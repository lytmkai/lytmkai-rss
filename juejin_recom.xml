<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Cursor 2.1 发布实测：计划能点了，审查能用了，CR 花多少？我也替你试了]]></title>    <link>https://juejin.cn/post/7575651989985591350</link>    <guid>https://juejin.cn/post/7575651989985591350</guid>    <pubDate>2025-11-24T02:02:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575651989985591350" data-draft-id="7575751471841476644" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor 2.1 发布实测：计划能点了，审查能用了，CR 花多少？我也替你试了"/> <meta itemprop="keywords" content="Cursor,AI编程,人工智能"/> <meta itemprop="datePublished" content="2025-11-24T02:02:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor 2.1 发布实测：计划能点了，审查能用了，CR 花多少？我也替你试了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:02:58.000Z" title="Mon Nov 24 2025 02:02:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>21号，<code>Cursor</code> 升级了 <code>2.1</code> 版本，给大家简单同步下升级内容。</p>
<h2 data-id="heading-0">改进的计划模式</h2>
<p>流程和定位没有改变，最大的改变是交互方式的优化。</p>
<p>原来的 <code>Plan</code> 模式是 <code>Cursor</code> 给出问题和带序号的答案，你可以响应问题题号和答案的序号，比如：<code>1:A,2:B</code>。</p>
<p>这次升级后，就不用手动录入了，直接通过<strong>图形交互</strong>点击选项即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df240a005234462b8b658c6cba326122~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554578&amp;x-signature=BZldWDZxOcHywR%2FRkI%2BnaO6s5iU%3D" alt="" loading="lazy"/></p>
<p>并且支持了多轮问答，这样生成的计划会更加准确和符合预期。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b01bd6e574c461cb5a0d9392a2021b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554578&amp;x-signature=9hE4I9xfh6V4Ykqo3Q7YEbcxvRw%3D" alt="" loading="lazy"/></p>
<p>全部分析完成后，就会生成分析文档和计划，确认无误后，可以点击“Build”开始生成。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/514a5c2cc29440259f157fa9e76b0ea8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554578&amp;x-signature=ZwubKZQxyV1qIszXwgdNGsvs%2FNI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">AI 代码审查</h2>
<p>这个功能之前版本已经开始逐步上线，这次算是正式推出吧。</p>
<p>我现在使用 AI 协同研发的时候，AI 生成的代码是通过“<strong>人工</strong>”+“<strong>AI Commit Message</strong>”进行审查的。</p>
<p>现在可以直接使用 <code>AI Code Reviews</code> 进行了。</p>
<h3 data-id="heading-2">入口</h3>
<p><code>Agent Review</code> 有两个入口：</p>
<ul>
<li>一个是在生成结果最后的 <code>agent diff</code> 处。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1822c3f938ba4d369bb812d0ed57280d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554578&amp;x-signature=bi7tefD5yTQ8VY2aHNSC31ivmNg%3D" alt="" loading="lazy"/></p>
<ul>
<li>另一个是 <code>Source Control</code> 选项卡的 <code>Agent Review</code>。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed13a5dc36384ec690a2aca6bc6e9cd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554578&amp;x-signature=rIp%2ByfHkoQp1TyQTSuAYUpShOzo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">Review 的效果</h3>
<p><code>Review</code> 后的效果如下。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2389eef2c60a4487b6d139cfe987b9f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554578&amp;x-signature=lKco8PGtWJ2GiPUSiJwhLJHAPPk%3D" alt="" loading="lazy"/></p>
<p>可以直接看到 AI 帮你找到的 <code>Issue</code>，支持单个修复，也支持一键全部修复。</p>
<h3 data-id="heading-4">计费方式</h3>
<p>按照 <code>Review</code> 中的<strong>实际使用量计费</strong>的。</p>
<p>我帮大家测试了一下，18 个前端文件 <code>Review</code> 了一次，<code>86.6</code>万 Token，<code>0.23</code>美元，不便宜呀，大家按需使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1c6256dfbe543a89c94b67f31c09278~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554578&amp;x-signature=htlnsY5Mb%2FBrMLJiVvhrZkfnyzk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">即时grep</h2>
<p>我理解的是编辑器内手动搜索，或者模型在调用 <code>grep</code> 命令时，会触发“即时grep”的特性。</p>
<p>该特性可以提供一个<strong>超快的搜索功能</strong>，让你快速定位要找的文件，不需等待扫描整个代码库。</p>
<p>我问了 <code>Composer 1</code>，底层应该是集成了 <code>ripgrep</code>。</p>
<h2 data-id="heading-6">移除自定义智能体</h2>
<p>自定义 Agent 模式被移除，如果想用的话，可以使用<strong>自定义命令</strong>。</p>
<p>前几天刚实现的自定义智能体还得改下。</p>
<h2 data-id="heading-7">结语</h2>
<p>这次升级没有特别大的调整，但功能倒是挺实用的，大家可以酌情试用。</p>
<p>有什么疑问欢迎留言交流~</p>
<p>明天周一，加油！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android模拟器检测全面指南：从基础到高级策略]]></title>    <link>https://juejin.cn/post/7575162322240880640</link>    <guid>https://juejin.cn/post/7575162322240880640</guid>    <pubDate>2025-11-23T17:01:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575162322240880640" data-draft-id="7575413146921861135" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android模拟器检测全面指南：从基础到高级策略"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-23T17:01:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陆业聪"/> <meta itemprop="url" content="https://juejin.cn/user/13629904404157"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android模拟器检测全面指南：从基础到高级策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/13629904404157/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陆业聪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T17:01:32.000Z" title="Sun Nov 23 2025 17:01:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、核心检测维度与方法</h2>
<p>检测Android模拟器的核心思路是识别其与真实设备在<strong>硬件、系统属性和行为特征</strong>上的差异。以下是经过实践验证的有效方法。</p>
<h3 data-id="heading-1">1.1 检查系统构建属性</h3>
<p>模拟器的<code>android.os.Build</code>类中的属性值通常包含特定标识符，这是最基础的检测方式。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isProbablyEmulator</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> Build.MODEL.toLowerCase();
    <span class="hljs-type">String</span> <span class="hljs-variable">manufacturer</span> <span class="hljs-operator">=</span> Build.MANUFACTURER.toLowerCase();
    <span class="hljs-type">String</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> Build.PRODUCT.toLowerCase();
    <span class="hljs-type">String</span> <span class="hljs-variable">fingerprint</span> <span class="hljs-operator">=</span> Build.FINGERPRINT.toLowerCase();
    <span class="hljs-type">String</span> <span class="hljs-variable">brand</span> <span class="hljs-operator">=</span> Build.BRAND.toLowerCase();
    <span class="hljs-type">String</span> <span class="hljs-variable">hardware</span> <span class="hljs-operator">=</span> Build.HARDWARE.toLowerCase();
    <span class="hljs-type">String</span> <span class="hljs-variable">device</span> <span class="hljs-operator">=</span> Build.DEVICE.toLowerCase();

    <span class="hljs-keyword">return</span> (model.contains(<span class="hljs-string">"google_sdk"</span>) ||
            model.contains(<span class="hljs-string">"droid4x"</span>) ||
            model.contains(<span class="hljs-string">"emulator"</span>) ||
            model.contains(<span class="hljs-string">"android sdk built for x86"</span>) ||
            manufacturer.contains(<span class="hljs-string">"genymotion"</span>) ||
            product.contains(<span class="hljs-string">"sdk_google"</span>) ||
            product.contains(<span class="hljs-string">"google_sdk"</span>) ||
            product.contains(<span class="hljs-string">"sdk"</span>) ||
            product.contains(<span class="hljs-string">"sdk_x86"</span>) ||
            product.contains(<span class="hljs-string">"vbox86p"</span>) ||
            product.contains(<span class="hljs-string">"emulator"</span>) ||
            fingerprint.contains(<span class="hljs-string">"generic"</span>) ||
            fingerprint.contains(<span class="hljs-string">"generic/sdk/generic"</span>) ||
            fingerprint.contains(<span class="hljs-string">"sdk_gphone"</span>) ||
            fingerprint.contains(<span class="hljs-string">"google/sdk_gphone"</span>) ||
            fingerprint.contains(<span class="hljs-string">"test-keys"</span>) ||
            brand.contains(<span class="hljs-string">"generic"</span>) ||
            hardware.contains(<span class="hljs-string">"goldfish"</span>) || <span class="hljs-comment">// 传统模拟器硬件</span>
            hardware.contains(<span class="hljs-string">"ranchu"</span>) ||   <span class="hljs-comment">// 较新模拟器硬件</span>
            device.contains(<span class="hljs-string">"generic"</span>));
}
</code></pre>
<p><strong>关键系统属性检查点</strong>：</p>
<ul>
<li><strong>ro.hardware</strong>：模拟器通常返回"goldfish"或"ranchu"</li>
<li><strong>ro.kernel.qemu</strong>：模拟器中常返回"1"，真机通常为空</li>
<li><strong>ro.product.model</strong>：Android模拟器通常为"sdk"或"google_sdk"</li>
</ul>
<h3 data-id="heading-2">1.2 检查特定系统文件与属性</h3>
<p>模拟器环境中存在真机没有的特殊文件和系统属性。</p>
<p><strong>通过反射读取系统属性</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSystemProperty</span><span class="hljs-params">(String key)</span> {
    <span class="hljs-keyword">try</span> {
        Class&lt;?&gt; systemPropertyClass = Class.forName(<span class="hljs-string">"android.os.SystemProperties"</span>);
        <span class="hljs-keyword">return</span> (String) systemPropertyClass.getMethod(<span class="hljs-string">"get"</span>, String.class).invoke(<span class="hljs-literal">null</span>, key);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        e.printStackTrace();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmulatorByProperties</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">hardware</span> <span class="hljs-operator">=</span> getSystemProperty(<span class="hljs-string">"ro.hardware"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">kernelQemu</span> <span class="hljs-operator">=</span> getSystemProperty(<span class="hljs-string">"ro.kernel.qemu"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">hardwarePlatform</span> <span class="hljs-operator">=</span> getSystemProperty(<span class="hljs-string">"ro.boot.hardware.platform"</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-string">"goldfish"</span>.equals(hardware) ||
           <span class="hljs-string">"ranchu"</span>.equals(hardware) ||
           <span class="hljs-string">"1"</span>.equals(kernelQemu) ||
           (hardwarePlatform != <span class="hljs-literal">null</span> &amp;&amp; hardwarePlatform.contains(<span class="hljs-string">"sdk"</span>));
}
</code></pre>
<p><strong>模拟器特有文件检测</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String[] known_files = {
    <span class="hljs-string">"/system/lib/libc_malloc_debug_qemu.so"</span>,
    <span class="hljs-string">"/sys/qemu_trace"</span>, 
    <span class="hljs-string">"/system/bin/qemu-props"</span>,
    <span class="hljs-string">"/dev/socket/qemud"</span>,
    <span class="hljs-string">"/dev/qemu_pipe"</span>
};

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasQEmuFiles</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">for</span>(String filePath : known_files) {
        <span class="hljs-type">File</span> <span class="hljs-variable">targetFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath);
        <span class="hljs-keyword">if</span> (targetFile.exists()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h3 data-id="heading-3">1.3 检查硬件与传感器信息</h3>
<p>模拟器通常无法完美模拟所有硬件特性，这为检测提供了多个切入点。</p>
<p><strong>传感器检测</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检查光传感器是否存在</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Boolean <span class="hljs-title function_">notHasLightSensorManager</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-type">SensorManager</span> <span class="hljs-variable">sensorManager</span> <span class="hljs-operator">=</span> (SensorManager) context.getSystemService(SENSOR_SERVICE);
    <span class="hljs-type">Sensor</span> <span class="hljs-variable">lightSensor</span> <span class="hljs-operator">=</span> sensorManager.getDefaultSensor(Sensor.TYPE_LIGHT);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> == lightSensor;
}
</code></pre>
<p><strong>基带与电话状态检查</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkByTelephony</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-type">TelephonyManager</span> <span class="hljs-variable">tm</span> <span class="hljs-operator">=</span> (TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE);
    <span class="hljs-type">String</span> <span class="hljs-variable">imei</span> <span class="hljs-operator">=</span> tm.getDeviceId();
    <span class="hljs-type">String</span> <span class="hljs-variable">networkOperator</span> <span class="hljs-operator">=</span> tm.getNetworkOperatorName();
    
    <span class="hljs-comment">// 模拟器IMEI通常为000000000000000，网络运营商为"Android"</span>
    <span class="hljs-keyword">return</span> (imei != <span class="hljs-literal">null</span> &amp;&amp; imei.equals(<span class="hljs-string">"000000000000000"</span>)) || 
           <span class="hljs-string">"android"</span>.equalsIgnoreCase(networkOperator);
}
</code></pre>
<p><strong>蓝牙检测</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">notHasBlueTooth</span><span class="hljs-params">()</span> {
    <span class="hljs-type">BluetoothAdapter</span> <span class="hljs-variable">ba</span> <span class="hljs-operator">=</span> BluetoothAdapter.getDefaultAdapter();
    <span class="hljs-keyword">if</span> (ba == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 如果有蓝牙但名称为空，可能是模拟器</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> ba.getName();
        <span class="hljs-keyword">return</span> TextUtils.isEmpty(name);
    }
}
</code></pre>
<h3 data-id="heading-4">1.4 检查CPU架构与信息</h3>
<p>模拟器通常运行在x86/x86_64架构的PC上，而真机多为ARM架构。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readCpuInfo</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
    <span class="hljs-keyword">try</span> {
        String[] args = {<span class="hljs-string">"/system/bin/cat"</span>, <span class="hljs-string">"/proc/cpuinfo"</span>};
        <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(args);
        <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> cmd.start();
        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">readLine</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">responseReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(process.getInputStream(), <span class="hljs-string">"utf-8"</span>));
        <span class="hljs-keyword">while</span> ((readLine = responseReader.readLine()) != <span class="hljs-literal">null</span>) {
            sb.append(readLine);
        }
        responseReader.close();
        result = sb.toString().toLowerCase();
    } <span class="hljs-keyword">catch</span> (IOException ex) {
        <span class="hljs-comment">// 处理异常</span>
    }
    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkByCpuInfo</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cpuInfo</span> <span class="hljs-operator">=</span> readCpuInfo();
    <span class="hljs-keyword">return</span> (cpuInfo.contains(<span class="hljs-string">"intel"</span>) || cpuInfo.contains(<span class="hljs-string">"amd"</span>));
}
</code></pre>
<h3 data-id="heading-5">1.5 电池状态检测</h3>
<p>模拟器的电池信息通常保持不变，而真机的电池状态会动态变化。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkBatteryStats</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-type">IntentFilter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntentFilter</span>(Intent.ACTION_BATTERY_CHANGED);
    <span class="hljs-type">Intent</span> <span class="hljs-variable">batteryStatus</span> <span class="hljs-operator">=</span> context.registerReceiver(<span class="hljs-literal">null</span>, filter);
    
    <span class="hljs-keyword">if</span> (batteryStatus == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-type">int</span> <span class="hljs-variable">level</span> <span class="hljs-operator">=</span> batteryStatus.getIntExtra(BatteryManager.EXTRA_LEVEL, -<span class="hljs-number">1</span>);
    <span class="hljs-type">int</span> <span class="hljs-variable">scale</span> <span class="hljs-operator">=</span> batteryStatus.getIntExtra(BatteryManager.EXTRA_SCALE, -<span class="hljs-number">1</span>);
    <span class="hljs-type">int</span> <span class="hljs-variable">temperature</span> <span class="hljs-operator">=</span> batteryStatus.getIntExtra(BatteryManager.EXTRA_TEMPERATURE, -<span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 模拟器电池电量通常固定，温度常为0</span>
    <span class="hljs-keyword">return</span> (temperature == <span class="hljs-number">0</span> || (level &gt;= <span class="hljs-number">0</span> &amp;&amp; scale &gt; <span class="hljs-number">0</span> &amp;&amp; level == scale));
}
</code></pre>
<h2 data-id="heading-6">二、高级检测技术</h2>
<h3 data-id="heading-7">2.1 基于Cache行为的检测</h3>
<p>利用ARM与x86架构的缓存差异进行检测：</p>
<ul>
<li><strong>ARM架构</strong>：使用哈佛架构，指令缓存(I-Cache)和数据缓存(D-Cache)分离</li>
<li><strong>x86架构</strong>：使用冯·诺依曼结构，指令和数据共享缓存</li>
</ul>
<p>这种方法能准确识别底层架构，但需要编写汇编代码，兼容性需要考虑。</p>
<h3 data-id="heading-8">2.2 基带信息检测</h3>
<p>基带是手机的基本通信模块，模拟器通常没有真实的基带信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkBaseband</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        Class&lt;?&gt; systemPropertyClass = Class.forName(<span class="hljs-string">"android.os.SystemProperties"</span>);
        <span class="hljs-type">Method</span> <span class="hljs-variable">getMethod</span> <span class="hljs-operator">=</span> systemPropertyClass.getMethod(<span class="hljs-string">"get"</span>, String.class);
        <span class="hljs-type">String</span> <span class="hljs-variable">baseband</span> <span class="hljs-operator">=</span> (String) getMethod.invoke(<span class="hljs-literal">null</span>, <span class="hljs-string">"gsm.version.baseband"</span>);
        <span class="hljs-keyword">return</span> (baseband == <span class="hljs-literal">null</span> || baseband.isEmpty());
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h3 data-id="heading-9">2.3 处理器信息一致性检查</h3>
<p>检测<code>ro.product.board</code>和<code>ro.board.platform</code>是否一致：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">checkProcessorConsistency</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">suspectCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-type">String</span> <span class="hljs-variable">productBoard</span> <span class="hljs-operator">=</span> getSystemProperty(<span class="hljs-string">"ro.product.board"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">boardPlatform</span> <span class="hljs-operator">=</span> getSystemProperty(<span class="hljs-string">"ro.board.platform"</span>);
    
    <span class="hljs-keyword">if</span> (productBoard == <span class="hljs-literal">null</span> || <span class="hljs-string">""</span>.equals(productBoard)) suspectCount++;
    <span class="hljs-keyword">if</span> (boardPlatform == <span class="hljs-literal">null</span> || <span class="hljs-string">""</span>.equals(boardPlatform)) suspectCount++;
    <span class="hljs-keyword">if</span> (productBoard != <span class="hljs-literal">null</span> &amp;&amp; boardPlatform != <span class="hljs-literal">null</span> &amp;&amp; 
        !productBoard.equals(boardPlatform)) suspectCount++;
    
    <span class="hljs-keyword">return</span> suspectCount;
}
</code></pre>
<h2 data-id="heading-10">三、集成检测策略与建议</h2>
<h3 data-id="heading-11">3.1 综合评分策略</h3>
<p>不要依赖单一检测方法，应采用<strong>多维度综合评分</strong>系统：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmulatorDetector</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>; <span class="hljs-comment">// 阈值可根据需求调整</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isRunningOnEmulator</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">suspectScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 系统属性检查</span>
        <span class="hljs-keyword">if</span> (checkBuildProperties()) suspectScore += <span class="hljs-number">2</span>;
        
        <span class="hljs-comment">// 文件检查</span>
        <span class="hljs-keyword">if</span> (hasQEmuFiles()) suspectScore += <span class="hljs-number">2</span>;
        
        <span class="hljs-comment">// 硬件检查</span>
        <span class="hljs-keyword">if</span> (checkByTelephony(context)) suspectScore += <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (notHasLightSensorManager(context)) suspectScore += <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (checkByCpuInfo()) suspectScore += <span class="hljs-number">2</span>;
        
        <span class="hljs-comment">// 电池状态检查</span>
        <span class="hljs-keyword">if</span> (checkBatteryStats(context)) suspectScore += <span class="hljs-number">1</span>;
        
        <span class="hljs-keyword">return</span> suspectScore &gt;= THRESHOLD;
    }
}
</code></pre>
<h3 data-id="heading-12">3.2 特定模拟器检测</h3>
<p>针对常见模拟器（如BlueStacks）的专项检测：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String[] known_bluestacks = {
    <span class="hljs-string">"/data/app/com.bluestacks.appmart-1.apk"</span>,
    <span class="hljs-string">"/data/app/com.bluestacks.BstCommandProcessor-1.apk"</span>, 
    <span class="hljs-string">"/data/app/com.bluestacks.help-1.apk"</span>,
    <span class="hljs-string">"/data/bluestacks.prop"</span>
};

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkBlueStacksFiles</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">for</span> (String filePath : known_bluestacks) {
        <span class="hljs-type">File</span> <span class="hljs-variable">targetFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath);
        <span class="hljs-keyword">if</span> (targetFile.exists()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h2 data-id="heading-13">四、重要注意事项</h2>
<h3 data-id="heading-14">4.1 权限与隐私合规</h3>
<p>部分检测方法需要申请权限：</p>
<ul>
<li><code>READ_PHONE_STATE</code>：用于读取IMEI、IMSI等设备标识</li>
<li><code>ACCESS_WIFI_STATE</code>：用于获取MAC地址信息</li>
<li><code>BLUETOOTH</code>：用于蓝牙检测</li>
</ul>
<p>确保遵循Google Play的隐私政策及相关法律法规（如GDPR）。</p>
<h3 data-id="heading-15">4.2 性能与兼容性考虑</h3>
<ul>
<li><strong>避免过度检测</strong>：检测逻辑应高效，不影响应用性能</li>
<li><strong>真机兼容性</strong>：在所有目标真机上充分测试，避免误判</li>
<li><strong>及时更新</strong>：模拟器技术不断进化，检测方法需定期更新</li>
</ul>
<h3 data-id="heading-16">4.3 服务端验证</h3>
<p>对于高安全性要求的应用，建议将关键检测逻辑放在服务端：</p>
<ul>
<li>防止客户端代码被篡改</li>
<li>动态更新检测规则</li>
<li>结合设备指纹技术</li>
</ul>
<h2 data-id="heading-17">五、总结</h2>
<p>Android模拟器检测是一场持续的"攻防战"。有效检测需要<strong>多维度、多方法结合</strong>，没有单一方法能100%准确识别所有模拟器。建议根据具体应用场景和安全要求，选择合适的检测方法组合，并建立综合评分机制。</p>
<p><strong>核心建议</strong>：</p>
<ol>
<li>优先使用系统属性检查等轻量级方法</li>
<li>结合文件检查、硬件信息验证等多维度检测</li>
<li>对高安全性场景，考虑使用专业设备指纹SDK</li>
<li>定期更新检测策略以应对新型模拟器</li>
</ol>
<p>通过系统化的检测方案，可以有效识别大多数模拟器环境，提升应用安全性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我把设计稿扔给 Doubao-Seed-Code，它写出的前端页面让我怀疑人生]]></title>    <link>https://juejin.cn/post/7575910298283098147</link>    <guid>https://juejin.cn/post/7575910298283098147</guid>    <pubDate>2025-11-24T08:39:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910298283098147" data-draft-id="7575910298283048995" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我把设计稿扔给 Doubao-Seed-Code，它写出的前端页面让我怀疑人生"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-24T08:39:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我把设计稿扔给 Doubao-Seed-Code，它写出的前端页面让我怀疑人生
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:39:41.000Z" title="Mon Nov 24 2025 08:39:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    73
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7461159993f14a6ba46eee1168757bdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764601052&amp;x-signature=BnmZW5AIFBygCFUALRR50wzekwo%3D" alt="" loading="lazy"/></p>
<p>过去几年，前端开发的节奏一直在悄悄发生变化：从「组件开发 → 低代码 → 设计稿转代码工具」一路往前推进，但始终有一道过不去的坎——模型看不懂设计稿，只能看懂语言。这意味着我们依然要靠开发者手工理解 UI、拆组件、对齐结构，然后再写代码。</p>
<p>直到我第一次把一张 UI 设计稿丢给 <strong>Doubao-Seed-Code</strong>。那种感觉像是有人突然把你从密闭的工地里拉出来说：</p>
<blockquote>
<p><strong>“别埋头写了，我能看图，剩下我来。”</strong></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0c87195f63642c580e8d2a1d3b6e67b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764601052&amp;x-signature=JBNbbeeBlrL6yrm2IWp8cUttKbk%3D" alt="" loading="lazy"/></p>
<p>这篇文章，我想与你分享的不是“模型会写代码”这种泛泛而谈，而是一次<strong>完全真实的前端开发体验</strong>：</p>
<p>👉 我把实际项目里的 UI 图丢给 Doubao-Seed-Code，让它帮我生成页面、分析结构、补齐交互、修 UI bug。你会看到它作为“视觉理解编码模型”的表现，与传统 LLM 有着根本性的差异。</p>
<hr/>
<h2 data-id="heading-0">一、为什么前端最需要视觉理解？</h2>
<p>前端的痛点一直很集中：</p>
<ol>
<li>设计稿与代码结构的映射是“非语言任务”；</li>
<li>样式 bug 往往是“眼睛能看懂，但语言难描述”；</li>
<li>页面复刻过程中，“哪个元素在哪、是 flex 还是 grid”靠的是视觉判断。</li>
</ol>
<p>传统代码模型再强，也无法跨过第一步：</p>
<blockquote>
<p>它们可以理解“文字的逻辑”，但无法理解“屏幕上元素的空间关系”。</p>
</blockquote>
<p>这就是 <strong>Doubao-Seed-Code</strong> 与 DeepSeek、GLM、MiniMax 等 Coding 模型最大的差异：</p>
<p>它不是靠 MCP 调图片，也不是先把图片转文字——它<strong>原生就能看图（VLM）</strong> 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ad505bcaf4c4d94b69365198349085a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764601052&amp;x-signature=KL8Q%2B9u3IJRKTb7Iva%2FPYp3%2B9NM%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">二、第一次把设计稿丢给模型，它给出的结构让我愣住了</h2>
<p>我拿了一张公司内部项目的 UI 页面（模拟版），丢给 Doubao-Seed-Code，并且只给了一个指令：</p>
<blockquote>
<p>“这是我项目里的一个页面，请你根据这张图生成一个优雅、布局合理、结构清晰的前端代码（Vue3 + TailwindCSS）。能不能做到接近视觉上的还原？”</p>
</blockquote>
<p>整个对话没有任何额外提示，没有 DOM 结构、没有组件说明。它做的第一件事不是写代码，而是<strong>拆 UI 结构树：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acfc58a202b448dba52b61fd9f6ca8d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764601052&amp;x-signature=FnsKderSEyBu3O0JnDCgIY1DWok%3D" alt="" loading="lazy"/></p>
<p>它自动识别了：</p>
<ul>
<li>Header 有品牌名 + 搜索栏</li>
<li>左侧是分组导航</li>
<li>中间是卡片网格</li>
<li>每张卡片包含标题、子项、状态点</li>
<li>右侧操作栏包含按钮与折叠菜单</li>
</ul>
<p>我在 Claude Code 里看它一步步还原结构时，有一种“这才是前端该有的 AI”的感觉。传统模型的做法是瞎猜 DOM。它第一次是“看懂设计”，第二次才是“写代码”。</p>
<hr/>
<h2 data-id="heading-2">三、模型生成的页面代码，有种“高级感”</h2>
<p>这是它最终生成的核心结构，节选如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- MainLayout.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex h-screen bg-gray-50"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Sidebar --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-64 border-r bg-white p-4"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-lg font-semibold mb-6"</span>&gt;</span>Workspace<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"space-y-3"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex items-center justify-between text-gray-700 cursor-pointer"</span>&gt;</span>
          Dashboard
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-gray-500 hover:text-gray-700 cursor-pointer"</span>&gt;</span>
          Projects
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Content --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex-1 p-6 overflow-y-auto"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex items-center justify-between mb-6"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-2xl font-semibold"</span>&gt;</span>Overview<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"border p-2 rounded w-64"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"Search..."</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

      <span class="hljs-comment">&lt;!-- Cards Grid --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid grid-cols-3 gap-6"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">v-for</span>=<span class="hljs-string">"card in cards"</span>
          <span class="hljs-attr">:key</span>=<span class="hljs-string">"card.id"</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"p-4 bg-white rounded-xl shadow-sm hover:shadow transition"</span>
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-lg font-medium mb-4"</span>&gt;</span>{{ card.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"space-y-2"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>
              <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in card.items"</span>
              <span class="hljs-attr">:key</span>=<span class="hljs-string">"item"</span>
              <span class="hljs-attr">class</span>=<span class="hljs-string">"flex items-center gap-2"</span>
            &gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-2 h-2 rounded-full bg-green-500"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-gray-600"</span>&gt;</span>{{ item }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> cards = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">"Messages"</span>, <span class="hljs-attr">items</span>: [<span class="hljs-string">"Inbox"</span>, <span class="hljs-string">"Archives"</span>] },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">"Users"</span>, <span class="hljs-attr">items</span>: [<span class="hljs-string">"Active Users"</span>, <span class="hljs-string">"Invitations"</span>] },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">"Settings"</span>, <span class="hljs-attr">items</span>: [<span class="hljs-string">"General"</span>, <span class="hljs-string">"Permissions"</span>] }
];
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>我注意到几点：</p>
<ol>
<li><strong>Tailwind 的使用非常干净，没有“堆样式”</strong></li>
<li>组件可拆分，这说明它理解了“信息分区”</li>
<li>卡片 hover、阴影、留白都非常现代</li>
<li>完全按照 UI 图去布局，而不是乱结构</li>
</ol>
<p>说句实话，这已经比一些入职一年的前端写得更好了。</p>
<hr/>
<h2 data-id="heading-3">四、视觉理解真正的杀手级场景：修 UI bug</h2>
<p>我又试了一件事情：</p>
<blockquote>
<p>我把一个“错位”的 UI 截图发过去：右栏偏移、grid 断层、字体粗细不对。</p>
</blockquote>
<p>模型不仅指出了所有视觉问题，还自动给出了修复后的代码 diff。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46a4c9e84a2d41a989a301125e78fb8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764601052&amp;x-signature=G1lgdO2X9EWnbBoiZGUxNOZZliE%3D" alt="" loading="lazy"/></p>
<p>它会说：</p>
<ul>
<li>“右侧栏偏移，因为父级少了 <code>flex-shrink-0</code>”</li>
<li>“标题层级比设计稿粗，可改成 <code>font-medium</code>”</li>
<li>“grid 不对齐，因为包裹层少了 <code>gap-x</code> 分隔”</li>
<li>“搜索栏的 padding 在图中更大，建议变为 px-4 py-2”</li>
</ul>
<p>我第一次感受到：</p>
<p><strong>模型不是在猜，是在看。</strong> 不是理解语言，是理解画面——就像一个前端高级工程师坐边上一样。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d97cf4342e484836b377954b10e73f12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764601052&amp;x-signature=0Fij%2FfvHqVrJ2O5KcK63VLchbx0%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-4">五、动手：你可以在 5 分钟内复现整个体验</h2>
<p>这部分我会给出最小可复现步骤，让你马上试起来。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2762dacb308b4dc8bdd38507e9d8a5a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764601052&amp;x-signature=Gq6Iqbs85cAN0JLnBsDS5Lmcpvc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">1）准备 Claude Code（推荐）</h3>
<p>在终端添加：</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">ANTHROPIC_BASE_URL</span>=https://ark.cn-beijing.volces.com/api/compatible
export <span class="hljs-attr">ANTHROPIC_AUTH_TOKEN</span>=&lt;你的APIKey&gt;
export <span class="hljs-attr">ANTHROPIC_MODEL</span>=doubao-seed-code-preview-latest
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18bb332ee89348a4b5ff45c7d0598575~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764601052&amp;x-signature=yzduBjrAu79CcQGkXsgeRXtNGdY%3D" alt="" loading="lazy"/></p>
<p>或者配置文件：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"api_key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"xxxxxxx"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"api_url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://ark.cn-beijing.volces.com/api/compatible"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"doubao-seed-code-preview-latest"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-6">2）让模型看 UI 图（核心步骤）</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3b37345b02c4dbfa2351b539149316d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764601052&amp;x-signature=j7J%2BUPle7wcbdG0VtlyIqNDbDc0%3D" alt="" loading="lazy"/></p>
<p>将任意 UI 图拖入 Claude Code，输入：</p>
<pre><code class="hljs">请你理解这张设计稿，输出其布局结构树，并用 Vue3 + TailwindCSS 实现页面。要求现代、美观、留白合理、易扩展。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5e67abf6eaa411fb039f66115313ec8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764601052&amp;x-signature=TJz7lRBuseGSD3d%2FU7MHPi3haAQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">3）让模型帮你修 UI bug</h3>
<p>把异常截图上传，输入：</p>
<pre><code class="hljs">帮我找出此页面与设计稿的差异，并提供 CSS/Tailwind 的修复建议，按 diff 方式输出。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afd4345380524c22b460719ab798a1a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764601052&amp;x-signature=poVHgcQ%2FfSiuBLPo9kvm1c41xWo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">4）扩展案例：视觉 + 交互协同</h3>
<p>你可以继续让它：</p>
<pre><code class="hljs">给这个页面加入右侧设置抽屉，逻辑是点击卡片右上角的按钮展开。请同时给出组件拆分建议。
</code></pre>
<p>模型会自动生成：</p>
<ul>
<li>drawer 组件</li>
<li>composables 逻辑</li>
<li>动画</li>
<li>事件绑定</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b3b7b1896df49b290da270e12526275~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764601052&amp;x-signature=blnl%2BvLC3dT3%2FWfJbjtpxgF4JSs%3D" alt="" loading="lazy"/></p>
<p>这展示了它在前端工程化能力上的“Agentic”倾向。</p>
<hr/>
<h2 data-id="heading-9">六、如果要用一句话形容 Doubao-Seed-Code 的视觉能力……</h2>
<p>我会说：它是第一个真正能“看懂设计稿”的编程模型，而不是把“图转文字后再写代码”的语言模型。</p>
<p>它能理解布局、视觉层级、间距、对齐、信息模块，这些能力不是语言模型的延伸，而是<strong>前端工程认知的延伸</strong>。</p>
<p>在前端这个高度依赖“视觉→结构→代码映射”的领域，VLM 是一个质的改变。</p>
<hr/>
<h2 data-id="heading-10">七、模型并不是来替代前端，而是重塑前端</h2>
<p>前端真正的瓶颈不是“写代码”，而是：</p>
<ul>
<li>理解页面结构</li>
<li>复刻设计稿</li>
<li>在脑中构建布局</li>
<li>调样式</li>
<li>修肉眼可见但语言难描述的细节</li>
</ul>
<p>当模型能够理解视觉，它开始承担起“结构理解”这一最难的部分，而开发者可以把更多时间放在：</p>
<ul>
<li>交互设计</li>
<li>动画体验</li>
<li>信息架构</li>
<li>业务逻辑</li>
<li>全链路性能</li>
</ul>
<p>如果说前端曾经被称为“还原度工程师”，那么视觉理解模型（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.volcengine.com%2Fdocs%2F82379%2F1949118%3Futm_source%3Dchatgpt.com" target="_blank" title="https://www.volcengine.com/docs/82379/1949118?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">传送门</a>）就是从根上改变这个称呼的工具。</p>
<p><strong>前端不是被替代，而是被升级。</strong> 如果你也在探索“AI 参与前端工程流程”，欢迎留言交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔍 React 有 useAntdTable，Vue3 怎么办？自封一个 useTable！]]></title>    <link>https://juejin.cn/post/7575887863797645322</link>    <guid>https://juejin.cn/post/7575887863797645322</guid>    <pubDate>2025-11-24T08:21:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575887863797645322" data-draft-id="7573601651782516763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔍  React 有 useAntdTable，Vue3 怎么办？自封一个 useTable！"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T08:21:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lsx_"/> <meta itemprop="url" content="https://juejin.cn/user/1442981392682829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔍  React 有 useAntdTable，Vue3 怎么办？自封一个 useTable！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442981392682829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lsx_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:21:29.000Z" title="Mon Nov 24 2025 08:21:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么封装一个Vue3版本的useTable</h2>
<p>之前写 React ， 有 <code>ahooks 的</code> 提供的 <code>useAntdTable</code> 这样的成熟数据表封装，而在 Vue3 中并没有等价的“官方”工具。</p>
<p>在 <strong>React + Ant Design</strong> 的生态里：</p>
<ul>
<li><code>ahooks</code> 的 <code>useAntdTable</code> 非常常用；</li>
<li>负责统一管理表格的数据请求、分页、搜索、loading、刷新等逻辑。</li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> { tableProps, search } = <span class="hljs-title function_">useAntdTable</span>(getTableData)
</code></pre>
<p>这会自动帮你实现：</p>
<ul>
<li>请求数据；</li>
<li>分页变化自动触发请求；</li>
<li>搜索参数归一化；</li>
<li>Loading 管理。</li>
</ul>
<p>👉 组件只负责展示，逻辑都集中在 hook 中。</p>
<blockquote>
<p>在vue3项目中，也有不少表格业务，他们的功能都大差不差，有很多相似的逻辑，然后我们的封装一个useTable，其作用就是提取相同的逻辑到hooks中，而UI组件只负责使用hooks暴露的数据与方法。这极大的提高了代码的逻辑复用，统一行为，UI 与业务逻辑完全分离。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">介绍 useTable</h2>
<p>一个专为 <code>Vue3 + Element Plus</code> 设计的表格数据管理 Hook，参考 ahooks 的 <code>useAntdTable</code> 设计，提供部分的表格功能支持。</p>
<h3 data-id="heading-2">特性</h3>
<ul>
<li>🚀 <strong>开箱即用</strong> - 零配置即可使用，自动处理分页、搜索、排序</li>
<li>📦 <strong>类型安全</strong> - 完整的 TypeScript 支持</li>
<li>🎯 <strong>语义化 API</strong> - 方法名清晰易懂，符合开发习惯</li>
<li>🔧 <strong>高度可定制</strong> - 支持数据转换、错误处理、回调函数等</li>
<li>📱 <strong>响应式</strong> - 基于 Vue3 Composition API，完全响应式</li>
<li>🎨 <strong>Element Plus 友好</strong> - 专为 Element Plus 表格组件设计</li>
</ul>
<h3 data-id="heading-3">📋 核心功能</h3>
<h4 data-id="heading-4">1. 数据管理</h4>
<ul>
<li>✅ 自动加载数据</li>
<li>✅ 加载状态管理</li>
<li>✅ 错误处理</li>
</ul>
<h4 data-id="heading-5">2. 分页功能</h4>
<ul>
<li>✅ 页码切换</li>
<li>✅ 每页条数调整</li>
<li>✅ 分页状态同步</li>
</ul>
<h4 data-id="heading-6">3. 搜索功能</h4>
<ul>
<li>✅ 多字段搜索</li>
<li>✅ 搜索条件组合</li>
<li>✅ 搜索重置</li>
</ul>
<h4 data-id="heading-7">4. 排序功能</h4>
<ul>
<li>✅ 多字段排序</li>
<li>✅ 排序方向切换</li>
<li>✅ 排序状态管理</li>
</ul>
<h4 data-id="heading-8">5. 行选择</h4>
<ul>
<li>✅ 单选/多选</li>
<li>✅ 批量操作</li>
<li>✅ 选中状态管理</li>
</ul>
<h3 data-id="heading-9">基础用法</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useTable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useTable'</span>

<span class="hljs-comment">// 定义数据类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">status</span>: <span class="hljs-string">'active'</span> | <span class="hljs-string">'inactive'</span>
}

<span class="hljs-comment">// 定义请求参数类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserListParams</span> {
  <span class="hljs-attr">current</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">pageSize</span>: <span class="hljs-built_in">number</span>
  name?: <span class="hljs-built_in">string</span>
  status?: <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">// API 请求函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getUserList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">params: UserListParams</span>) =&gt; {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/users'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params)
  })
  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>()
}

<span class="hljs-comment">// 使用 Hook</span>
<span class="hljs-keyword">const</span> { data, loading, pagination, search, refresh } = useTable&lt;<span class="hljs-title class_">User</span>, <span class="hljs-title class_">UserListParams</span>&gt;({
  <span class="hljs-attr">request</span>: getUserList,
  <span class="hljs-attr">defaultPagination</span>: { <span class="hljs-attr">current</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span> },
  <span class="hljs-attr">defaultSearchParams</span>: { <span class="hljs-attr">status</span>: <span class="hljs-string">'active'</span> }
})
</code></pre>
<h3 data-id="heading-10">API</h3>
<h4 data-id="heading-11">配置选项</h4>













































































<table><thead><tr><th>参数</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>request</code></td><td><code>(params: P) =&gt; Promise&lt;HttpResponse&lt;TableData&lt;T&gt;&gt;&gt;</code></td><td>-</td><td>数据请求函数</td></tr><tr><td><code>defaultPagination</code></td><td><code>Partial&lt;PaginationParams&gt;</code></td><td><code>{ current: 1, pageSize: 10 }</code></td><td>默认分页参数</td></tr><tr><td><code>defaultSearchParams</code></td><td><code>Record&lt;string, any&gt;</code></td><td><code>{}</code></td><td>默认搜索参数</td></tr><tr><td><code>defaultSortParams</code></td><td><code>SortParams</code></td><td><code>{}</code></td><td>默认排序参数</td></tr><tr><td><code>immediate</code></td><td><code>boolean</code></td><td><code>true</code></td><td>是否立即加载数据</td></tr><tr><td><code>paginationKey</code></td><td><code>PaginationKey</code></td><td><code>{ current: 'pageNum', size: 'pageSize' }</code></td><td>自定义分页字段映射 如接口的分页字段不是pageNum和pageSize，可使用该参数快速配置分页字段</td></tr><tr><td><code>rowKey</code></td><td><code>string | ((record: T) =&gt; string | number)</code></td><td><code>'id'</code></td><td>行键字段名或函数</td></tr><tr><td><code>transformResponse</code></td><td><code>(response: HttpResponse&lt;TableData&lt;T&gt;&gt;) =&gt; TableData&lt;T&gt;</code></td><td>-</td><td>数据转换函数</td></tr><tr><td><code>onError</code></td><td><code>(error: any) =&gt; void</code></td><td>-</td><td>错误处理函数</td></tr><tr><td><code>onSuccess</code></td><td><code>(data: TableData&lt;T&gt;) =&gt; void</code></td><td>-</td><td>成功回调函数</td></tr><tr><td><code>beforeRequest</code></td><td><code>(params: P) =&gt; P | Promise&lt;P&gt;</code></td><td>-</td><td>请求前处理函数</td></tr></tbody></table>
<h4 data-id="heading-12">返回值</h4>



















































































































<table><thead><tr><th>属性</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>data</code></td><td><code>ComputedRef&lt;T[]&gt;</code></td><td>表格数据列表</td></tr><tr><td><code>hasData</code></td><td><code>ComputedRef&lt;boolean&gt;</code></td><td>是否有表格数据</td></tr><tr><td><code>loading</code></td><td><code>ComputedRef&lt;boolean&gt;</code></td><td>加载状态</td></tr><tr><td><code>pagination</code></td><td><code>ComputedRef&lt;PaginationParams&gt;</code></td><td>分页信息</td></tr><tr><td><code>searchParams</code></td><td><code>Ref&lt;Record&lt;string, any&gt;&gt;</code></td><td>搜索参数</td></tr><tr><td><code>sortParams</code></td><td><code>Ref&lt;SortParams&gt;</code></td><td>排序参数</td></tr><tr><td><code>selectedRowKeys</code></td><td><code>Ref&lt;(string | number)[]&gt;</code></td><td>选中的行键</td></tr><tr><td><code>selectedRows</code></td><td><code>Ref&lt;T[]&gt;</code></td><td>选中的行数据</td></tr><tr><td><code>refresh</code></td><td><code>() =&gt; Promise&lt;void&gt;</code></td><td>刷新数据（保持当前条件）</td></tr><tr><td><code>reload</code></td><td><code>() =&gt; Promise&lt;void&gt;</code></td><td>重新加载数据（重置到第一页）</td></tr><tr><td><code>search</code></td><td><code>(params?: Record&lt;string, any&gt;) =&gt; Promise&lt;void&gt;</code></td><td>搜索</td></tr><tr><td><code>reset</code></td><td><code>() =&gt; Promise&lt;void&gt;</code></td><td>重置搜索</td></tr><tr><td><code>setPagination</code></td><td><code>(pagination: Partial&lt;PaginationParams&gt;) =&gt; void</code></td><td>设置分页</td></tr><tr><td><code>setSortParams</code></td><td><code>(sortParams: SortParams) =&gt; void</code></td><td>设置排序</td></tr><tr><td><code>setSelectedRowKeys</code></td><td><code>(keys: (string | number)[]) =&gt; void</code></td><td>设置选中行</td></tr><tr><td><code>clearSelection</code></td><td><code>() =&gt; void</code></td><td>清空选中</td></tr><tr><td><code>getRowKey</code></td><td><code>(record: T) =&gt; string | number</code></td><td>获取行键</td></tr><tr><td><code>onSortChange</code></td><td><code>(payload: { prop?: string; order?: 'ascending' |'descending' | null } | any)</code></td><td>处理 Element Plus 表格排序事件, @param payload - Element Plus 的 sort-change 事件参数</td></tr><tr><td><code>onSelectionChange</code></td><td><code>(selection: T[]) =&gt; void</code></td><td>处理 Element Plus 表格选择事件, @param selection - 选中的行数据</td></tr><tr><td><code>onCurrentChange</code></td><td><code>(current: number) =&gt; void</code></td><td>处理 Element Plus 分页页码变更事件, @param current - 当前页</td></tr><tr><td><code>onSizeChange</code></td><td><code>(size: number) =&gt; void</code></td><td>处理 Element Plus 分页每页条数变更事件, @param size - 每页条数</td></tr></tbody></table>
<h3 data-id="heading-13">使用示例</h3>
<h4 data-id="heading-14">基础表格</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 搜索表单 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-form</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">"searchForm"</span> <span class="hljs-attr">inline</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"用户名"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"searchForm.name"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入用户名"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleSearch"</span>&gt;</span>搜索<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleReset"</span>&gt;</span>重置<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 表格 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"data"</span> <span class="hljs-attr">:loading</span>=<span class="hljs-string">"loading"</span> <span class="hljs-attr">row-key</span>=<span class="hljs-string">"id"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"ID"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"用户名"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"邮箱"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 分页 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-pagination</span>
      <span class="hljs-attr">v-model:current-page</span>=<span class="hljs-string">"pagination.current"</span>
      <span class="hljs-attr">v-model:page-size</span>=<span class="hljs-string">"pagination.pageSize"</span>
      <span class="hljs-attr">:total</span>=<span class="hljs-string">"pagination.total"</span>
      @<span class="hljs-attr">current-change</span>=<span class="hljs-string">"handleCurrentChange"</span>
      @<span class="hljs-attr">size-change</span>=<span class="hljs-string">"handleSizeChange"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { useTable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useTable'</span>

<span class="hljs-keyword">const</span> searchForm = <span class="hljs-title function_">ref</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">''</span> })

<span class="hljs-keyword">const</span> { data, loading, pagination, search, reset } = <span class="hljs-title function_">useTable</span>({
  <span class="hljs-attr">request</span>: getUserList,
  <span class="hljs-attr">defaultPagination</span>: { <span class="hljs-attr">current</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span> }
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSearch</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">search</span>(searchForm.<span class="hljs-property">value</span>)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReset</span> = (<span class="hljs-params"/>) =&gt; {
  searchForm.<span class="hljs-property">value</span> = { <span class="hljs-attr">name</span>: <span class="hljs-string">''</span> }
  <span class="hljs-title function_">reset</span>()
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCurrentChange</span> = (<span class="hljs-params">current: number</span>) =&gt; {
  pagination.<span class="hljs-property">value</span>.<span class="hljs-property">current</span> = current
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSizeChange</span> = (<span class="hljs-params">size: number</span>) =&gt; {
  pagination.<span class="hljs-property">value</span>.<span class="hljs-property">pageSize</span> = size
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-15">带选择的表格</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span>
      <span class="hljs-attr">:data</span>=<span class="hljs-string">"data"</span>
      <span class="hljs-attr">:loading</span>=<span class="hljs-string">"loading"</span>
      @<span class="hljs-attr">selection-change</span>=<span class="hljs-string">"handleSelectionChange"</span>
      <span class="hljs-attr">row-key</span>=<span class="hljs-string">"id"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"selection"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"55"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"用户名"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"邮箱"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"danger"</span> 
      @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleBatchDelete"</span>
      <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"!selectedRowKeys.length"</span>
    &gt;</span>
      批量删除 ({{ selectedRowKeys.length }})
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useTable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useTable'</span>

<span class="hljs-keyword">const</span> { 
  data, 
  loading, 
  selectedRowKeys, 
  selectedRows, 
  setSelectedRowKeys 
} = <span class="hljs-title function_">useTable</span>({
  <span class="hljs-attr">request</span>: getUserList
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params">selection: User[]</span>) =&gt; {
  <span class="hljs-keyword">const</span> keys = selection.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span>)
  <span class="hljs-title function_">setSelectedRowKeys</span>(keys)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleBatchDelete</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'选中的用户:'</span>, selectedRows.<span class="hljs-property">value</span>)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-16">带排序的表格</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-table</span>
    <span class="hljs-attr">:data</span>=<span class="hljs-string">"data"</span>
    <span class="hljs-attr">:loading</span>=<span class="hljs-string">"loading"</span>
    @<span class="hljs-attr">sort-change</span>=<span class="hljs-string">"handleSortChange"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"用户名"</span> <span class="hljs-attr">sortable</span>=<span class="hljs-string">"custom"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"createTime"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"创建时间"</span> <span class="hljs-attr">sortable</span>=<span class="hljs-string">"custom"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useTable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useTable'</span>

<span class="hljs-keyword">const</span> { data, loading, setSortParams } = <span class="hljs-title function_">useTable</span>({
  <span class="hljs-attr">request</span>: getUserList
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSortChange</span> = (<span class="hljs-params">{ prop, order }: any</span>) =&gt; {
  <span class="hljs-title function_">setSortParams</span>({
    <span class="hljs-attr">field</span>: prop,
    <span class="hljs-attr">order</span>: order === <span class="hljs-string">'ascending'</span> ? <span class="hljs-string">'ascend'</span> : order === <span class="hljs-string">'descending'</span> ? <span class="hljs-string">'descend'</span> : <span class="hljs-literal">undefined</span>
  })
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-17">数据转换</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> { data, loading } = <span class="hljs-title function_">useTable</span>({
  <span class="hljs-attr">request</span>: getUserList,
  <span class="hljs-attr">transformResponse</span>: <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-comment">// 自定义数据转换逻辑</span>
    <span class="hljs-keyword">const</span> { result } = response
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">list</span>: result?.<span class="hljs-property">list</span>?.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
        ...item,
        <span class="hljs-attr">statusText</span>: item.<span class="hljs-property">status</span> === <span class="hljs-string">'active'</span> ? <span class="hljs-string">'激活'</span> : <span class="hljs-string">'禁用'</span>
      })) || [],
      <span class="hljs-attr">total</span>: result?.<span class="hljs-property">total</span> || <span class="hljs-number">0</span>,
      <span class="hljs-attr">current</span>: result?.<span class="hljs-property">current</span> || <span class="hljs-number">1</span>,
      <span class="hljs-attr">pageSize</span>: result?.<span class="hljs-property">pageSize</span> || <span class="hljs-number">10</span>
    }
  }
})
</code></pre>
<h4 data-id="heading-18">错误处理</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> { data, loading } = <span class="hljs-title function_">useTable</span>({
  <span class="hljs-attr">request</span>: getUserList,
  <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'数据加载失败:'</span>, error)
    <span class="hljs-comment">// 自定义错误处理逻辑</span>
  },
  <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据加载成功:'</span>, data)
    <span class="hljs-comment">// 自定义成功处理逻辑</span>
  }
})
</code></pre>
<h4 data-id="heading-19">请求前处理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> { data, loading } = <span class="hljs-title function_">useTable</span>({
  <span class="hljs-attr">request</span>: getUserList,
  <span class="hljs-attr">beforeRequest</span>: <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> {
    <span class="hljs-comment">// 在请求前添加额外参数</span>
    <span class="hljs-keyword">return</span> {
      ...params,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">token</span>: <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>)
    }
  }
})
</code></pre>
<h3 data-id="heading-20">最佳实践</h3>
<h4 data-id="heading-21">1. 类型安全</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义明确的类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserListParams</span> {
  <span class="hljs-attr">current</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">pageSize</span>: <span class="hljs-built_in">number</span>
  name?: <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">// 使用泛型确保类型安全</span>
<span class="hljs-keyword">const</span> { data, loading } = useTable&lt;<span class="hljs-title class_">User</span>, <span class="hljs-title class_">UserListParams</span>&gt;({
  <span class="hljs-attr">request</span>: getUserList
})
</code></pre>
<h4 data-id="heading-22">2. 错误处理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> { data, loading } = <span class="hljs-title function_">useTable</span>({
  <span class="hljs-attr">request</span>: getUserList,
  <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-comment">// 统一错误处理</span>
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'数据加载失败，请稍后重试'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'API Error:'</span>, error)
  }
})
</code></pre>
<h4 data-id="heading-23">3. 性能优化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用防抖搜索</span>
<span class="hljs-keyword">import</span> { debounce } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash-es'</span>

<span class="hljs-keyword">const</span> debouncedSearch = <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> {
  <span class="hljs-title function_">search</span>(params)
}, <span class="hljs-number">300</span>)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSearch</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">debouncedSearch</span>(searchForm.<span class="hljs-property">value</span>)
}
</code></pre>
<hr/>
<h2 data-id="heading-24">代码实现</h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { ref, computed, <span class="hljs-keyword">type</span> <span class="hljs-title class_">Ref</span>, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PaginationParams</span>, <span class="hljs-title class_">SortParams</span>, <span class="hljs-title class_">TableData</span>, <span class="hljs-title class_">UseTableOptions</span>, <span class="hljs-title class_">UseTableReturn</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./type'</span>;

<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./type'</span>;

<span class="hljs-comment">/**
 * 表格 Hook
 *
 * 提供表格数据管理、分页、搜索、排序、选择等功能
 *
 * <span class="hljs-doctag">@template</span> T 表格数据类型
 * <span class="hljs-doctag">@template</span> P 请求参数类型
 * <span class="hljs-doctag">@param</span> options 配置选项
 * <span class="hljs-doctag">@returns</span> 表格操作对象
 *
 * <span class="hljs-doctag">@example</span>
 * ```typescript
 * const { data, loading, pagination, search, refresh } = useTable({
 *   request: getUserList,
 *   defaultPagination: { current: 1, pageSize: 10 },
 *   defaultSearchParams: { status: 'active' }
 * })
 *
 * // 搜索
 * search({ name: 'test' })
 *
 * // 刷新
 * refresh()
 *
 * // 重置
 * reset()
 * ```
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useTable&lt;T = <span class="hljs-built_in">any</span>, P = <span class="hljs-built_in">any</span>&gt;(<span class="hljs-attr">options</span>: <span class="hljs-title class_">UseTableOptions</span>&lt;T, P&gt;): <span class="hljs-title class_">UseTableReturn</span>&lt;T&gt; {
  <span class="hljs-keyword">const</span> {
    request,
    defaultPagination = { <span class="hljs-attr">pageNum</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span> },
    defaultSearchParams = {},
    defaultSortParams = {},
    immediate = <span class="hljs-literal">true</span>,
    paginationKey = { <span class="hljs-attr">current</span>: <span class="hljs-string">'pageNum'</span>, <span class="hljs-attr">size</span>: <span class="hljs-string">'pageSize'</span> },
    rowKey = <span class="hljs-string">'id'</span>,
    transformResponse,
    onError,
    onSuccess,
    beforeRequest
  } = options;

  <span class="hljs-comment">// 分页字段名配置</span>
  <span class="hljs-keyword">const</span> pageKey = paginationKey?.<span class="hljs-property">current</span> || <span class="hljs-string">'pageNum'</span>;
  <span class="hljs-keyword">const</span> sizeKey = paginationKey?.<span class="hljs-property">size</span> || <span class="hljs-string">'pageSize'</span>;

  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> tableData = ref&lt;<span class="hljs-title class_">TableData</span>&lt;T&gt;&gt;({
    <span class="hljs-attr">list</span>: [],
    <span class="hljs-attr">total</span>: <span class="hljs-number">0</span>
  });
  <span class="hljs-keyword">const</span> searchParams = ref&lt;<span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;({ ...defaultSearchParams });
  <span class="hljs-keyword">const</span> pagination = ref&lt;<span class="hljs-title class_">PaginationParams</span>&gt;({
    <span class="hljs-attr">pageNum</span>: defaultPagination.<span class="hljs-property">pageNum</span> || <span class="hljs-number">1</span>,
    <span class="hljs-attr">pageSize</span>: defaultPagination.<span class="hljs-property">pageSize</span> || <span class="hljs-number">10</span>,
    <span class="hljs-attr">total</span>: defaultPagination.<span class="hljs-property">total</span>
  });
  <span class="hljs-keyword">const</span> sortParams = ref&lt;<span class="hljs-title class_">SortParams</span>&gt;({ ...defaultSortParams });
  <span class="hljs-keyword">const</span> selectedRowKeys = ref&lt;(<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>)[]&gt;([]);
  <span class="hljs-keyword">const</span> selectedRows = ref&lt;T[]&gt;([]);

  <span class="hljs-comment">// table数据</span>
  <span class="hljs-keyword">const</span> data = computed&lt;T[]&gt;(<span class="hljs-function">() =&gt;</span> tableData.<span class="hljs-property">value</span>.<span class="hljs-property">list</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> T[]);
  <span class="hljs-comment">// 是否有数据</span>
  <span class="hljs-keyword">const</span> hasData = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> data.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>);

  <span class="hljs-comment">/**
   * 获取行键
   */</span>
  <span class="hljs-keyword">const</span> getRowKey = (<span class="hljs-attr">record</span>: T): <span class="hljs-built_in">string</span> | <span class="hljs-function"><span class="hljs-params">number</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> rowKey === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">rowKey</span>(record);
    }
    <span class="hljs-keyword">return</span> (record <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)[rowKey];
  };

  <span class="hljs-comment">/**
   * 构建请求参数
   */</span>
  <span class="hljs-keyword">const</span> buildRequestParams = (): <span class="hljs-function"><span class="hljs-params">P</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> params = {
      ...searchParams.<span class="hljs-property">value</span>,
      [pageKey]: pagination.<span class="hljs-property">value</span>.<span class="hljs-property">pageNum</span>,
      [sizeKey]: pagination.<span class="hljs-property">value</span>.<span class="hljs-property">pageSize</span>
    } <span class="hljs-keyword">as</span> P;

    <span class="hljs-keyword">if</span> (sortParams.<span class="hljs-property">value</span>.<span class="hljs-property">field</span> &amp;&amp; sortParams.<span class="hljs-property">value</span>.<span class="hljs-property">order</span>) {
      (params <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">sortField</span> = sortParams.<span class="hljs-property">value</span>.<span class="hljs-property">field</span>;
      (params <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">sortOrder</span> = sortParams.<span class="hljs-property">value</span>.<span class="hljs-property">order</span>;
    }

    <span class="hljs-keyword">return</span> params;
  };

  <span class="hljs-comment">/**
   * 更新table数据 如：删除一行数据后，不想触发获取列表的接口，可通过此方法手动更新数据
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateData</span> = (<span class="hljs-params">data: T[]</span>) =&gt; {
    tableData.<span class="hljs-property">value</span> = {
      ...tableData.<span class="hljs-property">value</span>,
      <span class="hljs-attr">list</span>: data
    };
  };

  <span class="hljs-comment">/**
   * 执行数据请求
   */</span>
  <span class="hljs-keyword">const</span> fetchData = <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {
    <span class="hljs-keyword">try</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;

      <span class="hljs-keyword">let</span> params = <span class="hljs-title function_">buildRequestParams</span>();

      <span class="hljs-comment">// 请求前处理</span>
      <span class="hljs-keyword">if</span> (beforeRequest) {
        params = <span class="hljs-keyword">await</span> <span class="hljs-title function_">beforeRequest</span>(params);
      }

      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">request</span>(params);

      <span class="hljs-keyword">let</span> data = response;

      <span class="hljs-keyword">if</span> (transformResponse) {
        data = <span class="hljs-title function_">transformResponse</span>(response);
      }

      tableData.<span class="hljs-property">value</span> = {
        <span class="hljs-attr">list</span>: data.<span class="hljs-property">list</span> || [],
        <span class="hljs-attr">total</span>: data.<span class="hljs-property">total</span> || <span class="hljs-number">0</span>
      };

      pagination.<span class="hljs-property">value</span>.<span class="hljs-property">total</span> = tableData.<span class="hljs-property">value</span>.<span class="hljs-property">total</span>;

      onSuccess?.(tableData.<span class="hljs-property">value</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">TableData</span>&lt;T&gt;);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'useTable fetchData error:'</span>, error);
      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败，请稍后重试'</span>);
      onError?.(error);
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    }
  };

  <span class="hljs-comment">/**
   * 刷新数据（保持当前分页和搜索条件）
   */</span>
  <span class="hljs-keyword">const</span> refresh = <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
  };

  <span class="hljs-comment">/**
   * 重新加载数据（重置到第一页）
   */</span>
  <span class="hljs-keyword">const</span> reload = <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {
    pagination.<span class="hljs-property">value</span>.<span class="hljs-property">pageNum</span> = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
  };

  <span class="hljs-comment">/**
   * 搜索
   */</span>
  <span class="hljs-keyword">const</span> search = <span class="hljs-keyword">async</span> (params?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {
    <span class="hljs-keyword">if</span> (params) {
      searchParams.<span class="hljs-property">value</span> = { ...searchParams.<span class="hljs-property">value</span>, ...params };
    }
    pagination.<span class="hljs-property">value</span>.<span class="hljs-property">pageNum</span> = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
  };

  <span class="hljs-comment">/**
   * 重置搜索
   */</span>
  <span class="hljs-keyword">const</span> reset = <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {
    searchParams.<span class="hljs-property">value</span> = { ...defaultSearchParams };
    sortParams.<span class="hljs-property">value</span> = { ...defaultSortParams };
    pagination.<span class="hljs-property">value</span>.<span class="hljs-property">pageNum</span> = defaultPagination.<span class="hljs-property">pageNum</span>!;
    pagination.<span class="hljs-property">value</span>.<span class="hljs-property">pageSize</span> = defaultPagination.<span class="hljs-property">pageSize</span>!;
    selectedRowKeys.<span class="hljs-property">value</span> = [];
    selectedRows.<span class="hljs-property">value</span> = [];
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
  };

  <span class="hljs-comment">/**
   * 设置分页
   */</span>
  <span class="hljs-keyword">const</span> setPagination = (<span class="hljs-attr">paginationParams</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">PaginationParams</span>&gt;): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(pagination.<span class="hljs-property">value</span>, paginationParams);
    <span class="hljs-title function_">fetchData</span>();
  };

  <span class="hljs-comment">/**
   * 设置排序
   */</span>
  <span class="hljs-keyword">const</span> setSortParams = (<span class="hljs-attr">sortParamsData</span>: <span class="hljs-title class_">SortParams</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    sortParams.<span class="hljs-property">value</span> = { ...sortParamsData };
    <span class="hljs-title function_">fetchData</span>();
  };

  <span class="hljs-comment">/**
   * 设置选中行
   */</span>
  <span class="hljs-keyword">const</span> setSelectedRowKeys = (<span class="hljs-attr">keys</span>: (<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>)[]): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    selectedRowKeys.<span class="hljs-property">value</span> = keys;
    selectedRows.<span class="hljs-property">value</span> = (tableData.<span class="hljs-property">value</span>.<span class="hljs-property">list</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> T[]).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span>
      keys.<span class="hljs-title function_">includes</span>(<span class="hljs-title function_">getRowKey</span>(item))
    );
  };

  <span class="hljs-comment">/**
   * 清空选中
   */</span>
  <span class="hljs-keyword">const</span> clearSelection = (): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    selectedRowKeys.<span class="hljs-property">value</span> = [];
    selectedRows.<span class="hljs-property">value</span> = [];
  };

  <span class="hljs-comment">/**
   * Element Plus: 表格排序变更事件处理
   */</span>
  <span class="hljs-keyword">const</span> onSortChange = (
    <span class="hljs-attr">payload</span>: { prop?: <span class="hljs-built_in">string</span>; order?: <span class="hljs-string">'ascending'</span> | <span class="hljs-string">'descending'</span> | <span class="hljs-literal">null</span> } | <span class="hljs-built_in">any</span>
  ): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">prop</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span> = payload?.<span class="hljs-property">prop</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">order</span>: <span class="hljs-string">'ascending'</span> | <span class="hljs-string">'descending'</span> | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span> = payload?.<span class="hljs-property">order</span>;
    <span class="hljs-keyword">if</span> (prop &amp;&amp; order) {
      <span class="hljs-title function_">setSortParams</span>({ <span class="hljs-attr">field</span>: prop, <span class="hljs-attr">order</span>: order === <span class="hljs-string">'ascending'</span> ? <span class="hljs-string">'ascend'</span> : <span class="hljs-string">'descend'</span> });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">setSortParams</span>({});
    }
  };

  <span class="hljs-comment">/**
   * Element Plus: 表格选择变更事件处理
   */</span>
  <span class="hljs-keyword">const</span> onSelectionChange = (<span class="hljs-attr">selection</span>: T[]): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> keys = selection.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-title function_">getRowKey</span>(item));
    <span class="hljs-title function_">setSelectedRowKeys</span>(keys);
  };

  <span class="hljs-comment">/**
   * Element Plus: 分页当前页变更事件处理
   */</span>
  <span class="hljs-keyword">const</span> onCurrentChange = (<span class="hljs-attr">current</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    <span class="hljs-title function_">setPagination</span>({ <span class="hljs-attr">pageNum</span>: current });
  };

  <span class="hljs-comment">/**
   * Element Plus: 分页每页条数变更事件处理
   */</span>
  <span class="hljs-keyword">const</span> onSizeChange = (<span class="hljs-attr">size</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
    <span class="hljs-title function_">setPagination</span>({ <span class="hljs-attr">pageSize</span>: size, <span class="hljs-attr">pageNum</span>: <span class="hljs-number">1</span> });
  };

  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (immediate) {
      <span class="hljs-title function_">fetchData</span>();
    }
  });

  <span class="hljs-keyword">return</span> {
    data,
    hasData,
    loading,
    pagination,
    searchParams,
    sortParams,
    selectedRowKeys,
    <span class="hljs-attr">selectedRows</span>: selectedRows <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Ref</span>&lt;T[]&gt;,
    refresh,
    reload,
    search,
    reset,
    updateData,
    setPagination,
    setSortParams,
    setSelectedRowKeys,
    clearSelection,
    getRowKey,
    onSortChange,
    onSelectionChange,
    onCurrentChange,
    onSizeChange
  };
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useTable;

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis-Plus踩坑血泪史：那些年我们踩过的坑！]]></title>    <link>https://juejin.cn/post/7576018857368485931</link>    <guid>https://juejin.cn/post/7576018857368485931</guid>    <pubDate>2025-11-24T10:33:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576018857368485931" data-draft-id="7576026767372058643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis-Plus踩坑血泪史：那些年我们踩过的坑！"/> <meta itemprop="keywords" content="MyBatis,Java,面试"/> <meta itemprop="datePublished" content="2025-11-24T10:33:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis-Plus踩坑血泪史：那些年我们踩过的坑！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:33:57.000Z" title="Mon Nov 24 2025 10:33:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>前言</strong>：我们在生产环境里跑MyBatis-Plus很多年，几乎把能踩的坑都踩过了。每次出事故，都能追溯到我们当初以为“框架会帮忙搞定”的某个细节。于是我们把这些真实经历写下来，用更接地气的方式聊聊根因和解法，帮你少熬几次夜。</p>
</blockquote>
<h2 data-id="heading-0">1、时代背景与ORM选择</h2>
<h3 data-id="heading-1">1.1 互联网时代的数据挑战</h3>
<p>业务量暴涨，数据也跟着狂飙。百万级数据在几年前还算大，如今动不动就上亿。与此同时，微服务拆分得越来越细，数据访问层变得又厚又复杂。大家一边要追新需求，一边又要兼顾性能稳定。没有趁手的开发工具，根本顶不住节奏。</p>
<h3 data-id="heading-2">1.2 MyBatis-Plus的诞生与定位</h3>
<p>于是，Java团队开始在ORM世界里不断找平衡。Hibernate太重，原生MyBatis又太多手工活。MyBatis-Plus正是在这种“又想快又想稳”的诉求下出现的。它不是简单的“语法糖”，而是一个<strong>为了生产环境而生的增强框架</strong>。</p>
<p><strong>MyBatis-Plus的核心价值</strong>：</p>
<ul>
<li><strong>简化开发</strong>：CRUD都有封装，少写很多SQL，手更轻</li>
<li><strong>功能增强</strong>：逻辑删除、自动填充、乐观锁、多租户、代码生成器等都现成</li>
<li><strong>性能优化</strong>：内置分页、性能分析、批量优化、缓存插件，跑得更快</li>
<li><strong>无缝集成</strong>：兼容MyBatis，老项目也能慢慢替换，几乎不用重构</li>
</ul>
<p>这些卖点让MyBatis-Plus迅速走红。不过，功能多并不等于好用。特别是到了生产环境，隐藏的坑一个接一个。</p>
<hr/>
<h2 data-id="heading-3">2、生产环境挑战</h2>
<p>开发环境里一切都很顺。<code>saveBatch()</code>轻松搞定批量插入，<code>@TableId(type = IdType.ASSIGN_ID)</code>一写就有分布式ID，看起来稳得很。</p>
<p>然而，真正部署上线后问题才暴露出来。</p>
<p><strong>凌晨3点的告警</strong>：主键冲突，订单系统停摆。我们发现两个容器实例生成了同一个雪花ID。理论上“不可能发生”的事，就这么发生了。</p>
<p>再往下排查，批量操作乱序、枚举字段写入异常、自动填充失灵……问题一个比一个离谱。</p>
<p>这些事故有个共同点：开发环境一切正常，生产环境却崩成一片。根本原因是单机和分布式、低并发和高并发之间的差异，被框架默认配置无限放大，结果就是“看着没事”的代码在生产里频频掉链子。</p>
<p>我们因此整理出MyBatis-Plus在生产环境最容易暴雷的6大陷阱：</p>
<ol>
<li><strong>雪花算法ID生成重复问题</strong></li>
<li><strong>批量插入乱序问题</strong></li>
<li><strong>枚举字段存储风险</strong></li>
<li><strong>驼峰转换错位</strong></li>
<li><strong>批量操作时自动填充失效</strong></li>
<li><strong>写入时JSON数据丢失或格式异常</strong></li>
</ol>
<p>接下来我们把这些问题逐一拆开，聊聊背后的逻辑，再给出实测可行的解法。</p>
<hr/>
<h2 data-id="heading-4">雪花算法ID生成重复问题</h2>
<h3 data-id="heading-5">3.1 问题现象</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 看起来很正常的代码</span>
<span class="hljs-meta">@TableId(value = "id", type = IdType.ASSIGN_ID)</span>
<span class="hljs-keyword">private</span> Long id;

<span class="hljs-comment">// 但在生产环境中却出现了这样的错误：</span>
<span class="hljs-comment">// Duplicate entry '1234567890123456789' for key 'PRIMARY'</span>
</code></pre>
<p><strong>“ID怎么还能撞？”</strong> 这是我们第一次遇到时的真实反应。</p>
<h3 data-id="heading-6">3.2 雪花算法身份证结构</h3>
<p>先搞清楚雪花ID里面装了什么，再谈如何防重复。可以把它想成一个<strong>超长身份证号</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">身份证号码：<span class="hljs-number">1234567890123456789</span>
分解结构：
┌─────────┬─────────┬─────────┬─────────┐
│  时间戳  │ 数据中心 │ 机器编号 │ 序列号  │
│ (<span class="hljs-number">41</span>位)  │ (<span class="hljs-number">5</span>位)   │ (<span class="hljs-number">5</span>位)   │ (<span class="hljs-number">12</span>位)  │
└─────────┴─────────┴─────────┴─────────┘
</code></pre>
<ul>
<li><strong>时间戳</strong>像出生年月日</li>
<li><strong>数据中心ID</strong>类似省份</li>
<li><strong>机器ID</strong>对应城市</li>
<li><strong>序列号</strong>就是同一毫秒的排队号</li>
</ul>
<h3 data-id="heading-7">3.3 问题根源</h3>
<p>我们把雪花ID重复的元凶总结成四类。</p>
<h4 data-id="heading-8">3.3.1 元凶一：未配置机器ID，所有实例走默认值</h4>
<p>很多人以为框架会自动算出唯一的workerId，于是干脆不配。结果大家都走同一个默认流程。</p>
<p><strong>MyBatis-Plus获取机器ID的策略</strong>：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9379840880d14a11ac86b0fc9e9eb751~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585237&amp;x-signature=rVo4DnTclRpO28wXZg4WktiHOOw%3D" alt="yBatis-Plus获取机器ID的策略" loading="lazy"/></p>
<p>看似严谨，然而一旦进入第二步，容器环境下“撞车”概率直线上升。</p>
<h4 data-id="heading-9">3.3.2 元凶二：容器环境的MAC地址克隆</h4>
<p>先看Docker容器MAC地址的规律：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-title class_">Docker</span>容器<span class="hljs-variable constant_">MAC</span>地址格式：<span class="hljs-number">02</span><span class="hljs-symbol">:</span><span class="hljs-number">42</span><span class="hljs-symbol">:ac</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span><span class="hljs-symbol">:XX</span>
                     ├─────────────┤├─┤
                     固定前缀      变化部分

容器<span class="hljs-number">1</span>：<span class="hljs-number">02</span><span class="hljs-symbol">:</span><span class="hljs-number">42</span><span class="hljs-symbol">:ac</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span><span class="hljs-symbol">:</span><span class="hljs-number">02</span>
容器<span class="hljs-number">2</span>：<span class="hljs-number">02</span><span class="hljs-symbol">:</span><span class="hljs-number">42</span><span class="hljs-symbol">:ac</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span><span class="hljs-symbol">:</span><span class="hljs-number">03</span>  
容器<span class="hljs-number">3</span>：<span class="hljs-number">02</span><span class="hljs-symbol">:</span><span class="hljs-number">42</span><span class="hljs-symbol">:ac</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span><span class="hljs-symbol">:</span><span class="hljs-number">04</span>
...
</code></pre>
<p>如果继续依赖“取后两字节再模32”的做法，就会出现下面的情况：</p>
<pre><code class="hljs language-ini" lang="ini">MAC地址计算流程：
1. 提取后2字节 → 00:02, 00:03, 00:04...
2. 位运算处理 → 得到不同的中间值
3. 模32取余 → 问题就出在这里

实际结果：
├─ 容器1-32：机器<span class="hljs-attr">ID</span> = <span class="hljs-number">0</span>-<span class="hljs-number">31</span> ✅
├─ 容器33：机器<span class="hljs-attr">ID</span> = <span class="hljs-number">0</span> ❌
├─ 容器34：机器<span class="hljs-attr">ID</span> = <span class="hljs-number">1</span> ❌
└─ 以此类推...
</code></pre>
<p>如此可见，只要实例超过32个，就一定有重复。</p>
<h4 data-id="heading-10">3.3.3 元凶三：Kubernetes环境的虚拟MAC</h4>
<p>再看K8s。Pod里的网络接口本来就是虚拟的，MAC地址由CNI随机分配，还可能拿不到。
Kubernetes Pod网络特点：</p>
<ol>
<li>每个Pod都有虚拟网络接口</li>
<li>MAC地址由CNI插件分配</li>
<li>同一节点的Pod可能模式一致</li>
<li>某些环境下干脆拿不到MAC
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63afa6655bd94b2ca6ac9bfd7dda7992~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585237&amp;x-signature=uGX5C86XExDhN7PM0P8614khjKk%3D" alt="yBatis-Plus获取机器MAC地址" loading="lazy"/></li>
</ol>
<p>这种情况下，100个Pod全用workerId=1，冲突直接拉满。</p>
<h4 data-id="heading-11">3.3.4 元凶四：时钟回拨</h4>
<p>雪花算法非常依赖系统时间。一旦时钟被调回，就会闹出大问题。</p>
<p>雪花ID生成流程如下所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ba1c288dbad43a4851c820f8e746720~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585237&amp;x-signature=poCH4A8q1wGGZC2tuSp9QYgh4rE%3D" alt="雪花ID生成流程" loading="lazy"/>
但是，如何出现时钟回拨，就会出现如下问题
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77e0b8d6b11f4e139f23c14a23bf4950~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585237&amp;x-signature=BRn6Hp0DE6X808TLRaksxNXnstY%3D" alt="时钟回拨" loading="lazy"/></p>
<p>当以下条件同时满足时，重复就无可避免：</p>
<pre><code class="hljs language-ini" lang="ini">相同的机器ID (<span class="hljs-attr">workerId</span>=<span class="hljs-number">1</span>)
相同的数据中心ID (<span class="hljs-attr">datacenterId</span>=<span class="hljs-number">1</span>)  
相同的时间戳 (<span class="hljs-attr">timestamp</span>=<span class="hljs-number">1634567890123</span>)
相同的序列号 (<span class="hljs-attr">sequence</span>=<span class="hljs-number">0</span>)
</code></pre>
<h3 data-id="heading-12">3.4 解决方案：给每台机器一个专属身份证</h3>
<h4 data-id="heading-13">方案一：外部获取唯一的分布式ID</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdHelper</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>   <span class="hljs-type">long</span> <span class="hljs-title function_">getIdc</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> ZZIdcClient.getInstance().get();
        } <span class="hljs-keyword">catch</span> (Throwable e) {
            log.error(<span class="hljs-string">"act=getIdc error={}"</span>, e.getMessage());
        }
        <span class="hljs-comment">// 兜底逻辑：为了不影响业务，如果从架构拿不到id，就采用IDHelper</span>
        <span class="hljs-comment">// IDHelper有问题，并发情况下可能会生成重复id</span>
        log.info(<span class="hljs-string">"k=s act=getIdcByIDHelper"</span>);
        <span class="hljs-keyword">return</span> IDHelper.generator(<span class="hljs-number">0</span>);
    }
}
</code></pre>
<h4 data-id="heading-14">方案二：使用数据库自增ID</h4>
<pre><code class="hljs language-java" lang="java">

<span class="hljs-keyword">package</span> com.baomidou.mybatisplus.annotation;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">IdType</span> {
    AUTO(<span class="hljs-number">0</span>),
    NONE(<span class="hljs-number">1</span>),
    INPUT(<span class="hljs-number">2</span>),
    ASSIGN_ID(<span class="hljs-number">3</span>),
    ASSIGN_UUID(<span class="hljs-number">4</span>),
    <span class="hljs-comment">/** <span class="hljs-doctag">@deprecated</span> */</span>
    <span class="hljs-meta">@Deprecated</span>
    ID_WORKER(<span class="hljs-number">3</span>),
    <span class="hljs-comment">/** <span class="hljs-doctag">@deprecated</span> */</span>
    <span class="hljs-meta">@Deprecated</span>
    ID_WORKER_STR(<span class="hljs-number">3</span>),
    <span class="hljs-comment">/** <span class="hljs-doctag">@deprecated</span> */</span>
    <span class="hljs-meta">@Deprecated</span>
    UUID(<span class="hljs-number">4</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> key;
}

    <span class="hljs-comment">/**
     * 主键ID
     */</span>
    <span class="hljs-meta">@TableId(value = "id", type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
</code></pre>
<hr/>
<h2 data-id="heading-15">4、批量插入乱序问题</h2>
<h3 data-id="heading-16">4.1 问题现象</h3>
<p>场景1：父子订单批量插入。当子订单准备入库时，父订单还没完成，外键直接挂掉。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 期望：先插入父订单，再插入子订单</span>
heroPackageService.saveBatch(packages);  <span class="hljs-comment">// 父订单</span>
heroOrderService.saveBatch(orders);      <span class="hljs-comment">// 子订单</span>

<span class="hljs-comment">// 结果：外键约束失败！</span>
<span class="hljs-comment">// Cannot add or update a child row: a foreign key constraint fails</span>
</code></pre>
<p>场景2：远程接口返回一个有序列表，我们存到数据库里，想在后续查询中保持原有顺序，结果还是乱了。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 期望：远程获取数据之后，存在数据库，后续从数据库获取有序列表的快照</span>
<span class="hljs-comment">//远程获取外部有序集合</span>
List&lt;HeroPackage&gt; heroPackageList = recycleRpcService.getHeroPackageList(uid)
<span class="hljs-comment">//将远程获取数据存入数据库</span>
heroPackageService.saveBatch(heroPackageList)
<span class="hljs-comment">//从数据库获取有序集合数据</span>
List&lt;HeroPackage&gt; heroPackageList = heroPackageService.list(uid);


<span class="hljs-comment">// 结果：有序集合的顺序被打乱</span>
<span class="hljs-comment">// </span>
</code></pre>
<p><strong>明明是按顺序调用的，为什么会乱序？</strong></p>
<h3 data-id="heading-17">4.2 原理</h3>
<p>可以把它想成快递分拣。你按顺序交包裹，分拣中心为了效率会重排路线，于是最终顺序就变了。</p>
<h4 data-id="heading-18">4.2.1 MyBatis-Plus的两种批量插入模式</h4>
<p>官方其实有两套批量逻辑，差别非常大。</p>
<h5 data-id="heading-19">模式一：默认BATCH模式（逐条插入）</h5>
<p>MyBatis-Plus默认saveBatch的执行流程：</p>
<ol>
<li>
<p>接收数据列表</p>
<ol>
<li>List packages (1000条数据)</li>
<li>默认批次大小：1000</li>
</ol>
</li>
<li>
<p>创建批处理SqlSession</p>
<ol>
<li>使用 ExecutorType.BATCH</li>
<li>逐条执行INSERT</li>
</ol>
</li>
<li>
<p>逐条加入批处理队列</p>
<ol>
<li>第1条：INSERT INTO hero_package VALUES (...)</li>
<li>第2条：INSERT INTO hero_package VALUES (...)</li>
<li>...</li>
<li>第1000条：INSERT INTO hero_package VALUES (...)</li>
</ol>
</li>
<li>
<p>达到批次大小后 flushStatements()</p>
</li>
</ol>
<p>特点：</p>
<ol>
<li>支持主键回填</li>
<li>单线程下顺序可控</li>
<li>多线程+驱动优化后容易乱序</li>
<li>网络往返次数多，性能一般</li>
</ol>
<h5 data-id="heading-20">模式二：优化批处理模式（合并SQL）</h5>
<p>配置方式：要么改全局配置，要么写自定义SQL</p>
<p>执行流程：</p>
<ol>
<li>接收列表</li>
<li>foreach拼成一条多值INSERT</li>
<li>一次性落库</li>
</ol>
<p>特点：</p>
<ol>
<li>单次往返，性能高</li>
<li>顺序完全可控</li>
<li>主键需要自己准备</li>
<li>SQL过长时得自行分批</li>
</ol>
<p><strong>两种模式对比</strong>：</p>






























<table><thead><tr><th>特性</th><th>默认BATCH模式</th><th>优化批处理模式</th></tr></thead><tbody><tr><td>性能</td><td>多次往返，速度一般</td><td>单次往返，极快</td></tr><tr><td>顺序保证</td><td>单线程可控，多线程不稳</td><td>完全可控</td></tr><tr><td>主键回填</td><td>支持</td><td>不支持</td></tr><tr><td>适用场景</td><td>依赖数据库生成主键</td><td>自己能生成主键或无主键需求</td></tr></tbody></table>
<h4 data-id="heading-21">4.2.2 根本原因二：JDBC驱动的批处理重排序</h4>
<p>MySQL JDBC驱动为了提速，会把同表操作合并。原本交错的SQL被重新分组，顺序自然就乱了。</p>
<p>JDBC批处理模式：</p>
<p>模式1：rewriteBatchedStatements=false</p>
<ol>
<li>逐条执行</li>
<li>顺序稳定</li>
<li>性能一般</li>
</ol>
<p>模式2：rewriteBatchedStatements=true</p>
<ol>
<li>自动合并SQL</li>
<li>性能飙升</li>
<li>顺序可能被“优化”</li>
</ol>
<pre><code class="hljs language-sql" lang="sql">
例子：
原始<span class="hljs-keyword">SQL</span>：
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_package <span class="hljs-keyword">VALUES</span> (..)
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_order <span class="hljs-keyword">VALUES</span> (..)
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_package <span class="hljs-keyword">VALUES</span> (..)
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_order <span class="hljs-keyword">VALUES</span> (..)

驱动优化后：
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_package <span class="hljs-keyword">VALUES</span> (...), (...)
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_order <span class="hljs-keyword">VALUES</span> (...), (...)

</code></pre>
<p>顺序彻底变了。</p>
<h4 data-id="heading-22">4.2.3 根本原因三：数据库层面的执行优化</h4>
<p>MySQL优化器也会“帮忙”重排执行计划。同一张表的操作被集中，避免频繁切换表，性能是好了，但依赖顺序的逻辑直接崩。</p>
<pre><code class="hljs language-sql" lang="sql">期望：
Package1 → Order1 → Package2 → Order2

实际：
Package1, Package2 → Order1, Order2

优化器心声：
既然都是<span class="hljs-keyword">INSERT</span>，就分组吧
省得来回切换表         
</code></pre>
<p>问题在于，Order引用Package的主键。如果Package还没落库，Order插入必失败。</p>
<p>例如下面的真实案例。两个线程并发创建订单。批处理时队列不保证FIFO，于是订单项和订单的关系全乱套。</p>
<p>期望：
订单A → 订单项A → 订单B → 订单项B</p>
<p>现实：
线程A、线程B同时写入
批处理队列交错
驱动/数据库重排
→ 可能先执行线程B的订单项，再执行线程A的
→ 外键和业务逻辑全乱</p>
<h3 data-id="heading-23">4.3 解决方案：控制批处理节奏</h3>
<p>我们常用两个思路：要么“分批+强制刷新”，要么“自定义SQL一次写完”。</p>
<h4 data-id="heading-24">方案一：分批次执行，强制刷新</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrdersInSequence</span><span class="hljs-params">(List&lt;OrderData&gt; orderDataList)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; orderDataList.size(); i += batchSize) {
        List&lt;OrderData&gt; batch = orderDataList.subList(i, 
            Math.min(i + batchSize, orderDataList.size()));
        
        <span class="hljs-comment">// 先插入父订单</span>
        List&lt;HeroPackage&gt; packages = buildPackages(batch);
        heroPackageService.saveBatch(packages);
        sqlSession.flushStatements(); <span class="hljs-comment">// 强制执行，确保顺序</span>
        
        <span class="hljs-comment">// 再插入子订单</span>
        List&lt;HeroOrder&gt; orders = buildOrders(batch);
        heroOrderService.saveBatch(orders);
        sqlSession.flushStatements();
    }
}
</code></pre>
<h4 data-id="heading-25">方案二：自定义SQL，一次性插入</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用自定义SQL，完全控制执行顺序</span>
<span class="hljs-meta">@Insert({
    "&lt;script&gt;",
    "INSERT INTO hero_package (id, seller_uid, create_time) VALUES ",
    "&lt;foreach collection='packages' item='pkg' separator=','&gt;",
    "(#{pkg.id}, #{pkg.sellerUid}, #{pkg.createTime})",
    "&lt;/foreach&gt;",
    "&lt;/script&gt;"
})</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">insertPackageBatch</span><span class="hljs-params">(<span class="hljs-meta">@Param("packages")</span> List&lt;HeroPackage&gt; packages)</span>;
</code></pre>
<hr/>
<h2 data-id="heading-26">5、枚举字段存储风险</h2>
<h3 data-id="heading-27">5.1 问题现象：枚举字段存储异常</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 枚举定义</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatus</span> {
    PENDING(<span class="hljs-number">1</span>, <span class="hljs-string">"待处理"</span>),
    PROCESSING(<span class="hljs-number">2</span>, <span class="hljs-string">"处理中"</span>),
    COMPLETED(<span class="hljs-number">3</span>, <span class="hljs-string">"已完成"</span>);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;
}

<span class="hljs-comment">// 实体类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroOrder</span> {
    <span class="hljs-keyword">private</span> OrderStatus orderStatus; <span class="hljs-comment">// 期望存储code值(1,2,3)</span>
}

<span class="hljs-comment">// 结果：数据库中存储的是枚举名称("PENDING", "PROCESSING", "COMPLETED")</span>
</code></pre>
<h3 data-id="heading-28">5.2 深入原理：MyBatis的默认枚举处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MyBatis默认的枚举处理器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnumTypeHandler</span>&lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;E&gt;&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;E&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i, E parameter, JdbcType jdbcType)</span> {
        <span class="hljs-comment">// 默认使用枚举的name()方法！</span>
        ps.setString(i, parameter.name()); <span class="hljs-comment">// 存储"PENDING"而不是1</span>
    }
}
</code></pre>
<h3 data-id="heading-29">5.3 解决方案：使用@EnumValue注解</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatus</span> {
    PENDING(<span class="hljs-number">1</span>, <span class="hljs-string">"待处理"</span>),
    PROCESSING(<span class="hljs-number">2</span>, <span class="hljs-string">"处理中"</span>),
    COMPLETED(<span class="hljs-number">3</span>, <span class="hljs-string">"已完成"</span>);
    
    <span class="hljs-meta">@EnumValue</span> <span class="hljs-comment">// 标记这个字段用于数据库存储</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;
    
    <span class="hljs-comment">// 构造函数和getter...</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-30">6、驼峰转换错位</h2>
<h3 data-id="heading-31">6.1 问题现象</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 数据库字段：seller_uid, buyer_uid, create_time</span>
<span class="hljs-comment">// 实体类字段：</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroPackage</span> {
    <span class="hljs-keyword">private</span> Long sellerUid;    <span class="hljs-comment">// ✅ 正常映射</span>
    <span class="hljs-keyword">private</span> Long buyerUID;     <span class="hljs-comment">// ❌ 映射失败！</span>
    <span class="hljs-keyword">private</span> Date createTime;   <span class="hljs-comment">// ✅ 正常映射</span>
    <span class="hljs-keyword">private</span> String XMLData;    <span class="hljs-comment">// ❌ 映射失败！</span>
}
</code></pre>
<h3 data-id="heading-32">6.2 原理</h3>
<p>MyBatis-Plus的驼峰转换算法对连续大写很无奈。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 驼峰转换算法（简化版）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CamelCaseConverter</span> {
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">camelToUnderscore</span><span class="hljs-params">(String camelCase)</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; camelCase.length(); i++) {
            <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> camelCase.charAt(i);
            <span class="hljs-keyword">if</span> (Character.isUpperCase(c)) {
                <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) result.append(<span class="hljs-string">'_'</span>);
                result.append(Character.toLowerCase(c));
            } <span class="hljs-keyword">else</span> {
                result.append(c);
            }
        }
        <span class="hljs-keyword">return</span> result.toString();
    }
}

<span class="hljs-comment">// 转换结果：</span>
<span class="hljs-comment">// sellerUid -&gt; seller_uid ✅</span>
<span class="hljs-comment">// buyerUID -&gt; buyer_u_i_d ❌ (期望: buyer_uid)</span>
<span class="hljs-comment">// XMLData -&gt; x_m_l_data ❌ (期望: xml_data)</span>
</code></pre>
<h3 data-id="heading-33">6.3 解决方案：明确字段映射</h3>
<h5 data-id="heading-34">方案一：使用@TableField注解</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroPackage</span> {
    <span class="hljs-keyword">private</span> Long sellerUid;
    
    <span class="hljs-meta">@TableField("buyer_uid")</span>  <span class="hljs-comment">// 明确指定数据库字段名</span>
    <span class="hljs-keyword">private</span> Long buyerUID;
    
    <span class="hljs-keyword">private</span> Date createTime;
    
    <span class="hljs-meta">@TableField("xml_data")</span>
    <span class="hljs-keyword">private</span> String XMLData;
}
</code></pre>
<h5 data-id="heading-35">方案二：统一命名规范</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 推荐的命名规范</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroPackage</span> {
    <span class="hljs-keyword">private</span> Long sellerUid;     <span class="hljs-comment">// 驼峰命名，避免连续大写</span>
    <span class="hljs-keyword">private</span> Long buyerUid;      <span class="hljs-comment">// 而不是buyerUID</span>
    <span class="hljs-keyword">private</span> Date createTime;
    <span class="hljs-keyword">private</span> String xmlData;     <span class="hljs-comment">// 而不是XMLData</span>
}
</code></pre>
<h5 data-id="heading-36">方案三：自定义命名策略</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        
        <span class="hljs-comment">// 自定义命名策略</span>
        <span class="hljs-type">GlobalConfig</span> <span class="hljs-variable">globalConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalConfig</span>();
        globalConfig.setDbConfig(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalConfig</span>.DbConfig() {{
            <span class="hljs-comment">// 自定义字段命名策略</span>
            setColumnFormat(<span class="hljs-string">"`%s`"</span>); <span class="hljs-comment">// 字段名加反引号，避免关键字冲突</span>
            setTableFormat(<span class="hljs-string">"`%s`"</span>);  <span class="hljs-comment">// 表名加反引号</span>
        }});
        
        <span class="hljs-keyword">return</span> interceptor;
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-37">7、批量操作时自动填充失效</h2>
<h3 data-id="heading-38">7.1 问题现象</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 实体类配置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroOrder</span> {
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-keyword">private</span> Date createTime;
    
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span>  
    <span class="hljs-keyword">private</span> Date updateTime;
    
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-keyword">private</span> Long createBy;
}

<span class="hljs-comment">// 自动填充处理器</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMetaObjectHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MetaObjectHandler</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createTime"</span>, Date.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createBy"</span>, Long.class, getCurrentUserId());
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-built_in">this</span>.strictUpdateFill(metaObject, <span class="hljs-string">"updateTime"</span>, Date.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
    }
}

<span class="hljs-comment">// 问题现象：批量操作时自动填充失效！</span>
List&lt;HeroOrder&gt; orders = buildOrders();
heroOrderService.saveBatch(orders); <span class="hljs-comment">// createTime和createBy为null！</span>
</code></pre>
<h3 data-id="heading-39">7.2 原理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MyBatis-Plus的自动填充机制</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSqlSession</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(String statement, Object parameter)</span> {
        <span class="hljs-comment">// 只有通过MyBatis-Plus的insert方法才会触发自动填充</span>
        <span class="hljs-keyword">if</span> (parameter <span class="hljs-keyword">instanceof</span> BaseEntity) {
            metaObjectHandler.insertFill(parameter); <span class="hljs-comment">// 触发填充</span>
        }
        <span class="hljs-keyword">return</span> executor.update(statement, parameter);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(String statement, Object parameter)</span> {
        <span class="hljs-keyword">if</span> (parameter <span class="hljs-keyword">instanceof</span> BaseEntity) {
            metaObjectHandler.updateFill(parameter); <span class="hljs-comment">// 触发填充</span>
        }
        <span class="hljs-keyword">return</span> executor.update(statement, parameter);
    }
}

<span class="hljs-comment">// 但是批量操作使用的是JDBC批处理</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveBatch</span><span class="hljs-params">(Collection&lt;T&gt; entityList)</span> {
    <span class="hljs-comment">// 直接执行批量SQL，跳过了自动填充逻辑！</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO table VALUES (?,?,?)"</span>;
    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql);
    <span class="hljs-keyword">for</span> (T entity : entityList) {
        <span class="hljs-comment">// 没有调用metaObjectHandler.insertFill()</span>
        ps.setObject(<span class="hljs-number">1</span>, entity.getId());
        ps.setObject(<span class="hljs-number">2</span>, entity.getName());
        ps.addBatch();
    }
    ps.executeBatch();
}
</code></pre>
<h3 data-id="heading-40">7.3 解决方案：手动填充 + 批量优化</h3>
<h5 data-id="heading-41">方案一：批量操作前手动填充</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedOrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MyMetaObjectHandler metaObjectHandler;
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveBatchWithFill</span><span class="hljs-params">(Collection&lt;HeroOrder&gt; entityList)</span> {
        <span class="hljs-comment">// 手动触发自动填充</span>
        entityList.forEach(entity -&gt; {
            <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> SystemMetaObject.forObject(entity);
            metaObjectHandler.insertFill(metaObject);
        });
        
        <span class="hljs-comment">// 然后执行批量保存</span>
        <span class="hljs-keyword">return</span> heroOrderService.saveBatch(entityList);
    }
}
</code></pre>
<h5 data-id="heading-42">方案二：自定义批量保存方法</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchSaveHelper</span> {
    
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveBatchWithAutoFill</span><span class="hljs-params">(Collection&lt;T&gt; entityList, 
                                           Class&lt;T&gt; entityClass,
                                           BaseMapper&lt;T&gt; mapper)</span> {
        <span class="hljs-keyword">if</span> (entityList.isEmpty()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-comment">// 获取当前用户和时间</span>
        <span class="hljs-type">Long</span> <span class="hljs-variable">currentUserId</span> <span class="hljs-operator">=</span> getCurrentUserId();
        <span class="hljs-type">Date</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
        
        <span class="hljs-comment">// 反射设置自动填充字段</span>
        entityList.forEach(entity -&gt; {
            <span class="hljs-keyword">try</span> {
                setFieldValue(entity, <span class="hljs-string">"createTime"</span>, now);
                setFieldValue(entity, <span class="hljs-string">"updateTime"</span>, now);
                setFieldValue(entity, <span class="hljs-string">"createBy"</span>, currentUserId);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.warn(<span class="hljs-string">"自动填充失败"</span>, e);
            }
        });
        
        <span class="hljs-comment">// 分批保存，避免SQL过长</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;
        List&lt;T&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(entityList);
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; list.size(); i += batchSize) {
            List&lt;T&gt; batch = list.subList(i, Math.min(i + batchSize, list.size()));
            mapper.insertBatch(batch); <span class="hljs-comment">// 自定义批量插入方法</span>
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> 
            <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(<span class="hljs-literal">true</span>);
        <span class="hljs-keyword">if</span> (field.get(obj) == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 只有为null时才设置</span>
            field.set(obj, value);
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-43">8、写入时JSON数据丢失或格式异常</h2>
<h3 data-id="heading-44">8.1 问题现象</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 实体类定义</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroPackage</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String packageName;
    
    <span class="hljs-comment">// JSON字段存储扩展属性</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; extendInfo;
    <span class="hljs-keyword">private</span> List&lt;String&gt; tags;
}

<span class="hljs-comment">// 保存数据</span>
<span class="hljs-type">HeroPackage</span> <span class="hljs-variable">pkg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HeroPackage</span>();
pkg.setExtendInfo(Map.of(<span class="hljs-string">"color"</span>, <span class="hljs-string">"红色"</span>, <span class="hljs-string">"weight"</span>, <span class="hljs-number">1.5</span>));
pkg.setTags(Arrays.asList(<span class="hljs-string">"电子产品"</span>, <span class="hljs-string">"二手"</span>, <span class="hljs-string">"9成新"</span>));
heroPackageService.save(pkg);

<span class="hljs-comment">// 查询结果：extendInfo和tags字段为null！</span>
</code></pre>
<h3 data-id="heading-45">8.2 原理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MyBatis默认只能处理基本类型</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultTypeHandlerRegistry</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultTypeHandlerRegistry</span><span class="hljs-params">()</span> {
        register(String.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTypeHandler</span>());
        register(Integer.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerTypeHandler</span>());
        register(Long.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongTypeHandler</span>());
        <span class="hljs-comment">// 没有Map和List的处理器！</span>
    }
}

<span class="hljs-comment">// 复杂对象会被toString()处理</span>
Map&lt;String, Object&gt; map = Map.of(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> map.toString(); <span class="hljs-comment">// "{key=value}" - 不是标准JSON！</span>
</code></pre>
<h3 data-id="heading-46">8.3 解决方案：数据类型规范化处理</h3>
<p>我们的共识是：能不用复杂字段就别用。如果必须用，就自己管序列化。</p>
<h5 data-id="heading-47">方案一：数据库字段类型规范化</h5>
<ul>
<li>表里尽量只放基本类型</li>
<li>Map、List先拆成具体字段，或者转成独立表</li>
<li>复杂场景在业务层处理转换</li>
</ul>
<h5 data-id="heading-48">方案二：手动序列化处理</h5>
<ul>
<li>确实需要存结构化数据时，先序列化成JSON字符串</li>
<li>存入VARCHAR或TEXT</li>
<li>查询时再反序列化</li>
</ul>
<p><strong>实施建议</strong>：
优先走方案一。只有在业务强依赖动态结构时，再考虑方案二，记得封装好序列化逻辑，别把JSON工具散落在业务代码里。</p>
<hr/>
<h2 data-id="heading-49">总结与思考</h2>
<p>种种案例都在提醒我们：<strong>框架默认值是给理想环境准备的，到了生产就得重新审视</strong>。如果不了解内部机制，就很容易掉进坑里。</p>
<p><strong>启示一：默认配置靠不住</strong><br/>
开发环境通常是单机、低并发，默认配置自然没问题。可一上生产，容器化、分布式、高并发齐聚，默认值瞬间变成隐患。<strong>别指望框架“自动”处理所有边角料</strong>。</p>
<p><strong>启示二：机制理解少不了</strong><br/>
只有搞清楚框架怎么运转，才能提前发现风险；真出事时，也能快速定位。<strong>知其然而且要知其所以然</strong>。</p>
<p><strong>启示三：方案要服务于环境</strong><br/>
你在什么环境里跑，就得配什么策略。容器、K8s、云原生都在挑战旧有假设。<strong>没有银弹，只有适配</strong>。</p>
<blockquote>
<p>关于作者，朱洪旭，侠客汇Java开发工程师。</p>
</blockquote>
<blockquote>
<p>转转研发中心及业界小伙伴们的技术学习交流平台，定期分享一线的实战经验及业界前沿的技术话题。
关注公众号「转转技术」（综合性）、「大转转FE」（专注于FE）、「转转QA」（专注于QA），更多干货实践，欢迎交流分享~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML的Video从基础使用到高级实战+兼容的完全指南]]></title>    <link>https://juejin.cn/post/7575468252657303593</link>    <guid>https://juejin.cn/post/7575468252657303593</guid>    <pubDate>2025-11-24T00:59:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575468252657303593" data-draft-id="7569898158836432937" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML的Video从基础使用到高级实战+兼容的完全指南"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-24T00:59:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML的Video从基础使用到高级实战+兼容的完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T00:59:50.000Z" title="Mon Nov 24 2025 00:59:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>HTML5 的 <code>&lt;video&gt;</code> 标签彻底改变了网页视频播放的实现方式——无需依赖 Flash 等第三方插件，原生支持跨平台视频播放，兼具轻量性与扩展性。本文将从标签基础、API 详解、事件体系、样式控制、兼容性处理等维度，全面解析 <code>&lt;video&gt;</code> 标签的技术细节与实战技巧。</p>
<h2 data-id="heading-0">1. 核心用法与属性</h2>
<p>下面是标签的核心用法与属性：</p>
<h3 data-id="heading-1">1.1. 基本语法结构</h3>
<p><code>&lt;video&gt;</code> 标签的核心作用是嵌入视频资源，最简用法如下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 基础用法：指定视频源与基础控制 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"video.mp4"</span> <span class="hljs-attr">controls</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"640"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"360"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 降级提示：浏览器不支持 video 标签时显示 --&gt;</span>
  您的浏览器不支持 HTML5 视频播放，请升级浏览器或更换观看方式。
<span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">1.2. 核心属性详解</h3>




























































<table><thead><tr><th>属性名</th><th>取值</th><th>功能说明</th></tr></thead><tbody><tr><td><code>src</code></td><td>视频文件 URL</td><td>指定单个视频源（优先推荐使用 <code>&lt;source&gt;</code> 标签适配多格式）</td></tr><tr><td><code>controls</code></td><td>布尔值（省略则生效）</td><td>显示浏览器原生控制栏（播放/暂停、音量、进度条等）</td></tr><tr><td><code>autoplay</code></td><td>布尔值</td><td>页面加载完成后自动播放（注意：多数浏览器要求静音才能自动播放）</td></tr><tr><td><code>muted</code></td><td>布尔值</td><td>视频默认静音</td></tr><tr><td><code>loop</code></td><td>布尔值</td><td>视频播放完毕后自动循环</td></tr><tr><td><code>preload</code></td><td><code>auto</code>/<code>metadata</code>/<code>none</code></td><td>预加载策略：<br/>- <code>auto</code>：自动预加载整个视频（默认）<br/>- <code>metadata</code>：仅预加载元数据（时长、尺寸等）<br/>- <code>none</code>：不预加载任何内容</td></tr><tr><td><code>poster</code></td><td>图片 URL</td><td>视频加载完成前/未播放时显示的封面图</td></tr><tr><td><code>width</code>/<code>height</code></td><td>像素值（如 <code>640</code>）</td><td>视频播放器的宽高（建议通过 CSS 控制，更灵活）</td></tr><tr><td><code>playsinline</code></td><td>布尔值</td><td>允许视频在页面内播放（而非全屏，移动端必备）</td></tr><tr><td><code>webkit-playsinline</code></td><td>布尔值</td><td>iOS Safari 兼容属性（与 <code>playsinline</code> 配合使用）</td></tr></tbody></table>
<h3 data-id="heading-3">1.3. 多格式适配： 标签</h3>
<p>不同浏览器对视频格式支持存在差异（如 MP4 兼容所有现代浏览器，WebM 体积更小但兼容性较差），需通过 <code>&lt;source&gt;</code> 标签提供多格式备选：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">controls</span> <span class="hljs-attr">poster</span>=<span class="hljs-string">"cover.jpg"</span> <span class="hljs-attr">playsinline</span> <span class="hljs-attr">webkit-playsinline</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 浏览器会按顺序选择支持的格式 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"video.mp4"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"video/mp4"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"video.webm"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"video/webm"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"video.ogg"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"video/ogg"</span>&gt;</span>
  您的浏览器不支持 HTML5 视频播放，请升级浏览器。
<span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
</code></pre>
<p><strong>推荐格式组合</strong>：MP4（主格式）+ WebM（备选），覆盖 99% 以上现代浏览器。</p>
<h2 data-id="heading-4">2. 核心 API：通过JavaScript控制</h2>
<p><code>&lt;video&gt;</code> 元素暴露了丰富的 JavaScript API，可实现自定义播放逻辑、状态查询等功能。获取视频元素后即可调用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> video = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'video'</span>); <span class="hljs-comment">// 获取视频元素</span>
</code></pre>
<h3 data-id="heading-5">2.1. 核心方法</h3>





























<table><thead><tr><th>方法名</th><th>功能说明</th></tr></thead><tbody><tr><td><code>play()</code></td><td>开始播放视频，返回 Promise（需处理播放失败场景）</td></tr><tr><td><code>pause()</code></td><td>暂停播放视频</td></tr><tr><td><code>load()</code></td><td>重新加载视频资源（常用于切换视频源后）</td></tr><tr><td><code>canPlayType(type)</code></td><td>检测浏览器是否支持指定视频格式（返回 <code>probably</code>/<code>maybe</code>/<code>""</code>）</td></tr><tr><td><code>requestFullscreen()</code></td><td>进入全屏模式（需兼容前缀：<code>webkitRequestFullscreen</code> 等）</td></tr></tbody></table>
<h3 data-id="heading-6">2.2. 关键属性（可读写/只读）</h3>
<h4 data-id="heading-7">（1）可读写属性（控制视频行为）</h4>



































<table><thead><tr><th>属性名</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>currentTime</code></td><td>Number</td><td>当前播放位置（秒），可设置跳转</td></tr><tr><td><code>volume</code></td><td>Number</td><td>音量（0~1，0 为静音，1 为最大音量）</td></tr><tr><td><code>playbackRate</code></td><td>Number</td><td>播放速率（1 为正常，0.5 为慢放，2 为快放）</td></tr><tr><td><code>muted</code></td><td>Boolean</td><td>设置是否静音（与标签属性一致）</td></tr><tr><td><code>loop</code></td><td>Boolean</td><td>设置是否循环（与标签属性一致）</td></tr></tbody></table>
<h4 data-id="heading-8">（2）只读属性（获取视频状态）</h4>








































<table><thead><tr><th>属性名</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>duration</code></td><td>Number</td><td>视频总时长（秒），未加载完成时为 NaN</td></tr><tr><td><code>paused</code></td><td>Boolean</td><td>是否处于暂停状态（true 为暂停）</td></tr><tr><td><code>playing</code></td><td>Boolean</td><td>是否正在播放（H5 新增，需兼容）</td></tr><tr><td><code>buffered</code></td><td>TimeRanges</td><td>已缓冲的时间范围（通过 <code>buffered.start(0)</code>/<code>buffered.end(0)</code> 获取）</td></tr><tr><td><code>readyState</code></td><td>Number</td><td>视频就绪状态：<br/>0 = 未就绪<br/>1 = 元数据就绪<br/>2 = 当前帧就绪<br/>3 = 可播放（已缓冲部分内容）<br/>4 = 完全就绪</td></tr><tr><td><code>networkState</code></td><td>Number</td><td>网络状态：<br/>0 = 未初始化<br/>1 = 正在加载<br/>2 = 加载完成<br/>3 = 加载失败</td></tr></tbody></table>
<h3 data-id="heading-9">2.3. API 实战示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> video = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'video'</span>);

<span class="hljs-comment">// 1. 播放/暂停切换</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'playBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (video.<span class="hljs-property">paused</span>) {
    <span class="hljs-comment">// 处理自动播放限制（需静音或用户交互后）</span>
    video.<span class="hljs-title function_">play</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'播放失败：'</span>, err);
      video.<span class="hljs-property">muted</span> = <span class="hljs-literal">true</span>;
      video.<span class="hljs-title function_">play</span>(); <span class="hljs-comment">// 静音后重试自动播放</span>
    });
  } <span class="hljs-keyword">else</span> {
    video.<span class="hljs-title function_">pause</span>();
  }
});

<span class="hljs-comment">// 2. 跳转至指定时间（如 30 秒）</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'jumpBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  video.<span class="hljs-property">currentTime</span> = <span class="hljs-number">30</span>;
});

<span class="hljs-comment">// 3. 调整音量（50%）</span>
video.<span class="hljs-property">volume</span> = <span class="hljs-number">0.5</span>;

<span class="hljs-comment">// 4. 快放（1.5 倍速）</span>
video.<span class="hljs-property">playbackRate</span> = <span class="hljs-number">1.5</span>;

<span class="hljs-comment">// 5. 检测格式支持</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'MP4 支持：'</span>, video.<span class="hljs-title function_">canPlayType</span>(<span class="hljs-string">'video/mp4'</span>) !== <span class="hljs-string">''</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'WebM 支持：'</span>, video.<span class="hljs-title function_">canPlayType</span>(<span class="hljs-string">'video/webm'</span>) !== <span class="hljs-string">''</span>);
</code></pre>
<h2 data-id="heading-10">3. 监听视频生命周期与状态变化事件</h2>
<p><code>&lt;video&gt;</code> 标签提供了完整的事件机制，可监听播放状态、加载进度、错误等场景，是实现自定义控制逻辑的核心。</p>
<h3 data-id="heading-11">3.1. 核心事件分类与说明</h3>






































































<table><thead><tr><th>事件名</th><th>触发时机</th><th>应用场景</th></tr></thead><tbody><tr><td><code>loadedmetadata</code></td><td>视频元数据（时长、尺寸等）加载完成</td><td>获取视频总时长 <code>duration</code></td></tr><tr><td><code>loadeddata</code></td><td>第一帧视频加载完成并可显示</td><td>隐藏加载动画、显示视频画面</td></tr><tr><td><code>canplay</code></td><td>视频已缓冲足够数据，可开始播放（可能卡顿）</td><td>启用播放按钮</td></tr><tr><td><code>canplaythrough</code></td><td>视频已缓冲至末尾，可流畅播放</td><td>提示“可流畅观看”</td></tr><tr><td><code>play</code></td><td>调用 <code>play()</code> 后开始播放时</td><td>切换播放按钮状态（暂停图标）</td></tr><tr><td><code>pause</code></td><td>调用 <code>pause()</code> 或播放暂停时</td><td>切换播放按钮状态（播放图标）</td></tr><tr><td><code>timeupdate</code></td><td>播放位置 <code>currentTime</code> 变化时（约 250ms 一次）</td><td>更新进度条、显示当前播放时间</td></tr><tr><td><code>progress</code></td><td>视频缓冲时持续触发</td><td>更新缓冲进度条</td></tr><tr><td><code>ended</code></td><td>视频播放完毕时</td><td>显示“播放完成”提示、自动重播</td></tr><tr><td><code>error</code></td><td>视频加载/播放失败时</td><td>显示错误提示（通过 <code>error.code</code> 获取错误类型）</td></tr><tr><td><code>volumechange</code></td><td>音量/静音状态变化时</td><td>更新音量图标</td></tr><tr><td><code>fullscreenchange</code></td><td>全屏状态变化时</td><td>切换全屏/退出全屏按钮</td></tr></tbody></table>
<h3 data-id="heading-12">3.2. 事件监听实战示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> video = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'video'</span>);
<span class="hljs-keyword">const</span> progressBar = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.progress-bar'</span>);
<span class="hljs-keyword">const</span> currentTimeText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.current-time'</span>);
<span class="hljs-keyword">const</span> durationText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.duration'</span>);

<span class="hljs-comment">// 1. 元数据加载完成：显示总时长</span>
video.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'loadedmetadata'</span>, <span class="hljs-function">() =&gt;</span> {
  durationText.<span class="hljs-property">textContent</span> = <span class="hljs-title function_">formatTime</span>(video.<span class="hljs-property">duration</span>);
});

<span class="hljs-comment">// 2. 播放位置更新：同步进度条</span>
video.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'timeupdate'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> progress = (video.<span class="hljs-property">currentTime</span> / video.<span class="hljs-property">duration</span>) * <span class="hljs-number">100</span>;
  progressBar.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">`<span class="hljs-subst">${progress}</span>%`</span>;
  currentTimeText.<span class="hljs-property">textContent</span> = <span class="hljs-title function_">formatTime</span>(video.<span class="hljs-property">currentTime</span>);
});

<span class="hljs-comment">// 3. 缓冲进度更新：显示缓冲条</span>
video.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (video.<span class="hljs-property">buffered</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> bufferedEnd = video.<span class="hljs-property">buffered</span>.<span class="hljs-title function_">end</span>(video.<span class="hljs-property">buffered</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> bufferedProgress = (bufferedEnd / video.<span class="hljs-property">duration</span>) * <span class="hljs-number">100</span>;
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.buffer-bar'</span>).<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">`<span class="hljs-subst">${bufferedProgress}</span>%`</span>;
  }
});

<span class="hljs-comment">// 4. 播放完成：提示并重置</span>
video.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'ended'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">alert</span>(<span class="hljs-string">'视频播放完成！'</span>);
  video.<span class="hljs-property">currentTime</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 重置播放位置</span>
});

<span class="hljs-comment">// 5. 错误处理：显示错误信息</span>
video.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">switch</span>(video.<span class="hljs-property">error</span>.<span class="hljs-property">code</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-title function_">alert</span>(<span class="hljs-string">'视频加载中断'</span>); <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-title function_">alert</span>(<span class="hljs-string">'不支持的视频格式'</span>); <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-title function_">alert</span>(<span class="hljs-string">'视频解码失败'</span>); <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: <span class="hljs-title function_">alert</span>(<span class="hljs-string">'视频加载超时'</span>); <span class="hljs-keyword">break</span>;
  }
});

<span class="hljs-comment">// 辅助函数：格式化时间（秒 → 分:秒，如 125 → 2:05）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">formatTime</span>(<span class="hljs-params">seconds</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(seconds)) <span class="hljs-keyword">return</span> <span class="hljs-string">'0:00'</span>;
  <span class="hljs-keyword">const</span> min = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(seconds / <span class="hljs-number">60</span>);
  <span class="hljs-keyword">const</span> sec = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(seconds % <span class="hljs-number">60</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${min}</span>:<span class="hljs-subst">${sec.toString().padStart(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>)}</span>`</span>;
}
</code></pre>
<h2 data-id="heading-13">4. 自定义播放器外观样式</h2>
<p>浏览器原生控制栏样式难以适配不同网页设计，通过隐藏原生 <code>controls</code>，使用 CSS 自定义播放器界面是更常用的方案。</p>
<h3 data-id="heading-14">4.1. 基础样式控制</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 1. 视频容器样式（统一尺寸、边框、圆角） */</span>
<span class="hljs-selector-class">.video-container</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">1280px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">10px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
}

<span class="hljs-comment">/* 2. 视频元素样式（填充容器，避免变形） */</span>
<span class="hljs-selector-class">.video-container</span> <span class="hljs-selector-tag">video</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: auto;
  <span class="hljs-attribute">object-fit</span>: cover; <span class="hljs-comment">/* 保持宽高比，填充容器（可能裁剪边缘） */</span>
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#000</span>; <span class="hljs-comment">/* 未加载时显示黑色背景 */</span>
}

<span class="hljs-comment">/* 3. 封面图样式（与视频同尺寸） */</span>
<span class="hljs-selector-class">.video-container</span> poster {
  <span class="hljs-attribute">object-fit</span>: cover;
}
</code></pre>
<h3 data-id="heading-15">4.2. 自定义控制栏样式</h3>
<p>通过绝对定位在视频底部创建自定义控制栏，默认隐藏，鼠标悬浮时显示：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 控制栏容器 */</span>
<span class="hljs-selector-class">.video-controls</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(transparent, <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.7</span>)); <span class="hljs-comment">/* 渐变背景 */</span>
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span> ease;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-comment">/* 鼠标悬浮时显示控制栏 */</span>
<span class="hljs-selector-class">.video-container</span><span class="hljs-selector-pseudo">:hover</span> <span class="hljs-selector-class">.video-controls</span> {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
}

<span class="hljs-comment">/* 进度条容器 */</span>
<span class="hljs-selector-class">.progress-container</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">0.3</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
}

<span class="hljs-comment">/* 已播放进度条 */</span>
<span class="hljs-selector-class">.progress-bar</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#ff4400</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0%</span>;
}

<span class="hljs-comment">/* 缓冲进度条（叠加在进度条下方） */</span>
<span class="hljs-selector-class">.buffer-bar</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">0.5</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0%</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1</span>;
}

<span class="hljs-comment">/* 控制按钮区域 */</span>
<span class="hljs-selector-class">.controls-buttons</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
}

<span class="hljs-comment">/* 按钮样式 */</span>
<span class="hljs-selector-class">.controls-btn</span> {
  <span class="hljs-attribute">background</span>: transparent;
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">transition</span>: color <span class="hljs-number">0.2s</span>;
}

<span class="hljs-selector-class">.controls-btn</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#ff4400</span>;
}

<span class="hljs-comment">/* 音量控制滑块 */</span>
<span class="hljs-selector-class">.volume-slider</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">60px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">0.3</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">outline</span>: none;
  accent-<span class="hljs-attribute">color</span>: <span class="hljs-number">#ff4400</span>; <span class="hljs-comment">/* 自定义滑块颜色 */</span>
}
</code></pre>
<h3 data-id="heading-16">4.3. 自定义控制栏 HTML 结构</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"video-container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"video.mp4"</span> <span class="hljs-attr">poster</span>=<span class="hljs-string">"cover.jpg"</span> <span class="hljs-attr">playsinline</span> <span class="hljs-attr">webkit-playsinline</span>&gt;</span>
    您的浏览器不支持 HTML5 视频播放。
  <span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 自定义控制栏 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"video-controls"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-container"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"progressContainer"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"buffer-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"controls-buttons"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"controls-btn"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"playBtn"</span>&gt;</span>▶️<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"current-time"</span>&gt;</span>0:00<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"duration"</span>&gt;</span>0:00<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"range"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"volume-slider"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"volumeSlider"</span> <span class="hljs-attr">min</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">step</span>=<span class="hljs-string">"0.01"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"controls-btn"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fullscreenBtn"</span>&gt;</span>⛶<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h2 data-id="heading-17">5. 兼容性处理与常见问题</h2>
<p>下面是一些兼容性处理与常见问题：</p>
<h3 data-id="heading-18">5.1. 浏览器兼容性</h3>
<h4 data-id="heading-19">（1）核心兼容性现状</h4>
<ul>
<li><strong>现代浏览器</strong>：Chrome、Firefox、Safari、Edge 均完美支持 <code>&lt;video&gt;</code> 标签及核心 API。</li>
<li><strong>移动端</strong>：iOS Safari、Android Chrome 支持良好，但需注意 <code>playsinline</code> 属性（避免自动全屏）。</li>
<li><strong>旧浏览器</strong>：IE8 及以下不支持 <code>&lt;video&gt;</code> 标签，需通过降级提示或 Flash 备用方案（已不推荐）。</li>
</ul>
<h4 data-id="heading-20">（2）格式兼容性</h4>

























<table><thead><tr><th>视频格式</th><th>支持浏览器</th><th>优势</th></tr></thead><tbody><tr><td>MP4（H.264 + AAC）</td><td>所有现代浏览器、iOS、Android</td><td>兼容性最好，推荐主格式</td></tr><tr><td>WebM（VP8/VP9 + Vorbis）</td><td>Chrome、Firefox、Edge</td><td>体积小、开源，备选格式</td></tr><tr><td>OGG（Theora + Vorbis）</td><td>Chrome、Firefox</td><td>开源，兼容性较差（几乎不用）</td></tr></tbody></table>
<h4 data-id="heading-21">（3）API 兼容性处理</h4>
<p>部分 API 需添加浏览器前缀（如全屏、播放速率），示例如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 全屏兼容处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">toggleFullscreen</span>(<span class="hljs-params">video</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">fullscreenElement</span>) {
    <span class="hljs-comment">// 退出全屏</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">exitFullscreen</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err));
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 进入全屏（兼容前缀）</span>
    <span class="hljs-keyword">if</span> (video.<span class="hljs-property">requestFullscreen</span>) {
      video.<span class="hljs-title function_">requestFullscreen</span>();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (video.<span class="hljs-property">webkitRequestFullscreen</span>) { <span class="hljs-comment">// Safari</span>
      video.<span class="hljs-title function_">webkitRequestFullscreen</span>();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (video.<span class="hljs-property">msRequestFullscreen</span>) { <span class="hljs-comment">// IE/Edge</span>
      video.<span class="hljs-title function_">msRequestFullscreen</span>();
    }
  }
}

<span class="hljs-comment">// 播放速率兼容性（部分旧浏览器不支持）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">setPlaybackRate</span>(<span class="hljs-params">video, rate</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> video.<span class="hljs-property">playbackRate</span> !== <span class="hljs-string">'undefined'</span>) {
    video.<span class="hljs-property">playbackRate</span> = rate;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'您的浏览器不支持播放速率调整'</span>);
  }
}
</code></pre>
<h3 data-id="heading-22">5.2. 常见问题与解决方案</h3>
<h4 data-id="heading-23">（1）自动播放失败</h4>
<ul>
<li><strong>原因</strong>：现代浏览器限制“非静音自动播放”（需用户交互后才能播放有声视频）。</li>
<li><strong>解决方案</strong>：
<ol>
<li>默认静音自动播放（<code>muted autoplay</code>），提供“开启声音”按钮。</li>
<li>引导用户点击后播放（如“点击播放”封面图）。</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"video.mp4"</span> <span class="hljs-attr">autoplay</span> <span class="hljs-attr">muted</span> <span class="hljs-attr">playsinline</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-24">（2）视频加载缓慢/卡顿</h4>
<ul>
<li><strong>解决方案</strong>：
<ol>
<li>提供多码率视频（根据网络状况切换）。</li>
<li>使用 <code>preload="metadata"</code> 优化预加载策略。</li>
<li>显示缓冲进度条，提示用户“缓冲中”。</li>
<li>采用 CDN 分发视频资源，提升加载速度。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-25">（3）视频比例变形</h4>
<ul>
<li><strong>原因</strong>：播放器宽高与视频原生宽高比不一致。</li>
<li><strong>解决方案</strong>：使用 <code>object-fit</code> 属性控制视频填充方式：
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">video</span> {
  <span class="hljs-attribute">object-fit</span>: cover; <span class="hljs-comment">/* 保持宽高比，填充容器（裁剪边缘） */</span>
  <span class="hljs-comment">/* 或 object-fit: contain; 保持宽高比，完整显示（可能留黑边） */</span>
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-26">（4）移动端自动全屏播放</h4>
<ul>
<li><strong>原因</strong>：iOS Safari 默认会将视频全屏播放（无 <code>playsinline</code> 属性时）。</li>
<li><strong>解决方案</strong>：添加 <code>playsinline</code> 和 <code>webkit-playsinline</code> 属性：
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"video.mp4"</span> <span class="hljs-attr">playsinline</span> <span class="hljs-attr">webkit-playsinline</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
</code></pre>
</li>
</ul>
<h2 data-id="heading-27">6. 总结</h2>
<p>HTML5 <code>&lt;video&gt;</code> 标签凭借原生、轻量、可扩展的特性，成为网页视频播放的标准方案。通过本文的讲解，你可以掌握：</p>
<ol>
<li>标签基础属性与多格式适配技巧；</li>
<li>核心 API 的使用的（播放控制、状态查询）；</li>
<li>完整事件体系的应用（监听播放状态、缓冲进度等）；</li>
<li>自定义播放器的样式设计与逻辑实现；</li>
<li>兼容性处理与常见问题解决方案。</li>
</ol>
<p>在实际开发中，可根据需求灵活组合上述技术——简单场景直接使用原生控制栏，复杂场景（如视频网站、教育平台）则通过自定义控制栏与 API 实现个性化功能（如倍速播放、弹幕、画中画等）。随着浏览器技术的迭代，<code>&lt;video&gt;</code> 标签的功能将持续完善，为网页视频体验带来更多可能。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7568192652286754870" target="_blank" title="https://juejin.cn/post/7568192652286754870">纯前端提取图片颜色插件Color-Thief教学+实战完整指南</a></li>
<li><a href="https://juejin.cn/post/7565737512816771135" target="_blank" title="https://juejin.cn/post/7565737512816771135">react-konva实战指南：Canvas高性能+易维护的组件化图形开发实现教程</a></li>
<li><a href="https://juejin.cn/post/7560905838074462271" target="_blank" title="https://juejin.cn/post/7560905838074462271">React无限滚动插件react-infinite-scroll-component的配置+优化+避坑指南</a></li>
<li><a href="https://juejin.cn/post/7560542615484137491" target="_blank" title="https://juejin.cn/post/7560542615484137491">前端音频兼容解决：音频神器howler.js从基础到进阶完整使用指南</a></li>
<li><a href="https://juejin.cn/post/7559871680015024169" target="_blank" title="https://juejin.cn/post/7559871680015024169">使用React-OAuth进行Google/GitHub登录的教程和案例</a></li>
<li><a href="https://juejin.cn/post/7550585427834404927" target="_blank" title="https://juejin.cn/post/7550585427834404927">纯前端人脸识别利器：face-api.js手把手深入解析教学</a></li>
<li><a href="https://juejin.cn/post/7553865490732433462" target="_blank" title="https://juejin.cn/post/7553865490732433462">关于React父组件调用子组件方法forwardRef的详解和案例</a></li>
<li><a href="https://juejin.cn/post/7553484874609410074" target="_blank" title="https://juejin.cn/post/7553484874609410074">React跨组件数据共享useContext详解和案例</a></li>
<li><a href="https://juejin.cn/post/7545087762837815334" target="_blank" title="https://juejin.cn/post/7545087762837815334">Web图像编辑神器tui.image-editor从基础到进阶的实战指南</a></li>
<li><a href="https://juejin.cn/post/7544323659788288046" target="_blank" title="https://juejin.cn/post/7544323659788288046">开发个人微信小程序类目选择/盈利方式/成本控制与服务器接入指南</a></li>
<li><a href="https://juejin.cn/post/7541741121400864778" target="_blank" title="https://juejin.cn/post/7541741121400864778">前端图片裁剪Cropper.js核心功能与实战技巧详解</a></li>
<li><a href="https://juejin.cn/post/7536530451461472265" target="_blank" title="https://juejin.cn/post/7536530451461472265">编辑器也有邪修？盘点VS Code邪门/有趣的扩展</a></li>
<li><a href="https://juejin.cn/post/7535005018257981466" target="_blank" title="https://juejin.cn/post/7535005018257981466">js使用IntersectionObserver实现目标元素可见度的交互</a></li>
<li><a href="https://juejin.cn/post/7534547200330121225" target="_blank" title="https://juejin.cn/post/7534547200330121225">Web前端页面开发阿拉伯语种适配指南</a></li>
<li><a href="https://juejin.cn/post/7516122409948020736" target="_blank" title="https://juejin.cn/post/7516122409948020736">让网页拥有App体验？PWA 将网页变为桌面应用的保姆级教程PWA</a></li>
<li><a href="https://juejin.cn/post/6953803916484018206" target="_blank" title="https://juejin.cn/post/6953803916484018206">使用nvm管理node.js版本以及更换npm淘宝镜像源</a></li>
<li><a href="https://juejin.cn/post/7140443283209060383" target="_blank" title="https://juejin.cn/post/7140443283209060383">手把手教你搭建规范的团队vue项目，包含commitlint，eslint，prettier，husky，commitizen等等</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[部署大模型需要多少GPU显存?一文教你精准计算]]></title>    <link>https://juejin.cn/post/7575829296452157450</link>    <guid>https://juejin.cn/post/7575829296452157450</guid>    <pubDate>2025-11-24T06:57:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575829296452157450" data-draft-id="7575887863796989962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="部署大模型需要多少GPU显存?一文教你精准计算"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-24T06:57:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="居然JuRan"/> <meta itemprop="url" content="https://juejin.cn/user/2524134427858205"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            部署大模型需要多少GPU显存?一文教你精准计算
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134427858205/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    居然JuRan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:57:21.000Z" title="Mon Nov 24 2025 06:57:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言:部署大模型的第一道门槛</h2>
<p>当我们准备部署一个大语言模型并提供服务时,最先遇到的问题往往是:<strong>我到底需要准备多少GPU显存?</strong></p>
<p>这不仅关系到硬件成本,更直接影响服务的并发能力和响应速度。今天,我们就以<strong>Llama 70B模型</strong>为例,手把手教你计算推理所需的GPU显存。</p>
<h2 data-id="heading-1">📋 案例参数设定</h2>
<p>让我们先明确计算的基础参数:</p>
<ul>
<li>
<p><strong>模型规模</strong>:Llama 70B(700亿参数)</p>
</li>
<li>
<p><strong>模型层数</strong>:80层</p>
</li>
<li>
<p><strong>上下文长度</strong>:最大支持32K tokens</p>
</li>
<li>
<p><strong>Hidden Dimension</strong>:8196</p>
</li>
<li>
<p><strong>参数精度</strong>:每个参数2个bytes(FP16)</p>
</li>
<li>
<p><strong>并发用户数</strong>:10个同时请求</p>
</li>
</ul>
<p>基于这些参数,我们开始逐步计算所需的GPU显存。</p>
<h2 data-id="heading-2">💾 第一部分:模型权重显存</h2>
<p>首先要计算的是<strong>模型本身占据的显存</strong>,因为我们需要把整个模型加载到GPU中。</p>
<p><strong>计算公式:</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">模型显存 = 参数量 × 每参数字节数
        = 70B × 2 bytes
        = 70 × 10^9 × 2 bytes
        = 140 GB
</code></pre>
<p>这个140GB是模型权重的基础占用,无论有多少用户请求,这部分都是固定的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1508643296c44d2eb3f0eb77c9b32cca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572241&amp;x-signature=b4afNJEwyOJdZGsBETAcC6fjXH4%3D" alt="GPU显存配置主图" loading="lazy"/></p>
<h2 data-id="heading-3">🚀 第二部分:KV Cache显存(重点!)</h2>
<p>这是显存占用的<strong>大头</strong>,也是最容易被忽视的部分。</p>
<h3 data-id="heading-4">什么是KV Cache?</h3>
<p>在大模型推理时,文本是<strong>逐个token生成</strong>的。为了加速这个过程,我们使用KV Cache机制来缓存中间计算结果。</p>
<p><strong>如果没有KV Cache</strong>,每生成一个新token,都需要重新计算之前所有token的注意力权重,这会导致大量重复计算,严重影响推理效率。</p>
<h3 data-id="heading-5">KV Cache显存计算</h3>
<p>KV Cache的计算分为两步:</p>
<p><strong>步骤1:计算单个token的KV Cache大小</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">单token显存 = 层数 × Hidden Dimension × 字节数 × 2(Key + Value)
           = 80 × 8196 × 2 bytes × 2
           = 2.5 MB
</code></pre>
<p><strong>步骤2:计算总KV Cache</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">总KV Cache = 单token显存 × 上下文长度 × 并发用户数
          = 2.5 MB × 32K × 10
          = 2.5 MB × 32,000 × 10
          = 800 GB
</code></pre>
<p>注意:<strong>每个用户都需要独立的KV Cache</strong>,因为每个请求的上下文都不同。这就是为什么并发数对显存需求影响巨大!</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/904e61257eae4417a96ab7e5bb25052e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572241&amp;x-signature=nuMb5ZPq1UXzhG9iZQc0UGtEJsU%3D" alt="KV Cache工作原理图" loading="lazy"/></p>
<h2 data-id="heading-6">🔧 第三部分:其他显存开销</h2>
<p>除了模型权重和KV Cache,还有一些额外的显存占用:</p>
<h3 data-id="heading-7">1. Activation(激活值)</h3>
<p>神经网络每一层计算时产生的激活函数输出,需要暂存在显存中。</p>
<h3 data-id="heading-8">2. Buffers(缓冲区)</h3>
<p>存放中间变量的临时空间,计算完成后可能会被释放。</p>
<h3 data-id="heading-9">3. Overheads(开销)</h3>
<p>主要是显存碎片化导致的空间浪费。GPU显存分配是以block为单位的,可能会出现一些block未被充分利用的情况。</p>
<p><strong>估算方法:</strong></p>
<p>这些杂项通常按模型权重和KV Cache总和的**10%**来估算:</p>
<pre><code class="hljs language-plaintext" lang="plaintext">其他开销 = (140 GB + 800 GB) × 10%
        = 94 GB
</code></pre>
<h2 data-id="heading-10">📊 总显存需求计算</h2>
<p>现在我们可以得出最终结果:</p>
<pre><code class="hljs language-plaintext" lang="plaintext">总显存需求 = 模型权重 + KV Cache + 其他开销
          = 140 GB + 800 GB + 94 GB
          = 1,034 GB ≈ 1TB
</code></pre>
<p>也就是说,<strong>要支持10个并发用户使用Llama 70B模型,我们大约需要1TB的GPU显存!</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fb62a48e4154b358b50ac7533bb7e05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572241&amp;x-signature=wruF0I3MTWCOlhsuGoJcVvFr4aU%3D" alt="显存占用分布图" loading="lazy"/></p>
<h2 data-id="heading-11">💡 实用优化建议</h2>
<h3 data-id="heading-12">场景1:单用户场景</h3>
<p>如果只有1个用户,KV Cache显存大幅降低:</p>
<pre><code class="hljs language-plaintext" lang="plaintext">KV Cache = 2.5 MB × 32K × 1 = 80 GB
总显存 = 140 + 80 + 22 = 242 GB
</code></pre>
<p>所需显存减少到<strong>约250GB</strong>,只需3-4张A100(80GB)即可。</p>
<h3 data-id="heading-13">场景2:更短的上下文</h3>
<p>实际应用中,很多请求的上下文长度远小于32K。如果平均上下文为8K:</p>
<pre><code class="hljs language-plaintext" lang="plaintext">KV Cache = 2.5 MB × 8K × 10 = 200 GB
总显存 = 140 + 200 + 34 = 374 GB
</code></pre>
<p>显存需求降低到<strong>约400GB</strong>,大幅节省成本。</p>
<h2 data-id="heading-14">🎯 总结与延伸</h2>
<p>通过本文的计算方法,你可以快速估算<strong>任何大模型</strong>在不同场景下的显存需求:</p>
<p><strong>关键计算要素:</strong></p>
<ol>
<li>
<p>✅ 模型参数量 × 参数精度</p>
</li>
<li>
<p>✅ KV Cache = 层数 × Hidden维度 × 上下文长度 × 并发数</p>
</li>
<li>
<p>✅ 其他开销约为总和的10%</p>
</li>
</ol>
<p><strong>重要提示:</strong></p>
<ul>
<li>
<p>本文计算基于<strong>标准KV Cache推理</strong>方式</p>
</li>
<li>
<p>实际还有许多<strong>显存优化技术</strong>(如PagedAttention、量化等)可以大幅降低显存需求</p>
</li>
<li>
<p>不同推理框架的实现也会影响实际显存占用</p>
</li>
</ul>
<p>想了解如何进一步优化显存使用?敬请关注后续文章,我们将深入讲解各种显存优化技术!</p>
<hr/>
<p><strong>你在部署大模型时遇到过显存不足的问题吗?欢迎在评论区分享你的经验!</strong> 👇</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot拦截器结合HMAC-SHA256实现API安全验证]]></title>    <link>https://juejin.cn/post/7575468252657041449</link>    <guid>https://juejin.cn/post/7575468252657041449</guid>    <pubDate>2025-11-23T23:56:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575468252657041449" data-draft-id="7574978545144987683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot拦截器结合HMAC-SHA256实现API安全验证"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-23T23:56:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot拦截器结合HMAC-SHA256实现API安全验证
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T23:56:02.000Z" title="Sun Nov 23 2025 23:56:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在开放平台和第三方集成的项目中，如何确保 API 调用的安全性和可靠性是一个重要课题。特别是对于没有用户登录场景的系统间调用，传统的session或token认证方式并不适用，数字签名技术就成为了一种理想的选择。</p>
<p>这种验证方式在开放平台、SaaS服务、微服务间调用等场景下特别实用，能够有效验证请求来源的合法性，防止参数被篡改和重放攻击。</p>
<p>本文将详细介绍如何基于 Spring Boot 拦截器和 HMAC-SHA256 算法，构建一套轻量级但足够安全的 API 验签机制。</p>
<h2 data-id="heading-1">什么是数字签名？</h2>
<p>数字签名是一种用于验证数据完整性和真实性的技术手段。在 API 调用中，数字签名通过以下方式保障安全：</p>
<ul>
<li><strong>1. 身份验证</strong>：确认请求方身份的合法性</li>
<li><strong>2. 数据完整性</strong>：确保请求参数在传输过程中未被篡改</li>
<li><strong>3. 防止重放攻击</strong>：通过时间戳等机制防止请求被重复使用</li>
</ul>
<h2 data-id="heading-2">整体设计</h2>
<h4 data-id="heading-3">设计思路</h4>
<p>我们的验签机制基于以下核心思想：</p>
<ul>
<li><strong>无侵入性</strong>：通过 Spring Boot 拦截器实现，业务代码无需改动</li>
<li><strong>算法安全性</strong>：采用业界成熟的 HMAC-SHA256 算法</li>
<li><strong>配置灵活</strong>：支持多客户端、多密钥管理</li>
</ul>
<h4 data-id="heading-4">架构流程图</h4>
<pre><code class="hljs language-css" lang="css">客户端请求 → 生成签名 → 发送请求 → 拦截器验证 → 业务处理
     ↓              ↓           ↓           ↓           ↓
  <span class="hljs-selector-attr">[参数整理]</span>    <span class="hljs-selector-attr">[HMAC加密]</span>  <span class="hljs-selector-attr">[携带签名头]</span>  <span class="hljs-selector-attr">[验签逻辑]</span>  <span class="hljs-selector-attr">[通过/拒绝]</span>
     ↓              ↓           ↓           ↓           ↓
   参数排序    +时间戳加密   X-API-Key    密钥匹配    正常响应
     ↓              ↓           ↓           ↓           ↓
   拼接参数    Base64编码   X-Timestamp  时间戳验证   或返回<span class="hljs-number">401</span>
     ↓              ↓           ↓           ↓
   待签字符串    完整签名     X-Signature  签名对比
</code></pre>
<h2 data-id="heading-5">HMAC-SHA256 签名原理</h2>
<p>HMAC（Hash-based Message Authentication Code，基于哈希的消息认证码）结合了哈希函数和密钥，提供了一种安全高效的消息认证方式。</p>
<h4 data-id="heading-6">签名生成算法</h4>
<pre><code class="hljs language-scss" lang="scss">签名 = <span class="hljs-built_in">Base64</span>(HMAC-SHA256(时间戳 + 排序后的请求参数, 密钥))
</code></pre>
<h4 data-id="heading-7">算法步骤</h4>
<ul>
<li><strong>1. 参数标准化</strong>：将所有请求参数按字典序排序</li>
<li><strong>2. 数据拼接</strong>：将时间戳和排序后的参数按规则拼接</li>
<li><strong>3. 签名运算</strong>：使用密钥对拼接字符串进行 HMAC-SHA256 运输</li>
<li><strong>4. 编码转换</strong>：对加密结果进行 Base64 编码生成最终签名</li>
</ul>
<h2 data-id="heading-8">核心组件实现</h2>
<h4 data-id="heading-9">1. 签名工具类</h4>
<p>签名工具类是整个机制的核心，负责签名的生成和验证逻辑</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SignatureUtil</span> {

    <span class="hljs-comment">/**
     * 生成签名
     * 签名算法：Base64(HMAC-SHA256(timestamp + sortedParams, secret))
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateSignature</span><span class="hljs-params">(Map&lt;String, Object&gt; params,
                                         String timestamp, String secret)</span> {
        <span class="hljs-comment">// 参数排序并拼接</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sortedParams</span> <span class="hljs-operator">=</span> sortParams(params);
        <span class="hljs-type">String</span> <span class="hljs-variable">dataToSign</span> <span class="hljs-operator">=</span> timestamp + sortedParams;

        <span class="hljs-comment">// HMAC-SHA256加密并Base64编码</span>
        <span class="hljs-type">HMac</span> <span class="hljs-variable">hmac</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HMac</span>(HmacAlgorithm.HmacSHA256, secret.getBytes(StandardCharsets.UTF_8));
        <span class="hljs-type">byte</span>[] digest = hmac.digest(dataToSign);
        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(digest);
    }

    <span class="hljs-comment">/**
     * 验证时间戳有效性（防重放攻击）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validateTimestamp</span><span class="hljs-params">(String timestamp, <span class="hljs-type">long</span> tolerance)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">requestTime</span> <span class="hljs-operator">=</span> Long.parseLong(timestamp);
        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis() / <span class="hljs-number">1000</span>;
        <span class="hljs-keyword">return</span> Math.abs(currentTime - requestTime) &lt;= tolerance;
    }
}
</code></pre>
<h4 data-id="heading-10">2. 拦截器</h4>
<p>拦截器负责对所有受保护接口进行统一的签名验证</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SignatureValidationInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> {
        <span class="hljs-comment">// 1. 获取签名头信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"X-Timestamp"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"X-Signature"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">apiKey</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"X-Api-Key"</span>);

        <span class="hljs-comment">// 2. 验证必要参数</span>
        <span class="hljs-keyword">if</span> (!StringUtils.hasText(timestamp) || !StringUtils.hasText(signature) || !StringUtils.hasText(apiKey)) {
            <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Missing required signature headers"</span>);
        }

        <span class="hljs-comment">// 3. 验证时间戳（防重放攻击）</span>
        <span class="hljs-keyword">if</span> (!SignatureUtil.validateTimestamp(timestamp, timeTolerance)) {
            <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Invalid timestamp"</span>);
        }

        <span class="hljs-comment">// 4. 获取密钥并验证签名</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">secret</span> <span class="hljs-operator">=</span> securityProperties.getApiSecret(apiKey);
        <span class="hljs-keyword">if</span> (secret == <span class="hljs-literal">null</span> || !SignatureUtil.verifySignature(extractParams(request), timestamp, secret, signature)) {
            <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Invalid signature"</span>);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 验证通过，继续处理请求</span>
    }
}
</code></pre>
<h4 data-id="heading-11">3. 配置类（WebMvcConfig）</h4>
<p>配置类负责将拦截器集成到 Spring Boot 的请求处理链中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> {
        registry.addInterceptor(signatureValidationInterceptor)
                .addPathPatterns(<span class="hljs-string">"/api/**"</span>)              <span class="hljs-comment">// 拦截所有API请求</span>
                .excludePathPatterns(<span class="hljs-string">"/api/public/**"</span>);  <span class="hljs-comment">// 排除公开接口</span>
    }
}
</code></pre>
<h2 data-id="heading-12">客户端调用示例</h2>
<h4 data-id="heading-13">请求头设置</h4>
<p>客户端需要在请求头中包含三个必要字段：</p>
<ul>
<li><code>X-Api-Key</code>：客户端标识</li>
<li><code>X-Timestamp</code>：当前时间戳（秒级）</li>
<li><code>X-Signature</code>：生成的签名</li>
</ul>
<h4 data-id="heading-14">完整调用流程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 准备请求参数</span>
Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
params.put(<span class="hljs-string">"userId"</span>, <span class="hljs-string">"12345"</span>);
params.put(<span class="hljs-string">"type"</span>, <span class="hljs-string">"profile"</span>);

<span class="hljs-comment">// 2. 生成签名</span>
<span class="hljs-type">String</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> String.valueOf(System.currentTimeMillis() / <span class="hljs-number">1000</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> SignatureUtil.generateSignature(params, timestamp, <span class="hljs-string">"your-secret"</span>);

<span class="hljs-comment">// 3. 设置请求头并发送请求</span>
<span class="hljs-type">Headers</span> <span class="hljs-variable">headers</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>();
headers.set(<span class="hljs-string">"X-Api-Key"</span>, <span class="hljs-string">"client1"</span>);
headers.set(<span class="hljs-string">"X-Timestamp"</span>, timestamp);
headers.set(<span class="hljs-string">"X-Signature"</span>, signature);

<span class="hljs-comment">// GET /api/protected/data?userId=12345&amp;type=profile</span>
</code></pre>
<h2 data-id="heading-15">安全性设计要点</h2>
<h4 data-id="heading-16">1. 防重放攻击</h4>
<ul>
<li><strong>时间戳验证</strong>：服务端验证时间戳的有效性（默认容忍度5分钟）</li>
<li><strong>唯一性保证</strong>：相同参数在不同时间戳下生成不同签名</li>
<li><strong>配置灵活</strong>：可根据业务需求调整容忍时间</li>
</ul>
<h4 data-id="heading-17">2. 密钥管理</h4>
<ul>
<li><strong>多客户端支持</strong>：每个客户端使用独立的 API Key 和密钥</li>
<li><strong>配置化管理</strong>：通过配置文件或其他存储组件统一管理密钥映射</li>
<li><strong>定期轮换</strong>：建议定期更换密钥以提升安全性</li>
</ul>
<h4 data-id="heading-18">3. 日志审计</h4>
<ul>
<li><strong>请求日志</strong>：记录验证失败的关键信息（不包含完整签名）</li>
<li><strong>IP追踪</strong>：记录客户端真实IP地址</li>
<li><strong>安全预警</strong>：异常签名验证触发告警机制</li>
</ul>
<h2 data-id="heading-19">安全性增强建议</h2>
<h4 data-id="heading-20">1. 传输层安全</h4>
<ul>
<li><strong>HTTPS强制</strong>：所有API请求必须通过HTTPS传输</li>
<li><strong>证书验证</strong>：启用双向证书认证增加安全性</li>
<li><strong>协议升级</strong>：及时更新SSL/TLS协议版本</li>
</ul>
<h4 data-id="heading-21">2. 密钥管理优化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 生成安全密钥（32位随机字符串）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateSecureKey</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">chars</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"</span>;
    <span class="hljs-type">SecureRandom</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> SecureRandom.getInstanceStrong();
    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++) {
        sb.append(chars.charAt(random.nextInt(chars.length())));
    }

    <span class="hljs-keyword">return</span> sb.toString();
}
</code></pre>
<h4 data-id="heading-22">3. 请求限流</h4>
<p>建议结合 Redis 实现请求限流，防止暴力破解：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 简限流逻辑示例</span>
<span class="hljs-type">String</span> <span class="hljs-variable">rateLimitKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"api_limit:"</span> + apiKey;
<span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().increment(rateLimitKey);
<span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">100</span>) { <span class="hljs-comment">// 每分钟限制100次请求</span>
    <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Too many requests"</span>);
}
</code></pre>
<h2 data-id="heading-23">测试验证</h2>
<h4 data-id="heading-24">正常流程测试</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用curl测试（需要先根据参数生成签名）</span>
timestamp=$(<span class="hljs-built_in">date</span> +%s)
signature=$(生成签名逻辑)
curl -X GET <span class="hljs-string">"http://localhost:8080/api/protected/data?userId=12345"</span> \
  -H <span class="hljs-string">"X-Api-Key: client1"</span> \
  -H <span class="hljs-string">"X-Timestamp: <span class="hljs-variable">$timestamp</span>"</span> \
  -H <span class="hljs-string">"X-Signature: <span class="hljs-variable">$signature</span>"</span>
</code></pre>
<h4 data-id="heading-25">异常场景测试</h4>
<ul>
<li><strong>签名错误</strong>：修改参数但不更新签名</li>
<li><strong>时间戳过期</strong>：使用过期的时间戳</li>
<li><strong>密钥错误</strong>：使用错误的API Key</li>
<li><strong>缺少头信息</strong>：缺少必要的请求头</li>
</ul>
<h2 data-id="heading-26">总结</h2>
<p>通过 Spring Boot 拦截器和 HMAC-SHA256 算法，我们实现了一套完整且实用的 API 签名验证方案。这套机制有效解决了系统间调用的安全问题，而且对现有代码几乎零侵入，直接复用即可。</p>
<p>在实际项目中，你可以根据具体需求调整时间戳容忍度、密钥管理策略等配置，实现灵活的安全控制。</p>
<h2 data-id="heading-27">仓库</h2>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/yuboon</span><span class="hljs-regexp">/java-examples/tree</span><span class="hljs-regexp">/master/springboot</span>-api-signature
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何防止 IPA 被反编译，从结构隐藏到符号混淆的多层防护方案]]></title>    <link>https://juejin.cn/post/7576378563575005199</link>    <guid>https://juejin.cn/post/7576378563575005199</guid>    <pubDate>2025-11-25T06:44:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576378563575005199" data-draft-id="7576208176007626804" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何防止 IPA 被反编译，从结构隐藏到符号混淆的多层防护方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-25T06:44:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="00后程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1159358440539900"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何防止 IPA 被反编译，从结构隐藏到符号混淆的多层防护方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1159358440539900/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    00后程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T06:44:48.000Z" title="Tue Nov 25 2025 06:44:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动安全领域中，“如何防止 IPA 被反编译”一直是 iOS 开发团队最关心的问题之一。
无论你的项目是 Swift、ObjC、Flutter、RN 或混合架构，只要 IPA 暴露在攻击者手中，他们就能利用类反射、符号扫描、资源解析以及 Hopper/IDA 等工具恢复大量有价值的信息，从而分析你的业务逻辑、调用链路线以及关键模块。</p>
<p>因此，真正的目标从来不是“阻止反编译”——反编译无法阻止，而是要让攻击者 <strong>反编译后几乎看不懂、难以定位、无法替换资源、无法重打包</strong>，从工程结构上提高攻击成本。</p>
<p>下面给出一套适用于各种 iOS 应用的可落地方案。</p>
<hr/>
<h2 data-id="heading-0">一、IPA 为什么容易被反编译？</h2>
<h3 data-id="heading-1"><strong>1. Swift/ObjC 生成大量可读符号</strong></h3>
<p>Hopper、IDA、class-dump 能轻松恢复：</p>
<ul>
<li>方法名</li>
<li>类名</li>
<li>属性名</li>
<li>Selector</li>
<li>Swift 模块结构</li>
</ul>
<p>对逆向人员来说，这些就是“阅读代码”的入口。</p>
<hr/>
<h3 data-id="heading-2"><strong>2. 资源明文暴露</strong></h3>
<p>常见可直接读取和替换的文件：</p>
<ul>
<li>图片</li>
<li>JSON 配置</li>
<li>JS / H5 文件</li>
<li>mp3 / 视频资源</li>
<li>bundle 结构</li>
</ul>
<p>这些都是极易被分析的内容。</p>
<hr/>
<h3 data-id="heading-3"><strong>3. IPA 可被解包、重签名</strong></h3>
<p>攻击者完全可以：</p>
<ul>
<li>解包</li>
<li>注入 dylib</li>
<li>修改资源</li>
<li>重新签名</li>
<li>在越狱设备或企业分发环境安装</li>
</ul>
<p>这也是反编译环境的基础。</p>
<p>所以“防反编译”必须从根源进行结构与符号隐藏。</p>
<hr/>
<h2 data-id="heading-4">二、防反编译必须依赖多工具协同（而不是单点加固）</h2>
<p>下面是常用工具矩阵：</p>













































<table><thead><tr><th>目标</th><th>工具</th><th>作用</th></tr></thead><tbody><tr><td>结构分析</td><td>MobSF、class-dump</td><td>确定暴露面与白名单</td></tr><tr><td>IPA 符号混淆（核心）</td><td><strong>Ipa Guard CLI</strong></td><td>无需源码即可混淆符号与资源</td></tr><tr><td>资源扰动</td><td>Ipa Guard、脚本工具</td><td>图片/JS/JSON 改名、MD5 修改</td></tr><tr><td>运行时对抗</td><td>Frida 检测、反调试</td><td>提高 Hook 逆向成本</td></tr><tr><td>验证效果</td><td>Hopper、IDA</td><td>查看符号可读性下降情况</td></tr><tr><td>重签验收</td><td>kxsign</td><td>混淆后真机验证稳定性</td></tr><tr><td>治理与回滚</td><td>KMS、Bugly</td><td>映射表管理与符号化</td></tr></tbody></table>
<p>这是整体方案的基础。</p>
<hr/>
<p>三、可落地的“防反编译”工程流程</p>
<p>以下流程适用所有类型的 iOS 应用，包括有源码、无源码、外包项目、混合项目等。</p>
<hr/>
<h3 data-id="heading-5"><strong>步骤 1：使用 MobSF 与 class-dump 分析暴露面</strong></h3>
<p>目的：</p>
<ul>
<li>找到暴露的 Swift/ObjC 符号</li>
<li>找出 JS、JSON、H5 的路径</li>
<li>分析哪些方法依赖反射</li>
<li>标记需要加入白名单的符号</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-lua" lang="lua">class-<span class="hljs-built_in">dump</span> app.ipa &gt; <span class="hljs-built_in">dump</span>.txt
</code></pre>
<p>输出文件决定哪些符号不能被混淆。</p>
<hr/>
<h3 data-id="heading-6"><strong>步骤 2：导出可混淆符号（无需源码）</strong></h3>
<p>使用 <strong>Ipa Guard CLI</strong>：</p>
<pre><code class="hljs">ipaguard_cli parse app.ipa -o sym.json
</code></pre>
<p><code>sym.json</code> 中包含：</p>
<ul>
<li>可混淆方法名</li>
<li>文件引用（fileReferences）</li>
<li>字符串引用（stringReferences）</li>
<li>可否混淆字段（confuse）</li>
</ul>
<p>这是后续防反编译的重要策略文件。</p>
<hr/>
<h3 data-id="heading-7"><strong>步骤 3：编辑混淆策略（决定安全上限）</strong></h3>
<p>必须排除的符号：</p>
<ul>
<li>Storyboard id</li>
<li>JS/H5 回调方法</li>
<li>Flutter/RN 桥接方法</li>
<li>SDK 初始化方法</li>
<li>selector 反射调用方法</li>
</ul>
<p>可以混淆的符号：</p>
<ul>
<li>内部业务逻辑</li>
<li>工具类、控制器</li>
<li>Swift/ObjC 私有方法</li>
<li>服务端通信逻辑入口</li>
</ul>
<p>并且：</p>
<ul>
<li><code>refactorName</code> 长度必须保持一致</li>
<li>不可重复</li>
<li>与引用文件保持一致</li>
</ul>
<p>这一步决定“反编译后是否能看懂”。</p>
<hr/>
<h3 data-id="heading-8"><strong>步骤 4：对 IPA 执行符号混淆与资源扰动（防反编译的核心步骤）</strong></h3>
<p>Ipa Guard：</p>
<pre><code class="hljs language-arduino" lang="arduino">ipaguard_cli protect app.ipa -c sym.json --email dev@team.com --image --js -o <span class="hljs-keyword">protected</span>.ipa
</code></pre>
<p>混淆结果包括：</p>
<p>Swift/ObjC 方法名不可读
类名混淆、结构模糊化
JS/H5 路径变更（难定位）
资源文件名重写
图片、资源 MD5 修改（不可替换）
输出混淆映射表（用于回滚）</p>
<p>反编译后的可读性会显著降低。</p>
<hr/>
<h3 data-id="heading-9"><strong>步骤 5：重签名并真机验证</strong></h3>
<p>使用 kxsign：</p>
<pre><code class="hljs language-arduino" lang="arduino">kxsign sign <span class="hljs-keyword">protected</span>.ipa -c dev.p12 -p pwd \
  -m dev.mobileprovision -z <span class="hljs-type">signed</span>.ipa -i
</code></pre>
<p>测试：</p>
<ul>
<li>是否能顺利启动</li>
<li>JS/H5 页面是否正常渲染</li>
<li>SDK 初始化是否正常</li>
<li>网络、Pay、Push 是否成功</li>
</ul>
<p>确保混淆没有破坏业务逻辑。</p>
<hr/>
<h3 data-id="heading-10"><strong>步骤 6：使用 Hopper/IDA 进行反编译效果验证</strong></h3>
<p>检查：</p>
<ul>
<li>方法名是否完全乱码</li>
<li>结构是否混淆</li>
<li>类层级是否难以理解</li>
<li>是否仍能看到关键业务名称</li>
</ul>
<p>这是检验“防反编译效果”的最佳方法。</p>
<hr/>
<h3 data-id="heading-11"><strong>步骤 7：使用 Frida 进行动态 Hook 测试</strong></h3>
<pre><code class="hljs language-css" lang="css">frida -U -f com<span class="hljs-selector-class">.app</span> <span class="hljs-attr">--no-pause</span> -l hook<span class="hljs-selector-class">.js</span>
</code></pre>
<p>观察：</p>
<ul>
<li>是否能轻易定位方法</li>
<li>是否能 Hook 到关键逻辑</li>
<li>是否能追踪业务流程</li>
</ul>
<p>如果 Hook 成本显著提高，则表明混淆策略成功。</p>
<hr/>
<h3 data-id="heading-12"><strong>步骤 8：映射表治理与在线符号化</strong></h3>
<p>存储：</p>
<ul>
<li>混淆映射表</li>
<li>sym.json 策略文件</li>
<li>构建号与版本号</li>
<li>安装包签名指纹</li>
</ul>
<p>用于：</p>
<ul>
<li>崩溃符号化</li>
<li>策略审计</li>
<li>快速回滚</li>
</ul>
<p>使用 KMS 或 Git 加密仓库存储。</p>
<hr/>
<h2 data-id="heading-13">四、防反编译常见错误与解决方法</h2>



































<table><thead><tr><th>问题</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td>App 混淆后崩溃</td><td>错误混淆了反射方法或 Storyboard</td><td>通过 sym.json 加白名单</td></tr><tr><td>H5 页面失效</td><td>JS 路径被改但引用未更新</td><td>使用 <code>--js</code> 或手动同步</td></tr><tr><td>Flutter/RN 无法启动</td><td>桥接方法被混淆</td><td>禁混淆 MethodChannel 名称</td></tr><tr><td>反编译仍能看懂方法名</td><td>混淆策略覆盖率不足</td><td>扩大混淆范围</td></tr><tr><td>崩溃无法定位</td><td>映射表未保存</td><td>必须建立治理流程</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">防反编译是体系化工程，而不是一个加固动作</h2>
<p>推荐的完整方案：</p>
<h3 data-id="heading-15"><strong>分析层</strong></h3>
<p>MobSF、class-dump</p>
<h3 data-id="heading-16"><strong>混淆层（最重要）</strong></h3>
<p>Ipa Guard CLI</p>
<ul>
<li>无源码混淆</li>
<li>资源扰动</li>
<li>JS/H5 改名</li>
<li>图片 MD5 修改</li>
</ul>
<h3 data-id="heading-17"><strong>验证层</strong></h3>
<p>kxsign（重签验证）、Frida（Hook 测试）、Hopper（反编译验证）</p>
<h3 data-id="heading-18"><strong>治理层</strong></h3>
<p>KMS / Bugly / Sentry、Git 加密仓库</p>
<p>通过上述多层组合，可以最大限度提升 IPA 的反编译难度，让逆向工程变得“不值得”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一起聊聊大规模 AI Agent 部署与运维实战]]></title>    <link>https://juejin.cn/post/7576264484688773160</link>    <guid>https://juejin.cn/post/7576264484688773160</guid>    <pubDate>2025-11-25T06:50:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576264484688773160" data-draft-id="7576378563574972431" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一起聊聊大规模 AI Agent 部署与运维实战"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-11-25T06:50:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一起聊聊大规模 AI Agent 部署与运维实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T06:50:39.000Z" title="Tue Nov 25 2025 06:50:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们诚挚地邀请您参加将于 <strong>11 月 28 日（周五）下午，在北京阿里中心举办的</strong>  <strong>【企业 AI 原生应用架构升级】</strong> 主题研讨会。</p>
<p>进入链接立即报名，破解 AI 落地难题：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsurvey.aliyun.com%2Fapps%2Fzhiliao%2FtvSPhYv9e" target="_blank" title="https://survey.aliyun.com/apps/zhiliao/tvSPhYv9e" ref="nofollow noopener noreferrer">survey.aliyun.com/apps/zhilia…</a></p>
<p>AI Agent 已是企业智能化的标配，但传统的基础设施正成为其发展的瓶颈。为此，阿里云将云原生与 AI 工程化深度融合，打造全新的 AI 原生技术栈。本次活动，我们将聚焦于云基础设施从传统形态向 AI 原生架构的演进路径，与您一同：</p>
<ul>
<li>分享阿里云在 AI 基础设施领域的最新实践与核心要素；</li>
<li>研讨如何应对 AI Agent 的开发效率与成本挑战；</li>
<li>探寻AI 应用与企业已有数字化基础的无缝融合之道；</li>
<li>交流保障 AI 应用大规模、安全、稳定运行的最佳策略。</li>
</ul>
<p><strong>活动信息：</strong></p>
<ul>
<li>活动主题： 企业AI原生应用架构升级</li>
<li>活动时间： 11 月 28 日（周五） 13:30 - 17:00</li>
<li>活动地点： 北京阿里中心·望京A座5F-14 岳麓书院</li>
<li>报名链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsurvey.aliyun.com%2Fapps%2Fzhiliao%2FtvSPhYv9e" target="_blank" title="https://survey.aliyun.com/apps/zhiliao/tvSPhYv9e" ref="nofollow noopener noreferrer">survey.aliyun.com/apps/zhilia…</a></li>
</ul>
<p>现场席位有限，期待与您一起探索如何为企业构建真正可信赖、可扩展、可进化的下一代 AI 应用体系。</p>
<p><strong>议程详情 👇</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ecfc3f932af439ca7f5b580251f5c61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658239&amp;x-signature=TxkjiRyxoQBIF%2FOd%2FenMMFKmTXg%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 自定义 Hook：能否作为模块级全局状态管理？]]></title>    <link>https://juejin.cn/post/7575887863796924426</link>    <guid>https://juejin.cn/post/7575887863796924426</guid>    <pubDate>2025-11-24T06:43:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575887863796924426" data-draft-id="7575887863796793354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 自定义 Hook：能否作为模块级全局状态管理？"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T06:43:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三小河"/> <meta itemprop="url" content="https://juejin.cn/user/4222562141210478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 自定义 Hook：能否作为模块级全局状态管理？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4222562141210478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三小河
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:43:15.000Z" title="Mon Nov 24 2025 06:43:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 React 开发中，状态管理是核心需求之一。从简单的组件内 state，到 Context API、Redux 等全局状态方案，开发者一直在根据场景选择合适的方案。而自定义 Hook 作为 React 的核心特性，因其复用逻辑的能力，常常被开发者尝试用于全局状态管理。但随之而来的疑问是：自定义 Hook 真的能实现模块级全局状态吗？为什么能这么做？每次引入后内部的 state 会重新初始化吗？本文将从原理、示例、细节三个维度，彻底解答这些问题。</p>
<h2 data-id="heading-0">一、先明确结论</h2>
<ol>
<li><strong>自定义 Hook 可以实现模块级全局状态管理</strong>，但有适用场景（小型应用、非复杂状态）；</li>
<li>其核心原理是<strong>模块级作用域的闭包缓存</strong>—— 状态被存储在模块的闭包中，而非组件实例，因此跨组件复用 Hook 时能共享同一状态；</li>
<li>每次组件引入并调用该 Hook 时，<strong>内部的 state 不会重新执行初始化</strong>，而是复用模块闭包中缓存的状态（仅组件渲染时重新执行 Hook 的逻辑，但 state 引用不变）。</li>
</ol>
<h2 data-id="heading-1">二、为什么自定义 Hook 能实现全局状态？核心原理拆解</h2>
<p>要理解这个问题，需要先理清两个关键概念：<strong>模块作用域</strong>和<strong>React Hook 的执行机制</strong>。</p>
<h3 data-id="heading-2">1. 模块作用域：状态的 “全局容器”</h3>
<p>在 ES6 模块系统中，每个<code>.js</code>文件都是一个独立的模块，模块内的变量、函数会形成<strong>模块级作用域</strong>—— 即模块被导入时，会先执行一次初始化，之后所有导入该模块的地方，共享的是同一个模块实例，模块内的变量不会被重复创建。</p>
<h3 data-id="heading-3">2. React Hook 的 “状态绑定”：依赖闭包而非组件实例</h3>
<p>React 的<code>useState</code>、<code>useEffect</code>等 Hook，其状态是<strong>与组件渲染实例绑定</strong>的吗？表面看是，但如果将 Hook 的逻辑抽离到模块中，结合模块作用域，情况会发生变化：</p>
<p>当我们在模块中定义一个自定义 Hook，并在 Hook 内部调用<code>useState</code>时，这个<code>useState</code>的状态<strong>并不会绑定到某个具体组件</strong>，而是绑定到 “模块级闭包” 中。因为：</p>
<ul>
<li>模块初始化时，自定义 Hook 的函数定义被创建，其内部的<code>useState</code>调用会形成一个闭包；</li>
<li>无论哪个组件导入并调用这个 Hook，本质上都是执行同一个模块中的 Hook 函数，共享同一个闭包环境；</li>
<li>因此，所有组件通过该 Hook 访问的<code>state</code>和<code>setState</code>，都是同一个闭包中的状态和更新函数 —— 这就实现了 “全局共享”。</li>
</ul>
<h3 data-id="heading-4">3. 关键区别：普通自定义 Hook vs 全局状态自定义 Hook</h3>
<p>普通自定义 Hook（如<code>useCounter</code>）通常是 “组件私有” 的，因为它们的<code>useState</code>是在组件调用 Hook 时初始化的，每个组件调用一次 Hook，就会创建一个独立的状态。</p>
<p>而<strong>全局状态自定义 Hook</strong>的核心差异是：将<code>useState</code>的初始化逻辑，通过模块作用域 “提升” 到了模块层面，使得所有组件调用 Hook 时，复用同一个<code>useState</code>的结果。</p>
<h2 data-id="heading-5">三、实战示例：用自定义 Hook 实现模块级全局状态</h2>
<p>下面通过 3 个递进示例，从基础实现到进阶用法，展示自定义 Hook 的全局状态能力，并验证 “状态不重复初始化” 的特性。</p>
<h3 data-id="heading-6">示例 1：基础版全局状态 Hook（共享用户信息）</h3>
<p>需求：实现一个全局用户状态，支持登录、登出，在多个组件中共享用户信息。</p>
<h4 data-id="heading-7">步骤 1：定义全局状态 Hook（模块级）</h4>
<p>创建<code>useGlobalUser.js</code>文件，作为全局状态模块</p>
<pre><code class="hljs language-ini" lang="ini">// useGlobalUser.js（模块级全局状态Hook）
import { useState, useCallback } from 'react'<span class="hljs-comment">;</span>

// 模块作用域的变量：存储用户状态（闭包缓存）
let <span class="hljs-attr">globalUserState</span> = null<span class="hljs-comment">;</span>
// 存储所有订阅组件的更新函数（用于状态变更时通知组件重渲染）
let <span class="hljs-attr">subscribers</span> = new Set()<span class="hljs-comment">;</span>

// 触发所有订阅组件重渲染
const <span class="hljs-attr">notifySubscribers</span> = () =&gt; {
  subscribers.forEach(<span class="hljs-attr">update</span> =&gt; update())<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 自定义Hook：供组件调用
export function useGlobalUser() {
  // 每个组件调用Hook时，创建一个本地的更新函数（触发组件重渲染）
  const <span class="hljs-section">[, forceUpdate]</span> = useState({})<span class="hljs-comment">;</span>

  // 组件挂载时订阅，卸载时取消订阅
  useEffect(() =&gt; {
    subscribers.add(forceUpdate)<span class="hljs-comment">;</span>
    return () =&gt; {
      subscribers.delete(forceUpdate)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[forceUpdate]</span>)<span class="hljs-comment">;</span>

  // 登录：更新全局状态并通知所有订阅组件
  const <span class="hljs-attr">login</span> = useCallback((userInfo) =&gt; {
    <span class="hljs-attr">globalUserState</span> = { ...userInfo }<span class="hljs-comment">;</span>
    notifySubscribers()<span class="hljs-comment">; // 触发所有组件重渲染</span>
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  // 登出：重置全局状态
  const <span class="hljs-attr">logout</span> = useCallback(() =&gt; {
    <span class="hljs-attr">globalUserState</span> = null<span class="hljs-comment">;</span>
    notifySubscribers()<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  // 返回全局状态和操作方法
  return {
    user: globalUserState,
    login,
    logout,
    isLogin: !!globalUserState
  }<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-8">步骤 2：在多个组件中使用该 Hook</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Header组件</span>
<span class="hljs-keyword">import</span> { useGlobalUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalUser'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { user, isLogin, logout } = <span class="hljs-title function_">useGlobalUser</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Header组件渲染：'</span>, user); <span class="hljs-comment">// 验证是否共享状态</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>网站头部<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {isLogin ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          欢迎 {user.name} <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{logout}</span>&gt;</span>登出<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>未登录<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// Login组件</span>
<span class="hljs-keyword">import</span> { useGlobalUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalUser'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Login</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { login } = <span class="hljs-title function_">useGlobalUser</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 模拟登录接口返回的用户信息</span>
    <span class="hljs-title function_">login</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">avatar</span>: <span class="hljs-string">'xxx.png'</span> });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleLogin}</span>&gt;</span>模拟登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 主页组件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Header</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Header'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Login</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Login'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Login</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-9">效果验证：</h4>
<ol>
<li>初始状态：Header 显示 “未登录”，控制台打印<code>Header组件渲染：null</code>；</li>
<li>点击 “模拟登录”：Login 组件调用<code>login</code>更新全局状态，<code>notifySubscribers</code>触发 Header 组件重渲染；</li>
<li>最终效果：Header 显示 “欢迎张三”，控制台打印<code>Header组件渲染：{id:1, name:"张三", ...}</code>；</li>
<li>核心结论：Header 和 Login 组件通过<code>useGlobalUser</code>共享了同一个<code>user</code>状态，状态变更时所有使用该 Hook 的组件都会同步更新。</li>
</ol>
<h3 data-id="heading-10">示例 2：优化版：用 useState 替代模块变量（更符合 React 规范）</h3>
<p>示例 1 中直接用模块变量<code>globalUserState</code>存储状态，虽然可行，但不够 “React 化”。我们可以用<code>useState</code>替代模块变量，利用 React 的状态管理机制自动处理更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useGlobalUser优化版.js</span>
<span class="hljs-keyword">import</span> { useState, useCallback, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 模块作用域：存储全局状态的Hook实例（闭包缓存）</span>
<span class="hljs-keyword">let</span> globalHook = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// 全局状态的核心Hook（仅初始化一次）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createGlobalUserHook</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> login = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">userInfo</span>) =&gt;</span> {
    <span class="hljs-title function_">setUser</span>({ ...userInfo });
  }, []);

  <span class="hljs-keyword">const</span> logout = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setUser</span>(<span class="hljs-literal">null</span>);
  }, []);

  <span class="hljs-keyword">return</span> {
    user,
    login,
    logout,
    <span class="hljs-attr">isLogin</span>: !!user,
    <span class="hljs-comment">// 暴露setUser供订阅逻辑使用（或直接用user作为依赖）</span>
    <span class="hljs-attr">subscribe</span>: <span class="hljs-function">(<span class="hljs-params">callback</span>) =&gt;</span> {
      <span class="hljs-comment">// 这里利用React的状态更新机制，无需手动维护订阅者</span>
      <span class="hljs-comment">// 组件通过useEffect依赖user，自动触发重渲染</span>
    }
  };
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGlobalUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 模块初始化时，创建全局Hook实例（仅执行一次）</span>
  <span class="hljs-keyword">if</span> (!globalHook) {
    globalHook = <span class="hljs-title function_">createGlobalUserHook</span>();
  }

  <span class="hljs-comment">// 返回全局状态和方法（所有组件共享同一个实例）</span>
  <span class="hljs-keyword">return</span> globalHook;
}
</code></pre>
<h4 data-id="heading-11">优化点说明：</h4>
<ul>
<li>用<code>useState</code>替代模块变量，利用 React 的状态管理机制，无需手动维护订阅者（组件通过依赖<code>user</code>自动重渲染）；</li>
<li><code>globalHook</code>在模块作用域中仅初始化一次，所有组件调用<code>useGlobalUser</code>时返回的是同一个实例，因此状态完全共享。</li>
</ul>
<h3 data-id="heading-12">示例 3：进阶版：支持多状态、批量更新（类似简易 Context）</h3>
<p>如果需要管理多个全局状态（如用户、主题、权限），可以扩展为 “多状态全局 Hook”：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// useGlobalState.js（通用全局状态Hook）</span>
import { useState, useCallback, useEffect } from 'react';

<span class="hljs-comment">// 模块作用域：存储所有全局状态（key-value形式）</span>
const globalStates = new <span class="hljs-built_in">Map</span>();
<span class="hljs-comment">// 存储每个状态的订阅者</span>
const subscribers = new <span class="hljs-built_in">Map</span>();

<span class="hljs-comment">// 创建或获取全局状态</span>
function <span class="hljs-built_in">getOrCreateGlobalState</span>(key, initialValue) {
  <span class="hljs-comment">// 如果状态已存在，直接返回</span>
  if (globalStates.has(key)) {
    return globalStates<span class="hljs-selector-class">.get</span>(key);
  }

  <span class="hljs-comment">// 新建状态</span>
  const <span class="hljs-selector-attr">[state, setState]</span> = <span class="hljs-built_in">useState</span>(initialValue);

  <span class="hljs-comment">// 批量更新（类似setState的函数式更新）</span>
  const setGlobalState = <span class="hljs-built_in">useCallback</span>((updater) =&gt; {
    <span class="hljs-built_in">setState</span>(prev =&gt; {
      const nextState = typeof updater === 'function' ? updater(prev) : updater;
      <span class="hljs-comment">// 通知该状态的所有订阅者</span>
      if (subscribers.has(key)) {
        subscribers<span class="hljs-selector-class">.get</span>(key)<span class="hljs-selector-class">.forEach</span>(update =&gt; update(nextState));
      }
      return nextState;
    });
  }, <span class="hljs-selector-attr">[key]</span>);

  const globalState = { state, setGlobalState };
  globalStates<span class="hljs-selector-class">.set</span>(key, globalState);
  subscribers<span class="hljs-selector-class">.set</span>(key, new Set());

  return globalState;
}

<span class="hljs-comment">// 通用全局Hook：支持传入key和初始值</span>
export function <span class="hljs-built_in">useGlobalState</span>(key, initialValue) {
  const { state, setGlobalState } = <span class="hljs-built_in">getOrCreateGlobalState</span>(key, initialValue);

  <span class="hljs-comment">// 组件本地更新函数（触发组件重渲染）</span>
  const <span class="hljs-selector-attr">[, forceUpdate]</span> = <span class="hljs-built_in">useState</span>(state);

  <span class="hljs-comment">// 订阅状态变更：状态更新时触发组件重渲染</span>
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    const subs = subscribers<span class="hljs-selector-class">.get</span>(key);
    const update = (nextState) =&gt; <span class="hljs-built_in">forceUpdate</span>(nextState);
    subs<span class="hljs-selector-class">.add</span>(update);

    <span class="hljs-comment">// 初始触发一次渲染（同步初始状态）</span>
    <span class="hljs-built_in">forceUpdate</span>(state);

    return () =&gt; subs<span class="hljs-selector-class">.delete</span>(update);
  }, <span class="hljs-selector-attr">[key, state]</span>);

  return <span class="hljs-selector-attr">[state, setGlobalState]</span>;
}
</code></pre>
<h4 data-id="heading-13">使用方式：</h4>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 组件1：使用用户状态</span>
<span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useGlobalState</span>(<span class="hljs-string">'user'</span>, <span class="hljs-literal">null</span>);

<span class="hljs-comment">// 组件2：使用主题状态</span>
<span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useGlobalState</span>(<span class="hljs-string">'theme'</span>, <span class="hljs-string">'light'</span>);

<span class="hljs-comment">// 组件3：更新全局状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChangeTheme</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setTheme</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setUser</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span> });
};
</code></pre>
<h4 data-id="heading-14">进阶特性：</h4>
<ul>
<li>支持多状态隔离（通过<code>key</code>区分）；</li>
<li>支持函数式更新（批量修改状态）；</li>
<li>组件仅订阅自己关注的状态，性能更优。</li>
</ul>
<h2 data-id="heading-15">四、关键疑问解答：每次引入 Hook，state 会重新执行吗？</h2>
<p>这是开发者最关心的问题，我们结合示例和原理来详细解答：</p>
<h3 data-id="heading-16">1. 结论：不会重新初始化，但会重新执行 Hook 逻辑</h3>
<ul>
<li><strong>state 的初始化：仅执行一次</strong>：因为<code>globalHook</code>、<code>globalStates</code>等变量存储在<strong>模块作用域</strong>中，模块被导入时仅初始化一次，后续所有组件引入该模块并调用 Hook 时，不会重新创建这些变量，因此<code>useState</code>的初始化逻辑（<code>useState(initialValue)</code>）仅执行一次；</li>
<li><strong>Hook 逻辑的执行：每次组件渲染都会执行</strong>：组件每次重渲染时，都会重新调用自定义 Hook（如<code>useGlobalUser()</code>），但 Hook 内部的逻辑（如返回<code>globalHook</code>）是 “读取缓存”，而非 “重新创建状态”—— 因此 state 的引用不变，不会触发不必要的更新。</li>
</ul>
<h3 data-id="heading-17">2. 代码验证：打印日志看执行次数</h3>
<p>修改<code>useGlobalUser</code>优化版，添加日志：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useGlobalUser.js</span>
<span class="hljs-keyword">import</span> { useState, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">let</span> globalHook = <span class="hljs-literal">null</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'模块初始化：执行一次'</span>); <span class="hljs-comment">// 仅打印一次</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createGlobalUserHook</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'创建全局状态：仅执行一次'</span>); <span class="hljs-comment">// 仅打印一次</span>
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// ... 其余逻辑</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGlobalUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'调用useGlobalUser：组件渲染时执行'</span>); <span class="hljs-comment">// 组件每次渲染都会打印</span>

  <span class="hljs-keyword">if</span> (!globalHook) {
    globalHook = <span class="hljs-title function_">createGlobalUserHook</span>();
  }

  <span class="hljs-keyword">return</span> globalHook;
}
</code></pre>
<h4 data-id="heading-18">日志输出结果：</h4>
<ol>
<li>应用启动时：打印<code>模块初始化：执行一次</code>；</li>
<li>第一个组件（如 Header）挂载时：打印<code>调用useGlobalUser：组件渲染时执行</code> → <code>创建全局状态：仅执行一次</code>；</li>
<li>第二个组件（如 Login）挂载时：打印<code>调用useGlobalUser：组件渲染时执行</code>（无 “创建全局状态” 日志）；</li>
<li>组件重渲染时（如登录后）：两个组件都会打印<code>调用useGlobalUser：组件渲染时执行</code>（仍无 “创建全局状态” 日志）。</li>
</ol>
<h4 data-id="heading-19">结论验证：</h4>
<ul>
<li>模块初始化和全局状态创建仅执行一次（state 不会重新初始化）；</li>
<li>Hook 函数本身会在组件每次渲染时执行，但仅读取缓存的状态，不会重复创建。</li>
</ul>
<h3 data-id="heading-20">3. 与普通 Hook 的区别：状态存储位置不同</h3>






























<table><thead><tr><th>特性</th><th>普通自定义 Hook（如 useCounter）</th><th>全局状态自定义 Hook（如 useGlobalUser）</th></tr></thead><tbody><tr><td>状态存储位置</td><td>组件实例的 Hook 链表中</td><td>模块作用域的闭包中</td></tr><tr><td>状态共享性</td><td>组件私有（每个组件调用创建独立状态）</td><td>跨组件共享（所有组件调用共享同一状态）</td></tr><tr><td>state 初始化次数</td><td>每个组件调用一次</td><td>模块初始化时仅一次</td></tr><tr><td>Hook 逻辑执行次数</td><td>组件每次渲染执行</td><td>组件每次渲染执行（但仅读缓存）</td></tr></tbody></table>
<h2 data-id="heading-21">五、自定义 Hook 作为全局状态的适用场景与局限性</h2>
<h3 data-id="heading-22">1. 适用场景</h3>
<ul>
<li>小型应用或中型应用的非核心状态（如用户信息、主题、权限、全局加载状态）；</li>
<li>不需要中间件、时间旅行、状态回溯等高级特性；</li>
<li>追求轻量化、无额外依赖（无需引入 Redux、Zustand 等库）；</li>
<li>跨组件共享简单状态，且组件层级不深（无需 Context 的嵌套传递）。</li>
</ul>
<h3 data-id="heading-23">2. 局限性</h3>
<ul>
<li><strong>不支持服务端渲染（SSR）</strong> ：模块作用域的状态在 SSR 中会被所有请求共享，导致状态污染（因为 SSR 是多请求共享一个模块实例）；</li>
<li><strong>状态更新缺乏可追踪性</strong>：没有 Redux DevTools 等工具支持，难以调试状态变更；</li>
<li><strong>不支持复杂状态逻辑</strong>：如异步状态流、状态依赖、批量更新优化等，需要手动实现，成本较高；</li>
<li><strong>组件卸载后状态不自动清理</strong>：模块作用域的状态会一直存在于内存中，直到应用刷新（可能导致内存泄漏，需手动清理）；</li>
<li><strong>不支持状态切片隔离</strong>：多团队协作时，容易出现状态 key 冲突（需手动规范 key 命名）。</li>
</ul>
<h2 data-id="heading-24">六、总结</h2>
<p>自定义 Hook 之所以能实现模块级全局状态，核心是<strong>模块作用域的闭包缓存</strong>—— 状态被存储在模块层面，而非组件实例，因此跨组件调用 Hook 时能共享同一状态。每次引入 Hook 后，state 不会重新初始化（仅模块初始化时执行一次），但 Hook 逻辑会在组件每次渲染时执行（仅读取缓存，无性能开销）。</p>
<p>这种方案是一把 “双刃剑”：它轻量化、易实现，适合简单场景；但缺乏高级特性和调试能力，不适合复杂应用。在实际开发中，可根据项目规模选择：</p>
<ul>
<li>小型应用 / 简单状态：用自定义 Hook（本文方案）；</li>
<li>中型应用 / 需要调试：用 Zustand、Jotai 等轻量状态库（本质是基于自定义 Hook + 闭包实现）；</li>
<li>大型应用 / 复杂状态流：用 Redux、Redux Toolkit 或 Recoil 等成熟方案。</li>
</ul>
<p>理解自定义 Hook 的全局状态原理，不仅能帮助我们灵活应对不同场景，更能深入掌握 React 的模块机制、闭包和 Hook 执行逻辑，提升 React 开发的底层认知。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 中的结构化并发模式]]></title>    <link>https://juejin.cn/post/7575887863797039114</link>    <guid>https://juejin.cn/post/7575887863797039114</guid>    <pubDate>2025-11-24T07:10:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575887863797039114" data-draft-id="7575718948299210803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 中的结构化并发模式"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-24T07:10:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="信码由缰"/> <meta itemprop="url" content="https://juejin.cn/user/2110664941509214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 中的结构化并发模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2110664941509214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    信码由缰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T07:10:17.000Z" title="Mon Nov 24 2025 07:10:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>并发编程长期以来一直是 Java 的阿喀琉斯之踵。尽管 <code>ExecutorService</code> 和 <code>Future</code> 为我们提供了良好的服务，但它们允许不受限制的模式，其中子任务可能比其父任务存活更久、线程可能泄漏，而取消操作则变成了一场噩梦。结构化并发通过将运行在不同线程中的相关任务组视为一个单一的工作单元，改变了这一现状，它简化了错误处理和取消操作，同时提高了可靠性和可观测性。</p>
</blockquote>
<p><img src="https://cf-blog.icodebuddy.com/image/91/91-0.jpg" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">非结构化并发的问题</h2>
<p>考虑一个使用 <code>ExecutorService</code> 的典型模式：一个线程创建执行器，另一个线程提交工作，而执行任务的线程与前两者都没有关系。在一个线程提交工作之后，一个完全不同的线程可以等待结果——任何持有 <code>Future</code> 引用的代码都可以连接它，甚至可以是与获取该 <code>Future</code> 的线程不同的线程中的代码。</p>
<p>这种非结构化方法带来了实际问题。当父任务未能正确关闭子任务时，就会发生线程泄漏。由于没有协调的方式来通知多个子任务，取消操作会出现延迟。并且由于任务和子任务之间的关系在运行时未被跟踪，可观测性会受到影响。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 非结构化：关系是隐式且脆弱的</span>

<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();

Future&lt;User&gt; userFuture = executor.submit(() -&gt; fetchUser(id));

Future&lt;Orders&gt; ordersFuture = executor.submit(() -&gt; fetchOrders(id));

  


<span class="hljs-comment">// 如果 fetchUser 失败会发生什么？</span>

<span class="hljs-comment">// 谁负责关闭执行器？</span>

<span class="hljs-comment">// 如果我们忘记清理，线程会泄漏吗？</span>

</code></pre>
<h2 data-id="heading-1">引入 StructuredTaskScope</h2>
<p>结构化并发 API 的主要类是 <code>java.util.concurrent</code> 包中的 <code>StructuredTaskScope</code>，它使您能够将一个并发子任务组作为一个单元进行协调。使用 <code>StructuredTaskScope</code>，您可以在各自的线程中分叉每个子任务，然后将它们作为一个单元进行汇合，确保在主任务继续之前子任务完成。</p>
<p>该 API 遵循一个清晰的模式：</p>
<ol>
<li>
<p>使用 try-with-resources 创建一个 <code>StructuredTaskScope</code></p>
</li>
<li>
<p>将子任务定义为 <code>Callable</code> 实例</p>
</li>
<li>
<p>在各自的线程中分叉每个子任务</p>
</li>
<li>
<p>汇合以等待完成</p>
</li>
<li>
<p>处理子任务的结果</p>
</li>
</ol>
<p>以下是一个获取天气数据的真实示例：</p>
<pre><code class="hljs language-java" lang="java">
WeatherReport <span class="hljs-title function_">getWeatherReport</span><span class="hljs-params">(String location)</span>

<span class="hljs-keyword">throws</span> ExecutionException, InterruptedException {

<span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructuredTaskScope</span>.ShutdownOnFailure()) {

Supplier&lt;Temperature&gt; temperature =

scope.fork(() -&gt; getTemperature(location));

Supplier&lt;Humidity&gt; humidity =

scope.fork(() -&gt; getHumidity(location));

Supplier&lt;WindSpeed&gt; windSpeed =

scope.fork(() -&gt; getWindSpeed(location));

  


scope.join() <span class="hljs-comment">// 汇合所有子任务</span>

.throwIfFailed(); <span class="hljs-comment">// 如果有任何失败，传播错误</span>

  


<span class="hljs-comment">// 全部成功，组合结果</span>

<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeatherReport</span>(

location,

temperature.get(),

humidity.get(),

windSpeed.get()

);

}

}

</code></pre>
<p>try-with-resources 代码块至关重要——它确保作用域被正确关闭，取消任何未完成的子任务并防止线程泄漏。</p>
<h2 data-id="heading-2">使用关闭策略实现短路</h2>
<p>短路模式通过使主任务能够中断和取消那些不再需要其结果子任务，来促使子任务快速完成。两个内置策略处理了常见场景：</p>
<h3 data-id="heading-3">ShutdownOnFailure："调用所有"模式</h3>
<p>当您需要所有子任务都成功时，<code>ShutdownOnFailure</code> 会在一个任务失败后立即取消剩余的任务：</p>
<pre><code class="hljs language-java" lang="java">
Response <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(String userId)</span> <span class="hljs-keyword">throws</span> Exception {

<span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructuredTaskScope</span>.ShutdownOnFailure()) {

Subtask&lt;User&gt; user = scope.fork(() -&gt; fetchUser(userId));

Subtask&lt;Profile&gt; profile = scope.fork(() -&gt; fetchProfile(userId));

Subtask&lt;Settings&gt; settings = scope.fork(() -&gt; fetchSettings(userId));

  


scope.join().throwIfFailed();

  


<span class="hljs-comment">// 如果有任何失败，我们永远不会到达这里</span>

<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(user.get(), profile.get(), settings.get());

}

}

</code></pre>
<p>如果 <code>fetchUser()</code> 抛出异常，作用域会立即取消配置文件和设置的获取。没有浪费的工作，没有线程泄漏。</p>
<h3 data-id="heading-4">ShutdownOnSuccess："调用任一"模式</h3>
<p>有时您只需要第一个成功的结果——例如查询多个数据中心或尝试备用服务：</p>
<pre><code class="hljs language-java" lang="java">
String <span class="hljs-title function_">fetchFromMultipleSources</span><span class="hljs-params">(String key)</span> <span class="hljs-keyword">throws</span> Exception {

<span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructuredTaskScope</span>.ShutdownOnSuccess&lt;String&gt;()) {

scope.fork(() -&gt; fetchFromPrimaryDB(key));

scope.fork(() -&gt; fetchFromCache(key));

scope.fork(() -&gt; fetchFromBackup(key));

  


scope.join();

  


<span class="hljs-comment">// 返回第一个成功的结果</span>

<span class="hljs-keyword">return</span> scope.result();

}

}

</code></pre>
<p>任何子任务成功的瞬间，作用域就会取消其他任务。这种模式非常适合对延迟敏感的操作，即您需要竞速多个来源。</p>
<h2 data-id="heading-5">自定义关闭策略</h2>
<p>在实践中，大多数 <code>StructuredTaskScope</code> 的使用不会直接使用 <code>StructuredTaskScope</code> 类，而是使用实现了关闭策略的两个子类之一，或者编写自定义子类来实现自定义关闭策略。</p>
<p>以下是一个收集所有成功结果并忽略失败的自定义策略：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AllSuccessesScope</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">StructuredTaskScope</span>&lt;T&gt; {

<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;T&gt; results =

Collections.synchronizedList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());

  


<span class="hljs-meta">@Override</span>

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleComplete</span><span class="hljs-params">(Subtask&lt;? extends T&gt; subtask)</span> {

<span class="hljs-keyword">if</span> (subtask.state() == Subtask.State.SUCCESS) {

results.add(subtask.get());

}

}

  


<span class="hljs-keyword">public</span> List&lt;T&gt; <span class="hljs-title function_">getResults</span><span class="hljs-params">()</span> {

<span class="hljs-keyword">return</span> List.copyOf(results);

}

}

  


<span class="hljs-comment">// 用法</span>

List&lt;Data&gt; <span class="hljs-title function_">collectAll</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {

<span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AllSuccessesScope</span>&lt;Data&gt;()) {

<span class="hljs-keyword">for</span> (String source : dataSources) {

scope.fork(() -&gt; fetchData(source));

}

scope.join();

<span class="hljs-keyword">return</span> scope.getResults();

}

}

</code></pre>
<h2 data-id="heading-6">虚拟线程：完美搭档</h2>
<p>虚拟线程提供了大量的线程——结构化并发可以正确且健壮地协调它们，并使可观测性工具能够按开发人员理解的方式显示线程。这种组合非常强大，因为虚拟线程使得创建数百万个线程的成本很低，而结构化并发则确保您能安全地管理它们。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 现在启动 10,000 个并发任务是可行的</span>

<span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructuredTaskScope</span>.ShutdownOnFailure()) {

<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10_000</span>; i++) {

<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> i;

scope.fork(() -&gt; processTask(taskId));

}

scope.join().throwIfFailed();

}

</code></pre>
<p>使用平台线程，这将是灾难性的。但使用虚拟线程和结构化并发，这变得简单而安全。</p>
<h2 data-id="heading-7">模块系统考量</h2>
<p>在使用结构化并发构建模块化应用程序时，理解 Java 的模块系统变得很重要。对于模块，反射失去了其"超能力"，并且受限于与编译代码完全相同的可访问性规则——它只能访问导出包中公共类的公共成员。</p>
<p>默认情况下，只有 <code>module-info.java</code> 中显式导出的包是可见的。如果您使用的是依赖反射的框架（如 Spring 或 Hibernate），您将需要额外的声明：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">module</span> com.example.app {

<span class="hljs-comment">// 用于编译时访问的常规导出</span>

<span class="hljs-keyword">exports</span> com.example.api;

  


<span class="hljs-comment">// 为运行时反射访问开放</span>

opens com.example.entities to org.hibernate.orm.core;

  


<span class="hljs-keyword">requires</span> java.base;

<span class="hljs-keyword">requires</span> org.hibernate.orm.core;

}

</code></pre>
<p>在编译时，开放的包完全被封装，就像该指令不存在一样，但在运行时，包的类型可用于反射，自由地与所有类型和成员（无论公开与否）交互。</p>
<p>为了在所有包上获得完整的反射访问权限，您可以声明一个开放模块：</p>
<pre><code class="hljs language-java" lang="java">
open <span class="hljs-keyword">module</span> com.example.app {

<span class="hljs-keyword">exports</span> com.example.api;

<span class="hljs-keyword">requires</span> java.base;

}

</code></pre>
<p>开放模块会开放其包含的所有包，就像每个包都单独在 <code>opens</code> 指令中使用一样，这很方便但降低了封装性。</p>
<h2 data-id="heading-8">可观测性和调试</h2>
<p>结构化并发显著提高了可观测性。线程转储现在显示了清晰的父子关系：</p>
<pre><code class="hljs language-ini" lang="ini">
jcmd &lt;pid&gt; Thread.dump_to_file <span class="hljs-attr">-format</span>=json output.json

</code></pre>
<p>JSON 输出揭示了 <code>StructuredTaskScope</code> 及其在数组中的分叉子任务，使得理解正在运行的内容及其原因变得容易。这与关系隐式的扁平线程转储相比，是一种变革。</p>
<p><strong>当前状态与演进</strong></p>
<p>结构化并发由 JEP 428 提出，并在 JDK 19 中作为孵化 API 交付，在 JDK 20 中重新孵化，通过 JEP 453 在 JDK 21 中首次预览，并在 JDK 22 和 23 中重新预览。截至 JDK 25，该 API 已经演进，使用静态工厂方法替代了公共构造函数。</p>
<p>要在当前 JDK 版本中使用结构化并发，需启用预览特性：</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 编译</span>

javac --release 21 --enable-preview MyApp.java

  


<span class="hljs-comment"># 运行</span>

java --enable-preview MyApp

</code></pre>
<p>基于真实世界的反馈，该 API 正在稳定下来。结构化并发已被证明是一种安全、富有表现力且易于理解的并发方法，Python 库率先开创了这一领域，随后是 Kotlin 等语言。</p>
<h2 data-id="heading-9">最佳实践</h2>
<ul>
<li>
<p><strong>始终使用 Try-With-Resources</strong>：必须关闭作用域以防止线程泄漏。切勿手动管理 <code>StructuredTaskScope</code> 的生命周期。</p>
</li>
<li>
<p><strong>选择正确的策略</strong>：当所有结果都重要时使用 <code>ShutdownOnFailure</code>，在竞速场景中使用 <code>ShutdownOnSuccess</code>，或者为特定需求实现自定义策略。</p>
</li>
<li>
<p><strong>与虚拟线程结合使用</strong>：结构化并发与虚拟线程结合时效果最佳，能够通过简单的代码实现大规模并发。</p>
</li>
<li>
<p><strong>避免共享可变状态</strong>：虽然结构化并发处理协调，但您仍然需要对共享数据的线程安全负责。</p>
</li>
<li>
<p><strong>考虑作用域值</strong>：为了在任务层次结构中传递上下文，作用域值（JEP 481）提供了比 <code>ThreadLocal</code> 更好的替代方案。</p>
</li>
</ul>
<h2 data-id="heading-10">真实示例：聚合用户数据</h2>
<p>让我们构建一个从多个来源聚合数据的完整示例：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserAggregator</span> {

<span class="hljs-keyword">record</span> <span class="hljs-title class_">UserData</span><span class="hljs-params">(User user, List&lt;Order&gt; orders,

Stats stats, Recommendations recs)</span> {}

  


<span class="hljs-keyword">public</span> UserData <span class="hljs-title function_">aggregate</span><span class="hljs-params">(String userId)</span>

<span class="hljs-keyword">throws</span> ExecutionException, InterruptedException {

<span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructuredTaskScope</span>.ShutdownOnFailure()) {

Supplier&lt;User&gt; user =

scope.fork(() -&gt; userService.fetch(userId));

Supplier&lt;List&lt;Order&gt;&gt; orders =

scope.fork(() -&gt; orderService.fetch(userId));

Supplier&lt;Stats&gt; stats =

scope.fork(() -&gt; statsService.compute(userId));

Supplier&lt;Recommendations&gt; recs =

scope.fork(() -&gt; mlService.recommend(userId));

  


scope.join().throwIfFailed();

  


<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserData</span>(

user.get(),

orders.get(),

stats.get(),

recs.get()

);

}

}

}

</code></pre>
<p>这种模式简洁、安全且高效。如果任何服务失败，所有其他服务会立即被取消。作用域确保适当的清理。并且借助虚拟线程，这可以扩展到数千个并发请求。</p>
<h2 data-id="heading-11">开发者观点</h2>
<p>Java 架构师决定不从 <code>fork</code> 方法返回 <code>Future</code> 实例，以避免与非结构化计算混淆，并与旧的并发模型进行清晰切割。这一设计决策强调了结构化并发是一种新的范式，而不仅仅是渐进式改进。</p>
<p>Rock the JVM 教程指出，结构化并发最终为 Java 带来了其他 JVM 语言通过 Kotlin 协程和 Scala Cats Effects Fibers 等库所提供的功能，但拥有官方的平台支持。</p>
<h2 data-id="heading-12">展望未来</h2>
<p>结构化并发代表了我们对并发编程思考方式的根本转变。我们不是管理单个线程和 Future，而是按层次结构组织并发工作——就像我们用方法和循环组织顺序代码一样。</p>
<p>好处是显而易见的：没有线程泄漏、正确的错误传播、协调的取消以及增强的可观测性。结合虚拟线程，Java 现在提供了一个既强大又易于使用的并发模型。</p>
<p>随着该 API 走向最终化，预计将在框架和库中得到更广泛的采用。Spring、Hibernate 及其他生态系统项目已经在考虑如何利用结构化并发来编写更清晰、更可靠的并发代码。</p>
<hr/>
<p>【注】本文译自：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.javacodegeeks.com%2F2025%2F11%2Fstructured-concurrency-patterns-in-java.html" target="_blank" title="https://www.javacodegeeks.com/2025/11/structured-concurrency-patterns-in-java.html" ref="nofollow noopener noreferrer">Structured Concurrency Patterns in Java</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nano Banana新玩法无限套娃！“GPT-5都不会处理这种级别的递归”]]></title>    <link>https://juejin.cn/post/7576264484688822312</link>    <guid>https://juejin.cn/post/7576264484688822312</guid>    <pubDate>2025-11-25T06:52:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576264484688822312" data-draft-id="7576264484688789544" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nano Banana新玩法无限套娃！“GPT-5都不会处理这种级别的递归”"/> <meta itemprop="keywords" content="GPT,人工智能"/> <meta itemprop="datePublished" content="2025-11-25T06:52:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="量子位"/> <meta itemprop="url" content="https://juejin.cn/user/2858385963484488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nano Banana新玩法无限套娃！“GPT-5都不会处理这种级别的递归”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385963484488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    量子位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T06:52:28.000Z" title="Tue Nov 25 2025 06:52:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>您猜怎么着？Nano banana 的新玩法就像路易十六，根本看不到头。</p>
<p>今天一睁眼，就发现 Pro 版本带着咱掉进<strong>无限套娃</strong>的世界里了，be like：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6de44bc5efc846899696457dd98754ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=oEmUFY7qh%2FE%2Bpl6RPJkn3FiTpUk%3D" alt="" loading="lazy"/></p>
<p>求问，到底是先有的这张照片，还是先有的这幅油画？（doge）</p>
<p>想要画出这张图，需要的提示词非常简单：</p>
<blockquote>
<p>1998 年的一张业余摄影作品。画面中，一位中年艺术家正在将电脑屏幕上的图像亲手复制到一张绷好的油画布上，但这个图像本身其实就是这位艺术家绘制该递归图像时的拍摄画面。</p>
</blockquote>
<p>这张照片的原作者、Reddit 网友 r/ChatGPT 连连惊叹，表示 Nano Banana Pro 画的这张图真的惊艳到他了——</p>
<p>老式显示器发出的光晕，画布下溅上去的颜料，还有画面右下方那个傻瓜相机的时间戳……r/ChatGPT 像欣赏一张传世名画一样把这张图放大看了 20 分钟。</p>
<p>要知道，r/ChatGPT 皮下是 Riley Goodside，被业内普遍认为是最早一批 “提示工程师” 之一，甚至被媒体称为“全球最牛的提示工程师”。</p>
<p>今年，他加入了 Google DeepMind，从事与大模型提示工程相关的工作。</p>
<p>此次分享完自己的套娃玩法后，Riley 稍带手不忘对比一把：“GPT-5 都不会处理这种级别的递归！”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe3481fe42014430bf1cdf76f8fbd327~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=7PqNA%2B2%2BT0TeOIJ2bUAslBfqkZY%3D" alt="" loading="lazy"/></p>
<p>Nano Banana 不愧是 Nano Banana，果然是真 ·N B……</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f1e9f39b3b5449b80f80c0bb522642d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=XmVGpjwrxlFdMD3MmEcikcjqOOo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">“你的递归次数即将用尽”</h2>
<p>好奇的网友们闻讯火速赶来，已经开始套娃套得不知天地为何物——</p>
<p>生成出来的图像有很成功的。</p>
<p>而且提示词就在蛋糕上，属实是把 Nano Banana 玩儿明白了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9768a7d73552454fb32af0812e0475fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=jSXRO2e8wf6DMtant2A%2BKUQg11g%3D" alt="" loading="lazy"/></p>
<p>网友看了连声说好，表示 Nano Banana 对提示词中规定的背景和拍摄视角，理解非常到位。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f37926b0a0742cfab76f97c42fb93b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=kL2j8dlOWa1UgHYXUcmT9ma%2FLRM%3D" alt="" loading="lazy"/></p>
<p>而大家晒出的结果里也有令人看了就摇头的，比如下面这张。</p>
<p>你说它套娃了吗？好像套了。</p>
<p>但又好像哪里套得不对，抠脑壳. gif</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fe36a3a247d434f9886e7f39ae8079c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=di2uhmod%2FLe7NGOLKgUwvIv9y24%3D" alt="" loading="lazy"/></p>
<p>此外，大家还发现，只要规定 “1998 年”，Nano Banana 就很喜欢盖 1998 年 10 月的时间戳。</p>
<p>不知道它为啥对这个月份情有独钟。</p>
<p>有清楚背后原因的小伙伴不？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46b32fc4cecf450ba183d7bf1fd5816f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=cXSfbpS%2F6X1tRfOfT5rfzBmA4mU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/607bf598a84343f3ae28027b5234eb50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=3qSJG0ub6W81vPOzqzlrk0XveeA%3D" alt="" loading="lazy"/></p>
<p>但和是不是胡说八道的语言模型一样，Nano Banana 生成的照片肯定达不到百分百完美。</p>
<p>这场套娃游戏的细节处还是有诸多 bug，而且很多人玩儿无限套娃的时候都设定它画出来的是一张老照片，噪点堪比 ccd，分辨率很低，给了 AI 很多可以 “出错” 的模糊空间。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16693bf0469b49e79938f18ad41aa501~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=MwIUEtSpOepJBoXSMuQ8%2ByTFFoE%3D" alt="" loading="lazy"/></p>
<p>不过需要注意了，这个套娃游戏里，并不存在上面这个网友谈及的 “主图像”。</p>
<p>AI 生成图像时，并不是用 Photoshop 来 P 图那样把已有的图片素材（如一只猫的照片）用来复制、粘贴、缩放或拼接。</p>
<p>Nano Banana 画图，看起来是在用同样的元素套娃，但其实看起来相同的部分是分别随机噪声生成的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/849dd86181974f11ae063854ffdcbcee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=oNzM%2BcT8oDX9hv5oAfwfEOnkfVI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">Gemini 市场份额提升至 30%</h2>
<p>现阶段必然出现的画画 “幻觉” 并不妨碍大家表达对 Nano Banana 的喜欢。</p>
<p>Reddit 的讨论区里，不少用户直接用 “Gemini is CRAZY” 来表达自己的感叹。</p>
<p>怎么说呢——</p>
<p>太好了，太好了，谷歌你有点太好了！</p>
<p>不光是 Nano Banana 被大家疯玩，本月 19 日 Gemini 3 发布后，根据 SimilarWeb 统计结果，Gemini 的市场份额直接在短时间内从 23% 拉升至 30%。</p>
<p><em>（注：仅统计桌面和移动网页浏览量，不包括应用程序）</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86795de63418449aba44a72ebd44ec58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=GxS40y80VOmHJoPNbj37DeGagrw%3D" alt="" loading="lazy"/></p>
<p>虽然从图上的紫色曲线也可以看到，ChatGPT 的核心用户群保持稳固，但这个市场份额拉升之迅速，大概 ChatGPT 看了都要缓缓打出一个问号：</p>
<p>Hey Bro，这合理吗？</p>
<p>社交媒体上同时讨论着另一个话题。</p>
<p>增加的 7% 市场份额，是新发布带来的一时兴起的边缘用户，还是真的迎来了一波新的长期粉丝？</p>
<p>毕竟根据 TechRadar 援引的数据，ChatGPT 的用户忠诚度大约是 82%，相比之下，Gemini 则只有 49%。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f12c9cff6394bccb96c801341facf16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=e35Mi6sbVM2gYVE5OQD5injqFcA%3D" alt="" loading="lazy"/></p>
<p>有人表示，大模型用户本身就没任何粘性可言啦，更高智能的模型已出现，大家就立马投入新的怀抱了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b82111a2a57c4ddba9c215a13de60105~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=EO6g2MoY%2Fup81k2Wm%2FZ%2BQEzdeSU%3D" alt="" loading="lazy"/></p>
<p>话说回来，Gemini 的确已经让部分用户变心了。</p>
<p>Salesforce 的 CEO Marc Benioff，就是快乐奔向 Gemini 的那一个：</p>
<blockquote>
<p>过去 3 年，我每天都用 ChatGPT。但刚才玩儿了俩小时的 Gemini3，我再也回不去了。<br/>
推理能力、速度、图像、视频…… 这简直是一次疯狂的能力飞跃。一切变得更快、更清晰。<br/>
感觉世界再次发生了变化。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/741e860bb1af46f189bcf13ee2fa3b48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=PsgZGgKiX7bXH%2FWrNazmHH9piqY%3D" alt="" loading="lazy"/></p>
<p>也有另外的网友分享了自己的每日 AI 组合套餐——</p>
<p>用 Claude 编程、写作，涉及深度研究、搜索、学习（NotebookLM）、设计、图像和视频的时候，就使用 Gemini。</p>
<p>你呢？你每天都让哪些 AI 陪你打工？</p>
<p>可以在评论区和大家分享一下～</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3e1f414e07642ab9785218fd6e4e5a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658347&amp;x-signature=muLBDUORAP%2BYG1y1eKoL2e7E%2Fkw%3D" alt="" loading="lazy"/></p>
<p>参考链接：<br/>
[1]<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.reddit.com%2Fr%2FChatGPT%2Fcomments%2F1p4ljuz%2Fnano_banana_gemini_3_prompt_gone_infinite_1998%2F" target="_blank" title="https://www.reddit.com/r/ChatGPT/comments/1p4ljuz/nano_banana_gemini_3_prompt_gone_infinite_1998/" ref="nofollow noopener noreferrer">www.reddit.com/r/ChatGPT/c…</a><br/>
[2]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fgoodside%2Fstatus%2F1993049543945159145%3Fs%3D20" target="_blank" title="https://x.com/goodside/status/1993049543945159145?s=20" ref="nofollow noopener noreferrer">x.com/goodside/st…</a><br/>
[3]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FBenioff%2Fstatus%2F1992726929204760661%3Fs%3D20" target="_blank" title="https://x.com/Benioff/status/1992726929204760661?s=20" ref="nofollow noopener noreferrer">x.com/Benioff/sta…</a><br/>
[4]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fdeedydas%2Fstatus%2F1992972767424331978%3Fs%3D20" target="_blank" title="https://x.com/deedydas/status/1992972767424331978?s=20" ref="nofollow noopener noreferrer">x.com/deedydas/st…</a></p>
<p><strong>欢迎在评论区留下你的想法！</strong></p>
<p>— <strong>完</strong> —</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python实现异步任务队列深度好文]]></title>    <link>https://juejin.cn/post/7576470438579748890</link>    <guid>https://juejin.cn/post/7576470438579748890</guid>    <pubDate>2025-11-25T06:46:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576470438579748890" data-draft-id="7576218673050026035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python实现异步任务队列深度好文"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2025-11-25T06:46:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户234526700982"/> <meta itemprop="url" content="https://juejin.cn/user/3062604336999771"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python实现异步任务队列深度好文
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3062604336999771/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户234526700982
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T06:46:12.000Z" title="Tue Nov 25 2025 06:46:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Python实现异步任务队列深度好文</h2>
<p>@<a href="https://link.juejin.cn?target=%25E6%2596%2587%25E7%25AB%25A0%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">TOC</a></p>
<hr/>
<h3 data-id="heading-1">开篇引言</h3>
<p>在现代Web应用和数据处理系统中，异步任务队列已经成为处理高并发请求和后台任务的重要工具。Python作为一种高级编程语言，提供了多种方式来实现异步任务队列。本文将深入探讨如何使用Python实现高效的异步任务队列，并通过实际案例展示其应用场景。</p>
<h3 data-id="heading-2">核心要点</h3>
<ol>
<li>异步任务队列的基本原理</li>
<li>使用<code>asyncio</code>和<code>aiohttp</code>实现异步任务队列</li>
<li>任务队列的持久化与消息传递</li>
<li>实际应用案例：猴子音悦100万正版音乐</li>
</ol>
<h3 data-id="heading-3">异步任务队列的基本原理</h3>
<h4 data-id="heading-4">基本概念</h4>
<p>异步任务队列是一种用于处理大量后台任务的技术。它通过将任务放入队列中，然后由多个工作进程或线程并行处理这些任务，从而提高系统的整体性能和响应速度。</p>
<h4 data-id="heading-5">关键组件</h4>
<ul>
<li><strong>生产者</strong>：负责生成任务并将其放入队列。</li>
<li><strong>消费者</strong>：从队列中取出任务并执行。</li>
<li><strong>队列</strong>：存储待处理任务的数据结构。</li>
</ul>
<h4 data-id="heading-6">优缺点</h4>
<ul>
<li><strong>优点</strong>：提高系统吞吐量，减少响应时间，提高资源利用率。</li>
<li><strong>缺点</strong>：增加了系统的复杂性，需要处理任务的调度和协调。</li>
</ul>
<h3 data-id="heading-7">使用<code>asyncio</code>和<code>aiohttp</code>实现异步任务队列</h3>
<h4 data-id="heading-8">原理</h4>
<p><code>asyncio</code>是Python的标准库，提供了异步I/O、事件循环、协程等基础功能。<code>aiohttp</code>是一个基于<code>asyncio</code>的HTTP客户端和服务器库，适用于构建高性能的异步Web应用。</p>
<h4 data-id="heading-9">完整代码示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> aiohttp
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web

<span class="hljs-comment"># 任务队列</span>
task_queue = asyncio.Queue()

<span class="hljs-comment"># 生产者函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">producer</span>(<span class="hljs-params">url, queue</span>):
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(url) <span class="hljs-keyword">as</span> response:
            <span class="hljs-keyword">await</span> queue.put((url, <span class="hljs-keyword">await</span> response.text()))

<span class="hljs-comment"># 消费者函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">consumer</span>(<span class="hljs-params">queue</span>):
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        url, content = <span class="hljs-keyword">await</span> queue.get()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Received content from <span class="hljs-subst">{url}</span>"</span>)
        <span class="hljs-comment"># 处理内容</span>
        queue.task_done()

<span class="hljs-comment"># 主函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># 创建任务队列</span>
    task_queue = asyncio.Queue()

    <span class="hljs-comment"># 启动消费者</span>
    consumer_task = asyncio.create_task(consumer(task_queue))

    <span class="hljs-comment"># 启动生产者</span>
    urls = [<span class="hljs-string">"https://example.com"</span>, <span class="hljs-string">"https://example.org"</span>]
    producers = [producer(url, task_queue) <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> urls]
    <span class="hljs-keyword">await</span> asyncio.gather(*producers)

    <span class="hljs-comment"># 等待所有任务完成</span>
    <span class="hljs-keyword">await</span> task_queue.join()
    consumer_task.cancel()

<span class="hljs-comment"># 运行主函数</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<h4 data-id="heading-10">关键说明</h4>
<ul>
<li><code>asyncio.Queue</code>用于创建一个异步队列。</li>
<li><code>producer</code>函数负责生成任务并放入队列。</li>
<li><code>consumer</code>函数从队列中取出任务并处理。</li>
<li><code>asyncio.gather</code>用于并行运行多个协程。</li>
<li><code>queue.task_done()</code>用于标记任务已完成。</li>
</ul>
<h3 data-id="heading-11">任务队列的持久化与消息传递</h3>
<h4 data-id="heading-12">原理</h4>
<p>为了确保任务队列的可靠性和持久化，可以使用消息队列系统如RabbitMQ或Redis。这些系统提供了更强大的消息传递机制，支持消息的持久化、确认机制和高可用性。</p>
<h4 data-id="heading-13">完整代码示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> aioredis

<span class="hljs-comment"># Redis连接</span>
redis = <span class="hljs-literal">None</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_redis</span>():
    <span class="hljs-keyword">global</span> redis
    redis = <span class="hljs-keyword">await</span> aioredis.create_redis_pool(<span class="hljs-string">'redis://localhost'</span>)

<span class="hljs-comment"># 生产者函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">producer</span>(<span class="hljs-params">url</span>):
    <span class="hljs-keyword">await</span> redis.rpush(<span class="hljs-string">'task_queue'</span>, url)

<span class="hljs-comment"># 消费者函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">consumer</span>():
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        url = <span class="hljs-keyword">await</span> redis.blpop(<span class="hljs-string">'task_queue'</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Received URL: <span class="hljs-subst">{url[<span class="hljs-number">1</span>].decode()}</span>"</span>)
        <span class="hljs-comment"># 处理URL</span>
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 模拟处理时间</span>

<span class="hljs-comment"># 主函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-keyword">await</span> init_redis()
    <span class="hljs-comment"># 启动消费者</span>
    consumer_task = asyncio.create_task(consumer())

    <span class="hljs-comment"># 启动生产者</span>
    urls = [<span class="hljs-string">"https://example.com"</span>, <span class="hljs-string">"https://example.org"</span>]
    <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> urls:
        <span class="hljs-keyword">await</span> producer(url)

    <span class="hljs-comment"># 等待一段时间后退出</span>
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">5</span>)
    consumer_task.cancel()

<span class="hljs-comment"># 运行主函数</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<h4 data-id="heading-14">关键说明</h4>
<ul>
<li><code>aioredis</code>是一个基于<code>asyncio</code>的Redis客户端库。</li>
<li><code>rpush</code>和<code>blpop</code>分别用于向队列中添加任务和从队列中取出任务。</li>
<li><code>await asyncio.sleep(1)</code>用于模拟任务处理时间。</li>
</ul>
<h3 data-id="heading-15">实际应用案例：猴子音悦100万正版音乐</h3>
<h4 data-id="heading-16">应用场景</h4>
<p>假设我们有一个音乐平台“猴子音悦”，拥有100万首正版音乐。我们需要定期从各个音乐提供商获取最新的音乐信息并更新到我们的数据库中。这个过程可以通过异步任务队列来实现。</p>
<h4 data-id="heading-17">实现步骤</h4>
<ol>
<li><strong>任务生成</strong>：定时任务生成器定期生成抓取音乐信息的任务，并将其放入任务队列。</li>
<li><strong>任务处理</strong>：多个消费者从任务队列中取出任务，调用API获取音乐信息，并更新到数据库。</li>
<li><strong>持久化</strong>：使用Redis作为任务队列的持久化存储，确保任务不会丢失。</li>
</ol>
<h4 data-id="heading-18">代码示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> aioredis
<span class="hljs-keyword">import</span> aiohttp

<span class="hljs-comment"># Redis连接</span>
redis = <span class="hljs-literal">None</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_redis</span>():
    <span class="hljs-keyword">global</span> redis
    redis = <span class="hljs-keyword">await</span> aioredis.create_redis_pool(<span class="hljs-string">'redis://localhost'</span>)

<span class="hljs-comment"># 生产者函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">producer</span>(<span class="hljs-params">url</span>):
    <span class="hljs-keyword">await</span> redis.rpush(<span class="hljs-string">'music_task_queue'</span>, url)

<span class="hljs-comment"># 消费者函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">consumer</span>():
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        url = <span class="hljs-keyword">await</span> redis.blpop(<span class="hljs-string">'music_task_queue'</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Received URL: <span class="hljs-subst">{url[<span class="hljs-number">1</span>].decode()}</span>"</span>)
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(url[<span class="hljs-number">1</span>].decode()) <span class="hljs-keyword">as</span> response:
                music_info = <span class="hljs-keyword">await</span> response.json()
                <span class="hljs-comment"># 更新数据库</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Updated music info: <span class="hljs-subst">{music_info}</span>"</span>)
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 模拟处理时间</span>

<span class="hljs-comment"># 主函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-keyword">await</span> init_redis()
    <span class="hljs-comment"># 启动消费者</span>
    consumer_task = asyncio.create_task(consumer())

    <span class="hljs-comment"># 启动生产者</span>
    urls = [<span class="hljs-string">"https://api.example.com/music/1"</span>, <span class="hljs-string">"https://api.example.com/music/2"</span>]
    <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> urls:
        <span class="hljs-keyword">await</span> producer(url)

    <span class="hljs-comment"># 等待一段时间后退出</span>
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">5</span>)
    consumer_task.cancel()

<span class="hljs-comment"># 运行主函数</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<h4 data-id="heading-19">关键说明</h4>
<ul>
<li><code>producer</code>函数定期生成抓取音乐信息的任务。</li>
<li><code>consumer</code>函数从任务队列中取出任务，调用API获取音乐信息，并更新到数据库。</li>
<li><code>aioredis</code>和<code>aiohttp</code>结合使用，实现异步任务队列的高效处理。</li>
</ul>
<h3 data-id="heading-20">总结</h3>
<p>本文详细介绍了如何使用Python实现高效的异步任务队列。通过<code>asyncio</code>和<code>aiohttp</code>，我们可以轻松地构建异步任务队列，并通过Redis实现任务队列的持久化。实际应用案例展示了如何在音乐平台“猴子音悦”中使用异步任务队列来处理大规模的音乐信息更新任务。希望本文能帮助读者更好地理解和应用异步任务队列技术。</p>
<hr/>
<h3 data-id="heading-21">延伸阅读</h3>
<ul>
<li>建议结合实际项目进行练习</li>
<li>深入阅读相关技术文档</li>
<li>关注技术社区的最新动态</li>
</ul>
<blockquote>
<p>本文经过精心编写和优化，如有不准确之处，欢迎在评论区指出。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 内置函数---getattr()的使用]]></title>    <link>https://juejin.cn/post/7576271552704626714</link>    <guid>https://juejin.cn/post/7576271552704626714</guid>    <pubDate>2025-11-25T06:51:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576271552704626714" data-draft-id="7576307259385479195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 内置函数---getattr()的使用"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-25T06:51:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="峰中有多云"/> <meta itemprop="url" content="https://juejin.cn/user/1913602002914967"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 内置函数---getattr()的使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1913602002914967/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    峰中有多云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T06:51:19.000Z" title="Tue Nov 25 2025 06:51:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><p><strong><code>getattr()</code></strong> 是 Python 的内置函数，用于<strong>动态获取对象的属性值</strong>。<br/>
<strong>基本语法</strong>： <strong>|<code>getattr(object, name[, default])</code>|</strong>  <br/>
参数介绍：</p>
<ul>
<li><code>object</code>：要获取属性的对象</li>
<li><code>name</code>：属性名（字符串）</li>
<li><code>default</code>：可选，如果属性不存在时返回的默认值</li>
</ul>
<h3 data-id="heading-0">1. 基本用法</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>): 
    self.name = <span class="hljs-string">"张三"</span> 
    self.age = <span class="hljs-number">25</span>
person = Person()

<span class="hljs-comment"># 等价于 person.name </span>
name = <span class="hljs-built_in">getattr</span>(person, <span class="hljs-string">"name"</span>) 
<span class="hljs-built_in">print</span>(name) <span class="hljs-comment"># 输出：张三</span>

<span class="hljs-comment"># 等价于 person.age </span>
age = <span class="hljs-built_in">getattr</span>(person, <span class="hljs-string">"age"</span>) 
<span class="hljs-built_in">print</span>(age) <span class="hljs-comment"># 输出：25</span>
</code></pre>
<h3 data-id="heading-1">使用默认值（属性不存在时）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 属性存在时 </span>
email = <span class="hljs-built_in">getattr</span>(person, <span class="hljs-string">"email"</span>, <span class="hljs-string">"未设置邮箱"</span>) 
<span class="hljs-built_in">print</span>(email) <span class="hljs-comment"># 输出：未设置邮箱（因为person没有email属性） </span>
<span class="hljs-comment"># 等价于： </span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(person, <span class="hljs-string">"email"</span>): 
    email = person.email 
<span class="hljs-keyword">else</span>: 
    email = <span class="hljs-string">"未设置邮箱"</span>
</code></pre>
<h3 data-id="heading-2">3. 动态属性名（最常用的场景）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>: 
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>): 
        self.host = <span class="hljs-string">"localhost"</span> 
        self.port = <span class="hljs-number">8080</span> 
config = Config() 
attributes = [<span class="hljs-string">"host"</span>, <span class="hljs-string">"port"</span>, <span class="hljs-string">"timeout"</span>] 
<span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> attributes: 
    value = <span class="hljs-built_in">getattr</span>(config, attr, <span class="hljs-string">"未配置"</span>) 
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{attr}</span>: <span class="hljs-subst">{value}</span>"</span>) 
    
<span class="hljs-comment"># 输出： </span>
<span class="hljs-comment"># host: localhost </span>
<span class="hljs-comment"># port: 8080 </span>
<span class="hljs-comment"># timeout: 未配置</span>
</code></pre>
<h3 data-id="heading-3">4. 获取方法（函数属性）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span>: 
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, a, b</span>): 
    <span class="hljs-keyword">return</span> a + b 
    
calc = Calculator() 
<span class="hljs-comment"># 获取方法对象 </span>
add_method = <span class="hljs-built_in">getattr</span>(calc, <span class="hljs-string">"add"</span>) 
result = add_method(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>) 
<span class="hljs-built_in">print</span>(result) <span class="hljs-comment"># 输出：8</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 NodeJs 的分布式任务队列与容器优雅停机]]></title>    <link>https://juejin.cn/post/7575735719076331526</link>    <guid>https://juejin.cn/post/7575735719076331526</guid>    <pubDate>2025-11-24T02:56:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575735719076331526" data-draft-id="7575644469711683603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 NodeJs 的分布式任务队列与容器优雅停机"/> <meta itemprop="keywords" content="后端,Node.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T02:56:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WindRunnerMax"/> <meta itemprop="url" content="https://juejin.cn/user/1829999989247214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 NodeJs 的分布式任务队列与容器优雅停机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1829999989247214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WindRunnerMax
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:56:52.000Z" title="Mon Nov 24 2025 02:56:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当在后端执行复杂的任务时，通常不能够在短时间内即时响应，例如文档导入、导出任务等。再加上当前的<code>LLMs</code>发展，我们可以实现文档的写作、质检、翻译等复杂任务，这些任务通常都比较耗时，这样就需要任务队列来管理这些异步任务的执行顺序和资源分配，而优雅停机则用以保证任务的完整处理。</p>
<details>
<summary><strong>AI Infra 系列相关文章</strong></summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FEveryDay%2Fblob%2Fmaster%2FBrowser%2F%25E5%259F%25BA%25E4%25BA%258Efetch%25E7%259A%2584SSE%25E6%2596%25B9%25E6%25A1%2588.md" target="_blank" title="https://github.com/WindRunnerMax/EveryDay/blob/master/Browser/%E5%9F%BA%E4%BA%8Efetch%E7%9A%84SSE%E6%96%B9%E6%A1%88.md" ref="nofollow noopener noreferrer">基于 fetch 的 SSE 方案</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FEveryDay%2Fblob%2Fmaster%2FPlugin%2F%25E5%259F%25BA%25E4%25BA%258E%25E5%2590%2591%25E9%2587%258F%25E6%25A3%2580%25E7%25B4%25A2%25E5%25AE%259E%25E7%258E%25B0%25E5%259F%25BA%25E7%25A1%2580RAG%25E6%259C%258D%25E5%258A%25A1.md" target="_blank" title="https://github.com/WindRunnerMax/EveryDay/blob/master/Plugin/%E5%9F%BA%E4%BA%8E%E5%90%91%E9%87%8F%E6%A3%80%E7%B4%A2%E5%AE%9E%E7%8E%B0%E5%9F%BA%E7%A1%80RAG%E6%9C%8D%E5%8A%A1.md" ref="nofollow noopener noreferrer">基于向量检索实现基础 RAG 服务</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FEveryDay%2Fblob%2Fmaster%2FPlugin%2F%25E6%25B5%2581%25E5%25BC%258FMarkdown%25E5%25A2%259E%25E9%2587%258F%25E5%25AF%258C%25E6%2596%2587%25E6%259C%25AC%25E8%25A7%25A3%25E6%259E%2590%25E7%25AE%2597%25E6%25B3%2595.md" target="_blank" title="https://github.com/WindRunnerMax/EveryDay/blob/master/Plugin/%E6%B5%81%E5%BC%8FMarkdown%E5%A2%9E%E9%87%8F%E5%AF%8C%E6%96%87%E6%9C%AC%E8%A7%A3%E6%9E%90%E7%AE%97%E6%B3%95.md" ref="nofollow noopener noreferrer">流式 Markdown 增量富文本解析算法</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FEveryDay%2Fblob%2Fmaster%2FPlugin%2F%25E4%25BB%25BF%25E7%2585%25A7%25E8%25B1%2586%25E5%258C%2585%25E5%25AE%259E%25E7%258E%25B0Prompt%25E5%258F%2598%25E9%2587%258F%25E6%25A8%25A1%25E6%259D%25BF%25E8%25BE%2593%25E5%2585%25A5%25E6%25A1%2586.md" target="_blank" title="https://github.com/WindRunnerMax/EveryDay/blob/master/Plugin/%E4%BB%BF%E7%85%A7%E8%B1%86%E5%8C%85%E5%AE%9E%E7%8E%B0Prompt%E5%8F%98%E9%87%8F%E6%A8%A1%E6%9D%BF%E8%BE%93%E5%85%A5%E6%A1%86.md" ref="nofollow noopener noreferrer">仿照豆包实现 Prompt 变量模板输入框</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FEveryDay%2Fblob%2Fmaster%2FPlugin%2F%25E5%259F%25BA%25E4%25BA%258ENodeJs%25E5%25AE%259E%25E7%258E%25B0%25E4%25BB%25BB%25E5%258A%25A1%25E9%2598%259F%25E5%2588%2597%25E4%25B8%258E%25E4%25BC%2598%25E9%259B%2585%25E5%2581%259C%25E6%259C%25BA.md" target="_blank" title="https://github.com/WindRunnerMax/EveryDay/blob/master/Plugin/%E5%9F%BA%E4%BA%8ENodeJs%E5%AE%9E%E7%8E%B0%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97%E4%B8%8E%E4%BC%98%E9%9B%85%E5%81%9C%E6%9C%BA.md" ref="nofollow noopener noreferrer">基于 NodeJs 的分布式任务队列与容器优雅停机</a></li>
</ul>
</details>
<h2 data-id="heading-0">概述</h2>
<p>任务队列用于管理和调度异步任务，在实现时我们可能会使用一些现成的库，例如<code>Bull/BullMQ</code>、<code>Agenda</code>等。而如果需要实现更复杂的任务/消息调度，例如不同系统、应用之间的可靠消息传递等服务，我们还需要使用<code>Kafka</code>、<code>RabbitMQ</code>等消息队列系统。整体来说，异步任务可以实现如下功能:</p>
<ul>
<li>异步任务，将耗时的操作放到后台去处理，让主程序能够快速返回响应。</li>
<li>流量削峰，将大量请求转化为任务，平稳地存入队列，然后系统按照能承受的处理能力，从队列中取出任务进行消费。</li>
<li>错误重试，当任务执行失败时，队列可以尝试进行重试，如果重试多次后仍然失败，则可以将任务标记为失败。</li>
</ul>
<p>优雅停机则是指在应用程序关闭时，能够正确地处理正在进行的任务，确保数据的一致性和完整性。在这里的优雅停机主要分为针对请求的处理和针对任务队列的处理，请求的部分通常会由网关加上框架本身处理，而任务队列的重置或者结束，则需要靠我们主动处理。整体来说，优雅停机通常需要做如下处理:</p>
<ul>
<li>停止接收新的请求，服务需要避免新的请求进入，这部分通常需要网关等前置节点来处理。</li>
<li>处理当前请求，服务需要继续处理当前已经在处理中的请求，确保这些请求能够正常完成。</li>
<li>释放已分配资源，在请求处理完成后，需要释放所有申请的资源，例如关闭数据库连接等。</li>
<li>关闭服务，当所有请求都处理完毕且资源都已释放后，需要正常关闭服务，或者强制停机。</li>
</ul>
<p>在本文中我们在<code>Nest</code>框架的基础上，实现简化版的分布式任务调度队列。并且基于<code>pm2</code>管理<code>NodeJs</code>进程，实现了优雅停机的能力，而且探讨了<code>Linux</code>系统下进程与信号的传递表现。文中涉及的实现都在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2Fwebpack-simple-environment" target="_blank" title="https://github.com/WindRunnerMax/webpack-simple-environment" ref="nofollow noopener noreferrer">github.com/WindRunnerM…</a> 中。</p>
<h2 data-id="heading-1">任务队列</h2>
<p>任务队列的实现比较简单，在我们的场景中主要目标就是流量削峰，特别是在调度<code>LLMs</code>时，我们需要将请求排队处理，当前的云服务商都会有并发请求的限制。当前云服务商主要是会限制<code>RPM</code>和<code>TPM</code>，即每分钟请求数和每分钟<code>Token</code>数量，这样就需要我们在应用层进行请求的排队处理。</p>
<p>在这里我们就不借助已有的框架，而是直接实现任务队列，主要目标是能够控制并发任务，并且叙述单进程以及单机集群模式、分布式任务的锁控制方案。而除了任务队列之外，还有很多细节需要处理，例如从数据库读取的控制并发、任务超时控制等，这些都可以在实际应用中进行扩展。</p>
<p>消息队列系统通常会有推送模式以及拉取模式两种消息消费的方式，而实际上在拉取模式下，消费者也需要实现类似的任务队列来控制并发请求，例如<code>Kafka</code>系统。当然如果是推送模式，就可以直接在消息队列中进行并发控制，例如<code>RabbitMQ</code>系统。</p>
<h3 data-id="heading-2">单实例任务</h3>
<p>我们先来实现单实例单进程的任务队列，首先需要实现一个任务队列类，通过实例化这个类我们可以在多个服务<code>Service</code>分别调度队列实例。在这里需要注意的是，如若不想在全局分别创建实例，在<code>Next</code>中就在<code>Provider</code>的类中独立维护实例，但是需要注意其<code>Scope</code>必须为全局单例而非请求级实例。</p>
<pre><code class="hljs language-js" lang="js">@<span class="hljs-title class_">Injectable</span>({ <span class="hljs-attr">scope</span>: <span class="hljs-title class_">Scope</span>.<span class="hljs-property">DEFAULT</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TasksService</span> {}
</code></pre>
<p>接下来假设实际任务是在数据库中存储的，毕竟任务需要持久化存储以防止数据丢失。然后需要实现<code>TaskQueue</code>类以控制并发任务，由于我们现在是单实例单进程的模式，就不需要分布式锁的要求，因此可以直接使用内存中的变量来控制并发任务，这里先定义类基本的结构:</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> declare <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskQueue</span> {
  <span class="hljs-comment">/** 实例/锁标识 */</span>
  private readonly key;
  <span class="hljs-comment">/** 并发运行数 */</span>
  private readonly maxTasks;
  <span class="hljs-comment">/** 本机正在运行任务数量 */</span>
  private runningTasks;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-comment">/** 唯一标识 */</span> key: string, <span class="hljs-comment">/** 最大并行任务数 */</span> maxTasks: number</span>);
  <span class="hljs-comment">/** 尝试批量调度任务 */</span>
  <span class="hljs-title function_">tryRun</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;;
  <span class="hljs-comment">/**  正式调度任务 */</span>
  <span class="hljs-title function_">run</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;;
  <span class="hljs-comment">/** 调度运行任务 - 需要实例化后重写该方法 <span class="hljs-doctag">@returns</span> 返回任务标识 id */</span>
  <span class="hljs-title function_">onRunning</span>(): <span class="hljs-title class_">Promise</span>&lt;string | <span class="hljs-literal">undefined</span>&gt;;
  <span class="hljs-comment">/** 分配 Quota */</span>
  <span class="hljs-title function_">assign</span>(): <span class="hljs-title class_">Promise</span>&lt;boolean&gt;;
  <span class="hljs-comment">/** 释放 Quota */</span>
  <span class="hljs-title function_">release</span>(): <span class="hljs-title class_">Promise</span>&lt;boolean&gt;;
}
</code></pre>
<p>接下来关注于<code>assign</code>和<code>release</code>分配和释放<code>Quota</code>方法，在这里我们直接在内存放置<code>Record&lt;string, number&gt;</code>对象来管理并发任务的资源数量。由于最后需要实现分布式锁，因此这里的逻辑实际上是与<code>Redis</code>锁的<code>LUA</code>脚本逻辑类似。</p>
<p>分配<code>Quota</code>时，我们需要检查当前运行的任务数量是否小于最大并发数，如果小于则分配成功并增加运行任务数量，否则分配失败。释放<code>Quota</code>时，我们需要减少运行任务数量，确保不会小于零，这里主要是避免切换<code>key</code>时释放的<code>Quota</code>将值写为负数，这样会导致并发量变高。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">assign</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;boolean&gt; {
  <span class="hljs-keyword">const</span> lockKey = <span class="hljs-string">"_lock_"</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>;
  <span class="hljs-keyword">let</span> current = <span class="hljs-variable constant_">MEMORY_MAP</span>[lockKey];
  <span class="hljs-keyword">if</span> (current === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>)  current = <span class="hljs-variable constant_">MEMORY_MAP</span>[lockKey] = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (current &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxTasks</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">const</span> serial = ++<span class="hljs-variable constant_">MEMORY_MAP</span>[lockKey];
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">release</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;boolean&gt; {
  <span class="hljs-keyword">const</span> lockKey = <span class="hljs-string">"_lock_"</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>;
  <span class="hljs-keyword">const</span> current = <span class="hljs-variable constant_">MEMORY_MAP</span>[lockKey];
  <span class="hljs-keyword">if</span> (current === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> || current &lt;= <span class="hljs-number">0</span>) {
    <span class="hljs-variable constant_">MEMORY_MAP</span>[lockKey] = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  --<span class="hljs-variable constant_">MEMORY_MAP</span>[lockKey];
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>由于任务本身已经由锁控制了并发执行，因此接下来只需要控制好任务的执行流程即可，而控制异步任务的方法通常有两种方式，类似于<code>webpack</code>的插件实现，一种方式是类似于控制反转的方式将<code>done</code>函数传递到任务中，另一种方式则是直接在任务中返回<code>Promise</code>对象，这里我们就直接采用异步模式。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">run</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
  <span class="hljs-keyword">const</span> assigned = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">assign</span>();
  <span class="hljs-keyword">if</span> (!assigned) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">id</span>: string | <span class="hljs-literal">undefined</span> = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">runningTasks</span>++;
  <span class="hljs-keyword">try</span> {
    id = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onRunning</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Task Queue Running Error:"</span>, error);
  }
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">runningTasks</span>--;
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">release</span>();
  id &amp;&amp; process.<span class="hljs-title function_">nextTick</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tryRun</span>);
}
</code></pre>
<p>在这里我们需要将<code>onRunning</code>方法重写，也就是在服务中将内置方法赋值到类上，通常这个方法主要是从数据库中取出任务并执行，执行完成后返回任务的<code>id</code>，如果没有任务则返回<code>undefined</code>。而这个<code>id</code>则会标识后续的任务是否会继续执行，这里的<code>nextTick</code>主要是为了避免栈溢出的问题。</p>
<p>如果在任务调度中直接递归地执行，则会存在堆栈溢出的可能。在下面<code>recursion</code>这个例子中，如果是同步的的函数执行，则会抛出<code>Maximum call stack size exceeded</code>的异常。而如果是异步递归函数<code>asyncRecursion</code>，每次递归调用都是在下一个事件循环中执行的，避免了溢出问题。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">recursion</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
  n % <span class="hljs-number">100</span> === <span class="hljs-number">0</span>  &amp;&amp; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Depth: <span class="hljs-subst">${n}</span>`</span>); <span class="hljs-comment">// $</span>
  <span class="hljs-title function_">recursion</span>(n - <span class="hljs-number">1</span>)
}
<span class="hljs-title function_">recursion</span>(<span class="hljs-number">100000</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncRecursion</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
  n % <span class="hljs-number">100</span> === <span class="hljs-number">0</span>  &amp;&amp; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Depth: <span class="hljs-subst">${n}</span>`</span>); <span class="hljs-comment">// $</span>
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncRecursion</span>(n - <span class="hljs-number">1</span>));
}
<span class="hljs-title function_">asyncRecursion</span>(<span class="hljs-number">100000</span>);
</code></pre>
<p>并发执行任务执行就需要实际启动这个<code>run</code>函数，不断尝试调度任务并且执行，而调度任务的方式自然就是通过循环来实现批量调度。这里需要注意的是，执行<code>run</code>函数的时候不能<code>await</code>，否则就会阻塞当前的事件循环，从而无法实现并发执行任务。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">tryRun</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
  <span class="hljs-keyword">const</span> batch = <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxTasks</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">runningTasks</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; batch; i++) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">run</span>();
  }
}
</code></pre>
<p>不过这里其实有个问题，如果此时没有任务可以调度，还是会尝试<code>maxTasks</code>次任务执行，这其实是会存在数据库无效读的问题。不过对于数据库来说这里的读操作通常是可以接受的，数据库里状态值是要加索引的，如果实在不可接受就需要排队延迟<code>run</code>的执行，例如前个任务<code>10s</code>内返回空就不执行。</p>
<h3 data-id="heading-3">原子读写</h3>
<p>那么重写<code>onRunning</code>方法的实现，主要是从数据库中读取任务并执行。假设我们查找数据是使用<code>find</code>语句，写数据是使用<code>update</code>语句，那么假设此时的状态字段为<code>status</code>，我们可以定义如下的状态，<code>pending</code>待处理、<code>running</code>处理中、<code>completed</code>完成，<code>failed</code>失败。</p>
<p>那么假设现在已经有<code>id</code>为<code>1</code>和<code>2</code>的两个任务处于<code>pending</code>状态，并且我们允许最大的并发数为<code>2</code>。此时我们在两个独立的任务中进行任务调度，第一步就是查询数据库中状态为<code>pending</code>的任务，并且将其状态更新为<code>running</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 任务 1</span>
<span class="hljs-keyword">await</span> find status=<span class="hljs-string">"pending"</span>
update id=$0 status=<span class="hljs-string">"running"</span> <span class="hljs-comment">// $</span>
<span class="hljs-comment">// 任务 2</span>
<span class="hljs-keyword">await</span> find status=<span class="hljs-string">"pending"</span>
update id=$0 status=<span class="hljs-string">"running"</span> <span class="hljs-comment">// $</span>
</code></pre>
<p>看起来这个调度并没有什么问题，但是实际上会存在竞态条件的问题。由于任务<code>1</code>和任务<code>2</code>同时执行查询语句，那么两个任务都会查询到<code>id=1</code>的任务，然后两个任务都会将其状态更新为<code>running</code>，这样就会导致同一个任务被多个进程处理。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 任务 1</span>
<span class="hljs-keyword">await</span> find status=<span class="hljs-string">"pending"</span> -&gt; id=<span class="hljs-number">1</span>
<span class="hljs-comment">// 任务 2</span>
<span class="hljs-keyword">await</span> find status=<span class="hljs-string">"pending"</span> -&gt; id=<span class="hljs-number">1</span>
</code></pre>
<p>究其原因，是因为查询和更新是两个独立的操作，并行的任务会同时触发查询，而本身并没有锁来保证查询到的任务在更新前不会被其他任务修改。因此在并行执行时，需要保证读写状态的操作是原子性的，也就是需要将查询和更新合并为一个操作，例如在<code>mongodb</code>中就存在<code>findOneAndUpdate</code>方法。</p>
<p>那么在这里我们同样模拟一下数据处理的逻辑，由于<code>Service</code>现在是单例的，因此我们直接维护一个二维数组来存储任务。在这里我们实现一个<code>findAndModify</code>方法来模拟数据库的查询和更新操作，这个方法会根据传入的查询条件查找任务，并且将其状态更新为新的状态。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TasksService</span> {
  public <span class="hljs-attr">tasks</span>: { <span class="hljs-attr">id</span>: string; <span class="hljs-attr">status</span>: <span class="hljs-string">"pending"</span> | <span class="hljs-string">"running"</span> | <span class="hljs-string">"success"</span> | <span class="hljs-string">"fail"</span> }[]

  private <span class="hljs-keyword">async</span> <span class="hljs-title function_">findAndModify</span>(<span class="hljs-params">
    find: { id?: string; status?: <span class="hljs-keyword">typeof</span> TasksService.prototype.tasks[<span class="hljs-number">0</span>][<span class="hljs-string">"status"</span>] } = {},
    status: <span class="hljs-keyword">typeof</span> TasksService.prototype.tasks[<span class="hljs-number">0</span>][<span class="hljs-string">"status"</span>]
  </span>) {
    <span class="hljs-keyword">const</span> task = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (find.<span class="hljs-property">id</span> &amp;&amp; t.<span class="hljs-property">id</span> !== find.<span class="hljs-property">id</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (find.<span class="hljs-property">status</span> &amp;&amp; t.<span class="hljs-property">status</span> !== find.<span class="hljs-property">status</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    });
    <span class="hljs-keyword">if</span> (task) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Task <span class="hljs-subst">${task.id}</span> is <span class="hljs-subst">${task.status}</span> =&gt; <span class="hljs-subst">${status}</span>.`</span>);
      task.<span class="hljs-property">status</span> = status;
      <span class="hljs-keyword">return</span> task;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<p>而重写<code>running</code>方法运行任务时，我们就可以调用这个<code>findAndModify</code>方法来查询并更新任务状态，从而保证任务的原子性。这里我们模拟任务的执行时间超时时间为<code>2s</code>，任务本身是随机生成的执行时长，这里的状态转移同样是使用上述方法来严格控制状态转移，当然也可以用变量标记来处理。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">onRunning</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findAndModify</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">"pending"</span> }, <span class="hljs-string">"running"</span>);
  <span class="hljs-keyword">if</span> (!task) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">execute</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">3000</span>));
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findAndModify</span>({ <span class="hljs-attr">id</span>: task.<span class="hljs-property">id</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">"running"</span> }, <span class="hljs-string">"success"</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Task <span class="hljs-subst">${task.id}</span> cost <span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now() - now}</span> ms.`</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findAndModify</span>({ <span class="hljs-attr">id</span>: task.<span class="hljs-property">id</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">"running"</span> }, <span class="hljs-string">"fail"</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Task"</span>, task.<span class="hljs-property">id</span>, <span class="hljs-string">"is fail."</span>, error);
    }
  };
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">timeout</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">ms: number</span>) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(ms);
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findAndModify</span>({ <span class="hljs-attr">id</span>: task.<span class="hljs-property">id</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">"running"</span> }, <span class="hljs-string">"fail"</span>);
  };
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-title function_">execute</span>(), <span class="hljs-title function_">timeout</span>(<span class="hljs-number">2000</span>)]);
  <span class="hljs-keyword">return</span> task.<span class="hljs-property">id</span>;
}
</code></pre>
<p>接下来基本已经完成了单实例单进程的任务队列实现，接下来我们就通过接口实现任务的创建和执行。并且在接口中定义好任务创建的方法，在下面的例子中我们批量创建<code>5</code>个任务，然后会调用队列的<code>tryRun</code>方法来尝试调度任务。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createTask</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> id = <span class="hljs-string">`task_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">1000</span>)}</span>`</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>({ id, <span class="hljs-attr">status</span>: <span class="hljs-string">"pending"</span> });
  <span class="hljs-keyword">return</span> { id };
}

@<span class="hljs-title class_">Controller</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> {
  @<span class="hljs-title class_">Inject</span>(<span class="hljs-title class_">IndexService</span>)
  private readonly indexService!: <span class="hljs-title class_">IndexService</span>;
  @<span class="hljs-title class_">Post</span>(<span class="hljs-string">"batch-create-task"</span>)
  public <span class="hljs-keyword">async</span> <span class="hljs-title function_">createTask</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// curl -X POST http://localhost:3000/batch-create-task</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasksService</span>.<span class="hljs-title function_">createTask</span>();
    }
  }
}
</code></pre>
<p>当执行完成<code>curl</code>后，我们就可以看到任务被顺序调度执行，并且并发数被限制在<code>2</code>以内。当然由于本身任务的执行时间是随机的，因此实际的执行顺序以及任务的状态成功与否都是不确定的。</p>
<pre><code class="hljs language-ini" lang="ini">Lock Assign _lock_key 0 -&gt; 1
Lock Assign _lock_key 1 -&gt; 2
Task task_1762683026625_272 is <span class="hljs-attr">pending</span> =&gt; running.
Task task_1762683026625_164 is <span class="hljs-attr">pending</span> =&gt; running.
Task task_1762683026625_272 is <span class="hljs-attr">running</span> =&gt; success.
Task task_1762683026625_272 cost 534 ms.
Task task_1762683026625_164 is <span class="hljs-attr">running</span> =&gt; success.
Task task_1762683026625_164 cost 1556 ms.
Lock Release _lock_key 2 -&gt; 1
Lock Assign _lock_key 1 -&gt; 2
Task task_1762683026625_300 is <span class="hljs-attr">pending</span> =&gt; running.
Lock Release _lock_key 2 -&gt; 1
Lock Assign _lock_key 1 -&gt; 2
Task task_1762683026625_944 is <span class="hljs-attr">pending</span> =&gt; running.
Task task_1762683026625_300 is <span class="hljs-attr">running</span> =&gt; success.
Task task_1762683026625_300 cost 378 ms.
Task task_1762683026625_944 is <span class="hljs-attr">running</span> =&gt; success.
Task task_1762683026625_944 cost 1852 ms.
Lock Release _lock_key 2 -&gt; 1
Lock Assign _lock_key 1 -&gt; 2
Task task_1762683026625_42 is <span class="hljs-attr">pending</span> =&gt; running.
Lock Release _lock_key 2 -&gt; 1
Lock Assign _lock_key 1 -&gt; 2
Lock Release _lock_key 2 -&gt; 1
Task task_1762683026625_42 is <span class="hljs-attr">running</span> =&gt; success.
Task task_1762683026625_42 cost 1119 ms.
Lock Release _lock_key 1 -&gt; 0
Lock Assign _lock_key 0 -&gt; 1
Lock Assign _lock_key 1 -&gt; 2
Lock Release _lock_key 2 -&gt; 1
Lock Release _lock_key 1 -&gt; 0
</code></pre>
<h3 data-id="heading-4">分布式锁</h3>
<p>实际上关于锁的问题，上述的单进程模式仅需要处理内存，而如果是单机集群模式，即多进程模式可以共享内存或者使用文件系统处理。然而现在常见的都是分布式多实例模式，这种情况下则需要使用<code>Redis</code>等外部存储，因为需要一个集中式的锁管理。</p>
<p>此外，<code>Redis</code>提供了<code>RedLock</code>算法可以实现分布式互斥，也就是阻止并发，因此并不适合我们这里的任务队列场景。还有<code>Redis</code>分布式主从部署的情况下，若是<code>Redis</code>主节点挂掉，从节点晋升为主节点时，可能会导致短暂的任务超限，即同时运行的任务数超过<code>MaxTask</code>。</p>
<p>因此这里我们需要将内存的锁实现替换为<code>Redis</code>的分布式锁实现，对比内存的实现，由于本身<code>Redis</code>支持<code>incr</code>和<code>decr</code>原子操作，但是其不能限制其数据范围，因此我们需要使用<code>LUA</code>脚本来实现分布式锁的功能。下面是并行任务的<code>LUA</code>实现:</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * Redis 自增锁 LUA 脚本
 * - KEYS[1]: 锁的键名
 * - ARGV[1]: 最大任务数 MaxTask
 * <span class="hljs-doctag">@example</span> ioredis.eval(LUA_SCRIPT, 1, LOCK_KEY, MAX_TASK);
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">INCR_LOCK_LUA</span> = <span class="hljs-string">`
  local current = redis.call("GET", KEYS[1])

  if not current then
    current = 0
  else
    current = tonumber(current)
  end

  if current &gt;= tonumber(ARGV[1]) then
    return -1
  end

  local new_count = redis.call("INCR", KEYS[1])
  return new_count
`</span>;

<span class="hljs-comment">/**
 * Redis 自减锁 LUA 脚本
 * - KEYS[1]: 锁的键名
 * <span class="hljs-doctag">@example</span> ioredis.eval(LUA_SCRIPT, 1, LOCK_KEY);
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DESC_LOCK_LUA</span> = <span class="hljs-string">`
  local current = redis.call("GET", KEYS[1])
  
  if not current then
    return 0
  end

  current = tonumber(current)
  if current &lt;= 0 then
    return 0
  end

  local new_count = redis.call("DECR", KEYS[1])
  return new_count
`</span>;
</code></pre>
<h2 data-id="heading-5">优雅停机</h2>
<p>优雅停机的处理要更复杂一些，因为其不能完全依靠框架本身的处理能力，而是需要我们在应用层进行处理。即我们必须要将信号传递到进程中，如果进程没有收到信号的话，那么就无法进行优雅停机的处理，即使是处理好了相关资源的清理，也没有实际效用。</p>
<p>特别的，在分布式部署的情况下我们都是部署在<code>Docker</code>容器中，在这种情况下信号的传递就非常依赖容器本身的配置，以及守护进程的方式。假设停机信号仅发送给主进程而不像是<code>Ctrl+C</code>一样发送给进程组，那么优雅停机就必须要主动将信号传递到子进程中，否则子进程将无法进行停机处理。</p>
<h3 data-id="heading-6">SIGINT</h3>
<p><code>SIGINT</code>信号就是我们主要关注的信号类型，当我们在终端中按下<code>Ctrl+C</code>时，系统会向当前前台进程组发送<code>SIGINT</code>信号，从而触发进程的中断处理。在<code>kill</code>命令中，<code>SIGINT</code>信号的编号为<code>2</code>，因此我们也可以通过<code>kill -2 &lt;pid&gt;</code>或者<code>kill -INT &lt;pid&gt;</code>命令来发送该信号。</p>
<p>在这里我们来实现简单的<code>SIGINT</code>信号处理，需要创建简单的<code>HTTP</code>服务器，然后通过监听<code>process.on("SIGINT")</code>事件来处理信号。当我们执行<code>Ctrl+C</code>时，服务器不会立即关闭，而是会输出等待的提示，接下来等待<code>2s</code>后关闭，然后才会退出进程。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">_, res</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Received Request"</span>, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());
  res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/plain"</span> });
  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"Hello, World!\n"</span>);
});

process.<span class="hljs-title function_">on</span>(<span class="hljs-string">"SIGINT"</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Received SIGINT. Shutting Down Gracefully..."</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(r, <span class="hljs-number">2000</span>));
  server.<span class="hljs-title function_">close</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Server Closed. Exiting Process."</span>);
    process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">0</span>);
  });
});

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-number">3000</span>;
server.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server Running at http://localhost:<span class="hljs-subst">${PORT}</span>/`</span>);
});
</code></pre>
<h3 data-id="heading-7">信号传递</h3>
<p><code>Ctrl+C</code>会给整个前台进程组发送<code>SIGINT</code>信号，但是在业务中可能会仅可能给主进程发送<code>SIGINT</code>信号，这时候子进程就无法收到信号。我们可以来模拟一下这个行为，当使用<code>npx</code>命令时，其并不会将信号转发到其启动的子进程。此外还有个常用的信号是<code>SIGTERM</code>，编号为<code>15</code>。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ps -A -o pid,ppid,comm,args &gt; ps.txt</span>
<span class="hljs-comment"># lsof -i :3000</span>
<span class="hljs-comment"># kill -INT 1234</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"signal.sh PID-PPID $$,<span class="hljs-variable">$PPID</span>"</span>
npx tsx ./src/index.ts
</code></pre>
<p>当使用<code>bash signal.sh</code>启动脚本时，先输出当前进程的<code>PID</code>和以及父进程的<code>PPID</code>。此时由于进程是<code>bash</code>启动的，因此<code>PPID</code>是<code>bash</code>的进程号，接下来使用<code>npx tsx</code>启动<code>NodeJs</code>进程，此时<code>NodeJs</code>进程的父进程就是<code>npx</code>进程，假设输出是下面的<code>id</code>:</p>
<pre><code class="hljs language-bash" lang="bash">signal.sh PID-PPID 66721,59534
59534 51513 /bin/zsh         /bin/zsh -il                 <span class="hljs-comment"># zsh shell</span>
66721 59534 bash             bash signal.sh               <span class="hljs-comment"># bash </span>
66722 66721 npm <span class="hljs-built_in">exec</span> tsx ./s npm <span class="hljs-built_in">exec</span> tsx ./src/index.ts  <span class="hljs-comment"># npx tsx</span>
</code></pre>
<p>此时如果执行<code>kill -INT 66721</code>命令发送到脚本进程，会发现<code>NodeJs</code>进程并没有收到信号，因此无法进行优雅停机处理。通常在这种情况下只能等待一定时间后强制杀死子进程，也就是<code>kill -9 &lt;pid&gt;</code>或者<code>kill -KILL &lt;pid&gt;</code>命令。而如果直接<code>kill -2 66722</code>，则可以正常停机。</p>
<p>我们的假设是信号仅发送到主进程，而此时的主进程就是<code>bash</code>启动命令，无法结束进程就很合理了。这里问题其实就在于我们是使用<code>npx</code>启动的进程，这个命令会启动一个新的进程来执行服务的启动命令，在信号不传递的情况下，子进程是无法收到信号的。</p>
<p>在<code>Bash</code>中，我们可以使用<code>exec</code>命令用于替换当前的<code>Shell</code>进程，而不是创建新的子进程。因此，如果我们在<code>npx</code>命令前使用<code>exec</code>来替换掉当前的<code>bash</code>进程，那么信号就可以直接传递到<code>NodeJs</code>进程中了。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">exec</span> npx tsx ./src/index.ts
</code></pre>
<p>此时的进程关系如下所示，此时的主进程就是<code>67033</code>进程号了，此时直接<code>kill -INT 67033</code>就可以正常收到信号并且进行优雅停机处理了。这里还需要关注一下，我们是直接使用终端执行的命令，所以其本身的进程<code>59534</code>即<code>zsh</code>进程号就是父进程号。</p>
<pre><code class="hljs language-bash" lang="bash">signal.sh PID-PPID 67033,59534
59534 51513 /bin/zsh         /bin/zsh -il
67033 59534 npm <span class="hljs-built_in">exec</span> tsx ./s npm <span class="hljs-built_in">exec</span> tsx ./src/index.ts   
</code></pre>
<p>由于<code>npx</code>会创建子进程来执行命令，因此若是启动服务的命令本身如果也是创建子进程的方式，那么同样会存在信号无法传递的问题。因此在使用<code>pm2</code>等进程管理工具时，也需要注意其启动命令的信号传递问题，那么这种情况下我们可以避免使用<code>npx</code>命令来启动进程，此时服务就作为顶层进程启动了。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> PATH=<span class="hljs-string">"<span class="hljs-variable">$PWD</span>/node_modules/.bin:<span class="hljs-variable">$PATH</span>"</span>
<span class="hljs-built_in">exec</span> tsx ./src/index.ts
</code></pre>
<pre><code class="hljs language-bash" lang="bash">signal.sh PID-PPID 67675,59534
59534 51513 /bin/zsh         /bin/zsh -il
67675 59534 node             node /xxx/node_modules/.bin/../tsx/dist/cli.mjs ./src/index.ts
</code></pre>
<h3 data-id="heading-8">子进程管理</h3>
<p>由于下面需要以<code>PM2</code>在集群模式下实现信号传递，在这里我们就先做一个简单有趣的实验，主要是为了观察子进程执行的情况。通常情况下我们会在部署环境中使用容器内的进程例如<code>systemd</code>来守护进程，并不会使用<code>pm2</code>的守护进程，但是如果直接使用<code>pm2</code>守护，那就需要主动传递信号。</p>
<p>因此在这里我们实现一个简单的父子进程模型，相当于简单地表示一下进程的模型。<code>child.sh</code>是普通的脚本，在这里会直接使用<code>while</code>来保持进程。<code>normal.sh</code>是父进程脚本，使用<code>bash</code>启动<code>child.sh</code>作为子进程。<code>fork.sh</code>也是父进程脚本，但是会使用<code>disown</code>来分离进程。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># child.sh</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">sleep</span> 1
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"child.sh PID-PPID $$,<span class="hljs-variable">$PPID</span>"</span>
<span class="hljs-keyword">done</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># normal.sh</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"normal.sh PID-PPID $$,<span class="hljs-variable">$PPID</span>"</span>
bash child.sh &gt; /dev/tty 2&gt;&amp;1
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># fork.sh</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"fork.sh PID-PPID $$,<span class="hljs-variable">$PPID</span>"</span>
bash child.sh &gt; /dev/tty 2&gt;&amp;1 &amp;
<span class="hljs-built_in">disown</span> -h %1
</code></pre>
<p>当我们分别使用两个终端来启动<code>normal.sh</code>以及<code>fork.sh</code>后，可以观察到<code>normal</code>进程会持有且不会停止，<code>fork</code>进程会结束先前的进程，可以在终端里执行其他命令，类似于将其放置于后台，注意输出重定向到<code>tty</code>终端不会停, 也可以输出到文件。</p>
<pre><code class="hljs language-bash" lang="bash">normal.sh PID-PPID 70263,69842
child.sh PID-PPID 70264,70263
69842 51513 /bin/zsh         /bin/zsh -il
70263 69842 bash             bash normal.sh
70264 70263 bash             bash child.sh
72259 70264 <span class="hljs-built_in">sleep</span>            <span class="hljs-built_in">sleep</span> 1
</code></pre>
<pre><code class="hljs language-bash" lang="bash">fork.sh PID-PPID 70303,69954
child.sh PID-PPID 70304,1
69954 51513 /bin/zsh         /bin/zsh -il
70304     1 bash             bash child.sh
72260 70304 <span class="hljs-built_in">sleep</span>            <span class="hljs-built_in">sleep</span> 1
</code></pre>
<h3 data-id="heading-9">PM2 进程</h3>
<p>在先前的实验中我们已经观察到了信号传递的问题，那么在<code>pm2</code>中同样会存在这个问题。假设我们使用<code>pm2 start</code>来启动进程，这种情况下就是使用<code>fork</code>模式启动的进程，因此信号是无法传递到子进程中的，因为这个进程会立即结束掉。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> PORT=3000
<span class="hljs-built_in">echo</span> <span class="hljs-string">"bootstrap.sh PID-PPID $$,<span class="hljs-variable">$PPID</span>"</span>
npx tsc --project tsconfig.json
<span class="hljs-built_in">export</span> PATH=<span class="hljs-string">"<span class="hljs-variable">$PWD</span>/node_modules/.bin:<span class="hljs-variable">$PATH</span>"</span>
<span class="hljs-built_in">exec</span> pm2 start ./dist/index.js -i 2 --kill-timeout 5000 --log-date-format=<span class="hljs-string">"YYYY-MM-DD HH:mm:ss"</span> --<span class="hljs-built_in">log</span> ./output.log
</code></pre>
<p>此时的进程树关系如下，由于进程会立即结束，此时<code>pm2</code>的主进程的父进程就是<code>1</code>。然后由于是使用的集群模式，因此会启动两个子进程来执行服务，而这两个子进程的父进程就是<code>pm2</code>的主进程，此时我们是没有办法发送<code>SIGINT</code>信号给主进程，自然子进程也无法收到信号。</p>
<pre><code class="hljs language-bash" lang="bash">73353     1 PM2 v6.0.8: God  PM2 v6.0.8: God Daemon (/Users/czy/.pm2) 
73354 73353 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js 
73355 73353 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js 
</code></pre>
<p>在这种情况下，如果需要尝试优雅停机处理，那么就需要主动将信号传递到子进程中。通常来说由于进程结束，我们无法从主进程中得到子进程的<code>PID</code>，因此只能通过<code>pm2</code>提供的命令来获取子进程的<code>PID</code>，或者直接使用<code>ps</code>来匹配<code>PID</code>，然后再发送信号，这种情况下是可以优雅停机的。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">kill</span> -INT $(pgrep pm2)
</code></pre>
<p>因此，我们可以组合上面的脚本来实现信号的传递处理，首先需要避免主进程脚本结束掉，因此需要使用<code>while</code>来保持进程，然后在收到信号时获取子进程的<code>PID</code>并且传递信号。注意这种情况下不能用<code>exec</code>了，需要正常<code>fork</code>出子进程，否则后续<code>while</code>以及<code>trap</code>代码不会执行。</p>
<pre><code class="hljs language-bash" lang="bash">pm2 start ./dist/index.js -i 2 --kill-timeout 5000 --log-date-format=<span class="hljs-string">"YYYY-MM-DD HH:mm:ss"</span> --<span class="hljs-built_in">log</span> ./output.log
<span class="hljs-function"><span class="hljs-title">forward_signal</span></span>() {
    pm2_pid=$(pgrep pm2)
    <span class="hljs-built_in">kill</span> -INT <span class="hljs-variable">$pm2_pid</span>
    <span class="hljs-built_in">exit</span> 0
}
<span class="hljs-built_in">trap</span> forward_signal SIGINT
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">sleep</span> 1
<span class="hljs-keyword">done</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash">bootstrap.sh PID-PPID 76699,73203
76731     1 PM2 v6.0.8: God  PM2 v6.0.8: God Daemon (/Users/czy/.pm2) 
76732 76731 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js 
76733 76731 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js 
73203 51513 /bin/zsh         /bin/zsh -il
76699 73203 bash             bash bootstrap.sh
76895 76699 <span class="hljs-built_in">sleep</span>            <span class="hljs-built_in">sleep</span> 1
</code></pre>
<p>实际上，<code>pm2</code>当前支持了<code>pm2-runtime</code>命令来更好地支持容器化场景下的进程管理，同样的之前叙述的<code>npx</code>命令问题也会出现。从下面的进程树中可以看出来信号传递会比之前多了一层，而执行<code>kill -INT 80795</code>命令时，子进程是无法收到信号的，进程也不会结束。</p>
<pre><code class="hljs language-bash" lang="bash">78367 51513 /bin/zsh         /bin/zsh -il
80795 78367 bash             bash bootstrap.sh
80819 80795 npm <span class="hljs-built_in">exec</span> pm2-run npm <span class="hljs-built_in">exec</span> pm2-runtime start pm2.config.js --<span class="hljs-built_in">env</span> production      
80836 80819 node             node /xxx/.bin/../pm2/bin/pm2-runtime start pm2.config.js --<span class="hljs-built_in">env</span> production
80844 80836 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js     
80845 80836 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js 
</code></pre>
<p>因此这里的实现仍然需要保证使用<code>exec</code>来启动<code>pm2-runtime</code>服务，此外该命令不会启动<code>pm2</code>的守护进程，相关日志会直接输出到当前<code>shell</code>中。而且也是支持集群模式的，下面的例子展示了使用<code>pm2-runtime</code>启动的进程关系树，执行<code>kill -INT 84685</code>可以正常处理信号。</p>
<pre><code class="hljs language-bash" lang="bash">78367 51513 /bin/zsh         /bin/zsh -il
78673 78367 node             node /xxx/.bin/../pm2/bin/pm2-runtime start pm2.config.js --<span class="hljs-built_in">env</span> production
78704 78673 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js     
78705 78673 node /Users/czy/ node /xxx/graceful-shutdown/dist/index.js
</code></pre>
<h3 data-id="heading-10">心跳机制</h3>
<p>在分布式环境下，除了信号传递的问题之外，还有一个问题就是进程本身的存活检测问题。假设某个实例由于某些原因直接退出了，那么此时就无法进行优雅停机处理了，因此我们需要通过心跳机制来检测进程的存活状态，以此来维护服务本身的健壮性。</p>
<p>心跳机制的实现其实非常简单，主要是通过定时向存储位置写入当前的时间戳来表示进程的存活状态。假设我们使用<code>Redis</code>来存储心跳时间戳，那么每个实例可以使用唯一的<code>key</code>来存储自己的心跳时间戳，然后定时更新这个时间戳。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">launchInstance</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">keep</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 更新 Redis 心跳时间戳</span>
    <span class="hljs-built_in">setTimeout</span>(keep, <span class="hljs-variable constant_">LOOP_TIME</span>);
  };
  <span class="hljs-title function_">keep</span>();
  <span class="hljs-comment">// 开机时清理一次过期实例</span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-title function_">clearInactiveInstances</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Active Instance"</span>, res.<span class="hljs-property">active</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Inactive Instance"</span>, res.<span class="hljs-property">inactive</span>);
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">terminateInstance</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 优雅停机时删除当前实例</span>
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearInactiveInstances</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> entries = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable constant_">MEMORY_MAP</span>);
  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">const</span> <span class="hljs-attr">active</span>: string[] = [];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">inactive</span>: string[] = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> entries) {
    <span class="hljs-keyword">if</span> (now - <span class="hljs-title class_">Number</span>(value) &gt; <span class="hljs-variable constant_">ACTIVE_TIME_OUT</span>) {
      <span class="hljs-comment">// 清理过期实例</span>
      inactive.<span class="hljs-title function_">push</span>(key);
      <span class="hljs-keyword">continue</span>;
    }
    active.<span class="hljs-title function_">push</span>(key);
  }
  <span class="hljs-keyword">return</span> { active, inactive };
};
</code></pre>
<p>由于实例本身如果退出了，那么心跳时间戳就不会再更新了，而且守护进程的存在，退出的进程会在一段时间内重启。那么在业务中，例如我们最开始聊的任务队列实现中，我们就可以在实例启动的时获取当前的活跃实例，然后检查正在运行任务的调度实例<code>id</code>是否还在活跃实例中，以此来尝试重新调度任务。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// task</span>
{
  <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">pod_id</span>: <span class="hljs-string">"$instance_id0"</span>,
  <span class="hljs-attr">status</span>: <span class="hljs-string">"running"</span>
}

<span class="hljs-comment">// redis</span>
[
  <span class="hljs-string">"$instance_id0"</span>: <span class="hljs-number">100</span>,
  <span class="hljs-string">"$instance_id1"</span>: <span class="hljs-number">9999999999</span>,
  <span class="hljs-string">"$instance_id2"</span>: <span class="hljs-number">9999999999</span>
]
</code></pre>
<h2 data-id="heading-11">总结</h2>
<p>在文本中我们实现了一个简单的分布式任务队列，并且实现了优雅停机的处理。任务队列主要是通过分布式锁来限制并发数，从而保证任务能够被合理地调度执行，从而实现长任务的异步调度机制，并且实现任务的流量削峰、错误重试等。</p>
<p>优雅停机的处理主要是通过信号传递来实现的，从而保证进程能够在收到停机信号时进行资源的清理和任务的完成，避免任务的中断和数据的不一致问题。此外还叙述了父子进程间的信号传递，以及实现心跳机制来检测实例的存活状态，从而保证分布式环境下的服务健壮性。</p>
<h2 data-id="heading-12">每日一题</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FEveryDay" target="_blank" title="https://github.com/WindRunnerMax/EveryDay" ref="nofollow noopener noreferrer">github.com/WindRunnerM…</a></li>
</ul>
<h2 data-id="heading-13">参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.nestjs.com%2Fmodules" target="_blank" title="https://docs.nestjs.com/modules" ref="nofollow noopener noreferrer">docs.nestjs.com/modules</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpm2.keymetrics.io%2Fdocs%2Fusage%2Fdocker-pm2-nodejs%2F" target="_blank" title="https://pm2.keymetrics.io/docs/usage/docker-pm2-nodejs/" ref="nofollow noopener noreferrer">pm2.keymetrics.io/docs/usage/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpm2.keymetrics.io%2Fdocs%2Fusage%2Fsignals-clean-restart%2F" target="_blank" title="https://pm2.keymetrics.io/docs/usage/signals-clean-restart/" ref="nofollow noopener noreferrer">pm2.keymetrics.io/docs/usage/…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[马斯克开始用Grok替代员工了！最惨部门裁员90%]]></title>    <link>https://juejin.cn/post/7576208176007692340</link>    <guid>https://juejin.cn/post/7576208176007692340</guid>    <pubDate>2025-11-25T06:54:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576208176007692340" data-draft-id="7576245169843765288" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="马斯克开始用Grok替代员工了！最惨部门裁员90%"/> <meta itemprop="keywords" content="Grok,人工智能"/> <meta itemprop="datePublished" content="2025-11-25T06:54:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="量子位"/> <meta itemprop="url" content="https://juejin.cn/user/2858385963484488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            马斯克开始用Grok替代员工了！最惨部门裁员90%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385963484488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    量子位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T06:54:10.000Z" title="Tue Nov 25 2025 06:54:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>马斯克开始用 AI 取代手底下员工了！</p>
<p>这一次，他把刀挥向了 X_（前推特）_——用 Grok 取代 X 员工。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87f6102affb24c49a1d518063873a0f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658450&amp;x-signature=GMy8C7Eke1e6MTBixw5LjuwNQ9E%3D" alt="" loading="lazy"/></p>
<p>据 The Information 消息，上个月有两位知情人士向他们透露，马斯克解雇了 X 公司里负责打击垃圾邮件、影响力行动、非法内容以及其他信任与安全问题的工程团队的一半成员。</p>
<p>这个团队在本轮裁员之前已缩减至不足 20 人，而老马在 2022 年收购推特时，其团队规模曾超过 100 人。</p>
<p>从超 100 人→不足 10 人，足以见得老马裁员的程度有多深、有多狠。</p>
<p>事实上，如果回顾老马 10 月中旬发布的一条推文，那么此次曝出的裁员消息也就不意外了。</p>
<p>当时老马表示，要在未来几周内彻底移除 X 启发式推荐算法，由 Grok 接手，通过阅读和观看全部内容来全自动匹配用户兴趣。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7bdfd9eb91042d6bac910a9a390d5df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658450&amp;x-signature=gBAtoMMhUciD8%2BH6u6wN1vxQNtQ%3D" alt="" loading="lazy"/></p>
<p>连算法都全交给 AI 了，那背后的算法工程师及相关支持者们自然也就面临失业了。</p>
<p>而抛开 X 相关事件不谈，老马布下的棋子其实还很多。比如今年 8 月，硬刚微软成立巨硬（Macrohard），号称要用 AI 把微软产品重做一遍。</p>
<p>一旦把这些事情放到一起看，老马背后的意图就不言自明了——</p>
<blockquote>
<p><strong>用 AI 替代人力，用自动化替代传统工程。</strong></p>
</blockquote>
<p>就是说，大 BOSS 马斯克，现在已经盯上了 AI 这把 “尚方宝剑”。</p>
<h2 data-id="heading-0">引入双胞胎新人执行者</h2>
<p>为了完成用 Grok 改造 X 的目标，马斯克将这把剑交给了 xAI 两位双胞胎新人执行者——</p>
<p>现年 33 岁，来自乌克兰的 <strong>Dima</strong> 和 <strong>Ievgin Soboliev</strong>。</p>
<p>据此前《连线》爆料，自 OpenAI 挖走了 xAI 之前的工程师负责人 Uday Ruddarraju 和 Mike Dalton 之后，这对双胞胎兄弟就成了 xAI 的顶级工程师，并直接向马斯克汇报。</p>
<p><em>（注：x 和 xAI 今年 3 月就正式合并了，不过团队运作仍相对独立）</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20f3075a12d84e7881dc6c36bdaeb02b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658450&amp;x-signature=JKS199vYXBXGZymshL10PlZmb8c%3D" alt="" loading="lazy"/></p>
<p><strong>上图的 Dima</strong>，曾在哈尔科夫国立大学攻读应用数学专业，毕业后去了硅谷工作。</p>
<p>一开始加入了 Facebook（现 Meta），后快速辗转于谷歌、云原生数据库公司 SingleStore、国际跨境电商平台 Joom，以及全球顶级自营量化交易公司 Jump Trading Group。</p>
<p>从 2017 年开始，他又加入机器学习初创公司 Laserlike，后来该公司被苹果收购。</p>
<p>也是通过这次收购，从 2018~2024 年，他在苹果从事与搜索有关的工作。之后又离开苹果加入 OpenAI，但不到一年便离职转投 xAI。</p>
<p><strong>而 Ievgin Soboliev</strong>，也是在哈尔科夫国立大学攻读完应用数学后去了硅谷。</p>
<p>他一开始加入了曾经非常知名的程序化广告技术公司 Rocket Fuel Inc。</p>
<p>后来不知道是不是受到 Dima 影响，去了 Meta 从事广告机器学习工作，之后于 2022 年至 2025 年在苹果工作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dade4377b073421cb814f154ce172d87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658450&amp;x-signature=y2N3EKuscVvaowiG0eUNw%2BDTQ20%3D" alt="" loading="lazy"/></p>
<p>据知情人士透露，今年夏季，两兄弟在大致相同的时间加入了 xAI。他们经常一起工作，同事们也直接称他们为 “那对双胞胎”。</p>
<p>而且兄弟二人在 X 内部一直推行典型的 “马斯克模式”——</p>
<p>要求工程师在办公室长时间工作，包括周末；根除低效率现象；并迅速裁撤他们认为不必要的职位等。</p>
<p>目前尚不清楚 X 还可能裁掉多少工程师。知情人士称，X 至少还有另外 100 名工程师负责不同部分的工作。</p>
<h2 data-id="heading-1">马斯克到底要干啥？</h2>
<p>如开头所言，此次裁员正是马斯克 “用 AI 替代人力，用自动化替代传统工程” 的其中一步。</p>
<p>他曾公开表示，希望让 X 的算法 “完全 AI 化”，并让用户能够通过询问 xAI 的 Grok 聊天机器人来调整他们信息流中显示的内容。</p>
<p>这一手更新，直接让 Grok 从无情的总结机器罗伯特、X 上的维基百科，上位到了 X 的总管。</p>
<p>现在 X 上到处都是 Grok，未来还会有更多 Grok。</p>
<p>与此同时，他还在推进 “巨硬（Macrohard）计划”——<strong>用 AI 自动化软件开发</strong>。他表示：</p>
<blockquote>
<p>Macrohard 是一家纯粹的 AI 软件公司。<br/>
原则上，鉴于微软等软件公司本身不生产任何物理硬件，应该有可能完全用 AI 模拟它们。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/caed80d962ef446f945ee54ae6c18693~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658450&amp;x-signature=biF%2B0BvtyIH0klgfyeAHshmTVH0%3D" alt="" loading="lazy"/></p>
<p>从 Macrohard 商标注册内容来看，我们可以提炼以下几个关键要点：</p>
<ul>
<li>
<p>用于生成人工智能语音和文本的可下载软件</p>
</li>
<li>
<p>用于编写代码、设计和运行视频游戏的人工智能工具</p>
</li>
<li>
<p>图像、视频和语言理解系统</p>
</li>
</ul>
<p>一句话，马斯克这是要用 AI，把微软曾经做过的事情重做一遍。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d740ef98d49e463192cb8b8e33c8757e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658450&amp;x-signature=hY5KLo0SlLiPrvBF5JYUL44Rzdk%3D" alt="" loading="lazy"/></p>
<p>而且据老马自曝，他还把印着 Macrohard 的标语，涂在了 xAI 位于孟菲斯的最大数据中心的屋顶上。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ea971c259934a11b2d55f2eb69aa53f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658450&amp;x-signature=OtxfEuaIQ0xLXHl2mRYLilfbuCA%3D" alt="" loading="lazy"/></p>
<p>显而易见，不论是裁员还是 Macrohard 计划，马斯克都在尽力用 AI 改造他名下的公司。</p>
<p>而这种稍显激进的 AI 至上战略，所带来的风险也不容老马忽视。</p>
<p>最直接的矛盾在于，负责平台安全的团队与生成内容的 AI 系统之间，出现了致命的 “权责不对等”。</p>
<p>团队负责清理违规内容，但对 Grok 会生成什么却毫无控制权，这导致他们相当被动。</p>
<p>而且由于 X 和 xAI 合并后团队各自独立，当安全团队正在清理 Grok 生成的有害内容时，同一公司的 xAI 团队可能正在训练 Grok 变得更具 “创造性”——</p>
<p>这种内部目标的不一致，也容易让安全问题陷入无人负责的真空地带。</p>
<p>此外，马斯克的裁员计划也影响到了一些关键项目。多年来，马斯克一直希望在 X 上推出一项支付服务 “X Money”，但公司未能争取到一些关键州监管机构的支持，导致这一计划受阻。</p>
<p>据悉，金融监管机构的一个重要考量点是，支付公司是否拥有稳定的领导层和足够的员工来支持客户并打击欺诈。</p>
<p>而 X Money 团队，在过去一年中一直面临频繁的人员流动。</p>
<p>总之，马斯克的 AI 改造计划在砍向人力成本的同时，也正在砍伤平台安全的根基、核心业务的未来。</p>
<p>AI 这把剑，其双刃已现。</p>
<h2 data-id="heading-2">One More Thing</h2>
<p>说到裁员，老马今年 9 月还血裁了一波 <strong>xAI 团队</strong>。</p>
<p>xAI 是老马 2023 年创办的 AI 初创企业，旗下主要产品就是 Grok 模型，而 9 月被裁的就是帮忙训练 Grok 模型的数据标注团队。</p>
<p>据非官方统计，当时该团队有超过 500 名员工_（约占数据标注团队的 1/3）_被通知卷铺盖走人。</p>
<p>而裁来裁去，你猜怎么着？留下来的几乎全是华人了。</p>
<p>当时有一张 xAI 团队合影在社交媒体上疯传，原因是照片中几乎全是东亚面孔。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f25900b9134413384034f9c4fbd8f05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658450&amp;x-signature=SYsG4RdidYTc0ngihRI8W5Svzt0%3D" alt="" loading="lazy"/></p>
<p>而就在 Grok 4 发布后不久，一位自称是 “Grok 项目唯一白人参与者” 的员工在 X 上发文：</p>
<blockquote>
<p>今天我被 @X 解雇了，我是唯一一个参与 @grok 项目的白人……</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28ec1b9f724a4699a43944a867d6b82d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764658450&amp;x-signature=S8NLEez3Vi1aPE5hSxDWkLu%2FnAA%3D" alt="" loading="lazy"/></p>
<p>虽然未确认这条推文的真实性，但侧面说明老马可能确实偏爱华人（bushi。</p>
<p>参考链接：<br/>
[1]<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.theinformation.com%2Farticles%2Ftwins-pushing-elon-musks-plans-replace-x-staff-grok" target="_blank" title="https://www.theinformation.com/articles/twins-pushing-elon-musks-plans-replace-x-staff-grok" ref="nofollow noopener noreferrer">www.theinformation.com/articles/tw…</a><br/>
[2]<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzIzNjc1NzUzMw%3D%3D%26mid%3D2247820813%26idx%3D1%26sn%3D09a31d3cb6ee4b280834af773565656f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzIzNjc1NzUzMw==&amp;mid=2247820813&amp;idx=1&amp;sn=09a31d3cb6ee4b280834af773565656f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/0-ShEPVjc…</a><br/>
[3]<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzIzNjc1NzUzMw%3D%3D%26mid%3D2247834533%26idx%3D2%26sn%3D0e35b3df7c0f3b4ac919145f570aabf4%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzIzNjc1NzUzMw==&amp;mid=2247834533&amp;idx=2&amp;sn=0e35b3df7c0f3b4ac919145f570aabf4&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/v8mM_4FnK…</a></p>
<p><strong>欢迎在评论区留下你的想法！</strong></p>
<p>— <strong>完</strong> —</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[技术复盘：Solon-MCP 日志统一配置背后的技术架构分析]]></title>    <link>https://juejin.cn/post/7576057623742119978</link>    <guid>https://juejin.cn/post/7576057623742119978</guid>    <pubDate>2025-11-24T08:18:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576057623742119978" data-draft-id="7575829296452648970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="技术复盘：Solon-MCP 日志统一配置背后的技术架构分析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T08:18:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asthenian"/> <meta itemprop="url" content="https://juejin.cn/user/2685482018803200"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            技术复盘：Solon-MCP 日志统一配置背后的技术架构分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2685482018803200/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asthenian
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:18:37.000Z" title="Mon Nov 24 2025 08:18:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 问题的起因：一次“屏蔽报错”的任务</h3>
<p>故事的开始非常简单。最近在调试项目时，我的 Mentor (MT) 让我去处理一下控制台的日志。</p>
<p>原因是项目引入了 <code>solon-mcp</code> 相关组件，每次建立连接时都会输出一堆 <code>WARN</code> 级别的异常日志。经过排查，这些异常并不影响实际功能的链路，属于框架内部的“噪音”。为了保持控制台清爽，MT 让我把它的日志级别调高，屏蔽掉这些警告。</p>
<p>操作很简单，我熟练地打开 <code>application.yml</code>，加上了一行配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">io.modelcontextprotocol:</span> <span class="hljs-string">ERROR</span> <span class="hljs-comment"># 屏蔽 WARN，只看 ERROR</span>
</code></pre>
<p>重启服务，世界清静了。</p>
<p>任务虽然完成了，但我盯着 <code>application.yml</code> 里的这块配置区域，突然陷入了沉思：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">root:</span> <span class="hljs-string">INFO</span>
    <span class="hljs-attr">com.testjob.sls:</span> <span class="hljs-string">DEBUG</span>          <span class="hljs-comment"># 我们的业务代码</span>
    <span class="hljs-attr">com.xxl.job:</span> <span class="hljs-string">INFO</span>             <span class="hljs-comment"># 第三方任务调度框架</span>
    <span class="hljs-attr">io.modelcontextprotocol:</span> <span class="hljs-string">ERROR</span> <span class="hljs-comment"># 刚刚配置的 MCP 协议库</span>
</code></pre>
<p><strong>我不禁产生了一个疑问：</strong><br/>
为什么？为什么 <code>Solon-MCP</code>、<code>XXL-JOB</code>、<code>Spring</code> 以及我们自己写的业务代码，明明是完全不同团队、不同时间开发的组件，却都能被这同一个 <code>logging</code> 配置项所支配？</p>
<p>是不是在这简单的 YAML 配置背后，隐藏着某种统一的“潜规则”或底层架构设计？</p>
<p>带着这个疑问，我决定深挖一下 Java 日志体系背后的秘密。</p>
<hr/>
<h3 data-id="heading-1">2. 现象观察：万法归一</h3>
<p>在分析依赖树和源码后，我发现这是一个典型的<strong>从混乱到统一</strong>的架构设计案例。</p>
<p>所有的组件，无论内部实现如何，最终都“臣服”于我们的配置文件。这说明在我们的技术栈中，存在一个<strong>统一的日志门面（Logging Facade）</strong> ，它像一个外交官一样，统一管理了所有组件的对外发声渠道。</p>
<hr/>
<h3 data-id="heading-2">3. 技术架构拆解</h3>
<p>通过查阅资料和源码分析，我将这个机制拆解为三个核心层面：</p>
<h4 data-id="heading-3">3.1 第一层：门面模式（Facade Pattern）—— 制定标准</h4>
<p>在代码层面，我发现无论是我们自己写的代码，还是 <code>solon-mcp</code> 的源码，获取 Logger 的方式都惊人的一致：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 大家都使用的是 SLF4J 的接口，而不是具体的 Logback 或 Log4j</span>
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">McpAsyncServer</span> {
    <span class="hljs-comment">// 面向接口编程，而非面向实现</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> Logger logger = LoggerFactory.<span class="hljs-built_in">getLogger</span>(McpAsyncServer.<span class="hljs-keyword">class</span>);
}
</code></pre>
<p>这就是<strong>门面模式</strong>的应用。<strong>SLF4J (Simple Logging Facade for Java)</strong> 就是这个“门面”。</p>
<ul>
<li><strong>对于组件开发者（如 MCP 的作者）</strong> ：我只需要调用 SLF4J 的 API 打印日志，不需要关心使用者到底用的是 Logback 还是 Log4j2。</li>
<li><strong>对于使用者（我们）</strong> ：我们只需要配置 SLF4J 的具体实现，就能控制所有用了 SLF4J 的组件。</li>
</ul>
<h4 data-id="heading-4">3.2 第二层：偷天换日 —— 桥接器（Bridging）</h4>
<p>但是，如果引入的第三方库比较老（比如用了 Log4j 1.x）或者比较特立独行（用了 Java 原生的 JUL）怎么办？它们并没有使用 SLF4J 啊。</p>
<p>这时候，Java 日志生态的**桥接器（Bridging）**就登场了。</p>
<p>在我们的 <code>pom.xml</code> 依赖树中，我发现了这些“间谍”包的存在：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 将 Log4j 的调用拦截下来，转发给 SLF4J --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j-over-slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 将 Java 原生 Logging 拦截下来，转发给 SLF4J --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jul-to-slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>原理总结</strong>：这些桥接器通过同名包替换或拦截的方式，把其他日志框架的 API 调用，“骗”过来转发给 SLF4J。这就实现了“虽然你是不同门派，但最终都走同一个出口”。</p>
<h4 data-id="heading-5">3.3 第三层：自动配置魔法 —— Spring Boot / Solon 的统筹</h4>
<p>最后，为什么 <code>application.yml</code> 能生效？</p>
<p>这是框架（Spring Boot 或 Solon）提供的**自动化配置（Auto Configuration）**能力。以 Spring Boot 为例，启动时会发生以下过程：</p>
<ol>
<li><strong>扫描</strong>：<code>LoggingApplicationListener</code> 扫描 Classpath，发现存在 <code>logback-classic</code> 包。</li>
<li><strong>实例化</strong>：初始化 <code>LogbackLoggingSystem</code>。</li>
<li><strong>加载配置</strong>：读取 <code>application.yml</code> 中的 <code>logging.level.*</code>。</li>
<li><strong>应用</strong>：将这些配置动态设置到 Logback 的上下文中。</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 伪代码演示框架的配置逻辑</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">configure</span>(<span class="hljs-params">LoggingSystem system</span>) {
    <span class="hljs-title class_">String</span> mcpLevel = environment.<span class="hljs-title function_">getProperty</span>(<span class="hljs-string">"logging.level.io.modelcontextprotocol"</span>);
    <span class="hljs-comment">// 最终调用底层 Logback 的 API 设置级别</span>
    system.<span class="hljs-title function_">setLogLevel</span>(<span class="hljs-string">"io.modelcontextprotocol"</span>, <span class="hljs-title class_">LogLevel</span>.<span class="hljs-property">ERROR</span>);
}
</code></pre>
<p>这就是为什么我们改一行配置，就能远程控制深埋在 jar 包里的 <code>solon-mcp</code> 的行为了。</p>
<hr/>
<h3 data-id="heading-6">4. 深度思考：架构设计的魅力</h3>
<p>这次排查让我意识到，一个优秀的架构设计（如 Java 的日志体系）体现了以下原则：</p>
<ol>
<li><strong>依赖倒置原则 (DIP)</strong> ：<br/>
上层应用不应该依赖底层日志实现，二者都应该依赖抽象（SLF4J）。这也是为什么我们能随意切换 Logback 或 Log4j2 而不用改一行代码。</li>
<li><strong>关注点分离 (SoC)</strong> ：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>库开发者</strong>（MCP团队）只关注“我要打印什么信息”。</li>
<li><strong>应用开发者</strong>（我）只关注“我要看什么级别的日志”。</li>
<li><strong>运维人员</strong>只关注“日志存到哪里，保留几天”。<br/>
大家各司其职，通过标准接口解耦。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>微内核架构思想</strong>：<br/>
SLF4J 就像一个微内核，各种适配器和实现就像插件。这种生态兼容性，是 Java 工程化强大的重要原因。</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter：如何更改默认字体]]></title>    <link>https://juejin.cn/post/7575367791273951270</link>    <guid>https://juejin.cn/post/7575367791273951270</guid>    <pubDate>2025-11-24T01:42:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575367791273951270" data-draft-id="7573899782803750958" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter：如何更改默认字体"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-24T01:42:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JarvanMo"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565845704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter：如何更改默认字体
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565845704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JarvanMo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T01:42:27.000Z" title="Mon Nov 24 2025 01:42:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我的项目目前在 Windows 上运行并显示注册页面。这个页面本身有点过时了。最近的趋势是先显示 OAuth 供应商的按钮，因为大多数用户更喜欢它们。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92dc54a305dc49fdb4149d7b11c5823a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764553346&amp;x-signature=3VTJmxYD2gD7rAy%2BuH0F47AJBs8%3D" alt="image.png" loading="lazy"/></p>
<p>但是，对于这篇文章来说，这样没问题。</p>
<p>因为它运行在 Windows 上，所以默认字体是 SegoeUI。在 Android 和 Web 上默认是 Roboto，在 iOS 上默认是 SF Pro。</p>
<p>我们为什么要更改它？实际上我们不必更改。</p>
<p>但我的理由是：</p>
<ul>
<li><strong>在所有平台上使用相同的字体。</strong></li>
<li><strong>不使用默认字体，因为使用默认字体的应用程序看起来很“默认”。</strong></li>
<li><strong>我查看了 Google Fonts 并选择了 Open Sans。</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebf04425a884441aa50a89eb1d6cb7a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764553346&amp;x-signature=2be10J%2B2JMfPEhfg2Vv0CcxwYlk%3D" alt="image.png" loading="lazy"/></p>
<p>它比 Roboto 更透气、更轻盈一些，是继 Roboto 之后第二受欢迎的 Google 字体。但由于 Roboto 是 Android 上的默认字体（并被 Google 广泛使用），我们可以假设 Open Sans 在没有 Google 影响的情况下会是最受欢迎的。</p>
<p>它也比 Apple 专有的 SF Pro 更轻盈、更透气：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21c9a3267eb34e8fb25efc5a94e4ea24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764553346&amp;x-signature=fH8Kf60H8fsiBSd6qbNhUdVLsII%3D" alt="SF Pro" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/343e885196c2405eb64e513264dde2df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764553346&amp;x-signature=L2vki1n0ITS%2BNBNQc%2BWa3vlSt9U%3D" alt="Open Sans" loading="lazy"/></p>
<p>那么，如何用 Open Sans 替换默认字体呢？</p>
<p>我所知道的：</p>
<ul>
<li>下载字体并解压。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2e6ed538a674b5985aec0982b54bb39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764553346&amp;x-signature=UA%2BiP34fS1bL%2FIq%2BHvxjBoDRl30%3D" alt="image.png" loading="lazy"/></p>
<p><strong>有两种</strong>可变字体（Variable Fonts）：<strong>常规</strong>（regular）和<strong>斜体</strong>（italic）。<strong>可变</strong>意味着它的<strong>宽度</strong>和<strong>字重</strong>（weight）可以被代码<strong>动态地</strong>改变：</p>
<pre><code class="hljs language-dart" lang="dart">TextStyle(  
fontFamily: <span class="hljs-string">'OpenSans'</span>,  
fontVariations: [  
FontVariation(<span class="hljs-string">'wdth'</span>, <span class="hljs-number">77</span>),  
FontVariation(<span class="hljs-string">'wght'</span>, <span class="hljs-number">477</span>),  
]);
</code></pre>
<p>还有一个 <code>static</code> 文件夹，里面是静态字体。可变字体文件是 500 KB，而静态字体只有 130 KB。如果你最终只使用一个变体，例如 Open Sans Medium，你可以节省一些空间。不过，我不会为此费心。</p>
<ul>
<li>
<ol start="2">
<li>将其放入 <code>assets</code> 文件夹。</li>
</ol>
</li>
</ul>
<p>我拿了一个常规可变字体并重新命名了它。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc773603360e44dc8874592271c883fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764553346&amp;x-signature=8NIcWfwktJMTLYT%2B6%2BxD0v5uqfQ%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>剩下的字体是用于实验的；我不打算在同一个应用中使用所有这些字体。😎</p>
</blockquote>
<ul>
<li>
<ol start="3">
<li>在 <code>pubspec.yaml</code> 中指定字体。</li>
</ol>
</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">flutter:</span>
  <span class="hljs-attr">uses-material-design:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">assets:</span> 
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/images/</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/images/background/</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/audio/</span>
  <span class="hljs-attr">fonts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">family:</span> <span class="hljs-string">OpenSans</span>
      <span class="hljs-attr">fonts:</span> 
        <span class="hljs-bullet">-</span> <span class="hljs-attr">asset:</span> <span class="hljs-string">assets/fonts/OpenSans.ttf</span>
</code></pre>
<p>我知道如何用 <code>TextStyle</code> 为 <code>Text</code> 组件设置 <code>fontFamily</code>。但我想<strong>全局</strong>设置它。</p>
<p>原来，这可以通过** <code>ThemeData</code> **来实现，真是个惊喜：</p>
<pre><code class="hljs language-dart" lang="dart"> <span class="hljs-keyword">static</span> ThemeData getTheme(
    ColorScheme colorScheme,
    Brightness brightness,
  ) {
    <span class="hljs-keyword">return</span> ThemeData(
      brightness: brightness,
      colorScheme: colorScheme,
      fontFamily: <span class="hljs-string">'OpenSans'</span>,    <span class="hljs-comment">//&lt;-here</span>
      appBarTheme: AppBarTheme(
...
</code></pre>
<p>上面是我的方法，它为应用创建了 <code>ThemeData</code> 对象。修复很简单——只需添加 <code>fontFamily</code> 属性。但如果这么简单，我就不会写这篇文章了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d40f71e2729485187edd7dcda5b5055~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764553346&amp;x-signature=GdDo6kSbGzTQrrenCdq1%2FW5bsiE%3D" alt="image.png" loading="lazy"/></p>
<p>如你所见（你可能看不到 😀），只有 <code>Text</code> 和 <code>TextFields</code> 组件中的字体发生了变化。（提示：看看字母 <code>g</code>）。但 <code>AppBar</code> 标题和按钮仍然使用默认字体。</p>
<p>首先，我得说这很令人失望。如果这种设置整个 <code>ThemeData</code> 字体的方式对整个 <code>ThemeData</code> 不起作用，那设置它的意义何在？</p>
<p>或许我做错了什么？可能吧，因为我是第一次做。请帮忙。</p>
<p>好吧，我咨询了 Claude，这位又大又漂亮的 LLM 建议：</p>
<pre><code class="hljs language-dart" lang="dart">textTheme: Typography.englishLike2021
          .copyWith(
            bodyMedium: <span class="hljs-keyword">const</span> TextStyle(fontSize: <span class="hljs-number">16</span>),
            bodySmall: <span class="hljs-keyword">const</span> TextStyle(fontSize: <span class="hljs-number">15</span>),
            headlineMedium: TextStyle(color: colorScheme.primary),
            labelLarge: <span class="hljs-keyword">const</span> TextStyle(fontSize: <span class="hljs-number">15</span>),
            labelMedium: <span class="hljs-keyword">const</span> TextStyle(fontSize: <span class="hljs-number">14</span>),
            bodyLarge: TextStyle(
              fontSize: <span class="hljs-number">17</span>,
              color: colorScheme.onSurface,
            ),
          )
          .apply(  <span class="hljs-comment">//&lt;-this</span>
            fontFamily: <span class="hljs-string">'OpenSans'</span>,
          ),
</code></pre>
<p>添加 <code>apply(fontFamily: 'OpenSans',)</code> 到 <code>textTheme</code> 中。没用。按钮和 <code>AppBar</code> 仍然使用默认字体。这个方法实际上是有效的；它可以用来替代设置 <code>ThemeData</code> 的 <code>fontFamily</code> 属性。但它的作用方式是同样的局限。</p>
<p>下一个建议（这次奏效了）是分别在 <code>AppBarTheme</code> 和每个按钮的主题中指定 <code>fontFamily</code>。</p>
<pre><code class="hljs language-dart" lang="dart"> appBarTheme: AppBarTheme(
        foregroundColor: colorScheme.primary,
        elevation: <span class="hljs-number">0</span>,
        scrolledUnderElevation: <span class="hljs-number">2</span>,
        centerTitle: <span class="hljs-keyword">true</span>,
        titleTextStyle: TextStyle(
          fontSize: <span class="hljs-number">17</span>,
          fontWeight: FontWeight.w600,
          color: colorScheme.onSurface,
          fontFamily: <span class="hljs-string">'OpenSans'</span>,   <span class="hljs-comment">//&lt;-here</span>
        ),
      ),
</code></pre>
<p>我使用了所有的 Material 按钮（Elevated、Filled、Outlined 和 Text），所以我需要为它们每一个修改以下内容：</p>
<pre><code class="hljs language-dart" lang="dart"> textStyle: WidgetStateProperty.resolveWith&lt;TextStyle?&gt;(
        (states) {
          <span class="hljs-keyword">if</span> (states.contains(WidgetState.hovered)) {
            <span class="hljs-keyword">return</span> TextStyle(
              fontSize: <span class="hljs-number">16</span>,
             <span class="hljs-comment">// fontWeight: FontWeight.w800,</span>
              fontFamily: <span class="hljs-string">'OpenSans'</span>,  <span class="hljs-comment">//&lt;-here</span>
              fontVariations: [
                      FontVariation(<span class="hljs-string">'wght'</span>, <span class="hljs-number">800</span>),
                    ]
            );
          }
          <span class="hljs-keyword">return</span> TextStyle(
            fontSize: <span class="hljs-number">17</span>,
           <span class="hljs-comment">// fontWeight: FontWeight.w600,</span>
            fontFamily: <span class="hljs-string">'OpenSans'</span>,    <span class="hljs-comment">//&lt;-and here</span>
            fontVariations: [
                      FontVariation(<span class="hljs-string">'wght'</span>, <span class="hljs-number">600</span>),
                    ]
          );
        },
      ),
</code></pre>
<p><code>fontWeight</code> 属性不适用于 Open Sans；我们应该改用 <code>fontVariations</code>。</p>
<p>然后瞧（终于 😴），Open Sans 无处不在：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7a1a713b2c04fcca5362aa2c8cd04cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764553346&amp;x-signature=AKrVPuk6Jpcqtp7WxIEi4BkM3bc%3D" alt="image.png" loading="lazy"/></p>
<p>我已经觉得这篇文章值得写了，但无论如何……</p>
<p><strong>奖励 1</strong></p>
<p>让文本字段的标签使用等宽字体（monospace）。</p>
<p><strong>奖励 2</strong></p>
<p>对标题使用另一种（更有趣的）字体。</p>
<p>将字体添加到 <code>assets</code>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f195c931771d4043bd20c520b08d6819~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764553346&amp;x-signature=v0jDJiARawjyt%2FYtrmgnxmIFwhA%3D" alt="image.png" loading="lazy"/></p>
<p>(这两种字体都是和 Open Sans 一起从 Google Fonts 下载的)。</p>
<p>顺便说一下，VS Code 有一个非常有用的扩展叫 <code>Font Preview</code>。</p>
<ol start="2">
<li>将字体添加到 <code>pubspec.yaml</code>：</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">flutter:</span>
  <span class="hljs-attr">uses-material-design:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">assets:</span> 
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/images/</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/images/background/</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/audio/</span>
  <span class="hljs-attr">fonts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">family:</span> <span class="hljs-string">OpenSans</span>
      <span class="hljs-attr">fonts:</span> 
        <span class="hljs-bullet">-</span> <span class="hljs-attr">asset:</span> <span class="hljs-string">assets/fonts/OpenSans.ttf</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">family:</span> <span class="hljs-string">KodeMono</span>
      <span class="hljs-attr">fonts:</span> 
        <span class="hljs-bullet">-</span> <span class="hljs-attr">asset:</span> <span class="hljs-string">assets/fonts/KodeMono.ttf</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">family:</span> <span class="hljs-string">StardosStencil</span>
      <span class="hljs-attr">fonts:</span> 
        <span class="hljs-bullet">-</span> <span class="hljs-attr">asset:</span> <span class="hljs-string">assets/fonts/StardosStencil.ttf</span>  
</code></pre>
<ol start="3">
<li>最后，修改 <code>textTheme</code>：</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"> textTheme: Typography.englishLike2021
          .copyWith(
            bodyMedium: <span class="hljs-keyword">const</span> TextStyle(fontSize: <span class="hljs-number">15</span>),
            bodySmall: <span class="hljs-keyword">const</span> TextStyle(fontSize: <span class="hljs-number">14</span>),
            headlineMedium: TextStyle(
              color: colorScheme.primary,
              fontFamily: <span class="hljs-string">'StardosStencil'</span>,   <span class="hljs-comment">//&lt;-here</span>
              fontSize: <span class="hljs-number">25</span>,
            ),
            labelLarge: <span class="hljs-keyword">const</span> TextStyle(fontSize: <span class="hljs-number">15</span>),
            labelMedium: <span class="hljs-keyword">const</span> TextStyle(fontSize: <span class="hljs-number">14</span>),
            bodyLarge: TextStyle(
              fontSize: <span class="hljs-number">16</span>,
              color: colorScheme.onSurface,
              fontFamily: <span class="hljs-string">'KodeMono'</span>,        <span class="hljs-comment">//&lt;-and here</span>
            ),
          )
          <span class="hljs-comment">// .apply(</span>
          <span class="hljs-comment">//   fontFamily: 'OpenSans',</span>
          <span class="hljs-comment">// )</span>
          ,
</code></pre>
<p>👉（别忘了移除 <code>apply</code> 方法，它会覆盖所有指定的字体。）</p>
<p>这是我的注册页面，有一个有趣的标题和等宽的文本字段标签：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33c93b77d347490e8211f992da0292e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764553346&amp;x-signature=dx7wJ6XLST6bZ9Jrv3207Htf8KM%3D" alt="image.png" loading="lazy"/>
顺便说一句，我的显示“Create Account”文本的 <code>Text</code> 组件看起来像：</p>
<pre><code class="hljs language-dart" lang="dart">       Text(
            <span class="hljs-string">'Create Accountg'</span>,
            style: Get.textTheme.headlineMedium,                       
          ),
</code></pre>
<p>所以，我们明确地使用了 <code>textTheme</code> 中的 <code>headlineMedium</code> 样式。</p>
<p>关于文本字段标签，情况有所不同：</p>
<pre><code class="hljs language-dart" lang="dart">TextField(
            controller: _emailController,
            decoration: InputDecoration(
              labelText: <span class="hljs-string">'Emailg'</span>,
              prefixIcon: Icon(
                Icons.email_outlined,
              ),
            ),
          ),
</code></pre>
<p>正如我们所见，<code>labelStyle</code> 没有定义。<code>TextField</code> 隐式地使用 <code>textTheme</code> 中的 <code>bodyLarge</code> <code>TextStyle</code> 对象作为其标签。</p>
<p>我一直以为 GetX 会在内部的某个地方缓存 <code>ThemeData</code>，并且所有的 <code>Get.theme</code>、<code>Get.textTheme</code> 之类的调用都不会以 <code>Theme.of(context)</code> 查找结束。运气不好。</p>
<p>这是 GetX 内部的 <code>theme</code> getter 实现:</p>
<pre><code class="hljs language-dart" lang="dart"> ThemeData <span class="hljs-keyword">get</span> theme {
    <span class="hljs-keyword">var</span> theme = ThemeData.fallback();
    <span class="hljs-keyword">if</span> (context != <span class="hljs-keyword">null</span>) {
      theme = Theme.of(context!);
    }
    <span class="hljs-keyword">return</span> theme;
  }
</code></pre>
<p>只是要意识到（如果您使用 GetX）。</p>
<blockquote>
<p>那些 <code>.of(context)</code> 查找可能会对性能造成负担，最好在 <code>build</code> 方法的顶部缓存 <code>ThemeData</code> 对象。</p>
</blockquote>
<p>就是这样。</p>
<p>感谢您的阅读。</p>
<p>如果您学到了新东西，您就欠我鼓掌。开玩笑 😀。半开玩笑 😉。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《前端项目技术文档生成器》Prompt（可复用模板）]]></title>    <link>https://juejin.cn/post/7576218673049452595</link>    <guid>https://juejin.cn/post/7576218673049452595</guid>    <pubDate>2025-11-25T05:46:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576218673049452595" data-draft-id="7576197876717600806" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《前端项目技术文档生成器》Prompt（可复用模板）"/> <meta itemprop="keywords" content="前端,LLM,Visual Studio Code"/> <meta itemprop="datePublished" content="2025-11-25T05:46:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mwq30123"/> <meta itemprop="url" content="https://juejin.cn/user/3403743729030686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《前端项目技术文档生成器》Prompt（可复用模板）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743729030686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mwq30123
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T05:46:40.000Z" title="Tue Nov 25 2025 05:46:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>下面提供你一份 <strong>专门为前端项目优化的《技术文档自动生成 Prompt 模板》</strong> ，适用于：</p>
<ul>
<li>React / Vue / Angular / Svelte / Next.js / Nuxt / Vite / Webpack</li>
<li>单页应用（SPA）、组件库、管理后台、大型前端工程</li>
<li>任意 JS/TS 前端项目结构</li>
</ul>
<p>这是你可以 <strong>长期复用</strong> 的版本。</p>
<hr/>
<h2 data-id="heading-0">✅ <strong>《前端项目技术文档生成器》Prompt（可复用模板）</strong></h2>
<blockquote>
<p><strong>只需上传你的前端项目代码，然后贴入下面这段 Prompt，就能自动生成一整套专业文档。</strong></p>
</blockquote>
<hr/>
<p>你现在扮演一名「前端架构师 + 工程化专家 + 技术文档工程师」。<br/>
我将提供你一个前端项目（Vue/React/Angular/Next/其他）。<br/>
请基于我提供的代码，自动生成可用于入职培训和项目交接的技术文档。</p>
<p>请严格按以下结构输出（每一部分都必须生成）：</p>
<p>====================================</p>
<h2 data-id="heading-1">1. 项目概述（Project Overview）</h2>
<ul>
<li>项目功能、用途、业务定位</li>
<li>前端技术栈（框架、语言、主要依赖）</li>
<li>基础工程化工具（Vite/Webpack、ESLint、Prettier、TS 等）</li>
<li>项目亮点和架构意图</li>
</ul>
<p>===========================================</p>
<h2 data-id="heading-2">2. 项目目录结构（Project Structure）</h2>
<p>请扫描我提供的代码，生成一个简洁但完整的前端目录树（建议 2-3 层），并解释：</p>
<p>对每个目录请输出：</p>
<ul>
<li>该目录作用</li>
<li>是否为核心业务目录 / 公用组件目录 / 工具模块 / 配置目录</li>
</ul>
<p>重点关注前端常见结构：</p>
<ul>
<li>src/</li>
<li>pages/ 或 views/</li>
<li>components/</li>
<li>hooks/ composables/</li>
<li>store/（Pinia、Redux、MobX、Zustand）</li>
<li>router/</li>
<li>assets/</li>
<li>utils/</li>
<li>api/</li>
<li>types/</li>
<li>public/</li>
</ul>
<p>=======================================</p>
<h2 data-id="heading-3">3. 核心模块分析（Core Modules）</h2>
<p>对前端项目中的关键模块进行详细说明：</p>
<ul>
<li>页面 / 路由模块</li>
<li>状态管理（Vuex / Pinia / Redux / Zustand）</li>
<li>API 请求封装模块</li>
<li>公用组件库</li>
<li>工具库（utils）</li>
<li>权限模块（ACL / Router Guards）</li>
<li>配置模块（config）</li>
<li>国际化模块（i18n，如存在）</li>
<li>构建配置（vite.config.js / webpack.config.js）</li>
</ul>
<p>每个模块需包含：</p>
<ul>
<li>职责</li>
<li>内部核心文件</li>
<li>核心逻辑</li>
<li>模块之间的依赖关系</li>
</ul>
<p>==========================================</p>
<h2 data-id="heading-4">4. 关键代码深度解析（Important Code Insight）</h2>
<p>请自动识别「关键文件」并深入讲解，包括：</p>
<p>对每个关键文件分析：</p>
<ul>
<li>文件职责</li>
<li>关键函数 / 组件</li>
<li>组件的 Props / emits / 状态</li>
<li>生命周期或钩子逻辑</li>
<li>与其他模块的交互</li>
<li>异常情况处理</li>
</ul>
<p>可包含（如存在）：</p>
<ul>
<li>main.ts / main.js</li>
<li>App.vue / App.tsx</li>
<li>router/index.ts</li>
<li>store/index.ts</li>
<li>api/index.ts</li>
<li>layout 相关文件</li>
</ul>
<p>=======================================</p>
<h2 data-id="heading-5">5. 前端架构设计（Architecture）</h2>
<p>生成基于代码的前端架构说明：</p>
<ul>
<li>分层结构（组件层 / 页面层 / 服务层 / 状态层）</li>
<li>数据流动方式（自上而下的 props、事件、全局 store、API）</li>
<li>组件通信方式</li>
<li>状态同步模型（如 Redux flow / Vue reactivity flow）</li>
<li>可视化架构图（推荐用 Mermaid）</li>
</ul>
<p>示例（AI 可根据实际项目生成）：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Page --&gt; Component
    Component --&gt; API
    API --&gt; Store
    Store --&gt; Page
</code></pre>
<p>==================================</p>
<h2 data-id="heading-6">6. 应用运行流程（Runtime Flow）</h2>
<p>请解释整个前端应用从启动到渲染的完整流程：</p>
<ul>
<li>如何初始化应用（入口文件 main.ts）</li>
<li>路由加载流程</li>
<li>Store 初始化流程</li>
<li>API 初始化（如 Axios 拦截器）</li>
<li>页面渲染顺序</li>
<li>数据加载流程（从页面 → 服务 → API）</li>
<li>用户权限验证流程（如存在）</li>
</ul>
<p>如可行请生成：</p>
<ul>
<li>请求流程时序图</li>
<li>登录流程图</li>
<li>页面渲染流程图</li>
</ul>
<p>=============================</p>
<h2 data-id="heading-7">7. 工程化配置分析（Build &amp; Tooling）</h2>
<p>解释工程化相关内容：</p>
<ul>
<li>打包工具（Vite / Webpack）</li>
<li>插件（如自动导入、压缩、代码分割、路由自动生成）</li>
<li>TypeScript 配置</li>
<li>Lint 工具（ESLint、Stylelint）</li>
<li>Prettier 格式化</li>
<li>Husky / lint-staged（如存在）</li>
<li>环境变量机制（.env 文件说明）</li>
</ul>
<p>==============================</p>
<h2 data-id="heading-8">8. 启动 &amp; 开发指南（Run &amp; Development Guide）</h2>
<p>根据代码自动生成项目启动与开发说明：</p>
<h3 data-id="heading-9">开发：</h3>
<ul>
<li>安装依赖</li>
<li>运行开发环境</li>
<li>打包生产环境</li>
<li>调试建议</li>
<li>热更新机制讲解</li>
</ul>
<h3 data-id="heading-10">常见问题：</h3>
<ul>
<li>依赖报错的原因与解决</li>
<li>TS 报错解决方式</li>
<li>打包失败的常见原因</li>
<li>浏览器 CORS 问题（如存在）</li>
</ul>
<p>======================================</p>
<h2 data-id="heading-11">9. 新人快速上手指南（Onboarding Guide）</h2>
<p>为新加入的前端开发者生成：</p>
<ul>
<li>先看哪些文件？</li>
<li>如何运行项目？</li>
<li>如何调试一个页面？</li>
<li>如何新增一个页面？</li>
<li>如何新增 API？</li>
<li>组件开发规范</li>
<li>提交规范（如存在：commitlint）</li>
</ul>
<p>=======================================</p>
<h2 data-id="heading-12">10. 技术债 &amp; 改进建议（Technical Debt &amp; Improvements）</h2>
<p>基于代码自动分析：</p>
<ul>
<li>代码可读性问题</li>
<li>重复逻辑</li>
<li>组件过度耦合</li>
<li>状态冗余</li>
<li>API 封装改进建议</li>
<li>可工程化的提升点</li>
<li>文档缺失点</li>
</ul>
<p>========================================</p>
<p>输出要求：</p>
<ul>
<li>使用 Markdown</li>
<li>清晰分区、分标题</li>
<li>内容必须基于实际代码，不猜测未出现内容</li>
<li>若项目缺少信息，请明确标注“代码不足以判断”</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[UI小姐姐要求有“Duang~Duang”的效果怎么办？]]></title>    <link>https://juejin.cn/post/7576264484688379944</link>    <guid>https://juejin.cn/post/7576264484688379944</guid>    <pubDate>2025-11-25T05:51:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576264484688379944" data-draft-id="7573950036897087528" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="UI小姐姐要求有“Duang~Duang”的效果怎么办？"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-25T05:51:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端九哥"/> <meta itemprop="url" content="https://juejin.cn/user/3659622444970574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            UI小姐姐要求有“Duang~Duang”的效果怎么办？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3659622444970574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端九哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T05:51:59.000Z" title="Tue Nov 25 2025 05:51:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9456ab9014694573909de2733acc5b69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Lmd5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764654719&amp;x-signature=w4sPNHGfhJ%2Bv0Xhu3jDr%2BmOaPz0%3D" alt="test.gif" loading="lazy"/></p>
<blockquote>
<p><strong>设计小姐姐</strong>：  “搞一下这样的<strong>回弹</strong>效果，你行不行？”<br/>
<strong>我</strong>：“行！直接梭哈 50 行 keyframes + transform + 各种百分比，搞定 ”<br/>
<strong>设计小姐姐</strong>：“太硬（撇嘴），不够 Q 弹（鄙视）”<br/>
<strong>我</strong>：(裂开)<br/>
<strong>隔壁老王</strong>：这么简单你都不行，我来一行贝塞尔 cubic-bezier(0.3, 1.15, 0.33, 1.57) 秒了😎<br/>
<strong>设计小姐姐</strong>：哇哦！（兴奋）好帅！（星星眼🌟）好Q弹！（一脸崇拜😍）<br/>
<strong>我</strong>：<strong>“？？？”</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">🧠 一、为什么一行贝塞尔就能“Duang”起来？</h2>
<h3 data-id="heading-1">1️⃣ cubic-bezier 是什么？</h3>
<p>在 CSS 动画里，我们经常写：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.5s</span> ease;
</code></pre>
<p>但其实 <code>ease</code>、<code>linear</code>、<code>ease-in-out</code> 这些都只是封装好的贝塞尔曲线。<br/>
底层原理是：</p>
<pre><code class="hljs language-css" lang="css">cubic-bezier(x1, y1, x2, y2)
</code></pre>
<p>这四个参数定义了<strong>时间函数曲线</strong>，控制动画速度的变化。</p>
<ul>
<li><code>x</code>：时间轴（必须在 0～1 之间）</li>
<li><code>y</code>：数值轴（可以超出 0～1！）</li>
</ul>
<p>👉 当 y 超过 1 或小于 0 时，动画值就会<strong>冲过终点再回弹</strong>，<br/>
这就是“回弹感”的核心。</p>
<hr/>
<h3 data-id="heading-2">2️⃣ 回弹的本质：过冲 + 衰减</h3>
<p>想象一个球掉下来：</p>
<ul>
<li><strong>过冲</strong>：球落地时会压扁（超出终点）</li>
<li><strong>回弹</strong>：然后反弹回来，再逐渐稳定</li>
</ul>
<p>在动画中，这个“过冲”就是 y&gt;1 的部分，<br/>
而“回弹”就是曲线回到 y=1 的过程。</p>
<hr/>
<h2 data-id="heading-3">🧪 二、一行贝塞尔的魔法</h2>
<h3 data-id="heading-4">✅ 火箭发射</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d945616e56f74171afda7e6b38b97c8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Lmd5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764654719&amp;x-signature=lUyE6LGLXrjzlCGpwDn2f6gf%2F8M%3D" alt="export_1764044056566.gif" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bounce"</span>&gt;</span>🚀发射！<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.bounce</span> {
 <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.8s</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.68</span>, -<span class="hljs-number">0.55</span>, <span class="hljs-number">0.27</span>, <span class="hljs-number">1.55</span>);
}
<span class="hljs-selector-class">.bounce</span><span class="hljs-selector-pseudo">:hover</span> {
 <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">500px</span>);
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><span href="https://code.juejin.cn/pen/7576535022065647654" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7576535022065647654" data-src="https://code.juejin.cn/pen/7576535022065647654" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span>
💡 <strong>参数解析：</strong></p>
<ul>
<li>y1 = -0.55 → 先轻微反向缩小</li>
<li>y2 = 1.55 → 再冲过头 55%，最后回弹到原位</li>
</ul>
<h2 data-id="heading-5">🧩 四、常用贝塞尔参数</h2>



































<table><thead><tr><th>效果描述</th><th>贝塞尔参数</th><th>备注</th></tr></thead><tbody><tr><td>微回弹（按钮）</td><td><code>cubic-bezier(0.34, 1.31, 0.7, 1)</code></td><td>轻柔弹性</td></tr><tr><td>强回弹（卡片）</td><td><code>cubic-bezier(0.68, -0.55, 0.27, 1.55)</code></td><td>爆发力强</td></tr><tr><td>柔和出入</td><td><code>cubic-bezier(0.4, 0, 0.2, 1.4)</code></td><td>iOS 风</td></tr><tr><td>弹性放大</td><td><code>cubic-bezier(0.175, 0.885, 0.32, 1.275)</code></td><td>弹簧感</td></tr><tr><td>火箭猛冲</td><td><code>cubic-bezier(0.68, -0.55, 0.27, 1.55)</code></td><td>推背感</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-6">🧰 五、调试神器推荐</h2>
<ul>
<li>
<p>🎨 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcubic-bezier.com" target="_blank" title="https://cubic-bezier.com" ref="nofollow noopener noreferrer">cubic-bezier.com</a><br/>
拖动手柄实时预览动画，复制参数一键搞定。</p>
</li>
<li>
<p>⚙️ <a href="https://link.juejin.cn?target=https%3A%2F%2Feasings.net" target="_blank" title="https://easings.net" ref="nofollow noopener noreferrer">easings.net</a><br/>
收录各种 easing 函数（含物理弹簧、阻尼等）。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GitHub 上狂揽 1 万 Star，这个国产 AI 应用开发平台太厉害了]]></title>    <link>https://juejin.cn/post/7576378563574775823</link>    <guid>https://juejin.cn/post/7576378563574775823</guid>    <pubDate>2025-11-25T06:01:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576378563574775823" data-draft-id="7576208176007233588" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GitHub 上狂揽 1 万 Star，这个国产 AI 应用开发平台太厉害了"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-25T06:01:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GitHub 上狂揽 1 万 Star，这个国产 AI 应用开发平台太厉害了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T06:01:41.000Z" title="Tue Nov 25 2025 06:01:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>逛 GitHub 的时候，发现了一个叫 BISHENG <strong>的国产 AI 开源项目。</strong></p>
<p>这是一款主要面向企业的开源 AgentOps。</p>
<p>名字取自活字印刷术的发明者：<strong>毕昇。</strong> 活字印刷术为人类知识的传递起到了巨大的推动作用。BISHENG 团队的愿景是希望为智能应用的广泛落地提供有力支撑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/823ee124b8064c06953ea343da14148e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764655301&amp;x-signature=%2Btc3g69%2BdE8q2QRbhLBYFkK7zA0%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">01、开源项目简介</h2>
<p>BISHENG 已经在 GitHub 上斩获 10K 的 Star 了。</p>
<p>Readme 第一句话就能看到开发者对项目的打磨：源自中国匠心，希望我们能像 [Deepseek]、[黑神话：悟空] 团队一样，给世界带来更多美好。</p>
<p>它已被大量行业领先组织及财富 500 强企业采用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e68902288f04c778d8f703c88a94f88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764655301&amp;x-signature=AzuhEyK0qJD%2Fk%2BGxwx8DTu8k57I%3D" alt="图片" loading="lazy"/></p>
<p>这个项目像是一个企业级的 <strong>LLM DevOps 平台</strong>。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/dataelement/bisheng</span>
</code></pre>
<p>整合了 GenAI 工作流、RAG、Agent、统一模型管理、评估、SFT、数据集管理、企业级系统管理、可观测性等核心能力。</p>
<p>和很多开源的 AI 智能体平台相比，BISHENG 在两个最棘手的问题上解决的更好：<strong>复杂业务逻辑怎么编排 和 非结构化数据怎么处理。</strong></p>
<p><strong>① 独具特色的 Workflow</strong></p>
<p>BISHENG 提供了一套<strong>可视化图编排系统</strong>，允许开发者像画流程图一样设计应用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05deb5aaa85a4564860f9db1e67ce273~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764655301&amp;x-signature=k%2FAS1WiBYhcaoBO%2Bg%2B%2BuqxBLlUg%3D" alt="图片" loading="lazy"/></p>
<p>它支持循环（Loop）、条件分支（If-Else）以及并行处理。更重要的是，它支持 <strong>Human-in-the-loop（人机介入）</strong> ，比如模型生成了一个草稿，流程可以暂停，等待人工审核修改后，再继续后续步骤。</p>
<p>这种设计让它真正具备了处理严肃业务的能力。</p>
<p>而且 BISHENG 的 Workflow 的理念是尽可能用最少的组件类完成最多种类的应用，这才是低代码最核心的价值，并非一味追求更多组件。</p>
<p><strong>② 高精度文档解析</strong></p>
<p>BISHENG 内置了团队打磨多年的<strong>商业级文档解析模型</strong>，这在开源界非常少见。</p>
<p>它不仅能精准识别常规文档，对于财务报表中的复杂表格、合同上的红章、甚至潦草的手写体都有极高的识别率，大幅提升了知识库的质量。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9b53c001d444f9cb875fc6bf226aa41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764655301&amp;x-signature=qg8j5iGH1E2x156wTQQOtrFHl6w%3D" alt="图片" loading="lazy"/></p>
<p>③ 专家级品味的通用 Agent</p>
<p>BISHENG 还有一个叫做 <strong>灵思 的 Agent 助手。关于</strong> <strong>灵思的思考，非常推荐看一下 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkyMTM3NzQ2Nw%3D%3D%26mid%3D2247484289%26idx%3D1%26sn%3D3c9ba12e2165a457d6521697e7dacd39%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkyMTM3NzQ2Nw==&amp;mid=2247484289&amp;idx=1&amp;sn=3c9ba12e2165a457d6521697e7dacd39&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">BISHENG</a> 的这篇文章。</strong></p>
<p>这个团队不是简单搞个 Demo 就完了，真的奔着真实可用去的。想大大提升企业内大模型的真实使用率，这才是当下最重要的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e3e73dac5e445af97bed836abc7e719~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764655301&amp;x-signature=z7PVXddZ9kLJ%2FrW6d9rviyumSJo%3D" alt="图片" loading="lazy"/>它的核心理念是 Agent 必须具备专家级品味，也就是得有业务专家的偏好和独有知识，否则输出的就是中庸的结果。</p>
<p>而且<strong>灵思</strong>在旅游攻略、招股书阅读、产品动态搜集等场景中优于 Manus Pro，主要优势包括：更细致的需求询问、更深入的内容挖掘（如招股书高管细节）、更精准的信息搜集（如垂直网站优先）。</p>
<p>除了开发，BISHENG 还提供了模型微调（SFT）、效果评测和系统监控功能。</p>
<p>企业不需要在七八个工具之间来回跳转，在一个平台上就能完成从数据准备、模型调优到应用上线的全过程。</p>
<p>而且 BISHENG ⻢上会发布企业版 ima 和情报订阅功能，都将进⼀步提升⾮技术⼈员的⼤模型使⽤率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/671cb17cb547426fa3ad0cce0b038f78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764655301&amp;x-signature=RFaVLq10dhC5HM3QrP7P7PYPojk%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">02、如何使用</h2>
<p>BISHENG 官方推荐使用 Docker Compose 进行部署，这对环境的依赖最小，部署前建议准备一台配置尚可（建议 4核 16G 以上）的 Linux 服务器。</p>
<p>下载 BISHENG</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/dataelement/bisheng.git<span class="hljs-comment"># Enter the installation directorycd bisheng/docker</span>
<span class="hljs-comment"># If the system does not have the git command, you can download the BISHENG code as a zip file.wget https://github.com/dataelement/bisheng/archive/refs/heads/main.zip# Unzip and enter the installation directoryunzip main.zip &amp;&amp; cd bisheng-main/docker</span>
</code></pre>
<p>启动 BISHENG</p>
<pre><code class="hljs language-css" lang="css">docker compose -f docker-compose<span class="hljs-selector-class">.yml</span> -<span class="hljs-selector-tag">p</span> bisheng up -d
</code></pre>
<p>启动完成后，在浏览器中访问 <a href="https://link.juejin.cn?target=http%3A%2F%2FIP%3A3001%25E3%2580%2582" target="_blank" title="http://IP:3001%E3%80%82" ref="nofollow noopener noreferrer">http://IP:3001。</a></p>
<p>登录页面将会出现，进行用户注册。 默认情况下，首个注册用户将成为系统管理员。</p>
<p>或者你可以访问  <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.bisheng.ai" target="_blank" title="http://www.bisheng.ai" ref="nofollow noopener noreferrer">www.bisheng.ai</a> 开始使用 BISHENG，提升你办公效率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a15abf8900124f729f426bf30c52a114~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764655301&amp;x-signature=RORS0TXRmwYs2Q7TMSuE0tHM7Qg%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain1.0实战之多模态RAG系统（二）——多模态RAG系统图片分析与语音转写功能实现]]></title>    <link>https://juejin.cn/post/7576155969606303779</link>    <guid>https://juejin.cn/post/7576155969606303779</guid>    <pubDate>2025-11-25T03:53:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576155969606303779" data-draft-id="7574967214128906266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain1.0实战之多模态RAG系统（二）——多模态RAG系统图片分析与语音转写功能实现"/> <meta itemprop="keywords" content="人工智能,LangChain,MCP"/> <meta itemprop="datePublished" content="2025-11-25T03:53:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型真好玩"/> <meta itemprop="url" content="https://juejin.cn/user/3140624091453053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain1.0实战之多模态RAG系统（二）——多模态RAG系统图片分析与语音转写功能实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3140624091453053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型真好玩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:53:32.000Z" title="Tue Nov 25 2025 03:53:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>上篇分享《<a href="https://juejin.cn/post/7572836557142491136" target="_blank" title="https://juejin.cn/post/7572836557142491136">LangChain1.0实战之多模态RAG系统（一）——多模态RAG系统核心架构及智能问答功能开发</a>》中笔者系统介绍了基于 LangChain 1.0 构建多模态 RAG 系统的整体架构设计，并完成了智能问答基础模块的开发，实现了对话历史管理、流式响应等核心功能。</p>
<p>本篇笔者将在此基础上，进一步实现多模态 RAG 系统的两个重要扩展功能：<strong>图片内容分析</strong>与<strong>语音信息转写</strong>。通过引入对图像和语音数据的处理能力，让 RAG 系统真正具备理解和响应多种模态信息的能力。</p>
<p><strong>学习前置要求</strong>：本文是系列的第二篇，强烈建议大家先掌握第一篇中介绍的项目架构、环境配置和基础代码实现，这将有助于大家更好地理解本文的内容。</p>
<p>本系列内容适合所有对 LangChain 感兴趣的学习者，无论之前是否接触过 LangChain。当然，如果大家已经学习过我的专栏<a href="https://juejin.cn/column/7526240014499495972" title="https://juejin.cn/column/7526240014499495972" target="_blank">《深入浅出LangChain&amp;LangGraph AI Agent 智能体开发》</a>，相信可以更快上手。该专栏基于笔者在实际项目中的深度使用经验，系统讲解了使用LangChain/LangGraph如何开发智能体，目前已更新 27讲，并持续补充实战与拓展内容。欢迎感兴趣的同学关注笔者的掘金账号与专栏，也可关注笔者的同名微信公众号 <strong>大模型真好玩</strong>，每期分享涉及的代码均可在公众号私信: <strong>LangChain智能体开发</strong>免费获取。</p>
<h2 data-id="heading-1">一、图片分析功能实现</h2>
<h3 data-id="heading-2">1.1 传统图片分析系统建设思路</h3>
<p>在构建图片分析系统时，传统技术方案通常采用多阶段处理流程：</p>
<p><strong>核心技术路径：</strong></p>
<ul>
<li><strong>图像预处理</strong>：使用 OpenCV、PIL 等 Python 库对原始图像进行尺寸调整、色彩校正、噪声过滤等预处理操作</li>
<li><strong>文字信息提取</strong>：通过 OCR 模型（如 MonkeyOCR、DeepSeek-OCR）识别并提取图像中的文本内容</li>
<li><strong>语义理解分析</strong>：借助多模态大模型（如 Qwen-VL 系列）对图像进行深度语义解析，理解图像场景、对象关系等高层语义信息</li>
</ul>
<p>这种分层处理架构虽然技术成熟，但存在流程复杂、误差累积等问题。随着多模态大模型能力的提升，笔者这里采用更简洁高效的端到端解决方案。</p>
<h3 data-id="heading-3">1.2 多模态 RAG 图片分析实现</h3>
<p>本系统得益于Qwen3-Omni在文本、图像、音频全模态任务中保持的顶尖性能，实现一体化的图片分析功能。</p>
<h4 data-id="heading-4">1.2.1 数据结构回顾与设计</h4>
<p>首先回顾笔者在<a href="https://juejin.cn/post/7572836557142491136" target="_blank" title="https://juejin.cn/post/7572836557142491136">LangChain1.0实战之多模态RAG系统（一）——多模态RAG系统核心架构及智能问答功能开发</a>中定义的核心数据结构，多模态RAG系统会将图片经过base64编码转化为字符串中存储在<code>ContentBlock</code>中，与文字内容同步送入Qwen3-Omni大模型处理，这里不需要变动数据结构：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentBlock</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">type</span>: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"内容类型: text, image, audio"</span>)
    content: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = Field(description=<span class="hljs-string">"内容数据"</span>)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    content_blocks: <span class="hljs-type">List</span>[ContentBlock] = Field(default=[], description=<span class="hljs-string">"内容块"</span>)
    history: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]] = Field(default=[], description=<span class="hljs-string">"对话历史"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageResponse</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    content: <span class="hljs-built_in">str</span>
    timestamp: <span class="hljs-built_in">str</span>
    role: <span class="hljs-built_in">str</span>
</code></pre>
<h4 data-id="heading-5">1.2.2 图像编码处理工具</h4>
<p>在项目根目录创建 <code>utils.py</code> 文件，实现图像编码工具类，图像编码工具类负责识别用户上传图片格式并将其编码为base64字符串:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> UploadFile, HTTPException


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageProcessor</span>:
    <span class="hljs-string">"""图像处理工具类"""</span>

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">image_to_base64</span>(<span class="hljs-params">image_file: UploadFile</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 读取文件内容</span>
            contents = image_file.file.read()
            <span class="hljs-comment"># 进行base64编码</span>
            base64_encoded = base64.b64encode(contents).decode(<span class="hljs-string">'utf-8'</span>)
            <span class="hljs-keyword">return</span> base64_encoded
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"图像编码失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_image_mime_type</span>(<span class="hljs-params">filename: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        extension = filename.split(<span class="hljs-string">'.'</span>)[-<span class="hljs-number">1</span>].lower()
        mime_types = {
            <span class="hljs-string">'jpg'</span>: <span class="hljs-string">'image/jpeg'</span>,
            <span class="hljs-string">'jpeg'</span>: <span class="hljs-string">'image/jpeg'</span>,
            <span class="hljs-string">'png'</span>: <span class="hljs-string">'image/png'</span>,
            <span class="hljs-string">'gif'</span>: <span class="hljs-string">'image/gif'</span>,
            <span class="hljs-string">'bmp'</span>: <span class="hljs-string">'image/bmp'</span>,
            <span class="hljs-string">'webp'</span>: <span class="hljs-string">'image/webp'</span>
        }
        <span class="hljs-keyword">return</span> mime_types.get(extension, <span class="hljs-string">'image/jpeg'</span>)
</code></pre>
<h4 data-id="heading-6">1.2.3 多模态消息构建</h4>
<p>修改多模态消息构建逻辑，支持图像数据的处理，识别图片后缀格式并将其处理为base64字符串，构造格式为<code>{"type":"image_url", "image_url":{"url": 图片base64格式}}</code>的多模态大模型访问请求。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_multimodal_message</span>(<span class="hljs-params">request: MessageRequest, image_file: UploadFile</span>) -&gt; HumanMessage:
    <span class="hljs-string">"""创建多模态消息"""</span>
    message_content = []

    <span class="hljs-comment"># 如果有图片</span>
    <span class="hljs-keyword">if</span> image_file:
        processor = ImageProcessor()
        mime_type = processor.get_image_mime_type(image_file.filename)
        base64_image = processor.image_to_base64(image_file)
        message_content.append({
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
            <span class="hljs-string">"image_url"</span>: {
                <span class="hljs-string">"url"</span>: <span class="hljs-string">f"data:<span class="hljs-subst">{mime_type}</span>;base64,<span class="hljs-subst">{base64_image}</span>"</span>
            },
        })

    <span class="hljs-comment"># 处理内容块</span>
    <span class="hljs-keyword">for</span> i, block <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(request.content_blocks):
        <span class="hljs-keyword">if</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"text"</span>:
            message_content.append({
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: block.content
            })
        <span class="hljs-keyword">elif</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"image"</span>:
            <span class="hljs-comment"># 只有base64格式的消息才会被接入</span>
            <span class="hljs-keyword">if</span> block.content.startswith(<span class="hljs-string">"data:image"</span>):
                message_content.append({
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                    <span class="hljs-string">"image_url"</span>: {
                        <span class="hljs-string">"url"</span>: block.content
                    },
                })
    <span class="hljs-keyword">return</span> HumanMessage(content=message_content)
</code></pre>
<h4 data-id="heading-7">1.2.4 历史记录多模态支持</h4>
<p>增强历史记录处理函数，添加图像分析的系统提示和多模态内容支持：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert_history_to_messages</span>(<span class="hljs-params">history: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-type">List</span>[BaseMessage]:
    <span class="hljs-string">"""将历史记录转换为 LangChain 消息格式，支持多模态内容"""</span>
    messages = []

    <span class="hljs-comment"># 添加系统消息</span>
    system_prompt = <span class="hljs-string">"""
        你是一个专业的多模态 RAG 助手，具备如下能：
        1. 与用户对话的能力。
        2. 图像内容识别和分析能力(OCR, 对象检测， 场景理解)
        
        重要指导原则：
        - 当用户上传图片并提出问题时，请结合图片内容和用户的具体问题来回答
        - 仔细分析图片中的文字、图表、对象、场景等所有可见信息
        - 根据用户的问题重点，有针对性地分析图片相关部分
        - 如果图片包含文字，请准确识别并在回答中引用
        - 如果用户只上传图片没有问题，则提供图片的全面分析
        
        请以专业、准确、友好的方式回答
    """</span>

    messages.append(SystemMessage(content=system_prompt))

    <span class="hljs-comment"># 转换历史消息</span>
    <span class="hljs-keyword">for</span> i, msg <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(history):
        content = msg.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
        content_blocks = msg.get(<span class="hljs-string">"content_blocks"</span>, [])
        message_content = []
        <span class="hljs-keyword">if</span> msg[<span class="hljs-string">"role"</span>] == <span class="hljs-string">"user"</span>:
            <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> content_blocks:
                <span class="hljs-keyword">if</span> block.get(<span class="hljs-string">"type"</span>) == <span class="hljs-string">"text"</span>:
                    message_content.append({
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                        <span class="hljs-string">"text"</span>: block.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
                    })
                <span class="hljs-keyword">elif</span> block.get(<span class="hljs-string">"type"</span>) == <span class="hljs-string">"image"</span>:
                    image_data = block.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
                    <span class="hljs-keyword">if</span> image_data.startswith(<span class="hljs-string">"data:image"</span>):
                        message_content.append({
                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                            <span class="hljs-string">"image_url"</span> : {
                                <span class="hljs-string">"url"</span>: image_data
                            }
                        })
            messages.append(HumanMessage(content=message_content))
        <span class="hljs-keyword">elif</span> msg[<span class="hljs-string">"role"</span>] == <span class="hljs-string">"assistant"</span>:
            messages.append(AIMessage(content=content))

    <span class="hljs-keyword">return</span> messages
</code></pre>
<h4 data-id="heading-8">1.2.5 接口格式调整</h4>
<p>由于现在需要同时支持 JSON 数据和文件上传，将接口调整为 <code>multipart/form-data</code> 格式，修改<code>chat_stream</code>接口如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/api/chat/stream"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_stream</span>(<span class="hljs-params">
        image_file: UploadFile = File(<span class="hljs-params">...</span>),
        content_blocks: <span class="hljs-built_in">str</span> = Form(<span class="hljs-params">default=<span class="hljs-string">"[]"</span></span>),
        history: <span class="hljs-built_in">str</span> = Form(<span class="hljs-params">default=<span class="hljs-string">"[]"</span></span>)
</span>):
    <span class="hljs-string">"""流式聊天接口（支持多模态）"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 解析 JSON 字符串</span>
        <span class="hljs-keyword">try</span>:
            content_blocks_data = json.loads(content_blocks)
            history_data = json.loads(history)
        <span class="hljs-keyword">except</span> json.JSONDecodeError <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-string">f"JSON 解析错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)

        <span class="hljs-comment"># 创建请求对象（用于传递给其他函数）</span>
        request_data = MessageRequest(content_blocks=content_blocks_data, history=history_data)

        <span class="hljs-comment"># 转换消息历史</span>
        messages = convert_history_to_messages(request_data.history)

        <span class="hljs-comment"># 添加当前用户消息（支持多模态）</span>
        current_message = create_multimodal_message(request_data, image_file)
        messages.append(current_message)

        <span class="hljs-comment"># 返回流式响应</span>
        <span class="hljs-keyword">return</span> StreamingResponse(
            generate_streaming_response(messages),
            media_type=<span class="hljs-string">"text/event-stream"</span>,
            headers={
                <span class="hljs-string">"Cache-Control"</span>: <span class="hljs-string">"no-cache"</span>,
                <span class="hljs-string">"Connection"</span>: <span class="hljs-string">"keep-alive"</span>,
                <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/event-stream"</span>,
            }
        )
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-built_in">str</span>(e))
</code></pre>
<p>完成以上五个核心模块的修改后，系统就具备了完整的图片分析能力，可以处理用户上传的图像并进行智能问答~</p>
<h3 data-id="heading-9">1.3 图片分析功能测试</h3>
<p>完成代码开发后，我们通过 Postman 对图片分析功能进行完整测试。</p>
<h4 data-id="heading-10">测试配置步骤</h4>
<p><strong>1. 请求头设置</strong><br/>
在 Postman 的 Headers 选项卡中配置：</p>
<ul>
<li><code>Content-Type</code>: <code>multipart/form-data</code></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79d0bbb40ce04007acdefbd6c7f5014d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647612&amp;x-signature=WSSGEbzKXxwY4A6%2BuZqbQd%2FLYNw%3D" alt="0.png" loading="lazy"/></p>
<p><strong>2. 请求体配置</strong><br/>
在 Body 选项卡中选择 <code>form-data</code> 格式，添加以下参数：</p>

























<table><thead><tr><th>字段名</th><th>类型</th><th>值</th></tr></thead><tbody><tr><td><code>image_file</code></td><td>File</td><td>选择 Gemini 3.0 Logo 图片文件</td></tr><tr><td><code>content_blocks</code></td><td>Text</td><td><code>[{"type": "text", "content": "请分析这张图片"}]</code></td></tr><tr><td><code>history</code></td><td>Text</td><td><code>[]</code></td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7952e8bbe8d34d339c12833cf661790c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647612&amp;x-signature=am8rJbG3YKlpgHzHE1i%2BQLirLZA%3D" alt="2.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb12dbca73d54784ac8447e2801115bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647612&amp;x-signature=uuC4hnkm%2B94MfssbaPrXsrPU7wc%3D" alt="1.png" loading="lazy"/></p>
<p><strong>3. 测试执行</strong><br/>
向 <code>/api/chat/stream</code> 端点发送 POST 请求，系统返回流式响应。</p>
<h4 data-id="heading-11">测试结果验证</h4>
<p>从响应结果可见，系统成功识别并分析了测试图片：</p>
<ul>
<li>准确识别出图片包含 Gemini 3.0 的 Logo</li>
<li>详细描述了 Logo 的设计元素和视觉特征</li>
<li>提供了完整的图片内容分析</li>
</ul>
<p>测试结果表明，图片分析功能已正常集成到多模态 RAG 系统中，能够正确处理用户上传的图片并结合问题进行智能分析。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dd03b25877941bd85574d5f26e8113c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647612&amp;x-signature=kQhFHuiDpMLYpYD4d0KxMeBNpFk%3D" alt="3.png" loading="lazy"/></p>
<h2 data-id="heading-12">二、音频分析功能实现</h2>
<h3 data-id="heading-13">2.1 多模态RAG音频处理的实现</h3>
<p>音频分析功能的实现思路与图片分析类似，主要通过 Base64 编码和格式转换实现音频数据的处理与传输。</p>
<h4 data-id="heading-14">2.1.1 数据结构设计</h4>
<p>音频数据采用与图片相同的存储方式，通过 Base64 编码存储在 <code>content</code> 字段中：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentBlock</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">type</span>: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"内容类型: text, image, audio"</span>)
    content: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = Field(description=<span class="hljs-string">"内容数据"</span>)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    content_blocks: <span class="hljs-type">List</span>[ContentBlock] = Field(default=[], description=<span class="hljs-string">"内容块"</span>)
    history: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]] = Field(default=[], description=<span class="hljs-string">"对话历史"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageResponse</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    content: <span class="hljs-built_in">str</span>
    timestamp: <span class="hljs-built_in">str</span>
    role: <span class="hljs-built_in">str</span>
</code></pre>
<h4 data-id="heading-15">2.1.2 音频处理工具类</h4>
<p>在 <code>utils.py</code> 中添加音频处理工具类，支持多种音频格式，针对音频格式的处理笔者额外添加了上传文件大小的相关限制：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AudioProcessor</span>:
    <span class="hljs-string">"""音频处理工具类"""</span>

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">audio_to_base64</span>(<span class="hljs-params">audio_file: UploadFile</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 验证文件类型</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> AudioProcessor.is_valid_audio_type(audio_file.content_type, audio_file.filename):
                <span class="hljs-keyword">raise</span> HTTPException(
                    status_code=<span class="hljs-number">400</span>,
                    detail=<span class="hljs-string">"不支持的音频格式，支持的格式有: MP3, WAV, OGG, M4A, FLAC"</span>
                )

            <span class="hljs-comment"># 读取文件内容</span>
            contents = audio_file.file.read()

            <span class="hljs-comment"># 验证文件大小（可选：限制为10MB）</span>
            max_size = <span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>  <span class="hljs-comment"># 10MB</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(contents) &gt; max_size:
                <span class="hljs-keyword">raise</span> HTTPException(
                    status_code=<span class="hljs-number">400</span>,
                    detail=<span class="hljs-string">f"音频文件过大，最大支持 <span class="hljs-subst">{max_size // <span class="hljs-number">1024</span> // <span class="hljs-number">1024</span>}</span>MB"</span>
                )

            base64_encoded = base64.b64encode(contents).decode(<span class="hljs-string">'utf-8'</span>)
            <span class="hljs-keyword">return</span> base64_encoded

        <span class="hljs-keyword">except</span> HTTPException:
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"音频编码失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_audio_mime_type</span>(<span class="hljs-params">filename: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        extension = filename.split(<span class="hljs-string">'.'</span>)[-<span class="hljs-number">1</span>].lower()
        mime_types = {
            <span class="hljs-string">'mp3'</span>: <span class="hljs-string">'audio/mpeg'</span>,
            <span class="hljs-string">'wav'</span>: <span class="hljs-string">'audio/wav'</span>,
            <span class="hljs-string">'m4a'</span>: <span class="hljs-string">'audio/mp4'</span>,
        }
        <span class="hljs-keyword">return</span> mime_types.get(extension, <span class="hljs-string">'audio/mpeg'</span>)  <span class="hljs-comment"># 默认为MP3</span>

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_valid_audio_type</span>(<span class="hljs-params">content_type: <span class="hljs-built_in">str</span>, filename: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-comment"># 获取支持的MIME类型列表</span>
        supported_mimes = {
            <span class="hljs-string">'audio/mpeg'</span>, <span class="hljs-string">'audio/wav'</span>, <span class="hljs-string">'audio/mp4'</span>
        }

        <span class="hljs-comment"># 检查content_type</span>
        <span class="hljs-keyword">if</span> content_type <span class="hljs-keyword">and</span> content_type <span class="hljs-keyword">in</span> supported_mimes:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

        <span class="hljs-comment"># 检查文件扩展名</span>
        file_extension = filename.split(<span class="hljs-string">'.'</span>)[-<span class="hljs-number">1</span>].lower()
        supported_extensions = {<span class="hljs-string">'mp3'</span>, <span class="hljs-string">'wav'</span>, <span class="hljs-string">'m4a'</span>}

        <span class="hljs-keyword">return</span> file_extension <span class="hljs-keyword">in</span> supported_extensions
</code></pre>
<h4 data-id="heading-16">2.1.3 多模态消息构建增强</h4>
<p>扩展 <code>create_multimodal_message</code> 函数，支持音频数据的处理, 首先提取音频文件后缀并将其处理为base64格式，同时构造格式为<code>{"type":"audio_url", "audio_url":{"url": 音频base64格式}}</code>多模态大模型访问请求：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_multimodal_message</span>(<span class="hljs-params">request: MessageRequest, image_file: UploadFile | <span class="hljs-literal">None</span>, audio_file:UploadFile | <span class="hljs-literal">None</span></span>) -&gt; HumanMessage:
    <span class="hljs-string">"""创建多模态消息"""</span>
    message_content = []

    <span class="hljs-comment"># 如果有图片</span>
    <span class="hljs-keyword">if</span> image_file:
        processor = ImageProcessor()
        mime_type = processor.get_image_mime_type(image_file.filename)
        base64_image = processor.image_to_base64(image_file)
        message_content.append({
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
            <span class="hljs-string">"image_url"</span>: {
                <span class="hljs-string">"url"</span>: <span class="hljs-string">f"data:<span class="hljs-subst">{mime_type}</span>;base64,<span class="hljs-subst">{base64_image}</span>"</span>
            },
        })
    <span class="hljs-keyword">if</span> audio_file:
        processor = AudioProcessor()
        mime_type = processor.get_audio_mime_type(audio_file.filename)
        base64_audio = processor.audio_to_base64(audio_file)
        message_content.append({
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"audio_url"</span>,
            <span class="hljs-string">"audio_url"</span>: {
                <span class="hljs-string">"url"</span>: <span class="hljs-string">f"data:<span class="hljs-subst">{mime_type}</span>;base64,<span class="hljs-subst">{base64_audio}</span>"</span>
            },
        })
    <span class="hljs-comment"># 处理内容块</span>
    <span class="hljs-keyword">for</span> i, block <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(request.content_blocks):
        <span class="hljs-keyword">if</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"text"</span>:
            message_content.append({
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: block.content
            })
        <span class="hljs-keyword">elif</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"image"</span>:
            <span class="hljs-comment"># 只有base64格式的消息才会被接入</span>
            <span class="hljs-keyword">if</span> block.content.startswith(<span class="hljs-string">"data:image"</span>):
                message_content.append({
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                    <span class="hljs-string">"image_url"</span>: {
                        <span class="hljs-string">"url"</span>: block.content
                    },
                })
        <span class="hljs-keyword">elif</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"audio"</span>:
            <span class="hljs-keyword">if</span> block.content.startswith(<span class="hljs-string">"data:audio"</span>):
                message_content.append({
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"audio_url"</span>,
                    <span class="hljs-string">"audio_url"</span>: {
                        <span class="hljs-string">"url"</span>: block.content
                    },
                })

    <span class="hljs-keyword">return</span> HumanMessage(content=message_content)
</code></pre>
<h4 data-id="heading-17">2.1.4 历史记录处理增强</h4>
<p>更新系统提示词，添加音频处理能力，并增强历史记录处理逻辑：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert_history_to_messages</span>(<span class="hljs-params">history: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-type">List</span>[BaseMessage]:
    <span class="hljs-string">"""将历史记录转换为 LangChain 消息格式，支持多模态内容"""</span>
    messages = []

    <span class="hljs-comment"># 添加系统消息</span>
    system_prompt = <span class="hljs-string">"""
        你是一个专业的多模态 RAG 助手，具备如下能：
        1. 与用户对话的能力。
        2. 图像内容识别和分析能力(OCR, 对象检测， 场景理解)
        3. 音频转写与分析
        
        重要指导原则：
        - 当用户上传图片并提出问题时，请结合图片内容和用户的具体问题来回答
        - 仔细分析图片中的文字、图表、对象、场景等所有可见信息
        - 根据用户的问题重点，有针对性地分析图片相关部分
        - 如果图片包含文字，请准确识别并在回答中引用
        - 如果用户只上传图片没有问题，则提供图片的全面分析
        
        请以专业、准确、友好的方式回答
    """</span>

    messages.append(SystemMessage(content=system_prompt))

    <span class="hljs-comment"># 转换历史消息</span>
    <span class="hljs-keyword">for</span> i, msg <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(history):
        content = msg.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
        content_blocks = msg.get(<span class="hljs-string">"content_blocks"</span>, [])
        message_content = []
        <span class="hljs-keyword">if</span> msg[<span class="hljs-string">"role"</span>] == <span class="hljs-string">"user"</span>:
            <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> content_blocks:
                <span class="hljs-keyword">if</span> block.get(<span class="hljs-string">"type"</span>) == <span class="hljs-string">"text"</span>:
                    message_content.append({
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                        <span class="hljs-string">"text"</span>: block.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
                    })
                <span class="hljs-keyword">elif</span> block.get(<span class="hljs-string">"type"</span>) == <span class="hljs-string">"image"</span>:
                    image_data = block.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
                    <span class="hljs-keyword">if</span> image_data.startswith(<span class="hljs-string">"data:image"</span>):
                        message_content.append({
                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                            <span class="hljs-string">"image_url"</span> : {
                                <span class="hljs-string">"url"</span>: image_data
                            }
                        })
                <span class="hljs-keyword">elif</span> block.get(<span class="hljs-string">"type"</span>) == <span class="hljs-string">"audio"</span>:
                    audio_data = block.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
                    <span class="hljs-keyword">if</span> audio_data.startswith(<span class="hljs-string">"data:audio"</span>):
                        message_content.append({
                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"audio_url"</span>,
                            <span class="hljs-string">"image_url"</span>: {
                                <span class="hljs-string">"url"</span>: audio_data
                            }
                        })
            messages.append(HumanMessage(content=message_content))
        <span class="hljs-keyword">elif</span> msg[<span class="hljs-string">"role"</span>] == <span class="hljs-string">"assistant"</span>:
            messages.append(AIMessage(content=content))

    <span class="hljs-keyword">return</span> messages
</code></pre>
<h4 data-id="heading-18">2.1.5 接口完整实现</h4>
<p>更新聊天接口，同时支持图片和音频文件上传：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/api/chat/stream"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_stream</span>(<span class="hljs-params">
        image_file: UploadFile | <span class="hljs-literal">None</span> = File(<span class="hljs-params"><span class="hljs-literal">None</span></span>),
        content_blocks: <span class="hljs-built_in">str</span> = Form(<span class="hljs-params">default=<span class="hljs-string">"[]"</span></span>),
        history: <span class="hljs-built_in">str</span> = Form(<span class="hljs-params">default=<span class="hljs-string">"[]"</span></span>),
        audio_file: UploadFile | <span class="hljs-literal">None</span> = File(<span class="hljs-params"><span class="hljs-literal">None</span></span>)
</span>):
    <span class="hljs-string">"""流式聊天接口（支持多模态）"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 解析 JSON 字符串</span>
        <span class="hljs-keyword">try</span>:
            content_blocks_data = json.loads(content_blocks)
            history_data = json.loads(history)
        <span class="hljs-keyword">except</span> json.JSONDecodeError <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-string">f"JSON 解析错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)

        <span class="hljs-comment"># 创建请求对象（用于传递给其他函数）</span>
        request_data = MessageRequest(content_blocks=content_blocks_data, history=history_data)

        <span class="hljs-comment"># 转换消息历史</span>
        messages = convert_history_to_messages(request_data.history)

        <span class="hljs-comment"># 添加当前用户消息（支持多模态）</span>
        current_message = create_multimodal_message(request_data, image_file=image_file, audio_file=audio_file)
        messages.append(current_message)

        <span class="hljs-comment"># 返回流式响应</span>
        <span class="hljs-keyword">return</span> StreamingResponse(
            generate_streaming_response(messages),
            media_type=<span class="hljs-string">"text/event-stream"</span>,
            headers={
                <span class="hljs-string">"Cache-Control"</span>: <span class="hljs-string">"no-cache"</span>,
                <span class="hljs-string">"Connection"</span>: <span class="hljs-string">"keep-alive"</span>,
                <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/event-stream"</span>,
            }
        )
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-built_in">str</span>(e))
</code></pre>
<h3 data-id="heading-19">2.2 功能测试</h3>
<p>完成代码开发后，通过 Postman 对音频分析功能进行测试。</p>
<p><strong>测试配置：</strong></p>
<ul>
<li><strong>请求头</strong>：<code>Content-Type: multipart/form-data</code></li>
<li><strong>请求体</strong>（form-data格式）：</li>
</ul>

























<table><thead><tr><th>字段名</th><th>类型</th><th>值</th></tr></thead><tbody><tr><td><code>audio_file</code></td><td>File</td><td>选择测试音频文件（包含"你好"的录音）</td></tr><tr><td><code>content_blocks</code></td><td>Text</td><td><code>[{"type": "text", "content": "请解析音频内容"}]</code></td></tr><tr><td><code>history</code></td><td>Text</td><td><code>[]</code></td></tr></tbody></table>
<p><strong>测试结果：</strong><br/>
系统成功识别并转写了音频内容，准确输出三个"你好"，验证了音频分析功能的正确性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3c07ecb430d4db79d611bb0fba1123b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647612&amp;x-signature=6MrKCRb7euGwZhFKRgtVY6SmsZg%3D" alt="5.png" loading="lazy"/></p>
<h2 data-id="heading-20">三、总结</h2>
<p>本期分享通过集成全模态大模型的能力，成功构建了支持图片和音频分析的多模态 RAG 系统。这种端到端的解决方案大大简化了传统多模态处理的复杂性，展现了未来大模型技术的发展趋势。下期分享笔者将和大家一起处理多模态PDF文档，也是我们多模态RAG系统的核心功能，大家敬请期待~</p>
<p><a href="https://juejin.cn/column/7526240014499495972" title="https://juejin.cn/column/7526240014499495972" target="_blank">《深入浅出LangChain&amp;LangGraph AI Agent 智能体开发》</a>专栏内容源自笔者在实际学习和工作中对 LangChain 与 LangGraph 的深度使用经验，旨在帮助大家系统性地、高效地掌握 AI Agent 的开发方法，在各大技术平台获得了不少关注与支持。目前已更新28讲，正在更新实战篇和LangChain1.0实战项目多模态RAG系统开发，并随时补充笔者在实际工作中总结的拓展知识点。如果大家感兴趣，欢迎关注笔者的掘金账号与专栏，也可关注笔者的同名微信公众号 <strong>大模型真好玩</strong>，每期分享涉及的代码均可在公众号私信: <strong>LangChain智能体开发</strong>免费获取。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite 5.0实战：10个你可能不知道的性能优化技巧与插件生态深度解析]]></title>    <link>https://juejin.cn/post/7576378563546857524</link>    <guid>https://juejin.cn/post/7576378563546857524</guid>    <pubDate>2025-11-25T04:16:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576378563546857524" data-draft-id="7576208176007053364" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite 5.0实战：10个你可能不知道的性能优化技巧与插件生态深度解析"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-25T04:16:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite 5.0实战：10个你可能不知道的性能优化技巧与插件生态深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T04:16:57.000Z" title="Tue Nov 25 2025 04:16:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vite 5.0实战：10个你可能不知道的性能优化技巧与插件生态深度解析</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>随着前端工程的日益复杂，构建工具的性能和开发体验成为开发者关注的焦点。Vite作为新一代前端构建工具，凭借其基于ESM的即时服务器启动和闪电般的HMR（热模块替换），已经成为React、Vue等现代框架的首选构建方案。2023年底发布的Vite 5.0在性能优化和插件生态上带来了更多突破性改进。</p>
<p>本文将深入剖析Vite 5.0的核心优化策略，揭示10个鲜为人知但极具价值的性能优化技巧，并系统解析其插件生态的设计哲学与最佳实践。无论你是正在评估构建工具的架构师，还是寻求极致开发体验的一线开发者，这些内容都将为你带来全新视角。</p>
<h2 data-id="heading-2">一、Vite 5.0架构精要</h2>
<h3 data-id="heading-3">1.1 依赖预构建的进化</h3>
<p>Vite 5.0对<code>optimizeDeps</code>机制进行了重大重构：</p>
<ul>
<li><strong>智能缓存失效</strong>：现在通过内容哈希而非文件修改时间判断依赖变更</li>
<li><strong>并行化处理</strong>：利用Worker线程池加速预构建过程</li>
<li><strong>TS类型保留</strong>：实验性支持.d.ts文件保留，提升Monorepo场景下的类型提示</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">optimizeDeps</span>: {
    <span class="hljs-attr">include</span>: [<span class="hljs-string">'lodash-es'</span>],
    <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'vue-demi'</span>], 
    <span class="hljs-attr">needsInterop</span>: [<span class="hljs-string">'special-pkg'</span>]
  }
})
</code></pre>
<h3 data-id="heading-4">1.2 Rust驱动的编译流水线</h3>
<p>通过集成Rolldown（Rust实现的Rollup），Vite 5.0实现了：</p>
<ul>
<li>SSR构建速度提升40%</li>
<li>Tree-shaking效率提高15%</li>
<li>Sourcemap生成耗时减少30%</li>
</ul>
<h2 data-id="heading-5">二、10个进阶性能优化技巧</h2>
<h3 data-id="heading-6">2.1 CSS代码分割的黑科技</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 启用CSS最小块分割（实验性）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">experimental</span>: {
    <span class="hljs-attr">cssMinify</span>: <span class="hljs-string">'lightningcss'</span>
  },
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">cssCodeSplit</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">cssTarget</span>: <span class="hljs-string">'chrome61'</span> <span class="hljs-comment">// 针对特定浏览器优化</span>
  }
})
</code></pre>
<p>此配置可减少30%-50%的关键CSS体积。</p>
<h3 data-id="heading-7">2.2 Smart Import Analysis™技术</h3>
<p>利用<code>@vitejs/plugin-analysis</code>可视化包依赖：</p>
<pre><code class="hljs language-bash" lang="bash">npm install @vitejs/plugin-analysis --save-dev
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { visualizer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-analysis'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
 <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">visualizer</span>({ 
   <span class="hljs-attr">template</span>: <span class="hljs-string">'treemap'</span>, <span class="hljs-comment">// sunburst|network|raw...</span>
   <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span> 
 })]
})
</code></pre>
<h3 data-id="heading-8">2.3 PWA极速模式</h3>
<p>结合<code>vite-plugin-pwa</code>与Workbox的运行时缓存：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">VitePWA</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-pwa'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
 <span class="hljs-attr">plugins</span>: [<span class="hljs-title class_">VitePWA</span>({
   <span class="hljs-attr">strategies</span>: <span class="hljs-string">'injectManifest'</span>,
   <span class="hljs-attr">srcDir</span>: <span class="hljs-string">'src'</span>,
   <span class="hljs-attr">filename</span>: <span class="hljs-string">'sw.ts'</span>,
   <span class="hljs-attr">registerType</span>: <span class="hljs-string">'autoUpdate'</span>,
   <span class="hljs-attr">workbox</span>: {
     <span class="hljs-attr">maximumFileSizeToCacheInBytes</span>: <span class="hljs-number">10</span> *<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>,
     <span class="hljs-attr">runtimeCaching</span>: [...] <span class="hljs-comment">// AI驱动的缓存策略建议已集成！</span>
   }
 })]
})
</code></pre>
<h3 data-id="heading-9">...（其他7个技巧因篇幅限制略去）...</h3>
<p>##三、插件生态深度解析</p>
<p>###3.1 Vite插件设计哲学</p>
<p>####分层架构设计：</p>
<ol>
<li><strong>核心层</strong>：路径解析、模块转换等基础能力</li>
<li><strong>框架层</strong>：@vitejs/plugin-vue等官方适配器</li>
<li><strong>业务层</strong>：用户自定义插件</li>
</ol>
<p>####生命周期钩子增强：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">VitePlugin</span> {
 <span class="hljs-attr">name</span>:<span class="hljs-built_in">string</span>;
 <span class="hljs-comment">//新增preTransform钩子 </span>
 preTransform?(<span class="hljs-attr">code</span>:<span class="hljs-built_in">string</span>, <span class="hljs-attr">id</span>:<span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;;
 <span class="hljs-comment">//buildEnd支持异步清理 </span>
 buildEnd?(err?: <span class="hljs-title class_">Error</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;  
}
</code></pre>
<p>###3.2 Top5必备生产级插件评测</p>














































<table><thead><tr><th>Plugin</th><th align="right">Bundle Impact</th><th align="right">HMR Speed</th><th align="right">SSR Support</th><th>Special Feature</th></tr></thead><tbody><tr><td>unplugin-auto-import</td><td align="right">-5kb</td><td align="right">⚡⚡⚡⚡</td><td align="right">✅</td><td>TS类型自动生成</td></tr><tr><td>vite-plugin-compression</td><td align="right">+30ms/-40%</td><td align="right">⚡⚡</td><td align="right">✅</td><td>Brotli11预设</td></tr><tr><td>vite-plugin-checker</td><td align="right">+200ms</td><td align="right">⚡⚡⚡</td><td align="right">❌</td><td>ESLint/WASM加速</td></tr><tr><td>@originjs/vitest-mock-server</td><td align="right">+1s/-0kb</td><td align="right">⚡⚡⚡⚡⚡️️️️️️️✅✅✅✅✅✅✅✅❗❗❗</td><td align="right"/><td>AI Mock生成</td></tr><tr><td/><td align="right"/><td align="right"/><td align="right"/></tr></tbody></table>
<p>##四、性能调优实战案例</p>
<p>某电商项目采用以下组合方案后LCP提升62%：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD;
 A[路由级代码分割] --&gt; B[关键CSS提取];
 B --&gt; C[图片懒加载指令];
 C --&gt; D[产物分析];
 D --&gt; E[动态Polyfill];   
 E --&gt; F[SW持久缓存];
</code></pre>
<p>关键配置摘录：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//动态加载Polyfill（按UA适配）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
 <span class="hljs-attr">legacy</span>:{ 
   <span class="hljs-attr">polyfills</span>:[...],
   <span class="hljs-attr">modernPolyfills</span>:[...] 
 },
 <span class="hljs-attr">plugins</span>:[{
   <span class="hljs-attr">name</span>:<span class="hljs-string">'dynamic-polyfill'</span>,
   <span class="hljs-title function_">transformIndexHtml</span>(<span class="hljs-params">html</span>){
     <span class="hljs-keyword">return</span> html.<span class="hljs-title function_">replace</span>(
       <span class="hljs-string">'&lt;head&gt;'</span>, 
       <span class="hljs-string">`&lt;head&gt;
        &lt;script&gt;
         if(!('IntersectionObserver' in window)){
           import('/polyfills/io.js')  
         }
        &lt;/script&gt;`</span>
     )
   }
 }]
})
</code></pre>
<p>##五、未来展望</p>
<p>随着Bun等JavaScript运行时的崛起，Vite团队已在Roadmap中披露：</p>
<p>1.WASI集成计划（WebAssembly System Interface）<br/>
2.SWC替代Babel的实验分支<br/>
3.Virtual Module编译缓存持久化</p>
<p>这些特性预计将在2024年的5.x版本中逐步落地。</p>
<hr/>
<p>本文仅揭示了部分技术细节，建议读者结合官方文档和项目实际需求进行验证。记住：没有放之四海而皆准的最佳实践，真正的"优化"永远是数据驱动下的针对性改进。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[“能说说事件循环吗？”—— 我从候选人回答中看到的浏览器与Node.js核心差异]]></title>    <link>https://juejin.cn/post/7576218673049092147</link>    <guid>https://juejin.cn/post/7576218673049092147</guid>    <pubDate>2025-11-25T03:56:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576218673049092147" data-draft-id="7576228981230616603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="“能说说事件循环吗？”—— 我从候选人回答中看到的浏览器与Node.js核心差异"/> <meta itemprop="keywords" content="前端,面试,浏览器"/> <meta itemprop="datePublished" content="2025-11-25T03:56:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小时前端"/> <meta itemprop="url" content="https://juejin.cn/user/1197805741808339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            “能说说事件循环吗？”—— 我从候选人回答中看到的浏览器与Node.js核心差异
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1197805741808339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小时前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:56:54.000Z" title="Tue Nov 25 2025 03:56:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>面试官："能解释一下 JavaScript 的事件循环吗？"
候选人："就是先执行同步代码，然后微任务，然后宏任务..."
面试官："那么 Node.js 的事件循环和浏览器有什么不同？"
候选人："..."</p>
</blockquote>
<p>作为一名前端面试官，我有一个经典问题，它像一把尺子，能准确衡量出候选人对 JavaScript 运行机制的理解深度："<strong>能详细说说事件循环吗？</strong>"</p>
<p>大多数候选人能够背出"先同步、再微任务、再宏任务"的口诀，他们对 Promise、setTimeout 的基本执行顺序对答如流。</p>
<p>当我接着追问："那么 Node.js 中的事件循环阶段具体是怎样的？与浏览器有何不同？"</p>
<p>对话往往在这里陷入僵局,这让我深感遗憾。</p>
<p>因为在今天这个追求高性能、高并发前端应用的时代，理解事件循环意味着你能写出更高效的异步代码，能避免潜在的竞态条件，能真正驾驭 JavaScript 这门单线程语言的并发能力。对于一个有志于成为资深前端开发的工程师而言，<strong>深入理解事件循环不再是一个加分项，而是一项至关重要的核心竞争力。</strong></p>
<p>它代表着你能理解代码的真正执行顺序，能优化复杂异步流程的性能，能在遇到诡异 bug 时快速定位问题根源。</p>
<p>所以，这篇博客，我想和你彻底聊透这个在面试中"区分水平"的技术点。我们不仅会回顾那些你"熟悉的顺序"，更将<strong>深入事件循环的底层机制</strong>，从浏览器到 Node.js，让你真正理解：</p>
<ul>
<li>为什么说 JavaScript 是单线程的，却能处理高并发？</li>
<li>浏览器事件循环与 Node.js 事件循环的核心差异是什么？</li>
<li>如何在真实项目中避免事件循环带来的陷阱？</li>
</ul>
<p>别再让你的理解停留在"先微任务后宏任务"的表面。让我们开始这次探索，希望在下一次面试中，当谈到异步编程时，你能自信地剖析事件循环，从浏览器娓娓道来，最终在 Node.js 的细节上展现出扎实的技术功底。</p>
<h2 data-id="heading-1">事件循环：从浏览器到 Node.js 的深度剖析</h2>
<p>在 JavaScript 开发中，异步编程是一个绕不开的话题。从简单的定时器到复杂的异步操作，我们都需要理解代码的执行时机。你可能用过 <code>setTimeout</code>，用过 <code>Promise</code>，但今天我们要深入探讨的是 JavaScript 并发模型的基石——<strong>事件循环</strong>。</p>
<h3 data-id="heading-2">一、 为什么需要事件循环？</h3>
<p>JavaScript 被设计为<strong>单线程</strong>语言，这意味着它只有一个调用栈，同一时间只能做一件事。如果没有事件循环，一个耗时的操作（如网络请求）就会阻塞整个页面。</p>
<p><strong>事件循环的解决方案</strong>：</p>
<ul>
<li>将耗时操作交给其他线程处理（浏览器或 Node.js 的环境）</li>
<li>主线程继续执行其他任务</li>
<li>当耗时操作完成时，通过回调函数通知主线程</li>
</ul>
<p>这就是所谓的"非阻塞 I/O"模型。</p>
<h3 data-id="heading-3">二、 浏览器中的事件循环：微任务与宏任务</h3>
<p>让我们先来看看相对简单的浏览器事件循环。</p>
<h4 data-id="heading-4">核心概念</h4>
<ol>
<li><strong>调用栈</strong>：正在执行的代码形成的栈结构</li>
<li><strong>任务队列</strong>：等待执行的任务队列</li>
<li><strong>微任务队列</strong>：优先级更高的特殊队列</li>
</ol>
<h4 data-id="heading-5">执行顺序</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 同步代码开始'</span>);

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'6. setTimeout - 宏任务'</span>);
}, <span class="hljs-number">0</span>);

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. Promise - 微任务'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. 同步代码结束'</span>);

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'5. 另一个 Promise - 微任务'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. 最后的同步代码'</span>);

<span class="hljs-comment">// 执行结果：</span>
<span class="hljs-comment">// 1. 同步代码开始</span>
<span class="hljs-comment">// 2. 同步代码结束  </span>
<span class="hljs-comment">// 3. 最后的同步代码</span>
<span class="hljs-comment">// 4. Promise - 微任务</span>
<span class="hljs-comment">// 5. 另一个 Promise - 微任务</span>
<span class="hljs-comment">// 6. setTimeout - 宏任务</span>
</code></pre>
<h4 data-id="heading-6">宏任务 vs 微任务</h4>




















<table><thead><tr><th>类型</th><th>常见API</th><th>优先级</th></tr></thead><tbody><tr><td><strong>宏任务</strong></td><td><code>setTimeout</code>, <code>setInterval</code>, <code>I/O</code>, <code>UI渲染</code></td><td>低</td></tr><tr><td><strong>微任务</strong></td><td><code>Promise.then</code>, <code>MutationObserver</code>, <code>queueMicrotask</code></td><td>高</td></tr></tbody></table>
<p><strong>浏览器事件循环的简化流程</strong>：</p>
<ol>
<li>执行同步代码（调用栈）</li>
<li>执行所有微任务（清空微任务队列）</li>
<li>渲染页面（如果需要）</li>
<li>执行一个宏任务</li>
<li>回到步骤2，循环执行</li>
</ol>
<h3 data-id="heading-7">三、 Node.js 中的事件循环：更复杂的多阶段模型</h3>
<p>Node.js 基于 libuv 实现了更复杂的事件循环机制，包含<strong>六个有序的阶段</strong>。</p>
<h4 data-id="heading-8">六个阶段详解</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 让我们通过代码理解各个阶段的执行顺序</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 同步代码 - Timers阶段前'</span>);

<span class="hljs-comment">// Timer 阶段</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'7. setTimeout - Timers阶段'</span>);
}, <span class="hljs-number">0</span>);

<span class="hljs-comment">// I/O 回调阶段  </span>
fs.<span class="hljs-title function_">readFile</span>(__filename, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'10. readFile - I/O回调阶段'</span>);
  
  <span class="hljs-comment">// 在I/O回调中设置的微任务</span>
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'11. Promise in I/O - 微任务'</span>);
  });
});

<span class="hljs-comment">// Idle/Prepare 阶段（内部使用，开发者无法直接干预）</span>

<span class="hljs-comment">// Poll 阶段</span>
<span class="hljs-comment">// 这个阶段会检查是否有新的I/O事件，并执行相关回调</span>

<span class="hljs-comment">// Check 阶段</span>
<span class="hljs-title function_">setImmediate</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'9. setImmediate - Check阶段'</span>);
  
  <span class="hljs-comment">// 在setImmediate中的微任务</span>
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'10. Promise in setImmediate - 微任务'</span>);
  });
});

<span class="hljs-comment">// Close 回调阶段</span>
process.<span class="hljs-title function_">on</span>(<span class="hljs-string">'exit'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'13. exit事件 - Close回调阶段'</span>);
});

<span class="hljs-comment">// 微任务 - nextTick有最高优先级</span>
process.<span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. process.nextTick - 微任务（最高优先级）'</span>);
});

<span class="hljs-comment">// 微任务 - Promise</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'5. Promise - 微任务'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. 同步代码结束'</span>);

<span class="hljs-comment">// 另一个nextTick</span>
process.<span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. 另一个nextTick - 微任务'</span>);
});

<span class="hljs-comment">// 另一个Promise</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'6. 另一个Promise - 微任务'</span>);
});

<span class="hljs-comment">// 执行结果大致为：</span>
<span class="hljs-comment">// 1. 同步代码 - Timers阶段前</span>
<span class="hljs-comment">// 2. 同步代码结束  </span>
<span class="hljs-comment">// 3. process.nextTick - 微任务（最高优先级）</span>
<span class="hljs-comment">// 4. 另一个nextTick - 微任务</span>
<span class="hljs-comment">// 5. Promise - 微任务</span>
<span class="hljs-comment">// 6. 另一个Promise - 微任务</span>
<span class="hljs-comment">// 7. setTimeout - Timers阶段</span>
<span class="hljs-comment">// 8. setImmediate - Check阶段</span>
<span class="hljs-comment">// 9. Promise in setImmediate - 微任务</span>
<span class="hljs-comment">// 10. readFile - I/O回调阶段</span>
<span class="hljs-comment">// 11. Promise in I/O - 微任务</span>
<span class="hljs-comment">// 12. exit事件 - Close回调阶段</span>
</code></pre>
<h4 data-id="heading-9">Node.js 事件循环的六个阶段</h4>
<ol>
<li><strong>Timers 阶段</strong>：执行 <code>setTimeout</code> 和 <code>setInterval</code> 的回调</li>
<li><strong>I/O Callbacks 阶段</strong>：执行几乎所有的回调（除了close、timer、setImmediate）</li>
<li><strong>Idle/Prepare 阶段</strong>：Node.js 内部使用</li>
<li><strong>Poll 阶段</strong>：
<ul>
<li>检索新的 I/O 事件</li>
<li>执行与 I/O 相关的回调</li>
<li>适当情况下会阻塞在这个阶段</li>
</ul>
</li>
<li><strong>Check 阶段</strong>：执行 <code>setImmediate</code> 的回调</li>
<li><strong>Close Callbacks 阶段</strong>：执行关闭事件的回调，如 <code>socket.on('close')</code></li>
</ol>
<h3 data-id="heading-10">四、 浏览器 vs Node.js：核心差异对比</h3>



































<table><thead><tr><th>特性</th><th>浏览器</th><th>Node.js</th></tr></thead><tbody><tr><td><strong>架构</strong></td><td>相对简单</td><td>复杂的6阶段模型</td></tr><tr><td><strong>微任务优先级</strong></td><td>Promise.then, MutationObserver</td><td><code>process.nextTick</code> &gt; <code>Promise.then</code></td></tr><tr><td><strong>API 差异</strong></td><td><code>requestAnimationFrame</code></td><td><code>setImmediate</code>, <code>process.nextTick</code></td></tr><tr><td><strong>I/O 处理</strong></td><td>有限（主要UI相关）</td><td>完整文件、网络I/O支持</td></tr><tr><td><strong>渲染时机</strong></td><td>每个宏任务之后可能渲染</td><td>无渲染概念</td></tr></tbody></table>
<h3 data-id="heading-11">五、 实战：避免常见的事件循环陷阱</h3>
<h4 data-id="heading-12">陷阱1：阻塞事件循环</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误示例：同步阻塞操作</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculatePrimes</span>(<span class="hljs-params">max</span>) {
  <span class="hljs-keyword">const</span> primes = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">2</span>; i &lt;= max; i++) {
    <span class="hljs-keyword">let</span> isPrime = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">2</span>; j &lt; i; j++) {
      <span class="hljs-keyword">if</span> (i % j === <span class="hljs-number">0</span>) {
        isPrime = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">break</span>;
      }
    }
    <span class="hljs-keyword">if</span> (isPrime) primes.<span class="hljs-title function_">push</span>(i);
  }
  <span class="hljs-keyword">return</span> primes;
}

<span class="hljs-comment">// 这会阻塞整个事件循环</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">calculatePrimes</span>(<span class="hljs-number">1000000</span>));

<span class="hljs-comment">// ✅ 正确示例：使用异步分片</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">calculatePrimesAsync</span>(<span class="hljs-params">max, chunkSize = <span class="hljs-number">1000</span></span>) {
  <span class="hljs-keyword">const</span> primes = [];
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> start = <span class="hljs-number">2</span>; start &lt;= max; start += chunkSize) {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">0</span>));
    
    <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(start + chunkSize, max);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = start; i &lt;= end; i++) {
      <span class="hljs-keyword">let</span> isPrime = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">2</span>; j &lt; i; j++) {
        <span class="hljs-keyword">if</span> (i % j === <span class="hljs-number">0</span>) {
          isPrime = <span class="hljs-literal">false</span>;
          <span class="hljs-keyword">break</span>;
        }
      }
      <span class="hljs-keyword">if</span> (isPrime) primes.<span class="hljs-title function_">push</span>(i);
    }
  }
  
  <span class="hljs-keyword">return</span> primes;
}

<span class="hljs-comment">// 这不会阻塞事件循环</span>
<span class="hljs-title function_">calculatePrimesAsync</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>);
</code></pre>
<h4 data-id="heading-13">陷阱2：微任务无限递归</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 危险：微任务递归会导致阻塞</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">dangerousRecursion</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(dangerousRecursion);
}

<span class="hljs-comment">// ✅ 安全：使用宏任务避免阻塞</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">safeRecursion</span>(<span class="hljs-params"/>) {
  <span class="hljs-built_in">setTimeout</span>(safeRecursion, <span class="hljs-number">0</span>);
}
</code></pre>
<h4 data-id="heading-14">陷阱3：错误的执行顺序假设</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误的顺序假设</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'timeout'</span>), <span class="hljs-number">0</span>);
<span class="hljs-title function_">setImmediate</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'immediate'</span>));

<span class="hljs-comment">// 输出顺序是不确定的！</span>

<span class="hljs-comment">// ✅ 在I/O回调中顺序是确定的</span>
fs.<span class="hljs-title function_">readFile</span>(__filename, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'timeout'</span>), <span class="hljs-number">0</span>);
  <span class="hljs-title function_">setImmediate</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'immediate'</span>)); <span class="hljs-comment">// 这个先执行</span>
});
</code></pre>
<h3 data-id="heading-15">六、 现代开发的最佳实践</h3>
<ol>
<li><strong>CPU 密集型任务</strong>：使用 Web Workers（浏览器）或 Worker Threads（Node.js）</li>
<li><strong>合理使用微任务</strong>：避免微任务队列过长影响响应性</li>
<li><strong>理解执行环境</strong>：区分浏览器和 Node.js 的不同行为</li>
<li><strong>性能监控</strong>：使用 Performance API 监控任务执行时间</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 性能监控示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">monitorPerformance</span>(<span class="hljs-params">taskName, taskFn</span>) {
  <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
  
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">taskFn</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> duration = performance.<span class="hljs-title function_">now</span>() - start;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${taskName}</span> 耗时: <span class="hljs-subst">${duration.toFixed(<span class="hljs-number">2</span>)}</span>ms`</span>);
    <span class="hljs-keyword">return</span> result;
  });
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-title function_">monitorPerformance</span>(<span class="hljs-string">'数据计算'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">calculatePrimes</span>(<span class="hljs-number">10000</span>);
});
</code></pre>
<h3 data-id="heading-16">结语</h3>
<p>事件循环是 JavaScript 并发模型的核心，理解它意味着你真正理解了 JavaScript 的运行时行为。虽然浏览器和 Node.js 的实现有所不同，但其核心理念一致：在单线程中通过事件驱动的方式实现非阻塞 I/O。</p>
<p>对于追求卓越的前端开发者而言，深入掌握事件循环不仅能让你在面试中游刃有余，更能帮助你在实际项目中写出更高效、更健壮的异步代码。下次当你面对复杂的异步流程时，希望你能自信地分析其执行顺序，在事件循环的迷雾中找到清晰的路径。</p>
<p>记住：真正优秀的开发者，不仅知道代码怎么写，更知道代码何时执行、为何这样执行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter 状态管理--InheritedWidget、Provider原理解析]]></title>    <link>https://juejin.cn/post/7576218673049059379</link>    <guid>https://juejin.cn/post/7576218673049059379</guid>    <pubDate>2025-11-25T03:48:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576218673049059379" data-draft-id="7576197969843961882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter 状态管理--InheritedWidget、Provider原理解析"/> <meta itemprop="keywords" content="Flutter,Android,iOS"/> <meta itemprop="datePublished" content="2025-11-25T03:48:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="玲珑Felone"/> <meta itemprop="url" content="https://juejin.cn/user/4476867078523896"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter 状态管理--InheritedWidget、Provider原理解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4476867078523896/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    玲珑Felone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:48:54.000Z" title="Tue Nov 25 2025 03:48:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ul>
<li>
<p>整体流程</p>
<ul>
<li>介绍状态管理的由来、发展历程、用法、源码</li>
<li>最后在不使用三方库的情况下，通过控制器和继承式组件，实现一个Provide</li>
</ul>
</li>
</ul>
<h2 data-id="heading-0"><strong>为什么需要状态管理</strong></h2>
<ul>
<li>官方给的例子里，基础的事件响应是靠点击事件后更新参数，通过setState重新刷新整个页面，</li>
<li>他会重新创建整个widget，调用build方法</li>
<li>但是有些地方没必要更新，这个刷新就会造成一定程度的浪费</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64182e0afe5b42c49a8fcf206b1cf27d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546y54-RRmVsb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647334&amp;x-signature=85UoENu1m1XFg1mQjm%2FyqJ2FN8Q%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c6dcc7c8f7148ec9aff9e1786fd72ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546y54-RRmVsb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647334&amp;x-signature=uws50YeL5GoDnY4edGeevz75%2BeA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>状态管理需要解决几个问题</strong></h2>
<ul>
<li>
<p>问题1：子组件如何访问外部的变量？</p>
<ul>
<li>通过传值</li>
<li>如果嵌套层级过多，就要一层层往下传</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14941e15ffb641368d6fa04296c931a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546y54-RRmVsb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647334&amp;x-signature=YAAGSxLNSheo9862DWUkThVD0f0%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p>问题2：作为一个子组件如何修改外部的变量？</p>
<ul>
<li>通过回传函数callback</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f638f00d1ee48aaac3b20e9d6bfb621~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546y54-RRmVsb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647334&amp;x-signature=O4UnQT0eg5uGtzTzpPN9SzmO9E4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f71cc457dc0242249d480009945715ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546y54-RRmVsb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647334&amp;x-signature=9PxyUco4QYZdQ0QzbYrhYzuvoj8%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p>问题3：A组件如何控制B组件的状态？</p>
<ul>
<li>通过控制器</li>
<li>借助控制器，实现Button对TextField内文字的操作</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c74bf32bd7e473e8b51a48c1aa3d5c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546y54-RRmVsb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647334&amp;x-signature=pD8YeAye0%2BmKvm8AItN26fT0uSE%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 系统的控制器，用来控制文本</span>
<span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">_controller</span> = <span class="hljs-selector-tag">TextEditingController</span>();

@<span class="hljs-selector-tag">override</span>
<span class="hljs-selector-tag">Widget</span> <span class="hljs-selector-tag">build</span>(BuildContext context) {
  <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Scaffold</span>(
    <span class="hljs-attribute">body</span>: <span class="hljs-built_in">Center</span>(
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Column</span>(
        <span class="hljs-attribute">mainAxisAlignment</span>: MainAxisAlignment.center,
        <span class="hljs-attribute">children</span>: &lt;Widget&gt;[
          <span class="hljs-built_in">TextField</span>(
            <span class="hljs-attribute">controller</span>: _controller,
          ),
          <span class="hljs-built_in">ElevatedButton</span>(
            <span class="hljs-attribute">onPressed</span>: () {
              _controller.<span class="hljs-built_in">clear</span>();
            },
            <span class="hljs-attribute">child</span>: const <span class="hljs-built_in">Text</span>(<span class="hljs-string">"clear"</span>),
          ),
        ],
      ),
    ),
  );
}
</code></pre>
<h2 data-id="heading-2"><strong>控制器</strong></h2>
<ul>
<li>
<p><strong>为什么用控制器</strong></p>
<ul>
<li>
<p>不使用控制器的话，</p>
<ul>
<li>如果组件A需要控制组件B中属性，需要将B组件中的属性做状态提升，也就是将B组件中的属性提升到共有父组件</li>
</ul>
</li>
<li>
<p>这样做有三个问题</p>
<ul>
<li>第一，这要求我们对B组件要有完整的掌控能力，也就是说这枚组件的每一行代码都是我们自己写的，换句话说，如果这个组件不是我们自己写的，比如TextField，我们就不能让他把text信息暴露给我们，也就是说如果我们想为别人封装一枚可以独立运行的组件，就不能简单把内部状态提升出去</li>
<li>第二，就算我们将状态提升出去，刷新的时候还是需要通过父组件的setState，这个会导致外面一起重绘</li>
<li>第三，提升出去的属性有时候是基础类型，比如double，我们传递 到子组件的时候直接传递的话其实是值传递，要传递指针的话还需要封装成一个对象</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb10fb529cf340d6a214da4bbaa1b001~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546y54-RRmVsb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647334&amp;x-signature=Z8ekAlCtwX1JvfUIFZdU%2BRKqbCM%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>控制器是什么？手写一个控制器</strong></p>
<ul>
<li>将属性封装成一个ChangeNotifier对象，在set数据的时候调用notifyListeners()</li>
<li>将与属性相关的组件用ListenableBuilder包装起来，listenable参数绑定ChangeNotifier对象</li>
<li>set数据时，notifyListeners会通知到builder去刷新</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">_MyHomePageState</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">State</span>&lt;<span class="hljs-selector-tag">MyHomePage</span>&gt; {
  <span class="hljs-comment">// 自己写的控制器，研究控制器的原理</span>
  <span class="hljs-selector-tag">DoubleHolder</span> <span class="hljs-selector-tag">dh</span> = <span class="hljs-selector-tag">DoubleHolder</span>(<span class="hljs-number">0.3</span>);
  
  @<span class="hljs-selector-tag">override</span>
  <span class="hljs-selector-tag">Widget</span> <span class="hljs-selector-tag">build</span>(BuildContext context) {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Scaffold</span>(
      <span class="hljs-attribute">body</span>: <span class="hljs-built_in">Center</span>(
        <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Column</span>(
          <span class="hljs-attribute">mainAxisAlignment</span>: MainAxisAlignment.center,
          <span class="hljs-attribute">children</span>: &lt;Widget&gt;[
            const <span class="hljs-built_in">Text</span>(
              <span class="hljs-string">'对比系统的控制器，自己写的控制器，研究控制器的原理'</span>,
            ),
            <span class="hljs-built_in">Foo</span>(<span class="hljs-attribute">dh</span>: dh,),
            <span class="hljs-built_in">ElevatedButton</span>(
              <span class="hljs-attribute">onPressed</span>: () {
                dh.value = <span class="hljs-number">1</span>;
              },
              <span class="hljs-attribute">child</span>: const <span class="hljs-built_in">Text</span>(<span class="hljs-string">"设为100"</span>),
            ),
          ],
        ),
      ), 
    );
  }
}
</code></pre>

<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DoubleHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChangeNotifier</span></span>{
  double _value;

  <span class="hljs-type">DoubleHolder</span>(<span class="hljs-keyword">this</span>._value);

  double get value =&gt; _value;

  set value(double newValue){
    _value = newValue;
    notifyListeners();
  }
}
</code></pre>

<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-type">DoubleHolder</span> dh;
  const <span class="hljs-type">Foo</span>({<span class="hljs-keyword">super</span>.key,required <span class="hljs-keyword">this</span>.dh});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">Foo</span>&gt; createState() =&gt; _FooState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_FooState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;Foo&gt;</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Container</span>(
      color: <span class="hljs-type">Colors</span>.red.withOpacity(<span class="hljs-number">0.5</span>),
      child: <span class="hljs-type">ListenableBuilder</span>(
        listenable: widget.dh,
        builder: (context, child) {
          <span class="hljs-keyword">return</span> <span class="hljs-type">Column</span>(
            children: [
              <span class="hljs-type">FlutterLogo</span>(
                size: widget.dh.value * <span class="hljs-number">100</span> + <span class="hljs-number">50</span>,
              ),
              <span class="hljs-type">Slider</span>(
                value: widget.dh.value,
                onChanged: (value) {
                  setState(() {
                    widget.dh.value = value;
                  });
                },
              ),
            ],
          );
        },
      ),
    );
  }
}
</code></pre>
<h2 data-id="heading-3"><strong>继承式组件</strong></h2>
<ul>
<li>
<p>这是上面介绍的几种基础的状态管理方式</p>
</li>
<li>
<p>但是项目中的组件一般都是多层嵌套，如果经过状态提升之后，每次都依赖这种简单的传参的方式，很可能每次创建组件都需要在构造函数里传入大量的参数</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f21800e6a08041149161319359c1e673~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546y54-RRmVsb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647334&amp;x-signature=3LuP7oR94OYpNIEJsLexMqgRQTs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4"><strong>使用</strong></h3>
<ul>
<li>例子：系统现有的继承式组件</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">Widget <span class="hljs-title">build</span><span class="hljs-params">(BuildContext context)</span> </span>{
  MediaQuery.<span class="hljs-built_in">of</span>(context).size;
  <span class="hljs-keyword">return</span> ...;
 }
</code></pre>
<ul>
<li>尝试自己实现一个InheritedWidget</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff598f08a46e4f7eb1882856ace6479c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546y54-RRmVsb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647334&amp;x-signature=ecSNhiMKwMNm85QpNeSxkXdIgRg%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p>实现前先提一个问题：</p>
<ul>
<li>假设上面的红色方块是一个const的组件，在外面的按钮上调用setState，红色方块会不会刷新？</li>
<li>如果这个颜色是引用的InheritedWidget里的属性呢？</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 自定义一个</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyColor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">InheritedWidget</span> </span>{
  <span class="hljs-keyword">final</span> Color color;
  <span class="hljs-keyword">const</span> MyColor({<span class="hljs-keyword">required</span> <span class="hljs-keyword">super</span>.child,<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.color});

<span class="hljs-comment">// 核心方法</span>
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">bool</span> updateShouldNotify(<span class="hljs-keyword">covariant</span> MyColor oldWidget) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'updateShouldNotify；<span class="hljs-subst">${oldWidget.color}</span> -&gt; <span class="hljs-subst">$color</span>'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
  }

  <span class="hljs-keyword">static</span> MyColor? maybeOf(BuildContext context){
    <span class="hljs-keyword">return</span> context.dependOnInheritedWidgetOfExactType&lt;MyColor&gt;();
  }

  <span class="hljs-keyword">static</span> MyColor of(BuildContext context){
    <span class="hljs-keyword">return</span> context.dependOnInheritedWidgetOfExactType&lt;MyColor&gt;()!;
  }

}
</code></pre>
<ul>
<li>顶层加个MyColor（继承）</li>
</ul>

<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyHomePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  const <span class="hljs-type">MyHomePage</span>({<span class="hljs-keyword">super</span>.key});
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">MyHomePage</span>&gt; createState() =&gt; _MyHomePageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyHomePageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;MyHomePage&gt;</span> </span>{
  <span class="hljs-type">Color</span> _color = <span class="hljs-type">Colors</span>.red;

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">MyColor</span>(
      color: _color,
      child: <span class="hljs-type">Scaffold</span>(
        body: <span class="hljs-type">Center</span>(
            child: const <span class="hljs-type">Foo</span>()
        ),
        floatingActionButton: <span class="hljs-type">FloatingActionButton</span>(
          onPressed: () {
            setState(() {
              _color = <span class="hljs-type">Colors</span>.black;
            });
          },
        ),
      ),
    );
  }
}
</code></pre>
<ul>
<li>底层调用</li>
</ul>

<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  const <span class="hljs-type">Foo</span>({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Container</span>(
      width: <span class="hljs-number">100</span>,
      height: <span class="hljs-number">100</span>,
      color: <span class="hljs-type">MyColor</span>.of(context).color,
    );
  }
}
</code></pre>
<ul>
<li>结果</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff980cac4b154e57a932a23782eca41e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546y54-RRmVsb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647334&amp;x-signature=yPH6ovTJ0Du4mYZq4FjFY8F0X4U%3D" alt="Untitled.gif" loading="lazy"/></p>
<h3 data-id="heading-5"><strong>原理</strong></h3>
<ul>
<li>本质就是全局维护一个Map，对map进行存入、读取。</li>
<li>每个value（InheritedElement）有自己的更新操作，他绑定了关联的widget</li>
<li>当 InheritedWidget 更新时，先比对数据，数据改变会通知所有依赖它的 Widget 重建</li>
</ul>
<h4 data-id="heading-6"><strong>Map的创建和存入</strong></h4>
<ul>
<li>自定义一个InheritedWidget</li>
</ul>

<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyColor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">InheritedWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-type">Color</span> color;
  const <span class="hljs-type">MyColor</span>({required <span class="hljs-keyword">super</span>.child,required <span class="hljs-keyword">this</span>.color});
  
  <span class="hljs-meta">@override</span>
  bool updateShouldNotify(covariant <span class="hljs-type">MyColor</span> oldWidget) {
     <span class="hljs-keyword">return</span> oldWidget.color != color;
  }
}

<span class="hljs-comment">// 使用，最外层包一个</span>
<span class="hljs-meta">@override</span>
<span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
  <span class="hljs-keyword">return</span> <span class="hljs-type">MyColor</span>(
    color: _color,
    child: <span class="hljs-type">Scaffold</span>(...),
    );
}
</code></pre>
<ul>
<li>渲染三棵树时构建出共有Map</li>
</ul>

<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InheritedElement</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ProxyElement</span> </span>{
    
<span class="hljs-keyword">void</span> mount(<span class="hljs-built_in">Element?</span> parent, <span class="hljs-built_in">Object?</span> newSlot) {
  <span class="hljs-comment">// 节点激活时调用</span>
  _updateInheritance();
  ...
}
<span class="hljs-keyword">void</span> activate() {
    <span class="hljs-comment">// 脏节点回收时</span>
  _updateInheritance();
}

<span class="hljs-comment">// 每个Element里面都共有一个map的引用，从父类那里获取</span>
<span class="hljs-comment">//持久化哈希映射:是一种不可变的数据结构,当修改数据时，不会改变原实例，而是创建一个包含修改的新实例，同时尽可能复用原实例的未变部分，</span>
PersistentHashMap&lt;<span class="hljs-built_in">Type</span>, InheritedElement&gt;? _inheritedElements;

<span class="hljs-comment">// 存入的方法，在mount和activate时调用</span>
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> _updateInheritance() {
    <span class="hljs-keyword">assert</span>(_lifecycleState == _ElementLifecycle.active);
    <span class="hljs-comment">// 获取父类的_inheritedElements</span>
    <span class="hljs-keyword">final</span> PersistentHashMap&lt;<span class="hljs-built_in">Type</span>, InheritedElement&gt; incomingWidgets =
        _parent?._inheritedElements ?? <span class="hljs-keyword">const</span> PersistentHashMap&lt;<span class="hljs-built_in">Type</span>, InheritedElement&gt;.empty();
        <span class="hljs-comment">// 存入当前InheritedElement，key是类型，value是本体</span>
    _inheritedElements = incomingWidgets.put(widget.runtimeType, <span class="hljs-keyword">this</span>);
  }
}
</code></pre>
<h4 data-id="heading-7"><strong>Map的读取以及widget绑定过程</strong></h4>
<ul>
<li>一般使用InheritedWidget</li>
</ul>

<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_FooState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;Foo&gt;</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Container</span>(
      width: <span class="hljs-number">100</span>,
      height: <span class="hljs-number">100</span>,
      color: <span class="hljs-type">MyColor</span>.of(context).color,
    );
  }
  
static <span class="hljs-type">MyColor</span> of(<span class="hljs-type">BuildContext</span> context){
   <span class="hljs-keyword">return</span> context.dependOnInheritedWidgetOfExactType&lt;<span class="hljs-type">MyColor</span>&gt;()!;
}
</code></pre>
<ul>
<li>实际上干的事情</li>
</ul>

<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Element</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DiagnosticableTree</span> <span class="hljs-title">implements</span> <span class="hljs-title">BuildContext</span> </span>{
<span class="hljs-type">PersistentHashMap</span>&lt;<span class="hljs-type">Type</span>, <span class="hljs-type">InheritedElement</span>&gt;? _inheritedElements;

<span class="hljs-comment">// 读取以及绑定</span>
<span class="hljs-meta">@override</span>
<span class="hljs-type">T</span>? dependOnInheritedWidgetOfExactType&lt;<span class="hljs-type">T</span> <span class="hljs-keyword">extends</span> <span class="hljs-type">InheritedWidget</span>&gt;({<span class="hljs-type">Object</span>? aspect}) {
    <span class="hljs-comment">// 向上找，有没有存入过这个类型的InheritedElement</span>
  <span class="hljs-keyword">final</span> <span class="hljs-type">InheritedElement</span>? ancestor = _inheritedElements == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : _inheritedElements![<span class="hljs-type">T</span>];
  <span class="hljs-keyword">if</span> (ancestor != <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 匹配的InheritedElement不为空，就建立依赖关系</span>
      <span class="hljs-comment">// 当 InheritedWidget 数据更新时，框架会通知所有依赖它的 Widget 重建</span>
    <span class="hljs-keyword">return</span> dependOnInheritedElement(ancestor, aspect: aspect) as <span class="hljs-type">T</span>;
  }
  _hadUnsatisfiedDependencies = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
<span class="hljs-meta">@override</span>
<span class="hljs-type">InheritedWidget</span> dependOnInheritedElement(<span class="hljs-type">InheritedElement</span> ancestor, { <span class="hljs-type">Object</span>? aspect }) {
  _dependencies ??= <span class="hljs-type">HashSet</span>&lt;<span class="hljs-type">InheritedElement</span>&gt;();
  _dependencies!.add(ancestor);
  <span class="hljs-comment">// 将当前 Element-&gt;this 加入 InheritedElement-&gt;ancestor 的依赖列表</span>
  ancestor.updateDependencies(<span class="hljs-keyword">this</span>, aspect);
  <span class="hljs-keyword">return</span> ancestor.widget as <span class="hljs-type">InheritedWidget</span>;
}
</code></pre>

<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InheritedElement</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ProxyElement</span> </span>{
<span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">Element</span>, <span class="hljs-built_in">Object?</span>&gt; _dependents = HashMap&lt;<span class="hljs-built_in">Element</span>, <span class="hljs-built_in">Object?</span>&gt;();
<span class="hljs-meta">@protected</span>
<span class="hljs-keyword">void</span> updateDependencies(<span class="hljs-built_in">Element</span> dependent, <span class="hljs-built_in">Object?</span> aspect) {
  setDependencies(dependent, <span class="hljs-keyword">null</span>);
}

<span class="hljs-meta">@protected</span>
<span class="hljs-keyword">void</span> setDependencies(<span class="hljs-built_in">Element</span> dependent, <span class="hljs-built_in">Object?</span> value) {
  _dependents[dependent] = value;
}
</code></pre>
<h4 data-id="heading-8"><strong>InheritedWidget 更新时，通知所有依赖它的 Widget 重建</strong></h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Color</span> <span class="hljs-selector-tag">_color</span> = <span class="hljs-selector-tag">Colors</span><span class="hljs-selector-class">.red</span>;

@<span class="hljs-selector-tag">override</span>
<span class="hljs-selector-tag">Widget</span> <span class="hljs-selector-tag">build</span>(BuildContext context) {
  <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">MyColor</span>(
    <span class="hljs-attribute">color</span>: _color,
    <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Scaffold</span>(
      <span class="hljs-attribute">body</span>: <span class="hljs-built_in">Center</span>(
        <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Column</span>(
          <span class="hljs-attribute">mainAxisAlignment</span>: MainAxisAlignment.center,
          <span class="hljs-attribute">children</span>: &lt;Widget&gt;[
            const <span class="hljs-built_in">Foo</span>(),
          ],
        ),
      ),
      <span class="hljs-attribute">floatingActionButton</span>: <span class="hljs-built_in">FloatingActionButton</span>(
        <span class="hljs-attribute">onPressed</span>: (){
          <span class="hljs-built_in">setState</span>(() {
            _<span class="hljs-attribute">color</span> = Colors.black;
          });
        },
      ), 
    ),
  );
}
</code></pre>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 更新</span>
<span class="hljs-keyword">@override</span>
void updated(InheritedWidget oldWidget) {
  if ((widget as InheritedWidget)<span class="hljs-selector-class">.updateShouldNotify</span>(oldWidget)) {
    super<span class="hljs-selector-class">.updated</span>(oldWidget);
  }
}
  <span class="hljs-keyword">@override</span>
  void <span class="hljs-attribute">update</span>(InheritedWidget newWidget) {
    final oldWidget = widget;
    super<span class="hljs-selector-class">.update</span>(newWidget);
    <span class="hljs-comment">// 若需要通知依赖者（updateShouldNotify 返回 true）</span>
    if (widget.updateShouldNotify(oldWidget)) {
      <span class="hljs-built_in">notifyClients</span>(oldWidget);
    }
  }

  <span class="hljs-comment">// 通知所有依赖的 Element 重建</span>
  <span class="hljs-keyword">@protected</span>
  void notifyClients(covariant InheritedWidget oldWidget) {
    <span class="hljs-comment">// 遍历所有依赖的 Element</span>
    for (final Element dependent in _dependents.keys) {
      <span class="hljs-comment">// 检查依赖是否有效</span>
      if (dependent._active) {
        <span class="hljs-comment">// 标记依赖的 Element 为脏节点，并调度重建</span>
        dependent<span class="hljs-selector-class">.markNeedsBuild</span>();
      }
    }
  }
</code></pre>
<h2 data-id="heading-9"><strong>Provider</strong></h2>
<h3 data-id="heading-10"><strong>使用：</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24c86ceccc724cf5a126cbc2b30ed34d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546y54-RRmVsb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647334&amp;x-signature=bRYT2yeLcfqOu1UO6dDhU03nfDk%3D" alt="provide.gif" loading="lazy"/></p>
<ul>
<li>外层包一个ChangeNotifierProvider</li>
<li>传一个LogoModel构建方法</li>
<li>内部组件可以直接通过 watch绑定 LogoModel数据</li>
</ul>

<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  const <span class="hljs-type">MyApp</span>({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">ChangeNotifierProvider</span>(
      create: (context) =&gt; <span class="hljs-type">LogoModel</span>(),
      child: const <span class="hljs-type">MaterialApp</span>(
        title: '<span class="hljs-type">Flutter</span> <span class="hljs-type">Demo</span>',
        home: <span class="hljs-type">MyHomePage</span>(),
      ),
    );
  }
}
</code></pre>

<pre><code class="hljs language-ini" lang="ini">class LogoModel extends ChangeNotifier{
  bool <span class="hljs-attr">_flipX</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  bool <span class="hljs-attr">_flipY</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  double <span class="hljs-attr">_size</span> = <span class="hljs-number">200.0</span><span class="hljs-comment">;</span>

  bool get <span class="hljs-attr">flipX</span> =&gt; _flipX<span class="hljs-comment">;</span>

  set flipX(bool value) {
    <span class="hljs-attr">_flipX</span> = value<span class="hljs-comment">;</span>
    notifyListeners()<span class="hljs-comment">;</span>
  }

  bool get <span class="hljs-attr">flipY</span> =&gt; _flipY<span class="hljs-comment">;</span>

  set flipY(bool value) {
    <span class="hljs-attr">_flipY</span> = value<span class="hljs-comment">;</span>
    notifyListeners()<span class="hljs-comment">;</span>
  }

  double get <span class="hljs-attr">size</span> =&gt; _size<span class="hljs-comment">;</span>

  set size(double value) {
    <span class="hljs-attr">_size</span> = value<span class="hljs-comment">;</span>
    notifyListeners()<span class="hljs-comment">;</span>
  }
}
</code></pre>

<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyHomePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  const <span class="hljs-type">MyHomePage</span>({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> const <span class="hljs-type">Scaffold</span>(
      body: <span class="hljs-type">Center</span>(
        child: <span class="hljs-type">Column</span>(
          mainAxisAlignment: <span class="hljs-type">MainAxisAlignment</span>.center,
          children: &lt;<span class="hljs-type">Widget</span>&gt;[
            <span class="hljs-type">Logo</span>(),
            <span class="hljs-type">ControlPanel</span>(),
          ],
        ),
      ), <span class="hljs-comment">// This trailing comma makes auto-formatting nicer for build methods.</span>
    );
  }
}
</code></pre>

<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  const <span class="hljs-type">Logo</span>({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">final</span> model = context.watch&lt;<span class="hljs-type">LogoModel</span>&gt;();
    <span class="hljs-keyword">return</span> <span class="hljs-type">Card</span>(
      child: <span class="hljs-type">Transform</span>.flip(
        flipX: model.flipX,
        flipY: model.flipY,
        child: <span class="hljs-type">FlutterLogo</span>(
          size: model.size,
        ),
      ),
    );
  }
}
</code></pre>

<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">ControlPanel</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">StatelessWidget</span> {
  <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">ControlPanel</span>({<span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.key</span>});

  @<span class="hljs-selector-tag">override</span>
  <span class="hljs-selector-tag">Widget</span> <span class="hljs-selector-tag">build</span>(BuildContext context) {
    <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">model</span> = <span class="hljs-selector-tag">context</span><span class="hljs-selector-class">.watch</span>&lt;<span class="hljs-selector-tag">LogoModel</span>&gt;();
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Card</span>(
      <span class="hljs-attribute">margin</span>: const EdgeInsets.<span class="hljs-built_in">all</span>(<span class="hljs-number">32</span>),
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Padding</span>(
        <span class="hljs-attribute">padding</span>: const EdgeInsets.<span class="hljs-built_in">all</span>(<span class="hljs-number">16</span>),
        <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Column</span>(
          <span class="hljs-attribute">children</span>: [
            <span class="hljs-built_in">Row</span>(
              <span class="hljs-attribute">mainAxisAlignment</span>: MainAxisAlignment.center,
              <span class="hljs-attribute">children</span>: [
                const <span class="hljs-built_in">Text</span>(<span class="hljs-string">'flip X：'</span>),
                <span class="hljs-built_in">Switch</span>(
                    <span class="hljs-attribute">value</span>: model.flipX,
                    <span class="hljs-attribute">onChanged</span>: (value) {
                      model.flipX = value;
                    }),
                const <span class="hljs-built_in">Text</span>(<span class="hljs-string">'flip y：'</span>),
                <span class="hljs-built_in">Switch</span>(
                    <span class="hljs-attribute">value</span>: model.flipY,
                    <span class="hljs-attribute">onChanged</span>: (value) {
                      model.flipY = value;
                    }),
              ],
            ),
            <span class="hljs-built_in">Row</span>(
              <span class="hljs-attribute">mainAxisAlignment</span>: MainAxisAlignment.center,
              <span class="hljs-attribute">children</span>: [
                const <span class="hljs-built_in">Text</span>(<span class="hljs-string">'size：'</span>),
                <span class="hljs-built_in">Slider</span>(
                    <span class="hljs-attribute">min</span>: <span class="hljs-number">50</span>,
                    <span class="hljs-attribute">max</span>: <span class="hljs-number">300</span>,
                    <span class="hljs-attribute">value</span>: model.size,
                    <span class="hljs-attribute">onChanged</span>: (value) {
                      model.size = value;
                    }),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<h2 data-id="heading-11"><strong>如何在不使用三方库的情况下，手写一个Provide</strong></h2>
<h3 data-id="heading-12"><strong>原理：</strong></h3>
<ul>
<li>主要就是用到控制器和继承式组件</li>
</ul>

<ul>
<li>
<p>数据和我们自己写的布局都是作为参数传递进入的</p>
</li>
<li>
<p>读的过程通过InheritedWidget向上查找数据</p>
</li>
<li>
<p>修改数据后，通过ListenableBuilder刷新他子类，也就是InheritedWidget</p>
</li>
<li>
<p>InheritedWidget刷新时，为什么不会导致我们的布局刷新？</p>
<ul>
<li>因为他是外层传进去的参数，他其实存在最外层stateful里面，而ListenableBuilder刷新不会导致最外层stateful刷新</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14f2962244aa4a088cd8b0b4944f974a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546y54-RRmVsb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647334&amp;x-signature=C6mkTiQLuuaM7KHafiURa0jVtYw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/880e891984864c7b9bd18e4d62a51a39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546y54-RRmVsb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647334&amp;x-signature=AKd6MZ7zqHiVTqdXEQO2ePd7fTs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13"><strong>代码</strong></h3>
<pre><code class="hljs language-scala" lang="scala">void main() {
  runApp(const <span class="hljs-type">MyApp</span>());
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  const <span class="hljs-type">MyApp</span>({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">MyChangeNotifierProvider</span>(
      create: () =&gt; <span class="hljs-type">LogoModel</span>(),
      child: const <span class="hljs-type">MaterialApp</span>(
        title: '<span class="hljs-type">Flutter</span> <span class="hljs-type">Demo</span>',
        home: <span class="hljs-type">MyHomePage</span>(),
      ),
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogoModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChangeNotifier</span> </span>{
  bool _flipX = <span class="hljs-literal">false</span>;
  bool _flipY = <span class="hljs-literal">false</span>;
  double _size = <span class="hljs-number">200.0</span>;

  bool get flipX =&gt; _flipX;

  set flipX(bool value) {
    _flipX = value;
    notifyListeners();
  }

  bool get flipY =&gt; _flipY;

  set flipY(bool value) {
    _flipY = value;
    notifyListeners();
  }

  double get size =&gt; _size;

  set size(double value) {
    _size = value;
    notifyListeners();
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyChangeNotifierProvider&lt;T</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Listenable&gt;</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-type">Widget</span> child;
  <span class="hljs-keyword">final</span> <span class="hljs-type">T</span> <span class="hljs-type">Function</span>() create;

  const <span class="hljs-type">MyChangeNotifierProvider</span>(
      {<span class="hljs-keyword">super</span>.key, required <span class="hljs-keyword">this</span>.child, required <span class="hljs-keyword">this</span>.create});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">MyChangeNotifierProvider</span>&gt; createState() =&gt;
      _MyChangeNotifierProviderState&lt;<span class="hljs-type">T</span>&gt;();

  static <span class="hljs-type">T</span> of&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-type">BuildContext</span> context, {required bool listen}) {
    <span class="hljs-keyword">if</span> (listen) {
      <span class="hljs-keyword">return</span> context
          .dependOnInheritedWidgetOfExactType&lt;_MyInheritedWidget&lt;<span class="hljs-type">T</span>&gt;&gt;()!
          .model;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> context
          .getInheritedWidgetOfExactType&lt;_MyInheritedWidget&lt;<span class="hljs-type">T</span>&gt;&gt;()!
          .model;
    }
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyChangeNotifierProviderState&lt;T</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Listenable&gt;</span></span>
    <span class="hljs-keyword">extends</span> <span class="hljs-type">State</span>&lt;<span class="hljs-type">MyChangeNotifierProvider</span>&lt;<span class="hljs-type">T</span>&gt;&gt; {
  late <span class="hljs-type">T</span> model;

  <span class="hljs-meta">@override</span>
  void initState() {
    <span class="hljs-keyword">super</span>.initState();
    model = widget.create();
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">ListenableBuilder</span>(
        listenable: model,
        builder: (<span class="hljs-type">BuildContext</span> context, <span class="hljs-type">Widget</span>? child) {
          <span class="hljs-comment">// child是外面传进来的，所以重建的时候不会rebuild</span>
          <span class="hljs-keyword">return</span> _MyInheritedWidget(model: model, child: widget.child);
        });
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyInheritedWidget&lt;T&gt;</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">InheritedWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-type">T</span> model;

  const _MyInheritedWidget({required <span class="hljs-keyword">super</span>.child, required <span class="hljs-keyword">this</span>.model});

  <span class="hljs-meta">@override</span>
  bool updateShouldNotify(covariant <span class="hljs-type">InheritedWidget</span> oldWidget) {
    print(<span class="hljs-string">"======updateShouldNotify"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
}

<span class="hljs-comment">// 扩展BuildContext</span>
extension <span class="hljs-type">Consumer</span> on <span class="hljs-type">BuildContext</span> {
  <span class="hljs-comment">// 绑定</span>
  <span class="hljs-type">T</span> watch&lt;<span class="hljs-type">T</span>&gt;() =&gt; <span class="hljs-type">MyChangeNotifierProvider</span>.of(<span class="hljs-keyword">this</span>, listen: <span class="hljs-literal">true</span>);
  <span class="hljs-comment">// 只读一次</span>
  <span class="hljs-type">T</span> read&lt;<span class="hljs-type">T</span>&gt;() =&gt; <span class="hljs-type">MyChangeNotifierProvider</span>.of(<span class="hljs-keyword">this</span>, listen: <span class="hljs-literal">false</span>);
}
</code></pre>
<ul>
<li>使用</li>
</ul>

<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyHomePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  const <span class="hljs-type">MyHomePage</span>({<span class="hljs-keyword">super</span>.key});
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> const <span class="hljs-type">Scaffold</span>(
      body: <span class="hljs-type">Center</span>(
        child: <span class="hljs-type">Column</span>(
          mainAxisAlignment: <span class="hljs-type">MainAxisAlignment</span>.center,
          children: &lt;<span class="hljs-type">Widget</span>&gt;[
            <span class="hljs-type">Logo</span>(),
            <span class="hljs-type">ControlPanel</span>(),
          ],
        ),
      ),
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  const <span class="hljs-type">Logo</span>({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">var</span> model =
        <span class="hljs-type">Consumer</span>(context).watch&lt;<span class="hljs-type">LogoModel</span>&gt;();
    <span class="hljs-keyword">return</span> <span class="hljs-type">Card</span>(
      child: <span class="hljs-type">Transform</span>.flip(
        flipX: model.flipX,
        flipY: model.flipY,
        child: <span class="hljs-type">FlutterLogo</span>(
          size: model.size,
        ),
      ),
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ControlPanel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  const <span class="hljs-type">ControlPanel</span>({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">ControlPanel</span>&gt; createState() =&gt; _ControlPanelState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_ControlPanelState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;ControlPanel&gt;</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">var</span> model =
        <span class="hljs-type">Consumer</span>(context).watch&lt;<span class="hljs-type">LogoModel</span>&gt;();
    <span class="hljs-keyword">return</span> <span class="hljs-type">Card</span>(
      margin: const <span class="hljs-type">EdgeInsets</span>.all(<span class="hljs-number">32</span>),
      child: <span class="hljs-type">Padding</span>(
        padding: const <span class="hljs-type">EdgeInsets</span>.all(<span class="hljs-number">16</span>),
        child: <span class="hljs-type">Column</span>(
          children: [
            <span class="hljs-type">Row</span>(
              mainAxisAlignment: <span class="hljs-type">MainAxisAlignment</span>.center,
              children: [
                const <span class="hljs-type">Text</span>('flip <span class="hljs-type">X</span>：'),
                <span class="hljs-type">Switch</span>(
                    value: model.flipX,
                    onChanged: (value) {
                      model.flipX = value;
                    }),
                const <span class="hljs-type">Text</span>('flip y：'),
                <span class="hljs-type">Switch</span>(
                    value: model.flipY,
                    onChanged: (value) {
                      model.flipY = value;
                    }),
              ],
            ),
            <span class="hljs-type">Row</span>(
              mainAxisAlignment: <span class="hljs-type">MainAxisAlignment</span>.center,
              children: [
                const <span class="hljs-type">Text</span>('size：'),
                <span class="hljs-type">Slider</span>(
                    min: <span class="hljs-number">50</span>,
                    max: <span class="hljs-number">300</span>,
                    value: model.size,
                    onChanged: (value) {
                      model.size = value;
                    }),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[车载应用配置系统签名]]></title>    <link>https://juejin.cn/post/7576228981230698523</link>    <guid>https://juejin.cn/post/7576228981230698523</guid>    <pubDate>2025-11-25T03:58:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576228981230698523" data-draft-id="7576165316252139529" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="车载应用配置系统签名"/> <meta itemprop="keywords" content="Android,Android Studio"/> <meta itemprop="datePublished" content="2025-11-25T03:58:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BoomHe"/> <meta itemprop="url" content="https://juejin.cn/user/1513407128012333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            车载应用配置系统签名
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1513407128012333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BoomHe
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:58:12.000Z" title="Tue Nov 25 2025 03:58:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">车载应用配置系统签名</h3>
<p>在配置系统签名时，核心是在 <code>android</code> 闭包下的 <code>signingConfigs</code> 中定义签名信息，并在 <code>buildTypes</code> 中引用它</p>
<p>假设你的签名文件名为 <code>system_signature.jks</code>，并且你已经将其放在了 <strong>App 模块的根目录下</strong>（即与 <code>build.gradle</code> 同级）。</p>
<p>以下是两种构建脚本语言的详细配置方式：</p>
<h3 data-id="heading-1">1. Groovy (<code>build.gradle</code>)</h3>
<p>这是传统 Android 项目最常用的格式。</p>
<pre><code class="hljs language-java" lang="java">android {
    <span class="hljs-comment">// ... 其他配置</span>

    <span class="hljs-comment">// 1. 配置签名信息</span>
    signingConfigs {
        <span class="hljs-comment">// 定义一个名为 system 的签名配置（名字可以自定义，如 release）</span>
        system {
            storeFile <span class="hljs-title function_">file</span><span class="hljs-params">(<span class="hljs-string">"platform.jks"</span>)</span>      <span class="hljs-comment">// 如果在 app 目录下直接写文件名</span>
            storePassword <span class="hljs-string">"你的keystore密码"</span>     <span class="hljs-comment">// 例如：android</span>
            keyAlias <span class="hljs-string">"你的别名"</span>                  <span class="hljs-comment">// 例如：androiddebugkey 或 platform</span>
            keyPassword <span class="hljs-string">"你的别名密码"</span>            <span class="hljs-comment">// 例如：android</span>

            <span class="hljs-comment">// 强制开启 v1 和 v2 签名（通常车载系统为了兼容性建议都开启）</span>
            v1SigningEnabled <span class="hljs-literal">true</span>
            v2SigningEnabled <span class="hljs-literal">true</span>
        }
    }

    <span class="hljs-comment">// 2. 在构建类型中应用签名</span>
    buildTypes {
        release {
            <span class="hljs-comment">// 引用上面定义的 'system' 签名配置</span>
            signingConfig signingConfigs.system
            minifyEnabled <span class="hljs-literal">false</span>
            proguardFiles <span class="hljs-title function_">getDefaultProguardFile</span><span class="hljs-params">(<span class="hljs-string">'proguard-android-optimize.txt'</span>)</span>, <span class="hljs-string">'proguard-rules.pro'</span>
        }

        debug {
            <span class="hljs-comment">// 方便调试：让 debug 包也拥有系统签名，这样可以直接 Run 到车机上</span>
            signingConfig signingConfigs.system
        }
    }
}
</code></pre>
<h3 data-id="heading-2">2. Kotlin DSL (<code>build.gradle.kts</code>)</h3>
<p>如果你使用的是较新的 Android Studio 模版，通常默认为 KTS 格式。</p>
<pre><code class="hljs language-ini" lang="ini">android {
    // ... 其他配置

    // 1. 配置签名信息
    signingConfigs {
        // 创建一个名为 "system" 的配置
        create("system") {
            <span class="hljs-attr">storeFile</span> = file(<span class="hljs-string">"platform.jks"</span>)
            <span class="hljs-attr">storePassword</span> = <span class="hljs-string">"你的keystore密码"</span>
            <span class="hljs-attr">keyAlias</span> = <span class="hljs-string">"你的别名"</span>
            <span class="hljs-attr">keyPassword</span> = <span class="hljs-string">"你的别名密码"</span>

            <span class="hljs-attr">enableV1Signing</span> = <span class="hljs-literal">true</span>
            <span class="hljs-attr">enableV2Signing</span> = <span class="hljs-literal">true</span>
        }
    }

    // 2. 在构建类型中应用签名
    buildTypes {
        getByName("release") {
            // 引用名为 "system" 的签名配置
            <span class="hljs-attr">signingConfig</span> = signingConfigs.getByName(<span class="hljs-string">"system"</span>)
            <span class="hljs-attr">isMinifyEnabled</span> = <span class="hljs-literal">false</span>
            proguardFiles(getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro")
        }

        getByName("debug") {
            // 同样给 debug 包配置系统签名
            <span class="hljs-attr">signingConfig</span> = signingConfigs.getByName(<span class="hljs-string">"system"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-3">关键注意事项</h3>
<h4 data-id="heading-4">1. Manifest 声明 (Android 10 (API 29) 开始弃用 <code>sharedUserId</code>)</h4>
<p>既然配置了系统签名，你的应用通常需要声明自己是系统用户。请确保你的 <code>AndroidManifest.xml</code> 的 <code>&lt;manifest&gt;</code> 根节点中包含：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;manifest xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">package</span>=<span class="hljs-string">"com.your.package.name"</span>
    android:<span class="hljs-attr">sharedUserId</span>=<span class="hljs-string">"android.uid.system"</span>&gt; 
</code></pre>
<p>如果不加这句，即便签名正确，你也拿不到系统权限；且如果系统里已有相同 uid 的应用，安装时会报 <code>INSTALL_FAILED_SHARED_USER_INCOMPATIBLE</code>。</p>
<h3 data-id="heading-5">2. 动态配置签名信息</h3>
<ol>
<li>在项目根目录 <code>local.properties</code> 添加：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">SYSTEM_KEY_PATH</span>=keys/platform.jks
<span class="hljs-attr">SYSTEM_KEY_PASSWORD</span>=platform
<span class="hljs-attr">SYSTEM_KEY_ALIAS</span>=platform
<span class="hljs-attr">SYSTEM_ALIAS_PASSWORD</span>=platform
</code></pre>
<ol start="2">
<li>修改 <code>build.gradle</code> 读取这些值</li>
</ol>
<pre><code class="hljs language-vbscript" lang="vbscript">
    android {
        signingConfigs {
         create(<span class="hljs-string">"system"</span>) {
            // 从 gradle.properties 中读取文件路径和密码
            storeFile = file(project.rootDir.absolutePath + <span class="hljs-string">"/app/"</span> + project.<span class="hljs-keyword">property</span>(<span class="hljs-string">"SYSTEM_STORE_FILE"</span>).<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>())
            storePassword = project.<span class="hljs-keyword">property</span>(<span class="hljs-string">"SYSTEM_STORE_PASSWORD"</span>).<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>()
            keyAlias = project.<span class="hljs-keyword">property</span>(<span class="hljs-string">"SYSTEM_KEY_ALIAS"</span>).<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>()
            keyPassword = project.<span class="hljs-keyword">property</span>(<span class="hljs-string">"SYSTEM_KEY_PASSWORD"</span>).<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>()
            }
        }
        // ...
    }
</code></pre>
<ol start="3">
<li>验证签名，打包完成后，你可以使用 <code>apksigner</code> 验证签名是否生效</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">apksigner verify -v --print-certs your_app.apk
</code></pre>
<p>验证信息</p>
<pre><code class="hljs language-csharp" lang="csharp">C:\Users\ZQ\AppData\Local\Android\Sdk\build-tools\<span class="hljs-number">34.0</span><span class="hljs-number">.0</span>&gt;apksigner verify -v --print-certs C:\ZQ\change_system_sign\VwCopilotLauncher.<span class="hljs-function">apk
Verifies
Verified <span class="hljs-keyword">using</span> v1 <span class="hljs-title">scheme</span> (<span class="hljs-params">JAR signing</span>): <span class="hljs-literal">false</span>
Verified <span class="hljs-keyword">using</span> v2 <span class="hljs-title">scheme</span> (<span class="hljs-params">APK Signature Scheme v2</span>): <span class="hljs-literal">false</span>
Verified <span class="hljs-keyword">using</span> v3 <span class="hljs-title">scheme</span> (<span class="hljs-params">APK Signature Scheme v3</span>): <span class="hljs-literal">true</span>
Verified <span class="hljs-keyword">using</span> v3.1 <span class="hljs-title">scheme</span> (<span class="hljs-params">APK Signature Scheme v3<span class="hljs-number">.1</span></span>): <span class="hljs-literal">false</span>
Verified <span class="hljs-keyword">using</span> v4 <span class="hljs-title">scheme</span> (<span class="hljs-params">APK Signature Scheme v4</span>): <span class="hljs-literal">false</span>
Verified <span class="hljs-keyword">for</span> SourceStamp: <span class="hljs-literal">false</span>
Number of signers: 1
Signer #1 certificate DN: EMAILADDRESS</span>=seqc.zcdev@seres.cn, CN=Seres, OU=Seres, O=Seres, L=Chengdu View, ST=SiChuan, C=ZH
Signer <span class="hljs-meta">#1 certificate SHA-256 digest: f4e8fbc3b6c23a000639e3df8f1b4be1ed153436e638f7bdc65598f9d0d3c7e8</span>
Signer <span class="hljs-meta">#1 certificate SHA-1 digest: 816003d74e06bad2bab5f440801ed9ce2f75b89e</span>
Signer <span class="hljs-meta">#1 certificate MD5 digest: 907c255625cb183c7906de565522b446</span>
Signer <span class="hljs-meta">#1 key algorithm: RSA</span>
Signer <span class="hljs-meta">#1 key size (bits): 2048</span>
Signer <span class="hljs-meta">#1 public key SHA-256 digest: 7c51217f508f3c11341e5e025e7dc6c8eb103f1e850a6000433b8ae9cda3915b</span>
Signer <span class="hljs-meta">#1 public key SHA-1 digest: 5c09f551e8f356d979d7da239fd65857fc84d330</span>
Signer <span class="hljs-meta">#1 public key MD5 digest: e278637218a2bdfcac56bd279ac80dee</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通过Amazon Q CLI 集成DynamoDB MCP 实现游戏场景智能数据建模]]></title>    <link>https://juejin.cn/post/7576236480114262066</link>    <guid>https://juejin.cn/post/7576236480114262066</guid>    <pubDate>2025-11-25T04:38:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576236480114262066" data-draft-id="7576098886860832811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通过Amazon Q CLI 集成DynamoDB MCP  实现游戏场景智能数据建模"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-25T04:38:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通过Amazon Q CLI 集成DynamoDB MCP  实现游戏场景智能数据建模
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T04:38:35.000Z" title="Tue Nov 25 2025 04:38:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91cc23a3088f4680b403a4cf5a06ec07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650315&amp;x-signature=H2VgL%2FqAWuX9tkIkozd%2Bk6I8D00%3D" alt="blogbanner-newnew.png" loading="lazy"/></p>
<h2 data-id="heading-0">前言</h2>
<p>Amazon DynamoDB 是一项完全托管的 NoSQL 数据库服务，提供快速、可预测且可扩展的性能。作为一种无服务器数据库，DynamoDB 让开发者无需担心服务器管理、硬件配置或容量规划等基础设施问题，可以专注于应用程序开发。对于游戏行业而言，DynamoDB 的设计特性尤为适合：其低延迟数据访问（通常以个位数毫秒计）能够支持游戏中的实时交互；自动扩展功能可以轻松应对游戏上线或特殊活动期间的流量高峰；全球表功能支持多区域部署，为全球玩家提供一致的低延迟体验，而按需容量模式则使游戏开发商能够根据实际使用量付费，有效控制成本，这些特性使 DynamoDB 成为众多游戏公司使用 DynamoDB 作为游戏主数据库，来存储关键游戏数据。</p>
<p>在现代游戏开发中，数据架构设计往往是非常重要环节。传统的关系型数据库思维在面对DynamoDB这样的NoSQL数据库时，由于不熟悉可能会设计出性能低下、成本高昂的方案。本博客我们将通过一个完整的游戏项目案例，展示如何使用通过Amazon Q CLI 集成DynamoDB MCP (Model Context Protocol)工具，从客户需求出发，通过调研流程，最终生成高效的DynamoDB数据模型。</p>
<p>DynamoDB MCP是一个基于Model Context Protocol的智能数据建模工具，该工具作为 DynamoDB  MCP服务器的一部分提供。DynamoDB MCP 数据建模工具与支持 MCP 的 AI 助手集成，提供结构化的自然语言驱动工作流，将应用程序需求转换为 DynamoDB 数据模型。该工具基于专家工程化的上下文构建，使用最新的推理模型指导用户掌握高级建模技术，它集成了Amazon DynamoDB的最佳实践和专家经验，能够实现：</p>
<ul>
<li>通过专业调研表系统性收集业务需求</li>
<li>基于访问模式自动识别聚合边界</li>
<li>在性能和成本间找到最优平衡点 创建高效DynamoDB数据模型</li>
</ul>
<p>通过将专家上下文与最新推理模型相结合，这种方法大大缩短了开发初始 DynamoDB 设计所需的时间。以前需要数天甚至数周的研究和迭代工作，现在可以加速到几十分钟内完成。</p>
<blockquote>
<p>📢限时插播：Amazon Q Developer 来帮你做应用啦！</p>
<p>🌟10分钟帮你构建智能番茄钟应用，1小时搞定新功能拓展、测试优化、文档注程和部署</p>
<p>⏩快快点击进入《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D67f49364f0df324eb192e428%26visitfrom%3D3P_Juejinhead_0529%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejinhead_0529" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=67f49364f0df324eb192e428&amp;visitfrom=3P_Juejinhead_0529&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejinhead_0529" ref="nofollow noopener noreferrer">Agentic Al 帮你做应用 -- 从0到1打造自己的智能番茄钟</a>》实验
免费体验企业级 AI 开发工具的真实效果吧
构建无限，探索启程!</p>
</blockquote>
<h2 data-id="heading-1">快速配置Q CLI 集成DynamoDB MCP</h2>
<h3 data-id="heading-2">什么是 Amazon Q CLI?</h3>
<p>Amazon Q CLI 是一款命令行工具，它将 Amazon Q 的强大功能引入命令行界面。借助 Amazon Q CLI，用户可以完成以下或更多工作：</p>
<ul>
<li>获取亚马逊云科技服务的帮助与推荐建议</li>
<li>诊断并解决亚马逊云科技资源问题</li>
<li>生成并解析亚马逊云科技CLI 命令</li>
<li>以对话方式与 AI 助手交互</li>
</ul>
<h3 data-id="heading-3">使用前提</h3>
<p>开始实验前，请确保已经在本地电脑安装了必要的工具</p>
<ul>
<li>Amazon Q CLI is installed, instructions: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2Fzh_cn%2Famazonq%2Flatest%2Fqdeveloper-ug%2Fcommand-line-installing.html" target="_blank" title="https://docs.aws.amazon.com/zh_cn/amazonq/latest/qdeveloper-ug/command-line-installing.html" ref="nofollow noopener noreferrer">安装适用于命令行的 Amazon Q</a></li>
<li>Amazon CLI 已安装并配置，操作说明：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2Fzh_cn%2Fcli%2Flatest%2Fuserguide%2Fgetting-started-install.html" target="_blank" title="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/getting-started-install.html" ref="nofollow noopener noreferrer">安装或更新最新版本的 Amazon CLI</a></li>
</ul>
<p>您拥有适当的亚马逊云科技权限，可以创建和管理实验中使用到的资源。</p>
<h3 data-id="heading-4">开始和 Q CLI 进行对话</h3>
<p>在终端会话中，使用以下命令开始与 Q CLI 进行对话：</p>
<p>q chat –trust-tools=fs_read,fs_write</p>
<h3 data-id="heading-5">集成DynamoDB MCP</h3>
<ol>
<li>需要安装uvx 软件 安装请参考：安装<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fastral-sh%2Fuv" target="_blank" title="https://github.com/astral-sh/uv" ref="nofollow noopener noreferrer">uvx</a></li>
<li>需要配置dynamoDB使用的环境变量：Amazon_ACCESS_KEY_ID, Amazon_SECRET_ACCESS_KEY 配置请参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fawslabs.github.io%2Fmcp%2Fservers%2Fdynamodb-mcp-server%2F" target="_blank" title="https://awslabs.github.io/mcp/servers/dynamodb-mcp-server/" ref="nofollow noopener noreferrer">配置dynamodb mcp server</a></li>
<li>修改Q CLI MCP 配置文件：</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript">vi ~<span class="hljs-regexp">/.aws/</span>amazonq/mcp.<span class="hljs-property">json</span>{
<span class="hljs-string">"mcpServers"</span>: {
<span class="hljs-string">"awslabs.dynamodb-mcp-server"</span>: {
<span class="hljs-string">"command"</span>: <span class="hljs-string">"uvx"</span>,
<span class="hljs-string">"args"</span>: [<span class="hljs-string">"awslabs.dynamodb-mcp-server@latest"</span>],
<span class="hljs-string">"env"</span>: {
<span class="hljs-string">"DDB-MCP-READONLY"</span>: <span class="hljs-string">"true"</span>,
<span class="hljs-string">"AWS_PROFILE"</span>: <span class="hljs-string">"default"</span>,
<span class="hljs-string">"AWS_REGION"</span>: <span class="hljs-string">"us-east-1"</span>,
<span class="hljs-string">"FASTMCP_LOG_LEVEL"</span>: <span class="hljs-string">"ERROR"</span>
},
<span class="hljs-string">"disabled"</span>: <span class="hljs-literal">false</span>,
<span class="hljs-string">"autoApprove"</span>: []
}
}
}
</code></pre>
<p>重新运行<strong>Q CLI (q chat) MCP Server</strong>已经成功集成到<strong>Q CLI</strong>(如下图):</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97d5ce1730d84617a3313a71e18db8a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650315&amp;x-signature=XDK%2BGEhyqWFDUy62XD%2FB4hXKVAM%3D" alt="11.png" loading="lazy"/></p>
<h2 data-id="heading-6">通过Q CLI 集成DynamoDB MCP 实现游戏场景智能数据建模</h2>
<h3 data-id="heading-7">游戏场景介绍</h3>
<p>移动游戏平台服务超过500万注册用户，其中50万为日活跃用户。在正常时段，平台处理约20,000 RPS的请求，但在热门赛事或新英雄发布期间，流量可能在几分钟内激增至50,000 RPS，同时仍需支持各种具有不同性能要求的访问模式。每天产生约25万场游戏对局，这种规模引入了几个关键的数据建模挑战：</p>
<p>流量波动性 – 热门赛事可能瞬间使负载增加三倍。传统数据库往往难以应对这种变化，但当数据模型设计时考虑到最优分区时，DynamoDB 的按需扩展能够吸收突然的流量峰值。</p>
<p>多样化访问模式 – 在我们的示例中，用户可以通过多种方式进行查询，如按玩家排名、按游戏历史，需要满足每种模式都有不同的性能特征。</p>
<h3 data-id="heading-8">建模需求采集和智能建模</h3>
<p>步骤1:输入建模需求：</p>
<p>以 <strong>ddb_mcp_blog</strong> 目录作为工作目录，从该路径启动 Q CLI 对话窗口，输入提示词：</p>
<p><code>&gt;使用我的数据建模 MCP 工具来帮助设计 DynamoDB 数据模型</code></p>
<p>可以看到 Q CLI 开始思考并提出建模相关的调研问题- 需要了解您的应用程序详情和访问模式需求：</p>
<p><code>输入y</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fdde8feef42477c9e7209f48f6ffe7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650315&amp;x-signature=KJsGekR5%2B4%2B1C6VInl%2BXTy5eLQE%3D" alt="22.png" loading="lazy"/></p>
<p>步骤2:输入建模调研问题回答：</p>
<p>项目背景</p>
<p><code>我正在为一个高流量的移动MOBA游戏平台， 设计DynamoDB数据模型。目前使用MySQL，但希望迁移到DynamoDB来更好地处理极端规模和流量。</code></p>
<p>用户规模</p>
<pre><code class="hljs">• 500万注册用户，50万日活用户
• 峰值流量：50,000 RPS
• 平均流量：20,000 RPS
• 每日处理约25万场游戏对局
</code></pre>
<p>核心业务实体</p>
<pre><code class="hljs language-arduino" lang="arduino">玩家系统：
• 玩家基本信息（player_id, username, level, rank, coins）
• 玩家统计数据（total_games, wins, losses, kill_death_ratio, avg_damage）
• 玩家道具（平均每玩家<span class="hljs-number">50</span>个道具，最多<span class="hljs-number">1000</span>个）
对局系统：
• 游戏对局记录（match_id, game_name, game_mode, map, start_time, end_time）
• 每场对局<span class="hljs-number">10</span>个玩家（<span class="hljs-number">5</span>v5对战）
• 对局结果和玩家表现数
</code></pre>
<p>主要访问模式</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 玩家登录和信息获取
• 流量：峰值15000 RPS，平均8000 RPS
• 延迟要求：&lt;50ms
• 95%的登录后会查询统计信息
<span class="hljs-bullet">2.</span> 排行榜查询
• 流量：峰值12000 RPS，平均4000 RPS
• 延迟要求：&lt;100ms
• 需求：根据Game<span class="hljs-emphasis">_name 按rating_</span>points排序的前100名玩家
• 每场游戏后异步更新排名积分
<span class="hljs-bullet">3.</span> 对局管理
• 创建对局：8000 RPS峰值，3000 RPS平均
• 更新对局结果：8000 RPS峰值，3000 RPS平均
• 每场对局结束需批量更新10个玩家的统计数据
• 允许短暂数据不一致，使用异步更新玩家统计数据 对局结束后立即更新
<span class="hljs-bullet">4.</span> 道具管理
• 总流量：7000 RPS峰值，2000 RPS平均
• 读写比例：3:1（70%读取道具清单，30%购买/使用道具）
• 需要防止重复购买的原子操作
道具购买的原子性操作:
<span class="hljs-bullet">1.</span> 检查玩家coins余额 (读取PlayerProfile)
<span class="hljs-bullet">2.</span> 验证道具价格和库存
<span class="hljs-bullet">3.</span> 原子更新操作:
<span class="hljs-bullet">   -</span> 扣减玩家货币 
<span class="hljs-bullet">   -</span> 增加道具数量 
<span class="hljs-bullet">   -</span> 记录交易日志 
</code></pre>
<p>数据访问关联性</p>
<pre><code class="hljs language-erlang" lang="erlang">• <span class="hljs-number">95</span><span class="hljs-comment">%的查询需要玩家基本信息+统计数据</span>
• <span class="hljs-number">30</span><span class="hljs-comment">%的查询需要玩家信息+道具清单  </span>
• <span class="hljs-number">15</span><span class="hljs-comment">%的查询需要玩家信息+对局历史</span>
</code></pre>
<p>特殊需求</p>
<pre><code class="hljs">• 支持实时排行榜更新
• 高并发下的数据一致性处理
• 重大活动期间的流量峰值应对
以上信息是我目前知道的所有信息 请基于以上信息建模
</code></pre>
<p>步骤3:<strong>DynamoDB MCP</strong> 会基于输入的调研信息 创建模型需求文档 <strong>dynamodb_requirement.md</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccc9961b49fc495f854074254e50e370~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650315&amp;x-signature=XDJRUkiVDPLyCzEE4TwNm6%2FUHmo%3D" alt="3.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86e711d59d604c89bff7522c74509437~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650315&amp;x-signature=N7hCF4oEoGgNBDYuKMiwFiBxTJo%3D" alt="4.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b10ebe11956a4ed983ce6727ac43afad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650315&amp;x-signature=tSY792rQlJ6sNeyvizZ2BJXhCrk%3D" alt="intelligent-data-modeling-in-gaming-scenarios-5.png" loading="lazy"/></p>
<p><code>输入y</code></p>
<h3 data-id="heading-9">DynamoDB MCP 会基于以上输入的调研信息 创建dynamodb_requirement.md</h3>
<p>备注：DynamoDB MCP 可能会提示更多的调研问题 :</p>
<p>这时请输入：</p>
<p><code>&gt;请基于以上输入信息建模 目前还不能提供更详细信息</code></p>
<p>步骤4:<strong>DynamoDB MCP</strong> 基于需求文档 <strong>dynamodb_requirement.md</strong> 智能建模 生成<strong>dynamodb_data_model.md</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd920da72f8b4ab794734e7fc03a39ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650315&amp;x-signature=Fn1z2yB69SXpLbGuL3h42Z7LBkA%3D" alt="6.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b0ff0c33d3c4fa3a951a5dcc162a14d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650315&amp;x-signature=%2FMj6KGm%2B7UbVcNwRKBCnk8OC9Is%3D" alt="7.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7079f7b7b3847879f912b10ca18ce26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650315&amp;x-signature=540ufNkLMAZkrjD6ATDOBsJ2l8w%3D" alt="8.png" loading="lazy"/></p>
<p><code>输入y</code>
<strong>DynamoDB MCP</strong> 会基于以上生成的需求文档<strong>dynamodb_requirement.md</strong> 创建<strong>dynamodb_data_model.md</strong> 同时总结核心设计亮点</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef8fb03eda25417fb7ea66fdbec22cc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650315&amp;x-signature=Kx4RCv%2BW3ozOcIzOIHMqoZ59Cjc%3D" alt="9.png" loading="lazy"/></p>
<h4 data-id="heading-10">采用DynamoDB MCP 生成的dynamodb_data_model.md 有以下几部分组成：</h4>
<p>1、设计理念与方法</p>
<p>核心原则：</p>
<ul>
<li>基于访问模式驱动的聚合设计</li>
<li>根据数据访问相关性（95%、30%、90%）进行整合</li>
<li>针对高流量MOBA游戏平台优化（峰值50,000 RPS）</li>
</ul>
<p>聚合策略：</p>
<ul>
<li>单项聚合：Player+Stats（95%关联）</li>
<li>项目集合：Player+Items（30%关联）</li>
<li>分离表：MatchHistory（15%关联，无界增长）</li>
</ul>
<p>2、表结构设计</p>
<p>主要表设计：</p>
<ul>
<li>PlayerProfile表：玩家档案+统计+道具的混合聚合</li>
<li>Match表：对局+玩家表现的单项聚合</li>
<li>MatchHistory表：独立的对局历史表</li>
<li>ActivePlayersLeaderboard GSI：稀疏索引的排行榜</li>
</ul>
<p>分区键策略：</p>
<ul>
<li>使用自然分布键（player_id、match_id）</li>
<li>避免热分区问题</li>
<li>支持识别关系模式</li>
</ul>
<p>3、访问模式映射</p>
<p>10个核心模式全覆盖：</p>
<ul>
<li>登录查询：单次GetItem操作</li>
<li>排行榜：稀疏GSI查询</li>
<li>对局创建/更新：原子操作</li>
<li>道具购买：事务写入</li>
<li>Match历史查询：时间范围查询</li>
</ul>
<p>查询效率：</p>
<ul>
<li>消除不必要的GSI</li>
<li>使用识别关系 减少50%写入成本</li>
<li>单次查询获取相关数据</li>
</ul>
<p>4、性能与成本优化</p>
<p>热分区分析：</p>
<ul>
<li>所有模式保持在分区限制内（3,000 RCU/1,000 WCU）</li>
<li>自然键分布确保负载均衡</li>
</ul>
<p>成本节省：</p>
<ul>
<li>稀疏GSI节省80%存储/写入成本</li>
<li>聚合设计减少50%查询次数</li>
<li>识别关系消除额外GSI开销</li>
</ul>
<p>5、权衡决策</p>
<p>关键权衡：</p>
<ul>
<li>存储 vs 查询性能：选择适度非规范化的数据冗余</li>
<li>一致性 vs 可扩展性：基于业务需求选择最终一致性</li>
<li>复杂性 vs 成本：通过聚合简化操作降低成本</li>
</ul>
<p>优化选择：</p>
<ul>
<li>嵌入式PlayerPerformances实现原子更新</li>
<li>排行榜 增加用户名 非规范化的数据冗余 避免额外查询</li>
<li>分离MatchHistory 控制无界增长</li>
</ul>
<p>这个设计在保证高性能的同时实现了成本优化，完全满足高流量游戏平台的需求。每个部分都遵循了DynamoDB MCP工具提供的标准模板结构，提供了完整的数据建模文档，涵盖了从设计理念到具体实现的所有关键方面。</p>
<p>模型设计关键设计原则：</p>
<ul>
<li>基于访问模式的聚合减少了查询往返次数</li>
</ul>
<p>通过分析实际查询需求将频繁一起访问的数据组织在同一个聚合中，使原本需要多次数据库调用的操作，合并为单次查询。</p>
<p>例如本游戏应用中，95%的玩家登录场景需要同时获取玩家基本信息和统计数据，因此将Player和PlayerStats设计为单项聚合存储在PlayerProfile表中，用一次GetItem操作替代了两次独立查询。同时，Match和PlayerPerformances由于访问相关性也被合并为单项聚合，实现了对局结果的原子更新</p>
<ul>
<li>识别关系 最小化了对<strong>GSI</strong>的需求</li>
</ul>
<p>当子实体在业务逻辑上完全依赖父实体存在且查询时总是通过父实体ID进行时，采用父实体ID作为分区键、子实体ID作为排序键的设计模式。如PlayerProfile表中的道具数据，使用PK=player_id, SK=ITEM#{item_id}的设计，通过Query(player_id)直接获取玩家所有道具。</p>
<p>MatchHistory表使用PK=player_id, SK=date#match_id支持玩家历史查询，这种识别关系设计消除了创建专门GSI的需要，降低了50%的写入成本和存储开销</p>
<ul>
<li>单表设计 提高了效率和可扩展性</li>
</ul>
<p>将相关但访问相关性适中(30-70%)的实体通过不同排序键前缀组织在同一张表中，实现了数据的逻辑分离和物理共存。如PlayerProfile表中玩家道具采用项目集合设计，既支持获取完整玩家信息的单次查询，也允许独立查询道具清单，在保持查询灵活性的同时，优化了运营成本和表管理复杂度。</p>
<p>具体模型设计信息 请参考<strong>DynamoDB MCP</strong> 生成的<strong>dynamodb_data_model.md</strong>文件</p>
<p>下一步:可调用<strong>DynamoDB MCP</strong> 基于<strong>dynamodb_data_model.md</strong> 生成DynamoDB 表结构</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff9c6ed7d17648c49c6fdeb0637c2e29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650315&amp;x-signature=hdaLQWT2c%2FQ6SoxfmgnVRUi18pU%3D" alt="10.png" loading="lazy"/></p>
<h2 data-id="heading-11">总结</h2>
<p>DynamoDB MCP是基于Model Context Protocol的智能数据建模工具，通过Amazon Q CLI集成，将Amazon专家经验与AI推理模型深度融合，将传统需要数天甚至数周的DynamoDB架构设计工作缩短至几十分钟。该工具采用聚合导向设计理念，自动化完成容量规划、热分区风险评估和成本优化，可为各行业各类应用场景，提供智能的DynamoDB数据模型设计。</p>
<p><strong>相关博客推荐</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fblogs%2Fdatabase%2Fintroducing-the-amazon-dynamodb-data-modeling-mcp-tool%2F" target="_blank" title="https://aws.amazon.com/blogs/database/introducing-the-amazon-dynamodb-data-modeling-mcp-tool/" ref="nofollow noopener noreferrer">初识 Amazon DynamoDB 数据建模 MCP 工具</a></p>
<p><strong>其他产品和服务推荐</strong></p>
<p>S-BGP 是我们在由光环新网运营的亚马逊云科技中国（北京）区域和由西云数据运营的亚马逊云科技中国（宁夏）区域推出的一项成本优化型网络服务，旨在帮助我们的客户降低经过互联网传输数据出云（Data Transfer Out）的费用。 如果您想申请亚马逊云科技中国区域的 S-BGP 服务，请联系您的客户经理获取进一步帮助。</p>
<p>*<em>前述特定亚马逊云科技生成式人工智能相关的服务目前在亚马逊云科技海外区域可用。亚马逊云科技中国区域相关云服务由西云数据和光环新网运营，具体信息以中国区域官网为准。</em></p>
<p><strong>本篇作者</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5fd6342cbfc4912bc30add624e65d4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650315&amp;x-signature=xNQwBxBeqU4cjsRHYGAcSV2m%2BW4%3D" alt="3495607084-69246b42ee606_fix732.webp" loading="lazy"/></p>
<blockquote>
<p>本期最新实验为《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D67f49364f0df324eb192e428%26visitfrom%3D3P_Juejintail_0418%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_0418" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=67f49364f0df324eb192e428&amp;visitfrom=3P_Juejintail_0418&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_0418" ref="nofollow noopener noreferrer">Agentic AI 帮你做应用 —— 从0到1打造自己的智能番茄钟</a>》</p>
<p>✨ 自然语言玩转命令行，10分钟帮你构建应用，1小时搞定新功能拓展、测试优化、文档注释和部署</p>
<p>💪 免费体验企业级 AI 开发工具，质量+安全全掌控</p>
<p>⏩️[<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D67f49364f0df324eb192e428%26visitfrom%3D3P_Juejintail_0418%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_0418" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=67f49364f0df324eb192e428&amp;visitfrom=3P_Juejintail_0418&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_0418" ref="nofollow noopener noreferrer">点击进入实验</a>] 即刻开启  AI 开发之旅</p>
<p>构建无限, 探索启程！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[离职三个月后]]></title>    <link>https://juejin.cn/post/7576181242582859839</link>    <guid>https://juejin.cn/post/7576181242582859839</guid>    <pubDate>2025-11-25T03:04:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576181242582859839" data-draft-id="7576210031872704553" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="离职三个月后"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-25T03:04:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小兵张健"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032405229"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            离职三个月后
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032405229/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小兵张健
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:04:13.000Z" title="Tue Nov 25 2025 03:04:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>自之前写的 <a href="https://juejin.cn/post/7450047052804161576" target="_blank" title="https://juejin.cn/post/7450047052804161576">我这🤡般的7年开发生涯</a> 后，痛苦大半年，在今年 8 月底离职了，距今已有 3 个月。</p>
<p>当时我和老板说承受不了，想退居二线，之后的某一天，HR 找我谈话，签了离职协议就走人了。</p>
<p>刚离职当然是喜悦和惬意的，每天就出去晒晒太阳吹吹风都感觉很好。不用提心吊胆的守在手机旁边，不用精神一直紧绷。</p>
<p>我去办理的失业金领取，武汉这边比较好办，线上也可以办，领取的月份是 2N + 1，我连续工作了 6 年，可以领取 13 个月，每个月 1900 多块钱，还给缴医保，比我之前公司缴的还多🤣🤣。</p>
<p>离职后开销挺小的，我算了下每天点外卖最多 30 块钱，房租贵一点要 2000，因为和老婆一起租，假设单人就算 1000 吧，再加上水电网交通费，最多不超过 2500 块钱。</p>
<p>我们没啥额外的开销，偶尔看看电影买点面包吃，以前还会去下馆子，现在发现都是科技与狠活也吃的少了。</p>
<p>现代人的健康问题我认为是吃太多了，添加剂化学材料太多，吃了反而对身体不好，但是上班压力大的时候的确控制不住，吃成了唯一的发泄口。</p>
<p>另一边爸妈和岳父岳母一直在催生娃，我顶住了压力，为别人活了一辈子，为自己活个 1 年多不过分吧。</p>
<p>就当花点钱买自己的自由身了，在接下来的 1 年多时间里休息下。</p>
<p>离职的前两个月我连 BOSS 直聘都没看，听到工作两个字都头疼，第三个月闲的无聊刷了下，都是外包，现在找工作的情绪不是很强烈，只是把简历挂上去了，看缘分吧。</p>
<p>惬意了一段时间后就有点闲的无聊了，我买了个小电驴，到处晒太阳看风景，藏龙岛去了好多次了。我一般带个折叠床，看着太阳不错的地方就铺起来躺着。</p>
<p>另一个好地方是光谷书房，就跟图书馆一样，光谷这边特别多，我这篇文章就是在光谷书房里面写的。这里有电有网，带个电脑和充电器能待一天。</p>
<p>我给几个定了 2 个慢悠悠的目标，学好英语、学好 AI。</p>
<p>纳瓦尔年初有一篇 3 个多小时的深度采访，我刚听的时候就被震撼到了，把他和谷歌 Prompt 白皮书一起当做英语学习材料了。</p>
<p>额外的背了 3000 多个单词，但是独立的单词背了也没用，经常忘也不知道怎么运用，于是我开始背这些材料，劝大家少走弯路，直接从日常接触的英文材料开始，在句子里面学习单词，别像我一样漫无目的的乱背。</p>
<p>有时候也在溜圈的时候，抓点外国友人聊天，华科武大附近的比较多，或者线上有 Tandem 和 HelloTalk，推荐 Tandem 吧，里面欧美的比较多，注意下时间差在别人白天的时候聊聊天，HelloTalk 里面东南亚的多，和中国时区差距不大一致。</p>
<p>AI 我先学了整个 LLM 的原理，写了四篇文章记录 LLM 整个训练和推理的过程，还挺有意思的，整个过程就是量变到质变的“涌现”，再去看看 Dify、n8n 等相关的工具。</p>
<p>还有个全栈方面，我看很多公司用 Python 和 Go，就顺手把和 Java + Spring 对应的框架看了下，都差不多，有点细微插边我也写了几篇文章分享出来。</p>
<p>英语 +  AI 是未来风口，之前上班没时间，现在离职了就狠狠研究一番，离职的一大好处就是把做别的事的机会成本拉的很低。</p>
<p>中美形势比较紧张，但是两国之间的需求是客观存在的，越是在这种时候英语越值钱。</p>
<p>随手写写近期的情况给各位参考下，祝大家越过越好。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uniapp(vue3) 拖拽元素支持小程序h5]]></title>    <link>https://juejin.cn/post/7576378563546366004</link>    <guid>https://juejin.cn/post/7576378563546366004</guid>    <pubDate>2025-11-25T02:58:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576378563546366004" data-draft-id="7576208176006578228" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uniapp(vue3) 拖拽元素支持小程序h5"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-25T02:58:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="行者dyc"/> <meta itemprop="url" content="https://juejin.cn/user/4099460216140686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uniapp(vue3) 拖拽元素支持小程序h5
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4099460216140686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    行者dyc
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T02:58:56.000Z" title="Tue Nov 25 2025 02:58:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">uniapp(vue3) 拖拽元素支持小程序h5</h2>
<h4 data-id="heading-1">拖拽组件</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;template&gt;
  &lt;view
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"dragRef"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"drag-el"</span>
    :<span class="hljs-attr">style</span>=<span class="hljs-string">"{ left: `${position.x}px`, top: `${position.y}px` }"</span>
    @<span class="hljs-attr">touchstart</span>=<span class="hljs-string">"handleTouchStart"</span>
    @<span class="hljs-attr">touchmove</span>=<span class="hljs-string">"handleTouchMove"</span>
    @<span class="hljs-attr">touchend</span>=<span class="hljs-string">"handleTouchEnd"</span>
    @<span class="hljs-attr">mousedown</span>=<span class="hljs-string">"handleMouseDown"</span>
    @<span class="hljs-attr">mousemove</span>=<span class="hljs-string">"handleMouseMove"</span>
    @<span class="hljs-attr">mouseup</span>=<span class="hljs-string">"handleMouseUp"</span>
    @<span class="hljs-attr">mouseleave</span>=<span class="hljs-string">"handleMouseUp"</span>
  &gt;
    &lt;slot&gt;&lt;/slot&gt;
  &lt;/view&gt;
&lt;/template&gt;
​
&lt;script setup <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;
// 定义组件属性
const <span class="hljs-attr">props</span> = withDefaults(
  defineProps&lt;{
    // 初始位置
    initialPosition?: {
      x: number
      y: number
    }
    // 边界范围（相对于父元素）
    boundary?: {
      minX?: number
      maxX?: number
      minY?: number
      maxY?: number
    }
    // 回弹阈值（百分比，0-1）
    bounceThreshold?: number
    // 是否启用回弹
    enableBounce?: boolean
    initSize: {
      width: number
      height: number
    }
  }&gt;(),
  {
    initialPosition: () =&gt; ({ x: 0, y: 0 }),
    boundary: () =&gt; ({}),
    bounceThreshold: 0.5,
    enableBounce: true,
  },
)
const <span class="hljs-attr">isMiniProgram</span> = os.isXcx
​
// 定义事件
const <span class="hljs-attr">emit</span> = defineEmits&lt;{
  start: <span class="hljs-section">[{ x: number; y: number }]</span>
  move: <span class="hljs-section">[{ x: number; y: number }]</span>
  end: <span class="hljs-section">[{ x: number; y: number }]</span>
  bounce: <span class="hljs-section">[{ x: number; y: number }, 'left' | 'right']</span>
}&gt;()
​
// 组件实例引用
const <span class="hljs-attr">dragRef</span> = ref()
​
// 位置状态
const <span class="hljs-attr">position</span> = reactive&lt;{ x: number<span class="hljs-comment">; y: number }&gt;({</span>
  x: props.initialPosition.x,
  y: props.initialPosition.y,
})
​
// 拖拽状态
const <span class="hljs-attr">isDragging</span> = ref(<span class="hljs-literal">false</span>)
const <span class="hljs-attr">startPosition</span> = ref({ x: <span class="hljs-number">0</span>, y: <span class="hljs-number">0</span> })
const <span class="hljs-attr">elementStartPosition</span> = ref({ x: <span class="hljs-number">0</span>, y: <span class="hljs-number">0</span> })
​
// 计算拖拽边界父元素的宽高减去元素自身的宽高
const <span class="hljs-attr">calculatedBoundary</span> = computed(() =&gt; {
  const <span class="hljs-attr">boundary</span> = { ...props.boundary }
  // 如果没有指定边界，尝试从父元素获取
  if (!boundary.maxX || !boundary.maxY) {
    try {
      // 首先检查是否为小程序环境
​
      if (isMiniProgram) {
        // 小程序环境，使用屏幕尺寸减去元素实际宽度（如果有）
        const <span class="hljs-attr">systemInfo</span> = uni.getSystemInfoSync()
        const { windowWidth, windowHeight } = systemInfo
        if (<span class="hljs-attr">boundary.maxX</span> === undefined) {
          <span class="hljs-attr">boundary.maxX</span> = windowWidth - props.initSize.width
        }
        if (<span class="hljs-attr">boundary.maxY</span> === undefined) {
          <span class="hljs-attr">boundary.maxY</span> = windowHeight - props.initSize.height
        }
      } else {
        const <span class="hljs-attr">currentElement</span> = dragRef.value.<span class="hljs-variable">$el</span>
        // H5环境尝试获取父元素
        const <span class="hljs-attr">parent</span> = currentElement.parentElement
        if (parent) {
          const <span class="hljs-attr">parentRect</span> = parent.getBoundingClientRect()
          // 使用实际获取的元素尺寸
          const <span class="hljs-attr">elementWidth</span> = props.initSize.width
          const <span class="hljs-attr">elementHeight</span> = props.initSize.height
​
          if (<span class="hljs-attr">boundary.maxX</span> === undefined) {
            <span class="hljs-attr">boundary.maxX</span> = parentRect.width - elementWidth
          }
          if (<span class="hljs-attr">boundary.maxY</span> === undefined) {
            <span class="hljs-attr">boundary.maxY</span> = parentRect.height - elementHeight
          }
        } else {
          console.warn('无法获取父元素，使用默认边界值')
          // 使用默认边界值作为备选
          if (<span class="hljs-attr">boundary.maxX</span> === undefined) {
            <span class="hljs-attr">boundary.maxX</span> = window.innerWidth - props.initSize.width // 假设元素宽度约为<span class="hljs-number">100</span>px
          }
          if (<span class="hljs-attr">boundary.maxY</span> === undefined) {
            <span class="hljs-attr">boundary.maxY</span> = window.innerHeight - props.initSize.height // 假设元素高度约为<span class="hljs-number">100</span>px
          }
        }
      }
    } catch (error) {
      console.error('获取父元素尺寸时出错:', error)
      // 出错时使用默认值
      if (<span class="hljs-attr">boundary.maxX</span> === undefined) {
        <span class="hljs-attr">boundary.maxX</span> = <span class="hljs-number">300</span> // 默认最大X值
      }
      if (<span class="hljs-attr">boundary.maxY</span> === undefined) {
        <span class="hljs-attr">boundary.maxY</span> = <span class="hljs-number">300</span> // 默认最大Y值
      }
    }
  }
​
  // 确保minX和minY默认为0
  if (<span class="hljs-attr">boundary.minX</span> === undefined) {
    <span class="hljs-attr">boundary.minX</span> = <span class="hljs-number">0</span>
  }
  if (<span class="hljs-attr">boundary.minY</span> === undefined) {
    <span class="hljs-attr">boundary.minY</span> = <span class="hljs-number">0</span>
  }
  console.log('~~~~计算边界calculatedBoundary', boundary)
  return boundary
})
​
// 处理触摸开始
const <span class="hljs-attr">handleTouchStart</span> = (e: TouchEvent) =&gt; {
  console.log('~~~~开始handleTouchStart', e)
  <span class="hljs-attr">isDragging.value</span> = <span class="hljs-literal">true</span>
  // 记录拖拽开始位置
  <span class="hljs-attr">startPosition.value</span> = {
    x: e.touches<span class="hljs-section">[0]</span>.clientX,
    y: e.touches<span class="hljs-section">[0]</span>.clientY,
  }
  <span class="hljs-attr">elementStartPosition.value</span> = { ...position }
​
  emit('start', { ...position })
}
​
// 处理触摸移动
const <span class="hljs-attr">handleTouchMove</span> = (e: TouchEvent) =&gt; {
  console.log('~~~~~移动handleTouchMove', e)
  if (!isDragging.value) return
​
  // 计算移动距离
  const <span class="hljs-attr">deltaX</span> = e.touches[<span class="hljs-number">0</span>].clientX - startPosition.value.x
  const <span class="hljs-attr">deltaY</span> = e.touches[<span class="hljs-number">0</span>].clientY - startPosition.value.y
​
  updatePosition(deltaX, deltaY)
}
​
// 处理触摸结束
const <span class="hljs-attr">handleTouchEnd</span> = () =&gt; {
  console.log('~~~~~结束handleTouchEnd')
  finishDrag()
}
​
// 处理鼠标按下
const <span class="hljs-attr">handleMouseDown</span> = (e: MouseEvent) =&gt; {
  console.log('~~~~鼠标按下handleMouseDown', e)
  <span class="hljs-attr">isDragging.value</span> = <span class="hljs-literal">true</span>
  <span class="hljs-attr">startPosition.value</span> = { x: e.clientX, y: e.clientY }
  <span class="hljs-attr">elementStartPosition.value</span> = { ...position }
​
  emit('start', { ...position })
​
  // 阻止文本选择
  e.preventDefault()
}
​
// 处理鼠标移动
const <span class="hljs-attr">handleMouseMove</span> = (e: MouseEvent) =&gt; {
  console.log('~~~~鼠标移动handleMouseMove', e)
  if (!isDragging.value) return
​
  const <span class="hljs-attr">deltaX</span> = e.clientX - startPosition.value.x
  const <span class="hljs-attr">deltaY</span> = e.clientY - startPosition.value.y
​
  updatePosition(deltaX, deltaY)
}
​
// 处理鼠标松开
const <span class="hljs-attr">handleMouseUp</span> = () =&gt; {
  console.log('~~~~鼠标松开handleMouseUp')
  finishDrag()
}
​
// 更新位置
const <span class="hljs-attr">updatePosition</span> = (deltaX: number, deltaY: number) =&gt; {
  console.log('~~~~更新位置updatePosition', deltaX, deltaY)
  let <span class="hljs-attr">newX</span> = elementStartPosition.value.x + deltaX
  let <span class="hljs-attr">newY</span> = elementStartPosition.value.y + deltaY
​
  // 应用边界约束
  const <span class="hljs-attr">boundary</span> = calculatedBoundary.value
  // x轴最小不能小于0
  if (boundary.minX !== undefined) {
    <span class="hljs-attr">newX</span> = Math.max(boundary.minX, newX)
  }
  // x轴最大不能大于父元素宽度减去元素宽度
  if (boundary.maxX !== undefined) {
    <span class="hljs-attr">newX</span> = Math.min(boundary.maxX, newX)
  }
  // y轴最小不能小于0
  if (boundary.minY !== undefined) {
    <span class="hljs-attr">newY</span> = Math.max(boundary.minY, newY)
  }
  // y轴最大不能大于父元素高度减去元素高度
  if (boundary.maxY !== undefined) {
    <span class="hljs-attr">newY</span> = Math.min(boundary.maxY, newY)
  }
​
  // 更新位置
  <span class="hljs-attr">position.x</span> = newX
  <span class="hljs-attr">position.y</span> = newY
​
  emit('move', { ...position })
}
​
// 完成拖拽，处理回弹
const <span class="hljs-attr">finishDrag</span> = () =&gt; {
  if (!isDragging.value) return
​
  <span class="hljs-attr">isDragging.value</span> = <span class="hljs-literal">false</span>
​
  // 处理回弹逻辑
  if (props.enableBounce &amp;&amp; calculatedBoundary.value.maxX !== undefined) {
    const <span class="hljs-attr">maxX</span> = calculatedBoundary.value.maxX
    const <span class="hljs-attr">threshold</span> = props.bounceThreshold * maxX
​
    if (position.x &lt; threshold) {
      // 回弹到左侧
      animateToPosition(0, position.y, 'left')
    } else if (position.x &gt; maxX - threshold) {
      // 回弹到右侧
      animateToPosition(maxX, position.y, 'right')
      return // 动画完成后会触发end事件
    }
  }
​
  emit('end', { ...position })
}
​
// 兼容的动画帧请求函数，适配小程序环境
const <span class="hljs-attr">requestAnimationFrameCompat</span> = (callback: any) =&gt; {
  // 检查是否为小程序环境
  return setTimeout(callback, 16) // 约60fps
}
​
// 动画移动到指定位置
const <span class="hljs-attr">animateToPosition</span> = (targetX: number, targetY: number, direction: <span class="hljs-string">'left'</span> | <span class="hljs-string">'right'</span>) =&gt; {
  const <span class="hljs-attr">startX</span> = position.x
  const <span class="hljs-attr">startY</span> = position.y
  const <span class="hljs-attr">duration</span> = <span class="hljs-number">300</span> // 动画持续时间
  const <span class="hljs-attr">startTime</span> = Date.now()
  let animationId: <span class="hljs-attr">any</span> = null
​
  const <span class="hljs-attr">animate</span> = () =&gt; {
    const <span class="hljs-attr">currentTime</span> = Date.now()
    const <span class="hljs-attr">elapsed</span> = currentTime - startTime
    const <span class="hljs-attr">progress</span> = Math.min(elapsed / duration, <span class="hljs-number">1</span>)
​
    // 使用缓动函数
    const <span class="hljs-attr">easeOut</span> = <span class="hljs-number">1</span> - (<span class="hljs-number">1</span> - progress) ** <span class="hljs-number">3</span>
​
    <span class="hljs-attr">position.x</span> = startX + (targetX - startX) * easeOut
    <span class="hljs-attr">position.y</span> = startY + (targetY - startY) * easeOut
​
    if (progress &lt; 1) {
      <span class="hljs-attr">animationId</span> = requestAnimationFrameCompat(animate)
    } else {
      // 动画结束
      <span class="hljs-attr">position.x</span> = targetX
      <span class="hljs-attr">position.y</span> = targetY
      emit('bounce', { ...position }, direction)
      emit('end', { ...position })
    }
  }
​
  <span class="hljs-attr">animationId</span> = requestAnimationFrameCompat(animate)
}
​
// 暴露方法给父组件
const <span class="hljs-attr">setPosition</span> = (x: number, y: number) =&gt; {
  <span class="hljs-attr">position.x</span> = x
  <span class="hljs-attr">position.y</span> = y
}
​
const <span class="hljs-attr">resetPosition</span> = () =&gt; {
  <span class="hljs-attr">position.x</span> = props.initialPosition.x
  <span class="hljs-attr">position.y</span> = props.initialPosition.y
}
​
defineExpose({
  setPosition,
  resetPosition,
  position,
})
&lt;/script&gt;
​
&lt;style scoped <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;
.drag-el {
  position: absolute<span class="hljs-comment">;</span>
  cursor: move<span class="hljs-comment">; /* 鼠标指针样式 */</span>
  user-select: none<span class="hljs-comment">; /* 防止文本选中 */</span>
  touch-action: none<span class="hljs-comment">; /* 防止触摸事件的默认行为 */</span>
​
  // 增加可点击区域
  &amp;:active {
    // 可以在这里添加拖拽时的视觉反馈
  }
}
&lt;/style&gt;
​
</code></pre>
<h4 data-id="heading-2">使用组件</h4>
<pre><code class="hljs language-xml" lang="xml">vue
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"drag-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">DragEl</span> <span class="hljs-attr">:initSize</span>=<span class="hljs-string">"dragElSize"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dragElRef"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 200rpx; height: 100rpx"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bg-[#f0f0f0] p-4 rounded-md"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>拖动元素<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">DragEl</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">DragEl</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/pages-word/components/DragEl/index.vue'</span>
​
<span class="hljs-keyword">const</span> dragElSize = <span class="hljs-title function_">ref</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">0</span> })
<span class="hljs-keyword">const</span> dragElRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
​
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getElementSize</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 1. 创建选择器实例</span>
  <span class="hljs-keyword">const</span> query = uni.<span class="hljs-title function_">createSelectorQuery</span>().<span class="hljs-title function_">in</span>(dragElRef.<span class="hljs-property">value</span>) <span class="hljs-comment">// 关键：.in(this) 绑定当前组件实例（必填，否则可能获取不到）</span>
​
  <span class="hljs-comment">// 2. 选择目标元素，获取布局信息</span>
  query
    .<span class="hljs-title function_">select</span>(<span class="hljs-string">'.drag-el'</span>) <span class="hljs-comment">// 通过 id 选择元素（也可用 .class 选择，如 .box）</span>
    .<span class="hljs-title function_">boundingClientRect</span>(<span class="hljs-function">(<span class="hljs-params">rect</span>) =&gt;</span> {
      <span class="hljs-comment">// rect 包含元素的布局信息</span>
      <span class="hljs-keyword">if</span> (rect) {
        dragElSize.<span class="hljs-property">value</span> = { <span class="hljs-attr">width</span>: rect.<span class="hljs-property">width</span>, <span class="hljs-attr">height</span>: rect.<span class="hljs-property">height</span> }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'未找到目标元素'</span>)
      }
    })
    .<span class="hljs-title function_">exec</span>() <span class="hljs-comment">// 执行查询（必须调用，否则回调不触发）</span>
}
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">getElementSize</span>()
  })
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.dd</span> {
  <span class="hljs-attribute">position</span>: absolute;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
​
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code + Cursor编程环境初始化]]></title>    <link>https://juejin.cn/post/7575367791274377254</link>    <guid>https://juejin.cn/post/7575367791274377254</guid>    <pubDate>2025-11-24T02:46:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575367791274377254" data-draft-id="7575456858428293166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code + Cursor编程环境初始化"/> <meta itemprop="keywords" content="Claude,Cursor"/> <meta itemprop="datePublished" content="2025-11-24T02:46:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="撒币使我快乐"/> <meta itemprop="url" content="https://juejin.cn/user/1556564197509527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code + Cursor编程环境初始化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564197509527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    撒币使我快乐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:46:33.000Z" title="Mon Nov 24 2025 02:46:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>目前开发代码的最佳实践是使用Cursor的Tab自动补全功能加上Claude Code生成代码。为了让AI能更好地辅助开发，我们需要进行初始化。本文适用于Windows用户。</p>
<p>项目的Cursor Rules和CLAUDE.md都需要上传到代码仓，确保团队使用的是一样的规范。</p>
<h2 data-id="heading-1">Cursor初始化</h2>
<h3 data-id="heading-2">用户设置</h3>
<p>按如下路径打开设置，文件 &gt; 首选项 &gt; Cursor Settings 搜索User Rules，可以设置默认回复中文。</p>
<h3 data-id="heading-3">项目设置</h3>
<p>按下<code>Ctrl + L</code>并输入<code>/</code>可以使用<code>Generate Cursor Rules</code>指令，这样可以生成<code>.cursor/rules</code>下的.mdc文件，可以上传到代码仓便于团队成员使用。如果无法使用<code>Generate Cursor Rules</code>指令，可以参考<a href="https://juejin.cn/post/7572396000543817791" target="_blank" title="https://juejin.cn/post/7572396000543817791">这篇文章</a></p>
<h2 data-id="heading-4">Claude Code初始化</h2>
<p>如果还没有安装Claude Code，可以参考<a href="https://juejin.cn/post/7571808096936722473" target="_blank" title="https://juejin.cn/post/7571808096936722473">这篇文章</a></p>
<h3 data-id="heading-5">用户设置</h3>
<p>打开Claude Code后，输入<code>#尽可能输出中文</code>，并选择User memory即可让Claude Code后续都尽可能输出中文。也可以找到<code>~/.claude/CLAUDE.md</code>并进行编辑。</p>
<p>如果使用figma，则在其中加入</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># Figma 设计稿严格遵循规则</span></span>

当遇到 figama 字眼或者设计稿，必须使用 figama-mcp 读取完整设计稿节点信息再继续编码
</code></pre>
<p>对于复杂工作流，可以加入</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment">## 复杂需求标准工作流程</span>

1.首先理清问题，阅读代码库中的相关文件，并制定tasks/todo.md计划。
2.计划中应包含待办事项清单，完成一项即可勾选。
3.开始工作前请先与我确认，我会核对计划内容。
4.随后着手处理待办事项，完成时及时标记。
5.每个步骤都请用简明扼要的方式说明所做的修改。
6.所有任务和代码变更都应尽量简化。我们希望避免进行任何大规模或复杂的改动。每次变更应尽量减少代码量。一切以简洁为原则。
7.最后，需在待办事项.md文件中添加审查章节，总结所做的更改及相关信息。
</code></pre>
<h4 data-id="heading-6">找到CLAUDE.md</h4>
<p>使用虚拟机的情况下，我们无法像Mac一样直接在<code>C:\Users\Administrator.claude</code>找到CLAUDE.md文件 但我们却可以通过命令行的方式访问到</p>
<pre><code class="hljs language-ruby" lang="ruby">octopus<span class="hljs-variable">@CHINAMI</span>-<span class="hljs-variable constant_">UFE6487</span><span class="hljs-symbol">:/</span><span class="hljs-variable">$ </span>cd ~<span class="hljs-regexp">/.claude
octopus@CHINAMI-UFE6487:~/</span>.claude<span class="hljs-variable">$ </span>ls
<span class="hljs-variable constant_">CLAUDE</span>.md  file-history   projects     shell-snapshots  todos
debug      history.jsonl  session-env  statsig
</code></pre>
<p>这时只要我们输入<code>explorer.exe .</code>回车后就会发现打开了一个路径为<code>\wsl.localhost\Ubuntu\home&lt;你的用户名&gt;.claude</code>的窗口 这样我们就能使用IDE来对CLAUDE.md进行编辑了</p>
<h3 data-id="heading-7">项目设置</h3>
<p>用Cursor打开项目，打开WSL终端，打开claude code后，执行<code>/init</code>即可初始化项目的CLAUDE.md文件</p>
<h2 data-id="heading-8">接入MCP</h2>
<p>注意每一个MCP都会消耗资源，所以不是越多越好，建议只接入必要的，并定期清理非必要的。</p>
<h3 data-id="heading-9">接入墨刀MCP</h3>
<p>没必要接入，只支持提示词转html、提示词转文档、html存个人空间，并不支持UI节点信息转html</p>
<h3 data-id="heading-10">接入Figma MCP</h3>
<p>支持UI节点信息直接变成代码</p>
<p><a href="https://juejin.cn/post/7573508361740877824" target="_blank" title="https://juejin.cn/post/7573508361740877824">Claude Code全局添加figma MCP</a></p>
<h3 data-id="heading-11">接入Apifox MCP</h3>
<p>可以帮你自动生成符合规范的接口代码</p>
<p>修改~/.claude.json，将如下代码其加入mcpServers中即可</p>
<p>--project-id后端给的文档URL中会有，开发时记得改</p>
<p>APIFOX_ACCESS_TOKEN是公司内部通用的</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-string">"apifox"</span>: {
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"stdio"</span>,
  <span class="hljs-string">"command"</span>: <span class="hljs-string">"npx"</span>,
  <span class="hljs-string">"args"</span>: [
    <span class="hljs-string">"-y"</span>,
    <span class="hljs-string">"apifox-mcp-server@latest"</span>,
    <span class="hljs-string">"--project-id=9999999"</span>
  ],
  <span class="hljs-string">"env"</span>: {
    <span class="hljs-string">"APIFOX_ACCESS_TOKEN"</span>: <span class="hljs-string">"XXX"</span>
  }
}
</code></pre>
<p>输入如下命令检查是否成功添加</p>
<pre><code class="hljs">claude mcp list
</code></pre>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[千问快速review评审Java工程代码与异步代码智能体]]></title>    <link>https://juejin.cn/post/7575457788665184308</link>    <guid>https://juejin.cn/post/7575457788665184308</guid>    <pubDate>2025-11-24T06:55:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575457788665184308" data-draft-id="7576175307351310351" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="千问快速review评审Java工程代码与异步代码智能体"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-24T06:55:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PetterHillWater"/> <meta itemprop="url" content="https://juejin.cn/user/4088451358280841"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            千问快速review评审Java工程代码与异步代码智能体
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4088451358280841/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PetterHillWater
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:55:46.000Z" title="Mon Nov 24 2025 06:55:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>    《<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.amazon.com%2FEffective-Java-Joshua-Bloch%2Fdp%2F0134685997" target="_blank" title="https://www.amazon.com/Effective-Java-Joshua-Bloch/dp/0134685997" ref="nofollow noopener noreferrer">Effective Java</a>》是由 Joshua Bloch 编写的一本经典 Java 编程指南，被广泛认为是 Java 开发者必读的权威书籍之一。该书通过一系列具体、实用的“条款”（Items），帮助开发者写出更清晰、高效、健壮和可维护的 Java 代码。截至 2025 年，《Effective Java》已出版至<strong>第三版</strong>（2018 年发布），主要基于 <strong>Java 7 到 Java 9</strong> 的特性，并涵盖部分 Java 10/11 的内容（如局部变量类型推断 var）。全书共分为 <strong>12 章，90 条实践建议</strong>（Items）。</p>
<h2 data-id="heading-1">提示词</h2>
<p>根据 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fjiapengcai.gitbooks.io%2Feffective-java%2Fcontent%2F" target="_blank" title="https://link.juejin.cn/?target=https%3A%2F%2Fjiapengcai.gitbooks.io%2Feffective-java%2Fcontent%2F"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fca6db4337a84698a3f447847b943ab6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572146&amp;x-signature=NY9%2B8lsQtDguTvKj%2BoYdhsQVy5A%3D" alt="" loading="lazy"/>jiapengcai.gitbooks.io</a> 中原则，review当前工程src代码</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fimg2024.cnblogs.com%2Fblog%2F15172%2F202511%2F15172-20251119180701097-857863474.png" target="_blank" title="https://img2024.cnblogs.com/blog/15172/202511/15172-20251119180701097-857863474.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/995b88bb454b401e95147b8aea3078bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572146&amp;x-signature=9z6NvakUR6TqpCy6VA2Kocl46h4%3D" alt="image" title="image" loading="lazy"/></a></p>
<h2 data-id="heading-2">异步代码智能体Jules</h2>
<p>提示词</p>
<blockquote>
<p>根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjiapengcai.gitbooks.io%2Feffective-java%2Fcontent%2F" target="_blank" title="https://jiapengcai.gitbooks.io/effective-java/content/" ref="nofollow noopener noreferrer">jiapengcai.gitbooks.io/effective-j…</a> 中原则，review当前工程java代码</p>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fimg2024.cnblogs.com%2Fblog%2F15172%2F202511%2F15172-20251119180702774-742134011.png" target="_blank" title="https://img2024.cnblogs.com/blog/15172/202511/15172-20251119180702774-742134011.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0177e8536bd3499397e1985fb3d5005c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572146&amp;x-signature=wXOq18z%2Fw%2B7XMWSA06rhVJLrkWA%3D" alt="image" title="image" loading="lazy"/></a></p>
<p>PLAN 批准后</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fimg2024.cnblogs.com%2Fblog%2F15172%2F202511%2F15172-20251119180703721-1499175088.png" target="_blank" title="https://img2024.cnblogs.com/blog/15172/202511/15172-20251119180703721-1499175088.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4391aea8ba6744ea807567e233542565~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572146&amp;x-signature=3SCP4d1OMuMyXc3Tn%2BadTRkvJRs%3D" alt="image" title="image" loading="lazy"/></a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fimg2024.cnblogs.com%2Fblog%2F15172%2F202511%2F15172-20251119180704683-1065941867.png" target="_blank" title="https://img2024.cnblogs.com/blog/15172/202511/15172-20251119180704683-1065941867.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6feabd9d14b5479eaa574f429db9af49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572146&amp;x-signature=x6gvKKLwrkEbJkjzOklNLgRYXC4%3D" alt="image" title="image" loading="lazy"/></a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fimg2024.cnblogs.com%2Fblog%2F15172%2F202511%2F15172-20251119180705790-622426961.png" target="_blank" title="https://img2024.cnblogs.com/blog/15172/202511/15172-20251119180705790-622426961.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f9d9c0ab1ba4631abfb409db9d74d3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572146&amp;x-signature=A%2FKZmzWPssoU9VcidBJKz70ItyA%3D" alt="image" title="image" loading="lazy"/></a></p>
<p>报告</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fimg2024.cnblogs.com%2Fblog%2F15172%2F202511%2F15172-20251119180706958-941404890.png" target="_blank" title="https://img2024.cnblogs.com/blog/15172/202511/15172-20251119180706958-941404890.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8619eadec10f42d69e4465c9ec2624a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572146&amp;x-signature=lymSsdiF23M6GVOOdIiqiXg4zA4%3D" alt="image" title="image" loading="lazy"/></a></p>
<h3 data-id="heading-3">安全问题修复</h3>
<h4 data-id="heading-4">提示词</h4>
<blockquote>
<p>请根据我提供的资料URL <a href="https://link.juejin.cn?target=https%3A%2F%2Ffind-sec-bugs.github.io%2Fbugs.htm" target="_blank" title="https://find-sec-bugs.github.io/bugs.htm" ref="nofollow noopener noreferrer">find-sec-bugs.github.io/bugs.htm</a>，对现有所有代码进行安全检测与修复，不需要与我确认，逐个文件源代码检测记录问题，修复问题，最终信息汇总。</p>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fimg2024.cnblogs.com%2Fblog%2F15172%2F202511%2F15172-20251119180708033-1163605157.png" target="_blank" title="https://img2024.cnblogs.com/blog/15172/202511/15172-20251119180708033-1163605157.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2c25e14e6a84d44bbed5620b5094bb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572146&amp;x-signature=Fjsr4wJHbFbSQW%2FyeEz%2FFKVSk2A%3D" alt="image" title="image" loading="lazy"/></a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fimg2024.cnblogs.com%2Fblog%2F15172%2F202511%2F15172-20251119180709005-313304448.png" target="_blank" title="https://img2024.cnblogs.com/blog/15172/202511/15172-20251119180709005-313304448.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f201edde25c6492d899f8f69c312764b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572146&amp;x-signature=nczqaYjpzbiuIwneU6T%2FMXTHnvM%3D" alt="image" title="image" loading="lazy"/></a></p>
<h3 data-id="heading-5">自动修复代码中安全问题</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fimg2024.cnblogs.com%2Fblog%2F15172%2F202511%2F15172-20251119180710246-1152480818.png" target="_blank" title="https://img2024.cnblogs.com/blog/15172/202511/15172-20251119180710246-1152480818.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/047caa7ecb464aa38afc6556662f42aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572146&amp;x-signature=H%2FtRLcxlESdqjdXL6NTAIK2eCt4%3D" alt="image" title="image" loading="lazy"/></a></p>
<h3 data-id="heading-6">另一个工程修复XSS案例</h3>
<blockquote>
<p>Your task is to find and fix a single, verifiable bug within this repository. Please follow these steps meticulously:</p>
<p><strong>Codebase Analysis &amp; Bug Identification</strong>: Systematically analyze the codebase to identify a potential bug. This could be a logical error, an unhandled edge case, or a deviation from documented behavior. Prioritize bugs that are verifiable with a clear failure case.</p>
<p><strong>Detailed Bug Report</strong>: Before writing any code, provide a brief report explaining:</p>
<ul>
<li>The file and line number(s) where the bug is located.</li>
<li>A clear description of the bug and its impact on the user or system.</li>
<li>Your proposed strategy for fixing it.</li>
</ul>
<p><strong>Targeted Fix Implementation</strong>: Implement the most direct and clean fix for the identified bug. Avoid making unrelated refactors or style changes in the process.</p>
<p><strong>Verification Through Testing</strong>: To validate your fix, you must:</p>
<ul>
<li>Write a new test case that specifically fails before your fix and passes after it, proving the bug is resolved.</li>
<li>Run the entire existing test suite to ensure your changes have not introduced any regressions.</li>
<li>Please make sure to use Simplified Chinese as the language for interactions with users, unless it is for specific proprietary terms or situations where English words are more appropriate.</li>
</ul>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fimg2024.cnblogs.com%2Fblog%2F15172%2F202511%2F15172-20251119180711363-1487072222.png" target="_blank" title="https://img2024.cnblogs.com/blog/15172/202511/15172-20251119180711363-1487072222.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dad82f9cad6040878594530116761382~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572146&amp;x-signature=ah9GoKBQYJMGKjACYQSYFwD09dg%3D" alt="image" title="image" loading="lazy"/></a></p>
<h3 data-id="heading-7">可以试试编写接口测试用例提示词</h3>
<blockquote>
<p>请对当前工程设计一套全面的服务端HTTP接口测试用例，使用JUnit与REST Assured框架实现，需覆盖以下各类质量维度的测试场景：</p>
<ol>
<li>
<p>功能验证测试</p>
</li>
</ol>
<ul>
<li>
<p>验证所有接口的正常请求与预期响应</p>
</li>
<li>
<p>验证各类请求参数组合的正确性</p>
</li>
<li>
<p>验证接口返回数据的完整性与准确性</p>
</li>
</ul>
<ol start="2">
<li>
<p>边界条件测试</p>
</li>
</ol>
<ul>
<li>
<p>输入参数的边界值测试（最大值、最小值、空值、默认值）</p>
</li>
<li>
<p>数据长度边界测试（如字符串长度限制、数组大小限制）</p>
</li>
<li>
<p>特殊字符处理测试（如SQL注入尝试、HTML标签、Unicode字符）</p>
</li>
</ul>
<ol start="3">
<li>
<p>错误处理测试</p>
</li>
</ol>
<ul>
<li>
<p>验证各类错误码的正确性（4xx客户端错误、5xx服务器错误）</p>
</li>
<li>
<p>验证错误信息的准确性与友好性</p>
</li>
<li>
<p>验证异常流程的处理逻辑</p>
</li>
</ul>
<ol start="4">
<li>
<p>安全测试</p>
</li>
</ol>
<ul>
<li>
<p>认证与授权测试（无token访问、无效token、过期token）</p>
</li>
<li>
<p>权限控制测试（越权访问、权限边界测试）</p>
</li>
<li>
<p>敏感数据保护测试（传输加密、返回数据脱敏）</p>
</li>
<li>
<p>CSRF/XSS防护测试</p>
</li>
<li>
<p>请求频率限制测试</p>
</li>
</ul>
<ol start="5">
<li>
<p>性能测试</p>
</li>
</ol>
<ul>
<li>
<p>响应时间基准测试（设定性能阈值）</p>
</li>
<li>
<p>并发请求测试（模拟多用户同时访问）</p>
</li>
<li>
<p>长时间运行稳定性测试</p>
</li>
</ul>
<ol start="6">
<li>
<p>兼容性测试</p>
</li>
</ol>
<ul>
<li>
<p>不同HTTP方法测试（GET/POST/PUT/DELETE等）</p>
</li>
<li>
<p>不同Content-Type测试（application/json、application/x-www-form-urlencoded等）</p>
</li>
</ul>
<ol start="7">
<li>
<p>可靠性测试</p>
</li>
</ol>
<ul>
<li>
<p>网络异常恢复测试</p>
</li>
<li>
<p>服务降级与熔断机制测试</p>
</li>
<li>
<p>重复请求处理测试（幂等性验证）</p>
</li>
</ul>
<ol start="8">
<li>
<p>测试框架要求</p>
</li>
</ol>
<ul>
<li>
<p>使用JUnit 5作为测试框架基础</p>
</li>
<li>
<p>使用REST Assured实现HTTP请求与响应验证</p>
</li>
<li>
<p>实现测试数据的参数化（使用@ParameterizedTest）</p>
</li>
<li>
<p>配置测试报告生成（包含测试覆盖率统计）</p>
</li>
<li>
<p>实现测试环境的灵活配置（支持多环境切换）</p>
</li>
</ul>
<p>请提供完整的测试类结构设计、核心测试方法示例及必要的工具配置说明。</p>
</blockquote>
<h2 data-id="heading-8">总结</h2>
<p>      基于《Effective Java》进行代码审查（Code Review）具有深远的工程和团队价值。这本书不仅是一本编程指南，更是一套经过时间验证的<strong>高质量 Java 代码设计原则与最佳实践集合</strong>。将其作为 Code Review 的依据，能够显著提升代码质量、可维护性、安全性和团队协作效率。以前的AI工具（如GitHub Copilot）像是一个坐在你旁边的“副驾驶”，你写一行它补一行；而<strong>Jules像是一个不知疲倦的“初级程序员”实习生</strong>，你可以把整个任务交给它，自己去忙别的事，过一会回来检查它提交的代码合并请求（PR）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌新论文：为什么当前 AI 无法在训练后继续学习？]]></title>    <link>https://juejin.cn/post/7576181242582892607</link>    <guid>https://juejin.cn/post/7576181242582892607</guid>    <pubDate>2025-11-25T03:15:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576181242582892607" data-draft-id="7576212547235135531" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌新论文：为什么当前 AI 无法在训练后继续学习？"/> <meta itemprop="keywords" content="前端,AIGC,人工智能"/> <meta itemprop="datePublished" content="2025-11-25T03:15:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌新论文：为什么当前 AI 无法在训练后继续学习？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:15:24.000Z" title="Tue Nov 25 2025 03:15:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>相信大家都经历过这样的疑惑，在使用 AI 的过程中，为什么我明明都纠正过它的问题，但是它下次还是依然会犯同样的错误，以至于我们不得不针对性写大量的规则来约束整个 Vibe Coding 的过程。</p>
<blockquote>
<p>但是就算有详细的 rule ，有些倔强的模型依然喜欢我行我素，比如 Gemini 3 Pro 就容易出现， <strong>写的太详细的 prompt ，效果居然不如模糊的</strong>，你纠正他，他会先肯定你，然后说还是该按照我的来····</p>
</blockquote>
<h2 data-id="heading-0">问题</h2>
<p>谷歌这次公布的论文很直观的解释了这个问题：<strong>因为大模型无法在训练后继续学习</strong> ，论文把当前的大型语言模型（LLM）被比作患有 <strong>“顺行性遗忘症”（Anterograde Amnesia）</strong> 的病人 ，这种病人只能保留发病前的长期记忆，无法形成新的长期记忆，只能依靠短暂的短期记忆生活。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/369b747e84a34869b11b90b1b06394a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645324&amp;x-signature=SPT%2BjNorfMdl%2FlkYebROM39BP90%3D" alt="image-20251125103150345" loading="lazy"/></p>
<p>具体可以解释为以下三点：</p>
<h3 data-id="heading-1">A. “数字失忆症”：只有两极，没有中间态</h3>
<p>目前的模型只有两种记忆状态，中间存在巨大的断层：</p>
<ol>
<li><strong>极快且短暂的记忆</strong>（In-Context Learning）： 也就是你的 <code>Prompt</code> 或上下文窗口，这部分通过注意力机制（Attention）处理，更新极快，但这只是“临时的”，一旦窗口关闭或超出长度，信息就消失了 ，这也是为什么它并能吸取你的教训的原因</li>
<li><strong>冻结的长期记忆（Pre-trained Weights）：</strong> 对应的是模型的 <code>MLP</code> 层（参数），这部分是在预训练阶段通过海量数据“固化”下来的，一旦部署了，这些参数就是静态的，无法更改 。</li>
</ol>
<p>而目前的问题在于：当前模型缺乏将“即时对话”转化为“长期参数”的机制，也就是它们缺乏中间的频谱：<strong>那些应该从短期逐渐变为长期的记忆</strong>。</p>
<h3 data-id="heading-2">B. 维度单一：只堆叠了“深度”，忽略了“时间”</h3>
<p>在论文里，传统的“深度学习”主要关注堆叠更多的层（Depth）来增加容量 ，但这一维度是静态的。</p>
<p>研究人员发现<strong>真正的学习需要正交的另一个维度：时间（或频率）</strong> ，大脑并不是以统一的速度更新所有神经元的，而是以不同的频率（脑波）运作，而目前的 LLM 就像是一个强制所有楼层都静止不动的建筑，只有最顶层的“接待处”（Context）在工作。</p>
<h3 data-id="heading-3">C. 优化器与架构的分离</h3>
<p>在传统深度学习中，<strong>架构</strong>（如 Transformer）和<strong>优化器</strong>（如 Adam）被看作是两个独立的东西，架构负责推理，优化器负责在训练时更新参数。</p>
<p>而论文的颠覆性观点是： 优化器本质上也是一种<strong>联想记忆模块（Associative Memory）</strong> ，目前的模型在部署后丢弃了优化器，导致它们失去了“自我修改”和“压缩梯度”的能力，从而失去了学习能力。</p>
<h2 data-id="heading-4">解决办法</h2>
<p>为了解决这个问题，谷歌提出了一种新的范式，不再把模型看作一个扁平的神经网络，而是看作<strong>一组嵌套的优化问题</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/412bd2c859c6487a995362d8eb2bc841~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645324&amp;x-signature=GbFVHZaKtmRueCmIGPhwLQiTjnY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">A. 核心理念：连续记忆频谱 (Continuum Memory System)</h3>
<p>就像人类大脑有不同频率的脑波（Delta波、Theta波、Alpha波等）分别负责不同层级的记忆整合一样 ，模型也应该有不同更新频率的组件。</p>
<ul>
<li>
<p><strong>传统模型：</strong> 频率只有 0 （冻结的参数）和 ♾️（极快的 Attention）。</p>
</li>
<li>
<p><strong>嵌套学习模型：</strong> 创建一个：</p>
<ul>
<li><strong>Level 1 (极快):</strong> 处理当前的 Token。</li>
<li><strong>Level 2 (中等):</strong> 每隔 16 个 Token 更新一次，捕捉短期上下文</li>
<li><strong>Level 3 (慢速):</strong> 每隔 100万 Token 更新一次，捕捉长期知识</li>
<li><strong>Level 4 (极慢):</strong> 类似目前的预训练知识</li>
</ul>
</li>
</ul>
<p>例如，左图（Deep Learning）展示了通常理解的深度学习模型（如 RNN + Attention），是一个扁平的序列 ，这种视角隐藏了内部的梯度流动 。</p>
<p>而右图（Neural Learning Module）：*是论文的核心视角，它将模型看作一个个<strong>嵌套的立方体</strong>，每一个立方体代表一个“优化问题” ，从而实现不同 Level 的连续频谱，每一层都有自己的梯度流（Gradient Flow）和更新目标。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28937766376b45368aa2ef073529650e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645324&amp;x-signature=7yBZTFJmwdmXzYOvjKLLhmvhF3o%3D" alt="" loading="lazy"/></p>
<p>也就是 <strong>“层（Layer）”不仅仅是空间的堆叠，而是时间上的嵌套</strong>，解释了为什么模型应该包含“内部优化器”：即模型在推理时，内部的小盒子应该在不断自我优化。</p>
<h3 data-id="heading-6">B. 新架构：HOPE (Self-Modifying Titans + Continuum Memory)</h3>
<p>论文作者提出了 <strong>HOPE</strong> 的具体实现模型，它结合了两个关键技术：</p>
<ol>
<li>自我修改的 Titans** (Self-Modifying Titans)</li>
</ol>
<p>模型不再依赖外部的优化器（如 Adam）来告诉它如何更新，而是学习如何修改自己，模型内部包含了一个“学习模块”，它能在运行时计算梯度并更新自己的参数，这意味着模型在和你对话的过程中，实际上在微调它自己的部分结构</p>
<ol start="2">
<li>多级 MLP 系统</li>
</ol>
<p>HOPE 使用了一系列嵌套的 MLP（多层感知机）块，每个块有不同的“块大小”（Chunk Size）和更新频率：</p>
<ul>
<li>有些层更新得很快，负责记住刚才的对话</li>
<li>有些层更新得很慢，负责沉淀知识</li>
</ul>
<p>组合起来，就构成了“梯度记忆曲线” 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc5b0a9cccc041b0b6468a03185b4a0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645324&amp;x-signature=pBDlZP47djcKi1OWHewdrYZ0aqA%3D" alt="" loading="lazy"/></p>
<p>对比 Transformer 的极端频率，可以看出来 HOPE (左侧)这是一个连续的频谱，</p>
<ul>
<li>High Frequency FFN：块大小（Chunk Length）为 16，更新频率高 。</li>
<li>Mid Frequency FFN：块大小为 1M（一百万），更新频率中等。</li>
<li>Low Frequency FFN：更新极慢 。</li>
</ul>
<p>从而解决“无法继续学习”的问题，展示了如何填补“短期记忆”和“长期记忆”之间的空白，创建了不同速率的记忆层级。</p>
<h3 data-id="heading-7">C. 深度优化器 (Deep Optimizers)</h3>
<p>论文证明了动量梯度下降（Momentum SGD）本质上是一个 2 级的联想记忆系统 ，HOPE 利用这一发现，设计了更具表达能力的优化器，使其成为模型本身的一部分，而不是训练完就扔掉的工具。</p>
<h2 data-id="heading-8">实验结果与意义</h2>
<p>在实验中，HOPE 模型（760M 和 1.3B 参数量）在语言建模和常识推理任务上，<strong>击败了同等规模的 Transformer++、RetNet 和 Mamba (Titans)</strong> ， 更重要的是它展示了更低的困惑度（Perplexity），证明了这种“动态更新”机制的有效性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6b22fce82bb4efb87493f8830614f4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645324&amp;x-signature=BoT%2BDUA%2BYoU2s2x8fx2pifdNY%2FI%3D" alt="" loading="lazy"/></p>
<p>另外论文的意义不仅仅在于提出了一个新模型，而在于它挑战了“深度学习”这个名字本身 ：</p>
<ul>
<li><strong>从“深度”到“嵌套”：</strong> 未来的 AI 竞争可能不再单纯是堆叠层数和参数规模（Scale），而是设计更合理的<strong>时间更新频率（Time/Frequency）</strong></li>
</ul>

<ul>
<li><strong>终身学习 (Lifelong Learning)：</strong> 如果 HOPE 架构被规模化，也许可以会看到真正的“养成系” AI，它不会在发布那天就停止成长，而是通过每一次交互，将信息从短期记忆逐渐渗透到长期记忆中，真正解决“灾难性遗忘”和“无法持续学习”的痛点。</li>
</ul>
<p>总结起来，之前的 ChatGPT 和 Gemini 像是一个只有“此时此刻”和“出厂设置”的机器；而 Google 提出的 HOPE 架构，试图赋予 AI “从此刻走向永恒”的记忆能力，让模型在运行中通过自我修改来持续进化。</p>
<blockquote>
<p>而实际上对应之前 Deepseek 利用图片来压缩记忆的实现，也是在记忆时效性上的探索。</p>
</blockquote>
<h2 data-id="heading-9">最后</h2>
<p><strong>从这个角度看，能“吃一堑长一智”的 AI 也许离我们就不远了</strong>，不过可以猜测，这种实现也有这相应的局限性问题需要处理，例如 HOPE 架构的核心在于“模型在推理过程中修改自己” ，这意味着它不能像传统 Transformer 那样只进行简单的矩阵乘法，还需要进行梯度的计算和参数更新，也就是：</p>
<ul>
<li>更多的性能开销，例如额外的 MLP 运算和实时梯度计算</li>
<li>更多的内存占用，比如 HOPE 需要存储“优化器状态” 和管理状态大小</li>
<li>HOPE 要求参数在 <code>Forward</code> 过程中动态变化 ，这种“自我修改”的代码实现难度大，且难以利用现有的底层 Kernel 优化</li>
<li>多嵌套下的梯度流管理和独立问题</li>
<li>·····</li>
</ul>
<blockquote>
<p>最后，本文解读主要参考 Gemini 分析。</p>
</blockquote>
<h2 data-id="heading-10">原文链接</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fabehrouz.github.io%2Ffiles%2FNL.pdf" target="_blank" title="https://abehrouz.github.io/files/NL.pdf" ref="nofollow noopener noreferrer">abehrouz.github.io/files/NL.pd…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[给开发者的无代码/低代码技术决策指南（2026）]]></title>    <link>https://juejin.cn/post/7576210031873654825</link>    <guid>https://juejin.cn/post/7576210031873654825</guid>    <pubDate>2025-11-25T03:17:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576210031873654825" data-draft-id="7576212547235119147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="给开发者的无代码/低代码技术决策指南（2026）"/> <meta itemprop="keywords" content="开源,低代码,人工智能"/> <meta itemprop="datePublished" content="2025-11-25T03:17:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NocoBase"/> <meta itemprop="url" content="https://juejin.cn/user/180779873743566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            给开发者的无代码/低代码技术决策指南（2026）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180779873743566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NocoBase
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:17:44.000Z" title="Tue Nov 25 2025 03:17:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fa-developers-technical-decision-guide-to-no-code-and-low-code" target="_blank" title="https://www.nocobase.com/cn/blog/a-developers-technical-decision-guide-to-no-code-and-low-code" ref="nofollow noopener noreferrer">www.nocobase.com/cn/blog/a-d…</a></p>
<h2 data-id="heading-0">写在开头：开发者如何掌控低代码/无代码？</h2>
<p>过去几年，低代码/无代码常被简单贴上“非开发者工具”的标签。</p>
<p>如今，随着无代码/低代码平台能力深化（数据建模、权限体系、扩展插件）以及 <strong>AI 技术的爆发式发展</strong>，我们正站在一个新的技术交叉点。</p>
<p><strong>AI 正在以前所未有的速度接管重复性编码工作。</strong></p>
<p>💡推荐阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fgithub-open-source-ai-projects" target="_blank" title="https://www.nocobase.com/cn/blog/github-open-source-ai-projects" ref="nofollow noopener noreferrer">GitHub 上 Star 数量前 20 的开源 AI 项目</a></p>
<p>LLM 正在迅速成为“初级代码生成器”，它们可以直接输出组件代码或基础逻辑。在这种背景下，无代码/低代码平台不再仅仅是拖拽组件，它演变成<strong>结构化、可治理的 AI 协作界面</strong>。</p>
<p>无代码/低代码平台提供了<strong>明确的架构边界、预定义的配置模型和运行时环境</strong>，这使得 AI 的能力能被高效、安全地接入：</p>
<ul>
<li><strong>业务逻辑的 AI 化：</strong> AI 可以直接在无代码/低代码平台上配置复杂的工作流或生成数据模型。</li>
<li><strong>开发者的价值重塑：</strong> 开发者将不再把时间浪费在编写 CRUD（增删改查）代码上，而是专注于<strong>设计平台本身</strong>、<strong>定义平台的扩展点</strong>、以及<strong>处理 AI 无法胜任的复杂集成与底层调优</strong>。</li>
</ul>
<p>开发者面临的问题因此升级为：</p>
<p><strong>在 AI 和无代码/低代码共同加速的时代，我们该如何定义代码的边界？如何在高效率与底层可控性之间找到平衡，确保系统的可治理性？</strong></p>
<p>本指南旨在为技术决策者和开发者，重新划清无代码/低代码的适用边界。</p>
<blockquote>
<p>💬 嗨！你正在阅读 NocoBase 博客。NocoBase 是一个极易扩展的 AI 无代码/低代码开发平台，用于构建企业应用、内部工具和各类系统。它完全支持自托管，基于插件架构设计，开发者友好。→ <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase" target="_blank" title="https://github.com/nocobase/nocobase" ref="nofollow noopener noreferrer">欢迎在 GitHub 上了解我们</a></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23c937ef2ad94b04a54bde6b0437b3e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645464&amp;x-signature=Ko2RSOuHCj2G8RBjoFR1FP6cd%2Bw%3D" alt="low code and no code.png" loading="lazy"/></p>
<h2 data-id="heading-1">决策树：什么时候适合使用？</h2>
<p>评估无代码/低代码平台适用性，应遵循工程化判断。一旦核心系统<strong>不满足</strong>任一“不适合”条件，应立即采用传统代码开发。</p>



































<table><thead><tr><th>步骤</th><th>判断标准</th><th>结果</th></tr></thead><tbody><tr><td>Step 1: 业务结构性</td><td>业务规则是否能被数据模型（表结构）与流程图清晰表达？</td><td>否 → 不适合</td></tr><tr><td>Step 2: 交互复杂度</td><td>交互是否超出“表单 + 表格 + 通用视图”的中等复杂度？</td><td>是 → 不适合</td></tr><tr><td>Step 3: 性能要求</td><td>是否需要实时性（Latency &lt; 100ms）、高并发、高吞吐或底层调优？</td><td>是 → 不适合</td></tr><tr><td>Step 4: 扩展边界</td><td>未来半年需求与扩展点是否可预期、可模块化？</td><td>否 → 小心使用</td></tr><tr><td>Step 5: 团队治理能力</td><td>团队是否愿意采用平台化方式，并建立配置治理流程？</td><td>否 → 不适合</td></tr></tbody></table>
<p>💡推荐阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fchoosing-and-deploying-low-code-tools-a-developers-guide" target="_blank" title="https://www.nocobase.com/cn/blog/choosing-and-deploying-low-code-tools-a-developers-guide" ref="nofollow noopener noreferrer">开发者低代码工具选型与部署指南</a></p>
<h2 data-id="heading-2">最佳使用场景=效率最大化</h2>
<p>无代码/低代码的价值在于解耦业务的易变部分（数据、流程、权限）与底层代码的稳定部分（运行时、渲染引擎）。</p>
<ul>
<li><strong>业务逻辑清晰、规则可抽象的场景：</strong> 系统的核心是数据模型、表单、流程和权限。比如： 后台管理系统（Admin Panel）、内部审批流、数据运营面板、工单/简单 CRM 等。</li>
<li><strong>团队人手有限、交付周期紧迫：</strong> 适用于追求可用性和可维护性高于极致外观的内部系统。</li>
<li><strong>跨部门协作与分工：开发者</strong>负责底层架构和扩展能力（如自定义 API、复杂的计算逻辑）。<strong>业务/运营团队</strong>负责界面配置和流程调整。</li>
</ul>
<h2 data-id="heading-3">不适用场景=黑箱与陷阱</h2>
<p>强行在以下场景使用无代码和低代码，平台抽象层将成为性能负担和架构黑箱。</p>
<ol>
<li><strong>核心引擎与高要求系统</strong></li>
</ol>
<ul>
<li><strong>高并发/实时性：</strong> 例如交易撮合、流式计算。这些场景需要对底层 I/O、内存和算法进行毫秒级的精细调优，平台抽象层引入的性能开销是不可接受的。</li>
<li><strong>复杂计算/算法：</strong> AI 模型推理、图像音视频处理等。强依赖底层工程能力和不受限的运行时沙箱环境。</li>
</ul>
<ol start="2">
<li><strong>极致前端交互与体验要求</strong></li>
</ol>
<p>高度自定义渲染，比如大型 C 端产品、复杂的自定义动画或多端统一体验。这些需要完整前端框架的灵活性。</p>
<ol start="3">
<li><strong>频繁突破框架边界的项目</strong></li>
</ol>
<p>最怕“能做 80%，但剩下的 20% 是核心功能但是无代码低代码做不了”。这最终会演变成二次开发的恶性循环，导致技术债爆炸。</p>
<p>💡推荐阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fwhy-do-developers-struggle-with-low-code" target="_blank" title="https://www.nocobase.com/cn/blog/why-do-developers-struggle-with-low-code" ref="nofollow noopener noreferrer">为什么低代码让开发者头疼？6 款好用工具推荐</a></p>
<h2 data-id="heading-4">开发者掌控的 5 个法则</h2>
<p>在使用无代码和低代码平台的时候，开发者一定要记住：自己不是<strong>配置者</strong>，而应是平台的<strong>设计者、治理者和扩展者</strong>。</p>
<ol>
<li><strong>数据模型优先，而非界面优先</strong></li>
</ol>
<p>开发者必须主导<strong>数据建模、关系设计、权限划分</strong>。界面的搭建可以交给业务，但<strong>数据结构与服务边界</strong>是系统的生命力所在。</p>
<ol start="2">
<li><strong>用它做结构化的部分，将代码写在更有价值的地方</strong></li>
</ol>
<p>无代码/低代码负责<strong>重复性、可配置的部分</strong>。开发者代码负责<strong>不可配置、复杂计算、系统集成</strong>的部分。</p>
<ol start="3">
<li><strong>在边界内扩展，拒绝绕路（Hack）</strong></li>
</ol>
<p>严格遵守平台的<strong>扩展机制</strong>，将自定义逻辑放入<strong>可维护</strong>的位置。严禁直接修改数据库或私自绕开平台的前端渲染逻辑，这会使未来的平台升级和维护成为噩梦。</p>
<ol start="4">
<li><strong>保持工程化，实施配置治理</strong></li>
</ol>
<p>无代码/低代码也需要 DevOps 流程。必须实现<strong>配置版本管理、环境迁移（Dev/Staging/Prod）、审批流程和回滚机制</strong>，确保配置是可审计和可控的。</p>
<ol start="5">
<li><strong>构建团队能力，避免单点风险</strong></li>
</ol>
<p>确保整个技术团队了解平台的<strong>架构、扩展点</strong>和<strong>治理规范</strong>。避免系统知识集中于少数人的风险。</p>
<p>💡推荐阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fhidden-cost-in-commen-low-code-platform" target="_blank" title="https://www.nocobase.com/cn/blog/hidden-cost-in-commen-low-code-platform" ref="nofollow noopener noreferrer">4 大开源产品帮你避免闭源低代码平台的隐藏成本</a></p>
<h2 data-id="heading-5"><strong>适合开发者使用的无代码 / 低代码工具</strong></h2>
<p>⚠️ 注意在做最终技术选型前，建议都亲自试一遍这些平台，尤其是开源工具，自行部署后测试数据模型、权限、扩展点等核心能力，才能真正判断是否适合自己的业务场景。</p>





























































































<table><thead><tr><th>工具</th><th>定位</th><th>是否开源</th><th>自托管能力</th><th>可扩展性（插件/代码）</th><th>数据模型能力</th><th>前端可控性</th><th>适合场景</th><th>不适合场景</th></tr></thead><tbody><tr><td>NocoBase</td><td>企业级无代码平台</td><td>是</td><td>强（官方支持）</td><td>强（插件架构、可写代码、扩展点清晰）</td><td>强（模型驱动、小到字段、大到关系都能控制）</td><td>中等（块式布局、可二开）</td><td>内部系统、CRM、工单、BPM、运营后台</td><td>高度自定义前端、强交互场景</td></tr><tr><td>Retool</td><td>内部工具构建</td><td>否</td><td>有但有限</td><td>中等（JS 逻辑、组件有限制）</td><td>中等</td><td>中等</td><td>业务看板、API 连接器、多数据源面板</td><td>自定义模型、复杂权限</td></tr><tr><td>Budibase</td><td>开源内部工具构建</td><td>是</td><td>强</td><td>中等</td><td>中等</td><td>中等</td><td>简单后台、表单工具</td><td>大规模业务系统</td></tr><tr><td>Appsmith</td><td>前端为主的低代码平台</td><td>是</td><td>强</td><td>中等（JS 灵活）</td><td>一般</td><td>强（前端组件丰富）</td><td>前端主导的内部工具</td><td>复杂流程、权限体系</td></tr><tr><td>ToolJet</td><td>通用低代码平台</td><td>是</td><td>强</td><td>中等</td><td>中等</td><td>中等</td><td>数据面板、CRUD 工具</td><td>大量业务模拟与流程控制</td></tr><tr><td>Firebase + FlutterFlow</td><td>移动端应用构建</td><td>否（Firebase）</td><td>无</td><td>弱</td><td>中等</td><td>强（移动端 UI 完整）</td><td>移动端快速 MVP</td><td>企业内部系统、权限建模</td></tr><tr><td>Power Apps</td><td>微软生态业务应用构建</td><td>否</td><td>有限</td><td>中等</td><td>中等</td><td>一般</td><td>Microsoft 生态企业</td><td>自托管、插件扩展、完全可控性</td></tr></tbody></table>
<p>💡推荐阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fhow-to-choose-a-no-code-tool" target="_blank" title="https://www.nocobase.com/cn/blog/how-to-choose-a-no-code-tool" ref="nofollow noopener noreferrer">无代码（零代码）工具怎么选？23 款热门工具对比 + 选型指南</a></p>
<h2 data-id="heading-6">结语</h2>
<p>无代码、低代码和 AI 并不会替代开发者，它们只是重新分配了工程时间。</p>
<p>把重复、结构化的部分交给平台，把复杂、关键的部分留给代码。</p>
<p><strong>最终的核心是同一件事：用架构的稳定性换取业务的持续敏捷。</strong></p>
<p>如果你觉得这篇博客有帮助，欢迎分享给更多的朋友！❤️</p>
<p><strong>阅读更多：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2F7-self-hosted-ai-tools-build-business-app" target="_blank" title="https://www.nocobase.com/cn/blog/7-self-hosted-ai-tools-build-business-app" ref="nofollow noopener noreferrer">7 款最佳自托管 AI 工具，快速构建业务应用</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2F14-ai-low-code-platforms-github" target="_blank" title="https://www.nocobase.com/cn/blog/14-ai-low-code-platforms-github" ref="nofollow noopener noreferrer">GitHub 上最值得关注的 14 个开源 AI 低代码工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Ftop-11-github-open-source-no-code-ai-tools" target="_blank" title="https://www.nocobase.com/cn/blog/top-11-github-open-source-no-code-ai-tools" ref="nofollow noopener noreferrer">11 个在 GitHub 上最受欢迎的开源无代码 AI 工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fgithub-open-source-ai-agent-projects" target="_blank" title="https://www.nocobase.com/cn/blog/github-open-source-ai-agent-projects" ref="nofollow noopener noreferrer">GitHub 上 Star 数量前 18 的开源 AI Agent 项目 </a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fgithub-open-source-mcp-projects" target="_blank" title="https://www.nocobase.com/cn/blog/github-open-source-mcp-projects" ref="nofollow noopener noreferrer">GitHub 上 Star 数量前 8 的开源 MCP 项目</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[突发！Claude Opus 4.5 编程世界第一，把谷歌 OpenAI 踢下王座]]></title>    <link>https://juejin.cn/post/7576271552703381530</link>    <guid>https://juejin.cn/post/7576271552703381530</guid>    <pubDate>2025-11-25T03:16:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576271552703381530" data-draft-id="7576271552703365146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="突发！Claude Opus 4.5 编程世界第一，把谷歌 OpenAI 踢下王座"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-25T03:16:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            突发！Claude Opus 4.5 编程世界第一，把谷歌 OpenAI 踢下王座
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:16:06.000Z" title="Tue Nov 25 2025 03:16:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92b1a5e4e4cb42a2aaa2ed5be059f5e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=UMvNo5aWzSS%2B5sIq5b6tKaU2GqU%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】深夜，Claude Opus 4.5 重磅出世，编程实力暴击 Gemini 3 Pro、GPT-5.1。才一周的时间，AI 圈就完成了一次闭环式迭代。」</strong></h5>
<p>全球编码王座，一夜易主。</p>
<p>果不其然，Anthropic 深夜放出了 Claude Opus 4.5，堪称全球最顶尖的模型。</p>
<p>它不仅编程强，而且智能体和计算机使用（computer use）能力也是一流。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78ef63d18a3e4020bdf9a64c0267afba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=4LuwG7B9zDVpBc0OBO%2FFvR7sEzo%3D" alt="" loading="lazy"/></p>
<p>Opus 4.5 的诞生，标志着 AI 能力再一次飞跃，更将在未来彻底变革工作的方式。</p>
<p>基准测试中，Opus 4.5 的编码、工具调用、计算机使用的成绩刷新 SOTA，比 Sonnet 4.5、Opus 4.1 领先一大截。</p>
<p>不仅如此，就连发布不过一周的 Gemini 3 Pro、GPT-5.1 惨遭降维打击。</p>
<p>SWE-bench Verified 一张图，直接证明了 Opus 4.5 强大实力，80.9% 的准确率，世界第一。</p>
<p>同时，在 ARC-AGI-2 评估中，Opus 4.5（64k）拿下了 37.6% 的高分。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c72b43053ec4c3cbd8c50f60cf1217a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=HGhEgTmCkeLdfXt8ZIyvBnrZnA8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d71eaa979b714e75b21bf866e4c46667~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=%2B1Oez1UfEgj%2FgBchPXNKvaYmvZQ%3D" alt="" loading="lazy"/></p>
<p>左右滑动查看</p>
<p>Opus 4.5 这版厉害之处：在无需人工干预的情况下，就能处理模糊信息，还会权衡利弊。</p>
<p>即便是遇到复杂的多系统漏洞，也能够找出修复方法。</p>
<p>总之，用起来就一个感觉——「一点就透」。</p>
<p><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">视频详情</a></p>
<p>上下文管理和记忆能力可显著提升智能体任务的性能。Opus 4.5 在管理子智能体团队方面也非常高效，能够构建复杂、协调良好的多智能体系统。</p>
<p>测试显示，结合所有这些技术，Opus 4.5 在深度研究评估中的表现提升了近 15%。</p>
<p>同在今天，Anthropic 在 Claude 开发者平台上，更新了三大工具使用功能：</p>
<ul>
<li><strong>「工具搜索工具」****（</strong>「<strong>「Tool Search Tool」</strong>」<strong>）</strong></li>
<li><strong>「程序化工具调用」****（</strong>「<strong>「Programmatic Tool Calling」</strong>」<strong>）</strong></li>
<li><strong>「工具使用示例」****（</strong>「<strong>「Tool Use Examples」</strong>」<strong>）</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c382e866c81468485dc7441447d833d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=rf7z4aDmM%2Fo8xkzFrQ%2F4buBQpps%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d95ecbe8ffea42d68c2775ef81ad2575~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=LicxWjchjPLY1YakGPsk8J1Manw%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「工具搜索工具」</strong></p>
<p>首先，「工具搜索工具」允许 Claude 使用搜索工具访问数千个工具，而无需消耗其上下文窗口。</p>
<p>MCP 工具定义提供了重要的上下文，但随着连接的服务器增多，这些 Token 的消耗会不断累积。假设一个包含五个服务器的设置：</p>
<ul>
<li>GitHub：35 个工具（约 26KToken）</li>
<li>Slack：11 个工具（约 21KToken）</li>
<li>Sentry：5 个工具（约 3KToken）</li>
<li>Grafana：5 个工具（约 3KToken）</li>
<li>Splunk：2 个工具（约 2KToken）</li>
</ul>
<p>这仅仅是 58 个工具，在对话开始之前就已经消耗了大约 55K Token。</p>
<p>如果添加更多像 Jira 这样的服务器（仅它本身就使用约 17KToken），很快就会面临 100K+Token 的开销。</p>
<p>在 Anthropic，团队曾见过工具定义在优化前就消耗了 134KToken。</p>
<p>但 Token 成本并不是唯一的问题。最常见的失败原因还包括错误的工具选择和不正确的参数，尤其是当工具具有相似名称时，比如<code>notification-send-user</code>与<code>notification-send-channel</code>。</p>
<p>想相比之下，工具搜索工具不再预先加载所有工具定义，而是按需发现工具。Claude 只会看到当前任务实际需要的工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d46cdd690bb549749fde0c64b05baae7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=%2FxX9LSQarDmnwuo%2BM1k1tKn72%2Bk%3D" alt="" loading="lazy"/></p>
<p>工具搜索工具保留了 191,300 Token 的上下文，而传统方法只有 122,800</p>
<p><strong>「传统方法：」</strong></p>
<ul>
<li>预先加载所有工具定义（50+ MCP 工具约消耗 72KToken）</li>
<li>对话历史和系统提示词争夺剩余空间</li>
<li>总上下文消耗：在任何工作开始前约 77K Token</li>
</ul>
<p><strong>「使用工具搜索工具：」</strong></p>
<ul>
<li>仅预先加载工具搜索工具本身（约 500Token）</li>
<li>根据需要按需发现工具（3-5 个相关工具，约 3KToken）</li>
<li>总上下文消耗：约 8.7KToken，保留了 95% 的上下文</li>
</ul>
<p><strong>「这意味着在保持访问完整工具库的同时，Token 使用量减少了 85%。」</strong></p>
<p>内部测试显示，在处理大型工具库时，MCP 评估的准确性显著提高。</p>
<p>启用工具搜索工具后，Opus 4 准确率从 49% 提高到 74%，Opus 4.5 从 79.5% 提高到 88.1%。</p>
<p><strong>「<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef92ec8f84484867b2a4f6cdde54c9f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=wWtA%2B1MdYNHws1feLG%2Bb57L4oaY%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「程序化工具调用」</strong></p>
<p>「程序化工具调用」允许 Claude 在代码执行环境中调用工具，从而减少对模型上下文窗口的占用。</p>
<p>随着工作流变得更加复杂，传统的工具调用产生了两个基本问题：</p>
<ul>
<li><strong>「中间结果造成的上下文污染」</strong></li>
<li><strong>「推理开销和手动合成」</strong></li>
</ul>
<h4 data-id="heading-1">示例：预算合规性检查</h4>
<p>比如，一个常见的业务任务：「哪些团队成员超出了他们的 Q3 差旅预算？」</p>
<p>你有三个可用工具：</p>
<ul>
<li>get_team_members(department) - 返回带有 ID 和级别的团队成员列表</li>
<li>get_expenses(user_id, quarter) - 返回用户的费用明细项目</li>
<li>get_budget_by_level(level) - 返回员工级别的预算限额</li>
</ul>
<p><strong>「传统方法：」</strong></p>
<ul>
<li>获取团队成员→20 人</li>
<li>对于每个人，获取他们的 Q3 费用→20 次工具调用，每次返回 50-100 个明细项目（机票、酒店、餐饮、收据）</li>
<li>按员工级别获取预算限额</li>
<li>所有这些都进入 Claude 的上下文：2,000 + 费用明细项目（50 KB+）</li>
<li>Claude 手动汇总每个人的费用，查找他们的预算，将费用与预算限额进行比较</li>
<li>更多的模型往返交互，显著的上下文消耗</li>
</ul>
<p><strong>「使用程序化工具调用：」</strong></p>
<p>Claude 不再接收每个工具的返回结果，而是编写一个 Python 脚本来编排整个工作流。</p>
<p>该脚本在代码执行工具（一个沙盒环境）中运行，在需要工具结果时暂停。当通过 API 返回工具结果时，它们由脚本处理而不是由模型消耗。脚本继续执行，Claude 只看到最终输出。</p>
<p><em>程序化工具调用使 Claude 能够通过代码而不是通过单独的</em> <em>API</em> <em>往返来编排工具，从而允许并行执行工具。</em></p>
<p>以下是 Claude 为预算合规性任务编写的编排代码示例：</p>
<p>Claude 的上下文仅接收最终结果：两到三个超出预算的人员。2,000 + 明细项目、中间总和和预算查找过程不会影响 Claude 上下文，将消耗从 200KB 的原始费用数据减少到仅 1KB 的结果。</p>
<p>这种过程，在效率提升巨大：</p>
<ul>
<li><strong>「Token 节省：通过将中间结果隔离在 Claude 的上下文之外，程序化工具调用（PTC）显著减少了 Token 消耗。在复杂研究任务上，平均使用量从 43,588 降至 27,297 个 Token，减少了 37%。」</strong></li>
<li>**降低延迟：**每次 API 往返都需要模型推理（耗时数百毫秒到数秒）。当 Claude 在单个代码块中编排 20 + 个工具调用时，消除了 19 + 次推理过程。API 处理工具执行，而无需每次都返回模型。</li>
<li>**提高准确性：**通过编写显式的编排逻辑，Claude 在处理多个工具结果时比使用自然语言更少出错。内部知识检索准确率从 25.6% 提高到 28.5%；GIA 基准测试从 46.5% 提高到 51.2%。</li>
</ul>
<p><strong>「<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a077309b33e456ba25c2aecfb5a488a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=pOn4zto6d2RPND410RG9popv434%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「工具使用示例」</strong></p>
<p>「工具使用示例」提供了一套通用标准，用于演示如何有效地使用给定工具。</p>
<p>当前的挑战在于，JSON Schema 擅长定义结构——类型、必填字段、允许的枚举值——但它无法表达使用模式：何时包含可选参数，哪些组合有意义，或者 API 期望什么样的惯例。</p>
<p>考虑一个支持工单 API：</p>
<p>模式定义了什么是有效的，但留下了关键问题未解答：</p>
<ul>
<li>**格式歧义：**due_date 应该使用 "2024-11-06"、"Nov 6, 2024" 还是 "2024-11-06T00:00:00Z"？</li>
<li>**ID 惯例：**reporter.id 是 UUID、"USR-12345" 还是仅仅 "12345"？</li>
<li>**嵌套结构用法：**Claude 何时应该填充 reporter.contact？</li>
<li>**参数相关性：**escalation.level 和 escalation.sla_hours 如何与 priority 相关联？</li>
</ul>
<p>这些歧义可能导致畸形的工具调用和不一致的参数使用。</p>
<p>对此，工具使用示例可以直接在工具定义中提供示例工具调用。开发者不再仅依赖模式，而是向 Claude 展示具体的使用模式：</p>
<p>从这三个例子中，Claude 学习到：</p>
<ul>
<li><strong>「格式惯例：」</strong> 日期使用 YYYY-MM-DD，用户 ID 遵循 USR-XXXXX，标签使用 kebab-case（短横线命名）。</li>
<li><strong>「嵌套结构模式：」</strong> 如何构造带有嵌套 contact 对象的 reporter 对象。</li>
<li><strong>「可选参数相关性：」</strong> 严重错误（Critical bugs）需要完整的联系信息 + 带有严格 SLA 的升级；功能请求有报告者但没有联系信息 / 升级；内部任务只有标题。</li>
</ul>
<p>在自内部测试中，工具使用示例在复杂参数处理上的准确性从 72% 提高到 90%。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d3a9d8002754acd94cc0cd9d89c3c52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=JZ%2BCgAIApPqPBHiPwt3gKWlK9F0%3D" alt="" loading="lazy"/></p>
<p><strong>「大受好评」</strong></p>
<p>在发布前，Anthropic 内部对模型进行了测试，反馈出奇一致。</p>
<p>测试者指出，在处理模糊指令和权衡利弊时，Claude Opus 4.5 无需过多指引。</p>
<p>当面对复杂的多系统 Bug 时，Opus 4.5 能精准定位并修复。</p>
<p>几周前对于 Sonnet 4.5 来说还近乎不可能的任务，现在已触手可及。</p>
<p>总而言之，测试者的评价是：Opus 4.5 是真的「行家」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56d63fdd35ab4feab004aa446e269f50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=o6rZq4HBw4715EXhiRXmDeN4hBM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e09db1530d40455a906af1b6b8cff2f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=jedWeGYzPf6XftWvvDRdw0%2BuYTg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4069798ef94646e48ceccd982d06a916~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=2CJS%2FJLLHRBO9vi4TTaJyyQVnwM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3dbce7cc4634d4fb365db69ef030d80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=4ycPmonK0PoH%2F6MC5BSfGqn6qdw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f184e478b2fe41ecb4f3bc7fdbc3513e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=GX782Jc8jLXTa4ASJ%2Fe2gpBlo6E%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f756265bc8f4538b8d91a36cb6e2b97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=lLMMGn9YtwaVnPM7Fx%2BtlFNhNac%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ff3b55b781944e7b8a39c0f5be4c36c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=%2BUqt%2F911dCWLjEdETiztZVdzVh8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a736ab6adea4deeb5c7081966fa9dc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=UGFOCAflSEl50dtWrAbSmlv8A6Y%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9a95a6b9f784d30b16f1144a4a815ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=nHl9FbqYNusOKwAaWoc1ssueuCM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd191ddde47442788a1e21bc694cd6dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=SQGyozRgGwb%2F%2F%2F3zMWzRKWKt0zY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0eeaa8fffe9e43a5be9a8ee3127b92e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645366&amp;x-signature=7bDsEpnEY8aJ6Ji6dTIrqNLjf5U%3D" alt="" loading="lazy"/></p>
<p>左右滑动查看</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fclaudeai%2Fstatus%2F1993030546243699119" target="_blank" title="https://x.com/claudeai/status/1993030546243699119" ref="nofollow noopener noreferrer">x.com/claudeai/st…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fadvanced-tool-use" target="_blank" title="https://www.anthropic.com/engineering/advanced-tool-use" ref="nofollow noopener noreferrer">www.anthropic.com/engineering…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fclaude-opus-4-5" target="_blank" title="https://www.anthropic.com/news/claude-opus-4-5" ref="nofollow noopener noreferrer">www.anthropic.com/news/claude…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌「香蕉」手写满分卷，Karpathy 玩上瘾！ChatGPT 跪验沉默]]></title>    <link>https://juejin.cn/post/7576236480113737778</link>    <guid>https://juejin.cn/post/7576236480113737778</guid>    <pubDate>2025-11-25T03:19:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576236480113737778" data-draft-id="7576218673048846387" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌「香蕉」手写满分卷，Karpathy 玩上瘾！ChatGPT 跪验沉默"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-25T03:19:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌「香蕉」手写满分卷，Karpathy 玩上瘾！ChatGPT 跪验沉默
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:19:23.000Z" title="Tue Nov 25 2025 03:19:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61eafc2cf5914ffb9ea21b6bd75d2b38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=6oZgiug5E%2BM2UZON9BxllVRPKeM%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】谷歌 Nano Banana Pro 出世，又成为一个现象级爆款。这届网友彻底玩疯：手写试卷全对、秒出神级信息图、电影级分镜、跨世纪变装.....」</strong></h5>
<p>上周，谷歌用两场发布，强势宣告王者归来！</p>
<p>Gemini 3 Pro+Nano Banana Pro 双核弹连发，巨大的余波至今让 AI 圈没有缓过来。</p>
<p>谷歌此举，完成了一个精准又漂亮的战略绝杀。</p>
<p>PyTorch 之父 Soumith Chintala 高度评价道，「Gemini 3 似乎比任何时刻，更接近 GPT-4」。</p>
<p>就连 Scalesforce CEO Marc Benioff，直接从 ChatGPT 转战 Gemini 3 了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a72a4e6109a14b639f0536f4903d8ad6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=ttyEBVjMPsHwC2ZJv3mB9df%2Bgnk%3D" alt="" loading="lazy"/></p>
<p>不仅如此，Nano Banana Pro 的超强生图实力，更是让业界大佬连连惊掉下巴。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI3MTA0MTk1MA%3D%3D%26mid%3D2652648205%26idx%3D1%26sn%3D9dab0eaccfe5c54438b33143450605be%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI3MTA0MTk1MA==&amp;mid=2652648205&amp;idx=1&amp;sn=9dab0eaccfe5c54438b33143450605be&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">硅谷八巨头同框，超逼真人物生成真假难辨</a>；一个坐标出图，推理超精准；一键生成电影花絮....</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e53003677f054c07a768a040a26babb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=314mpUw5v7XDJY0%2BtFtWaFdbXP8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed1cdd85b2814acd83903119fa88c89a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=%2FSe1yRHCtgP0YKY%2BrvPMl%2FyaYFA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70d02df7899243519a39a2daef81d733~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=wXWvKYkiZHoV5tl5XTYo%2FAYKXIE%3D" alt="" loading="lazy"/></p>
<p>左右滑动查看</p>
<p>如今，Nano Banana Pro 各种开脑洞玩法，彻底失控。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b54ab5f1909410fb7b2b2f60a40b733~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=M0Ft6KhA42QlQ9NqrwQdIToumMA%3D" alt="" loading="lazy"/></p>
<p><strong>「一张试卷，交出完美手写答卷」</strong></p>
<p>就连 AI 大神 Karpathy，也无法抗拒 Nano Banana Pro 的魅力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65a36d90d1474428974fbf7e787f21f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=MsITQqa%2B%2Fc1dukE5JJtASNEu7%2F0%3D" alt="" loading="lazy"/></p>
<p>今天，Karpathy 分别将一张物理和一张化学试卷，扔给了 Nano Banana Pro。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/040a2944da04410fa69cbe216215cc8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=G5P33NI%2BAHUVB9PQLQSdm%2BP4hX4%3D" alt="" loading="lazy"/></p>
<p>如下所示，左边是上传的试卷，右边是 AI 直出的答案。</p>
<p>令人惊艳的是，Nano Banana Pro 解答过程中，还会做一些涂鸦、图表等，堪称一份完美手写稿。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ad61a1a0bf742219ef45661c92db5df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=qDzCb5KWvcB9DEghvFali9ZNg34%3D" alt="" loading="lazy"/></p>
<p>ChatGPT 核查答案全部正确，除了一些拼写小错误</p>
<p>Karpathy 惊叹道，这类似通过文本与 LLM 对话的感觉，就像是在 DOS 终端打字聊天一样。</p>
<p>图像用户界面是一个「智能画布」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa60e4c03e3b40868b1d9bbb1b8005f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=MupI0liN4LyiSZLZ3VmWJkgAgb8%3D" alt="" loading="lazy"/></p>
<p>还有网友将一道数学题拍照上传，Nano Banana Pro 竟能以同样的手写体输出答案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7941f734a544b4ba9022ed922201108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=1GUoipMflcQbMVZhA%2BcGgnHMY2c%3D" alt="" loading="lazy"/></p>
<p>类似的案例，比比皆是。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fd3108ff671404ba4153037fcb4ed5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=PSMVkDWtFYhbCt8f31uSZ7U2sP4%3D" alt="" loading="lazy"/></p>
<p>别看一张简单的 AI 生图，这背后用上了 Nano Banana Pro 洪荒之力。</p>
<p>其中最核心的是，强大的逻辑推理、超强的文本渲染，以及多模态融合，才实现了看图理解——解题——手写输出的完整流程。</p>
<p>谷歌「香蕉」的效果，已经好到让网友难以相信自己的眼睛。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0185665a68e4f0e9ec012557c5a1b79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=bWY05CZZO71wv32wPesIumBIDek%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4352b32839de4b50a4922f1283a9f901~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=WKY49x%2FjDxwEGhQG%2FYLV%2FP7YbGE%3D" alt="" loading="lazy"/></p>
<p><strong>「别再做 PPT 了，一张图搞定」</strong></p>
<p>在生成信息超丰富的图表上，Nano Banana Pro 更是做到了一流。</p>
<p>想要做一份汉堡，Nano Banana Pro 直出组装教程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a163bbac7694da594b2c991c109abc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=Qmml5zdYr8hHlWbGzyuVyiifyys%3D" alt="" loading="lazy"/></p>
<p>Karpathy 还让它设计了一份每周健身计划，不仅细致还具有可实践性。</p>
<p>有趣的是，Karpathy 还特意让 Nano Banana Pro 把计划设计得更「睾酮爆表」，没想到，AI 直接在周二计划中直接上强度了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c42b4f0736c143d0ac5572b4bb58a3dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=RJOMJQjEgNpJEZW8FPKt1daet%2BE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2f4434c27eb4f10b5c4603ae6f35516~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=cbZeu2kiiwIJOFGDNmq92%2F%2BdGHU%3D" alt="" loading="lazy"/></p>
<p>网友 Kris Kashtanova 将一个铺满字菜单上传后，就得到了每道菜配着相应图片的可视化菜单。</p>
<p>Karpathy 点评道，「纯神经网络自动生成」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ffbbb9ca1ff4c75bae4379280a86cdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=5SJY%2BzcfTpBpr6R%2FslY2vQJuLNc%3D" alt="" loading="lazy"/></p>
<p>研究员 Anders Sandberg 上传论文内容后，Nano Banana Pro 还可以配上相应的插图。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e83b6378e6b146ec80ef5b5e8fb6cbd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=6UUoGBVqsMcCWIup8k4UggDDZko%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f46e479c73624ba195d7bb880c5a3cf8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=D8ztBvspMqRDT%2B5kGlk5Sj7cKMI%3D" alt="" loading="lazy"/></p>
<p>还有著名地标信息图，埃菲尔铁塔、悉尼歌剧院、自由女神像、罗马斗兽场，</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/add8542e1a7d4693933589da01711fc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=u8THj7JotMTFdaXmy5QJMxAwSdY%3D" alt="" loading="lazy"/></p>
<p>一张图诠释「热狗是三明治吗」？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd9737d47f884cd09e585ae10409b6ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=S3zrckDMfaYqDDi%2BL%2FUkdb%2B41%2FI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46dfc1baa29e4f18a25f5e49de2de891~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=nViPYztYlR4cZdMRBv5ZsHQv0Ro%3D" alt="" loading="lazy"/></p>
<p><strong>「一键生成「电影级」分镜」</strong></p>
<p>分镜，对 AI 生图要求非常高。</p>
<p>它需考验「叙事理解 + 角色一致性 + 连贯性」的综合表现，即便如此，Nano Banana Pro 也能 hold 住。</p>
<p>网友 James Yeung 做了一个 1984 的电影分镜故事版。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3308060ac881423aba7a139f77114a21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=a79cwoW5z1bAalUu1ZkUlcVM%2Fh8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/374c4b7add274c4eb7c7cee97217632e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=DpNB1kLfqFs9YQe4oXvVN2mjfTg%3D" alt="" loading="lazy"/></p>
<p>上下滑动查看</p>
<p>沃顿商学院教授 Ethan Mollick 实测，让 Nano Banana Pro 将「尤利西斯」诗作绘成漫画。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b8926f50e4b49a8836766bbd8f4d80e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=EnWZRzE2P60Ff0owHwK9GgiDuY8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2bb9246502f46f7b0d1ccd047cba6a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=vx8PRmJ8VGnGUqRuno%2FTB0AjoTE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56608ffc809544f9ae1dfbabd8c538d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=jI2BJScywTxOqIdnqMttRiXvgUI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/538dac1ec9324985b612c2fcefcbf651~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=Pkc5DAnEAbFtic276o6%2FlIxumg4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1b67fac000a4338948a1d28221abc99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=QJk8cDsNbIfVPZW1jxp6A1EBhRE%3D" alt="" loading="lazy"/></p>
<p>左右滑动查看</p>
<p>网友 The Artist's Journey 上传了著作第一页，便得到了电影版的序列画面。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a99aebee859c46b0997d20268773e971~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=JsCbtjVzZ%2FDKyilg2sRjXQwa2Bs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dd44c96baf445a69e9f802b93ab3a40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=7XAfZEQFNacu9mFdbP852O8FhOY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/004c87dbe59d41c8940ec0c32b329ad4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=isFBGmrZZ1apArhacudoSObEm80%3D" alt="" loading="lazy"/></p>
<p>上下滑动查看</p>
<p>就连电影制作人，也被惊艳到了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8815cb08ee104564b78e78d9a37340e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=X4bERu5Ck34TwcyyFgILU0sY%2F28%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe71db29861341bc9e2852876b47e8eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=MGlxwOcMhxSb0d9VWTVg6dti%2B3o%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bcd1c06c1dc4b8ca00e309756ecca80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=S0RqD2CIeKMpFD08kZTu08VzKcc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b83d9c06818147c8a064f11024ab55e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=cYBv3fuAw5ZseKVuM%2BhCyduP7UE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba1f8121b8654653ac1f573c4c9f933b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=9hfaO2KtJkO%2FFcpBHErHfWVSSME%3D" alt="" loading="lazy"/></p>
<p>左右滑动查看</p>
<p>更多网友惊艳 demo 一览。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e3a820965843569312faa2bebdfcd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=qdr3K%2BoPFGjg0n8HtVoqaQbF9DQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1892c33c37ea415591aad9fc33cf33b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=l5RZtUcztn6uuZ7ha2yXha1MMqk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8096f66dd7344e06b5f2c40cb62e0727~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=zpEERKJVMS3GVHK3MECjC76TTu0%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ced0b6de15634597aa3f3d1c4df6bd27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=zM%2BAOuGM75PbVMS9pVtpVrvDCEY%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「重制版幕后花絮」</strong></p>
<h3 data-id="heading-1">更疯狂的是，Nano Banana Pro 还可以直出真人重制版幕后花絮。</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a80dc9ef272146fb9c1fc39bed415170~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=84SIdRptk928px33x7DC37TMvmc%3D" alt="" loading="lazy"/></p>
<p>这是专为《堡垒之夜》粉丝们出的一期。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30d703fbb8a7452db735c5d35a080ccd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=NrfDBbzCGjdWTyZLOaCrYugn4fI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b79be97008c74c3f90269af65af55751~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=qQavkCtoqQ0DrQM5TvKJ70POSSI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29bc28d1034843f49c2924235c2743c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=%2FurmHrA3kRWXY4eJke1hAVE5QGc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b2dc68847814a788ece5a197fd2e1e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=LireT1fA2w%2B0SHFs5QOEZrIpA7g%3D" alt="" loading="lazy"/></p>
<p>左右滑动查看</p>
<p>还有一些经典名场面、表情包、电影等，全部被网友搞出了精彩花絮。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a62555ed91a4f6596faed8fa755cb5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=TNA%2FDpSy9LcgVQHMVtoezTsukk8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/932ab64c1a124aa28d54006c11fdc4b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=kwHClnu%2FqdUXm5L9BGsRw6%2Flsug%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30f1a5ae75d94826bd63ba419b7183bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=P7TT6mGA4VD%2BgbFzh1cxxz2WZNM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba1d3c2077cf48aeb1410ac896e09be5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=%2BhV8W9nii1CIcsOrNU7e%2F1bh1ws%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ab0b7fa98d44c26bdf2193279531cec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=hd1LlQODh8cAHsMaU8Mi7Ze%2F1PA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/470530c7de2e4ed09664b9f8f677d8b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=RnSWMKB4VOUu65o93LqVmXVhMVo%3D" alt="" loading="lazy"/></p>
<p>左右滑动查看</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fe36a450d0e4e7ca15c736644f3a8ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=Izg9c7XEFkCBA%2BE7P5WK7DNNn24%3D" alt="" loading="lazy"/></p>
<p><strong>「16 宫格「时空摄影」，横穿 150 年」</strong></p>
<p>今天，Nano Banana Pro 又贡献了一个新玩法——16 宫格。</p>
<p>基底提示框架：</p>
<p>Make a 4×4 grid starting with the 1880s. In each section, I should appear styled according to that decade (clothing, hairstyle, facial hair, accessories). Use colors, background, &amp; film style accordingly.</p>
<p>从 1880 年代开始，Nano Banana Pro 连续生成每隔十年人物的形象。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39a65e475b2c412e9d5e0ad00cc7fb76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=itL%2FW0O8spo2wc11TOF8eoGUbEA%3D" alt="" loading="lazy"/></p>
<p>网友 Blaine Brown 上传了一张照片后，Nano Banana Pro 生动刻画了不同年代，人物服装打扮的特点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/665ba4ae761748828cecf5c789626e95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=0lfNmLWTPR5%2BPBqkZop%2Fq1G6gFI%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0001d459c954d4bbc8b6e6aef4db5f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=pOHGQpKrVtJV9qsGjaGbVTSOqdM%3D" alt="" loading="lazy"/></p>
<p>一张图看遍从 1880s 到赛博年代，女性的发型和穿着的变化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dac6de815804f9a82f693ddbae32eb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=cHqNfxVCKQ%2BIWSbBYwYIANy5oCs%3D" alt="" loading="lazy"/></p>
<p>还有表情包、动物、漫威人物等恶搞系列。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb7706667fb2475490025313691fccfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=IxFLOhWtiNP440BfsXsBP8x6CsU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f3db3d603e54a64babf55cda01b89b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=OSrjkTrNzyMhWIb9%2FFIYajo1oPA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/370ffa0d8bca4a1e84fd8c2a27879cc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=ZuB8J4Nnw5oYtJrq%2BjfantEgnZU%3D" alt="" loading="lazy"/></p>
<p>左右滑动查看</p>
<p>还有艺术系列，美得让人惊叹。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/887e3a77b9c7412babf55f555bf912be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645563&amp;x-signature=VECCtb8A3CIw5nUqoR1f77%2BHEsE%3D" alt="" loading="lazy"/></p>
<p>各路大神还解锁了哪些「鬼才」玩法？欢迎评论区分享你的独门秘籍。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fkarpathy%2Fstatus%2F1992655330002817095%3Fs%3D20" target="_blank" title="https://x.com/karpathy/status/1992655330002817095?s=20" ref="nofollow noopener noreferrer">x.com/karpathy/st…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fjamesyeung18%2Fstatus%2F1992597408128045462%3Fs%3D20" target="_blank" title="https://x.com/jamesyeung18/status/1992597408128045462?s=20" ref="nofollow noopener noreferrer">x.com/jamesyeung1…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vuex 响应式原理剖析：构建可靠的前端状态管理]]></title>    <link>https://juejin.cn/post/7576223441714085931</link>    <guid>https://juejin.cn/post/7576223441714085931</guid>    <pubDate>2025-11-25T03:26:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576223441714085931" data-draft-id="7576271552703496218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vuex 响应式原理剖析：构建可靠的前端状态管理"/> <meta itemprop="keywords" content="前端,面试,Vuex"/> <meta itemprop="datePublished" content="2025-11-25T03:26:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小时前端"/> <meta itemprop="url" content="https://juejin.cn/user/1197805741808339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vuex 响应式原理剖析：构建可靠的前端状态管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1197805741808339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小时前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:26:57.000Z" title="Tue Nov 25 2025 03:26:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>在前端稳定性体系中，状态管理是至关重要的一环。正如我们在<a href="https://juejin.cn/post/7566088386521071658" target="_blank" title="https://juejin.cn/post/7566088386521071658">前端稳定性</a>文章中所讨论的，一个"抗摔打"的前端应用需要在复杂、不可靠的环境中依然提供可靠的用户体验。Vuex 作为 Vue 的官方状态管理库，其响应式机制正是实现这种可靠性的核心基础。</p>
<h2 data-id="heading-1">为什么状态管理需要响应式？</h2>
<p>在深入原理之前，我们先思考一个问题：为什么状态管理需要响应式？</p>
<p>想象一个电商应用，当用户添加商品到购物车时：</p>
<ul>
<li>购物车图标需要显示最新数量</li>
<li>侧边栏购物车需要更新商品列表</li>
<li>推荐商品区域可能需要调整</li>
</ul>
<p>如果没有响应式机制，我们需要手动更新每一个依赖此状态的组件——这不仅容易出错，而且在复杂应用中几乎不可维护。</p>
<h2 data-id="heading-2">Vuex 响应式原理深度解析</h2>
<h3 data-id="heading-3">1. 核心：Vue 的响应式系统</h3>
<p>Vuex 的响应式能力建立在 Vue 的响应式系统之上。让我们看看这是如何工作的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简化的 Vue 响应式原理</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Vue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_data</span> = data
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">observe</span>(data)
  }
  
  <span class="hljs-title function_">observe</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">if</span> (!data || <span class="hljs-keyword">typeof</span> data !== <span class="hljs-string">'object'</span>) <span class="hljs-keyword">return</span>
    
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">defineReactive</span>(data, key, data[key])
    })
  }
  
  <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, key, val</span>) {
    <span class="hljs-keyword">const</span> dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>() <span class="hljs-comment">// 依赖收集器</span>
    
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
      <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>) {
          dep.<span class="hljs-title function_">depend</span>() <span class="hljs-comment">// 收集依赖</span>
        }
        <span class="hljs-keyword">return</span> val
      },
      <span class="hljs-title function_">set</span>(<span class="hljs-params">newVal</span>) {
        <span class="hljs-keyword">if</span> (newVal === val) <span class="hljs-keyword">return</span>
        val = newVal
        dep.<span class="hljs-title function_">notify</span>() <span class="hljs-comment">// 通知更新</span>
      }
    })
  }
}
</code></pre>
<h3 data-id="heading-4">2. Vuex 如何集成 Vue 的响应式</h3>
<p>Vuex 在内部使用 Vue 实例来存储状态，这正是其响应式能力的来源：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Store</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = {}</span>) {
    <span class="hljs-comment">// 使用 Vue 实例来管理 state</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_vm</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
      <span class="hljs-attr">data</span>: {
        <span class="hljs-attr">$$state</span>: options.<span class="hljs-property">state</span>
      }
    })
  }
  
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">state</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_vm</span>.<span class="hljs-property">_data</span>.<span class="hljs-property">$$state</span>
  }
  
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">state</span>(<span class="hljs-params">v</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请使用 replaceState() 来显式替换 store 状态'</span>)
  }
}
</code></pre>
<h3 data-id="heading-5">3. 完整的响应式数据流</h3>
<p>让我们通过一个具体的例子来理解完整的响应式流程：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// store.js</span>
<span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuex</span>.<span class="hljs-title class_">Store</span>({
  <span class="hljs-attr">state</span>: {
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">user</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
      <span class="hljs-attr">cart</span>: []
    }
  },
  <span class="hljs-attr">mutations</span>: {
    <span class="hljs-title function_">increment</span>(<span class="hljs-params">state</span>) {
      state.<span class="hljs-property">count</span>++
    },
    <span class="hljs-title function_">addToCart</span>(<span class="hljs-params">state, product</span>) {
      state.<span class="hljs-property">user</span>.<span class="hljs-property">cart</span>.<span class="hljs-title function_">push</span>(product)
    }
  }
})

<span class="hljs-comment">// Component.vue</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">count</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">count</span>
    },
    <span class="hljs-title function_">cartItems</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">user</span>.<span class="hljs-property">cart</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">addProduct</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'addToCart'</span>, {
        <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'商品A'</span>,
        <span class="hljs-attr">price</span>: <span class="hljs-number">100</span>
      })
    }
  }
}
</code></pre>
<p>当调用 <code>addToCart</code> mutation 时：</p>
<ol>
<li>修改 <code>state.user.cart</code></li>
<li>Vue 检测到状态变化</li>
<li>通知所有依赖 <code>cart</code> 的组件重新渲染</li>
<li>界面自动更新</li>
</ol>
<h2 data-id="heading-6">构建稳定的状态管理架构</h2>
<h3 data-id="heading-7">1. 状态分片与模块化</h3>
<p>借鉴前端稳定性中的"隔离"思想，我们应该将状态按功能分片：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuex</span>.<span class="hljs-title class_">Store</span>({
  <span class="hljs-attr">modules</span>: {
    <span class="hljs-comment">// 用户模块</span>
    <span class="hljs-attr">user</span>: {
      <span class="hljs-attr">namespaced</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
        <span class="hljs-attr">info</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">preferences</span>: {}
      }),
      <span class="hljs-attr">mutations</span>: {
        <span class="hljs-title function_">SET_USER_INFO</span>(<span class="hljs-params">state, info</span>) {
          state.<span class="hljs-property">info</span> = info
        }
      }
    },
    
    <span class="hljs-comment">// 购物车模块 - 关键业务，需要高度稳定</span>
    <span class="hljs-attr">cart</span>: {
      <span class="hljs-attr">namespaced</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
        <span class="hljs-attr">items</span>: [],
        <span class="hljs-attr">lastUpdated</span>: <span class="hljs-literal">null</span>
      }),
      <span class="hljs-attr">getters</span>: {
        <span class="hljs-attr">totalPrice</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
          <span class="hljs-keyword">return</span> state.<span class="hljs-property">items</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">total, item</span>) =&gt;</span> 
            total + item.<span class="hljs-property">price</span> * item.<span class="hljs-property">quantity</span>, <span class="hljs-number">0</span>)
        }
      },
      <span class="hljs-attr">mutations</span>: {
        <span class="hljs-comment">// 带错误处理的 mutation</span>
        <span class="hljs-title function_">ADD_ITEM</span>(<span class="hljs-params">state, item</span>) {
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> existing = state.<span class="hljs-property">items</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> i.<span class="hljs-property">id</span> === item.<span class="hljs-property">id</span>)
            <span class="hljs-keyword">if</span> (existing) {
              existing.<span class="hljs-property">quantity</span> += item.<span class="hljs-property">quantity</span>
            } <span class="hljs-keyword">else</span> {
              state.<span class="hljs-property">items</span>.<span class="hljs-title function_">push</span>({ ...item, <span class="hljs-attr">quantity</span>: item.<span class="hljs-property">quantity</span> || <span class="hljs-number">1</span> })
            }
            state.<span class="hljs-property">lastUpdated</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'添加商品到购物车失败:'</span>, error)
            <span class="hljs-comment">// 降级方案：使用 localStorage 临时存储</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dispatch</span>(<span class="hljs-string">'cart/fallbackToLocalStorage'</span>, item)
          }
        }
      },
      <span class="hljs-attr">actions</span>: {
        <span class="hljs-comment">// 降级方案</span>
        <span class="hljs-title function_">fallbackToLocalStorage</span>(<span class="hljs-params">{ commit }, item</span>) {
          <span class="hljs-keyword">const</span> cartData = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'cart_fallback'</span>) || <span class="hljs-string">'[]'</span>)
          cartData.<span class="hljs-title function_">push</span>(item)
          <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'cart_fallback'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(cartData))
        }
      }
    }
  }
})
</code></pre>
<h3 data-id="heading-8">2. 容错与降级机制</h3>
<p>正如我们在前端稳定性中强调的，需要有备用方案：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 带容错的插件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">stabilityPlugin</span> = (<span class="hljs-params">store</span>) =&gt; {
  <span class="hljs-comment">// 状态快照，用于异常恢复</span>
  <span class="hljs-keyword">let</span> stateSnapshot = <span class="hljs-literal">null</span>
  
  store.<span class="hljs-title function_">subscribeMutation</span>(<span class="hljs-function">(<span class="hljs-params">mutation, state</span>) =&gt;</span> {
    <span class="hljs-comment">// 定期保存状态快照</span>
    <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'cart'</span>) || mutation.<span class="hljs-property">type</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'user'</span>)) {
      stateSnapshot = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(state))
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'vuex_backup'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(stateSnapshot))
    }
  })
  
  <span class="hljs-comment">// 状态恢复机制</span>
  <span class="hljs-keyword">const</span> savedState = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'vuex_backup'</span>)
  <span class="hljs-keyword">if</span> (savedState) {
    <span class="hljs-keyword">try</span> {
      store.<span class="hljs-title function_">replaceState</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(savedState))
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'状态恢复失败，使用初始状态'</span>)
    }
  }
}
</code></pre>
<h3 data-id="heading-9">3. 监控与调试</h3>
<p>建立完善的监控体系：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 性能监控插件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">performancePlugin</span> = (<span class="hljs-params">store</span>) =&gt; {
  store.<span class="hljs-title function_">subscribeAction</span>({
    <span class="hljs-attr">before</span>: <span class="hljs-function">(<span class="hljs-params">action, state</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">`action: <span class="hljs-subst">${action.type}</span>`</span>)
    },
    <span class="hljs-attr">after</span>: <span class="hljs-function">(<span class="hljs-params">action, state</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">`action: <span class="hljs-subst">${action.type}</span>`</span>)
    }
  })
  
  store.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">mutation, state</span>) =&gt;</span> {
    <span class="hljs-comment">// 上报状态变更到监控系统</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">monitor</span>) {
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">monitor</span>.<span class="hljs-title function_">track</span>(<span class="hljs-string">'vuex_mutation'</span>, {
        <span class="hljs-attr">type</span>: mutation.<span class="hljs-property">type</span>,
        <span class="hljs-attr">payload</span>: mutation.<span class="hljs-property">payload</span>
      })
    }
  })
}
</code></pre>
<h2 data-id="heading-10">响应式系统的稳定性考量</h2>
<h3 data-id="heading-11">1. 性能优化</h3>
<p>大规模状态树的响应式可能带来性能问题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 优化大型列表的响应式</span>
<span class="hljs-keyword">const</span> optimizedModule = {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">largeList</span>: []
  }),
  <span class="hljs-attr">mutations</span>: {
    <span class="hljs-comment">// 使用 Object.freeze 避免不必要的响应式</span>
    <span class="hljs-title function_">SET_LARGE_LIST</span>(<span class="hljs-params">state, list</span>) {
      state.<span class="hljs-property">largeList</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>(list)
    },
    
    <span class="hljs-comment">// 分批更新避免卡顿</span>
    <span class="hljs-title function_">APPEND_TO_LIST</span>(<span class="hljs-params">state, items</span>) {
      <span class="hljs-keyword">const</span> chunkSize = <span class="hljs-number">100</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; items.<span class="hljs-property">length</span>; i += chunkSize) {
        <span class="hljs-keyword">const</span> chunk = items.<span class="hljs-title function_">slice</span>(i, i + chunkSize)
        state.<span class="hljs-property">largeList</span> = state.<span class="hljs-property">largeList</span>.<span class="hljs-title function_">concat</span>(chunk)
        
        <span class="hljs-comment">// 让出主线程，避免阻塞</span>
        <span class="hljs-keyword">if</span> (i + chunkSize &lt; items.<span class="hljs-property">length</span>) {
          <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {}, <span class="hljs-number">0</span>)
        }
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-12">2. 内存管理</h3>
<p>防止内存泄漏的响应式设计：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 组件内的内存安全模式</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 避免在组件中直接存储大量状态引用</span>
      <span class="hljs-attr">localCartCopy</span>: <span class="hljs-literal">null</span>
    }
  },
  
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-comment">// 使用计算属性而非直接引用</span>
    <span class="hljs-title function_">cartSummary</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> cart = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">cart</span>.<span class="hljs-property">items</span>
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">count</span>: cart.<span class="hljs-property">length</span>,
        <span class="hljs-attr">total</span>: cart.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, item</span>) =&gt;</span> sum + item.<span class="hljs-property">price</span>, <span class="hljs-number">0</span>)
      }
    }
  },
  
  <span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 清理工作</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localCartCopy</span> = <span class="hljs-literal">null</span>
  }
}
</code></pre>
<h2 data-id="heading-13">总结：构建可靠的状态管理体系</h2>
<p>Vuex 的响应式机制为我们提供了强大的状态管理能力，但要构建真正稳定可靠的前端应用，我们需要：</p>
<ol>
<li><strong>深度理解原理</strong>：明白响应式系统的工作机制，避免常见的陷阱</li>
<li><strong>广度设计架构</strong>：采用模块化、分片化的状态设计，实现故障隔离</li>
<li><strong>实践容错方案</strong>：为关键状态操作准备降级和恢复机制</li>
<li><strong>主动监控优化</strong>：建立完善的监控体系，主动发现性能问题</li>
</ol>
<p>正如我们在前端稳定性文章中强调的，优秀的系统不是不会出错，而是在出错时依然能够提供可用的体验。Vuex 的响应式系统，配合恰当的架构设计和容错机制，可以帮助我们构建出真正"抗摔打"的前端应用。</p>
<p>记住：在前端稳定性的世界里，<strong>降级的体验远胜于完全的失败</strong>。即使状态管理出现临时问题，通过合理的降级设计，我们依然可以为用户提供基本可用的服务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工具推荐 - 沉浸式翻译 Chrome 插件]]></title>    <link>https://juejin.cn/post/7576228981230534683</link>    <guid>https://juejin.cn/post/7576228981230534683</guid>    <pubDate>2025-11-25T03:29:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576228981230534683" data-draft-id="7576197876717994022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工具推荐 - 沉浸式翻译 Chrome 插件"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-25T03:29:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Vic_wkx"/> <meta itemprop="url" content="https://juejin.cn/user/1116759545357182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工具推荐 - 沉浸式翻译 Chrome 插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759545357182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Vic_wkx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:29:15.000Z" title="Tue Nov 25 2025 03:29:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在阅读 Jake Wharton 的博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjakewharton.com%2Fblog%2F" target="_blank" title="https://jakewharton.com/blog/" ref="nofollow noopener noreferrer">jakewharton.com/blog/</a></p>
<p>看的时候只恨自己英语不够好，原文实在是看得头大。所以只能借助翻译工具来勉强理解。</p>
<h2 data-id="heading-0">Google Translate 插件</h2>
<p>可以借助 Google Translate 插件来翻译，点击<code>右键 -&gt; Translate to 中文</code>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c76ee946095402488b1fd4385695879~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646930&amp;x-signature=RK8tM6K1udIwB9oCcdJ%2BiAAVPjU%3D" alt="image.png" loading="lazy"/></p>
<p>不过这个翻译有些生硬，有的句子翻译之后反而看不懂了，所以有时候需要切回原文，对照着理解。此时再点一次<code>右键 -&gt; Translate to 中文</code>就能切换中英文了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/601300c56d6c414783cd7d392f4f9516~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646930&amp;x-signature=42dJSsVPBkkLlAZckPkMtwOO3M8%3D" alt="image.png" loading="lazy"/></p>
<p>不过这样切来切去的也有点麻烦，我希望有一个翻译工具，能在翻译之后，保留原文。</p>
<h2 data-id="heading-1">Immersive Translate 插件</h2>
<p>于是找到了这个 Chrome 插件：</p>
<p>沉浸式翻译（Immersive Translate）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fchromewebstore.google.com%2Fdetail%2Fimmersive-translate-trans%2Fbpoadfkcbjbfhfodiogcnhhhpibjhbnh" target="_blank" title="https://chromewebstore.google.com/detail/immersive-translate-trans/bpoadfkcbjbfhfodiogcnhhhpibjhbnh" ref="nofollow noopener noreferrer">chromewebstore.google.com/detail/imme…</a></p>
<p>装上之后，有一个非常详细清晰的新手引导，做得真的很不错，堪称插件典范，跟着引导很快就能上手。</p>
<p>在其设置界面，可以选择双语对照，这就是我需要的效果了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e35c48e5b0454788a8a77144ac5321e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646930&amp;x-signature=1RphTJ963l9BJ3H00ychPEEgF6s%3D" alt="image.png" loading="lazy"/></p>
<p>启用这个插件后，点击网页右边的悬浮球就能一键翻译了，底部还有个设置 icon，可以进行一些常用的设置，这是双语对照的效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc6ac93c0dad445ca9397a268dc5f57b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646930&amp;x-signature=po6gNt8SImcsh7GGIMkHico7LB8%3D" alt="image.png" loading="lazy"/></p>
<p>设置 icon 中提供了<code>总是翻译该网站</code>的快捷设置，这样下次就不用手动点击翻译了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1feefa01019c47f895593c492d6d1642~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646930&amp;x-signature=XZHnxQCaNKvL%2B5tlpZJAcN%2Bpeo4%3D" alt="image.png" loading="lazy"/></p>
<p>在插件设置界面可以看到<code>总是翻译的网址</code>列表，也可以在这里直接编辑：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c02bf815f151474e8245ba3eb5ebeb6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646930&amp;x-signature=VGAVLeIQ92RZH8bkYyR4aFj1s74%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到，这里还可以选择译文显示的样式，我比较喜欢实线边框的效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bec69ebbc91244cba364e8926d7dcca9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646930&amp;x-signature=XZkphkgub8svCHjUoyYXT3oiAnE%3D" alt="image.png" loading="lazy"/></p>
<p>我注意到这里面还有个<code>模糊效果（学习模式）</code>，启用后，翻译就会被模糊处理，鼠标移动上去才显示译文。还挺有意思的，是给学习语言的人用的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25115a6c6eb64f4dbb42e899db3c8431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646930&amp;x-signature=Wt%2FXAPJCs%2FiczhIddTqgEQ%2Bmz6A%3D" alt="image.png" loading="lazy"/></p>
<p>翻译服务这里还可以切换各种模型，可以借助各种 AI 模型帮忙翻译：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78ebae93e6d34d14ba23db2bf01bd8b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646930&amp;x-signature=A8AFG2OHJe9Xlzq6B5hTpPSCh9o%3D" alt="image.png" loading="lazy"/></p>
<p>不过高级翻译是收费的，我用的免费的模型，做个辅助就好了，诶，别骂人哦，不是钱不钱的事儿，主要是喜欢自己理解（申公豹：哥吃不惯这个，就喜欢自己修炼=，=）</p>
<h2 data-id="heading-2">后记</h2>
<p>我注意到 Jake Wharton 巨佬在博客底部写了：</p>
<blockquote>
<p>P.S. I'm casually looking for new employment opportunities. Got a lead? I'm <a href="https://link.juejin.cn?target=https%3A%2F%2Fjakewharton.com%2Fhire" target="_blank" title="https://jakewharton.com/hire" ref="nofollow noopener noreferrer">available for hire</a>.</p>
</blockquote>
<p>有点震惊，这样的巨佬都需要自己找工作吗。不应该是想去哪就去哪吗？看了下巨佬的简历，里面提到一些价值观挺有意思的：</p>
<h3 data-id="heading-3">Values</h3>
<p>Here are some values of mine. You don't need to share them all, but more is better.</p>
<h4 data-id="heading-4">No “AI”</h4>
<p>No “AI” companies, “AI”-based products, or forced “AI” usage for development.</p>
<h4 data-id="heading-5">No crypto</h4>
<p>Cryptography is good, but cryptocurrencies are bad.</p>
<h4 data-id="heading-6">Remote work</h4>
<p>I work remotely, but happy to visit offices a couple of times each year.</p>
<h4 data-id="heading-7">Open source</h4>
<p>You use open source software, and you publish your own open source projects (or want to start).</p>
<h4 data-id="heading-8">Customers over shareholders</h4>
<p>Your product focuses on providing value to customers, not enriching shareholders.</p>
<h4 data-id="heading-9">People over profits</h4>
<p>No gig workers or exploitative practices to squeeze every cent from customers.</p>
<h4 data-id="heading-10">Small and focused</h4>
<p>Doing one thing well is better than trying to be everything to everyone.</p>
<h4 data-id="heading-11">Diversity, equity, and inclusion</h4>
<p>Distributing opportunity equally takes active work.</p>
<h4 data-id="heading-12">Work/life balance</h4>
<p>I don't have work chat, email, or code review on my phone.</p>
<p>看起来巨佬不喜欢 AI，不喜欢加密货币。这两点我不能完全苟同。其他几点我都非常支持。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AIBrix v0.5.0 正式发布：实现批量API支持、KVCache v1连接器升级，全面提升P/D架构协同效能]]></title>    <link>https://juejin.cn/post/7576208176006889524</link>    <guid>https://juejin.cn/post/7576208176006889524</guid>    <pubDate>2025-11-25T03:38:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576208176006889524" data-draft-id="7576208176006856756" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AIBrix v0.5.0 正式发布：实现批量API支持、KVCache v1连接器升级，全面提升P/D架构协同效能"/> <meta itemprop="keywords" content="GitHub,开源,资讯"/> <meta itemprop="datePublished" content="2025-11-25T03:38:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="字节跳动开源"/> <meta itemprop="url" content="https://juejin.cn/user/1227510999971086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AIBrix v0.5.0 正式发布：实现批量API支持、KVCache v1连接器升级，全面提升P/D架构协同效能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1227510999971086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    字节跳动开源
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:38:38.000Z" title="Tue Nov 25 2025 03:38:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b7c4cd3861d44c49ce4dba1a0622c07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646718&amp;x-signature=GpS4oinKLXNDSoAnz4ffCmEdes0%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvllm-project%2Faibrix" target="_blank" title="https://github.com/vllm-project/aibrix" ref="nofollow noopener noreferrer">github.com/vllm-projec…</a></p>
</blockquote>
<p>今日，我们正式发布 AIBrix v0.5.0。此版本引入与 OpenAI 兼容的批处理 API，专为处理高吞吐、时延不敏感的离线推理与评估任务设计，有效避免对实时端点造成干扰。同时，新版本集成了全新的 KVCache 连接器（AIBrixOffloadingConnectorV1Type3），借助其流水线式预取与分层卸载机制，显著提升 KVCache 卸载与复用的效率。此外，v0.5.0 将 StormService 打造为生产级的控制面，通过 PodSet/PodGroup 原语实现多 Pod 管理，提供拓扑与负载感知的路由能力，并利用 subTargetSelector 实现角色级自动扩缩，从而为 P/D 分离架构提供精细化的资源伸缩。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d206373451f47e28304378c092bef2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646718&amp;x-signature=9lamrIz1OQeKsZszQlIKCMlMeeQ%3D" alt="图片" loading="lazy"/></p>
<p>下面是 v0.5.0 的核心功能概览。</p>
<h2 data-id="heading-0">批处理 API</h2>
<p><strong>AIBrix</strong> 本次更新正式加入对<strong>批处理 API</strong> 的支持。批处理 API 旨在优化大体量、对延迟不敏感的推理工作负载，是一项强大的新功能。</p>
<p>随着生成式人工智能（GenAI）应用的规模不断扩大，并非每个请求都需要即时响应。像大规模数据集评测、离线内容生成和批量数据处理等任务，常常会使实时服务接口拥堵不堪，导致资源利用效率低下和成本增加。AIBrix 批处理 API 通过允许用户异步提交大量请求来解决这一问题。通过将这些请求以优化过的数量批次处理，相较于标准在线服务，AIBrix 可以显著提高 GPU 利用率和集群整体吞吐量。</p>
<p><strong>主要特性</strong></p>
<ul>
<li><strong>OpenAI 兼容性：</strong>  批处理 API 被设计为可直接替代现有工作流，支持标准的 OpenAI 批处理 API（例如，<code>/v1/batches</code>）。</li>
<li><strong>异步处理：</strong>  支持“即发即忘”架构。通过 <code>.jsonl</code> 文件提交大量任务后，客户端应用程序可以处理其他任务，并在结果就绪后进行检索。</li>
<li><strong>可配置的作业池：</strong>  支持通过可配置的作业池大小微调资源分配，以适应特定的硬件限制和吞吐量目标。</li>
<li><strong>增强的错误处理：</strong>  强大的验证和错误报告功能支持请求自动重试，确保您可以追踪大规模批处理中每个单独请求的状态。</li>
</ul>
<p><strong>快速入门</strong></p>
<p>由于 AIBrix 批处理 API 与 OpenAI 兼容，对于熟悉标准大语言模型工具的人来说，上手操作十分简单。</p>
<ol>
<li>准备批处理输入（<code>requests.jsonl</code>）：</li>
</ol>

<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"custom_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"req-1"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"POST"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/v1/chat/completions"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"llama-3-8b"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Hello world!"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"custom_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"req-2"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"POST"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/v1/chat/completions"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"llama-3-8b"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Explain batch processing."</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<p>2.  提交批处理作业（使用指向 AIBrix 的标准 OpenAI 客户端）：</p>

<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI

<span class="hljs-attr">client</span> = OpenAI(
    <span class="hljs-attr">base_url</span>=<span class="hljs-string">"http://your-aibrix-endpoint/v1"</span>,
    <span class="hljs-attr">api_key</span>=<span class="hljs-string">"aibrix"</span>
)

<span class="hljs-comment"># Upload file</span>
<span class="hljs-attr">batch_file</span> = client.files.create(
  <span class="hljs-attr">file</span>=open(<span class="hljs-string">"requests.jsonl"</span>, <span class="hljs-string">"rb"</span>),
  <span class="hljs-attr">purpose</span>=<span class="hljs-string">"batch"</span>
)

<span class="hljs-comment"># Create batch job</span>
<span class="hljs-attr">batch_job</span> = client.batches.create(
  <span class="hljs-attr">input_file_id</span>=batch_file.id,
  <span class="hljs-attr">endpoint</span>=<span class="hljs-string">"/v1/chat/completions"</span>,
  <span class="hljs-attr">completion_window</span>=<span class="hljs-string">"24h"</span>
)

print(f"Batch submitted: {batch_job.id}")
</code></pre>
<p><strong>了解更多</strong></p>
<p>如需完整的部署配置和 API 参考，请访问我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Faibrix.readthedocs.io%2Flatest%2Ffeatures%2Fbatch-api.html" target="_blank" title="https://aibrix.readthedocs.io/latest/features/batch-api.html" ref="nofollow noopener noreferrer">官方文档</a>。</p>
<h2 data-id="heading-1">KVCache v1 Connector</h2>
<p>我们在 v0.4.0 版本中发布的 AIBrix KVCache Connector，经过基准测试与内部实际部署验证，发现了一些重要的可以提升性能的优化机会。为充分挖掘这些优化点以发挥 KVCache 卸载的潜力，我们在 v0.5.0 版本中实现了一系列关键优化，并推出了新的 KVCache Connector9（AIBrixOffloadingConnectorV1Type3）。</p>
<p><strong>核心优化技术包含：</strong></p>
<ul>
<li>流水线式 KVCache 预取和加载技术</li>
</ul>
<p>我们通过让预取、加载与计算这三个关键阶段并行执行，以流水线充分重叠的优化方式，不仅大幅减少了空闲等待时间，消除了TPOT（每秒输出 token 数）的延迟损耗，更让系统吞吐性能突破原有瓶颈。</p>
<ul>
<li>分层式 KVCache 卸载机制</li>
</ul>
<p>通过将 KVCache 卸载操作与推理各层的前向计算同步进行，有效隐藏了数据传输延迟。使得即使 KVCache 命中率较低时，仍能保持高效推理，确保推理引擎持续满载运转，实现资源利用率最大化。</p>
<p>相较于 v0.4.0 版本的 KVCache Connector（AIBrixOffloadingConnectorV1Type1），在 Llama 3.1 70B 模型（张量并行度=8）的测试中，v0.5.0 版本的这套组合优化方案使 TPOT 与整体吞吐量双双提升超过20%，同时仍保持优异的 TTFT（首 token 时延）。</p>
<h2 data-id="heading-2">生产级 P/D 分离编排方案</h2>
<p>v0.5.0 版本将 StormService 升级为面向大规模异构 P/D 分离集群的高级控制面。全新推出的 PodGroup API 使 StormService 能够与协同调度生态系统（Coscheduling、Godel、Volcano）无缝集成，将紧耦合的工作节点作为统一调度单元进行编排。结合新设计的 PodSet API，StormService 现已能显式管理多 Pod 工作节点与分片组, 即将其作为逻辑整体统一控制生命周期、拓扑结构与运行状态，同时保持与现有单 Pod 架构的向后兼容性。</p>
<p>此外，v0.5.0 为复杂部署场景提供了更强大的滚动更新与重启语义。新增的 FullRecreate 策略让运维人员能够以原子方式恢复异常 PodSet，避免产生中间状态残留；而角色升级序列功能支持按预设顺序（例如：集群内路由 → 预填充节点 → 解码节点）在不同角色间进行安全有序的变更发布，彻底取代随机更新机制。这套组合方案使得高风险操作（如模式变更、路由调整、运行时升级）变得高度可预测。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spec:</span>
      <span class="hljs-attr">roles:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prefill</span>
          <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
          <span class="hljs-attr">podGroupSize:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># introduce new field to indicate the pod group size. for example DP or TP case.</span>
          <span class="hljs-string">stateful:</span> <span class="hljs-literal">true</span>
          <span class="hljs-attr">recoveryPolicy:</span> <span class="hljs-string">ReplaceUnhealthy</span> <span class="hljs-comment"># ReplaceUnhealthy or Recreate</span>
          <span class="hljs-attr">template:</span>
            <span class="hljs-string">...</span>
</code></pre>
<p>路由层现已升级至支持这些编排原语。在副本模式和池化模式下，AIBrix 会优先选择同一 RoleSet/PodSet 中的预填充与解码节点进行配对，通过负载感知评分机制选取最空闲的候选节点，并将基于 Nixl 的 P/D 分离架构与正确的 kv_transfer_params 参数对齐，确保流量能够抵达具备正确 KVCache 状态的目标群组。新增的防护机制可保证路由逻辑遵循 HttpRoute 状态与故障条件，弥补了早期版本中存在的正确性缺陷。</p>
<p>此外，我们为 StormService 新增了角色级自动扩缩容功能，使预填充与解码角色能根据各自指标独立伸缩。通过 PodAutoscaler 中新引入的 subTargetSelector 选择器，运维人员可为不同角色或资源池配置独立的自动扩缩容策略（例如对预填充角色采用激进的扩缩容策略，对解码角色则采用保守策略），这对 P/D 分离形态下的池化场景与异构场景至关重要。这些改进使得 P/D 分离架构不仅能实现，更能在规模化场景中保持运维整洁性。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># PodAutoscaler for prefill role</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">autoscaling.aibrix.ai/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PodAutoscaler</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">ss-pool-prefill</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-string">autoscaling.aibrix.ai/storm-service-mode:</span> <span class="hljs-string">"pool"</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">scaleTargetRef:</span>
    <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">orchestration.aibrix.ai/v1alpha1</span>
    <span class="hljs-attr">kind:</span> <span class="hljs-string">StormService</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">ss-pool</span>

<span class="hljs-comment"># new Added: Select the prefill role within the StormService</span>
  <span class="hljs-attr">subTargetSelector:</span>
    <span class="hljs-attr">roleName:</span> <span class="hljs-string">prefill</span>
</code></pre>
<p>完整示例: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvllm-project%2Faibrix%2Fblob%2Fmain%2Fsamples%2Fautoscaling%2Fstormservice-pool.yaml" target="_blank" title="https://github.com/vllm-project/aibrix/blob/main/samples/autoscaling/stormservice-pool.yaml" ref="nofollow noopener noreferrer">github.com/vllm-projec…</a></p>
<hr/>
<h2 data-id="heading-3">其他改进</h2>
<p>v0.5.0 版本还强化了运行时层，使运维人员能够在所有引擎上获得更清晰一致的控制路径。元数据服务器已完成从 Go 到 Python 的重构，并集成健康与存活探查，镜像体积显著缩减；下载器现能更稳健地处理递归式对象存储布局，使得实际使用中的模型与制品管理标准化变得更为容易。通过 Webhook 与轻量级封装库，AIBrixRuntime 边车容器可自动注入到 Deployment 和 StormService 工作负载中，实现了指标收集、下载管理与运维操作的统一，无需再为每个推理引擎编写定制化代码。</p>
<p>在此基础上，我们强化了面向多租户场景的 LoRA 与模型适配器的工作流。AIBrix 现支持将适配器伸缩至预期副本数，重构了适配器副本跟踪机制，新增类型化封装以降低集成难度，并允许通过运行时直接拉取 LoRA 制品。这些改进共同使得在单个基础模型上跨多引擎、多集群运行大量 LoRA 组件的实践更健壮，更易于实现自动化。</p>
<p>自动扩缩容组件也进行了显著的加强。v0.5.0 版本通过可重试的 RestMetricsFetcher、共享客户端/聚合器以及配置更新中的竞态条件修复，统一了指标采集流程，让扩缩容决策既更快速又更可靠。我们优化了 KPA 默认参数，增加指标标签选择器支持，仅在副本数实际变更时触发事件，并将扩缩容历史直接暴露于 PodAutoscaler 状态中。这些改进使自动扩缩容从一个黑盒组件转变为可观测、可调试、策略驱动的系统模块。</p>
<p>总体而言，这些在运行时、LoRA、自动注入与自动扩缩容方面的增强，共同推动 AIBrix 向开箱即用控制面的目标迈进。</p>
<p>如需查看完整变更列表、提交历史与贡献者详情，请参阅 AIBrix v0.5.0 版本发布说明。</p>
<h2 data-id="heading-4">贡献者与社区</h2>
<p>v0.5.0 版本共包含 39 项贡献，其中 21 项来自首次贡献者 💫。衷心感谢所有通过代码提交、问题反馈、代码审查和建议参与推动此版本进展的每一位参与者。</p>
<p>特别向我们的新贡献者致敬：</p>
<p>@JonathonShea, @bigerous, @jiangxiaobin96, @mayooot, @zyfy29, @zhengkezhou1, @tianzhiqiang3, @atakli, @jwjwjw3, @lx1036, @chethanuk, @baozixiaoxixi, @TylerGillson, @omrishiv, @lex1ng, @ChenTaoyu-SJTU, @zhenyu-02, @yapple, @xvoron, @freedown19, @Leafykn 🙌</p>
<p>你们的贡献让 AIBrix 更加稳健、更具备生产环境可用性，也让我们的开源社区更加开放包容。期待大家持续参与！</p>
<h2 data-id="heading-5">未来规划</h2>
<p>我们正持续推动 AIBrix 构建为面向现代 LLM 工作负载的全生产级云原生技术栈。在 v0.6.0 版本中，我们将聚焦以下几个核心方向：生产级 LoRA 与无服务器 LLM 服务、以 KVCache 为核心的 P/D 分离与卸载工作流、容错性与稳定性探索，以及生态集成——包括 vLLM 语义路由与 Envoy AI 网关等故意排除在 AIBrix 核心但保持技术栈可组合性的功能领域。</p>
<p>如果您正在生产环境中运行 LLM，或正在探索无服务器架构、KVCache、P/D 分离等新架构方向，我们诚挚期待您就 v0.6.0 技术路线图提出反馈并参与协作——欢迎在 GitHub 加入讨论，共同贡献力量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[智能体&编程新王Claude Opus 4.5震撼登场，定价大降2/3]]></title>    <link>https://juejin.cn/post/7576228981230600219</link>    <guid>https://juejin.cn/post/7576228981230600219</guid>    <pubDate>2025-11-25T03:38:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576228981230600219" data-draft-id="7576218673049010227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="智能体&amp;编程新王Claude Opus 4.5震撼登场，定价大降2/3"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-25T03:38:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            智能体&amp;编程新王Claude Opus 4.5震撼登场，定价大降2/3
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:38:55.000Z" title="Tue Nov 25 2025 03:38:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如昨日预期一样，Anthropic 正式发布了最新模型 Claude Opus 4.5。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2435955875894980aa313a70c241034f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=PvkldMZS9F36cIigFdhu6vZtXEM%3D" alt="图片" loading="lazy"/></p>
<p>根据介绍，Claude Opus 4.5 非常智能高效，在编程、智能体以及计算机操作方面表现卓越，是当今世界最优秀的模型。该模型在深度研究、处理幻灯片与电子表格等日常任务上也有显著提升。</p>
<p>该模型标志着 AI 系统化能力的进一步跃升，也预示着未来工作方式即将迎来更深刻的变革。如下图所示，Claude Opus 4.5 在真实世界软件工程测试中达到了行业 SOTA 水平，超越了 GPT-5.1-Codex-Max、Gemini 3 Pro 以及自家 Sonnet 4.5。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49419847433341d0bdf9648fba771949~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=9ZMYCyvPohX3sZS5JXwafcJilig%3D" alt="图片" loading="lazy"/></p>
<p>自今日起，Claude Opus 4.5 即可以通过 Claude app、API 以及三大主流云平台访问。如果你是开发者，只需通过 Claude API 使用 claude-opus-4-5-20251101 即可。</p>
<p>关于价格，Claude Opus 4.5 的最新定价为每百万 Token 5/25 美元（输入 / 输出），使更多用户、团队和企业都能轻松获得 Opus 级别的能力。可以看到，与上代 Opus 4.1 相比，API 定价降低了 2/3。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1a5c7b40795453e9d17615c69f0e4be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=8a%2FcE2Jk6pYG1E41JjIkak9LTRs%3D" alt="图片" loading="lazy"/></p>
<p>与 Claude Opus 4.5 同步，Anthropic 还更新了 Claude 开发者平台、Claude Code 以及消费者应用，推出了适用于更长时长运行的智能体新工具。其中，在 Claude app 中，长对话不再会轻易遇到限制。</p>
<p>Claude Code 现已登陆桌面应用，用户可以并行运行多个会话，比如编程、研究和更新工作。随着 Claude Opus 4.5 的推出，Plan Mode 也获得了升级：一开始提出澄清性问题，随后即可自主开展工作。</p>
<p>Anthropic 提供了在 Excel、Chrome 和桌面端使用 Claude 的全新方式。Max、Team 和 Enterprise 用户可以直接在 Excel 中使用最新模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44a8983fb03d40d3aae82a642c9289f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=OT4Jo%2B5srq2DRQ3IJwBNkxi50P4%3D" alt="图片" loading="lazy"/></p>
<p>基准测试多项最新 SOTA</p>
<p>根据 Anthropic 的介绍，他们提供了一份众所周知极其困难的居家测试（take-home exam），同时也将这份测试用作新模型的内部基准评估。在规定的两小时限时内，Claude Opus 4.5 的得分超过了迄今为止所有参加过该测试的人类候选人。</p>
<p>这份居家测试旨在评估候选人（包括 AI 大模型）在时间压力下的技术能力与判断力，但并不衡量如协作、沟通，或多年经验中积累的职业直觉等其他关键技能。然而，这一结果 —— 即 AI 模型在重要技术能力上超越实力强劲的候选人 —— 引发了关于人工智能将如何改变工程职业的思考。</p>
<p>软件工程并不是 Claude Opus 4.5 唯一取得显著提升的领域。这一代模型在整体能力上全线增强，在视觉、推理和数学方面均优于前代模型，并在许多领域达到了当前 SOTA 水平，包括智能体编程、智能体终端编程、智能体工具使用、可扩展的工具使用、计算机操作、解决新型问题的能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80aeb23e73ed4251906d63f1198b2061~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=bMzoVJOIhtMitGHJ%2FGyiH8Bq1KQ%3D" alt="图片" loading="lazy"/></p>
<p>Claude Opus 4.5 具备更出色的代码生成能力，在 SWE-bench Multilingual 基准中，在 8 种编程语言中的 7 种上表现领先。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d061249145be419889897fe3da122ec6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=mvpWM2T55degMFOh3iC%2FXvnPMkk%3D" alt="图片" loading="lazy"/></p>
<p>Claude Opus 4.5 能够轻松解决高难度的编码问题，并在 Aider Polyglot 基准上相比 Sonnet 4.5 实现了 10.6% 的提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5baeeb4fac564b37841aacf1a03d749a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=Ss2pnBZmstaWcxj8DahBIFCo%2Bbw%3D" alt="图片" loading="lazy"/></p>
<p>Claude Opus 4.5 在前沿的智能体搜索能力上取得了显著进步，在 BrowseComp-Plus 基准上有明显提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6317b7269a148de90efc4ba5734e424~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=t7Y1t%2BqVzBiLEGU5ef34AFkIsRg%3D" alt="图片" loading="lazy"/></p>
<p>同时，Claude Opus 4.5 在长程任务上的稳定性也更强，在 Vending-Bench 基准中相较于 Sonnet 4.5 实现了 29% 的提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13d195045cef435bba0c7f17d816ae5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=%2FoFiYOXffwlpbFgqxBasosemzkI%3D" alt="图片" loading="lazy"/></p>
<p>Anthropic 表示，Claude Opus 4.5 的能力已经在某些测试项目上超出了现有基准的衡量范围。一个常用的智能体能力基准是 τ^2-bench，它用于评估智能体在真实场景、多轮任务中的表现。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/836a8a437e54459a810dcc3803b45da4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=bfDWo69nGuIfOjUZihLA%2F1O1qFI%3D" alt="图片" loading="lazy"/></p>
<p>图源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsierra-research%2Ftau2-bench" target="_blank" title="https://github.com/sierra-research/tau2-bench" ref="nofollow noopener noreferrer">github.com/sierra-rese…</a></p>
<p>在其中一个情境中，模型需要扮演航空公司客服代理，帮助一位处于困境的旅客。根据基准设定，由于航空公司不允许更改基础经济舱的机票，模型应当拒绝旅客的改签请求。然而，Claude Opus 4.5 找到了一个富有洞察力且合法的解决方式：先升级舱位，再对航班进行修改。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acec9804bf7c427588303b17f033e90d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=gRo2vTbOyKJlj09n%2FTBVRDKVdFs%3D" alt="图片" loading="lazy"/></p>
<p>从技术上讲，由于 Claude 的解决方式不在基准预设范围内，这一表现被系统判定为失败。但这种具有创造性的解决问题方式，正是 Anthropic 从测试者和客户那里频繁听到的反馈，也是让 Claude Opus 4.5 被认为是一次有意义跃升的关键特质。</p>
<p>当然，在其他情境中，绕开预期约束的巧妙做法也可能被视为一种「奖励规避」（reward hacking），即模型以非预期方式「钻规则空子」。</p>
<p>Claude 开发者平台新变化</p>
<p>随着模型变得更智能，它们能够用更少的步骤解决问题：更少的回溯、更少的重复探索、更简洁的推理。为达到相同或更好的结果，Claude Opus 4.5 使用的 token 数量相比前代大幅减少。</p>
<p>但是，不同任务需要在速度、成本和能力之间做出不同取舍。有时开发者希望模型持续深思某个问题，有时则希望模型更加轻量迅捷。通过 Anthropic 在 Claude API 中新增的 effort 参数，开发者可以自行决定是要最小化时间与成本，还是要最大化模型能力。</p>
<p>在中等 effort 设定下，Opus 4.5 能达到与 Sonnet 4.5 在 SWE-bench Verified 中相同的最佳成绩，但输出 token 使用量减少了 76%。在最高 effort 设定下，Opus 4.5 的表现比 Sonnet 4.5 高出 4.3 个百分点，同时输出 token 使用量仍减少了 48%。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82d32892d94c4674ac0aa01b81c983b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=NUQuusqDC%2B%2BhTdl2vuKeZLmUmU8%3D" alt="图片" loading="lazy"/></p>
<p>通过 effort 控制、上下文压缩以及更先进的工具使用能力，Claude Opus 4.5 能运行更长时间、完成更多任务，并且需要更少的人为干预。</p>
<p>上下文管理与记忆能力能够显著提升模型在智能体任务中的表现。Claude Opus 4.5 同样非常擅长管理由多个子智能体组成的团队，从而支持构建复杂且协调良好的多智能体系统。在测试中，通过结合使用这些技术，Opus 4.5 在一项深度研究评估中的表现提升了近 15 个百分点。</p>
<p>Anthropic 也在逐步增强开发者平台的可组合性。目标是为开发者提供所需的各种构建模块，从而可以完全掌控效率、工具使用方式以及上下文管理，精准构建所需的系统。</p>
<p>安全性进一步提升</p>
<p>Anthropic 表示，Claude Opus 4.5 是其迄今发布的在对齐方面最为稳健的模型，也可能是目前各家前沿模型中对齐度最高的之一。该模型延续了 Anthropic 在打造更安全、更可靠模型方面的趋势：</p>
<p>在 Anthropic 的评估中，「令人担忧的行为」分数衡量了范围非常广泛的非对齐表现，其中既包括模型配合人类进行不当使用，也包括模型在自身主动性下做出的不良行为。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53451fa0bb334af0b7066e12b78114cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=VZ5BXgrPjrQMEY190W%2FJ%2FVIe0WU%3D" alt="图片" loading="lazy"/></p>
<p>Claude Opus 4.5 在抵御提示注入攻击方面取得了实质性的进展，提示注入会通过夹带欺骗性指令来误导模型做出有害行为。而 Opus 4.5 在这类攻击上的稳健性显著增强，是目前行业中最不容易被提示注入欺骗的前沿模型之一。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7975d0afe25840c3b43a5a74375c0623~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=oAZ%2B65XNN76LyoUX0SteFi2Eoik%3D" alt="图片" loading="lazy"/></p>
<p>该基准仅包含强度极高的提示注入攻击，由 Gray Swan 开发并运行。</p>
<p>更多细节信息请参阅模型系统卡：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36d2b0e90cac48c490f8480456c09298~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764646734&amp;x-signature=0Cszyv6MKcnDMnlU0R%2Fckbj8iis%3D" alt="图片" loading="lazy"/></p>
<p>模型系统卡地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fassets.anthropic.com%2Fm%2F64823ba7485345a7%2FClaude-Opus-4-5-System-Card.pdf" target="_blank" title="https://assets.anthropic.com/m/64823ba7485345a7/Claude-Opus-4-5-System-Card.pdf" ref="nofollow noopener noreferrer">assets.anthropic.com/m/64823ba74…</a></p>
<p>博客地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fclaude-opus-4-5" target="_blank" title="https://www.anthropic.com/news/claude-opus-4-5" ref="nofollow noopener noreferrer">www.anthropic.com/news/claude…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[聊聊场景题：百万人同时点赞怎么办？这个怎么回答]]></title>    <link>https://juejin.cn/post/7576273949186932778</link>    <guid>https://juejin.cn/post/7576273949186932778</guid>    <pubDate>2025-11-25T03:46:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576273949186932778" data-draft-id="7576273949186883626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="聊聊场景题：百万人同时点赞怎么办？这个怎么回答"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-25T03:46:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小富"/> <meta itemprop="url" content="https://juejin.cn/user/993614241734270"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            聊聊场景题：百万人同时点赞怎么办？这个怎么回答
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614241734270/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小富
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:46:07.000Z" title="Tue Nov 25 2025 03:46:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家发现了吧，现在面试八股文好像问的少了，反倒是场景题多了起来，毕竟现在AI如此强大，总揪着这点底层基础也没多大意思。</p>
<p>面试官张嘴闭嘴高并发、大数据量倒是真的，别管实际业务是不是高并发，但是你不会是进不来拧螺丝的。</p>
<p>就像之前有同学被问：“某音百万用户同时给一个视频点赞，让你来要怎么设计？”，这类题肯定见过吧。</p>
<p>咱们来简单拆解下这题，我是一个小学习，知识量有限，不喜勿喷。</p>
<h3 data-id="heading-0">这道题到底考察什么？</h3>
<p>别上来就想用什么技术，先明确面试官的考察点，才能答到点子上：</p>
<ol>
<li>
<p>高并发写入能力：百万人同时操作，瞬间 QPS 能冲到几十万，如何避免数据库被打垮？这是考察你对流量削峰的理解；</p>
</li>
<li>
<p>数据一致性：用户点赞后必须立刻看到 <strong>已赞</strong> 状态，点赞数可以有轻微延迟，但不能错、不能丢，这是对最终一致性的考察；</p>
</li>
<li>
<p>系统可用性：就算后端服务波动，用户点赞操作也得成功，不能出现点了没反应的情况，考察容错和降级思路；</p>
</li>
<li>
<p>资源优化：百万次请求直接怼数据库肯定不行，如何用缓存、消息队列等中间件减轻压力，考察技术选型能力。</p>
</li>
</ol>
<h3 data-id="heading-1">换位思考</h3>
<p>很多人一上来就纠结怎么让百万次点赞实时写入数据库，其实跑偏了。</p>
<p>咱们站在用户角度想：</p>
<ul>
<li>
<p>用户点击点赞后，最关心的是<code>有没有点赞成功</code>，而不是<code>当前赞数到底是 10086 还是 10087</code>；</p>
</li>
<li>
<p>赞数是给所有用户看的<code>公共数据</code>，轻微延迟用户完全感知不到（就算数据丢了，用户也很难发现，只是会想“咦”我之前点赞过一个视频没了，就没然后了）；</p>
</li>
<li>
<p>核心需求是：<strong>操作成功率 99% + 客户端状态实时反馈 + 赞数最终准确</strong>。</p>
</li>
</ul>
<p>想通这一点，方案就清晰了：把实时写入数据库的压力，转移到中间件上，用异步 + 缓存的思路解决高并发。</p>
<h3 data-id="heading-2">选取方案</h3>
<p>咱们一步步拆解，从用户点击点赞按钮开始，整个流程是这样的：</p>
<h4 data-id="heading-3">1. 用户点赞：先写消息队列，客户端直接反馈成功</h4>
<p>用户点击点赞的瞬间，客户端不会直接调用数据库接口，而是做两件事：</p>
<ul>
<li>
<p>向后端发送点赞请求，后端收到后，<strong>不操作数据库</strong>，直接把用户ID + 视频ID + 点赞状态（赞 / 取消赞）封装成一条消息，写入 Kafka；</p>
</li>
<li>
<p>Reids 记录 用户ID + 视频ID 的点赞状态，增加 视频ID 的赞数量</p>
</li>
<li>
<p>只要消息成功写入 Kafka，后端就立刻返回点赞成功给前端，客户端马上显示已赞状态。</p>
</li>
</ul>
<p>为啥选 Kafka 我就不说了。</p>
<h4 data-id="heading-4">2. 客户端：本地记录状态，避免重复点赞</h4>
<p>客户端收到点赞成功后，除了显示已赞，还要在本地存储记录当前用户对该视频已点赞。</p>
<p>这样做的好处是：</p>
<ul>
<li>
<p>防止用户短时间内重复点击点赞，前端直接拦截，减少无效请求；</p>
</li>
<li>
<p>就算后续缓存没更新，用户自己看到的状态也是准确的，不影响个人体验。</p>
</li>
</ul>
<h4 data-id="heading-5">3. 查赞数：直接读 Redis，不用查数据库</h4>
<p>其他用户查看视频时，需要显示赞数，这时候客户端会调用查询赞数接口，后端的处理逻辑是：</p>
<ul>
<li>
<p>不查数据库，直接从 Redis 里读取该视频的赞数缓存；</p>
</li>
<li>
<p>Redis 读性能极高，支持每秒几十万次查询，完全能扛住百万用户同时查看的压力；</p>
</li>
<li>
<p>这里的赞数可能不是实时最新的，但只要延迟在可接受范围内，用户完全没感觉。</p>
</li>
</ul>
<h4 data-id="heading-6">4. 后台任务：定时同步 Redis 和数据库，保证最终一致</h4>
<p>这一步是兜底，负责把 Kafka 里的点赞消息处理掉，同时更新 Redis 和数据库：</p>
<ul>
<li>
<p>后端持续从 Kafka 里拉取点赞消息；</p>
</li>
<li>
<p>启动一个定时任务，把 Redis 里所有视频的赞数，批量同步到数据库里；</p>
</li>
<li>
<p>同步时要注意幂等性：比如用户先赞后取消，最终状态是未赞，避免重复计算导致赞数错误。</p>
</li>
</ul>
<p>批量同步，攒一批数据（比如 1 万条）再批量更新，大大减少数据库的写入压力。</p>
<p>而且定时任务可以根据业务调整频率，比如高峰期每 1 分钟同步一次，低峰期每 10 分钟同步一次，灵活适配流量。</p>
<h3 data-id="heading-7">方案优势</h3>
<p>这套方案没有复杂的架构，但的确能解决百万级点赞的高并发问题，核心优势在于几种中间件的组合使用：</p>
<ul>
<li>
<p>高可用：Kafka 保证消息不丢失，Redis 保证查询不卡顿，就算数据库暂时挂了，用户点赞和查赞数都不受影响；</p>
</li>
<li>
<p>易扩展：如果后续点赞量涨到千万级，只需要增加 Kafka 的分区数、Redis 的集群节点，就能轻松扛住；</p>
</li>
<li>
<p>低成本：不用复杂的分布式事务，不用实时计算框架，用最基础的中间件就能实现，开发和维护成本都低。</p>
</li>
</ul>
<h3 data-id="heading-8">写在最后</h3>
<p>其实很多高并发场景，比如点赞、评论、秒杀，核心思路都是异步解耦 + 缓存兜底。</p>
<p>面试官考察的不是你知道多少冷门技术，而是你能不能看透问题本质，用户要的是 <strong>体验</strong> 和 <strong>成功</strong>，不是 <strong>实时准确</strong>。</p>
<p>不过，这套方案看似简单，但覆盖了 “削峰、缓存、异步、最终一致性” 等核心考点，面试时把这个逻辑讲清楚，再结合 Kafka 的消息可靠性、Redis 的高性能、定时任务的批量处理，面试官起码会觉得你 <strong>懂行</strong>。</p>
<p>如果实际业务中，赞数延迟要求极高（比如直播场景，需要实时显示赞数），也可以把定时同步改成 Kafka 消费后实时更新 Redis，数据库异步同步，本质还是换汤不换药～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ant Design 6.0 正式发布：前端开发者的福音与革新]]></title>    <link>https://juejin.cn/post/7576273949186949162</link>    <guid>https://juejin.cn/post/7576273949186949162</guid>    <pubDate>2025-11-25T03:50:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576273949186949162" data-draft-id="7576272680519122987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ant Design 6.0 正式发布：前端开发者的福音与革新"/> <meta itemprop="keywords" content="前端,React.js,Ant Design"/> <meta itemprop="datePublished" content="2025-11-25T03:50:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大前端历险记"/> <meta itemprop="url" content="https://juejin.cn/user/395479916219517"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ant Design 6.0 正式发布：前端开发者的福音与革新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479916219517/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大前端历险记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:50:37.000Z" title="Tue Nov 25 2025 03:50:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Ant Design 6.0 正式发布：前端开发者的福音与革新</h2>
<blockquote>
<p>更快的性能，更小的体积，更好的开发体验</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d361980dab174e8bae803733f21e199b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5YmN56uv5Y6G6Zmp6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647437&amp;x-signature=Ih9l9fDFIpmer31UOjpWh603ouY%3D" alt="" loading="lazy"/></p>
<p>作为一名前端开发者，相信你对 Ant Design 都不陌生。这个拥有近10万Star的React UI组件库，一直以来都是企业级中后台项目的首选。最近，Ant Design 6.0正式发布了，这不仅是版本号的迭代，更是一次<strong>技术架构的全面革新</strong>。</p>
<h3 data-id="heading-1">平滑迁移，体验升级</h3>
<p>与v5相比，v6实现了<strong>无缝迁移体验</strong>。如果你的项目已经在使用v5，不需要任何兼容包或codemod工具，可以直接升级到v6。官方承诺这是一个平滑的技术升级，组件API保持兼容。</p>
<p>v5分支将切换到<code>v5.x-stable</code>并进入<strong>1年的维护周期</strong>，除非出现严重bug，否则不会再进行功能性更新。这意味着v6将是未来发展的重点。</p>
<h3 data-id="heading-2">核心技术突破</h3>
<h4 data-id="heading-3">React 18+成为最低要求</h4>
<p>v6将React最低版本要求提升到了<strong>18</strong>，彻底移除了之前版本的兼容逻辑。这避免了多版本间的API行为差异，让我们能够更纯粹地享受React最新特性带来的开发体验。</p>
<p>对于静态方法如<code>Modal.confirm</code>，不再需要额外的兼容代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 可以移除这行代码了</span>
-- <span class="hljs-keyword">import</span> <span class="hljs-string">'@ant-design/v5-patch-for-react-19'</span>;
</code></pre>
<h4 data-id="heading-4">全面拥抱CSS Variables</h4>
<p>v6最令人兴奋的改进之一是默认采用<strong>纯CSS Variables模式</strong>。这意味着什么？</p>
<p>首先，<strong>性能大幅提升</strong>。浏览器原生支持CSS变量，不再需要JS去计算和插入样式。官方性能对比显示，Zero Runtime模式下的性能表现最佳。</p>
<p>其次，<strong>主题切换变得轻而易举</strong>。现在切换暗色模式，只需要改变根节点的几个CSS变量值，浏览器瞬间就能完成渲染。</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">ConfigProvider</span> theme={{ <span class="hljs-attr">zeroRuntime</span>: <span class="hljs-literal">true</span> }}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">ConfigProvider</span>&gt;
</code></pre>
<p>性能对比如下，zeroRuntime 模式表现最佳（水平轴为主题数量）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97957ecc35984d13818f18299576b55a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5YmN56uv5Y6G6Zmp6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647437&amp;x-signature=A0YCusg7ADiu0jEoWsFlHE6h3fA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b82359eb91354456bf7a76f812bb4c2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5YmN56uv5Y6G6Zmp6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647437&amp;x-signature=k8AmlPSPZqsdrRK4183x6U%2F%2BdTs%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">组件DOM结构语义化</h4>
<p>v6完成了<strong>所有组件的DOM语义化改造</strong>。这解决了长期困扰开发者的问题——如何优雅地定制组件样式。</p>
<p>现在，你可以直接使用<code>classNames</code>和<code>styles</code>属性精准地定制组件各个部分的样式，不再需要写高权重的CSS选择器：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Button</span>
  classNames={{
    <span class="hljs-attr">root</span>: <span class="hljs-string">'rounded-tr-xl rounded-bl-xl'</span>,
    <span class="hljs-attr">icon</span>: <span class="hljs-string">'rotate-30'</span>,
  }}
  icon={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SmileOutlined</span> /&gt;</span></span>}
&gt;
  <span class="hljs-title class_">Ant</span> <span class="hljs-title class_">Design</span>
&lt;/<span class="hljs-title class_">Button</span>&gt;
</code></pre>
<p>这种设计思路很有<strong>Headless UI的味道</strong>，让Ant Design从"写死的积木"变成了提供灵活接口的设计系统。</p>
<h3 data-id="heading-6">与过去告别</h3>
<h4 data-id="heading-7">彻底放弃IE支持</h4>
<p>v6做了一个硬气的决定：<strong>彻底移除对IE的支持</strong>。虽然这对维护老旧项目的团队可能是个坏消息，但对整个前端生态来说是个好消息。</p>
<p>我们终于不需要为了1%的IE用户，去背负沉重的polyfill和hack代码了。</p>
<h4 data-id="heading-8">移除废弃API</h4>
<p>v6清理了所有在v4被标记废弃、v5保留兼容的接口，包括：</p>
<ul>
<li><code>findDOMNode</code>兼容逻辑移除</li>
<li><code>List</code>、<code>Dropdown.Button</code>、<code>BackTop</code>文档移除但保留兼容</li>
<li>React 18兼容代码删除</li>
</ul>
<h3 data-id="heading-9">新组件与功能增强</h3>
<p>v6还引入了一系列新组件和功能增强：</p>
<ul>
<li><strong>Masonry组件</strong>：用于图片墙、卡片流等场景</li>
<li><strong>Tooltip支持平移和滑动</strong>：在多个tooltip内容间进行平移滑动</li>
<li><strong>InputNumber的spinner模式</strong>：常见的按钮布局风格</li>
<li><strong>Drawer支持调整大小</strong>：增强了抽屉组件的交互能力</li>
<li><strong>蒙层模糊背景</strong>：所有弹层类组件默认使用模糊效果</li>
</ul>
<h3 data-id="heading-10">性能优化实践</h3>
<p>在实际项目中，你可以通过以下方式充分利用v6的性能优势：</p>
<h4 data-id="heading-11">1. 启用零运行时模式</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> () =&gt; (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span> <span class="hljs-attr">theme</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">zeroRuntime:</span> <span class="hljs-attr">true</span> }}&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span></span>
);
</code></pre>
<h4 data-id="heading-12">2. 利用Tree Shaking</h4>
<p>v6更好地支持了Tree Shaking，确保打包时只包含实际使用的组件。</p>
<h4 data-id="heading-13">3. 语义化样式覆盖</h4>
<p>放弃高权重的CSS选择器，改用语义化的classNames：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Card</span>
  title=<span class="hljs-string">"Hello World"</span>
  classNames={{
    <span class="hljs-attr">root</span>: <span class="hljs-string">"bg-green-300/10 text-green-500 border-green-500 rounded-none"</span>,
    <span class="hljs-attr">header</span>: <span class="hljs-string">"rounded-none border-green-500"</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">"text-green-500 overflow-visible"</span>,
    <span class="hljs-attr">body</span>: <span class="hljs-string">"rounded-none"</span>
  }}
&gt;
  内容
&lt;/<span class="hljs-title class_">Card</span>&gt;
</code></pre>
<h3 data-id="heading-14">升级建议</h3>
<h4 data-id="heading-15">对于v5用户</h4>
<p><strong>直接升级吧！</strong> 官方承诺是平滑迁移，无需codemod，直接升级即可享受性能提升和CSS变量的红利。升级前记得处理控制台的废弃API警告。</p>
<h4 data-id="heading-16">对于v4用户</h4>
<p>这次升级成本较高，建议先升级到v5过渡，或者在新项目中直接使用v6。</p>
<h4 data-id="heading-17">对于仍需支持IE的用户</h4>
<p>留在v5吧，v5进入了1年的维护周期，足够过渡了。</p>
<h3 data-id="heading-18">总结</h3>
<p>Ant Design 6.0不仅仅是一次版本更新，更是<strong>开发理念的进化</strong>。它试图撕掉"笨重"的标签，向现代前端开发范式看齐。</p>
<p>从CSS-in-JS运行时到纯CSS Variables，从黑盒样式到语义化DOM结构，从兼容包袱到轻装上阵，Ant Design正在努力适应AI时代的前端开发需求。</p>
<p>尝试一下Ant Design 6.0吧，相信它会给你带来不一样的发展体验！</p>
<hr/>
<p>关注我的公众号" <strong>大前端历险记</strong>"，获取更多前端开发干货！</p>
<p><em>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fant-design%2Freleases%2Ftag%2F6.0.0" target="_blank" title="https://github.com/ant-design/ant-design/releases/tag/6.0.0" ref="nofollow noopener noreferrer">Ant Design 6.0 Release Note</a></em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React函数组件与Hooks的实现原理]]></title>    <link>https://juejin.cn/post/7576197876717125670</link>    <guid>https://juejin.cn/post/7576197876717125670</guid>    <pubDate>2025-11-25T01:32:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576197876717125670" data-draft-id="7575093624902025257" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React函数组件与Hooks的实现原理"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-11-25T01:32:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LRH"/> <meta itemprop="url" content="https://juejin.cn/user/3280598427770087"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React函数组件与Hooks的实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598427770087/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LRH
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T01:32:43.000Z" title="Tue Nov 25 2025 01:32:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>我们在编写 React 应用的时候，会使用函数组件配合 Hooks 实现状态管理及其他能力，然而大家是否有深究过为何函数组件需要使用各种 Hooks 来实现其他能力，以及 Hooks 的本质究竟是什么？为什么它们的使用需要严格按照规范，这背后的原理究竟是什么？</p>
<p>本文将针对上述问题展开探讨，分析 Hooks 的本质，以及它们如何与函数组件进行结合，从而辅助函数组件实现各种功能的。</p>
<h2 data-id="heading-1">Hooks 的前世今生</h2>
<h3 data-id="heading-2">React16.8 前的组件</h3>
<p>在 React16.8 版本之前，React 有两种类型的组件，分别是<code>类组件</code>和<code>函数式组件</code>。</p>
<p>它们根本上的区别是，类组件有状态管理、生命周期、副作用等 React 能力，而函数组件则没有。</p>
<p>函数组件用普通的 JS 函数编写，只接收 props 并返回 JSX，不具备状态管理等 React 能力，所以也称为无状态函数组件（Stateless Functional Components）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// helloworld.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> (props) =&gt; (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{props.greeting}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);

<span class="hljs-comment">// Example use</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">HelloWorld</span> <span class="hljs-attr">greeting</span>=<span class="hljs-string">"Hello World!"</span> /&gt;</span></span>;
</code></pre>
<p>所以在 React16.8 版本之前，大部分 React 组件都需要使用类组件来编写，而函数组件只能参与小部分的纯 UI 编写。</p>
<h3 data-id="heading-3">类组件的不足之处</h3>
<p>但是承担着主要作用的类组件，却存在<a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.legacy.reactjs.org%2Fdocs%2Fhooks-intro.html%23motivation" target="_blank" title="https://zh-hans.legacy.reactjs.org/docs/hooks-intro.html#motivation" ref="nofollow noopener noreferrer">三个不足之处</a>：</p>
<h4 data-id="heading-4">组件间难以复用状态逻辑</h4>
<p>类组件中没有实现逻辑复用的原生方案，如果需要在多个组件中复用逻辑，只能通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.legacy.reactjs.org%2Fdocs%2Fhigher-order-components.html" target="_blank" title="https://zh-hans.legacy.reactjs.org/docs/higher-order-components.html" ref="nofollow noopener noreferrer">HOC（高阶组件）</a> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.legacy.reactjs.org%2Fdocs%2Frender-props.html" target="_blank" title="https://zh-hans.legacy.reactjs.org/docs/render-props.html" ref="nofollow noopener noreferrer">Render Props</a> 辅助，代码实现比较麻烦，而且多层嵌套后还会形成“嵌套地狱”的问题。</p>
<h4 data-id="heading-5">逻辑分散，复杂组件变得难以理解</h4>
<p>在某些业务场景中，我们可能需要监听某个变量改变从而执行后续操作，或需要在组件挂载/卸载时执行某些操作。在类组件中，我们需要借助 componentDidUpdate、componentWillUnmount 等生命周期钩子辅助完成。</p>
<p>其中的问题是，假设有一个业务 A，需要使用到上述两个钩子，那么对应的逻辑则需要分别放在它们的回调函数中，造成一个业务的逻辑（在代码中）分散在两个地方，且会与其他业务的代码混杂在一起，使得代码难以阅读和理解。</p>
<h4 data-id="heading-6">class 语义复杂</h4>
<p>类组件使用 JS 原生的 class 语法进行编写，然而使用 class 语法就必须先理解 JS 中的 this 的工作原理，在事件处理函数绑定的时候，需要绑定当前的 this 值。这些复杂的原理和繁杂的使用方式，使类组件难以上手及增加平时使用的负担。</p>
<h3 data-id="heading-7">Hooks 与函数组件</h3>
<h4 data-id="heading-8">Hooks 的目的</h4>
<p>出于对上述类组件的三个不足及 React 长期发展的考虑，React 团队希望推出一种新特性，与无状态函数组件（Stateless Functional Components）配合使用，使其拥有类组件所拥有的能力（即保持状态、处理副作用等 React 特性）。使得<code>无状态函数组件 + Hooks == 类组件</code>，从而实现抛弃类组件也能编写 React 应用的目的。</p>
<h4 data-id="heading-9">Hooks 的本质</h4>
<blockquote>
<p>Hook 是 React 16.8 的新增特性。它可以让你在不编写 class 的情况下使用 state 以及其他的 React 特性。</p>
</blockquote>
<p>如上片段是<a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.legacy.reactjs.org%2Fdocs%2Fhooks-intro.html" target="_blank" title="https://zh-hans.legacy.reactjs.org/docs/hooks-intro.html" ref="nofollow noopener noreferrer">React 官方文档</a>对 Hooks 的总结性描述。</p>
<p>Hooks 的本质是普通的 JS 函数，它只能在函数组件或另一个 Hook 中调用，而不能在类组件中使用。</p>
<p>且在使用各种 Hooks 的时候，必须遵守如下规则：<code>Hooks只能在函数组件或自定义Hook的最顶层调用</code>，即不能在条件语句、循环语句或其他嵌套函数内调用 Hook，必须保障<code>函数组件每次调用时，各个Hooks的调用顺序一致</code>。</p>
<p>接下来本文将会围绕以下三点展开：</p>
<ol>
<li>Hooks 的来源（针对不同时机调用不同版本的 Hooks）</li>
<li>Hooks 是如何被存储的（为什么需要保持调用顺序一致）</li>
<li>以 useState 和 useEffect 为例，展示 Hooks 的执行流程。</li>
</ol>
<h2 data-id="heading-10">Hooks 的来源</h2>
<p>React 组件被调用时，会处于以下两个阶段中的一个：</p>
<ul>
<li>mount 阶段（组件初次挂载时）</li>
<li>update 阶段（已经挂载过的组件更新时）</li>
</ul>
<p>而处于不同阶段的组件，所引用的 Hooks 其实是不一样的。</p>
<p>如下代码所示，Count 组件第一次挂载时和后续更新时，所引用执行的 useState 函数是不一样的（即使它们都叫做 useState），useEffect 同理。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Count</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 不同阶段所引用的 useState 函数是不一样的</span>
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// useEffect 同理</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`count：<span class="hljs-subst">${count}</span>`</span>);
  }, [count]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Count</span>;
</code></pre>
<p>每个 Hook 都会有两套版本，即 mount 版本和 update 版本，分别存放在 HooksDispatcherOnMount 对象和 HooksDispatcherOnUpdate 对象中。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 存放所有mount时期需要执行的Hooks</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HooksDispatcherOnMount</span> = {
  <span class="hljs-comment">// ... some code .. 其他hooks基本同理</span>

  <span class="hljs-comment">// mount时期需要执行的useEffect</span>
  <span class="hljs-attr">useEffect</span>: mountEffect,
  <span class="hljs-attr">useRef</span>: mountRef,
  <span class="hljs-attr">useState</span>: mountState,

  <span class="hljs-comment">// ... some code ...</span>
};

<span class="hljs-comment">// 存放所有update时期需要执行的Hooks</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HooksDispatcherOnUpdate</span>: <span class="hljs-title class_">Dispatcher</span> = {
  <span class="hljs-comment">// ... some code .. 其他hooks基本同理</span>

  <span class="hljs-attr">useEffect</span>: updateEffect,
  <span class="hljs-attr">useRef</span>: updateRef,
  <span class="hljs-attr">useState</span>: updateState,

  <span class="hljs-comment">// ... some code ...</span>
};
</code></pre>
<p>而 React 组件是如何知道在当前阶段应该从哪个对象中取出所需的 Hooks 呢？答案就是 ReactCurrentDispatcher ，现在我们可以将其理解为一个“Hooks 调度器”，他的 current 属性会指向组件当前阶段所对应的 Hooks 集合（即上述的 HooksDispatcherOnMount 或 HooksDispatcherOnUpdate）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">ReactCurrentDispatcher</span> = {
  <span class="hljs-comment">// 此current属性将会动态指向 HooksDispatcherOnMount 或 HooksDispatcherOnUpdate</span>
  <span class="hljs-attr">current</span>: <span class="hljs-literal">null</span>,
};
</code></pre>
<p>当 ReactCurrentDispatcher 的 current 通过某种方式（下文将会提到）指向了某个 Hooks 集合之后，各个 Hooks 在执行时就会从所指的集合中取出对应 Hook。以 useState 和 useEffect 为例，它们的源码分别如下所示：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useState</span>(<span class="hljs-params">initialState</span>) {
  <span class="hljs-comment">// 获取ReactCurrentDispatcher.current的指向</span>
  <span class="hljs-keyword">const</span> dispatcher = <span class="hljs-title function_">resolveDispatcher</span>();
  <span class="hljs-comment">// 从正确的Hooks集合中取出对应的Hook</span>
  <span class="hljs-keyword">return</span> dispatcher.<span class="hljs-title function_">useState</span>(initialState);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useEffect</span>(<span class="hljs-params">create, deps</span>) {
  <span class="hljs-comment">// 获取ReactCurrentDispatcher.current的指向</span>
  <span class="hljs-keyword">const</span> dispatcher = <span class="hljs-title function_">resolveDispatcher</span>();
  <span class="hljs-comment">// 从正确的Hooks集合中取出对应的Hook</span>
  <span class="hljs-keyword">return</span> dispatcher.<span class="hljs-title function_">useEffect</span>(create, deps);
}
</code></pre>
<p>从上述 useState 和 useEffect 的例子可见，一般情况下，一个 Hook 函数被调用时，不会立即执行对应 Hook 的“本体”，而是先通过 ReactCurrentDispatcher.current 获取到当前组件所需的 Hooks 集合（HooksDispatcherOnMount 或 HooksDispatcherOnUpdate），然后从中取出真正的“本体”执行。</p>
<p>而上述 useState 和 useEffect 中的 resolveDispatcher 函数，本质就是返回 ReactCurrentDispatcher.current 的指向，源码如下所示：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">resolveDispatcher</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> dispatcher = <span class="hljs-title class_">ReactCurrentDispatcher</span>.<span class="hljs-property">current</span>;
  <span class="hljs-keyword">return</span> dispatcher;
}
</code></pre>
<p>如下图展示了 ReactCurrentDispatcher.current 的赋值及 Hooks 提取并执行的过程</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f493d0f5a0204adca69b1a2db7817f31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTFJI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764639163&amp;x-signature=EwfdfS%2B5nUuVjMraIj2sjE%2B%2FilM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-11">ReactCurrentDispatcher.current 的指向</h3>
<p>现在我们知道了 ReactCurrentDispatcher.current 会根据当前被调用的组件所处的阶段，指向 HooksDispatcherOnMount 或 HooksDispatcherOnUpdate 对象。接下来我们将探讨 ReactCurrentDispatcher.current 是如何指向正确的 Hooks 集合的。</p>
<p>在开始之前，我们需要知道在 React 的双缓存架构中，维护着 current fiber tree 和 workInProgress fiber tree 这两颗树，它们分别代表当前页面的 fiber 节点所组成的树，和下一个页面的 fiber 节点所组成的树。</p>
<p>而对于某个组件而言，当它在初始化挂载的时候，是没有对应的 current fiber 节点的，只有当挂载完毕之后，才会将 workInprogress fiber 节点赋值给 current fiber 节点。所以 React 判断当前组件是否是处于初始化挂载阶段，采用的是<code>判断其 current fiber 节点是否为空</code>，反之则为更新阶段。</p>
<p>除了上述判断条件之外，我们还需引入另一个条件进行辅助判断：当前组件是否已经初始化过 Hooks。代码中的体现为判断 current.memoizedState 属性是否为空，此属性用于当前组件存储自身所有的 Hooks（以链表的方式存储，本文后续将会提到）。使用 memoizedState 进行辅助判断的原因是 React 的渲染过程是可以中断的，可能出现的一种情况为，已经为当前组件创建了 fiber 节点但没有提交，此时渲染中断，等到后续重新渲染的时候，可以复用之前的 fiber 节点，但是其 Hooks 是没有初始化，即 memoizedState 属性为空。</p>
<p>归纳一下，ReactCurrentDispatcher.current 只有如下两种情况会指向 HooksDispatcherOnMount，其余情况都指向 HooksDispatcherOnUpdate：</p>
<ol>
<li>当前组件 fiber 节点没有初始化过</li>
<li>当前组件 fiber 节点的 memoizedState 属性为空（即 Hooks 链表为空）</li>
</ol>
<p>节选代码如下所示：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderWithHooks</span>(<span class="hljs-params">
  current, <span class="hljs-comment">// current Fiber</span>
  workInProgress, <span class="hljs-comment">// workInProgress Fiber</span>
  Component <span class="hljs-comment">// 函数组件本身</span>
  <span class="hljs-comment">// ... 其他形参 ...</span>
</span>) {
  <span class="hljs-comment">// ... some code ...</span>

  <span class="hljs-title class_">ReactCurrentDispatcher</span>.<span class="hljs-property">current</span> =
    current === <span class="hljs-literal">null</span> || current.<span class="hljs-property">memoizedState</span> === <span class="hljs-literal">null</span> <span class="hljs-comment">// current.memoizedState === null 代表当前组件没有使用过任何Hooks</span>
      ? <span class="hljs-title class_">HooksDispatcherOnMount</span>
      : <span class="hljs-title class_">HooksDispatcherOnUpdate</span>;

  <span class="hljs-comment">// ... some code ...</span>
}
</code></pre>
<h2 data-id="heading-12">Hook 的数据结构及储存方式</h2>
<h3 data-id="heading-13">Hook 的数据结构</h3>
<p>接下来我们聊一下 Hooks 执行之后，会生成什么样的数据结构进行存储。<br/>
在源码中，我们可以看到执行之后的 Hook 会以对象的形式存储。而每个 Hook 对象可能会拥有不同的属性，或同名属性有不同的用途，这需要根据具体 Hooks 具体分析。</p>
<p>如下展示的是 useState 的 hook 对象，拥有如下 5 个属性：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Hook</span> = {
  <span class="hljs-attr">memoizedState</span>: <span class="hljs-built_in">any</span>; <span class="hljs-comment">// 当前渲染后保存的state的值</span>
  <span class="hljs-attr">baseState</span>: <span class="hljs-built_in">any</span>; <span class="hljs-comment">// 上一次未被跳过的基础state</span>
  <span class="hljs-attr">baseQueue</span>: <span class="hljs-title class_">Update</span>&lt;<span class="hljs-built_in">any</span>, <span class="hljs-built_in">any</span>&gt; | <span class="hljs-literal">null</span>; <span class="hljs-comment">// 保存之前未被处理的更新链表</span>
  <span class="hljs-attr">queue</span>: <span class="hljs-built_in">any</span>; <span class="hljs-comment">// 当前useState对应的更新链表</span>
  <span class="hljs-attr">next</span>: <span class="hljs-title class_">Hook</span> | <span class="hljs-literal">null</span>; <span class="hljs-comment">// 指向下一个hook对象</span>
};
</code></pre>
<ul>
<li>memoizedState： 保存当前 Hook 的状态值，不同类型的 Hook 保存不同的信息。（如 useState 中 保存 state 信息、useEffect 中 保存着 effect 对象、useRef 中保存的是 ref 对象）。</li>
<li>baseState：保存在上一次 render 中未被跳过的 state 基准值（主要用于 useState 和 useReducer 的批量更新或中断更新场景。如：在并发模式（Concurrent Mode）下，如果某个更新被中断或跳过，React 需要一个“基础状态”来重新计算后续更新。baseState 就是这个起点。）</li>
<li>baseQueue：保存那些尚未被处理（或被跳过）的更新队列。（低优先级更新被高优先级更新打断后，这些被挂起的更新会被暂存在 baseQueue 中，等到合适的时机再重新应用。）</li>
<li>queue：(一般只在 useState 和 useReducer 中发挥作用)以循环链表的方式储存当前 Hook 的更新对象</li>
<li>next：指向当前组件的下一个 Hook 对象的引用。</li>
</ul>
<h3 data-id="heading-14">Hook 对象在 React 的存储方式</h3>
<p>当我们大概了解 Hook 的结构后，再聊聊它们是如何与对应的组件进行绑定及存储的。</p>
<p>函数组件不像类组件那样有自己的实例，它们是以 fiber 节点的形式存在的。其中 Fiber 对象中有一个关键的<code>memoizedState</code>属性，此属性储存当前函数组件所有 Hook 对象所组成的链表（在类组件中，此属性储存的则是当前组件的状态）。</p>
<p>当我们在一个组件中调用多个 Hooks 时，React 会为每个 Hook 创建一个对象，并按顺序挂载到 fiber.memoizedState 中：</p>
<pre><code class="hljs language-scss" lang="scss">fiber<span class="hljs-selector-class">.memoizedState</span>
  ↓
Hook1 (useState)
  ↓
Hook2 (useEffect)
  ↓
Hook3 (useRef)
</code></pre>
<p>在函数组件重新执行的时候，就会顺着这条链表去“对号入座”，为每个 Hook 匹配正确的 Hook 对象。</p>
<blockquote>
<p>第一个 Hook → 第一个 Hook 节点<br/>
第二个 Hook → 第二个 Hook 节点<br/>
...以此类推</p>
</blockquote>
<p>这也可以解释，为什么 Hooks 必须在组件的顶层使用，而不能在条件分支中调用。因为如果每次组件重新执行时，Hooks 的数量不一致，那么 fiber.memoizedState 的链表就会错乱，无法正确匹配。</p>
<h2 data-id="heading-15">梳理执行流程：从函数组件的执行说起</h2>
<h3 data-id="heading-16">函数组件执行</h3>
<p>接下来我们将从函数组件的执行出发，梳理 Hooks 是如何被创建及发挥其作用的。</p>
<p>函数组件的本质就是一个 JS 函数，那么它们是如何被调用的呢？</p>
<p>答案就是上一节所提到的<code>renderWithHooks</code>函数，此函数会接收如下几个参数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">renderWithHooks</span>(
  current, <span class="hljs-comment">// current Fiber</span>
  workInProgress, <span class="hljs-comment">// workInProgress Fiber</span>
  <span class="hljs-title class_">Component</span>, <span class="hljs-comment">// 函数组件本身</span>
  props, <span class="hljs-comment">// props</span>
  context, <span class="hljs-comment">// 上下文</span>
  renderExpirationTime <span class="hljs-comment">// 渲染 ExpirationTime</span>
);
</code></pre>
<p>其中第三个参数<code>Component</code>就是函数组件本身（即一个 JS 函数），将会在上述 renderWithHook 函数中被调用。</p>
<p>整体宏观流程如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b654f9cac5e843789783d84b1dfd9a10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTFJI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764639163&amp;x-signature=6GgqxBMwhXqzUeUNqBdBoJGz5dU%3D" alt="image.png" loading="lazy"/></p>
<p>整个流程可分为三个步骤：</p>
<ol>
<li>首先根据传入的 current 判断当前组件是否是初次渲染，从而决定 ReactCurrentDispatcher.current 的指向。</li>
<li>执行 Component 函数，执行函数组件，遇到 Hooks 时从 ReactCurrentDispatcher.current 获取并执行</li>
<li>将 ReactCurrentDispatcher.current 赋值为 ContextOnlyDispatcher</li>
</ol>
<p>接下来我们将从上述三点展开阐述：</p>
<ul>
<li>
<p>第一点中对 ReactCurrentDispatcher.current 的赋值相信大家通过前文已经有所了解，就是通过 current 参数判断当前组件是否是第一次挂载，从而决定指向 HooksDispatcherOnMount 还是 HooksDispatcherOnUpdate。</p>
</li>
<li>
<p>第二点主要阐述各个 Hooks 是如何运行的，虽然各个 Hooks 的具体逻辑有所不同，但大致过程是相同的。这一点会在下文详细展开。</p>
</li>
<li>
<p>第三点中提到当 Component 执行完毕之后，会将 ReactCurrentDispatcher.current 指向 ContextOnlyDispatcher 对象。此对象就是类似 HooksDispatcherOnMount 和 HooksDispatcherOnUpdate 的 Hooks 集合，只不过里面的 Hooks 大都指向同一个 throwInvalidHookError 函数。</p>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ContextOnlyDispatcher</span>: <span class="hljs-title class_">Dispatcher</span> = {
  <span class="hljs-comment">// ... some code ...</span>
  <span class="hljs-attr">useEffect</span>: throwInvalidHookError,
  <span class="hljs-attr">useState</span>: throwInvalidHookError,
  <span class="hljs-comment">// ... some code ...</span>
};
</code></pre>
<p>throwInvalidHookError 函数如下所示，执行时会抛出错误，以提示“hooks 只能在函数组件内部使用”。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">throwInvalidHookError</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(
    <span class="hljs-string">"Invalid hook call. Hooks can only be called inside of the body of a function component. This could happen for"</span> +
      <span class="hljs-string">" one of the following reasons:\n"</span> +
      <span class="hljs-string">"1. You might have mismatching versions of React and the renderer (such as React DOM)\n"</span> +
      <span class="hljs-string">"2. You might be breaking the Rules of Hooks\n"</span> +
      <span class="hljs-string">"3. You might have more than one copy of React in the same app\n"</span> +
      <span class="hljs-string">"See https://reactjs.org/link/invalid-hook-call for tips about how to debug and fix this problem."</span>
  );
}
</code></pre>
<p>其作用是确保 Hooks 只能在函数内部被调用，否则就会抛出错误。回看上面的图片会发现，当函数组件将要被调用时，会经历三个阶段<code>赋值ReactCurrentDispatcher.current -&gt; 执行Component函数 -&gt; 赋值ReactCurrentDispatcher.current</code>，即 <strong>ReactCurrentDispatcher.current 只有在函数组件被执行的期间才会正确指向 HooksDispatcherOnMount 或 HooksDispatcherOnUpdate</strong>，其他时间都会指向 ContextOnlyDispatcher。<br/>
这就是为什么如果在函数组件之外调用 Hooks 那么就会报错的原因。</p>
<h3 data-id="heading-17">Hooks 执行</h3>
<p>接下来我们将展开当函数组件遇到 Hooks 时是如何执行的。</p>
<p>Hooks 的执行流程可以宏观地分为两个阶段：</p>
<ol>
<li>获取 Hook 对象</li>
<li>执行 Hook 个性化逻辑</li>
</ol>
<p>如上步骤所示，每个 Hook 执行之前都会拿到当前的 Hook 对象，这一步的逻辑是统一的，后续才是根据不同类型的 Hook 执行不同的逻辑。</p>
<h4 data-id="heading-18">获取 hook 对象</h4>
<p>那么接下来我们将展开聊聊 Hook 执行时是如何获取当前的 Hook 对象的。</p>
<h5 data-id="heading-19">首次渲染 - mountWorkInProgressHook</h5>
<p>对于第一次渲染的组件而言，它们获取每个 Hook 对象的方式是调用 mountWorkInProgressHook 函数，此函数会创建一个全新的 hook 对象，并将其挂载到当前组件 fiber 对象的 memoizedState 链表上。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">mountWorkInProgressHook</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 创建一个新的 hook 对象</span>
  <span class="hljs-keyword">const</span> hook = {
    <span class="hljs-attr">memoizedState</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">baseState</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">baseQueue</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">queue</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">next</span>: <span class="hljs-literal">null</span>,
  };
  <span class="hljs-comment">// 判断当前hook是否是当前函数组件的第一个hook</span>
  <span class="hljs-keyword">if</span> (workInProgressHook === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 将hook对象直接挂载到当前fiber.memoizedState</span>
    currentlyRenderingFiber.<span class="hljs-property">memoizedState</span> = workInProgressHook = hook;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 移动指针保存当前hook对象（hook对象在fiber.memoizedState上以链表方式存储）</span>
    workInProgressHook = workInProgressHook.<span class="hljs-property">next</span> = hook;
  }
  <span class="hljs-comment">// 返回当前hook对象的引用</span>
  <span class="hljs-keyword">return</span> workInProgressHook;
}
</code></pre>
<h5 data-id="heading-20">组件更新 - updateWorkInProgressHook</h5>
<p>对于是 update 时重新渲染的组件，它们的各个 Hook 已经拥有了各自的 hook 对象并挂载到 currnet fiber 的 memoizedState 链表上，所以现在我们需要根据 currnet fiber 树中的 hooks 链表生成当前渲染的 workInProgress fiber 树的 Hooks 链表，使组件更新前后 Hooks 链表结构一致。</p>
<p>具体做法是维护以下两个指针辅助 workInProgress fiber 树生成 Hooks 链表：</p>
<ul>
<li>currentHook：指向 current Fiber 树（上次渲染）的 Hook 链表当前位置</li>
<li>workInProgressHook：指向 workInProgress Fiber 树（本次渲染）已构建链表的末尾</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateWorkInProgressHook</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Hook</span> {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">nextCurrentHook</span>: <span class="hljs-literal">null</span> | <span class="hljs-title class_">Hook</span>;

  <span class="hljs-keyword">if</span> (currentHook === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 说明这是当前组件的第一个 Hook</span>
    <span class="hljs-keyword">const</span> current = currentlyRenderingFiber.<span class="hljs-property">alternate</span>; <span class="hljs-comment">// 获取 current fiber 树的引用</span>
    <span class="hljs-keyword">if</span> (current !== <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 指向 current fiber 树 的 memoizedState（即Hook 链表的链头）</span>
      nextCurrentHook = current.<span class="hljs-property">memoizedState</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 若不存current fiber 树（可能处于首轮挂载过程中的特殊重渲染分支），则无 current hooks链可对齐</span>
      nextCurrentHook = <span class="hljs-literal">null</span>;
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 常规情况：沿着 current hook 链推进到下一个 Hook</span>
    nextCurrentHook = currentHook.<span class="hljs-property">next</span>;
  }

  <span class="hljs-comment">// 计算 workInProgress 链表中下一个应当使用/复用的节点</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">nextWorkInProgressHook</span>: <span class="hljs-literal">null</span> | <span class="hljs-title class_">Hook</span>;
  <span class="hljs-keyword">if</span> (workInProgressHook === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 若还未创建任何 workInProgress Hook 节点，则从 fiber.memoizedState（即链头）开始</span>
    nextWorkInProgressHook = currentlyRenderingFiber.<span class="hljs-property">memoizedState</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 否则从已构建的 workInProgress 链表的下一个节点尝试复用</span>
    nextWorkInProgressHook = workInProgressHook.<span class="hljs-property">next</span>;
  }

  <span class="hljs-keyword">if</span> (nextWorkInProgressHook !== <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 情况 1：已经存在对应的 workInProgress Hook，直接复用</span>
    workInProgressHook = nextWorkInProgressHook;
    nextWorkInProgressHook = workInProgressHook.<span class="hljs-property">next</span>;

    currentHook = nextCurrentHook;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 情况 2：没有可复用的 workInProgress hook 节点，需要从 currentHook 克隆一个新的 Hook 节点</span>
    <span class="hljs-keyword">if</span> (nextCurrentHook === <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 若连 current 的对应节点也没有，说明当前渲染调用的 Hook 数量“超过了上一轮的数量”</span>
      <span class="hljs-comment">// 违反“Hook 调用顺序与数量在渲染间保持一致”的约束，直接抛错</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Rendered more hooks than during the previous render."</span>);
    }

    <span class="hljs-comment">// 将 current 指针推进到下一个</span>
    currentHook = nextCurrentHook;

    <span class="hljs-comment">// 基于 currentHook 克隆一个新的 Hook 节点到 workInProgress 的hooks 链中</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">newHook</span>: <span class="hljs-title class_">Hook</span> = {
      <span class="hljs-attr">memoizedState</span>: currentHook.<span class="hljs-property">memoizedState</span>,
      <span class="hljs-attr">baseState</span>: currentHook.<span class="hljs-property">baseState</span>,
      <span class="hljs-attr">baseQueue</span>: currentHook.<span class="hljs-property">baseQueue</span>,
      <span class="hljs-attr">queue</span>: currentHook.<span class="hljs-property">queue</span>,
      <span class="hljs-attr">next</span>: <span class="hljs-literal">null</span>,
    };

    <span class="hljs-keyword">if</span> (workInProgressHook === <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 若这是本轮渲染的第一个 Hook</span>
      <span class="hljs-comment">// 将 fiber.memoizedState 指向该新 Hook，作为 workInProgress 树的hook 链头</span>
      currentlyRenderingFiber.<span class="hljs-property">memoizedState</span> = workInProgressHook = newHook;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 挂载到 workInProgress 树hooks链表的末尾，并推进指针</span>
      workInProgressHook = workInProgressHook.<span class="hljs-property">next</span> = newHook;
    }
  }

  <span class="hljs-comment">// 返回本次对应的 wip Hook 节点。</span>
  <span class="hljs-keyword">return</span> workInProgressHook;
}
</code></pre>
<h4 data-id="heading-21">执行各个 hook 具体逻辑</h4>
<p>当执行了上述的 mountWorkInProgressHook 或 updateWorkInProgressHook 函数获取到 hook 对象之后，就正式开始执行各个 hook 的具体逻辑了。</p>
<p>接下来会以常用的 useState 和 useEffect 进行举例说明它们在组件首次渲染和更新时发生了什么。</p>
<h5 data-id="heading-22">useState</h5>
<h6 data-id="heading-23">函数组件首次渲染： mountState</h6>
<p>组件第一次渲染时，useState 的“本体”是 mountState 函数，代码如下所示</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">mountState</span>(<span class="hljs-params">initialState</span>) {
  <span class="hljs-comment">// 步骤一：为当前Hook创建Hook对象并挂载</span>
  <span class="hljs-keyword">const</span> hook = <span class="hljs-title function_">mountWorkInProgressHook</span>();

  <span class="hljs-comment">// 步骤二：计算初始 state 并挂载保存</span>
  <span class="hljs-comment">// 当useState的参数为函数时，执行它并将返回值作为state的值</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> initialState === <span class="hljs-string">"function"</span>) {
    initialState = <span class="hljs-title function_">initialState</span>();
  }
  <span class="hljs-comment">// 将初始state的值分别挂载到hook对象的baseState和memoizedState属性上</span>
  hook.<span class="hljs-property">memoizedState</span> = hook.<span class="hljs-property">baseState</span> = initialState;

  <span class="hljs-comment">// 步骤三：初始化 hook.queue 属性</span>
  <span class="hljs-comment">// 初始化hook对象的queue属性，方便后续在其上面挂载update对象</span>
  <span class="hljs-keyword">const</span> queue = {
    <span class="hljs-attr">pending</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 用于存放update对象链表</span>
    <span class="hljs-attr">lanes</span>: <span class="hljs-title class_">NoLanes</span>,
    <span class="hljs-attr">dispatch</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">lastRenderedReducer</span>: basicStateReducer, <span class="hljs-comment">// 基础reducer函数（下文会提到）</span>
    <span class="hljs-attr">lastRenderedState</span>: initialState,
  };
  hook.<span class="hljs-property">queue</span> = queue;

  <span class="hljs-comment">// 步骤四：创建 setXXX 函数</span>
  <span class="hljs-comment">// 创建setXXX函数，为其绑定当前Fiber节点及update对象链表</span>
  <span class="hljs-keyword">const</span> dispatch = (queue.<span class="hljs-property">dispatch</span> = dispatchSetState.<span class="hljs-title function_">bind</span>(
    <span class="hljs-literal">null</span>,
    currentlyRenderingFiber,
    queue
  ));

  <span class="hljs-keyword">return</span> [hook.<span class="hljs-property">memoizedState</span>, dispatch];
}
</code></pre>
<p>上述操作我们可以简单归纳为四个步骤：</p>
<ol>
<li>hook 对象创建与挂载</li>
<li>计算初始 state 并挂载保存</li>
<li>初始化 hook.queue 属性</li>
<li>创建 setXXX 函数，为其绑定当前 fiber 节点与 update 链表 queue</li>
</ol>
<p>第一点的创建 hook 对象，需要使用前文提到的函数 mountWorkInProgressHook。</p>
<p>第二点即是根据参数类型，通过计算或直接获取 state 值，并挂载到 hook.memoizedState 上。</p>
<p>第三点则是初始化 hook.queue 属性，用于后续保存 update 对象链表等信息（此 queue 属性一般只在 useState 和 useReducer 的 hook 对象中被使用）</p>
<p>第四点会创建 dispatch 函数，此函数其实就是 useState 返回的数组的第二个元素（即 setXXX 函数）。</p>
<p>前三个步骤都以相对容易理解的，接下来需要对第四步的 dispatch 函数展开聊聊。</p>
<h6 data-id="heading-24">dispatchSetState</h6>
<p>dispatch 函数实际上就是 dispatchSetState 函数调用 bind 绑定了两个实参后返回的新函数。/
接下来我们看看这个 dispatchSetState 究竟做了什么。</p>
<p>它的作用可简单归纳为三个步骤：</p>
<ol>
<li>创建 update 对象。</li>
<li>eager state 优化：决定是否重新渲染组件</li>
<li>将 update 对象挂载至 hook.queue 上</li>
<li>执行调度函数，调度更新的执行。</li>
</ol>
<p>至于它是如何知道要挂载到哪个 hook 的 queue 上的，答案就在于其参数上。</p>
<p>如下是精简后的 dispatchSetState 的伪代码：<br/>
此函数实际上需要接收三个参数，而我们平时调用 setXXX 函数时，只需传入具体的值或一个回调函数。此时我们传入的其实是第三个参数，前两个参数会在 mountState 执行时，使用 bind 帮我们绑定，把对应的 fiber 节点和 hook.queue 绑定。
这样就能确保调用 setXX 函数时，如何正确更新对应的 state 了。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">dispatchSetState</span>(<span class="hljs-params">
  fiber,
  queue,
  action <span class="hljs-comment">// setXXX的参数，可为函数或普通值</span>
</span>) {
  <span class="hljs-comment">// 步骤一：创建update对象</span>
  <span class="hljs-keyword">const</span> update = {
    expirationTime,
    suspenseConfig,
    action,
    <span class="hljs-attr">eagerReducer</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">eagerState</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">next</span>: <span class="hljs-literal">null</span>,
  };

  <span class="hljs-comment">// 步骤二：Eager state 优化</span>
  <span class="hljs-keyword">const</span> baseState = queue.<span class="hljs-property">lastRenderedState</span>; <span class="hljs-comment">// 上一次渲染完成时的状态</span>
  <span class="hljs-keyword">const</span> eagerReducer = queue.<span class="hljs-property">lastRenderedReducer</span>; <span class="hljs-comment">// 用于计算新的state的reducer函数（下文会再展开）</span>
  <span class="hljs-keyword">if</span> (eagerReducer !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 直接计算新 state（不重新渲染组件）</span>
      <span class="hljs-keyword">const</span> eagerState = <span class="hljs-title function_">eagerReducer</span>(baseState, action);

      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(eagerState, baseState)) {
        <span class="hljs-comment">// 结果没变，直接返回，不触发调度</span>
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-comment">// 记录提前计算的结果，方便下次渲染使用</span>
      update.<span class="hljs-property">eagerState</span> = eagerState;
      update.<span class="hljs-property">hasEagerState</span> = <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">catch</span> {
      <span class="hljs-comment">// eager 计算出错时忽略</span>
    }
  }

  <span class="hljs-comment">// 步骤三：挂载update对象（update对象链表会以环形链表的方式储存）</span>
  <span class="hljs-keyword">const</span> pending = queue.<span class="hljs-property">shared</span>.<span class="hljs-property">pending</span>; <span class="hljs-comment">// update队列</span>
  <span class="hljs-keyword">if</span> (pending === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 是第一次更新</span>
    update.<span class="hljs-property">next</span> = update; <span class="hljs-comment">// 当前update对象指向自己，形式环状</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 不是第一次更新</span>
    update.<span class="hljs-property">next</span> = pending.<span class="hljs-property">next</span>; <span class="hljs-comment">// 当前update对象指向pending.next（即第一个加入的update）</span>
    pending.<span class="hljs-property">next</span> = update; <span class="hljs-comment">// pending.next指向当前update对象（链表中最迟加入的的update指向当前update）</span>
  }
  queue.<span class="hljs-property">pending</span> = update; <span class="hljs-comment">// pending 指向当前update</span>

  <span class="hljs-comment">// 步骤四：调度更新操作（并非同步执行，具体调度逻辑由 scheduler 执行）</span>
  <span class="hljs-title function_">scheduleUpdateOnFiber</span>(fiber, expirationTime);
}
</code></pre>
<p>拓展：上面代码提到的，update 对象链表以环形链表存放于 fiber 节点的 queue.shared.pending 属性上。</p>
<p>示意图如下所示，其中三个 update 对象的加入顺序为：update1 -&gt; update2 -&gt; update3</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8c7211a8359486c9c413cc6af1bf31e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTFJI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764639163&amp;x-signature=Ev0dsKT9RcohSfQEDR0Za7g%2FVek%3D" alt="image.png" loading="lazy"/></p>
<p>关键点为：</p>
<ul>
<li>queue.shared.pending 指向最后加入的 update</li>
<li>queue.shared.pending.next 指向第一个加入的 update</li>
</ul>
<h6 data-id="heading-25">函数组件更新：updateState</h6>
<p>在函数组件更新时，useState 的“本体”是 updateState 函数，它的源码如下所示</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateState</span>(<span class="hljs-params">initialState</span>) {
  <span class="hljs-comment">//  实质上是调用 useReducer 的 updateReducer 函数</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateReducer</span>(basicStateReducer, initialState);
}
</code></pre>
<p>从上述代码中我们可以看到，updateState 实际上是调用 useReducer 在组件更新时执行的本体——updateReducer。也就是说，在函数组件更新时，useState 和 useReducer 所执行的逻辑是一样的。</p>
<p>首先我们从 useState 和 useReducer 使用的角度来看看，为什么 useState 能使用 useReducer 的逻辑，以及上面的 basicStateReducer 参数究竟是什么。</p>
<p>如下为 useState 的使用方式，可以使用两种传参方式去修改 state 的值</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
<span class="hljs-comment">// 方式一：直接传入目标值</span>
<span class="hljs-title function_">setCount</span>(<span class="hljs-number">100</span>);
<span class="hljs-comment">// 方式二：传入计算函数</span>
<span class="hljs-title function_">setCount</span>(<span class="hljs-function">(<span class="hljs-params">n</span>) =&gt;</span> n + <span class="hljs-number">1</span>);
</code></pre>
<p>而实际上，我们使用 useReducer 也能实现上述目标</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">reducer</span>(<span class="hljs-params">state, action</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> action === <span class="hljs-string">"function"</span>) {
    <span class="hljs-comment">// action为函数时，将当前state传入，并将其返回值视为新的state</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">action</span>(state);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// action不为函数，则直接将其设置为新的state</span>
    <span class="hljs-keyword">return</span> action;
  }
}

<span class="hljs-keyword">const</span> [count, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, <span class="hljs-number">0</span>);
<span class="hljs-comment">// 直接传入具体值修改count</span>
<span class="hljs-title function_">dispatch</span>(<span class="hljs-number">100</span>);
<span class="hljs-comment">// 传入计算函数</span>
<span class="hljs-title function_">dispatch</span>(<span class="hljs-function">(<span class="hljs-params">n</span>) =&gt;</span> n + <span class="hljs-number">1</span>);
</code></pre>
<p>从上面 useState 和 useReducer 的使用对比，可以看出 useState 实际上就是一个简易版的 useReducer。是一个 React 帮我们写好 reducer 函数，并且没有 action.type（即 reducer 中没有多种逻辑）的功能单一的 useReducer。</p>
<p>上面 updateState 的源码中提到了，updateState 执行时，会返回 updateReducer(basicStateReducer, initialState)的返回值。其中 initialState 参数就是 useState 的参数，而 basicStateReducer 实际上就是上面提到的“React 帮我们写好的 reducer 函数”，逻辑与我们上面编写的 reducer 函数一样，源码如下所示</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 最基础的reducer，action是“普通值”或“接收当前值并返回新值的函数”。（即setXXX的参数）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">basicStateReducer</span>(<span class="hljs-params">prevState, action</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> action === <span class="hljs-string">"function"</span> ? <span class="hljs-title function_">action</span>(prevState) : action;
}
</code></pre>
<p>接下来我们首先从宏观上理解为什么 useState 能帮助函数组件记忆并计算出最新 state 值。</p>
<p>useState 在函数组件更新时，执行的“本体”的 updateState 函数，从宏观上它会执行如下操作，计算出最新的 state，储存并返回出来供函数组件使用：</p>
<ol>
<li>取出基础值：updateState 从 hook.baseState 取出上一次的 state 值（因可能存在因优先级不匹配而跳过更新的情况，baseState 记录上一次跳过更新后的基础状态，而 hook.memoizedState 记录的是上次渲染结果的状态）。</li>
<li>获取更新链表：使用 hook.baseQueue（储存可能存在的上次渲染因优先级不匹配而被跳过的更新对象链表）与 hook.queue.pending（本次渲染的新的更新链表）合并，然后按照 lanes 优先级过滤（即假设本次渲染为高优先渲染，则过滤掉优先级不匹配的更新对象），将被过滤掉但需要保留的更新对象链表存储回 baseQueue 中（供下次渲染时使用），得出最终要更新的 update 链表。</li>
<li>根据 baseState 及最终的 update 链表，依次计算，并得出 state 的最终值，写到 hook.memoizedState 和 hook.baseState 上。</li>
<li>将最终值返回，供函数组件使用。</li>
</ol>
<p>如下是 updateReducer 的伪代码，旨在梳理 updateState 的主体流程</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateReducer</span>(<span class="hljs-params">
  hook,
  reducer,
  renderLane, <span class="hljs-comment">// 本次渲染的优先级（车道）</span>
</span>) {
  <span class="hljs-keyword">const</span> queue = hook.<span class="hljs-property">queue</span>;

  <span class="hljs-comment">// 1) 合并“待处理”的 pending（环形）与历史的 baseQueue（线性）</span>
  <span class="hljs-keyword">const</span> pending = queue.<span class="hljs-property">pending</span>;
  <span class="hljs-keyword">let</span> first = <span class="hljs-title function_">mergeQueuesLinear</span>(hook.<span class="hljs-property">baseQueue</span>, pending);

  <span class="hljs-comment">// 清空 pending（已并入）</span>
  queue.<span class="hljs-property">pending</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// 如果没有任何更新，直接复用上次的 memoizedState</span>
  <span class="hljs-keyword">if</span> (!first) {
    <span class="hljs-keyword">return</span> hook.<span class="hljs-property">memoizedState</span>;
  }

  <span class="hljs-comment">// 2) 回放更新链</span>
  <span class="hljs-keyword">let</span> newState = hook.<span class="hljs-property">baseState</span>;   <span class="hljs-comment">// 从 baseState 起算</span>
  <span class="hljs-keyword">let</span> newBaseState = newState;     <span class="hljs-comment">// 如果发生“跳过”，会更新它</span>
  <span class="hljs-keyword">let</span> newBaseQueueHead = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">let</span> newBaseQueueTail = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">let</span> u = first;
  <span class="hljs-keyword">while</span> (u) {
    <span class="hljs-comment">// 计算本次当前更新对象是否匹配当前更新优先级</span>
    <span class="hljs-keyword">const</span> shouldProcess = <span class="hljs-title function_">includesLane</span>(renderLane, u.<span class="hljs-property">lane</span>);

    <span class="hljs-keyword">if</span> (shouldProcess) {
      <span class="hljs-comment">// 满足本次优先级：真正“吃掉并计算”</span>
      newState = <span class="hljs-title function_">reducer</span>(newState, u.<span class="hljs-property">action</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 优先级不够：跳过，但要“克隆”到 newBaseQueue，未来保留</span>
      <span class="hljs-keyword">const</span> <span class="hljs-attr">clone</span>: <span class="hljs-title class_">Update</span>&lt;S&gt; = { <span class="hljs-attr">lane</span>: u.<span class="hljs-property">lane</span>, <span class="hljs-attr">action</span>: u.<span class="hljs-property">action</span>, <span class="hljs-attr">next</span>: <span class="hljs-literal">null</span> };

      <span class="hljs-keyword">if</span> (!newBaseQueueHead) {
        newBaseQueueHead = newBaseQueueTail = clone;
        <span class="hljs-comment">// 一旦有跳过，未来的回放“起点”必须更新为当前已算出的 newState</span>
        newBaseState = newState;
      } <span class="hljs-keyword">else</span> {
        newBaseQueueTail!.<span class="hljs-property">next</span> = clone;
        newBaseQueueTail = clone;
      }
    }
    <span class="hljs-comment">// 指向下一个update对象</span>
    u = u.<span class="hljs-property">next</span>;
  }

  <span class="hljs-comment">// 3) 写回 hook 各字段（这就是 useState 在本次渲染后的可见结果）</span>
  hook.<span class="hljs-property">memoizedState</span> = newState;           <span class="hljs-comment">// 本次渲染最终 state</span>
  hook.<span class="hljs-property">baseState</span> = newBaseState;           <span class="hljs-comment">// 未来回放起点（若无跳过，等于 newState）</span>
  hook.<span class="hljs-property">baseQueue</span> = newBaseQueueHead;       <span class="hljs-comment">// 未来要继续处理的“跳过更新”链</span>
  queue.<span class="hljs-property">lastRenderedState</span> = newState;      <span class="hljs-comment">// 记录用</span>

  <span class="hljs-keyword">return</span> newState;
}
</code></pre>
<h5 data-id="heading-26">useEffect</h5>
<h6 data-id="heading-27">函数组件首次渲染： mountEffect</h6>
<p>当组件挂载时，useEffect 的本体是 mountEffect 函数。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">mountEffect</span>(<span class="hljs-params">
  create, <span class="hljs-comment">// useEffect 第一个参数，副作用函数</span>
  deps <span class="hljs-comment">// useEffect 第二个参数，依赖项数组</span>
</span>) {
  <span class="hljs-comment">// mountEffect可简单理解为执行了mountEffectImpl函数</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">mountEffectImpl</span>(
    <span class="hljs-title class_">PassiveEffect</span> | <span class="hljs-title class_">PassiveStaticEffect</span>,
    <span class="hljs-title class_">HookPassive</span>,
    create,
    deps
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mountEffectImpl</span>(<span class="hljs-params">fiberFlags, hookFlags, create, deps</span>) {
  <span class="hljs-comment">// 创建并挂载hook对象</span>
  <span class="hljs-keyword">const</span> hook = <span class="hljs-title function_">mountWorkInProgressHook</span>();
  <span class="hljs-comment">// 获取依赖项数组</span>
  <span class="hljs-keyword">const</span> nextDeps = deps === <span class="hljs-literal">undefined</span> ? <span class="hljs-literal">null</span> : deps;
  currentlyRenderingFiber.<span class="hljs-property">flags</span> |= fiberFlags;
  <span class="hljs-comment">// 创建并挂载effect对象</span>
  hook.<span class="hljs-property">memoizedState</span> = <span class="hljs-title function_">pushEffect</span>(
    <span class="hljs-title class_">HookHasEffect</span> | hookFlags,
    create,
    <span class="hljs-literal">undefined</span>,
    nextDeps
  );
}
</code></pre>
<p>此函数先调用 mountWorkInProgressHook 创建了当前 hook 的 hook 对象。</p>
<p>然后将传入的副作用函数和依赖数组作为参数传递给 pushEffect 函数并调用。</p>
<p>pushEffect 的返回值是当前 useEffect 的 effect 对象，并将其挂载至 hook.memoizedState 上。（不同的 hook 的 memoizedState 记录着不同信息，useState 记录当前 state 的值，useEffect 记录当前的 effect 对象）。</p>
<p>至于 pushEffect 的具体作用，可以归纳为两点：</p>
<ol>
<li>创建 effect 对象（记录副作用函数和依赖数组等信息）</li>
<li>将当前 effect 对象作为链表节点，挂载到 workInProgress fiber 节点的 updateQueue 属性的链表上。（即当前 effect 对象既单独保存在 hook.memoizedState 上，又会与其他 useEffect 的 effect 对象以链表的形式存储的 fiber.updateQueue 上）</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pushEffect</span>(<span class="hljs-params">tag, create, destroy, deps</span>) {
  <span class="hljs-comment">// effect 副作用对象</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">effect</span>: <span class="hljs-title class_">Effect</span> = {
    tag, <span class="hljs-comment">// 标识 effect 类型与是否需要执行</span>
    create, <span class="hljs-comment">// 副作用函数</span>
    destroy, <span class="hljs-comment">// cleanup函数</span>
    deps, <span class="hljs-comment">// 依赖项数组</span>
    <span class="hljs-attr">next</span>: (<span class="hljs-attr">null</span>: any),
  };

  <span class="hljs-comment">// 获取当前workInProgress节点的updateQueue属性</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">componentUpdateQueue</span>: <span class="hljs-literal">null</span> | <span class="hljs-title class_">FunctionComponentUpdateQueue</span> =
    (currentlyRenderingFiber.<span class="hljs-property">updateQueue</span>: any);

  <span class="hljs-keyword">if</span> (componentUpdateQueue === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 当fiber的effect链表为空，则此effect是第一个effect，初始化fiber.updateQueue</span>
    componentUpdateQueue = <span class="hljs-title function_">createFunctionComponentUpdateQueue</span>();
    currentlyRenderingFiber.<span class="hljs-property">updateQueue</span> = (<span class="hljs-attr">componentUpdateQueue</span>: any);
    componentUpdateQueue.<span class="hljs-property">lastEffect</span> = effect.<span class="hljs-property">next</span> = effect;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 如前面已有effect，则作为链表节点插入fiber.updateQueue中</span>
    <span class="hljs-keyword">const</span> lastEffect = componentUpdateQueue.<span class="hljs-property">lastEffect</span>;
    <span class="hljs-keyword">if</span> (lastEffect === <span class="hljs-literal">null</span>) {
      componentUpdateQueue.<span class="hljs-property">lastEffect</span> = effect.<span class="hljs-property">next</span> = effect;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">const</span> firstEffect = lastEffect.<span class="hljs-property">next</span>;
      lastEffect.<span class="hljs-property">next</span> = effect;
      effect.<span class="hljs-property">next</span> = firstEffect;
      componentUpdateQueue.<span class="hljs-property">lastEffect</span> = effect;
    }
  }
  <span class="hljs-keyword">return</span> effect;
}
</code></pre>
<p>需要注意的是 fiber.updateQueue 中，也是以环形链表的方式存储，并且其 lastEffect 属性指向最后一个 effect 对象。<br/>
假如有三个effect对象依次加入，则它们的储存结构如下所示:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbce0d38fc04414db38368a5c17b3c67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTFJI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764639163&amp;x-signature=vKp%2BTcwwEjl8WsLVj4kcnd62lJc%3D" alt="image.png" loading="lazy"/></p>
<h6 data-id="heading-28">函数组件更新：updateEffect</h6>
<p>在组件更新重新渲染时，useEffect 的“本体”是 updateEffect 函数。</p>
<p>updateEffect 的逻辑是根据判断依赖项数组中的依赖项是否更新：</p>
<ul>
<li>如果没有更新则代表当前副作用无需执行，调用 pushEffect 函数将原 effect 对象挂载到 fiber.updateQueue 链表上并赋值给 hook.memoizedState。</li>
<li>如果依赖项发生了更新，则需要更新 effect 对象（主要更新 effect.tag 属性，将其标记为当前副作用需要执行），然后调用 pushEffect 函数挂载到 fiber.updateQueue 链表，并且更新 hook.memoizedState 属性。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateEffect</span>(<span class="hljs-params">
  create, <span class="hljs-comment">// 副作用函数</span>
  deps <span class="hljs-comment">// 依赖项数组</span>
</span>) {
  <span class="hljs-comment">// updateEffect 只调用了updateEffectImpl函数</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateEffectImpl</span>(<span class="hljs-title class_">PassiveEffect</span>, <span class="hljs-title class_">HookPassive</span>, create, deps);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateEffectImpl</span>(<span class="hljs-params">fiberFlags, hookFlags, create, deps</span>) {
  <span class="hljs-comment">// 获取当前hook的hook对象。</span>
  <span class="hljs-keyword">const</span> hook = <span class="hljs-title function_">updateWorkInProgressHook</span>();
  <span class="hljs-keyword">const</span> nextDeps = deps === <span class="hljs-literal">undefined</span> ? <span class="hljs-literal">null</span> : deps;
  <span class="hljs-keyword">let</span> destroy = <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">if</span> (currentHook !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> prevEffect = currentHook.<span class="hljs-property">memoizedState</span>;
    destroy = prevEffect.<span class="hljs-property">destroy</span>;
    <span class="hljs-keyword">if</span> (nextDeps !== <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 依赖项不为空，比较依赖项是否改变</span>
      <span class="hljs-keyword">const</span> prevDeps = prevEffect.<span class="hljs-property">deps</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">areHookInputsEqual</span>(nextDeps, prevDeps)) {
        <span class="hljs-comment">// 依赖项没有发生改变，创建原effect对象副本</span>
        hook.<span class="hljs-property">memoizedState</span> = <span class="hljs-title function_">pushEffect</span>(hookFlags, create, destroy, nextDeps);
        <span class="hljs-keyword">return</span>;
      }
    }
  }

  currentlyRenderingFiber.<span class="hljs-property">flags</span> |= fiberFlags;
  <span class="hljs-comment">// 依赖项发生改变，标记effect.tag为需要执行副作用</span>
  hook.<span class="hljs-property">memoizedState</span> = <span class="hljs-title function_">pushEffect</span>(
    <span class="hljs-title class_">HookHasEffect</span> | hookFlags, <span class="hljs-comment">// effect.tag参数</span>
    create,
    destroy,
    nextDeps
  );
}
</code></pre>
<p>其实 mountEffect 和 updateEffect 的执行时间在 React 的 render 阶段。它们的目的在于创建、更新 effect 对象，并将其挂载到 hook.memoizedState 和 fiber.updateQueue 链表上。而不会直接执行执行副作用函数和 cleanup 函数。<br/>
在 commit 阶段，React 会遍历 fiber.updateQueue 链表，根据每个 effect 的 tag 属性判断是否需要执行清理函数和副作用函数。从而完成整个 useEffect 的执行流程。</p>
<h2 data-id="heading-29">总结</h2>
<p>本文主要围绕 Hooks 梳理了如下几点的知识：</p>
<p>因为类组件的使用不便及功能缺失，React 团队希望推出一种新特性与无状态函数组件配合使用，以达到在不使用类组件的情况下也能编写 React 应用的目的，于是 Hooks 便应运而生。</p>
<p>Hooks 本质是普通 JS 函数，在函数组件执行过程中被调用，而在 React 内部逻辑中，这些 Hooks 会以 hook 对象的形式形成一条单向链表，挂载到对应组件的 fiber 节点的 memoizedState 属性上。</p>
<p>而每种类型的 Hooks 所对应的 hook 对象，会有不同的属性，或相同属性会有不同的用途。</p>
<p>在组件初次渲染和更新时，每个 hook 会执行不同的“本体”，一般命名为 mountXXX 和 updateXXX，而 React 会通过 ReactCurrentDispatcher.current 指向当前所需的“hooks 本体集合”，从中取出所需的“本体函数”。</p>
<p>然后我们以 useState 和 useEffect 为例子，探讨了 Hooks 在组件首次渲染时和更新时的表现。梳理了:</p>
<ul>
<li>Hooks 必须要在函数组件顶部使用而不能在条件语句等语句中使用的原因是，hooks 会以链表的方式存储在 fiber.memoizedState 上，每次函数组件的执行，都会拿着 Hooks 链条与 Hooks 一一匹配，如果 Hooks 嵌套在其他语句中使用，则可能出现匹配错乱的问题。</li>
<li>hook 对象分别由 mountWorkInProgressHook 和 updateWorkInProgressHook 来创建及获取。</li>
<li>函数组件状态管理和副作用管理的逻辑。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 19 高薪技术从入门到进阶 - 实战课程- 慕课网]]></title>    <link>https://juejin.cn/post/7576155790165246003</link>    <guid>https://juejin.cn/post/7576155790165246003</guid>    <pubDate>2025-11-25T01:29:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576155790165246003" data-draft-id="7576197876717076518" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 19 高薪技术从入门到进阶 - 实战课程- 慕课网"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-25T01:29:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户105293826602"/> <meta itemprop="url" content="https://juejin.cn/user/1646390820995722"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 19 高薪技术从入门到进阶 - 实战课程- 慕课网
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1646390820995722/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户105293826602
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T01:29:22.000Z" title="Tue Nov 25 2025 01:29:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>React 19 高薪技术从入门到进阶 - 实战课程- 慕课网---youkeit.xyz/16048/</p>
<h2 data-id="heading-0">技术解码：React 19 Compiler 如何自动优化性能？高清同步训练营从入门讲透</h2>
<p>在 React 19 的生态中，<strong>Compiler（编译器）</strong>  是颠覆性能优化的核心武器。它通过静态分析代码结构，自动插入记忆化（Memoization）逻辑，彻底解放开发者从手动使用 <code>useMemo</code>、<code>useCallback</code> 和 <code>React.memo</code> 的繁琐工作。本文将结合高清同步训练营的实战案例，从原理到代码，拆解 Compiler 如何实现“零手动优化”的性能飞跃。</p>
<hr/>
<h3 data-id="heading-1">一、性能痛点：React 的“渲染地狱”</h3>
<p>在 React 18 及之前版本中，开发者需手动优化组件渲染性能，常见场景包括：</p>
<ol>
<li><strong>列表渲染</strong>：未优化的列表组件会因父组件状态更新而全量重渲染。</li>
<li><strong>复杂计算</strong>：高频调用的计算函数（如过滤、排序）需手动缓存结果。</li>
<li><strong>函数与对象</strong>：内联函数和对象每次渲染都会重新创建，触发子组件不必要的更新。</li>
</ol>
<p><strong>传统优化代码示例</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">jsx
// 需手动记忆化的列表组件
const <span class="hljs-attr">ExpensiveList</span> = React.memo(({ items, filterText }) =&gt; {
  const <span class="hljs-attr">filteredItems</span> = useMemo(() =&gt; 
    items.filter(<span class="hljs-attr">item</span> =&gt; item.name.includes(filterText)), 
  <span class="hljs-section">[items, filterText]</span>
  )<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">handleClick</span> = useCallback((id) =&gt; {
    console.log(`Clicked ${id}`)<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  return (
    &lt;ul&gt;
      {filteredItems.map(<span class="hljs-attr">item</span> =&gt; (
        &lt;ListItem 
          <span class="hljs-attr">key</span>={item.id} 
          <span class="hljs-attr">item</span>={item} 
          <span class="hljs-attr">onClick</span>={handleClick} 
        /&gt;
      ))}
    &lt;/ul&gt;
  )<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">二、React 19 Compiler：自动优化的黑科技</h3>
<p>Compiler 的核心原理是通过<strong>静态分析（Static Analysis）</strong>  和<strong>代码转换（Code Transformation）</strong> ，在构建阶段自动插入优化逻辑。其工作流程分为三步：</p>
<h4 data-id="heading-3">1. 抽象语法树（AST）解析</h4>
<p>Compiler 将 JSX 和 JavaScript 代码转换为 AST，深度遍历节点以识别：</p>
<ul>
<li><strong>变量声明</strong>：区分稳定值（如 <code>const</code> 常量）和动态值（如 <code>state</code>）。</li>
<li><strong>控制流</strong>：分析条件语句、循环对渲染的影响。</li>
<li><strong>JSX 结构</strong>：追踪组件嵌套关系和 props 传递路径。</li>
</ul>
<h4 data-id="heading-4">2. 依赖图构建</h4>
<p>基于 AST 分析，Compiler 构建细粒度依赖图（Dependency Graph），标记哪些计算或渲染节点依赖于动态值。例如：</p>
<pre><code class="hljs language-javascript" lang="javascript">jsx
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params">{ items, filterText }</span>) {
  <span class="hljs-comment">// 依赖图：filterText → filteredItems → visibleItems → ListItem</span>
  <span class="hljs-keyword">const</span> filteredItems = items.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(filterText));
  <span class="hljs-keyword">const</span> visibleItems = filteredItems.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{visibleItems.map(item =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">ListItem</span> <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span> /&gt;</span>)}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-5">3. 自动记忆化插入</h4>
<p>Compiler 根据依赖图，自动为高成本计算和子组件 props 插入 <code>useMemo</code> 或 <code>React.memo</code>。上述代码经 Compiler 转换后等效于：</p>
<pre><code class="hljs language-ini" lang="ini">jsx
function _compiled_MyComponent({ items, filterText }) {
  const $<span class="hljs-attr">memoCache</span> = useMemoCache(<span class="hljs-number">2</span>)<span class="hljs-comment">; // 编译器生成的缓存池</span>
  
  // 自动记忆化过滤逻辑
  let $filteredItems<span class="hljs-comment">;</span>
  if ($memoCache<span class="hljs-section">[0]</span>?.items !== items || $memoCache<span class="hljs-section">[0]</span>?.filterText !== filterText) {
    $<span class="hljs-attr">filteredItems</span> = items.filter(item =&gt; item.name.includes(filterText))<span class="hljs-comment">;</span>
    $memoCache<span class="hljs-section">[0]</span> = { items, filterText, $filteredItems }<span class="hljs-comment">;</span>
  } else {
    $<span class="hljs-attr">filteredItems</span> = <span class="hljs-variable">$memoCache</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">$filteredItems</span><span class="hljs-comment">;</span>
  }

  // 自动记忆化切片逻辑
  let $visibleItems<span class="hljs-comment">;</span>
  if ($memoCache<span class="hljs-section">[1]</span>?.$filteredItems !== $filteredItems) {
    $<span class="hljs-attr">visibleItems</span> = <span class="hljs-variable">$filteredItems</span>.slice(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>)<span class="hljs-comment">;</span>
    $memoCache<span class="hljs-section">[1]</span> = { $filteredItems, $visibleItems }<span class="hljs-comment">;</span>
  } else {
    $<span class="hljs-attr">visibleItems</span> = <span class="hljs-variable">$memoCache</span>[<span class="hljs-number">1</span>].<span class="hljs-variable">$visibleItems</span><span class="hljs-comment">;</span>
  }

  // 自动记忆化子组件
  const <span class="hljs-attr">MemoizedListItem</span> = React.memo(({ item }) =&gt; &lt;ListItem item={item} /&gt;)<span class="hljs-comment">;</span>
  
  return (
    &lt;ul&gt;{$visibleItems.map(<span class="hljs-attr">item</span> =&gt; &lt;MemoizedListItem key={item.id} item={item} /&gt;)}&lt;/ul&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-6">三、实战案例：从手动优化到 Compiler 驱动</h3>
<h4 data-id="heading-7">案例1：动态列表渲染优化</h4>
<p><strong>场景</strong>：渲染 10,000 条数据的列表，支持实时搜索过滤。</p>
<h5 data-id="heading-8">传统方案（React 18）：</h5>
<pre><code class="hljs language-javascript" lang="javascript">jsx
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ManualOptimizedList</span>(<span class="hljs-params">{ data, searchTerm }</span>) {
  <span class="hljs-keyword">const</span> filteredData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> 
    data.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(searchTerm)), 
  [data, searchTerm]
  );

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      {filteredData.map(item =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">OptimizedListItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span> <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span> /&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">OptimizedListItem</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ item }</span>) =&gt;</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
));
</code></pre>
<h5 data-id="heading-9">Compiler 方案（React 19）：</h5>
<pre><code class="hljs language-javascript" lang="javascript">jsx
<span class="hljs-keyword">function</span> <span class="hljs-title function_">AutoOptimizedList</span>(<span class="hljs-params">{ data, searchTerm }</span>) {
  <span class="hljs-comment">// 编译器自动优化过滤逻辑和子组件</span>
  <span class="hljs-keyword">const</span> filteredData = data.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(searchTerm));
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      {filteredData.map(item =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span> // 编译器自动包裹 React.memo
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>性能对比</strong>：</p>
<ul>
<li><strong>首次渲染</strong>：Compiler 方案提速 15%（减少记忆化包装开销）。</li>
<li><strong>更新渲染</strong>：Compiler 方案提速 40%（精准跳过无关节点计算）。</li>
<li><strong>内存占用</strong>：减少 20%（避免冗余缓存）。</li>
</ul>
<h4 data-id="heading-10">案例2：复杂表单处理</h4>
<p><strong>场景</strong>：多步骤表单，每步依赖前序数据计算。</p>
<h5 data-id="heading-11">传统方案（React 18）：</h5>
<pre><code class="hljs language-ini" lang="ini">jsx
function ComplexForm() {
  const <span class="hljs-section">[step, setStep]</span> = useState(1)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[formData, setFormData]</span> = useState({})<span class="hljs-comment">;</span>

  // 手动记忆化计算逻辑
  const <span class="hljs-attr">derivedData</span> = useMemo(() =&gt; {
    if (<span class="hljs-attr">step</span> === <span class="hljs-number">1</span>) return { summary: <span class="hljs-string">"Step 1"</span> }<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">step</span> === <span class="hljs-number">2</span>) return { summary: `Step <span class="hljs-number">2</span>: <span class="hljs-variable">${formData.input}</span>` }<span class="hljs-comment">;</span>
    return {}<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[step, formData]</span>)<span class="hljs-comment">;</span>

  return (
    &lt;div&gt;
      &lt;p&gt;{derivedData.summary}&lt;/p&gt;
      {/* ...其他表单字段 */}
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h5 data-id="heading-12">Compiler 方案（React 19）：</h5>
<pre><code class="hljs language-css" lang="css">jsx
function AutoOptimizedForm() {
  const <span class="hljs-selector-attr">[step, setStep]</span> = useState(<span class="hljs-number">1</span>);
  const <span class="hljs-selector-attr">[formData, setFormData]</span> = useState({});

  // 编译器自动记忆化计算逻辑
  const derivedData = step === <span class="hljs-number">1</span> 
    ? { <span class="hljs-selector-tag">summary</span>: <span class="hljs-string">"Step 1"</span> } 
    : step === <span class="hljs-number">2</span> 
      ? { <span class="hljs-selector-tag">summary</span>: `Step <span class="hljs-number">2</span>: ${formData<span class="hljs-selector-class">.input</span>}` } 
      : {};

  return (
    &lt;<span class="hljs-selector-tag">div</span>&gt;
      &lt;<span class="hljs-selector-tag">p</span>&gt;{derivedData<span class="hljs-selector-class">.summary</span>}&lt;/<span class="hljs-selector-tag">p</span>&gt;
      {<span class="hljs-comment">/* ...其他表单字段 */</span>}
    &lt;/<span class="hljs-selector-tag">div</span>&gt;
  );
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>代码简洁性</strong>：减少 50% 的 <code>useMemo</code> 代码。</li>
<li><strong>维护性</strong>：无需手动管理依赖数组。</li>
<li><strong>安全性</strong>：编译器静态分析避免遗漏依赖。</li>
</ul>
<hr/>
<h3 data-id="heading-13">四、高清同步训练营：从入门到精通</h3>
<h4 data-id="heading-14">1. 环境配置</h4>
<ul>
<li>
<p><strong>安装 Compiler</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">bash
npm install <span class="hljs-symbol">react@</span><span class="hljs-number">19</span> react-<span class="hljs-symbol">compiler@</span>latest
</code></pre>
</li>
<li>
<p><strong>Vite 集成</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">js
<span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> reactCompiler <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-react-compiler'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">reactCompiler</span>()],
};
</code></pre>
</li>
<li>
<p><strong>ESLint 规则</strong>：</p>
<pre><code class="hljs language-java" lang="java">js
<span class="hljs-comment">// .eslintrc.js</span>
<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  plugins: [<span class="hljs-string">'react-compiler'</span>],
  rules: {
    <span class="hljs-string">'react-compiler/no-manual-memoization'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-comment">// 禁止手动使用 useMemo</span>
  },
};
</code></pre>
</li>
</ul>
<h4 data-id="heading-15">2. 调试技巧</h4>
<ul>
<li>
<p><strong>开启调试模式</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">js
// 在开发环境中查看编译器优化日志
if (import.meta.env.DEV) {
  <span class="hljs-attr">window.__REACT_COMPILER_DEBUG__</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
}
</code></pre>
</li>
<li>
<p><strong>性能监控</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">jsx
<span class="hljs-keyword">import</span> { usePerformance } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-compiler'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { renderCount, cacheHits } = <span class="hljs-title function_">usePerformance</span>();
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Render Count: {renderCount}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Cache Hits: {cacheHits}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-16">3. 迁移指南</h4>
<ul>
<li>
<p><strong>渐进式采用</strong>：</p>
<ol>
<li>先在非关键路径组件中启用 Compiler。</li>
<li>使用 <code>/* @react-compiler ignore */</code> 注释跳过特定组件的优化。</li>
<li>逐步替换现有 <code>useMemo</code> 和 <code>React.memo</code>。</li>
</ol>
</li>
<li>
<p><strong>兼容性注意</strong>：</p>
<ul>
<li><strong>Class 组件</strong>：需手动添加 <code>UNSAFE_</code> 前缀的遗留方法。</li>
<li><strong>动态 Props</strong>：避免在渲染中动态生成对象（如 <code>style={{ color: 'red' }}</code>），改用稳定引用。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-17">五、未来展望：Compiler 的进化方向</h3>
<ol>
<li><strong>更智能的缓存策略</strong>：基于使用频率动态调整缓存大小。</li>
<li><strong>跨组件缓存共享</strong>：全局缓存高频计算结果（如国际化翻译文本）。</li>
<li><strong>与 Server Components 深度集成</strong>：自动优化服务端渲染逻辑。</li>
</ol>
<p>React 19 Compiler 的出现，标志着前端开发从“手动优化时代”迈向“智能优化时代”。通过高清同步训练营的实战训练，开发者可以快速掌握这一利器，构建出更高效、更易维护的 React 应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain、LangGraph、LangSmith这些AI开发框架有什么区别？一篇文章解释清楚]]></title>    <link>https://juejin.cn/post/7576130618906198052</link>    <guid>https://juejin.cn/post/7576130618906198052</guid>    <pubDate>2025-11-25T02:33:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576130618906198052" data-draft-id="7576181242582302783" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain、LangGraph、LangSmith这些AI开发框架有什么区别？一篇文章解释清楚"/> <meta itemprop="keywords" content="LangChain,LLM,Agent"/> <meta itemprop="datePublished" content="2025-11-25T02:33:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain、LangGraph、LangSmith这些AI开发框架有什么区别？一篇文章解释清楚
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T02:33:05.000Z" title="Tue Nov 25 2025 02:33:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acbb6e231c454d9e8ac5ed4463523723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764642785&amp;x-signature=64Bt%2FuXkUB%2FpqYJEr9Q7boAFxOk%3D" alt="" loading="lazy"/></p>
<p>在AI应用开发的浪潮中，一个问题始终困扰着开发者：<strong>面对众多的AI开发框架，如何选择最适合的技术栈？</strong></p>
<p>随着AI技术的快速发展和企业数字化转型的深入推进，一个关键趋势正在显现：<strong>LangChain生态系统正在从单一框架演进为完整的AI应用开发平台，这将彻底改变我们构建智能应用的方式。</strong></p>
<p>LangChain不再只是一个简单的框架，而是发展成为包含LangChain（开发框架）、LangGraph（状态管理）、LangSmith（监控部署）的完整生态系统。每个组件都有其独特的价值和适用场景，形成了一个从开发到部署的完整解决方案。</p>
<p>这种生态化的发展模式代表了AI应用开发从手工作坊向工业化生产的根本性转变，为开发者提供了标准化的工具链和最佳实践。</p>
<p>让我们一起深入这个AI开发框架的"三国演义"！希望对你有所启发。</p>
<hr/>
<h2 data-id="heading-0">PART 01 LangChain生态的战略定位</h2>
<h3 data-id="heading-1">AI应用开发的核心痛点</h3>
<p>要理解LangChain生态系统的价值，我们首先需要认清AI应用开发面临的根本挑战。</p>
<p>传统AI开发面临四大核心困境。复杂性挑战表现在大语言模型API调用的复杂性、多个AI服务的集成和编排难度、复杂业务逻辑的实现困难以及错误处理和异常管理的复杂性。</p>
<p>可维护性问题体现在代码结构混乱难以维护、业务逻辑与技术实现耦合、缺乏标准化的开发模式以及调试和优化困难。</p>
<p>可扩展性限制包括单体架构难以扩展、状态管理复杂、并发处理能力有限以及性能监控和优化困难。</p>
<p>生产部署挑战涵盖缺乏有效的监控工具、版本管理和回滚困难、性能分析和优化复杂以及成本控制和资源管理问题。</p>
<p>这些问题在实际项目中的影响是巨大的。很多AI项目在概念验证阶段表现良好，但在规模化部署时却面临重重困难，导致大量AI项目无法成功落地或无法持续运营。</p>
<h3 data-id="heading-2">LangChain生态：分层解决方案</h3>
<p>LangChain生态系统通过分层架构的方式，系统性地解决了传统AI开发的核心问题。这个三层架构设计体现了明确的职责分工和协同机制：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a422419851144144852fac8737256e5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764642785&amp;x-signature=eo6bFlt7Va7apE4SQvOHmHVTI7Q%3D" alt="" loading="lazy"/></p>
<p>开发层（LangChain）专注于简化AI应用的开发过程，提供标准化的组件和模式，降低技术门槛和学习成本，支持快速原型和迭代。</p>
<p>编排层（LangGraph）负责处理复杂的状态管理，支持多智能体协作，提供可视化的流程设计，实现高级的AI工作流。</p>
<p>运营层（LangSmith）提供生产级的监控和调试，支持性能分析和优化，实现版本管理和A/B测试，提供成本分析和资源优化。</p>
<h3 data-id="heading-3">应用场景：从简单到复杂的全覆盖</h3>
<p>LangChain生态系统的分层设计使其能够覆盖从简单到复杂的各种AI应用场景。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eefce2b7996d447780e72d8308d2f4d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764642785&amp;x-signature=TAnWoqcc3IdCkprsAwdK5a326Hk%3D" alt="" loading="lazy"/></p>
<p>简单AI应用适合使用LangChain，包括基础的问答系统、文档摘要和分析、简单的内容生成以及单步骤的AI任务。</p>
<p>复杂AI应用需要引入LangGraph，涵盖多智能体协作系统、复杂的决策支持系统、需要状态管理的对话系统以及多步骤的AI工作流。</p>
<p>企业级AI应用则需要完整的生态系统支持，包括生产环境的AI服务、需要监控和优化的系统、关键业务的AI应用以及大规模部署的AI平台。</p>
<p>这种分层的方法让开发者可以根据项目需求选择合适的工具组合，既避免了过度工程化，也确保了系统的可扩展性。</p>
<hr/>
<h2 data-id="heading-4">PART 02 三大框架的技术特性对比</h2>
<h3 data-id="heading-5">LangChain：AI应用开发的基石</h3>
<p>LangChain作为整个生态系统的基础，采用了链式编程模型和组件化设计，为AI应用开发提供了直观易用的开发框架。</p>
<p>其核心架构特点体现在链式编程模型上，通过简洁的API设计实现复杂功能的组合：</p>
<pre><code class="hljs language-ini" lang="ini">ounter(lineounter(lineounter(lineounter(lineounter(line
<span class="hljs-comment"># 典型的LangChain应用结构</span>
<span class="hljs-attr">prompt</span> = PromptTemplate(...)
<span class="hljs-attr">llm</span> = OpenAI(...)
<span class="hljs-attr">chain</span> = LLMChain(llm=llm, prompt=prompt)
<span class="hljs-attr">result</span> = chain.run(input_data)
</code></pre>
<p>组件化设计是LangChain的另一大特色，包括模板化的提示词管理（Prompts）、大语言模型的统一接口（LLMs）、组件的链式组合（Chains）、对话历史和上下文管理（Memory）以及智能决策和工具调用（Agents）。</p>
<p>LangChain的核心优势在于简单直观的开发体验，链式调用模式易于理解，拥有丰富的预构建组件、详细的文档和教程以及活跃的社区支持。</p>
<p>快速开发能力体现在快速原型构建、标准化的开发模式、丰富的集成选项和灵活的自定义能力。</p>
<p>广泛兼容性表现为支持多种LLM提供商、集成各种数据源、支持多种输出格式和跨平台兼容性。</p>
<p>LangChain最适合简单的AI应用开发、快速原型验证、学习和教育项目以及单一用户的应用。但其局限性也很明显，包括状态管理能力有限、复杂工作流支持不足、并发处理能力较弱以及生产环境监控不够。</p>
<h3 data-id="heading-6">LangGraph：状态管理的革命</h3>
<p>LangGraph通过引入图状态架构，彻底改变了AI应用的执行模式和状态管理方式，代表了从线性处理向图状态处理的重大技术升级。</p>
<p>传统链式架构与图状态架构的对比清晰地展现了这种革新：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4070db538b5b478196388c13c4f54142~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764642785&amp;x-signature=H%2FFbMTtIpLwppuq5yQH8UkDaAQw%3D" alt="" loading="lazy"/></p>
<p>LangGraph的技术特点体现在三个核心方面。</p>
<p>状态管理方面实现了全局状态共享、状态版本控制、状态持久化以及状态回滚和恢复。</p>
<p>节点和边的设计提供了灵活的节点定义、条件边和动态路由、并行执行支持以及循环和递归处理能力。</p>
<p>可视化功能包括图形化的流程设计、实时执行状态监控、调试和错误追踪以及性能分析和优化。</p>
<p>LangGraph在复杂AI应用中展现出显著优势，特别适合多步骤的推理过程、需要回溯和重试的场景、多智能体协作系统以及复杂的决策支持流程。</p>
<p>在状态敏感应用中，LangGraph能够很好地处理长时间的对话系统、需要上下文保持的应用、多用户状态管理以及实时协作应用。</p>
<h3 data-id="heading-7">LangSmith：生产环境的守护者</h3>
<p>LangSmith作为生态系统的运营层，专注于为AI应用提供企业级的监控、调试和优化能力，确保AI应用能够在生产环境中稳定可靠地运行。</p>
<p>其核心功能围绕监控与优化展开。实时监控能力涵盖应用性能监控、用户行为分析、错误率和延迟统计以及资源使用情况跟踪。</p>
<p>调试工具提供请求链路追踪、详细的日志分析、性能瓶颈识别和错误根因分析。</p>
<p>优化建议功能能够提供性能优化建议、成本优化分析、用户体验改进和系统架构建议。</p>
<p>LangSmith的企业级特性体现在三个关键领域。版本管理方面支持模型版本控制、配置版本管理、灰度发布支持以及回滚和恢复机制。</p>
<p>A/B测试功能包括多版本对比测试、用户分群实验、效果评估和分析以及自动化决策支持。</p>
<p>安全合规方面提供数据安全保护、访问权限控制、审计日志记录和合规性检查。</p>
<p>这些功能使得LangSmith成为AI应用从开发环境向生产环境迁移的关键桥梁，为企业级AI应用的稳定运营提供了全面保障。</p>
<h3 data-id="heading-8">三大框架的协同价值</h3>
<p>三大框架的真正价值在于其协同合作，形成了覆盖完整开发生命周期的工具链：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e80dbc77566402fb7d86035c7ec1ee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764642785&amp;x-signature=NfLsQaDvTihUxebnT3PvNWaw8t8%3D" alt="" loading="lazy"/></p>
<p>开发阶段使用LangChain进行快速原型构建、功能验证和测试、基础架构搭建以及初步性能评估。</p>
<p>优化阶段引入LangGraph实现复杂逻辑、状态管理优化、性能调优和可扩展性改进。</p>
<p>生产阶段通过LangSmith完成生产环境部署、实时监控和告警、持续优化改进以及版本管理和更新。</p>
<p>这种分工协作的模式让每个工具都能在其最擅长的领域发挥最大价值，同时确保了整个开发流程的连贯性和高效性。</p>
<hr/>
<h2 data-id="heading-9">PART 03 状态与数据的智能管理</h2>
<h3 data-id="heading-10">LangChain的数据处理模式</h3>
<p>在传统的LangChain应用中，数据处理相对简单但也有明显局限。</p>
<p>其数据流模式采用线性处理方式：输入数据经过预处理、LLM处理、后处理最终输出结果。这种线性流程虽然简单直观，但存在明显的架构局限。</p>
<p>内存管理方面，LangChain采用简单的对话历史存储、基于窗口的内存管理方式，上下文保持能力有限，缺乏复杂的状态管理机制。</p>
<p>这种简化的内存管理在处理复杂交互场景时暴露出明显不足。</p>
<p>主要挑战集中在两个方面。状态丢失问题表现为长对话中的上下文丢失、多轮交互的状态不一致、并发用户的状态混淆以及错误恢复时的状态重置。</p>
<p>数据一致性问题涉及多个组件间的数据同步、异步处理的数据一致性、错误处理时的数据完整性以及版本更新时的数据迁移等复杂场景。</p>
<h3 data-id="heading-11">LangGraph的状态架构革新</h3>
<p>LangGraph通过引入图状态管理，彻底改变了数据的组织和处理方式。其状态管理架构采用全局状态存储模式，通过结构化的状态定义实现复杂数据的统一管理：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># LangGraph状态定义</span>
class GraphState(TypedDict):
<span class="hljs-section">user_input: str</span>
<span class="hljs-section">processed_data: dict</span>
<span class="hljs-section">conversation_history: list</span>
<span class="hljs-section">current_step: str</span>
<span class="hljs-section">metadata: dict</span>
</code></pre>
<p>状态更新机制通过智能状态合并、版本控制和一致性检查，确保状态变更的安全性和可靠性：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 状态更新函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">update_state</span>(<span class="hljs-params">state: GraphState, new_data: <span class="hljs-built_in">dict</span></span>) -&gt; GraphState:
<span class="hljs-comment"># 智能状态合并、版本控制、一致性检查</span>
<span class="hljs-keyword">return</span> updated_state
</code></pre>
<p>LangGraph的高级状态特性体现在三个核心方面。</p>
<p>状态持久化支持多种存储后端、自动状态快照、增量状态更新以及状态压缩和优化，确保状态数据的可靠存储和高效访问。</p>
<p>状态版本控制提供状态变更历史记录、支持状态回滚、分支状态管理以及状态合并和冲突解决，为复杂应用场景提供了强大的状态管理能力。</p>
<p>分布式状态实现跨节点状态共享、状态分片和路由、状态复制和同步以及故障恢复和容错，满足大规模分布式应用的需求。</p>
<h3 data-id="heading-12">数据流优化：从串行到并行</h3>
<p>LangGraph实现了从串行到并行的数据流优化，显著提升了数据处理效率和系统吞吐量。</p>
<p>并行节点执行是LangGraph的核心优势之一，通过异步处理机制同时执行多个数据处理任务：</p>
<pre><code class="hljs language-scss" lang="scss"># 并行数据处理
async def <span class="hljs-built_in">parallel_processing</span>(state):
tasks = [
<span class="hljs-built_in">process_text_data</span>(state),
<span class="hljs-built_in">process_image_data</span>(state),
<span class="hljs-built_in">process_metadata</span>(state)
]
results = await asyncio.<span class="hljs-built_in">gather</span>(*tasks)
return <span class="hljs-built_in">merge_results</span>(results)
</code></pre>
<p>智能数据路由机制包括基于内容的数据路由、负载均衡的数据分发、动态路由策略调整以及故障转移和重试机制，确保数据处理的高效性和可靠性。</p>
<p>性能优化策略涵盖多个层面。缓存机制采用多层缓存架构、智能缓存策略、缓存失效管理和分布式缓存同步，最大化数据访问效率。</p>
<p>数据预处理通过批量数据处理、预计算和预加载、数据压缩和优化以及异步数据准备，减少实时处理的计算开销。</p>
<h3 data-id="heading-13">LangSmith的数据监控</h3>
<p>LangSmith提供全面的数据监控和分析能力，为AI应用的持续优化提供数据支撑。</p>
<p>数据质量监控是LangSmith的核心功能之一。实时数据监控涵盖数据流量监控、数据质量检查、异常数据检测和性能指标统计，确保系统运行状态的实时可见。</p>
<p>数据血缘追踪功能提供数据来源追踪、处理过程记录、输出结果关联以及完整的数据链路分析，为问题排查和系统优化提供详细的数据支持。</p>
<p>数据分析和洞察功能帮助企业深入理解系统运行情况和用户行为模式。用户行为分析包括查询模式分析、用户偏好识别、使用习惯统计和满意度评估，为产品优化提供用户视角的数据洞察。</p>
<p>系统性能分析涵盖处理延迟分析、资源利用率统计、错误率和成功率以及成本效益分析，为系统优化和资源配置提供科学依据。</p>
<p>这种数据驱动的优化方式，让AI应用能够基于真实的运行数据持续改进和演进，实现从被动维护向主动优化的转变。</p>
<hr/>
<h2 data-id="heading-14">PART 04 企业级部署的最佳实践</h2>
<h3 data-id="heading-15">技术栈选择策略</h3>
<p>基于实际项目经验和技术特性分析，我们可以建立一个系统的技术选择框架来指导企业的技术决策。</p>
<p>项目复杂度评估是选择技术栈的关键依据。简单项目适合使用LangChain，其特征包括单一用户交互、简单的业务逻辑、有限的状态需求和快速原型验证需求，推荐技术栈为LangChain加OpenAI API加简单存储。</p>
<p>中等复杂项目需要引入LangGraph，特征包括多用户并发、复杂的业务流程、状态管理需求和较高的性能要求，推荐技术栈为LangChain加LangGraph加Redis或PostgreSQL加Docker。</p>
<p>企业级项目需要完整生态支持，特征包括大规模用户访问、关键业务应用、严格的性能要求和完整的监控需求，推荐技术栈为LangChain加LangGraph加LangSmith加Kubernetes加监控栈加CI/CD。</p>
<h3 data-id="heading-16">技术选型决策树</h3>
<p>基于技术特性分析和实践经验，我们可以建立一个系统化的决策框架来指导技术选型：</p>
<pre><code class="hljs">开始项目评估
│
是否需要复杂状态管理？
├─────┴─────┐
否           是
│           │
使用LangChain    是否需要生产监控？
├─────┴─────┐
否           是
│           │
LangChain+LangGraph  完整生态系统
</code></pre>
<p>详细的评估标准可以从三个维度进行量化分析。</p>
<p>项目规模评估：用户数量少于100使用LangChain，100-1000引入LangGraph，超过1000需要LangSmith；</p>
<p>请求量小于1000/天使用LangChain，1000-10000/天加入LangGraph，超过10000/天需要完整生态；</p>
<p>数据量小于1GB使用LangChain，1GB-10GB引入LangGraph，超过10GB需要LangSmith支持。</p>
<p>技术复杂度评估：简单状态管理使用LangChain，复杂状态管理需要LangGraph；</p>
<p>线性工作流使用LangChain，非线性工作流需要LangGraph；</p>
<p>基础监控需求使用LangChain，高级监控需求需要LangSmith。</p>
<hr/>
<h2 data-id="heading-17">PART 05 性能对比</h2>
<h3 data-id="heading-18">框架性能对比</h3>
<p>基于大量实际项目的测试数据和性能分析，我们可以从多个维度对比三个框架的性能表现。</p>
<p><strong>响应时间对比</strong></p>
<p>不同场景下的响应时间表现存在明显差异。简单查询场景中，LangChain平均响应时间为800ms-1.2s，LangGraph为1.2s-1.8s（包含状态管理开销），LangSmith监控开销小于50ms几乎无影响。</p>
<p>复杂查询场景中，LangChain平均响应时间为2-5s（链式处理），LangGraph为1.5-3s（并行处理优势），LangSmith提供详细的性能分析数据。</p>
<p><strong>并发处理能力对比</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70e8119aa4a24b73ae0fb51810f7c3fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764642785&amp;x-signature=VyeZ3lb43ujaWsOf2Rbrqb5FMOo%3D" alt="" loading="lazy"/></p>
<p>LangChain在并发处理方面存在明显限制，支持用户数少于50，内存使用呈线性增长，CPU利用率为20-40%，采用简单内存状态管理。</p>
<p>LangGraph展现出显著的并发优势，支持100-500并发用户，内存使用经过优化管理，CPU利用率达60-80%，采用分布式状态存储。</p>
<p>LangSmith作为监控层，开销极小，内存占用20-50MB，CPU开销小于5%。</p>
<hr/>
<h2 data-id="heading-19">结论</h2>
<p>通过对LangChain生态系统的全面分析，我们清晰地看到了这个技术平台的完整面貌：</p>
<p><strong>LangChain生态系统不仅仅是三个独立的工具，而是一个完整的AI应用开发平台，代表了AI应用开发从手工作坊向工业化生产的根本性转变。</strong></p>
<p>这种生态系统的深层价值在于：</p>
<ol>
<li><strong>专业化分工</strong>：每个工具专注于特定的问题域，发挥最大价值</li>
<li><strong>协同增效</strong>：三个工具的组合效果远大于单独使用的总和</li>
<li><strong>渐进演进</strong>：支持从简单到复杂的平滑升级路径</li>
<li><strong>生态完整</strong>：覆盖了AI应用开发的完整生命周期</li>
</ol>
<p><strong>技术的价值不在于其复杂程度，而在于其解决问题的效率和效果。</strong></p>
<p>对于开发者而言，关键不是掌握所有工具的细节，而是理解每个工具的价值定位，根据项目需求做出最合适的选择。</p>
<h2 data-id="heading-20">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 ECharts + ECharts-GL 生成 3D 环形图]]></title>    <link>https://juejin.cn/post/7576181242582024255</link>    <guid>https://juejin.cn/post/7576181242582024255</guid>    <pubDate>2025-11-25T01:42:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576181242582024255" data-draft-id="7568755613876027392" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 ECharts + ECharts-GL 生成 3D 环形图"/> <meta itemprop="keywords" content="前端,ECharts"/> <meta itemprop="datePublished" content="2025-11-25T01:42:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Danny_FD"/> <meta itemprop="url" content="https://juejin.cn/user/1788247743933225"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 ECharts + ECharts-GL 生成 3D 环形图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1788247743933225/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Danny_FD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T01:42:08.000Z" title="Tue Nov 25 2025 01:42:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文系统总结在项目中用 ECharts 与 ECharts-GL 手工生成 3D 环形图（Donut）的全过程：从原理、实现步骤、关键配置，到常见坑位与解决方案，以及可复用的代码片段与使用流程。</p>
<hr/>
<h2 data-id="heading-0">为什么选择 ECharts-GL 手工实现 3D</h2>
<ul>
<li>原生 ECharts 饼图是 2D；3D 需要借助 ECharts-GL 的 <code>series.surface</code> 与参数方程自定义曲面形状。</li>
<li>手工实现可精细控制：切片厚度、内外径比例、标签引导线、视角与后处理特效（高光、SSAO等）。</li>
<li>可与数据规模、性能要求做平衡：通过参数步进控制网格密度，避免过多面元导致性能瓶颈。</li>
</ul>
<p>适用场景：数据可视化展示、营销演示、报告图表对比；不适用场景：强交互且需要大量点击选择的复杂图表（ECharts-GL 事件交互相对有限）。</p>
<hr/>
<h2 data-id="heading-1">环境与依赖</h2>
<ul>
<li><code>echarts</code>：基础图表库</li>
<li><code>echarts-gl</code>：3D 能力与曲面支持</li>
<li>可选：<code>echarts-for-react</code>（在 React 项目中便捷渲染）</li>
</ul>
<p>安装示例：</p>
<pre><code class="hljs language-bash" lang="bash">yarn add echarts echarts-gl echarts-for-react
</code></pre>
<p>在 React 组件中引入：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">EChartsReact</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'echarts-for-react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'echarts-gl'</span>;
</code></pre>
<hr/>
<h2 data-id="heading-2">原理概述：参数方程生成“环形切片”</h2>
<p>3D 环形图的每个扇形切片本质上是一个通过参数方程描述的曲面。我们为每个数据点计算其在圆环上的起止比例（<code>startRatio</code> / <code>endRatio</code>），然后用参数方程将该角段“弯折”到环面上。</p>
<p>关键参数：</p>
<ul>
<li><code>k</code>：由内外径比换算得到的辅助参数，控制环的厚度（默认约 <code>1/3</code>）。</li>
<li><code>h</code>：切片高度（厚度），与数据值成比例，避免某项过大导致“超高”。</li>
<li><code>startRatio</code> / <code>endRatio</code>：每个扇形在圆周上的起止比例，来源于数据总和与各项值。</li>
</ul>
<p>我们在 <code>getParametricEquation</code> 中将 <code>(u, v)</code> 两个参数映射到三维空间 <code>(x, y, z)</code>，并控制边界（区间外使用边缘角度），从而形成饼图扇形段的立体曲面。</p>
<hr/>
<h2 data-id="heading-3">实现步骤（核心流程）</h2>
<ol>
<li>计算比例与厚度</li>
</ol>
<ul>
<li>累加数据得到 <code>sumValue</code>，为每个数据计算 <code>startRatio</code> / <code>endRatio</code>。</li>
<li>取数据最大值作为基准，按比例将值映射为高度 <code>h</code>：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">heightFromVal</span> = (<span class="hljs-params">v: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">if</span> (!maxValue || maxValue &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> minH;
  <span class="hljs-keyword">const</span> ratio = v / maxValue;
  <span class="hljs-keyword">return</span> minH + (maxH - minH) * ratio;
};
</code></pre>
<ol start="2">
<li>为每个数据构造 <code>series.surface</code></li>
</ol>
<ul>
<li><code>type: 'surface'</code>、<code>parametric: true</code>，设置 <code>parametricEquation</code> 为曲面方程。</li>
<li>将颜色与透明度通过 <code>itemStyle.color</code> / <code>itemStyle.opacity</code> 传入（与 3D 视觉保持一致）。</li>
</ul>
<ol start="3">
<li>标签与引导线（3D版本）</li>
</ol>
<ul>
<li>使用两条 <code>line3D</code> + 一个 <code>scatter3D</code>（文本）构成“引导线 + 标签”。</li>
<li>文本通过 <code>scatter3D.label.formatter</code> 输出 <code>{name}\n{value}元</code> 两行样式。</li>
<li><code>endPosArr</code> 的计算要考虑象限（通过中径角判断朝向），以避免文本与线段穿插扭曲：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> flag = (midRadianInFirstOrFourthQuadrant) ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;
<span class="hljs-keyword">const</span> endPosArr = [
  posX * <span class="hljs-number">1.8</span> + i * <span class="hljs-number">0.1</span> * flag + (flag &lt; <span class="hljs-number">0</span> ? -<span class="hljs-number">0.5</span> : <span class="hljs-number">0</span>),
  posY * <span class="hljs-number">1.8</span> + i * <span class="hljs-number">0.1</span> * flag + (flag &lt; <span class="hljs-number">0</span> ? -<span class="hljs-number">0.5</span> : <span class="hljs-number">0</span>),
  posZ * <span class="hljs-number">2</span>,
];
</code></pre>
<ol start="4">
<li>透明“支撑环”</li>
</ol>
<ul>
<li>额外添加一个透明 <code>surface</code>，用于近似实现高亮/鼠标交互的承载，避免直接与扇形交互造成干扰。</li>
</ul>
<ol start="5">
<li>场景配置</li>
</ol>
<ul>
<li><code>grid3D</code> 控制视角与后处理：开启 <code>postEffect.bloom</code>、<code>SSAO</code> 增强质感，同时合理设置 <code>viewControl</code> 的旋转/缩放灵敏度（大多数展示场景禁用交互）。</li>
</ul>
<hr/>
<h2 data-id="heading-4">完整示例（精简版）</h2>
<p>源自项目文件 <code>Pie3DChart.tsx</code>，保留核心逻辑并做少量注释：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">EChartsReact</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'echarts-for-react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'echarts-gl'</span>;

<span class="hljs-comment">// 支持通过 props 传入切片高度范围，默认 [8, 20]</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Pie3DChart</span> = (<span class="hljs-params">{ dataList, sliceHeightRange = [<span class="hljs-number">8</span>, <span class="hljs-number">20</span>] }</span>) =&gt; {
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParametricEquation</span>(<span class="hljs-params">startRatio, endRatio, isSelected, isHovered, k, h</span>) {
    <span class="hljs-keyword">const</span> midRatio = (startRatio + endRatio) / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> startRadian = startRatio * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> endRadian = endRatio * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> midRadian = midRatio * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;
    <span class="hljs-keyword">if</span> (startRatio === <span class="hljs-number">0</span> &amp;&amp; endRatio === <span class="hljs-number">1</span>) isSelected = <span class="hljs-literal">false</span>;
    k = <span class="hljs-keyword">typeof</span> k !== <span class="hljs-string">'undefined'</span> ? k : <span class="hljs-number">1</span> / <span class="hljs-number">3</span>;
    <span class="hljs-keyword">const</span> offsetX = isSelected ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(midRadian) * <span class="hljs-number">0.1</span> : <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> offsetY = isSelected ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(midRadian) * <span class="hljs-number">0.1</span> : <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> hoverRate = isHovered ? <span class="hljs-number">1.05</span> : <span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">u</span>: { <span class="hljs-attr">min</span>: -<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>, <span class="hljs-attr">max</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">3</span>, <span class="hljs-attr">step</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">32</span> },
      <span class="hljs-attr">v</span>: { <span class="hljs-attr">min</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">max</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>, <span class="hljs-attr">step</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">20</span> },
      <span class="hljs-title function_">x</span>(<span class="hljs-params">u, v</span>) {
        <span class="hljs-keyword">if</span> (u &lt; startRadian) <span class="hljs-keyword">return</span> offsetX + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(startRadian) * (<span class="hljs-number">1</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(v) * k) * hoverRate;
        <span class="hljs-keyword">if</span> (u &gt; endRadian) <span class="hljs-keyword">return</span> offsetX + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(endRadian) * (<span class="hljs-number">1</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(v) * k) * hoverRate;
        <span class="hljs-keyword">return</span> offsetX + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(u) * (<span class="hljs-number">1</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(v) * k) * hoverRate;
      },
      <span class="hljs-title function_">y</span>(<span class="hljs-params">u, v</span>) {
        <span class="hljs-keyword">if</span> (u &lt; startRadian) <span class="hljs-keyword">return</span> offsetY + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(startRadian) * (<span class="hljs-number">1</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(v) * k) * hoverRate;
        <span class="hljs-keyword">if</span> (u &gt; endRadian) <span class="hljs-keyword">return</span> offsetY + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(endRadian) * (<span class="hljs-number">1</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(v) * k) * hoverRate;
        <span class="hljs-keyword">return</span> offsetY + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(u) * (<span class="hljs-number">1</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(v) * k) * hoverRate;
      },
      <span class="hljs-title function_">z</span>(<span class="hljs-params">u, v</span>) {
        <span class="hljs-keyword">if</span> (u &lt; -<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">0.5</span>) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(u);
        <span class="hljs-keyword">if</span> (u &gt; <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2.5</span>) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(u) * h * <span class="hljs-number">0.1</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(v) &gt; <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> * h * <span class="hljs-number">0.1</span> : -<span class="hljs-number">1</span>;
      },
    };
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getPie3D</span>(<span class="hljs-params">pieData, internalDiameterRatio, heightRange</span>) {
    <span class="hljs-keyword">const</span> [minH, maxH] = heightRange || [<span class="hljs-number">8</span>, <span class="hljs-number">20</span>];
    <span class="hljs-keyword">let</span> series = [];
    <span class="hljs-keyword">let</span> sumValue = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> startValue = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> k = <span class="hljs-keyword">typeof</span> internalDiameterRatio !== <span class="hljs-string">'undefined'</span>
      ? (<span class="hljs-number">1</span> - internalDiameterRatio) / (<span class="hljs-number">1</span> + internalDiameterRatio)
      : <span class="hljs-number">1</span> / <span class="hljs-number">3</span>;

    <span class="hljs-keyword">const</span> maxValue = (pieData || []).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">m, d</span>) =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(m, d?.<span class="hljs-property">value</span> || <span class="hljs-number">0</span>), <span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">heightFromVal</span> = (<span class="hljs-params">v</span>) =&gt; (!maxValue ? minH : minH + (maxH - minH) * (v / maxValue));

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; pieData.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">const</span> { value = <span class="hljs-number">0</span>, name, itemStyle } = pieData[i] || {};
      sumValue += value;
      <span class="hljs-keyword">const</span> seriesItem = {
        <span class="hljs-attr">name</span>: <span class="hljs-keyword">typeof</span> name === <span class="hljs-string">'undefined'</span> ? <span class="hljs-string">`series<span class="hljs-subst">${i}</span>`</span> : name,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'surface'</span>, <span class="hljs-attr">parametric</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">wireframe</span>: { <span class="hljs-attr">show</span>: <span class="hljs-literal">false</span> }, <span class="hljs-attr">pieData</span>: pieData[i],
        <span class="hljs-attr">pieStatus</span>: { <span class="hljs-attr">selected</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">hovered</span>: <span class="hljs-literal">false</span>, k },
      };
      <span class="hljs-keyword">if</span> (itemStyle) seriesItem.<span class="hljs-property">itemStyle</span> = { <span class="hljs-attr">color</span>: itemStyle.<span class="hljs-property">color</span>, <span class="hljs-attr">opacity</span>: itemStyle.<span class="hljs-property">opacity</span> };
      series.<span class="hljs-title function_">push</span>(seriesItem);
    }

    <span class="hljs-keyword">const</span> linesSeries = [];
    <span class="hljs-keyword">let</span> endValue = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; series.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">const</span> { pieData } = series[i] || {};
      <span class="hljs-keyword">const</span> val = pieData?.<span class="hljs-property">value</span> || <span class="hljs-number">0</span>;
      endValue = startValue + val;
      series[i].<span class="hljs-property">pieData</span>.<span class="hljs-property">startRatio</span> = startValue / sumValue;
      series[i].<span class="hljs-property">pieData</span>.<span class="hljs-property">endRatio</span> = endValue / sumValue;
      series[i].<span class="hljs-property">parametricEquation</span> = <span class="hljs-title function_">getParametricEquation</span>(
        series[i].<span class="hljs-property">pieData</span>.<span class="hljs-property">startRatio</span>,
        series[i].<span class="hljs-property">pieData</span>.<span class="hljs-property">endRatio</span>,
        <span class="hljs-literal">false</span>,
        <span class="hljs-literal">false</span>,
        k,
        <span class="hljs-title function_">heightFromVal</span>(val),
      );
      startValue = endValue;

      <span class="hljs-comment">// 计算标签位置与引导线（两段线）</span>
      <span class="hljs-keyword">const</span> midRadian = (series[i].<span class="hljs-property">pieData</span>.<span class="hljs-property">endRatio</span> + series[i].<span class="hljs-property">pieData</span>.<span class="hljs-property">startRatio</span>) * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>;
      <span class="hljs-keyword">const</span> posX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(midRadian) * (<span class="hljs-number">1</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>));
      <span class="hljs-keyword">const</span> posY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(midRadian) * (<span class="hljs-number">1</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>));
      <span class="hljs-keyword">const</span> posZ = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(val + <span class="hljs-number">1</span>)) * <span class="hljs-number">0.1</span>;
      <span class="hljs-keyword">const</span> flag = (midRadian &gt;= <span class="hljs-number">0</span> &amp;&amp; midRadian &lt;= <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>) ||
                   (midRadian &gt;= (<span class="hljs-number">3</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>) / <span class="hljs-number">2</span> &amp;&amp; midRadian &lt;= <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>) ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;
      <span class="hljs-keyword">const</span> color = pieData?.<span class="hljs-property">itemStyle</span>?.<span class="hljs-property">color</span>;
      <span class="hljs-keyword">const</span> endPosArr = [posX * <span class="hljs-number">1.8</span> + i * <span class="hljs-number">0.1</span> * flag + (flag &lt; <span class="hljs-number">0</span> ? -<span class="hljs-number">0.5</span> : <span class="hljs-number">0</span>),
                         posY * <span class="hljs-number">1.8</span> + i * <span class="hljs-number">0.1</span> * flag + (flag &lt; <span class="hljs-number">0</span> ? -<span class="hljs-number">0.5</span> : <span class="hljs-number">0</span>),
                         posZ * <span class="hljs-number">2</span>];

      linesSeries.<span class="hljs-title function_">push</span>(
        { <span class="hljs-attr">type</span>: <span class="hljs-string">'line3D'</span>, <span class="hljs-attr">coordinateSystem</span>: <span class="hljs-string">'cartesian3D'</span>, <span class="hljs-attr">lineStyle</span>: { color }, <span class="hljs-attr">data</span>: [[posX, posY, posZ], endPosArr] },
        { <span class="hljs-attr">type</span>: <span class="hljs-string">'scatter3D'</span>, <span class="hljs-attr">coordinateSystem</span>: <span class="hljs-string">'cartesian3D'</span>, <span class="hljs-attr">label</span>: { <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">formatter</span>: <span class="hljs-string">'{b}'</span> }, <span class="hljs-attr">symbolSize</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">data</span>: [{ <span class="hljs-attr">name</span>: series[i].<span class="hljs-property">name</span> + <span class="hljs-string">'\n'</span> + val + <span class="hljs-string">'元'</span>, <span class="hljs-attr">value</span>: endPosArr }] },
      );
    }
    series = series.<span class="hljs-title function_">concat</span>(linesSeries);

    <span class="hljs-comment">// 透明支撑环</span>
    series.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'mouseoutSeries'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'surface'</span>, <span class="hljs-attr">parametric</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">wireframe</span>: { <span class="hljs-attr">show</span>: <span class="hljs-literal">false</span> }, <span class="hljs-attr">itemStyle</span>: { <span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span> }, <span class="hljs-attr">parametricEquation</span>: {<span class="hljs-comment">/* ...略 */</span>} });

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">legend</span>: { <span class="hljs-attr">bottom</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'circle'</span> },
      <span class="hljs-attr">tooltip</span>: { <span class="hljs-attr">trigger</span>: <span class="hljs-string">'item'</span>, <span class="hljs-attr">axisPointer</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'none'</span> } },
      <span class="hljs-attr">xAxis3D</span>: { <span class="hljs-attr">min</span>: -<span class="hljs-number">1</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">1</span> }, <span class="hljs-attr">yAxis3D</span>: { <span class="hljs-attr">min</span>: -<span class="hljs-number">1</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">1</span> }, <span class="hljs-attr">zAxis3D</span>: { <span class="hljs-attr">min</span>: -<span class="hljs-number">1</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">1</span> },
      <span class="hljs-attr">grid3D</span>: {
        <span class="hljs-attr">show</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">boxHeight</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">viewControl</span>: { <span class="hljs-attr">alpha</span>: <span class="hljs-number">40</span>, <span class="hljs-attr">rotateSensitivity</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">zoomSensitivity</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">panSensitivity</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">autoRotate</span>: <span class="hljs-literal">false</span> },
        <span class="hljs-attr">postEffect</span>: { <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">bloom</span>: { <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">bloomIntensity</span>: <span class="hljs-number">0.1</span> }, <span class="hljs-attr">SSAO</span>: { <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">quality</span>: <span class="hljs-string">'medium'</span>, <span class="hljs-attr">radius</span>: <span class="hljs-number">2</span> } },
      },
      series,
    };
  }

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">EChartsReact</span> <span class="hljs-attr">option</span>=<span class="hljs-string">{getPie3D(dataList,</span> <span class="hljs-attr">0.71</span>, <span class="hljs-attr">sliceHeightRange</span>)} <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> '<span class="hljs-attr">100</span>%' }} /&gt;</span></span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Pie3DChart</span>;
</code></pre>
<hr/>
<h2 data-id="heading-5">使用流程与集成</h2>
<ol>
<li>准备数据</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> dataList = [
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'成本'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">1200</span>, <span class="hljs-attr">itemStyle</span>: { <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.7</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#4FA8A4'</span> } },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'收益'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">250</span>, <span class="hljs-attr">itemStyle</span>: { <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.7</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#3570af'</span> } },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'2收益'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">158</span>, <span class="hljs-attr">itemStyle</span>: { <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.7</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#FDAA56'</span> } },
];
</code></pre>
<ol start="2">
<li>组件调用（React）</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Pie3DChart</span> dataList={dataList} sliceHeightRange={[<span class="hljs-number">8</span>, <span class="hljs-number">20</span>]} /&gt;
</code></pre>
<ol start="3">
<li>页面集成与 2D 标签对齐（微协同场景）</li>
</ol>
<p>微协同页面使用 2D 饼图的 <code>label/labelLine</code> 控制两行标签与两段引导线长度，便于与 3D 效果保持视觉一致：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-attr">label</span>: {
  <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-title function_">formatter</span>(<span class="hljs-params">params</span>) { <span class="hljs-keyword">return</span> <span class="hljs-string">`{name|<span class="hljs-subst">${params.name}</span>}\n{value|<span class="hljs-subst">${formatAmount(params.value)}</span>}`</span>; },
  <span class="hljs-attr">rich</span>: {
    <span class="hljs-attr">name</span>: { <span class="hljs-attr">color</span>: <span class="hljs-string">'#6A7570'</span>, <span class="hljs-attr">fontSize</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">lineHeight</span>: <span class="hljs-number">18</span> },
    <span class="hljs-attr">value</span>: { <span class="hljs-attr">color</span>: <span class="hljs-string">'#6A7570'</span>, <span class="hljs-attr">fontSize</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">lineHeight</span>: <span class="hljs-number">18</span> },
  },
},
<span class="hljs-attr">labelLine</span>: { <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">length</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">length2</span>: <span class="hljs-number">40</span>, <span class="hljs-attr">lineStyle</span>: { <span class="hljs-attr">color</span>: <span class="hljs-string">'#C2C8C5'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">1</span> } },
</code></pre>
<hr/>
<h2 data-id="heading-6">注意事项与踩坑实录</h2>
<ol>
<li>性能与细节平衡</li>
</ol>
<ul>
<li>参数方程的步进值（<code>u.step</code>, <code>v.step</code>）越小，曲面越精细但性能越差；在业务场景下推荐 <code>u.step ≈ π/32</code>, <code>v.step ≈ π/20</code>。</li>
<li>切片高度过大导致遮挡：通过 <code>sliceHeightRange</code> 做归一化，避免某一项过度突出。</li>
</ul>
<ol start="2">
<li>标签与引导线（3D）</li>
</ol>
<ul>
<li>3D 文本与线条在某些角度可能被遮挡；可微调 <code>endPosArr</code> 的 <code>x/y/z</code> 加上微小偏移，或降低 <code>viewControl.alpha</code>。</li>
<li>不建议开启自由旋转：旋转后标签可能穿模或与曲面错位。</li>
</ul>
<ol start="3">
<li>透明支撑环与 tooltip 冲突</li>
</ol>
<ul>
<li>透明 <code>surface</code> 可能拦截事件；通过 <code>tooltip.axisPointer.type = 'none'</code>、以及将透明环的 <code>name</code> 设为特殊值并在 <code>formatter</code> 里跳过，可规避无意义提示。</li>
</ul>
<ol start="4">
<li>颜色与图例对齐</li>
</ol>
<ul>
<li>图例项来源于 <code>series.name</code>，确保与数据 <code>name</code> 一致；颜色建议集中在数据的 <code>itemStyle.color</code>，避免后续混乱。</li>
</ul>
<ol start="5">
<li>视角与后处理</li>
</ol>
<ul>
<li><code>postEffect.SSAO</code> 在低端设备上可能产生锯齿或性能问题；可在移动端降级关闭或降低质量级别。</li>
</ul>
<ol start="6">
<li>容器尺寸变化</li>
</ol>
<ul>
<li>容器大小变化时需重新渲染或触发图表 <code>resize</code>，否则曲面比例失衡；在 React 中可监听容器尺寸变化并调用 <code>chart.resize()</code>。</li>
</ul>
<ol start="7">
<li>SSR / 首屏渲染</li>
</ol>
<ul>
<li>ECharts-GL 依赖浏览器 WebGL 环境，服务端渲染需延迟到客户端挂载后再初始化。</li>
</ul>
<ol start="8">
<li>数据边界与数值格式化</li>
</ol>
<ul>
<li>当数据为空时，避免渲染假数据；页面上用 <code>--</code> 做占位（见 <code>useLeftContent.tsx</code>）。</li>
<li>金额格式统一用千分位与“元”，可复用 <code>formatAmount</code> 方法：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">formatAmount</span> = (<span class="hljs-params">n: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> v = <span class="hljs-title class_">Number</span>(n) || <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> isInt = <span class="hljs-title class_">Number</span>.<span class="hljs-title function_">isInteger</span>(v);
  <span class="hljs-keyword">const</span> str = (isInt ? v : v.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>)).<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\B(?=(\d{3})+(?!\d))/g</span>, <span class="hljs-string">','</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${str}</span>元`</span>;
};
</code></pre>
<hr/>
<h2 data-id="heading-7">配置项说明（精选）</h2>
<p>ECharts-GL（本项目使用）</p>
<ul>
<li><code>series.surface.parametricEquation</code>: 参数方程，决定曲面形状。</li>
<li><code>series.surface.itemStyle.color/opacity</code>: 切片颜色与透明度。</li>
<li><code>line3D</code> / <code>scatter3D</code>: 标签引导线与文本，放置在三维坐标系中。</li>
<li><code>grid3D.viewControl</code>: 视角控制，如 <code>alpha</code> 旋转角、交互灵敏度。</li>
<li><code>grid3D.postEffect</code>: 后处理，含 <code>bloom</code> 高光与 <code>SSAO</code> 环境光遮蔽。</li>
</ul>
<p>自定义（本项目扩展）</p>
<ul>
<li><code>internalDiameterRatio</code> → <code>k</code>：内外径比例换算为参数方程辅助参数。</li>
<li><code>sliceHeightRange</code>：映射数据到切片厚度，避免高度失衡。</li>
<li><code>endPosArr</code> 算法：考虑象限与偏移，保证标签分布均衡。</li>
</ul>
<p>2D 饼图标签（微协同页面）</p>
<ul>
<li><code>label.rich</code>：两行文本样式（名称/金额），统一字号与颜色。</li>
<li><code>labelLine.length/length2</code>：两段引导线长度；<code>lineStyle</code> 控制颜色与宽度。</li>
</ul>
<hr/>
<h2 data-id="heading-8">常见问题 Q&amp;A</h2>
<ol>
<li>3D 表面有锯齿？</li>
</ol>
<ul>
<li>降低 <code>u/v</code> 步进密度、开启 <code>postEffect.bloom</code> 并调整强度；在低端设备关闭 <code>SSAO</code>。</li>
</ul>
<ol start="2">
<li>标签被遮挡或穿模？</li>
</ol>
<ul>
<li>微调 <code>endPosArr</code>，减小 <code>alpha</code> 值，或固定视角不允许旋转。</li>
</ul>
<ol start="3">
<li>性能偏慢？</li>
</ol>
<ul>
<li>减少数据项、降低步进密度、禁用不必要的后处理；在 React 中避免频繁重渲染。</li>
</ul>
<ol start="4">
<li>想实现高亮/选择？</li>
</ol>
<ul>
<li>3D 下选择较难稳定，推荐在 2D 饼图实现交互逻辑；3D 仅作视觉展示。</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vscode 如何修改插件默认安装地址]]></title>    <link>https://juejin.cn/post/7576130918078693411</link>    <guid>https://juejin.cn/post/7576130918078693411</guid>    <pubDate>2025-11-25T02:18:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576130918078693411" data-draft-id="7576130918078414883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vscode 如何修改插件默认安装地址"/> <meta itemprop="keywords" content="Visual Studio Code,前端"/> <meta itemprop="datePublished" content="2025-11-25T02:18:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百分三十七"/> <meta itemprop="url" content="https://juejin.cn/user/8451825861821"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vscode 如何修改插件默认安装地址
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/8451825861821/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百分三十七
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T02:18:06.000Z" title="Tue Nov 25 2025 02:18:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h3 data-id="heading-0">前言</h3>
<p><code>Vscode</code> 插件默认安装在C盘上，所有插件都安装到extensions文件下，C盘空间有限，所以要更换插件默认安装路径地址。</p>
<h3 data-id="heading-1">移动（剪切）extensions文件</h3>
<p>移动（剪切）插件文件到自定义目录。插件默认安装路径在<code>C:\Users{个人用户名}.vscode\extensions</code>目录下，找到『extensions』文件夹，<strong>右键→剪切</strong>。</p>
<p><code>注意：这里必须使用剪切</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59a07a0d991f41848c87cb807c9947b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5YiG5LiJ5Y2B5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764641885&amp;x-signature=VuvaUONnUNig86HbPhyO9KzqzhQ%3D" alt="image.png" loading="lazy"/>
我这里是已经操作完的文件状态，文件夹上有个快捷方式箭头。
我的文件存放路径是：<code>C:\Users\baimi\.vscode\extensions</code></p>
<p>粘贴的文件路径是：<code>D:\run\vsCode\extensions</code>
我这边是从C盘放到了D盘，根据个人安装路径进行操作。</p>
<h3 data-id="heading-2">两个文件夹进行软连接</h3>
<p>在<strong>管理员权限</strong>下的<strong>命令提示符</strong>CMD
<code>必须是管理员打开方式，不能使用Powershell</code></p>
<pre><code class="hljs language-js" lang="js">mklink /D <span class="hljs-string">"C:\Users\baimi\.vscode\extensions"</span> <span class="hljs-string">"D:\run\vsCode\extensions"</span>

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2555bef7a45f4d0293fbaab4c8da7bbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5YiG5LiJ5Y2B5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764641885&amp;x-signature=teLKgjkCSB33Y5LE%2BBwhihiYWVI%3D" alt="image.png" loading="lazy"/></p>
<p>再次打开C盘extensions 查看目标路径已经在D盘</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ef1db9e2c4742bfad9dbd4cf3577742~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5YiG5LiJ5Y2B5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764641885&amp;x-signature=9AyZ2ngQ6CwGFHKkMErgRNX2PgA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">总结</h3>
<p>其实就是创建快捷方式，同时进行两个文件进行软连接。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Native 通信机制详解 - 旧架构]]></title>    <link>https://juejin.cn/post/7576187677839228943</link>    <guid>https://juejin.cn/post/7576187677839228943</guid>    <pubDate>2025-11-25T02:37:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576187677839228943" data-draft-id="7576155790165835827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native 通信机制详解 - 旧架构"/> <meta itemprop="keywords" content="React Native"/> <meta itemprop="datePublished" content="2025-11-25T02:37:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tamarous"/> <meta itemprop="url" content="https://juejin.cn/user/2612095357290845"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native 通信机制详解 - 旧架构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095357290845/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tamarous
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T02:37:48.000Z" title="Tue Nov 25 2025 02:37:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React Native 通信机制详解 - 旧架构</h2>
<h3 data-id="heading-1">一、概述</h3>
<p>在<a href="https://juejin.cn/post/7576197876717699110" target="_blank" title="https://juejin.cn/post/7576197876717699110">前文</a>中，我们介绍了 React Native 的新旧两种架构，并在文章末尾介绍了如何在这两种架构中注册和实现一个原生模块。由于篇幅限制，我们并未对其底层原理进行深入介绍。接下来，我们将聚焦于此，深入探讨 React Native 新旧架构下原生模块和 JavaScript 调用的底层实现。</p>
<p>本篇是 React Native 通信机制详解系列的第一篇文章，主要介绍 React Native 旧架构下的通信机制。如果想要了解 React Native 新架构下的通信机制，请点击<a href="https://link.juejin.cn?target=.%2Freact_native_message_new.md" target="_blank" title="./react_native_message_new.md" ref="nofollow noopener noreferrer">这里</a>。</p>
<h3 data-id="heading-2">二、示例</h3>
<p>让我们回顾一下前文中注册原生模块的过程：</p>
<p>1.<strong>定义原生模块类</strong></p>
<p>首先需要创建一个继承自 <code>NSObject</code> 并遵循 <code>RCTBridgeModule</code> 协议的类。</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// CalcModule.h</span>
<span class="hljs-meta">#import <span class="hljs-string">&lt;React/RCTBridgeModule.h&gt;</span></span>

<span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">CalcModule</span> : <span class="hljs-title">NSObject</span> &lt;<span class="hljs-title">RCTBridgeModule</span>&gt;</span>
<span class="hljs-keyword">@end</span>
</code></pre>
<p>2.<strong>实现模块方法</strong></p>
<p>在实现文件中，我们使用 <code>RCT_EXPORT_MODULE()</code> 宏来导出模块，并通过 <code>RCT_EXPORT_METHOD</code> 宏来导出具体的方法。</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// CalcModule.m</span>
<span class="hljs-meta">#import <span class="hljs-string">"CalcModule.h"</span></span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">CalcModule</span></span>

RCT_EXPORT_MODULE()

RCT_EXPORT_METHOD(add:(<span class="hljs-built_in">NSInteger</span>)a
                  b:(<span class="hljs-built_in">NSInteger</span>)b
                  callback:(RCTResponseSenderBlock)callback)
{
    <span class="hljs-built_in">NSInteger</span> result = a + b;
    callback(@[@(result)]);
}

<span class="hljs-keyword">@end</span>
</code></pre>
<p>3.<strong>导出模块到 JavaScript</strong></p>
<p>最后，我们在 JavaScript 端使用这个原生模块。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Calculator.js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NativeModules</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;

<span class="hljs-keyword">const</span> { <span class="hljs-title class_">CalcModule</span> } = <span class="hljs-title class_">NativeModules</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-title class_">CalcModule</span>.<span class="hljs-title function_">add</span>(a, b, <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(result);
    });
  });
};
</code></pre>
<h3 data-id="heading-3">三、模块注册机制</h3>
<p>在旧架构中，原生模块的注册和原生模块中方法的暴露分别是通过 <code>RCT_EXPORT_MODULE()</code> 和 <code>RCT_EXPORT_METHOD</code>宏来实现的。将上述代码进行宏展开：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// RCT_EXPORT_MODULE() 宏展开</span>
<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">CalcModule</span></span>

<span class="hljs-comment">// 生成模块名映射函数</span>
+ (<span class="hljs-built_in">NSString</span> *)moduleName {
    <span class="hljs-keyword">return</span> <span class="hljs-string">@"CalcModule"</span>;
}

<span class="hljs-comment">// 注册模块到 Bridge</span>
+ (<span class="hljs-type">void</span>)load {
    RCTRegisterModule(<span class="hljs-keyword">self</span>);
}

<span class="hljs-comment">// RCT_EXPORT_METHOD 宏展开</span>
- (<span class="hljs-type">void</span>)__rct_export__add_a_b_callback {
    RCTMethodInfo methodInfo = {
        .objcName = <span class="hljs-string">"add:b:callback:"</span>,
        .jsName = <span class="hljs-string">"add"</span>,
        .isSync = <span class="hljs-literal">NO</span>
    };
    RCTRegisterMethodInfo(<span class="hljs-keyword">self</span>, methodInfo);
}

<span class="hljs-comment">// 原始方法实现</span>
- (<span class="hljs-type">void</span>)add:(<span class="hljs-built_in">NSInteger</span>)a
          b:(<span class="hljs-built_in">NSInteger</span>)b
  callback:(RCTResponseSenderBlock)callback
{
    <span class="hljs-built_in">NSInteger</span> result = a + b;
    callback(@[@(result)]);
}

<span class="hljs-keyword">@end</span>
</code></pre>
<p><code>RCT_EXPORT_MODULE()</code> 宏会在类的 +load 方法中调用 <code>RCTRegisterModule(class)</code> 函数，将模块注册到 Bridge。<code>RCT_EXPORT_METHOD</code> 宏则会调用 <code>RCTRegisterMethodInfo</code>，将方法信息注册到 Bridge。</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// RCTRegisterModule 实现</span>
<span class="hljs-keyword">static</span> <span class="hljs-built_in">NSMutableArray</span>&lt;Class&gt; *RCTModuleClasses;
<span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> onceToken;

<span class="hljs-type">void</span> RCTRegisterModule(Class moduleClass)
{
    <span class="hljs-built_in">dispatch_once</span>(&amp;onceToken, ^{
        RCTModuleClasses = [<span class="hljs-built_in">NSMutableArray</span> new];
    });

    <span class="hljs-comment">// 确保类遵循 RCTBridgeModule 协议</span>
    <span class="hljs-keyword">if</span> ([moduleClass conformsToProtocol:<span class="hljs-class"><span class="hljs-keyword">@protocol</span>(<span class="hljs-title">RCTBridgeModule</span>)]) </span>{
        <span class="hljs-comment">// 添加到全局模块注册表</span>
        [RCTModuleClasses addObject:moduleClass];
    }
}
</code></pre>
<p>这个方法的本质是将当前 module 添加到全局变量 RCTModuleClasses 中。</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// RCTRegisterMethodInfo 实现</span>
<span class="hljs-keyword">static</span> <span class="hljs-built_in">NSMutableDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, <span class="hljs-built_in">NSMutableSet</span>&lt;RCTMethodInfo *&gt; *&gt; *methodsMap;
<span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> methodMapOnceToken;

<span class="hljs-type">void</span> RCTRegisterMethodInfo(Class moduleClass, RCTMethodInfo methodInfo)
{
    <span class="hljs-built_in">dispatch_once</span>(&amp;methodMapOnceToken, ^{
        methodsMap = [<span class="hljs-built_in">NSMutableDictionary</span> new];
    });

    <span class="hljs-comment">// 获取或创建模块的方法集合</span>
    <span class="hljs-built_in">NSString</span> *moduleName = [moduleClass moduleName];
    <span class="hljs-built_in">NSMutableSet</span> *methods = methodsMap[moduleName];
    <span class="hljs-keyword">if</span> (!methods) {
        methods = [<span class="hljs-built_in">NSMutableSet</span> new];
        methodsMap[moduleName] = methods;
    }

    <span class="hljs-comment">// 添加方法信息到方法集合</span>
    RCTMethodInfo *info = [[RCTMethodInfo alloc] init];
    info.objcName = methodInfo.objcName;
    info.jsName = methodInfo.jsName;
    info.isSync = methodInfo.isSync;
    [methods addObject:info];
}
</code></pre>
<p>这个方法的本质是将当前 module 对应的方法信息添加到全局变量 methodsMap 中。</p>
<p>当 RCTBridge 初始化时，会遍历 <code>RCTModuleClasses</code> 数组，为每个注册的模块类创建实例：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)initModules
{
    <span class="hljs-comment">// 遍历已注册的模块类</span>
    <span class="hljs-keyword">for</span> (Class moduleClass <span class="hljs-keyword">in</span> RCTModuleClasses) {
        <span class="hljs-comment">// 创建模块实例</span>
        <span class="hljs-type">id</span>&lt;RCTBridgeModule&gt; module = [[moduleClass alloc] init];
        
        <span class="hljs-comment">// 将模块实例添加到 bridge 的模块表中</span>
        <span class="hljs-built_in">NSString</span> *moduleName = [moduleClass moduleName];
        _modulesByName[moduleName] = module;
    }
}
</code></pre>
<p>当 JavaScript 端调用 <code>CalcModule.add</code> 方法时，会先经过 MessageQueue：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// MessageQueue.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageQueue</span> {
  <span class="hljs-title function_">callNativeMethod</span>(<span class="hljs-params">moduleID, methodID, params, onFail, onSucc</span>) {
    <span class="hljs-comment">// 将调用信息放入队列</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enqueueNativeCall</span>(moduleID, methodID, params, onFail, onSucc);
    <span class="hljs-comment">// 触发队列刷新</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flushQueue</span>();
  }

  <span class="hljs-title function_">flushQueue</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 将队列中的调用序列化为 JSON</span>
    <span class="hljs-keyword">const</span> calls = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_queue</span>);
    <span class="hljs-comment">// 通过 Bridge 发送到原生层</span>
    <span class="hljs-variable language_">global</span>.<span class="hljs-title function_">nativeFlushQueueImmediate</span>(calls);
  }
}
</code></pre>
<p>而在 React Native 初始化时，会通过 JavaScriptCore 引擎为 JavaScript 环境注入一个全局函数 <code>nativeFlushQueueImmediate</code>。这个注入过程发生在 <code>RCTBridge</code> 初始化时：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// RCTBridge.m</span>
- (<span class="hljs-type">void</span>)setupJSExecutor
{
    <span class="hljs-comment">// 获取 JSContext</span>
    JSContext *context = [JSContext new];
    
    <span class="hljs-comment">// 注入全局函数</span>
    context[<span class="hljs-string">@"nativeFlushQueueImmediate"</span>] = ^(JSValue *calls) {
        <span class="hljs-comment">// 将 JSValue 转换为 NSString</span>
        <span class="hljs-built_in">NSString</span> *callsString = [calls toString];
        
        <span class="hljs-comment">// 解析调用请求</span>
        <span class="hljs-built_in">NSArray</span> *requests = [<span class="hljs-built_in">NSJSONSerialization</span> JSONObjectWithData:[callsString dataUsingEncoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>]
                                                         options:<span class="hljs-number">0</span>
                                                           error:<span class="hljs-literal">NULL</span>];
        
        <span class="hljs-comment">// 处理每个调用请求</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSDictionary</span> *request <span class="hljs-keyword">in</span> requests) {
            <span class="hljs-built_in">NSNumber</span> *moduleID = request[<span class="hljs-string">@"moduleID"</span>];
            <span class="hljs-built_in">NSString</span> *methodName = request[<span class="hljs-string">@"methodID"</span>];
            <span class="hljs-built_in">NSArray</span> *args = request[<span class="hljs-string">@"args"</span>];
            
            <span class="hljs-comment">// 转发到 Bridge 处理</span>
            [<span class="hljs-keyword">self</span> _handleRequestNumber:moduleID
                              method:methodName
                           arguments:args];
        }
    };
}
</code></pre>
<p>因此当 JavaScript 调用 <code>global.nativeFlushQueueImmediate(calls)</code> 时，实际上是调用了上述注入的函数。这个函数会将 JavaScript 传入的调用队列转换为原生数据结构，然后解析出每个调用请求的模块 ID、方法名和参数，最终将请求转发给 <code>RCTBridge</code> 的 <code>_handleRequestNumber:method:arguments:</code> 方法处理</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// RCTBridge.m</span>
- (<span class="hljs-type">void</span>)_handleRequestNumber:(<span class="hljs-built_in">NSNumber</span> *)requestNumber
                    method:(<span class="hljs-built_in">NSString</span> *)method
                   arguments:(<span class="hljs-built_in">NSArray</span> *)arguments
{
    <span class="hljs-comment">// 序列化参数</span>
    <span class="hljs-built_in">NSData</span> *messageData = [<span class="hljs-built_in">NSJSONSerialization</span> dataWithJSONObject:arguments
                                                        options:<span class="hljs-number">0</span>
                                                          error:<span class="hljs-literal">NULL</span>];
    <span class="hljs-comment">// 发送到原生模块</span>
    [<span class="hljs-keyword">self</span> enqueueJSCall:method args:messageData];
}
</code></pre>
<p>最后，原生层通过 <code>invokeMethod</code> 方法找到并执行对应的原生实现：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)invokeMethod:(<span class="hljs-built_in">NSString</span> *)moduleName
           methodName:(<span class="hljs-built_in">NSString</span> *)methodName
            arguments:(<span class="hljs-built_in">NSArray</span> *)arguments
{
    <span class="hljs-comment">// 获取模块的方法集合</span>
    <span class="hljs-built_in">NSMutableSet</span>&lt;RCTMethodInfo *&gt; *methods = methodsMap[moduleName];
    
    <span class="hljs-comment">// 查找对应的方法信息</span>
    RCTMethodInfo *methodInfo = <span class="hljs-literal">nil</span>;
    <span class="hljs-keyword">for</span> (RCTMethodInfo *info <span class="hljs-keyword">in</span> methods) {
        <span class="hljs-keyword">if</span> ([info.jsName isEqualToString:methodName]) {
            methodInfo = info;
            <span class="hljs-keyword">break</span>;
        }
    }
    
    <span class="hljs-keyword">if</span> (methodInfo) {
        <span class="hljs-comment">// 获取模块实例</span>
        <span class="hljs-type">id</span>&lt;RCTBridgeModule&gt; module = _modulesByName[moduleName];
        
        <span class="hljs-comment">// 通过 performSelector 调用原生方法</span>
        SEL selector = <span class="hljs-built_in">NSSelectorFromString</span>(methodInfo.objcName);
        [module performSelector:selector withArguments:arguments];
    }
}
</code></pre>
<h3 data-id="heading-4">四、流程图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant JS as JavaScript
    participant Bridge as Bridge
    participant Native as Native Module
    participant Runtime as Runtime System

    %% 模块注册阶段
    Note over Native: 定义原生模块类 CalcModule
    Native-&gt;&gt;Runtime: RCT_EXPORT_MODULE() 宏展开
    activate Runtime
    Runtime-&gt;&gt;Runtime: 生成 moduleName 方法
    Runtime-&gt;&gt;Runtime: 生成 load 方法
    Runtime-&gt;&gt;Bridge: RCTRegisterModule(CalcModule)
    Bridge-&gt;&gt;Bridge: 将模块类添加到 RCTModuleClasses
    deactivate Runtime

    Native-&gt;&gt;Runtime: RCT_EXPORT_METHOD 宏展开
    activate Runtime
    Runtime-&gt;&gt;Runtime: 生成方法信息 RCTMethodInfo
    Runtime-&gt;&gt;Bridge: RCTRegisterMethodInfo(CalcModule, methodInfo)
    Bridge-&gt;&gt;Bridge: 将方法信息添加到 methodsMap
    deactivate Runtime

    %% Bridge 初始化阶段
    Note over Bridge: RCTBridge 初始化
    Bridge-&gt;&gt;Bridge: initModules
    activate Bridge
    Bridge-&gt;&gt;Native: 创建模块实例
    Native--&gt;&gt;Bridge: 返回模块实例
    Bridge-&gt;&gt;Bridge: 保存实例到 _modulesByName
    deactivate Bridge

    Bridge-&gt;&gt;JS: setupJSExecutor
    activate JS
    JS-&gt;&gt;JS: 注入 nativeFlushQueueImmediate
    deactivate JS

    %% JavaScript 调用阶段
    Note over JS: 调用 CalcModule.add()
    JS-&gt;&gt;JS: 创建 Promise
    JS-&gt;&gt;Bridge: MessageQueue.callNativeMethod
    activate Bridge
    Bridge-&gt;&gt;Bridge: enqueueNativeCall
    Bridge-&gt;&gt;Bridge: flushQueue
    Bridge-&gt;&gt;Bridge: nativeFlushQueueImmediate
    Bridge-&gt;&gt;Bridge: 解析调用请求
    Bridge-&gt;&gt;Native: invokeMethod
    deactivate Bridge

    activate Native
    Native-&gt;&gt;Native: 执行 add 方法
    Native-&gt;&gt;JS: 通过 callback 返回结果
    deactivate Native

    JS-&gt;&gt;JS: Promise resolve
</code></pre>
<h3 data-id="heading-5">五、小结</h3>
<p>本篇文章主要介绍了 React Native 旧架构下原生模块和 JavaScript 调用的底层实现。通过对模块注册机制和 JavaScript 调用流程的分析，我们深入了解了 React Native 旧架构下的通信机制。希望本文能帮助你更好地理解 React Native 的通信机制。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 Vue3 高效技巧：10 行代码实现表单防抖 + 实时验证，复用率拉满！]]></title>    <link>https://juejin.cn/post/7576210031873327145</link>    <guid>https://juejin.cn/post/7576210031873327145</guid>    <pubDate>2025-11-25T02:39:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576210031873327145" data-draft-id="7576223441713496107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 🚀 Vue3 高效技巧：10 行代码实现表单防抖 + 实时验证，复用率拉满！"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-25T02:39:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="宇余"/> <meta itemprop="url" content="https://juejin.cn/user/2999123453424542"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             🚀 Vue3 高效技巧：10 行代码实现表单防抖 + 实时验证，复用率拉满！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123453424542/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    宇余
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T02:39:20.000Z" title="Tue Nov 25 2025 02:39:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，表单是高频场景，而「输入防抖」和「实时验证」几乎是必备需求 —— 比如搜索框输入时避免频繁接口请求、注册页面实时校验手机号格式、登录表单防重复提交。如果每个表单都单独写一遍逻辑，不仅冗余还容易出错。</p>
<p>今天分享一个 Vue3 组合式 API 小技巧，用 10 行核心代码封装通用的「防抖 + 验证」工具，支持任意表单复用，兼顾性能和开发效率，完全适配实际项目场景！</p>
<h2 data-id="heading-0">一、场景痛点</h2>
<p>先看看我们平时遇到的问题：</p>
<ol>
<li>输入框实时校验时，输入过快导致频繁触发验证函数（比如每输入一个字符就校验手机号），浪费性能；</li>
<li>多个表单（登录、注册、搜索）需要重复写防抖逻辑，代码冗余；</li>
<li>验证规则不统一，后续维护成本高。</li>
</ol>
<p>而用组合式 API 封装后，只需一行代码即可接入，完美解决以上问题！</p>
<h2 data-id="heading-1">二、核心实现：封装 <code>useDebounceValidate</code> 工具</h2>
<p>直接上代码，核心逻辑基于 <code>lodash.debounce</code> 简化（也可以手写防抖函数，下文附原生实现），兼顾灵活性和易用性：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/hooks/useDebounceValidate.js</span>
<span class="hljs-keyword">import</span> { ref, watch, unref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> debounce <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash.debounce'</span>; <span class="hljs-comment">// 也可以手写防抖（下文附原生实现）</span>

<span class="hljs-comment">/**
 * 表单防抖+实时验证组合式工具
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Ref</span>} <span class="hljs-variable">valueRef</span> - 输入值的响应式引用
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} <span class="hljs-variable">validator</span> - 验证函数（返回布尔值/错误信息）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">delay</span> - 防抖延迟时间（默认300ms）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Object</span>} {<span class="hljs-type"> debouncedValue, isValid, errorMsg </span>}
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useDebounceValidate</span>(<span class="hljs-params">valueRef, validator, delay = <span class="hljs-number">300</span></span>) {
  <span class="hljs-keyword">const</span> debouncedValue = <span class="hljs-title function_">ref</span>(<span class="hljs-title function_">unref</span>(valueRef)); <span class="hljs-comment">// 防抖后的值</span>
  <span class="hljs-keyword">const</span> isValid = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 验证结果（true=通过）</span>
  <span class="hljs-keyword">const</span> errorMsg = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>); <span class="hljs-comment">// 验证错误信息</span>

  <span class="hljs-comment">// 防抖处理函数</span>
  <span class="hljs-keyword">const</span> debounceHandler = <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> {
    debouncedValue.<span class="hljs-property">value</span> = val;
    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">validator</span>(val); <span class="hljs-comment">// 执行自定义验证规则</span>
    isValid.<span class="hljs-property">value</span> = <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'boolean'</span> ? result : <span class="hljs-literal">true</span>;
    errorMsg.<span class="hljs-property">value</span> = <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'string'</span> ? result : <span class="hljs-string">''</span>;
  }, delay);

  <span class="hljs-comment">// 监听输入值变化，触发防抖</span>
  <span class="hljs-title function_">watch</span>(valueRef, <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> <span class="hljs-title function_">debounceHandler</span>(newVal), { <span class="hljs-attr">immediate</span>: <span class="hljs-literal">false</span> });

  <span class="hljs-comment">// 组件卸载时取消防抖（避免内存泄漏）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">cleanup</span> = (<span class="hljs-params"/>) =&gt; debounceHandler.<span class="hljs-title function_">cancel</span>();

  <span class="hljs-keyword">return</span> { debouncedValue, isValid, errorMsg, cleanup };
}

<span class="hljs-comment">// 🌟 原生防抖函数（无需依赖lodash，直接替换使用）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">debounceNative</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-built_in">clearTimeout</span>(timer);
    timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args), delay);
  };
}
</code></pre>
<h3 data-id="heading-2">核心逻辑解析：</h3>
<ol>
<li><strong>响应式封装</strong>：接收输入值的响应式引用（<code>valueRef</code>），返回防抖后的值、验证结果、错误信息；</li>
<li><strong>灵活验证</strong>：<code>validator</code> 参数支持自定义验证规则（返回布尔值表示是否通过，或字符串表示错误信息）；</li>
<li><strong>内存安全</strong>：提供 <code>cleanup</code> 方法，组件卸载时取消防抖计时器，避免内存泄漏；</li>
<li><strong>无依赖可选</strong>：支持使用 lodash.debounce 或原生防抖函数，按需选择。</li>
</ol>
<h2 data-id="heading-3">三、实际应用：登录表单示例</h2>
<p>在 Vue3 组件中直接使用，一行代码接入防抖 + 验证，逻辑清晰且复用性拉满：</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- src/components/LoginForm.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-form"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>登录表单<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 手机号输入框 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>手机号：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">v-model</span>=<span class="hljs-string">"phone"</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"tel"</span>
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入手机号"</span>
        <span class="hljs-attr">class</span>=<span class="hljs-string">"input"</span>
      /&gt;</span>
      <span class="hljs-comment">&lt;!-- 实时显示错误信息 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"error-msg"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!phoneIsValid"</span>&gt;</span>{{ phoneErrorMsg }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 密码输入框（仅防抖，不验证格式） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>密码：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">v-model</span>=<span class="hljs-string">"password"</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span>
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入密码"</span>
        <span class="hljs-attr">class</span>=<span class="hljs-string">"input"</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 按钮状态：手机号验证通过+密码不为空才可用 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
      <span class="hljs-attr">class</span>=<span class="hljs-string">"login-btn"</span>
      <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"!phoneIsValid || !password"</span>
      @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleLogin"</span>
    &gt;</span>
      登录
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { useDebounceValidate } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useDebounceValidate'</span>;

<span class="hljs-comment">// 1. 定义表单响应式数据</span>
<span class="hljs-keyword">const</span> phone = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> password = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);

<span class="hljs-comment">// 2. 手机号验证规则（自定义：返回错误信息或true）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">validatePhone</span> = (<span class="hljs-params">val</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!val) <span class="hljs-keyword">return</span> <span class="hljs-string">'手机号不能为空'</span>;
  <span class="hljs-keyword">const</span> reg = <span class="hljs-regexp">/^1[3-9]\d{9}$/</span>;
  <span class="hljs-keyword">return</span> reg.<span class="hljs-title function_">test</span>(val) ? <span class="hljs-literal">true</span> : <span class="hljs-string">'请输入正确的手机号格式'</span>;
};

<span class="hljs-comment">// 3. 一行代码接入防抖+验证（延迟300ms）</span>
<span class="hljs-keyword">const</span> { 
  <span class="hljs-attr">isValid</span>: phoneIsValid, <span class="hljs-comment">// 验证结果</span>
  <span class="hljs-attr">errorMsg</span>: phoneErrorMsg, <span class="hljs-comment">// 错误信息</span>
  <span class="hljs-attr">cleanup</span>: cleanupPhoneDebounce <span class="hljs-comment">// 清理防抖计时器</span>
} = <span class="hljs-title function_">useDebounceValidate</span>(phone, validatePhone, <span class="hljs-number">300</span>);

<span class="hljs-comment">// 4. 登录提交逻辑（密码也可加防抖防重复提交）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'登录请求：'</span>, { <span class="hljs-attr">phone</span>: phone.<span class="hljs-property">value</span>, <span class="hljs-attr">password</span>: password.<span class="hljs-property">value</span> });
  <span class="hljs-comment">// 实际项目中可在此处调用登录接口</span>
};

<span class="hljs-comment">// 5. 组件卸载时清理防抖（避免内存泄漏）</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">cleanupPhoneDebounce</span>();
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.login-form</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">50px</span> auto;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
}
<span class="hljs-selector-class">.form-item</span> {
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">4px</span>;
}
<span class="hljs-selector-class">.input</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}
<span class="hljs-selector-class">.error-msg</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#ff4d4f</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
}
<span class="hljs-selector-class">.login-btn</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#1890ff</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
}
<span class="hljs-selector-class">.login-btn</span><span class="hljs-selector-pseudo">:disabled</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#ccc</span>;
  <span class="hljs-attribute">cursor</span>: not-allowed;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">效果演示：</h3>
<ul>
<li>输入手机号时，快速输入不会立即触发验证，等待 300ms 无输入后才执行校验；</li>
<li>手机号格式错误时实时显示错误信息，格式正确后错误信息自动消失；</li>
<li>登录按钮只有在手机号验证通过且密码不为空时才可用，避免无效提交。</li>
</ul>
<h2 data-id="heading-5">四、扩展场景：搜索框防抖请求</h2>
<p>除了表单验证，搜索框的接口请求也能直接复用这个工具，无需额外写防抖逻辑：</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"search-box"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"searchKey"</span>
      <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"搜索商品..."</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"search-input"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { useDebounceValidate } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useDebounceValidate'</span>;
<span class="hljs-keyword">import</span> { fetchSearchGoods } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/goods'</span>; <span class="hljs-comment">// 搜索接口</span>

<span class="hljs-keyword">const</span> searchKey = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);

<span class="hljs-comment">// 搜索框：防抖500ms后请求接口（验证规则简化为“非空”）</span>
<span class="hljs-keyword">const</span> { 
  <span class="hljs-attr">debouncedValue</span>: searchValue,
  <span class="hljs-attr">cleanup</span>: cleanupSearchDebounce
} = <span class="hljs-title function_">useDebounceValidate</span>(
  searchKey,
  <span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> { 
    <span class="hljs-comment">// 验证规则：非空则执行搜索请求</span>
    <span class="hljs-keyword">if</span> (val) <span class="hljs-title function_">fetchSearchGoods</span>(val).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'搜索结果：'</span>, res));
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 无需错误信息，返回true即可</span>
  },
  <span class="hljs-number">500</span>
);

<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">cleanupSearchDebounce</span>());
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-6">五、核心优势总结</h2>
<ol>
<li><strong>极致复用</strong>：一个工具适配所有表单（登录、注册、搜索、设置页面），减少重复代码；</li>
<li><strong>性能优化</strong>：防抖避免频繁触发验证 / 接口请求，降低性能消耗；</li>
<li><strong>灵活扩展</strong>：验证规则完全自定义，支持多字段联动、异步验证（比如校验手机号是否已注册）；</li>
<li><strong>上手简单</strong>：Vue3 组合式 API 风格，一行代码接入，新手也能快速使用；</li>
<li><strong>内存安全</strong>：提供清理防抖计时器的方法，避免组件卸载后内存泄漏。</li>
</ol>
<h2 data-id="heading-7">六、进阶优化（可选）</h2>
<p>如果需要支持异步验证（比如校验手机号是否已被注册），只需修改验证函数为异步即可：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// 异步验证示例：校验手机号是否已注册
const <span class="hljs-attr">validatePhoneAsync</span> = async (val) =&gt; {
  if (!val) return '手机号不能为空'<span class="hljs-comment">;</span>
  const <span class="hljs-attr">reg</span> = /^<span class="hljs-number">1</span>[<span class="hljs-number">3</span>-<span class="hljs-number">9</span>]\d{<span class="hljs-number">9</span>}$/<span class="hljs-comment">;</span>
  if (!reg.test(val)) return '请输入正确的手机号格式'<span class="hljs-comment">;</span>
  // 调用接口校验手机号是否已注册
  const <span class="hljs-attr">isRegistered</span> = await fetchCheckPhone(val)<span class="hljs-comment">;</span>
  return isRegistered ? '该手机号已注册' : true<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 工具内部只需将防抖函数改为支持异步：
const <span class="hljs-attr">debounceHandler</span> = debounce(async (val) =&gt; {
  <span class="hljs-attr">debouncedValue.value</span> = val<span class="hljs-comment">;</span>
  const <span class="hljs-attr">result</span> = await validator(val)<span class="hljs-comment">; // 等待异步验证结果</span>
  <span class="hljs-attr">isValid.value</span> = typeof result === <span class="hljs-string">'boolean'</span> ? result : <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">errorMsg.value</span> = typeof result === <span class="hljs-string">'string'</span> ? result : <span class="hljs-string">''</span><span class="hljs-comment">;</span>
}, delay)<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-8">最后</h2>
<p>这个小技巧看似简单，但实际项目中能大幅提升开发效率，尤其适合中大型项目的表单统一管理。如果觉得有用，欢迎点赞、收藏，评论区分享你的使用场景～ 也可以关注我，后续会分享更多 Vue3/React 实用技巧和性能优化方案！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>