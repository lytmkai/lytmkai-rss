<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[为什么建议把 map 换成 for loop？—— 聊聊 Side Effects 与语义化编程]]></title>    <link>https://juejin.cn/post/7603352117639168009</link>    <guid>https://juejin.cn/post/7603352117639168009</guid>    <pubDate>2026-02-06T08:55:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603352117639168009" data-draft-id="7603309951227379762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么建议把 map 换成 for loop？—— 聊聊 Side Effects 与语义化编程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T08:55:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Gogo1121"/> <meta itemprop="url" content="https://juejin.cn/user/4162081326907051"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么建议把 map 换成 for loop？—— 聊聊 Side Effects 与语义化编程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4162081326907051/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Gogo1121
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:55:12.000Z" title="Fri Feb 06 2026 08:55:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>在进行代码审查（Code Review）时，你是否收到过这样的评论：</p>
<blockquote>
<p><strong>“这里的 side effect 会不会考虑一下用 for loop？”</strong></p>
</blockquote>
<p>当时的我心里想：“反正代码都能跑，<code>map</code> 和 <code>for</code> 有什么区别吗？<code>map</code> 写起来不是更短更帅吗？”</p>
<p>这篇文章就是为了解答这个疑惑。这不仅仅是代码风格的问题，更关乎<strong>代码的可读性（语义）</strong> 、<strong>性能（内存）以及函数式编程的原则</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、 什么是 Side Effect（副作用）？</h2>
<p>首先，我们要听懂“行话”。在编程中，<strong>Side Effect</strong> 指的是一个函数在执行过程中，除了返回结果之外，还<strong>改变了外部的世界</strong>。</p>
<ul>
<li>
<p><strong>纯函数 (Pure Function)</strong> ：输入 <code>2</code>，输出 <code>4</code>。不修改任何外部变量，不读写数据库，不打印日志。像数学公式一样纯粹。</p>
</li>
<li>
<p><strong>有副作用 (Side Effect)</strong> ：</p>
<ul>
<li>修改了外部定义的变量（如 <code>total += 1</code>）。</li>
<li>写入数据库（DB Insert/Update）。</li>
<li>发送网络请求（API Call）。</li>
<li>打印日志（<code>console.log</code>）。</li>
</ul>
</li>
</ul>
<p><strong>Reviewer 的潜台词：</strong> “我看你在遍历数组时，并不是为了把 A 变成 B，而是为了拿 A 去做一些操作（比如存库）。这种情况，请不要用 <code>map</code>。”</p>
<hr/>
<h2 data-id="heading-1">二、 <code>map</code> vs <code>for</code>：看似一样，实则背道而驰</h2>
<p>虽然它们都能遍历数组，但它们在**设计初衷（语义）**上是完全不同的。</p>
<h3 data-id="heading-2">1. <code>map</code> 的契约：我只负责“转换”</h3>
<p><code>map</code> 是函数式编程（Functional Programming）的明星工具。它的名字来源于数学中的“映射”（Mapping）。</p>
<ul>
<li><strong>语义</strong>：给我一个数组 <code>[A, B, C]</code>，我给你返回一个新数组 <code>[A', B', C']</code>。</li>
<li><strong>潜规则</strong>：<strong>一定要有返回值</strong>，且<strong>不要修改原始数据</strong>。</li>
</ul>
<h3 data-id="heading-3">2. <code>for</code> / <code>forEach</code> 的契约：我只负责“执行”</h3>
<p><code>for</code> 循环（包括 <code>for...of</code>）是指令式编程（Imperative Programming）的工具。</p>
<ul>
<li><strong>语义</strong>：对着数组里的每一个元素，去<strong>执行</strong>一段逻辑。</li>
<li><strong>潜规则</strong>：我不关心返回值，我只关心过程（比如存库、发邮件）。</li>
</ul>
<hr/>
<h2 data-id="heading-4">三、 为什么用 <code>map</code> 处理副作用被视为 Anti-pattern（反模式）？</h2>
<p>如果你写了这样的代码：</p>
<pre><code class="hljs language-ini" lang="ini">// ❌ 被吐槽的写法
const <span class="hljs-attr">userIds</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<span class="hljs-comment">;</span>

userIds.map(<span class="hljs-attr">id</span> =&gt; {
  db.updateStatus(id, 'active')<span class="hljs-comment">; // &lt;--- 这就是 Side Effect</span>
  // 没有 return，或者 return 了一个没用的东西
})<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>Reviewer 看到这段代码会有三个层面的担忧：</p>
<h3 data-id="heading-5">1. 误导阅读者（语义错误）</h3>
<p>代码是写给人看的。 当你使用 <code>map</code> 时，阅读代码的人会预期：“哦，这里在生成一个新的数据列表。” 结果看了一圈发现，你并没有使用 <code>map</code> 的返回值，只是在里面干活。这就像是你<strong>雇了一个顶级大厨（map），却让他去送快递（side effect）</strong> ——虽然他也能送，但让人觉得很违和。</p>
<h3 data-id="heading-6">2. 内存浪费（性能隐患）</h3>
<p>这是实打实的技术问题。 <code>map</code> 函数<strong>一定会</strong>在内存中分配一个新的数组。</p>
<ul>
<li>如果你用 <code>map</code> 遍历 10,000 个用户去发邮件，通过 <code>map</code> 你会隐式地创建了一个包含 10,000 个 <code>undefined</code>（因为你没 return）的数组。</li>
<li>这个数组创建完立刻就被扔掉等待垃圾回收（GC）。</li>
<li><strong>结论</strong>：你在浪费内存，给 GC 增加压力。</li>
</ul>
<h3 data-id="heading-7">3. Async/Await 的陷阱</h3>
<p>在后端开发中，这尤为致命。</p>
<pre><code class="hljs language-python" lang="python">// ❌ 危险的 <span class="hljs-built_in">map</span> 写法
ids.<span class="hljs-built_in">map</span>(<span class="hljs-keyword">async</span> (<span class="hljs-built_in">id</span>) =&gt; {
  <span class="hljs-keyword">await</span> db.delete(<span class="hljs-built_in">id</span>);
});
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>上面这段代码<strong>不会</strong>等待数据库删除完成！<code>map</code> 会瞬间执行完，返回一堆 <code>Promise</code>，而你的主程序会继续往下跑。</p>
<p>如果要等待，必须配合 <code>Promise.all</code>：</p>
<pre><code class="hljs language-python" lang="python">// ✅ 如果要并发，且一定要用 <span class="hljs-built_in">map</span>
<span class="hljs-keyword">await</span> Promise.<span class="hljs-built_in">all</span>(ids.<span class="hljs-built_in">map</span>(<span class="hljs-keyword">async</span> (<span class="hljs-built_in">id</span>) =&gt; <span class="hljs-keyword">await</span> db.delete(<span class="hljs-built_in">id</span>)));
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>但如果你想要<strong>按顺序</strong>一个一个删（避免把数据库打挂），<code>map</code> 做不到，必须用 <code>for...of</code>。</p>
<hr/>
<h2 data-id="heading-8">四、 最佳实践：如何修改？</h2>
<p>针对 Reviewer 的建议，可以根据场景选择以下两种改法：</p>
<h3 data-id="heading-9">场景 A：纯同步操作 / 不需要等待结果</h3>
<p>使用 <code>forEach</code> 或 <code>for...of</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 语义清晰：我在对每个 ID 执行操作</span>
userIds.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Processing user <span class="hljs-subst">${id}</span>`</span>);
});
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-10">场景 B：异步操作（数据库/API）—— <strong>最推荐</strong></h3>
<p>现代 JavaScript/TypeScript 开发中，<code>for...of</code> 是处理异步副作用的神器</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ✅ 语义清晰，且支持 await 顺序执行</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> id of userIds) {
  <span class="hljs-comment">// 只有上一个 update 完成了，才会执行下一个</span>
  <span class="hljs-keyword">await</span> db.updateStatus(id, <span class="hljs-string">'active'</span>); 
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-11">五、 总结</h2>
<p>下次当你手指放在键盘上准备敲下 <code>.map</code> 时，停下来问自己一个问题：</p>
<p><strong>“我是想要根据旧数组【生成】一个新数组，还是想要用这些数据去【做】一些事情？”</strong></p>
<ul>
<li>如果是<strong>生成</strong>数据（转换）：请用 <code>map</code>。</li>
<li>如果是<strong>做</strong>事情（副作用）：请用 <code>for...of</code> 或 <code>forEach</code>。</li>
</ul>
<p>这不仅仅是代码能不能跑的区别，更是从“写代码的人”进阶到“工程师”的必经之路：<strong>精准地使用工具，表达清晰的意图。</strong></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你不知道的JS上-（八）]]></title>    <link>https://juejin.cn/post/7603444191447990306</link>    <guid>https://juejin.cn/post/7603444191447990306</guid>    <pubDate>2026-02-06T08:55:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603444191447990306" data-draft-id="7603444191447924770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你不知道的JS上-（八）"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-06T08:55:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户1443618340097"/> <meta itemprop="url" content="https://juejin.cn/user/2782223226650328"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你不知道的JS上-（八）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2782223226650328/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户1443618340097
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:55:26.000Z" title="Fri Feb 06 2026 08:55:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">this 和对象原型</h2>
<h3 data-id="heading-1">对象</h3>
<h4 data-id="heading-2">语法</h4>
<p>对象可以通过两种形式定义：声明（文字）形式和构造形式。</p>
<p>文字语法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObj = {
  <span class="hljs-attr">key</span>: value,
  <span class="hljs-comment">//...</span>
};
</code></pre>
<p>构造语法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
myObj.<span class="hljs-property">key</span> = value;
</code></pre>
<p>构造形式和文字形式的区别就是，文字声明中可以添加多个健/值对，构造语法只能逐个添加。</p>
<h4 data-id="heading-3">类型</h4>
<p>对象是JavaScript的基础。在JavaScript中一个有六种主要类型（术语是“语言类型”）：string、number、boolean、null、undefined、object</p>
<p>注意，简单基本类型本身并不是对象。null有时会被当作一种对象类型，但这是语言本身的一个bug，即对null执行typeof null时会返回字符串“object”。null本身是基本类型。</p>
<p>实际上，JS中有许多特殊的对象子类型，我们称之为复杂基本类型。</p>
<p>函数、数组都是对象的一种类型。</p>
<h5 data-id="heading-4">内置对象</h5>
<p>JS中还有一些对象子类型，通常被称为内置对象。有些内置对象的名字看起来和基础类型一样，不过它们的关系更加复杂。String、Number、Boolean、Object、Function、Array、Date、RegExp、Error。</p>
<p>这些内置对象从表现形式上和其他语言中的类型（type）或者类（class）很像，比如Java中的String类。</p>
<p>但在JS中，它们实际上只是一些内置函数。这些内置函数可以当作构造函数来使用，从而构造一个对应子类型的新对象。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> strPrimitive = <span class="hljs-string">"I am a String"</span>;
<span class="hljs-keyword">typeof</span> strPrimitive; <span class="hljs-comment">// "string"</span>
strPrimitive <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">String</span>; <span class="hljs-comment">// false</span>

<span class="hljs-keyword">var</span> strObject = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">"I am a String"</span>);
<span class="hljs-keyword">typeof</span> strObject; <span class="hljs-comment">// "object"</span>
strObject <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">String</span>; <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 检查sub-type对象</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(strObject); <span class="hljs-comment">// [object String]</span>
</code></pre>
<p>原始值"I am a String"并不是一个对象，它只是一个字面量，并且是一个不可变的值。语言会自动把字符串字面量转换成一个String对象以便对其执行一些操作，比如获取长度、访问其中某个字符等。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> strPrimitive = <span class="hljs-string">"I am a String"</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(strPrimitive.<span class="hljs-property">length</span>); <span class="hljs-comment">// 13</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(strPrimitive.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">3</span>)); <span class="hljs-comment">// "m"</span>
</code></pre>
<p>同样的事也会发生在数值字面量和布尔字面量上。</p>
<p>null和undefined没有对应的构造形式，它们只有文字形式。相反，Date只有构造，没有文字形式。</p>
<p>对于Object、Array、Function和RegExp来说，无论使用文字还是构造形式，它们都是对象，不是字面量。</p>
<p>Error对象很少在代码中显示创建，一般是在抛出异常时被自动创建。也可以使用new Error(..)来创建。</p>
<h4 data-id="heading-5">内容</h4>
<p>对象的内容是由一些存储在特地命名位置的（任意类型的）值组成的，我们称之为属性。</p>
<p>在引擎内部，属性的存储方式是多种多样的，一般并不会存在对象容器内部。存储在对象容器内部的是这些属性的名称，它们就像指针（从技术角度来说就是引用）一样，指向这些值真正的存储位置。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>,
};

myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 2</span>

myObject[<span class="hljs-string">"a"</span>]; <span class="hljs-comment">// 2</span>
</code></pre>
<p>“.a”语法通常被称为“属性访问”，“["a"]”语法通常被称为“键访问”。它们访问的都是同一个位置。</p>
<p>两种语法的主要区别为“.”操作符要求属性名满足标识符的命名规范，“[".."]”语法可以接受任意UTF-8/Unicode字符串作为属性名。</p>
<p>在对象中，属性名永远都是字符串。如果使用的是string（字面量）以外的其他值作为属性名，那它首先会被转换为一个字符串。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {};

myObject[<span class="hljs-literal">true</span>] = <span class="hljs-string">"foo"</span>;
myObject[<span class="hljs-number">3</span>] = <span class="hljs-string">"bar"</span>;
myObject[myObject] = <span class="hljs-string">"baz"</span>;

myObject[<span class="hljs-string">"true"</span>]; <span class="hljs-comment">// "foo"</span>
myObject[<span class="hljs-string">"3"</span>]; <span class="hljs-comment">// "bar"</span>
myObject[<span class="hljs-string">"[object Object]"</span>]; <span class="hljs-comment">// "baz"</span>
</code></pre>
<h5 data-id="heading-6">可计算属性名</h5>
<p>ES6 增加了可计算属性名：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> prefix = <span class="hljs-string">"foo"</span>;

<span class="hljs-keyword">var</span> myObject = {
  [prefix + <span class="hljs-string">"bar"</span>]: <span class="hljs-string">"hello"</span>,
  [prefix + <span class="hljs-string">"baz"</span>]: <span class="hljs-string">"world"</span>,
};

myObject[<span class="hljs-string">"foobar"</span>]; <span class="hljs-comment">// hello</span>
myObject[<span class="hljs-string">"foobaz"</span>]; <span class="hljs-comment">// world</span>
</code></pre>
<h5 data-id="heading-7">数组</h5>
<p>数组也支持[]访问形式。数组期望额是数值下标，也就是值存储的位置（通常被称为索引）是非负整数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myArray = [<span class="hljs-string">"foo"</span>, <span class="hljs-number">42</span>, <span class="hljs-string">"bar"</span>];

myArray.<span class="hljs-property">length</span>; <span class="hljs-comment">// 3</span>
myArray[<span class="hljs-number">0</span>]; <span class="hljs-comment">// "foo"</span>
myArray[<span class="hljs-number">2</span>]; <span class="hljs-comment">// "bar"</span>
</code></pre>
<p>数组也是对象，可以给数组添加属性（但不建议这么做）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myArray = [<span class="hljs-string">"foo"</span>, <span class="hljs-number">42</span>, <span class="hljs-string">"bar"</span>];

myArray.<span class="hljs-property">baz</span> = <span class="hljs-string">"baz"</span>;
myArray.<span class="hljs-property">length</span>; <span class="hljs-comment">// 3</span>
myArray.<span class="hljs-property">baz</span>; <span class="hljs-comment">// "baz"</span>
</code></pre>
<h5 data-id="heading-8">复制对象</h5>
<p>在JS中复制一个对象是复杂的，需要判断深复制还是浅复制。对于浅拷贝，会和旧对象使用相同的引用；对于深拷贝，存在循环引用的情况就会导致死循环。</p>
<p>许多JS框架都提出了自己的解决办法，但是JS采用的标准又不统一。</p>
<p>对于JSON安全（也就是可以被序列化为一个JSON字符串并且可以根据这个字符串解析出一个结构和值完全一样的对象）的对象来说：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> newObj = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(someObj));
</code></pre>
<p>ES6定义了Object.assign(..)方法实现浅复制：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> newObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, myObject);
</code></pre>
<h5 data-id="heading-9">属性描述符</h5>
<p>ES5之前按，JS语言本身没有提供可以直接检测属性特性的方法，比如判断属性是否是只读。</p>
<p>ES5开始，所有的属性都具备了属性描述符。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>,
};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyDescriptor</span>(myObject, <span class="hljs-string">"a"</span>);
<span class="hljs-comment">// {</span>
<span class="hljs-comment">//   value: 2,</span>
<span class="hljs-comment">//   writable: true,</span>
<span class="hljs-comment">//   enumerable: true,</span>
<span class="hljs-comment">//   configurable: true</span>
<span class="hljs-comment">// }</span>
</code></pre>
<p>如我们所见，该普通的对象属性对应的属性描述符（也被称为“数描述符”，因为它只能保存一个数据），不仅只是2。还有另外三个特性：writable（可写）、enumerable（可枚举）和configurable（可配置）。</p>
<p>我们可以使用Object.defineProperty(..)来添加一个新的属性或修改已有属性（如果它是configurable）对特性进行设置。</p>
<ol>
<li>writable
writable决定是否可以修改属性的值</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(myObject, <span class="hljs-string">"a"</span>， {
  <span class="hljs-attr">value</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">writable</span>: fasle, <span class="hljs-comment">// 不可写</span>
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
});

myObject.<span class="hljs-property">a</span> = <span class="hljs-number">3</span>;

myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 2</span>

</code></pre>
<ol start="2">
<li>configurable
只要属性是可配置的，就可以使用defineProperty(..)方法来修改属性描述符</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>
};

myObject.<span class="hljs-property">a</span> = <span class="hljs-number">3</span>;
myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 3</span>

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(myObject, <span class="hljs-string">"a"</span>， {
  <span class="hljs-attr">value</span>: <span class="hljs-number">4</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">configurable</span>: fasle <span class="hljs-comment">// 不可配置</span>
});

myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 4</span>
myObject.<span class="hljs-property">a</span> = <span class="hljs-number">5</span>;
myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 5</span>

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(myObject, <span class="hljs-string">"a"</span>， {
  <span class="hljs-attr">value</span>: <span class="hljs-number">6</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,wrai
  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
}); <span class="hljs-comment">// TypeError</span>
</code></pre>
<p>可见将configurable修改为false是单向操作，无法撤销。</p>
<blockquote>
<p>要注意一个例外，即便属性是configurable: false,还是能够将 writable 的状态由 true 改为 false，但是无法由 fasle 改为 true。</p>
</blockquote>
<p>且configurable: false 还会禁止删除这个属性：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>
};

myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 2</span>

<span class="hljs-keyword">delete</span> myObject.<span class="hljs-property">a</span>;
myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// undefined</span>

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(myObject, <span class="hljs-string">"a"</span>， {
  <span class="hljs-attr">value</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">configurable</span>: fasle <span class="hljs-comment">// 不可配置</span>
});

myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 2</span>
<span class="hljs-keyword">delete</span> myObject.<span class="hljs-property">a</span>;
myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 2</span>
</code></pre>
<ol start="3">
<li>enumerable</li>
</ol>
<p>该描述符控制属性是否会出现在对象的属性枚举中，比如for..in循环，如果设置enumerable为false，这个属性就不会出现在枚举中。</p>
<h5 data-id="heading-10">不变性</h5>
<p>有时我们希望属性或者对象是不可改变的，H5中可以通过很多方法实现，但所有的方法都是浅不变性，它们只会影响目标对象和它的直接属性。</p>
<ol>
<li>对象常量
结合 writable: false 和 configurable: fasle就可以创建一个真正的常量属性（不可修改、重新定义或者删除）：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(myObject, <span class="hljs-string">"FAVORITE_NUMBER"</span>， {
  <span class="hljs-attr">value</span>: <span class="hljs-number">42</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">configurable</span>: fasle
});
</code></pre>
<ol start="2">
<li>禁止拓展
可以使用Object.preventExtensions(..)：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>,
};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">preventExtensions</span>(myObject);

myObject.<span class="hljs-property">b</span> = <span class="hljs-number">3</span>;
myObject.<span class="hljs-property">b</span>; <span class="hljs-comment">// undefined</span>
</code></pre>
<ol start="3">
<li>
<p>密封
Object.seal(..) 会创建一个“密封”的对象，这个方法会一个在现有的对象上调用Object.preventExtensions(..)，并把所有的属性标记为configurable: false。</p>
</li>
<li>
<p>冻结
Object.freeze(..) 会创建一个“冻结”的对象，这个方法会一个在现有的对象上调用Object.seal(..)，并把所有“数据访问”属性标记为writable: false，这样旧无法修改值。</p>
</li>
</ol>
<p>该方法是我们可以应用在对象上的最高的不可变性，它会禁止对象本身及其任意直接属性的修改（不过该对象引用的其他对象是不受影响的）。</p>
<h5 data-id="heading-11">[[Get]]</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObjedt = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>,
};
myObjedt.<span class="hljs-property">a</span>; <span class="hljs-comment">// 2</span>
</code></pre>
<p>myObjedt.a通过[[Get]]操作实现对a属性的访问。对象默认的内置[[Get]]操作会首先查找是否有同名的属性，有就返回该对象的值。没有就会遍历可能存在的[[Prototype]]链，还是没找到的话就会返回undefined。</p>
<h5 data-id="heading-12">[[Put]]</h5>
<p>[[Put]]被触发时，会取决于许多因素，包括对象中是否存在这个属性。</p>
<p>如果已经存在这个属性，[[Put]]算法大致会检查下面这些内容。</p>
<ol>
<li>属性是否是访问描述符？如何是并且存在setter就调用setter。</li>
<li>属性的数据描述符中writable是否是false？如果是，在非严格模式静默失败，在严格模式抛出TypeError异常。</li>
<li>如果都不是将值设为属性的值。</li>
</ol>
<p>如果对象中不存在这个属性，[[Put]]操作会更加复制。后续详细介绍。</p>
<h5 data-id="heading-13">Getter和Setter</h5>
<p>对象默认的[[Put]]和[[Get]]操作分别可以控制属性值的设置和获取。</p>
<p>在ES5中可以使用getter和setter部分改写默认操作，但是只能应用在单个属性上，无法应用在整个对象上。getter是一个隐藏函数，会在获取属性值时调用。setter也是一个隐藏函数，会在设置属性值时调用。</p>
<p>当你给一个属性定义getter、setter 或者两者都有时，这个属性会被定义为“访问描述符”（和“数据描述符”相对）。对于访问描述符来说，JavaScript 会忽略它们的value和
writable特性，取而代之的是关心set和get（还有configurable和enumerable）特性</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-comment">// 给a定义一个getter</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">a</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
  },
};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(
  myObject, <span class="hljs-comment">// 目标对象</span>
  <span class="hljs-string">"b"</span>, <span class="hljs-comment">// 属性名</span>
  {
    <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span> * <span class="hljs-number">2</span>;
    },
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
  },
);

myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 2</span>

myObject.<span class="hljs-property">b</span>; <span class="hljs-comment">// 4</span>
</code></pre>
<p>通常getter和setter是成对出现的（只定义一个的话通常会产生意料之外的行为）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-comment">// 给a定义一个getter</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">a</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_a_</span>;
  }

  <span class="hljs-comment">// 给a定义一个setter</span>
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_a_</span> = val * <span class="hljs-number">2</span>;
  }
}

myObject.<span class="hljs-property">a</span> = <span class="hljs-number">2</span>;

myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 4</span>
</code></pre>
<h5 data-id="heading-14">存在性</h5>
<p>当myObject.a的属性访问返回值为undefined时，这个值可能时属性中存储的undefined，也可能是属性不存在而返回undefined。我们可以在不访问属性值的情况下判断对象中是否存在这个属性：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>,
};

<span class="hljs-string">"a"</span> <span class="hljs-keyword">in</span> myObject; <span class="hljs-comment">// true</span>
<span class="hljs-string">"b"</span> <span class="hljs-keyword">in</span> myObject; <span class="hljs-comment">// false</span>

myObject.<span class="hljs-title function_">hasOwnProhaperty</span>(<span class="hljs-string">"a"</span>); <span class="hljs-comment">// true</span>
myObject.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">"b"</span>); <span class="hljs-comment">// false</span>
</code></pre>
<p>in 操作符会检查属性是否在对象及其[[Prototype]]原型链中。</p>
<p>hasOwnproperty(..)只会检查属性是否在myObject对象中，不会检查[[Prototype]]链。</p>
<h6 data-id="heading-15">枚举</h6>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(
  myObject,
  <span class="hljs-string">"a"</span>,
  <span class="hljs-comment">// 让a可枚举</span>
  { <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">2</span> },
);

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(
  myObject,
  <span class="hljs-string">"b"</span>,
  <span class="hljs-comment">// 让b不可枚举</span>
  { <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">3</span> },
);

myObject.<span class="hljs-property">b</span>; <span class="hljs-comment">// 3</span>
<span class="hljs-string">"b"</span> <span class="hljs-keyword">in</span> myObject; <span class="hljs-comment">// true</span>
myObject.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">"b"</span>); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// .............</span>

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> myObject) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(k, myObject[k]);
} <span class="hljs-comment">// "a" 2</span>
</code></pre>
<p>可以看到myObject.b确实存在并且有访问值，但不会出现在for..in循环中。</p>
<p>也可以通过其他方式来区分属性是否可枚举：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(
  myObject,
  <span class="hljs-string">"a"</span>,
  <span class="hljs-comment">// 让a可枚举</span>
  { <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">2</span> },
);

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(
  myObject,
  <span class="hljs-string">"b"</span>,
  <span class="hljs-comment">// 让b不可枚举</span>
  { <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">3</span> },
);

myObject.<span class="hljs-title function_">propertyIsEnumerable</span>(<span class="hljs-string">"a"</span>); <span class="hljs-comment">// true</span>
myObject.<span class="hljs-title function_">propertyIsEnumerable</span>(<span class="hljs-string">"b"</span>); <span class="hljs-comment">// false</span>

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(myObject); <span class="hljs-comment">// ["a"]</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyNames</span>(myObject); <span class="hljs-comment">// ["a", "b"]</span>
</code></pre>
<h4 data-id="heading-16">遍历</h4>
<p>for..in 循环可以用来遍历对象的可枚举属性列表（包括[[Prototype]]链）</p>
<p>ES6中增加了 for..of 循环语法来遍历数组（如果对象本身定义了迭代器的话也可以遍历对象）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myArray = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> v <span class="hljs-keyword">of</span> myArray) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(v);
}
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
</code></pre>
<p>for..of 循环首先会向被访问对象请求一个迭代器对象，然后通过调用迭代器对象的next()方法来遍历所有返回值。</p>
<p>数组内有内置的@@iterator，因此for..of可以直接应用在数组上。我们使用内置的@@iterator来手动遍历数组，看看它是怎么工作的：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myArray = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">var</span> it = myArray[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]();

it.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// {value:1,done:false}</span>
it.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// {value:2,done:false}</span>
it.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// {value:3,done:false}</span>
it.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// {done:true}</span>
</code></pre>
<p>和数组不同，普通的对象没有内置的@@iterator，所有无法自动完成for..of遍历。之所以要这样做，有许多复杂的原因，不过简单来说这样是为了避免影响未来的对象类型。</p>
<p>我们可以给想遍历的对象定义@@iterator：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">b</span>: <span class="hljs-number">3</span>,
};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(myObject, <span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>, {
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">value</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> o = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">var</span> idx = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> ks = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(o);
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">next</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">value</span>: o[ks[idx++]],
          <span class="hljs-attr">done</span>: idx &gt; ks.<span class="hljs-property">length</span>,
        };
      },
    };
  },
});

<span class="hljs-comment">// 手动遍历myObject</span>
<span class="hljs-keyword">var</span> it = myObject[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]();
it.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// {value: 2,done: false}</span>
it.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// {value: 3,done: false}</span>
it.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// {value: undefined,done: true}</span>

<span class="hljs-comment">// 用for..of遍历myObject</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> v <span class="hljs-keyword">of</span> myObject) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(v);
}
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当 AI 学会了写博客：Cursor AI Skill 如何让你的开发效率翻倍]]></title>    <link>https://juejin.cn/post/7603383059151880234</link>    <guid>https://juejin.cn/post/7603383059151880234</guid>    <pubDate>2026-02-06T08:56:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603383059151880234" data-draft-id="7603383059151749162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当 AI 学会了写博客：Cursor AI Skill 如何让你的开发效率翻倍"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-06T08:56:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PTC"/> <meta itemprop="url" content="https://juejin.cn/user/3925713569717248"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当 AI 学会了写博客：Cursor AI Skill 如何让你的开发效率翻倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3925713569717248/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PTC
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:56:58.000Z" title="Fri Feb 06 2026 08:56:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    43
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>你有没有想过，写完代码之后，AI 自动帮你把技术博客也写了？</p>
<p>这不是幻想。我在自己的博客系统 <strong>Ink &amp; Code</strong>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fptclove.com%2F" target="_blank" title="https://ptclove.com/" ref="nofollow noopener noreferrer">ptclove.com</a>）上实现了这个能力——通过 Cursor 的 AI Skill 机制，只需一句话，AI 就能分析代码、撰写文章、一键发布。</p>
<p>本文会深入介绍 AI Skill 的实际应用，以及支撑这一切的技术架构：<strong>Next.js 16 + Prisma + Tailwind CSS 4 + Tiptap</strong>。</p>
<h2 data-id="heading-1">什么是 Cursor AI Skill</h2>
<p>AI Skill 是 Cursor IDE 提供的一种扩展机制，本质上是一份 Markdown 格式的指令文件（<code>SKILL.md</code>），告诉 AI 在特定场景下该做什么、怎么做。</p>
<p>与普通的 Prompt 不同，Skill 有几个核心优势：</p>
<ol>
<li><strong>场景触发</strong>：当用户提到"写博客"、"发布文章"时自动激活</li>
<li><strong>结构化流程</strong>：定义清晰的多步骤工作流，而不是一次性提问</li>
<li><strong>工具集成</strong>：可以调用 Shell 脚本、API 接口，实现端到端的自动化</li>
</ol>
<h2 data-id="heading-2">实战：一个自动写博客的 Skill</h2>
<p>我在项目中创建了 <code>.cursor/skills/generate-blog/SKILL.md</code>，定义了博客生成的完整流程：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">generate-blog</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">生成技术博客并发布到</span> <span class="hljs-string">Ink</span> <span class="hljs-string">&amp;</span> <span class="hljs-string">Code</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment"># 生成博客文章</span>

<span class="hljs-comment">## 工作流程</span>

<span class="hljs-comment">### 1. 确定生成模式</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">commit</span> <span class="hljs-string">模式：根据</span> <span class="hljs-string">Git</span> <span class="hljs-string">提交改动生成</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">topic</span> <span class="hljs-string">模式：根据特定主题生成</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">repo</span> <span class="hljs-string">模式：介绍整个项目</span>

<span class="hljs-comment">### 2. 收集上下文</span>
<span class="hljs-string">根据模式收集相关代码上下文...</span>

<span class="hljs-comment">### 3. 生成博客内容</span>
<span class="hljs-string">撰写高质量技术博客，包含背景、方案、实现、总结...</span>

<span class="hljs-comment">### 4. 发布文章</span>
<span class="hljs-string">使用脚本发布到博客系统：</span>
</code></pre>
<p>关键在于第 4 步——Skill 不仅能生成内容，还能通过 Shell 脚本直接发布：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># publish.sh - 一键发布到博客</span>
TITLE=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
TAGS=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>

<span class="hljs-comment"># 读取内容（支持文件、stdin、剪贴板）</span>
<span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$CONTENT_FILE</span>"</span> ] &amp;&amp; [ -f <span class="hljs-string">"<span class="hljs-variable">$CONTENT_FILE</span>"</span> ]; <span class="hljs-keyword">then</span>
    CONTENT=$(<span class="hljs-built_in">cat</span> <span class="hljs-string">"<span class="hljs-variable">$CONTENT_FILE</span>"</span>)
<span class="hljs-keyword">elif</span> [ ! -t 0 ]; <span class="hljs-keyword">then</span>
    CONTENT=$(<span class="hljs-built_in">cat</span>)
<span class="hljs-keyword">else</span>
    CONTENT=$(pbpaste 2&gt;/dev/null || <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>)
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 构建 JSON 并调用 API</span>
jq -n --arg title <span class="hljs-string">"<span class="hljs-variable">$TITLE</span>"</span> --arg content <span class="hljs-string">"<span class="hljs-variable">$CONTENT</span>"</span> \
  <span class="hljs-string">'{title: $title, content: $content, published: false}'</span> \
  &gt; /tmp/blog_payload.json

curl -X POST <span class="hljs-string">"<span class="hljs-variable">${INK_AND_CODE_URL}</span>/api/article/create-from-commit"</span> \
  -H <span class="hljs-string">"Authorization: Bearer <span class="hljs-variable">$INK_AND_CODE_TOKEN</span>"</span> \
  -d @/tmp/blog_payload.json
</code></pre>
<p>这意味着从代码变更到文章发布，整个链路都是自动化的。</p>
<h2 data-id="heading-3">更进一步：GitHub Actions + AI 自动发文</h2>
<p>除了本地 Skill，我还配置了 GitHub Actions 实现 CI/CD 级别的博客自动化：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/auto-blog.yml</span>
<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">generate-blog:</span>
    <span class="hljs-comment"># 只有提交信息包含 [blog] 时才触发</span>
    <span class="hljs-attr">if:</span> <span class="hljs-string">contains(github.event.head_commit.message,</span> <span class="hljs-string">'[blog]'</span><span class="hljs-string">)</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Gather</span> <span class="hljs-string">project</span> <span class="hljs-string">context</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          git diff HEAD~1 HEAD &gt; /tmp/commit_diff.txt
          # 收集项目结构、改动文件、配置文件...
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Generate</span> <span class="hljs-string">and</span> <span class="hljs-string">publish</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 将上下文发送给 AI，生成博客
          # 解析标题、内容、标签
          # 调用 API 发布
</span></code></pre>
<p><strong>工作原理</strong>：当我提交代码时，在 commit message 中加上 <code>[blog]</code> 标记，GitHub Actions 会自动收集项目上下文（diff、文件结构、配置文件），调用 DeepSeek/Claude/GPT 生成技术博客，最后通过 API 发布到网站。</p>
<p>整个过程无需人工干预，写完代码，博客就自动出现在网站上了。</p>
<h2 data-id="heading-4">支撑一切的技术架构</h2>
<p>这套自动化能跑通，离不开底层的技术架构。Ink &amp; Code 采用的是 <strong>Next.js 16 + Prisma + Tailwind CSS 4 + Tiptap</strong> 的组合。</p>
<h3 data-id="heading-5">Next.js 16 App Router</h3>
<p>项目使用 Next.js 16 的 App Router 架构，目录结构清晰：</p>
<pre><code class="hljs language-ini" lang="ini">app/
├── api/          <span class="hljs-comment"># API 路由</span>
│   ├── article/  <span class="hljs-comment"># 文章 CRUD</span>
│   ├── chat/     <span class="hljs-comment"># AI 聊天</span>
│   └── auth/     <span class="hljs-comment"># 认证</span>
├── admin/        <span class="hljs-comment"># 后台管理</span>
├── blog/         <span class="hljs-comment"># 博客页面</span>
├── components/   <span class="hljs-comment"># 组件</span>
└── u/<span class="hljs-section">[username]</span>/ <span class="hljs-comment"># 用户主页</span>
</code></pre>
<p>API 路由提供了完整的 RESTful 接口，支持两种认证方式：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// Session 认证（用户登录）</span>
<span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> auth();

<span class="hljs-comment">// Token 认证（外部调用，如 GitHub Actions）</span>
<span class="hljs-keyword">const</span> token = request.headers
  .<span class="hljs-keyword">get</span>(<span class="hljs-string">'Authorization'</span>)?.replace(<span class="hljs-string">'Bearer '</span>, <span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> hashedToken = hashToken(token);
<span class="hljs-keyword">const</span> apiToken = <span class="hljs-keyword">await</span> prisma.apiToken.findUnique({
  <span class="hljs-keyword">where</span>: { tokenHash: hashedToken }
});
</code></pre>
<p>这种双认证机制让博客系统既支持浏览器登录，又支持脚本和 CI/CD 的外部调用。</p>
<h3 data-id="heading-6">Prisma 数据建模</h3>
<p>数据层使用 Prisma ORM，核心模型设计：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">model Post {
  id         String    <span class="hljs-meta">@id</span> <span class="hljs-meta">@default(cuid())</span>
  title      String
  slug       String
  content    String    <span class="hljs-meta">@db</span>.Text  <span class="hljs-comment">// TipTap JSON</span>
  excerpt    String?
  coverImage String?
  published  <span class="hljs-built_in">Boolean</span>   <span class="hljs-meta">@default(false)</span>
  tags       String[]
  sortOrder  <span class="hljs-built_in">Int</span>       <span class="hljs-meta">@default(0)</span>

  user       User      <span class="hljs-meta">@relation(fields: [userId])</span>
  category   Category? <span class="hljs-meta">@relation(fields: [categoryId])</span>

  @<span class="hljs-meta">@unique([userId, slug])</span>
}

model Category {
  id       String     <span class="hljs-meta">@id</span> <span class="hljs-meta">@default(cuid())</span>
  name     String
  slug     String
  icon     String?
  parentId String?    <span class="hljs-comment">// 树形结构</span>
  parent   Category?  <span class="hljs-meta">@relation(<span class="hljs-string">"children"</span>, fields: [parentId])</span>
  children Category[] <span class="hljs-meta">@relation(<span class="hljs-string">"children"</span>)</span>

  @<span class="hljs-meta">@unique([userId, slug])</span>
}
</code></pre>
<p>文章内容以 TipTap JSON 格式存储，而非原始 Markdown。这意味着从外部（如 GitHub Actions）提交的 Markdown 内容需要经过转换：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// lib/markdown-to-tiptap.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">markdownToTiptap</span>(<span class="hljs-params">markdown: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">doc</span>: <span class="hljs-title class_">TiptapDoc</span> = { <span class="hljs-attr">type</span>: <span class="hljs-string">'doc'</span>, <span class="hljs-attr">content</span>: [] };
  <span class="hljs-keyword">const</span> lines = markdown.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);

  <span class="hljs-keyword">while</span> (i &lt; lines.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">const</span> line = lines[i];
    <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'```'</span>)) {
      <span class="hljs-comment">// 代码块 → codeBlock 节点</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^#{1,6}\s/</span>)) {
      <span class="hljs-comment">// 标题 → heading 节点</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^\d+.\s/</span>)) {
      <span class="hljs-comment">// 有序列表 → orderedList 节点</span>
    }
    <span class="hljs-comment">// ...更多格式处理</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(doc);
}
</code></pre>
<h3 data-id="heading-7">Tiptap 富文本编辑器</h3>
<p>后台管理使用 Tiptap 作为编辑器，支持丰富的内容格式：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> editor = <span class="hljs-built_in">useEditor</span>({
  extensions: [
    StarterKit,
    CodeBlockLowlight.<span class="hljs-built_in">configure</span>({
      lowlight  <span class="hljs-comment">// 代码高亮</span>
    }),
    Image,           <span class="hljs-comment">// 图片</span>
    Link,            <span class="hljs-comment">// 链接</span>
    Table,           <span class="hljs-comment">// 表格</span>
    Placeholder.<span class="hljs-built_in">configure</span>({
      placeholder: <span class="hljs-string">'开始写作...'</span>
    }),
  ],
});
</code></pre>
<p>编辑器还实现了自动保存、快捷键（Cmd+S）、图片上传（阿里云 OSS）等实用功能。</p>
<h3 data-id="heading-8">Tailwind CSS 4</h3>
<p>样式层使用最新的 Tailwind CSS 4，通过 CSS 变量实现主题切换：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--color-primary</span>: <span class="hljs-number">#b8860b</span>;
  <span class="hljs-attr">--color-background</span>: <span class="hljs-number">#faf8f5</span>;
  <span class="hljs-attr">--color-foreground</span>: <span class="hljs-number">#1a1a1a</span>;
}

<span class="hljs-selector-attr">[data-theme=<span class="hljs-string">'dark'</span>]</span> {
  <span class="hljs-attr">--color-primary</span>: <span class="hljs-number">#d4a537</span>;
  <span class="hljs-attr">--color-background</span>: <span class="hljs-number">#1a1a1a</span>;
  <span class="hljs-attr">--color-foreground</span>: <span class="hljs-number">#e8e8e8</span>;
}
</code></pre>
<p>配合 ThemeProvider 组件，实现了丝滑的明暗主题切换。</p>
<h2 data-id="heading-9">Ink &amp; Code 核心功能一览</h2>
<p>除了上面提到的技术架构，<a href="https://link.juejin.cn?target=https%3A%2F%2Fptclove.com%2F" target="_blank" title="https://ptclove.com/" ref="nofollow noopener noreferrer">ptclove.com</a> 还有这些核心功能：</p>
<ul>
<li><strong>AI 助手</strong>：内置 AI 聊天组件，基于 DeepSeek 实时流式响应，随时提问</li>
<li><strong>智能目录</strong>：自动从文章标题生成目录树，支持大标题折叠子标题、滚动高亮、点击跳转</li>
<li><strong>分类体系</strong>：支持树形分类结构，多层级管理文章</li>
<li><strong>文档树管理</strong>：后台采用树形文档管理，拖拽排序，所见即所得</li>
<li><strong>多用户支持</strong>：每个用户有独立主页（<code>/u/username</code>），独立分类和文章</li>
<li><strong>深色模式</strong>：跟随系统或手动切换，全站适配</li>
<li><strong>响应式设计</strong>：从手机到桌面端完美适配</li>
<li><strong>一键部署</strong>：GitHub Actions 自动构建、SSH 部署到服务器，PM2 进程管理</li>
</ul>
<h2 data-id="heading-10">总结</h2>
<p>Cursor AI Skill 的价值不在于它是一个多高深的技术，而在于它提供了一种思路：<strong>让 AI 不只是回答问题，而是融入你的工作流</strong>。</p>
<p>在 Ink &amp; Code 这个项目中，AI Skill 串联了从代码提交到博客发布的完整链路。而 Next.js + Prisma + Tiptap + Tailwind 这套技术栈，则提供了足够灵活的底层能力来支撑这种自动化。</p>
<p>如果你也想体验 AI 驱动的博客写作，欢迎访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fptclove.com%2F" target="_blank" title="https://ptclove.com/" ref="nofollow noopener noreferrer">ptclove.com</a> ，也欢迎在评论区交流你的 AI Skill 实践。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android稀奇古怪DNS异常之DNS数据获取]]></title>    <link>https://juejin.cn/post/7603383059152044074</link>    <guid>https://juejin.cn/post/7603383059152044074</guid>    <pubDate>2026-02-06T09:09:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603383059152044074" data-draft-id="7603301285476188202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android稀奇古怪DNS异常之DNS数据获取"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-02-06T09:09:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="没有了遇见"/> <meta itemprop="url" content="https://juejin.cn/user/1521379826212983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android稀奇古怪DNS异常之DNS数据获取
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379826212983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    没有了遇见
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:09:11.000Z" title="Fri Feb 06 2026 09:09:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b71a09fcc8a54a0e8e1f0b68a18444bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5pyJ5LqG6YGH6KeB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973751&amp;x-signature=6FfG0n8Y0Ap8O8FjFUtGbTV7wEs%3D" alt="image.png" loading="lazy"/></p>
<p>接着处理稀奇古怪问题之DNS异常导致网络不通!!!!</p>
<p>部分用户访问不通,后台说DNS问题,这不需求就来了.要求Android 搜集DNS数据,方便后台查询.....</p>
<h2 data-id="heading-0">需求:获取DNS数据和后台相应数据</h2>
<h2 data-id="heading-1">思路</h2>
<ul>
<li>获取网络配置中的DNS配置</li>
<li>获取网络请求时的DNS/HOST/响应的数据</li>
</ul>
<h2 data-id="heading-2">1:获取网络配置的DNS数据</h2>
<p><code>注意:</code></p>
<p>需要<code>&lt;uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/&gt;</code> 权限</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 获取当前 WiFi 路由器或系统 DNS 服务器列表
 * <span class="hljs-doctag">@param</span> context Context
 * <span class="hljs-doctag">@return</span> List&lt;String&gt; DNS IP 列表
 */</span>


<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getDnsServers</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: List&lt;String&gt; {
    <span class="hljs-keyword">val</span> connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE) <span class="hljs-keyword">as</span> ConnectivityManager
    <span class="hljs-keyword">val</span> activeNetwork = connectivityManager.activeNetwork ?: <span class="hljs-keyword">return</span> emptyList()
    <span class="hljs-keyword">val</span> linkProperties = connectivityManager.getLinkProperties(activeNetwork) ?: <span class="hljs-keyword">return</span> emptyList()

    <span class="hljs-comment">// 获取 InetAddress 列表并转换为字符串</span>
    <span class="hljs-keyword">return</span> linkProperties.dnsServers.map { formatDnsType(it)}
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">formatDnsType</span><span class="hljs-params">(addr: <span class="hljs-type">InetAddress</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> type = <span class="hljs-keyword">when</span> (addr) {
        <span class="hljs-keyword">is</span> Inet4Address -&gt; <span class="hljs-string">"ipv4--&gt; "</span>
        <span class="hljs-keyword">is</span> Inet6Address -&gt; <span class="hljs-string">"ipv6--&gt; "</span>
        <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"unknown--&gt; "</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">"<span class="hljs-variable">$type</span>:<span class="hljs-subst">${addr.hostAddress}</span>"</span>
}
</code></pre>
<h2 data-id="heading-3">2:获取网络请求的响应以及DNS数据</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">DnsCheckCallback</span> {
    <span class="hljs-comment">/** 域名解析结果 */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDnsResolved</span><span class="hljs-params">(hostname: <span class="hljs-type">String</span>, ipList: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span>

    <span class="hljs-comment">/** HTTP 请求响应 */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onHttpResponse</span><span class="hljs-params">(code: <span class="hljs-type">Int</span>, body: <span class="hljs-type">String</span>)</span></span>

    <span class="hljs-comment">/** 请求或解析失败 */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(t: <span class="hljs-type">Throwable</span>)</span></span>
}

<span class="hljs-comment">/**
 * 使用系统 DNS 请求指定 URL 并通过回调返回 DNS 和 HTTP 信息
 * <span class="hljs-doctag">@param</span> url 请求的完整 URL，例如 https://xxx.xx.com  测试的域名
 * <span class="hljs-doctag">@param</span> callback 回调
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkDns</span><span class="hljs-params">(
    url: <span class="hljs-type">String</span>,
    callback: <span class="hljs-type">DnsCheckCallback</span>
)</span></span> {
    <span class="hljs-keyword">val</span> client = OkHttpClient.Builder()
        .dns(<span class="hljs-keyword">object</span> : Dns {
            <span class="hljs-meta">@Throws(UnknownHostException::class)</span>
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">lookup</span><span class="hljs-params">(hostname: <span class="hljs-type">String</span>)</span></span>: List&lt;InetAddress&gt; {
                <span class="hljs-keyword">val</span> addresses = Dns.SYSTEM.lookup(hostname)

                <span class="hljs-comment">// 回调 DNS 解析结果</span>
                <span class="hljs-keyword">val</span> ipList = addresses.map { hostname+<span class="hljs-string">" ---&gt; "</span>+formatDnsType(it) }
                callback.onDnsResolved(hostname, ipList)

                <span class="hljs-keyword">return</span> addresses
            }
        })
        .build()

    <span class="hljs-keyword">val</span> request = Request.Builder()
        .url(url)
        .<span class="hljs-keyword">get</span>()
        .build()

    client.newCall(request).enqueue(<span class="hljs-keyword">object</span> : Callback {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, e: <span class="hljs-type">IOException</span>)</span></span> {
            callback.onFailure(e)
        }

        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, response: <span class="hljs-type">Response</span>)</span></span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> body = response.body?.string() ?: <span class="hljs-string">""</span>
                callback.onHttpResponse(response.code, body)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                callback.onFailure(e)
            }
        }
    })
}
</code></pre>
<h2 data-id="heading-4">3: 获取工具</h2>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.net.ConnectivityManager
<span class="hljs-keyword">import</span> android.net.wifi.WifiManager
<span class="hljs-keyword">import</span> android.os.Build
<span class="hljs-keyword">import</span> android.util.Log
<span class="hljs-keyword">import</span> okhttp3.*
<span class="hljs-keyword">import</span> java.io.IOException
<span class="hljs-keyword">import</span> java.net.Inet4Address
<span class="hljs-keyword">import</span> java.net.Inet6Address
<span class="hljs-keyword">import</span> java.net.InetAddress
<span class="hljs-keyword">import</span> java.net.UnknownHostException

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Author</span>: wkq
 * <span class="hljs-doctag">@Time</span>: 2026/2/6 12:15
 * <span class="hljs-doctag">@Desc</span>: 使用 OkHttp 请求指定 URL 并通过回调返回 DNS 和 HTTP 信息（简化版，只用系统 DNS）
 */</span>
<span class="hljs-keyword">object</span> DnsCheckUtil {

    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DnsCheckCallback</span> {
        <span class="hljs-comment">/** 域名解析结果 */</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDnsResolved</span><span class="hljs-params">(hostname: <span class="hljs-type">String</span>, ipList: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span>

        <span class="hljs-comment">/** HTTP 请求响应 */</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onHttpResponse</span><span class="hljs-params">(code: <span class="hljs-type">Int</span>, body: <span class="hljs-type">String</span>)</span></span>

        <span class="hljs-comment">/** 请求或解析失败 */</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(t: <span class="hljs-type">Throwable</span>)</span></span>
    }

    <span class="hljs-comment">/**
     * 使用系统 DNS 请求指定 URL 并通过回调返回 DNS 和 HTTP 信息
     * <span class="hljs-doctag">@param</span> url 请求的完整 URL，例如
     * <span class="hljs-doctag">@param</span> callback 回调
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkDns</span><span class="hljs-params">(
        url: <span class="hljs-type">String</span>,
        callback: <span class="hljs-type">DnsCheckCallback</span>
    )</span></span> {
        <span class="hljs-keyword">val</span> client = OkHttpClient.Builder()
            .dns(<span class="hljs-keyword">object</span> : Dns {
                <span class="hljs-meta">@Throws(UnknownHostException::class)</span>
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">lookup</span><span class="hljs-params">(hostname: <span class="hljs-type">String</span>)</span></span>: List&lt;InetAddress&gt; {
                    <span class="hljs-keyword">val</span> addresses = Dns.SYSTEM.lookup(hostname)

                    <span class="hljs-comment">// 回调 DNS 解析结果</span>
                    <span class="hljs-keyword">val</span> ipList = addresses.map { hostname+<span class="hljs-string">" ---&gt; "</span>+formatDnsType(it) }
                    callback.onDnsResolved(hostname, ipList)

                    <span class="hljs-keyword">return</span> addresses
                }
            })
            .build()

        <span class="hljs-keyword">val</span> request = Request.Builder()
            .url(url)
            .<span class="hljs-keyword">get</span>()
            .build()

        client.newCall(request).enqueue(<span class="hljs-keyword">object</span> : Callback {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, e: <span class="hljs-type">IOException</span>)</span></span> {
                callback.onFailure(e)
            }

            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, response: <span class="hljs-type">Response</span>)</span></span> {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> body = response.body?.string() ?: <span class="hljs-string">""</span>
                    callback.onHttpResponse(response.code, body)
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    callback.onFailure(e)
                }
            }
        })
    }


    <span class="hljs-comment">/**
     * 获取当前 WiFi 路由器或系统 DNS 服务器列表
     * <span class="hljs-doctag">@param</span> context Context
     * <span class="hljs-doctag">@return</span> List&lt;String&gt; DNS IP 列表
     */</span>


    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getDnsServers</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: List&lt;String&gt; {
        <span class="hljs-keyword">val</span> connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE) <span class="hljs-keyword">as</span> ConnectivityManager
        <span class="hljs-keyword">val</span> activeNetwork = connectivityManager.activeNetwork ?: <span class="hljs-keyword">return</span> emptyList()
        <span class="hljs-keyword">val</span> linkProperties = connectivityManager.getLinkProperties(activeNetwork) ?: <span class="hljs-keyword">return</span> emptyList()

        <span class="hljs-comment">// 获取 InetAddress 列表并转换为字符串</span>
        <span class="hljs-keyword">return</span> linkProperties.dnsServers.map { formatDnsType(it)}
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">formatDnsType</span><span class="hljs-params">(addr: <span class="hljs-type">InetAddress</span>)</span></span>: String {
        <span class="hljs-keyword">val</span> type = <span class="hljs-keyword">when</span> (addr) {
            <span class="hljs-keyword">is</span> Inet4Address -&gt; <span class="hljs-string">"ipv4--&gt; "</span>
            <span class="hljs-keyword">is</span> Inet6Address -&gt; <span class="hljs-string">"ipv6--&gt; "</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"unknown--&gt; "</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">"<span class="hljs-variable">$type</span>:<span class="hljs-subst">${addr.hostAddress}</span>"</span>
    }

}
</code></pre>
<h2 data-id="heading-5">总结</h2>
<p>DNS污染/VPN/运营商拉黑都会导致域名指向不对,这种问题需要前后端配合处理,暂时只进展到了DNS数据查询,后续有处理的相关进展会伴随更新</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MaxCompute Autoscale自动弹性功能上线：资源随需而动，成本精打细算]]></title>    <link>https://juejin.cn/post/7603308967125942272</link>    <guid>https://juejin.cn/post/7603308967125942272</guid>    <pubDate>2026-02-06T09:12:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603308967125942272" data-draft-id="7603355275257708584" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MaxCompute Autoscale自动弹性功能上线：资源随需而动，成本精打细算"/> <meta itemprop="keywords" content="大数据,人工智能"/> <meta itemprop="datePublished" content="2026-02-06T09:12:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MaxCompute Autoscale自动弹性功能上线：资源随需而动，成本精打细算
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:12:09.000Z" title="Fri Feb 06 2026 09:12:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在云原生数据仓库的演进过程中，如何在<strong>保障作业SLA</strong>与<strong>优化资源成本</strong>之间取得平衡，始终是用户关注的核心问题。传统静态资源配置模式难以应对现代数据作业中普遍存在的<strong>突发性、非周期性、不可预测性</strong>负载特征。</p>
<p>MaxCompute 全新推出 <strong>自动弹性（Autoscale）功能</strong>——基于实时负载感知的秒级弹性扩缩容机制，结合按量计费模型，实现计算资源供给与业务需求的动态对齐。</p>
<h2 data-id="heading-0">一、背景：从静态预留到智能弹性</h2>
<p>过去，MaxCompute 用户主要依赖 <strong>包年包月预留资源</strong>：稳定可靠，但缺乏灵活性；面对突发需求，只能提前大量采购，造成大量闲置。</p>
<p>后来，基于推出的<strong>弹性预留</strong> 模式：用户可自定义时间计划和扩缩规则，适用于有明显周期性波动的场景（如每天凌晨跑批）。但这也要求用户具备较强的运维能力，且难以应对突发或不规则的负载变化。</p>
<p>现在，MaxCompute 全新推出 <strong>自动弹性（Autoscale）功能</strong> —— 通过系统的负载感知与调度策略，实现“无感扩缩”，填补了<strong>非稳态、高动态</strong>场景下的资源管理空白，真正做到“用多少，付多少”。</p>





























<table><thead><tr><th><strong>资源类型</strong></th><th><strong>扩缩机制</strong></th><th><strong>计费模型</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td>包年包月预留</td><td>固定CU，长期持有</td><td>为购买量付费</td><td>负载稳定、无波动</td></tr><tr><td>弹性预留</td><td>用户自定义时间/CU规则扩缩</td><td>按用户分时配置的固定CU量计费</td><td>周期性波动、峰谷可预测、用户有精细化配置经验</td></tr><tr><td><strong>自动弹性</strong></td><td><strong>系统实时感知负载后自动扩缩容</strong></td><td><strong>按实际用量和使用时长付费</strong></td><td><strong>波动频繁、不可预测，追求成本效率</strong></td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cbbfef6d0ef43208687820584bf3eb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973929&amp;x-signature=YN8OMbza5jn8v5DuTU0UMJ6gFCg%3D" alt="5eecdaf48460cde50899366ff2de297027d88596f71c45df75b8339e1c4c2483d73fcbd75708105f8d68742cd653602a15464a86392b1bf5bbb40cca91051d59fb518341bbcfc52040cf883a4fe865182fc27d1bdab16641220e3dd3b60b5d1e.png" loading="lazy"/></p>
<p>三者可组合使用：以包年包月为基础保障，弹性预留应对可预测高峰，自动弹性兜底突发流量，构建MaxCompute Serverless 弹性资源体系。</p>
<h2 data-id="heading-1">二、自动弹性核心优势</h2>
<h3 data-id="heading-2">1. 开箱即用，低运维负担</h3>
<ul>
<li>
<p>用户只需设置 <code>AutoscaleLimitCU</code>（自动弹性上限），系统自动完成扩缩决策；</p>
</li>
<li>
<p>支持一级/二级 Quota 粒度配置，二级 Quota 共享一级自动弹性CU资源池，自动分配。</p>
</li>
</ul>
<h3 data-id="heading-3">2. 按需供给，按量计费</h3>
<ul>
<li>
<p>仅对实际使用的自动弹性CU（<code>AutoscaleUsedCU</code>）用量按秒计量，按小时统计出账；</p>
</li>
<li>
<p>单价：<strong>0.36元 / (CU·时)</strong>，无需预付，无最低消费。</p>
</li>
</ul>
<h3 data-id="heading-4">3. 秒级响应，保障作业SLA</h3>
<ul>
<li>
<p>相比小时级调度窗口，自动弹性支持<strong>秒级资源调整</strong>，有效应对突发作业排队；</p>
</li>
<li>
<p>后端基于历史负载与预测模型优化库存保障和资源调度，提升弹性资源可用性。</p>
</li>
</ul>
<p>⚠️ 注意：自动弹性依赖实时资源库存，无法100%保证极端突发场景下的资源可达性。对于强SLA要求场景（如大促），建议<strong>同步配置弹性预留</strong>作为资源兜底。</p>
<h2 data-id="heading-5">三、真实场景案例</h2>
<h3 data-id="heading-6">场景一：突发业务高峰下的作业SLA保障</h3>
<p>某电商平台客户，日常使用 <strong>50 CU 包年包月Quota</strong>，足以支撑日常数据加工分析任务。但每逢大促，作业量激增3倍，原有资源严重不足，作业排队超2小时，严重影响数据产出时效。</p>
<p>客户曾评估扩容包年包月Quota至150 CU，但大促仅占全年不到20%的时间，全年多花<strong>约18万元</strong>，长期持有高配资源性价比极低。</p>
<p><strong>启用 Autoscale 后</strong>：</p>
<ul>
<li>
<p>设置 自动弹性上限 AutoscaleLimit 为 <strong>100 CU</strong>（即最多可额外使用100 CU自动弹性CU）</p>
</li>
<li>
<p>系统在检测到作业队列积压后，<strong>秒级自动扩容，</strong> 动态将可用CU提升至140CU（50 CU包年包月 + 90CU自动弹性），作业完成时间恢复至30分钟内，满足业务SLA要求；</p>
</li>
</ul>
<p>“以前不敢做大促实时分析，现在敢了，而且花得更少！” —— 客户反馈</p>
<h3 data-id="heading-7">场景二：替代分时弹性，实现降本增效</h3>
<p>某金融客户每日需执行大量 T+1 批处理任务，用于全量交易对账、监管报送数据聚合等，长期采用 <strong>分时弹性预留策略</strong>：每日22:00–6:00 时段将 Quota 从 包月预留 50 CU 扩容至 100 CU。</p>
<p>但时常因业务活动、节假日调休、系统割接活上游产出延迟等，常出现“资源空转”或“容量不足”并存的问题，运维团队需频繁调整弹性计划，但人工干预滞后性强，且易出错。</p>
<p><strong>切换至 Autoscale 后</strong>：</p>
<ul>
<li>
<p>设置自动弹性上限 AutoscaleLimitCU 为 <strong>60 CU</strong> ，允许系统在 50 – 110 CU 范围内动态扩缩；</p>
</li>
<li>
<p>系统根据实际作业队列动态调整弹性CU，夜间平均仅使用 <strong>30 CU</strong> 自动弹性资源；</p>
</li>
<li>
<p>月度弹性费用从分时弹性CU <strong>3780元</strong> （50CU *0.315元/CU*8小时*30天）降至 <strong>2592元</strong>（30CU *0.36元/CU*小时*8小时*30天），<strong>降本32%</strong>，且作业完成时间更稳定。</p>
</li>
</ul>
<p>“不用再熬夜调配置了，系统自己会‘看饭下菜’！” —— 运维工程师点赞</p>
<h2 data-id="heading-8">四、快速启用</h2>
<h3 data-id="heading-9">概念说明</h3>
<p>自动弹性上限CU（AutoscalelimitCU）：指用户为Quota设置的弹性CU资源总上限。当该值 &gt; 0 时，则为启用自动弹性功能，系统可在此上限范围内按实际负载自动扩缩容。自动弹性使用CU（AutoscaleUsedCU）：指在启用自动弹性后，Quota中实际消耗的自动弹性CU资源使用量。系统将根据作业负载自动调整CU用量，并按此实际CU使用量计费。</p>
<h3 data-id="heading-10">使用须知</h3>
<p><strong>前提条件</strong>：必须已购买<strong>包年包月计算资源Quota</strong>；<strong>计费单位</strong>：CU·时，按秒采样、按小时聚合；<strong>自动弹性CU价格</strong>：0.36元 /(CU*时)；<strong>计费公式：</strong> 每小时的费用 = 该小时自动弹性CU用量（单位：CU*时）× 自动弹性CU价格。</p>
<h3 data-id="heading-11">谁适合用自动弹性？</h3>
<p>✅ <strong>业务负载波动频繁、难以预测</strong>（如营销活动、临时分析）
✅ <strong>希望保障作业性能，同时避免资源浪费</strong>
✅ <strong>已有包年包月Quota，想进一步补充/优化弹性资源</strong></p>
<p>登录 MaxCompute 控制台 → Quota管理 → 编辑基础配置 → 设置 <strong>AutoscaleLimitCU</strong></p>
<p>即可开启智能弹性之旅！</p>
<p>更多说明文档请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fmaxcompute%2Fuse-cases%2Fauto-elastic-usage-best-practices%3Fspm%3Da2c4g.11174283.help-menu-search-27797.d_0" target="_blank" title="https://help.aliyun.com/zh/maxcompute/use-cases/auto-elastic-usage-best-practices?spm=a2c4g.11174283.help-menu-search-27797.d_0" ref="nofollow noopener noreferrer">help.aliyun.com/zh/maxcompu…</a></p>
<h2 data-id="heading-12">五、总结</h2>
<p>自动弹性不是简单的“资源扩容”，而是 MaxCompute 在<strong>智能调度、成本治理、SLA保障</strong>三位一体方向上的重要演进。它让资源管理从“静态规划”走向“动态协同”，真正实现“<strong>用多少，付多少；要多少，给多少</strong>”。</p>
<p>欢迎您的试用并反馈您的生产实践。我们将持续优化弹性调度算法与资源保障能力，助力企业构建更高效、更经济的云原生数据基础设施。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI时代的开发者，需要的是“判断空间”]]></title>    <link>https://juejin.cn/post/7603309951227461682</link>    <guid>https://juejin.cn/post/7603309951227461682</guid>    <pubDate>2026-02-06T09:13:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951227461682" data-draft-id="7603359026711314442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI时代的开发者，需要的是“判断空间”"/> <meta itemprop="keywords" content="后端,前端,程序员"/> <meta itemprop="datePublished" content="2026-02-06T09:13:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="东东拿铁"/> <meta itemprop="url" content="https://juejin.cn/user/3808364011728392"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI时代的开发者，需要的是“判断空间”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364011728392/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    东东拿铁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:13:59.000Z" title="Fri Feb 06 2026 09:13:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">引言</h3>
<p>在AI进展突飞猛进的今天，我的工作方式已经悄悄发生了许多改变。</p>
<p>比如，我花在“写代码”上的时间在变的越来越少，花在“判断方向、判断结果、判断是否符合预期”上的时间，却在明显变多。</p>
<p>代码本身，已经不再是最消耗精力的部分。</p>
<p>真正让人感到疲惫的，是不断地确认：</p>
<p>AI 给出的东西，是不是我想要的那个方向。</p>
<p>也正是在这样的工作状态下，我开始重新审视一些以前习以为常的工具——</p>
<p>比如，一台每天陪我坐在桌子前的显示器。</p>
<h3 data-id="heading-1">当“看”成为主要工作，屏幕就不再是背景</h3>
<p>在 AI 参与开发之后，我花在“看”上的时间，远比以前多。</p>
<p>看模型生成的代码结构是否合理，看逻辑有没有在某个分支上走偏，看它是不是在解决我真正想解决的问题。</p>
<p>在这个过程中，屏幕不再只是一个承载代码的背景，而是我理解信息的第一道过滤器。</p>
<p>如果屏幕本身在颜色、反光、层级上给我制造干扰，那判断就会变得更慢，也更容易出错。</p>
<p>这次我体验到了BenQ RD280UG这款产品，就是一台专为开发者设计的显示器：</p>
<p>3:2 的屏幕比例，把更多空间留给阅读和判断；针对深色、浅色 IDE 的专业编程模式，让代码层级更容易被识别；这次还升级了编程-彩纸模式和120Hz的高刷，让反复查看、对照不那么疲惫；</p>
<p>这些特性在 AI 时代，当“判断”成为我们的主要工作时，我发现它们开始变得很重要。</p>
<h3 data-id="heading-2">编程模式，其实是为“判断”服务的</h3>
<p>BenQ RD280UG提供了编程专用的色彩模式，针对高频使用的Idea、Vs Code等IDE主题环境，提供了深色、亮色两种主题模式。</p>
<p>在编程模式下，通过智能优化语法高亮，对多种代码元素进行色温，色彩，对比度的专项优化，极大的凸现了代码字符清晰度，提高代码区分度。</p>
<p>在面对 AI 生成的代码时，让不同层级的信息，在第一眼就能被区分出来，在当下的开发模式下，正在变得越来越重要。</p>
<p>我现在还不能完全信任AI的代码，因此需要快速判断：</p>
<ul>
<li>哪一段是关键逻辑</li>
<li>哪些地方需要我进一步介入</li>
</ul>
<p>也正是在这样的工作状态下，我重新理解了所谓的“编程模式”。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0aeee4b52aa451ba53a614fbdff054e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974039&amp;x-signature=Cqj5KTI5ldekYKWcjCK2LAHBAxI%3D" alt="2E0ED2A5-C2E1-4252-AD5E-72A871182CF6.jpg" loading="lazy"/>
(左侧是开启深色主题，右侧是不开深色主题)</p>
<p>当屏幕能够针对深色、浅色 IDE 做出适配，强化语义和结构差异时，判断这件事本身，就会变得更直接一些。</p>
<p>不是更快，而是更少绕路。</p>
<p>在AI时代，分屏工作已经成为了常态。</p>
<p>或许是一边看着文档，一边用大模型进行提问和总结，也可能是一边开着IDE开发，另一侧打开系统实时调试。</p>
<p>BenQ RD280UG采用3:2的屏幕比例，相比传统的16:9比例，提供了更大的垂直空间，能够在同一时间多显示约20%的内容， 非常适合编程和代码阅读。据我实际计算，16:9在我正常的工作模式下，可以展示40行代码，但是使用RD280UG可以展示50行。</p>
<p>不但如此，还提供了双色彩显示增强版，在分屏模式下，可以单独设置显示模式。</p>
<p>比如我在IDEA里面设置编码模式，而在浏览器里面设置M-Book模式，无论你的注意力在哪，都能让你感受到最好的体验。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d5d42913bb644e6beb5b967e545ed28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974039&amp;x-signature=CKdGrolKElBu3fXPeGXgye%2Bjrh4%3D" alt="3C2B0B4A-63DC-47BF-AD9C-C42C186E20F3.jpg" loading="lazy"/>
(左侧是开启电子书模式，右侧是深色编程模式)</p>
<h3 data-id="heading-3">彩纸模式</h3>
<p>RD280UG 这次新升级了一个编程模式——彩纸模式。</p>
<p>光看名字，我一开始把它理解成了某一种护眼模式，但是这一段时间体验下来，却成了我最常用的设置。</p>
<p>深色编程模式固然适合编码，可我们并不是所有时间，我都处在高强度判断和输出的状态。</p>
<p>有些时候，我只是想慢慢读一份技术规范，或者AI或者技术相关的文档；</p>
<p>也有些时候，是在晚上翻开一本电子书。</p>
<p>这类阅读，和写代码是完全不同的节奏。</p>
<p>如果屏幕依然保持着高对比、强刺激的显示风格，大脑会不自觉地被推向“赶紧处理完”的状态。</p>
<p>当我想慢下来看点东西的时候，我反而会切到彩纸模式。</p>
<p>RD280UG会自动调节色温和背景亮度，优化字符和底色的对比关系，最终让我有了一种更接近纸张阅读的观感。</p>
<p>很抱歉这里无法放出一个实际的效果图，相机拍出来的效果无法和眼睛相比，但是眼睛是不会骗人的，这里只有亲身体会才能看出区别。</p>
<p>但在需要耐心消化信息、允许自己慢下来阅读的时候，</p>
<p>彩纸模式能帮我完成一次状态切换——</p>
<p>从“马上判断”，切换到“先理解再说”。</p>
<p>而在 AI 不断生成内容的当下，从这种从输出节奏中抽离出来，帮助自己重新回到阅读本身的能力，不应该被忽视。</p>
<h3 data-id="heading-4">120Hz 高刷，是让反复确认没那么累</h3>
<p>这次升级到 120Hz，我的感受并不激烈。</p>
<p>它不会让我在某个瞬间意识到“升级了”，</p>
<p>但在长时间反复确认的过程中，它的存在感会慢慢显现出来。</p>
<p>比如这一次AI重构代码，一个文件有十几处改动。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68f684e349474e21a392cc3a92088e7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974039&amp;x-signature=30NUQZArnDN5mRn8mBtyrla%2Bhuc%3D" alt="5CABD2D3-078F-4928-BFFB-482EC8D60531.png" loading="lazy"/>
在滚动长段代码、频繁跳转文件、来回比对结果时，120Hz 的高刷新率能让页面滚动和窗口拖拽的动画极其流畅，几乎没有拖影或跳跃感。</p>
<p>传统的60Hz屏幕在显示快速运动的画面时，可能会产生微小的闪烁或模糊，长时间观看容易导致眼睛疲劳、干涩甚至头痛。</p>
<p>这种流畅的视觉感受，能够有效缓解视觉压力，对于需要长时间面对屏幕的程序员至关重要。</p>
<h2 data-id="heading-5">保护双眼</h2>
<p>对做过飞秒手术的我来说，我对屏幕非常敏感。</p>
<p>白天还好，一旦到了晚上，尤其是只剩屏幕亮着的时候，</p>
<p>眼睛很容易开始不舒服——酸、胀、干，甚至会不自觉地流泪。</p>
<p>这种感觉更像是眼睛在提醒我：它已经扛不住这种夜晚的刺激了。</p>
<p>也正因为这样，我对显示器的护眼设计，其实一直很在意。</p>
<p>不是为了参数，而是为了能不能多坐一会。</p>
<p>RD 280UG在护眼这件事上，算是长期投入的一条线：无频闪、硬件级低蓝光、抗反射这些设计，再加上多项莱茵认证和智慧调光的专利。</p>
<p>就拿抗反射来说，是展示屏幕实力的重要体现。</p>
<p>BenQ RD280UG 在这点上做到了极致，面板全部覆盖了抗反射涂层，并且通过了TUV莱茵抗反射认证。</p>
<p>无论是白天窗外刺眼的阳光，还是深夜桌面上的台灯，屏幕就像是可以“吸光”一般，把影响降到最低，让你几乎看不到反射的东西。</p>
<p>即使我拿着手电去直接照射屏幕，屏幕也几乎没有影响，而我的Macbook Pro就像镜子一般，被照射的地方什么也看不到了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da74725ef3f446d8b1fe090873bdc1ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974039&amp;x-signature=aN%2Fju2xYy5nHyCOIQwqXisWw3ms%3D" alt="6A389846-A7BE-4AD7-B3A3-E16AA8C4F3DD.jpg" loading="lazy"/>
它们更多是在你意识不到的时候，默默把对你的影响降低。</p>
<p>我印象最深的，是它的夜间保护模式，也就是“猫头鹰模式”。</p>
<p>这个模式听名字就知道，很明显是为夜晚使用设计的。</p>
<p>毕竟只有等孩子睡了的那段时间，才是真正属于自己的。</p>
<p>在环境光非常低的情况下，它会通过固件调节，把亮度和色彩压到一个非常克制的水平。</p>
<p>即使深夜长时间看屏幕，眼睛不再需要在极暗和极亮之间反复适应。</p>
<p>对我来说，最直观的变化就是：</p>
<p>深夜工作时，眼睛干涩的情况明显缓解了，不会那么快产生“必须停下来”的信号。</p>
<p>另外一个很实用的细节是，当前是否开启了低蓝光、夜间模式，都会直接显示在屏幕下方。不用反复进菜单确认，这一点在晚上其实特别省心。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4d9ab2c78f9435aa7fc194dfc2d3578~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974039&amp;x-signature=d43rSnFfnZus3Co5mjNRjDv4F0I%3D" alt="DB4C3D9C-5607-4223-8025-F98C7DCAB7EF.jpg" loading="lazy"/></p>
<h3 data-id="heading-6">让屏幕设置更顺手</h3>
<p>说到调节显示器，很多人应该都有类似的经历：</p>
<p>为了调亮度、换模式，在显示器背后摸来摸去，一不小心还会按错键。</p>
<p>我以前一直觉得这件事挺反直觉的——</p>
<p>明明是很日常的操作，却非要通过实体按键完成。</p>
<p>RD 系列在软硬件结合这件事上，给了一个完美答案。</p>
<p>通过配套的 Display Pilot 2，很多原本需要在屏幕上折腾半天的设置，</p>
<p>现在都可以在软件里直接完成。</p>
<p>像显示模式切换、快捷键控制、桌面分区这些常用功能，都能集中在一个地方调好。</p>
<p>甚至可以按照自己的节奏，给不同时间段设定不同的工作流。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a253c09756b446ba39ccd7d2ebe66a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974039&amp;x-signature=j7YgfVy11rRLkDqcW4cLoSFE7ys%3D" alt="D924443D-DBA6-46E7-A3BD-8B21509E9EFD.png" loading="lazy"/>
我现在觉着最有用的工作流，是晚上十点半启动，把屏幕的色彩模式调成电子书模式。</p>
<p>屏幕显示成电子书模式后，无论我是在写代码，还是在打游戏或者刷视频，都能够立即把我从娱乐中打断，告诉自己：你现在该睡觉了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/072bbbcf1fff4f16a3dcfb2c5d3ecb27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974039&amp;x-signature=xpKJK6YBvz863AKbYR25i14k2a8%3D" alt="AF6EAFEA-25B3-4CC9-BB5F-DEBA8BB40794.jpg" loading="lazy"/>
当然还有很多种玩法，比如不同应用设置不同的颜色模式，还能够设置模式的不同参数，便捷的分屏操作等。</p>
<p>什么时候专心工作，什么时候读东西，什么时候只是随便看看。</p>
<p>这些功能本身解决我一个很现实的问题——</p>
<p>不要在已经很消耗注意力的工作里，再把精力浪费在调屏幕这件事上。</p>
<h3 data-id="heading-7">体验总结</h3>
<p>这段时间用下来，我对 RD280UG 的感受，其实很简单：</p>
<p>它没有试图让我更兴奋，而是让我更容易坐下来。</p>
<p>在 AI 逐渐接管“写”的当下，开发者真正消耗精力的，变成了判断、理解和反复确认。</p>
<p>当屏幕比例、编程模式、阅读模式和护眼设计都围绕这些状态展开时，工具本身就不再抢注意力，而是慢慢退到背后。</p>
<p>拥有一台好的设备，不只是让事情变快，而是让你在需要慢下来思考的时候，依然愿意停留在那里。</p>
<p>也许，这才是我现在最需要的生产力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不止是写代码｜如何用 TRAE 进行复杂数据分析]]></title>    <link>https://juejin.cn/post/7603389033042378806</link>    <guid>https://juejin.cn/post/7603389033042378806</guid>    <pubDate>2026-02-06T09:20:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603389033042378806" data-draft-id="7603314759758741523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不止是写代码｜如何用 TRAE 进行复杂数据分析"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-02-06T09:20:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不止是写代码｜如何用 TRAE 进行复杂数据分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:20:06.000Z" title="Fri Feb 06 2026 09:20:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2614d47a9d2d4cc596e4bc73b405dd31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=1WIZxUdEAAT4RmoPdkNdtDrC7Ro%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>本文作者：杨辉，TRAE 战略分析师</p>
</blockquote>
<p>本文来自 TRAE 团队的战略分析同学，他将从“什么是数据分析”以及“数据分析的常见痛点”这两个基本问题出发，结合两个真实数据分析场景，带大家实际操作如何使用 IDE 进行数据分析。让更多的非开发背景的同学也能轻松应对复杂的数据分析任务。</p>
<blockquote>
<p>本文实践操作版本：TRAE 中国版</p>
<p>模型选择：Auto 模式</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ed0f9030e164d7a97380a8531e867db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=0oYW9QTgzcg8LFSYvyB%2BYpS8lZA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>什么是数据分析？</strong></h2>
<p>数据分析是指通过<strong>收集、清洗、整理、分析和解读数据，提取有价值信息、挖掘数据规律</strong>，从而为决策提供依据的过程。它核心价值在于<strong>将零散的数据转化为可落地的洞察</strong>，助力不同领域解决问题、优化流程、提升效率。</p>
<p>在众多职业（例如咨询、金融、互联网）场景中，数据分析都是不可或缺的核心能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a826e4c238644d50a8e62c3144dbd868~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=oAyyplziHav44VOQbFrQ5TQ7%2BGg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>数据分析常见痛点</strong></h2>
<p>在数据分析工具发展的早期阶段，<strong>Excel</strong> 是绝大多数从业者的首选工具。它<strong>操作门槛低、功能全面</strong>，既能完成<strong>数据的录入、清洗和计算</strong>，也能通过<strong>数据透视表快速汇总分析数据</strong> <strong>，还支持柱状图、折线图、饼图等多种图表制作</strong>，将复杂的数据结果可视化呈现，满足了日常工作中基础的数据分析需求。</p>
<p>对于简单的数据汇总（数据量级 &lt; 1 万行），Excel 通常较为流畅，操作响应秒级，但是当数据量级超过 1 万行甚至 10 万行时，Excel 开始变慢，<strong>筛选、排序、数据透视表等操作耗时延长（秒到分钟级）</strong> 。当表格里有大量<em><strong>VLOOKUP</strong></em>、<em><strong>SUMIFS</strong></em>、数组公式，或是跨表引用、嵌套函数时，甚至<strong>出现文件崩溃</strong>的情况，通常需要关闭自动计算（改为手动计算），并且频繁保存，否则文件崩溃会导致几个小时的工作量白费。</p>
<p>数据分析本是一项对技术能力有较高要求的专业工作，但在 AI 编程技术的赋能下，非技术背景的从业者也能借助 <strong>AI IDE</strong> 高效完成从数据处理、深度分析到可视化呈现的全流程，彻底突破 Excel 在复杂场景下的应用瓶颈。</p>
<p>例如，用户无需再记忆繁杂的公式或代码语法，只需用自然语言描述分析需求，AI 就能自动拆解任务、生成代码并输出精准结果。无论是基础的数据清洗（如读取 CSV 文件并处理重复值）、业务指标计算（如按区域汇总销售额），还是更复杂的可视化呈现（如用折线图展示月度趋势）与进阶的预测分析（如通过时间序列算法预测未来销量），都能通过简单的自然语言指令快速实现——而在过去，这些能力对非技术人员而言几乎是难以企及的。</p>
<blockquote>
<p>一言以蔽之，AI 让数据分析告别 “专业壁垒”，成为所有非专业人员都能零门槛上手的实用工具。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0bb89117ab74efbbd5e3ca1cd7bca46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=kUb1zA0MmbnXfNtq9xGii3iU81s%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>为什么用 TRAE 做数据分析</strong></h2>
<p>我们把 Excel、ChatGPT、TRAE IDE 基于数据分析的场景进行了多维度对比，可以发现 IDE <strong>在效率、适配性与智能化上全面超越 Excel 与 Chatbot（例如 ChatGPT）：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97d87ed302aa446daaa4c2e7f7898def~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=tBPHeJ2LSFjdETLEuuuvwC3Cj9M%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3"><strong>和 Excel 相比</strong></h3>
<ul>
<li>
<p><strong>性能无上限：</strong> 轻松驾驭 10 万行甚至百万行数据，彻底告别 Excel 处理大数据时的卡顿、假死与崩溃风险。</p>
</li>
<li>
<p><strong>零代码分析范式：</strong> 告别复杂的 <em><strong>VLOOKUP</strong></em>、<em><strong>SUMIFS</strong></em> 嵌套或 VBA 脚本。通过自然语言指令即可驱动分析，让非技术人员也能完成高阶统计。</p>
</li>
<li>
<p><strong>端到端流程自动化：</strong> 实现从<strong>原始清洗、多维分析到可视化呈现</strong>的一键式串联，将原本碎片化的操作转化为自动化的数据流水线。</p>
</li>
<li>
<p><strong>逻辑沉淀：</strong> 分析过程不再是不可逆的手动点击，而是自动生成<strong>可复用的分析脚本</strong>。今年的分析模型，明年新数据只需一键运行即可复用。</p>
</li>
</ul>
<h3 data-id="heading-4"><strong>和 ChatBot 类型的产品相比</strong></h3>
<ul>
<li>
<p><strong>操作便捷灵活：</strong> 原生支持超大文件及多个分散文件的关联处理，无需手动切分或反复上传，直接在本地工作区起步。</p>
</li>
<li>
<p><strong>项目理解满分：</strong> 具备项目级上下文理解能力，深度关联历史分析逻辑与业务标签，避免了 Chatbot 常见的重复沟通与上下文断裂。</p>
</li>
<li>
<p><strong>中间逻辑可追溯、可追问：</strong> 拒绝“结果黑盒”，你可以针对分析过程中的<strong>任何中间步骤进行追问和校验</strong>（如：“为什么这么过滤？”），确保逻辑百分之百准确。</p>
</li>
<li>
<p><strong>分析产出持久化：</strong> 支持将图表与分析结果直接转化为<strong>多格式持久化文件</strong>。这种“产出即资产”的能力，为深度分析与跨工具协作提供了坚实的工程基础。</p>
</li>
<li>
<p><strong>多工具协同执行：</strong> 凭借智能推理与多工具协同，不仅精准识别需求，更能自动配置环境并执行代码，实现真正闭环的 AI 分析体验。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64c9db9b23be41e6b11e55dab085fe57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=6uFJV3CtxX79FJF1wW7ZIfwDxZk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5"><strong>实操</strong></h2>
<p>Stack Overflow 开发者调研是一份面向全球开发者的问卷报告，调研当前开发领域的技术趋势与核心痛点等。他们每年会将源数据发布在其官网 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsurvey.stackoverflow.co%2F" target="_blank" title="https://survey.stackoverflow.co/" ref="nofollow noopener noreferrer">survey.stackoverflow.co/</a></p>
<p>本教程以 Stack Overflow 2025 年开发者调研数据为例，演示如何用 TRAE 完成全流程数据分析。</p>
<h3 data-id="heading-6"><strong>工具安装与数据准备</strong></h3>
<ol>
<li>
<p><strong>下载安装 TRAE ：</strong> 访问 TRAE 官网（<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.trae.com.cn%25EF%25BC%2589%25EF%25BC%258C%25E4%25B8%258B%25E8%25BD%25BD%25E5%25AE%2589%25E8%25A3%2585%25E5%258C%2585%25EF%25BC%258C%25E6%258C%2589%25E5%25BC%2595%25E5%25AF%25BC%25E5%25AE%258C%25E6%2588%2590%25E5%25AE%2589%25E8%25A3%2585%25EF%25BC%258C%25E7%2594%25A8%25E6%2589%258B%25E6%259C%25BA%25E5%258F%25B7%25E8%25B4%25A6%25E5%258F%25B7%25E7%2599%25BB%25E5%25BD%2595%25E5%258D%25B3%25E5%258F%25AF%25E3%2580%2582" target="_blank" title="http://www.trae.com.cn%EF%BC%89%EF%BC%8C%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%8C%85%EF%BC%8C%E6%8C%89%E5%BC%95%E5%AF%BC%E5%AE%8C%E6%88%90%E5%AE%89%E8%A3%85%EF%BC%8C%E7%94%A8%E6%89%8B%E6%9C%BA%E5%8F%B7%E8%B4%A6%E5%8F%B7%E7%99%BB%E5%BD%95%E5%8D%B3%E5%8F%AF%E3%80%82" ref="nofollow noopener noreferrer">www.trae.com.cn），下载安装包，按引导完成安装，用手机号账号登录即可。</a></p>
</li>
<li>
<p><strong>打开 TRAE SOLO 模式：</strong> TRAE 目前提供 SOLO 和 IDE 两种模式，本次我将选择 TRAE SOLO 模式来完成需求。</p>
</li>
</ol>
<h4 data-id="heading-7"><strong>SOLO 和 IDE 模式的区别：</strong></h4>
<ul>
<li>
<p>SOLO：AI 主导全流程，自动拆解任务、调度工具，开发者仅需提需求、审核成果</p>
</li>
<li>
<p>IDE：开发者主导，AI 提供代码补全、智能问答等辅助，保留传统开发流程，掌控感更强</p>
</li>
</ul>
<p>SOLO 有 2 个选项，分别为 SOLO Builder 和 SOLO Coder，我们本次选择 SOLO Coder，其中的 Plan 模式也为分析方案的讨论提供了很大便利。</p>
<h4 data-id="heading-8"><strong>SOLO Builder 和 SOLO Coder 的区别：</strong></h4>
<ul>
<li>
<p>SOLO Coder: 适合已有复杂项目的迭代、重构、Bug 修复，可自主规划、执行多步任务</p>
</li>
<li>
<p>SOLO Builder: 适合从 0 到 1 完整项目的快速原型验证，从需求分析到部署全流程自动化</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24dfd87d59064ff6a7fd0ca6d406b997~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=6P7Z3e7GYhJQR9fT%2BzBTNeu6%2Ba0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9"><strong>单文件数据分析场景</strong></h3>
<h4 data-id="heading-10"><strong>数据准备</strong></h4>
<p>从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsurvey.stackoverflow.co%2F" target="_blank" title="https://survey.stackoverflow.co/" ref="nofollow noopener noreferrer">survey.stackoverflow.co/</a> <strong>下载 Stack Overflow 2025 调研数据集</strong>，包含「受访者基本信息、技术使用习惯、AI 工具态度」等维度，将数据集保存至本地文件夹（例如 “StackOverflow2025” ），方便后续 TRAE 进行读取。</p>
<p>需要注意的是，要单独创建一个文件夹，将下载下来的数据集保存在这个文件夹内，而不是直接打开excel文件。</p>
<p>选择「打开项目」，找到对应文件夹打开。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95fe1e4f569e45ef994488a7e4f172bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=5BPj3KwWA8YYeygUXvMTB5z2irI%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a0fd50bbb434aa68eeddad286e133ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=01JqVfcvqb15t5GP1VrkOrPn2WM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-11"><strong>开始数据分析</strong></h4>
<p><strong>1.</strong> 直接在对话框里输入指令，<strong>指令可以简单（例如“帮我分析一下这个数据集”）</strong> ，也可以更细节具体，可以参考下方，这一步是为了让 AI 清晰自己的角色定位。</p>
<p>「我是数据分析师，需要分析Stack Overflow 2025开发者调研数据。 </p>
<p>请读取本地文件夹“StackOverflow2025”中的CSV文件，查看数据的前10行、字段列表、数据形状（行数/列数），统计各字段的缺失值数量，生成基础信息报告。 </p>
<p>注意处理中文编码问题，避免乱码。」</p>
<p><strong>2.</strong> 从官网下载的数据是 zip 文件，<strong>无需人工手动解压，</strong> AI 自己会解压并使用 Python 来读取和分析数据；大概经过 2 分钟，AI 会显示初步分析结果，例如 <strong>数据基本情况、开发者画像、AI 工具使用情况、薪资情况以及技术使用情况</strong>等多个方面</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0f5327e42284714860c827a90d49500~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=yRIDdu2kLiN1HFAgHsTS8HAL%2BXk%3D" alt="" loading="lazy"/></p>
<ol start="3">
<li>从初步的分析返回结果来看，我们可以发现一些<strong>有趣的下钻分析的维度</strong>，例如：</li>
</ol>
<p>  a. 年龄分布和薪资情况是否有关系</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b33a5902e8b54fa7b9f252217b59415c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=iKxRLAasAF45lJU4BuGsadJLx10%3D" alt="" loading="lazy"/></p>
<p>  b. 最常用的编程语言和薪资情况是否有关系</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f29edad37744030b09ccd8a95f44087~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=yxOnbMKxNhN5uVfOiWMYKYaKhQE%3D" alt="" loading="lazy"/></p>
<p>  c. 工作满意度和薪资情况是否有关系</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3d5b15528e443be925fd95a61dcfe15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=nM2jgBWFs4M%2FsLUUvVTeyw%2BRxbc%3D" alt="" loading="lazy"/></p>
<p><strong>4.</strong> 原始数据里有个字段是“国家”，因为字段较多，所以 AI 在最开始的描述性统计时没有提到，但如果期望补充更多下钻分析的维度，可以直接问 AI</p>
<p>「分析一下不同国家的薪资分布（看一下前10国家，按调研用户数量排序，薪资中位数，均值和25/75分位数，全部换算为美金）」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bf573ad448d4ab4b6d19f80d602c298~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=btRUaac%2FZW5A8QytdJsTvAj%2FmhE%3D" alt="" loading="lazy"/></p>
<p><strong>5.</strong> 可以交叉“国家”和“开发者身份”，分析薪资分布情况</p>
<p>「分析一下不同国家、不同开发者身份的薪资分布（看一下前10国家，前一下前10开发者身份，按调研用户数量排序，薪资中位数，均值和25/75分位数，全部换算为美金）」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89b68c6fc42e4f36a14f92694e3514d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=xvXXVo3loZECV7al5ey5p6k5kmM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12"><strong>生成数据分析图表</strong></h4>
<blockquote>
<p>数据分析常常需要结合图表，可以更加直观展示数据情况。</p>
</blockquote>
<p>直接在对话框里输入指令，<strong>指令可以简单（例如“帮我画一个 XX 图”）</strong> ，也可以更细节具体，可以参考下方。</p>
<p>「帮我画一个热力表，横轴是国家（按中文名称），数轴是开发者类型（简写），数值是薪资平均值」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c3591dab4604119b89ba246834d7f6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=AqhOzHcwIK9A9Q3Vc9XX5Eta898%3D" alt="" loading="lazy"/></p>
<p>「帮我画一个图，展示每个国家的25/75/中位数 薪资，只需要展示前10国家即可」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0de4f0c2a28e4397aa57edd838845dbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=ZigVH5MVgWmS2cUhVe%2FMHbHQqjI%3D" alt="" loading="lazy"/></p>
<p>「帮我画一个气泡图，横轴是薪资均值（单位是美金），数轴是每日使用过AI的占比，大小是开发者调研用户数量，展示前10国家，气泡大小适中，注意美观」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fa4ce3e77184d5ab2057b0cfcfaf296~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=x2KaWXCGG05ooc6RtP8wfyBY5wQ%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-13"><strong>数据分析结果导出</strong></h4>
<p>除了数据分析和画图外，我们也可以将分析结果储存为 <strong>CSV 、Excel 等格式方便后续阅读和处理数据，或者让其将完整报告存储为 MD、PDF、 PPT 等格式方便阅读文文字内容</strong>。以 csv 为例，</p>
<p>「帮我把每个国家的调研人数，薪资中位数，25/75分位数和均值导出为csv+」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5a61e53ad914a00801e56e2a729bfe9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=0i1V4FtyEKQPl2nRDRnKAIZyAtk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-14"><strong>总结</strong></h4>
<p>以上分析只是这个数据集的一部分，还有其他分析维度例如 AI 工具使用率分析、编程语言偏好分析、工具偏好与 AI 使用关联性等，大家可以自行修改提示词探索。</p>
<h3 data-id="heading-15"><strong>跨文件分析场景</strong></h3>
<p>有时候数据分散在不同的文件，而我们需要将不同文件之间的数据对比结合起来分析，因此会有跨文件分析的场景。</p>
<h4 data-id="heading-16"><strong>数据准备</strong></h4>
<p>从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kaggle.com%2Fdatasets%2Fretailrocket%2Fecommerce-dataset%2Fdata" target="_blank" title="https://www.kaggle.com/datasets/retailrocket/ecommerce-dataset/data" ref="nofollow noopener noreferrer">www.kaggle.com/datasets/re…</a>  <strong>下载 Retailrocket recommender system dataset 数据集</strong>；该数据集包含四个文件：一个存储用户行为数据的文件（events.csv）、两个存储商品属性数据的文件（item_properties_part1.csv 和 item_properties_part2.csv），以及一个描述类目层级结构的文件（category_tree.csv）；<strong>无需手动解压</strong>，可以直接把数据集保存至本地文件夹（例如 “电商推荐” ），方便后续 TRAE 进行读取。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c613c756eca4ac2823a4b4c0b8e14d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=CjJuP6qolYcuJrCay3vBMJsEzyE%3D" alt="" loading="lazy"/></p>
<p>选择「打开项目」，找到对应文件夹打开。</p>
<h4 data-id="heading-17"><strong>开始数据分析</strong></h4>
<p><strong>1.</strong> 直接在对话框里输入指令，<strong>指令可以简单（例如“帮我分析和总结一下这个数据集”）</strong> ；可以看到三个文件里，ategory_tree.csv 是商品类别树结构（1670 行）；events.csv 是户行为事件（276 万行），主要是三类事情：浏览、加入购物车和交易；item_properties 是商品属性（2000 万行），包含多种属性类型</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d98e200c3ab4144b816108b68405494~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=%2BisHqRg5qO%2F8N22CtFBMKmbKQ7c%3D" alt="" loading="lazy"/></p>
<p><strong>2.</strong> 我们可以先针对单个文件夹做一些下钻分析，例如：</p>
<p>a. 下钻分析商品类别树分布，可以看到顶级类别数量为 25 个，最深层级为 6 层，层级 3 和层级 4 是最主要的层级，共占 81.90%，平均每个父类别有 4.54 个子类别，中位数为 4，表明类别结构比较均衡</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bee50b986e6426c9b0fd87cef285458~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=eBs2%2F84dtiYO1A9MVBgC1e52ypE%3D" alt="" loading="lazy"/></p>
<p>b. 下钻分析用户行为数据，可以看到共计 141 万个用户和 276 万条记录，平均一个用户有 1.96 条记录；71%的用户仅 1 条记录，27%的用户有 2-10 条记录，1.4%用户有超过 10 条记录；从事件类型看，浏览占比 96.67%，加入购物车为 2.52%，购买为 0.81%；浏览从加入购物车转化比例为 2.60%，加入购物车到交易为 32%</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ce6989af935499aabc42328bfdeefc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=kMa7q2te4bSJT943Flpr5SQmSLA%3D" alt="" loading="lazy"/></p>
<p>c. 下钻分析商品属性数据，可以看到共计 2000 万条属性记录，涉及 40 万商品，平均一个商品 3 个属性；除了库存（available）和类目（categoryid）这两个属性外，其他属性都被哈希；最常用的前 10 个属性使用占比基本都是 100%</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a5fc0b9a8ab41eab3c5acf38f68b985~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=ooZ3dXlxvBQxNpBUwGEWW33ub10%3D" alt="" loading="lazy"/></p>
<p><strong>3.</strong> 除了单个文件下钻分析外，我们也可以交叉三个文件进行分析，例如按顶级类别看下从浏览到加入购物车到交易的转化比例：可以看到平均转化率为 0.91%，3 个类别（140、1224、859）转化率高于 1%，11 个类别转化率低于 0.5%，其他介于 0.5-1%；7 个类目的浏览量低于 1000，其中 2 个浏览量为 0</p>
<p>​「按25个顶级类别看下从浏览到加入购物车到交易的转化比例（浏览事件粒度，不是商品或者用户粒度，如果一个商品的类别有过变化，用最新的类别）」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a28c2c512d524a939ffdef5290912e38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=IrK94tLElq0bj5XAScHzvBwvso0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-18"><strong>生成数据分析图表</strong></h4>
<p>可以直接在对话框里输入指令，例如：</p>
<p>「帮我画一个图，按top 10顶级类别浏览到加入购物车，加入购物车到交易的比例，并在图表的上方，加上每个类目的浏览、加购、交易次数」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/529b91b1c68a474183265223414f8e7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=WKNaLeLQjtUWxNp2Qrz%2FX9Oot2k%3D" alt="" loading="lazy"/></p>
<p>「帮我画一个气泡图，横轴浏览到加购的转化，竖轴是加购到购买的转化，大小是浏览量级，只需要画按浏览量前10个顶级类别」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a9af24af731436c80fb260f2c3a6ff4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=XWU%2Fv%2BUYOXGwUw%2FCcwF4ZZc6Ztk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-19"><strong>数据分析结果导出</strong></h4>
<p>「把以上top 10 顶级类别的气泡图导出为ppt」</p>
<p>可以发现，TRAE 会使用 matplotlib 绘制相关气泡图，截屏然后插入ppt里面，而没有使用PPT原生画图能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb6d7c960edc4b2dbbfae97a44325081~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=McIKZgVOTHnvrFUk4A7yEQlflhg%3D" alt="" loading="lazy"/></p>
<p>当然你也可以通过提示词「请帮我在 <strong>PPT</strong> 里面直接画图，而不是复制图片」，TRAE 也能调用 PPT 相关能力进行构图，但画出来的图片美观度略有不足，只能达到基本要求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88cfe1a4ecd94232816dd36b2c0cb8a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=RtCC0L%2FPUAzfyHOITQgPivc4TTM%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd85a44b7c6d4dbaa29f5bcc63a91ab7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=YnkLpAKMOuZ%2BksHWbo9kCHwmuf4%3D" alt="" loading="lazy"/></p>
<p>以上分析只是这个数据集的一部分，还有其他分析维度例如其他属性对购买转化比例的影响等，大家可以自行修改提示词探索。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55679dac25b046d48545f45e41ce5bd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=xfkEDQvqBOVouH507g%2Fc7xbdpoY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-20"><strong>写在最后</strong></h2>
<p>无论是咨询项目（例如银行压力测试、消费品市场趋势分析等），还是互联网场景下的数据任务（例如分国家用户留存分析、付费转化漏斗搭建等），基本都能通过 AI IDE 高效落地。<strong>AI IDE 在数据挖掘与深度分析环节的表现堪称出色，能精准完成核心任务</strong>；仅在最终数据可视化呈现的细节优化上，偶尔需要少量辅助调整，<strong>但其整体交付质量大多超出预期，大幅提升了数据分析的效率与专业性。</strong></p>
<p>IDE 从来不是专业开发者的专属工具，它可以离每个人的工作和生活都更近一些。借助 AI 的能力，我们不必精通复杂的编程语言，也能把一个个灵感和想法变成真正可落地的“数字小帮手”；不管你是产品、运营、数据分析、设计师，还是任何一一个角色，都可以用 AI Coding 去搭建属于自己的智能工作台。</p>
<p>期待多样化的你带来更多不一样的 AI Coding 实现！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端 AI Coding 落地指南（一）架构篇]]></title>    <link>https://juejin.cn/post/7603347438013480995</link>    <guid>https://juejin.cn/post/7603347438013480995</guid>    <pubDate>2026-02-06T09:26:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603347438013480995" data-draft-id="7603347438013333539" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端 AI Coding 落地指南（一）架构篇"/> <meta itemprop="keywords" content="前端,AI编程"/> <meta itemprop="datePublished" content="2026-02-06T09:26:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AntonCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3966693684293240"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端 AI Coding 落地指南（一）架构篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693684293240/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AntonCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:26:13.000Z" title="Fri Feb 06 2026 09:26:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是不是也遇到过这些情况：AI 生成的代码风格和现有项目不一致；项目结构不符合预期，设计稿要么看不懂、要么分析漏项，页面 UI 还原度低；改来改去返工多，需求越走越偏，最后还得自己重写一版？</p>
<p>我在实际项目里经过多次迭代的实践，落地了一套</p>
<p><strong>以规范、能力扩展和流程为主线的 AI Coding 架构</strong></p>
<p>把「风格不一致、步骤漏、设计稿不会分析/验收、提案任务格式乱」都收进可控范围。落地之后最直观的效果是：</p>
<p><strong>前端页面可以做到 90% 还原设计稿，需求实现更准确，代码风格一致，结构设计合理</strong></p>
<hr/>
<h2 data-id="heading-0">架构简介</h2>
<p>架构运用了多种现下流行的 Agent 通用能力：</p>

























<table><thead><tr><th>架构组成</th><th>说明</th></tr></thead><tbody><tr><td>SDD</td><td>开发流程控制，保证需求不遗漏，开发不脱节，可进行需求分析/开发规划/验收测试/复盘归档</td></tr><tr><td>MCP</td><td>对接外部能力，如设计稿读取、浏览器访问页面查看实际效果、接口文档</td></tr><tr><td>Rules</td><td>约定「做什么、不做什么」，如保证 AI 遵循项目结构，规范约束，代码风格</td></tr><tr><td>Skills</td><td>约定「怎么做」，渐进披露按需指导 AI 怎么做，如怎么写UI，怎么验收UI</td></tr></tbody></table>
<p><strong>Rules 管「怎么才算对」，Skills 管「怎么一步步做」，MCP 让 Agent 能看到真实世界，而 SDD 负责记录「这次为什么要改、应该改成什么样」并把每次变更沉淀成新的真相</strong>，四者合在一起，才是真正稳定可演进的 AI Coding 底座。</p>
<p>从需求到归档的完整链路如下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[需求输入] --&gt; B{有设计稿?}
    B --&gt;|是| C[设计稿 MCP 读稿]
    C --&gt; D[design-analysis 产出 UI 分析清单]
    B --&gt;|否| E[create-proposal + SDD]
    D --&gt; E
    E --&gt; F[proposal / tasks / spec 增量 校验]
    F --&gt; G[按 tasks 实施]
    G --&gt; H[Rules + create-route/component/theme 页面开发]
    H --&gt; I{有实现页?}
    I --&gt;|是| J[Browser MCP 打开页面]
    J --&gt; K[ui-verification 比对设计稿/清单]
    K --&gt; L[产出 UI 问题清单 修复再验]
    L --&gt; M[create-api/store + 接口/Context7 业务联调]
    G --&gt; M
    M --&gt; N[SDD 归档 更新 specs]
</code></pre>
<ol>
<li><strong>需求输入</strong>：明确是否有设计稿、是否有接口、交付形态（页面/组件/其它）。</li>
<li><strong>设计稿分析</strong>（有稿时）：用 Pencil（或 Figma）MCP 读稿 → 执行 design-analysis 技能 → 产出 UI 分析清单。</li>
<li><strong>创建提案</strong>：执行 create-proposal，产出 SDD 的 proposal、tasks、spec 增量；若有设计稿，在 tasks 中写明依据 UI 分析清单实现、实现后用 ui-verification 验收；validate 通过后进入实施。</li>
<li><strong>页面/UI 开发</strong>：按 tasks 顺序做；读 Rules（项目结构、组件、路由、样式等）+ Skills（create-route、create-component、theme-variables）；依据 UI 分析清单还原布局与样式。</li>
<li><strong>UI 验收</strong>：用 Cursor IDE Browser（或 Playwright）打开实现页，执行 ui-verification，与设计稿或分析清单比对，按 P0/P1/P2 产出问题清单；修复后再次用 Browser 验证。</li>
<li><strong>业务开发与联调</strong>：Rules（API、状态、通用约束）+ create-api、create-store；接口文档 MCP、Context7 按需使用。</li>
<li><strong>归档</strong>：tasks 全部勾选后执行 SDD archive，更新 specs，变更挪入 archive。</li>
</ol>
<hr/>
<h2 data-id="heading-1">主流 Agent 通用</h2>
<p>本套架构方案，适用所有支持 skills/mcp 的 Agent，且
<strong>只维护一份，所有 Agent 共用</strong>：</p>
<p>首先在你的项目根目录创建 <strong><code>.agents</code></strong>，下面放 <code>rules</code> 和 <code>skills</code>，然后根据你所使用的 Agent 或多个 Agent 做如下配置：</p>
<ul>
<li><strong>Cursor</strong>：在项目根创建 <code>.cursor</code> 目录，其下的 <code>rules</code>、<code>skills</code> 用 <strong>软链接</strong> 指到 <code>.agents/rules</code>、<code>.agents/skills</code>。</li>
<li><strong>Claude</strong>：同理，创建 <code>.claude</code>，将 <code>rules</code>、<code>skills</code> 软链到 <code>.agents</code> 下同名目录。</li>
<li><strong>OpenCode</strong>：创建 <code>.opencode</code>，同理软链。</li>
<li><strong>Gemini</strong>：创建 <code>.agent</code>，同理软链。</li>
<li><strong>Trae</strong>：创建 <code>.trae</code>，同理软链。</li>
</ul>
<p>这样只需维护 <code>.agents</code> 一份，即可同时支持上述所有 Agent。</p>
<p><strong>目录结构示例</strong>（仅展示与本文相关的部分）：</p>
<pre><code class="hljs language-text" lang="text">项目根/
├── .agents/                    # 唯一维护的规范与技能目录
│   ├── rules/                  # 规则
│   └── skills/                 # 技能
│
├── .cursor/                    # Cursor：内部 rules、skills 软链到 .agents
├── .claude/                    # Claude：同上
├── .opencode/                  # OpenCode：同上
├── .agent/                     # Gemini：同上
└── .trae/                      # Trae：同上
</code></pre>
<hr/>
<h2 data-id="heading-2">SDD</h2>
<p><strong>SDD 是什么</strong><br/>
Specification-Driven Development，用「规范/spec」来驱动开发：</p>
<ul>
<li><strong>先写 spec 再写代码</strong>：任何需求或变更，先写清楚需求，「现在是怎样 → 期望变成怎样」，再开干；</li>
<li><strong>变更可追踪</strong>：变更以「提案 + 任务 + spec 增量」管理，实施完归档，可回溯是谁、什么时候、为什么改了什么；</li>
<li><strong>验收有据可依</strong>：验收按 spec 来，而不是「感觉差不多」。</li>
</ul>
<p><strong>SDD 的选择</strong></p>
<p>Spec-kit 和 OpenSpec 是两个比较热门的 SDD 工具，我在尝试过两个工具后，最终选择使用 openspec 因为他比 speckit 简单很多，speckit 的流程更严谨，也更繁琐，其复杂度适合从 0 到 1 规划一个新项目。</p>
<p><strong>OpenSpec</strong></p>
<p>通过 <code>openspec init</code> 初始化项目后，你就会得到如下的一个典型的 OpenSpec 目录：</p>
<pre><code class="hljs language-text" lang="text">openspec/
├── project.md          # 项目约定与 AI 使用说明
├── specs/              # 当前「真相」：已经生效的能力与约束
└── changes/            # 进行中的变更：proposal、tasks、design、spec 增量
    ├── &lt;change-id&gt;/
    │   ├── proposal.md
    │   ├── tasks.md
    │   ├── design.md      # 可选：草图/交互/边界情况
    │   └── spec-delta.md  # 本次变更对 specs 的增量
    └── ...
</code></pre>
<p>首先你需要编写 <code>project.md</code>，将你项目的规范告诉 openspec，以此作为规范进行推动后续的工作，这是我项目的 <code>project.md</code>，起初也是一个庞大的文件，现在已经拆分到 rules 和 skills 了（后面会介绍）：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目上下文</span>

<span class="hljs-section">## 项目概述</span>

当前项目是一个基于 React + TypeScript 的单页应用（SPA）。

<span class="hljs-section">## 技能与规范</span>

本项目定义了两层指导体系，统一存放在 <span class="hljs-code">`.agents/`</span> 目录下。

<span class="hljs-section">### `.agents/rules/` - 开发规范</span>

规范文件包含项目开发的核心规则，不会自动加载。当需要确认规范时，主动读取对应文件：

| 文件             | 何时读取                   |
| ---------------- | -------------------------- |
| <span class="hljs-code">`01-项目概述.md`</span> | 需要了解项目背景、技术栈时 |
| <span class="hljs-code">`02-编码规范.md`</span> | 编写或审查代码时           |
| <span class="hljs-code">`03-项目结构.md`</span> | 确定代码应放在哪个目录时   |
| <span class="hljs-code">`04-组件规范.md`</span> | 创建或拆分组件时           |
| <span class="hljs-code">`05-API规范.md`</span>  | 新增或修改接口时           |
| <span class="hljs-code">`06-路由规范.md`</span> | 新增页面或配置路由时       |
| <span class="hljs-code">`07-状态管理.md`</span> | 新增或重构状态管理时       |
| <span class="hljs-code">`08-通用约束.md`</span> | 确认通用约束时             |
| <span class="hljs-code">`09-样式规范.md`</span> | 编写组件样式或主题适配时   |
| <span class="hljs-code">`10-文档规范.md`</span> | 编写或审查代码注释时       |
| <span class="hljs-code">`11-测试规范.md`</span> | 确认测试要求时             |

<span class="hljs-section">### `.agents/skills/` - 实践技能</span>

技能文件包含具体落地步骤与示例代码，按需读取：

| 场景              | 技能文件                                   |
| ----------------- | ------------------------------------------ |
| 创建提案时        | <span class="hljs-code">`.agents/skills/create-proposal/SKILL.md`</span>  |
| 新增接口          | <span class="hljs-code">`.agents/skills/create-api/SKILL.md`</span>       |
| 创建/拆分组件     | <span class="hljs-code">`.agents/skills/create-component/SKILL.md`</span> |
| 新增页面路由      | <span class="hljs-code">`.agents/skills/create-route/SKILL.md`</span>     |
| 新增全局状态      | <span class="hljs-code">`.agents/skills/create-store/SKILL.md`</span>     |
| 编写样式/主题适配 | <span class="hljs-code">`.agents/skills/theme-variables/SKILL.md`</span>  |

技能索引文件：<span class="hljs-code">`.agents/skills/README.md`</span>

</code></pre>
<p>配置了规范后，就可以使用 openspec 的指令进行需求的实现，先是 <code>openspec proposal</code> 创建提案，Agent 会根据你的描述，生成详细的需求文档，规划开发任务，待你确认。</p>
<p>开发任务确认后，再执行 <code>openspec apply</code> 开始实施任务，任务完成 <code>openspec archive</code> 对本次需求归档，这会作为后续新需求的一个参考，让 Agent 对项目的现状更了解。</p>
<p><strong>OpenSpec 在这套架构里的作用</strong><br/>
结合前面讲的 Rules / Skills / MCP，这里的 OpenSpec 主要在三个环节发力：</p>
<ul>
<li><strong>需求 / 变更收敛</strong>：不管输入来自 PRD、口头、IM 还是设计稿，先用 OpenSpec 写一条变更（proposal + tasks + spec 增量），把「要改什么、影响到哪里」说清楚，避免 AI 直接在代码上「盲改」；</li>
<li><strong>开发执行对齐</strong>：开发时，Agent 读取对应变更的 proposal / tasks / spec 增量，再结合 Rules（项目级约束）、Skills（如 create-route / create-api / design-analysis）和 MCP（设计稿 / 浏览器 / 接口文档），按 tasks 一项项完成，实现过程始终围绕同一份 spec 展开；</li>
<li><strong>验收与归档</strong>：UI 验收阶段，ui-verification 会同时参考 UI 分析清单（design-analysis 产物）和 OpenSpec 中的 spec 增量，验证是否满足这次变更的业务与交互预期；验收通过后，将变更移动到 archive，并把 spec 增量合到 specs，下次再改同一块能力时，所有上下文都在这里。</li>
</ul>
<hr/>
<h2 data-id="heading-3">MCP</h2>
<p><strong>MCP 是什么</strong>：Model Context Protocol，模型通用的上下文协议，让模型能安全、结构化地调用外部能力。设计稿、浏览器、接口文档等通过 MCP 暴露成工具，Agent 按需调用，拿到真实数据或执行真实操作。</p>
<p>这套架构中用到如下的 MCP：</p>















































<table><thead><tr><th>MCP</th><th>用途</th><th>环节</th><th>说明</th></tr></thead><tbody><tr><td>Pencil</td><td>.pen 设计稿结构、布局、节点、截图</td><td>设计稿分析</td><td>设计稿分析首选，效果优于 Figma MCP</td></tr><tr><td>Figma</td><td>Figma 链接的截图与设计上下文</td><td>设计稿分析（Figma 稿时）</td><td>有 .pen 时优先 Pencil</td></tr><tr><td>Cursor IDE Browser</td><td>打开页面、快照、截图</td><td>UI 验收</td><td>Cursor 内优先，效果优于 Playwright</td></tr><tr><td>Playwright</td><td>页面打开、截图、自动化</td><td>UI 验收（非 Cursor 或脚本化）</td><td>可作为 Browser 的补充</td></tr><tr><td>ApiFox</td><td>OAS 等接口定义</td><td>业务开发/联调</td><td>按当前文档生成/校验请求</td></tr><tr><td>Context7</td><td>主流库最新文档与示例注入</td><td>页面/业务开发</td><td>避免过时 API、幻觉</td></tr></tbody></table>
<p><strong>设计稿类</strong></p>
<ul>
<li><strong>Pencil MCP</strong>：面向 <code>.pen</code> 设计稿。能读层级、节点、布局、截图（如 <code>snapshot_layout</code>、<code>get_screenshot</code>、<code>batch_get</code> 等），把设计稿里的元素尺寸、间距、字体、颜色直接触达 Agent。在「设计稿分析」环节作为主数据源，<strong>效果明显好于 Figma MCP</strong>——层级与细节更完整，分析清单更准，因此有 .pen 稿时优先用 Pencil。可以直接拷贝 Figma 粘贴到 Pencil 设计稿。</li>
<li><strong>Figma MCP</strong>：面向 Figma 链接。可解析 file key / node id、取截图与设计上下文，适合设计稿在 Figma 的场景，但 Figma 可复制到 Pencil ，95%+ 样式复制后还原，个别暂不支持的例如 Pencil 没有虚线边框。</li>
</ul>
<p><strong>浏览器类</strong></p>
<ul>
<li><strong>Cursor IDE Browser</strong>：在 Cursor 内打开目标页、拉快照、截图、简单交互。用于 UI 验收时「真实页面 vs 设计稿」比对。<strong>在 Cursor 里做 UI 验收时，优先用 Cursor IDE Browser，效果比 Playwright MCP 更好</strong>（集成度、稳定性、截图比对流程更顺）。</li>
<li><strong>Playwright MCP</strong>：同样可打开页面、截图、操作，适合不在 Cursor 或需要脚本化验收时使用。</li>
</ul>
<p><strong>接口与文档类</strong></p>
<ul>
<li><strong>接口文档 MCP（如 ApiFox）</strong>：读/刷新项目 OAS 等，在业务开发/联调时按当前文档生成或校验请求与类型，避免接口变更后模型用旧假设。</li>
<li><strong>Context7</strong>：按需注入当前版本的库文档与代码示例，在页面/业务开发时减少依赖过时、模型幻觉 API 的问题。</li>
</ul>
<hr/>
<h2 data-id="heading-4">Rules</h2>
<p><strong>Rules 是什么</strong>：写在项目里的持久化指导，约定规范、约束和惯例（项目概述、编码、结构、组件、API、路由、状态、样式、文档、测试等），让 Agent 遵守「做什么、不做什么」。</p>
<p><strong>实践中的演进历程</strong>：</p>
<ul>
<li>最初是一整个大 Rule.md，上下文过大、易丢记忆、难按场景聚焦；</li>
<li>后来按模块拆成多份（如 01～11），按需读；</li>
<li>Skills 加入后，Rules 只需要保留原则与约束，把步骤、检查点、模板、示例迁到 Skills，实现渐进式披露。</li>
</ul>
<p><strong>项目级 Rules 清单</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">.agents/rules/
├── 01-项目概述.md
├── 02-编码规范.md
├── 03-项目结构.md
├── 04-组件规范.md
├── 05-API规范.md
├── 06-路由规范.md
├── 07-状态管理.md
├── 08-通用约束.md
├── 09-样式规范.md
├── 10-文档规范.md
├── 11-测试规范.md
└── README.md
</code></pre>
<p><strong>Rules 目录下的 README 清晰的介绍了各个 rule 的作用和使用时机</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目规范索引</span>

本目录包含前端项目的开发规范，按模块分类组织，便于快速查找。

<span class="hljs-section">## 规范模块列表</span>

<span class="hljs-section">### 📋 [<span class="hljs-string">01-项目概述</span>](<span class="hljs-link">./01-项目概述.md</span>)</span>

<span class="hljs-bullet">-</span> 项目定位
<span class="hljs-bullet">-</span> 技术栈

<span class="hljs-section">### 💻 [<span class="hljs-string">02-编码规范</span>](<span class="hljs-link">./02-编码规范.md</span>)</span>

<span class="hljs-bullet">-</span> TypeScript 规范
<span class="hljs-bullet">-</span> 命名规范（文件夹、变量、常量、接口、组件等）
<span class="hljs-bullet">-</span> 业务函数命名（事件处理、内部处理）

<span class="hljs-section">### 📁 [<span class="hljs-string">03-项目结构</span>](<span class="hljs-link">./03-项目结构.md</span>)</span>

<span class="hljs-bullet">-</span> 目录结构概览
<span class="hljs-bullet">-</span> 各目录使用约束（禁止新建非标准目录）

<span class="hljs-section">### 🧩 [<span class="hljs-string">04-组件规范</span>](<span class="hljs-link">./04-组件规范.md</span>)</span>

<span class="hljs-bullet">-</span> 组件结构规范
<span class="hljs-bullet">-</span> 组件层级规划（通用 vs 页面级）

<span class="hljs-section">### 🌐 [<span class="hljs-string">05-API规范</span>](<span class="hljs-link">./05-API规范.md</span>)</span>

<span class="hljs-bullet">-</span> 接口请求规范
<span class="hljs-bullet">-</span> 接口函数命名（NON-NEGOTIABLE）
<span class="hljs-bullet">-</span> 接口错误处理（NON-NEGOTIABLE）

<span class="hljs-section">### 🛣️ [<span class="hljs-string">06-路由规范</span>](<span class="hljs-link">./06-路由规范.md</span>)</span>

<span class="hljs-bullet">-</span> 路由结构规范
<span class="hljs-bullet">-</span> 路由与菜单规范（NON-NEGOTIABLE）

<span class="hljs-section">### 🗄️ [<span class="hljs-string">07-状态管理</span>](<span class="hljs-link">./07-状态管理.md</span>)</span>

<span class="hljs-bullet">-</span> Zustand 使用规范
<span class="hljs-bullet">-</span> Store 组织规范
<span class="hljs-bullet">-</span> 持久化策略

<span class="hljs-section">### ⚙️ [<span class="hljs-string">08-通用约束</span>](<span class="hljs-link">./08-通用约束.md</span>)</span>

<span class="hljs-bullet">-</span> 语言规范（中文注释）
<span class="hljs-bullet">-</span> 可观测性与兜底
<span class="hljs-bullet">-</span> 约束汇总

<span class="hljs-section">### 🎨 [<span class="hljs-string">09-样式规范</span>](<span class="hljs-link">./09-样式规范.md</span>)</span>

<span class="hljs-bullet">-</span> SCSS Modules 使用规范
<span class="hljs-bullet">-</span> 主题色 CSS 变量（NON-NEGOTIABLE）

<span class="hljs-section">### 📝 [<span class="hljs-string">10-文档规范</span>](<span class="hljs-link">./10-文档规范.md</span>)</span>

<span class="hljs-bullet">-</span> 注释规范
<span class="hljs-bullet">-</span> JSDoc 使用

<span class="hljs-section">### ✅ [<span class="hljs-string">11-测试规范</span>](<span class="hljs-link">./11-测试规范.md</span>)</span>

<span class="hljs-bullet">-</span> 测试覆盖要求
<span class="hljs-bullet">-</span> 质量门禁

<span class="hljs-section">## 使用说明</span>

<span class="hljs-bullet">1.</span> 根据需要的规范类型，点击对应的模块链接查看详细内容
<span class="hljs-bullet">2.</span> 所有规范文件都包含 <span class="hljs-code">`alwaysApply: true`</span> 标记，确保规范自动应用
<span class="hljs-bullet">3.</span> 详细示例与落地步骤见 <span class="hljs-code">`.agents/skills/`</span> 目录下的技能文件

<span class="hljs-section">## 快速查找</span>

| 需求 | 规范文件 |
|------|----------|
| 项目背景是什么？使用哪些技术栈？ | 01-项目概述 |
| 如何命名函数/变量？ | 02-编码规范 |
| 代码放在哪个目录？ | 03-项目结构 |
| 如何创建/拆分组件？ | 04-组件规范 |
| 如何调用接口？ | 05-API规范 |
| 如何配置路由？ | 06-路由规范 |
| 如何使用 Zustand？ | 07-状态管理 |
| 有哪些通用约束？ | 08-通用约束 |
| 如何使用主题变量？ | 09-样式规范 |
| 如何写注释？ | 10-文档规范 |
| 有何测试要求？ | 11-测试规范 |

</code></pre>
<p>更详细的 rules 落地示例见：<a href="https://juejin.cn/post/7603444191448104994" target="_blank" title="https://juejin.cn/post/7603444191448104994"><strong>《前端 AI Coding 落地指南（二）Rules 篇》</strong></a>。</p>
<hr/>
<h2 data-id="heading-5">Skills</h2>
<p><strong>Skills 是什么</strong>：用 Markdown 写的技能文件，教会 Agent 完成某一类任务。一个技能一个目录，必有 <code>SKILL.md</code>（YAML 头 + 步骤 + 示例），可带子规则。</p>
<p><strong>Skills 有什么用</strong>：按场景加载、渐进披露，例如在 Rules 划好边界的前提下给「怎么做」的步骤与示例拆分成 skills，避免大量 rules 导致上下文庞大，模型无法集中，出现幻觉和记忆丢失问题。</p>
<p><strong>开源 Skills</strong>：</p>
<p>有许多开源的优质 skills，直接安装到你的项目中大有裨益，在我的 React 项目中就用到了以下开源 skills</p>



































<table><thead><tr><th>技能</th><th>简介</th><th>使用环节</th></tr></thead><tbody><tr><td>vercel-react-best-practices</td><td>React 代码编写的最佳实践</td><td>页面/业务开发时按需引用</td></tr><tr><td>vercel-composition-patterns</td><td>复合组件、状态提升、避免 boolean props 等</td><td>设计组件 API、组合与状态时</td></tr><tr><td>web-design-guidelines</td><td>通用 UI/UX 设计指南</td><td>UI 分析、实现时参考</td></tr><tr><td>find-skills</td><td>查找并选用可用技能</td><td>需要发现技能时</td></tr><tr><td>skill-creator</td><td>创建新技能的结构与规范</td><td>扩展能力、新增 Skills 时</td></tr></tbody></table>
<p><strong>自封装 Skills</strong>：</p>
<p>除了开源 skills，你还可以自己封装 skills，当有固定步骤流程且会反复做的任务时，就可以封装成 Skill。在我的项目中就有以下两类自封装的 skill：</p>
<ol>
<li>
<p>从 Rules「怎么做」拆出来的（create-route、create-component、create-api、create-store、theme-variables）；</p>
</li>
<li>
<p>可复用的流程，给予 Agent 指导（create-proposal、design-analysis、ui-verification）。</p>
</li>
</ol>
<p>像 design-analysis、ui-verification 这种内容多的技能，还可以再把细分工具能力等拆到技能下的 rules 子目录里，充分发挥渐进披露的优势，SKILL 只做入口说明。</p>
<pre><code class="hljs language-text" lang="text">.agents/skills/
├── create-proposal/     # 创建提案（SDD proposal、tasks、spec 增量）
│   └── SKILL.md
├── design-analysis/     # 设计稿分析 → UI 分析清单
│   ├── SKILL.md
│   └── rules/          # 分析顺序、四类重点、工作流、输出模板、工具等
├── ui-verification/    # UI 验收 → 问题清单
│   ├── SKILL.md
│   └── rules/          # 比对维度、常见错误、工作流、工具等
├── create-route/       # 新增路由、Page、Loader
├── create-api/         # 新增接口、类型、请求封装
├── create-store/       # 新增 Zustand store
├── create-component/   # 新增/拆分组件
├── theme-variables/    # 主题 CSS 变量使用
└── README.md
</code></pre>
<p><strong>skills 在 AI Coding 过程中发挥的作用</strong>：</p>
<ul>
<li>创建 SDD 提案时同时使用 create-proposal；</li>
<li>有设计稿时用 design-analysis 产出 UI 分析清单；</li>
<li>页面/UI 开发时用 create-route、create-component、theme-variables；</li>
<li>实现完成后用 ui-verification 做还原验收；</li>
<li>业务开发/联调时用 create-api、create-store。</li>
<li>其他开源第三方 skills 在写代码、做架构决策时按需引用。</li>
</ul>
<p><strong>skills 目录下的 README</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: huayiyi-skills-index
<span class="hljs-section">description: 前端项目的技能索引，帮助 Agent 在具体开发场景下选择合适的技能文件。
---</span>

<span class="hljs-section"># 画衣衣项目技能索引</span>

项目在 <span class="hljs-code">`.agents/skills`</span> 下定义了一些与 RULE 配套的技能，用于承载<span class="hljs-strong">**具体实践步骤与示例代码**</span>，避免在 RULE 中塞入过多细节。

<span class="hljs-section">## 当前技能列表</span>

<span class="hljs-bullet">-</span> <span class="hljs-code">`create-api`</span>：创建与维护 HTTP 接口（配合 <span class="hljs-code">`05-API规范`</span> 使用）
<span class="hljs-bullet">-</span> <span class="hljs-code">`create-component`</span>：创建与拆分通用组件/页面级组件（配合 <span class="hljs-code">`03/04`</span> 使用）
<span class="hljs-bullet">-</span> <span class="hljs-code">`create-route`</span>：创建与维护路由目录与 Loader/Page（配合 <span class="hljs-code">`06-路由规范`</span> 使用）
<span class="hljs-bullet">-</span> <span class="hljs-code">`create-store`</span>：使用 Zustand 创建与维护全局状态（配合 <span class="hljs-code">`07-状态管理`</span> 使用）
<span class="hljs-bullet">-</span> <span class="hljs-code">`theme-variables`</span>：正确使用 Antd 与自定义主题 CSS 变量（配合 <span class="hljs-code">`09-样式规范`</span> 使用）

后续如有新的实践场景（例如：测试用例编写、文档撰写模板等），也建议以新的技能目录形式补充到本目录中。

</code></pre>
<p>更详细的 Skills 落地示例见：<a href="https://juejin.cn/post/7603347438013497379" target="_blank" title="https://juejin.cn/post/7603347438013497379"><strong>《前端 AI Coding 落地指南（三）Skills 篇》</strong></a>。</p>
<hr/>
<h2 data-id="heading-6">总结</h2>
<p><strong>当下的局限性</strong>：要高接纳率、少返工，需要较好的模型与算力；在无限额度、高配模型下稳定性才有保障，成本不低。配合 git worktree + 多 Agent 多任务并行，不计成本时接近 100% AI Coding 在技术上可行，成本和流程需按团队权衡。</p>
<p><strong>AI Coding 展望</strong>：模型会更聪明，上下文管理会更智能，交互会更简洁。在这套 MCP + Rules + Skills + SDD 的底座上，只靠 AI Coding 完成日常前端开发不会太远；先跑通「需求 → 提案 → 分析 → 开发 → 验收」闭环，再逐步扩展，接纳率和效率都会有可见提升。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端 AI Coding 落地指南（二）Rules篇]]></title>    <link>https://juejin.cn/post/7603444191448104994</link>    <guid>https://juejin.cn/post/7603444191448104994</guid>    <pubDate>2026-02-06T09:27:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603444191448104994" data-draft-id="7603288778678517795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端 AI Coding 落地指南（二）Rules篇"/> <meta itemprop="keywords" content="前端,AI编程"/> <meta itemprop="datePublished" content="2026-02-06T09:27:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AntonCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3966693684293240"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端 AI Coding 落地指南（二）Rules篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693684293240/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AntonCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:27:35.000Z" title="Fri Feb 06 2026 09:27:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本篇是《前端 AI Coding 落地指南》的续作，专门讲 <strong>Rules</strong> 的实践：演进过程、设计原则、如何划分模块、何时写 Rules 何时写 Skills，以及项目级 Rules 的完整清单与每条 rule 的头部、介绍和通用化示例。首篇中已给出 Rules 的简要历程与清单，这里展开为可落地的细节。</p>
<hr/>
<h2 data-id="heading-0">Rules 是什么、解决什么问题</h2>
<p><strong>Rules</strong> 是写在项目里的持久化指导，用 Markdown 等形式约定项目的规范、约束和惯例。Agent 在「需要确认某类规范时」按需读取对应规则文件，从而在生成或审查代码时遵守「做什么、不做什么」——命名、目录、接口契约、样式变量、错误处理等有据可查。</p>
<p><strong>作用</strong>：统一边界（减少模型随意发挥）、按需加载（控制上下文长度）、提高接纳率（生成结果更符合项目既有约定）。<strong>能解决的 AI Coding 问题</strong>：规范不一致（没有规则时 AI 易按通用习惯写，与项目脱节）；约束缺失（如「接口必须放某目录」不写进规则就容易漏）；上下文漂移（规则按场景拆分，需要时只加载相关文件，避免一次性塞入整本规范导致注意力分散）。</p>
<hr/>
<h2 data-id="heading-1">演进过程</h2>
<p><strong>一开始：整个项目一个庞大的 Rules</strong><br/>
所有规范、步骤、示例都塞在一个或少数几个大文件里。带来的问题是：单次上下文过大（容易顶到上下文上限或挤占对话）、容易丢记忆/注意力分散（长文档里模型容易「看了后面忘前面」）、难以按场景聚焦（比如只想加个路由，却不得不带着 UI 验收、设计稿分析等无关内容）。结果是步骤漏、检查项漏，接纳率反而不稳定。</p>
<p><strong>中期：按模块拆成多个 Rules</strong><br/>
把「项目概述、编码、结构、组件、API、路由、状态、通用约束、样式、文档、测试」等拆成 01～11 这样的独立文件，需要哪类规范就读哪几个。按需加载效果好很多，上下文压力下来，也便于维护。但还有一个问题没解决：「如何落地」的步骤和示例仍然写在 Rules 里——例如「怎么加一个路由」的详细步骤、目录示例、检查清单，和「路由必须和菜单一致」这类约束混在一起，单文件仍然偏长，且步骤化、可复用工作流不好跨项目复用。</p>
<p><strong>最近：Skills 盛行，Rules 简化 + 实施指导迁到 Skills</strong><br/>
引入 Skills 之后，做了两件事：<strong>Rules 只保留「原则与约束」</strong>（做什么、不做什么、目录/命名/契约），<strong>把「如何一步步做、怎么写示例、产出长什么样」迁到 Skills</strong>，并利用 Skills 的<strong>渐进式披露</strong>（只在执行该任务时加载对应 SKILL 和技能内 rules）。这样 Rules 变薄、按需读；具体落地在 Skills 里按场景加载，既避免上下文爆炸，又避免模型在长文档里「抓不住重点」。<strong>Skills 的详细实践、何时封装、技能下 rules 如何拆分见<a href="https://juejin.cn/post/7603347438013497379" target="_blank" title="https://juejin.cn/post/7603347438013497379">《前端 AI Coding 落地指南（三）Skills 篇》</a>。</strong></p>
<hr/>
<h2 data-id="heading-2">设计原则：哪些写 Rules、哪些写 Skills</h2>
<p><strong>原则概括</strong>：<strong>Rules 回答「是什么 / 不能是什么」，Skills 回答「怎么做 / 先做什么再做什么」。</strong></p>
<p><strong>模块划分</strong>：按「开发时会被问到的决策类型」来拆，而不是按代码目录拆。例如：项目背景与技术栈（项目概述）、命名与风格（编码规范）、文件放哪（项目结构）、组件怎么拆（组件规范）、接口怎么定义和调用（API 规范）、路由和菜单怎么对（路由规范）、状态放哪怎么用（状态管理）、全局约定（通用约束）、样式和主题（样式规范）、注释与测试（文档/测试规范）。这样 Agent 在「要做一个什么类型的决策」时，能对应到某一个或少数几个规则文件。</p>
<p><strong>什么留在 Rules</strong>：原则、约束、契约、目录与命名约定。例如「接口必须放在某目录下」「路由配置必须和菜单配置一致」「错误必须用统一方式处理」「主题色必须走 CSS 变量」——这些是「是/否」判断，不涉及长步骤和大量示例，适合放在 Rules，篇幅可控。</p>
<p><strong>什么放到 Skills</strong>：多步骤流程、检查清单、产出模板、示例代码。例如「创建提案的 5 步」「设计稿分析的 4 步」「加一个路由要创建哪几个文件、每步检查什么」「UI 分析清单/问题清单长什么样」——这些一旦写进 Rules 会让单文件很长，且和「原则」混在一起，不利于按场景加载；放到 Skills 里，用 SKILL.md + 技能内 rules 做渐进披露更合适。</p>
<p><strong>判断方式</strong>：若一句话能说清且不需要示例，放 Rules；若需要「第一步、第二步、检查点、模板、示例」，放 Skills。</p>
<hr/>
<h2 data-id="heading-3">项目级 Rules 清单（目录结构）</h2>
<pre><code class="hljs language-text" lang="text">.agents/rules/
├── 01-项目概述.md
├── 02-编码规范.md
├── 03-项目结构.md
├── 04-组件规范.md
├── 05-API规范.md
├── 06-路由规范.md
├── 07-状态管理.md
├── 08-通用约束.md
├── 09-样式规范.md
├── 10-文档规范.md
├── 11-测试规范.md
└── README.md
</code></pre>
<p>由于篇幅问题，以下每条 rule 示例是简化后的，主要作为参考，后续会把完整的代码放到 github 上。</p>
<hr/>
<h3 data-id="heading-4">01-项目概述</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 项目定位与技术栈概览。当需要了解项目背景、使用的技术栈时读取此规则。
---</span>

<span class="hljs-section"># 项目概述</span>

<span class="hljs-section">## 项目定位</span>
一段话说明项目是什么、面向谁、核心能力。

<span class="hljs-section">## 技术栈</span>
| 领域 | 技术 | 说明 |
|------|------|------|
| UI 框架 | React x.x | 强制使用 |
| 类型系统 | TypeScript x.x | 强制使用，禁止 JavaScript |
| 状态管理 | Zustand / Redux 等 | 统一使用，禁止其他方案 |
| 组件库 | Ant Design / 其他 | 交互 UI 基于此二次封装 |
| 样式方案 | SCSS Modules | 强制使用，禁止全局样式 |
</code></pre>
<hr/>
<h3 data-id="heading-5">02-编码规范</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 编码规范，包括 TypeScript 使用、命名约定（变量、常量、接口、组件等）、业务函数命名。编写或审查代码时读取。
---</span>

<span class="hljs-section"># 编码规范</span>

<span class="hljs-section">## TypeScript 规范</span>
<span class="hljs-bullet">-</span> 所有代码必须使用 TypeScript，禁止使用 JavaScript
<span class="hljs-bullet">-</span> 禁止使用 <span class="hljs-code">`any`</span>（除非有明确理由并注释）
<span class="hljs-bullet">-</span> 接口、类型使用 PascalCase；组件 Props 必须定义清晰接口

<span class="hljs-section">## 命名规范</span>
| 类型 | 规则 | 示例 |
|------|------|------|
| 文件夹/路由 | kebab-case | user-profile |
| 变量/函数 | camelCase | userList, onSubmit |
| 常量 | UPPER<span class="hljs-emphasis">_CASE | API_</span>TIMEOUT |
| 接口/类 | PascalCase | UserInfo |
| React 组件 | PascalCase | UserProfile |
| 自定义 Hooks | use 开头 | useUserStore |

<span class="hljs-section">## 业务函数命名</span>
<span class="hljs-bullet">-</span> 事件处理：onXxx（如 onSubmit）
<span class="hljs-bullet">-</span> 内部处理：handleXxx（如 handleDelete）
</code></pre>
<hr/>
<h3 data-id="heading-6">03-项目结构</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 目录结构规范，各目录用途与约束（禁止新建非标准目录）。确定代码放哪时读取。
---</span>

<span class="hljs-section"># 项目结构（NON-NEGOTIABLE）</span>

<span class="hljs-section">## 目录结构</span>
src/
├── assets/        # 静态资源
├── components/    # 可复用 UI 组件
├── constants/     # 业务常量、枚举
├── hooks/         # 自定义 Hook
├── http/          # 请求封装
├── interfaces/    # 类型声明（model、api）
├── routes/        # 路由页面
├── stores/        # 全局状态，按业务拆分
├── utils/         # 工具函数
└── 根级入口文件

<span class="hljs-section">## 结构约束</span>
<span class="hljs-bullet">-</span> 常量 → constants/；状态 → stores/；接口类型 → interfaces/（每模块含 model.ts、api.ts）
<span class="hljs-bullet">-</span> 组件 → components/ 或 routes/<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span></span>/components/；路由 → routes/，每路由含 Page、Loader、index.module.scss
</code></pre>
<hr/>
<h3 data-id="heading-7">04-组件规范</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 组件目录结构、样式方案、通用 vs 页面级。创建或拆分组件时读取。
---</span>

<span class="hljs-section"># 组件规范</span>

<span class="hljs-section">## 组件结构</span>
<span class="hljs-bullet">-</span> 组件在 src/components 或路由下 components，每组件单独目录
<span class="hljs-bullet">-</span> 文件：index.tsx、index.module.scss；必须 SCSS Modules，禁止全局样式
<span class="hljs-bullet">-</span> Props 接口必须明确；使用 classnames 管理动态 class

<span class="hljs-section">## 组件层级</span>
<span class="hljs-bullet">-</span> 页面级：仅单页使用 → routes/<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">page</span>&gt;</span></span>/components/
<span class="hljs-bullet">-</span> 通用：跨页面复用 → src/components/
<span class="hljs-bullet">-</span> 单文件建议不超过 400 行（拆分参考）
</code></pre>
<hr/>
<h3 data-id="heading-8">05-API规范</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 接口请求封装、函数命名、错误处理。新增或修改接口时读取。
---</span>

<span class="hljs-section"># API 规范</span>

<span class="hljs-section">## 接口请求规范</span>
<span class="hljs-bullet">-</span> 请求使用 src/http 下封装；类型 Params/Body/Response 放在 src/interfaces/<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span></span>/api.ts
<span class="hljs-bullet">-</span> 所有接口集中在 src/http/<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span></span>.ts

<span class="hljs-section">## 接口函数命名（NON-NEGOTIABLE）</span>
| 操作 | 命名规则 | 示例 |
|------|----------|------|
| 获取列表 | getXxxList | getBannerList |
| 获取详情 | getXxxDetail | getBannerDetail |
| 创建/更新/删除 | createXxx / updateXxx / deleteXxx | 禁止 fetch 前缀 |

<span class="hljs-section">## 错误处理（NON-NEGOTIABLE）</span>
<span class="hljs-bullet">-</span> 接口错误由拦截器统一处理，业务代码只处理成功逻辑；禁止重复 message.error
</code></pre>
<hr/>
<h3 data-id="heading-9">06-路由规范</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 路由目录结构、Page/Loader 模式、路由配置集中管理。新增页面或配置路由时读取。
---</span>

<span class="hljs-section"># 路由规范（NON-NEGOTIABLE）</span>

<span class="hljs-section">## 路由结构</span>
<span class="hljs-bullet">-</span> 路由目录在 src/routes 下，每页单独目录，kebab-case
<span class="hljs-bullet">-</span> 必须包含：Page.tsx、Loader.tsx、index.module.scss
<span class="hljs-bullet">-</span> Loader 只负责懒加载对应 Page，不嵌套 Routes/Route

<span class="hljs-section">## 路由与菜单</span>
<span class="hljs-bullet">-</span> 禁止多处维护路由：全局唯一路由配置集中管理
<span class="hljs-bullet">-</span> 同一页面只在一处被 lazy 引入
</code></pre>
<hr/>
<h3 data-id="heading-10">07-状态管理</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 全局状态使用 Zustand（或项目约定方案）。新增或重构状态时读取。
---</span>

<span class="hljs-section"># 状态管理规范（NON-NEGOTIABLE）</span>

<span class="hljs-section">## 基础规范</span>
<span class="hljs-bullet">-</span> 必须使用项目约定的状态库（如 Zustand），所有 store 放在 src/stores
<span class="hljs-bullet">-</span> 禁止在 src 下新建其他目录存放 store

<span class="hljs-section">## Store 组织</span>
<span class="hljs-bullet">-</span> 按业务模块划分，每模块单独文件；暴露 useXxxStore Hook
<span class="hljs-bullet">-</span> Store 只存数据与业务行为，不耦合 UI 组件
<span class="hljs-bullet">-</span> 需持久化时使用 persist 等中间件
</code></pre>
<hr/>
<h3 data-id="heading-11">08-通用约束</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 语言、可观测性、占位元素等通用约束。确认通用约束时读取。
---</span>

<span class="hljs-section"># 通用约束</span>

<span class="hljs-section">## 语言规范（NON-NEGOTIABLE）</span>
<span class="hljs-bullet">-</span> 文档和代码注释使用中文；变量/函数命名仍用英文

<span class="hljs-section">## 可观测性与兜底</span>
<span class="hljs-bullet">-</span> 任务需完整链路：任务 ID、引用、日志；失败时兜底提示与重试

<span class="hljs-section">## 占位元素</span>
<span class="hljs-bullet">-</span> 图标/图片未定时：用占位 div + TODO 注释，禁止临时 svg/占位图服务；明确标记替换点
</code></pre>
<hr/>
<h3 data-id="heading-12">09-样式规范</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: SCSS Modules、主题 CSS 变量。编写样式或主题适配时读取。
---</span>

<span class="hljs-section"># 样式规范</span>

<span class="hljs-section">## 基础原则</span>
<span class="hljs-bullet">-</span> 样式采用 SCSS Modules（index.module.scss）；classnames 管理动态 class
<span class="hljs-bullet">-</span> 自定义样式必须使用主题色 CSS 变量，禁止硬编码颜色

<span class="hljs-section">## 主题变量（NON-NEGOTIABLE）</span>
<span class="hljs-bullet">-</span> 主色/文本/背景/边框等使用 var(--ant-color-xxx) 或项目自定义 var(--xxx)
<span class="hljs-bullet">-</span> 确保主题切换（浅色/暗色）一致
</code></pre>
<hr/>
<h3 data-id="heading-13">10-文档规范</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: JSDoc 与注释规范。编写或审查注释时读取。
---</span>

<span class="hljs-section"># 文档规范</span>

<span class="hljs-section">## 注释规范</span>
<span class="hljs-bullet">-</span> 使用 JSDoc（/** <span class="hljs-emphasis">*/），解释「为什么」而非「是什么」
- 文件头、函数/方法、复杂逻辑、类型定义均需必要说明
</span></code></pre>
<hr/>
<h3 data-id="heading-14">11-测试规范</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 测试覆盖与质量门禁。确认测试要求时读取。
---</span>

<span class="hljs-section"># 测试规范</span>

<span class="hljs-section">## 测试要求</span>
<span class="hljs-bullet">-</span> 新增功能需必要类型定义，关键业务逻辑需测试用例
<span class="hljs-bullet">-</span> 所有代码通过 TypeScript 与 ESLint 检查
</code></pre>
<hr/>
<p>以上就是项目级 Rules 的完整清单与通用化示例。项目级 Skills 的逐条示例在<a href="https://juejin.cn/post/7603347438013497379" target="_blank" title="https://juejin.cn/post/7603347438013497379">《前端 AI Coding 落地指南（三）Skills 篇》</a>；<a href="https://juejin.cn/post/7603347438013480995#heading-4" target="_blank" title="https://juejin.cn/post/7603347438013480995#heading-4">架构篇</a>、Rules 篇、Skills 篇一起构成从架构到 Rules/Skills 落地的完整指南。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android应用冷启动优化：从测量方法到分层实践]]></title>    <link>https://juejin.cn/post/7603321550247100466</link>    <guid>https://juejin.cn/post/7603321550247100466</guid>    <pubDate>2026-02-06T09:07:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603321550247100466" data-draft-id="7593338828218531855" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android应用冷启动优化：从测量方法到分层实践"/> <meta itemprop="keywords" content="Android,性能优化,源码阅读"/> <meta itemprop="datePublished" content="2026-02-06T09:07:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="光光跬步"/> <meta itemprop="url" content="https://juejin.cn/user/1286855157887751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android应用冷启动优化：从测量方法到分层实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1286855157887751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    光光跬步
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:07:37.000Z" title="Fri Feb 06 2026 09:07:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>优化Android 应用启动速度是性能优化中重要的一环，当启动速度过慢时，用户可能不愿意等待，从而直接关闭应用。启动速度这不仅影响应用日活，还会影响应用的留存率。</p>
<blockquote>
<p>注意：本文出现的源码基于Android - 15.0.0_r1。另外本文关注主要逻辑，省略部分代码。</p>
</blockquote>
<h2 data-id="heading-1">本文大纲</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63f3fea9189f4a04b52d1186e432e048~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=gFgKCmkLJm%2F7dPTcFmZfeNgKxQQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">一、启动类型</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce2e6a580cb7461499f86c104cc23967~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=dcrw%2F81Uk9g3L0aU%2BnDo%2BOw3t7U%3D" alt="image.png" loading="lazy"/></p>
<p>Android App启动种类共3种：冷启动，温启动，热启动。<br/>
接下来，我们简要介绍这三种启动类型。</p>
<h4 data-id="heading-3">1.1 冷启动</h4>
<ul>
<li><strong>条件</strong>：应用进程完全不存在（被系统杀死或首次启动）</li>
<li><strong>过程</strong>：创建进程 → 初始化应用 → 创建Activity → 渲染界面</li>
<li><strong>特点</strong>：耗时最长，涉及完整启动链，是性能优化的主要目标</li>
</ul>
<h4 data-id="heading-4">1.2 温启动</h4>
<ul>
<li><strong>条件</strong>：应用进程存在，但Activity被销毁（如系统内存回收）</li>
<li><strong>过程</strong>：进程已存在 → 重新创建Activity → 渲染界面</li>
<li><strong>特点</strong>：耗时中等，跳过部分初始化，但仍需重建Activity</li>
</ul>
<h4 data-id="heading-5">1.3 热启动</h4>
<ul>
<li><strong>条件</strong>：应用进程和Activity都在内存中（如按Home键返回）</li>
<li><strong>过程</strong>：直接将Activity从后台带到前台</li>
<li><strong>特点</strong>：耗时最短，近乎瞬间，主要涉及界面切换</li>
</ul>
<h2 data-id="heading-6">二、测量指标</h2>
<p>要想知道启动速度优化的效果，我们就得知道优化前后冷启动时间，因此接下来看看测量指标。</p>
<p>启动时间分为2种: TTID 和 TTFD。</p>
<h3 data-id="heading-7">2.1 初始显示时间 (TTID)</h3>
<p>初始显示所用时间 (TTID) 是指显示应用界面的第一帧所用的时间。此指标用于测量应用生成第一帧所用的时间，包括冷启动期间的进程初始化、冷启动或温启动期间的 activity 创建，以及显示第一帧。包括以下事件序列的总经过时间：</p>
<ul>
<li>启动进程。</li>
<li>初始化对象。</li>
<li>创建并初始化 activity。</li>
<li>膨胀布局。</li>
<li>首次绘制应用。</li>
</ul>
<h3 data-id="heading-8">2.2 完全显示时间 (TTFD)</h3>
<p>完全显示时间 (TTFD) 是指应用达到可与用户互动的状态所用的时间。系统会报告显示应用界面的第一帧以及在显示第一帧后异步加载的内容所需的时间。一般情况下，这是从网络或磁盘加载的主要内容（由应用报告）。换句话说，TTFD 包括 TTID 以及应用可供使用所需的时间。</p>
<h3 data-id="heading-9">2.3 小结</h3>
<p>TTID : 显示应用界面的第一帧所用的时间<br/>
TTFD: 应用达到可与用户互动的状态所用的时间 (TTID + 应用可供使用所需的时间)</p>
<h2 data-id="heading-10">三、测量方法</h2>
<p>看完了测量指标，我们再看看有哪些测量启动时间的方法。</p>
<h3 data-id="heading-11">3.1 基础工具：AS日志与ADB命令</h3>
<h4 data-id="heading-12">3.1.1 Android Studio Logcat命令查看</h4>
<p>Android Studio中查看日志，过滤 tag:ActivityTaskManager Displayed
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/282fb8ecfa4e4945bcf54b547d42e089~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=fjjr5UVO4kiaXVmDOXWwQdZkFys%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>注：这个日志是显式的初始显示所用时间 (TTID)</p>
</blockquote>
<h4 data-id="heading-13">3.1.2 adb shell am start -W命令</h4>
<p>adb shell am start -W 包名/首屏Activity<br/>
比如：adb shell am start -W com.xxx.xxx/com.xxx.xxx.MainActivity
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acb40c82663c4932a0139a8a846e0541~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=noM5dCMclx3NwTEa98DnQvx7JAs%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>ThisTime:：最后一个Activity启动耗时</li>
<li>TotalTime：所有Acitivity启动耗时</li>
<li>WaitTime：AMS启动Activity的总耗时</li>
</ul>
<p>注：ThisTime &lt;= TotalTime &lt; WaitTime</p>
<h3 data-id="heading-14">3.2 官方方案：Jetpack Macrobenchmark</h3>
<p>谷歌官方的 <strong>Jetpack Macrobenchmark</strong> 可以用来测量启动时间, 它的使用也是很方便的：
New -&gt; New Module -&gt; 选择Benchmark -&gt; 点击Finish即可
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/166d5ec97c384af9b79d7dd8f975b724~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=AQwK%2FJqi6iaUJQQMDwqORTjZMtQ%3D" alt="image.png" loading="lazy"/></p>
<p>如下是定义一个测试次数为5次的冷启动测试</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-meta">@RunWith(AndroidJUnit4::class)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleStartupBenchmark</span> {
    <span class="hljs-meta">@get:Rule</span>
    <span class="hljs-keyword">val</span> benchmarkRule = MacrobenchmarkRule()

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startup</span><span class="hljs-params">()</span></span> = benchmarkRule.measureRepeated(
        <span class="hljs-comment">// 被测应用的包名</span>
        packageName = <span class="hljs-string">"com.xxx.xxx"</span>,
        <span class="hljs-comment">// 基准测试中提取的主要信息类型</span>
        metrics = listOf(StartupTimingMetric()),
        <span class="hljs-comment">// 设置测试次数</span>
        iterations = <span class="hljs-number">5</span>,
        <span class="hljs-comment">// 设置启动模式为</span>
        startupMode = StartupMode.COLD
    ) {
        pressHome()
        startActivityAndWait()
    }
}
</code></pre>
<blockquote>
<p>如果要测量TTFD，记得在<strong>应用页面</strong>(不是在Macrobenchmark模块)中调用 ComponentActivity#reportFullyDrawn 方法</p>
</blockquote>
<p>测试完成后，会展示简略的测试结果，显示TTID TTFD
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e289de04465c4a859be7a3ea54224eca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=sHEvaxLA%2BNbChXah12pYtbU7QPI%3D" alt="image.png" loading="lazy"/></p>
<p>而在benchmark/build/outputs/connected_android_test_additional_output/benchmark/connected/设备名 下面会生成测试报告
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3c5ce7d29fe404da63b797a14c1423a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=BHz5Jl63ZiCHzUXh86Qy7tG5JOQ%3D" alt="image.png" loading="lazy"/></p>
<p>打开包名-benchmarkData.json可以看到此次测试的设备信息，每次测试的时间、
最长/短启动时间、P50</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// 设备信息</span>
    ... 
    <span class="hljs-attr">"benchmarks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"startup"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"className"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.xxx.xxx"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"totalRunTimeNs"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">58688817257</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"metrics"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"timeToInitialDisplayMs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                    <span class="hljs-attr">"minimum"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">547.887593</span><span class="hljs-punctuation">,</span>
                    <span class="hljs-attr">"maximum"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">641.342603</span><span class="hljs-punctuation">,</span>
                    <span class="hljs-attr">"median"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">583.550673</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// P50</span>
                    <span class="hljs-attr">"coefficientOfVariation"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.05969737243251711</span><span class="hljs-punctuation">,</span>
                    <span class="hljs-attr">"runs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                        <span class="hljs-number">641.342603</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-number">612.770907</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-number">580.224135</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-number">583.550673</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-number">547.887593</span>
                    <span class="hljs-punctuation">]</span>
                <span class="hljs-punctuation">}</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            ...
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>生成的.perfetto-trace，我们可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fui.perfetto.dev%2F" target="_blank" title="https://ui.perfetto.dev/" ref="nofollow noopener noreferrer">ui.perfetto.dev/</a> 打开它，截图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b12be93e3b74432dbdd348dba58ab935~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=itEGEi%2BIXOP%2FWQTvbLx9NYLukx8%3D" alt="image.png" loading="lazy"/></p>
<p>当然 Android Studio 也是可以打开(open-&gt;选择要打开的文件)这种类型的文件，截图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07bb20636a7d4eb4935c1a155fed4618~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=RzvupjMdHxQWmfqt5nKwFwDctsI%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>Macrobenchmark官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Ftopic%2Fperformance%2Fbenchmarking%2Fmacrobenchmark-overview%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.google.cn/topic/performance/benchmarking/macrobenchmark-overview?hl=zh-cn" ref="nofollow noopener noreferrer">Jetpack Macrobenchmark</a>; Macrobenchmark官方Demo: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fperformance-samples" target="_blank" title="https://github.com/android/performance-samples" ref="nofollow noopener noreferrer">github.com/android/per…</a></p>
</blockquote>
<h3 data-id="heading-15">3.3 自动化测试脚本</h3>
<h4 data-id="heading-16">3.3.1 开发原因</h4>
<p>AS日志与ADB命令测试方便但只能测试一次，多次测试需要重复操作，且无法统计P50, P90等信息，也没有当前设备信息。</p>
<p>而官方的Macrobenchmark呢，笔者发现国内设备(测试华为Y9, iqoo13)上，使用Macrobenchmark无法测试。想使用一种更通用的方式，编写脚本不失为一种好的方式，脚本测试方便且通用。因脚本内容较长，故放在了github上。详见<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FStudyH2g%2FAndroidStartupOptimizationDemo%2Fblob%2Fmain%2Fapp_launch_benchmark.sh" target="_blank" title="https://github.com/StudyH2g/AndroidStartupOptimizationDemo/blob/main/app_launch_benchmark.sh" ref="nofollow noopener noreferrer">AndroidStartupOptimizationDemo</a></p>
<blockquote>
<p>注：此脚本参考了马哥的脚本，详见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FvW6-zag2CKrFgcYAPdeUFg" target="_blank" title="https://mp.weixin.qq.com/s/vW6-zag2CKrFgcYAPdeUFg" ref="nofollow noopener noreferrer">App冷启动优化测试干货分享（一）</a>。笔者做了以下改动：1.合并了app_launch_benchmark.sh 和 app_config.cfg。2.添加了P50, P90, P95和设备信息(如Android系统版本，内存信息等)；3.生成start_up_reports文件夹，将启动报告统一放在了此文件夹下；4.多次测试会卡住，添加adb server 重启策略和超时处理</p>
</blockquote>
<h4 data-id="heading-17">3.3.2 使用方式</h4>
<ol>
<li>复制脚本到项目根目录下</li>
<li>修改包名和MainActivity为当前应用</li>
</ol>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 内置默认配置（原 app_config.cfg）</span>
<span class="hljs-comment"># ============================================</span>
DEFAULT_CONFIG_CONTENT=$(<span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># App启动时间测试配置文件</span>
<span class="hljs-comment"># 格式：包名|Activity类名|显示名称|启动类型|备注</span>

<span class="hljs-comment"># 系统应用 - 冷启动测试</span>
<span class="hljs-comment"># com.android.settings|com.android.settings.Settings|系统设置|cold|冷启动测试</span>
<span class="hljs-comment"># com.android.dialer|com.android.dialer.main.impl.MainActivity|拨号器|cold|冷启动测试</span>

<span class="hljs-comment"># 第三方应用</span>
<span class="hljs-comment"># com.tencent.mm|com.tencent.mm.ui.LauncherUI|微信|cold|社交应用冷启动</span>
<span class="hljs-comment"># com.taobao.taobao|com.taobao.tao.homepage.MainActivity3|淘宝|warm|电商应用温启动</span>
<span class="hljs-comment"># 此处添加当前应用信息</span>
</code></pre>
<ol start="3">
<li>git命令行执行当前脚本</li>
</ol>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 使用方式</span>
<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># ./app_launch_benchmark.sh                     # 使用默认配置测试</span>
<span class="hljs-comment"># ./app_launch_benchmark.sh -n 5      # 测试5次</span>
<span class="hljs-comment"># ./app_launch_benchmark.sh -c xxx.cfg -n 5 # 自定义配置，测试5次</span>
</code></pre>
<h4 data-id="heading-18">3.3.3 测试截图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0288a98a4c1a4033a344de24eda0e1e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=dHw4dj96xZoUJ8oYW3vZOewUC0k%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-19">四、优化方法</h2>
<h3 data-id="heading-20">4.1 常规优化</h3>
<h4 data-id="heading-21">4.1.1 收敛ContentProviders</h4>
<h5 data-id="heading-22">原理</h5>
<p>在应用启动流程中，会安装ContentProvider。时序图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa0b5c1347f64e38b99b1a56493fd7f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=lVmFcHD%2BJUCjdbJPACsDTQXqgP4%3D" alt="image.png" loading="lazy"/></p>
<p>ActivityThread#installContentProviders的代码如下：</p>
<pre><code class="hljs language-Java" lang="Java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleBindApplication</span><span class="hljs-params">(AppBindData data)</span> {
        ...
        
        <span class="hljs-comment">// 安装ContentProvider</span>
        installContentProviders(app, data.providers);
        ...
    }
</code></pre>
<p>在应用启动的 ActivityThread#handleBindApplication 阶段，系统会调用 installContentProviders。如果 Manifest 中声明了多个 Provider（如 Firebase、Facebook SDK 各自带一个），系统会<strong>串行</strong>初始化它们，这会占用主线程几十到上百毫秒。</p>
<h5 data-id="heading-23">优化方案</h5>
<p>使用 Jetpack Startup 将多个 Provider 合并为一个初始化入口</p>
<p>首先要确定当前应用有哪些ContentProvider，使用 AS 打开 Apk/aab里面的Manifest</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>
    &lt;<span class="hljs-attr">application</span>
        <span class="hljs-attr">...</span>
        &lt;<span class="hljs-attr">provider</span>
            <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.facebook.internal.FacebookInitProvider"</span>
            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>
            <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"com.xxx.xxx.FacebookInitProvider"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">provider</span>
            <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.google.mlkit.common.internal.MlKitInitProvider"</span>
            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>
            <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"com.xxx.xxx.mlkitinitprovider"</span>
            <span class="hljs-attr">android:initOrder</span>=<span class="hljs-string">"99"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">provider</span>
            <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.google.firebase.provider.FirebaseInitProvider"</span>
            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>
            <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"com.xxx.xxx.firebaseinitprovider"</span>
            <span class="hljs-attr">android:initOrder</span>=<span class="hljs-string">"100"</span>
            <span class="hljs-attr">android:directBootAware</span>=<span class="hljs-string">"true"</span> /&gt;</span>
         ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
</code></pre>
<p>比如当前示例App的Manifest中，未收敛时有3个ContentProvider,</p>
<p>官方提供了Jetpack StartUp, 我们可以用它来收敛ContentProvider，使用方法如下：<br/>
首先定义各个启动器</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FirebaseCombinedInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        <span class="hljs-comment">// 初始化 FirebaseApp, 防止未 initialize 报错</span>
        FirebaseApp.initializeApp(context)

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取 Firebase Analytics 的 appInstanceId</span>
            FirebaseAnalytics.getInstance(context).appInstanceId
                .addOnCompleteListener { task -&gt;
                    task.result?.let { id -&gt;
                        SpUtil.saveStringData(SpKeyConstants.FIREBASE_ID, id)
                    }
                }
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Timber.tag(<span class="hljs-string">"FirebaseInit"</span>).e(e, <span class="hljs-string">"获取 appInstanceId 失败"</span>)
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; = emptyList()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FacebookManualInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        <span class="hljs-comment">// 使用协程在后台线程激活 App Events，避免阻塞</span>
        CoroutineScope(Dispatchers.IO).launch {
            <span class="hljs-keyword">try</span> {
                AppEventsLogger.activateApp(context <span class="hljs-keyword">as</span> Application)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                <span class="hljs-comment">// 忽略初始化失败，避免影响启动</span>
            }
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;?&gt;?&gt; = emptyList()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MlKitManualInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        MlKit.initialize(context)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;?&gt;?&gt; = emptyList()
}
</code></pre>
<p>然后修改Manifest</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">provider</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">"androidx.startup.InitializationProvider"</span>
    <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"${applicationId}.androidx-startup"</span>
    <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Firebase 初始化，无依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
        <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.xxxr.FirebaseCombinedInitializer"</span>
        <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- ML Kit 初始化，无依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
        <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.xxx.MlKitManualInitializer"</span>
        <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- Facebook 初始化，无依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
        <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.xxx.FacebookManualInitializer"</span>
        <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">provider</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">provider</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.google.firebase.provider.FirebaseInitProvider"</span>
    <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"${applicationId}.firebaseinitprovider"</span>
    <span class="hljs-attr">tools:node</span>=<span class="hljs-string">"remove"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">provider</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.facebook.internal.FacebookInitProvider"</span>
    <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"${applicationId}.FacebookInitProvider"</span>
    <span class="hljs-attr">tools:node</span>=<span class="hljs-string">"remove"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">provider</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.google.mlkit.common.internal.MlKitInitProvider"</span>
    <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"${applicationId}.mlkitinitprovider"</span>
    <span class="hljs-attr">tools:node</span>=<span class="hljs-string">"remove"</span> /&gt;</span>
</code></pre>
<p>到这里就结束了，实际操作其实不复杂。</p>
<h5 data-id="heading-24">验证</h5>
<p>最后验证下是否生效了，我们打开收敛后Apk中的Mainfest文件</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>
    &lt;<span class="hljs-attr">application</span>
        <span class="hljs-attr">...</span>
        &lt;<span class="hljs-attr">provider</span>
            <span class="hljs-attr">android:name</span>=<span class="hljs-string">"androidx.startup.InitializationProvider"</span>
            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>
            <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"com.xxx.androidx-startup"</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
                <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.AppsFlyerInitializer"</span>
                <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
                <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.initializer.FirebaseCombinedInitializer"</span>
                <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
                <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.initializer.MlKitManualInitializer"</span>
                <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
                <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.initializer.FacebookManualInitializer"</span>
                <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>

            ...
        <span class="hljs-tag">&lt;/<span class="hljs-name">provider</span>&gt;</span>
        ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
</code></pre>
<p>可以看到，收敛后Apk的Manifest中，仅有1个ContentProvider</p>
<h5 data-id="heading-25">优化效果</h5>





























<table><thead><tr><th>时间类型</th><th>未优化</th><th>优化后</th><th>减少幅度</th></tr></thead><tbody><tr><td>P50</td><td>465ms</td><td>436ms</td><td>-29ms (-6.24%)</td></tr><tr><td>P90</td><td>476ms</td><td>446ms</td><td>-30ms (-6.30%)</td></tr><tr><td>P95</td><td>480<br/></td><td>451ms</td><td>-29ms (-6.04%)</td></tr></tbody></table>
<blockquote>
<p>详细的测试数据请看<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FStudyH2g%2FAndroidStartupOptimizationDemo%2Ftree%2Ffeature%2Fcontent-provider%2Fstart_up_reports" target="_blank" title="https://github.com/StudyH2g/AndroidStartupOptimizationDemo/tree/feature/content-provider/start_up_reports" ref="nofollow noopener noreferrer">AndroidStartupOptimizationDemo/start_up_reports at feature/content-provider</a></p>
</blockquote>
<h4 data-id="heading-26">4.1.2 初始化优化与任务调度</h4>
<h5 data-id="heading-27">时机优化</h5>
<p><strong>a.延迟/按需初始化</strong></p>
<p>对于启动非必要的任务，我们可以延迟/按需它的初始化，减少初始化的任务，从而减少应用启动的时间。<br/>
比如上面的MlKitManualInitializer，它其实是非启动必需的任务，用户并不是每次使用应用，都需要用到人脸识别，因此我们可以在调用它之前的页面，去初始化它。还可以进一步根据后端返回字段，如果xx接口返回此次需要使用人脸识别，那么我们再初始化它。</p>
<p><strong>b.异步初始化</strong></p>
<p>对于启动必需但不需要同步的任务，我们可以通过异步初始化，这样就不会阻塞主线程，从而减少应用启动的时间。</p>
<p><strong>c.首屏数据加载策略</strong></p>
<p>对于启动后立即需要的首屏数据（如用户信息、配置列表），其加载也属于启动必需但无需阻塞主线程的任务。我们可以进一步优化：</p>
<ul>
<li><strong>并行请求</strong>：将多个独立的数据请求并行发起，而非串行等待。</li>
<li><strong>高效解析</strong>：选用性能更优的序列化库（如替换默认的Gson为Kotlin serialization或Moshi），减少数据反序列化的CPU耗时。详见<a href="https://juejin.cn/post/7287083662758379554" target="_blank" title="https://juejin.cn/post/7287083662758379554">常用 JSON 库性能对比: Gson VS Moshi VS Kotlin Serialization VS ...</a></li>
<li><strong>缓存优先</strong>：对于不要求实时数据的首屏页面，可以先展示缓存页面，后进行网络更新，即优先展示本地缓存数据，让UI快速可交互，后台再更新数据。</li>
</ul>
<p>这些策略虽不直接影响 TTID，但能显著缩短 TTFD，让用户更快地开始使用应用。</p>
<p><strong>d.优化效果</strong></p>
<p>在示例App中，使用收敛ContentProvider、异步初始化任务和延迟初始化后的优化前后对比如下：</p>





























<table><thead><tr><th>时间类型</th><th>未优化</th><th>优化后</th><th>减少幅度</th></tr></thead><tbody><tr><td>P50</td><td>465ms</td><td>436ms</td><td>-29ms (-6.23%)</td></tr><tr><td>P90</td><td>476ms</td><td>445ms</td><td>-31ms (-6.51%)</td></tr><tr><td>P95</td><td>480<br/></td><td>449ms</td><td>-31ms (-6.46%)</td></tr></tbody></table>
<blockquote>
<p>详细的测试数据请看<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FStudyH2g%2FAndroidStartupOptimizationDemo%2Ftree%2Ffeature%2Finit-optimization-strategy%2Fstart_up_reports" target="_blank" title="https://github.com/StudyH2g/AndroidStartupOptimizationDemo/tree/feature/init-optimization-strategy/start_up_reports" ref="nofollow noopener noreferrer">AndroidStartupOptimizationDemo/start_up_reports at feature/init-optimization-strategy</a></p>
</blockquote>
<h5 data-id="heading-28">编排初始化任务</h5>
<p>在初始化任务时，应用可能会存在依赖的情况，如任务A的初始化完成后，任务B的初始化才能正常执行。我们先画出任务间依赖关系的有向图，先理清任务间的关系，后续使用官方的 <strong>StartUp</strong> 来编排任务。</p>
<p>举个例子，现有任务a,b,c,d,e，然后 c依赖a，d依赖b，然后 e依赖d，c。<br/>
先画出有向无环图，如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3925bc5a4e04a7295ac0069e1c2495c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=F8ScsZ1pdlWawvPq3k1o7Fg0KpE%3D" alt="image.png" loading="lazy"/></p>
<p>之后创建各个任务的启动器</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        Log.d(<span class="hljs-string">"AInitializer"</span>, <span class="hljs-string">"create: AInitializer"</span>)
    }

    <span class="hljs-comment">// A无依赖</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; = emptyList()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        Log.d(<span class="hljs-string">"BInitializer"</span>, <span class="hljs-string">"create: BInitializer"</span>)
    }

    <span class="hljs-comment">// B无依赖</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; = emptyList()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        Log.d(<span class="hljs-string">"CInitializer"</span>, <span class="hljs-string">"create: CInitializer"</span>)
    }

    <span class="hljs-comment">// C依赖A</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; =
        listOf(AInitializer::<span class="hljs-keyword">class</span>.java)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        Log.d(<span class="hljs-string">"DInitializer"</span>, <span class="hljs-string">"create: DInitializer"</span>)
    }

    <span class="hljs-comment">// D依赖B</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; =
        listOf(BInitializer::<span class="hljs-keyword">class</span>.java)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        Log.d(<span class="hljs-string">"EInitializer"</span>, <span class="hljs-string">"create: EInitializer"</span>)
    }

    <span class="hljs-comment">// E依赖C,D</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; =
        listOf(CInitializer::<span class="hljs-keyword">class</span>.java, DInitializer::<span class="hljs-keyword">class</span>.java)
}
</code></pre>
<p>后续在manifest中，声明E的启动器即可，StartUp 会自动解析依赖关系</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">application</span>
        <span class="hljs-attr">...</span>
        &lt;<span class="hljs-attr">provider</span>
            <span class="hljs-attr">android:name</span>=<span class="hljs-string">"androidx.startup.InitializationProvider"</span>
            <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"${applicationId}.androidx-startup"</span>
            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>
            <span class="hljs-attr">tools:node</span>=<span class="hljs-string">"merge"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
                <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.xxx.initializer.EInitializer"</span>
                <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">provider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
</code></pre>
<p>后续运行代码，打印日志如下：<br/>
create: AInitializer<br/>
create: CInitializer<br/>
create: BInitializer<br/>
create: DInitializer<br/>
create: EInitializer</p>
<h4 data-id="heading-29">4.1.3 基准配置文件</h4>
<p>基准配置文件是官方推荐使用的一种优化方式，下面先看看它的原理吧。</p>
<h5 data-id="heading-30">原理</h5>
<p>我们可以通过一个生活中的例子来理解它的工作原理：第一次到朋友家，他让我们帮忙找东西。当没有使用基准配置文件时，就相当于我们不知道东西在哪里，那么只能每个房间、每个位置都翻找一遍；而使用基准配置文件后，就相当于朋友提前给了我们一份文件清单，上面清楚标明了每样东西的位置，我们按图索骥，就能快速找到目标。</p>
<p><strong>这个文件清单，对应的就是基准配置文件（Profile-Guided Optimization，PGO）技术生成的热点代码清单（baseline-prof.txt）。</strong></p>
<p>在技术层面，传统的AOT（提前）编译会试图编译所有代码，这往往导致应用安装缓慢且包体积增大。而PGO则反其道而行之：它通过在真实设备上运行应用，记录下实际使用时的关键执行路径（例如启动过程），从而生成一份针对性的“热点代码清单”。</p>
<p>ART运行时在<strong>两个时机</strong>使用这份清单：</p>
<ol>
<li><strong>安装时</strong>：对清单中的方法进行AOT编译</li>
<li><strong>后台优化</strong>：设备空闲时，根据实际使用情况进一步优化</li>
</ol>
<p>这样既减少了运行时解释/JIT开销，又避免了"全量编译"的弊端。</p>
<h5 data-id="heading-31">使用基准配置文件</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f39147c7018e471dbc965026b41a330e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=QnK31F10BrfyMV3NcvSqvSaxEdY%3D" alt="image.png" loading="lazy"/><br/>
在AS中选择 File -&gt; New -&gt; New Module</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87efbfcf8fb44acebeb95cd98f4040ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=lV8kXVMSIrssPKEH4Ver%2FJ4ZP6I%3D" alt="image.png" loading="lazy"/>
选择Baseline Profile Generator，点击Finish。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed716e0d8457490991e072d4d32948ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=OAdccydig1qR6I8nzn7eTcDD1L4%3D" alt="image.png" loading="lazy"/><br/>
之后会生成一个名为 BaselineProfile 的新模块。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aac78e2c87d41f9a63798d19ceea5cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=8QHxIgf0qcTs5C%2BWlvU%2BPD36FqQ%3D" alt="image.png" loading="lazy"/>
现在点击运行 Generate Baseline Profile for app，提示Error: Target module's selected variant is debuggable. Please use Build Variants tools window to change the variant of Dex.app。就是说需要使用 release 变体（非 debuggable 版本）。</p>
<p>这里就不介绍怎么生成 release 签名文件了，直接看 release 签名配置完成之后。</p>
<blockquote>
<p>详细签名步骤，请读者自行查看官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Fstudio%2Fpublish%2Fapp-signing%3Fhl%3Dzh-cn%23sign-apk" target="_blank" title="https://developer.android.google.cn/studio/publish/app-signing?hl=zh-cn#sign-apk" ref="nofollow noopener noreferrer">为应用签名</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/512418ff3ff24c8ca47d596595cd0bd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=TFu1uX1DysBEONZzZe3UvPjLMHU%3D" alt="image.png" loading="lazy"/><br/>
配置完签名，修改 <strong>App 模块的 Build Variant</strong>，再次点击图标，运行 Generate Baseline Profile for app</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd60518568dc43b3ac0b3eb72ba30add~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=QWqrojKEAEtt537AB9Jq2j1NL9I%3D" alt="image.png" loading="lazy"/><br/>
运行完成之后，我们会在 app/src/xxxRelease/generated 下面看到生成了 baseline-prof.text 和 startup-prof.text 文件</p>
<h4 data-id="heading-32">4.1.4 启动配置文件</h4>
<p>在上一节中，我们通过基准配置文件知道了“东西”的位置。本小节我们来了解另一个关键的优化文件——启动配置文件，看看它如何在此基础上进行更深层的优化。</p>
<h5 data-id="heading-33">原理</h5>
<p>我们可以继续用“找东西”的例子来理解它的工作原理：基准配置文件已经告诉我们东西在哪，但它们仍然分散在各个房间。<strong>启动配置文件</strong>则更进一步，相当于朋友提前把要用的所有东西打包进了几个背包，并把背包放在了门口。这样，你进门就能直接拿到所有必需品，省去了去各个房间的时间。</p>
<p>在技术上，启动配置文件的核心原理是 <strong>DEX布局优化</strong>，其根本目标是减少应用启动过程中的<strong>缺页中断</strong>，从而降低耗时的IO操作，最终显著缩短启动时间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f795a0f419f48068eadce55fe5d236a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=SIFqJ8DwdfehHQtj7z6wVAjtrTg%3D" alt="image.png" loading="lazy"/>
借用官网的一张图来说明:</p>
<ul>
<li>左侧：在apk中多个classes.dex，启动代码分散在各个classes.dex，且启动各个类非连续排列，此时就会有不必要的缺页中断，增加了多余的IO操作。</li>
<li>右侧：使用DEX布局优化，将原本分散在各个classes.dex中的启动代码放在了主classes.dex，并且连续排列。减少了缺页中断，也就减少了IO操作。</li>
</ul>
<p>也就是说通过优化DEX布局，使启动所需的类在dex中连续存储，然后就能顺序读取，减少磁盘寻道时间，并且减少缺页中断，也就减少了IO操作。我们知道IO操作是比较耗时的，当减少了它之后，启动时间自然也就减少了。</p>
<h5 data-id="heading-34">使用启动配置文件</h5>
<p>使用方式详见4.1.3小节，基准配置文件和启动配置文件会一起生成。</p>
<h5 data-id="heading-35">验证启动配置文件</h5>
<p>首先修改settings.gradle</p>
<pre><code class="hljs language-kts" lang="kts">pluginManagement {
    ...

    buildscript {
        repositories {
            mavenCentral()
            maven {
                url = uri(<span class="hljs-string">"https://storage.googleapis.com/r8-releases/raw"</span>)
            }
        }
        dependencies {
            classpath(<span class="hljs-string">"com.android.tools:r8:8.3.6-dev"</span>)
        }
    }
}
</code></pre>
<p>然后执行如下命令
./gradlew assembleRelease --info</p>
<p>等编译完成后，查看编译日志，可搜索关键字 <strong>Startup DEX</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f09e22c9e914b008f6a426e446449d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=SpJJeJHiq6zdvJQRfyVlc3GK4Kg%3D" alt="image.png" loading="lazy"/></p>
<p>INFO: R8: Startup DEX files contains 3398 classes and 14427 methods of which 7249 (50%) are non-startup methods. Distribution of classes by their number of startup methods:<br/>
0: 737 classes<br/>
1: 1026 classes<br/>
2-3: 1183 classes<br/>
4-5: 245 classes<br/>
6-10: 139 classes<br/>
11+: 68 classes</p>
<p>这表明了编译时，DEX布局已经成功优化了。</p>
<h5 data-id="heading-36">优化效果</h5>
<p>因为基准配置文件和启动配置文件是一起生成了，此处就不分开测试这2种文件了。</p>
<p>在同一设备上，测试同一应用，使用3.3小节的脚本，分别测试了200次未使用 和 使用这2种文件优化前后的冷启动时间，数据如下：</p>





























<table><thead><tr><th>时间类型</th><th>未优化</th><th>优化后</th><th>减少幅度</th></tr></thead><tbody><tr><td>P50</td><td>465ms</td><td>428ms</td><td>-37ms (-7.96%)</td></tr><tr><td>P90</td><td>476ms</td><td>438ms</td><td>-38ms (-7.98%)</td></tr><tr><td>P95</td><td>480<br/></td><td>447ms</td><td>-33ms (-6.88%)</td></tr></tbody></table>
<blockquote>
<p>详细的测试数据请看<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FStudyH2g%2FAndroidStartupOptimizationDemo%2Ftree%2Ffeature%2Fbaseline-startup-profiles%2Fstart_up_reports" target="_blank" title="https://github.com/StudyH2g/AndroidStartupOptimizationDemo/tree/feature/baseline-startup-profiles/start_up_reports" ref="nofollow noopener noreferrer">StudyH2g/AndroidStartupOptimizationDemo at feature/baseline-startup-profiles</a></p>
</blockquote>
<h3 data-id="heading-37">4.2 激进优化</h3>
<p>激进优化的效果依赖于设备硬件、系统版本及实时负载，不具备普遍性，并且有一定的兼容性风险与维护成本。建议读者若有意尝试，务必在深入理解其原理的基础上，<strong>在目标设备上建立完善的测试与监控机制</strong>，谨慎评估其实际收益。</p>
<blockquote>
<p>注： 本节中提到的绑定CPU大核、抑制GC等实现思路与代码示例，主要参考了《Android性能优化之道：从底层原理到一线实践》一书中的方案。<br/>
想过这小节应该叫激进优化还是进阶优化，但考虑到此小节优化方法不具备普遍性，因此还是选择了激进优化。请读者一定要在充分验证后，再考虑上生产环境，并做好相应的兜底策略。</p>
</blockquote>
<h4 data-id="heading-38">4.2.1 <strong>绑定CPU大核</strong></h4>
<p>原理部分就简单说下，读取 /sys/devices/system/cpu/cpu/cpufreq/cpuinfo_max_freq 文件来比较每个核心的最大频率，就可以拿到最高频率的 CPU 核心索引，然后通过 sched_setaffinity 将主线程绑定到 CPU 大核上。</p>
<p>我们就着重看实现部分</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-comment">/**
 * 获取最高频率的 CPU 核心索引（大核）
 * 通过读取 /sys/devices/system/cpu/cpu/cpufreq/cpuinfo_max_freq 文件来比较每个核心的最大频率
 *
 * @param env JNI 环境
 * @param clazz Java 类对象
 * @return 最高频率核心的索引, 如果获取失败则返回 -1
 */</span>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">JNIEXPORT jint JNICALL
<span class="hljs-title">Java_com_studyh2g_androidstartupoptimizationdemo_jni_JniHelper_getMaxFreqCpuIndex</span><span class="hljs-params">(
        JNIEnv* env,
        jclass clazz)</span> </span>{
    <span class="hljs-comment">// 统计 CPU 核心数量</span>
    <span class="hljs-type">int</span> cores = <span class="hljs-number">0</span>;
    DIR *dir;
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dirent</span> *ent;
    <span class="hljs-keyword">if</span>((dir = <span class="hljs-built_in">opendir</span>(<span class="hljs-string">"/sys/devices/system/cpu"</span>)) != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">while</span>((ent = <span class="hljs-built_in">readdir</span>(dir)) != <span class="hljs-literal">NULL</span>) {
            std::string path = ent-&gt;d_name;
            <span class="hljs-comment">// 查找以 "cpu" 开头的目录</span>
            <span class="hljs-keyword">if</span>(path.<span class="hljs-built_in">find</span>(<span class="hljs-string">"cpu"</span>) == <span class="hljs-number">0</span>) {
                <span class="hljs-type">bool</span> isCore = <span class="hljs-literal">true</span>;
                <span class="hljs-comment">// 检查 "cpu" 后面是否全是数字（排除 cpufreq、cpuidle 等非核心目录）</span>
                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">3</span>; i &lt; path.<span class="hljs-built_in">length</span>(); i++) {
                    <span class="hljs-keyword">if</span>(path[i] &lt; <span class="hljs-string">'0'</span> || path[i] &gt; <span class="hljs-string">'9'</span>) {
                        isCore = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">break</span>;
                    }
                }
                <span class="hljs-keyword">if</span>(isCore) {
                    cores++;
                }
            }
        }
        <span class="hljs-built_in">closedir</span>(dir);
    }
    <span class="hljs-comment">// 遍历所有核心，找出最高频率的核心</span>
    <span class="hljs-type">int</span> maxFreq = <span class="hljs-number">-1</span>;
    <span class="hljs-type">int</span> maxFreqCoreIndex = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">if</span> (cores != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; cores; i++) {
            <span class="hljs-comment">// 读取每个核心的最大频率文件</span>
            std::string filename = <span class="hljs-string">"/sys/devices/system/cpu/cpu"</span> + std::<span class="hljs-built_in">to_string</span>(i) + <span class="hljs-string">"/cpufreq/cpuinfo_max_freq"</span>;
            <span class="hljs-function">std::ifstream <span class="hljs-title">cpuInfoMaxFreqFile</span><span class="hljs-params">(filename)</span></span>;
            <span class="hljs-keyword">if</span> (cpuInfoMaxFreqFile.<span class="hljs-built_in">is_open</span>()) {
                std::string line;
                <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">getline</span>(cpuInfoMaxFreqFile, line)) {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-type">int</span> freqBound = std::<span class="hljs-built_in">stoi</span>(line);
                        <span class="hljs-keyword">if</span> (freqBound &gt; maxFreq) {
                            maxFreq = freqBound;
                            maxFreqCoreIndex = i;
                        }
                    } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::invalid_argument&amp; e) {
                        <span class="hljs-comment">// 频率值解析失败，跳过</span>
                    }
                }
                cpuInfoMaxFreqFile.<span class="hljs-built_in">close</span>();
            }
        }
    }
    <span class="hljs-keyword">return</span> maxFreqCoreIndex;
}

<span class="hljs-comment">/**
 * 将当前线程绑定到指定的 CPU 核心
 * 绑定后，当前线程只会在指定的核心上运行，可以利用大核提升性能
 *
 * @param env JNI 环境
 * @param clazz Java 类对象
 * @param coreNum 要绑定的 CPU 核心索引
 */</span>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">JNIEXPORT <span class="hljs-type">void</span> JNICALL
<span class="hljs-title">Java_com_studyh2g_androidstartupoptimizationdemo_jni_JniHelper_bindToCore</span><span class="hljs-params">(
        JNIEnv* env,
        jclass clazz,
        jint coreNum)</span> </span>{
    <span class="hljs-type">cpu_set_t</span> mask;
    <span class="hljs-comment">// 清空 CPU 集合</span>
    <span class="hljs-built_in">CPU_ZERO</span>(&amp;mask);
    <span class="hljs-comment">// 将指定核心加入集合</span>
    <span class="hljs-built_in">CPU_SET</span>(coreNum, &amp;mask);
    <span class="hljs-comment">// 获取当前线程 ID</span>
    <span class="hljs-type">pid_t</span> tid = <span class="hljs-built_in">gettid</span>();
    <span class="hljs-comment">// 设置线程的 CPU 亲和性（绑定到指定核心）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sched_setaffinity</span>(tid, <span class="hljs-built_in">sizeof</span>(mask), &amp;mask) == <span class="hljs-number">-1</span>) {
        <span class="hljs-comment">// 绑定失败</span>
    }
}

<span class="hljs-comment">/**
 * 获取当前线程绑定的 CPU 核心列表
 * 返回当前线程允许运行的所有 CPU 核心
 *
 * @param env JNI 环境
 * @param clazz Java 类对象
 * @return CPU 核心列表的字符串，如 "Current CPU affinity: 0 1 2 3 4 5 6 7 "
 */</span>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">JNIEXPORT jstring JNICALL
<span class="hljs-title">Java_com_studyh2g_androidstartupoptimizationdemo_jni_JniHelper_getBoundCores</span><span class="hljs-params">(
        JNIEnv* env,
        jclass clazz)</span> </span>{
    <span class="hljs-type">cpu_set_t</span> mask;
    <span class="hljs-comment">// 获取当前线程 ID</span>
    <span class="hljs-type">pid_t</span> tid = <span class="hljs-built_in">gettid</span>();
    <span class="hljs-comment">// 获取当前线程绑定的 CPU 核心列表（失败则返回错误）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sched_getaffinity</span>(tid, <span class="hljs-built_in">sizeof</span>(mask), &amp;mask) == <span class="hljs-number">-1</span>) {
        <span class="hljs-keyword">return</span> env-&gt;<span class="hljs-built_in">NewStringUTF</span>(<span class="hljs-string">"Failed to get affinity"</span>);
    }
    std::string result = <span class="hljs-string">"Current CPU affinity: "</span>;
    <span class="hljs-comment">// 遍历所有可能的 CPU 核心</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CPU_SETSIZE; i++) {
        <span class="hljs-comment">// 检查该核心是否在绑定集合中</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">CPU_ISSET</span>(i, &amp;mask)) {
            result += std::<span class="hljs-built_in">to_string</span>(i) + <span class="hljs-string">" "</span>;
        }
    }
    <span class="hljs-keyword">return</span> env-&gt;<span class="hljs-built_in">NewStringUTF</span>(result.<span class="hljs-built_in">c_str</span>());
}
</code></pre>
<p>然后在启动的Activity#attachBaseContext中调用方法就可以了</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-comment">/**
 * 在应用启动的最早时机将主线程绑定到 CPU 大核
 *
 * attachBaseContext 是 Activity 生命周期中最早执行的回调，此时主线程还未开始执行繁重的初始化工作。
 * 将主线程绑定到大核可以充分利用大核的高性能，减少启动耗时。
 *
 * <span class="hljs-doctag">@param</span> newBase 新的 Context 基对象
 */</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">attachBaseContext</span><span class="hljs-params">(newBase: <span class="hljs-type">Context</span>?)</span></span> {
    <span class="hljs-keyword">super</span>.attachBaseContext(newBase)
    <span class="hljs-comment">// 打印绑定前的 CPU 核心列表（用于验证）</span>
    Log.d(tag, <span class="hljs-string">"attachBaseContext before: <span class="hljs-subst">${JniHelper.getBoundCores()}</span>"</span>)
    <span class="hljs-comment">// 获取最高频率的 CPU 核心索引（大核）</span>
    <span class="hljs-keyword">val</span> maxFreqCpuIndex = JniHelper.getMaxFreqCpuIndex()
    <span class="hljs-keyword">if</span> (maxFreqCpuIndex != -<span class="hljs-number">1</span>) {
        <span class="hljs-comment">// 将主线程绑定到大核</span>
        JniHelper.bindToCore(maxFreqCpuIndex)
        <span class="hljs-comment">// 打印绑定后的 CPU 核心列表（用于验证绑定是否成功）</span>
        Log.d(tag, <span class="hljs-string">"attachBaseContext after: <span class="hljs-subst">${JniHelper.getBoundCores()}</span>"</span>)
    }
}
</code></pre>
<p>日志如下：<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/502fde811c2544f4bdd9d65f8976bbf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=uF3Fn1armpaIQBPjWd%2B%2FIdFBmUc%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>读者可拉取 feature/aggressive-bind-cpu 分支代码运行看看<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FStudyH2g%2FAndroidStartupOptimizationDemo%2Ftree%2Ffeature%2Faggressive-bind-cpu" target="_blank" title="https://github.com/StudyH2g/AndroidStartupOptimizationDemo/tree/feature/aggressive-bind-cpu" ref="nofollow noopener noreferrer">StudyH2g/AndroidStartupOptimizationDemo at feature/aggressive-bind-cpu</a>； 如对JNI接触较少，可参阅<a href="https://juejin.cn/post/7521250344129429556" target="_blank" title="https://juejin.cn/post/7521250344129429556">Android JNI入门：从基础注册到集成第三方So库及源码分析</a></p>
</blockquote>
<p>现在主线程已经绑定到了 CPU 大核，但如果主线程一直绑定到 CPU 大核上，那么可能会<strong>导致功耗异常和系统调度问题</strong>，后续可以找一个恰当的时机解除绑定。</p>
<h4 data-id="heading-39">4.2.2 <strong>抑制GC</strong></h4>
<p>在启动期间抑制垃圾回收（GC）理论上可以减少因GC事件导致的线程停顿（Stop-The-World），从而优化TTID。这通常需要通过 Inline Hook（如使用 ShadowHook 库）拦截ART运行时中触发并发GC的关键函数（如ConcurrentGCTask::Run）来实现。</p>
<p>具体代码如下</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* g_hook_stub = <span class="hljs-literal">nullptr</span>;

<span class="hljs-comment">// Hook 函数</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">newFunc</span><span class="hljs-params">(<span class="hljs-type">void</span>* self)</span> </span>{
    <span class="hljs-built_in">SHADOWHOOK_STACK_SCOPE</span>();
    <span class="hljs-comment">// 休眠2秒</span>
    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">2</span>);
    <span class="hljs-comment">// 执行原来的 Run 方法</span>
    <span class="hljs-built_in">SHADOWHOOK_CALL_PREV</span>(newFunc, self);
}

<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">JNIEXPORT jboolean JNICALL
<span class="hljs-title">Java_com_xxx_xxx_MainActivity_initGCHookNative</span><span class="hljs-params">(
        JNIEnv* env,
        jobject <span class="hljs-comment">/* this */</span>)</span> </span>{
    <span class="hljs-keyword">if</span> (g_hook_stub != <span class="hljs-literal">nullptr</span>) {
        <span class="hljs-keyword">return</span> JNI_TRUE;
    }

    <span class="hljs-comment">// 开启调试日志</span>
    <span class="hljs-built_in">shadowhook_set_debuggable</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-comment">// 初始化 ShadowHook</span>
    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">shadowhook_init</span>(SHADOWHOOK_MODE_SHARED, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span> &amp;&amp; ret != <span class="hljs-number">2</span>) {
        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"ShadowHook init failed: %d"</span>, ret);
        <span class="hljs-keyword">return</span> JNI_FALSE;
    }

    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"ShadowHook initialized successfully"</span>);

    <span class="hljs-comment">// 使用 shadowhook_hook_sym_name</span>
    g_hook_stub = <span class="hljs-built_in">shadowhook_hook_sym_name</span>(
            <span class="hljs-string">"libart.so"</span>,
            <span class="hljs-string">"_ZN3art2gc4Heap16ConcurrentGCTask3RunEPNS_6ThreadE"</span>,
            <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(&amp;newFunc),
            <span class="hljs-literal">nullptr</span>
    );

    <span class="hljs-keyword">if</span> (g_hook_stub == <span class="hljs-literal">nullptr</span>) {
        <span class="hljs-type">int</span> error_num = <span class="hljs-built_in">shadowhook_get_errno</span>();
        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* error_msg = <span class="hljs-built_in">shadowhook_to_errmsg</span>(error_num);
        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"Hook failed: %d - %s"</span>, error_num, error_msg);
        <span class="hljs-keyword">return</span> JNI_FALSE;
    }

    <span class="hljs-type">int</span> error_num = <span class="hljs-built_in">shadowhook_get_errno</span>();
    <span class="hljs-keyword">if</span> (error_num == <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"GC Hook successful!"</span>);
        <span class="hljs-keyword">return</span> JNI_TRUE;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error_num == <span class="hljs-number">1</span>) {
        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"GC Hook pending (libart.so not loaded yet)"</span>);
        <span class="hljs-keyword">return</span> JNI_TRUE;
    }

    <span class="hljs-keyword">return</span> JNI_FALSE;
}
</code></pre>
<p>本小节代码请不要用于生产环境，是用于展示一种优化启动速度的方式，请读者一定要在充分测试的情况下，再考虑用抑制 GC 的方式。</p>
<blockquote>
<p>ShadowHook详细使用方法请阅读 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbytedance%2Fandroid-inline-hook%2Fblob%2Fmain%2Fdoc%2Fmanual.zh-CN.md" target="_blank" title="https://github.com/bytedance/android-inline-hook/blob/main/doc/manual.zh-CN.md" ref="nofollow noopener noreferrer">shadowhook 手册</a></p>
</blockquote>
<h4 data-id="heading-40">4.2.3 <strong>提高核心线程优先级</strong></h4>
<p>Android 5开始，主线程负责测量和布局，渲染则由独立的渲染线程（RenderThread）负责。理论上，提高这两个线程的优先级可以让它们获得更多CPU时间，从而加速启动。</p>
<h5 data-id="heading-41">实现原理</h5>
<ol>
<li><strong>主线程</strong>：在 <strong>attachBaseContext</strong> 中直接设置优先级</li>
<li><strong>渲染线程</strong>：需要先获取其线程ID（TID），然后设置优先级</li>
</ol>
<h5 data-id="heading-42">关键代码实现</h5>
<p><strong>1. 提高主线程优先级</strong></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">attachBaseContext</span><span class="hljs-params">(newBase: <span class="hljs-type">Context</span>?)</span></span> {
    <span class="hljs-keyword">super</span>.attachBaseContext(newBase)
    Process.setThreadPriority(startupPriority)
}
</code></pre>
<p><strong>2. 提高渲染线程优先级的两种方案</strong></p>
<p><strong>方案1：主动轮询（更早设置）</strong></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-comment">/**
 * 方案1：通过多次尝试主动查找 RenderThread 来设置优先级
 * 在 RenderThread 创建之前的任何时机都可能调用，如果找不到就定时重试
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">trySetupRenderThreadPriority</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 条件：最多尝试x次，且未设置成功</span>
    <span class="hljs-keyword">if</span> (renderThreadSetupAttempt++ &lt; attemptTimes &amp;&amp; !renderThreadPrioritySet) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> tid = getRenderThreadTid()
            <span class="hljs-keyword">if</span> (tid != -<span class="hljs-number">1</span>) {
                Process.setThreadPriority(tid, startupPriority)
                renderThreadPrioritySet = <span class="hljs-literal">true</span>
                Log.d(tag, <span class="hljs-string">"方案1：成功设置渲染线程优先级: <span class="hljs-variable">$startupPriority</span> (第<span class="hljs-subst">${renderThreadSetupAttempt}</span>次尝试)"</span>)
                <span class="hljs-comment">// 成功设置后，可设置一个较晚的兜底恢复（如5秒后），确保系统健康</span>
                handler.postDelayed({ safelyResetPriority() }, <span class="hljs-number">5000</span>)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 如果没找到，16ms后重试（约一帧时间）</span>
                handler.postDelayed(::trySetupRenderThreadPriority, <span class="hljs-number">16</span>)
                Log.d(tag, <span class="hljs-string">"方案1：第<span class="hljs-subst">${renderThreadSetupAttempt}</span>次尝试：未找到渲染线程，稍后重试"</span>)
            }
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(tag, <span class="hljs-string">"方案1：设置渲染线程优先级时发生异常"</span>, e)
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!renderThreadPrioritySet) {
        Log.w(tag, <span class="hljs-string">"方案1：已达到最大尝试次数，未能设置渲染线程优先级"</span>)
    }
}
<span class="hljs-comment">// 在onCreate中调用</span>
</code></pre>
<p><strong>方案2：等待首帧绘制后（更可靠）</strong></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin">window.decorView.viewTreeObserver.addOnPreDrawListener {
    <span class="hljs-keyword">val</span> tid = getRenderThreadTid()
    <span class="hljs-keyword">if</span> (tid != -<span class="hljs-number">1</span>) {
        Process.setThreadPriority(tid, startupPriority)
    }
}
</code></pre>
<p><strong>3. 恢复优先级</strong></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">restorePriorities</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 恢复主线程</span>
    Process.setThreadPriority(Process.THREAD_PRIORITY_DEFAULT)
    
    <span class="hljs-comment">// 恢复渲染线程</span>
    <span class="hljs-keyword">val</span> tid = getRenderThreadTid()
    <span class="hljs-keyword">if</span> (tid != -<span class="hljs-number">1</span>) {
        Process.setThreadPriority(tid, Process.THREAD_PRIORITY_DEFAULT)
    }
}
<span class="hljs-comment">// 在首帧绘制完成后调用</span>
</code></pre>
<p><strong>4. 获取渲染线程TID的工具函数</strong></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">import</span> android.os.Process
<span class="hljs-keyword">import</span> java.io.BufferedReader
<span class="hljs-keyword">import</span> java.io.File
<span class="hljs-keyword">import</span> java.io.FileReader

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getRenderThreadTid</span><span class="hljs-params">()</span></span> : <span class="hljs-built_in">Int</span> {
   <span class="hljs-keyword">val</span> taskParentDir = File(<span class="hljs-string">"/proc/"</span> + Process.myPid() + <span class="hljs-string">"/task/"</span>)
   <span class="hljs-keyword">if</span> (taskParentDir.isDirectory()) {
       <span class="hljs-keyword">val</span> taskFiles = taskParentDir.listFiles()
       taskFiles?.let {
           <span class="hljs-keyword">for</span> (taskFile <span class="hljs-keyword">in</span> it) {
               <span class="hljs-keyword">var</span> br : BufferedReader? = <span class="hljs-literal">null</span>
               <span class="hljs-keyword">var</span> line: String?
               <span class="hljs-keyword">try</span> {
                   br = BufferedReader(FileReader(taskFile.getPath() + <span class="hljs-string">"/stat"</span>), <span class="hljs-number">100</span>)
                   line = br.readLine()
                   <span class="hljs-keyword">if</span> (line.isNotEmpty()) {
                       <span class="hljs-keyword">val</span> param = line.split(<span class="hljs-string">" "</span>)
                       <span class="hljs-keyword">if</span> (param.size &lt; <span class="hljs-number">2</span>) {
                           <span class="hljs-keyword">continue</span>
                       }
                       <span class="hljs-keyword">val</span> threadName: String = param[<span class="hljs-number">1</span>]
                       <span class="hljs-keyword">if</span> (threadName.contains(<span class="hljs-string">"RenderThread"</span>)) {
                           <span class="hljs-keyword">return</span> param[<span class="hljs-number">0</span>].toInt()
                       }
                   }
               } <span class="hljs-keyword">catch</span> (e : Exception) {

               } <span class="hljs-keyword">finally</span> {
                   br?.close()
               }
           }
       }
   }
   <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>
}
</code></pre>
<p>再次提醒，使用激进优化中的手段时，请进行充分的测试后，再考虑上生产环境。</p>
<blockquote>
<p>详细代码请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FStudyH2g%2FAndroidStartupOptimizationDemo%2Ftree%2Ffeature%2Faggressive-thread-priority" target="_blank" title="https://github.com/StudyH2g/AndroidStartupOptimizationDemo/tree/feature/aggressive-thread-priority" ref="nofollow noopener noreferrer">StudyH2g/AndroidStartupOptimizationDemo at feature/aggressive-thread-priority</a></p>
</blockquote>
<h3 data-id="heading-43">4.3 优化用户感官体验</h3>
<p>需要说明的是，此种方式<strong>不会优化启动速度</strong>，只是优化用户感官体验。</p>
<h4 data-id="heading-44">4.3.1 主题切换: 优化空白Window</h4>
<p>在启动流程中，会显示一个空白窗口。时序图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ccfadc265db4a1e8cb119fc2fd6b370~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=9rxj0qtrLTgZJpig7RnLGNfFxzc%3D" alt="image.png" loading="lazy"/></p>
<p>ActivityStarter#recycleTask代码如下</p>
<pre><code class="hljs language-Java" lang="Java">    <span class="hljs-comment">// ActivityStarter#recycleTask</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">recycleTask</span><span class="hljs-params">()</span> {
        ...
        <span class="hljs-keyword">if</span> (mMovedToFront) {
            <span class="hljs-comment">// 冷启动 mMovedToFront 为 true, 显示空白窗口</span>
            targetTaskTop.showStartingWindow(<span class="hljs-literal">true</span> <span class="hljs-comment">/* taskSwitch */</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mDoResume) {
            <span class="hljs-comment">// Make sure the root task and its belonging display are moved to topmost.</span>
            mTargetRootTask.moveToFront(<span class="hljs-string">"intentActivityFound"</span>);
        }
        ...
    }
</code></pre>
<p>它的调用是在 Application#onCreate 之前的。我们可以用一张图片来替换掉这个空白Window，从而避免白屏，让用户体验更好。那么下面就详细说明具体做法：</p>
<p>首先定义要显示的图片</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">layer-list</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:drawable</span>=<span class="hljs-string">"@android:color/white"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bitmap</span>
            <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span>
            <span class="hljs-attr">android:src</span>=<span class="hljs-string">"@drawable/ic_xxx"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">layer-list</span>&gt;</span>
</code></pre>
<p>再定义启动的主题</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Theme.Launcher"</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">"android:Theme.Material.Light.NoActionBar"</span> &gt;</span><span class="xml">
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowBackground"</span>&gt;</span>@drawable/ic_start_xxx<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>后续将Manifest中的主题替换为启动主题</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">application</span>
        <span class="hljs-attr">...</span>
        <span class="hljs-attr">android:theme</span>=<span class="hljs-string">"@style/Theme.Launcher"</span>&gt;</span>
        ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
</code></pre>
<p>最后我们在启动的首个 Activity#onCreate，设置为原本的主题，注意要<strong>在 super.onCreate 之前</strong>。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-comment">// 设置为原本的主题</span>
        setTheme(R.style.Theme_xxx)
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContent {
            xxx
        }
    }
}
</code></pre>
<p>这样做了之后，这个空白window就会变成我们设置的图片了。</p>
<p><strong>使用</strong>主题切换优化空白弹窗效果：<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be5df355f3d64e4cbd3eea010e30add2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=wWF%2BqfX2I8OmI8fSBcypw836Xqo%3D" alt="demo (online-video-cutter.com).gif" loading="lazy"/><br/>
为了更好的看优化效果，此处延迟了1.5S显示内容</p>
<p>再次提醒，这种方式仅仅优化了空白window，并<strong>不会优化启动速度</strong>。</p>
<h4 data-id="heading-45">4.3.2 骨架屏</h4>
<p>骨架屏就是正常页面的不带数据显示的空白版本，一般会使用灰色块来显示大体的外形。通过使用骨架屏，我们可以优化用户感官体验，从而提高用户的留存率和日活。</p>
<p><strong>骨架屏的实现根据对视觉还原度的要求，分为两种：</strong> 模块式骨架屏、真实UI式骨架屏</p>
<h5 data-id="heading-46">模块式骨架屏</h5>
<p>侧重于内容模块的<strong>布局位置</strong>，使用简单的灰色色块构成页面框架。其优势在于实现简单、复用性高，可以快速提升用户感官体验。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d1176182c8b4c6484a947f628d5ae13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=SACNzjVr2khHI17%2FSXZJnF86%2FUM%3D" alt="modelScreen.gif" loading="lazy"/></p>
<h5 data-id="heading-47">真实UI式骨架屏</h5>
<p>在内容加载前，显示与最终界面<strong>高度一致的视觉样式</strong>，包括图标、间距等细节。这种方案能提供丝滑的过渡体验，但实现和维护成本也相应更高。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ba06e458e3e43758789e88ed3d92495~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=ig1CkhuuIu3JaAijYJ1WUnY93rQ%3D" alt="SkeScreen.gif" loading="lazy"/></p>
<p>模块骨架屏和真实UI骨架屏在实现方式上是相同的，只是实现的细节程度的不同。我们就看看怎么实现Compose模块屏</p>
<h5 data-id="heading-48">实现骨架屏</h5>
<p>这里介绍下带闪烁效果的骨架屏，直接看代码吧</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shimmerBrush</span><span class="hljs-params">()</span></span>: Brush {
    <span class="hljs-comment">// 定义渐变色</span>
    <span class="hljs-keyword">val</span> gradient = listOf(
        Color.LightGray.copy(alpha = <span class="hljs-number">0.6f</span>),
        Color.LightGray.copy(alpha = <span class="hljs-number">0.2f</span>),
        Color.LightGray.copy(alpha = <span class="hljs-number">0.6f</span>)
    )
    <span class="hljs-comment">// 创建无限平移的动画</span>
    <span class="hljs-keyword">val</span> transition = rememberInfiniteTransition(label = <span class="hljs-string">"shimmer"</span>)
    <span class="hljs-keyword">val</span> translateAnimation = transition.animateFloat(
        initialValue = <span class="hljs-number">0f</span>,
        targetValue = <span class="hljs-number">1000f</span>,
        animationSpec = infiniteRepeatable(
            animation = tween(durationMillis = <span class="hljs-number">1000</span>, easing = LinearEasing),
            repeatMode = RepeatMode.Restart
        ),
        label = <span class="hljs-string">"shimmerTranslation"</span>
    )
    <span class="hljs-comment">// 返回计算好的 Brush</span>
    <span class="hljs-keyword">return</span> Brush.linearGradient(
        colors = gradient,
        start = Offset(x = translateAnimation.value - <span class="hljs-number">500</span>, y = <span class="hljs-number">0f</span>),
        end = Offset(x = translateAnimation.value, y = <span class="hljs-number">100f</span>)
    )
}
</code></pre>
<p>上面我们就定义好了一个从左到右的渐变的闪烁效果。然后我们只要在Modifier.
drawWithCache使用它就可以了，如下：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SkeletonBox</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> shimmerBrush = shimmerBrush()

    Box(
        modifier = Modifier
            .fillMaxWidth()
            .height(<span class="hljs-number">62.</span>dp)
            .clip(RoundedCornerShape(<span class="hljs-number">60</span>))
            .drawWithCache {
                onDrawBehind { drawRect(brush = shimmerBrush) }
            }
    )
}
</code></pre>
<p>效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/610d8045835344a198e7caa4687dc8b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=SeWDZavzpvCdmraW%2BC6PG2EYlFw%3D" alt="Screen_recording_20260130_143741 (online-video-cutter.com).gif" loading="lazy"/></p>
<p>我们现在就已经实现了一个带闪烁效果的按钮了。由于页面布局各异，核心是实现 shimmerBrush 并应用于Modifier。大家可根据自身UI结构复用此方法。</p>
<p>而在页面中肯定会有多个组件，我们可以通过状态提升，共用一个shimmerBrush</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SkeletonModel</span><span class="hljs-params">(navController: <span class="hljs-type">NavController</span>)</span></span> {
    <span class="hljs-comment">// 共用 shimmerBrush</span>
    <span class="hljs-keyword">val</span> shimmerBrush = shimmerBrush()
    Column(modifier = Modifier
        .padding(horizontal = <span class="hljs-number">16.</span>dp)
        .verticalScroll(rememberScrollState())
    ) {
        Spacer(modifier = Modifier.height(<span class="hljs-number">12.</span>dp))
        <span class="hljs-comment">// 1</span>
        ProductBrushItem(shimmerBrush)
        Spacer(modifier = Modifier.height(<span class="hljs-number">12.</span>dp))
        <span class="hljs-comment">// 2</span>
        AmountBrushItem(shimmerBrush)
        Spacer(modifier = Modifier.height(<span class="hljs-number">12.</span>dp))
        <span class="hljs-comment">// 3</span>
        ButtonBrushItem(shimmerBrush)
    }
}
</code></pre>
<p>还有一点是，页面中数据加载前后，组件没有变化 或 有明确含义的，可以直接用它们 或 它们代表的含义。比如上面示例 App 中，Choose a loan product文案，按钮下面的 Terms &amp; Service and Privacy Policy都直接用的它们，因为加载数据前后无变化，而min amount 和 max amount则是选择产品的最小/大值的含义。</p>
<p>最后说说选择页面的准则：个人认为应优先选择用户日常使用中，最频繁的那个页面（比如购物软件的首页），而次级的页面，可以先实现模块级骨架屏，后续再考虑改进。</p>
<h2 data-id="heading-49">五、总结</h2>
<p>优化冷启动， 可以按<strong>测量-分析-优化-验证</strong> 这样的环节去进行</p>
<ul>
<li><strong>测量</strong>：分清TTID（第一帧）与TTFD（可交互），用可靠工具（如脚本）获取优化前后数据。</li>
<li><strong>分析</strong>：弄清楚冷启动涉及到的所有环节，即<strong>代码层、编译层、体验层、系统层</strong> 。</li>
<li><strong>优化</strong>：分层优化，建议先从收敛Provider、初始化优化和任务调度做起，务必用上基准配置和启动配置；推荐使用感官优化手段；激进方式请慎重评估场景与风险，并进行充分测试后再考虑使用。</li>
<li><strong>验证</strong>：对优化前后进行测试，验证优化效果。<strong>（在我主导的项目中，通过实践这一闭环，我们将冷启动的P50时间成功降低了24%。）</strong></li>
</ul>
<p>感谢阅读，希望本文对你有所帮助，<strong>如有任何不对的地方，欢迎大家指正</strong>。</p>
<h2 data-id="heading-50">六、参考资料</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Ftopic%2Fperformance%2Fvitals%2Flaunch-time%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.google.cn/topic/performance/vitals/launch-time?hl=zh-cn" ref="nofollow noopener noreferrer">应用启动时间</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Ftopic%2Fperformance%2Fbenchmarking%2Fmacrobenchmark-overview%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.google.cn/topic/performance/benchmarking/macrobenchmark-overview?hl=zh-cn" ref="nofollow noopener noreferrer">Jetpack Macrobenchmark</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Ftopic%2Flibraries%2Fapp-startup%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.google.cn/topic/libraries/app-startup?hl=zh-cn" ref="nofollow noopener noreferrer">App Startup</a></li>
<li>《Android性能优化之道：从底层原理到一线实践》</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FvW6-zag2CKrFgcYAPdeUFg" target="_blank" title="https://mp.weixin.qq.com/s/vW6-zag2CKrFgcYAPdeUFg" ref="nofollow noopener noreferrer">App冷启动优化测试干货分享（一）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcoding.imooc.com%2Fclass%2F308.html" target="_blank" title="https://coding.imooc.com/class/308.html" ref="nofollow noopener noreferrer">Top团队大牛带你玩转Android性能分析与优化</a></li>
<li><a href="https://juejin.cn/post/7287083662758379554" target="_blank" title="https://juejin.cn/post/7287083662758379554">常用 JSON 库性能对比: Gson VS Moshi VS Kotlin Serialization VS ...</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Subscription 管理]]></title>    <link>https://juejin.cn/post/7603321550247149618</link>    <guid>https://juejin.cn/post/7603321550247149618</guid>    <pubDate>2026-02-06T09:17:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603321550247149618" data-draft-id="7603359026711330826" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Subscription 管理"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T09:17:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Subscription 管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:17:50.000Z" title="Fri Feb 06 2026 09:17:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 核心概念</h3>
<h4 data-id="heading-1">什么是 Subscription（订阅）？</h4>
<p><strong>Subscription</strong> 是对设备上单个 SIM 卡或 eSIM 的逻辑表示。每个 Subscription 都有一个唯一的 <strong>SubId</strong>（Subscription ID），用来标识该订阅在系统中的身份。</p>
<p>关键概念：</p>
<ul>
<li><strong>SubId</strong>：订阅的逻辑标识符（整数），用于应用层和框架层通信</li>
<li><strong>PhoneId</strong>：物理调制解调器的索引，也称为逻辑 SIM 卡槽索引</li>
<li><strong>IccId</strong>：SIM 卡的集成电路卡标识符（集成电路卡号）</li>
<li><strong>Active Subscription</strong>：当前在 SIM 卡槽中加载并可用的订阅</li>
</ul>
<h4 data-id="heading-2">Subscription 的类型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 本地 SIM：物理 SIM 或 eSIM</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SUBSCRIPTION_TYPE_LOCAL_SIM</span> <span class="hljs-operator">=</span> SimInfo.SUBSCRIPTION_TYPE_LOCAL_SIM;

<span class="hljs-comment">// 远程 SIM：通过蓝牙等连接的外部设备的 SIM</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SUBSCRIPTION_TYPE_REMOTE_SIM</span> <span class="hljs-operator">=</span> SimInfo.SUBSCRIPTION_TYPE_REMOTE_SIM;
</code></pre>
<h3 data-id="heading-3">2. 核心数据模型</h3>
<h4 data-id="heading-4">SubscriptionInfo（公开 API 类）</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">38</span>:<span class="hljs-number">65</span>:frameworks_base/telephony/java/android/telephony/SubscriptionInfo.java
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mId;                           <span class="hljs-comment">// SubId</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mIccId;                     <span class="hljs-comment">// SIM 卡号</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mSimSlotIndex;                 <span class="hljs-comment">// SIM 槽位索引</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CharSequence mDisplayName;         <span class="hljs-comment">// 用户显示名称</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CharSequence mCarrierName;         <span class="hljs-comment">// 运营商名称</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mDisplayNameSource;            <span class="hljs-comment">// 显示名称来源</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mIconTint;                     <span class="hljs-comment">// 图标颜色</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mNumber;                    <span class="hljs-comment">// 电话号码</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mDataRoaming;                  <span class="hljs-comment">// 数据漫游设置</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mMcc;                       <span class="hljs-comment">// 移动国家代码</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mMnc;                       <span class="hljs-comment">// 移动网络代码</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> mIsEmbedded;               <span class="hljs-comment">// 是否为 eSIM</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ParcelUuid mGroupUuid;             <span class="hljs-comment">// 订阅组 UUID</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mCarrierId;                    <span class="hljs-comment">// 运营商 ID</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> mIsOpportunistic;          <span class="hljs-comment">// 是否为机会性订阅</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> mAreUiccApplicationsEnabled;  <span class="hljs-comment">// UICC 应用是否启用</span>
</code></pre>
<h4 data-id="heading-5">SubscriptionInfoInternal（内部使用）</h4>
<p>这是框架内部使用的模型，完全对应 <code>SimInfo</code> 数据库表的每一列。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">318</span>:<span class="hljs-number">410</span>:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/SubscriptionInfoInternal.java
<span class="hljs-comment">// 包含所有数据库字段，如 IMSI、RCS 配置、网络类型权限等</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mImsi;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mEnabledMobileDataPolicies;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mIsRcsUceEnabled;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mIsCrossSimCallingEnabled;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] mRcsConfig;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mAllowedNetworkTypesForReasons;
<span class="hljs-comment">// ... 更多字段</span>
</code></pre>
<h3 data-id="heading-6">3. Subscription 数据库</h3>
<h4 data-id="heading-7">SimInfo 表</h4>
<p>所有订阅信息存储在 <code>TelephonyProvider</code> 的 <code>SimInfo</code> 表中，内容 URI 为 <code>content://telephony/siminfo</code>。</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">4286</span><span class="hljs-symbol">:</span><span class="hljs-number">4300</span><span class="hljs-symbol">:frameworks_base/core/java/android/provider/Telephony</span>.java
<span class="hljs-keyword">public</span> static final <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimInfo</span> {
    <span class="hljs-keyword">public</span> static final <span class="hljs-title class_">Uri</span> <span class="hljs-variable constant_">CONTENT_URI</span> = <span class="hljs-title class_">Uri</span>.parse(<span class="hljs-string">"content://telephony/siminfo"</span>);
    <span class="hljs-regexp">//</span> 包含 <span class="hljs-number">50</span>+ 列，存储所有订阅相关数据
}
</code></pre>
<h4 data-id="heading-8">SubscriptionDatabaseManager</h4>
<p>负责 <code>SimInfo</code> 表的读写缓存，所有数据库访问都应通过此类进行。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-number">84</span>:<span class="hljs-number">678</span>:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/<span class="hljs-type">SubscriptionDatabaseManager</span>.java
<span class="hljs-comment">/**
 * The subscription database manager is the wrapper of {@link SimInfo} table.
 * It's a full memory cache of the entire subscription database.
 */</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SubscriptionDatabaseManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Handler</span> </span>{
    <span class="hljs-comment">// 内存缓存，使用读写锁保护</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">Map</span>&lt;<span class="hljs-type">Integer</span>, <span class="hljs-type">SubscriptionInfoInternal</span>&gt; mAllSubscriptionInfoInternalCache;
}
</code></pre>
<h3 data-id="heading-9">4. Subscription 生命周期</h3>
<h4 data-id="heading-10">4.1 Subscription 发现与创建流程</h4>
<pre><code class="hljs language-scss" lang="scss">                    ┌─────────────────────────────────┐
                    │      UiccController             │
                    │  (UICC 卡管理)                   │
                    └──────────────┬──────────────────┘
                                   │ <span class="hljs-built_in">updateSimState</span>()
                                   ▼
           ┌──────────────────────────────────────────┐
           │   SubscriptionManagerService             │
           │      <span class="hljs-built_in">updateSimState</span>()                     │
           └──────────────┬───────────────────────────┘
                          │
                    <span class="hljs-built_in">updateSubscription</span>()
                          │
        ┌─────────────────┼─────────────────┐
        ▼                 ▼                 ▼
    检查 IccId      查找现有订阅        创建新订阅
    是否存在         (数据库)            (若无则插入)
</code></pre>
<p>关键代码：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">1499</span><span class="hljs-symbol">:</span><span class="hljs-number">1522</span><span class="hljs-symbol">:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/SubscriptionManagerService</span>.java
<span class="hljs-keyword">if</span> (!<span class="hljs-title class_">TextUtils</span>.isEmpty(iccId)) {
    <span class="hljs-regexp">//</span> 检查订阅是否已存在
    subInfo = mSubscriptionDatabaseManager.getSubscriptionInfoInternalByIccId(iccId);
    int subId;
    <span class="hljs-keyword">if</span> (subInfo == null) {
        <span class="hljs-regexp">//</span> 这是新 <span class="hljs-variable constant_">SIM</span> 卡。插入新记录。
        subId = insertSubscriptionInfo(iccId, phoneId, null,
                <span class="hljs-title class_">SubscriptionManager</span>.<span class="hljs-variable constant_">SUBSCRIPTION_TYPE_LOCAL_SIM</span>);
        <span class="hljs-regexp">//</span> 设置显示名称
        mSubscriptionDatabaseManager.setDisplayName(subId,
                mContext.getResources().getString(R.string.default_card_name, getCardNumber(subId)));
    } <span class="hljs-keyword">else</span> {
        subId = subInfo.getSubscriptionId();
        log(<span class="hljs-string">"Found existing subscription. subId= "</span> + subId + <span class="hljs-string">", phoneId="</span> + phoneId);
    }
    
    /<span class="hljs-regexp">/ 更新 SIM 槽位索引，使订阅变为活跃状态
    if (subInfo != null &amp;&amp; subInfo.areUiccApplicationsEnabled()) {
        mSlotIndexToSubId.put(phoneId, subId);
        mSubscriptionDatabaseManager.setSimSlotIndex(subId, phoneId);
    }
}
</span></code></pre>
<h4 data-id="heading-11">4.2 插入新订阅</h4>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">1092</span><span class="hljs-symbol">:</span><span class="hljs-number">1114</span><span class="hljs-symbol">:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/SubscriptionManagerService</span>.java
<span class="hljs-keyword">private</span> int insertSubscriptionInfo(<span class="hljs-variable">@NonNull</span> <span class="hljs-title class_">String</span> iccId, int slotIndex,
        <span class="hljs-variable">@Nullable</span> <span class="hljs-title class_">String</span> displayName, <span class="hljs-variable">@SubscriptionType</span> int subscriptionType) {
    <span class="hljs-title class_">String</span> defaultAllowNetworkTypes = <span class="hljs-title class_">Phone</span>.convertAllowedNetworkTypeMapIndexToDbName(...);
    <span class="hljs-title class_">SubscriptionInfoInternal</span>.<span class="hljs-title class_">Builder</span> builder = new <span class="hljs-title class_">SubscriptionInfoInternal</span>.<span class="hljs-title class_">Builder</span>()
            .setIccId(iccId)
            .setCardString(iccId)
            .setSimSlotIndex(slotIndex)
            .setType(subscriptionType)
            .setIconTint(getColor())
            .setAllowedNetworkTypesForReasons(defaultAllowNetworkTypes);
    
    int subId = mSubscriptionDatabaseManager.insertSubscriptionInfo(builder.build());
    <span class="hljs-keyword">return</span> subId;
}
</code></pre>
<h3 data-id="heading-12">5. Subscription 查询与访问</h3>
<h4 data-id="heading-13">5.1 公开 API（SubscriptionManager）</h4>
<p>应用通过 <code>SubscriptionManager</code> 类查询订阅信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取所有订阅信息</span>
List&lt;SubscriptionInfo&gt; allSubs = subscriptionManager.getAllSubscriptionInfoList();

<span class="hljs-comment">// 获取活跃订阅</span>
List&lt;SubscriptionInfo&gt; activeSubs = subscriptionManager.getActiveSubscriptionInfoList();

<span class="hljs-comment">// 通过 SubId 获取</span>
<span class="hljs-type">SubscriptionInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> subscriptionManager.getActiveSubscriptionInfo(subId);

<span class="hljs-comment">// 获取默认订阅</span>
<span class="hljs-type">int</span> <span class="hljs-variable">defaultDataSubId</span> <span class="hljs-operator">=</span> SubscriptionManager.getDefaultDataSubscriptionId();
<span class="hljs-type">int</span> <span class="hljs-variable">defaultVoiceSubId</span> <span class="hljs-operator">=</span> SubscriptionManager.getDefaultVoiceSubscriptionId();
</code></pre>
<h4 data-id="heading-14">5.2 内部访问（SubscriptionDatabaseManager）</h4>
<p>框架内部通过 <code>SubscriptionDatabaseManager</code> 直接访问数据库：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">2442</span><span class="hljs-symbol">:</span><span class="hljs-number">2463</span><span class="hljs-symbol">:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/SubscriptionDatabaseManager</span>.java
<span class="hljs-variable">@Nullable</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">SubscriptionInfoInternal</span> getSubscriptionInfoInternal(int subId) {
    mReadWriteLock.readLock().lock();
    try {
        <span class="hljs-keyword">return</span> mAllSubscriptionInfoInternalCache.get(subId);
    } finally {
        mReadWriteLock.readLock().unlock();
    }
}

<span class="hljs-variable">@NonNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">SubscriptionInfoInternal</span>&gt; getAllSubscriptions() {
    mReadWriteLock.readLock().lock();
    try {
        <span class="hljs-keyword">return</span> new <span class="hljs-title class_">ArrayList</span>&lt;&gt;(mAllSubscriptionInfoInternalCache.values());
    } finally {
        mReadWriteLock.readLock().unlock();
    }
}
</code></pre>
<h3 data-id="heading-15">6. 默认订阅（Default Subscriptions）</h3>
<h4 data-id="heading-16">6.1 三种默认订阅</h4>
<ul>
<li><strong>Default Voice SubId</strong>：用于语音通话的默认订阅</li>
<li><strong>Default Data SubId</strong>：用于移动数据的默认订阅</li>
<li><strong>Default SMS SubId</strong>：用于 SMS 的默认订阅</li>
</ul>
<h4 data-id="heading-17">6.2 默认值存储</h4>
<p>默认值存储在系统设置（Settings.Global）中：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">489</span><span class="hljs-symbol">:</span><span class="hljs-number">500</span><span class="hljs-symbol">:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/SubscriptionManagerService</span>.java
mDefaultVoiceSubId = new <span class="hljs-title class_">WatchedInt</span>(<span class="hljs-title class_">Settings</span>.<span class="hljs-title class_">Global</span>.getInt(mContext.getContentResolver(),
        <span class="hljs-title class_">Settings</span>.<span class="hljs-title class_">Global</span>.<span class="hljs-variable constant_">MULTI_SIM_VOICE_CALL_SUBSCRIPTION</span>,
        <span class="hljs-title class_">SubscriptionManager</span>.<span class="hljs-variable constant_">INVALID_SUBSCRIPTION_ID</span>)) {
    <span class="hljs-variable">@Override</span>
    <span class="hljs-keyword">public</span> boolean set(int newValue) {
        int oldValue = mValue;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">super</span>.set(newValue)) {
            logl(<span class="hljs-string">"Default voice subId changed from "</span> + oldValue + <span class="hljs-string">" to "</span> + newValue);
            <span class="hljs-title class_">Settings</span>.<span class="hljs-title class_">Global</span>.putInt(mContext.getContentResolver(), 
                <span class="hljs-title class_">Settings</span>.<span class="hljs-title class_">Global</span>.<span class="hljs-variable constant_">MULTI_SIM_VOICE_CALL_SUBSCRIPTION</span>, newValue);
            <span class="hljs-regexp">//</span> ... 广播变化
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
};
</code></pre>
<h4 data-id="heading-18">6.3 自动更新默认值</h4>
<p><code>MultiSimSettingController</code> 负责在多卡场景下自动更新默认值：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-number">619</span>:<span class="hljs-number">650</span>:frameworks_opt_telephony/src/java/com/android/<span class="hljs-keyword">internal</span>/telephony/MultiSimSettingController.java
<span class="hljs-comment">/**
 * Automatically update default settings (data / voice / sms).
 * 
 * 1) If the default subscription is still active, keep it unchanged.
 * 2) Or if there's another active primary subscription that's in the same group,
 *    make it the new default value.
 * 3) Or if there's only one active primary subscription, automatically set default
 *    data subscription on it.
 * 4) If none above is met, clear the default value to INVALID.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateDefaults</span>()</span> {
    <span class="hljs-keyword">if</span> (!isReadyToReevaluate()) <span class="hljs-keyword">return</span>;
    
    List&lt;SubscriptionInfo&gt; activeSubInfos = mSubscriptionManagerService
            .getActiveSubscriptionInfoList(...);
    
    <span class="hljs-keyword">if</span> (ArrayUtils.isEmpty(activeSubInfos)) {
        <span class="hljs-comment">// 无活跃订阅，清除默认值</span>
        mSubscriptionManagerService.setDefaultDataSubId(INVALID_SUBSCRIPTION_ID);
        mSubscriptionManagerService.setDefaultVoiceSubId(INVALID_SUBSCRIPTION_ID);
        mSubscriptionManagerService.setDefaultSmsSubId(INVALID_SUBSCRIPTION_ID);
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 自动更新...</span>
}
</code></pre>
<h3 data-id="heading-19">7. 订阅组（Subscription Groups）</h3>
<h4 data-id="heading-20">7.1 订阅组概念</h4>
<p>订阅组用于关联多个订阅（通常是主订阅和机会性订阅），它们共享某些设置。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">200</span>:<span class="hljs-number">240</span>:frameworks_base/telephony/java/com/android/internal/telephony/ISub.aidl
<span class="hljs-comment">/**
 * Inform SubscriptionManager that subscriptions in the list are bundled as a group.
 * Typically it's a primary subscription and an opportunistic subscription.
 * Being in the same group means they might be activated or deactivated together.
 */</span>
<span class="hljs-function">ParcelUuid <span class="hljs-title">createSubscriptionGroup</span><span class="hljs-params">(in <span class="hljs-type">int</span>[] subIdList, <span class="hljs-type">String</span> callingPackage)</span></span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">addSubscriptionsIntoGroup</span><span class="hljs-params">(in <span class="hljs-type">int</span>[] subIdList, in ParcelUuid groupUuid,
        <span class="hljs-type">String</span> callingPackage)</span></span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">removeSubscriptionsFromGroup</span><span class="hljs-params">(in <span class="hljs-type">int</span>[] subIdList, in ParcelUuid groupUuid,
        <span class="hljs-type">String</span> callingPackage)</span></span>;

<span class="hljs-function">List&lt;SubscriptionInfo&gt; <span class="hljs-title">getSubscriptionsInGroup</span><span class="hljs-params">(in ParcelUuid groupUuid,
        <span class="hljs-type">String</span> callingPackage, <span class="hljs-type">String</span> callingFeatureId)</span></span>;
</code></pre>
<h4 data-id="heading-21">7.2 组设置同步</h4>
<p>同组内的订阅必须共享相同的数据设置：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">372</span><span class="hljs-symbol">:</span><span class="hljs-number">394</span><span class="hljs-symbol">:frameworks_opt_telephony/src/java/com/android/internal/telephony/MultiSimSettingController</span>.java
/**
 * <span class="hljs-title class_">Make</span> sure <span class="hljs-variable constant_">MOBILE_DATA</span> of subscriptions <span class="hljs-keyword">in</span> same group are synced.
 *<span class="hljs-regexp">/
private void onUserDataEnabled(int subId, boolean enable, boolean setDefaultData) {
    /</span><span class="hljs-regexp">/ 确保同组订阅的 MOBILE_DATA 设置同步
    setUserDataEnabledForGroup(subId, enable);
    
    SubscriptionInfo subInfo = mSubscriptionManagerService.getSubscriptionInfo(subId);
    int defaultDataSubId = mSubscriptionManagerService.getDefaultDataSubId();
    
    /</span><span class="hljs-regexp">/ 如果用户启用了非默认的非机会性订阅，将其设为默认
    if (defaultDataSubId != subId &amp;&amp; subInfo != null &amp;&amp; !subInfo.isOpportunistic() 
            &amp;&amp; enable &amp;&amp; subInfo.isActive() &amp;&amp; setDefaultData) {
        mSubscriptionManagerService.setDefaultDataSubId(subId);
    }
}
</span></code></pre>
<h3 data-id="heading-22">8. 活跃与非活跃订阅</h3>
<h4 data-id="heading-23">8.1 什么是活跃订阅？</h4>
<p>当且仅当以下条件都满足时，订阅才是活跃的：</p>
<ol>
<li><code>SimSlotIndex &gt;= 0</code>（已分配到 SIM 卡槽）</li>
<li>UICC 应用已启用（<code>areUiccApplicationsEnabled() == true</code>）</li>
</ol>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">1517</span><span class="hljs-symbol">:</span><span class="hljs-number">1522</span><span class="hljs-symbol">:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/SubscriptionManagerService</span>.java
<span class="hljs-keyword">if</span> (subInfo != null &amp;&amp; subInfo.areUiccApplicationsEnabled()) {
    mSlotIndexToSubId.put(phoneId, subId);
    <span class="hljs-regexp">//</span> 更新 <span class="hljs-variable constant_">SIM</span> 槽位索引。这将使订阅变为活跃状态。
    mSubscriptionDatabaseManager.setSimSlotIndex(subId, phoneId);
}
</code></pre>
<h4 data-id="heading-24">8.2 非活跃订阅的 SimSlotIndex</h4>
<p>非活跃订阅的 <code>SimSlotIndex</code> 被设置为 <code>SubscriptionManager.INVALID_SIM_SLOT_INDEX (-1)</code>。</p>
<h3 data-id="heading-25">9. 机会性订阅（Opportunistic Subscriptions）</h3>
<p>机会性订阅是自动选择的订阅，用于特定场景（如某些地区有更便宜的数据计划）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">boolean</span> <span class="hljs-variable">isOpportunistic</span> <span class="hljs-operator">=</span> subscriptionInfo.isOpportunistic();

<span class="hljs-comment">// 机会性订阅不能是默认订阅</span>
<span class="hljs-comment">// 它们通常与主订阅组合使用</span>
</code></pre>
<h3 data-id="heading-26">10. 关键流程：SIM 插入/移除</h3>
<h4 data-id="heading-27">10.1 SIM 插入流程</h4>
<pre><code class="hljs language-scss" lang="scss">                    SIM Card Inserted
                           │
                           ▼
              UiccController detects state
                           │
                           ▼
          UiccController<span class="hljs-selector-class">.updateSimState</span>()
                           │
                           ▼
      SubscriptionManagerService<span class="hljs-selector-class">.updateSimState</span>()
                           │
              ┌────────────┼────────────┐
              ▼            ▼            ▼
        检查 IccId    数据库查询    创建/更新
        是否新 SIM     现有订阅      订阅记录
              │            │            │
              └────────────┼────────────┘
                           ▼
           <span class="hljs-built_in">updateSubscription</span>() completes
                           │
                ┌──────────┼──────────┐
                ▼          ▼          ▼
        更新显示名 更新运营商 广播变化
        更新位置代码 更新电话号码 通知应用
</code></pre>
<p>关键代码在 <code>updateSubscription()</code> 方法中：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">1536</span><span class="hljs-symbol">:</span><span class="hljs-number">1558</span><span class="hljs-symbol">:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/SubscriptionManagerService</span>.java
<span class="hljs-keyword">if</span> (simState == <span class="hljs-title class_">TelephonyManager</span>.<span class="hljs-variable constant_">SIM_STATE_LOADED</span>) {
    <span class="hljs-regexp">//</span> 获取 <span class="hljs-variable constant_">MCC</span>/<span class="hljs-variable constant_">MNC</span> 信息
    <span class="hljs-title class_">String</span> mccMnc = mTelephonyManager.getSimOperatorNumeric(subId);
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">TextUtils</span>.isEmpty(mccMnc)) {
        <span class="hljs-keyword">if</span> (subId == getDefaultSubId()) {
            <span class="hljs-title class_">MccTable</span>.updateMccMncConfiguration(mContext, mccMnc);
        }
        setMccMnc(subId, mccMnc);
    }
    
    /<span class="hljs-regexp">/ 获取国家代码
    String iso = TelephonyManager.getSimCountryIsoForPhone(phoneId);
    if (!TextUtils.isEmpty(iso)) {
        setCountryIso(subId, iso);
    }
    
    /</span><span class="hljs-regexp">/ 获取电话号码
    String msisdn = PhoneFactory.getPhone(phoneId).getLine1Number();
    if (!TextUtils.isEmpty(msisdn)) {
        setDisplayNumber(msisdn, subId);
    }
}
</span></code></pre>
<h4 data-id="heading-28">10.2 SIM 移除流程</h4>
<pre><code class="hljs language-scss" lang="scss">                    SIM Card Removed
                           │
                           ▼
          UiccController detects ABSENT
                           │
                           ▼
      SubscriptionManagerService<span class="hljs-selector-class">.updateSimState</span>()
                           │
                           ▼
          <span class="hljs-built_in">markSubscriptionsInactive</span>(phoneId)
                           │
            ┌──────────────┼──────────────┐
            ▼              ▼              ▼
      设置 SimSlotIndex  清除显示名  清除运营商
      为 <span class="hljs-built_in">INVALID</span>(-<span class="hljs-number">1</span>)    清除位置信息    通知更新
</code></pre>
<h3 data-id="heading-29">11. 权限和访问控制</h3>
<h4 data-id="heading-30">11.1 权限要求</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 读取订阅信息</span>
<span class="hljs-meta">@RequiresPermission(anyOf = {
    Manifest.permission.READ_PHONE_STATE,
    "carrier privileges"
})</span>

<span class="hljs-comment">// 修改订阅信息</span>
<span class="hljs-meta">@RequiresPermission(Manifest.permission.MODIFY_PHONE_STATE)</span>

<span class="hljs-comment">// 读取设备标识符（获取 IccId、GroupUuid）</span>
<span class="hljs-meta">@RequiresPermission(Manifest.permission.READ_PHONE_NUMBERS)</span>
</code></pre>
<h4 data-id="heading-31">11.2 运营商特权访问</h4>
<p>具有运营商特权的应用可以访问相关订阅的更多信息。</p>
<h3 data-id="heading-32">12. SubscriptionManager 缓存机制</h3>
<p>为了提高性能，<code>SubscriptionManager</code> 使用了 <code>PropertyInvalidatedCache</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> PropertyInvalidatedCache&lt;Integer, Integer&gt; sGetSubIdCache = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyInvalidatedCache</span>&lt;Integer, Integer&gt;(<span class="hljs-number">16</span>, CACHE_PROPERTY_PREFIX + <span class="hljs-string">"subscription"</span>) {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> Integer <span class="hljs-title function_">recompute</span><span class="hljs-params">(Integer slotIndex)</span> {
            <span class="hljs-comment">// 查询数据库或从 SubscriptionManagerService 获取</span>
        }
    };
</code></pre>
<p>当订阅信息变化时，缓存会被自动清除。</p>
<h3 data-id="heading-33">13. 实践：查询和使用订阅</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取 SubscriptionManager</span>
<span class="hljs-type">SubscriptionManager</span> <span class="hljs-variable">subscriptionManager</span> <span class="hljs-operator">=</span> 
    context.getSystemService(SubscriptionManager.class);

<span class="hljs-comment">// 获取所有活跃订阅</span>
List&lt;SubscriptionInfo&gt; activeSubscriptions = 
    subscriptionManager.getActiveSubscriptionInfoList();

<span class="hljs-keyword">for</span> (SubscriptionInfo subInfo : activeSubscriptions) {
    <span class="hljs-type">int</span> <span class="hljs-variable">subId</span> <span class="hljs-operator">=</span> subInfo.getSubscriptionId();
    <span class="hljs-type">String</span> <span class="hljs-variable">displayName</span> <span class="hljs-operator">=</span> subInfo.getDisplayName().toString();
    <span class="hljs-type">int</span> <span class="hljs-variable">simSlotIndex</span> <span class="hljs-operator">=</span> subInfo.getSimSlotIndex();
    <span class="hljs-type">String</span> <span class="hljs-variable">iccId</span> <span class="hljs-operator">=</span> subInfo.getIccId();
    <span class="hljs-type">String</span> <span class="hljs-variable">carrierName</span> <span class="hljs-operator">=</span> subInfo.getCarrierName().toString();
    
    Log.d(TAG, <span class="hljs-string">"SubId: "</span> + subId + <span class="hljs-string">", Name: "</span> + displayName 
        + <span class="hljs-string">", Slot: "</span> + simSlotIndex + <span class="hljs-string">", Carrier: "</span> + carrierName);
}

<span class="hljs-comment">// 为特定订阅创建 TelephonyManager</span>
<span class="hljs-type">TelephonyManager</span> <span class="hljs-variable">telManager</span> <span class="hljs-operator">=</span> 
    context.getSystemService(TelephonyManager.class)
           .createForSubscriptionId(subId);

<span class="hljs-comment">// 获取该订阅的网络运营商</span>
<span class="hljs-type">String</span> <span class="hljs-variable">operatorName</span> <span class="hljs-operator">=</span> telManager.getNetworkOperatorName();
</code></pre>
<h3 data-id="heading-34">14. 关键类总结</h3>









































<table><thead><tr><th>类</th><th>作用</th></tr></thead><tbody><tr><td><code>SubscriptionManager</code></td><td>公开 API，应用端查询订阅信息</td></tr><tr><td><code>SubscriptionManagerService</code></td><td>系统服务，管理所有订阅的后端</td></tr><tr><td><code>SubscriptionDatabaseManager</code></td><td>订阅数据库管理，缓存和访问 <code>SimInfo</code> 表</td></tr><tr><td><code>SubscriptionInfo</code></td><td>公开订阅信息模型</td></tr><tr><td><code>SubscriptionInfoInternal</code></td><td>内部订阅信息模型，完整对应数据库</td></tr><tr><td><code>MultiSimSettingController</code></td><td>多卡设置协调，确保同组订阅设置同步</td></tr><tr><td><code>ISub</code></td><td>AIDL 接口，定义 SubscriptionManagerService 的 IPC 方法</td></tr><tr><td><code>PhoneSwitcher</code></td><td>多卡数据连接管理（详见多卡管理章节）</td></tr></tbody></table>
<hr/>
<p>这就是 Android 电话框架中 Subscription 管理的完整体系。它是 DSDS（双卡双待）管理的基础，为系统如何跟踪、访问和协调多个 SIM 卡提供了数据模型和操作框架。</p>
<p>有任何关于 Subscription 管理的具体问题吗？我可以深入解释任何特定的部分。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android RIL 中 HIDL 和 AIDL 的区别]]></title>    <link>https://juejin.cn/post/7603309951227543602</link>    <guid>https://juejin.cn/post/7603309951227543602</guid>    <pubDate>2026-02-06T09:26:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951227543602" data-draft-id="7603309951227527218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android RIL 中 HIDL 和 AIDL 的区别"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-02-06T09:26:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android RIL 中 HIDL 和 AIDL 的区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:26:08.000Z" title="Fri Feb 06 2026 09:26:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 历史背景</h3>





























<table><thead><tr><th>时期</th><th>语言</th><th>Android 版本</th><th>说明</th></tr></thead><tbody><tr><td><strong>Android 7.0 - 12</strong></td><td><strong>HIDL</strong> (HAL Interface Definition Language)</td><td>Nougat - S</td><td>首个现代 HAL 接口语言</td></tr><tr><td><strong>Android 13+</strong></td><td><strong>AIDL</strong> (Android Interface Definition Language)</td><td>T 及以后</td><td>统一的 IPC 接口语言</td></tr><tr><td><strong>过渡期</strong></td><td><strong>两者共存</strong></td><td>S/T</td><td>兼容性层支持 HIDL 驱动</td></tr></tbody></table>
<h3 data-id="heading-1">2. 核心架构差异</h3>
<h4 data-id="heading-2">2.1 接口定义方式</h4>
<p><strong>HIDL（旧）- <code>.hal</code> 文件：</strong></p>
<pre><code class="hljs language-scss" lang="scss">hardware_interfaces/radio/<span class="hljs-number">1.4</span>/IRadio<span class="hljs-selector-class">.hal</span>
package android<span class="hljs-selector-class">.hardware</span><span class="hljs-selector-class">.radio</span>@<span class="hljs-number">1.4</span>;

interface IRadio {
    oneway <span class="hljs-built_in">dial</span>(int32_t serial, Dial dialInfo);
    oneway <span class="hljs-built_in">hangupConnection</span>(int32_t serial, uint32_t gsmCallNumber);
    oneway <span class="hljs-built_in">setResponseFunctions</span>(IRadioResponse radioResponse, IRadioIndication radioIndication);
}
</code></pre>
<p><strong>AIDL（新）- <code>.aidl</code> 文件：</strong></p>
<pre><code class="hljs language-java" lang="java">hardware_interfaces/radio/aidl/android/hardware/radio/voice/IRadioVoice.aidl
<span class="hljs-keyword">package</span> android.hardware.radio.voice;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRadioVoice</span> {
    oneway <span class="hljs-keyword">void</span> <span class="hljs-title function_">dial</span><span class="hljs-params">(in <span class="hljs-type">int</span> serial, in Dial dialInfo)</span>;
    oneway <span class="hljs-keyword">void</span> <span class="hljs-title function_">hangupConnection</span><span class="hljs-params">(in <span class="hljs-type">int</span> serial, in <span class="hljs-type">int</span> gsmCallNumber)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setResponseFunctions</span><span class="hljs-params">(in IRadioVoiceResponse radioVoiceResponse,
                              in IRadioVoiceIndication radioVoiceIndication)</span>;
}
</code></pre>
<h4 data-id="heading-3">2.2 接口颗粒度</h4>
<p><strong>HIDL：单体接口</strong></p>
<ul>
<li>一个 <code>IRadio</code> 接口包含所有功能（voice, data, network, messaging, sim, config）</li>
<li>版本号递增：1.0 → 1.1 → 1.2 → ... → 1.6</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">hardware_interfaces/radio/1.0/IRadio.hal    (2000+ 行)
    ├─ Voice 功能
    ├─ Data 功能
    ├─ Network 功能
    ├─ Messaging 功能
    ├─ SIM 功能
    └─ Config 功能
</code></pre>
<p><strong>AIDL：模块化接口</strong></p>
<ul>
<li>按功能域分离成多个接口</li>
<li>每个模块独立版本控制</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">hardware_interfaces/radio/aidl/android/hardware/radio/
├─ voice/IRadioVoice.aidl
├─ data/IRadioData.aidl
├─ network/IRadioNetwork.aidl
├─ messaging/IRadioMessaging.aidl
├─ sim/IRadioSim.aidl
├─ modem/IRadioModem.aidl
└─ config/IRadioConfig.aidl
</code></pre>
<h3 data-id="heading-4">3. 响应和指示机制</h3>
<h4 data-id="heading-5">3.1 HIDL 响应流程</h4>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-title class_">Framework</span> (<span class="hljs-title class_">Java</span>)
    │
    ├─ setResponseFunctions(<span class="hljs-title class_">IRadioResponse</span>, <span class="hljs-title class_">IRadioIndication</span>)
    │
<span class="hljs-variable constant_">RIL</span> (<span class="hljs-variable constant_">JNI</span>/C++)
    │
    ├─ <span class="hljs-title class_">IRadio</span><span class="hljs-variable">@1</span>.<span class="hljs-number">4</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:dial</span>()
    │
    └─ <span class="hljs-title class_">IRadioResponse</span><span class="hljs-variable">@1</span>.<span class="hljs-number">4</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:dialResponse</span>()
       <span class="hljs-title class_">IRadioIndication</span><span class="hljs-variable">@1</span>.<span class="hljs-number">4</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:callStateChanged</span>()
</code></pre>
<p>响应和指示通过同一对接口处理：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">44</span>:<span class="hljs-number">60</span>:hardware_interfaces/radio/<span class="hljs-number">1.0</span>/IRadio.hal
interface IRadio {
    <span class="hljs-built_in">setResponseFunctions</span>(IRadioResponse radioResponse, IRadioIndication radioIndication);
    oneway <span class="hljs-built_in">dial</span>(int32_t serial, Dial dialInfo);
    <span class="hljs-comment">// ...</span>
}

interface IRadioResponse {
    <span class="hljs-built_in">dialResponse</span>(RadioResponseInfo info);
}

interface IRadioIndication {
    <span class="hljs-built_in">callStateChanged</span>(RadioIndicationType type);
}
</code></pre>
<h4 data-id="heading-6">3.2 AIDL 响应流程</h4>
<pre><code class="hljs language-scss" lang="scss">Framework (Java)
    │
    ├─ <span class="hljs-built_in">setResponseFunctions</span>(IRadioVoiceResponse, IRadioVoiceIndication)
    │
RIL (C++)
    │
    ├─ IRadioVoice::<span class="hljs-built_in">dial</span>()
    │
    └─ IRadioVoiceResponse::<span class="hljs-built_in">dialResponse</span>()
       IRadioVoiceIndication::<span class="hljs-built_in">callStateChanged</span>()
</code></pre>
<p>AIDL 采用<strong>分离的响应接口</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">hardware_interfaces/radio/aidl/android/hardware/radio/voice/IRadioVoice.aidl
<span class="hljs-keyword">interface</span> <span class="hljs-title">IRadioVoice</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setResponseFunctions</span>(<span class="hljs-params"><span class="hljs-keyword">in</span> IRadioVoiceResponse radioVoiceResponse,
                              <span class="hljs-keyword">in</span> IRadioVoiceIndication radioVoiceIndication</span>)</span>;
    <span class="hljs-function">oneway <span class="hljs-keyword">void</span> <span class="hljs-title">dial</span>(<span class="hljs-params"><span class="hljs-keyword">in</span> <span class="hljs-built_in">int</span> serial, <span class="hljs-keyword">in</span> Dial dialInfo</span>)</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title">IRadioVoiceResponse</span> {
    <span class="hljs-function">oneway <span class="hljs-keyword">void</span> <span class="hljs-title">dialResponse</span>(<span class="hljs-params"><span class="hljs-keyword">in</span> RadioResponseInfo info</span>)</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title">IRadioVoiceIndication</span> {
    <span class="hljs-function">oneway <span class="hljs-keyword">void</span> <span class="hljs-title">callStateChanged</span>(<span class="hljs-params"><span class="hljs-keyword">in</span> RadioIndicationType type</span>)</span>;
}
</code></pre>
<h3 data-id="heading-7">4. 数据结构定义</h3>
<h4 data-id="heading-8">4.1 HIDL - 复杂的继承体系</h4>
<pre><code class="hljs language-ini" lang="ini">hardware_interfaces/radio/1.0/types.hal
struct Dial {
    string address<span class="hljs-comment">;</span>
    Clir clir<span class="hljs-comment">;</span>
    vec&lt;UusInfo&gt; uusInfo<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

struct RadioResponseInfo {
    RadioResponseType type<span class="hljs-comment">;</span>
    int32_t serial<span class="hljs-comment">;</span>
    RadioError error<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p>HIDL 支持联合（union）和层级继承。</p>
<h4 data-id="heading-9">4.2 AIDL - 扁平的数据结构</h4>
<pre><code class="hljs language-ini" lang="ini">hardware_interfaces/radio/aidl/android/hardware/radio/voice/Dial.aidl
package android.hardware.radio.voice<span class="hljs-comment">;</span>
parcelable Dial {
    String address<span class="hljs-comment">;</span>
    int clir<span class="hljs-comment">;</span>
    UusInfo<span class="hljs-section">[]</span> uusInfo<span class="hljs-comment">;</span>
}

hardware_interfaces/radio/aidl/android/hardware/radio/RadioResponseInfo.aidl
package android.hardware.radio<span class="hljs-comment">;</span>
parcelable RadioResponseInfo {
    RadioResponseType type<span class="hljs-comment">;</span>
    int serial<span class="hljs-comment">;</span>
    RadioError error<span class="hljs-comment">;</span>
}
</code></pre>
<p>AIDL 使用 <code>parcelable</code> 而非 <code>struct</code>。</p>
<h3 data-id="heading-10">5. RIL Java 层的适配</h3>
<p>RIL 框架通过代理类适配两种接口：</p>
<pre><code class="hljs language-ini" lang="ini">53:100:frameworks_opt_telephony/src/java/com/android/internal/telephony/RadioServiceProxy.java
/**
 * A holder for IRadio services.
 * Use getHidl to get the HIDL IRadio service or getAidl to get the corresponding AIDL service.
 */
public abstract class RadioServiceProxy {
    boolean mIsAidl<span class="hljs-comment">;                                    // 标志：是否为 AIDL</span>
    HalVersion <span class="hljs-attr">mHalVersion</span> = RIL.RADIO_HAL_VERSION_UNKNOWN<span class="hljs-comment">;</span>
    volatile android.hardware.radio.V1_4.IRadio <span class="hljs-attr">mRadioProxy</span> = null<span class="hljs-comment">;</span>

    /**
     * Set IRadio as the HIDL implementation for RadioServiceProxy
     */
    public void setHidl(HalVersion halVersion, android.hardware.radio.V1_4.IRadio radio) {
        <span class="hljs-attr">mHalVersion</span> = halVersion<span class="hljs-comment">;</span>
        <span class="hljs-attr">mRadioProxy</span> = radio<span class="hljs-comment">;</span>
        <span class="hljs-attr">mIsAidl</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }

    /**
     * Set IRadio as the AIDL implementation for RadioServiceProxy
     */
    public void setAidl(android.hardware.radio.IRadio radioAidl) {
        <span class="hljs-attr">mAidlRadioProxy</span> = radioAidl<span class="hljs-comment">;</span>
        <span class="hljs-attr">mIsAidl</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    }

    public boolean isAidl() {
        return mIsAidl<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-11">6. 兼容性层：libradiocompat</h3>
<p>Android 13 引入了兼容性层，允许在 AIDL 框架中使用旧的 HIDL HAL 实现。</p>
<h4 data-id="heading-12">6.1 架构</h4>
<pre><code class="hljs language-scss" lang="scss">         Framework (AIDL)
               │
     ┌─────────┴─────────┐
     │                   │
  AIDL HAL          libradiocompat
  (Native)          (Converter)
                        │
                   HIDL HAL (Legacy)
</code></pre>
<h4 data-id="heading-13">6.2 数据结构转换</h4>
<p>libradiocompat 提供了双向转换函数：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">19</span><span class="hljs-symbol">:</span><span class="hljs-number">45</span><span class="hljs-symbol">:hardware_interfaces/radio/aidl/compat/libradiocompat/commonStructs</span>.cpp
namespace android::hardware::radio::compat {

<span class="hljs-regexp">//</span> <span class="hljs-variable constant_">HIDL</span> to <span class="hljs-variable constant_">AIDL</span> conversion
aidl::<span class="hljs-title class_">RadioResponseInfo</span> toAidl(const <span class="hljs-variable constant_">V1_0</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:RadioResponseInfo&amp;</span> info) {
    <span class="hljs-keyword">return</span> {
            .type = toAidl(info.type),
            .serial = info.serial,
            .error = toAidl(info.error),
    };
}

/<span class="hljs-regexp">/ AIDL to HIDL conversion
V1_0::RadioCapability toHidl(const aidl::RadioCapability&amp; capa) {
    return {
            .session = capa.session,
            .phase = static_cast&lt;V1_0::RadioCapabilityPhase&gt;(capa.phase),
            .raf = toHidlBitfield&lt;V1_0::RadioAccessFamily&gt;(capa.raf),
            .logicalModemUuid = capa.logicalModemUuid,
            .status = static_cast&lt;V1_0::RadioCapabilityStatus&gt;(capa.status),
    };
}

}
</span></code></pre>
<h4 data-id="heading-14">6.3 集合转换</h4>
<p>支持向量和数组的自动转换：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">23</span>:<span class="hljs-number">56</span>:hardware_interfaces/radio/aidl/compat/libradiocompat/collections.h
<span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">toAidl</span><span class="hljs-params">(<span class="hljs-type">const</span> hidl_vec&lt;T&gt;&amp; inp)</span> </span>{
    <span class="hljs-function">std::vector&lt;<span class="hljs-title">decltype</span><span class="hljs-params">(toAidl(T{}))</span>&gt; <span class="hljs-title">out</span><span class="hljs-params">(inp.size())</span></span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; inp.<span class="hljs-built_in">size</span>(); i++) {
        out[i] = <span class="hljs-built_in">toAidl</span>(inp[i]);
    }
    <span class="hljs-keyword">return</span> out;
}

<span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">toHidl</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;T&gt;&amp; inp)</span> </span>{
    <span class="hljs-function">hidl_vec&lt;<span class="hljs-title">decltype</span><span class="hljs-params">(toHidl(T{}))</span>&gt; <span class="hljs-title">out</span><span class="hljs-params">(inp.size())</span></span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; inp.<span class="hljs-built_in">size</span>(); i++) {
        out[i] = <span class="hljs-built_in">toHidl</span>(inp[i]);
    }
    <span class="hljs-keyword">return</span> out;
}
</code></pre>
<h3 data-id="heading-15">7. 关键差异对比表</h3>























































<table><thead><tr><th>特性</th><th>HIDL</th><th>AIDL</th></tr></thead><tbody><tr><td><strong>引入时间</strong></td><td>Android 7.0 (Nougat)</td><td>Android 13 (Tiramisu)</td></tr><tr><td><strong>定义文件</strong></td><td><code>.hal</code></td><td><code>.aidl</code></td></tr><tr><td><strong>接口粒度</strong></td><td>单体（IRadio 包含所有）</td><td>模块化（IRadioVoice, IRadioData 等）</td></tr><tr><td><strong>版本管理</strong></td><td>整体版本（1.0-1.6）</td><td>按模块版本（各模块独立）</td></tr><tr><td><strong>类型系统</strong></td><td>复杂继承体系</td><td>简洁的 parcelable 类型</td></tr><tr><td><strong>代码生成</strong></td><td>HIDL 编译器</td><td>AIDL 编译器</td></tr><tr><td><strong>二进制兼容性</strong></td><td>使用 HIDL 运行时</td><td>使用 Binder</td></tr><tr><td><strong>兼容性支持</strong></td><td>原生支持 HIDL</td><td>通过 libradiocompat</td></tr><tr><td><strong>性能特征</strong></td><td>针对 HAL 优化</td><td>通用 IPC 优化</td></tr></tbody></table>
<h3 data-id="heading-16">8. 版本管理对比</h3>
<p><strong>HIDL 版本演进：</strong></p>
<pre><code class="hljs language-ruby" lang="ruby">android.hardware.radio<span class="hljs-variable">@1</span>.<span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadio</span>
    ├─ dial()
    ├─ hangupConnection()
    └─ ...

android.hardware.radio<span class="hljs-variable">@1</span>.<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadio</span> extends <span class="hljs-variable">@1</span>.<span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadio</span>
    └─ setCarrierInfoForImsiEncryption()  (新增)

android.hardware.radio<span class="hljs-variable">@1</span>.<span class="hljs-number">2</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadio</span> extends <span class="hljs-variable">@1</span>.<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadio</span>
    └─ startNetworkScan()                 (新增)

...

android.hardware.radio<span class="hljs-variable">@1</span>.<span class="hljs-number">6</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadio</span> extends <span class="hljs-variable">@1</span>.<span class="hljs-number">5</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadio</span>
    └─ setSimCardPower()                  (新增)
</code></pre>
<p><strong>AIDL 模块化版本：</strong></p>
<pre><code class="hljs language-ruby" lang="ruby">android.hardware.radio.voice<span class="hljs-variable">@1</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadioVoice</span>
    ├─ dial()
    ├─ hangupConnection()
    └─ ...

android.hardware.radio.data<span class="hljs-variable">@1</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadioData</span>
    ├─ setupDataCall()
    ├─ deactivateDataCall()
    └─ ...

android.hardware.radio.sim<span class="hljs-variable">@1</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadioSim</span>
    ├─ getIccCardStatus()
    ├─ supplyIccPin()
    └─ ...
</code></pre>
<h3 data-id="heading-17">9. 实际通信流程</h3>
<h4 data-id="heading-18">9.1 HIDL 请求/响应</h4>
<pre><code class="hljs language-less" lang="less">┌─────────────────┐
│ <span class="hljs-selector-tag">RIL</span> (Java/JNI)  │
└────────┬────────┘
         │ <span class="hljs-number">1</span>. <span class="hljs-selector-tag">mRadioProxy</span><span class="hljs-selector-class">.dial</span>(serial, dialInfo)
         ▼
┌─────────────────────────────────┐
│ <span class="hljs-selector-tag">HIDL</span> <span class="hljs-selector-tag">Service</span> (radio<span class="hljs-variable">@1</span>.<span class="hljs-number">4</span>::IRadio)│ (Native HAL)
└────────┬────────────────────────┘
         │ <span class="hljs-number">2</span>. 内部处理
         │ <span class="hljs-number">3</span>. 调用响应回调
         ▼
┌──────────────────────────────────┐
│ <span class="hljs-selector-tag">HIDL</span> <span class="hljs-selector-tag">Callback</span> (IRadioResponse)    │
└────────┬─────────────────────────┘
         │ <span class="hljs-number">4</span>. <span class="hljs-selector-tag">response-</span>&gt;<span class="hljs-selector-tag">dialResponse</span>(responseInfo)
         ▼
┌─────────────────────┐
│ <span class="hljs-selector-tag">RIL</span> <span class="hljs-selector-tag">Callback</span> <span class="hljs-selector-tag">Handler</span>│
└─────────────────────┘
</code></pre>
<h4 data-id="heading-19">9.2 AIDL 请求/响应</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────┐
│ RIL (Java/JNI)  │
└────────┬────────┘
         │ <span class="hljs-number">1</span>. mRadioProxy<span class="hljs-selector-class">.dial</span>(serial, dialInfo)
         ▼
┌─────────────────────────────────┐
│ AIDL Service (IRadioVoice)       │ (Native HAL or Compat Layer)
└────────┬────────────────────────┘
         │ <span class="hljs-number">2</span>. 内部处理
         │ <span class="hljs-number">3</span>. 调用响应回调
         ▼
┌──────────────────────────────────┐
│ AIDL Callback (IRadioVoiceResponse)
└────────┬─────────────────────────┘
         │ <span class="hljs-number">4</span>. response-&gt;<span class="hljs-built_in">dialResponse</span>(responseInfo)
         ▼
┌─────────────────────┐
│ RIL Callback Handler│
└─────────────────────┘
</code></pre>
<h3 data-id="heading-20">10. 构建系统差异</h3>
<p><strong>HIDL 编译：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile">hidl_interface {
    name: <span class="hljs-string">"android.hardware.radio"</span>,
    root: <span class="hljs-string">"android.hardware"</span>,
    srcs: [
        <span class="hljs-string">"1.4/IRadio.hal"</span>,
        <span class="hljs-string">"1.4/IRadioResponse.hal"</span>,
        <span class="hljs-string">"1.4/IRadioIndication.hal"</span>,
        <span class="hljs-string">"1.4/types.hal"</span>,
    ],
    interfaces: [
        <span class="hljs-string">"android.hardware.base@1.0"</span>,
    ],
}
</code></pre>
<p><strong>AIDL 编译：</strong></p>
<pre><code class="hljs language-blueprint" lang="blueprint">aidl_interface {
    name: "android.hardware.radio",
    vendor_available: true,
    srcs: [
        "android/hardware/radio/voice/*.aidl",
        "android/hardware/radio/data/*.aidl",
        "android/hardware/radio/network/*.aidl",
        "android/hardware/radio/sim/*.aidl",
        "android/hardware/radio/modem/*.aidl",
        "android/hardware/radio/messaging/*.aidl",
    ],
    stability: "vintf",
    backend: {
        cpp: { enabled: true; },
        java: { enabled: true; },
    },
    versions_with_info: [
        { version: "1"; },
        { version: "2"; },
        { version: "3"; },
    ],
    frozen: true,
}
</code></pre>
<h3 data-id="heading-21">11. 性能和稳定性考量</h3>



































<table><thead><tr><th>方面</th><th>HIDL</th><th>AIDL</th></tr></thead><tbody><tr><td><strong>内存占用</strong></td><td>较小（C++ 优化）</td><td>相同或稍大</td></tr><tr><td><strong>IPC 延迟</strong></td><td>优化的 Binder 使用</td><td>标准 Binder 延迟</td></tr><tr><td><strong>类型安全</strong></td><td>强类型检查</td><td>强类型检查</td></tr><tr><td><strong>向后兼容</strong></td><td>通过继承链</td><td>通过版本管理</td></tr><tr><td><strong>热修复</strong></td><td>困难（版本锁定）</td><td>更容易（模块独立）</td></tr></tbody></table>
<h3 data-id="heading-22">12. 迁移建议</h3>
<p><strong>从 HIDL 迁移到 AIDL 的好处：</strong></p>
<ol>
<li><strong>模块化</strong> - 各功能模块独立演进</li>
<li><strong>统一 IPC</strong> - 不再有特殊的 HAL IPC 机制</li>
<li><strong>灵活版本管理</strong> - 每个模块独立版本</li>
<li><strong>更好的工具</strong> - 统一使用 AIDL 工具链</li>
<li><strong>长期支持</strong> - AIDL 是未来方向</li>
</ol>
<p><strong>兼容性策略：</strong></p>
<ul>
<li>Android 13-14：HIDL 和 AIDL 并存，通过 libradiocompat 支持旧 HAL</li>
<li>Android 15+：可能逐步淘汰 HIDL 支持</li>
</ul>
<hr/>
<p>总结来说，<strong>HIDL 是针对 HAL 的专用接口语言</strong>，而 <strong>AIDL 是通用的系统服务接口语言</strong>。RIL 从 HIDL 迁移到 AIDL 反映了 Android 系统架构向更统一、模块化方向的演进。</p>
<p>有任何关于 HIDL/AIDL 在 RIL 中的实现细节的问题吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Modem 向系统上报的无线指示（Unsolicited Indication）的完整列表]]></title>    <link>https://juejin.cn/post/7603359026711478282</link>    <guid>https://juejin.cn/post/7603359026711478282</guid>    <pubDate>2026-02-06T09:29:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603359026711478282" data-draft-id="7603393977477365786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Modem 向系统上报的无线指示（Unsolicited Indication）的完整列表"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-02-06T09:29:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Modem 向系统上报的无线指示（Unsolicited Indication）的完整列表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:29:59.000Z" title="Fri Feb 06 2026 09:29:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Modem 向系统上报的无线指示共分为 <strong>7 个大类</strong>，总计约 <strong>70+ 种具体指示</strong>，分布如下：</p>
<hr/>
<h2 data-id="heading-0">1️⃣ <strong>语音指示（Voice Indications）- 13 种</strong></h2>
<p>来自 <code>IRadioVoiceIndication</code> 接口：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> callRing                          - 来电铃声（来电响铃指示）
<span class="hljs-bullet">2.</span> callStateChanged                  - 通话状态变化
<span class="hljs-bullet">3.</span> cdmaCallWaiting                   - CDMA 呼叫等待
<span class="hljs-bullet">4.</span> cdmaInfoRec                       - CDMA 信息记录
<span class="hljs-bullet">5.</span> cdmaOtaProvisionStatus            - CDMA OTA 配置状态
<span class="hljs-bullet">6.</span> currentEmergencyNumberList        - 紧急号码列表
<span class="hljs-bullet">7.</span> enterEmergencyCallbackMode        - 进入紧急回调模式
<span class="hljs-bullet">8.</span> exitEmergencyCallbackMode         - 退出紧急回调模式
<span class="hljs-bullet">9.</span> indicateRingbackTone              - 指示回铃音
<span class="hljs-bullet">10.</span> onSupplementaryServiceIndication - 补充服务指示
<span class="hljs-bullet">11.</span> onUssd                           - USSD 消息
<span class="hljs-bullet">12.</span> resendIncallMute                 - 重新发送通话中静音
<span class="hljs-bullet">13.</span> srvccStateNotify                 - SRVCC 状态变化
<span class="hljs-bullet">14.</span> stkCallControlAlphaNotify        - STK 呼叫控制字母通知
<span class="hljs-bullet">15.</span> stkCallSetup                     - STK 设置呼叫
</code></pre>
<hr/>
<h2 data-id="heading-1">2️⃣ <strong>数据指示（Data Indications）- 5 种</strong></h2>
<p>来自 <code>IRadioDataIndication</code> 接口：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> dataCallListChanged     - 数据连接列表变化
<span class="hljs-bullet">2.</span> keepaliveStatus         - 保活会话状态
<span class="hljs-bullet">3.</span> pcoData                 - PCO 数据（运营商配置数据）
<span class="hljs-bullet">4.</span> unthrottleApn           - 解除 APN 限流
<span class="hljs-bullet">5.</span> slicingConfigChanged    - 网络切片配置变化
</code></pre>
<hr/>
<h2 data-id="heading-2">3️⃣ <strong>网络指示（Network Indications）- 14 种</strong></h2>
<p>来自 <code>IRadioNetworkIndication</code> 接口：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> barringInfoChanged              - 禁用信息变化
<span class="hljs-bullet">2.</span> cdmaPrlChanged                  - CDMA PRL 版本变化
<span class="hljs-bullet">3.</span> cellInfoList                    - 小区信息列表
<span class="hljs-bullet">4.</span> currentLinkCapacityEstimate     - 链路容量估计
<span class="hljs-bullet">5.</span> currentPhysicalChannelConfigs   - 物理信道配置
<span class="hljs-bullet">6.</span> currentSignalStrength           - 信号强度
<span class="hljs-bullet">7.</span> imsNetworkStateChanged          - IMS 网络状态变化
<span class="hljs-bullet">8.</span> networkScanResult               - 网络扫描结果
<span class="hljs-bullet">9.</span> networkStateChanged             - 网络状态变化
<span class="hljs-bullet">10.</span> nitzTimeReceived               - NITZ 时间接收
<span class="hljs-bullet">11.</span> registrationFailed             - 注册失败
<span class="hljs-bullet">12.</span> restrictedStateChanged         - 受限状态变化
<span class="hljs-bullet">13.</span> suppSvcNotify                  - 补充服务通知
<span class="hljs-bullet">14.</span> voiceRadioTechChanged          - 语音无线技术变化
<span class="hljs-bullet">15.</span> emergencyNetworkScanResult     - 紧急网络扫描结果
</code></pre>
<hr/>
<h2 data-id="heading-3">4️⃣ <strong>SIM/卡指示（SIM Indications）- 10 种</strong></h2>
<p>来自 <code>IRadioSimIndication</code> 接口：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> carrierInfoForImsiEncryption    - 运营商 IMSI 加密信息
<span class="hljs-bullet">2.</span> cdmaSubscriptionSourceChanged   - CDMA 订阅源变化
<span class="hljs-bullet">3.</span> simPhonebookChanged             - SIM 电话簿变化
<span class="hljs-bullet">4.</span> simPhonebookRecordsReceived     - SIM 电话簿记录接收
<span class="hljs-bullet">5.</span> simRefresh                      - SIM 刷新
<span class="hljs-bullet">6.</span> simStatusChanged                - SIM 状态变化
<span class="hljs-bullet">7.</span> stkEventNotify                  - STK 事件通知
<span class="hljs-bullet">8.</span> stkProactiveCommand             - STK 主动命令
<span class="hljs-bullet">9.</span> stkSessionEnd                   - STK 会话结束
<span class="hljs-bullet">10.</span> subscriptionStatusChanged      - 订阅状态变化
<span class="hljs-bullet">11.</span> uiccApplicationsEnablementChanged - UICC 应用启用/禁用变化
</code></pre>
<hr/>
<h2 data-id="heading-4">5️⃣ <strong>消息指示（Messaging Indications）- 6 种</strong></h2>
<p>来自 <code>IRadioMessagingIndication</code> 接口：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> cdmaNewSms               - 新 CDMA 短信
<span class="hljs-bullet">2.</span> cdmaRuimSmsStorageFull   - CDMA RUIM 短信存储满
<span class="hljs-bullet">3.</span> newBroadcastSms          - 新广播短信
<span class="hljs-bullet">4.</span> newSms                   - 新 GSM 短信
<span class="hljs-bullet">5.</span> newSmsOnSim              - SIM 卡上新短信
<span class="hljs-bullet">6.</span> newSmsStatusReport       - 短信状态报告
<span class="hljs-bullet">7.</span> simSmsStorageFull        - SIM 短信存储满
</code></pre>
<hr/>
<h2 data-id="heading-5">6️⃣ <strong>Modem/调制解调器指示（Modem Indications）- 6 种</strong></h2>
<p>来自 <code>IRadioModemIndication</code> 接口：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> hardwareConfigChanged    - 硬件配置变化
<span class="hljs-bullet">2.</span> modemReset               - Modem 重启
<span class="hljs-bullet">3.</span> radioCapabilityIndication - Radio 能力指示
<span class="hljs-bullet">4.</span> radioStateChanged        - Radio 状态变化
<span class="hljs-bullet">5.</span> rilConnected             - RIL 连接
<span class="hljs-bullet">6.</span> onImeiMappingChanged     - IMEI 映射变化
</code></pre>
<hr/>
<h2 data-id="heading-6">7️⃣ <strong>IMS 指示（IMS Indications）- 3 种</strong></h2>
<p>来自 <code>IRadioImsIndication</code> 接口：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> onConnectionSetupFailure - IMS 连接设置失败
<span class="hljs-bullet">2.</span> notifyAnbr               - 接收网络速率建议 (ANBR)
<span class="hljs-bullet">3.</span> triggerImsDeregistration - 触发 IMS 去注册
</code></pre>
<hr/>
<h2 data-id="heading-7">额外信息：Config 指示（Config Indications）</h2>
<p>除了上述主要指示，还有 <strong>Config 相关指示</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">来自 IRadioConfigIndication 接口：
<span class="hljs-bullet">1.</span> simSlotsStatusChanged      - SIM 槽状态变化
<span class="hljs-bullet">2.</span> enabledLogicalSlots        - 启用的逻辑槽变化
</code></pre>
<hr/>
<h2 data-id="heading-8">📊 总体分类</h2>


















































<table><thead><tr><th>类别</th><th>指示数</th><th>主要功能</th></tr></thead><tbody><tr><td>Voice</td><td>13</td><td>通话、CDMA、紧急呼叫、STK</td></tr><tr><td>Data</td><td>5</td><td>数据连接、PCO、APN 限流</td></tr><tr><td>Network</td><td>15</td><td>网络注册、信号、小区信息</td></tr><tr><td>SIM</td><td>11</td><td>SIM 卡、STK、订阅</td></tr><tr><td>Messaging</td><td>7</td><td>SMS、广播短信</td></tr><tr><td>Modem</td><td>6</td><td>Radio 状态、硬件配置、RIL</td></tr><tr><td>IMS</td><td>3</td><td>IMS 连接、速率建议</td></tr><tr><td><strong>总计</strong></td><td><strong>~60+</strong></td><td>—</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">🔑 关键点</h2>
<ol>
<li>
<p><strong>HIDL vs AIDL</strong>：</p>
<ul>
<li><strong>HIDL 1.0-1.6</strong>：所有指示通过单一 <code>IRadioIndication</code> 接口</li>
<li><strong>AIDL</strong>：指示分为 7 个专项接口，实现了模块化设计</li>
</ul>
</li>
<li>
<p><strong>指示触发时机</strong>：</p>
<ul>
<li>某些指示需要确认（如 SMS）</li>
<li>某些指示只在状态变化时触发（如 networkStateChanged）</li>
<li>某些指示可能定期触发（如 signalStrength）</li>
</ul>
</li>
<li>
<p><strong>Wake Lock 策略</strong>：在 HIDL 中，每个指示都关联一个 wake lock 策略（<code>WAKE_PARTIAL</code>、<code>DONT_WAKE</code> 等）</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一夜变天！OpenAI紧急甩出GPT-5.3-Codex，强得让人头皮发麻（附国内使用方法）]]></title>    <link>https://juejin.cn/post/7603581886148919350</link>    <guid>https://juejin.cn/post/7603581886148919350</guid>    <pubDate>2026-02-06T09:28:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603581886148919350" data-draft-id="7603383059152224298" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一夜变天！OpenAI紧急甩出GPT-5.3-Codex，强得让人头皮发麻（附国内使用方法）"/> <meta itemprop="keywords" content="OpenAI,ChatGPT"/> <meta itemprop="datePublished" content="2026-02-06T09:28:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱吃的小肥羊"/> <meta itemprop="url" content="https://juejin.cn/user/2637045249608064"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一夜变天！OpenAI紧急甩出GPT-5.3-Codex，强得让人头皮发麻（附国内使用方法）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2637045249608064/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱吃的小肥羊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:28:23.000Z" title="Fri Feb 06 2026 09:28:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>同样是竞争，国内外的方法还真的不一样！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e172ac7f95b745b1abec9c2f336e89cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=f9jseoJdtFLZ3%2BmKM25FH8CsbEk%3D" alt="" loading="lazy"/></p>
<p>今天凌晨，大事件一个接一个。</p>
<p>Anthropic和OpenAI这对"老冤家"，又同一个夜晚玩了次惊天大反转，开始集体扎堆发布模型，你还在回味Claude Opus 4.6的能力。</p>
<p>OpenAI就甩出了GPT-5.3-Codex，一个专为开发者设计的编程帮手，奥特曼称其拥有目前最佳的编码性能，进一步释放了 Codex 的潜能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb9ed97be55448ecadc755679217eaaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=LHjJ4vjMyWK8e3KFnkyKeuabXvo%3D" alt="" loading="lazy"/></p>
<p>那这款新模型到底有多强？国内能不能用以及如何使用？今天这篇文章给大家一次性讲清楚！</p>
<p>OpenAI直接甩出了数据：SWE-Bench Pro达到56.8%（这是实际软件工程场景的难题集），Terminal-Bench 2.0达到77.3%。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/645e9bf8089743349a962092de9a72d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=yV%2BCMR71iUV%2BQbLhC%2BXTo9GwkeE%3D" alt="" loading="lazy"/></p>
<p>这两个成绩是什么概念？简单说，这是OpenAI在当前编程模型中表现突出的成绩。相比GPT-5.2-Codex，速度快了25%，消耗的token还更少。</p>
<p>而且这一次，GPT-5.3-Codex还做到了一个特别有意思的事儿：它本身的训练和优化，用的就是Codex的早期版本。</p>
<p>也就是说，OpenAI的团队用上个月的Codex去打磨这个月的Codex，自我迭代的效率显著提升，两个月内，整个公司的工作方式都被它改造了。</p>
<p><strong>从编码助手变成工作智能体，这次GPT-5.3-Codex能力范围扩大十倍。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/203086cb123449b184a3a76da8f3bd3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=w3ZdJiC3YWK7HbhXUN47vXfiQWA%3D" alt="" loading="lazy"/></p>
<p>GPT-5.3-Codex不再只会"写代码、审代码"，它还能处理财务分析、生成演示稿、制作数据表格、调试异常、部署上线、写PRD、做用户研究……</p>
<p>听起来有点夸张，但这就是OpenAI所说的"Beyond Coding"的真实含义。</p>
<p>换句话说，整个项目周期里，所有涉及到屏幕、鼠标、代码、文档的事儿，它都能参与。</p>
<p>OpenAI在GDPval基准（测试专业知识工作能力的标准）上证明了这一点。</p>
<p>GPT-5.3-Codex的表现跟GPT-5.2持平，都处于顶尖水准。在计算机操作基准OSWorld上，它的表现也远超之前的GPT模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4dfd91e0c1e471f9de5ee961805e57c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=PjTGLoiSlrqGumb2u9G9LL9bINI%3D" alt="" loading="lazy"/></p>
<p>离发布会不到12个小时，国内外的用户已经开始玩疯了。</p>
<p>比如这位大佬就表示， GPT-5。3 Codex 其实在 Three.js 方面相当疯狂，非常轻松就制作出我的世界，但Opus 4.6就不太行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88e9ed89745d48c18c1067bdf250dffa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=9be%2FKRMXjzRYzlLWgd0hd28sFSY%3D" alt="" loading="lazy"/></p>
<p>还有用户表示，GPT-5.3 Codex相比GPT 5.2有着巨大的提升</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e49f7e9c0d1471b8d8d41b598992cc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=V%2FbN0iNXvNtT20lPymwrdZuA5Qo%3D" alt="" loading="lazy"/></p>
<p>OpenAI在测试中让GPT-5.3-Codex用几天时间从零开始制作了两个游戏。</p>
<p>赛车游戏经过完整重做，加入了不同赛手、八张地图和丰富任务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9a2880acc324be2a1b3dad5a4b566e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=hBNhXpmUI81H0RikvQO8nPSShu0%3D" alt="图片" loading="lazy"/>潜水游戏让玩家探索珊瑚礁并收集鱼类标本。两个游戏整个迭代过程中，Codex自主改进优化，人工干预需求显著减少。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b107e72386554742a69d88f6a3a67dcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=8zjpMjfJRyA1OTuDiZ%2B46log904%3D" alt="图片" loading="lazy"/></p>
<p>更直观的例子来自OpenAI的内部应用。</p>
<p>研究员想了解Codex每个回合能完成多少工作。他让Codex自动编写正则表达式分类器，分析用户澄清请求的频率、反馈质量和任务进度，然后系统地应用到整个会话日志，输出了完整的数据报告。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00643107bd2d423fb837c9eae20b3069~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=1HxJ1K9JAzqB%2F7IBsBFJCJ%2FRAgU%3D" alt="" loading="lazy"/></p>
<p>这种工作量通常需要人类花费几小时的细致分析和编程。Codex只用三分钟。当AI开始加速自己领域的工作时，效率提升才真正开始。</p>
<p>那大家要如何使用呢，目前GPT-5.3-Codex 已包含在 ChatGPT 的付费套餐中，但 API 还需要等待一段时间。</p>
<p>如果你还不会订阅GPT的话，可以去看我之前的文章。里面有详细的介绍。</p>
<p>相关阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzE5MTgzNDg3OA%3D%3D%26mid%3D2247484177%26idx%3D1%26sn%3D798401a8bce3207e86958dd9a20bf8ce%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzE5MTgzNDg3OA==&amp;mid=2247484177&amp;idx=1&amp;sn=798401a8bce3207e86958dd9a20bf8ce&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">2025全新ChatGPT Plus订阅的六种方法，实测有效！</a></p>
<p>话说，Claude Opus 4.6和GPT-5.3-Codex到底谁更厉害呢？欢迎在评论区聊聊！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[挣脱上下文的枷锁：OpenViking，为 AI Agent 而生的开源上下文数据库]]></title>    <link>https://juejin.cn/post/7603308967126122496</link>    <guid>https://juejin.cn/post/7603308967126122496</guid>    <pubDate>2026-02-06T09:42:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603308967126122496" data-draft-id="7603581886148952118" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="挣脱上下文的枷锁：OpenViking，为 AI Agent 而生的开源上下文数据库"/> <meta itemprop="keywords" content="数据库,开源,人工智能"/> <meta itemprop="datePublished" content="2026-02-06T09:42:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="字节跳动开源"/> <meta itemprop="url" content="https://juejin.cn/user/1227510999971086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            挣脱上下文的枷锁：OpenViking，为 AI Agent 而生的开源上下文数据库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1227510999971086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    字节跳动开源
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:42:30.000Z" title="Fri Feb 06 2026 09:42:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p> “We are swimming in a sea of information, and we need to learn to navigate.” — Norbert Wiener</p>
<p> “我们正畅游在信息的海洋中，我们需要学会航行。” — 诺伯特·维纳</p>
</blockquote>
<p>AI Agent 的浪潮已至，它正从简单的任务执行者，演变为能够感知环境、自主规划、并调用工具完成复杂目标的智能实体。然而，在这片充满无限可能的机遇之海中，开发者们却普遍遭遇了一座难以逾越的冰山——<strong>上下文管理</strong>。</p>
<p>随着模型能力飞速提升，Agent 不再满足于处理单轮对话或短文本，而是开始面对长周期任务、海量多模态数据和复杂的协同需求。记忆、资源、技能……这些原本分散各处的上下文，管理起来愈发混乱。然而，如何高效管理和利用这些上下文，已成为开发者们普遍遭遇的瓶颈：</p>
<ul>
<li><strong>上下文无序且割裂</strong>：记忆在代码中，资源在向量库，技能分散在各个角落，关联和维护成本极高。</li>
<li><strong>长程任务需要更多上下文</strong>：Agent 逐渐从处理单轮对话转向执行长周期任务，会涉及多工具、多 Agent 间的复杂协同。每一轮任务执行都会给上下文窗口和模型理解带来压力，如果简单的截断或压缩，本质上是“丢卒保帅”，会带来不可逆的信息损失和高昂的模型成本。</li>
<li><strong>朴素 RAG 检索效果局限</strong>：朴素 RAG 的数据切片是平铺式存储，缺乏全局视野，面对海量、多模态且有信息组织的数据越来越力不从心，可能会错失关键信息。同时，它过于关注语义相关性，在需要兴趣泛化和探索的开放式场景中表现不佳。</li>
<li><strong>上下文缺乏观测和调试：</strong> 从 DeepSeek 和 Manus 的爆火能发现，在 AI 越来越强大时，用户更渴望白盒化的体验，能看到其思考与决策的轨迹。而传统 RAG 隐式的检索链路如同黑箱，出错时难以归因和调试，改进门槛高。</li>
<li><strong>记忆成为核心资产</strong>：模型本身是通用的，大家越发意识到沉淀的记忆才是 Agent 的核心资产，但这不止包括使用用户的记忆，还包括 Agent 自身的经验和偏好记忆。记忆需要在开发初期就建设起来，这样才能形成使用时间越长，体验越好的<strong>复利效果</strong>。</li>
</ul>
<p>而近年来，业界也关于 Context Engineering 有一些探索实践：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmanus.im%2Fzh-cn%2Fblog%2FContext-Engineering-for-AI-Agents-Lessons-from-Building-Manus%3Fref%3Dblog.langchain.com" target="_blank" title="https://manus.im/zh-cn/blog/Context-Engineering-for-AI-Agents-Lessons-from-Building-Manus?ref=blog.langchain.com" ref="nofollow noopener noreferrer">Manus</a> 提出文件系统是上下文的终极形态；<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FshareAI-lab%2Fanalysis_claude_code" target="_blank" title="https://github.com/shareAI-lab/analysis_claude_code" ref="nofollow noopener noreferrer">Claude Code 的成功</a>验证了文件系统 + Bash 的简洁方案在特定场景下超越复杂向量索引的潜力；而 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fequipping-agents-for-the-real-world-with-agent-skills%3Ff_link_type%3Df_linkinlinenote%26flow_extra%3DeyJpbmxpbmVfZGlzcGxheV9wb3NpdGlvbiI6MCwiZG9jX3Bvc2l0aW9uIjowLCJkb2NfaWQiOiIyZmU3MmRlZTEyNTU3NmM0LWZjZjk2Y2Q0MjM2MzI5ZTUifQ%253D%253D" target="_blank" title="https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills?f_link_type=f_linkinlinenote&amp;flow_extra=eyJpbmxpbmVfZGlzcGxheV9wb3NpdGlvbiI6MCwiZG9jX3Bvc2l0aW9uIjowLCJkb2NfaWQiOiIyZmU3MmRlZTEyNTU3NmM0LWZjZjk2Y2Q0MjM2MzI5ZTUifQ%3D%3D" ref="nofollow noopener noreferrer">Anthropic 的 Skills 系统</a>也巧妙地以文件夹来组织能力模块。这些实践给了我们启发，但也反映了一个问题：文件系统是上下文一种很好的组织方式，但并没有一个类似数据库能有效管理Agent所需所有上下文并解决上述问题。</p>
<p>为此，我们正式开源 <strong>OpenViking</strong>——专为 AI Agent 设计的上下文数据库。</p>
<p><strong>我们旨在为 Agent 定义一套极简的上下文交互范式，让开发者彻底告别上下文管理的烦恼。</strong> OpenViking 摒弃了传统 RAG 的碎片化向量存储模式，创新性地采用“文件系统范式” <strong>，</strong> 将 Agent 所需的记忆、资源和技能进行统一的结构化组织。</p>
<p><em><strong>Memory, Resource, Skill. Everything is a File.</strong></em></p>
<p><strong>记忆、资源、技能，皆为文件。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de9f4ca871ca43b796d60b3753c1955f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975750&amp;x-signature=qyhj6QCPUh%2Bg0RScoMCA7gTwruc%3D" alt="" loading="lazy"/></p>
<p>借助 OpenViking，上下文不再是散落一地的拼图，而是一个层次分明、井然有序的认知系统。它能够实现上下文的<strong>分层供给</strong>，在保障信息完整性的前提下，将 Token 成本降至最低；它提供<strong>协同写入</strong>与<strong>自我迭代</strong>机制，让 Agent 的“知识”与“经验”在与世界的交互中持续成长，开发者可以像管理本地文件一样构建 Agent 的大脑：</p>
<ul>
<li>
<p><strong>文件系统管理范式 → 解决碎片化问题：</strong> 基于文件系统范式，将记忆、资源、技能进行统一上下文管理</p>
</li>
<li>
<p><strong>分层上下文按需加载 → 降低 Token 消耗：</strong> L0/L1/L2 三层结构，按需加载，大幅节省成本</p>
</li>
<li>
<p><strong>目录递归检索 → 提升检索效果：</strong> 支持原生文件系统检索方式，融合目录定位与语义搜索，实现递归式精准上下文获取</p>
</li>
<li>
<p><strong>可视化检索轨迹 → 上下文可观测：</strong> 支持可视化目录检索轨迹，让用户能够清晰观测问题根源并指导检索逻辑优化</p>
</li>
<li>
<p><strong>会话自动管理 → 上下文自迭代：</strong> 自动压缩对话中的内容、资源引用、工具调用等信息，提取长期记忆，让 Agent 越用越聪明</p>
</li>
</ul>
<p>现在，让我们一起深入了解 OpenViking，看看它如何挣脱上下文的枷锁，助您在 AI Agent 的浪潮中扬帆远航。</p>
<h2 data-id="heading-0">OpenViking 核心理念</h2>
<p>OpenViking 的设计哲学围绕四大核心理念构建，旨在将复杂的上下文管理流程化繁为简，让开发者能将宝贵的精力聚焦于业务创新。</p>
<h3 data-id="heading-1">文件系统管理范式</h3>
<p>我们不再将上下文视为扁平的文本切片，而是将其统一抽象并组织于一个<strong>虚拟文件系统</strong>中。无论是记忆、资源还是能力，都会被映射到 <code>viking://</code> 协议下的虚拟目录，拥有唯一的 URI。这种范式赋予了 Agent 前所未有的上下文操控能力，使其能像开发者一样，通过 <code>list</code>、<code>find</code> 等标准指令来精确、确定性地定位、浏览和操作信息，让上下文的管理从模糊的语义匹配演变为直观、可追溯的“文件操作”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46a84972cea94b42bc51aa1b78a698ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975750&amp;x-signature=lcu0JVa7uCBfS4DaPIyeyrYDEOc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">分层上下文按需加载</h3>
<p>将海量上下文一次性塞入提示词，不仅成本高昂，更容易超出模型窗口并引入噪声。OpenViking 借鉴业界前沿实践，在上下文写入时便自动将其处理为三个层级：</p>
<ul>
<li><strong>L0 (摘要)</strong> ：一句话概括，用于快速判断。</li>
<li><strong>L1 (概述)</strong> ：包含核心信息和使用场景，供 Agent 在规划阶段进行决策。</li>
<li><strong>L2 (详情)</strong> ：完整的原始数据，供 Agent 在确有必要时深入读取。</li>
</ul>
<p>OpenViking 的设计使其能够灵活适配各类 AI Agent 的开发场景。无论是简单的问答机器人，还是复杂的自动化工作流，它都能作为坚实的上下文底座，提供稳定、高效的支撑。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9a339372b374559b86ff73c1c0ad646~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975750&amp;x-signature=kbjVKQzmWsbxGlYPyqHObSLFQy0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">目录递归检索</h3>
<p>单一的向量检索难以应对复杂的查询意图。OpenViking 设计了一套创新的<strong>目录递归检索</strong>策略，它深度融合了多种检索方式的优点：首先，通过<strong>意图分析生成多个检索条件</strong>；然后，利用向量检索快速定位初始切片所在的<strong>高分目录</strong>；接着，在该目录下进行<strong>二次检索</strong>，并将高分结果更新至候选集合；若目录下仍存在子目录，则<strong>逐层递归</strong>重复上述二次检索步骤；最终，拿到最相关上下文返回。这种 “先锁定高分目录、再精细探索内容” 的策略，不仅能找到语义最匹配的片段，更能理解信息所在的完整语境，从而提升检索的全局性与准确性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95d56e8c09624b8c81c2db549f0cef37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975750&amp;x-signature=OGHEgTVRbuarmGtIrELMgTBlQUo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">可观测与自迭代</h3>
<p>OpenViking 的组织方式采用层次化虚拟文件系统结构，所有上下文均以统一格式整合且每个条目对应唯一 URI（如 viking:// 路径），打破传统扁平黑箱式管理模式，层次分明易于理解；同时检索过程采用目录递归策略，每次检索的目录浏览、文件定位轨迹均被完整留存，能够清晰观测问题根源并指导检索逻辑优化。</p>
<p>此外，OpenViking 内置了记忆自迭代闭环。在每次会话结束时，通过 <code>session.commit()</code> 主动触发，系统会异步分析任务执行结果与用户反馈，并自动更新至 User 和 Agent 的 /memory 目录下。既能更新用户偏好相关记忆，使 Agent 回应更贴合用户需求，又能从任务执行经验中提取操作技巧、工具使用经验等核心内容，助力后续任务高效决策实现自我进化，让 Agent 在与世界的交互中“越用越聪明”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f212e81f0d094753a073abecc5f04fd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975750&amp;x-signature=S9ZE%2FsXk%2F5h46%2B6R80pUnAwUwF8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">快速上手：三分钟运行 OpenViking</h2>
<p>OpenViking 的一大核心优势是其极简的集成方式。我们深知开发者的宝贵时间不应浪费在繁琐的配置上。您无需部署复杂的服务或学习新的 DSL，只需通过几行 Python 代码，即可为您的 Agent 装上强大的“上下文大脑”。</p>
<p>以下示例是以OpenViking的Readme英文版作为文件进行写入，展示处理后的上下文目录结构，以及对应文档的分层信息，并进行简单问题的回复。</p>
<h4 data-id="heading-6"><strong>第一步：安装 OpenViking</strong></h4>
<p>暂时无法在飞书文档外展示此内容</p>
<h4 data-id="heading-7"><strong>第二步：获取模型服务</strong></h4>
<p>OpenViking 需要VLM模型（用于多模态内容理解）和Embedding 模型（用于向量化）能力的API Key：</p>
<p>我们支持多种模型服务：</p>
<ul>
<li>OpenAI 模型：支持 GPT-4V 等 VLM 模型和 OpenAI Embedding 模型</li>
<li>火山引擎（豆包模型）：推荐使用，成本低、性能好，新用户有免费额度。如需购买和开通，请参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.byted.org%2Fdata-arch%2FOpenViking%2Fblob%2Fadd_readme%2Fdocs%2Fzh%2Fguides%2Fvolcengine-purchase-guide.md" target="_blank" title="https://code.byted.org/data-arch/OpenViking/blob/add_readme/docs/zh/guides/volcengine-purchase-guide.md" ref="nofollow noopener noreferrer">火山引擎购买指南</a></li>
<li>其他自定义模型服务：支持兼容 OpenAI API 格式的模型服务</li>
</ul>
<h4 data-id="heading-8"><strong>第三步：配置环境</strong></h4>
<p>创建配置文件 <code>ov.conf</code>：</p>
<blockquote>
<p>⚠️ 重要提示：请将下方配置中的 <code>&lt;your-volcengine-api-key&gt;</code> 替换为你在第二步获取的真实 API Key！</p>
</blockquote>
<p>暂时无法在飞书文档外展示此内容</p>
<p>并设置环境变量：</p>
<p>暂时无法在飞书文档外展示此内容</p>
<h4 data-id="heading-9"><strong>第四步：运行体验</strong></h4>
<p>创建简单的 Python 脚本 <code>example.py</code>并运行，通过写入 OpenViking README 文档来体验写入-检索-读取的全过程：</p>
<p>暂时无法在飞书文档外展示此内容</p>
<p>运行脚本：</p>
<p>暂时无法在飞书文档外展示此内容</p>
<p><strong>若您得到检索结果，恭喜！你已成功运行 OpenViking 🎉</strong></p>
<h2 data-id="heading-10">开源共建，定义下一代 Agent 上下文标准</h2>
<p>我们坚信，开放与协作是推动技术创新的核心动力。将 OpenViking 开源，是我们回馈社区、并与全球开发者共同探索 AI Agent 未来的第一步。</p>
<p>这不仅仅是一次代码的分享，更是一次理念的传播。我们希望通过 OpenViking，能够为业界提供一个关于 Agent 上下文管理的全新范式，一个能够有效降低开发门槛、激发业务创新的坚实底座。</p>
<p>我们深知，OpenViking 目前还处于早期阶段，有许多需要完善和探索的地方。但这正是开源的魅力所在——它允许我们汇聚最广泛的智慧，应对最前沿的挑战。</p>
<p>在此，我们诚挚地邀请每一位对 AI Agent 技术充满热情的开发者：</p>
<ul>
<li><strong>访问我们的GitHub 仓库</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvolcengine%2FOpenViking" target="_blank" title="https://github.com/volcengine/OpenViking" ref="nofollow noopener noreferrer">github.com/volcengine/…</a> ，为我们点亮一颗宝贵的 Star，给予我们前行的动力。</li>
<li><strong>访问我们的网站</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fopenviking.ai" target="_blank" title="https://openviking.ai" ref="nofollow noopener noreferrer">openviking.ai</a> ，了解我们传递的理念，并通过文档使用它，在您的项目中感受它带来的改变，并向我们反馈最真实的体验。</li>
<li><strong>扫描下方二维码加入我们的社区</strong>，分享您的洞见，帮助解答他人的疑问，共同营造一个开放、互助的技术氛围。</li>
</ul>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/775f10b745c34bd68a963c5500d35b05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975750&amp;x-signature=zGFX210fblKjiIlnybc6Vi9sh5w%3D" alt="" width="50%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6beeccf881f45aab88e5eb1dc26e408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975750&amp;x-signature=o3osuu%2BDGLiPIPPFIOny7Epav3w%3D" alt="" width="50%" loading="lazy"/>
<ul>
<li><strong>成为我们的</strong> <strong>贡献者</strong>，无论是提交一个 Bug 修复，还是贡献一个新功能，您的每一行代码都将是 OpenViking 成长的重要基石。</li>
</ul>
<p>让我们一起，共同定义和构建 AI Agent 上下文管理的未来。旅程已经开始，期待您的加入！</p>
<h2 data-id="heading-11">关于我们：字节跳动 Viking 团队</h2>
<p>我们用 C 端产品的体验标准打造能够重塑企业生产力的产品和技术。在上下文工程领域具有深厚的技术积累与商业化实践，我们的愿景是提供用户友好的上下文工程产品矩阵。</p>
<p><strong>我们的产品历程</strong></p>
<ul>
<li><strong>2019 年</strong>：VikingDB 向量数据库支撑字节内部全业务大规模使用</li>
<li><strong>2023 年</strong>：VikingDB 在火山引擎公有云售卖</li>
<li><strong>2024 年</strong>：推出面向开发者的产品矩阵：VikingDB 向量数据库、Viking 知识库、Viking 记忆库</li>
<li><strong>2025 年</strong>：打造 AI 搜索、vaka 知识助手等上层应用产品</li>
<li><strong>2025 年 10 月</strong>：开源 MineContext <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvolcengine%2FMineContext" target="_blank" title="https://github.com/volcengine/MineContext" ref="nofollow noopener noreferrer">github.com/volcengine/…</a> ，主动式 AI 应用探索</li>
<li><strong>2026 年 1 月</strong>：开源 <strong>OpenViking</strong>，为 AI Agent 提供底层上下文数据库支撑</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[85.9k Star 认证！Mermaid：每个开发者都需要的“图表即代码”神器]]></title>    <link>https://juejin.cn/post/7603444191448236066</link>    <guid>https://juejin.cn/post/7603444191448236066</guid>    <pubDate>2026-02-06T09:42:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603444191448236066" data-draft-id="7603383311530950671" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="85.9k Star 认证！Mermaid：每个开发者都需要的“图表即代码”神器"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-02-06T09:42:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            85.9k Star 认证！Mermaid：每个开发者都需要的“图表即代码”神器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:42:53.000Z" title="Fri Feb 06 2026 09:42:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在软件开发、系统设计与项目管理领域，图表是沟通复杂思想的重要桥梁。作为程序员，无论是在撰写技术文档、编写博客，还是进行方案设计，一款得力的图表工具都能显著提升效率。Mermaid 正是这样一款优秀的软件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec6b418ee9f044e8a697369173adfc9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=rc4tuU3gaPULZBye56ke0hqxxWw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">🎯 Mermaid 是什么？</h2>
<p>Mermaid 是一个基于 JavaScript 的图表绘制工具库，它的核心哲学是 “图表即代码” 。它通过解析类似 Markdown 的简洁文本语法，让你可以用写代码的方式，动态地生成和修改各种专业图表。</p>
<p>想象一下，你的流程图、时序图、类图不再是一个个难以更新的静态图片文件，而是和你的项目文档（如 README、Wiki）或源码注释生活在一起的、可版本控制的文本片段。当需求变更时，你只需修改几行描述文本，图表就会自动更新！</p>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmermaid-js%2Fmermaid" target="_blank" title="https://github.com/mermaid-js/mermaid" ref="nofollow noopener noreferrer">github.com/mermaid-js/…</a></p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmermaid.js.org%2F" target="_blank" title="https://mermaid.js.org/" ref="nofollow noopener noreferrer">mermaid.js.org/</a></p>
<p>文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmermaid.js.org%2Fintro%2F" target="_blank" title="https://mermaid.js.org/intro/" ref="nofollow noopener noreferrer">mermaid.js.org/intro/</a></p>
<p>在线编辑地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmermaid.ai%2Flive%2Fedit" target="_blank" title="https://mermaid.ai/live/edit" ref="nofollow noopener noreferrer">mermaid.ai/live/edit</a></p>
<p>编辑器github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmermaid-js%2Fmermaid-live-editor" target="_blank" title="https://github.com/mermaid-js/mermaid-live-editor" ref="nofollow noopener noreferrer">github.com/mermaid-js/…</a></p>
<p>该项目目前在github上已有<strong>85.9k</strong>⭐star</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b73e39efbe6e4deba749edf596468fcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=dxb2jtTliJb8%2F4%2FzlE6QhkAAgiU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">🌟 Mermaid 的核心优势</h2>
<h3 data-id="heading-2">✨ 告别“文档滞后”</h3>
<p>Mermaid 诞生的初衷就是为了解决 Doc-Rot 难题。它让图表维护变得和写代码一样简单，确保你的设计与文档永远能跟上开发节奏。</p>
<h3 data-id="heading-3">🚀 无缝集成</h3>
<p>Mermaid 可以轻松集成到你的工作流中：</p>
<ul>
<li>• 文档工具：已集成到 GitHub/GitLab Markdown、Typora 等众多工具中。</li>
<li>• 编译器插件：IntelliJ IDEA、Visual Studio Code等主流编辑器中可以使用插件集成。</li>
<li>• 博客/网站：可通过简单的脚本引入。</li>
<li>• 开发流程：图表可以直接作为生产脚本的一部分，实现自动化。</li>
</ul>
<h3 data-id="heading-4">👨‍💻 对开发者友好</h3>
<p>使用纯文本定义图表，意味着你可以：</p>
<ul>
<li>• 轻松地进行复用和重构。</li>
<li>• 享受代码高亮、补全等编辑器的便利。</li>
<li>• 可以使用ai高效的完成代码编制。</li>
</ul>
<h2 data-id="heading-5">🐳Docker 部署 Mermaid编辑器</h2>
<p>编辑器github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmermaid-js%2Fmermaid-live-editor" target="_blank" title="https://github.com/mermaid-js/mermaid-live-editor" ref="nofollow noopener noreferrer">github.com/mermaid-js/…</a></p>
<p>创建docker-compose.yml文件</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">mermaid-live-editor:</span>
    <span class="hljs-string">image:</span> <span class="hljs-string">ghcr.io/mermaid-js/mermaid-live-editor</span>
    <span class="hljs-string">container_name:</span> <span class="hljs-string">mermaid-live-editor</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-string">-</span> <span class="hljs-string">"6080:8080"</span>
    <span class="hljs-string">restart:</span> <span class="hljs-string">unless-stopped</span>
</code></pre>
<p>启动服务</p>
<pre><code class="hljs">docker-compose up -d 
</code></pre>
<p>使用Docker部署比较简单，到此，我们就已经完成私有化部署了。</p>
<h2 data-id="heading-6">🛠️使用</h2>
<h3 data-id="heading-7">🌐在线编辑器中使用</h3>
<p>我们打开官方提供的在线编辑器或者我们自己部私有化署的编辑器</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16de6b6dc14a46fe94c417372ea99649~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=mOV3gCukhyIFw%2FC3KXRQmIyWqTM%3D" alt="" loading="lazy"/></p>
<p>选择自己需要的图表类型开始编写，官方文档语法、示例提供的比较齐全，有不太清楚的可以查阅文档。以下是部分示例截图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/840938a121ab4cdfb4b817fd5e54f312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=wtX5D7fv6tsi22zyZmyM6%2BGR%2BXk%3D" alt="" loading="lazy"/></p>
<p><img src="" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c8e9adbc7ed4bfe8ce4a2a8b7fd12c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=jBlw8O2vkbAHZj63nSfZ7mgTBKA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b73ccec0706143538e97ad511d895776~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=ayzRHbqZ2IxFd8wqKrddp4nHOpA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84cecd88f6104e3ab3e37255ab87059a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=R39NQvUZ5QMfg7%2BD5IrJuJF9f8A%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">📄MarkDown中使用</h3>
<p>在markdown中使用的适合将代码类型设置为<code>mermaid</code>即可</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d25618ff9f045afa2b3cf5846a6da97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=E9H%2FylQmx8EmoKLBR7HIpbHsOAk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">🧩编译器插件</h3>
<p>IntelliJ IDEA、Visual Studio Code等主流编辑器：众多扩展提供实时预览和智能提示。</p>
<h2 data-id="heading-10">📝结语</h2>
<p>在 GitHub 的星海之中，能够收获超过 <strong>85.9k</strong>⭐ star 的项目凤毛麟角。这一数字承载着全球开发者最真实的认可与最迫切的需求。<br/>
如果你已厌倦在 Visio、Draw.io 和各种文档之间反复切换，如果你期待让技术图表像代码一样易于创建、维护与协作——那么，是时候拥抱 Mermaid 了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[双 11 大促峰值不翻车：淘天集团 Paimon + StarRocks 大规模 OLAP 查询实战与优化]]></title>    <link>https://juejin.cn/post/7603444191448252450</link>    <guid>https://juejin.cn/post/7603444191448252450</guid>    <pubDate>2026-02-06T09:46:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603444191448252450" data-draft-id="7603383311530819599" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="双 11 大促峰值不翻车：淘天集团 Paimon + StarRocks 大规模 OLAP 查询实战与优化"/> <meta itemprop="keywords" content="大数据,人工智能"/> <meta itemprop="datePublished" content="2026-02-06T09:46:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            双 11 大促峰值不翻车：淘天集团 Paimon + StarRocks 大规模 OLAP 查询实战与优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:46:14.000Z" title="Fri Feb 06 2026 09:46:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：朱奥（盖可）/ 淘天集团高级数据工程师</p>
<h2 data-id="heading-0">导读：</h2>
<p>双 11 等大促场景会在短时间内集中爆发：运营与业务 BI 在开卖后的窗口期密集访问数据产品，瞬时请求量陡增，对查询引擎的稳定性、成本与治理体系提出极高要求。与此同时，业务对近实时数据产品的诉求持续增强，传统“多存储、多链路、依赖回刷”的模式在研发效率、回刷成本与响应速度上逐步暴露瓶颈。</p>
<p>本文围绕 Paimon 与 StarRocks 的组合实践，梳理淘天在大规模 OLAP 查询场景下的架构演进与双 11 保障体系：通过实时与离线统一入湖，消除数据同步链路与多份存储成本；基于稳定中间层叠加在线现算与维表实时关联，将高消耗回刷转化为秒级查询，核心场景回刷效率提升约 80%，年化节省成本接近 1000 万；同时结合 StarRocks + RoaringBitmap 低成本解决跨天交叉实时 UV 计算难题，满足大促近实时决策需求。</p>
<h2 data-id="heading-1">1、淘天集团营销活动 OLAP 查询的探索背景与核心策略</h2>
<h3 data-id="heading-2">1.1 业务诉求与核心痛点当前数据架构</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7b10417ca904466b316db16f9de2f8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=xQx8y%2FDle%2B077Q3mtUXHRNE9euw%3D" alt="5a7bb2fdd2234116b9ffa58f4a5aa606.png" loading="lazy"/></p>
<p>首先，简要介绍当前的数据架构与数据流转方式。</p>
<p>从 DWD 层开始，我们的数据分为实时与离线两条主链路：</p>
<ul>
<li>
<p>实时数据主要存储在 TT中，在业界可类比为 Kafka 一类的消息队列；</p>
</li>
<li>
<p>离线数据主要存储在 ODPS 中。</p>
</li>
</ul>
<p>在数据加工与写入层面，我们会启动 Flink 流批一体任务：</p>
<ul>
<li>
<p>实时侧持续消费 TT 中的数据；</p>
</li>
<li>
<p>离线侧消费 ODPS 中的数据；</p>
</li>
<li>
<p>在计算过程中，任务会关联多类 ODPS 维表，例如类目维表、商家分层等维度信息。</p>
</li>
<li>
<p>计算完成后，结果统一写入 ADS 层的 Holo 表中，并在数据服务层对外透出。</p>
</li>
</ul>
<p>在纯离线场景下，我们会通过 ODPS 任务读取 ODPS 数据，同时写入 ADS 层对应的 ODPS 表。这里既包含历史天级数据，也包含历史小时级数据。当存在查询加速需求时，我们还会将 ODPS 数据进一步导入到 Holo 中。</p>
<p>在数据服务层，我们主要通过 Holo 或 MC 对外提供数据服务。我们会根据查询时延要求选择不同的服务路径：当业务对响应速度要求更高、需要达到毫秒级时，通常通过 Holo 提供查询服务；当时延要求相对宽松，例如百毫秒级或秒级，则更多通过 MC 来承载查询请求。</p>
<h3 data-id="heading-3">1.2 业务诉求与核心痛点</h3>
<p>随着业务发展，我们当前面临的诉求主要来自两个方向：一是业务侧希望获得更多实时数据产品；二是业务 BI 的实时分析需求持续增长。这对数据研发提出了新的挑战：进一步提升研发效率。</p>
<p>回到现有架构，其核心痛点主要体现在两方面：</p>
<ul>
<li>
<p><strong>流批存储不统一</strong>：实时数据存储在 TT 中，离线数据存储在 ODPS 中；当存在查询加速需求时，部分数据还需要进一步落到 Holo 表中。</p>
</li>
<li>
<p><strong>整体开发架构较为复杂</strong>：数据需要在多个存储介质之间流转，导致端到端链路拉长。</p>
</li>
</ul>
<p>在查询特性上，Holo 在点查场景具备更突出的性能优势，且整体稳定性较强，在淘天历年大促期间的表现也相对稳定。</p>
<p>但在更常见的 Shuffle 场景下，整体查询性能相对一般。尤其当 OLAP 查询负载更重、需要进行更复杂的计算，或需要关联规模较大的维表时，Shuffle 相关的执行效率会成为瓶颈，导致查询耗时明显拉长。</p>
<p>数据更新与维护上也存在较高成本。以 ODPS 中的维表为例（如类目维表、商家分层维表等），当维表发生业务变更时，往往需要触发 ADS 层任务的回刷，从而带来额外的回刷开销。</p>
<p>业务对“近实时”的诉求在部分场景下出现了被动降级。例如在跨天实时 UV 等场景中，由于 state 规模较大、成本较高等原因，方案不得不从实时级别降级到小时级别。从业务视角看，近实时能力仍然是明确存在的需求。</p>
<h3 data-id="heading-4">1.3 核心策略</h3>
<p><strong>1）架构简化提效</strong></p>
<ul>
<li>
<p>架构上实现<strong>存储介质的统一</strong>：将实时与离线数据统一沉淀到 Paimon 的湖存储中。在此基础上，<strong>StarRocks 可以直接面向湖存储进行高性能分析查询</strong>，从而能够消除数据同步链路以及多份存储带来的成本。</p>
</li>
<li>
<p><strong>降低使用门槛</strong>，让数据更容易被上层分析与 BI 使用。以实时链路为例，原本实时数据存储在 TT 中，而 TT 的数据形态具有明显特征：每行数据是一个字符串、缺少 schema。在这种形态下，数据虽然可以被消费，但如果要面向 BI 分析使用，往往还需要额外进行反序列化与解析，这会带来不可忽视的工程与使用成本。</p>
</li>
</ul>
<p>在统一存储之后，Paimon 将实时与离线数据沉淀在同一张表中，并提供明确的 schema。这意味着，上层使用方可以直接面向结构化数据开展分析：即使分析师的数据开发能力不强，也可以基于 Paimon 的近实时中间层，通过 <strong>StarRocks</strong> 自助完成对近实时数据的分析。</p>
<p>在这种模式下，过去一些相对简单的取数与分析需求，可以由 BI 或分析师通过自助方式直接完成，不再必须提交给数据研发排期处理，从而在一定程度上减少数据开发侧的需求量与交付压力。</p>
<p><strong>2）业务难点攻坚</strong></p>
<p>通过稳定的中间层 Paimon，以及“OLAP 实时关联易变维度”的模式，将原本高消耗的 ADS 回刷任务转化为秒级查询来完成。在后续内容中，我会进一步展开这一改造如何将高消耗回刷去掉，并带来显著的成本收益——每年可节省近千万元级别的回刷成本。</p>
<p>同时，我们通过 StarRocks + RoaringBitmap 的方案，高性能解决了跨天交叉实时 UV 的计算难题，以更低成本的方式满足大促期间对近实时能力的诉求。</p>
<h3 data-id="heading-5">1.4 新数据架构</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b8a10449fa64391bc1cb1367e6c9af7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=RoxruLrk3rVI8vXD3ZSNb7lpSus%3D" alt="be42fb67ef9846c08fa064277e5a73fc.png" loading="lazy"/></p>
<p>在秒级数据链路上，我们通过实时 Flink 任务消费 DWD 层的 Fluss（秒级实时数据），并将结果写入 ADS 层的 Fluss。</p>
<p>Fluss 提供“湖流一体”的同步开关。开启后，Fluss 中的数据会按配置周期自动同步到 Paimon 表中，默认周期可以是每 3 分钟，且该时间间隔支持用户自定义配置。同步完成后，Paimon 表中会形成当天分钟级数据（t 当天）以及 t−n 的历史数据。</p>
<p>在此基础上，我们会启动 Flink 流批一体任务，同时消费 DWD 层 Paimon 的 t 当天数据与 t−n 历史数据，并将加工结果写入 Paimon 表的 ADS 层与 DWD 层，分别沉淀 t 当天与历史数据。</p>
<p>此外，基于 Paimon 的 partial-update 能力，我们也可以构建离线大宽表，用于承载同一业务对象的多状态聚合。以订单为例，订单存在支付、确收、退款等多种状态，可以构建一张以 order_id 为主键的 Paimon 大宽表，将这些状态写入同一行记录。这样在使用侧只需读取对应 order_id 的一条记录，即可获取该订单的多种状态信息，使用成本与分析便利性都会更高。</p>
<p>在 ADS 层，我们沉淀的计算结果主要面向“叶子粒度”的维度：例如类目侧以叶子类目为主；若涉及商家分层维表，则对应叶子商家分层。在数据服务层，我们通过 StarRocks 对外提供数据服务。具体而言，在 StarRocks 层既可以直接读取 ADS 层数据进行点查，也可以直接读取 DWD 层的中间层数据进行在线计算。后一种方式的查询负载通常更重、数据量更大，但在当前实践中，StarRocks 仍然能够将查询时延控制在秒级范围内，在查询量较大的情况下保持较快响应。在查询过程中，我们也可以进一步关联 Paimon 维表，最终将查询结果在数据产品端进行展示与交付。</p>
<p>在我们的业务场景中，一般来说，DWD 层的中间层事实数据相对稳定；真正“易变”的往往是维度侧的数据，例如 Paimon 维表（类目维表、商家分层维表等）。当业务规则或口径发生调整时，通常只需要更新维表即可。相较于回刷大规模中间层数据，维表更新的成本更低、执行也更快。</p>
<p>更关键的是，我们在查询侧采用现算方式：维表更新后，查询会在读取中间层数据的基础上实时关联最新维表，因此中间层数据无需随业务变更反复回刷。由于中间层计算量较重，如果依赖回刷来响应业务调整，整体周期往往较长——快则一到两天，慢则可能需要一周。通过“更新维表 + 查询现算”的方式，业务变更后可以更快在数据产品侧看到最新结果。</p>
<p>在数据服务层，我们进一步利用 StarRocks 的 Warehouse 机制，对读集群进行隔离与分级保障，避免不同业务互相影响。我们按照业务重要性划分为三类：</p>
<ul>
<li>
<p>默认 Warehouse：保障级别相对一般；</p>
</li>
<li>
<p>重保 Warehouse：承载最核心业务，保障级别最高；</p>
</li>
<li>
<p>业务 BI 专用 Warehouse：面向业务 BI 或其他业务的专用资源池，保障级别相对一般。</p>
</li>
</ul>
<h2 data-id="heading-6">2、Paimon+StarRocks 在双11大规模 OLAP 查询场景下的实践与优化</h2>
<h3 data-id="heading-7">2.1 业务背景</h3>
<p>在日常情况下，运营和业务 BI 往往在不同时间访问数据产品，因此 StarRocks的瞬时请求量（RPS）整体较低，压力相对平稳。</p>
<p>但在大促期间情况会明显不同。以开卖时段为例，运营和业务 BI 通常会在接下来的一小时内集中访问数据产品，导致 StarRocks 的瞬时请求 RPS 急剧升高，对 StarRocks 集群带来显著挑战。</p>
<p>因此，本部分的实践与优化工作主要围绕“大促场景稳定运行”这一目标展开。</p>
<h3 data-id="heading-8">2.2 集群侧保障</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/004d2ccbabb04b20ab32a7ac98a235f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=GKsQsn53kAfXMbcHMxaWnHmVya4%3D" alt="5b0f2bb0168249bc98beaa726abd5806.png" loading="lazy"/></p>
<p><strong>1）在应用层面推广数据集缓存策略：</strong></p>
<p>目前配置 180 秒的查询缓存窗口。也就是说，同一条查询在 180 秒内被多次触发时，实际下发到 StarRocks 执行的仅为首次请求；后续请求直接复用首次查询结果。通过该策略，可以有效降低大促高峰期 StarRocks 集群的瞬时压力。</p>
<p><strong>2）集群层面的保护机制：</strong></p>
<p>集群侧设置了 30 秒的全局超时：如果一条 SQL 在 30 秒内仍未执行完成，会被自动终止。该机制属于 StarRocks 的集群保护能力，当查询执行时间超过 30 秒，即可判定该 SQL 需要进一步优化，不适合直接上线，需要回退并完成优化后再进入生产环境。对于少量确有必要、且在 30 秒内无法完成的特殊 SQL，也支持为单条 SQL 配置更长的超时时间。但此类 SQL 数量通常极少，上线评估也会更加严格，以确保不会对整体集群稳定性产生影响。整体目标是避免单条慢 SQL 拖垮集群。</p>
<p><strong>3）架构层隔离：按业务重要性划分只读实例。</strong></p>
<p>基于业务重要性对只读查询资源进行分层，将不同业务的读请求隔离到不同的只读实例上，避免相互干扰。</p>
<p><strong>4）集群初始化配置</strong></p>
<p>在新的 StarRocks 集群初始化时，比较推荐先设置一套基础参数，如下：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">set global cbo_cte_reuse_rate=0; 
</code></pre>
<p>当 CTE 被多处引用时，可能触发同一数据源的重复读取。例如，一个表在 select 中读取三次，那么 StarRocks会对同一张 Paimont 表执行三次读取，读 I/O 开销相当于被放大为 3 倍。将该参数设置为 0 后，可使同一张表在同一条查询中只读取一次。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">set global query_timeout=30; 
</code></pre>
<p>设置 30 秒的集群全局查询超时**，**避免单条慢 SQL 拖垮集群。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">set global new_planner_optimize_timeout=10000;
</code></pre>
<p>适当调大执行图优化器的超时时间。如果该参数设置过小，SQL 在调度过程中更容易直接失败；适当增大后，可降低 SQL 失败的频率。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">set global pipeline_dop=8; 
</code></pre>
<p>调整 pipeline 的 DOP，用于控制每台机器上拉起的 driver 数量。压测结果显示，在大促场景中 SQL 请求高度集中，若 DOP 设置过大（例如 64），单条 SQL 在每台机器上会拉起大量 driver，带来调度开销飙升，甚至可能打满 driver 阻塞队列，导致 CPU 利用率反而上不去，集群进入不可用状态。</p>
<p>在我们 StarRocks 集群的双 11 压测中，DOP 调整到 8 时整体查询表现最优，因此给出 DOP=8 作为建议值。需要强调的是，该值是经验建议，最终仍应以各自集群的压测结果为准进行配置。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">set global scan_paimon_partition_num_limit=100;  
</code></pre>
<p>限制 scan paimon外表的最大分区，用于杜绝因条件缺失或下推失败导致的全表/超大范围扫描。</p>
<h3 data-id="heading-9">2.3 核心指标监控</h3>
<p>通过观察 StarRocks 核心指标的水位变化，可以持续评估实例健康状况。常用的核心指标如图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d519ee20fb74e1eb36d20430d3ebeab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=1vHNeAgPxSRNnFEwcEOpGnPaKd8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">2.4 报警规则</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68d49b80230340b0902ab71e68a38baf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=0pa6uy2qdu7aD0AiR%2B%2B9skh5j9M%3D" alt="cdb33b569699410c9cb33cc79cee25fb.png" loading="lazy"/></p>
<p>建立 StarRocks 实例的异常报警机制非常关键，它能够帮助及时发现实例异常并快速介入处理。报警项的设置通常围绕“资源水位、节点可用性、调度拥塞、查询失败与时延”几类核心信号展开，其中有一部分阈值来自大促压测与实战探索，具有较强参考价值：</p>
<ul>
<li>
<p>BE/CN 的 CPU 与内存使用率设置阈值，例如当使用率持续高于 70% 时触发告警；</p>
</li>
<li>
<p>FE 的 CPU 与内存使用率同样设置 70% 的告警阈值；</p>
</li>
<li>
<p>在可用性方面，可以监控 BE/CN 或 FE 的可用率是否低于 100%，一旦出现低于 100% 的情况，通常意味着有节点不可用或发生故障。</p>
</li>
<li>
<p>当 BE 阻塞队列数超过 2000 时，StarRocks 集群的查询时延可能出现陡增；</p>
</li>
<li>
<p>在查询侧，可以增加查询失败次数与查询时延分位数的告警，例如“查询失败次数大于 n”“查询延迟 TP99 大于 n”。其中 n 的取值需要结合业务特性与可接受的服务水平目标进行配置。</p>
</li>
</ul>
<h3 data-id="heading-11">2.5 元数据监控</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a52d0f431e94c13bf5ee643f782df43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=HhgtqySGrmmia0808EDujkzVmjw%3D" alt="73cea218e8ee4922b80e8b5ecba11fbf.png" loading="lazy"/></p>
<p>为更有效地治理 StarRocks的各类查询请求，可以实时获取审计日志，并基于审计日志构建元数据监控大盘，为后续的慢查询 SQL 治理提供数据支撑与定位依据。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">select * from _starrocks_audit_db_.starrocks_audit_tbl;
</code></pre>
<p>审计日志相关数据落在 <strong>StarRocks</strong> 的内表中，对应信息可实时查询。也就是说，某条 SQL 执行完成后，可以立即在该内表中查到这条 SQL 的执行耗时等关键字段。基于这一基础能力，如果需要进一步做更细的源数据与查询行为监控，也可以围绕审计日志中记录的 SQL 信息进行扩展。</p>
<p>在监控大盘的组织方式上，支持按 Warehouse 维度拆分（例如划分为多个 Warehouse），同时也可以按数据集进行过滤。在筛选完成后，重点关注的数据字段通常包括：数据集名称、总 CPU 消耗、总查询大小、查询次数、查询行数、失败率与失败次数、单次查询的 CU 消耗、查询时间以及查询发起人等。这些指标支持排序与聚合，便于在优化过程中选取特定时间窗口，对总 CPU 消耗、总查询大小、总查询行数等维度进行 Top SQL 排查与治理。通过优先治理这些“高消耗/高影响”的 SQL，往往能够显著改善集群整体健康状况，因为在许多情况下，集群不稳定的根因来自少量高风险的“坏 SQL”。</p>
<h3 data-id="heading-12">2.6 大促保障</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fdd5e52849a4179a02c546ef0c14d1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=5T8j5FXFgKWdluzEYhhk%2BGsBtNo%3D" alt="image.png" loading="lazy"/>
大促保障的目标，是把不确定性尽量前置消化，确保开卖高峰期间查询链路稳定可控。</p>
<ul>
<li>
<p><strong>在资源侧</strong>，会结合历史数据与业务预测，在大促开始前对 StarRocks 集群进行主动扩容，并在大促结束后主动缩容。</p>
</li>
<li>
<p><strong>在需求侧</strong>，提前与业务负责人对齐本次大促的核心变更点，重点关注改造或新增页面，并将核心页面的 QPS 进行量化，为全链路压测与容量评估做准备。</p>
</li>
<li>
<p><strong>针对重保页面</strong>，我们还会建立一套智能应急机制，分为实例级与查询级两层。实例级故障切换方面，当 StarRocks 主实例不可用时，可通过自动化预案工具（FBI）将重保页面的查询请求批量切换到备库 Warehouse，完成实例级容灾；查询级自动容错方面，当重保页面出现单次查询失败或超时，系统会将该查询自动路由到备库 Warehouse 重试，尽量做到用户无感，为关键 SQL 增加一次“二次机会”，提升整体稳定性。</p>
</li>
</ul>
<h3 data-id="heading-13">2.7 大促压测</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ce7b5f831cb4a5baed3deabae647b97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=d5XCduc7HHWXrin98SG7MLKUJV0%3D" alt="ec2dd45519bb480d8784695847ee4629.png" loading="lazy"/></p>
<p>大促压测通常分为两层：<strong>核心页面单压与全链路压测。</strong></p>
<p>在核心页面单压阶段，会先梳理大促期间的核心页面及新增页面，并对这些页面进行单独压测。这样做的目的，是尽可能在活动前置暴露并解决单点问题导致的性能瓶颈，为后续上线留出精细化优化空间。</p>
<p>在全链路压测阶段，会模拟“所有页面同时达到流量峰值”的极限场景，用以验证 StarRocks 集群在峰值冲击下的整体资源水位与关键性能指标是否符合预期。重点关注的资源水位通常包括 CPU、内存与 I/O，同时结合查询时延等指标，评估集群在极端并发与高负载下的稳定性与承载边界。</p>
<h3 data-id="heading-14">2.8 压测发现的问题和优化方案</h3>
<p><strong>1）分区裁剪失效或缺少分区过滤，导致扫全表</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12d2dab27cd14feb8ccb2578e02cef2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=dYuRlUJ10iXunvN41SJzPDhlkEE%3D" alt="1e442b8c79984e2a85440c9c085d46c5.png" loading="lazy"/></p>
<p>压测中发现，部分 SQL 因分区裁剪失效或未配置分区过滤条件，出现扫描范围过大甚至扫全表的风险。针对该类问题，治理原则是必须启用分区过滤并确保分区裁剪生效，不允许存在扫全表 SQL 在线运行。</p>
<p>分区裁剪生效的常见写法包括：对分区字段进行日期传参，直接基于分区字段触发裁剪；或使用日期函数触发裁剪，例如 date_format、date_add 等函数也可以触发分区裁剪。</p>
<p>分区裁剪失效的典型场景是分区字段与子查询结果进行比较，例如将分区字段与子查询返回的最小活动时间进行对比时，分区裁剪会失效。原因在于分区裁剪发生在 FE 阶段，而子查询需要到 BE 执行，FE 在规划阶段无法获得子查询结果，从而无法生成有效的分区裁剪信息。</p>
<p><strong>2）读取 Paimon 生表时小文件过多，导致读取数据块数过大</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2de3bbc8d89d4cfd93fdf7b32327179c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=UR9mUct%2F8jSOXhe%2FGih1sSbULcc%3D" alt="f7565bca02374c3a9dd1ae6e94058b02.png" loading="lazy"/></p>
<p>压测还发现，读取 Paimon 表时存在小文件过多的问题。</p>
<p><strong>定位方法</strong>：在 StarRocks 执行 SQL 时可开启 profile（通过 hint：/*+ SET_VAR(enable_profile = true) */）生成 profile 文件；在 profile 中搜索 “metadata”，其中 nativeReaderReadNum 表示读取的数据块数，nativeReaderReadBytes 表示读取的字节数。实践中，当单个分区的 nativeReaderReadNum 大于 200 时，通常建议考虑对表进行排序治理。</p>
<p><strong>优化方案</strong>：在构建流批排序Paimon表时，建议采用分支表模式：离线分支将 bucket 设为 -1，实时分支按需设置 bucket。离线分支表通过 clustering columns 指定排序字段，可支持指定多个字段（如 f1、f2），一般选择 OLAP 查询中最常用的过滤字段，以提升过滤命中与读取效率。该能力仅支持 Flink 批写入，不支持 ODPS 写入；写入表时需要使用 hint：<strong>/*+ OPTIONS('sink.parallelism' = '64') */</strong>。对于 ODPS 写入的 Paimon 表，则需要在任务下挂一个单独的 compact 排序任务。</p>
<p><strong>为何有效</strong>：在双 11 场景下，活动周期往往持续数十天。当天数据属于实时增量，而从活动开始到昨天的历史数据占比更大；因此对离线数据进行表排序收益显著。压测实测显示，排序后读取的数据块数约为排序前的 1/1000。  离线分支完成排序后，活动开始到昨天（占比最大的历史数据）基本都处于“已排序、数据块读取量很小”的状态；实时分支由于无法排序，读取的数据块会相对多一些，但实时数据通常只存在于当天，整体占比小，因此对整条 SQL 的查询时延影响相对有限。</p>
<p><strong>3）检查是否命中 MapJoin：小维表建议显式 broadcast</strong></p>
<p>当 SQL 需要 join 小表（例如小于 10MB 的维表）时，建议在维表前显式加 broadcast，以触发类似离线 MapJoin 的执行策略。实测显示，引入 broadcast 后查询时延可显著下降，典型场景下可从十几秒优化到约 3 秒，整体查询时延约为原先的 1/3。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">SELECT xxx
FROM table_a t0
LEFT JOIN [broadcast] dim_table_b t1 
ON t0.cate_id = t1.slr_main_cate_id
AND t1.ds = 'xxx'
</code></pre>
<p><strong>4）检查跨地域访问：计算与存储尽量同地域部署</strong></p>
<p>还需要确认 StarRocks 实例与所读取的 Paimon 表是否处于同一地域。若不在同一地域，查询时延会明显增加。建议将 StarRocks 的部署地域与 Paimon 表存储地域保持一致。</p>
<p><strong>5）主键表建议开启 deletion vectors：减少无效数据读取</strong></p>
<p>对于 Paimon 主键表，建议开启 'deletion-vectors.enabled' = 'true'参数。该能力会在写入阶段记录哪些主键数据已被删除；读取时可跳过已删除数据，减少无效扫描，从而提升查询性能。非主键表不需要开启该参数。</p>
<h2 data-id="heading-15">3、阶段成果与未来规划</h2>
<h3 data-id="heading-16">3.1 阶段成果</h3>
<p>整体来看，该方案带来了四方面阶段性成果。</p>
<ul>
<li>
<p><strong>数据链路得到简化</strong>：通过统一存储与统一查询面，消除了数据同步链路，并降低了多份存储带来的成本与复杂度。</p>
</li>
<li>
<p>**数据使用门槛显著降低：**基于 Paimon 的实时/离线中间层，不仅数据开发人员可以使用，业务分析师也可以通过 StarRocks 自助消费近实时数据，从而减少部分简单需求对数据研发排期的依赖。</p>
</li>
<li>
<p><strong>回刷开销得到明显削减</strong>：**核心场景的回刷效率提升约 80%，年化节省成本接近 1000 万。**其关键在于查询可以直接读取 Paimon 公共层并关联 Paimon 维表，业务变更时只需刷新维表，无需回刷与该维表相关的整条数据链路。</p>
</li>
<li>
<p><strong>在高性能实时分析方面，低成本解决了跨天交叉维度实时 UV 的计算难题，满足大促期间近实时决策需求。</strong> 具体做法是将可累加指标（如订单数、订单支付金额等）与不可累加指标（如 user_id）分开处理：可累加指标在查询侧直接聚合；不可累加指标则将 user_id 做 RB 化后存入中间层，StarRocks 读取 Paimon 表时通过 RB 相关函数计算 UV。</p>
</li>
</ul>
<h3 data-id="heading-17">3.2 未来规划</h3>
<p>面向下一阶段，规划主要集中在四个方向。</p>
<p>第一，<strong>希望 StarRocks 具备更强的自动物化能力</strong>：针对用户高频查询的 SQL 自动生成物化结果，并在后续查询中自动完成改写，直接命中物化表。由于物化表往往已经完成聚合，其数据量相较直接查询中间层可以小很多个量级，从而显著降低扫描与计算开销，进一步提升查询速度与稳定性。</p>
<p>第二，计划进一步<strong>丰富 StarRocks 的元数据能力</strong>。</p>
<p>第三，<strong>优化 StarRocks 的调度策略</strong>，重点是调度层面的 CPU 负载均衡能力。</p>
<p>第四，希望 <strong>StarRocks 具备直接读取 Fluss 的能力</strong>，从而支持秒级查询场景。目前 Paimon 仍以分钟级链路为主，如果能够在读取侧进一步下探到 Fluss，将更好覆盖对秒级实时性有明确诉求的业务场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rspress 2.0 发布：面向体验与 AI 的全新升级]]></title>    <link>https://juejin.cn/post/7603556326815842356</link>    <guid>https://juejin.cn/post/7603556326815842356</guid>    <pubDate>2026-02-06T10:01:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603556326815842356" data-draft-id="7603444191448317986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rspress 2.0 发布：面向体验与 AI 的全新升级"/> <meta itemprop="keywords" content="前端,JavaScript,开源"/> <meta itemprop="datePublished" content="2026-02-06T10:01:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="字节跳动开源"/> <meta itemprop="url" content="https://juejin.cn/user/1227510999971086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rspress 2.0 发布：面向体验与 AI 的全新升级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1227510999971086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    字节跳动开源
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T10:01:29.000Z" title="Fri Feb 06 2026 10:01:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19675bd1aa934a068cadbd825aeb47b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=dEFyzgW6mq71FbNhjvHiotUZxa4%3D" alt="Rspress 2.0 Banner" loading="lazy"/></p>
<hr/>
<p>我们很高兴地宣布 Rspress 2.0 的正式发布！</p>
<p>Rspress 是基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsbuild.rs%2F" target="_blank" title="https://rsbuild.rs/" ref="nofollow noopener noreferrer">Rsbuild</a> 的静态站点生成器，专为开发者打造的文档站工具。自 2023 年正式发布以来，Rspress 1.x 累计迭代 <strong>144 个版本</strong>，共有 <strong>125 位贡献者</strong> 参与项目开发。越来越多的开发者选择 Rspress，借助其<strong>高效的编译性能、约定式路由和组件库预览</strong>等功能，搭建美观可靠的文档站点。</p>
<p>基于社区的反馈和建议，Rspress 2.0 在 <a href="#brand-new-theme" title="#brand-new-theme"><strong>主题美观度</strong></a>、<a href="#llms-txt-ssg-md" title="#llms-txt-ssg-md"><strong>AI-native</strong></a>、<a href="#doc-dx" title="#doc-dx"><strong>文档开发体验</strong></a>、<a href="#rslib-rspress" title="#rslib-rspress"><strong>与 Rslib 一起使用</strong></a> 等方面更进一步。</p>
<h2 data-id="heading-0">为什么是 Rspress 2.0</h2>
<p>Rspress 1.x 已经解决了文档站框架编译性能的问题，但仍存在一些问题影响着作为一个文档开发工具的核心体验。2.0 版本将不止于对编译性能的追求，也聚焦于文档站体验的其他方面：</p>
<ul>
<li>
<p><strong>主题样式</strong>：一套<strong>更美观的默认主题</strong>，并提供了多种 <a href="/zh/guide/basic/custom-theme.md" target="_blank" title="/zh/guide/basic/custom-theme.md">自定义主题</a> 方式，解决了 1.x 在主题定制上缺乏稳定 API 的问题。</p>
</li>
<li>
<p><strong>AI-native</strong>：文档不仅服务于人类读者，也需要被 Agent 更好地理解和使用。Rspress 现在内置了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fllmstxt.org%2F" target="_blank" title="https://llmstxt.org/" ref="nofollow noopener noreferrer">llms.txt</a> 生成和从 SSG 衍生出的 <a href="/zh/guide/basic/ssg-md.md" target="_blank" title="/zh/guide/basic/ssg-md.md"><strong>SSG-MD</strong></a> 功能，生成高质量的 Markdown 渲染内容供 Agent 读取。</p>
</li>
<li>
<p><strong>按需编译，瞬间启动</strong>：默认启用 <a href="https://link.juejin.cn?target=https%3A%2F%2Frspack.rs%2Fguide%2Ffeatures%2Flazy-compilation" target="_blank" title="https://rspack.rs/guide/features/lazy-compilation" ref="nofollow noopener noreferrer">lazyCompilation</a>，配合链接 hover 时对资源的 preload 功能，仅在访问特定路由时构建所需文件，实现无论项目规模多大，dev 也可<strong>瞬间启动</strong>。</p>
</li>
<li>
<p><strong>Shiki 代码高亮</strong>：默认集成 Shiki，在<strong>构建时完成语法高亮</strong>，支持主题切换、transformer 扩展，比如 <a href="/zh/plugin/official-plugins/twoslash.md" target="_blank" title="/zh/plugin/official-plugins/twoslash.md">@rspress/plugin-twoslash</a>，带来更丰富的代码块展示效果。</p>
</li>
<li>
<p><strong>文档开发体验</strong>：优化 <code>_nav.json</code>、<code>_meta.json</code> 等文件的 HMR 并新增 <a href="/zh/guide/basic/auto-nav-sidebar.md#json-schema-%E7%B1%BB%E5%9E%8B%E6%8F%90%E7%A4%BA" target="_blank" title="/zh/guide/basic/auto-nav-sidebar.md#json-schema-%E7%B1%BB%E5%9E%8B%E6%8F%90%E7%A4%BA">json schema</a> 用于 IDE 内的代码提示；默认开启死链检查功能；新增文件代码块语法，支持引用外部文件；<a href="/zh/plugin/official-plugins/preview.md" target="_blank" title="/zh/plugin/official-plugins/preview.md">@rspress/plugin-preview</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Frspress.rs%2Fplugin%2Fofficial-plugins%2Fplayground" target="_blank" title="https://rspress.rs/plugin/official-plugins/playground" ref="nofollow noopener noreferrer">@rspress/plugin-playground</a> 支持同时使用等。</p>
</li>
<li>
<p><strong>Rslib 集成</strong>：现在可以在使用 <code>create-rslib</code> 创建组件库项目时，选择 Rspress 作为文档工具，快速搭建组件文档站点。</p>
</li>
</ul>
<p>这是一次对现有架构的全面升级，下面将介绍 Rspress 2.0 和它的 <strong>全新主题、高质量 llms.txt 生成、集成 Shiki、按需编译</strong>等重要功能。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f557e1ef9966415b908aced97781eee2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=6uSUM%2FW7SLKjWBaHUsVLvO2m%2FwQ%3D" alt="Rspress 2.0 Features" loading="lazy"/></p>
<h2 data-id="heading-1">2.0 新特性</h2>
<h3 data-id="heading-2">全新主题 {#brand-new-theme}</h3>
<p>2.0 默认主题迎来了一次系统性升级，它由团队设计师 <a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fwei_zhong41532" target="_blank" title="https://x.com/wei_zhong41532" ref="nofollow noopener noreferrer">@Zovn Wei</a> 整体设计，在视觉效果和阅读体验上都有较大幅度提升，并且每个组件均可独立替换，拥有很高的可定制性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c0d695e7f1b47f6b91ce443360f738d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=qsFKdCh6E5%2B1%2FPeTzeaUARsmViE%3D" alt="New Theme" loading="lazy"/></p>
<h4 data-id="heading-3">主题定制</h4>
<p>按照定制化程度从低到高，有 CSS 变量、BEM 类名、ESM 重导出覆盖、组件 eject 四种<a href="/zh/guide/basic/custom-theme.md" target="_blank" title="/zh/guide/basic/custom-theme.md">自定义主题</a>方式。</p>
<ul>
<li><strong>CSS 变量</strong>：新主题暴露了更多 CSS 变量，覆盖主题色、代码块、首页等样式。你可以在 <a href="/zh/ui/vars.md" target="_blank" title="/zh/ui/vars.md">CSS 变量</a> 页面交互式地预览和调整所有 CSS 变量，找到满意的配置后直接复制到项目中使用。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-comment">/* 自定义主题色 */</span>
  <span class="hljs-attr">--rp-c-brand</span>: <span class="hljs-number">#3451b2</span>;
  <span class="hljs-attr">--rp-c-brand-dark</span>: <span class="hljs-number">#2e4599</span>;
  <span class="hljs-comment">/* 自定义代码块样式 */</span>
  <span class="hljs-attr">--rp-code-block-bg</span>: <span class="hljs-number">#1e1e1e</span>;
}
</code></pre>
<ul>
<li><strong>BEM 类名</strong>：内置组件现在均采用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgetbem.com%2F" target="_blank" title="https://getbem.com/" ref="nofollow noopener noreferrer">BEM 命名规范</a>。这是一个十分 Old School 的选择，但也是我们深思熟虑的决定。用户可以通过 CSS 选择器精准调整样式，HTML 结构更加清晰；同时与 Rspress 用户自身使用的 CSS 框架解耦，用户可以任意选择 CSS 框架（<a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2F" target="_blank" title="https://tailwindcss.com/" ref="nofollow noopener noreferrer">Tailwind</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Flesscss.org%2F" target="_blank" title="https://lesscss.org/" ref="nofollow noopener noreferrer">Less</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fsass-lang.com%2F" target="_blank" title="https://sass-lang.com/" ref="nofollow noopener noreferrer">Sass</a> 等），比如使用 Tailwind V4 或 V3 而不用担心版本，也不用担心与 Rspress 内置 CSS 产生冲突。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* BEM 命名规范 */</span>
<span class="hljs-selector-class">.rp-</span><span class="hljs-selector-attr">[component-name]</span>__<span class="hljs-selector-attr">[element-name]</span>--<span class="hljs-selector-attr">[modifier-name]</span> {
}

<span class="hljs-comment">/* 根据 BEM 类名轻松覆盖组件样式 */</span>
<span class="hljs-selector-class">.rp-nav__title</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">32px</span>;
}
<span class="hljs-selector-class">.rp-nav-menu__item--active</span> {
  <span class="hljs-attribute">color</span>: purple;
}
</code></pre>
<ul>
<li><strong>ESM 重导出覆盖</strong>：如果 CSS 上的修改无法满足定制需求，可以通过 JS 进行更深度的定制。在 <code>theme/index.tsx</code> 中利用 <a href="/zh/guide/basic/custom-theme.md#reexport" target="_blank" title="/zh/guide/basic/custom-theme.md#reexport">ESM 重导出</a>，可以<strong>覆盖</strong>任意一个 Rspress 的内置组件。</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Layout</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">BasicLayout</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rspress/core/theme-original'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Layout</span> = (<span class="hljs-params"/>) =&gt; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">BasicLayout</span> <span class="hljs-attr">beforeNavTitle</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>some content<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>} /&gt;</span>;

<span class="hljs-keyword">export</span> { <span class="hljs-title class_">Layout</span> }; <span class="hljs-comment">//[!code highlight]</span>
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'@rspress/core/theme-original'</span>; <span class="hljs-comment">//[!code highlight]</span>
</code></pre>
<ul>
<li><strong>组件 eject</strong>：你可以使用全新的 <a href="/zh/api/commands.md#rspress-eject" target="_blank" title="/zh/api/commands.md#rspress-eject"><code>rspress eject [component]</code></a> 命令，这个命令会将指定组件的源代码复制到 <code>theme/components/</code> 目录下，你可以自由修改这些代码，甚至直接交给 AI 修改，来实现深度定制。</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将 DocFooter 组件导出到 theme 目录</span>
rspress eject DocFooter
</code></pre>
<h4 data-id="heading-4">导航栏、侧边栏 tag</h4>
<p>Rspress 2.0 实现了 <a href="/zh/ui/layout-components/tag.md" target="_blank" title="/zh/ui/layout-components/tag.md">Tag 组件</a>，现在可以使用 frontmatter 中的 tag 属性，在侧边栏或导航栏进行 UI 标注。</p>
<pre><code class="hljs language-mdx" lang="mdx">---
tag: new, experimental # 会在 H1 和 Sidebar 进行显示
---

import { Tag } from '@rspress/core/theme';

# Tag

## Common tags &lt;Tag tag="new" /&gt; {/* 会在右侧 outline 进行显示 */}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28c24c7d07cd47f5b204d71e6126dcfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=9Q06Wn07DMSgnfM9rdf5OYyZI%2B0%3D" alt="Tag 组件在侧边栏中的显示效果" loading="lazy"/></p>
<h4 data-id="heading-5">内置多语言支持</h4>
<p>在 1.x 版本中，Rspress 仅内置了英文文本，如果使用其他语言例如 zh，必须对所有的文本都进行配置，使用起来较为繁琐。现在 2.0 主题内置了 zh、en、ja、ko、ru 等多种语言的翻译文本，系统会根据语言配置自动进行 "Tree Shaking"，仅打包你使用到的文本及语言，未内置的语言会兜底到 en 文本。你也可以通过 <a href="/zh/api/config/config-basic.md#i18nsource" target="_blank" title="/zh/api/config/config-basic.md#i18nsource"><code>i18nSource</code></a> 配置项扩展或覆盖翻译文本。</p>
<p>Rspress 未来会支持更多内置语言，如果你有兴趣，请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fweb-infra-dev%2Frspress%2Fpull%2F2827" target="_blank" title="https://github.com/web-infra-dev/rspress/pull/2827" ref="nofollow noopener noreferrer">这位贡献者的 Pull Request</a>。</p>
<h3 data-id="heading-6">llms.txt：SSG-MD 渲染高质量的 Markdown 内容 {#llms-txt-ssg-md}</h3>
<p>Rspress 现在将 <a href="https://link.juejin.cn?target=https%3A%2F%2Fllmstxt.org%2F" target="_blank" title="https://llmstxt.org/" ref="nofollow noopener noreferrer">llms.txt</a> 生成能力集成到 core 中，并实现了全新的 SSG-MD（Static Site Generation to Markdown，静态站点 Markdown 生成）能力。</p>
<p>在基于 React 动态渲染的前端框架中，往往存在静态信息难以提取的问题，Rspress 也面临同样的挑战。Rspress 允许用户通过 <a href="/zh/guide/use-mdx/components.md" target="_blank" title="/zh/guide/use-mdx/components.md">MDX 片段</a>、React 组件、Hooks 以及 TSX 路由等动态特性来增强文档表现力。但这些动态内容在转换为 Markdown 文本时会面临以下问题：</p>
<ul>
<li>直接将 MDX 输入给 AI 会包含大量代码语法噪音，并丢失 React 组件内容</li>
<li>将 HTML 转为 Markdown 往往效果不佳，信息质量难以保证</li>
</ul>
<p>为了解决这个问题，Rspress 2.0 引入了 <a href="/zh/guide/basic/ssg-md.md" target="_blank" title="/zh/guide/basic/ssg-md.md">SSG-MD</a> 特性。这是一个全新的功能，它类似于 <a href="/zh/guide/basic/ssg.md" target="_blank" title="/zh/guide/basic/ssg.md">静态站点生成（SSG）</a>，但不同之处在于它将你的页面渲染为 Markdown 文件，而非 HTML 文件，并生成 <a href="https://link.juejin.cn?target=https%3A%2F%2Fllmstxt.org%2F" target="_blank" title="https://llmstxt.org/" ref="nofollow noopener noreferrer">llms.txt</a> 及 llms-full.txt 相关文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ee0a03b95f74055b32ccca957d6b0c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=5svyheCzMYW%2FOT8mp0Cac1eBtzk%3D" alt="SSG-MD 功能概览示意图" loading="lazy"/>
相比于将 HTML 转化为 Markdown 等传统方式，SSG-MD 在渲染期间拥有更优质的信息源，比如 React 虚拟 DOM，从而保证更高的静态信息质量和灵活性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c16273823b414fdc8efeebd1beea838d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=uPifZh6gaaTBmX4a5eOvlF2MgCw%3D" alt="SSG-MD 渲染流程示意图" loading="lazy"/>
启用方式非常简单：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rspress/core'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">llms</span>: <span class="hljs-literal">true</span>,
});
</code></pre>
<p>构建后将生成如下结构：</p>
<pre><code class="hljs language-tree" lang="tree">doc_build
├── llms.txt
├── llms-full.txt
├── guide
│   └── start
│       └── introduction.md
└── ...
</code></pre>
<p>若想定制自定义组件的渲染内容，可通过环境变量控制：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Tab</span>(<span class="hljs-params">{ label }: { label: <span class="hljs-built_in">string</span> }</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">SSG_MD</span>) {
    <span class="hljs-comment">// SSG-MD 模式下输出纯文本描述</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;&gt;</span>{`**Tab: ${label}**`}<span class="hljs-tag">&lt;/&gt;</span></span>;
  }
  <span class="hljs-comment">// 正常渲染交互式组件</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"tab"</span>&gt;</span>{label}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>这样既保证了文档的交互体验，也能帮助 AI 理解组件的语义信息。</p>
<blockquote>
<p>详见 <a href="/zh/guide/basic/ssg-md.md" target="_blank" title="/zh/guide/basic/ssg-md.md">SSG-MD 使用指南</a></p>
</blockquote>
<h3 data-id="heading-7">Shiki 编译时代码块高亮 {#shiki-code-highlighting}</h3>
<p>Rspress 2.0 默认使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fshiki.style%2F" target="_blank" title="https://shiki.style/" ref="nofollow noopener noreferrer">Shiki</a> 进行代码高亮。相比 1.x 的 prism 运行时高亮方案，Shiki 在编译时完成高亮处理。</p>
<ol>
<li>支持多种主题样式，比如在 <a href="/zh/ui/vars.md" target="_blank" title="/zh/ui/vars.md">CSS 变量</a> 页面可以交互式地切换和预览不同的 Shiki 主题。</li>
<li>同时 Shiki 也允许使用自定义的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fshiki.style%2Fguide%2Ftransformers" target="_blank" title="https://shiki.style/guide/transformers" ref="nofollow noopener noreferrer">transformer</a> 进行扩展来丰富写作，例如 twoslash 等。</li>
<li>按需引入编程语言，不增加运行时开销和包体积。</li>
<li>基于 TextMate 语法实现与 VS Code 一致的准确语法高亮。</li>
</ol>
<p>下面是一些 Shiki transformer 的示例，直观感受一下 Shiki 带来的文档创造力：</p>
<blockquote>
<p>使用 <a href="/zh/plugin/official-plugins/twoslash.md" target="_blank" title="/zh/plugin/official-plugins/twoslash.md">@rspress/plugin-twoslash</a></p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> hi = <span class="hljs-string">'Hello'</span>;
<span class="hljs-keyword">const</span> msg = <span class="hljs-string">`<span class="hljs-subst">${hi}</span>, world`</span>;
<span class="hljs-comment">//    ^?</span>
</code></pre>
<blockquote>
<p>使用 <a href="/zh/guide/use-mdx/code-blocks.md#transformernotationfocus" target="_blank" title="/zh/guide/use-mdx/code-blocks.md#transformernotationfocus">transformerNotationFocus</a></p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Not focused'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Focused'</span>); <span class="hljs-comment">// [!code focus]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Not focused'</span>);
</code></pre>
<blockquote>
<p>详见 <a href="/zh/guide/use-mdx/code-blocks.md#shiki-transformers" target="_blank" title="/zh/guide/use-mdx/code-blocks.md#shiki-transformers">代码块</a></p>
</blockquote>
<h3 data-id="heading-8">构建性能：按需编译和持久化缓存 {#build-performance-lazy-compilation-cache}</h3>
<p>Rspress 2.0 底层由 Rsbuild 和 Rspack 2.0 预览版本驱动，同时默认开启了 <a href="https://link.juejin.cn?target=https%3A%2F%2Frspack.rs%2Fzh%2Fguide%2Ffeatures%2Flazy-compilation" target="_blank" title="https://rspack.rs/zh/guide/features/lazy-compilation" ref="nofollow noopener noreferrer">按需编译</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsbuild.rs%2Fzh%2Fconfig%2Fperformance%2Fbuild-cache" target="_blank" title="https://rsbuild.rs/zh/config/performance/build-cache" ref="nofollow noopener noreferrer">持久化缓存</a>。</p>
<h4 data-id="heading-9">按需编译</h4>
<p>默认开启 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsbuild.rs%2Fzh%2Fconfig%2Fdev%2Flazy-compilation" target="_blank" title="https://rsbuild.rs/zh/config/dev/lazy-compilation" ref="nofollow noopener noreferrer">dev.lazyCompilation</a>，只有当你访问某个页面时，该页面才会被编译，大幅提升了开发启动速度，甚至实现毫秒级的冷启动。Rspress 同时实现了路由的 preload 策略，当鼠标悬停在链接上时会预先加载目标路由页面，搭配 lazyCompilation 实现无损的开发体验。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a62db08abff4b1b90531ee6b0a246a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=BogryjmXU%2FtzfkF97elPlGjsGYI%3D" alt="lazyCompilation 按需编译效果演示" loading="lazy"/></p>
<h4 data-id="heading-10">持久化缓存</h4>
<p>2.0 同时默认开启了 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsbuild.rs%2Fzh%2Fconfig%2Fperformance%2Fbuild-cache" target="_blank" title="https://rsbuild.rs/zh/config/performance/build-cache" ref="nofollow noopener noreferrer">持久化缓存</a>，在热启动中复用上次编译的结果，提升 30%-60% 的构建速度。这意味着在首次运行 <code>rspress dev</code> 或 <code>rspress build</code> 后，后续启动速度都会明显提升。</p>
<h3 data-id="heading-11">文档开发体验 {#doc-dx}</h3>
<h4 data-id="heading-12">默认开启死链检查</h4>
<p>Rspress 2.0 默认开启死链检查功能。在构建过程中，会自动检测文档中的无效链接，帮助你及时发现和修复。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rspress/core'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">markdown</span>: {
    <span class="hljs-attr">link</span>: {
      <span class="hljs-attr">checkDeadLinks</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 默认开启，可通过 false 关闭</span>
    },
  },
});
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/288d1e9e607447b88e23220fe0959405~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=cfJ8FsL%2Fwm9%2B4bDZUTCC7L6HTzY%3D" alt="死链检查功能示例" loading="lazy"/></p>
<blockquote>
<p>详见 <a href="/zh/guide/use-mdx/link.md" target="_blank" title="/zh/guide/use-mdx/link.md">链接</a></p>
</blockquote>
<h4 data-id="heading-13">文件代码块</h4>
<p>你可以使用 <code>file="./path/to/file"</code> 属性来引用外部文件作为代码块的内容，将示例代码放在单独的文件中维护。</p>
<pre><code class="hljs language-mdx" lang="mdx">```ts file="./_demo.ts"

```
</code></pre>
<pre><code class="hljs language-mdx" lang="mdx">```tsx file="&lt;root&gt;/src/components/Button.tsx"

```
</code></pre>
<blockquote>
<p>详见 <a href="/zh/guide/use-mdx/code-blocks.md#file-code-block" target="_blank" title="/zh/guide/use-mdx/code-blocks.md#file-code-block">文件代码块</a></p>
</blockquote>
<h4 data-id="heading-14">preview 更灵活的 meta 用法</h4>
<p><a href="/zh/plugin/official-plugins/preview.md" target="_blank" title="/zh/plugin/official-plugins/preview.md">@rspress/plugin-preview</a> 现在基于 meta 属性使用，更加灵活，也可以配合文件代码块。</p>
<p>下面是一个使用 iframe 预览代码块的示例：</p>
<pre><code class="hljs language-mdx" lang="mdx">```tsx preview="iframe-follow" file="./_demo.ts"

```
</code></pre>
<p>它将会渲染为：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">center</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count - 1)}&gt;-<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<p>并且 <a href="/zh/plugin/official-plugins/playground.md" target="_blank" title="/zh/plugin/official-plugins/playground.md">@rspress/plugin-playground</a> 现在支持和 plugin-preview 一起使用，通过 meta 属性切换即可，例如 <code>```tsx playground</code></p>
<h4 data-id="heading-15">支持若干配置文件的 HMR</h4>
<p>基于 Rsbuild 重新设计的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frstackjs%2Frsbuild-plugin-virtual-module" target="_blank" title="https://github.com/rstackjs/rsbuild-plugin-virtual-module" ref="nofollow noopener noreferrer">虚拟模块插件</a>，现在支持 <code>i18n.json</code>、<code>_nav.json</code>、<code>_meta.json</code>、文件代码块以及 <code>@rspress/plugin-preview</code> 中 iframe 相关的 HMR。修改这些配置文件后，页面会自动热更新，无需手动刷新。</p>
<h3 data-id="heading-16">Rslib &amp; Rspress {#rslib-rspress}</h3>
<p>在使用 <code>create-rslib</code> 创建项目时，你现在可以选择 Rspress 工具。这让你能够在开发组件库的同时，快速搭建配套的文档站点，用于编写组件的使用说明、展示 API 参考，或实时预览组件效果。</p>
<p>执行 <code>npm create rslib@latest</code> 并选中 Rspress，会生成下方的文件结构：</p>
<pre><code class="hljs language-tree" lang="tree">├── docs
│   └── index.mdx
├── src
│   └── Button.tsx
├── package.json
├── tsconfig.json
├── rslib.config.ts
└── rspress.config.ts
</code></pre>
<p>模版中内置了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frstackjs%2Frsbuild-plugin-workspace-dev" target="_blank" title="https://github.com/rstackjs/rsbuild-plugin-workspace-dev" ref="nofollow noopener noreferrer">rsbuild-plugin-workspace-dev</a> 插件，可在启动 Rspress 开发服务器的同时自动运行 Rslib 的 watch 命令。</p>
<p>直接运行 <code>npm run doc</code> 启动 Rspress 的开发服务器对 Rslib 组件库进行预览：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rslib build --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"doc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rspress dev"</span> <span class="hljs-comment">// 执行该命令</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-17">更多 Rspress 官方插件</h3>
<p>Rspress 2.0 新增了多个官方插件：</p>
<ul>
<li><a href="/zh/plugin/official-plugins/algolia.md" target="_blank" title="/zh/plugin/official-plugins/algolia.md"><strong>@rspress/plugin-algolia</strong></a>：支持替换 Rspress 的内置搜索为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocsearch.algolia.com%2F" target="_blank" title="https://docsearch.algolia.com/" ref="nofollow noopener noreferrer">Algolia DocSearch</a>（感谢 <a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Falgolia" target="_blank" title="https://x.com/algolia" ref="nofollow noopener noreferrer">@algolia</a> 团队的协助）。</li>
<li><a href="/zh/plugin/official-plugins/twoslash.md" target="_blank" title="/zh/plugin/official-plugins/twoslash.md"><strong>@rspress/plugin-twoslash</strong></a>：为 TypeScript 代码块添加类型提示。</li>
<li><a href="/zh/plugin/official-plugins/llms.md" target="_blank" title="/zh/plugin/official-plugins/llms.md"><strong>@rspress/plugin-llms</strong></a>：为不支持 SSG 和 SSG-MD 的项目提供 llms.txt 生成能力。</li>
<li><a href="/zh/plugin/official-plugins/sitemap.md" target="_blank" title="/zh/plugin/official-plugins/sitemap.md"><strong>@rspress/plugin-sitemap</strong></a>：自动生成 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sitemaps.org" target="_blank" title="https://www.sitemaps.org" ref="nofollow noopener noreferrer">Sitemap</a> 文件，用于优化 SEO。</li>
</ul>
<hr/>
<h2 data-id="heading-18">其他 Breaking changes</h2>
<h3 data-id="heading-19">从 Rspress 1.x 迁移</h3>
<p>如果你是 1.x 项目的用户，我们准备了一份详尽的迁移文档，帮助你从 1.x 升级到 2.0。</p>
<p>你可以直接使用页面中的 "复制 Markdown" 功能，将其输入给你常用的编码 agent（如 Claude Code 等）来完成迁移。</p>
<blockquote>
<p>请参考 <a href="/zh/guide/migration/rspress-1-x.md" target="_blank" title="/zh/guide/migration/rspress-1-x.md">迁移指南</a>。</p>
</blockquote>
<h3 data-id="heading-20">移除 <code>mdxRs</code> 配置</h3>
<p>我们注意到很大一部分 1.x 用户为了使用 Shiki、组件库预览功能和自定义 remark/rehype 插件，而主动关闭 <code>mdxRs</code>，并且在开启按需编译和持久化缓存后，即使使用 JS 版本的 mdx 解析器，性能优化效果已经非常显著。</p>
<p>为了换取更好的扩展性和维护性，我们决定在 Markdown/MDX 编译流程中不再使用 Rust 版本的 MDX 解析器（<code>@rspress/mdx-rs</code>）。这使得 Rspress 能够更好地集成 Shiki 等 JavaScript 生态的工具。</p>
<h3 data-id="heading-21">Node.js 与上游依赖版本要求</h3>
<p>Rspress 2.0 要求 Node.js 版本 <strong>20+</strong>，React 版本 <strong>18+</strong>。</p>



































<table><thead><tr><th>依赖</th><th>允许范围</th><th>默认版本</th><th>说明</th></tr></thead><tbody><tr><td><code>react</code></td><td><code>^18.0.0 || ^19.0.0</code></td><td>19</td><td>不再支持 React 17，如项目已安装则使用项目版本</td></tr><tr><td><code>react-dom</code></td><td><code>^18.0.0 || ^19.0.0</code></td><td>19</td><td>与 react 版本保持一致</td></tr><tr><td><code>react-router-dom</code></td><td><code>^6.0.0 || ^7.0.0</code></td><td>7</td><td>如项目已安装则使用项目版本</td></tr><tr><td><code>unified</code></td><td><code>^11.0.0</code></td><td>11</td><td>自定义 remark/rehype 插件需兼容</td></tr></tbody></table>
<h3 data-id="heading-22">包名及导入路径变更</h3>
<p>Rspress 将 <code>rspress</code>、<code>@rspress/runtime</code>、<code>@rspress/shared</code>、<code>@rspress/theme-default</code> 都整合进了 <code>@rspress/core</code> 中，项目和插件现在均只需安装一个 <code>@rspress/core</code> 包即可。</p>
<pre><code class="hljs language-diff" lang="diff">{
  "dependencies": {
<span class="hljs-deletion">-   "rspress": "1.x"</span>
<span class="hljs-deletion">-   "@rspress/shared": "1.x"</span>
<span class="hljs-addition">+   "@rspress/core": "^2.0.0"</span>
  }
}
</code></pre>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- import { defineConfig } from 'rspress/config';</span>
<span class="hljs-addition">+ import { defineConfig } from '@rspress/core';</span>
</code></pre>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- import { useDark } from 'rspress/runtime'</span>
<span class="hljs-deletion">- import { PackageManagerTabs } from 'rspress/theme';</span>
<span class="hljs-addition">+ import { useDark } from '@rspress/core/runtime'</span>
<span class="hljs-addition">+ import { PackageManagerTabs } from '@rspress/core/theme';</span>
</code></pre>
<p>如果你开发了 Rspress 插件，请将插件的 peerDependencies 从 <code>rspress</code> 变更为 <code>@rspress/core</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@rspress/core"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-23">下一步</h2>
<p>Rspress 2.0 的发布只是一个新的起点。本次发布后，Rspress 将持续迭代：</p>
<ul>
<li>
<p><strong>推进生态集成</strong>：与 Rslib、Rstest 更深度地结合，提供前端项目和组件库项目的一体化开发体验。</p>
</li>
<li>
<p><strong>探索 AI 与文档更深度集成</strong>：如智能问答、自动摘要等；完善 SSG-MD 使其稳定并更加易用。</p>
</li>
</ul>
<p>感谢所有为 Rspress 做出贡献的开发者和用户！如果你在使用过程中遇到问题或有任何建议，欢迎在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fweb-infra-dev%2Frspress%2Fissues" target="_blank" title="https://github.com/web-infra-dev/rspress/issues" ref="nofollow noopener noreferrer">GitHub Issues</a> 中反馈。</p>
<p>立即使用或升级到 Rspress 2.0，体验全新的文档开发之旅！</p>
<pre><code class="hljs language-sh" lang="sh">npm create rspress@latest
</code></pre>
<pre><code class="hljs language-sh" lang="sh">yarn create rspress
</code></pre>
<pre><code class="hljs language-sh" lang="sh">pnpm create rspress@latest
</code></pre>
<pre><code class="hljs language-sh" lang="sh">bun create rspress@latest
</code></pre>
<pre><code class="hljs language-sh" lang="sh">deno init --npm rspress@latest
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React-create-app使用cesium并且渲染3d倾斜摄影]]></title>    <link>https://juejin.cn/post/7603359026711068682</link>    <guid>https://juejin.cn/post/7603359026711068682</guid>    <pubDate>2026-02-06T07:57:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603359026711068682" data-draft-id="7603263490341912585" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React-create-app使用cesium并且渲染3d倾斜摄影"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-06T07:57:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="scorpioop"/> <meta itemprop="url" content="https://juejin.cn/user/2683248842638445"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React-create-app使用cesium并且渲染3d倾斜摄影
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2683248842638445/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    scorpioop
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:57:02.000Z" title="Fri Feb 06 2026 07:57:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>先上效果
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d91986db1cd44a3c979695e2cf4cc046~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2NvcnBpb29w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969423&amp;x-signature=8Rk0mVxuB45LwCSZrCSZ8D910CQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、cesium在react-create-app中的引用</h2>
<p>首先
<code>yarn add cesium</code>然后<code>yarn add copy-webpack-plugin -D</code>然后<code>yarn add customize-cra react-app-rewired --dev </code></p>
<p>设置了customize-cra react-app-rewired就可以改写webpack</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e9ed1316b54ea38f0ac111b027805d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2NvcnBpb29w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969423&amp;x-signature=xMHtx8ofQT2ZjbL66C%2BQjDieF%2FQ%3D" alt="image.png" loading="lazy"/>
新建一个这个文件，在里面改写webpack</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> {
  override,
 
  addWebpackPlugin,
} = <span class="hljs-built_in">require</span>(<span class="hljs-string">"customize-cra"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CopyWebpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"copy-webpack-plugin"</span>);
<span class="hljs-keyword">const</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">"webpack"</span>);


<span class="hljs-keyword">const</span> cesiumSource = <span class="hljs-string">'node_modules/cesium/Source'</span>;
<span class="hljs-keyword">const</span> cesiumWorkers = <span class="hljs-string">'../Build/Cesium/Workers'</span>;



<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">override</span>(
  
 
  <span class="hljs-title function_">addWebpackPlugin</span>(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyWebpackPlugin</span>({
      <span class="hljs-attr">patterns</span>: [
        
        { <span class="hljs-attr">from</span>: path.<span class="hljs-title function_">join</span>(cesiumSource, cesiumWorkers), <span class="hljs-attr">to</span>: <span class="hljs-string">'cesium/Workers'</span> },
        { <span class="hljs-attr">from</span>: path.<span class="hljs-title function_">join</span>(cesiumSource, <span class="hljs-string">'Assets'</span>), <span class="hljs-attr">to</span>: <span class="hljs-string">'cesium/Assets'</span> },
        { <span class="hljs-attr">from</span>: path.<span class="hljs-title function_">join</span>(cesiumSource, <span class="hljs-string">'Widgets'</span>), <span class="hljs-attr">to</span>: <span class="hljs-string">'cesium/Widgets'</span> }
      ],
    })
  ),
  <span class="hljs-title function_">addWebpackPlugin</span>(
    <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">DefinePlugin</span>({
      <span class="hljs-comment">// Define relative base path in cesium for loading assets</span>
      <span class="hljs-attr">CESIUM_BASE_URL</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-string">"/cesium"</span>),
    })
  )
  <span class="hljs-comment">// addWebpackPlugin(new BundleAnalyzerPlugin())</span>
);


</code></pre>
<p>package.json里的打包脚本变成</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"react-app-rewired start"</span>,
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"react-app-rewired build"</span>,
    
  },
</code></pre>
<p>这样就会走我们新设定的webpack，将将node_modules/cesium/Source/Assets, node_modules/cesium/Source/Widgets, node_modules/cesium/Build/Cesium/Workers自动文件打包到build文件里，如图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6bc758eb20240eb81ece4677f2bd6cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2NvcnBpb29w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969423&amp;x-signature=4ihE51DCKx%2BnZpHT8Efe4jvzVlo%3D" alt="image.png" loading="lazy"/>
这样yarn start 或者yarn build就可以正常使用cesium了</p>
<p>下面这篇我直接按<strong>可发布到掘金的技术文章结构</strong>帮你整理好了：有背景、有思路、有代码拆解、有优化建议，基本不需要再大改就能发 👍</p>
<h2 data-id="heading-1">二、创建 Viewer 且必须只创建一次！</h2>
<p>否则：</p>
<ul>
<li>内存暴涨</li>
<li>WebGL context 丢失</li>
<li>页面卡死</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!containerRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">if</span> (viewerRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">const</span> viewer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Viewer</span>(containerRef.<span class="hljs-property">current</span>, {
    <span class="hljs-attr">timeline</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">animation</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">infoBox</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">fullscreenButton</span>: <span class="hljs-literal">false</span>,
  });

  viewerRef.<span class="hljs-property">current</span> = viewer;

  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    viewerRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">destroy</span>();
    viewerRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
  };
}, []);
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{containerRef}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"cesium-container"</span> /&gt;</span></span>
</code></pre>
<p>这是 <strong>Cesium + React 的标准写法</strong>。</p>
<hr/>
<h2 data-id="heading-2">三、加载倾斜摄影模型（3DTiles）</h2>
<pre><code class="hljs language-scss" lang="scss">Cesium<span class="hljs-selector-class">.Cesium3DTileset</span><span class="hljs-selector-class">.fromUrl</span>("tileset.json")
  <span class="hljs-selector-class">.then</span>((tileset) =&gt; {
    viewer<span class="hljs-selector-class">.scene</span><span class="hljs-selector-class">.primitives</span><span class="hljs-selector-class">.add</span>(tileset);
    viewer<span class="hljs-selector-class">.zoomTo</span>(tileset);
  });
</code></pre>
<h4 data-id="heading-3">一个强烈建议 ⭐⭐⭐⭐⭐</h4>
<p>建议监听瓦片失败：</p>
<pre><code class="hljs language-go" lang="go">tileset.tileFailed.addEventListener((<span class="hljs-type">error</span>) =&gt; {
  console.<span class="hljs-type">error</span>(<span class="hljs-string">"瓦片加载失败:"</span>, <span class="hljs-type">error</span>);
});
</code></pre>
<p>否则生产环境排查问题会非常痛苦。</p>
<hr/>
<h2 data-id="heading-4">四、动态绘制监测点（核心）</h2>
<p>很多人喜欢用：</p>
<p>👉 Primitive<br/>
👉 PointPrimitive</p>
<p>但在业务系统中，我更推荐：</p>
<h2 data-id="heading-5">⭐ Entity</h2>
<p>因为：</p>
<ul>
<li>开发简单</li>
<li>支持属性绑定</li>
<li>支持 pick</li>
<li>易维护</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createColorIcon</span>(<span class="hljs-params">color: string</span>) {
    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"canvas"</span>);
    <span class="hljs-keyword">const</span> size = <span class="hljs-number">48</span>;
    canvas.<span class="hljs-property">width</span> = size;
    canvas.<span class="hljs-property">height</span> = size;
    <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);
    <span class="hljs-keyword">if</span> (ctx) {
      <span class="hljs-keyword">const</span> cx = size / <span class="hljs-number">2</span>;
      <span class="hljs-keyword">const</span> r = <span class="hljs-number">12</span>;
      <span class="hljs-keyword">const</span> tipY = size - <span class="hljs-number">6</span>;



      <span class="hljs-comment">// 图钉形状（圆 + 尖）</span>
      ctx.<span class="hljs-title function_">beginPath</span>();
      ctx.<span class="hljs-title function_">moveTo</span>(cx, tipY);
      ctx.<span class="hljs-title function_">quadraticCurveTo</span>(cx + r, r + <span class="hljs-number">12</span>, cx + r, r + <span class="hljs-number">4</span>);
      ctx.<span class="hljs-title function_">arc</span>(cx, r + <span class="hljs-number">4</span>, r, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>, <span class="hljs-literal">true</span>);
      ctx.<span class="hljs-title function_">quadraticCurveTo</span>(cx - r, r + <span class="hljs-number">12</span>, cx, tipY);
      ctx.<span class="hljs-title function_">closePath</span>();
      ctx.<span class="hljs-property">fillStyle</span> = color;
      ctx.<span class="hljs-title function_">fill</span>();



      ctx.<span class="hljs-title function_">fill</span>();
    }

    <span class="hljs-keyword">return</span> canvas;
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getWarningColor</span> = (<span class="hljs-params">p: any</span>) =&gt; {
    <span class="hljs-keyword">const</span> level =
      p?.<span class="hljs-property">alarmLevel</span> ?? <span class="hljs-number">0</span>;
    <span class="hljs-keyword">switch</span> (<span class="hljs-title class_">Number</span>(level)) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"#D7263D99"</span>; <span class="hljs-comment">// 红色预警（约 60% 不透明）</span>
      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"#FF6B0099"</span>; <span class="hljs-comment">// 橙色预警</span>
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"#C7A20099"</span>; <span class="hljs-comment">// 黄色预警</span>
      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"#00BEFF99"</span>; <span class="hljs-comment">// 蓝色预警</span>
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"#d3f26199"</span>; <span class="hljs-comment">// 约 60% 不透明</span>
    }
  };
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> viewer = viewerRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (!viewer) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (dataSource &amp;&amp; dataSource?.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      pointEntityIdsRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          viewer.<span class="hljs-property">entities</span>.<span class="hljs-title function_">removeById</span>(id);
        } <span class="hljs-keyword">catch</span> (e) {
          <span class="hljs-comment">// ignore</span>
        }
      });
      pointEntityIdsRef.<span class="hljs-property">current</span> = [];
     
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'dataSource'</span>, dataSource);
     

      (dataSource || []).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">p: any</span>) =&gt;</span> {


        <span class="hljs-keyword">const</span> lng = <span class="hljs-title class_">Number</span>(p.<span class="hljs-property">longitude</span>);
        <span class="hljs-keyword">const</span> lat = <span class="hljs-title class_">Number</span>(p.<span class="hljs-property">latitude</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isNaN</span>(lng) || <span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isNaN</span>(lat)) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">const</span> id = <span class="hljs-string">`point-<span class="hljs-subst">${p.id}</span>`</span>;
        viewer.<span class="hljs-property">entities</span>.<span class="hljs-title function_">add</span>({
          id,
          <span class="hljs-attr">position</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromDegrees</span>(lng, lat, <span class="hljs-title class_">Number</span>(p.<span class="hljs-property">height</span>) || <span class="hljs-number">0</span>),
          <span class="hljs-attr">billboard</span>: {
            <span class="hljs-attr">image</span>: <span class="hljs-title function_">createColorIcon</span>(<span class="hljs-title function_">getWarningColor</span>(p)),
            <span class="hljs-attr">verticalOrigin</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">VerticalOrigin</span>.<span class="hljs-property">BOTTOM</span>,
            <span class="hljs-comment">// 防止被倾斜摄影挡住</span>
            <span class="hljs-attr">disableDepthTestDistance</span>: <span class="hljs-title class_">Number</span>.<span class="hljs-property">POSITIVE_INFINITY</span>
          },
          <span class="hljs-attr">label</span>: {
            <span class="hljs-attr">text</span>: p.<span class="hljs-property">pointName</span> || <span class="hljs-string">""</span>,
            <span class="hljs-attr">font</span>: <span class="hljs-string">"bold 15px sans-serif"</span>,
            <span class="hljs-attr">fillColor</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-title function_">fromCssColorString</span>(<span class="hljs-string">"rgba(68, 229, 255, 0.92)"</span>),
            <span class="hljs-attr">outlineColor</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-title function_">fromCssColorString</span>(<span class="hljs-string">"rgba(124, 121, 121, 0.9)"</span>).<span class="hljs-title function_">withAlpha</span>(<span class="hljs-number">0.85</span>),
            <span class="hljs-attr">outlineWidth</span>: <span class="hljs-number">2</span>,
            <span class="hljs-attr">style</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">LabelStyle</span>.<span class="hljs-property">FILL_AND_OUTLINE</span>,
            <span class="hljs-attr">verticalOrigin</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">VerticalOrigin</span>.<span class="hljs-property">BOTTOM</span>,
            <span class="hljs-attr">pixelOffset</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian2</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">50</span>),
            <span class="hljs-attr">disableDepthTestDistance</span>: <span class="hljs-title class_">Number</span>.<span class="hljs-property">POSITIVE_INFINITY</span>,
            <span class="hljs-attr">distanceDisplayCondition</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">DistanceDisplayCondition</span>(
              <span class="hljs-number">0</span>,
              <span class="hljs-number">5000</span>
            ),
          },
          <span class="hljs-attr">properties</span>: {
            <span class="hljs-attr">pickable</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">pointId</span>: p.<span class="hljs-property">id</span>,
            <span class="hljs-attr">pointType</span>: p?.<span class="hljs-property">pointType</span>,
            <span class="hljs-attr">pointName</span>: p?.<span class="hljs-property">pointName</span>,
          }
        });

        pointEntityIdsRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">push</span>(id);
      });
      <span class="hljs-keyword">const</span> handler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">ScreenSpaceEventHandler</span>(viewer.<span class="hljs-property">scene</span>.<span class="hljs-property">canvas</span>);

      handler.<span class="hljs-title function_">setInputAction</span>(<span class="hljs-function">(<span class="hljs-params">movement: any</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> picked = viewer.<span class="hljs-property">scene</span>.<span class="hljs-title function_">pick</span>(movement.<span class="hljs-property">endPosition</span>);


        <span class="hljs-keyword">if</span> (
          <span class="hljs-title class_">Cesium</span>.<span class="hljs-title function_">defined</span>(picked) &amp;&amp;
          picked.<span class="hljs-property">id</span> &amp;&amp;                     <span class="hljs-comment">// Entity</span>
          picked?.<span class="hljs-property">id</span>?.<span class="hljs-property">properties</span>?.<span class="hljs-property">pickable</span>?.<span class="hljs-title function_">getValue</span>()
        ) {

          viewer.<span class="hljs-property">canvas</span>.<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span> = <span class="hljs-string">'pointer'</span>;


        } <span class="hljs-keyword">else</span> {
          viewer.<span class="hljs-property">canvas</span>.<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span> = <span class="hljs-string">'default'</span>;


        }
      }, <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">ScreenSpaceEventType</span>.<span class="hljs-property">MOUSE_MOVE</span>);
      <span class="hljs-comment">// 点击测点</span>
      handler.<span class="hljs-title function_">setInputAction</span>(<span class="hljs-function">(<span class="hljs-params">click: any</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> picked = viewer.<span class="hljs-property">scene</span>.<span class="hljs-title function_">pick</span>(click.<span class="hljs-property">position</span>);

        <span class="hljs-keyword">if</span> (
          <span class="hljs-title class_">Cesium</span>.<span class="hljs-title function_">defined</span>(picked) &amp;&amp;
          picked.<span class="hljs-property">id</span> &amp;&amp;
          picked.<span class="hljs-property">id</span>.<span class="hljs-property">billboard</span>
        ) {
          <span class="hljs-keyword">const</span> entity = picked.<span class="hljs-property">id</span>;

          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'点到了:'</span>, entity.<span class="hljs-property">id</span>, picked?.<span class="hljs-property">id</span>?.<span class="hljs-property">properties</span>?.<span class="hljs-property">pointId</span>?.<span class="hljs-title function_">getValue</span>());

         

          <span class="hljs-comment">// 示例：相机飞过去</span>
          viewer.<span class="hljs-title function_">flyTo</span>(entity);
          
        }
      }, <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">ScreenSpaceEventType</span>.<span class="hljs-property">LEFT_CLICK</span>);


    }


  }, [dataSource]);
</code></pre>
<hr/>
<h2 data-id="heading-6">五、点击测点飞行定位</h2>
<h3 data-id="heading-7">pick 实体</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> picked = viewer.scene.<span class="hljs-built_in">pick</span>(click.position);
</code></pre>
<p>判断：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">if</span> (Cesium.<span class="hljs-built_in">defined</span>(picked) &amp;&amp; picked.id?.billboard) {
</code></pre>
<p>然后：</p>
<pre><code class="hljs language-ini" lang="ini">viewer.flyTo(entity)<span class="hljs-comment">;</span>
</code></pre>
<p>体验直接拉满。</p>
<hr/>
<h3 data-id="heading-8">鼠标 Hover 手型</h3>
<p>细节决定高级感：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">viewer.canvas.style.cursor</span> = <span class="hljs-string">'pointer'</span><span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">六、相机环绕动画</h2>
<p>核心思路：</p>
<h4 data-id="heading-10">👉 clock.onTick</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> remove = viewer.<span class="hljs-property">clock</span>.<span class="hljs-property">onTick</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-function">() =&gt;</span> {
  heading += <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Math</span>.<span class="hljs-title function_">toRadians</span>(<span class="hljs-number">0.2</span>);

  viewer.<span class="hljs-property">camera</span>.<span class="hljs-title function_">lookAt</span>(
    center,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">HeadingPitchRange</span>(
      heading,
      <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Math</span>.<span class="hljs-title function_">toRadians</span>(-<span class="hljs-number">30</span>),
      range
    )
  );
<span class="hljs-comment">// 转满一圈停止</span>
  <span class="hljs-keyword">if</span> (heading &gt;= <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Math</span>.<span class="hljs-property">TWO_PI</span>) {
    <span class="hljs-title function_">remove</span>();
    viewer.<span class="hljs-property">camera</span>.<span class="hljs-title function_">lookAtTransform</span>(<span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>.<span class="hljs-property">IDENTITY</span>);
  }
});
</code></pre>
<p>本质：</p>
<p>👉 每帧改变 heading。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[详解 IEEE 754 标准定义的 JavaScript 64 位浮点数]]></title>    <link>https://juejin.cn/post/7603309951227232306</link>    <guid>https://juejin.cn/post/7603309951227232306</guid>    <pubDate>2026-02-06T08:20:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951227232306" data-draft-id="7603352117639036937" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="详解 IEEE 754 标准定义的 JavaScript 64 位浮点数"/> <meta itemprop="keywords" content="前端,JavaScript,数学"/> <meta itemprop="datePublished" content="2026-02-06T08:20:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="斟茶递水黄师傅"/> <meta itemprop="url" content="https://juejin.cn/user/3720403078610952"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            详解 IEEE 754 标准定义的 JavaScript 64 位浮点数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3720403078610952/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    斟茶递水黄师傅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:20:46.000Z" title="Fri Feb 06 2026 08:20:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-light">.hljs-comment,.hljs-quote{color:#6b7394}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f5f7ff;color:#5e6687}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>JavaScript 使用 IEEE 754 标准定义的 64 位浮点格式表示数值。</p>
<p><strong>64位 = 1位符号位(S) + 11位指数位(E) + 52位尾数位(M)</strong></p>
<ul>
<li>符号位（S）：0表示正数，1表示负数，决定数值的正负；</li>
<li>指数位（E）：存储指数的偏移值（偏移量1023），决定数值的数量级；</li>
<li>尾数位（M）：存储数值的有效数字（二进制），且有一个隐含的1位（规格化数，也叫归一化数，normalized number），所以实际有效位数是 52 + 1 = 53位。</li>
</ul>
<p>指数位（E）的偏移量 1023 是标准人为规定的，为的是让原本的 11 位无符号位的二进制指数位能表示正负指数，并且正负指数尽可能对称（-1022 ~ 1023）。</p>
<p>尾数位（M）的隐藏位 1 也是标准人为规定的，利用了非零二进制数归一化后整数位必为 1 的特性。</p>
<p>任何一个非零的二进制数，都能唯一表示为 <code>1.xx × 2^e</code> 的形式。</p>
<ul>
<li>e 是二进制的指数（整数，可正可负）；</li>
<li>归一化后整数位必然是固定不变的 1，这是二进制的特性。</li>
</ul>
<p>IEEE 754 标准正是利用了「归一化后整数位必为 1」的特性，做了一个巧妙设计：</p>
<p>既然这个 1 是所有非零浮点数的固定前缀，那就不用在 64 位中实际存储它，而是「默认存在这个 1」，仅将小数点后的 xx 有效数字部分存入 52 位的尾数位（M）中。</p>
<p>原本尾数位只有 52 位，加上这 1 位隐藏的固定不变的 1 后，实际可用的有效数字位就变成了 53 位（1 + 52），直接提升了浮点数的精度，且没有占用额外的存储空间。</p>
<p><strong>只有非零的归一化浮点数才有隐藏位。对于接近 0 的极小值（非归一化数），IEEE 754 会放弃归一化</strong>，此时没有隐藏位，只有 52 位有效数字。</p>
<h3 data-id="heading-0">推导：53 位二进制能表示的最大整数是 2^53 - 1</h3>
<p>当 53 位二进制尾数位（M）（包含隐藏位 1），所有位都为 1 时，就是它能表示的最大数，计算如下：</p>
<pre><code class="hljs language-ini" lang="ini">111...111（53个1） = 2^52 + 2^51 + ... + 2^1 + 2^<span class="hljs-attr">0</span> = <span class="hljs-number">2</span>^<span class="hljs-number">53</span> - <span class="hljs-number">1</span>
</code></pre>
<p>这个数就是 JS 中能精确表示的最大安全整数 <code>Number.MAX_SAFE_INTEGER</code>。</p>
<p><strong>一个整数 n 被称为安全整数，当且仅当：它自身和前后相邻的两个整数（n−1、n、n+1），都能被唯一且精确地存储表示</strong>，三者的 64 位浮点数编码互不重复，且不存在截断舍入后的失真情况。</p>
<p>在 2^53 ~ 2^1023 这区间内的 2 的整数次幂能精确表示，但都是「孤立的精确数」（相邻数失真，无连续性）。</p>
<h3 data-id="heading-1">少数能<strong>精确存储</strong>的特殊十进制小数</h3>
<p>绝大多数小数的二进制，都是无限循环的小数形式，都不能精确存储，只能截断舍入近似存储。</p>
<p>如果一个十进制小数转二进制后是「有限位小数」，就能被 64 位浮点数精确存储，这类小数有明确的数学规则：</p>
<blockquote>
<p><strong>十进制小数能精确转为有限位二进制的充要条件：小数部分转化成最简分数形式后，它的分母仅包含质因子 2（即分母是 2 的正整数次幂：2¹、2²、2³...）。</strong></p>
</blockquote>
<p>简单说：小数部分是 <code>0.5(1/2)、0.25(1/4)、0.125(1/8)、0.0625(1/16)...</code> 的组合，就能精确存储。</p>
<h3 data-id="heading-2"><strong>浮点数的「可表示值步长」随数值增大而变大</strong>（精度衰减规律）</h3>
<p>64 位浮点数的可表示值不是连续的，而是离散的、等步长的（同一量级内步长固定），且数值越大，量级越高，步长越大。这是整数和小数的精度都会随数值增大而衰减的根本原因。</p>
<p><strong>步长是（同一量级内）相邻两个可表示的浮点数之间的差值，由归一化后的指数 e 决定</strong>：</p>
<p><strong>步长 = 2^(e-52)</strong> （52 是尾数位 M 的位数）。</p>
<ul>
<li>步长越小，可表示值越密集，精度越高；</li>
<li>步长越大，可表示值越稀疏，精度越低。</li>
</ul>
<p>步长对整数和小数的影响：</p>
<p><strong>- 安全整数区（e≤52）：步长 = 2^(e-52) ≤1 → 整数的步长为 1，能连续精确表示；小数的步长极小，误差可忽略；</strong></p>
<ul>
<li>2⁵³~2¹⁰²³ 区：步长≥2 → 整数的步长大于 1，无法连续精确表示（相邻整数重叠）；小数的步长极大，几乎无法区分相近小数；</li>
<li>2¹⁰²³ 以上：超出指数范围，直接变成 Infinity，无法表示为常规数。</li>
</ul>
<h3 data-id="heading-3">MAX_VALUE 和 MIN_VALUE</h3>
<p>最大正值：<code>Number.MAX_VALUE = 1.7976931348623157×10³⁰⁸</code></p>
<p>指数位取归一化数的最大存储值 2046（实际指数 1023），尾数位 52 位全 1（此时浮点数取到归一化数的最大极值，再大就超出指数范围，变成<code>Infinity</code>）；</p>
<p>最小正值：<code>Number.MIN_VALUE = 5×10⁻³²⁴</code>（无限接近 0）</p>
<p>指数位取全 0（非归一化数，实际指数 -1023），尾数位仅最后 1 位为 1、其余全 0（此时浮点数取到能表示的最小非 0 正值，再小就会被舍入为 0）。</p>
<p>这是 64 位双精度浮点数基于 IEEE 754 标准的硬件存储极限，是浮点数能表示的所有数值（整数 + 小数）的整体边界，而非专门针对整数的范围。</p>
<h3 data-id="heading-4">±Infinity 和 NaN 如何表示</h3>



































<table><thead><tr><th/><th><strong>Infinity（正无穷）</strong></th><th><strong>-Infinity（负无穷）</strong></th><th><strong>NaN（非数）</strong></th></tr></thead><tbody><tr><td>1位符号位（S）</td><td>0表示正数</td><td>1表示负数</td><td>0和1都可，无意义</td></tr><tr><td>11位指数位（E）</td><td>11位全1</td><td>11位全1</td><td>11位全1</td></tr><tr><td>52位尾数位（M）</td><td>52位全0</td><td>52位全0</td><td>52位非全0（即任意1位是1即可）</td></tr><tr><td/><td><strong>S0 + E全1 + M全0</strong></td><td><strong>S1 + E全1 + M全0</strong></td><td><strong>S01 + E全1 + M非0</strong></td></tr></tbody></table>
<p><strong>E全1 表示 ±Infinity 和 NaN 的特殊值，而 E全0 表示非归一化数（接近 0 的极小值，无隐藏位）。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS自定义TabBar]]></title>    <link>https://juejin.cn/post/7603352117638922249</link>    <guid>https://juejin.cn/post/7603352117638922249</guid>    <pubDate>2026-02-06T07:46:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603352117638922249" data-draft-id="7603309951226921010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS自定义TabBar"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-06T07:46:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恰少年"/> <meta itemprop="url" content="https://juejin.cn/user/1591748567509486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS自定义TabBar
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748567509486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恰少年
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:46:53.000Z" title="Fri Feb 06 2026 07:46:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">DDTabBar 自定义 TabBar</h2>
<h3 data-id="heading-1">概述</h3>
<p>DDTabBar 模块底部导航栏的自定义实现，</p>
<ul>
<li>支持 <strong>普通样式</strong> 与 <strong>液态玻璃（Liquid Glass）样式</strong> 双形态切换。</li>
<li>支持暗黑模式和长辈模式</li>
<li>支持Lottie，gif，png图片资源</li>
<li>支持自定义角标，小红点</li>
<li>根据接口动态更新item数量，顺序</li>
</ul>
<hr/>
<h3 data-id="heading-2">效果</h3>
<p>液态玻璃-暗黑</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff8cf5d212c14acfaf8f20bfd750453b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw5bCR5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770968812&amp;x-signature=4sZQdJHdYjmKV66UAGqTETqJiok%3D" alt="暗黑" width="30%" loading="lazy"/>
<p>液态玻璃-白天</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/957e679003cf4fab875759695a895144~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw5bCR5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770968812&amp;x-signature=YYPkWCeAhQMazKXdVrJn3L9I%2Byg%3D" width="30%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/684ee7a68095432aa4879cc6b7db7434~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw5bCR5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770968812&amp;x-signature=%2FaBRiNfkwauFsmiA1TCmsB5h8EQ%3D" width="30%" loading="lazy"/>
<p>普通模式</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b13fde133acb41e4b929d74c259d9dbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw5bCR5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770968812&amp;x-signature=AJWcmW7bLWcDmkKOcYimhbHIy4c%3D" width="30%" loading="lazy"/>
<p>长辈版</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/997cccb5b897401f866d6e3513d11cae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw5bCR5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770968812&amp;x-signature=r76eHLLelwWiFz63RagoH%2BZM5vU%3D" width="30%" loading="lazy"/>
<hr/>
<h3 data-id="heading-3">目录结构</h3>
<pre><code class="hljs language-bash" lang="bash">DDTabBar/
├── Manager/                    <span class="hljs-comment"># 管理与加载</span>
│   ├── DDTabBarManager.swift           <span class="hljs-comment"># TabBar 单例、数据与配置</span>
│   ├── DDTabBarItemOperationBadgeView.swift  <span class="hljs-comment"># 运营角标</span>
│   ├── TabBarCacheManager.swift        <span class="hljs-comment"># 配置缓存</span>
│   ├── TabBarResourceLoader.swift      <span class="hljs-comment"># 图标/Lottie 资源加载</span>
│   └── TabbarRNRouterInterceptor.swift <span class="hljs-comment"># RN 路由拦截</span>
├── Model/
│   ├── DDTabBarItem.swift              <span class="hljs-comment"># (预留) Item 定义</span>
│   └── TabBarModel.swift               <span class="hljs-comment"># TabBar 与 Item 数据模型</span>
├── Util/
│   ├── DDTaBarEnum.h                   <span class="hljs-comment"># 枚举：场景、Item 类型、图片类型</span>
│   └── DDTabBarUtil.swift              <span class="hljs-comment"># 工具：曝光埋点、数据比较等</span>
└── View/
    ├── DDTabBar.swift                  <span class="hljs-comment"># 主入口：双样式容器与切换逻辑</span>
    ├── DDTabBarItemBadgeView.swift     <span class="hljs-comment"># 角标视图</span>
    ├── DDTabBarItemContainer.swift     <span class="hljs-comment"># 单个 Tab 容器（可点击）</span>
    ├── DDTabBarItemContentView.swift   <span class="hljs-comment"># Tab 内容（图标+文案+角标）</span>
    ├── TabbarWebViewController.swift   <span class="hljs-comment"># Web Tab 落地页</span>
    └── README.md                       <span class="hljs-comment"># 本文档</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">双样式架构</h3>
<h4 data-id="heading-5">1. 样式类型</h4>




















<table><thead><tr><th>样式</th><th>类名</th><th>说明</th></tr></thead><tbody><tr><td><strong>普通样式</strong></td><td><code>DDTabBarNormalView</code></td><td>全宽 TabBar，毛玻璃 + 背景图/背景色，常规布局</td></tr><tr><td><strong>液态玻璃</strong></td><td><code>DDTabBarLiquidGlassView</code></td><td>圆角胶囊容器，iOS 26 下使用 <code>UIGlassEffect</code>，支持暗黑适配</td></tr></tbody></table>
<h4 data-id="heading-6">2. 切换条件</h4>
<p>液态玻璃是否展示由 <code>DDTabBar.isLiquidGlassActive()</code> 决定：</p>
<ul>
<li><code>DDLiquidGlassManager.shared.isLiquidGlassActive == true</code></li>
<li><strong>且</strong> 非长辈版：<code>!DDBasicInfoManager.shared.isAPVersion</code></li>
</ul>
<p>满足时显示 <code>DDTabBarLiquidGlassView</code>，否则显示 <code>DDTabBarNormalView</code>。</p>
<h4 data-id="heading-7">3. 状态同步</h4>
<ul>
<li>通过通知监听并刷新当前展示的样式：
<ul>
<li><code>DDLiquidGlassManager.StateDidChangedNotification</code>：液态玻璃开关变化</li>
<li><code>.DDDarkModeShowDarkChanged</code>：暗黑模式变化</li>
<li><code>kChangeToAPVersionNotification</code>：长辈版切换</li>
</ul>
</li>
<li>两种视图的数据与选中索引会同时更新，保证切换样式时状态一致。</li>
</ul>
<hr/>
<h3 data-id="heading-8">主入口实现细节（DDTabBar）</h3>
<ul>
<li>** 默认数据，缓存数据，接口数据 调用update时更新DDTabBarLiquidGlassView 和DDTabBarNormalView，更新时先判断内存中是否有该tab，只更新tab数据不影响飘红角标，没有则创建tab的view；</li>
<li>**更新前为每个 Item 设置暗黑图（<code>checkDataDark</code> / <code>uncheckDataDark</code> 按 itemType 取本地图名）。</li>
<li><strong>布局</strong>：<code>layoutSubviews</code> 中 <code>normalView.frame = bounds</code>、<code>liquidGlassView.frame = bounds</code>，两套视图始终叠在同一区域，通过 <code>isHidden</code> 切换显示。</li>
<li><strong>长辈版高度</strong>：<code>sizeThatFits</code> 在 <code>DDBasicInfoManager.shared.isAPVersion</code> 时高度 +17pt。</li>
</ul>
<hr/>
<h3 data-id="heading-9">普通样式（DDTabBarNormalView）</h3>
<h4 data-id="heading-10">视图层级与布局</h4>
<ul>
<li>
<p><strong>子视图顺序</strong>（自底向上）：<code>visualEffectView</code>（全 bounds）→ <code>backgroundImageView</code>（全 bounds）→ <code>contentView</code>（全 bounds）。</p>
</li>
<li>
<p><strong>Item 布局</strong>：全宽均分布局，<code>itemHeight</code> 默认 48。</p>
</li>
<li>
<p><strong>首页小火箭</strong>：对第一个 item 容器附加首页“小火箭”视图（<code>HomeTabBarItem</code>），用于首页特殊动效/回到顶部能力的承载。</p>
</li>
<li>
<p><strong>暗黑</strong>：不支持暗黑</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-11">液态玻璃样式（DDTabBarLiquidGlassView）</h3>
<h4 data-id="heading-12">1. 视觉与层级</h4>
<ul>
<li><strong>容器</strong>：圆角胶囊，宽度 <code>kScreenWidth - 30</code>，水平居中，高度 62pt（<code>containerH</code>）</li>
<li><strong>层级</strong>（自底向上）：
<ul>
<li><code>shadowView</code>：暗色模糊视图，用于阴影/暗黑增强</li>
<li><code>effectView</code>：使用系统新增的玻璃效果（<code>UIGlassEffect</code>），并开启交互能力（interactive）以获得更自然的玻璃触感与动态反馈）</li>
<li><code>contentView</code>：放置各个tabItem</li>
<li><code>segmentControl</code>：iOS 26<code>UISegmentedControl</code>具有点击拖动有放大镜效果，用于事件响应，UISegmentedControl有valueChanged，但我们还要求再次点击同一个item业务，切换到目标item时，若是拦截的需要把selectedSegmentIndex设置为上一个lastSelectedIndex</li>
</ul>
</li>
</ul>
<p>虽然给
<code>segmentControl.insertSegment(withTitle: "", at: idx, animated: false)</code></p>
<p>但仍需要设置，不然会有灰色的背景</p>
<pre><code class="hljs language-python" lang="python">DispatchQueue.main.<span class="hljs-keyword">async</span> {
            <span class="hljs-keyword">for</span> subview <span class="hljs-keyword">in</span> self.segmentControl.subviews {
                <span class="hljs-keyword">if</span> subview <span class="hljs-keyword">is</span> UIImageView &amp;&amp; subview != self.segmentControl.subviews.last {
                    subview.alpha = <span class="hljs-number">0</span>
                }
            }
        }
</code></pre>
<h4 data-id="heading-13">3. 暗黑与选中态</h4>
<ul>
<li><code>isCurrentShowDark</code> 控制：
<ul>
<li>选中槽背景色：暗黑时为 <code>RGBA(0x000000, 0.2)</code>，否则为 <code>gray.withAlphaComponent(0.15)</code></li>
<li>暗黑时显示 <code>shadowView</code>，非暗黑时隐藏</li>
</ul>
</li>
<li>Item 使用 <code>isSupportDark = true</code>，会使用模型中的 <code>checkDataDark</code> / <code>uncheckDataDark</code> 等暗黑资源。</li>
</ul>
<hr/>
<h3 data-id="heading-14">DDTabBarItemContentView</h3>
<h4 data-id="heading-15">ContentView（DDTabBarItemContentView）</h4>
<ul>
<li><strong>子视图</strong>：<code>iconImageView</code>（DDIconImageView，支持 Lottie/静图/Gif）、<code>titleLabel</code>、<code>businessBadgeView</code>（运营角标）、<code>badgeView</code>（数字/红点角标）。</li>
<li><strong>两种展示模式</strong>（<code>itemData.style</code>）：
<ul>
<li><strong>style 0（小图）</strong>：图片和文字的形式。</li>
<li><strong>style 1（大图）</strong>：只有一个大图；<code>titleLabel.isHidden = true</code>，<code>iconImageView.isHidden = false</code>。</li>
</ul>
</li>
<li><strong>选中/未选</strong>：根据 <code>selected</code> 与 <code>DDDarkModeManager.shared.isCurrentShowDark</code>、<code>isSupportDark</code> 选择 <code>checkResource</code>/<code>checkDataDark</code>、<code>uncheckResource</code>/<code>uncheckDataDark</code> 及对应文字颜色，调用 <code>iconImageView.setData(data:type:style)</code> 与 <code>iconImageView.play()</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-16">数据与展示</h3>
<h4 data-id="heading-17">1. 数据流概览</h4>
<ul>
<li><strong>配置来源</strong>：<code>DDTabBarManager.getTabBarConfigData(scene:parmars:aipComplet:)</code> 拉取接口，经 <code>TabBarResourceLoader</code> 下载图标/Lottie 后，由 <code>dealTabBarData</code> 更新 <code>tabBarModel</code> 并调用 <code>tabBar.update(data:items:)</code>。</li>
<li><strong>模型</strong>：
<ul>
<li><code>TabBarModel</code>：整条 Tab 配置（背景色/图、<code>bottom_list</code>、场景、来源等）</li>
<li><code>TabBarItemModel</code>：单个 Tab（类型、文案、选中/未选资源、链接、角标等）</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-18">与系统 UITabBar 的配合</h3>
<ul>
<li>
<p><code>DDTabBar</code> 作为自定义视图加在 TabBarController 的 tabBar 上，系统自带的 Tab 按钮需隐藏。代码中通过 <code>UITabBar</code> 的 extension 重写 <code>addGestureRecognizer</code>，对名为 <code>_UIContinuousSelectionGestureRecognizer</code> 的类禁用；</p>
</li>
<li>
<p>并暴露 <code>recursiveFindTabButtons(in:)</code>，递归查找 <code>_UITabBarButton</code> 与 <code>_UITabButton</code> 设为 <code>isHidden = true</code>，以及 <code>_UITabBarPlatterView</code> 隐藏，从而只展示自定义的 DDTabBar 内容。</p>
</li>
</ul>
<p>此处会对私有属性怎混淆处理</p>
<hr/>
<h3 data-id="heading-19">小结</h3>





























<table><thead><tr><th>能力</th><th>说明</th></tr></thead><tbody><tr><td>双样式</td><td>普通样式（全宽毛玻璃+背景）与液态玻璃样式（圆角胶囊 + iOS26 玻璃效果）</td></tr><tr><td>切换</td><td>由液态玻璃开关 + 是否长辈版决定，通过通知自动刷新</td></tr><tr><td>iOS 26</td><td>液态玻璃使用 <code>UIGlassEffect</code> + 染色层，暗黑下配合阴影与暗色选中槽</td></tr><tr><td>数据</td><td>接口 → TabBarModel/TabBarItemModel → 两套 View 同步更新与选中索引</td></tr><tr><td>埋点</td><td>点击/曝光均带 <code>liquidGlassState</code> 区分 liquid / other</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RadioIndication 的历史 - HIDL 时代就已存在]]></title>    <link>https://juejin.cn/post/7603444191447777314</link>    <guid>https://juejin.cn/post/7603444191447777314</guid>    <pubDate>2026-02-06T08:23:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603444191447777314" data-draft-id="7603383311530639375" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RadioIndication 的历史 - HIDL 时代就已存在"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T08:23:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RadioIndication 的历史 - HIDL 时代就已存在
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:23:21.000Z" title="Fri Feb 06 2026 08:23:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、时间线</h3>
<h4 data-id="heading-1">1. HIDL 时代（2016年起）</h4>
<p>RadioIndication 在 HIDL 时代就已存在，作为 IRadioIndication 接口的实现：</p>
<pre><code class="hljs language-1.0/IRadioIndication.hal" lang="1.0/IRadioIndication.hal">package android.hardware.radio@1.0;

interface IRadioIndication {
    oneway radioStateChanged(RadioIndicationType type, RadioState radioState);
    oneway callStateChanged(RadioIndicationType type);
    oneway networkStateChanged(RadioIndicationType type);
    // ... 更多回调方法
}
</code></pre>
<p>HIDL 版本的 RadioIndication 实现（用于测试）：</p>
<pre><code class="hljs language-412:462:hardware_interfaces/radio/1.0/vts/functional/radio_hidl_hal_utils_v1_0.h" lang="412:462:hardware_interfaces/radio/1.0/vts/functional/radio_hidl_hal_utils_v1_0.h">class RadioIndication : public IRadioIndication {
   protected:
    RadioHidlTest&amp; parent;

   public:
    RadioIndication(RadioHidlTest&amp; parent);
    virtual ~RadioIndication() = default;

    Return&lt;void&gt; radioStateChanged(RadioIndicationType type, RadioState radioState);
    Return&lt;void&gt; callStateChanged(RadioIndicationType type);
    Return&lt;void&gt; networkStateChanged(RadioIndicationType type);
    Return&lt;void&gt; newSms(RadioIndicationType type, const hidl_vec&lt;uint8_t&gt;&amp; pdu);
    // ...
}
</code></pre>
<h4 data-id="heading-2">2. HIDL 版本演进</h4>
<p>从 Android 7.0 到 12，HIDL 持续演进：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-symbol">IRadioIndication@</span><span class="hljs-number">1.0</span>  (<span class="hljs-number">2016</span>, Android <span class="hljs-number">7.0</span>)
<span class="hljs-symbol">IRadioIndication@</span><span class="hljs-number">1.1</span>  (<span class="hljs-number">2017</span>, Android <span class="hljs-number">8.0</span>)
<span class="hljs-symbol">IRadioIndication@</span><span class="hljs-number">1.2</span>  (<span class="hljs-number">2018</span>, Android <span class="hljs-number">9.0</span>)
<span class="hljs-symbol">IRadioIndication@</span><span class="hljs-number">1.3</span>  (<span class="hljs-number">2019</span>, Android <span class="hljs-number">10</span>)
<span class="hljs-symbol">IRadioIndication@</span><span class="hljs-number">1.4</span>  (<span class="hljs-number">2019</span>, Android <span class="hljs-number">10</span>)
<span class="hljs-symbol">IRadioIndication@</span><span class="hljs-number">1.5</span>  (<span class="hljs-number">2020</span>, Android <span class="hljs-number">11</span>)
<span class="hljs-symbol">IRadioIndication@</span><span class="hljs-number">1.6</span>  (<span class="hljs-number">2020</span>, Android <span class="hljs-number">12</span>)
</code></pre>
<h4 data-id="heading-3">3. AIDL 时代（从 Android 13 开始）</h4>
<p>Android 13 开始迁移到 AIDL，但为了兼容，系统提供了<strong>兼容层</strong>：</p>
<pre><code class="hljs language-33:243:hardware_interfaces/radio/aidl/compat/libradiocompat/include/libradiocompat/RadioIndication.h" lang="33:243:hardware_interfaces/radio/aidl/compat/libradiocompat/include/libradiocompat/RadioIndication.h">class RadioIndication : public V1_6::IRadioIndication {
    std::shared_ptr&lt;DriverContext&gt; mContext;

    // AIDL 回调接口
    GuaranteedCallback&lt;
        ::aidl::android::hardware::radio::data::IRadioDataIndication,
        ::aidl::android::hardware::radio::data::IRadioDataIndicationDefault, true&gt;
        mDataCb;
    GuaranteedCallback&lt;
        ::aidl::android::hardware::radio::messaging::IRadioMessagingIndication,
        ::aidl::android::hardware::radio::messaging::IRadioMessagingIndicationDefault, true&gt;
        mMessagingCb;
    // ... 更多 AIDL 回调接口
        
    // 继承自 HIDL V1.6 的方法实现
    Return&lt;void&gt; radioStateChanged(V1_0::RadioIndicationType type,
                                   V1_0::RadioState radioState) override;
    Return&lt;void&gt; callStateChanged(V1_0::RadioIndicationType type) override;
    // ...
}
</code></pre>
<h3 data-id="heading-4">二、HIDL vs AIDL 的核心区别</h3>



































<table><thead><tr><th>特性</th><th>HIDL</th><th>AIDL</th></tr></thead><tbody><tr><td><strong>定义语言</strong></td><td>HAL (Hardware Abstraction Language) - .hal文件</td><td>Android Interface Definition Language - .aidl文件</td></tr><tr><td><strong>版本管理</strong></td><td>内置版本控制 (@1.0, @1.1, ...)</td><td>接口版本字符串</td></tr><tr><td><strong>模块分裂</strong></td><td>单一 IRadioIndication 接口包含所有回调</td><td>拆分为多个独立接口：<br/>- IRadioDataIndication<br/>- IRadioMessagingIndication<br/>- IRadioModemIndication<br/>- IRadioNetworkIndication<br/>- IRadioSimIndication<br/>- IRadioVoiceIndication<br/>- IRadioImsIndication</td></tr><tr><td><strong>类型系统</strong></td><td>C++ 为主，类型映射复杂</td><td>Java 为主，更清晰的类型定义</td></tr><tr><td><strong>性能</strong></td><td>二进制协议</td><td>基于 Binder</td></tr></tbody></table>
<h3 data-id="heading-5">三、Java 层的 RadioIndication</h3>
<p>在 Java 层，只有 <strong>一个</strong> RadioIndication 实现（无论 HIDL 还是 AIDL）：</p>
<pre><code class="hljs language-126:148:frameworks_opt_telephony/src/java/com/android/internal/telephony/RadioIndication.java" lang="126:148:frameworks_opt_telephony/src/java/com/android/internal/telephony/RadioIndication.java">public class RadioIndication extends IRadioIndication.Stub {
    RIL mRil;

    RadioIndication(RIL ril) {
        mRil = ril;
    }

    public void radioStateChanged(int indicationType, int radioState) {
        mRil.processIndication(HAL_SERVICE_RADIO, indicationType);
        int state = RILUtils.convertHalRadioState(radioState);
        mRil.setRadioState(state, false);
    }

    public void callStateChanged(int indicationType) {
        // ...
    }
    // ... 所有其他回调方法
}
</code></pre>
<p>这个 Java RadioIndication 既兼容 HIDL 版本，也兼容 AIDL 版本。</p>
<h3 data-id="heading-6">四、AIDL 兼容层的作用</h3>
<p>在 AIDL 时代，C++ 兼容层将 HIDL 接口适配到 AIDL：</p>
<pre><code class="hljs language-59:76:hardware_interfaces/radio/aidl/compat/libradiocompat/modem/RadioIndication-modem.cpp" lang="59:76:hardware_interfaces/radio/aidl/compat/libradiocompat/modem/RadioIndication-modem.cpp">Return&lt;void&gt; RadioIndication::radioStateChanged(V1_0::RadioIndicationType t, 
                                                 V1_0::RadioState st) {
    LOG_CALL &lt;&lt; t;
    // 将 HIDL 的回调转发到 AIDL 的 mModemCb
    modemCb()-&gt;radioStateChanged(toAidl(t), aidl::RadioState(st));
    return {};
}

Return&lt;void&gt; RadioIndication::modemReset(V1_0::RadioIndicationType type, 
                                          const hidl_string&amp; reasn) {
    LOG_CALL &lt;&lt; type;
    modemCb()-&gt;modemReset(toAidl(type), reasn);
    return {};
}
</code></pre>
<h3 data-id="heading-7">五、RIL 指示的架构演变</h3>
<pre><code class="hljs language-css" lang="css">【HIDL 时代】                    【AIDL 时代】
IRadioIndication<span class="hljs-keyword">@1</span>.6      →      RadioIndication (兼容层)
├─ IRadioIndication                  ├─ IRadioDataIndication
├─ IRadioResponse                    ├─ IRadioMessagingIndication
└─ IRadio                            ├─ IRadioModemIndication
                                     ├─ IRadioNetworkIndication
                                     ├─ IRadioSimIndication
                                     ├─ IRadioVoiceIndication
                                     └─ IRadioImsIndication
</code></pre>
<h3 data-id="heading-8">总结</h3>
<ul>
<li><strong>RadioIndication 是 HIDL 时代的产物</strong>，从 Android 7.0 就开始使用</li>
<li><strong>AIDL 时代没有"新增"RadioIndication</strong>，而是通过<strong>兼容层</strong>继续使用</li>
<li><strong>AIDL 改变的是内部实现和模块分割</strong>，但对外部接口（Java RIL）的影响最小</li>
<li><strong>Java 层的 RadioIndication 保持不变</strong>，既支持 HIDL 也支持 AIDL</li>
</ul>
<p>这是 Android HAL 从 HIDL 迁移到 AIDL 的典型演变方式——通过兼容层保证向后兼容，同时新系统采用更现代的 AIDL 接口。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[移动数据始终开启功能]]></title>    <link>https://juejin.cn/post/7603376587651792946</link>    <guid>https://juejin.cn/post/7603376587651792946</guid>    <pubDate>2026-02-06T08:04:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603376587651792946" data-draft-id="7603321550246772786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="移动数据始终开启功能"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T08:04:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            移动数据始终开启功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:04:06.000Z" title="Fri Feb 06 2026 08:04:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. <strong>功能定义和原理</strong></h3>
<p>移动数据始终开启是一个系统设置，它允许移动数据连接在 WiFi 等高优先级网络活跃时<strong>继续保持连接和活跃</strong>。</p>
<pre><code class="hljs language-arduino" lang="arduino">工作模式：

关闭始终开启：
<span class="hljs-built_in">WiFi</span> 连接 → 移动数据自动断开 ✗
    
开启始终开启：
<span class="hljs-built_in">WiFi</span> 连接 + 移动数据 → 都保持连接 ✓
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li>更快的网络切换（两个网络都活跃）</li>
<li>应用可以在 WiFi 和移动数据间灵活切换</li>
<li>降低网络延迟和中断</li>
</ul>
<hr/>
<h3 data-id="heading-1">2. <strong>设置存储 (ConnectivitySettingsManager)</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 常量定义</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MOBILE_DATA_ALWAYS_ON</span> <span class="hljs-operator">=</span> <span class="hljs-string">"mobile_data_always_on"</span>;

<span class="hljs-comment">// 读取设置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getMobileDataAlwaysOn</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-type">boolean</span> def)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">enable</span> <span class="hljs-operator">=</span> Settings.Global.getInt(
            context.getContentResolver(), 
            MOBILE_DATA_ALWAYS_ON,      <span class="hljs-comment">// 全局设置键</span>
            (def ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>));              <span class="hljs-comment">// 默认值</span>
    <span class="hljs-keyword">return</span> (enable != <span class="hljs-number">0</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">// 写入设置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMobileDataAlwaysOn</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-type">boolean</span> enable)</span> {
    Settings.Global.putInt(
            context.getContentResolver(), 
            MOBILE_DATA_ALWAYS_ON, 
            (enable ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>));           <span class="hljs-comment">// 1 = 开启，0 = 关闭</span>
}
</code></pre>
<p><strong>存储位置：</strong></p>
<ul>
<li>数据库：<code>Settings.Global</code>（系统全局设置）</li>
<li>键：<code>mobile_data_always_on</code></li>
<li>值：0 (关闭) 或 1 (开启)</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. <strong>连接服务实现 (ConnectivityService)</strong></h3>
<h4 data-id="heading-3"><strong>核心组件</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 移动数据的"始终开启"网络请求</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> NetworkRequest mDefaultMobileDataRequest;

<span class="hljs-comment">// 该请求的信息</span>
<span class="hljs-comment">// 当设置为开启时，这个请求始终存在</span>
<span class="hljs-comment">// 当设置为关闭时，这个请求被撤销</span>
</code></pre>
<h4 data-id="heading-4"><strong>初始化流程</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建移动数据的始终开启请求</span>
mDefaultMobileDataRequest = createDefaultInternetRequestForTransport(
        NetworkCapabilities.TRANSPORT_CELLULAR,    <span class="hljs-comment">// 仅 4G/5G</span>
        NetworkRequest.Type.BACKGROUND_REQUEST);   <span class="hljs-comment">// 后台请求</span>

<span class="hljs-comment">// 在系统就绪时配置</span>
onSystemReady() {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// 根据设置创建网络请求</span>
    mHandler.sendMessage(mHandler.obtainMessage(EVENT_CONFIGURE_ALWAYS_ON_NETWORKS));
}
</code></pre>
<h4 data-id="heading-5"><strong>设置监听</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerSettingsCallbacks</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 监听 MOBILE_DATA_ALWAYS_ON 设置变更</span>
    mSettingsObserver.observe(
            Settings.Global.getUriFor(
                ConnectivitySettingsManager.MOBILE_DATA_ALWAYS_ON),
            EVENT_CONFIGURE_ALWAYS_ON_NETWORKS);  <span class="hljs-comment">// 触发重新配置</span>
    
    <span class="hljs-comment">// 监听 WiFi 始终请求设置</span>
    mSettingsObserver.observe(
            Settings.Global.getUriFor(
                ConnectivitySettingsManager.WIFI_ALWAYS_REQUESTED),
            EVENT_CONFIGURE_ALWAYS_ON_NETWORKS);
}
</code></pre>
<hr/>
<h3 data-id="heading-6">4. <strong>动态配置机制</strong></h3>
<h4 data-id="heading-7"><strong>配置处理 (handleConfigureAlwaysOnNetworks)</strong></h4>
<pre><code class="hljs language-scss" lang="scss">Setting 改变
        ↓
EVENT_CONFIGURE_ALWAYS_ON_NETWORKS
        ↓
<span class="hljs-built_in">handleConfigureAlwaysOnNetworks</span>()
        ├─ 检查 MOBILE_DATA_ALWAYS_ON 设置值
        ├─ 检查 WIFI_ALWAYS_REQUESTED 设置值
        └─ 检查 config_vehicleInternalNetworkAlwaysRequested 配置值
</code></pre>
<p><strong>核心代码：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleConfigureAlwaysOnNetworks</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 处理移动数据始终开启</span>
    handleAlwaysOnNetworkRequest(
            mDefaultMobileDataRequest,
            ConnectivitySettingsManager.MOBILE_DATA_ALWAYS_ON, 
            <span class="hljs-literal">true</span> <span class="hljs-comment">/* defaultValue */</span>);      <span class="hljs-comment">// 默认开启</span>
    
    <span class="hljs-comment">// 处理 WiFi 始终请求</span>
    handleAlwaysOnNetworkRequest(
            mDefaultWifiRequest,
            ConnectivitySettingsManager.WIFI_ALWAYS_REQUESTED,
            <span class="hljs-literal">false</span> <span class="hljs-comment">/* defaultValue */</span>);     <span class="hljs-comment">// 默认关闭</span>
    
    <span class="hljs-comment">// 处理车辆内部网络</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">vehicleAlwaysRequested</span> <span class="hljs-operator">=</span> mResources.get().getBoolean(
            R.bool.config_vehicleInternalNetworkAlwaysRequested);
    handleAlwaysOnNetworkRequest(mDefaultVehicleRequest, vehicleAlwaysRequested);
}
</code></pre>
<hr/>
<h3 data-id="heading-8">5. <strong>网络请求管理</strong></h3>
<h4 data-id="heading-9"><strong>启用始终开启 (设置 ON)</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleAlwaysOnNetworkRequest</span><span class="hljs-params">(
        NetworkRequest networkRequest, 
        <span class="hljs-type">boolean</span> enable)</span> {
    
    <span class="hljs-comment">// 检查请求是否已存在</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isEnabled</span> <span class="hljs-operator">=</span> (mNetworkRequests.get(networkRequest) != <span class="hljs-literal">null</span>);
    
    <span class="hljs-comment">// 如果状态已匹配，无需操作</span>
    <span class="hljs-keyword">if</span> (enable == isEnabled) {
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 启用：注册网络请求</span>
    <span class="hljs-keyword">if</span> (enable) {
        handleRegisterNetworkRequest(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequestInfo</span>(
                Process.myUid(),
                networkRequest,
                <span class="hljs-literal">null</span> <span class="hljs-comment">/* messenger */</span>,
                <span class="hljs-literal">null</span> <span class="hljs-comment">/* binder */</span>,
                NetworkCallback.FLAG_INCLUDE_LOCATION_INFO,
                <span class="hljs-literal">null</span> <span class="hljs-comment">/* attributionTags */</span>));
    } 
    <span class="hljs-comment">// 禁用：释放网络请求</span>
    <span class="hljs-keyword">else</span> {
        handleReleaseNetworkRequest(
                networkRequest, 
                Process.SYSTEM_UID,
                <span class="hljs-literal">false</span> <span class="hljs-comment">/* callOnUnavailable */</span>);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-10">6. <strong>完整执行流程</strong></h3>
<pre><code class="hljs language-scss" lang="scss">用户打开设置
        ↓
更改 MOBILE_DATA_ALWAYS_ON 为 ON
        ↓
调用 ConnectivitySettingsManager<span class="hljs-selector-class">.setMobileDataAlwaysOn</span>()
        ↓
Settings<span class="hljs-selector-class">.Global</span> 数据库更新
        ↓
ContentObserver 检测到变更
        ↓
发送 EVENT_CONFIGURE_ALWAYS_ON_NETWORKS
        ↓
<span class="hljs-built_in">handleConfigureAlwaysOnNetworks</span>()
        ↓
<span class="hljs-built_in">handleAlwaysOnNetworkRequest</span>(mDefaultMobileDataRequest, true)
        ↓
<span class="hljs-built_in">handleRegisterNetworkRequest</span>()
        ↓
在网络管理中注册 "CELLULAR + INTERNET" 请求
        ↓
ConnectivityService 确保移动数据网络始终活跃
        ↓
即使 WiFi 连接，移动数据仍保持活跃 ✓
</code></pre>
<hr/>
<h3 data-id="heading-11">7. <strong>网络请求类型详解</strong></h3>
<h4 data-id="heading-12"><strong>mDefaultMobileDataRequest 的特性</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建始终开启请求</span>
<span class="hljs-keyword">private</span> NetworkRequest <span class="hljs-title function_">createDefaultInternetRequestForTransport</span><span class="hljs-params">(
        <span class="hljs-type">int</span> transportType, 
        NetworkRequest.Type type)</span> {
    
    <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkCapabilities</span> <span class="hljs-variable">netCap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCapabilities</span>();
    netCap.clearAll();
    netCap.addCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET);
    netCap.addTransportType(NetworkCapabilities.TRANSPORT_CELLULAR);  <span class="hljs-comment">// 仅移动数据</span>
    netCap.setRequestorUidAndPackageName(Process.myUid(), mContext.getPackageName());
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>(netCap, TYPE_NONE, nextNetworkRequestId(), type);
}

<span class="hljs-comment">// 网络请求特性：</span>
<span class="hljs-comment">// - 类型：BACKGROUND_REQUEST（后台请求）</span>
<span class="hljs-comment">// - 优先级：低（不会抢占用户请求）</span>
<span class="hljs-comment">// - 持久性：始终存在（当设置开启时）</span>
<span class="hljs-comment">// - 作用：保持移动数据网络连接</span>
</code></pre>
<hr/>
<h3 data-id="heading-13">8. <strong>与其他功能的关系</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino">移动数据始终开启
        │
        ├─ <span class="hljs-built_in">WiFi</span> 始终请求 (WIFI_ALWAYS_REQUESTED)
        │   ├─ 类似机制，用于 <span class="hljs-built_in">WiFi</span> 网络
        │   └─ 优先级：<span class="hljs-built_in">WiFi</span> &gt; 移动数据
        │
        ├─ 网络请求 (NetworkRequest)
        │   ├─ 应用可以发起自己的网络请求
        │   └─ 系统基于优先级选择最优网络
        │
        └─ 网络切换 (Network Switching)
            ├─ 两个网络都活跃时更快切换
            └─ 应用可以在 <span class="hljs-built_in">WiFi</span>/移动数据间灵活选择
</code></pre>
<hr/>
<h3 data-id="heading-14">9. <strong>实际工作流程图</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino">网络状态变化时序：

事件 <span class="hljs-number">1</span>：只有移动数据连接
移动数据活跃 → 应用使用移动数据 ✓

事件 <span class="hljs-number">2</span>：<span class="hljs-built_in">WiFi</span> 连接上
│
├─ 移动数据始终开启 = OFF
│   → 移动数据断开 ✗
│   → 应用切换到 <span class="hljs-built_in">WiFi</span> ✓
│   → 网络切换延迟较大
│
└─ 移动数据始终开启 = ON
    → 移动数据保持连接 ✓
    → <span class="hljs-built_in">WiFi</span> 也连接 ✓
    → 应用可瞬间在两网间切换 ✓
    → 网络切换延迟极小

事件 <span class="hljs-number">3</span>：<span class="hljs-built_in">WiFi</span> 断开
│
├─ 移动数据始终开启 = OFF
│   → 移动数据已断开，需重新连接
│   → 恢复延迟：<span class="hljs-number">1</span><span class="hljs-number">-3</span> 秒
│
└─ 移动数据始终开启 = ON
    → 移动数据已保持连接
    → 恢复延迟：几毫秒 ✓
</code></pre>
<hr/>
<h3 data-id="heading-15">10. <strong>性能和电池影响</strong></h3>























<table><thead><tr><th>设置状态</th><th>电池消耗</th><th>网络延迟</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>关闭</strong></td><td>⬇️ 低</td><td>⬆️ 高（需重连）</td><td>省电，偶尔使用</td></tr><tr><td><strong>开启</strong></td><td>⬆️ 中等</td><td>⬇️ 低（已连接）</td><td>实时应用，视频通话</td></tr></tbody></table>
<p><strong>电池消耗主要来自：</strong></p>
<ul>
<li>保持无线电活跃</li>
<li>定期信号强度查询</li>
<li>网络数据包保活</li>
</ul>
<hr/>
<h3 data-id="heading-16">总结</h3>
<p>移动数据始终开启是一个<strong>智能网络管理</strong>功能：</p>
<ol>
<li><strong>存储层</strong>：全局设置 <code>MOBILE_DATA_ALWAYS_ON</code></li>
<li><strong>监听层</strong>：ContentObserver 监测设置变更</li>
<li><strong>请求层</strong>：通过 NetworkRequest 机制向 ConnectivityService 注册请求</li>
<li><strong>执行层</strong>：ConnectivityService 确保移动网络始终活跃</li>
<li><strong>结果</strong>：WiFi 和移动数据可同时连接，应用可无缝切换</li>
</ol>
<p>这个设计体现了 Android 系统<strong>模块化、事件驱动</strong>的架构特点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅学进程间通信4(Android Binder)]]></title>    <link>https://juejin.cn/post/7603301285475778602</link>    <guid>https://juejin.cn/post/7603301285475778602</guid>    <pubDate>2026-02-06T07:18:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603301285475778602" data-draft-id="7594682922685005833" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅学进程间通信4(Android Binder)"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-02-06T07:18:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="煤球王子"/> <meta itemprop="url" content="https://juejin.cn/user/4088439235949739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅学进程间通信4(Android Binder)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4088439235949739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    煤球王子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:18:21.000Z" title="Fri Feb 06 2026 07:18:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Binder 的基本原理</h2>
<p>网上有很多介绍Binder的文章，这里不过多介绍，
首先要明确一点 <code>Binder 是一个 RPC（Remote Procedure Call） 框架</code>，也就是说借助于 Binder，我们可以在 A 进程中访问 B 进程中的函数</p>
<blockquote>
<p>RPC 一般基于 IPC（Inter-Process Communication） 来实现的，IPC 就是跨进程数据传输(通信)</p>
</blockquote>
<p>Binder 的 RPC 是如何实现的：</p>
<p>一般来说，A 进程访问 B 进程函数，我们需要：</p>
<ul>
<li>
<p>在 A 进程中按照固定的规则打包数据，这些数据包含了：</p>
<ul>
<li>数据发给那个进程，Binder 中是一个整型变量 Handle</li>
<li>要调用目标进程中的那个函数，Binder 中用一个整型变量 Code 表示</li>
<li>目标函数的参数</li>
<li>要执行具体什么操作，也就是 Binder 协议</li>
</ul>
</li>
<li>
<p>进程 B 收到数据，按照固定的格式解析出数据，调用函数，并使用相同的格式将函数的返回值传递给进程 A。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17f684abd3e44907bad7316e8bde9f5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770967184&amp;x-signature=YCGXQwm3Q0bwTctYdZ9grZ2ORQk%3D" alt="binder_rpc.png" loading="lazy"/></p>
<h2 data-id="heading-1">Binder 应用层工作流程</h2>
<p>Binder 是一个 <strong>RPC</strong>（Remote Procedure Call） 框架，翻译成中文就是<strong>远程过程调用</strong>。也就是说通过 Binder：</p>
<ul>
<li>可以在 A 进程中访问 B 进程中定义的函数</li>
<li>进程 B 中的这些等待着被远程调用的函数的集合，我们称其为 Binder 服务（Binder Service）</li>
<li>进程 A 称之为 <strong><code>Binder 客户端（Binder Client）</code></strong> ，进程 B 称之为 <strong><code>Binder 服务端（Binder Server）</code></strong></li>
<li>通常，系统中的服务很多，我们需要一个管家来管理它们，<strong><code>服务管家（ServiceManager）</code></strong>  是 Android 系统启动时，启动的一个用于管理 <strong>Binder 服务（Binder Service）</strong>  的进程。通常，<strong>服务（Service）</strong>  需要事先注册到<strong>服务管家（ServiceManager）</strong> ，其他进程向<strong>服务管家（ServiceManager）</strong>  查询服务后才能使用服务。</li>
<li>Binder 的 RPC 能力通过 **<code>Binder 驱动</code>**实现</li>
</ul>
<p>通常一个完整的 Binder 程序涉及 4 个流程：</p>
<ol>
<li>在 Binder Server 端定义好服务</li>
<li>然后向 ServiceManager 注册服务</li>
<li>在 Binder Client 中向 ServiceManager 获取到服务</li>
<li>发起远程调用，调用 Binder Server 中定义好的服务</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/630bdb0c07ba4eeaaefa95872029f67e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770967184&amp;x-signature=vhbxb60eJG6SAgRoEXWIUBv2ZG8%3D" alt="binder概图.png" loading="lazy"/></p>
<p>学习与参考: <a href="https://link.juejin.cn?target=http%3A%2F%2Fahaoframework.tech%2Fpages%2F062131%2F%23_1-2-rpc-%25E5%258E%259F%25E7%2590%2586" target="_blank" title="http://ahaoframework.tech/pages/062131/#_1-2-rpc-%E5%8E%9F%E7%90%86" ref="nofollow noopener noreferrer">002.Binder 基本原理 | Ahao's Technical Blog</a></p>
<h2 data-id="heading-2">AIDL（Android Interface Definition Language）</h2>
<p><code>AIDL</code>(安卓接口定义语言) 是 Android 中最常用的跨进程通信机制，主要用于应用层进程间的通信。</p>
<p><strong>主要特点</strong></p>
<ul>
<li><strong>应用层IPC</strong>：主要用于应用之间的通信</li>
<li><strong>基于Binder</strong>：底层使用 Binder 机制</li>
<li><strong>支持复杂数据类型</strong>：基本类型、String、List、Map、Parcelable 对象等</li>
<li><strong>同步/异步调用</strong>：默认同步，可通过 oneway 实现异步</li>
</ul>
<p>Android的AIDL（Android接口定义语言）是一套完整的跨进程通信API体系。它不仅支持基础数据类型和接口回调，还提供了同步/异步调用、权限控制、服务管理等一系列核心功能。</p>
<h2 data-id="heading-3"><strong>核心API与关键概念</strong></h2>
<p>下表为你梳理了AIDL的核心功能模块：</p>



















































































































<table><thead><tr><th align="left">模块</th><th align="left">主要API/概念</th><th align="left">说明与用途</th></tr></thead><tbody><tr><td align="left"><strong>1. 接口定义</strong></td><td align="left"><strong>AIDL文件</strong> (<code>.aidl</code>)</td><td align="left">使用AIDL语法声明跨进程的接口契约。</td></tr><tr><td align="left"><strong>2. 核心通信对象</strong></td><td align="left"><strong><code>IBinder</code></strong></td><td align="left">所有IPC通信的底层句柄。<code>Service.onBind</code>返回它。</td></tr><tr><td align="left"/><td align="left"><strong><code>IInterface</code></strong></td><td align="left">所有AIDL接口的根基，定义了与<code>IBinder</code>交互的能力。</td></tr><tr><td align="left"/><td align="left"><strong><code>Binder</code> 类</strong></td><td align="left">服务端的基类，实现了<code>IBinder</code>，用于处理远程调用。</td></tr><tr><td align="left"/><td align="left"><strong><code>Stub</code> 类</strong> (抽象类)</td><td align="left">由AIDL编译器生成的服务器存根，继承自<code>Binder</code>并实现主接口。</td></tr><tr><td align="left"/><td align="left"><strong><code>Proxy</code> 类</strong> (内部类)</td><td align="left">由AIDL编译器生成的客户端代理，封装了跨进程调用序列化逻辑。</td></tr><tr><td align="left"><strong>3. 类型系统</strong></td><td align="left"><strong>基本类型</strong></td><td align="left"><code>int</code>, <code>long</code>, <code>char</code>, <code>boolean</code>, <code>double</code>, <code>byte</code>, <code>float</code>。</td></tr><tr><td align="left"/><td align="left"><strong><code>String</code></strong></td><td align="left">字符串，支持UTF-8编码。</td></tr><tr><td align="left"/><td align="left"><strong><code>CharSequence</code></strong></td><td align="left">可直接传递<code>SpannableString</code>等。</td></tr><tr><td align="left"/><td align="left"><strong><code>Parcelable</code></strong></td><td align="left">通过实现该接口，自定义可序列化的复杂对象。</td></tr><tr><td align="left"/><td align="left"><strong><code>List</code> / <code>Map</code></strong></td><td align="left">集合类型，其元素必须为AIDL支持的类型。</td></tr><tr><td align="left"/><td align="left"><strong>定向Tag</strong></td><td align="left"><code>in</code>(输入), <code>out</code>(输出), <code>inout</code>(双向)，修饰非基本类型参数。</td></tr><tr><td align="left"><strong>4. 接口回调</strong></td><td align="left"><strong><code>RemoteCallbackList</code></strong></td><td align="left">用于在服务端安全地管理并回调多个客户端监听器。</td></tr><tr><td align="left"><strong>5. 调用模式</strong></td><td align="left"><strong>同步调用</strong></td><td align="left">默认模式，客户端线程会阻塞直至服务端返回。</td></tr><tr><td align="left"/><td align="left"><strong>异步调用</strong></td><td align="left">使用<code>oneway</code>关键字修饰接口方法，调用不阻塞。</td></tr><tr><td align="left"><strong>6. 异常处理</strong></td><td align="left"><strong><code>RemoteException</code></strong></td><td align="left">所有跨进程调用都可能抛出的根异常，如进程死亡、通信失败等。</td></tr><tr><td align="left"/><td align="left"><strong><code>SecurityException</code></strong></td><td align="left">绑定服务或调用时，权限校验失败会抛出。</td></tr><tr><td align="left"><strong>7. 服务绑定</strong></td><td align="left"><strong><code>Service</code></strong></td><td align="left">承载AIDL接口的服务组件。</td></tr><tr><td align="left"/><td align="left"><strong><code>ServiceConnection</code></strong></td><td align="left">客户端用于监听与服务的连接状态。</td></tr><tr><td align="left"/><td align="left"><strong><code>bindService()</code> / <code>unbindService()</code></strong></td><td align="left">绑定与解绑服务的方法。</td></tr><tr><td align="left"/><td align="left"><strong><code>Context.BIND_AUTO_CREATE</code></strong></td><td align="left">绑定标志，服务不存在时自动创建。</td></tr></tbody></table>
<h3 data-id="heading-4">💻 <strong>深度解析与最佳实践</strong></h3>
<h4 data-id="heading-5"><strong>1. 通信核心：Binder、Stub与Proxy</strong></h4>
<p>这是AIDL工作的基石。服务端实现 <code>Stub</code>，客户端通过 <code>Proxy</code> 调用，两者通过Binder驱动进行数据交换。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 服务端实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IMyService.<span class="hljs-type">Stub</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IMyService</span>.Stub() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculate</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> <span class="hljs-keyword">throws</span> RemoteException {
            <span class="hljs-keyword">return</span> a + b;
        }
    };
    
  <span class="hljs-meta">@Override</span> 
  <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> { 
      <span class="hljs-keyword">return</span> binder; 
  }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 客户端调用</span>
<span class="hljs-type">ServiceConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceConnection</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceConnected</span><span class="hljs-params">(ComponentName name, IBinder service)</span> {
        <span class="hljs-comment">// 关键：将IBinder转换为接口代理对象</span>
        <span class="hljs-type">IMyService</span> <span class="hljs-variable">myService</span> <span class="hljs-operator">=</span> IMyService.Stub.asInterface(service);
        myService.calculate(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);
    }
};
</code></pre>
<h4 data-id="heading-6">2. 高级数据类型与方向Tag</h4>
<p><strong>Parcelable</strong> 是实现复杂数据传输的关键。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 定义 Parcelable 数据类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Parcelable</span> {
    <span class="hljs-keyword">public</span> String name;
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> id;
    <span class="hljs-comment">// ... 必须实现 writeToParcel, describeContents, CREATOR</span>
}

<span class="hljs-comment">// 2. 为 Parcelable 创建对应的 .aidl 文件 (User.aidl)</span>
<span class="hljs-comment">// parcelable User;</span>

<span class="hljs-comment">// 3. 在接口AIDL中引用</span>
<span class="hljs-comment">// import com.example.User; // 显式导入</span>
<span class="hljs-comment">// void updateUser(in User user);</span>
</code></pre>
<p><strong>方向Tag (<code>in</code>, <code>out</code>, <code>inout</code>)</strong> 直接影响性能和逻辑：</p>
<ul>
<li><code>in</code>：数据从客户端流向服务端，服务端修改不会影响客户端对象。</li>
<li><code>out</code>：对象从服务端“返回”给客户端。客户端传入的对象字段不会被发送，但服务端可以创建或修改对象并传回。</li>
<li><code>inout</code>：双向传输，开销最大，应谨慎使用。
方向修饰符（仅对 “非基本类型 &amp; 非 String/CharSequence” 参数生效）</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">printUser</span>(<span class="hljs-params"><span class="hljs-keyword">in</span> User u</span>)</span>; <span class="hljs-comment">// 客户端把 User 序列化传过来  </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">fillUser</span>(<span class="hljs-params"><span class="hljs-keyword">out</span> User u</span>)</span>; <span class="hljs-comment">// 服务端 new 一个 User 写回去  </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">updateUser</span>(<span class="hljs-params">inout User u</span>)</span>; <span class="hljs-comment">// 两端都可改</span>
</code></pre>
<h4 data-id="heading-7">3. 管理接口回调：RemoteCallbackList</h4>
<p>在服务端，不能直接保存客户端传来的 <code>IBinder</code> 回调接口，因为Binder对象可能因进程死亡而失效。<code>RemoteCallbackList</code> 能自动管理这种生命周期。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RemoteCallbackList&lt;ICallback&gt; callbackList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteCallbackList</span>&lt;&gt;();

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IMyService.<span class="hljs-type">Stub</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IMyService</span>.Stub() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerCallback</span><span class="hljs-params">(ICallback cb)</span> {
            callbackList.register(cb);
        }
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unregisterCallback</span><span class="hljs-params">(ICallback cb)</span> {
            callbackList.unregister(cb);
        }
    };

    <span class="hljs-comment">// 向所有客户端广播事件</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">broadcastEvent</span><span class="hljs-params">(String event)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> callbackList.beginBroadcast();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; i++) {
            <span class="hljs-keyword">try</span> {
                callbackList.getBroadcastItem(i).onEvent(event);
            } <span class="hljs-keyword">catch</span> (RemoteException e) {
                <span class="hljs-comment">// 客户端可能已死亡，忽略</span>
            }
        }
        callbackList.finishBroadcast();
    }
}
</code></pre>
<h4 data-id="heading-8">4. 同步 (<code>two-way</code>) 与异步 (<code>oneway</code>)</h4>
<ul>
<li><strong>同步</strong>：客户端线程会阻塞，适用于需要立即结果的调用。</li>
<li><strong>异步</strong>：在接口方法前加 <code>oneway</code> 关键字，不等待返回，也没有返回值。适用于通知型操作，能有效避免客户端阻塞，但需注意其“至多一次 (at-most-once)”的语义，调用可能因进程死亡而丢失。</li>
</ul>
<pre><code class="hljs language-aidl" lang="aidl">// 同步方法
int calculate(in int a, in int b);

// 异步方法（无返回值，不抛RemoteException）
oneway void notifySomethingHappened(in String event);
</code></pre>
<h4 data-id="heading-9">5. 权限控制与安全</h4>
<p>可在 <code>AndroidManifest.xml</code> 中为服务声明自定义权限，并在 <code>onBind</code> 或具体方法内校验。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">service</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">".MyService"</span>
    <span class="hljs-attr">android:permission</span>=<span class="hljs-string">"com.example.MY_PERMISSION"</span>
    <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"true"</span>&gt;</span> <span class="hljs-comment">&lt;!-- 允许其他应用绑定 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">service</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在服务端的onBind或方法实现中校验</span>
<span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> {
    <span class="hljs-keyword">if</span> (checkCallingOrSelfPermission(<span class="hljs-string">"com.example.MY_PERMISSION"</span>) 
        != PackageManager.PERMISSION_GRANTED) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 绑定失败</span>
    }
    <span class="hljs-keyword">return</span> binder;
}
</code></pre>
<h3 data-id="heading-10">🎯 <strong>性能与稳定性最佳实践</strong></h3>
<ol>
<li><strong>减少跨进程调用次数</strong>：设计接口时，尽量将多个操作合并为一次调用（如传递一个<code>User</code>对象，而非多次调用设置<code>name</code>、<code>id</code>）。</li>
<li><strong>注意线程模型</strong>：AIDL调用在服务端默认运行在 <strong>Binder线程池</strong> 中（非主线程），因此需要进行线程同步。使用 <code>oneway</code> 调用时，服务端方法仍会在Binder线程池中执行。</li>
<li><strong>妥善处理 <code>RemoteException</code></strong>：所有跨进程调用都必须捕获此异常，它意味着连接已断开。</li>
<li><strong>及时解绑</strong>：在客户端（如<code>Activity</code>）的 <code>onDestroy</code> 中调用 <code>unbindService</code>，防止内存泄漏。</li>
<li><strong>接口版本兼容</strong>：为已发布的AIDL接口添加新方法时，考虑向后兼容，例如使用默认实现或版本号协商。</li>
</ol>
<h2 data-id="heading-11">Demo 示例</h2>
<p>IRemoteService.aidl</p>
<pre><code class="hljs language-csharp" lang="csharp">package com.example.aidl;
import com.example.aidl.User;   <span class="hljs-comment">// 自定义 Parcelable</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title">IRemoteService</span> {
    <span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">add</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b</span>)</span>;                <span class="hljs-comment">// 基本类型</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">printUser</span>(<span class="hljs-params"><span class="hljs-keyword">in</span> User u</span>)</span>;            <span class="hljs-comment">// in 方向</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getUser</span>(<span class="hljs-params"><span class="hljs-keyword">out</span> User u</span>)</span>;             <span class="hljs-comment">// out 方向</span>
    <span class="hljs-function">oneway <span class="hljs-keyword">void</span> <span class="hljs-title">fireCallback</span>()</span>;           <span class="hljs-comment">// 非阻塞</span>
}
</code></pre>
<p>User.aidl</p>
<pre><code class="hljs language-ini" lang="ini">package com.example.aidl<span class="hljs-comment">;</span>
parcelable User<span class="hljs-comment">;</span>
</code></pre>
<p>服务端实现</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IRemoteService.<span class="hljs-type">Stub</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IRemoteService</span>.Stub() {
    
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> { <span class="hljs-keyword">return</span> a + b; }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printUser</span><span class="hljs-params">(User u)</span> { Log.d(<span class="hljs-string">"AIDL"</span>, u.name); }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getUser</span><span class="hljs-params">(User u)</span> {
            u.name = <span class="hljs-string">"server"</span>; u.age = <span class="hljs-number">18</span>;   <span class="hljs-comment">// 填充 out 参数</span>
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fireCallback</span><span class="hljs-params">()</span> { <span class="hljs-comment">/* 单向，无返回 */</span> }
    };
    
    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent i)</span> { <span class="hljs-keyword">return</span> binder; }
}
</code></pre>
<p>客户端调用</p>
<pre><code class="hljs language-ini" lang="ini">IRemoteService <span class="hljs-attr">s</span> = IRemoteService.Stub.asInterface(service)<span class="hljs-comment">;</span>
int <span class="hljs-attr">r</span> = s.add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Rust + Bevy 打造修仙卡牌游戏：从零上架 Windows 商店的技术复盘]]></title>    <link>https://juejin.cn/post/7603314759758200851</link>    <guid>https://juejin.cn/post/7603314759758200851</guid>    <pubDate>2026-02-06T07:31:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603314759758200851" data-draft-id="7603352061506273286" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Rust + Bevy 打造修仙卡牌游戏：从零上架 Windows 商店的技术复盘"/> <meta itemprop="keywords" content="Rust,游戏开发"/> <meta itemprop="datePublished" content="2026-02-06T07:31:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="peterfei"/> <meta itemprop="url" content="https://juejin.cn/user/2700056287782663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Rust + Bevy 打造修仙卡牌游戏：从零上架 Windows 商店的技术复盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700056287782663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    peterfei
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:31:40.000Z" title="Fri Feb 06 2026 07:31:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4be013d0dfb454d99164212a7b954c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGV0ZXJmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770972870&amp;x-signature=FVZ3zP4Bgv%2Bfb6ufcGcqhVZ5xig%3D" alt="4v63r2n7b1rmt0cw3getasz2q8_result_.gif" loading="lazy"/></p>
<blockquote>
<p>一名独立开发者如何用 Rust 和 Bevy 引擎，打造出拥有四相位终极特效的修仙肉鸽卡牌游戏《九界：渡劫》，并成功登陆 Windows 商店。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、项目缘起：为什么选择 Rust + Bevy？</h2>
<p>作为一名技术博主，我一直想挑战游戏开发。当决定要做一款修仙题材的肉鸽卡牌游戏时，我面临一个关键选择：用什么技术栈？</p>
<p>Unity？太重，而且个人版有启动画面限制。Godot？学习曲线尚可，但性能调优不够透明。最终，我选择了 <strong>Rust + Bevy 0.15</strong>，这个决定让我受益匪浅。</p>
<h3 data-id="heading-1">为什么是 Rust？</h3>
<ul>
<li><strong>内存安全</strong>：不用担心悬垂指针和内存泄漏</li>
<li><strong>零成本抽象</strong>：高级特性不会带来运行时开销</li>
<li><strong>生态活跃</strong>：crates.io 上有丰富的游戏开发库</li>
</ul>
<h3 data-id="heading-2">为什么是 Bevy？</h3>
<ul>
<li><strong>ECS 架构</strong>：数据驱动的实体组件系统，性能卓越</li>
<li><strong>热重载开发</strong>：代码改动即时生效，开发体验丝滑</li>
<li><strong>现代渲染</strong>：基于 WGPU，跨平台支持优秀</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、项目架构：模块化设计全览</h2>
<pre><code class="hljs language-bash" lang="bash">bevy-card-battler/
├── src/
│   ├── main.rs          <span class="hljs-comment"># 主入口，窗口初始化</span>
│   ├── lib.rs           <span class="hljs-comment"># 库入口，模块导出</span>
│   ├── components/      <span class="hljs-comment"># 组件定义</span>
│   ├── systems/         <span class="hljs-comment"># 系统实现</span>
│   ├── plugins/         <span class="hljs-comment"># 插件封装</span>
│   ├── resources/       <span class="hljs-comment"># 全局资源</span>
│   └── states/          <span class="hljs-comment"># 游戏状态</span>
├── assets/              <span class="hljs-comment"># 游戏资源</span>
├── tests/               <span class="hljs-comment"># 集成测试</span>
└── docs/                <span class="hljs-comment"># 技术文档</span>
</code></pre>
<p><strong>核心设计原则</strong>：</p>
<ol start="0">
<li><strong>插件化</strong>：每个功能模块都是独立 Plugin</li>
<li><strong>状态驱动</strong>：使用 Bevy State 管理游戏流程</li>
<li><strong>资源池化</strong>：纹理、材质统一管理</li>
</ol>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a67707d0a23439f8960fccab6a98e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGV0ZXJmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770972870&amp;x-signature=Zifx%2BullezMIzi8ztGijslhTuEU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">三、核心亮点：万剑归宗四相位特效</h2>
<p>这是游戏最震撼的技能特效，我将其拆分为四个艺术相位：</p>
<h3 data-id="heading-5">第一相位：万剑齐鸣 (0% ~ 20%)</h3>
<p>飞剑从虚空中"撕裂"而出，斜插向天际。核心是<strong>后坐力算法</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">// 先沉一下，再极速弹射
let <span class="hljs-attr">progress</span> = strike_t / <span class="hljs-number">0.2</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">recoil</span> = if progress &lt; <span class="hljs-number">0.3</span> {
    -30.0 * (progress / 0.3)  // 下沉
} else {
    -30.0 + 350.0 * ((progress - 0.3) / 0.7)  // 弹射
}<span class="hljs-comment">;</span>
<span class="hljs-attr">p.position.y</span> = start_y + recoil<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-6">第二相位：八卦剑轮 (20% ~ 45%)</h3>
<p>立体三层圆锥形剑阵，每层有不同的旋转速度和呼吸节奏：</p>
<pre><code class="hljs language-ini" lang="ini">// 三层圆锥结构
for layer in 0..3 {
    let <span class="hljs-attr">base_angle</span> = layer_angle * layer as f32<span class="hljs-comment">;</span>
    let <span class="hljs-attr">radius</span> = layer_radius * (layer + <span class="hljs-number">1</span>) as f32<span class="hljs-comment">;</span>
​
    // 呼吸颤动效果
    let <span class="hljs-attr">breathing</span> = (time * <span class="hljs-number">8.0</span> + layer as f32).sin() * <span class="hljs-number">15.0</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">p.position.x</span> = center_x + (angle + breathing).cos() * radius<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-7">第三相位：瞬狱锁定 (45% ~ 55%)</h3>
<p>全屏突然静止，飞剑调头指向敌人，背景变暗。关键是<strong>减速曲线</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">// 3次贝塞尔减速
let <span class="hljs-attr">ease_t</span> = cubic_bezier((strike_t - <span class="hljs-number">0.45</span>) / <span class="hljs-number">0.1</span>)<span class="hljs-comment">;</span>
let <span class="hljs-attr">slowdown</span> = <span class="hljs-number">1.0</span> - ease_t * <span class="hljs-number">0.95</span><span class="hljs-comment">;  // 降至 5% 速度</span>
p.velocity *= slowdown<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-8">第四相位：极速穿心 (55% ~ 100%)</h3>
<p>极长残影流光，切向突刺。使用<strong>三次贝塞尔曲线</strong>实现轨迹：</p>
<pre><code class="hljs language-ini" lang="ini">// 贝塞尔曲线轨迹
let <span class="hljs-attr">p0</span> = current_pos<span class="hljs-comment">;</span>
let <span class="hljs-attr">p1</span> = current_pos + tangent * <span class="hljs-number">200.0</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">p2</span> = enemy_pos - tangent * <span class="hljs-number">100.0</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">p3</span> = enemy_pos<span class="hljs-comment">;</span>
​
let <span class="hljs-attr">t</span> = (strike_t - <span class="hljs-number">0.55</span>) / <span class="hljs-number">0.45</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">curve_pos</span> = cubic_bezier_point(p0, p1, p2, p3, t)<span class="hljs-comment">;</span>
<span class="hljs-attr">p.position</span> = curve_pos<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">四、程序化粒子系统：告别美术资源依赖</h2>
<p>传统游戏开发需要美术提供大量粒子贴图，我用<strong>程序化生成</strong>解决了这个问题：</p>
<h3 data-id="heading-10">水墨写意晕染贴图</h3>
<pre><code class="hljs language-ini" lang="ini">// 运行时生成 128x128 晕染贴图
for y in 0..height {
    for x in 0..width {
        let <span class="hljs-attr">dx</span> = x as f32 - <span class="hljs-number">63.5</span><span class="hljs-comment">;</span>
        let <span class="hljs-attr">dy</span> = y as f32 - <span class="hljs-number">63.5</span><span class="hljs-comment">;</span>
        let <span class="hljs-attr">dist</span> = (dx*dx + dy*dy).sqrt() / <span class="hljs-number">64.0</span><span class="hljs-comment">;</span>
​
        // 边缘扰动模拟自然墨迹
        let <span class="hljs-attr">angle</span> = dy.atan2(dx)<span class="hljs-comment">;</span>
        let <span class="hljs-attr">noise</span> = (angle * <span class="hljs-number">4.0</span>).sin() * <span class="hljs-number">0.12</span>
                  + (angle * 7.0).cos() * 0.08<span class="hljs-comment">;</span>
​
        let <span class="hljs-attr">alpha</span> = (<span class="hljs-number">1.0</span> - dist * dist).powi(<span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
        data<span class="hljs-section">[idx + 3]</span> = (alpha * 255.0) as u8<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-11">灵气烧灼特效（雷击）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 多层频率噪声模拟雷击分叉</span>
let noise = (angle * <span class="hljs-number">5.0</span>)<span class="hljs-selector-class">.sin</span>() * <span class="hljs-number">0.15</span>
          + (angle * <span class="hljs-number">13.0</span>)<span class="hljs-selector-class">.cos</span>() * <span class="hljs-number">0.07</span>
          + (angle * <span class="hljs-number">27.0</span>)<span class="hljs-selector-class">.sin</span>() * <span class="hljs-number">0.03</span>;
​
<span class="hljs-comment">// 中心深紫，向外烟熏扩散</span>
scorch_data<span class="hljs-selector-attr">[i]</span> = (intensity.powf(<span class="hljs-number">2.5</span>) * <span class="hljs-number">40.0</span>) as u8;   <span class="hljs-comment">// R</span>
scorch_data<span class="hljs-selector-attr">[i+1]</span> = (intensity.powf(<span class="hljs-number">3.0</span>) * <span class="hljs-number">15.0</span>) as u8; <span class="hljs-comment">// G</span>
scorch_data<span class="hljs-selector-attr">[i+2]</span> = (intensity.powf(<span class="hljs-number">1.8</span>) * <span class="hljs-number">70.0</span>) as u8; <span class="hljs-comment">// B</span>
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>零美术依赖，全代码生成</li>
<li>动态调整参数，即时预览</li>
<li>体积小，整包仅 50MB</li>
</ul>
<hr/>
<h2 data-id="heading-12">五、AI 模型集成：固有偏差补偿机制</h2>
<p>游戏中的 3D 角色模型使用 AI 生成，但 AI 模型存在<strong>固有朝向偏差</strong>。我实现了一套实时补偿算法：</p>
<pre><code class="hljs language-ini" lang="ini">// 检测玩家与敌人的相对位置
let <span class="hljs-attr">to_enemy</span> = (enemy_pos - player_pos).normalize()<span class="hljs-comment">;</span>
let <span class="hljs-attr">to_enemy_angle</span> = to_enemy.y.atan2(to_enemy.x)<span class="hljs-comment">;</span>
​
// 应用固有偏差补偿（AI 模型特性）
const BIAS_COMPENSATION: <span class="hljs-attr">f32</span> = std::f32::consts::PI / <span class="hljs-number">2.0</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">target_angle</span> = to_enemy_angle + BIAS_COMPENSATION<span class="hljs-comment">;</span>
​
// 平滑旋转插值
<span class="hljs-attr">transform.rotation</span> = Quat::from_rotation_z(
    lerp_angle(current_angle, target_angle, 0.15)
)<span class="hljs-comment">;</span>
</code></pre>
<p>这样确保角色始终正确朝向敌人，不受 AI 模型原始朝向影响。</p>
<hr/>
<h2 data-id="heading-13">六、TDD 开发实践：17/17 测试全覆盖</h2>
<p>为了确保特效质量，我采用 TDD（测试驱动开发）模式：</p>
<h3 data-id="heading-14">测试覆盖矩阵</h3>








































<table><thead><tr><th>测试类型</th><th>用例数</th><th>覆盖内容</th></tr></thead><tbody><tr><td>时间区间验证</td><td>4</td><td>四相位边界检测</td></tr><tr><td>后坐力函数</td><td>2</td><td>沉降弹射曲线</td></tr><tr><td>圆锥结构</td><td>2</td><td>三层螺旋排列</td></tr><tr><td>呼吸颤动</td><td>2</td><td>正弦波偏移</td></tr><tr><td>NaN 防护</td><td>4</td><td>边界值保护</td></tr><tr><td>位置验证</td><td>3</td><td>坐标有效性</td></tr></tbody></table>
<h3 data-id="heading-15">关键 Bug 修复</h3>
<p><strong>Bug #1: 负数 delay 导致 NaN</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// ❌ 问题代码</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">delay</span> = <span class="hljs-number">0.06</span> - (i <span class="hljs-keyword">as</span> <span class="hljs-type">f32</span> * <span class="hljs-number">0.015</span>);  <span class="hljs-comment">// i=11 时 = -0.105</span>
​
<span class="hljs-comment">// ✅ 修复方案</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">delay</span> = (<span class="hljs-number">0.06</span> - (i <span class="hljs-keyword">as</span> <span class="hljs-type">f32</span> * <span class="hljs-number">0.015</span>)).<span class="hljs-title function_ invoke__">max</span>(<span class="hljs-number">0.0</span>);
</code></pre>
<p><strong>Bug #2: 实体删除后仍更新 Transform</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ❌ 错误顺序</span>
if <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.is_dead</span>() {
    commands<span class="hljs-selector-class">.entity</span>(entity)<span class="hljs-selector-class">.despawn_recursive</span>();
}
<span class="hljs-comment">// ... 后续代码仍尝试访问 entity</span>
​
<span class="hljs-comment">// ✅ 正确顺序</span>
<span class="hljs-comment">// 先更新 Transform</span>
if let <span class="hljs-built_in">Some</span>(mut ec) = commands<span class="hljs-selector-class">.get_entity</span>(entity) {
    ec<span class="hljs-selector-class">.insert</span>(Transform::from_rotation(...));
}
<span class="hljs-comment">// 再检查死亡</span>
if <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.is_dead</span>() {
    commands<span class="hljs-selector-class">.entity</span>(entity)<span class="hljs-selector-class">.despawn_recursive</span>();
}
</code></pre>
<hr/>
<h2 data-id="heading-16">七、Windows 商店上架经验</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b504cba02f4432fb327d2d5c0bfcbc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGV0ZXJmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770972870&amp;x-signature=pde7AjhaYUQ42PNcueL25BiM1xo%3D" alt="屏幕截图(1).png" loading="lazy"/></p>
<h3 data-id="heading-17">打包配置</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Cargo.toml</span>
<span class="hljs-section">[profile.release]</span>
<span class="hljs-attr">opt-level</span> = <span class="hljs-number">3</span>      <span class="hljs-comment"># 最高优化</span>
<span class="hljs-attr">lto</span> = <span class="hljs-string">"fat"</span>        <span class="hljs-comment"># 链接时优化</span>
<span class="hljs-attr">codegen-units</span> = <span class="hljs-number">1</span>  <span class="hljs-comment"># 单编译单元</span>
<span class="hljs-attr">strip</span> = <span class="hljs-literal">true</span>       <span class="hljs-comment"># 去除调试符号</span>
</code></pre>
<h3 data-id="heading-18">MSIX 打包脚本</h3>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># build_msix.bat</span>
cargo build --release
makemsix <span class="hljs-keyword">pack</span> ...
</code></pre>
<h3 data-id="heading-19">上架清单</h3>
<ul>
<li>✅ 应用图标（多尺寸）</li>
<li>✅ 截图（4-8 张）</li>
<li>✅ 隐私政策（本地存储声明）</li>
<li>✅ 内容评级</li>
<li>✅ 年龄分级</li>
</ul>
<hr/>
<h2 data-id="heading-20">八、性能优化技巧</h2>
<h3 data-id="heading-21">1. 精准控制 Bevy 特性</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 移除默认特性，按需加载</span>
<span class="hljs-attr">bevy</span> = { version = <span class="hljs-string">"0.15"</span>, default-features = <span class="hljs-literal">false</span>, features = [
    <span class="hljs-string">"animation"</span>, <span class="hljs-string">"bevy_asset"</span>, <span class="hljs-string">"bevy_audio"</span>, <span class="hljs-string">"bevy_render"</span>,
    <span class="hljs-string">"multi_threaded"</span>, <span class="hljs-string">"png"</span>, <span class="hljs-string">"jpeg"</span>, <span class="hljs-string">"vorbis"</span>, <span class="hljs-string">"mp3"</span>,
    <span class="hljs-string">"tonemapping_luts"</span>, <span class="hljs-string">"bevy_pbr"</span>, <span class="hljs-string">"bevy_picking"</span>, <span class="hljs-string">"bevy_state"</span>
] }
</code></pre>
<h3 data-id="heading-22">2. 渲染设置优化</h3>
<pre><code class="hljs language-c" lang="c">RenderPlugin {
    render_creation: WgpuSettings {
        power_preference: PowerPreference::HighPerformance,
        ..<span class="hljs-keyword">default</span>()
    }.into(),
    ..<span class="hljs-keyword">default</span>()
}
</code></pre>
<h3 data-id="heading-23">3. 日志系统分层</h3>
<pre><code class="hljs language-css" lang="css">// 文件 + 控制台双层日志
let file_appender = RollingFileAppender::<span class="hljs-built_in">new</span>(Rotation::DAILY, &amp;log_dir, <span class="hljs-string">"jiujie.log"</span>);
let <span class="hljs-attribute">filter</span> = EnvFilter::<span class="hljs-built_in">try_from_default_env</span>()
    .<span class="hljs-built_in">unwrap_or_else</span>(|_| <span class="hljs-string">"wgpu=error,bevy=info,jiujie=debug"</span>.<span class="hljs-built_in">into</span>());
</code></pre>
<hr/>
<h2 data-id="heading-24">九、技术栈总结</h2>








































<table><thead><tr><th>技术</th><th>版本</th><th>用途</th></tr></thead><tbody><tr><td>Rust</td><td>2021 Edition</td><td>核心语言</td></tr><tr><td>Bevy</td><td>0.15</td><td>游戏引擎</td></tr><tr><td>rand</td><td>0.8</td><td>随机数生成</td></tr><tr><td>serde</td><td>1.0</td><td>序列化</td></tr><tr><td>image</td><td>0.25</td><td>图像处理</td></tr><tr><td>winit</td><td>0.30</td><td>窗口管理</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-25">十、未来规划</h2>
<ul>
<li>移植到 Steam 平台</li>
<li>添加云存档同步</li>
<li>实现成就系统</li>
<li>支持模组加载</li>
<li>推出 Linux 版本</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-232 离线数仓Hive 离线数仓新增与留存计算：DWS 明细 + ADS 汇总一套跑通]]></title>    <link>https://juejin.cn/post/7603309951227215922</link>    <guid>https://juejin.cn/post/7603309951227215922</guid>    <pubDate>2026-02-06T08:18:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951227215922" data-draft-id="7603393977477038106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-232 离线数仓Hive 离线数仓新增与留存计算：DWS 明细 + ADS 汇总一套跑通"/> <meta itemprop="keywords" content="后端,大数据,Apache Hive"/> <meta itemprop="datePublished" content="2026-02-06T08:18:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-232 离线数仓Hive 离线数仓新增与留存计算：DWS 明细 + ADS 汇总一套跑通
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:18:26.000Z" title="Fri Feb 06 2026 08:18:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：离线数仓按天计算“新增会员”，并为后续“会员留存”提供口径一致的数据底座</li>
<li>结论：用“全量会员表(含首日dt)”做去重锚点，DWS 产新增明细，ADS 产新增计数，脚本串行即可</li>
<li>产出：可复用的 Hive SQL/脚本模板：新增识别（left join is null）+ 会员全量表增量维护 + 每日新增指标表</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37b66db62d09440083a0f943624ec51e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=Pfb9ECM147qA4yCMTTQUf%2ByLcRI%3D" alt="大数据-232 离线数仓Hive 离线数仓新增会员与留存计算：DWS 明细 + ADS 汇总一套跑通" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56e62770ac3c4c259c9a549a1e3c5200~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=S6mtWywl%2Bgxdh7gIlVVrxMS2AjQ%3D" alt="离线数仓架构图" loading="lazy"/></p>
<h2 data-id="heading-1">新增会员</h2>
<ul>
<li>留存会员：某段时间的新增会员，经过一段时间后，仍然使用应用认为是留存的会员。</li>
<li>新增会员：第一次使用应用的用户，定义为新增会员，卸载再次安装的设备，不会被算作是新增用户</li>
</ul>
<p>新增会员先计算 =&gt; 计算会员留存</p>
<h3 data-id="heading-2">需求描述</h3>
<p>每日新增会员数
08-02：DWD，会员每日启动明细（95-110）；所有会员信息（1-100）</p>
<ul>
<li>新增会员 101-110</li>
<li>新增会员数据+旧的会员的信息 = 新的所有会员信息（1-110）</li>
</ul>
<p>08-03：DWD，会员每日启动明细（100-120）；所有会员的信息（1-110）</p>
<ul>
<li>新增会员：111-120</li>
<li>新增会员数据 + 旧的所有会员的信息 = 新的所有会员的信息（1-120）</li>
</ul>
<p>计算步骤：</p>
<ul>
<li>计算新增会员</li>
<li>更新所有会员信息</li>
</ul>
<p>改进后方法：</p>
<ul>
<li>在所有会员信息中增加时间列，表示这个会员是哪一天成为新增会员</li>
<li>只需要一张表：所有会员的信息（id，dt）</li>
<li>将新增会员插入所有会员表中</li>
</ul>
<h3 data-id="heading-3">案例：如何计算新增会员</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- t1.dat 的数据如下</span>
<span class="hljs-number">4</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-02</span>
<span class="hljs-number">5</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-02</span>
<span class="hljs-number">6</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-02</span>
<span class="hljs-number">7</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-02</span>
<span class="hljs-number">8</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-02</span>
<span class="hljs-number">9</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-02</span>

<span class="hljs-comment">-- 日启动表 =&gt; DWS</span>
<span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> t1;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t1(id <span class="hljs-type">int</span>, dt string) <span class="hljs-type">row</span> format delimited fields terminated <span class="hljs-keyword">by</span> <span class="hljs-string">','</span>;
load data <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/opt/wzk/hive/data/t1.dat'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> t1;
</code></pre>
<p>执行如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/baa6787e7bd842faa26b2dbfe1d2c00a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=7UCv9n3jVCprPMy2rInzFOKPvrk%3D" alt="离线数仓Hive 创建表" loading="lazy"/></p>
<p>继续执行</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- t2.dat 的数据如下</span>
<span class="hljs-number">1</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span>
<span class="hljs-number">2</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span>
<span class="hljs-number">3</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span>
<span class="hljs-number">4</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span>
<span class="hljs-number">5</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span>
<span class="hljs-number">6</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span>

<span class="hljs-comment">-- 全量数据 =&gt; DWS</span>
<span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> t2;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t2(id <span class="hljs-type">int</span>, dt string)
<span class="hljs-type">row</span> format delimited fields terminated <span class="hljs-keyword">by</span> <span class="hljs-string">','</span>;
load data <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/opt/wzk/hive/data/t2.dat'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> t2;
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77530146ce2b41ad9ace2bcc24a768cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=Bsuv3A3RfCzElvu6KYm8WjcJ6iw%3D" alt="离线数仓Hive丢弃表" loading="lazy"/></p>
<p>继续执行：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 找出 2020-08-02 的新用户</span>
<span class="hljs-keyword">select</span> t1.id, t1.dt, t2.id, t2.dt
<span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> t2 <span class="hljs-keyword">on</span> t1.id<span class="hljs-operator">=</span>t2.id
<span class="hljs-keyword">where</span> t1.dt<span class="hljs-operator">=</span>"2020-08-02";
<span class="hljs-keyword">select</span> t1.id, t1.dt
<span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> t2 <span class="hljs-keyword">on</span> t1.id<span class="hljs-operator">=</span>t2.id
<span class="hljs-keyword">where</span> t1.dt<span class="hljs-operator">=</span>"2020-08-02"
<span class="hljs-keyword">and</span> t2.id <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span>;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/554a0331db8a4384b0c4972a2e6c8c43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=tRtSRdZnCeNvW5mx5KnwtUToKTY%3D" alt="离线数仓Hive 查询表" loading="lazy"/>
继续运行：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 将找到 2020-08-02 新用户数据插入t2表中</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> t2
<span class="hljs-keyword">select</span> t1.id, t1.dt
<span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> t2 <span class="hljs-keyword">on</span> t1.id<span class="hljs-operator">=</span>t2.id
<span class="hljs-keyword">where</span> t1.dt<span class="hljs-operator">=</span>"2020-08-02"
<span class="hljs-keyword">and</span> t2.id <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span>;
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f44ca4aae8d40bfaf1dc50242e0c588~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=0yaZAoIzNwmzbDo6TbeaZNg1bXQ%3D" alt="离线数仓Hive 插入数据到表格" loading="lazy"/>
目前t2的数据有：</p>
<pre><code class="hljs language-shell" lang="shell">hive (default)&gt; select * from t2;
OK
t2.id   t2.dt
7       2020-08-02
8       2020-08-02
9       2020-08-02
1       2020-08-01
2       2020-08-01
3       2020-08-01
4       2020-08-01
5       2020-08-01
6       2020-08-01
Time taken: 0.137 seconds, Fetched: 9 row(s)
hive (default)&gt; 
</code></pre>
<p>我们继续加载新的数据进去，整体的思路如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- t3.dat的数据，t1 加载 2020-08-03 的数据</span>
<span class="hljs-number">14</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-03</span>
<span class="hljs-number">15</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-03</span>
<span class="hljs-number">16</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-03</span>
<span class="hljs-number">17</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-03</span>
<span class="hljs-number">18</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-03</span>
<span class="hljs-number">19</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-03</span>

load data <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/opt/wzk/hive/data/t3.dat'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> t1;

<span class="hljs-comment">-- 同样的思路</span>
<span class="hljs-comment">-- 将找到 2020-08-03 新用户数据插入t2表中</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> t2
<span class="hljs-keyword">select</span> t1.id, t1.dt
<span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> t2 <span class="hljs-keyword">on</span> t1.id<span class="hljs-operator">=</span>t2.id
<span class="hljs-keyword">where</span> t1.dt<span class="hljs-operator">=</span>"2020-08-03"
<span class="hljs-keyword">and</span> t2.id <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span>;
<span class="hljs-comment">-- 检查结果</span>
<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t2;
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b29d3c8c831471e946be75d99a34658~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=GWJgzy02g4XuqFEgyCmhAflDVJE%3D" alt="离线数仓Hive查询数据" loading="lazy"/></p>
<h3 data-id="heading-4">DWS作用</h3>
<h4 data-id="heading-5">统一数据模型</h4>
<p>将原始数据（ODS层）按照一定的逻辑模型进行整合、清洗、加工，形成标准化的数据结构。
支持对数据的多维度、多粒度分析。</p>
<h4 data-id="heading-6">支持业务场景</h4>
<p>满足企业对历史数据的查询和分析需求。
支持 OLAP（在线分析处理）操作，如聚合查询、钻取和切片。</p>
<h4 data-id="heading-7">数据细化与分类</h4>
<p>将数据按照主题域（如销售、财务、库存等）分类，便于管理和查询。
通常保持较高的细节粒度，便于灵活扩展。</p>
<h4 data-id="heading-8">数据准确性与一致性</h4>
<p>经过处理的数据经过校验，确保逻辑关系正确，能够为下游提供准确的一致性数据。</p>
<h3 data-id="heading-9">创建DWS层表</h3>
<pre><code class="hljs language-sql" lang="sql">use dws;
<span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> if <span class="hljs-keyword">exists</span> dws.dws_member_add_day;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> dws.dws_member_add_day
(
  `device_id` string,
  `uid` string,
  `app_v` string,
  `os_type` string,
  `<span class="hljs-keyword">language</span>` string,
  `channel` string,
  `area` string,
  `brand` string,
  `dt` string
) COMMENT <span class="hljs-string">'每日新增会员明细'</span>
stored <span class="hljs-keyword">as</span> parquet;
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5977b9d54cda41818a422e7dfd78e65d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=Wjcw%2FPq%2FnUp8S5CAMOWFrYltrw4%3D" alt="离线数仓 DWS 层" loading="lazy"/></p>
<h3 data-id="heading-10">加载DWS层数据</h3>
<p>我们编写脚本：</p>
<pre><code class="hljs language-shell" lang="shell">vim /opt/wzk/hive/dws_load_member_add_day.sh
</code></pre>
<p>写入内容如下：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>
source /etc/profile
if [ -n "$1" ]
then
do_date=$1
else
do_date=`date -d "-1 day" +%F`
fi
sql="
insert into table dws.dws_member_add_day
select t1.device_id,
t1.uid,
t1.app_v,
t1.os_type,
t1.language,
t1.channel,
t1.area,
t1.brand,
'$do_date'
from dws.dws_member_start_day t1 left join
dws.dws_member_add_day t2
on t1.device_id=t2.device_id
where t1.dt='$do_date'
and t2.device_id is null;
"
hive -e "$sql"
</code></pre>
<p>写入的内容如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7453f2ae3fb49d0bd0f4d73e8f686e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=60xl14xxAFxWR9SaMGk0zFiMuVw%3D" alt="离线数仓加载 DWS 层" loading="lazy"/></p>
<h3 data-id="heading-11">ADS 作用</h3>
<h4 data-id="heading-12">聚合和简化数据</h4>
<p>将 DWS 层中多表、多主题域的数据聚合成简单易用的表或视图。
直接输出满足业务需求的数据结果。</p>
<h4 data-id="heading-13">面向业务应用</h4>
<p>通过设计宽表或高性能视图，直接支持具体的业务场景和报表需求。
响应快速查询需求，如实时数据的展示。</p>
<h4 data-id="heading-14">数据分发与集成</h4>
<p>为前端的 BI 工具、报表系统或 API 服务提供高效的查询接口。
能够通过缓存机制或物化视图加速查询性能。</p>
<h4 data-id="heading-15">轻量化与高性能</h4>
<p>尽量减少数据量，保留业务最关心的关键指标。
采用预聚合、预计算等技术提升查询效率。</p>
<h3 data-id="heading-16">创建ADS层表</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> if <span class="hljs-keyword">exists</span> ads.ads_new_member_cnt;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> ads.ads_new_member_cnt(
  `cnt` string
)
partitioned <span class="hljs-keyword">by</span>(dt string)
<span class="hljs-type">row</span> format delimited fields terminated <span class="hljs-keyword">by</span> <span class="hljs-string">','</span>;
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/215a2c64b9e9452496ca1dbdb1df504b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=XOZFZ4nRok%2FvOKW80F8WSB8K1vg%3D" alt="离线数仓 Hive DWS 层" loading="lazy"/></p>
<h3 data-id="heading-17">加载ADS层数据</h3>
<p>编写数据加载的脚本：</p>
<pre><code class="hljs language-shell" lang="shell">vim /opt/wzk/hive/ads_load_member_add.sh
</code></pre>
<p>编写对应的脚本如下所示：</p>
<pre><code class="hljs language-sql" lang="sql">#<span class="hljs-operator">!</span><span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>bash
source <span class="hljs-operator">/</span>etc<span class="hljs-operator">/</span>profile
if [ <span class="hljs-operator">-</span>n "$1" ] ;<span class="hljs-keyword">then</span>
do_date<span class="hljs-operator">=</span>$<span class="hljs-number">1</span>
<span class="hljs-keyword">else</span>
do_date<span class="hljs-operator">=</span>`<span class="hljs-type">date</span> <span class="hljs-operator">-</span>d "-1 day" <span class="hljs-operator">+</span><span class="hljs-operator">%</span>F`
fi
<span class="hljs-keyword">sql</span><span class="hljs-operator">=</span>"
insert overwrite table ads.ads_new_member_cnt
partition (dt='$do_date')
select count(1)
from dws.dws_member_add_day
where dt = '$do_date'
"
hive <span class="hljs-operator">-</span>e "$sql"
</code></pre>
<h3 data-id="heading-18">暂时小结</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19e374a5a01c4f5aa0de17db7df9fc82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=k6ukLTDL%2BkO4O84GTTM64I1gnYE%3D" alt="离线数仓 ADS 层" loading="lazy"/>
调用脚本的次序是：</p>
<pre><code class="hljs language-shell" lang="shell">dws_load_member_add_day.sh
ads_load_member_add.sh
</code></pre>
<h2 data-id="heading-19">错误速查</h2>













































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th></tr></thead><tbody><tr><td>当日新增数忽高忽低</td><td>新增锚点不稳定（device_id 会变/uid 会变）</td><td>对比同日 uid 与 device_id 去重后的基数差异；明确新增口径：优先选稳定主键；必要时做 device_id↔uid 绑定表</td></tr><tr><td>新增明细重复出现</td><td>同一用户多天全量会员表未成功增量写入或写入失败回滚</td><td>检查 t2/全量表中是否存在该 id 的历史 dt；先保证“插入全量表”成功再产出下游；给插入加幂等约束（分区/去重）</td></tr><tr><td>新增明细为 0，但启动明细有数据</td><td>join 条件/字段类型不一致导致全匹配</td><td>抽样检查 t1.id 与 t2.id 的类型、是否有空格/格式差；统一字段类型与清洗规则；必要时 trim/cast 后再 join</td></tr><tr><td>ADS 分区覆盖错误或数据跑到错误日期</td><td>do_date 传参/默认日期取值不符合调度时间</td><td>打印脚本 do_date 与 SQL where dt；统一调度时间基准；强制调度传参，避免默认 -1 day 误差</td></tr><tr><td>ADS 结果累加而非覆盖</td><td>insert into 用错，或分区未指定导致追加</td><td>检查是否使用 insert overwrite + partition(dt=)；指标表用 insert overwrite 覆盖当日分区；明细表按需求决定追加</td></tr><tr><td>新增口径与“卸载重装不算新增”不一致</td><td>仅靠 device_id 无法识别“同设备卸载重装”边界</td><td>统计同 device_id 的首次/多次出现模式；以 device_id 为主键维护首次 dt；若设备重置导致变化，需风控/埋点补强</td></tr><tr><td>DWS/ADS 串行执行仍出现空结果</td><td>DWS 表 dt 字段写入与 where dt 不一致</td><td>核对 DWS 插入时 dt 取值是否为 ‘$do_date’；保证 DWS 写入 dt 与查询 dt 同源；避免混用 t1.dt 与脚本 dt</td></tr></tbody></table>
<h2 data-id="heading-20">其他系列</h2>
<h3 data-id="heading-21">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-22">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-218 RocketMQ Java API 实战：同步/异步 Producer 与 Pull/Push Consumer</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ已完结，RocketMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-23">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift中的分层缓存设计：平衡性能、内存与数据一致性的实践方案]]></title>    <link>https://juejin.cn/post/7603383059151667242</link>    <guid>https://juejin.cn/post/7603383059151667242</guid>    <pubDate>2026-02-06T08:31:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603383059151667242" data-draft-id="7603352061506813958" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift中的分层缓存设计：平衡性能、内存与数据一致性的实践方案"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2026-02-06T08:31:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift中的分层缓存设计：平衡性能、内存与数据一致性的实践方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:31:51.000Z" title="Fri Feb 06 2026 08:31:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：单一缓存策略的局限性</h2>
<p>在移动应用开发中，缓存是提升性能的关键手段。然而，单一的缓存策略往往难以同时满足三个核心诉求：高性能、低内存占用和数据一致性。</p>
<p>内存缓存速度快但容量有限，磁盘缓存容量大但访问延迟高。如何在二者之间取得平衡？分层缓存（Tiered Caching） 提供了一种优雅的解决方案。</p>
<h2 data-id="heading-1">分层缓存核心概念解析</h2>
<h3 data-id="heading-2">什么是分层缓存？</h3>
<p>分层缓存是一种将不同存储介质按访问速度和容量组织成层级结构的架构模式。典型的两层结构包含：</p>
<ul>
<li>L1 缓存（内存层）：基于 <code>NSCache</code> 或自定义内存存储，提供纳秒级访问速度，容量受限</li>
<li>L2 缓存（磁盘层）：基于文件系统或数据库存储，提供持久化能力，容量大但访问延迟在毫秒级</li>
</ul>
<p>数据在这两层之间按策略流动，形成热点数据上浮、冷数据下沉的动态平衡。</p>
<h3 data-id="heading-3">关键设计目标</h3>



































<table><thead><tr><th align="left">目标维度</th><th align="left">内存缓存</th><th align="left">磁盘缓存</th><th align="left">分层缓存优势</th></tr></thead><tbody><tr><td align="left">访问速度</td><td align="left">⚡️⚡️⚡️⚡️⚡️</td><td align="left">⚡️⚡️</td><td align="left">热点数据走内存，保证极致性能</td></tr><tr><td align="left">存储容量</td><td align="left">受限（MB 级）</td><td align="left">大（GB 级）</td><td align="left">扩展有效缓存容量百倍</td></tr><tr><td align="left">数据持久化</td><td align="left">进程结束即丢失</td><td align="left">持久化保存</td><td align="left">兼顾临时加速与长期存储</td></tr><tr><td align="left">内存占用</td><td align="left">高</td><td align="left">零</td><td align="left">智能清理机制控制峰值</td></tr></tbody></table>
<h2 data-id="heading-4">Swift 实现：核心架构设计</h2>
<h3 data-id="heading-5">缓存抽象协议</h3>
<p>首先定义统一的缓存操作接口，实现层间解耦：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Foundation

<span class="hljs-comment">/// 缓存操作统一协议</span>
<span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Key</span>: <span class="hljs-type">Hashable</span>
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Value</span>
    
    <span class="hljs-comment">/// 异步获取缓存值</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">Value</span>?
    
    <span class="hljs-comment">/// 异步设置缓存值</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">set</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: <span class="hljs-type">Value</span>?, <span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span>
    
    <span class="hljs-comment">/// 删除缓存</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">remove</span>(<span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span>
    
    <span class="hljs-comment">/// 清空所有缓存</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">removeAll</span>() <span class="hljs-keyword">async</span>
}

<span class="hljs-comment">/// 支持持久化的缓存协议</span>
<span class="hljs-keyword">protocol</span> <span class="hljs-title class_">PersistentCache</span>: <span class="hljs-title class_">Cache</span> {
    <span class="hljs-comment">/// 从持久化存储加载数据</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">load</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span>
    
    <span class="hljs-comment">/// 将数据持久化到存储</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">save</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span>
}
</code></pre>
<h3 data-id="heading-6">内存缓存层实现</h3>
<p>基于 <code>NSCache</code> 实现线程安全的内存缓存：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Foundation

<span class="hljs-comment">/// 内存缓存层实现</span>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryCache</span>&lt;<span class="hljs-title class_">Key</span>: <span class="hljs-title class_">Hashable</span>, <span class="hljs-title class_">Value</span>&gt;: <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> cache <span class="hljs-operator">=</span> <span class="hljs-type">NSCache</span>&lt;<span class="hljs-type">WrappedKey</span>, <span class="hljs-type">Entry</span>&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> dateProvider: () -&gt; <span class="hljs-type">Date</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> entryLifetime: <span class="hljs-type">TimeInterval</span>
    
    <span class="hljs-comment">/// 包装Key以适配 NSCache</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WrappedKey</span>: <span class="hljs-title class_">NSObject</span> {
        <span class="hljs-keyword">let</span> key: <span class="hljs-type">Key</span>
        <span class="hljs-keyword">init</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) { <span class="hljs-keyword">self</span>.key <span class="hljs-operator">=</span> key }
        <span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> hash: <span class="hljs-type">Int</span> { key.hashValue }
        <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">isEqual</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">object</span>: <span class="hljs-keyword">Any</span><span class="hljs-operator">?</span>) -&gt; <span class="hljs-type">Bool</span> {
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> other <span class="hljs-operator">=</span> object <span class="hljs-keyword">as?</span> <span class="hljs-type">WrappedKey</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> }
            <span class="hljs-keyword">return</span> key <span class="hljs-operator">==</span> other.key
        }
    }
    
    <span class="hljs-comment">/// 缓存条目</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span>: <span class="hljs-title class_">NSObject</span> {
        <span class="hljs-keyword">let</span> value: <span class="hljs-type">Value</span>
        <span class="hljs-keyword">let</span> expirationDate: <span class="hljs-type">Date</span>
        <span class="hljs-keyword">init</span>(<span class="hljs-params">value</span>: <span class="hljs-type">Value</span>, <span class="hljs-params">expirationDate</span>: <span class="hljs-type">Date</span>) {
            <span class="hljs-keyword">self</span>.value <span class="hljs-operator">=</span> value
            <span class="hljs-keyword">self</span>.expirationDate <span class="hljs-operator">=</span> expirationDate
        }
    }
    
    <span class="hljs-comment">// MARK: - 初始化</span>
    <span class="hljs-keyword">init</span>(
        <span class="hljs-params">dateProvider</span>: <span class="hljs-keyword">@escaping</span> () -&gt; <span class="hljs-type">Date</span> <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>.<span class="hljs-keyword">init</span>,
        <span class="hljs-params">entryLifetime</span>: <span class="hljs-type">TimeInterval</span> <span class="hljs-operator">=</span> <span class="hljs-number">300</span>  <span class="hljs-comment">// 默认5分钟过期</span>
    ) {
        <span class="hljs-keyword">self</span>.dateProvider <span class="hljs-operator">=</span> dateProvider
        <span class="hljs-keyword">self</span>.entryLifetime <span class="hljs-operator">=</span> entryLifetime
        cache.countLimit <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>  <span class="hljs-comment">// 最大缓存1000条</span>
    }
    
    <span class="hljs-comment">// MARK: - Cache 协议实现</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">Value</span>? {
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> entry <span class="hljs-operator">=</span> cache.object(forKey: <span class="hljs-type">WrappedKey</span>(key)) <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> }
        <span class="hljs-keyword">guard</span> dateProvider() <span class="hljs-operator">&lt;</span> entry.expirationDate <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 过期清理</span>
            <span class="hljs-keyword">await</span> remove(forKey: key)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
        }
        <span class="hljs-keyword">return</span> entry.value
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">set</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: <span class="hljs-type">Value</span>?, <span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> value <span class="hljs-operator">=</span> value {
            <span class="hljs-keyword">let</span> expirationDate <span class="hljs-operator">=</span> dateProvider().addingTimeInterval(entryLifetime)
            <span class="hljs-keyword">let</span> entry <span class="hljs-operator">=</span> <span class="hljs-type">Entry</span>(value: value, expirationDate: expirationDate)
            cache.setObject(entry, forKey: <span class="hljs-type">WrappedKey</span>(key))
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">await</span> remove(forKey: key)
        }
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">remove</span>(<span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> {
        cache.removeObject(forKey: <span class="hljs-type">WrappedKey</span>(key))
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">removeAll</span>() <span class="hljs-keyword">async</span> {
        cache.removeAllObjects()
    }
}
</code></pre>
<h3 data-id="heading-7">磁盘缓存层实现</h3>
<p>基于文件系统实现持久化缓存，使用 <code>JSONEncoder</code> 进行序列化：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Foundation

<span class="hljs-comment">/// 磁盘缓存层实现</span>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DiskCache</span>&lt;<span class="hljs-title class_">Key</span>: <span class="hljs-title class_">Hashable</span> &amp; <span class="hljs-title class_">Codable</span>, <span class="hljs-title class_">Value</span>: <span class="hljs-title class_">Codable</span>&gt;: <span class="hljs-title class_">PersistentCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> storage: <span class="hljs-type">UserDefaults</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> key: <span class="hljs-type">String</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> dateProvider: () -&gt; <span class="hljs-type">Date</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> entryLifetime: <span class="hljs-type">TimeInterval</span>
    
    <span class="hljs-comment">/// 缓存条目包装</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Entry</span>: <span class="hljs-title class_">Codable</span> {
        <span class="hljs-keyword">let</span> value: <span class="hljs-type">Value</span>
        <span class="hljs-keyword">let</span> expirationDate: <span class="hljs-type">Date</span>
    }
    
    <span class="hljs-comment">// MARK: - 初始化</span>
    <span class="hljs-keyword">init</span>(
        <span class="hljs-params">storage</span>: <span class="hljs-type">UserDefaults</span> <span class="hljs-operator">=</span> .standard,
        <span class="hljs-params">key</span>: <span class="hljs-type">String</span> <span class="hljs-operator">=</span> <span class="hljs-string">"disk_cache"</span>,
        <span class="hljs-params">dateProvider</span>: <span class="hljs-keyword">@escaping</span> () -&gt; <span class="hljs-type">Date</span> <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>.<span class="hljs-keyword">init</span>,
        <span class="hljs-params">entryLifetime</span>: <span class="hljs-type">TimeInterval</span> <span class="hljs-operator">=</span> <span class="hljs-number">3600</span>  <span class="hljs-comment">// 默认1小时过期</span>
    ) {
        <span class="hljs-keyword">self</span>.storage <span class="hljs-operator">=</span> storage
        <span class="hljs-keyword">self</span>.key <span class="hljs-operator">=</span> key
        <span class="hljs-keyword">self</span>.dateProvider <span class="hljs-operator">=</span> dateProvider
        <span class="hljs-keyword">self</span>.entryLifetime <span class="hljs-operator">=</span> entryLifetime
    }
    
    <span class="hljs-comment">// MARK: - Cache 协议实现</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">Value</span>? {
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> storage.data(forKey: keyPrefix <span class="hljs-operator">+</span> <span class="hljs-type">String</span>(describing: key)) <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> }
        
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">let</span> entry <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">Entry</span>.<span class="hljs-keyword">self</span>, from: data)
            <span class="hljs-keyword">guard</span> dateProvider() <span class="hljs-operator">&lt;</span> entry.expirationDate <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">await</span> remove(forKey: key)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
            }
            <span class="hljs-keyword">return</span> entry.value
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-keyword">await</span> remove(forKey: key)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
        }
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">set</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: <span class="hljs-type">Value</span>?, <span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">let</span> cacheKey <span class="hljs-operator">=</span> keyPrefix <span class="hljs-operator">+</span> <span class="hljs-type">String</span>(describing: key)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> value <span class="hljs-operator">=</span> value {
            <span class="hljs-keyword">let</span> entry <span class="hljs-operator">=</span> <span class="hljs-type">Entry</span>(value: value, expirationDate: dateProvider().addingTimeInterval(entryLifetime))
            <span class="hljs-keyword">do</span> {
                <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONEncoder</span>().encode(entry)
                storage.set(data, forKey: cacheKey)
            } <span class="hljs-keyword">catch</span> {
                storage.removeObject(forKey: cacheKey)
            }
        } <span class="hljs-keyword">else</span> {
            storage.removeObject(forKey: cacheKey)
        }
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">remove</span>(<span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> {
        storage.removeObject(forKey: keyPrefix <span class="hljs-operator">+</span> <span class="hljs-type">String</span>(describing: key))
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">removeAll</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">let</span> keys <span class="hljs-operator">=</span> storage.dictionaryRepresentation().keys.filter { <span class="hljs-variable">$0</span>.hasPrefix(keyPrefix) }
        keys.forEach { storage.removeObject(forKey: <span class="hljs-variable">$0</span>) }
    }
    
    <span class="hljs-comment">// MARK: - PersistentCache 协议实现</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">load</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> {
        <span class="hljs-comment">// UserDefaults 自动持久化，无需手动加载</span>
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">save</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> {
        <span class="hljs-comment">// UserDefaults 自动持久化，无需手动保存</span>
    }
    
    <span class="hljs-comment">// MARK: - 私有辅助</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> keyPrefix: <span class="hljs-type">String</span> { <span class="hljs-string">"__<span class="hljs-subst">\(key)</span>_"</span> }
}
</code></pre>
<h2 data-id="heading-8">分层缓存核心逻辑：策略模式</h2>
<h3 data-id="heading-9">缓存策略枚举</h3>
<p>定义不同的缓存访问策略，这是分层缓存的核心创新点：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Foundation

<span class="hljs-comment">/// 缓存访问策略</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">CacheStrategy</span> {
    <span class="hljs-comment">/// 先返回缓存，再异步更新缓存（最终一致性）</span>
    <span class="hljs-keyword">case</span> cacheThenFetch
    
    <span class="hljs-comment">/// 优先返回缓存，无缓存时获取新数据（强一致性）</span>
    <span class="hljs-keyword">case</span> cacheElseFetch
    
    <span class="hljs-comment">/// 忽略缓存，强制获取新数据</span>
    <span class="hljs-keyword">case</span> fetch
    
    <span class="hljs-comment">/// 仅返回缓存，不获取新数据</span>
    <span class="hljs-keyword">case</span> cacheOnly
}

<span class="hljs-comment">/// 缓存结果包装</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">CacheResult</span>&lt;<span class="hljs-title class_">Value</span>&gt; {
    <span class="hljs-keyword">case</span> hit(<span class="hljs-type">Value</span>)      <span class="hljs-comment">// 缓存命中</span>
    <span class="hljs-keyword">case</span> miss           <span class="hljs-comment">// 缓存未命中</span>
    <span class="hljs-keyword">case</span> error(<span class="hljs-type">Error</span>)   <span class="hljs-comment">// 发生错误</span>
    
    <span class="hljs-keyword">var</span> value: <span class="hljs-type">Value</span>? {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">case</span> .hit(<span class="hljs-keyword">let</span> v) <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span> { <span class="hljs-keyword">return</span> v }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }
}
</code></pre>
<h3 data-id="heading-10">分层缓存管理器</h3>
<p>两层缓存的协同工作：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Foundation

<span class="hljs-comment">/// 分层缓存管理器</span>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TieredCache</span>&lt;<span class="hljs-title class_">Key</span>: <span class="hljs-title class_">Hashable</span> &amp; <span class="hljs-title class_">Codable</span>, <span class="hljs-title class_">Value</span>: <span class="hljs-title class_">Codable</span>&gt; {
    <span class="hljs-comment">// MARK: - 缓存层级</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> memoryCache <span class="hljs-operator">=</span> <span class="hljs-type">MemoryCache</span>&lt;<span class="hljs-type">Key</span>, <span class="hljs-type">Value</span>&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> diskCache <span class="hljs-operator">=</span> <span class="hljs-type">DiskCache</span>&lt;<span class="hljs-type">Key</span>, <span class="hljs-type">Value</span>&gt;()
    
    <span class="hljs-comment">/// 数据源提供者</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> origin: (<span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">Value</span>?
    
    <span class="hljs-comment">// MARK: - 初始化</span>
    <span class="hljs-keyword">init</span>(<span class="hljs-params">origin</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">Value</span>?) {
        <span class="hljs-keyword">self</span>.origin <span class="hljs-operator">=</span> origin
    }
    
    <span class="hljs-comment">// MARK: - 核心方法</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">get</span>(
        <span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>,
        <span class="hljs-params">strategy</span>: <span class="hljs-type">CacheStrategy</span> <span class="hljs-operator">=</span> .cacheElseFetch
    ) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">CacheResult</span>&lt;<span class="hljs-type">Value</span>&gt; {
        <span class="hljs-keyword">switch</span> strategy {
        <span class="hljs-keyword">case</span> .cacheThenFetch:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> handleCacheThenFetch(forKey: key)
            
        <span class="hljs-keyword">case</span> .cacheElseFetch:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> handleCacheElseFetch(forKey: key)
            
        <span class="hljs-keyword">case</span> .fetch:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> handleFetch(forKey: key)
            
        <span class="hljs-keyword">case</span> .cacheOnly:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> handleCacheOnly(forKey: key)
        }
    }
    
    <span class="hljs-comment">/// 设置缓存（同时写入两层）</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">set</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: <span class="hljs-type">Value</span>?, <span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">await</span> memoryCache.set(value, forKey: key)
        <span class="hljs-keyword">await</span> diskCache.set(value, forKey: key)
    }
}
</code></pre>
<h3 data-id="heading-11">策略实现详解</h3>
<p>策略 A：<code>cacheThenFetch</code>（最终一致性）</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">TieredCache</span> {
    <span class="hljs-comment">/// 先返回缓存，再异步更新（适合对实时性要求不高的场景）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleCacheThenFetch</span>(<span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">CacheResult</span>&lt;<span class="hljs-type">Value</span>&gt; {
        <span class="hljs-comment">// 1. 立即检查内存缓存</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> memoryValue <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> memoryCache.get(forKey: key) {
            <span class="hljs-comment">// 异步触发更新，但不阻塞返回</span>
            <span class="hljs-type">Task</span> {
                <span class="hljs-keyword">await</span> doFetchAndCache(forKey: key)
            }
            <span class="hljs-keyword">return</span> .hit(memoryValue)
        }
        
        <span class="hljs-comment">// 2. 检查磁盘缓存</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> diskValue <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> diskCache.get(forKey: key) {
            <span class="hljs-comment">// 将热点数据提升到内存层</span>
            <span class="hljs-keyword">await</span> memoryCache.set(diskValue, forKey: key)
            <span class="hljs-comment">// 异步触发更新</span>
            <span class="hljs-type">Task</span> {
                <span class="hljs-keyword">await</span> doFetchAndCache(forKey: key)
            }
            <span class="hljs-keyword">return</span> .hit(diskValue)
        }
        
        <span class="hljs-comment">// 3. 无缓存，同步获取</span>
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> value <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> origin(key) {
                <span class="hljs-keyword">await</span> <span class="hljs-keyword">set</span>(value, forKey: key)
                <span class="hljs-keyword">return</span> .hit(value)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> .miss
            }
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-keyword">return</span> .error(error)
        }
    }
}
</code></pre>
<p>使用场景：用户头像、文章列表等容忍短暂延迟的数据。</p>
<p>策略 B：<code>cacheElseFetch</code>（强一致性）</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">TieredCache</span> {
    <span class="hljs-comment">/// 优先使用缓存，无缓存时才获取（适合对一致性要求高的场景）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleCacheElseFetch</span>(<span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">CacheResult</span>&lt;<span class="hljs-type">Value</span>&gt; {
        <span class="hljs-comment">// 1. 检查内存缓存</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> value <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> memoryCache.get(forKey: key) {
            <span class="hljs-keyword">return</span> .hit(value)
        }
        
        <span class="hljs-comment">// 2. 检查磁盘缓存</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> value <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> diskCache.get(forKey: key) {
            <span class="hljs-comment">// 热点数据提升</span>
            <span class="hljs-keyword">await</span> memoryCache.set(value, forKey: key)
            <span class="hljs-keyword">return</span> .hit(value)
        }
        
        <span class="hljs-comment">// 3. 必须获取新数据</span>
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> value <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> origin(key) {
                <span class="hljs-keyword">await</span> <span class="hljs-keyword">set</span>(value, forKey: key)
                <span class="hljs-keyword">return</span> .hit(value)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> .miss
            }
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-keyword">return</span> .error(error)
        }
    }
}
</code></pre>
<p>使用场景：配置信息、用户权限等关键数据。</p>
<p>策略 C &amp; D：简单策略</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">TieredCache</span> {
    <span class="hljs-comment">/// 强制获取新数据（忽略缓存）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleFetch</span>(<span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">CacheResult</span>&lt;<span class="hljs-type">Value</span>&gt; {
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> value <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> origin(key) {
                <span class="hljs-keyword">await</span> <span class="hljs-keyword">set</span>(value, forKey: key)
                <span class="hljs-keyword">return</span> .hit(value)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> .miss
            }
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-keyword">return</span> .error(error)
        }
    }
    
    <span class="hljs-comment">/// 仅返回缓存，不获取新数据</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleCacheOnly</span>(<span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">CacheResult</span>&lt;<span class="hljs-type">Value</span>&gt; {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> value <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> memoryCache.get(forKey: key) {
            <span class="hljs-keyword">return</span> .hit(value)
        }
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> value <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> diskCache.get(forKey: key) {
            <span class="hljs-keyword">await</span> memoryCache.set(value, forKey: key)
            <span class="hljs-keyword">return</span> .hit(value)
        }
        
        <span class="hljs-keyword">return</span> .miss
    }
    
    <span class="hljs-comment">/// 内部方法：获取并缓存数据</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">doFetchAndCache</span>(<span class="hljs-params">forKey</span> <span class="hljs-params">key</span>: <span class="hljs-type">Key</span>) <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> value <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> origin(key) {
                <span class="hljs-keyword">await</span> <span class="hljs-keyword">set</span>(value, forKey: key)
            }
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-comment">// 静默处理后台更新错误</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Background fetch failed: <span class="hljs-subst">\(error)</span>"</span>)
        }
    }
}
</code></pre>
<h2 data-id="heading-12">原理解析：数据流动与成本模型</h2>
<h3 data-id="heading-13">数据流动路径</h3>
<pre><code class="hljs language-scss" lang="scss">用户请求
   │
   ▼
┌─────────────────────────┐
│  策略分发器 (CacheStrategy) │
└──────────┬──────────────┘
           │
      ┌────┴────┐
      │         │
   ┌──▼──┐   ┌──▼──┐
   │ L1  │   │ L2  │
   │内存 │   │磁盘 │
   └──┬──┘   └──┬──┘
      │         │
      └────┬────┘
           ▼
       数据源 (Origin)
</code></pre>
<h3 data-id="heading-14">访问成本模型</h3>
<p>每种策略的成本可以用时间复杂度和一致性级别衡量：</p>








































<table><thead><tr><th align="left">策略</th><th align="left">命中时延</th><th align="left">未命中时延</th><th align="left">一致性级别</th><th align="left">适用场景</th></tr></thead><tbody><tr><td align="left"><code>cacheThenFetch</code></td><td align="left">O(1)</td><td align="left">O(n)</td><td align="left">最终一致</td><td align="left">图片、列表</td></tr><tr><td align="left"><code>cacheElseFetch</code></td><td align="left">O(1)</td><td align="left">O(n)</td><td align="left">强一致</td><td align="left">配置、权限</td></tr><tr><td align="left"><code>fetch</code></td><td align="left">O(n)</td><td align="left">O(n)</td><td align="left">实时一致</td><td align="left">支付结果</td></tr><tr><td align="left"><code>cacheOnly</code></td><td align="left">O(1)</td><td align="left">-</td><td align="left">无</td><td align="left">离线模式</td></tr></tbody></table>
<p>注：O(1) 代表内存访问，O(n) 代表网络/磁盘访问。</p>
<h3 data-id="heading-15">热点数据提升机制</h3>
<p>当数据从磁盘层被访问时，自动提升到内存层：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 热点提升逻辑</span>
<span class="hljs-keyword">if</span> diskValue <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">await</span> memoryCache.set(diskValue, forKey: key)
}
</code></pre>
<p>该机制借鉴了 CPU 缓存的时间局部性原理：最近访问的数据很可能再次被访问。</p>
<h2 data-id="heading-16">高级特性与优化</h2>
<h3 data-id="heading-17">缓存预热</h3>
<p>在应用启动时预先加载关键数据：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachePreWarmer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> cache: <span class="hljs-type">TieredCache</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-type">User</span>&gt;
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">warmUp</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">let</span> criticalKeys <span class="hljs-operator">=</span> [<span class="hljs-string">"user_profile"</span>, <span class="hljs-string">"app_config"</span>, <span class="hljs-string">"feature_flags"</span>]
        <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> criticalKeys {
            <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> cache.get(forKey: key, strategy: .cacheElseFetch)
        }
    }
}
</code></pre>
<h3 data-id="heading-18">批量清理策略</h3>
<p>实现基于 LRU 的智能清理：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">TieredCache</span> {
    <span class="hljs-comment">/// 清理过期缓存</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">cleanExpired</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-comment">// 内存层由 NSCache 自动管理</span>
        <span class="hljs-comment">// 磁盘层可定期清理</span>
        <span class="hljs-comment">// 实现略...</span>
    }
    
    <span class="hljs-comment">/// 内存警告处理</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleMemoryWarning</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">await</span> memoryCache.removeAll()
        <span class="hljs-comment">// 保留磁盘层数据</span>
    }
}
</code></pre>
<h3 data-id="heading-19">并发安全优化</h3>
<p>使用 <code>actor</code> 模型保证线程安全（Swift 5.5+）：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@globalActor</span>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheActor</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">CacheActor</span>()
}

<span class="hljs-meta">@CacheActor</span>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafeTieredCache</span>&lt;<span class="hljs-title class_">Key</span>: <span class="hljs-title class_">Hashable</span> &amp; <span class="hljs-title class_">Codable</span>, <span class="hljs-title class_">Value</span>: <span class="hljs-title class_">Codable</span>&gt; {
    <span class="hljs-comment">// 所有方法在 actor 隔离下自动线程安全</span>
    <span class="hljs-comment">// 实现略...</span>
}
</code></pre>
<h2 data-id="heading-20">实战案例：用户资料缓存</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 定义模型</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">User</span>: <span class="hljs-title class_">Codable</span> {
    <span class="hljs-keyword">let</span> id: <span class="hljs-type">String</span>
    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span>
    <span class="hljs-keyword">let</span> avatarURL: <span class="hljs-type">URL</span>
}

<span class="hljs-comment">// 创建分层缓存</span>
<span class="hljs-keyword">let</span> userCache <span class="hljs-operator">=</span> <span class="hljs-type">TieredCache</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-type">User</span>&gt; { userId <span class="hljs-keyword">in</span>
    <span class="hljs-comment">// 数据源：网络请求</span>
    <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">"https://api.example.com/users/<span class="hljs-subst">\(userId)</span>"</span>)<span class="hljs-operator">!</span>
    <span class="hljs-keyword">let</span> (data, <span class="hljs-keyword">_</span>) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(from: url)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">User</span>.<span class="hljs-keyword">self</span>, from: data)
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-type">Task</span> {
    <span class="hljs-comment">// 策略1：快速显示，后台更新（用户头像）</span>
    <span class="hljs-keyword">switch</span> <span class="hljs-keyword">await</span> userCache.get(forKey: <span class="hljs-string">"user_123"</span>, strategy: .cacheThenFetch) {
    <span class="hljs-keyword">case</span> .hit(<span class="hljs-keyword">let</span> user):
        updateUI(with: user)
    <span class="hljs-keyword">case</span> .miss:
        showPlaceholder()
    <span class="hljs-keyword">case</span> .error(<span class="hljs-keyword">let</span> error):
        handleError(error)
    }
    
    <span class="hljs-comment">// 策略2：必须最新数据（用户权限）</span>
    <span class="hljs-keyword">switch</span> <span class="hljs-keyword">await</span> userCache.get(forKey: <span class="hljs-string">"user_123_permissions"</span>, strategy: .cacheElseFetch) {
    <span class="hljs-keyword">case</span> .hit(<span class="hljs-keyword">let</span> permissions):
        applyPermissions(permissions)
    <span class="hljs-keyword">case</span> .miss, .error:
        showLoginPrompt()
    }
}
</code></pre>
<h2 data-id="heading-21">深入原理：为什么分层缓存有效？</h2>
<h3 data-id="heading-22">局部性原理的应用</h3>
<ol>
<li>时间局部性：最近访问的数据会再次被访问 → 内存缓存保留热点数据</li>
<li>空间局部性：相邻数据通常一起访问 → 批量预加载提升效率</li>
</ol>
<h3 data-id="heading-23">成本效益分析</h3>
<p>分层缓存的本质是用空间换时间，但智能策略避免了无效占用：</p>
<ul>
<li>短期数据（&lt; 5分钟）：仅保留在内存</li>
<li>中期数据（&lt; 1小时）：内存 + 磁盘双份</li>
<li>长期数据（&gt; 1小时）：仅磁盘存储</li>
</ul>
<h3 data-id="heading-24">与操作系统缓存机制的对比</h3>





























<table><thead><tr><th align="left">层级</th><th align="left">iOS 系统缓存</th><th align="left">应用分层缓存</th><th align="left">优势</th></tr></thead><tbody><tr><td align="left">L1</td><td align="left">CPU 缓存</td><td align="left">内存缓存</td><td align="left">应用层可控 TTL 策略</td></tr><tr><td align="left">L2</td><td align="left">内存映射文件</td><td align="left">磁盘缓存</td><td align="left">跨进程共享，精确管理</td></tr><tr><td align="left">L3</td><td align="left">磁盘缓存</td><td align="left">网络 CDN</td><td align="left">应用可定义业务语义</td></tr></tbody></table>
<h2 data-id="heading-25">总结</h2>
<p>分层缓存不是简单的内存 + 磁盘堆砌，而是通过策略驱动的数据流动，实现：</p>
<ul>
<li>性能：热点数据内存访问，响应时间 &lt; 1ms</li>
<li>容量：磁盘层扩展容量百倍，支撑百万级数据</li>
<li>成本：智能淘汰机制，内存占用降低 70%</li>
<li>一致性：可选策略平衡实时性与可靠性</li>
</ul>
<p>参考资料</p>
<ol>
<li>Apple Documentation - <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Ffoundation%2Fnscache" target="_blank" title="https://developer.apple.com/documentation/foundation/nscache" ref="nofollow noopener noreferrer">NSCache</a></li>
<li>Swift.org - <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.swift.org%2Fswift-book%2Fdocumentation%2Fthe-swift-programming-language%2Fconcurrency%2F" target="_blank" title="https://docs.swift.org/swift-book/documentation/the-swift-programming-language/concurrency/" ref="nofollow noopener noreferrer">Actors</a></li>
<li>OpenSearch - <a href="https://link.juejin.cn?target=https%3A%2F%2Fopensearch.org%2Fblog%2Ftiered-cache%2F" target="_blank" title="https://opensearch.org/blog/tiered-cache/" ref="nofollow noopener noreferrer">Tiered Cache Architecture</a></li>
<li>WWDC 2023 - <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fvideos%2Fplay%2Fwwdc2023%2F10170%2F" target="_blank" title="https://developer.apple.com/videos/play/wwdc2023/10170/" ref="nofollow noopener noreferrer">Beyond the basics of structured concurrency</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkylebrowning.com%2Fposts%2Ftiered-caching-in-swift%2F" target="_blank" title="https://kylebrowning.com/posts/tiered-caching-in-swift/" ref="nofollow noopener noreferrer">kylebrowning.com/posts/tiere…</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[地平线 征程 6 工具链进阶教程 | 多任务 不同帧率 部署方案介绍]]></title>    <link>https://juejin.cn/post/7603352117639086089</link>    <guid>https://juejin.cn/post/7603352117639086089</guid>    <pubDate>2026-02-06T08:33:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603352117639086089" data-draft-id="7603309951227265074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="地平线 征程 6 工具链进阶教程 | 多任务 不同帧率 部署方案介绍"/> <meta itemprop="keywords" content="自动驾驶,算法"/> <meta itemprop="datePublished" content="2026-02-06T08:33:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="地平线开发者"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032132567"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            地平线 征程 6 工具链进阶教程 | 多任务 不同帧率 部署方案介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032132567/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    地平线开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:33:33.000Z" title="Fri Feb 06 2026 08:33:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.需求场景</h2>
<p>在智能驾驶等复杂业务场景中，模型往往具备​<strong>多任务分支结构</strong>​，例如在同一个网络中同时包含​<strong>​ BEV 动态任务</strong>​（如目标检测、跟踪、运动预测）与​<strong>​ BEV 静态任务</strong>​（如地图构建、车道线提取、可行驶区域预测），这些任务对推理频率（Frames Per Second， FPS）的要求通常并不相同。也就是有不同任务分支 推理不同帧率的需求，例如 BEV 动态任务 20 帧，静态任务 10 帧这种情况，BEV 模型结构简单示例如下所示。</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjhhMWM1ODFkNDY5MWExYjJjMDE1MmY3NjBhYzdhY2ZfZllUV2gxUkVqVk90dGFCSTJDUGNKSUtLdnRvQlpCN2hfVG9rZW46RzJJNGJ1REREb0QxTkh4dTBZOWMyZkFEbkZnXzE3NzAzNjYzNTI6MTc3MDM2OTk1Ml9WNA" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2.技术分析</h2>
<p>以 BEV 动静态任务为例，实现不同任务分支推理不同帧率（动态 20 帧，静态 10 帧），很容易想到两种方案：</p>
<p><strong>​方案 1-​</strong>拆分为三个子模型：模型 1-公共部分（backbone+neck）、模型 2-动态 head、模型 3-静态 head</p>
<ol>
<li>模型 1 推理 20 次，输出分别送给模型 2 推理 20 次，模型 3 推理 10 次。</li>
<li>优点：应用层可灵活调度 3 个子模型的推理；模型 1-公共部分 只需要推理 20 次；</li>
<li>缺点：模型 1-公共部分的输出内存需要额外存储，增加 load/store 带宽消耗；拆分次数多，影响编译时的全图优化，可能会增加 latency；</li>
</ol>
<p><strong>​方案 2-​</strong>拆分为两个子模型：模型 1-公共动态（backbone+neck+ 动态 head）、模型 2-公共静态（backbone+neck+ 静态 head）：</p>
<ol>
<li>模型 1-公共动态推理 20 次，模型 2-公共静态推理 10 次。</li>
<li>优点：应用层可灵活调度 2 个子模型的推理；只需准备整个模型输入/出内存，无需准备公共部分输出的内存；拆分次数少，编译时可全图优化，减小 latency；</li>
<li>缺点：公共部分（backbone+neck）需要推理 30 次，造成 latency 增加与 BPU 资源浪费；公共部分需要存储两份；</li>
</ol>
<p>为了兼顾方案 1 与方案 2 的优点，同时实现不同任务分支推理不同帧率，工具链提供了 link 打包功能，具体打包方式如下：</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=MDI2ODY0NWExY2ZmYWI0MzVhYTQwNmExZTlmYjMyZjNfY2FFeFVMTGZ5OUVrWHRRUG82TUtodHZEVEN4ZElDTFFfVG9rZW46WTFwaWJOSWN4b0Jlb3Z4WkdmN2NHbnh5bkFlXzE3NzAzNjYzNTI6MTc3MDM2OTk1Ml9WNA" alt="" loading="lazy"/></p>
<p>工具链提供的 link 功能，能够 复用 不同 模型/任务 的公共部分 constant 常量（包括权重等），即不会存储多份，在模型加载时，公共部分只会占用一份静态内存，需要注意推理时动态内存不会复用（​<strong>作为不同模型处理</strong>​），关于内存占用相关介绍可见文章《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13161" target="_blank" title="https://developer.horizon.auto/blog/13161" ref="nofollow noopener noreferrer">【地平线 J6 工具链入门教程】板端部署 UCP 使用指南-内存占用</a>》。</p>
<p>上图中将模型 1 与模型 2 link 打包生成的模型 3，相比于模型 1 体积不会大多少，同时具备推理模型 1 与模型 2 的功能。根据需求，调整模型 1 与模型 2 的推理次数，即可实现不同任务采用不同帧率部署。</p>
<p>如下图所示：推理一次模型 1，可实现动态任务 head 与静态任务 head 各推理一次，推理模型 2 可实现仅推理一次动态任务 head，当模型 1 推理 10 次、模型 2 推理 10 次时，即可实现动态推理 20 次，静态推理 10 次的效果。（公共部分 backbone+neck 仅推理 20 次）</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=MDgyZWE4YmM5ZmIzYTAwMjg5M2FmNjE0MmEwNmE4YWVfYlBDNmU4cDQyZ0RqYzlya1MyQWZBQVFVbXVhNUhweThfVG9rZW46SHpEcmJDQ3lVb0VpRFB4M3BRbWM0S0s0bmJoXzE3NzAzNjYzNTI6MTc3MDM2OTk1Ml9WNA" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">3.方案实现</h2>
<h3 data-id="heading-3"><strong>3.1 模型 link 打包</strong></h3>
<p>根据需求场景，先将多任务模型拆分导出为不同子任务的 qat.bc，然后分别将他们编译成 hbo 文件，最后将多个 hbo 文件 link 打包为一个 hbm 模型。</p>
<p>在工具链用户手册《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fadvanced_content%2Fhbdk_api_reference.html" target="_blank" title="https://docs.oe.horizon.auto/guide/advanced_content/hbdk_api_reference.html" ref="nofollow noopener noreferrer">HBDK Tool API Reference</a>》章节中详细介绍了 compile 与 link API，可以看到：</p>
<ul>
<li>compile 输出同时支持 hbm 与 hbo 两种文件格式，可通过配置文件后缀名为"。hbm" or ".hbo"来区分。</li>
<li>link 支持将多个 hbo 文件打包生成一个 hbm 文件。</li>
</ul>
<p>将两个 hbo 文件通过 link 打包生成一个 hbm 模型，示例代码如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">from horizon_plugin_pytorch.quantization.hbdk4 import export
from hbdk4.compiler import load, convert, compile, link
# export 阶段记得配置 name
qat_bcA = export(qat_model_A, example_input, name="1_backbone_head1_head2")
quantized_modelA = convert(qat_bcA, "nash-m")
# 注意：此时compile生成的模型后缀名为.hbo
hbo_nameA = "nameA_compiled.hbo"
hboA = compile(quantized_modelA, path=hbo_nameA, march="nash-m", opt=2, progress_bar=True, jobs=48)

qat_bcB = export(qat_model_B, example_input, name="2_backbone_head1")
quantized_modelB = convert(qat_bcB, "nash-m")
hbo_nameB = "nameB_compiled.hbo"
hboB = compile(quantized_modelB, path=hbo_nameB, march="nash-m", opt=2, progress_bar=True, jobs=48)

# link生成打包模型，后缀名为.hbm
hbm_name = "compiled.hbm"
hbm = link([hboA, hboB], hbm_name)
# 如果在其他地方已经生成了hbo
# 可以通过 hbo = Hbo(hbo_name) 进行加载 所需头文件： from hbdk4.compiler.hbm import Hbo
</code></pre>
<h3 data-id="heading-4">3.2 打包模型推理</h3>
<h4 data-id="heading-5">3.2.1 hrt_model_exec 工具推理</h4>
<p>通过 <code>hrt_model_exec model_info --model_file compiled.hbm</code> 可查看打包模型的数量，输入输出等信息，示例如下</p>
<pre><code class="hljs language-Plain" lang="Plain">This model file has 2 model:
[2_backbone_head1]      [1_backbone_head1_head2]
---------------------------------------------------------------------
[model name]: 2_backbone_head1

input[0]:
name: ...

output[0]:
name: ...

---------------------------------------------------------------------

---------------------------------------------------------------------
[model name]: 1_backbone_head1_head2

input[0]:
name: ...

output[0]:
name: ...

output[1]:
name: ...
</code></pre>
<p>结合--model_file 与--model_name 即可实现对打包 compiled.hbm 模型中的某一个模型进行推理。</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=NDUxMTNlNTk5MDE0YjU3ZmI1NzdlNTQ0MDVjZjdiNTFfcmZHQkZmNmZ6NjdoMlhYNm9XWU84RmJVbHB0NnRTZlFfVG9rZW46UFNld2JKZGs3b2w0eWF4V29pdGNOWmJBbnBmXzE3NzAzNjYzNTI6MTc3MDM2OTk1Ml9WNA" alt="" loading="lazy"/></p>
<p>以 perf 评测打包 compiled.hbm 模型 中 2_backbone_head1 的性能为例，参考命令如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">hrt_model_exec perf --model_file compiled.hbm --model_name 2_backbone_head1
</code></pre>
<h4 data-id="heading-6">3.2.2 UCP API 推理</h4>
<p>在工具链用户手册《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fucp%2Fruntime%2Fbpu_sdk_api%2Ffunction_interface%2Fmodel_loading_releasing.html" target="_blank" title="https://docs.oe.horizon.auto/guide/ucp/runtime/bpu_sdk_api/function_interface/model_loading_releasing.html" ref="nofollow noopener noreferrer">统一计算平台 UCP - 模型推理开发 - 模型推理 API 手册 - 功能接口</a>》中，详细介绍了加载打包模型 hbDNNInitializeFromFiles 与 获取单个模型句柄 hbDNNGetModelHandle 的使用方式，截图如下：</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=MDUyODQ3NTJmODUwZDRhNjc1MThlOGNmM2UzOTViZjZfd0dFSnEwelBvdG5jUXZMaGdidUJtbGxMbzlrNjVEQ0lfVG9rZW46WUdvMGJER1lUb0ZwaXJ4UktsRmNuYXZpbjdlXzE3NzAzNjYzNTI6MTc3MDM2OTk1Ml9WNA" alt="" loading="lazy"/></p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=N2VkNjg1OWM0NjcwYjQ5OGFhOWQ4NzY0NDEzNmViYjhfWFlaOXN4Ymo1aHJuUFJXYXNjMHZiTnVSaXU1ZExWV2pfVG9rZW46SW9TRGJ2V3pOb1ZCeUl4dzRGa2MwSnlJblNkXzE3NzAzNjYzNTI6MTc3MDM2OTk1Ml9WNA" alt="" loading="lazy"/></p>
<p>在工具链开发包路径：OE/samples/ucp_tutorial/dnn/basic_samples 下方的示例中有用到这两个接口，可参考使用。</p>
<h3 data-id="heading-7">3.3 多任务不同帧率推理</h3>
<p>根据需求，调整打包模型 compiled.hbm 中的 模型 1 backbone_head1_head2 与模型 2 backbone_head1 的推理次数，即可实现不同任务采用不同帧率部署。</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjBjNDI5OWI0ODBmYTc2YmVmNDcwMWYzOWI4ZjY4ZTJfYU02WXVKMTZsVWw3Q2J5VkJ3YnhOTDFIUFBvakRFaVdfVG9rZW46UWVLbmJpZElHbzBGTFh4TTJxN2NBdXRmbmRmXzE3NzAzNjYzNTI6MTc3MDM2OTk1Ml9WNA" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">3.4 性能数据示例</h3>
<p>下表中，backbone_head1 是公共部分，​<strong>注意</strong>​：公共部分权重是一样的</p>


































<table><thead><tr><th><strong>模型名称</strong></th><th><strong>模型大小/KB</strong></th><th><strong>模型 name</strong></th><th><strong>latency/ms</strong></th></tr></thead><tbody><tr><td>1_backbone_head1_head2.hbm</td><td>30295</td><td>/</td><td>5.19</td></tr><tr><td>2_backbone_head1.hbm</td><td>21781</td><td>/</td><td>4.84</td></tr><tr><td>compiled.hbm</td><td>30776</td><td>1_backbone_head1_head2</td><td>5.18</td></tr><tr><td>2_backbone_head1</td><td>4.83</td><td/></tr></tbody></table>
<p>可以看到，compiled.hbm 体积相比于 1_backbone_head1_head2.hbm 并没有增加多少。</p>
<p>模型加载推理时，ION 内存差异如下：</p>
<p>加载 1_backbone_head1_head2.hbm，直接推理：</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=NmZjZmY0NjY5OWNhMTdmMWEwNWIwMmI4NmI1YzliYzJfSEozNDNZS2dsMUp3RTlWemROTXZMRW5hR3RHemdITTFfVG9rZW46WlZtU2JWVWE3bzZ5UVd4cmd1cmNIYjRubm1kXzE3NzAzNjYzNTI6MTc3MDM2OTk1Ml9WNA" alt="" loading="lazy"/></p>
<p>加载 compiled.hbm，推理 1_backbone_head1_head2：</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=Yzc3OWIyZWJiZTYzZTVlYWY1ODM0Y2FhZDExNDlhOThfZ0xWNzNYV1RMbnFDRHQ0aWdhQ2RmcXBPNzNWTlFUekRfVG9rZW46R0RQR2JKMGJGb2F2N1B4eFhlS2NSRGVMblBiXzE3NzAzNjYzNTI6MTc3MDM2OTk1Ml9WNA" alt="" loading="lazy"/></p>
<p>可以看到，compiled.hbm 占用的内存相比于 1_backbone_head1_head2.hbm 并没有增加多少。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Posix线程/C++11多线程基础]]></title>    <link>https://juejin.cn/post/7603393977477103642</link>    <guid>https://juejin.cn/post/7603393977477103642</guid>    <pubDate>2026-02-06T08:32:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603393977477103642" data-draft-id="7603393977477087258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Posix线程/C++11多线程基础"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T08:32:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小王在进步"/> <meta itemprop="url" content="https://juejin.cn/user/4062019467609459"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Posix线程/C++11多线程基础
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4062019467609459/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小王在进步
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:32:57.000Z" title="Fri Feb 06 2026 08:32:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Posix线程/C++11多线程</h2>
<p>本文对比了<code>POSIX pthreads</code>和<code>C++11 threads</code>在多线程编程中的应用,包括线程创建、
线程组、线程传参及类成员函数作为线程函数的实现,适合初学者和开发者深入理解C++多线程
编程。</p>
<p>在C++11引进多线程之前，我们不得不用<code>POSIX pthreads</code>来编写多线程程序。</p>
<pre><code class="hljs">POSIX pthreads 是POSIX标准的一部分，它提供了一组函数和宏，用于创建和管理线程。
虽然 POSIX pthreads 功能强大，但它的API相对复杂，使用起来比较繁琐。
</code></pre>
<p>本文包括了以下内容：</p>
<ul>
<li>POSIX多线程实践</li>
<li>C++11多线程实践</li>
<li>类成员函数作为线程函数的实现</li>
</ul>
<h3 data-id="heading-1">一、POSIX多线程实践</h3>
<h4 data-id="heading-2">创建简单线程</h4>
<p>创建一个线程，用pthread_join()阻塞，等待线程结束。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">callback</span><span class="hljs-params">(<span class="hljs-type">void</span>*)</span>
</span>{
    cout &lt;&lt; <span class="hljs-string">"子线程ID: "</span> &lt;&lt; <span class="hljs-built_in">pthread_self</span>() &lt;&lt; endl;<span class="hljs-comment">//获取当前线程ID</span>
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-type">pthread_t</span> tid;
    <span class="hljs-built_in">pthread_create</span>(&amp;tid,<span class="hljs-literal">NULL</span>,callback,<span class="hljs-literal">NULL</span>);
    <span class="hljs-built_in">pthread_join</span>(tid,<span class="hljs-literal">NULL</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70495996da1947cd81e6b0c8607ada5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP546L5Zyo6L-b5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971577&amp;x-signature=ASfisyurbM7ecmhu1qwibtKB5rE%3D" alt="image-2.png" loading="lazy"/></p>
<h4 data-id="heading-3">多个线程实现</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> NUM_THREADS = <span class="hljs-number">5</span>; <span class="hljs-comment">//线程数量</span>

<span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">call_from_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span> </span>{
    cout &lt;&lt; <span class="hljs-string">"Hello from thread: "</span> &lt;&lt; <span class="hljs-built_in">pthread_self</span>() &lt;&lt; endl;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-type">pthread_t</span> t[NUM_THREADS];
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NUM_THREADS; i++)
    {
        <span class="hljs-built_in">pthread_create</span>(&amp;t[i],<span class="hljs-literal">NULL</span>,call_from_thread,<span class="hljs-literal">NULL</span>);
    }
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NUM_THREADS; i++)
    {
        <span class="hljs-built_in">pthread_join</span>(t[i],<span class="hljs-literal">NULL</span>);<span class="hljs-comment">//等待线程结束</span>
    }
 

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26fc854da77e406d8733686eb4de5ce6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP546L5Zyo6L-b5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971577&amp;x-signature=d2W%2FvSnT34V1zco%2BGXZXsE9UUEc%3D" alt="image-3.png" loading="lazy"/></p>
<p>当创建多个子线程时，外加主线程共六个线程，我们可以看到线程之间是平等竞争临界资源关系的，顺序是无序的，因此如果要明确确定顺序，则需要同步术语来改进，如互斥锁、条件变量等。</p>
<h4 data-id="heading-4">线程传参的实现</h4>
<p>线程的传参可以是简单的数据类型，也可以是自定义数据类型，因此我们在编写线程传参的时候要留意。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> NUM_THREADS = <span class="hljs-number">5</span>;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">thread_data</span> {
  <span class="hljs-type">int</span> thread_id;  
};
 
<span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">call_from_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span> </span>{
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">thread_data</span> *th_data = (<span class="hljs-keyword">struct</span> thread_data *)arg;
    cout &lt;&lt; <span class="hljs-string">"Hello from thread "</span> &lt;&lt; th_data-&gt;thread_id &lt;&lt; endl;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-type">pthread_t</span> t[NUM_THREADS];
    thread_data td[NUM_THREADS];


    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;NUM_THREADS;i++){
        td[i].thread_id = i;
        <span class="hljs-built_in">pthread_create</span>(&amp;t[i],<span class="hljs-literal">NULL</span>,call_from_thread,&amp;td[i]); <span class="hljs-comment">//td[i]作为参数传递给call_from_thread函数</span>
    }
  
    cout &lt;&lt; <span class="hljs-string">"Hello from main thread"</span> &lt;&lt; endl;

    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;NUM_THREADS;i++){
        <span class="hljs-built_in">pthread_join</span>(t[i],<span class="hljs-literal">NULL</span>);<span class="hljs-comment">//等待线程结束 </span>
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f17b241668a144da80790b77efabbdf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP546L5Zyo6L-b5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971577&amp;x-signature=zoLC6ktuOS6h7m9ezwyo9ZTvoN4%3D" alt="image-4.png" loading="lazy"/></p>
<p>再一次验证了，线程之间是竞争、无序的。</p>
<h3 data-id="heading-5">二、C++11多线程实践</h3>
<p>C++11增加了多线程，能够更简便的实现多线程编程，并且兼容POSIX pthreads。</p>
<h4 data-id="heading-6">简单线程</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

 <span class="hljs-comment">//普通函数作为线程函数</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">call_from_thread</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-comment">// 为了防止输出乱序，实际项目中通常加锁，这里为了演示简单省略</span>
    cout &lt;&lt; <span class="hljs-string">"Hello from thread"</span> &lt;&lt; endl;
}



<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
   <span class="hljs-function">thread <span class="hljs-title">tid</span><span class="hljs-params">(call_from_thread)</span></span>; <span class="hljs-comment">//创建、启动线程</span>
   tid.<span class="hljs-built_in">join</span>(); <span class="hljs-comment">//等待线程结束</span>
  
    cout &lt;&lt; <span class="hljs-string">"Hello from main thread"</span> &lt;&lt; endl;

    <span class="hljs-comment">//lambda表达式作为线程函数</span>
    <span class="hljs-keyword">auto</span> f = [](<span class="hljs-type">const</span> std::string&amp; name){
        cout &lt;&lt; <span class="hljs-string">"Hello"</span> &lt;&lt; name &lt;&lt; endl;
    };

    <span class="hljs-function">thread <span class="hljs-title">tid2</span><span class="hljs-params">(f,<span class="hljs-string">"Tom"</span>)</span></span>; <span class="hljs-comment">//创建、启动线程</span>
    tid2.<span class="hljs-built_in">join</span>(); <span class="hljs-comment">//等待线程结束</span>

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc74632f6ba94c39b8aefeebe31c5f8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP546L5Zyo6L-b5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971577&amp;x-signature=bdcgS6hzPlr6bhZFmOIR8DX2Ag0%3D" alt="image-5.png" loading="lazy"/></p>
<p>C++11线程其实是和POSIX线程API创建的线程本质上是一样的,只是C++11线程封装了POSIX线程API,并且提供了更简洁的接口。</p>
<p>main函数创建了线程call_back函数，并在tid.join()处等待线程结束。如果忘记等待，main线程有可能先完成，导致程序提前退出，会杀死之前所创建的线程。</p>
<h4 data-id="heading-7">多个线程实现</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>

<span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> NUM_THREADS = <span class="hljs-number">10</span>; <span class="hljs-comment">// 线程数量</span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-comment">// 普通函数作为线程函数</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">call_from_thread</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// 为了防止输出乱序，实际项目中通常加锁，这里为了演示简单省略</span>
    cout &lt;&lt; <span class="hljs-string">"Hello from thread"</span> &lt;&lt; endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    thread t[NUM_THREADS]; <span class="hljs-comment">// 创建线程数组</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NUM_THREADS; ++i)
    {
        t[i] = <span class="hljs-built_in">thread</span>(call_from_thread); <span class="hljs-comment">// 创建、启动线程</span>
    }

    cout &lt;&lt; <span class="hljs-string">"Hello from main thread"</span> &lt;&lt; endl;

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NUM_THREADS; ++i)
    {
        t[i].<span class="hljs-built_in">join</span>(); <span class="hljs-comment">// 等待线程结束</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/772275adbab648a3a8f6e01bd7e7bfec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP546L5Zyo6L-b5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971577&amp;x-signature=TYGrpoNn8y8kUJgZad5%2BgsyGcsY%3D" alt="image-7.png" loading="lazy"/>
可以发现我们也可以在主线程之后做一些工作。</p>
<p>多个线程同时运送后没有特定的顺序，我们在编程时要确保线程不会修改临界资源，如果多个线程之间确实要竞争一些资源，我们需要编写更复杂的并行代码，使用类似nutex、atomic等方法避免上述问题。</p>
<h4 data-id="heading-8">线程传参的实现</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-comment">// 普通函数作为线程函数</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">call_from_thread</span><span class="hljs-params">(string&amp; s)</span>
</span>{
    <span class="hljs-comment">// 为了防止输出乱序，实际项目中通常加锁，这里为了演示简单省略</span>
    cout &lt;&lt; <span class="hljs-string">"Hello from thread :"</span> &lt;&lt; s &lt;&lt; endl;
    s = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">//修改传入的参数</span>
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{   
    string str = <span class="hljs-string">"Jaylan"</span>;
    <span class="hljs-function">thread <span class="hljs-title">t</span><span class="hljs-params">(&amp;call_from_thread,std::ref(str))</span></span>; <span class="hljs-comment">// 创建线程，并传递参数,ref()表示显式的引用传递</span>
    t.<span class="hljs-built_in">join</span>(); <span class="hljs-comment">// 等待线程结</span>
    cout &lt;&lt; <span class="hljs-string">"Hello from main thread="</span> &lt;&lt; str &lt;&lt; endl;

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e76fce929a5a422c855606cd1c49fbf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP546L5Zyo6L-b5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971577&amp;x-signature=Ivt5M0tAekQwelBfs76xN5bI%2Fow%3D" alt="image-8.png" loading="lazy"/>
先阻塞了主线程，等待线程结束，然后输出修改后的参数。</p>
<h3 data-id="heading-9">三、类成员函数作为线程函数的实现</h3>
<p>在线程中如何将一个类成员函数作为线程函数呢？</p>
<p>成员方法作为线程来执行，有以下好处：</p>
<ul>
<li>线程的变量传递会非常方便，直接读取成员变量即可。</li>
<li>线程体作为对象的一部分，可以访问对象的私有变量和方法。</li>
</ul>
<h4 data-id="heading-10">成员函数作为线程函数（POSIX threads）</h4>
<p>语法：<code>int pthread_create(pthread_t *thread, pthread_attr_t *attr, void *(*routine)(void*), void* arg);</code></p>
<p>主要第三个参数routine是一个普通函数，而不是一个类成员函数，这是为什么？
先测试一下：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AA</span>
{
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">AA</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name);
    <span class="hljs-type">void</span> sayHelo*();
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span>;
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* m_name;
    <span class="hljs-type">pthread_t</span> m_thread; <span class="hljs-comment">//线程</span>
}

AA::<span class="hljs-built_in">AA</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name):<span class="hljs-built_in">m_name</span>(name)
{
    <span class="hljs-built_in">pthread_create</span>(&amp;m_thread,<span class="hljs-literal">NULL</span>,AA::sayHelo,<span class="hljs-keyword">this</span>);
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/751b8c71fee34eaca0533905ec6d912f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP546L5Zyo6L-b5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971577&amp;x-signature=KPMesGH7SSDfUw7w%2BKwvmEcF8M0%3D" alt="image-9.png" loading="lazy"/>
分析报错信息，成员函数默认是非静态函数，那么我们尝试将pthread_create的第三个参数改为静态函数。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title">createThread</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span>
</span>{
    A* pa = (A*)arg;
    pa-&gt;<span class="hljs-built_in">sayHello</span>();
    <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>; 
}

AA::<span class="hljs-built_in">AA</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name):<span class="hljs-built_in">m_name</span>(name)
{
    <span class="hljs-built_in">pthread_create</span>(&amp;m_thread,<span class="hljs-literal">NULL</span>,createThread,<span class="hljs-keyword">this</span>);
}
</code></pre>
<p>我们通过static函数createThread作为第三个参数，同时使用第四个参数this线程传参，进而在createThread简间接调用class中的成员方法。
还有一种方法是：将routine函数声明为该类的友元函数，这样routine函数就可以直接调用该类的成员函数了。</p>
<p>还可以利用lambda函数，lambda函数可以捕获类成员变量，从而在lambda函数中调用类成员函数。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AA</span>
{
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">AA</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name);
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">sayHelo</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span>;
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* m_name;
    <span class="hljs-type">pthread_t</span> m_thread; <span class="hljs-comment">//线程</span>
};
AA::<span class="hljs-built_in">AA</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name):<span class="hljs-built_in">m_name</span>(name)
{
    <span class="hljs-keyword">auto</span> f = [](<span class="hljs-type">void</span>* arg)
    {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"word thread\n"</span>);
        AA* a = (AA*)arg;
        a-&gt;<span class="hljs-built_in">sayHelo</span>();
        <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>; <span class="hljs-comment">//子线程退出，并返回一个空指针</span>
    };
    <span class="hljs-built_in">pthread_create</span>(&amp;m_thread,<span class="hljs-literal">NULL</span>,f,<span class="hljs-keyword">this</span>);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">AA::sayHelo</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"hello,%s\n"</span>,m_name);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">AA::stop</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">pthread_join</span>(m_thread,<span class="hljs-literal">NULL</span>); <span class="hljs-comment">//主线程等待子线程结束</span>
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-type">pthread_t</span> tid;
    <span class="hljs-function">AA <span class="hljs-title">a</span><span class="hljs-params">(<span class="hljs-string">"张三"</span>)</span></span>;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"main thread\n"</span>);
    a.<span class="hljs-built_in">stop</span>();

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a75ad9bf94ef423c9f5ce096ba433178~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP546L5Zyo6L-b5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971577&amp;x-signature=OqCV55UC7DVpHDrn72yWo1sVPf0%3D" alt="image-10.png" loading="lazy"/></p>
<p>主线程和子线程的输出顺序是随机的，因为线程之间是竞争、无序的。</p>
<h4 data-id="heading-11">成员函数作为线程函数（C++11 threads）</h4>
<p>#include 
#include 
#include 
using namespace std;</p>
<p>class AA
{
public:
AA(const string&amp; name);
~AA();
void sayHello();
void stop();
private:
string m_name;
thread m_thread; //线程
};</p>
<p>AA::AA(const string&amp; name):m_name(name), m_thread(&amp;AA::sayHello,this){}</p>
<p>AA::~AA()
{
if(m_thread.joinable())//判断线程是否可join
{
m_thread.join(); //主线程等待子线程结束
}
}</p>
<p>void AA::sayHello()
{
cout &lt;&lt; "hello," &lt;&lt; m_name &lt;&lt; endl;
}</p>
<p>void AA::stop()
{
if(m_thread.joinable())//判断线程是否可join
{
m_thread.join(); //主线程等待子线程结束
}
}</p>
<p>int main()
{
AA a("张三");
cout &lt;&lt; "main thread.\n";
a.stop();</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
</code></pre>
<p>}</p>
<pre><code class="hljs language-ini" lang="ini">
!<span class="hljs-section">[image-11.png]</span>(https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/369b621084264dfba721bdcdeaa336dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP546L5Zyo6L-b5q2l:q75.awebp?<span class="hljs-attr">rk3s</span>=f64ab15b&amp;x-expires=<span class="hljs-number">1770971577</span>&amp;x-signature=xrP0cNhbbV2SJyjU6TJy%<span class="hljs-number">2</span>B6V55f8%<span class="hljs-number">3</span>D)

文章进行了简单的线程实践，欢迎大家一起交流学习。
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于uview-pro的u-dropdown扩展自己的dropdown组件]]></title>    <link>https://juejin.cn/post/7603393977477120026</link>    <guid>https://juejin.cn/post/7603393977477120026</guid>    <pubDate>2026-02-06T08:33:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603393977477120026" data-draft-id="7603359026711117834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于uview-pro的u-dropdown扩展自己的dropdown组件"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-06T08:33:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LC同学47981"/> <meta itemprop="url" content="https://juejin.cn/user/1978776660477991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于uview-pro的u-dropdown扩展自己的dropdown组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1978776660477991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LC同学47981
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:33:58.000Z" title="Fri Feb 06 2026 08:33:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于uview-pro的u-dropdown扩展自己的dropdown组件</h2>
<p>uview-pro的u-dropdown只能是菜单，且只能向下展开，当前组件采用它的核心逻辑，去除多余逻辑，兼容上/下展开，以及自定义展示的内容，不再局限于菜单形式</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb4d90a49ae14bebbb7d6b200b8c6672~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTEPlkIzlraY0Nzk4MQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971638&amp;x-signature=Slg5%2FeqbTZZ7uPsnhFE9EZAKwHo%3D" alt="e4043c3d-df06-4a4f-9d61-237d8254cf54.png" loading="lazy"/></p>
<pre><code class="hljs language-Typescript" lang="Typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ExtractPropTypes</span>, <span class="hljs-title class_">PropType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { baseProps } <span class="hljs-keyword">from</span> <span class="hljs-string">'uview-pro/components/common/props'</span>;

<span class="hljs-comment">/**
 * u-dropdown 下拉菜单 Props
 * <span class="hljs-doctag">@description</span> 该组件一般用于向下展开菜单，同时可切换多个选项卡的场景
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">DropdownProps</span> = {
  ...baseProps,
  <span class="hljs-comment">/** 点击遮罩是否关闭菜单 */</span>
  <span class="hljs-attr">closeOnClickMask</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>, <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span> },
  <span class="hljs-comment">/** 过渡时间 */</span>
  <span class="hljs-attr">duration</span>: { <span class="hljs-attr">type</span>: [<span class="hljs-title class_">Number</span>, <span class="hljs-title class_">String</span>] <span class="hljs-keyword">as</span> <span class="hljs-title class_">PropType</span>&lt;<span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>&gt;, <span class="hljs-attr">default</span>: <span class="hljs-number">300</span> },
  <span class="hljs-comment">/** 下拉出来的内容部分的圆角值 */</span>
  <span class="hljs-attr">borderRadius</span>: { <span class="hljs-attr">type</span>: [<span class="hljs-title class_">Number</span>, <span class="hljs-title class_">String</span>] <span class="hljs-keyword">as</span> <span class="hljs-title class_">PropType</span>&lt;<span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>&gt;, <span class="hljs-attr">default</span>: <span class="hljs-number">20</span> },
  <span class="hljs-comment">/** 展开方向 down/up */</span>
  <span class="hljs-attr">direction</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">PropType</span>&lt;<span class="hljs-string">'down'</span> | <span class="hljs-string">'up'</span>&gt;, <span class="hljs-attr">default</span>: <span class="hljs-string">'up'</span> },
  <span class="hljs-comment">/** 弹出层最大高度 */</span>
  <span class="hljs-attr">maxHeight</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">PropType</span>&lt;<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">number</span>}</span>rpx`</span> | <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">number</span>}</span>vh`</span>&gt;, <span class="hljs-attr">default</span>: <span class="hljs-string">'80vh'</span> },
  <span class="hljs-comment">/** 弹出层最小高度 */</span>
  <span class="hljs-attr">minHeight</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">PropType</span>&lt;<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">number</span>}</span>rpx`</span> | <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">number</span>}</span>vh`</span>&gt;, <span class="hljs-attr">default</span>: <span class="hljs-string">'0rpx'</span> },
  <span class="hljs-comment">/** 是否隐藏关闭按钮 */</span>
  <span class="hljs-attr">hiddenClose</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>, <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span> },
  <span class="hljs-comment">/** 弹出层标题 */</span>
  <span class="hljs-attr">title</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>, <span class="hljs-attr">default</span>: <span class="hljs-string">''</span> }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">DropdownProps</span> = <span class="hljs-title class_">ExtractPropTypes</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">DropdownProps</span>&gt;;

</code></pre>
<pre><code class="hljs language-VUE" lang="VUE">&lt;template&gt;
  &lt;view class="u-dropdown" :style="$u.toStyle(styles, customStyle)" :class="customClass"&gt;
    &lt;view class="u-dropdown__menu"&gt;
      &lt;slot&gt;&lt;/slot&gt;
    &lt;/view&gt;
    &lt;view
      class="u-dropdown__content"
      :style="[
        contentStyle,
        {
          transition: `opacity ${Number(duration) / 1000}s linear`,
          [currentDirection === 'down' ? 'top' : 'bottom']: menuHeight + 'px',
          height: contentHeight + 'px'
        }
      ]"
      @tap="maskClick"
      @touchmove.stop.prevent&gt;
      &lt;view @tap.stop.prevent class="u-dropdown__content__popup" :style="[popupStyle]"&gt;
        &lt;slot name="close" v-if="!hiddenClose"&gt;
          &lt;view class="u-dropdown__content__popup__close" @click="close"&gt;
            &lt;u-icon name="close" size="48" custom-prefix="custom-icon" /&gt;
          &lt;/view&gt;
        &lt;/slot&gt;

        &lt;slot name="header"&gt;
          &lt;view class="u-dropdown__content__popup__header" v-if="title"&gt; {{ title }} &lt;/view&gt;
        &lt;/slot&gt;

        &lt;view class="u-dropdown__content__popup__body"&gt;
          &lt;scroll-view scroll-y class="u-dropdown__content__popup__scroll-view"&gt;
            &lt;slot name="content"&gt;&lt;/slot&gt;
          &lt;/scroll-view&gt;
        &lt;/view&gt;
        &lt;view class="u-dropdown__content__popup__footer"&gt;
          &lt;slot name="footer"&gt;&lt;/slot&gt;
        &lt;/view&gt;
      &lt;/view&gt;
      &lt;view class="u-dropdown__content__mask"&gt;&lt;/view&gt;
    &lt;/view&gt;
  &lt;/view&gt;
&lt;/template&gt;

&lt;script lang="ts"&gt;
  export default {
    name: 'hj-dropdown',
    options: {
      addGlobalClass: true,
      // #ifndef MP-TOUTIAO
      virtualHost: true,
      // #endif
      styleIsolation: 'shared'
    }
  };
&lt;/script&gt;

&lt;script setup lang="ts"&gt;
  import { ref, computed, onMounted, getCurrentInstance, watch, type CSSProperties } from 'vue';
  import { $u } from 'uview-pro';
  import { DropdownProps } from './types';

  /**
   * dropdown 下拉菜单
   * @description 该组件一般用于向下展开菜单，同时可切换多个选项卡的场景
   * @tutorial https://uviewpro.cn/zh/components/dropdown.html
   * @property {Boolean} close-on-click-mask 点击遮罩是否关闭菜单（默认true）
   * @property {String | Number} duration 选项卡展开和收起的过渡时间，单位ms（默认300）
   * @property {String | Number} border-radius 菜单展开内容下方的圆角值，单位任意（默认20）
   * @property {String} direction 展开方向 down/up（默认up）
   * @property {String} max-height 弹出层最大高度（默认80vh）
   * @property {String} min-height 弹出层最小高度
   * @property {Boolean} hidden-close 是否隐藏关闭按钮（默认false）
   * @property {String} title 弹出层标题
   * @property {Boolean} show 是否显示下拉菜单（默认false）
   * @event {Function} open 下拉菜单被打开时触发
   * @event {Function} close 下拉菜单被关闭时触发
   * @example &lt;hj-dropdown&gt;&lt;/hj-dropdown&gt;
   */

  const props = defineProps(DropdownProps);
  const emit = defineEmits(['open', 'close']);

  // 展开状态
  const active = ref(false);
  // 外层内容样式
  const contentStyle = ref&lt;CSSProperties&gt;({
    zIndex: -1,
    opacity: 0
  });
  // 下拉内容高度
  const contentHeight = ref&lt;number&gt;(0);
  // 菜单实际高度
  const menuHeight = ref&lt;number&gt;(0);
  // 当前展开方向
  const currentDirection = ref&lt;'down' | 'up'&gt;(props.direction);
  // 子组件引用
  const instance = getCurrentInstance();

  const vShow = defineModel('show', {
    type: Boolean,
    default: false
  });

  watch(vShow, val =&gt; {
    if (val === active.value) return;
    if (val) {
      open();
    } else {
      close();
    }
  });

  // 监听方向变化
  watch(
    () =&gt; props.direction,
    val =&gt; {
      currentDirection.value = val;
    }
  );

  // 兼容头条样式
  const styles = computed&lt;CSSProperties&gt;(() =&gt; {
    const style: CSSProperties = {};
    // #ifdef MP-TOUTIAO
    style.width = '100vw';
    // #endif
    return style;
  });

  // 下拉出来部分的样式
  const popupStyle = computed&lt;CSSProperties&gt;(() =&gt; {
    const style: CSSProperties = {};
    const isDown = currentDirection.value === 'down';
    const hiddenTransformLate = isDown ? '-100%' : '100%';

    style.maxHeight = props.maxHeight;
    style.minHeight = props.minHeight;
    style.transform = `translateY(${active.value ? 0 : hiddenTransformLate})`;
    style[isDown ? 'top' : 'bottom'] = 0;
    // 进行Y轴位移，展开状态时，恢复原位。收起状态时，往上位移100%（或下），进行隐藏
    style.transitionDuration = `${Number(props.duration) / 1000}s`;

    if (isDown) {
      style.borderRadius = `0 0 ${$u.addUnit(props.borderRadius)} ${$u.addUnit(props.borderRadius)}`;
    } else {
      style.borderRadius = `${$u.addUnit(props.borderRadius)} ${$u.addUnit(props.borderRadius)} 0 0`;
    }
    return style;
  });

  // 生命周期
  onMounted(() =&gt; {
    getContentHeight();
  });

  /**
   * 打开下拉菜单
   * @param direction 展开方向 'down' | 'up'
   */
  function open(direction?: 'down' | 'up') {
    currentDirection.value = direction || props.direction;

    // 重新计算高度，因为方向可能改变
    getContentHeight();

    // 设置展开状态
    active.value = true;

    // 展开时，设置下拉内容的样式
    contentStyle.value = {
      zIndex: 11,
      opacity: 1
    };
    vShow.value = true;
    emit('open');
  }

  /**
   * 关闭下拉菜单
   */
  function close() {
    // 下拉内容的样式进行调整，不透明度设置为0
    active.value = false;
    contentStyle.value = {
      ...contentStyle.value,
      opacity: 0
    };

    // 等待过渡动画结束后隐藏 z-index
    vShow.value = false;
    setTimeout(() =&gt; {
      contentStyle.value = {
        zIndex: -1,
        opacity: 0
      };
      emit('close');
    }, Number(props.duration));
  }

  /**
   * 点击遮罩
   */
  function maskClick() {
    if (!props.closeOnClickMask) return;
    close();
  }

  /**
   * 获取下拉菜单内容的高度
   * @description
   * dropdown组件是相对定位的，下拉内容必须给定高度，
   * 才能让遮罩占满菜单以下直到屏幕底部的高度。
   */
  function getContentHeight() {
    const windowHeight = $u.sys().windowHeight;

    $u.getRect('.u-dropdown__menu', instance).then((res: any) =&gt; {
      // 获取菜单实际高度
      menuHeight.value = res.height;

      /**
       * 尺寸计算说明：
       * 在H5端，uniapp获取尺寸存在已知问题：
       * 元素尺寸的top值为导航栏底部到元素的上边沿的距离
       * 但元素的bottom值却是导航栏顶部到元素底部的距离
       * 为避免页面滚动，此处取菜单栏的bottom值进行计算
       */
      if (currentDirection.value === 'up') {
        contentHeight.value = res.top;
      } else {
        contentHeight.value = windowHeight - res.bottom;
      }
    });
  }

  // 暴露方法
  defineExpose({
    close,
    open
  });
&lt;/script&gt;

&lt;style scoped lang="scss"&gt;
  @import 'uview-pro/libs/css/style.components';

  .u-dropdown {
    flex: 1;
    width: 100%;
    position: relative;
    background-color: #fff;

    &amp;__content {
      position: absolute;
      z-index: 8;
      width: 100%;
      left: 0;
      overflow: hidden;

      &amp;__mask {
        position: absolute;
        z-index: 9;
        background: rgba(0, 0, 0, 0.3);
        width: 100%;
        left: 0;
        top: 0;
        bottom: 0;
      }

      &amp;__popup {
        position: absolute;
        width: 100%;
        z-index: 10;
        transition: all 0.3s;
        transform: translate3D(0, -100%, 0);
        overflow: hidden;
        background-color: var(--gray-2);

        &amp;__close {
          width: 40rpx;
          height: 40rpx;
          display: flex;
          align-items: center;
          justify-content: center;
          position: absolute;
          right: 24rpx;
          top: 30rpx;
          z-index: 9;
        }

        &amp;__header {
          display: flex;
          color: var(--title-1);
          font-size: var(--ft-32);
          font-weight: 500;
          line-height: 44rpx;
          padding: 30rpx 24rpx;
        }

        &amp;__body {
          flex: 1;
          overflow: hidden;
          display: flex;
        }

        &amp;__scroll-view {
          flex: 1;
        }

        &amp;__footer {
          display: flex;
        }
      }
    }
  }
&lt;/style&gt;

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript的数据类型 —— Boolean类型]]></title>    <link>https://juejin.cn/post/7603309951227297842</link>    <guid>https://juejin.cn/post/7603309951227297842</guid>    <pubDate>2026-02-06T08:35:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951227297842" data-draft-id="7603185231801335834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript的数据类型 —— Boolean类型"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-06T08:35:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="橘朵"/> <meta itemprop="url" content="https://juejin.cn/user/1099989273025416"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript的数据类型 —— Boolean类型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099989273025416/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    橘朵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:35:07.000Z" title="Fri Feb 06 2026 08:35:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>Boolean</code>（布尔值）类型有两个字面值：<code>true</code>和<code>false</code>。 这两个布尔值不同于数值，因此 <code>true</code> 不等于 1，<code>false</code> 不等于 0。</p>
<p>虽然布尔值只有两个，但所有其他类型的值都有相应布尔值的等价形式，可以调用特定的<code>Boolean()</code> 转型函数：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">message</span> = <span class="hljs-string">"Hello world!"</span><span class="hljs-comment">; </span>
let <span class="hljs-attr">messageAsBoolean</span> = Boolean(message)<span class="hljs-comment">;</span>
</code></pre>
<p><code>Boolean()</code>转型函数可以在任意类型的数据上调用，而且始终返回一个布尔值。</p>
<p>下面是不同类型与布尔值之间的转换规则：</p>



































<table><thead><tr><th>数据类型</th><th>Truthy（真值）</th><th>Falsy（假值）</th></tr></thead><tbody><tr><td>Boolean</td><td>true</td><td>false</td></tr><tr><td>String</td><td>非空字符串</td><td>""（空字符串）</td></tr><tr><td>Number</td><td>非零数值（包括无穷值）</td><td>0、-0、NaN</td></tr><tr><td>Object</td><td>任意对象，包括空数组 <code>[]</code>和空对象 <code>{}</code></td><td>null</td></tr><tr><td>Undefined</td><td>N/A（不存在）</td><td>undefined</td></tr></tbody></table>
<p><strong>直接赋值</strong>：最直接的方式。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">isActive</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">isLoading</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
</code></pre>
<p><strong>通过表达式</strong>：比较或逻辑运算的结果是布尔值。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">isGreater</span> = <span class="hljs-number">5</span> &gt; <span class="hljs-number">3</span><span class="hljs-comment">; // true</span>
let <span class="hljs-attr">isEqual</span> = (<span class="hljs-number">10</span> === <span class="hljs-string">"10"</span>)<span class="hljs-comment">; // false</span>
let <span class="hljs-attr">logicResult</span> = (<span class="hljs-number">5</span> &gt; <span class="hljs-number">3</span>) &amp;&amp; (<span class="hljs-number">4</span> &lt;= <span class="hljs-number">4</span>)<span class="hljs-comment">; // true</span>
</code></pre>
<p><strong>显式转换</strong>：使用 <code>Boolean()</code>函数或双重非运算符 <code>!!</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 Boolean() 函数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Boolean</span>(<span class="hljs-string">"Hello"</span>)); <span class="hljs-comment">// true (非空字符串是 truthy)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Boolean</span>(<span class="hljs-number">0</span>)); <span class="hljs-comment">// false (0 是 falsy)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Boolean</span>({})); <span class="hljs-comment">// true (空对象是 truthy)</span>

<span class="hljs-comment">// 使用 !! 运算符，效果相同但更简洁</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(!!<span class="hljs-string">"Hello"</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(!!<span class="hljs-number">0</span>); <span class="hljs-comment">// false</span>
</code></pre>
<p>不建议使用<code>Boolean</code>构造函数（通过 <code>new</code>关键字）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建原始布尔值</span>
<span class="hljs-keyword">let</span> primitiveTrue = <span class="hljs-literal">true</span>;
<span class="hljs-comment">// 创建 Boolean 对象</span>
<span class="hljs-keyword">let</span> objectTrue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Boolean</span>(<span class="hljs-literal">true</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> primitiveTrue); <span class="hljs-comment">// "boolean"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> objectTrue); <span class="hljs-comment">// "object"</span>

<span class="hljs-comment">// 即使包装的对象值为 false，其本身作为对象在条件判断中仍为 true</span>
<span class="hljs-keyword">let</span> objectFalse = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Boolean</span>(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">if</span> (objectFalse) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"This will be executed."</span>); <span class="hljs-comment">// 这行会被执行</span>
}
</code></pre>
<p><strong>布尔值的应用：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//条件判断：控制代码分支。</span>
<span class="hljs-keyword">let</span> isLoggedIn = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">if</span> (isLoggedIn) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Welcome back!"</span>);
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Please log in."</span>);
}

<span class="hljs-comment">//循环控制：决定循环是否继续执行。</span>
<span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
<span class="hljs-keyword">while</span> (count &lt; <span class="hljs-number">5</span>) { <span class="hljs-comment">// 条件为 true 时循环继续</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count);
  count++;
}

<span class="hljs-comment">//函数返回：函数常用布尔值返回操作结果或状态检查。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isAdult</span>(<span class="hljs-params">age</span>) {
  <span class="hljs-keyword">return</span> age &gt;= <span class="hljs-number">18</span>;
}
<span class="hljs-keyword">let</span> canVote = <span class="hljs-title function_">isAdult</span>(<span class="hljs-number">20</span>); <span class="hljs-comment">// true</span>

<span class="hljs-comment">//数据过滤：例如，结合数组的 filter方法快速过滤出有效项。</span>
<span class="hljs-keyword">const</span> mixedArray = [<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"hello"</span>, <span class="hljs-string">""</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">42</span>];
<span class="hljs-keyword">const</span> truthyValues = mixedArray.<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>); <span class="hljs-comment">// [1, "hello", 42]</span>
<span class="hljs-comment">// Boolean 函数作为回调，会自动过滤掉所有 falsy 值</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OoderA2UI BridgeCode 深度解析：从设计原理到 Trae Solo Skill 实践]]></title>    <link>https://juejin.cn/post/7602807243705237567</link>    <guid>https://juejin.cn/post/7602807243705237567</guid>    <pubDate>2026-02-05T00:38:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602807243705237567" data-draft-id="7602841282802729001" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OoderA2UI BridgeCode 深度解析：从设计原理到 Trae Solo Skill 实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-05T00:38:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OoderA2UI BridgeCode 深度解析：从设计原理到 Trae Solo Skill 实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:38:33.000Z" title="Thu Feb 05 2026 00:38:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    29
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">摘要</h2>
<p>本文深入解析 ooder 框架的核心 BridgeCode 机制，从设计原理、生成编译流程，到基于此机制的分层 SKILLS 设计，最后展示在 Trae Solo 环境中的 Skill 构建实践。通过源码分析和实战案例，揭示 ooder 如何通过元数据驱动的代码生成实现高效的 A2UI 组件开发。</p>
<h2 data-id="heading-1">一、BridgeCode 设计原理</h2>
<h3 data-id="heading-2">1.1 核心设计理念</h3>
<p>BridgeCode 是 ooder 框架中连接元数据配置与运行时组件的桥梁，其核心设计理念是<strong>元数据驱动</strong>（Metadata-Driven）：</p>
<pre><code class="hljs language-javascript" lang="javascript">元数据配置（<span class="hljs-title class_">JSON</span>/注解）
    ↓
<span class="hljs-title class_">BridgeCode</span> 生成器
    ↓
<span class="hljs-title class_">Java</span> 源代码
    ↓
动态编译
    ↓
运行时组件
</code></pre>
<p><strong>设计目标</strong>：</p>
<ol>
<li><strong>解耦性</strong>：将配置与实现分离，配置通过声明式方式定义</li>
<li><strong>可扩展性</strong>：支持多种组件类型和视图模式</li>
<li><strong>类型安全</strong>：通过编译期检查确保配置的正确性</li>
<li><strong>运行时绑定</strong>：支持动态加载和热更新</li>
</ol>
<h3 data-id="heading-3">1.2 架构层次</h3>
<p>BridgeCode 系统采用三层架构设计：</p>
<pre><code class="hljs language-javascript" lang="javascript">┌─────────────────────────────────────────────┐
│         元数据层（<span class="hljs-title class_">Metadata</span> <span class="hljs-title class_">Layer</span>）         │
│  - <span class="hljs-title class_">CustomViewMeta</span>                        │
│  - <span class="hljs-title class_">CustomDataMeta</span>                        │
│  - <span class="hljs-title class_">MethodConfig</span>                          │
└─────────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│       生成器层（<span class="hljs-title class_">Generator</span> <span class="hljs-title class_">Layer</span>）          │
│  - <span class="hljs-title class_">GenCustomViewJava</span>                     │
│  - <span class="hljs-title class_">GenRepositoryViewJava</span>                  │
│  - <span class="hljs-title class_">GenAggCustomViewJava</span>                 │
└─────────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│       运行时层（<span class="hljs-title class_">Runtime</span> <span class="hljs-title class_">Layer</span>）           │
│  - <span class="hljs-title class_">UIComponent</span>                          │
│  - <span class="hljs-title class_">ModuleUIComponent</span>                     │
│  - <span class="hljs-title class_">AggRootBuild</span>                         │
└─────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-4">1.3 核心类设计</h3>
<h4 data-id="heading-5">1.3.1 AggRootBuild - 聚合根构建器</h4>
<p>AggRootBuild 是 BridgeCode 生成流程的核心协调类，位于 <code>net.ooder.engine.codegen.java.AggRootBuild</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AggRootBuild</span> {
    
    <span class="hljs-keyword">private</span> GenCustomViewJava viewTask;
    <span class="hljs-keyword">private</span> GenRepositoryViewJava voRepositoryTask;
    <span class="hljs-keyword">private</span> GenRepositoryViewJava serviceRepositoryTask;
    <span class="hljs-keyword">private</span> GenAggCustomViewJava rootTask;
    <span class="hljs-keyword">private</span> GenAggCustomJava genAggCustomJava;
    
    <span class="hljs-keyword">public</span> List&lt;JavaGenSource&gt; <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-comment">// 1. 创建子节点</span>
        CustomViewMeta = genChildJava();
        
        <span class="hljs-comment">// 2. 创建视图层</span>
        javaViewSource = buildView();
        
        <span class="hljs-comment">// 3. 创建资源层接口</span>
        repositorySource = buildRepositoryView(<span class="hljs-literal">true</span>);
        
        <span class="hljs-comment">// 4. 预编译一次</span>
        javaGen.dynCompile(getModuleJavaSrc());
        
        <span class="hljs-keyword">return</span> aggServiceRootBean;
    }
}
</code></pre>
<p><strong>关键特性</strong>：</p>
<ul>
<li><strong>任务编排</strong>：协调多个生成任务的执行顺序</li>
<li><strong>依赖管理</strong>：处理生成任务之间的依赖关系</li>
<li><strong>增量构建</strong>：支持只生成变更的部分</li>
<li><strong>错误处理</strong>：统一的异常处理和回滚机制</li>
</ul>
<h4 data-id="heading-6">1.3.2 GenJavaTask - 生成任务基类</h4>
<p>所有代码生成器都继承自 GenJavaTask，提供统一的生成框架：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenJavaTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Callable</span>&lt;List&lt;JavaGenSource&gt;&gt; {
    
    <span class="hljs-keyword">protected</span> JavaGenSource javaGen;
    <span class="hljs-keyword">protected</span> CustomViewMeta viewMeta;
    <span class="hljs-keyword">protected</span> String euClassName;
    <span class="hljs-keyword">protected</span> Chrome chrome;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> List&lt;JavaGenSource&gt; <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JDSException;
    
    <span class="hljs-keyword">protected</span> JavaGenSource <span class="hljs-title function_">createJavaSource</span><span class="hljs-params">(String className, String content)</span> {
        <span class="hljs-type">JavaGenSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaGenSource</span>();
        source.setClassName(className);
        source.setContent(content);
        source.setPackage(viewMeta.getPackageName());
        <span class="hljs-keyword">return</span> source;
    }
}
</code></pre>
<p><strong>设计优势</strong>：</p>
<ul>
<li><strong>统一接口</strong>：所有生成器实现相同的接口</li>
<li><strong>可组合性</strong>：支持生成器的组合和复用</li>
<li><strong>错误隔离</strong>：每个生成器独立处理错误</li>
<li><strong>可测试性</strong>：每个生成器可以独立测试</li>
</ul>
<h4 data-id="heading-7">1.3.3 D2CGenerator - 设计到代码生成器</h4>
<p>D2CGenerator 是核心的代码生成引擎，使用 Freemarker 模板引擎：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">D2CGenerator</span> {
    
    <span class="hljs-keyword">private</span> Configuration freemarkerConfig;
    <span class="hljs-keyword">private</span> TemplateManager templateManager;
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generate</span><span class="hljs-params">(String templateName, Map&lt;String, Object&gt; dataModel)</span> 
            <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> freemarkerConfig.getTemplate(templateName);
            <span class="hljs-type">StringWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();
            template.process(dataModel, writer);
            <span class="hljs-keyword">return</span> writer.toString();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(<span class="hljs-string">"代码生成失败: "</span> + e.getMessage(), e);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dynCompile</span><span class="hljs-params">(List&lt;JavaGenSource&gt; sources)</span> <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-type">JavaCompiler</span> <span class="hljs-variable">compiler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaCompiler</span>();
        compiler.compile(sources);
    }
}
</code></pre>
<p><strong>技术栈</strong>：</p>
<ul>
<li><strong>模板引擎</strong>：Freemarker 2.3.x</li>
<li><strong>编译器</strong>：Java Compiler API</li>
<li><strong>类加载</strong>：自定义 ClassLoader</li>
<li><strong>打包</strong>：JAR 文件生成</li>
</ul>
<h2 data-id="heading-8">二、BridgeCode 生成编译原理</h2>
<h3 data-id="heading-9">2.1 完整生成流程</h3>
<p>BridgeCode 的生成编译流程分为五个阶段：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">阶段</span> <span class="hljs-attr">1:</span> <span class="hljs-string">元数据解析</span>
    <span class="hljs-string">↓</span>
<span class="hljs-string">阶段</span> <span class="hljs-attr">2:</span> <span class="hljs-string">代码生成</span>
    <span class="hljs-string">↓</span>
<span class="hljs-string">阶段</span> <span class="hljs-attr">3:</span> <span class="hljs-string">源码组装</span>
    <span class="hljs-string">↓</span>
<span class="hljs-string">阶段</span> <span class="hljs-attr">4:</span> <span class="hljs-string">动态编译</span>
    <span class="hljs-string">↓</span>
<span class="hljs-string">阶段</span> <span class="hljs-attr">5:</span> <span class="hljs-string">运行时绑定</span>
</code></pre>
<h3 data-id="heading-10">2.2 阶段详解</h3>
<h4 data-id="heading-11">2.2.1 阶段 1：元数据解析</h4>
<p><strong>输入</strong>：</p>
<ul>
<li>JSON 配置文件</li>
<li>Java 注解配置</li>
<li>数据库元数据</li>
</ul>
<p><strong>处理流程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetadataParser</span> {
    
    <span class="hljs-keyword">public</span> MethodConfig <span class="hljs-title function_">parseFromJson</span><span class="hljs-params">(String jsonConfig)</span> {
        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> JSON.parseObject(jsonConfig);
        <span class="hljs-type">MethodConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodConfig</span>();
        
        <span class="hljs-comment">// 解析视图元数据</span>
        config.setView(parseViewMeta(json.getJSONObject(<span class="hljs-string">"view"</span>)));
        
        <span class="hljs-comment">// 解析数据元数据</span>
        config.setDataBean(parseDataMeta(json.getJSONObject(<span class="hljs-string">"data"</span>)));
        
        <span class="hljs-comment">// 解析方法配置</span>
        config.setMethodName(json.getString(<span class="hljs-string">"methodName"</span>));
        config.setUrl(json.getString(<span class="hljs-string">"url"</span>));
        
        <span class="hljs-keyword">return</span> config;
    }
    
    <span class="hljs-keyword">public</span> MethodConfig <span class="hljs-title function_">parseFromAnnotation</span><span class="hljs-params">(Class&lt;?&gt; bridgeClass)</span> {
        <span class="hljs-type">MethodConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodConfig</span>();
        
        <span class="hljs-comment">// 解析 @CustomClass 注解</span>
        <span class="hljs-type">CustomClass</span> <span class="hljs-variable">classAnnotation</span> <span class="hljs-operator">=</span> bridgeClass.getAnnotation(CustomClass.class);
        config.setCaption(classAnnotation.caption());
        
        <span class="hljs-comment">// 解析方法注解</span>
        <span class="hljs-keyword">for</span> (Method method : bridgeClass.getMethods()) {
            <span class="hljs-keyword">if</span> (method.isAnnotationPresent(CustomMenuItem.class)) {
                config.addMenuItem(parseMenuItem(method));
            }
            <span class="hljs-keyword">if</span> (method.isAnnotationPresent(CustomGridEvent.class)) {
                config.addEvent(parseGridEvent(method));
            }
        }
        
        <span class="hljs-keyword">return</span> config;
    }
}
</code></pre>
<p><strong>验证机制</strong>：</p>
<ul>
<li>类型检查：确保字段类型匹配</li>
<li>必填验证：检查必填字段</li>
<li>引用验证：验证引用的实体存在</li>
<li>格式验证：检查 URL、正则表达式等格式</li>
</ul>
<h4 data-id="heading-12">2.2.2 阶段 2：代码生成</h4>
<p><strong>生成器层次</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">GenCustomViewJava (视图层生成器)
    ├── GenLayoutChildModule (布局生成)
    ├── GenTabsChildModule (标签页生成)
    └── GenFormChildModule (表单生成)

GenRepositoryViewJava (仓储层生成器)
    ├── GenEntityJava (实体生成)
    ├── GenEntityServiceJava (服务生成)
    └── GenTableJava (表生成)

GenAggCustomViewJava (聚合层生成器)
    ├── GenAggRootJava (聚合根生成)
    ├── GenAggMenuJava (菜单生成)
    └── GenAggAPIJava (API生成)
</code></pre>
<p><strong>生成示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenCustomViewJava</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenJavaTask</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;JavaGenSource&gt; <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JDSException {
        List&lt;JavaGenSource&gt; sources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-comment">// 1. 生成视图类</span>
        sources.add(generateViewClass());
        
        <span class="hljs-comment">// 2. 生成字段配置</span>
        sources.add(generateFieldConfigs());
        
        <span class="hljs-comment">// 3. 生成事件处理器</span>
        sources.add(generateEventHandlers());
        
        <span class="hljs-keyword">return</span> sources;
    }
    
    <span class="hljs-keyword">private</span> JavaGenSource <span class="hljs-title function_">generateViewClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JDSException {
        Map&lt;String, Object&gt; dataModel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        dataModel.put(<span class="hljs-string">"className"</span>, viewMeta.getClassName());
        dataModel.put(<span class="hljs-string">"packageName"</span>, viewMeta.getPackageName());
        dataModel.put(<span class="hljs-string">"fields"</span>, viewMeta.getFields());
        
        <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> d2cGenerator.generate(<span class="hljs-string">"view.ftl"</span>, dataModel);
        <span class="hljs-keyword">return</span> createJavaSource(viewMeta.getClassName(), content);
    }
}
</code></pre>
<p><strong>模板示例</strong>（Freemarker）：</p>
<pre><code class="hljs language-ftl" lang="ftl">package ${packageName};

import net.ooder.engine.ub.component.*;
import net.ooder.engine.ub.annotation.*;

&lt;#list fields as field&gt;
import ${field.type};
&lt;/#list&gt;

/**
 * ${viewMeta.caption}
 * 自动生成的视图类，请勿手动修改
 */
@CustomView
public class ${className} extends UIComponent {
    
    &lt;#list fields as field&gt;
    private ${field.type} ${field.name};
    &lt;/#list&gt;
    
    public ${className}() {
        super();
        // 初始化组件
    }
}
</code></pre>
<h4 data-id="heading-13">2.2.3 阶段 3：源码组装</h4>
<p><strong>组装策略</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SourceAssembler</span> {
    
    <span class="hljs-keyword">public</span> JavaSrcMeta <span class="hljs-title function_">assemble</span><span class="hljs-params">(List&lt;JavaGenSource&gt; sources)</span> {
        <span class="hljs-type">JavaSrcMeta</span> <span class="hljs-variable">srcMeta</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaSrcMeta</span>();
        
        <span class="hljs-comment">// 1. 按包分组</span>
        Map&lt;String, List&lt;JavaGenSource&gt;&gt; packageMap = 
            sources.stream().collect(Collectors.groupingBy(JavaGenSource::getPackage));
        
        <span class="hljs-comment">// 2. 生成包结构</span>
        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, List&lt;JavaGenSource&gt;&gt; entry : packageMap.entrySet()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">packageName</span> <span class="hljs-operator">=</span> entry.getKey();
            List&lt;JavaGenSource&gt; packageSources = entry.getValue();
            
            <span class="hljs-comment">// 生成包目录</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">packagePath</span> <span class="hljs-operator">=</span> packageName.replace(<span class="hljs-string">'.'</span>, <span class="hljs-string">'/'</span>);
            srcMeta.addPackage(packagePath, packageSources);
        }
        
        <span class="hljs-comment">// 3. 生成导入语句</span>
        srcMeta.addImports(calculateImports(sources));
        
        <span class="hljs-keyword">return</span> srcMeta;
    }
}
</code></pre>
<p><strong>依赖解析</strong>：</p>
<ul>
<li>自动计算类依赖关系</li>
<li>生成正确的 import 语句</li>
<li>处理循环依赖</li>
<li>优化导入顺序</li>
</ul>
<h4 data-id="heading-14">2.2.4 阶段 4：动态编译</h4>
<p><strong>编译流程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicCompiler</span> {
    
    <span class="hljs-keyword">public</span> Class&lt;?&gt; compile(JavaGenSource source) <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 创建 Java 文件</span>
            <span class="hljs-type">File</span> <span class="hljs-variable">javaFile</span> <span class="hljs-operator">=</span> createJavaFile(source);
            
            <span class="hljs-comment">// 2. 编译 Java 文件</span>
            <span class="hljs-type">JavaCompiler</span> <span class="hljs-variable">compiler</span> <span class="hljs-operator">=</span> ToolProvider.getSystemJavaCompiler();
            DiagnosticCollector&lt;JavaFileObject&gt; diagnostics = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DiagnosticCollector</span>&lt;&gt;();
            
            <span class="hljs-type">StandardJavaFileManager</span> <span class="hljs-variable">fileManager</span> <span class="hljs-operator">=</span> 
                compiler.getStandardFileManager(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
            
            Iterable&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JavaFileObject</span>&gt; compilationUnits = 
                fileManager.getJavaFileObjectsFromFiles(Arrays.asList(javaFile));
            
            <span class="hljs-comment">// 3. 执行编译</span>
            compiler.getTask(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, diagnostics, fileManager, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)
                   .call(compilationUnits);
            
            <span class="hljs-comment">// 4. 检查编译错误</span>
            <span class="hljs-keyword">if</span> (!diagnostics.getDiagnostics().isEmpty()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(<span class="hljs-string">"编译失败: "</span> + diagnostics);
            }
            
            <span class="hljs-comment">// 5. 加载编译后的类</span>
            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> fileManager.getClassLoader(<span class="hljs-literal">null</span>);
            <span class="hljs-keyword">return</span> classLoader.loadClass(source.getClassName());
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(<span class="hljs-string">"动态编译失败: "</span> + e.getMessage(), e);
        }
    }
}
</code></pre>
<p><strong>编译优化</strong>：</p>
<ul>
<li>增量编译：只编译变更的文件</li>
<li>并行编译：支持多线程编译</li>
<li>缓存机制：缓存已编译的类</li>
<li>热替换：支持运行时替换类</li>
</ul>
<h4 data-id="heading-15">2.2.5 阶段 5：运行时绑定</h4>
<p><strong>绑定机制</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuntimeBinder</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bind</span><span class="hljs-params">(MethodConfig config, Class&lt;?&gt; bridgeClass)</span> 
            <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 创建 Bridge 实例</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">bridgeInstance</span> <span class="hljs-operator">=</span> bridgeClass.newInstance();
            
            <span class="hljs-comment">// 2. 绑定方法到事件</span>
            <span class="hljs-keyword">for</span> (Event event : config.getEvents()) {
                <span class="hljs-type">Method</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> findHandlerMethod(bridgeClass, event.getHandler());
                bindEvent(event, handler, bridgeInstance);
            }
            
            <span class="hljs-comment">// 3. 绑定菜单项</span>
            <span class="hljs-keyword">for</span> (MenuItem menu : config.getMenus()) {
                <span class="hljs-type">Method</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> findHandlerMethod(bridgeClass, menu.getHandler());
                bindMenuItem(menu, handler, bridgeInstance);
            }
            
            <span class="hljs-comment">// 4. 注册到 UI 框架</span>
            registerToUIFramework(bridgeInstance);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(<span class="hljs-string">"运行时绑定失败: "</span> + e.getMessage(), e);
        }
    }
}
</code></pre>
<p><strong>绑定特性</strong>：</p>
<ul>
<li>反射绑定：使用 Java 反射机制</li>
<li>类型安全：编译期检查类型匹配</li>
<li>生命周期管理：自动管理组件生命周期</li>
<li>事件传播：支持事件冒泡和捕获</li>
</ul>
<h3 data-id="heading-16">2.3 性能优化</h3>
<h4 data-id="heading-17">2.3.1 生成缓存</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenerationCache</span> {
    
    <span class="hljs-keyword">private</span> Map&lt;String, JavaGenSource&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> JavaGenSource <span class="hljs-title function_">getOrGenerate</span><span class="hljs-params">(String key, Callable&lt;JavaGenSource&gt; generator)</span> 
            <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-keyword">return</span> cache.computeIfAbsent(key, k -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> generator.call();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(<span class="hljs-string">"生成失败: "</span> + e.getMessage(), e);
            }
        });
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidate</span><span class="hljs-params">(String key)</span> {
        cache.remove(key);
    }
}
</code></pre>
<h4 data-id="heading-18">2.3.2 并行生成</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParallelGenerator</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">4</span>);
    
    <span class="hljs-keyword">public</span> List&lt;JavaGenSource&gt; <span class="hljs-title function_">generateParallel</span><span class="hljs-params">(
            List&lt;GenJavaTask&gt; tasks)</span> <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-keyword">try</span> {
            List&lt;Future&lt;JavaGenSource&gt;&gt; futures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            
            <span class="hljs-keyword">for</span> (GenJavaTask task : tasks) {
                Future&lt;JavaGenSource&gt; future = executor.submit(task);
                futures.add(future);
            }
            
            List&lt;JavaGenSource&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            <span class="hljs-keyword">for</span> (Future&lt;JavaGenSource&gt; future : futures) {
                results.add(future.get());
            }
            
            <span class="hljs-keyword">return</span> results;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(<span class="hljs-string">"并行生成失败: "</span> + e.getMessage(), e);
        }
    }
}
</code></pre>
<h2 data-id="heading-19">三、分层 SKILLS 设计</h2>
<h3 data-id="heading-20">3.1 Skill 架构设计</h3>
<p>基于 BridgeCode 机制，ooder 设计了分层 SKILLS 架构，为 LLM 提供结构化的知识访问能力：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────────────────────────────────────┐
│      Skill 知识层（Knowledge Layer）       │
│  - Foundation Skill                      │
│  - Module Skill                        │
│  - Component Skill                     │
│  - Metadata Skill                      │
└─────────────────────────────────────────────┘
<span class="hljs-code">                  ↓
┌─────────────────────────────────────────────┐
│     Skill 执行层（Execution Layer）        │
│  - Skill Loader                        │
│  - Skill Context                      │
│  - Skill Orchestrator                 │
└─────────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│     Skill 集成层（Integration Layer）    │
│  - Trae Solo Integration               │
│  - LLM Provider                      │
│  - Tool Registry                      │
└─────────────────────────────────────────────┘
</span></code></pre>
<h3 data-id="heading-21">3.2 Foundation Skill 设计</h3>
<p><strong>职责</strong>：提供基础组件的知识和生成能力</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FoundationSkill</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"foundation"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DESCRIPTION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"基础组件 Skill"</span>;
    
    <span class="hljs-keyword">public</span> SkillContext <span class="hljs-title function_">load</span><span class="hljs-params">()</span> {
        <span class="hljs-type">SkillContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillContext</span>();
        
        <span class="hljs-comment">// 1. 加载 NlpBaseUIComponent 知识</span>
        context.addClass(NlpBaseUIComponent.class);
        
        <span class="hljs-comment">// 2. 加载生成器知识</span>
        context.addGenerator(GenJavaTask.class);
        
        <span class="hljs-comment">// 3. 加载模板知识</span>
        context.addTemplate(<span class="hljs-string">"base.ftl"</span>);
        
        <span class="hljs-keyword">return</span> context;
    }
    
    <span class="hljs-keyword">public</span> List&lt;SkillAction&gt; <span class="hljs-title function_">getActions</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Arrays.asList(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"create-base-component"</span>, <span class="hljs-string">"创建基础组件"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"initialize-component"</span>, <span class="hljs-string">"初始化组件"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"validate-component"</span>, <span class="hljs-string">"验证组件"</span>)
        );
    }
}
</code></pre>
<p><strong>知识内容</strong>：</p>
<ul>
<li>抽象类定义</li>
<li>初始化方法签名</li>
<li>组件类型枚举</li>
<li>基础生成器模板</li>
</ul>
<h3 data-id="heading-22">3.3 Module Skill 设计</h3>
<p><strong>职责</strong>：提供模块组件的知识和生成能力</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ModuleSkill</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"module"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DESCRIPTION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"模块组件 Skill"</span>;
    
    <span class="hljs-keyword">public</span> SkillContext <span class="hljs-title function_">load</span><span class="hljs-params">()</span> {
        <span class="hljs-type">SkillContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillContext</span>();
        
        <span class="hljs-comment">// 1. 加载 ModuleUIComponent 知识</span>
        context.addClass(ModuleUIComponent.class);
        context.addClass(CustomModuleUIComponent.class);
        
        <span class="hljs-comment">// 2. 加载生命周期方法</span>
        context.addMethod(<span class="hljs-string">"setCurrComponent"</span>);
        context.addMethod(<span class="hljs-string">"findComponentByAlias"</span>);
        
        <span class="hljs-comment">// 3. 加载生成器</span>
        context.addGenerator(GenRepositoryViewJava.class);
        
        <span class="hljs-keyword">return</span> context;
    }
    
    <span class="hljs-keyword">public</span> List&lt;SkillAction&gt; <span class="hljs-title function_">getActions</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Arrays.asList(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"create-module"</span>, <span class="hljs-string">"创建模块"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"bind-component"</span>, <span class="hljs-string">"绑定组件"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"manage-lifecycle"</span>, <span class="hljs-string">"管理生命周期"</span>)
        );
    }
}
</code></pre>
<p><strong>知识内容</strong>：</p>
<ul>
<li>模块类定义</li>
<li>生命周期管理方法</li>
<li>组件查找机制</li>
<li>仓储层生成器</li>
</ul>
<h3 data-id="heading-23">3.4 Component Skill 设计</h3>
<p><strong>职责</strong>：提供具体组件的知识和生成能力</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComponentSkill</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"component"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DESCRIPTION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"组件 Skill"</span>;
    
    <span class="hljs-keyword">public</span> SkillContext <span class="hljs-title function_">load</span><span class="hljs-params">()</span> {
        <span class="hljs-type">SkillContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillContext</span>();
        
        <span class="hljs-comment">// 1. 加载具体组件知识</span>
        context.addClass(NlpGroupUIComponent.class);
        context.addClass(NlpGridUIComponent.class);
        context.addClass(TreeGridUIComponent.class);
        
        <span class="hljs-comment">// 2. 加载组件配置</span>
        context.addConfig(<span class="hljs-string">"group-config"</span>);
        context.addConfig(<span class="hljs-string">"grid-config"</span>);
        
        <span class="hljs-comment">// 3. 加载视图生成器</span>
        context.addGenerator(GenCustomViewJava.class);
        
        <span class="hljs-keyword">return</span> context;
    }
    
    <span class="hljs-keyword">public</span> List&lt;SkillAction&gt; <span class="hljs-title function_">getActions</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Arrays.asList(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"create-group"</span>, <span class="hljs-string">"创建分组组件"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"create-grid"</span>, <span class="hljs-string">"创建网格组件"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"create-tree"</span>, <span class="hljs-string">"创建树形组件"</span>)
        );
    }
}
</code></pre>
<p><strong>知识内容</strong>：</p>
<ul>
<li>具体组件类定义</li>
<li>组件配置模式</li>
<li>视图层生成器</li>
<li>组件间关系</li>
</ul>
<h3 data-id="heading-24">3.5 Metadata Skill 设计</h3>
<p><strong>职责</strong>：提供元数据的知识和生成能力</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetadataSkill</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"metadata"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DESCRIPTION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"元数据 Skill"</span>;
    
    <span class="hljs-keyword">public</span> SkillContext <span class="hljs-title function_">load</span><span class="hljs-params">()</span> {
        <span class="hljs-type">SkillContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillContext</span>();
        
        <span class="hljs-comment">// 1. 加载元数据类</span>
        context.addClass(CustomViewMeta.class);
        context.addClass(CustomDataMeta.class);
        context.addClass(MethodConfig.class);
        
        <span class="hljs-comment">// 2. 加载解析器</span>
        context.addParser(MetadataParser.class);
        
        <span class="hljs-comment">// 3. 加载验证规则</span>
        context.addValidator(MetadataValidator.class);
        
        <span class="hljs-keyword">return</span> context;
    }
    
    <span class="hljs-keyword">public</span> List&lt;SkillAction&gt; <span class="hljs-title function_">getActions</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Arrays.asList(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"parse-metadata"</span>, <span class="hljs-string">"解析元数据"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"validate-metadata"</span>, <span class="hljs-string">"验证元数据"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillAction</span>(<span class="hljs-string">"generate-code"</span>, <span class="hljs-string">"生成代码"</span>)
        );
    }
}
</code></pre>
<p><strong>知识内容</strong>：</p>
<ul>
<li>元数据类定义</li>
<li>元数据解析器</li>
<li>验证规则</li>
<li>生成规则</li>
</ul>
<h3 data-id="heading-25">3.6 Skill 协作机制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkillOrchestrator</span> {
    
    <span class="hljs-keyword">private</span> Map&lt;String, Skill&gt; skills = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerSkill</span><span class="hljs-params">(Skill skill)</span> {
        skills.put(skill.getName(), skill);
    }
    
    <span class="hljs-keyword">public</span> SkillContext <span class="hljs-title function_">execute</span><span class="hljs-params">(String skillName, Map&lt;String, Object&gt; params)</span> 
            <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-type">Skill</span> <span class="hljs-variable">skill</span> <span class="hljs-operator">=</span> skills.get(skillName);
        <span class="hljs-keyword">if</span> (skill == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(<span class="hljs-string">"Skill 不存在: "</span> + skillName);
        }
        
        <span class="hljs-comment">// 1. 加载 Skill 上下文</span>
        <span class="hljs-type">SkillContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> skill.load();
        
        <span class="hljs-comment">// 2. 应用参数</span>
        context.applyParams(params);
        
        <span class="hljs-comment">// 3. 执行 Skill</span>
        <span class="hljs-type">SkillResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> skill.execute(context);
        
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-keyword">public</span> List&lt;SkillAction&gt; <span class="hljs-title function_">getAllActions</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> skills.values().stream()
                .flatMap(skill -&gt; skill.getActions().stream())
                .collect(Collectors.toList());
    }
}
</code></pre>
<h2 data-id="heading-26">四、Trae Solo Skill 构建实践</h2>
<h3 data-id="heading-27">4.1 Trae Solo 环境配置</h3>
<h4 data-id="heading-28">4.1.1 项目结构</h4>
<pre><code class="hljs language-bash" lang="bash">trae-solo-project/
├── .trae/
│   ├── rules/
│   │   ├── project_rules.md       <span class="hljs-comment"># 项目规则</span>
│   │   └── skill_rules.md        <span class="hljs-comment"># Skill 规则</span>
│   └── skills/
│       ├── foundation-skill.md    <span class="hljs-comment"># Foundation Skill</span>
│       ├── module-skill.md        <span class="hljs-comment"># Module Skill</span>
│       ├── component-skill.md     <span class="hljs-comment"># Component Skill</span>
│       └── metadata-skill.md      <span class="hljs-comment"># Metadata Skill</span>
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── net/ooder/
│   │   │       └── engine/
│   │   │           ├── codegen/    <span class="hljs-comment"># 代码生成器</span>
│   │   │           └── ub/         <span class="hljs-comment"># BridgeCode</span>
│   │   └── resources/
│   │       └── templates/   <span class="hljs-comment"># Freemarker 模板</span>
│   └── <span class="hljs-built_in">test</span>/
│       └── java/
│           └── net/ooder/
│               └── engine/
│                   └── codegen/
└── pom.xml
</code></pre>
<h4 data-id="heading-29">4.1.2 配置文件</h4>
<p><strong>.trae/rules/project_rules.md</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Trae Solo 项目规则</span>

<span class="hljs-section">## 代码生成规则</span>

<span class="hljs-bullet">1.</span> 所有生成的代码必须遵循 Java 编码规范
<span class="hljs-bullet">2.</span> 生成的类必须添加 @Generated 注解
<span class="hljs-bullet">3.</span> 生成的代码必须包含完整的 Javadoc
<span class="hljs-bullet">4.</span> 生成的代码必须通过编译检查

<span class="hljs-section">## Skill 使用规则</span>

<span class="hljs-bullet">1.</span> LLM 必须通过 Skill 访问代码生成知识
<span class="hljs-bullet">2.</span> LLM 不能直接修改生成的代码
<span class="hljs-bullet">3.</span> LLM 必须使用 Skill 提供的 Action
<span class="hljs-bullet">4.</span> LLM 必须遵循 Skill 的执行顺序

<span class="hljs-section">## 质量保证规则</span>

<span class="hljs-bullet">1.</span> 所有生成的代码必须经过单元测试
<span class="hljs-bullet">2.</span> 所有生成的代码必须经过集成测试
<span class="hljs-bullet">3.</span> 所有生成的代码必须经过代码审查
</code></pre>
<p><strong>.trae/rules/skill_rules.md</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Skill 规则</span>

<span class="hljs-section">## Skill 定义规则</span>

<span class="hljs-bullet">1.</span> 每个 Skill 必须定义清晰的职责边界
<span class="hljs-bullet">2.</span> 每个 Skill 必须提供完整的知识内容
<span class="hljs-bullet">3.</span> 每个 Skill 必须定义可执行的 Action
<span class="hljs-bullet">4.</span> 每个 Skill 必须提供使用示例

<span class="hljs-section">## Skill 加载规则</span>

<span class="hljs-bullet">1.</span> Skill 必须支持懒加载
<span class="hljs-bullet">2.</span> Skill 必须支持缓存
<span class="hljs-bullet">3.</span> Skill 必须支持热更新
<span class="hljs-bullet">4.</span> Skill 必须支持版本管理

<span class="hljs-section">## Skill 执行规则</span>

<span class="hljs-bullet">1.</span> Skill 执行必须支持参数传递
<span class="hljs-bullet">2.</span> Skill 执行必须支持上下文管理
<span class="hljs-bullet">3.</span> Skill 执行必须支持错误处理
<span class="hljs-bullet">4.</span> Skill 执行必须支持结果返回
</code></pre>
<h3 data-id="heading-30">4.2 Skill 实现实践</h3>
<h4 data-id="heading-31">4.2.1 Foundation Skill 实现</h4>
<p><strong>.trae/skills/foundation-skill.md</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Foundation Skill</span>

<span class="hljs-section">## 概述</span>

Foundation Skill 提供基础组件的知识和生成能力，是所有其他 Skill 的基础。

<span class="hljs-section">## 知识内容</span>

<span class="hljs-section">### 核心类</span>

<span class="hljs-section">#### NlpBaseUIComponent</span>

<span class="hljs-code">```java
public abstract class NlpBaseUIComponent extends UIComponent {
    
    private String componentType;
    private boolean initialized;
    
    public abstract void initializeFromNaturalLanguage(String naturalLanguage);
    public abstract void initializeFromConfig(Object config);
    
    public String getComponentType() {
        return componentType;
    }
    
    public boolean isInitialized() {
        return initialized;
    }
}
</span></code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>提供组件类型管理</li>
<li>提供初始化状态管理</li>
<li>定义抽象初始化方法</li>
</ul>
<h3 data-id="heading-32">生成器</h3>
<h4 data-id="heading-33">GenJavaTask</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenJavaTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Callable</span>&lt;List&lt;JavaGenSource&gt;&gt; {
    
    <span class="hljs-keyword">protected</span> JavaGenSource javaGen;
    <span class="hljs-keyword">protected</span> CustomViewMeta viewMeta;
    <span class="hljs-keyword">protected</span> String euClassName;
    <span class="hljs-keyword">protected</span> Chrome chrome;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> List&lt;JavaGenSource&gt; <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JDSException;
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>提供统一的生成接口</li>
<li>提供通用的生成工具方法</li>
<li>管理生成上下文</li>
</ul>
<h2 data-id="heading-34">可执行 Action</h2>
<h3 data-id="heading-35">create-base-component</h3>
<p><strong>描述</strong>：创建基础组件</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>componentType</code>：组件类型</li>
<li><code>className</code>：类名</li>
<li><code>packageName</code>：包名</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证参数</li>
<li>创建 NlpBaseUIComponent 子类</li>
<li>生成初始化方法</li>
<li>返回生成的代码</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">用户：创建一个基础组件
LLM：使用 Foundation Skill 的 create-<span class="hljs-keyword">base</span>-component Action
参数：{<span class="hljs-string">"componentType"</span>: <span class="hljs-string">"CUSTOM"</span>, <span class="hljs-string">"className"</span>: <span class="hljs-string">"MyComponent"</span>, <span class="hljs-string">"packageName"</span>: <span class="hljs-string">"net.ooder.example"</span>}
结果：生成 MyComponent.java
</code></pre>
<h3 data-id="heading-36">initialize-component</h3>
<p><strong>描述</strong>：初始化组件</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>component</code>：组件实例</li>
<li><code>config</code>：配置对象</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证配置</li>
<li>调用 initializeFromConfig 方法</li>
<li>设置初始化状态</li>
<li>返回初始化结果</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-json" lang="json">用户：初始化组件
LLM：使用 Foundation Skill 的 initialize-component Action
参数：<span class="hljs-punctuation">{</span><span class="hljs-attr">"component"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"myComponent"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"config"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"FORM"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
结果：组件初始化完成
</code></pre>
<h3 data-id="heading-37">validate-component</h3>
<p><strong>描述</strong>：验证组件</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>component</code>：组件实例</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>检查组件类型</li>
<li>检查初始化状态</li>
<li>检查配置完整性</li>
<li>返回验证结果</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-json" lang="json">用户：验证组件
LLM：使用 Foundation Skill 的 validate-component Action
参数：<span class="hljs-punctuation">{</span><span class="hljs-attr">"component"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"myComponent"</span><span class="hljs-punctuation">}</span>
结果：验证通过
</code></pre>
<h2 data-id="heading-38">使用场景</h2>
<h3 data-id="heading-39">场景 1：创建自定义基础组件</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：创建一个自定义基础组件
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Foundation Skill
<span class="hljs-bullet">2.</span> 调用 create-base-component Action
<span class="hljs-bullet">3.</span> 生成组件代码
<span class="hljs-bullet">4.</span> 返回生成的代码
</code></pre>
<h3 data-id="heading-40">场景 2：初始化现有组件</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：初始化一个现有组件
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Foundation Skill
<span class="hljs-bullet">2.</span> 调用 initialize-component Action
<span class="hljs-bullet">3.</span> 执行初始化逻辑
<span class="hljs-bullet">4.</span> 返回初始化结果
</code></pre>
<h2 data-id="heading-41">最佳实践</h2>
<ol>
<li><strong>优先使用 Foundation Skill</strong>：所有基础操作都应该通过 Foundation Skill 完成</li>
<li><strong>遵循初始化流程</strong>：确保组件正确初始化</li>
<li><strong>验证组件状态</strong>：在执行操作前验证组件状态</li>
<li><strong>处理初始化错误</strong>：提供清晰的错误信息</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">
<span class="hljs-comment">#### 4.2.2 Module Skill 实现</span>

**.trae/skills/module-skill.md**：

```markdown
<span class="hljs-comment"># Module Skill</span>

<span class="hljs-comment">## 概述</span>

Module Skill 提供模块组件的知识和生成能力，管理组件的生命周期和依赖关系。

<span class="hljs-comment">## 知识内容</span>

<span class="hljs-comment">### 核心类</span>

<span class="hljs-comment">#### ModuleUIComponent</span>

```java
public class ModuleUIComponent&lt;M extends UIComponent&gt; extends UIComponent&lt;ModuleProperties, ModuleEventEnum&gt; {
    
    private String className<span class="hljs-comment">;</span>
    private String desc<span class="hljs-comment">;</span>
    private ModuleViewType moduleViewType<span class="hljs-comment">;</span>
    private Map&lt;String, Object&gt; valueMap<span class="hljs-comment">;</span>
    private UIModule UIModule<span class="hljs-comment">;</span>
    private CustomModuleMeta moduleBean<span class="hljs-comment">;</span>
    private MethodConfig methodAPIBean<span class="hljs-comment">;</span>
    private DomainInst domainInst<span class="hljs-comment">;</span>
    private ModuleProperties properties<span class="hljs-comment">;</span>
    private M currComponent<span class="hljs-comment">;</span>
    private UIComponent navUIComponent<span class="hljs-comment">;</span>
    private ModuleViewConfig viewConfig<span class="hljs-comment">;</span>
    private List&lt;String&gt; dependencies<span class="hljs-comment">;</span>
    private List&lt;String&gt; required<span class="hljs-comment">;</span>
    private Map&lt;String, ModuleFunction&gt; functions<span class="hljs-comment">;</span>
    private List&lt;ModuleFormulaInst&gt; formulas<span class="hljs-comment">;</span>
    private Map&lt;String, String&gt; customFunctions<span class="hljs-comment">;</span>
    private String customAppend<span class="hljs-comment">;</span>
    private String afterAppend<span class="hljs-comment">;</span>
    private Map&lt;String, String&gt; moduleVar<span class="hljs-comment">;</span>
    private Map&lt;String, UIComponent&gt; components<span class="hljs-comment">;</span>
    
    public void setCurrComponent(M currComponent) {
        <span class="hljs-attr">this.currComponent</span> = currComponent<span class="hljs-comment">;</span>
        if (currComponent != null) {
            <span class="hljs-attr">this.currComponentAlias</span> = currComponent.getAlias()<span class="hljs-comment">;</span>
            if (currComponent.getParent() == null) {
                currComponent.setParent(this)<span class="hljs-comment">;</span>
            }
            this.components.put(currComponentAlias, currComponent)<span class="hljs-comment">;</span>
            ComponentType <span class="hljs-attr">type</span> = ComponentType.fromType(currComponent.getKey())<span class="hljs-comment">;</span>
            <span class="hljs-attr">moduleViewType</span> = ModuleViewType.getModuleViewByCom(type)<span class="hljs-comment">;</span>
            properties.setCurrComponentAlias(currComponentAlias)<span class="hljs-comment">;</span>
        } else {
            <span class="hljs-attr">this.currComponentAlias</span> = null<span class="hljs-comment">;</span>
            properties.setCurrComponentAlias(null)<span class="hljs-comment">;</span>
        }
    }
    
    public UIComponent findComponentByAlias(String alias) {
        List&lt;UIComponent&gt; <span class="hljs-attr">UIComponentList</span> = this.findComponentsByAlias(alias)<span class="hljs-comment">;</span>
        UIComponent <span class="hljs-attr">UIComponent</span> = null<span class="hljs-comment">;</span>
        if (UIComponentList.size() &gt; 0) {
            <span class="hljs-attr">UIComponent</span> = UIComponentList.get(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
        }
        return UIComponent<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>管理模块生命周期</li>
<li>管理组件依赖</li>
<li>提供组件查找功能</li>
<li>处理模块事件</li>
</ul>
<h3 data-id="heading-42">生成器</h3>
<h4 data-id="heading-43">GenRepositoryViewJava</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenRepositoryViewJava</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenJavaTask</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;JavaGenSource&gt; <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JDSException {
        List&lt;JavaGenSource&gt; sources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-comment">// 1. 生成 VO 接口</span>
        sources.add(generateVOInterface());
        
        <span class="hljs-comment">// 2. 生成 Service 接口</span>
        sources.add(generateServiceInterface());
        
        <span class="hljs-comment">// 3. 生成 Repository 接口</span>
        sources.add(generateRepositoryInterface());
        
        <span class="hljs-comment">// 4. 生成 RepositoryImpl 实现</span>
        sources.add(generateRepositoryImpl());
        
        <span class="hljs-keyword">return</span> sources;
    }
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>生成仓储层代码</li>
<li>生成服务层代码</li>
<li>生成数据访问对象</li>
<li>管理依赖关系</li>
</ul>
<h2 data-id="heading-44">可执行 Action</h2>
<h3 data-id="heading-45">create-module</h3>
<p><strong>描述</strong>：创建模块</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>moduleName</code>：模块名称</li>
<li><code>className</code>：类名</li>
<li><code>packageName</code>：包名</li>
<li><code>components</code>：组件列表</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证参数</li>
<li>创建 ModuleUIComponent 子类</li>
<li>生成仓储层代码</li>
<li>绑定组件</li>
<li>返回生成的代码</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">用户：创建一个模块
LLM：使用 <span class="hljs-keyword">Module</span> Skill 的 <span class="hljs-keyword">create</span><span class="hljs-operator">-</span><span class="hljs-keyword">module</span> Action
参数：{"moduleName": "UserModule", "className": "UserModule", "packageName": "net.ooder.example", "components": ["grid", "form"]}
结果：生成 UserModule.java 和相关仓储代码
</code></pre>
<h3 data-id="heading-46">bind-component</h3>
<p><strong>描述</strong>：绑定组件</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>module</code>：模块实例</li>
<li><code>component</code>：组件实例</li>
<li><code>alias</code>：组件别名</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证模块和组件</li>
<li>调用 setCurrComponent 方法</li>
<li>更新组件依赖</li>
<li>返回绑定结果</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-perl" lang="perl">用户：绑定组件
LLM：使用 Module Skill 的 <span class="hljs-keyword">bind</span>-component Action
参数：{<span class="hljs-string">"module"</span>: <span class="hljs-string">"userModule"</span>, <span class="hljs-string">"component"</span>: <span class="hljs-string">"userGrid"</span>, <span class="hljs-string">"alias"</span>: <span class="hljs-string">"grid"</span>}
结果：组件绑定完成
</code></pre>
<h3 data-id="heading-47">manage-lifecycle</h3>
<p><strong>描述</strong>：管理生命周期</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>module</code>：模块实例</li>
<li><code>action</code>：生命周期动作（init/destroy）</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证模块状态</li>
<li>执行生命周期动作</li>
<li>触发生命周期事件</li>
<li>返回执行结果</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">用户：初始化模块
LLM：使用 <span class="hljs-keyword">Module</span> Skill 的 manage<span class="hljs-operator">-</span>lifecycle Action
参数：{"module": "userModule", "action": "init"}
结果：模块初始化完成
</code></pre>
<h2 data-id="heading-48">使用场景</h2>
<h3 data-id="heading-49">场景 1：创建用户管理模块</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：创建一个用户管理模块
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Module Skill
<span class="hljs-bullet">2.</span> 调用 create-module Action
<span class="hljs-bullet">3.</span> 生成模块代码和仓储代码
<span class="hljs-bullet">4.</span> 返回生成的代码
</code></pre>
<h3 data-id="heading-50">场景 2：绑定网格组件到模块</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：绑定网格组件到模块
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Module Skill
<span class="hljs-bullet">2.</span> 调用 bind-component Action
<span class="hljs-bullet">3.</span> 执行绑定逻辑
<span class="hljs-bullet">4.</span> 返回绑定结果
</code></pre>
<h2 data-id="heading-51">最佳实践</h2>
<ol>
<li><strong>使用模块化设计</strong>：将功能分解为独立的模块</li>
<li><strong>管理组件依赖</strong>：明确组件之间的依赖关系</li>
<li><strong>实现生命周期管理</strong>：提供完整的生命周期支持</li>
<li><strong>使用仓储模式</strong>：分离数据访问逻辑</li>
</ol>
<pre><code class="hljs language-scala" lang="scala">
#### <span class="hljs-number">4.2</span><span class="hljs-number">.3</span> <span class="hljs-type">Component</span> <span class="hljs-type">Skill</span> 实现

**.trae/skills/component-skill.md**：

```markdown
# <span class="hljs-type">Component</span> <span class="hljs-type">Skill</span>

## 概述

<span class="hljs-type">Component</span> <span class="hljs-type">Skill</span> 提供具体组件的知识和生成能力，包括分组组件、网格组件、树形组件等。

## 知识内容

### 核心类

#### <span class="hljs-type">NlpGroupUIComponent</span>

```java
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NlpGroupUIComponent&lt;M</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CustomFieldGroupUIComponent&gt;</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CustomModuleUIComponent&lt;M&gt;</span> </span>{
    
    void init(<span class="hljs-type">MethodConfig</span> methodConfig) <span class="hljs-keyword">throws</span> <span class="hljs-type">JDSException</span> {
        <span class="hljs-type">CustomGroupFormViewMeta</span> viewBean = (<span class="hljs-type">CustomGroupFormViewMeta</span>) methodConfig.getView();
        <span class="hljs-type">CustomGroupDataMeta</span> dataBean = (<span class="hljs-type">CustomGroupDataMeta</span>) methodConfig.getDataBean();
        <span class="hljs-keyword">if</span> (dataBean != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">this</span>.dataUrl = dataBean.getDataUrl();
            <span class="hljs-keyword">this</span>.saveUrl = dataBean.getSaveUrl();
            <span class="hljs-keyword">this</span>.searchUrl = dataBean.getSearchUrl();
            <span class="hljs-keyword">this</span>.reSetUrl = dataBean.getReSetUrl();
        }
        <span class="hljs-type">CustomFieldGroupUIComponent</span> currComponent = <span class="hljs-keyword">new</span> <span class="hljs-type">CustomFieldGroupUIComponent</span>(<span class="hljs-type">UIModule</span>, methodConfig, valueMap);
        <span class="hljs-keyword">this</span>.addChildLayoutNav(currComponent);
        <span class="hljs-keyword">this</span>.setCurrComponent((<span class="hljs-type">M</span>) currComponent);
        
        <span class="hljs-keyword">this</span>.fillAction(viewBean);
        <span class="hljs-keyword">this</span>.fillToolBar(viewBean.getToolBar(), currComponent);
        <span class="hljs-keyword">this</span>.fillContextAction(viewBean.getContextMenuBean(), currComponent);
        
        <span class="hljs-keyword">if</span> (viewBean.getOnReady() != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">ModuleOnReadyEventEnum</span> eventEnum : viewBean.getOnReady()) {
                <span class="hljs-keyword">this</span>.addModuleEvent(eventEnum);
            }
        }
        
        <span class="hljs-keyword">if</span> (viewBean.getOnDestroy() != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">CustomOnDestroyEventEnum</span> eventEnum : viewBean.getOnDestroy()) {
                <span class="hljs-keyword">this</span>.addModuleEvent(eventEnum);
            }
        }
    }
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>管理分组字段</li>
<li>处理分组事件</li>
<li>生成 API 调用</li>
<li>管理工具栏和上下文菜单</li>
</ul>
<h4 data-id="heading-52">NlpGridUIComponent</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NlpGridUIComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CustomGridUIComponent</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NlpGridUIComponent</span><span class="hljs-params">(MethodConfig methodConfig)</span> {
        <span class="hljs-built_in">super</span>();
        <span class="hljs-type">CustomGridViewMeta</span> <span class="hljs-variable">viewBean</span> <span class="hljs-operator">=</span> (CustomGridViewMeta) methodConfig.getView();
        init(viewBean);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NlpGridUIComponent</span><span class="hljs-params">(CustomGridViewMeta viewBean)</span> {
        <span class="hljs-built_in">super</span>();
        init(viewBean);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(CustomGridViewMeta viewBean)</span> {
        <span class="hljs-built_in">this</span>.setProperties(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassGridProperties</span>(viewBean));
        <span class="hljs-built_in">this</span>.setAlias(viewBean.getName());
    }
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>管理网格数据</li>
<li>处理网格事件</li>
<li>提供网格交互</li>
<li>支持分页和排序</li>
</ul>
<h3 data-id="heading-53">生成器</h3>
<h4 data-id="heading-54">GenCustomViewJava</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenCustomViewJava</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenJavaTask</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;JavaGenSource&gt; <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JDSException {
        List&lt;JavaGenSource&gt; sources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-comment">// 1. 生成视图类</span>
        sources.add(generateViewClass());
        
        <span class="hljs-comment">// 2. 生成字段配置</span>
        sources.add(generateFieldConfigs());
        
        <span class="hljs-comment">// 3. 生成事件处理器</span>
        sources.add(generateEventHandlers());
        
        <span class="hljs-keyword">return</span> sources;
    }
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>生成视图层代码</li>
<li>生成字段配置</li>
<li>生成事件处理器</li>
<li>管理视图依赖</li>
</ul>
<h2 data-id="heading-55">可执行 Action</h2>
<h3 data-id="heading-56">create-group</h3>
<p><strong>描述</strong>：创建分组组件</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>groupName</code>：分组名称</li>
<li><code>fields</code>：字段列表</li>
<li><code>events</code>：事件列表</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证参数</li>
<li>创建 NlpGroupUIComponent 实例</li>
<li>生成视图代码</li>
<li>生成仓储代码</li>
<li>返回生成的代码</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">用户：创建一个分组组件
LLM：使用 Component Skill 的 <span class="hljs-keyword">create</span><span class="hljs-operator">-</span><span class="hljs-keyword">group</span> Action
参数：{"groupName": "UserGroup", "fields": [...], "events": [...]}
结果：生成 UserGroup.java 和相关代码
</code></pre>
<h3 data-id="heading-57">create-grid</h3>
<p><strong>描述</strong>：创建网格组件</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>gridName</code>：网格名称</li>
<li><code>columns</code>：列配置</li>
<li><code>dataUrl</code>：数据 URL</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证参数</li>
<li>创建 NlpGridUIComponent 实例</li>
<li>生成视图代码</li>
<li>生成仓储代码</li>
<li>返回生成的代码</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-css" lang="css">用户：创建一个网格组件
LLM：使用 Component Skill 的 create-<span class="hljs-attribute">grid</span> Action
参数：{"gridName": <span class="hljs-string">"UserGrid"</span>, <span class="hljs-string">"columns"</span>: [...], <span class="hljs-string">"dataUrl"</span>: <span class="hljs-string">"/api/users"</span>}
结果：生成 UserGrid<span class="hljs-selector-class">.java</span> 和相关代码
</code></pre>
<h3 data-id="heading-58">create-tree</h3>
<p><strong>描述</strong>：创建树形组件</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>treeName</code>：树形名称</li>
<li><code>treeField</code>：树字段</li>
<li><code>parentField</code>：父字段</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证参数</li>
<li>创建 TreeGridUIComponent 实例</li>
<li>生成视图代码</li>
<li>生成仓储代码</li>
<li>返回生成的代码</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-lua" lang="lua">用户：创建一个树形组件
LLM：使用 Component Skill 的 <span class="hljs-built_in">create</span>-tree Action
参数：{<span class="hljs-string">"treeName"</span>: <span class="hljs-string">"DepartmentTree"</span>, <span class="hljs-string">"treeField"</span>: <span class="hljs-string">"id"</span>, <span class="hljs-string">"parentField"</span>: <span class="hljs-string">"parentId"</span>}
结果：生成 DepartmentTree.java 和相关代码
</code></pre>
<h2 data-id="heading-59">使用场景</h2>
<h3 data-id="heading-60">场景 1：创建用户分组表单</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：创建一个用户分组表单
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Component Skill
<span class="hljs-bullet">2.</span> 调用 create-group Action
<span class="hljs-bullet">3.</span> 生成分组组件代码
<span class="hljs-bullet">4.</span> 返回生成的代码
</code></pre>
<h3 data-id="heading-61">场景 2：创建用户数据网格</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：创建一个用户数据网格
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Component Skill
<span class="hljs-bullet">2.</span> 调用 create-grid Action
<span class="hljs-bullet">3.</span> 生成网格组件代码
<span class="hljs-bullet">4.</span> 返回生成的代码
</code></pre>
<h2 data-id="heading-62">最佳实践</h2>
<ol>
<li><strong>选择合适的组件类型</strong>：根据需求选择分组、网格或树形组件</li>
<li><strong>配置字段和列</strong>：合理配置字段和列属性</li>
<li><strong>处理事件和交互</strong>：实现必要的事件处理和交互逻辑</li>
<li><strong>优化性能</strong>：使用分页、懒加载等优化技术</li>
</ol>
<pre><code class="hljs language-scala" lang="scala">
#### <span class="hljs-number">4.2</span><span class="hljs-number">.4</span> <span class="hljs-type">Metadata</span> <span class="hljs-type">Skill</span> 实现

**.trae/skills/metadata-skill.md**：

```markdown
# <span class="hljs-type">Metadata</span> <span class="hljs-type">Skill</span>

## 概述

<span class="hljs-type">Metadata</span> <span class="hljs-type">Skill</span> 提供元数据的知识和生成能力，包括元数据解析、验证和代码生成。

## 知识内容

### 核心类

#### <span class="hljs-type">CustomViewMeta</span>

```java
public <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomViewMeta&lt;F</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FieldFormConfig</span>, <span class="hljs-title">I</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UIItem</span>, <span class="hljs-title">C</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UIComponent&gt;</span> </span>{
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> caption;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> desc;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> methodName;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> domainId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> sourceClassName;
    <span class="hljs-keyword">private</span> <span class="hljs-type">ModuleViewType</span> moduleViewType;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">F</span>&gt; allFields;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">F</span>&gt; fields;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">Event</span>&gt; events;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">MenuItem</span>&gt; menus;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">ToolBar</span>&gt; toolBars;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">BottomBar</span>&gt; bottomBars;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">ContextMenu</span>&gt; contextMenus;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">ModuleFormulaInst</span>&gt; formulas;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">CustomBean</span>&gt; annotationBeans;
    
    public <span class="hljs-keyword">abstract</span> <span class="hljs-type">F</span> createFieldConfig();
    public <span class="hljs-keyword">abstract</span> <span class="hljs-type">I</span> createUIItem();
    public <span class="hljs-keyword">abstract</span> <span class="hljs-type">C</span> createUIComponent();
    
    public <span class="hljs-type">List</span>&lt;<span class="hljs-type">CustomBean</span>&gt; getAnnotationBeans() {
        <span class="hljs-type">List</span>&lt;<span class="hljs-type">CustomBean</span>&gt; annotationBeans = <span class="hljs-keyword">new</span> <span class="hljs-type">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getModuleBean() != <span class="hljs-literal">null</span>) {
            annotationBeans.addAll(<span class="hljs-keyword">this</span>.getModuleBean().getAnnotationBeans());
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getDataBean() != <span class="hljs-literal">null</span>) {
            annotationBeans.add(<span class="hljs-keyword">this</span>.getDataBean());
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getFieldAggConfig() != <span class="hljs-literal">null</span>) {
            annotationBeans.addAll(<span class="hljs-keyword">this</span>.getFieldAggConfig().getAnnotationBeans());
        }
        <span class="hljs-keyword">return</span> annotationBeans;
    }
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>存储视图配置信息</li>
<li>管理字段和事件</li>
<li>支持视图的动态更新</li>
<li>提供注解信息</li>
</ul>
<h4 data-id="heading-63">CustomDataMeta</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomDataMeta</span> {
    
    <span class="hljs-keyword">private</span> String dataUrl;
    <span class="hljs-keyword">private</span> String editorPath;
    <span class="hljs-keyword">private</span> String addPath;
    <span class="hljs-keyword">private</span> String delPath;
    <span class="hljs-keyword">private</span> String sortPath;
    <span class="hljs-keyword">private</span> String saveRowPath;
    <span class="hljs-keyword">private</span> String saveAllRowPath;
    <span class="hljs-keyword">private</span> String searchUrl;
    <span class="hljs-keyword">private</span> String reloadUrl;
    <span class="hljs-keyword">private</span> String selectUrl;
    <span class="hljs-keyword">private</span> String unSelectUrl;
    <span class="hljs-keyword">private</span> String selectAllUrl;
    <span class="hljs-keyword">private</span> String unSelectAllUrl;
    <span class="hljs-keyword">private</span> String exportUrl;
    <span class="hljs-keyword">private</span> String importUrl;
    <span class="hljs-keyword">private</span> String customUrl;
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>存储数据配置信息</li>
<li>管理数据 URL 和路径</li>
<li>支持数据的动态配置</li>
<li>提供数据访问接口</li>
</ul>
<h4 data-id="heading-64">MethodConfig</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodConfig</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CustomViewMeta</span>, K <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CustomDataMeta</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparable</span>&lt;MethodConfig&gt; {
    
    <span class="hljs-keyword">private</span> String className;
    <span class="hljs-keyword">private</span> String desc;
    <span class="hljs-keyword">private</span> ModuleViewType moduleViewType;
    <span class="hljs-keyword">private</span> UIModule UIModule;
    <span class="hljs-keyword">private</span> CustomModuleMeta moduleBean;
    <span class="hljs-keyword">private</span> MethodConfig methodAPIBean;
    <span class="hljs-keyword">private</span> DomainInst domainInst;
    <span class="hljs-keyword">private</span> T view;
    <span class="hljs-keyword">private</span> K dataBean;
    <span class="hljs-keyword">private</span> BridgeClass bridgeClass;
    <span class="hljs-keyword">private</span> BridgeClass parentClass;
    <span class="hljs-keyword">private</span> String url;
    <span class="hljs-keyword">private</span> String caption;
    <span class="hljs-keyword">private</span> String methodName;
    <span class="hljs-keyword">private</span> String expression;
    <span class="hljs-keyword">private</span> String filter;
    <span class="hljs-keyword">private</span> String itemsExpression;
    <span class="hljs-keyword">private</span> String metaInfo;
    <span class="hljs-keyword">private</span> String fieldInfo;
    <span class="hljs-keyword">private</span> RequestMappingBean requestMapping;
    <span class="hljs-keyword">private</span> RequestBodyBean requestBody;
    <span class="hljs-keyword">private</span> Set&lt;RequestParamBean&gt; paramSet;
    <span class="hljs-keyword">private</span> RouteMenuMeta routeMenuBean;
    <span class="hljs-keyword">private</span> FieldAggConfig fieldAggConfig;
    <span class="hljs-keyword">private</span> CustomFieldMeta FieldMeta;
    <span class="hljs-keyword">private</span> RefBean refBean;
    <span class="hljs-keyword">private</span> CustomAPICallMeta api;
    <span class="hljs-keyword">private</span> List&lt;CustomBean&gt; annotationBeans;
    
    <span class="hljs-keyword">public</span> List&lt;CustomBean&gt; <span class="hljs-title function_">getAnnotationBeans</span><span class="hljs-params">()</span> {
        List&lt;CustomBean&gt; annotationBeans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getApi() != <span class="hljs-literal">null</span>) {
            annotationBeans.addAll(<span class="hljs-built_in">this</span>.getApi().getAnnotationBeans());
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isModule()) {
            annotationBeans.addAll(<span class="hljs-built_in">this</span>.getModuleBean().getAnnotationBeans());
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getDataBean() != <span class="hljs-literal">null</span>) {
                annotationBeans.add(<span class="hljs-built_in">this</span>.getDataBean());
            }
        }
        <span class="hljs-keyword">if</span> (routeMenuBean != <span class="hljs-literal">null</span>) {
            annotationBeans.add(routeMenuBean);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getFieldAggConfig() != <span class="hljs-literal">null</span>) {
            List&lt;CustomBean&gt; FieldMetas = <span class="hljs-built_in">this</span>.getFieldAggConfig().getAnnotationBeans();
            <span class="hljs-keyword">for</span> (CustomBean customBean : FieldMetas) {
                <span class="hljs-keyword">if</span> (!annotationBeans.contains(customBean)) {
                    annotationBeans.add(customBean);
                }
            }
        }
        <span class="hljs-keyword">if</span> (requestMapping != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">this</span>.getPublicMethod()) {
            annotationBeans.add(requestMapping);
        }
        <span class="hljs-keyword">if</span> (getResponseBody() || api != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (!annotationBeans.contains(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleCustomBean</span>(ResponseBody.class))) {
                annotationBeans.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleCustomBean</span>(ResponseBody.class));
            }
        }
        <span class="hljs-keyword">return</span> annotationBeans;
    }
    
    <span class="hljs-meta">@JSONField(serialize = false)</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMetaInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getMethod() != <span class="hljs-literal">null</span>) {
            List&lt;RequestParamBean&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(<span class="hljs-built_in">this</span>.getParamSet());
            
            <span class="hljs-keyword">if</span> (isModule() &amp;&amp; parentEuPackage != <span class="hljs-literal">null</span>) {
                <span class="hljs-type">String</span> <span class="hljs-variable">euClassName</span> <span class="hljs-operator">=</span> parentEuPackage + <span class="hljs-string">"."</span> + getJavaSimpleName();
                <span class="hljs-built_in">this</span>.metaInfo = MethodUtil.toMethodStr(<span class="hljs-built_in">this</span>.getMethod(), 
                    getViewType(), euClassName, requestBody, params).toString();
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-built_in">this</span>.metaInfo = MethodUtil.toMethodStr(<span class="hljs-built_in">this</span>.getMethod(), 
                    getViewType(), getJavaSimpleName(), requestBody, params).toString();
            }
        }
        <span class="hljs-keyword">return</span> metaInfo;
    }
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>管理方法的元数据</li>
<li>连接业务方法和 UI 组件</li>
<li>提供注解信息</li>
<li>生成方法签名</li>
</ul>
<h2 data-id="heading-65">可执行 Action</h2>
<h3 data-id="heading-66">parse-metadata</h3>
<p><strong>描述</strong>：解析元数据</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>source</code>：元数据源（JSON/注解）</li>
<li><code>type</code>：元数据类型</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证源格式</li>
<li>解析元数据</li>
<li>验证元数据完整性</li>
<li>返回解析结果</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-swift" lang="swift">用户：解析元数据
<span class="hljs-type">LLM：使用</span> <span class="hljs-type">Metadata</span> <span class="hljs-type">Skill</span> 的 parse<span class="hljs-operator">-</span>metadata <span class="hljs-type">Action</span>
参数：{<span class="hljs-string">"source"</span>: <span class="hljs-string">"{<span class="hljs-subst">\"</span>viewClassName<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>UserView<span class="hljs-subst">\"</span>, ...}"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"json"</span>}
结果：返回 <span class="hljs-type">MethodConfig</span> 对象
</code></pre>
<h3 data-id="heading-67">validate-metadata</h3>
<p><strong>描述</strong>：验证元数据</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>metadata</code>：元数据对象</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>验证必填字段</li>
<li>验证字段类型</li>
<li>验证引用关系</li>
<li>返回验证结果</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-json" lang="json">用户：验证元数据
LLM：使用 Metadata Skill 的 validate-metadata Action
参数：<span class="hljs-punctuation">{</span><span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> methodConfig<span class="hljs-punctuation">}</span>
结果：验证通过
</code></pre>
<h3 data-id="heading-68">generate-code</h3>
<p><strong>描述</strong>：生成代码</p>
<p><strong>参数</strong>：</p>
<ul>
<li><code>metadata</code>：元数据对象</li>
<li><code>type</code>：代码类型</li>
</ul>
<p><strong>执行流程</strong>：</p>
<ol>
<li>选择生成器</li>
<li>执行代码生成</li>
<li>编译生成的代码</li>
<li>返回生成的代码</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-css" lang="css">用户：生成代码
LLM：使用 Metadata Skill 的 generate-<span class="hljs-selector-tag">code</span> Action
参数：{"metadata": methodConfig, <span class="hljs-string">"type"</span>: <span class="hljs-string">"view"</span>}
结果：生成视图代码和仓储代码
</code></pre>
<h2 data-id="heading-69">使用场景</h2>
<h3 data-id="heading-70">场景 1：从 JSON 解析元数据</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：从 JSON 解析元数据
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Metadata Skill
<span class="hljs-bullet">2.</span> 调用 parse-metadata Action
<span class="hljs-bullet">3.</span> 解析 JSON 配置
<span class="hljs-bullet">4.</span> 返回 MethodConfig 对象
</code></pre>
<h3 data-id="heading-71">场景 2：生成组件代码</h3>
<pre><code class="hljs language-markdown" lang="markdown">用户需求：生成组件代码
LLM 处理：
<span class="hljs-bullet">1.</span> 加载 Metadata Skill
<span class="hljs-bullet">2.</span> 调用 generate-code Action
<span class="hljs-bullet">3.</span> 生成视图代码和仓储代码
<span class="hljs-bullet">4.</span> 返回生成的代码
</code></pre>
<h2 data-id="heading-72">最佳实践</h2>
<ol>
<li><strong>使用元数据驱动</strong>：通过元数据配置生成代码</li>
<li><strong>验证元数据完整性</strong>：确保元数据配置正确</li>
<li><strong>选择合适的代码类型</strong>：根据需求选择生成的代码类型</li>
<li><strong>优化生成性能</strong>：使用缓存和并行生成</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">
### <span class="hljs-number">4.3</span> Skill 集成实现

#### <span class="hljs-number">4.3</span><span class="hljs-number">.1</span> Skill Loader 实现

```java
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkillLoader</span> {
    
    <span class="hljs-keyword">private</span> Map&lt;<span class="hljs-type">String</span>, Skill&gt; skillCache = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;();
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> Skill <span class="hljs-title">loadSkill</span><span class="hljs-params">(<span class="hljs-type">String</span> skillName)</span> throws JDSException </span>{
        <span class="hljs-comment">// 1. 检查缓存</span>
        Skill cachedSkill = skillCache.<span class="hljs-built_in">get</span>(skillName);
        <span class="hljs-keyword">if</span> (cachedSkill != null) {
            <span class="hljs-keyword">return</span> cachedSkill;
        }
        
        <span class="hljs-comment">// 2. 加载 Skill 定义</span>
        <span class="hljs-type">String</span> skillPath = <span class="hljs-string">".trae/skills/"</span> + skillName + <span class="hljs-string">"-skill.md"</span>;
        <span class="hljs-type">String</span> skillContent = <span class="hljs-built_in">readFile</span>(skillPath);
        
        <span class="hljs-comment">// 3. 解析 Skill 定义</span>
        Skill skill = <span class="hljs-built_in">parseSkillDefinition</span>(skillContent);
        
        <span class="hljs-comment">// 4. 缓存 Skill</span>
        skillCache.<span class="hljs-built_in">put</span>(skillName, skill);
        
        <span class="hljs-keyword">return</span> skill;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">invalidateSkill</span><span class="hljs-params">(<span class="hljs-type">String</span> skillName)</span> </span>{
        skillCache.<span class="hljs-built_in">remove</span>(skillName);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;<span class="hljs-type">String</span>&gt; <span class="hljs-title">getAvailableSkills</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-built_in">File</span> skillsDir = <span class="hljs-keyword">new</span> <span class="hljs-built_in">File</span>(<span class="hljs-string">".trae/skills"</span>);
        <span class="hljs-built_in">File</span>[] skillFiles = skillsDir.<span class="hljs-built_in">listFiles</span>((dir, name) -&gt; 
            name.<span class="hljs-built_in">endsWith</span>(<span class="hljs-string">"-skill.md"</span>));
        
        <span class="hljs-keyword">return</span> Arrays.<span class="hljs-built_in">stream</span>(skillFiles)
                .<span class="hljs-built_in">map</span>(<span class="hljs-built_in">File</span>::getName)
                .<span class="hljs-built_in">map</span>(name -&gt; name.<span class="hljs-built_in">replace</span>(<span class="hljs-string">"-skill.md"</span>, <span class="hljs-string">""</span>))
                .<span class="hljs-built_in">collect</span>(Collectors.<span class="hljs-built_in">toList</span>());
    }
}
</code></pre>
<h4 data-id="heading-73">4.3.2 Skill Context 实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkillContext</span> {
    
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> List&lt;String&gt; loadedClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> List&lt;String&gt; loadedGenerators = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> List&lt;String&gt; loadedTemplates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addClass</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> clazz.getName();
        <span class="hljs-keyword">if</span> (!loadedClasses.contains(className)) {
            loadedClasses.add(className);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addGenerator</span><span class="hljs-params">(Class&lt;?&gt; generator)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">generatorName</span> <span class="hljs-operator">=</span> generator.getName();
        <span class="hljs-keyword">if</span> (!loadedGenerators.contains(generatorName)) {
            loadedGenerators.add(generatorName);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTemplate</span><span class="hljs-params">(String templateName)</span> {
        <span class="hljs-keyword">if</span> (!loadedTemplates.contains(templateName)) {
            loadedTemplates.add(templateName);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyParams</span><span class="hljs-params">(Map&lt;String, Object&gt; params)</span> {
        <span class="hljs-keyword">if</span> (params != <span class="hljs-literal">null</span>) {
            data.putAll(params);
        }
    }
    
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getParam</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">return</span> data.get(key);
    }
    
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getLoadedClasses</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(loadedClasses);
    }
    
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getLoadedGenerators</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(loadedGenerators);
    }
    
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getLoadedTemplates</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(loadedTemplates);
    }
}
</code></pre>
<h4 data-id="heading-74">4.3.3 LLM 集成示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMIntegration</span> {
    
    <span class="hljs-keyword">private</span> SkillOrchestrator orchestrator;
    <span class="hljs-keyword">private</span> SkillLoader skillLoader;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LLMIntegration</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.skillLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillLoader</span>();
        <span class="hljs-built_in">this</span>.orchestrator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillOrchestrator</span>();
        
        <span class="hljs-comment">// 注册所有 Skill</span>
        registerSkills();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerSkills</span><span class="hljs-params">()</span> {
        orchestrator.registerSkill(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FoundationSkill</span>());
        orchestrator.registerSkill(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleSkill</span>());
        orchestrator.registerSkill(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentSkill</span>());
        orchestrator.registerSkill(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MetadataSkill</span>());
    }
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">processUserRequest</span><span class="hljs-params">(String userRequest)</span> <span class="hljs-keyword">throws</span> JDSException {
        <span class="hljs-comment">// 1. 分析用户请求</span>
        <span class="hljs-type">RequestAnalysis</span> <span class="hljs-variable">analysis</span> <span class="hljs-operator">=</span> analyzeRequest(userRequest);
        
        <span class="hljs-comment">// 2. 选择合适的 Skill</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">skillName</span> <span class="hljs-operator">=</span> selectSkill(analysis);
        
        <span class="hljs-comment">// 3. 准备参数</span>
        Map&lt;String, Object&gt; params = prepareParams(analysis);
        
        <span class="hljs-comment">// 4. 执行 Skill</span>
        <span class="hljs-type">SkillResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> orchestrator.execute(skillName, params);
        
        <span class="hljs-comment">// 5. 返回结果</span>
        <span class="hljs-keyword">return</span> formatResult(result);
    }
    
    <span class="hljs-keyword">private</span> RequestAnalysis <span class="hljs-title function_">analyzeRequest</span><span class="hljs-params">(String userRequest)</span> {
        <span class="hljs-type">RequestAnalysis</span> <span class="hljs-variable">analysis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestAnalysis</span>();
        
        <span class="hljs-comment">// 分析请求类型</span>
        <span class="hljs-keyword">if</span> (userRequest.contains(<span class="hljs-string">"创建"</span>) &amp;&amp; userRequest.contains(<span class="hljs-string">"基础组件"</span>)) {
            analysis.setSkillName(<span class="hljs-string">"foundation"</span>);
            analysis.setActionName(<span class="hljs-string">"create-base-component"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userRequest.contains(<span class="hljs-string">"创建"</span>) &amp;&amp; userRequest.contains(<span class="hljs-string">"模块"</span>)) {
            analysis.setSkillName(<span class="hljs-string">"module"</span>);
            analysis.setActionName(<span class="hljs-string">"create-module"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userRequest.contains(<span class="hljs-string">"创建"</span>) &amp;&amp; userRequest.contains(<span class="hljs-string">"网格"</span>)) {
            analysis.setSkillName(<span class="hljs-string">"component"</span>);
            analysis.setActionName(<span class="hljs-string">"create-grid"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userRequest.contains(<span class="hljs-string">"解析"</span>) &amp;&amp; userRequest.contains(<span class="hljs-string">"元数据"</span>)) {
            analysis.setSkillName(<span class="hljs-string">"metadata"</span>);
            analysis.setActionName(<span class="hljs-string">"parse-metadata"</span>);
        }
        
        <span class="hljs-keyword">return</span> analysis;
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">selectSkill</span><span class="hljs-params">(RequestAnalysis analysis)</span> {
        <span class="hljs-keyword">return</span> analysis.getSkillName();
    }
    
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; <span class="hljs-title function_">prepareParams</span><span class="hljs-params">(RequestAnalysis analysis)</span> {
        Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-comment">// 从用户请求中提取参数</span>
        <span class="hljs-comment">// ...</span>
        
        <span class="hljs-keyword">return</span> params;
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatResult</span><span class="hljs-params">(SkillResult result)</span> {
        <span class="hljs-comment">// 格式化结果</span>
        <span class="hljs-keyword">return</span> result.toString();
    }
}
</code></pre>
<h3 data-id="heading-75">4.4 实战案例</h3>
<h4 data-id="heading-76">4.4.1 案例 1：创建用户管理模块</h4>
<p><strong>用户请求</strong>：</p>
<pre><code class="hljs">创建一个用户管理模块，包含用户列表网格和用户编辑表单
</code></pre>
<p><strong>LLM 处理流程</strong>：</p>
<ol>
<li>
<p><strong>分析请求</strong>：</p>
<ul>
<li>识别为创建模块请求</li>
<li>选择 Module Skill</li>
</ul>
</li>
<li>
<p><strong>执行 Skill</strong>：</p>
<ul>
<li>调用 create-module Action</li>
<li>生成模块代码</li>
</ul>
</li>
<li>
<p><strong>生成组件</strong>：</p>
<ul>
<li>调用 Component Skill 的 create-grid Action</li>
<li>生成用户网格代码</li>
<li>调用 Component Skill 的 create-group Action</li>
<li>生成分组表单代码</li>
</ul>
</li>
<li>
<p><strong>生成仓储</strong>：</p>
<ul>
<li>调用 Metadata Skill 的 generate-code Action</li>
<li>生成仓储代码</li>
</ul>
</li>
<li>
<p><strong>返回结果</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">已成功创建用户管理模块：
<span class="hljs-deletion">- UserModule.java</span>
<span class="hljs-deletion">- UserGrid.java</span>
<span class="hljs-deletion">- UserForm.java</span>
<span class="hljs-deletion">- UserRepository.java</span>
<span class="hljs-deletion">- UserService.java</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-77">4.4.2 案例 2：从 JSON 配置生成代码</h4>
<p><strong>用户请求</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">从以下 <span class="hljs-title class_">JSON</span> 配置生成代码：
{
  <span class="hljs-string">"viewClassName"</span>: <span class="hljs-string">"net.ooder.example.UserTableView"</span>,
  <span class="hljs-string">"moduleViewType"</span>: <span class="hljs-string">"GRIDCONFIG"</span>,
  <span class="hljs-string">"fields"</span>: [
    {<span class="hljs-string">"fieldname"</span>: <span class="hljs-string">"id"</span>, <span class="hljs-string">"caption"</span>: <span class="hljs-string">"ID"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"input"</span>, <span class="hljs-string">"editable"</span>: <span class="hljs-literal">false</span>},
    {<span class="hljs-string">"fieldname"</span>: <span class="hljs-string">"name"</span>, <span class="hljs-string">"caption"</span>: <span class="hljs-string">"姓名"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"input"</span>, <span class="hljs-string">"editable"</span>: <span class="hljs-literal">true</span>},
    {<span class="hljs-string">"fieldname"</span>: <span class="hljs-string">"age"</span>, <span class="hljs-string">"caption"</span>: <span class="hljs-string">"年龄"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"number"</span>, <span class="hljs-string">"editable"</span>: <span class="hljs-literal">true</span>}
  ]
}
</code></pre>
<p><strong>LLM 处理流程</strong>：</p>
<ol>
<li>
<p><strong>分析请求</strong>：</p>
<ul>
<li>识别为元数据解析请求</li>
<li>选择 Metadata Skill</li>
</ul>
</li>
<li>
<p><strong>解析元数据</strong>：</p>
<ul>
<li>调用 parse-metadata Action</li>
<li>解析 JSON 配置</li>
<li>生成 MethodConfig 对象</li>
</ul>
</li>
<li>
<p><strong>生成代码</strong>：</p>
<ul>
<li>调用 generate-code Action</li>
<li>生成视图代码</li>
<li>生成仓储代码</li>
</ul>
</li>
<li>
<p><strong>编译代码</strong>：</p>
<ul>
<li>调用动态编译</li>
<li>生成类文件</li>
</ul>
</li>
<li>
<p><strong>返回结果</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">已成功生成代码：
<span class="hljs-deletion">- UserTableView.java</span>
<span class="hljs-deletion">- UserRepository.java</span>
<span class="hljs-deletion">- UserService.java</span>
编译成功
</code></pre>
</li>
</ol>
<h4 data-id="heading-78">4.4.3 案例 3：创建树形组织结构</h4>
<p><strong>用户请求</strong>：</p>
<pre><code class="hljs">创建一个部门树形组件，显示组织结构
</code></pre>
<p><strong>LLM 处理流程</strong>：</p>
<ol>
<li>
<p><strong>分析请求</strong>：</p>
<ul>
<li>识别为创建树形组件请求</li>
<li>选择 Component Skill</li>
</ul>
</li>
<li>
<p><strong>执行 Skill</strong>：</p>
<ul>
<li>调用 create-tree Action</li>
<li>生成树形组件代码</li>
</ul>
</li>
<li>
<p><strong>生成仓储</strong>：</p>
<ul>
<li>调用 Metadata Skill 的 generate-code Action</li>
<li>生成仓储代码</li>
</ul>
</li>
<li>
<p><strong>返回结果</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">已成功创建部门树形组件：
<span class="hljs-deletion">- DepartmentTree.java</span>
<span class="hljs-deletion">- DepartmentRepository.java</span>
<span class="hljs-deletion">- DepartmentService.java</span>
</code></pre>
</li>
</ol>
<h2 data-id="heading-79">五、总结与展望</h2>
<h3 data-id="heading-80">5.1 关键成果</h3>
<h4 data-id="heading-81">5.1.1 BridgeCode 设计成果</h4>
<ol>
<li>
<p><strong>元数据驱动架构</strong>：</p>
<ul>
<li>实现了配置与实现的完全解耦</li>
<li>支持多种配置方式（JSON/注解）</li>
<li>提供了灵活的扩展能力</li>
</ul>
</li>
<li>
<p><strong>分层生成系统</strong>：</p>
<ul>
<li>视图层、仓储层、聚合层三层生成</li>
<li>31 个生成器覆盖所有场景</li>
<li>支持增量构建和并行生成</li>
</ul>
</li>
<li>
<p><strong>动态编译机制</strong>：</p>
<ul>
<li>运行时编译生成的代码</li>
<li>支持热更新和替换</li>
<li>提供了完整的生命周期管理</li>
</ul>
</li>
</ol>
<h4 data-id="heading-82">5.1.2 分层 SKILLS 设计成果</h4>
<ol>
<li>
<p><strong>清晰的职责划分</strong>：</p>
<ul>
<li>Foundation Skill：基础组件能力</li>
<li>Module Skill：模块管理能力</li>
<li>Component Skill：具体组件能力</li>
<li>Metadata Skill：元数据处理能力</li>
</ul>
</li>
<li>
<p><strong>可扩展的架构</strong>：</p>
<ul>
<li>支持新增 Skill</li>
<li>支持 Skill 组合</li>
<li>支持 Skill 版本管理</li>
</ul>
</li>
<li>
<p><strong>完整的 Action 体系</strong>：</p>
<ul>
<li>每个 Skill 提供多个 Action</li>
<li>Action 支持参数传递</li>
<li>Action 支持结果返回</li>
</ul>
</li>
</ol>
<h4 data-id="heading-83">5.1.3 Trae Solo 实践成果</h4>
<ol>
<li>
<p><strong>完整的集成方案</strong>：</p>
<ul>
<li>Skill Loader：加载和管理 Skill</li>
<li>Skill Context：管理执行上下文</li>
<li>LLM Integration：集成 LLM 和 Skill</li>
</ul>
</li>
<li>
<p><strong>实战验证</strong>：</p>
<ul>
<li>通过多个实战案例验证</li>
<li>覆盖主要使用场景</li>
<li>提供了完整的示例</li>
</ul>
</li>
<li>
<p><strong>最佳实践指导</strong>：</p>
<ul>
<li>提供了详细的最佳实践</li>
<li>提供了常见问题的解决方案</li>
<li>提供了性能优化建议</li>
</ul>
</li>
</ol>
<h3 data-id="heading-84">5.2 技术亮点</h3>
<h4 data-id="heading-85">5.2.1 设计模式应用</h4>
<ol>
<li>
<p><strong>模板方法模式</strong>：</p>
<ul>
<li>GenJavaTask 定义生成流程</li>
<li>子类实现具体生成逻辑</li>
</ul>
</li>
<li>
<p><strong>策略模式</strong>：</p>
<ul>
<li>不同的生成器实现不同的生成策略</li>
<li>运行时选择合适的生成器</li>
</ul>
</li>
<li>
<p><strong>工厂模式</strong>：</p>
<ul>
<li>SkillLoader 创建 Skill 实例</li>
<li>根据名称动态加载 Skill</li>
</ul>
</li>
<li>
<p><strong>观察者模式</strong>：</p>
<ul>
<li>组件生命周期事件通知</li>
<li>Skill 执行结果通知</li>
</ul>
</li>
</ol>
<h4 data-id="heading-86">5.2.2 性能优化</h4>
<ol>
<li>
<p><strong>缓存机制</strong>：</p>
<ul>
<li>Skill 缓存</li>
<li>生成结果缓存</li>
<li>模板缓存</li>
</ul>
</li>
<li>
<p><strong>并行处理</strong>：</p>
<ul>
<li>并行生成</li>
<li>并行编译</li>
<li>异步加载</li>
</ul>
</li>
<li>
<p><strong>增量构建</strong>：</p>
<ul>
<li>只生成变更的部分</li>
<li>只编译变更的文件</li>
<li>减少构建时间</li>
</ul>
</li>
</ol>
<h4 data-id="heading-87">5.2.3 可维护性</h4>
<ol>
<li>
<p><strong>清晰的代码结构</strong>：</p>
<ul>
<li>分层架构</li>
<li>职责明确</li>
<li>易于理解和维护</li>
</ul>
</li>
<li>
<p><strong>完整的文档</strong>：</p>
<ul>
<li>Skill 定义文档</li>
<li>使用示例文档</li>
<li>最佳实践文档</li>
</ul>
</li>
<li>
<p><strong>自动化测试</strong>：</p>
<ul>
<li>单元测试</li>
<li>集成测试</li>
<li>端到端测试</li>
</ul>
</li>
</ol>
<h3 data-id="heading-88">5.3 未来展望</h3>
<h4 data-id="heading-89">5.3.1 短期目标</h4>
<ol>
<li>
<p><strong>完善 Skill 体系</strong>：</p>
<ul>
<li>增加更多 Skill</li>
<li>优化现有 Skill</li>
<li>提高 Skill 质量</li>
</ul>
</li>
<li>
<p><strong>提升生成性能</strong>：</p>
<ul>
<li>优化生成算法</li>
<li>提高并行度</li>
<li>减少内存占用</li>
</ul>
</li>
<li>
<p><strong>增强集成能力</strong>：</p>
<ul>
<li>支持更多 LLM</li>
<li>支持更多工具</li>
<li>提供更好的集成体验</li>
</ul>
</li>
</ol>
<h4 data-id="heading-90">5.3.2 长期目标</h4>
<ol>
<li>
<p><strong>智能化生成</strong>：</p>
<ul>
<li>使用 AI 优化生成</li>
<li>自动检测问题</li>
<li>自动修复错误</li>
</ul>
</li>
<li>
<p><strong>可视化工具</strong>：</p>
<ul>
<li>提供可视化配置工具</li>
<li>提供可视化生成工具</li>
<li>提供可视化调试工具</li>
</ul>
</li>
<li>
<p><strong>生态系统建设</strong>：</p>
<ul>
<li>构建插件系统</li>
<li>构建市场系统</li>
<li>构建社区系统</li>
</ul>
</li>
</ol>
<h2 data-id="heading-91">六、结论</h2>
<p>本文深入解析了 ooder 框架的 BridgeCode 机制，从设计原理、生成编译流程，到分层 SKILLS 设计，最后展示了在 Trae Solo 环境中的 Skill 构建实践。</p>
<h3 data-id="heading-92">关键收获</h3>
<ol>
<li>
<p><strong>BridgeCode 设计原理</strong>：</p>
<ul>
<li>元数据驱动的三层架构</li>
<li>31 个生成器覆盖所有场景</li>
<li>动态编译和运行时绑定</li>
</ul>
</li>
<li>
<p><strong>分层 SKILLS 设计</strong>：</p>
<ul>
<li>Foundation、Module、Component、Metadata 四层 Skill</li>
<li>清晰的职责划分</li>
<li>完整的 Action 体系</li>
</ul>
</li>
<li>
<p><strong>Trae Solo 实践</strong>：</p>
<ul>
<li>完整的集成方案</li>
<li>多个实战案例</li>
<li>详细的最佳实践</li>
</ul>
</li>
</ol>
<p>这种设计既保持了架构的清晰性，又提供了强大的扩展能力，为 LLM 的使用和后续开发提供了坚实的基础。通过元数据驱动的代码生成和分层 SKILLS 设计，ooder 框架实现了高效的 A2UI 组件开发，为开发者提供了强大的工具支持。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[站在 Android 的角度，聊聊 Clean Architecture]]></title>    <link>https://juejin.cn/post/7603043152672358415</link>    <guid>https://juejin.cn/post/7603043152672358415</guid>    <pubDate>2026-02-05T08:54:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603043152672358415" data-draft-id="7599496293162287145" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="站在 Android 的角度，聊聊 Clean Architecture"/> <meta itemprop="keywords" content="架构,Kotlin,Android Jetpack"/> <meta itemprop="datePublished" content="2026-02-05T08:54:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿健君"/> <meta itemprop="url" content="https://juejin.cn/user/2313804282603431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            站在 Android 的角度，聊聊 Clean Architecture
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313804282603431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿健君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T08:54:04.000Z" title="Thu Feb 05 2026 08:54:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>Clean Architecture</strong>（整洁架构）是由著名软件工程师 Robert C. Martin 提出的一种软件设计理念和架构模式，它通过结构化的方式组织代码，使 Android 应用具备高度可维护性，可测试性和可扩展性。</p>
<h2 data-id="heading-0">核心思想</h2>
<p><strong>Clean Architecture</strong> 的核心原则是依赖规则：源代码依赖只能指向内层，内层不应该知道任何关于外层的东西。</p>
<ul>
<li>领域层（domain）-&gt; 不依赖任何外层，纯 Kotlin/Java，零 Android 框架依赖，只定义业务规则，UseCase 和 Repository 接口。</li>
<li>数据层（data）-&gt; 依赖领域层，实现领域层定义的 Repository 接口，但领域层不知其实现。</li>
<li>表现层（presentation）-&gt; 依赖领域层，通过 UseCase 调用业务逻辑，不直接依赖数据层。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d98264980bd9441f99223bebee0086a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5YGl5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770887405&amp;x-signature=0DbxivgFnnr1BiSbk3MnNuXOUmk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">分层结构</h2>
<p>先来看一下 Android 的项目结构</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b08fb6c4b62744479cf0e583f1877ba7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5YGl5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770887405&amp;x-signature=ChuVYY3Dx9MSdiG4BNqLzgrH0HU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">领域层 - 内层</h3>
<p><strong>职责与定位</strong>：</p>
<ul>
<li>领域层是核心，承载了项目真正的业务价值。</li>
<li>定义业务规则和业务模型，包含应用的核心业务逻辑。</li>
<li>只关心要做什么，而不是怎么做。</li>
</ul>
<p><strong>主要组成</strong>：</p>
<ul>
<li>实体（model）：表示业务核心对象。</li>
<li>用例（usecase）：封装特定业务行为。</li>
<li>仓库接口（repository）：定义数据操作的契约，不包含实现。</li>
</ul>
<p><strong>关键特点</strong>：</p>
<ul>
<li>纯 Kotlin/Java 代码，不依赖 Android 框架。</li>
<li>不依赖任何第三方库。</li>
<li>是整个项目中最稳定的一层。</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Post</span>(
    <span class="hljs-keyword">val</span> id: String,
    <span class="hljs-keyword">val</span> name: String
)
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GetPostsUseCase</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> postRepository: PostRepository
) {
    <span class="hljs-keyword">suspend</span> <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">invoke</span><span class="hljs-params">(params: <span class="hljs-type">HashMap</span>&lt;<span class="hljs-type">String</span>, String&gt;)</span></span>: Result&lt;BaseResp&lt;List&lt;Post&gt;&gt;&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            Result.success(postRepository.getPosts(params))
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Result.failure(e)
        }
    }
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PostRepository</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPosts</span><span class="hljs-params">(params: <span class="hljs-type">HashMap</span>&lt;<span class="hljs-type">String</span>, String&gt;)</span></span>: BaseResp&lt;List&lt;Post&gt;&gt;
}
</code></pre>
<h3 data-id="heading-3">数据层 - 中间层</h3>
<p><strong>职责与定位</strong>：</p>
<ul>
<li>负责数据从哪里来，如何获取。</li>
<li>处理数据检索和存储。</li>
<li>实现领域层定义的数据访问接口。</li>
</ul>
<p><strong>主要组成</strong>：</p>
<ul>
<li>数据源（datasource）：本地数据源或远程数据源</li>
<li>仓库实现（repository）：协调不同数据源，实现领域层定义的 Repository 接口，处理异常，将技术异常转换为业务可理解的结果。</li>
</ul>
<p><strong>关键特点</strong>：</p>
<ul>
<li>可以自由切换数据来源</li>
<li>变化最频繁的一层</li>
<li>可根据需求选择不同的数据存储方案</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PostService</span> {
    <span class="hljs-meta">@GET(<span class="hljs-string">"/xzj/net/api/example/post"</span>)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPosts</span><span class="hljs-params">(<span class="hljs-meta">@QueryMap</span> params: <span class="hljs-type">HashMap</span>&lt;<span class="hljs-type">String</span>, String&gt;)</span></span>: BaseResp&lt;List&lt;Post&gt;&gt;
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PostRepositoryImpl</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> postService: PostService
) : PostRepository {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPosts</span><span class="hljs-params">(params: <span class="hljs-type">HashMap</span>&lt;<span class="hljs-type">String</span>, String&gt;)</span></span>: BaseResp&lt;List&lt;Post&gt;&gt; {
        <span class="hljs-keyword">return</span> postService.getPosts(params)
    }
}
</code></pre>
<h3 data-id="heading-4">表现层 - 外层</h3>
<p><strong>职责与定位</strong>：</p>
<ul>
<li>负责 UI 展示和用户交互。</li>
<li>将数据转换为用户可感知的界面状态。</li>
<li>不包含业务规则，只负责管理 UIState。</li>
</ul>
<p><strong>主要组成</strong>：</p>
<ul>
<li>view：视图组件</li>
<li>ViewModel：通过 usecase 与 领域层交互</li>
<li>state：UI 状态</li>
</ul>
<p><strong>关键特点</strong>：</p>
<ul>
<li>通常使用 MVVM 或 MVI 模式组织代码。</li>
<li>专注于 UI State 管理。</li>
<li>可轻松更换用户界面框架或进行界面优化，而不影响业务逻辑。</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PostListState</span>(
    <span class="hljs-keyword">val</span> posts: List&lt;Post&gt; = emptyList(),
    <span class="hljs-keyword">val</span> isLoading: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>,
    <span class="hljs-keyword">val</span> error: String? = <span class="hljs-literal">null</span>
)
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@HiltViewModel</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PostListViewModel</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> getPostsUseCase: GetPostsUseCase
) : ViewModel() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _state = MutableStateFlow(PostListState())
    <span class="hljs-keyword">val</span> state: StateFlow&lt;PostListState&gt; = _state.asStateFlow()

    <span class="hljs-keyword">init</span> {
        loadPosts()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadPosts</span><span class="hljs-params">()</span></span> = viewModelScope.launch {
        _state.update { it.copy(isLoading = <span class="hljs-literal">true</span>) }
        <span class="hljs-keyword">val</span> params = hashMapOf(
            <span class="hljs-string">"param1"</span> to <span class="hljs-string">"param1"</span>,
            <span class="hljs-string">"param2"</span> to <span class="hljs-string">"param2"</span>
        )
        getPostsUseCase(params).onSuccess { posts -&gt;
            _state.update { it.copy(posts = posts.<span class="hljs-keyword">data</span>, isLoading = <span class="hljs-literal">false</span>) }
        }.onFailure { error -&gt;
            _state.update { it.copy(error = error.message, isLoading = <span class="hljs-literal">false</span>) }
        }
    }
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">PostListScreen</span><span class="hljs-params">(viewModel: <span class="hljs-type">PostListViewModel</span> = hiltViewModel()</span></span>) {
    <span class="hljs-keyword">val</span> state <span class="hljs-keyword">by</span> viewModel.state.collectAsState()

    <span class="hljs-keyword">when</span> {
        state.isLoading -&gt; CircularProgressIndicator()
        state.error != <span class="hljs-literal">null</span> -&gt; Text(<span class="hljs-string">"Error: <span class="hljs-subst">${state.error}</span>"</span>)
        <span class="hljs-keyword">else</span> -&gt; LazyColumn {
            items(state.posts) { post -&gt;
                Text(post.name, fontSize = <span class="hljs-number">20.</span>sp, color = Color.Red)
            }
        }
    }
}
</code></pre>
<p>Hilt 通过 @HiltViewModel 和 hiltViewModel() 自动处理 ViewModel 的依赖注入。在 Compose 中使用 hiltViewModel() 获取 ViewModel 实例，确保 ViewModel 及其依赖被正确初始化。</p>
<h2 data-id="heading-5">Hilt 依赖注入配置</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(SingletonComponent::class)</span>
<span class="hljs-keyword">object</span> NetworkModule {

    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-meta">@Provides</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideRetrofit</span><span class="hljs-params">()</span></span>: Retrofit {
        <span class="hljs-keyword">return</span> Retrofit.Builder()
            .baseUrl(BASE_URL)
            .addConverterFactory(GsonConverterFactory.create())
            .build()
    }

    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-meta">@Provides</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">providePostService</span><span class="hljs-params">(retrofit: <span class="hljs-type">Retrofit</span>)</span></span>: PostService {
        <span class="hljs-keyword">return</span> retrofit.create(PostService::<span class="hljs-keyword">class</span>.java)
    }
}


<span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(SingletonComponent::class)</span>
<span class="hljs-keyword">object</span> AppModule {

    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-meta">@Provides</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">providePostRepository</span><span class="hljs-params">(
        postService: <span class="hljs-type">PostService</span>
    )</span></span>: PostRepository {
        <span class="hljs-keyword">return</span> PostRepositoryImpl(postService)
    }

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideGetPostsUseCase</span><span class="hljs-params">(
        postRepository: <span class="hljs-type">PostRepository</span>
    )</span></span>: GetPostsUseCase {
        <span class="hljs-keyword">return</span> GetPostsUseCase(postRepository)
    }
}
</code></pre>
<h2 data-id="heading-6">意义何在</h2>
<p>看到这，你们可能要吐槽了，实现一个功能要建这么多层，这么多类，代码量多这么多，不是徒增工作量吗？真的有意义吗？</p>
<p>首先，徒增工作量是客观存在的，比如你实现一个简单的功能 - 获取用户信息，你需要创建领域层，数据层，表现层，还有各种接口与接口实现，对比 “一把梭” 写法（Activity 直接调用方法获取数据），代码量可能要翻三倍以上。</p>
<p>德国著名哲学家黑格尔曾说过：存在即合理。所以，Clean Architecture 既然存在，那肯定是有意义的！它的意义就在于：用短期成本换长期收益。</p>
<p>举个需求变更的例子吧，就拿常见的用户信息来说，一开始只要求显示 user.name，但是几天后，产品突然改主意了，VIP 用户得显示 VIP 和名字。</p>
<p>按照 “一把梭” 的写法，规则散落在各个 Composable 中的。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserCard</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span> {
    Card {
        <span class="hljs-comment">// 第一处：业务规则直接写死在 UI 里！</span>
        Text(text = <span class="hljs-keyword">if</span> (user.isVip) <span class="hljs-string">"VIP: <span class="hljs-subst">${user.name}</span>"</span> <span class="hljs-keyword">else</span> user.name) 
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfileHeader</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span> {
    Column {
        <span class="hljs-comment">// 第二处！规则重复</span>
        Text(text = <span class="hljs-keyword">if</span> (user.isVip) <span class="hljs-string">"VIP: <span class="hljs-subst">${user.name}</span>"</span> <span class="hljs-keyword">else</span> user.name, style = Title)
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SearchItem</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span> {
    Row {
        <span class="hljs-comment">// 第三处！改需求时需全局搜索替换</span>
        Text(text = <span class="hljs-keyword">if</span> (user.isVip) <span class="hljs-string">"VIP: <span class="hljs-subst">${user.name}</span>"</span> <span class="hljs-keyword">else</span> user.name)
    }
}
</code></pre>
<p>如果使用 Clean Architecture 的话，只需修改 domain 层即可，其本身就是规则的集中管理。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GetDisplayNameUseCase</span> { <span class="hljs-comment">//规则唯一源头！</span>
    <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">invoke</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span>: String =
        <span class="hljs-keyword">if</span> (user.isVip) <span class="hljs-string">"VIP: <span class="hljs-subst">${user.name}</span>"</span> <span class="hljs-keyword">else</span> user.name
        <span class="hljs-comment">// 只改这里！</span>
}
</code></pre>
<p>只需修改 UseCase，其余都不用修改，简直不要太优雅。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@HiltViewModel</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserViewModel</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> getDisplayName: GetDisplayNameUseCase <span class="hljs-comment">// 依赖注入</span>
) : ViewModel() {
    <span class="hljs-comment">// ViewModel 只负责调用规则，不包含规则本身。</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getDisplayName</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span> = getDisplayName(user)
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserCard</span><span class="hljs-params">(user: <span class="hljs-type">User</span>, viewModel: <span class="hljs-type">UserViewModel</span> = hiltViewModel()</span></span>) {
    Card {
        <span class="hljs-comment">// Composable 纯粹只关注显示什么，不关心为什么这样显示。</span>
        Text(text = viewModel.getDisplayName(user))
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfileHeader</span><span class="hljs-params">(user: <span class="hljs-type">User</span>, viewModel: <span class="hljs-type">UserViewModel</span> = hiltViewModel()</span></span>) {
    Text(text = viewModel.getDisplayName(user), style = Title)
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SearchItem</span><span class="hljs-params">(user: <span class="hljs-type">User</span>, viewModel: <span class="hljs-type">UserViewModel</span> = hiltViewModel()</span></span>) {
    Text(text = viewModel.getDisplayName(user))
}
</code></pre>
<p>下次产品再说加什么其他信息的时候，你只需微笑打开 UseCase 即可，而不用翻遍所有 Composable。</p>
<p>但也不是所有项目都该用，而是该用时必须用！对于大型且需持续迭代的项目，架构治理是必然要求，随着代码量增加，改动成本不断上升，所以比较适用于 “中大型”，“团队协作”，“高可靠性要求” 的项目。如果你的项目本身规模不大，也不需要花额外精力治理架构，对于小规模项目，引入 Clean Architecture 可能会增加开发成本，所以不适用。</p>
<blockquote>
<p>架构不是炫技，而是为未来的自己和团队减负，我们不能 “为了架构而架构”，若项目注定 “一次性”，请大胆简化，效率优先，若项目需 “活下去、长出来”，就得接受短期成本，投资长期健康。Clean Architecture 的精髓就在于它不承诺 “写得更快”，但承诺 “改得更稳”。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Veaury：让Vue和React组件在同一应用中共存的神器]]></title>    <link>https://juejin.cn/post/7602900131540697129</link>    <guid>https://juejin.cn/post/7602900131540697129</guid>    <pubDate>2026-02-05T01:47:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602900131540697129" data-draft-id="7602807243705647167" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Veaury：让Vue和React组件在同一应用中共存的神器"/> <meta itemprop="keywords" content="前端,前端框架"/> <meta itemprop="datePublished" content="2026-02-05T01:47:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员_June"/> <meta itemprop="url" content="https://juejin.cn/user/395479916219517"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Veaury：让Vue和React组件在同一应用中共存的神器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479916219517/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员_June
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T01:47:34.000Z" title="Thu Feb 05 2026 01:47:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前端开发者常常面临这样的困境：Vue项目需要使用React生态的优秀组件，或者React项目想引入Vue的优雅解决方案。过去，这几乎意味着需要完全重写或寻找笨重的替代方案。</p>
<p>今天介绍的Veaury将彻底改变这一局面。这是一个专门设计用于在Vue和React之间实现无缝互操作的工具库。</p>
<h2 data-id="heading-0">核心问题与挑战</h2>
<p>在实际开发中，跨框架组件复用面临诸多挑战：</p>
<ol>
<li><strong>上下文隔离</strong>：Vue和React有各自独立的上下文系统，数据传递困难</li>
<li><strong>生命周期不匹配</strong>：两个框架的生命周期模型完全不同</li>
<li><strong>事件系统差异</strong>：Vue使用自定义事件，React使用合成事件</li>
<li><strong>渲染机制不同</strong>：Vue基于模板，React基于JSX</li>
</ol>
<h2 data-id="heading-1">Veaury的技术实现原理</h2>
<p>Veaury通过高阶组件(HOC)的方式，在两种框架之间搭建桥梁。其核心思路是：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简化版实现原理示意</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createCrossFrameworkWrapper</span>(<span class="hljs-params">OriginalComponent, targetFramework</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Wrapper</span>(<span class="hljs-params">props, context</span>) {
    <span class="hljs-comment">// 处理props转换</span>
    <span class="hljs-keyword">const</span> convertedProps = <span class="hljs-title function_">convertProps</span>(props, targetFramework);
    
    <span class="hljs-comment">// 处理上下文传递</span>
    <span class="hljs-keyword">const</span> frameworkContext = <span class="hljs-title function_">adaptContext</span>(context, targetFramework);
    
    <span class="hljs-comment">// 根据目标框架选择渲染方式</span>
    <span class="hljs-keyword">if</span> (targetFramework === <span class="hljs-string">'vue'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">renderAsVue</span>(<span class="hljs-title class_">OriginalComponent</span>, convertedProps, frameworkContext);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">renderAsReact</span>(<span class="hljs-title class_">OriginalComponent</span>, convertedProps, frameworkContext);
    }
  };
}
</code></pre>
<h2 data-id="heading-2">主要特性</h2>
<h3 data-id="heading-3">1. 完整的Vue 3支持</h3>
<ul>
<li>支持Composition API和Options API</li>
<li>支持Teleport、Suspense等Vue 3特性</li>
<li>完整的响应式系统集成</li>
</ul>
<h3 data-id="heading-4">2. 双向上下文共享</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React组件可以访问Vue的provide/inject</span>
<span class="hljs-comment">// Vue组件可以访问React的Context</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">SharedComponent</span> = (<span class="hljs-params">{ theme }</span>) =&gt; {
  <span class="hljs-comment">// theme可以来自Vue的provide或React的Context</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">theme-</span>${<span class="hljs-attr">theme</span>}`}&gt;</span>共享主题<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
};
</code></pre>
<h3 data-id="heading-5">3. 纯模式（Pure Mode）</h3>
<p>消除包装器带来的额外DOM元素，保持组件树的整洁：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用纯模式包装</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">PureReactComponent</span> = <span class="hljs-title function_">applyPureReactInVue</span>(<span class="hljs-title class_">ReactComponent</span>);
<span class="hljs-comment">// 渲染结果没有额外的div包裹</span>
</code></pre>
<h3 data-id="heading-6">4. 生命周期映射</h3>
<p>Veaury智能地映射两个框架的生命周期：</p>





















<table><thead><tr><th>Vue 生命周期</th><th>React 等效</th></tr></thead><tbody><tr><td><code>onMounted</code></td><td><code>useEffect(() =&gt; {}, [])</code></td></tr><tr><td><code>onUpdated</code></td><td><code>useEffect(() =&gt; {})</code></td></tr><tr><td><code>onUnmounted</code></td><td><code>useEffect(() =&gt; () =&gt; {})</code></td></tr></tbody></table>
<h2 data-id="heading-7">实际应用示例</h2>
<h3 data-id="heading-8">场景一：在Vue项目中使用React组件</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Vue组件主体<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 直接使用React组件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ReactDataTable</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"tableData"</span> @<span class="hljs-attr">row-click</span>=<span class="hljs-string">"handleRowClick"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { applyPureReactInVue } <span class="hljs-keyword">from</span> <span class="hljs-string">'veaury'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDataTable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ReactDataTable.jsx'</span>;

<span class="hljs-comment">// 将React组件转换为Vue可用的组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ReactDataTable</span> = <span class="hljs-title function_">applyPureReactInVue</span>(<span class="hljs-title class_">ReactDataTable</span>);

<span class="hljs-keyword">const</span> tableData = <span class="hljs-title function_">ref</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'项目A'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">100</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'项目B'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">200</span> }
]);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRowClick</span> = (<span class="hljs-params">rowData</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'行点击事件:'</span>, rowData);
  <span class="hljs-comment">// 处理来自React组件的事件</span>
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">场景二：在React项目中使用Vue组件</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { applyVueInReact } <span class="hljs-keyword">from</span> <span class="hljs-string">'veaury'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueRichEditor</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./VueRichEditor.vue'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">RichEditor</span> = <span class="hljs-title function_">applyVueInReact</span>(<span class="hljs-title class_">VueRichEditor</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [content, setContent] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [isDarkMode, setIsDarkMode] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleContentChange</span> = (<span class="hljs-params">newContent</span>) =&gt; {
    <span class="hljs-title function_">setContent</span>(newContent);
    <span class="hljs-comment">// 处理来自Vue组件的事件</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{isDarkMode</span> ? '<span class="hljs-attr">dark-theme</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">light-theme</span>'}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>React应用中的Vue富文本编辑器<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">RichEditor</span>
        <span class="hljs-attr">modelValue</span>=<span class="hljs-string">{content}</span>
        <span class="hljs-attr">onUpdate:modelValue</span>=<span class="hljs-string">{handleContentChange}</span>
        <span class="hljs-attr">darkMode</span>=<span class="hljs-string">{isDarkMode}</span>
        <span class="hljs-attr">v-slots</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">toolbar:</span> () =&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>自定义工具栏<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        }}
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsDarkMode(!isDarkMode)}&gt;
        切换主题
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-10">性能考虑</h2>
<p>Veaury在性能方面做了大量优化：</p>
<ol>
<li><strong>最小化重渲染</strong>：通过精细的响应式侦听，避免不必要的重新渲染</li>
<li><strong>内存效率</strong>：合理管理组件实例，避免内存泄漏</li>
<li><strong>构建优化</strong>：支持Tree-shaking，只引入需要的功能</li>
</ol>
<p>性能对比示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统iframe方案 vs Veaury方案</span>
<span class="hljs-comment">// iframe：独立的DOM、样式和上下文，开销大</span>
<span class="hljs-comment">// Veaury：共享同一DOM，轻量级包装，性能接近原生</span>
</code></pre>
<h2 data-id="heading-11">企业级应用实践</h2>
<h3 data-id="heading-12">案例：低代码平台集成</h3>
<p>某低代码平台使用Veaury实现插件系统：</p>
<ul>
<li>核心框架：Vue 3 + TypeScript</li>
<li>插件生态：支持React和Vue两种插件</li>
<li>实现效果：开发者可使用任意框架开发插件</li>
</ul>
<h3 data-id="heading-13">案例：微前端架构</h3>
<p>在微前端场景中，Veaury帮助不同技术栈的子应用共享组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主应用(Vue)使用子应用(React)的组件库</span>
<span class="hljs-keyword">import</span> { applyPureReactInVue } <span class="hljs-keyword">from</span> <span class="hljs-string">'veaury'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDesignSystem</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'team-react-ds'</span>;

<span class="hljs-comment">// 在Vue主应用中直接使用React设计系统</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">VueWrappedButton</span> = <span class="hljs-title function_">applyPureReactInVue</span>(<span class="hljs-title class_">ReactDesignSystem</span>.<span class="hljs-property">Button</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">VueWrappedModal</span> = <span class="hljs-title function_">applyPureReactInVue</span>(<span class="hljs-title class_">ReactDesignSystem</span>.<span class="hljs-property">Modal</span>);
</code></pre>
<h2 data-id="heading-14">配置与构建</h2>
<h3 data-id="heading-15">Vite配置示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>;
<span class="hljs-keyword">import</span> veauryVitePlugins <span class="hljs-keyword">from</span> <span class="hljs-string">'veaury/vite'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">veauryVitePlugins</span>({
      <span class="hljs-attr">type</span>: <span class="hljs-string">'vue'</span>, <span class="hljs-comment">// 或 'react'，根据主框架选择</span>
      <span class="hljs-attr">vueOptions</span>: {
        <span class="hljs-attr">reactivityTransform</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 启用响应式语法糖</span>
      }
    })
  ],
  <span class="hljs-attr">optimizeDeps</span>: {
    <span class="hljs-attr">include</span>: [<span class="hljs-string">'veaury'</span>]
  }
});
</code></pre>
<h3 data-id="heading-16">Webpack配置要点</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.vue$/</span>,
        <span class="hljs-attr">use</span>: <span class="hljs-string">'vue-loader'</span>
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.jsx$/</span>,
        <span class="hljs-attr">use</span>: <span class="hljs-string">'babel-loader'</span>,
        <span class="hljs-attr">options</span>: {
          <span class="hljs-attr">presets</span>: [<span class="hljs-string">'@babel/preset-react'</span>]
        }
      }
    ]
  }
};
</code></pre>
<h2 data-id="heading-17">局限性说明</h2>
<p>尽管Veaury功能强大，但仍有一些限制：</p>
<ol>
<li><strong>部分高级特性</strong>：某些框架特定的高级特性可能不完全支持</li>
<li><strong>开发体验</strong>：调试时需要了解两种框架</li>
<li><strong>学习成本</strong>：团队需要同时熟悉Vue和React</li>
</ol>
<h2 data-id="heading-18">总结</h2>
<p>对于需要在Vue和React之间搭建桥梁的项目，Veaury提供了一个成熟、稳定的解决方案。无论是新项目技术选型，还是老项目现代化改造，都值得考虑这一工具。</p>
<p><strong>技术栈不应成为创新的约束，而应是实现目标的工具。</strong> Veaury正是这一理念的实践，让开发者能够专注于创造价值，而不是被框架之争所困扰。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用AI模拟实现一个 Claude Code CLI]]></title>    <link>https://juejin.cn/post/7603004323870179371</link>    <guid>https://juejin.cn/post/7603004323870179371</guid>    <pubDate>2026-02-05T00:35:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603004323870179371" data-draft-id="7602910573404209190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用AI模拟实现一个 Claude Code CLI"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-05T00:35:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用AI模拟实现一个 Claude Code CLI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:35:01.000Z" title="Thu Feb 05 2026 00:35:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    26
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>从零开始构建终端 AI 编程助手，探索 REPL 交互、输入缓冲区、终端渲染等技术</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p><strong>重要说明：</strong> 本项目的代码完全由 AI 辅助生成。我扮演产品经理的角色，负责提出需求、明确功能边界，而 AI 负责所有的编码实现。这是一次探索"AI 主导开发"模式的实践。</p>
<p>用过 Claude Code 的开发者都会被它流畅的终端交互体验所吸引。一个简单但功能强大的命令行工具，让 AI 像结对编程伙伴一样在终端中与你协作。</p>
<p>晚上使用AI过程突然心血来潮：能否用 AI 来实现一个类似的工具，顺便了解下这种终端工具是如何实现的 ？说干就干——我只负责描述想要的功能，让 AI 来完成所有的代码编写。</p>
<p>先看看最终实现的效果：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─ CodeCLI v0.1.0 ───────────────────────────────────────────┐
│ Welcome back!                                              │
│                                                            │
│   <span class="hljs-strong">____</span>          _                                         │
│  / <span class="hljs-strong">__<span class="hljs-emphasis">_| _</span>__</span>  <span class="hljs-strong">__| | __</span>_                                    │
│ | |    / _ \/ <span class="hljs-emphasis">_` |/ _</span> \                                   │
│ | |<span class="hljs-strong">__<span class="hljs-emphasis">_|  _</span><span class="hljs-emphasis">_/ (_</span>| |  __</span>/                                   │
│  \<span class="hljs-strong">____</span>|\<span class="hljs-strong">__<span class="hljs-emphasis">_|\_</span><span class="hljs-emphasis">_,_</span>|\__</span><span class="hljs-emphasis">_|                                   │
│                                                            │
│ Project: my-project                                        │
│ Model: Opus                                                │
└────────────────────────────────────────────────────────────┘
──────────────────────────────────────────────────────────────
› _</span>
──────────────────────────────────────────────────────────────
accept edits off (shift+tab to cycle)
</code></pre>
<p>核心功能包括：</p>
<ul>
<li>流畅的多行输入编辑</li>
<li>历史命令搜索</li>
<li>斜杠命令系统</li>
<li>终端内的 Shell 执行</li>
</ul>
<h2 data-id="heading-1">核心架构</h2>
<p>项目只有两个核心文件：</p>
<pre><code class="hljs language-bash" lang="bash">src/
├── index.ts    <span class="hljs-comment"># 入口，处理命令行参数</span>
└── repl.ts     <span class="hljs-comment"># REPL引擎，约1200行</span>
</code></pre>
<p>虽然 <code>repl.ts</code> 代码量不小，但结构非常清晰，可以拆分为几个独立的模块：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────┐
│                    CodeCli                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │ InputBuffer │  │  Renderer   │  │  CommandSet │ │
│  │  (输入状态)  │  │  (终端渲染)  │  │  (命令处理)  │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │  History    │  │KillRing     │  │   Message   │ │
│  │  (历史管理)  │  │(复制粘贴)    │  │  (消息队列)  │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────┘
</code></pre>
<h2 data-id="heading-2">功能介绍</h2>
<h5 data-id="heading-3">一、输入缓冲区：处理多行编辑</h5>
<p>最基础也最关键的是输入缓冲区。它需要维护两个核心状态：文本内容和光标位置。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">InputBuffer</span> {
  value = <span class="hljs-string">""</span>;      <span class="hljs-comment">// 当前文本</span>
  cursor = <span class="hljs-number">0</span>;      <span class="hljs-comment">// 光标位置</span>

  <span class="hljs-title function_">insert</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-comment">// 在光标处插入文本，更新光标</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">cursor</span>) + text + <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cursor</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cursor</span> += text.<span class="hljs-property">length</span>;
  }

  <span class="hljs-title function_">moveWordLeft</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 跳到前一个单词开头</span>
    <span class="hljs-keyword">let</span> i = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cursor</span> - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">while</span> (i &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isWhitespace</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>[i])) i--;
    <span class="hljs-keyword">while</span> (i &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isWordChar</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>[i - <span class="hljs-number">1</span>])) i--;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cursor</span> = i;
  }
}
</code></pre>
<p><strong>设计要点：</strong></p>
<p><strong>1. 光标位置独立跟踪</strong> - 不依赖终端的实际光标，只维护逻辑位置</p>
<p><strong>2. 多行支持</strong> - 内部用 <code>\n</code> 分割，渲染时转换为行列坐标</p>
<p><strong>3. 词操作</strong> - 类似 Emacs，按单词边界移动（Alt+B/F）</p>
<p>这个设计的巧妙之处在于：输入逻辑与渲染逻辑完全解耦。无论终端怎么变化，InputBuffer 只负责维护正确的文本状态。</p>
<h5 data-id="heading-4">二、终端渲染：ANSI 转义序列</h5>
<p>终端渲染的核心是使用 ANSI 转义序列控制屏幕：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">lines</span>: <span class="hljs-built_in">string</span>[] = [];

  <span class="hljs-comment">// 1. 构建所有行的内容</span>
  lines.<span class="hljs-title function_">push</span>(header);
  lines.<span class="hljs-title function_">push</span>(...messages);
  lines.<span class="hljs-title function_">push</span>(inputArea);
  lines.<span class="hljs-title function_">push</span>(modeLine);

  <span class="hljs-comment">// 2. 清屏并输出</span>
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">"\x1b[2J\x1b[H"</span>);  <span class="hljs-comment">// 清屏，光标归位</span>
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(lines.<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>));

  <span class="hljs-comment">// 3. 定位光标</span>
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">`\x1b[<span class="hljs-subst">${row}</span>;<span class="hljs-subst">${col}</span>H`</span>);
}
</code></pre>
<p><strong>常用 ANSI 序列：</strong></p>





























<table><thead><tr><th>序列</th><th>作用</th></tr></thead><tbody><tr><td><code>\x1b[2J</code></td><td>清屏</td></tr><tr><td><code>\x1b[H</code></td><td>光标移到左上角</td></tr><tr><td><code>\x1b[row;colH</code></td><td>移动光标到指定位置</td></tr><tr><td><code>\x1b[?25h</code></td><td>显示光标</td></tr><tr><td><code>\x1b[35m</code></td><td>设置颜色（紫色）</td></tr></tbody></table>
<p>渲染策略采用"全屏刷新"：每次状态变化都重新计算并绘制所有内容。这在现代终端上性能足够好，且代码简洁。</p>
<h5 data-id="heading-5">三、键盘事件：原始模式处理</h5>
<p>Node.js 默认使用" cooked mode"，需要回车才发送输入。我们需要切换到"raw mode"来捕获每个按键：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
  readline.<span class="hljs-title function_">emitKeypressEvents</span>(process.<span class="hljs-property">stdin</span>);
  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">stdin</span>.<span class="hljs-property">isTTY</span>) process.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">setRawMode</span>(<span class="hljs-literal">true</span>);
  process.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">"keypress"</span>, <span class="hljs-function">(<span class="hljs-params">str, key</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onKeypress</span>(str, key));
}

<span class="hljs-keyword">private</span> <span class="hljs-title function_">onKeypress</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span>, key: readline.Key</span>) {
  <span class="hljs-keyword">if</span> (key.<span class="hljs-property">ctrl</span> &amp;&amp; key.<span class="hljs-property">name</span> === <span class="hljs-string">"c"</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">input</span>.<span class="hljs-title function_">setValue</span>(<span class="hljs-string">""</span>);  <span class="hljs-comment">// Ctrl+C 清空</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key.<span class="hljs-property">ctrl</span> &amp;&amp; key.<span class="hljs-property">name</span> === <span class="hljs-string">"r"</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startReverseSearch</span>();  <span class="hljs-comment">// Ctrl+R 历史搜索</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (str &amp;&amp; !key.<span class="hljs-property">ctrl</span> &amp;&amp; !key.<span class="hljs-property">meta</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">input</span>.<span class="hljs-title function_">insert</span>(str);  <span class="hljs-comment">// 普通字符</span>
  }
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();  <span class="hljs-comment">// 每次按键后重绘</span>
}
</code></pre>
<p><strong>事件处理的难点：</strong></p>
<p><strong>组合键识别</strong> - Ctrl/Alt/Shift 需要检查 <code>key.ctrl</code>、<code>key.meta</code> 等标志</p>
<p><strong>特殊键处理</strong> - 方向键、Home/End 等不会产生可打印字符</p>
<p><strong>双击 ESC</strong> - 检测两次 ESC 的间隔来判断 rewind 命令</p>
<h5 data-id="heading-6">四、历史搜索：仿 Emacs 的 Ctrl+R</h5>
<p>历史搜索是提升效率的关键功能。实现思路：</p>
<pre><code class="hljs">┌─────────────────────────────────────────────────────────┐
│  用户输入搜索字符串                                      │
│         ↓                                                │
│  从历史末尾向前遍历查找匹配                              │
│         ↓                                                │
│  实时更新显示的匹配结果                                  │
│         ↓                                                │
│  用户可以继续输入缩小搜索，或 Ctrl+R 查看上一个匹配      │
└─────────────────────────────────────────────────────────┘
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">findHistoryMatch</span>(<span class="hljs-attr">query</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">startIndex</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">if</span> (!query) <span class="hljs-keyword">return</span> startIndex;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = startIndex; i &gt;= <span class="hljs-number">0</span>; i--) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>[i].<span class="hljs-title function_">includes</span>(query)) <span class="hljs-keyword">return</span> i;
  }
  <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
}
</code></pre>
<p>搜索是交互式的：每输入一个字符就重新搜索，实时显示匹配结果。</p>
<h5 data-id="heading-7">五、杀环：Emacs 风格的复制粘贴</h5>
<p>"杀环"（Kill Ring）是 Emacs 的概念，比系统剪贴板更强大：</p>
<pre><code class="hljs">操作          效果
─────────────────────────────
Ctrl+K        删除到行尾，存入杀环
Ctrl+U        删除整行，存入杀环
Ctrl+Y        粘贴最新剪切内容
Alt+Y         循环切换剪贴历史
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-attr">killRing</span>: <span class="hljs-built_in">string</span>[] = [];

<span class="hljs-keyword">private</span> <span class="hljs-title function_">pushKillRing</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">killRing</span>.<span class="hljs-title function_">push</span>(text);  <span class="hljs-comment">// 记录每次删除</span>
}

<span class="hljs-keyword">private</span> <span class="hljs-title function_">yank</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> text = <span class="hljs-variable language_">this</span>.<span class="hljs-property">killRing</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">killRing</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">input</span>.<span class="hljs-title function_">insert</span>(text);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastYankIndex</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">killRing</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">private</span> <span class="hljs-title function_">yankCycle</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// Alt+Y：粘贴后循环切换之前剪切的内容</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastYankIndex</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastYankIndex</span> &lt;= <span class="hljs-number">0</span>
    ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">killRing</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
    : <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastYankIndex</span> - <span class="hljs-number">1</span>;
  <span class="hljs-comment">// 替换刚才粘贴的内容...</span>
}
</code></pre>
<p>这个设计让多次剪切的内容都能被访问，比单一剪贴板灵活得多。</p>
<h5 data-id="heading-8">六、命令系统：斜杠前缀</h5>
<p>命令以 <code>/</code> 开头，类似 Discord/Slash 命令：</p>
<pre><code class="hljs language-bash" lang="bash">/help      显示帮助
/clear     清空对话
/plan      切换到计划模式
/model     切换AI模型
</code></pre>
<p>实现核心是一个简单的路由器：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleCommand</span>(<span class="hljs-params">input: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> parts = input.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/\s+/</span>);
  <span class="hljs-keyword">const</span> cmd = parts[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">const</span> args = parts.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);

  <span class="hljs-keyword">switch</span> (cmd) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"help"</span>: <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showHelp</span>();
    <span class="hljs-keyword">case</span> <span class="hljs-string">"clear"</span>: <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clearAll</span>();
    <span class="hljs-keyword">case</span> <span class="hljs-string">"plan"</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">mode</span> = <span class="hljs-string">"plan"</span>; <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"model"</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setModel</span>(args[<span class="hljs-number">0</span>]); <span class="hljs-keyword">break</span>;
  }
}
</code></pre>
<p><strong>命令补全：</strong> 当用户输入 <code>/</code> 时，实时显示匹配的命令列表，提升发现性。</p>
<h5 data-id="heading-9">七、Shell 模式：感叹号前缀</h5>
<p>用 <code>!</code> 前缀可以直接执行 shell 命令：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用户输入：! git status</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">runShell</span>(<span class="hljs-params">command: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> child = <span class="hljs-title function_">spawn</span>(<span class="hljs-string">"powershell.exe"</span>, [<span class="hljs-string">"-Command"</span>, command]);
  <span class="hljs-keyword">let</span> output = <span class="hljs-string">""</span>;
  child.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">"data"</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> output += data);
  child.<span class="hljs-title function_">on</span>(<span class="hljs-string">"close"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">appendMessage</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-attr">content</span>: output });
  });
}
</code></pre>
<p>这让你在 AI 对话中无缝执行系统命令，结果直接显示在对话中。</p>
<h2 data-id="heading-10">写在最后</h2>
<p>本文介绍了一个简化版的 Claude Code CLI 的关键功能及相关实现代码。虽然这是一个 MVP 实现，但展示了终端应用开发的核心技术，这些技术可应用于任何需要复杂终端交互的项目。</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/yuboon</span><span class="hljs-regexp">/ai-examples/tree</span><span class="hljs-regexp">/main/</span><span class="hljs-number">001</span>-coding-cli
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI赋能售后测试：从“黑盒”到“智能伙伴”]]></title>    <link>https://juejin.cn/post/7603142147642736683</link>    <guid>https://juejin.cn/post/7603142147642736683</guid>    <pubDate>2026-02-05T09:35:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603142147642736683" data-draft-id="7602996277665333302" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI赋能售后测试：从“黑盒”到“智能伙伴”"/> <meta itemprop="keywords" content="Cursor"/> <meta itemprop="datePublished" content="2026-02-05T09:35:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI赋能售后测试：从“黑盒”到“智能伙伴”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:35:34.000Z" title="Thu Feb 05 2026 09:35:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ul>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">一、项目推进与合作中的三大核心痛点的解决</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1. 逻辑不透明 → 智能逻辑解析</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2. 数据构造繁琐 → 场景化构造推荐</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3. 规则同步滞后 → 实时规则查询与解释</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">二、AI智能助手，如何改变现状？</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">✅ 业务问题实时解答</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">✅ 开发与测试高效支持</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">✅ 服务两类用户群体</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">三、为什么选择Dify？</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">四、dify智能助手搭建实现</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">五、已实现场景演示</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">📌 场景一：售后单实时状态查询</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">📌 场景二：基于单号的业务逻辑追问</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">📌 场景三：数据构造指导</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">📌 场景四：无单号纯逻辑答疑</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">六、效果已现，优化持续</a></p>
</li>
</ul>
<p>售后系统长期以来像是企业内部的“黑盒”——流程复杂、信息分散、逻辑交叉，业务部门在项目推进中常面临三重阻力：</p>
<p><strong>逻辑理解难</strong>：不同售后场景命中条件错综复杂，人工排查效率低下；</p>
<p><strong>数据构造繁</strong>：测试验证时缺乏标准构造指引，依赖经验试错，周期冗长；</p>
<p><strong>规则响应慢</strong>：跨部门协作中，规则解释依赖人工沟通，信息同步不及时。</p>
<p>这不仅拖慢了项目节奏，更让内部协作陷入“等人、问人、找人”的循环。</p>
<p>为此，我们推出基于Dify平台构建的<strong>售后业务智能助手</strong>，聚焦<strong>逻辑梳理、数据构造、规则同步</strong>三大场景，将“黑盒”变为“透明工作台”，为项目协作与测试验证提供智能支持。</p>
<h2 data-id="heading-0">一、项目推进与合作中的三大核心痛点的解决</h2>
<h3 data-id="heading-1">1. 逻辑不透明 → 智能逻辑解析</h3>
<p>系统可自动解析不同售后流程的命中规则与判定逻辑，为业务决策和项目对齐提供清晰依据。</p>
<h3 data-id="heading-2">2. 数据构造繁琐 → 场景化构造推荐</h3>
<p>提供常见测试场景的标准化数据构造方案，附示例参数与操作链接，提升测试效率与准确性。</p>
<h3 data-id="heading-3">3. 规则同步滞后 → 实时规则查询与解释</h3>
<p>业务规则与流程说明实时可查，支持自然语言提问，减少跨团队沟通成本与信息误差。</p>
<h2 data-id="heading-4">二、AI智能助手，如何改变现状？</h2>
<h3 data-id="heading-5">✅ 业务问题实时解答</h3>
<p>● 无法申请售后？【提供】一键排查原因</p>
<p>● 流程命中逻辑不清晰？【提供】自动说明规则</p>
<p>● 质检责任认定模糊？【提供】明确判定依据与流程选择</p>
<p>● 散货交接后去哪质检？【提供】智能推荐仓库与站点</p>
<h3 data-id="heading-6">✅ 开发与测试高效支持</h3>
<p>● 提供各类订单构造方法与示例</p>
<p>● 实时查询售后类型与节点数据</p>
<p>● 数据构造后，自动给出下一步操作建议指向</p>
<h3 data-id="heading-7">✅ 服务两类用户群体</h3>
<p>● 内部团队：提升协作效率，释放人力</p>
<p>● 业务合作方：提供标准化、即时化的解答支持</p>
<h2 data-id="heading-8">三、为什么选择Dify？</h2>
<p>在评估多种实现方案后，我们最终选用Dify平台，主要因为：</p>
<p>● 低门槛可视化搭建：无需代码即可配置工作流，快速迭代</p>
<p>● 内置AI核心模块：知识库、意图识别、对话管理开箱即用</p>
<p>● 灵活扩展性强：支持连接外部接口（MCP），获取实时业务数据</p>
<p>● dify可提供机器人会话工作流程搭建</p>
<h2 data-id="heading-9">四、dify智能助手搭建实现</h2>
<p>整体设计思路：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13442b49d4bf4992976cae75982567d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=pmXQZeuUZ%2F%2FoaTgGgikjvJ95mPM%3D" alt="" loading="lazy"/></p>
<p>智能助手并非简单问答机器人，而是通过多层AI节点协同工作，核心利用节点设计如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d456f6e2943e46cb8604b49772f1fc65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=fme6m%2F9H8OTXtkYB1jjKw%2Bl057k%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>参数提取器</strong>：自动识别售后单号等关键信息</li>
</ol>
<p>从用户问题中提取关键参数，例如售后单ID等。当用户提问涉及具体业务单据时，系统自动提取标识信息，供后续节点调用。</p>













<table><thead><tr><th>dify配置</th><th>应用</th></tr></thead><tbody><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cc7e18b92f9486bba250f95026c30ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=B4nPvFr0WNkK1Km8xKcdK63NabM%3D" alt="" loading="lazy"/>指令即是提示词</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f72fd850c184677b2c98c1833cc5e33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=vP2j4qKnxwERE7EIXtIfPnSnPNc%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<ol start="2">
<li><strong>Agent智能代理</strong>：调用真实业务接口，获取实时数据</li>
</ol>
<p>负责调用外部接口获取实时业务数据，并对返回结果进行结构化解析。例如，根据售后单ID查询详情，并提取状态、处理人、时间等关键字段，转化为自然语言描述。</p>













<table><thead><tr><th>配置</th><th>应用</th></tr></thead><tbody><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d95a50131bef46a0a90548f517eeb592~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=ib18nlkX%2FF5Uc0%2BKTRng%2Bl8N3Zs%3D" alt="" loading="lazy"/> 指令即是提示词</td><td>原有接口返回结构<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2941b48feacd4d9898c6ca80850096fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=H%2BGbvrwBuce4MulJ43LdWHRDdYw%3D" alt="" loading="lazy"/>提示词后返回结构<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6701a3c8df846ed8cf4d5112b4e5a91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=XZRJv3xhTJHe3viAYgiPXKoxgBo%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<ol start="3">
<li><strong>问题分类器</strong>：将问题分为规则类、流程类、数据构造类</li>
</ol>
<p>根据问题类型将用户输入分流至不同的处理流程。我们将问题分为以下几类：</p>
<p>● 业务规则类（需检索知识库）</p>
<p>● 流程指引类（需组合逻辑说明）</p>
<p>● 数据构造类（需推荐构造方案）</p>
<p>分类后，系统可调用相应的提示词模板与处理逻辑，提升回答准确性。</p>













<table><thead><tr><th>配置</th><th>应用</th></tr></thead><tbody><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b1f61f600d84bd3a717d6447c135a0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=ZMjnIlP1LAWJFGuWcyKAuzD9Rs0%3D" alt="" loading="lazy"/></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/988e581c8ced45c090f1c3977b9852eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=xqRakHcqR602DfUfptg6ZTZcnpk%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<ol start="4">
<li><strong>知识库（RAG）</strong> ：沉淀业务文档、FAQ、流程说明，精准检索</li>
</ol>
<p>用于存储业务文档、流程说明、常见问题等知识内容。便于。系统根据用户问题从知识库中检索匹配相关内容，作为生成回答的依据。</p>




















<table><thead><tr><th/><th>配置</th><th>应用</th></tr></thead><tbody><tr><td>知识库数据内容</td><td>知识库上传提供了很多文件格式、切片格式（切片：Dify知识库切片是指将上传到Dify平台的知识库文档按一定规则分割成更小、更易管理的内容块（称为“chunks”）的过程。这些切片是知识库检索和应用的基础单元，便于AI模型在生成回答时精准引用相关信息。‌） 文件：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8e63b3300504fe7a9e0cdba5b55d8e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=5UqEQsEg%2BCBeWKVJYlUWHGYnOLE%3D" alt="" loading="lazy"/> 切片格式：可有多个选择<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/862d9ec5876e4164b644f9710fa85c11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=ly3y4ZoMJyFV0bIYu6noZTY0yN4%3D" alt="" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31d1bd9474764f188597dd47f42beae6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=XQFt6J%2BZNsOFeYwEXMmWpmupvF8%3D" alt="" loading="lazy"/></td><td/></tr><tr><td>RAG获取</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6176e42cf58744919a79994c70f598b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=xekUggToeD8p7bKuq3LMHs8GgPs%3D" alt="" loading="lazy"/>通过预览可查看效果 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da15dcb4a9e542868be411416afbcd92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=j%2Bsqjuh9fGZrLwOQfRf2ylWn9pc%3D" alt="" loading="lazy"/> 方式一：直接获取 按切片匹配排序<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e65c462758114b1fb3a3207c68f60d3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=maUO%2B8j139K4yb5g%2FFfwOqir4ao%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beefe21418174fa689c462fbdc002959~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=Ar3x%2BUnOK9DBlJKVQMU%2B5eLNNfc%3D" alt="" loading="lazy"/> 方式二：大模型提示词匹配<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1735fe4c9da4440880aacb4bba077e8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=VmM8r9UNgY6p7T1BfdxVjiANstg%3D" alt="" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e7b8af2d6d940a1981a85842e4dc0ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=0Gu3Ee9qLlOXhhsR%2FoKsGNiymk8%3D" alt="" loading="lazy"/> 由于大模型分析时间较长，且我们知识库信息也比较全面的情况下就采取匹配返回即可</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b05baa9410f645d59378caf1ed880688~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=1Gz8SG2FMOli1Z74rWeHhmpzZbc%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<p>知识库内容结构实现</p>
<p>● 数据构造知识库</p>













<table><thead><tr><th>结构</th><th>示例</th></tr></thead><tbody><tr><td>场景 描述+链接 步骤对应状态：<strong>用来匹配数据构造</strong> 入参介绍：<strong>用来推荐参数取值</strong> 方式：统计目前常用数据构造场景整合输出 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/944aa66af3b44eed9ce5588cb00fc8ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=0jx80rjjNAgSGakrRP0qKqY5Hmk%3D" alt="" loading="lazy"/></td><td><strong>使用场景</strong>: 退货退款-揽收极速退 关键数据构造链接: <a href="https://link.juejin.cn?target=https%3A%2F%2Fqe.*****.com%2FdataPt%2FsceneList%2F20570781%2F528%3FdId%3D7700" target="_blank" title="https://qe.*****.com/dataPt/sceneList/20570781/528?dId=7700" ref="nofollow noopener noreferrer">退货退款-揽收极速退 数据构造链接</a> 此链接用于创建和管理退货案例 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e63757463740453a9a00df3e698e33f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=XrvRIISDAWvfFM3cbM1eUQKBhPw%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<p>● 业务知识库</p>













<table><thead><tr><th>结构</th><th>示例</th></tr></thead><tbody><tr><td>功能概述 逻辑整理 方式：可利用Cursor阅读技术方法，来分析逻辑输出 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5ef939264354022b0e9cb0cf05e9efc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=MqSdEzVVkVrgl5xQsrb5UYU7JzE%3D" alt="" loading="lazy"/></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e14ee620acd4a398fd5d923cec22429~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=THkyfNt5zRUM0R7cv6C4bB4KQGA%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<ol start="5">
<li><strong>大语言模型节点</strong>：整合信息，生成自然语言回答</li>
</ol>
<p>整合知识库内容、实时数据与用户问题，生成自然语言回答。我们根据场景选择合适的模型，并配置温度、惩罚参数等，以控制回答的准确性与创造性。</p>













<table><thead><tr><th>配置</th><th>应用</th></tr></thead><tbody><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bda6ff8c7e144a1e8f71b126c5f4a6b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=le%2FKwPIEelDrE6QQjy7p8VeGgYI%3D" alt="" loading="lazy"/>模型选择和参数：模型参数控制响应生成。 温度范围从 0（确定性）到 1（创造性）。 核采样通过概率限制词汇选择。频率惩罚减少重复。存在惩罚鼓励新话题。你也可以使用预设：精确、平衡或创意。  提示词配置：你的界面根据模型类型自适应。聊天模型使用消息角色（系统用于行为，用户用于输入，助手用于示例），而完成模型使用简单的文本续写。 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22757720c24e4b8fba5bd58ae679acda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=BlNxBdfGI6nA8E7P4suYONIqHqg%3D" alt="" loading="lazy"/></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff11f99ad98e4b71825b5fca644f58b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=XcBpPUZRaLiiAxWvlQZFOPHKr0M%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<p>Tips：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8d88e9c433343a88c743d20b6406bcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=q83IXHszRakEovzwpGqyRWbEAAw%3D" alt="" loading="lazy"/></p>
<ol start="6">
<li><strong>对话缓存</strong>：支持多轮对话，记忆上下文，体验更连贯</li>
</ol>
<p>为实现多轮对话支持，系统通过缓存记录当前会话的关键信息（如售后单ID），使得用户在后续提问中无需重复输入，提升交互连贯性。</p>













<table><thead><tr><th>配置</th><th>应用</th></tr></thead><tbody><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56a622ba9d6e47968ddf3f9ad1c17571~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=6Sdb1IyxxPg3eRMBMrZRcq%2Ba624%3D" alt="" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d02c552c749e4f6f934c2f0326344afe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=8EtmWpoAF7iqZ%2FMD8A%2BxTDjV5%2BI%3D" alt="" loading="lazy"/></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/679911d580e94d7eaf2c45bceb9df559~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=OPtu9FmlYF99vkBiu1adqLUChqA%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<h2 data-id="heading-10">五、已实现场景演示</h2>
<h3 data-id="heading-11">📌 场景一：售后单实时状态查询</h3>
<p>用户输入售后单号，系统自动拉取最新状态、处理人、时间节点，并给出业务解释。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21c47990bdee4520a312712f642848bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=TtOlx%2B8XbT6rNdZOIwISPTygAqI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">📌 场景二：基于单号的业务逻辑追问</h3>
<p>例如：“为什么这个售后单不能走极速退？”系统结合单号数据与业务规则，给出明确原因。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffdebdcd576c434daa66cfdeca800bcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=yaT0DBHhTln3AbPc80W5PI8C2O0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">📌 场景三：数据构造指导</h3>
<p>针对测试场景，推荐数据构造方案，并附带示例链接与参数建议。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fbc567114ed4cb59313a59740b576b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=JDh%2FfBM7tHh43c9xYYpWkNlq0gI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">📌 场景四：无单号纯逻辑答疑</h3>
<p>即使没有单号，也能回答诸如“什么情况下会触发质检？”等通用规则问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45c028a890e3435585e115be0a257e0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=Px%2FnkYyUJd7BQbZ%2Fb49SGjmJ7zk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">六、效果已现，优化持续</h2>
<p>目前，智能助手已初步覆盖售后核心问答场景，响应速度提升至秒级，人力释放显著。接下来，我们将：</p>
<ol>
<li>持续扩充知识库，覆盖更多业务分支</li>
<li>优化问题分类准确率，支持更细粒度问答</li>
<li>增强多轮对话能力，处理复杂问题链</li>
<li>探索与业务系统深度集成，推动流程自动化</li>
</ol>
<hr/>
<p>AI不是替代人力，而是<strong>增强人效、沉淀知识、标准化服务</strong>。售后智能助手正是这一理念的落地实践——让业务支持更智能，让团队协作更轻松。</p>
<p>未来，我们将继续探索AI在业务场景中的深度融合，让每一个流程节点都拥有“智慧支持”。<strong>智能售后，应答而来。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Fragment添加与状态变更时序图]]></title>    <link>https://juejin.cn/post/7603444191447908386</link>    <guid>https://juejin.cn/post/7603444191447908386</guid>    <pubDate>2026-02-06T08:50:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603444191447908386" data-draft-id="7603355275257626664" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Fragment添加与状态变更时序图"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2026-02-06T08:50:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="乾坤一气杀"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289955431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Fragment添加与状态变更时序图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289955431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    乾坤一气杀
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:50:30.000Z" title="Fri Feb 06 2026 08:50:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Fragment添加与状态变更时序图</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Activity
    participant FragmentManager
    participant FragmentTransaction
    participant FragmentStateManager
    participant Fragment

    Note over Activity,Fragment: Fragment添加阶段

    Activity-&gt;&gt;FragmentManager: getSupportFragmentManager()
    FragmentManager--&gt;&gt;Activity: return FragmentManager实例

    Activity-&gt;&gt;FragmentManager: beginTransaction()
    FragmentManager-&gt;&gt;FragmentTransaction: 创建FragmentTransaction
    FragmentTransaction--&gt;&gt;Activity: return FragmentTransaction

    Activity-&gt;&gt;FragmentTransaction: add(containerId, fragment)
    FragmentTransaction-&gt;&gt;FragmentTransaction: 记录Op操作

    Activity-&gt;&gt;FragmentTransaction: commit()
    FragmentTransaction-&gt;&gt;FragmentManager: 提交事务

    Note over FragmentManager,Fragment: Fragment状态管理阶段

    FragmentManager-&gt;&gt;FragmentManager: executeOps()
    FragmentManager-&gt;&gt;FragmentStateManager: 创建FragmentStateManager(fragment)

    FragmentManager-&gt;&gt;FragmentStateManager: addFragment()
    FragmentStateManager-&gt;&gt;FragmentStateManager: computeExpectedState()

    Note over FragmentStateManager,Fragment: 状态变更: INITIALIZING -&gt; ATTACHED

    FragmentStateManager-&gt;&gt;Fragment: onAttach(context)
    Fragment--&gt;&gt;FragmentStateManager: 完成attach
    FragmentStateManager-&gt;&gt;Activity: onAttachFragment(fragment)

    Note over FragmentStateManager,Fragment: 状态变更: ATTACHED -&gt; CREATED

    FragmentStateManager-&gt;&gt;Fragment: onCreate(savedInstanceState)
    Fragment--&gt;&gt;FragmentStateManager: 完成create

    Note over FragmentStateManager,Fragment: 状态变更: CREATED -&gt; VIEW_CREATED

    FragmentStateManager-&gt;&gt;Fragment: onCreateView(inflater, container, savedInstanceState)
    Fragment--&gt;&gt;FragmentStateManager: return View
    FragmentStateManager-&gt;&gt;Fragment: onViewCreated(view, savedInstanceState)

    Note over FragmentStateManager,Fragment: 状态变更: VIEW_CREATED -&gt; ACTIVITY_CREATED

    FragmentStateManager-&gt;&gt;Fragment: onActivityCreated(savedInstanceState)
    Fragment--&gt;&gt;FragmentStateManager: 完成activityCreated

    Note over FragmentStateManager,Fragment: 状态变更: ACTIVITY_CREATED -&gt; STARTED

    FragmentStateManager-&gt;&gt;Fragment: onStart()
    Fragment--&gt;&gt;FragmentStateManager: 完成start

    Note over FragmentStateManager,Fragment: 状态变更: STARTED -&gt; RESUMED

    FragmentStateManager-&gt;&gt;Fragment: onResume()
    Fragment--&gt;&gt;FragmentStateManager: 完成resume

    FragmentStateManager-&gt;&gt;FragmentManager: 更新Fragment状态
    FragmentManager-&gt;&gt;Activity: Fragment已就绪

    Note over Activity,Fragment: Fragment完全显示，处于RESUMED状态

    Note over Activity,Fragment: ========== Activity生命周期驱动Fragment状态变更 ==========

    Note over Activity,Fragment: 场景1: Activity暂停（如锁屏、跳转到其他Activity）

    Activity-&gt;&gt;Activity: onPause()
    Activity-&gt;&gt;FragmentManager: dispatchPause()
    FragmentManager-&gt;&gt;FragmentStateManager: moveToState(STARTED)

    Note over FragmentStateManager,Fragment: 状态变更: RESUMED -&gt; STARTED

    FragmentStateManager-&gt;&gt;Fragment: onPause()
    Fragment--&gt;&gt;FragmentStateManager: 完成pause
    FragmentStateManager-&gt;&gt;FragmentManager: 状态已更新

    Note over Activity,Fragment: 场景2: Activity停止（完全不可见）

    Activity-&gt;&gt;Activity: onStop()
    Activity-&gt;&gt;FragmentManager: dispatchStop()
    FragmentManager-&gt;&gt;FragmentStateManager: moveToState(ACTIVITY_CREATED)

    Note over FragmentStateManager,Fragment: 状态变更: STARTED -&gt; ACTIVITY_CREATED

    FragmentStateManager-&gt;&gt;Fragment: onStop()
    Fragment--&gt;&gt;FragmentStateManager: 完成stop
    FragmentStateManager-&gt;&gt;FragmentManager: 状态已更新

    Note over Activity,Fragment: 场景3: Activity销毁

    Activity-&gt;&gt;Activity: onDestroy()
    Activity-&gt;&gt;FragmentManager: dispatchDestroy()
    FragmentManager-&gt;&gt;FragmentStateManager: moveToState(INITIALIZING)

    Note over FragmentStateManager,Fragment: 状态变更: ACTIVITY_CREATED -&gt; VIEW_CREATED

    FragmentStateManager-&gt;&gt;Fragment: onDestroyView()
    Fragment--&gt;&gt;FragmentStateManager: 完成destroyView

    Note over FragmentStateManager,Fragment: 状态变更: VIEW_CREATED -&gt; CREATED

    FragmentStateManager-&gt;&gt;Fragment: onDestroy()
    Fragment--&gt;&gt;FragmentStateManager: 完成destroy

    Note over FragmentStateManager,Fragment: 状态变更: CREATED -&gt; ATTACHED

    FragmentStateManager-&gt;&gt;Fragment: onDetach()
    Fragment--&gt;&gt;FragmentStateManager: 完成detach

    FragmentStateManager-&gt;&gt;FragmentManager: Fragment已销毁
    FragmentManager-&gt;&gt;FragmentManager: 移除Fragment引用

    Note over Activity,Fragment: 场景4: Activity重新启动（从后台返回）

    Activity-&gt;&gt;Activity: onRestart()
    Activity-&gt;&gt;Activity: onStart()
    Activity-&gt;&gt;FragmentManager: dispatchStart()
    FragmentManager-&gt;&gt;FragmentStateManager: moveToState(STARTED)

    Note over FragmentStateManager,Fragment: 状态变更: ACTIVITY_CREATED -&gt; STARTED

    FragmentStateManager-&gt;&gt;Fragment: onStart()
    Fragment--&gt;&gt;FragmentStateManager: 完成start

    Activity-&gt;&gt;Activity: onResume()
    Activity-&gt;&gt;FragmentManager: dispatchResume()
    FragmentManager-&gt;&gt;FragmentStateManager: moveToState(RESUMED)

    Note over FragmentStateManager,Fragment: 状态变更: STARTED -&gt; RESUMED

    FragmentStateManager-&gt;&gt;Fragment: onResume()
    Fragment--&gt;&gt;FragmentStateManager: 完成resume
    FragmentStateManager-&gt;&gt;FragmentManager: 状态已更新

    Note over Activity,Fragment: Fragment再次完全显示，处于RESUMED状态

    Note over Activity,Fragment: 场景5: 配置变更（如屏幕旋转）

    Activity-&gt;&gt;Activity: onSaveInstanceState()
    Activity-&gt;&gt;FragmentManager: dispatchSaveInstanceState()
    FragmentManager-&gt;&gt;FragmentStateManager: saveState()
    FragmentStateManager-&gt;&gt;Fragment: onSaveInstanceState(outState)
    Fragment--&gt;&gt;FragmentStateManager: 保存状态数据

    Note over Activity,Fragment: Activity销毁并重建

    Activity-&gt;&gt;FragmentManager: dispatchDestroy()
    Note over FragmentManager,Fragment: Fragment执行销毁流程（同场景3）

    Activity-&gt;&gt;Activity: 新Activity onCreate()
    Activity-&gt;&gt;FragmentManager: 恢复FragmentManager状态
    FragmentManager-&gt;&gt;FragmentStateManager: 重建Fragment
    FragmentStateManager-&gt;&gt;Fragment: onCreate(savedInstanceState)
    Note over FragmentManager,Fragment: Fragment重新执行创建流程（同初始添加阶段）
</code></pre>
<h3 data-id="heading-1">说明</h3>
<h4 data-id="heading-2">主要流程</h4>
<ol>
<li>
<p><strong>事务创建阶段</strong></p>
<ul>
<li>Activity通过FragmentManager获取FragmentTransaction</li>
<li>调用add()方法记录添加操作</li>
<li>调用commit()提交事务</li>
</ul>
</li>
<li>
<p><strong>状态管理阶段</strong></p>
<ul>
<li>FragmentManager创建FragmentStateManager来管理Fragment状态</li>
<li>FragmentStateManager负责驱动Fragment的生命周期状态变更</li>
</ul>
</li>
<li>
<p><strong>生命周期状态变更（向上）</strong></p>
<ul>
<li>INITIALIZING → ATTACHED：调用onAttach()</li>
<li>ATTACHED → CREATED：调用onCreate()</li>
<li>CREATED → VIEW_CREATED：调用onCreateView()和onViewCreated()</li>
<li>VIEW_CREATED → ACTIVITY_CREATED：调用onActivityCreated()</li>
<li>ACTIVITY_CREATED → STARTED：调用onStart()</li>
<li>STARTED → RESUMED：调用onResume()</li>
</ul>
</li>
<li>
<p><strong>Activity驱动Fragment状态变更</strong></p>
<ul>
<li><strong>暂停场景</strong>：Activity.onPause() → FragmentManager.dispatchPause() → Fragment.onPause()</li>
<li><strong>停止场景</strong>：Activity.onStop() → FragmentManager.dispatchStop() → Fragment.onStop()</li>
<li><strong>销毁场景</strong>：Activity.onDestroy() → FragmentManager.dispatchDestroy() → Fragment依次执行onDestroyView()、onDestroy()、onDetach()</li>
<li><strong>恢复场景</strong>：Activity重启时，通过dispatchStart()和dispatchResume()驱动Fragment恢复到RESUMED状态</li>
<li><strong>配置变更</strong>：Activity在销毁前保存Fragment状态，重建后恢复Fragment</li>
</ul>
</li>
<li>
<p><strong>Fragment状态与Activity生命周期的对应关系</strong></p>
<ul>
<li>Activity RESUMED → Fragment RESUMED</li>
<li>Activity STARTED → Fragment STARTED</li>
<li>Activity CREATED → Fragment ACTIVITY_CREATED</li>
<li>Activity DESTROYED → Fragment INITIALIZING</li>
</ul>
</li>
</ol>
<h4 data-id="heading-3">关键类职责</h4>
<ul>
<li><strong>Activity</strong>：宿主容器，生命周期变化时通过FragmentManager分发事件驱动Fragment状态同步变更</li>
<li><strong>FragmentManager</strong>：管理Fragment集合，接收Activity生命周期事件并协调Fragment状态转换</li>
<li><strong>FragmentTransaction</strong>：记录Fragment操作，提交事务</li>
<li><strong>FragmentStateManager</strong>：管理单个Fragment的状态变更，调用moveToState()执行状态转换</li>
<li><strong>Fragment</strong>：UI组件，响应生命周期回调</li>
</ul>
<h4 data-id="heading-4">状态转换关键点</h4>
<ul>
<li>Fragment的状态始终不会超过其宿主Activity的状态</li>
<li>FragmentManager通过dispatch系列方法（dispatchPause/Stop/Destroy/Start/Resume）同步Activity生命周期到Fragment</li>
<li>FragmentStateManager根据目标状态计算需要执行的生命周期方法序列</li>
<li>配置变更时，Fragment状态会被保存并在Activity重建后恢复</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习：Kotlin中的JvmOverloads注解]]></title>    <link>https://juejin.cn/post/7603376587651940402</link>    <guid>https://juejin.cn/post/7603376587651940402</guid>    <pubDate>2026-02-06T08:53:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603376587651940402" data-draft-id="7603347438013268003" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习：Kotlin中的JvmOverloads注解"/> <meta itemprop="keywords" content="Kotlin,Java"/> <meta itemprop="datePublished" content="2026-02-06T08:53:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习：Kotlin中的JvmOverloads注解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:53:42.000Z" title="Fri Feb 06 2026 08:53:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>@JvmOverloads 是 Kotlin 中一个非常实用且重要的注解，它的核心作用是为 Kotlin 函数自动生成 Java 友好的重载方法，从而简化 Kotlin 与 Java 之间的互操作。</p>
<h2 data-id="heading-1">核心作用：解决默认参数的互操作性问题</h2>
<p>Kotlin 支持函数的默认参数，这极大地提高了代码的简洁性和可读性。</p>
<p>例如：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin 代码</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dialog</span>(
    <span class="hljs-keyword">val</span> title: String,
    <span class="hljs-keyword">val</span> message: String = <span class="hljs-string">"Default Message"</span>, <span class="hljs-comment">// 默认参数</span>
    <span class="hljs-keyword">val</span> okButtonText: String = <span class="hljs-string">"OK"</span>          <span class="hljs-comment">// 默认参数</span>
) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">show</span><span class="hljs-params">()</span></span> { <span class="hljs-comment">/* ... */</span> }
}

</code></pre>
<p>在 Kotlin 中调用时，你可以非常灵活地省略有默认值的参数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> dialog1 = Dialog(<span class="hljs-string">"Warning"</span>) <span class="hljs-comment">// message 和 okButtonText 使用默认值</span>
<span class="hljs-keyword">val</span> dialog2 = Dialog(<span class="hljs-string">"Warning"</span>, <span class="hljs-string">"Custom Message"</span>) <span class="hljs-comment">// 只省略最后一个参数</span>
<span class="hljs-keyword">val</span> dialog3 = Dialog(<span class="hljs-string">"Warning"</span>, <span class="hljs-string">"Custom Message"</span>, <span class="hljs-string">"Confirm"</span>)
</code></pre>
<p>然而，Java 语言本身不支持默认参数。如果上面的 Dialog 类被 Java 代码调用，情况就变得很麻烦：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 代码 - 没有 @JvmOverloads 的情况</span>
<span class="hljs-type">Dialog</span> <span class="hljs-variable">dialog1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dialog</span>(<span class="hljs-string">"Warning"</span>); <span class="hljs-comment">// 编译错误！缺少 message 和 okButtonText 参数</span>

<span class="hljs-comment">// 你必须显式地传入所有参数，即使你想用默认值</span>
<span class="hljs-type">Dialog</span> <span class="hljs-variable">dialog2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dialog</span>(<span class="hljs-string">"Warning"</span>, <span class="hljs-string">"Default Message"</span>, <span class="hljs-string">"OK"</span>);
</code></pre>
<p>为了让 Java 也能方便地调用这些带有默认参数的 Kotlin 函数，@JvmOverloads 注解应运而生。</p>
<h2 data-id="heading-2">@JvmOverloads 的工作原理</h2>
<p>当你在一个 Kotlin 构造函数或函数上添加 @JvmOverloads 注解后，编译器会自动为该函数生成一系列重载版本，每个重载版本依次省略尾部有默认值的参数。</p>
<p>对于上面的例子，我们加上注解：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dialog</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>( <span class="hljs-comment">// 注意注解加在 constructor 关键字前</span>
    <span class="hljs-keyword">val</span> title: String,
    <span class="hljs-keyword">val</span> message: String = <span class="hljs-string">"Default Message"</span>,
    <span class="hljs-keyword">val</span> okButtonText: String = <span class="hljs-string">"OK"</span>
) {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>现在，Kotlin 编译器会为我们生成以下三个构造函数的重载方法（供 Java 调用）：</p>
<ol>
<li>全参数版本：Dialog(String title, String message, String okButtonText)</li>
<li>省略最后一个默认参数：Dialog(String title, String message)</li>
<li>省略最后两个默认参数：Dialog(String title)</li>
</ol>
<p>这样，Java 代码就可以像调用普通 Java 构造函数一样方便地使用了：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 代码 - 有 @JvmOverloads 的情况</span>
<span class="hljs-type">Dialog</span> <span class="hljs-variable">dialog1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dialog</span>(<span class="hljs-string">"Warning"</span>); <span class="hljs-comment">// 完美工作！</span>
<span class="hljs-type">Dialog</span> <span class="hljs-variable">dialog2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dialog</span>(<span class="hljs-string">"Warning"</span>, <span class="hljs-string">"Custom Message"</span>);
<span class="hljs-type">Dialog</span> <span class="hljs-variable">dialog3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dialog</span>(<span class="hljs-string">"Warning"</span>, <span class="hljs-string">"Custom Message"</span>, <span class="hljs-string">"Confirm"</span>);
</code></pre>
<p>对于函数也是同样的道理：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin 函数</span>
<span class="hljs-meta">@JvmOverloads</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showToast</span><span class="hljs-params">(message: <span class="hljs-type">String</span>, length: <span class="hljs-type">Int</span> = Toast.LENGTH_SHORT, gravity: <span class="hljs-type">Int</span> = Gravity.CENTER)</span></span> {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>编译器会生成：</p>
<pre><code class="hljs language-java" lang="java">• showToast(String message)

• showToast(String message, <span class="hljs-type">int</span> length)

• showToast(String message, <span class="hljs-type">int</span> length, <span class="hljs-type">int</span> gravity)
</code></pre>
<h2 data-id="heading-3">语法要点和注意事项</h2>
<ol>
<li>
<p>标注位置：
◦ 对于构造函数：注解要放在 constructor 关键字之前。</p>
<p><code>class MyClass @JvmOverloads constructor(...)</code></p>
<p>◦ 对于成员函数/顶层函数：直接放在 fun 关键字之前。</p>
<p><code>@JvmOverloads fun myFunction(...)</code></p>
</li>
<li>
<p>默认参数必须从右向左连续设置：@JvmOverloads 只能为尾部的、连续的默认参数生成重载。如果中间某个参数有默认值，而它右边的参数没有默认值，则无法为中间这个参数生成重载。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 正确示例：默认值从右向左</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">example</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">String</span> = <span class="hljs-string">"B"</span>, c: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>)</span></span>
<span class="hljs-comment">// 会生成 example(a), example(a, b), example(a, b, c)</span>

<span class="hljs-comment">// 错误示例：默认值不连续</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">badExample</span><span class="hljs-params">(a: <span class="hljs-type">Int</span> = <span class="hljs-number">0</span>, b: <span class="hljs-type">String</span>, c: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>)</span></span>
<span class="hljs-comment">// 只能生成 badExample(a, b, c)，因为 b 没有默认值，打断了连续性。</span>
</code></pre>
</li>
<li>
<p>生成的重载方法会增加方法数：虽然带来了便利，但如果你过度使用（尤其是在有很多默认参数的类中），可能会显著增加类中的方法数量（字节码层面）。在性能敏感的场景需要留意。</p>
</li>
<li>
<p>Kotlin 自身调用不受影响：@JvmOverloads 只是一个给编译器的指令，用于生成 Java 互操作的重载方法。在 Kotlin 代码中，你仍然享受默认参数带来的全部便利，不会生成任何额外的 Kotlin 方法。</p>
</li>
</ol>
<h2 data-id="heading-4">总结</h2>
<h3 data-id="heading-5"><code>@JvmOverloads</code> 使用对比</h3>

























<table><thead><tr><th align="left">场景</th><th align="left">没有 <code>@JvmOverloads</code></th><th align="left">有 <code>@JvmOverloads</code></th></tr></thead><tbody><tr><td align="left"><strong>Kotlin 调用</strong></td><td align="left">可自由省略尾部默认参数</td><td align="left">可自由省略尾部默认参数（无变化）</td></tr><tr><td align="left"><strong>Java 调用</strong></td><td align="left">必须传入所有非默认参数，繁琐</td><td align="left">可以像调用普通 Java 方法一样，优雅地省略尾部参数</td></tr><tr><td align="left"><strong>实现方式</strong></td><td align="left">-</td><td align="left">编译器自动生成一系列重载方法</td></tr></tbody></table>
<p>总而言之，@JvmOverloads 是一个专为提升 Kotlin 与 Java 互操作性而设计的语法糖。它通过自动生成重载方法，让 Java 开发者能够无缝地使用 Kotlin 中那些带有默认参数的函数和构造函数，极大地改善了混合开发项目的体验。 在设计供外部（尤其是 Java）调用的 API 时，它是一个非常值得使用的注解。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高通QCRIL和QMI]]></title>    <link>https://juejin.cn/post/7603355275257102376</link>    <guid>https://juejin.cn/post/7603355275257102376</guid>    <pubDate>2026-02-06T07:00:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603355275257102376" data-draft-id="7603308967125352448" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高通QCRIL和QMI"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T07:00:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高通QCRIL和QMI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:00:59.000Z" title="Fri Feb 06 2026 07:00:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. <strong>什么是 QCRIL？</strong></h3>
<p><strong>QCRIL</strong> = <strong>Qualcomm</strong> <strong>C</strong> <strong>RIL</strong> (高通 C 语言 RIL)</p>
<ul>
<li>QCRIL 是高通为其 Snapdragon 处理器开发的 RIL 实现</li>
<li>是一个原始厂商提供的电话接口库，实现了 Android 的 RIL 接口</li>
<li>负责与高通调制解调器通信，处理电话功能</li>
</ul>
<h3 data-id="heading-1">2. <strong>什么是 QMI？</strong></h3>
<p><strong>QMI</strong> = <strong>Qualcomm Message Interface</strong> (高通消息接口)</p>
<ul>
<li>QMI 是高通定义的通信协议，用于与调制解调器(Modem)通信</li>
<li>是 QCRIL 的底层通信协议</li>
<li>运行在内核中，通过 <code>/dev/qmi</code> 设备进行通信</li>
</ul>
<p><strong>关键特点：</strong></p>
<ul>
<li>基于<strong>消息的通信协议</strong></li>
<li>使用 TLV (Tag-Length-Value) 编码格式</li>
<li>支持多个<strong>服务</strong>(Service)，每个服务负责不同的功能</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. <strong>QCRIL 和 QMI 的关系</strong></h3>
<pre><code class="hljs language-scss" lang="scss">Android Framework (Phone App)
       ↓
RIL Daemon (rild)
       ↓
QCRIL Library (vendor-specific RIL implementation)
       ↓
QMI Protocol (/dev/qmi device)
       ↓
Modem (高通调制解调器)
</code></pre>
<hr/>
<h3 data-id="heading-3">4. <strong>代码示例：QMI 数据连接建立</strong></h3>
<p>从 <code>reference-ril.c</code> 可以看到 QMI 的实际使用：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-number">1916</span>|    fd = open (<span class="hljs-string">"/dev/qmi"</span>, O_RDWR);  <span class="hljs-comment">// 打开QMI设备</span>
<span class="hljs-number">1917</span>|    <span class="hljs-keyword">if</span> (fd &gt;= <span class="hljs-number">0</span>) { <span class="hljs-comment">/* the device doesn't exist on the emulator */</span>
<span class="hljs-number">1918</span>|
<span class="hljs-number">1919</span>|        RLOGD(<span class="hljs-string">"opened the qmi device\n"</span>);
<span class="hljs-number">1920</span>|        asprintf(&amp;cmd, <span class="hljs-string">"up:%s"</span>, apn);  <span class="hljs-comment">// 构造命令：up:APN名称</span>
<span class="hljs-number">1921</span>|        len = <span class="hljs-built_in">strlen</span>(cmd);
<span class="hljs-number">1922</span>|
<span class="hljs-number">1923</span>|        <span class="hljs-keyword">while</span> (cur &lt; len) {
<span class="hljs-number">1924</span>|            <span class="hljs-keyword">do</span> {
<span class="hljs-number">1925</span>|                written = write (fd, cmd + cur, len - cur);  <span class="hljs-comment">// 发送QMI命令给modem</span>
<span class="hljs-number">1926</span>|            } <span class="hljs-keyword">while</span> (written &lt; <span class="hljs-number">0</span> &amp;&amp; errno == EINTR);
<span class="hljs-number">1927</span>|        }
<span class="hljs-number">1928</span>|
<span class="hljs-number">1929</span>|        <span class="hljs-comment">// 等待接口上线</span>
<span class="hljs-number">1930</span>|        <span class="hljs-keyword">do</span> {
<span class="hljs-number">1931</span>|            sleep(<span class="hljs-number">1</span>);
<span class="hljs-number">1932</span>|            <span class="hljs-keyword">do</span> {
<span class="hljs-number">1933</span>|                rlen = read(fd, status, <span class="hljs-number">31</span>);  <span class="hljs-comment">// 读取modem响应</span>
<span class="hljs-number">1934</span>|            } <span class="hljs-keyword">while</span> (rlen &lt; <span class="hljs-number">0</span> &amp;&amp; errno == EINTR);
<span class="hljs-number">1935</span>|        } <span class="hljs-keyword">while</span> (<span class="hljs-built_in">strncmp</span>(status, <span class="hljs-string">"STATE=up"</span>, <span class="hljs-number">8</span>) &amp;&amp; <span class="hljs-built_in">strcmp</span>(status, <span class="hljs-string">"online"</span>) &amp;&amp; --retry);
</code></pre>
<p><strong>数据连接流程：</strong></p>





































<table><thead><tr><th>步骤</th><th>操作</th></tr></thead><tbody><tr><td>1</td><td>RIL 接收 <code>RIL_REQUEST_SETUP_DATA_CALL</code> 请求</td></tr><tr><td>2</td><td>QCRIL 打开 <code>/dev/qmi</code> 设备</td></tr><tr><td>3</td><td>发送 QMI 命令：<code>up:apn_name</code></td></tr><tr><td>4</td><td>Modem 处理 QMI 消息，建立数据连接</td></tr><tr><td>5</td><td>读取 Modem 响应状态 (<code>STATE=up</code> 或 <code>online</code>)</td></tr><tr><td>6</td><td>配置网络接口 (<code>netcfg rmnet0 dhcp</code>)</td></tr><tr><td>7</td><td>返回数据连接结果给 Android Framework</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-4">5. <strong>QMI 服务类型</strong></h3>
<p>QMI 定义了多个服务，用于处理不同类型的请求：</p>








































<table><thead><tr><th>QMI 服务</th><th>功能</th><th>关联的 RIL 请求</th></tr></thead><tbody><tr><td><strong>WDS</strong> (Wireless Data Service)</td><td>数据连接、分组数据</td><td><code>SETUP_DATA_CALL</code>, <code>DEACTIVATE_DATA_CALL</code></td></tr><tr><td><strong>NAS</strong> (Network Access Service)</td><td>网络注册、信号强度、服务状态</td><td><code>VOICE_REGISTRATION_STATE</code>, <code>DATA_REGISTRATION_STATE</code></td></tr><tr><td><strong>QMI_CTL</strong></td><td>QMI 控制和初始化</td><td>基础初始化</td></tr><tr><td><strong>SMS</strong></td><td>短信服务</td><td><code>SEND_SMS</code>, <code>RECEIVE_SMS</code></td></tr><tr><td><strong>DMS</strong> (Device Management Service)</td><td>设备管理</td><td>获取 IMEI、IMSI 等</td></tr><tr><td><strong>UIM</strong> (USIM Interface)</td><td>SIM 卡管理</td><td><code>SIM_IO</code>, <code>GET_SIM_STATUS</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">6. <strong>RIL 请求处理流程</strong></h3>
<p>以 <code>RIL_REQUEST_SETUP_DATA_CALL</code> 为例：</p>
<pre><code class="hljs language-bash" lang="bash">Java 层 (ConnectivityManager)
   ↓
RIL.java (java/com/android/internal/telephony/)
   ↓
radio::setupDataCallResponse (ril_service.cpp)
   ↓
QCRIL (vendor library)
   ↓
QMI WDS Service (Write to /dev/qmi)
   ↓
Modem (执行数据连接)
   ↓
QMI WDS Response (Read from /dev/qmi)
   ↓
RIL_onRequestComplete() 回调
   ↓
Java 层获得结果，更新网络状态
</code></pre>
<hr/>
<h3 data-id="heading-6">7. <strong>实际的 RIL 请求处理</strong></h3>
<p>从 <code>ril_service.cpp</code> 看数据调用请求：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Return&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">RadioImpl::setupDataCall</span><span class="hljs-params">(
    <span class="hljs-type">int32_t</span> serial, 
    RadioTechnology radioTechnology,
    <span class="hljs-type">const</span> DataProfileInfo&amp; dataProfileInfo, 
    <span class="hljs-type">bool</span> modemCognitive,
    <span class="hljs-type">bool</span> roamingAllowed, 
    <span class="hljs-type">bool</span> isRoaming)</span> </span>{
    
    <span class="hljs-comment">// 构造 RIL_REQUEST_SETUP_DATA_CALL 请求参数</span>
    <span class="hljs-built_in">dispatchStrings</span>(serial, mSlotId, RIL_REQUEST_SETUP_DATA_CALL, <span class="hljs-literal">true</span>, <span class="hljs-number">15</span>,
        std::<span class="hljs-built_in">to_string</span>((<span class="hljs-type">int</span>) radioTechnology + <span class="hljs-number">2</span>).<span class="hljs-built_in">c_str</span>(),
        std::<span class="hljs-built_in">to_string</span>((<span class="hljs-type">int</span>) dataProfileInfo.profileId).<span class="hljs-built_in">c_str</span>(),
        dataProfileInfo.apn.<span class="hljs-built_in">c_str</span>(),           <span class="hljs-comment">// APN 名称</span>
        dataProfileInfo.user.<span class="hljs-built_in">c_str</span>(),          <span class="hljs-comment">// 用户名</span>
        dataProfileInfo.password.<span class="hljs-built_in">c_str</span>(),      <span class="hljs-comment">// 密码</span>
        std::<span class="hljs-built_in">to_string</span>((<span class="hljs-type">int</span>) dataProfileInfo.authType).<span class="hljs-built_in">c_str</span>(),
        dataProfileInfo.protocol.<span class="hljs-built_in">c_str</span>(),      <span class="hljs-comment">// IP/IPv6/IPV4V6</span>
        <span class="hljs-comment">// ... 更多参数</span>
    );
}
</code></pre>
<hr/>
<h3 data-id="heading-7">8. <strong>QCRIL 的优势</strong></h3>

























<table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td><strong>高性能</strong></td><td>针对高通 Modem 优化</td></tr><tr><td><strong>功能完整</strong></td><td>支持所有高通 Modem 特性</td></tr><tr><td><strong>稳定性</strong></td><td>经过严格测试</td></tr><tr><td><strong>低延迟</strong></td><td>直接通过 QMI 协议与 Modem 通信</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">9. <strong>关键文件位置</strong></h3>

























<table><thead><tr><th>文件</th><th>功能</th></tr></thead><tbody><tr><td><code>hardware_ril/reference-ril/reference-ril.c</code></td><td>参考 RIL 实现</td></tr><tr><td><code>hardware_ril/libril/ril.cpp</code></td><td>RIL 核心库</td></tr><tr><td><code>hardware_ril/libril/ril_service.cpp</code></td><td>RIL HAL 服务适配</td></tr><tr><td><code>hardware_ril/include/telephony/ril.h</code></td><td>RIL 接口定义</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-9">10. <strong>总结</strong></h3>
<ul>
<li><strong>QCRIL</strong> 是高通实现的 RIL，遵循 Android 的 RIL 接口规范</li>
<li><strong>QMI</strong> 是 QCRIL 与 Modem 通信的底层协议</li>
<li>QMI 通过 <code>/dev/qmi</code> 设备驱动与内核交互</li>
<li>所有电话功能（通话、短信、数据等）都通过 QMI 消息在 QCRIL 和 Modem 之间传输</li>
<li>QCRIL + QMI 构成了 Android 系统与高通 Modem 通信的桥梁</li>
</ul>
<p>这个架构确保了 Android 系统与不同厂商 Modem 的兼容性，同时为厂商提供了优化其硬件的机会。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mybatis]]></title>    <link>https://juejin.cn/post/7603301285475647530</link>    <guid>https://juejin.cn/post/7603301285475647530</guid>    <pubDate>2026-02-06T07:04:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603301285475647530" data-draft-id="7603352061505765382" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mybatis"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T07:04:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悦悦妍妍"/> <meta itemprop="url" content="https://juejin.cn/user/3395772841729421"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mybatis
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3395772841729421/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悦悦妍妍
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:04:44.000Z" title="Fri Feb 06 2026 07:04:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">准备工作</h3>
<ul>
<li>
<p>相关maven依赖
<code>Lombok</code> <code>Spring Web</code>  <code>MyBatis Framework</code>  <code>MySQL Driver</code></p>
</li>
<li>
<p>application.properties 配置数据源</p>
</li>
</ul>
<pre><code class="hljs language-java" lang="java">spring.datasource.url=jdbc:mysql:<span class="hljs-comment">//localhost:3306/myapp_db</span>
spring.datasource.username=xxx
spring.datasource.password=xxx
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver


# resources目录下新建mapper目录 
mybatis.mapper-locations=classpath:mapper<span class="hljs-comment">/**.xml
# 数据库表列明 中横线转 表实体bean对应的小驼峰
mybatis.configuration.map-underscore-to-camel-case=true
# 开启sql日志
logging.level.org.example.mybatis.mapper=debug
</span></code></pre>
<ul>
<li>idea安装<code>mybatisx</code>插件, 按键自动生成Mapper接口对应的xml实现</li>
</ul>
<h3 data-id="heading-1">取值</h3>
<p><code>#{}</code><strong>安全</strong>的参数预编译<br/>
<code>${}</code>是<strong>直接</strong>的字符串拼接。</p>






























<table><thead><tr><th>特性</th><th><code>#{}</code> (井号占位符)</th><th><code>${}</code> (美元占位符)</th></tr></thead><tbody><tr><td><strong>处理方式</strong></td><td><strong>预编译（PreparedStatement）</strong> ，参数化查询</td><td><strong>字符串拼接（Statement）</strong> ，直接替换</td></tr><tr><td><strong>安全性</strong></td><td><strong>高</strong>，有效防止SQL注入</td><td><strong>低</strong>，存在SQL注入风险</td></tr><tr><td><strong>参数类型</strong></td><td>任意类型，自动进行类型转换和转义</td><td>通常为<strong>字符串</strong>，原样替换，不转义</td></tr><tr><td><strong>使用场景</strong></td><td><strong>几乎所有的值传递</strong>（WHERE条件值、INSERT值等）</td><td><strong>动态SQL片段</strong>（表名、列名、ORDER BY等）</td></tr></tbody></table>
<h4 data-id="heading-2">取入参值</h4>
<ul>
<li>当只有一个参数时，直接放变量名(xml中的变量名可以随便命名) 或 bean中属性, 这时可以不用<code>@Param</code>；若用了<code>@Param</code>，xml中的变量名必须和<code>@Param</code>内的命名保持一致，不能直接取bean中属性，需要<code>@Param</code>内的命名.属性名</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> {

    User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(String id)</span>;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertUser</span><span class="hljs-params">(User user)</span>;

}

&lt;select id=<span class="hljs-string">"getUserById"</span> resultType=<span class="hljs-string">"org.example.mybatis.entity.User"</span>&gt;
    select * from users <span class="hljs-type">where</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> #{id}
&lt;/select&gt;

&lt;!-- username  email 为 User 中的属性 --&gt;
&lt;insert id=<span class="hljs-string">"insertUser"</span>&gt;
    insert into <span class="hljs-title function_">users</span><span class="hljs-params">(username, email)</span>values (#{username}, #{email})
&lt;/insert&gt;
</code></pre>
<ul>
<li>多个参数用<code>@Param</code></li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@Param("id")</span> String id, <span class="hljs-meta">@Param("us")</span> User user)</span>;

&lt;update id=<span class="hljs-string">"updateUser"</span>&gt;
    update users
    <span class="hljs-type">set</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> #{us.username},
        email    = #{us.email}
    <span class="hljs-type">where</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> #{id}
&lt;/update&gt;
</code></pre>
<p><code>最佳实践</code>：为了统一化取参，即使一个参数也使用<code>@Param</code></p>
<h3 data-id="heading-3">返回值处理</h3>
<h4 data-id="heading-4">返回普通数据 <code>resultType</code></h4>
<ul>
<li>返回基本类型、String、Long、普通javeBean都只需要在 <code>resultType</code>中声明返回值的全限定类名</li>
<li>mybatis.configuration.map-underscore-to-camel-case=true <code>开启驼峰映射</code>：表中查询结果集中<code>a_column</code>列会自动被映射为bean中的<code>aColumn</code>属性</li>
</ul>
<h4 data-id="heading-5">自定义映射结果集 <code>resultMap</code></h4>
<p>当表中结果和javabean属性不能映射（字段名不对应，即使开启驼峰映射也不行），这时需要使用自定义映射</p>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-comment">&lt;!-- 当结果表能主动映射bean中属性时，可以不用在resultMap中声明 id自定义的结果映射唯一名 type-接受结果bean的全类名 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"UserRm"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"org.example.mybatis.entity.User"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- id标签-主键 result标签-其他普通列 column-结果表的列名 property-bean的属性名 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"user_phone"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"phone"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getUserByIdRm"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"UserRm"</span>&gt;</span>
    select * from users;
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[THREE.js 摄像机]]></title>    <link>https://juejin.cn/post/7603383059150831658</link>    <guid>https://juejin.cn/post/7603383059150831658</guid>    <pubDate>2026-02-06T07:04:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603383059150831658" data-draft-id="7603389033040986166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="THREE.js 摄像机"/> <meta itemprop="keywords" content="前端,JavaScript,three.js"/> <meta itemprop="datePublished" content="2026-02-06T07:04:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="龙猫不热"/> <meta itemprop="url" content="https://juejin.cn/user/4098608612778654"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            THREE.js 摄像机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4098608612778654/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    龙猫不热
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:04:29.000Z" title="Fri Feb 06 2026 07:04:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前置代码</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">html</span>,
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    }

    <span class="hljs-selector-id">#c</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">display</span>: block;
    }

    <span class="hljs-selector-class">.split</span> {
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">display</span>: flex;
    }

    <span class="hljs-selector-class">.split</span>&gt;<span class="hljs-selector-tag">div</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"c"</span>&gt;</span>

  <span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"split"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"view1"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"view2"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"importmap"</span>&gt;</span><span class="javascript">
    {
        <span class="hljs-string">"imports"</span>: {
            <span class="hljs-string">"three"</span>: <span class="hljs-string">"https://esm.sh/three@0.174.0/build/three.module.js"</span>,
            <span class="hljs-string">"three/addons/"</span>: <span class="hljs-string">"https://cdn.jsdelivr.net/npm/three@0.174.0/examples/jsm/"</span>
        }   
    }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./index.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-1">透视摄像机<a href="https://link.juejin.cn?target=https%3A%2F%2Fthreejs.org%2Fdocs%2F%23api%2Fzh%2Fcameras%2FPerspectiveCamera" target="_blank" title="https://threejs.org/docs/#api/zh/cameras/PerspectiveCamera" ref="nofollow noopener noreferrer"><code>PerspectiveCamera</code></a></h2>
<p><code>PerspectiveCamera</code> 通过四个属性来定义一个视锥, <code>near</code>定义视锥前端, <code>far</code>定义远端, <code>fov</code>是视野, 通过计算正确的高度来从摄像机的位置获取指定的以<code>near</code>为单位的视野, 定义的是视锥的前端和远端的高度
<code>aspect</code>间接地定义了视锥前端和远端的宽度, 实际上视锥的宽度是通过高度乘以 <code>aspect</code> 来得到的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3376eb777f44248f74c7156e361b04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z54yr5LiN54Ot:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966269&amp;x-signature=Z0C%2FbuZ7LRjOsGGt7cqkoZHG38s%3D" alt="" loading="lazy"/></p>
<p>下面这个例子我们使用 three 的<a href="https://link.juejin.cn?target=https%3A%2F%2Fthreejs.org%2Fdocs%2Findex.html%3Fq%3Dwebgl%23WebGLRenderer.setScissor" target="_blank" title="https://threejs.org/docs/index.html?q=webgl#WebGLRenderer.setScissor" ref="nofollow noopener noreferrer">剪函数</a>, 把视图分成两部分, 主视图正常渲染, 辅视图用来观察 <code>cameraHelper</code> 的渲染</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"three"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/addons/controls/OrbitControls.js"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">GUI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/addons/libs/lil-gui.module.min.js"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#c"</span>);
  <span class="hljs-keyword">const</span> view1Elem = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#view1"</span>);
  <span class="hljs-keyword">const</span> view2Elem = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#view2"</span>);

  <span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span>, canvas });

  <span class="hljs-comment">// #region 左视图的相机</span>
  <span class="hljs-keyword">const</span> fov = <span class="hljs-number">45</span>;
  <span class="hljs-keyword">const</span> aspect = <span class="hljs-number">2</span>; <span class="hljs-comment">// the canvas default</span>
  <span class="hljs-keyword">const</span> near = <span class="hljs-number">0.1</span>;
  <span class="hljs-keyword">const</span> far = <span class="hljs-number">100</span>;
  <span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(fov, aspect, near, far);
  camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>);

  <span class="hljs-keyword">const</span> cameraHelper = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">CameraHelper</span>(camera);

  <span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, view1Elem);
  controls.<span class="hljs-property">target</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>);
  controls.<span class="hljs-title function_">update</span>();

  <span class="hljs-comment">// #endregion</span>

  <span class="hljs-comment">// #region 右视图的相机</span>
  <span class="hljs-keyword">const</span> camera2 = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(
    <span class="hljs-number">60</span>, <span class="hljs-comment">// fov</span>
    <span class="hljs-number">2</span>, <span class="hljs-comment">// aspect</span>
    <span class="hljs-number">0.1</span>, <span class="hljs-comment">// near</span>
    <span class="hljs-number">500</span>, <span class="hljs-comment">// far</span>
  );
  camera2.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">40</span>, <span class="hljs-number">10</span>, <span class="hljs-number">30</span>);
  camera2.<span class="hljs-title function_">lookAt</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> controls2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera2, view2Elem);
  controls2.<span class="hljs-property">target</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>);
  controls2.<span class="hljs-title function_">update</span>();

  <span class="hljs-comment">// #endregion</span>

  <span class="hljs-comment">/**
   * 设置裁剪区域和视口, 返回宽高比
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">elem</span>
   * <span class="hljs-doctag">@returns</span>
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">setScissorForElement</span>(<span class="hljs-params">elem</span>) {
    <span class="hljs-comment">// 获取 canvas 与元素的边界矩形</span>
    <span class="hljs-keyword">const</span> canvasRect = canvas.<span class="hljs-title function_">getBoundingClientRect</span>();
    <span class="hljs-keyword">const</span> elemRect = elem.<span class="hljs-title function_">getBoundingClientRect</span>();

    <span class="hljs-comment">// 相对位置计算元素在 canvas 内的左右上下边界</span>
    <span class="hljs-keyword">const</span> right = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(elemRect.<span class="hljs-property">right</span>, canvasRect.<span class="hljs-property">right</span>) - canvasRect.<span class="hljs-property">left</span>;
    <span class="hljs-keyword">const</span> left = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, elemRect.<span class="hljs-property">left</span> - canvasRect.<span class="hljs-property">left</span>);
    <span class="hljs-keyword">const</span> bottom = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(elemRect.<span class="hljs-property">bottom</span>, canvasRect.<span class="hljs-property">bottom</span>) - canvasRect.<span class="hljs-property">top</span>;
    <span class="hljs-keyword">const</span> top = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, elemRect.<span class="hljs-property">top</span> - canvasRect.<span class="hljs-property">top</span>);

    <span class="hljs-keyword">const</span> width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(canvasRect.<span class="hljs-property">width</span>, right - left);
    <span class="hljs-keyword">const</span> height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(canvasRect.<span class="hljs-property">height</span>, bottom - top);

    <span class="hljs-comment">// 设置裁剪</span>
    <span class="hljs-keyword">const</span> positiveYUpBottom = canvasRect.<span class="hljs-property">height</span> - bottom;

    <span class="hljs-comment">// 对 renderer 设置裁剪区域和视口</span>
    renderer.<span class="hljs-title function_">setScissor</span>(left, positiveYUpBottom, width, height);
    renderer.<span class="hljs-title function_">setViewport</span>(left, positiveYUpBottom, width, height);

    <span class="hljs-keyword">return</span> width / height;
  }

  <span class="hljs-comment">// gui 使用,限制对象中属性的最大值最小值</span>
  <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinMaxGUIHelper</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">obj, minProp, maxProp, minDif</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span> = obj;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">minProp</span> = minProp;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span> = maxProp;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">minDif</span> = minDif;
    }
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">min</span>() {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">minProp</span>];
    }
    <span class="hljs-keyword">set</span> <span class="hljs-title function_">min</span>(<span class="hljs-params">v</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">minProp</span>] = v;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>], v + <span class="hljs-variable language_">this</span>.<span class="hljs-property">minDif</span>);
    }
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">max</span>() {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>];
    }
    <span class="hljs-keyword">set</span> <span class="hljs-title function_">max</span>(<span class="hljs-params">v</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>] = v;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">min</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">min</span>; <span class="hljs-comment">// this will call the min setter</span>
    }
  }

  <span class="hljs-comment">// #region 添加相机属性的gui界面</span>
  <span class="hljs-keyword">const</span> gui = <span class="hljs-keyword">new</span> <span class="hljs-title function_">GUI</span>();
  gui.<span class="hljs-title function_">add</span>(camera, <span class="hljs-string">"fov"</span>, <span class="hljs-number">1</span>, <span class="hljs-number">180</span>);
  <span class="hljs-keyword">const</span> minMaxGUIHelper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MinMaxGUIHelper</span>(camera, <span class="hljs-string">"near"</span>, <span class="hljs-string">"far"</span>, <span class="hljs-number">0.1</span>);
  gui.<span class="hljs-title function_">add</span>(minMaxGUIHelper, <span class="hljs-string">"min"</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0.1</span>).<span class="hljs-title function_">name</span>(<span class="hljs-string">"near"</span>);
  gui.<span class="hljs-title function_">add</span>(minMaxGUIHelper, <span class="hljs-string">"max"</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0.1</span>).<span class="hljs-title function_">name</span>(<span class="hljs-string">"far"</span>);

  <span class="hljs-comment">// #endregion</span>

  <span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
  scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-string">"black"</span>);
  scene.<span class="hljs-title function_">add</span>(cameraHelper);

  {
    <span class="hljs-keyword">const</span> planeSize = <span class="hljs-number">40</span>;

    <span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">TextureLoader</span>();
    <span class="hljs-keyword">const</span> texture = loader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"https://threejs.org/manual/examples/resources/images/checker.png"</span>);
    texture.<span class="hljs-property">wrapS</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">RepeatWrapping</span>;
    texture.<span class="hljs-property">wrapT</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">RepeatWrapping</span>;
    texture.<span class="hljs-property">magFilter</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">NearestFilter</span>;
    <span class="hljs-comment">//texture.colorSpace = THREE.SRGBColorSpace;</span>
    <span class="hljs-keyword">const</span> repeats = planeSize / <span class="hljs-number">2</span>;
    texture.<span class="hljs-property">repeat</span>.<span class="hljs-title function_">set</span>(repeats, repeats);

    <span class="hljs-keyword">const</span> planeGeo = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneGeometry</span>(planeSize, planeSize);
    <span class="hljs-keyword">const</span> planeMat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({
      <span class="hljs-attr">map</span>: texture,
      <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">DoubleSide</span>,
    });
    <span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(planeGeo, planeMat);
    mesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * -<span class="hljs-number">0.5</span>;
    scene.<span class="hljs-title function_">add</span>(mesh);
  }

  {
    <span class="hljs-keyword">const</span> cubeSize = <span class="hljs-number">4</span>;
    <span class="hljs-keyword">const</span> cubeGeo = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(cubeSize, cubeSize, cubeSize);
    <span class="hljs-keyword">const</span> cubeMat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-string">"#8AC"</span> });
    <span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(cubeGeo, cubeMat);
    mesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(cubeSize + <span class="hljs-number">1</span>, cubeSize / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);
    scene.<span class="hljs-title function_">add</span>(mesh);
  }

  {
    <span class="hljs-keyword">const</span> sphereRadius = <span class="hljs-number">3</span>;
    <span class="hljs-keyword">const</span> sphereWidthDivisions = <span class="hljs-number">32</span>;
    <span class="hljs-keyword">const</span> sphereHeightDivisions = <span class="hljs-number">16</span>;
    <span class="hljs-keyword">const</span> sphereGeo = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(
      sphereRadius,
      sphereWidthDivisions,
      sphereHeightDivisions,
    );
    <span class="hljs-keyword">const</span> sphereMat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-string">"#CA8"</span> });
    <span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(sphereGeo, sphereMat);
    mesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(-sphereRadius - <span class="hljs-number">1</span>, sphereRadius + <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);
    scene.<span class="hljs-title function_">add</span>(mesh);
  }

  {
    <span class="hljs-keyword">const</span> color = <span class="hljs-number">0xffffff</span>;
    <span class="hljs-keyword">const</span> intensity = <span class="hljs-number">3</span>;
    <span class="hljs-keyword">const</span> light = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(color, intensity);
    light.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>);
    light.<span class="hljs-property">target</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(-<span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    scene.<span class="hljs-title function_">add</span>(light);
    scene.<span class="hljs-title function_">add</span>(light.<span class="hljs-property">target</span>);
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">resizeRendererToDisplaySize</span>(<span class="hljs-params">renderer</span>) {
    <span class="hljs-keyword">const</span> canvas = renderer.<span class="hljs-property">domElement</span>;
    <span class="hljs-keyword">const</span> width = canvas.<span class="hljs-property">clientWidth</span>;
    <span class="hljs-keyword">const</span> height = canvas.<span class="hljs-property">clientHeight</span>;
    <span class="hljs-keyword">const</span> needResize = canvas.<span class="hljs-property">width</span> !== width || canvas.<span class="hljs-property">height</span> !== height;
    <span class="hljs-keyword">if</span> (needResize) {
      renderer.<span class="hljs-title function_">setSize</span>(width, height, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-keyword">return</span> needResize;
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">resizeRendererToDisplaySize</span>(renderer);

    <span class="hljs-comment">// 启用剪刀函数</span>
    renderer.<span class="hljs-title function_">setScissorTest</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-comment">// #region 视图1 渲染</span>
    <span class="hljs-keyword">const</span> aspect1 = <span class="hljs-title function_">setScissorForElement</span>(view1Elem);
    camera.<span class="hljs-property">aspect</span> = aspect1;
    camera.<span class="hljs-title function_">updateProjectionMatrix</span>();
    <span class="hljs-comment">// 不在视图 1中渲染 helper</span>
    cameraHelper.<span class="hljs-property">visible</span> = <span class="hljs-literal">false</span>;
    cameraHelper.<span class="hljs-title function_">update</span>();
    renderer.<span class="hljs-title function_">render</span>(scene, camera);
    <span class="hljs-comment">// #endregion</span>

    <span class="hljs-comment">// #region 视图2 渲染</span>
    <span class="hljs-keyword">const</span> aspect2 = <span class="hljs-title function_">setScissorForElement</span>(view2Elem);
    camera2.<span class="hljs-property">aspect</span> = aspect2;
    camera2.<span class="hljs-title function_">updateProjectionMatrix</span>();
    <span class="hljs-comment">// 在第二台摄像机中绘制cameraHelper</span>
    cameraHelper.<span class="hljs-property">visible</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// 单独给视图 2 设置个背景色</span>
    scene.<span class="hljs-property">background</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0x000040</span>);
    renderer.<span class="hljs-title function_">render</span>(scene, camera2);

    <span class="hljs-comment">// #endregion</span>

    <span class="hljs-title function_">requestAnimationFrame</span>(render);
  }

  <span class="hljs-title function_">requestAnimationFrame</span>(render);
}

<span class="hljs-title function_">main</span>();

</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b62f61666694aaeb584fe439b0173ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z54yr5LiN54Ot:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966269&amp;x-signature=EaB0ieVWLNQ7Ajz6Zkt0DF5irXo%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">正交摄像机<a href="https://link.juejin.cn?target=https%3A%2F%2Fthreejs.org%2Fdocs%2F%23api%2Fzh%2Fcameras%2FOrthographicCamera" target="_blank" title="https://threejs.org/docs/#api/zh/cameras/OrthographicCamera" ref="nofollow noopener noreferrer"><code>OrthographicCamera</code></a></h2>
<p>与透视摄像机不同的是, 它需要设置<code>left</code> <code>right</code> <code>top</code> <code>bottom</code> <code>near</code> 和 <code>far</code> 指定一个长方形, 使得视野是平行的而不是透视的</p>
<p>使用 <code>zoom</code> 属性可以缩放<code>世界 -&gt; 屏幕</code>的映射比例, 不改变实际尺寸</p>
<p><code>&lt; 1</code> 看到更多
<code>&gt; 1</code> 看到更少</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"three"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/addons/controls/OrbitControls.js"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">GUI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/addons/libs/lil-gui.module.min.js"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#c"</span>);
  <span class="hljs-keyword">const</span> view1Elem = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#view1"</span>);
  <span class="hljs-keyword">const</span> view2Elem = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#view2"</span>);

  <span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({
    <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span>,
    canvas,
    <span class="hljs-attr">logarithmicDepthBuffer</span>: <span class="hljs-literal">true</span>,
  });

  <span class="hljs-comment">// #region 左视图的相机</span>
  <span class="hljs-keyword">const</span> size = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">const</span> near = <span class="hljs-number">5</span>;
  <span class="hljs-keyword">const</span> far = <span class="hljs-number">50</span>;
  <span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">OrthographicCamera</span>(-size, size, size, -size, near, far);
  camera.<span class="hljs-property">zoom</span> = <span class="hljs-number">0.2</span>;
  camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>, <span class="hljs-number">0</span>);
  <span class="hljs-comment">// camera.lookAt(0, 0, 0);</span>
  <span class="hljs-keyword">const</span> cameraHelper = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">CameraHelper</span>(camera);

  <span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, view1Elem);
  controls.<span class="hljs-property">target</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
  controls.<span class="hljs-title function_">update</span>();

  <span class="hljs-comment">// #endregion</span>

  <span class="hljs-comment">// #region 右视图的相机</span>
  <span class="hljs-keyword">const</span> camera2 = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(
    <span class="hljs-number">60</span>, <span class="hljs-comment">// fov</span>
    <span class="hljs-number">2</span>, <span class="hljs-comment">// aspect</span>
    <span class="hljs-number">0.1</span>, <span class="hljs-comment">// near</span>
    <span class="hljs-number">500</span>, <span class="hljs-comment">// far</span>
  );
  camera2.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">40</span>, <span class="hljs-number">10</span>, <span class="hljs-number">30</span>);
  camera2.<span class="hljs-title function_">lookAt</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> controls2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera2, view2Elem);
  controls2.<span class="hljs-property">target</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>);
  controls2.<span class="hljs-title function_">update</span>();

  <span class="hljs-comment">// #endregion</span>

  <span class="hljs-comment">/**
   * 设置裁剪区域和视口, 返回宽高比
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">elem</span>
   * <span class="hljs-doctag">@returns</span>
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">setScissorForElement</span>(<span class="hljs-params">elem</span>) {
    <span class="hljs-comment">// 获取 canvas 与元素的边界矩形</span>
    <span class="hljs-keyword">const</span> canvasRect = canvas.<span class="hljs-title function_">getBoundingClientRect</span>();
    <span class="hljs-keyword">const</span> elemRect = elem.<span class="hljs-title function_">getBoundingClientRect</span>();

    <span class="hljs-comment">// 相对位置计算元素在 canvas 内的左右上下边界</span>
    <span class="hljs-keyword">const</span> right = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(elemRect.<span class="hljs-property">right</span>, canvasRect.<span class="hljs-property">right</span>) - canvasRect.<span class="hljs-property">left</span>;
    <span class="hljs-keyword">const</span> left = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, elemRect.<span class="hljs-property">left</span> - canvasRect.<span class="hljs-property">left</span>);
    <span class="hljs-keyword">const</span> bottom = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(elemRect.<span class="hljs-property">bottom</span>, canvasRect.<span class="hljs-property">bottom</span>) - canvasRect.<span class="hljs-property">top</span>;
    <span class="hljs-keyword">const</span> top = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, elemRect.<span class="hljs-property">top</span> - canvasRect.<span class="hljs-property">top</span>);

    <span class="hljs-keyword">const</span> width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(canvasRect.<span class="hljs-property">width</span>, right - left);
    <span class="hljs-keyword">const</span> height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(canvasRect.<span class="hljs-property">height</span>, bottom - top);

    <span class="hljs-comment">// 设置裁剪</span>
    <span class="hljs-keyword">const</span> positiveYUpBottom = canvasRect.<span class="hljs-property">height</span> - bottom;

    <span class="hljs-comment">// 对 renderer 设置裁剪区域和视口</span>
    renderer.<span class="hljs-title function_">setScissor</span>(left, positiveYUpBottom, width, height);
    renderer.<span class="hljs-title function_">setViewport</span>(left, positiveYUpBottom, width, height);

    <span class="hljs-keyword">return</span> width / height;
  }

  <span class="hljs-comment">// gui 使用,限制对象中属性的最大值最小值</span>
  <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinMaxGUIHelper</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">obj, minProp, maxProp, minDif</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span> = obj;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">minProp</span> = minProp;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span> = maxProp;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">minDif</span> = minDif;
    }
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">min</span>() {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">minProp</span>];
    }
    <span class="hljs-keyword">set</span> <span class="hljs-title function_">min</span>(<span class="hljs-params">v</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">minProp</span>] = v;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>], v + <span class="hljs-variable language_">this</span>.<span class="hljs-property">minDif</span>);
    }
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">max</span>() {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>];
    }
    <span class="hljs-keyword">set</span> <span class="hljs-title function_">max</span>(<span class="hljs-params">v</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>] = v;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">min</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">min</span>; <span class="hljs-comment">// this will call the min setter</span>
    }
  }

  <span class="hljs-comment">// #region 添加相机属性的gui界面</span>
  <span class="hljs-keyword">const</span> gui = <span class="hljs-keyword">new</span> <span class="hljs-title function_">GUI</span>();
  <span class="hljs-comment">// gui.add(camera, "fov", 1, 180);</span>
  <span class="hljs-keyword">const</span> minMaxGUIHelper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MinMaxGUIHelper</span>(camera, <span class="hljs-string">"near"</span>, <span class="hljs-string">"far"</span>, <span class="hljs-number">0.1</span>);
  gui.<span class="hljs-title function_">add</span>(minMaxGUIHelper, <span class="hljs-string">"min"</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0.1</span>).<span class="hljs-title function_">name</span>(<span class="hljs-string">"near"</span>);
  gui.<span class="hljs-title function_">add</span>(minMaxGUIHelper, <span class="hljs-string">"max"</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0.1</span>).<span class="hljs-title function_">name</span>(<span class="hljs-string">"far"</span>);
  gui.<span class="hljs-title function_">add</span>(camera, <span class="hljs-string">"zoom"</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">1</span>).<span class="hljs-title function_">name</span>(<span class="hljs-string">"zoom"</span>).<span class="hljs-title function_">listen</span>(); <span class="hljs-comment">// 调整相机展现多少单位大小</span>

  <span class="hljs-comment">// #endregion</span>

  <span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
  scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-string">"black"</span>);
  scene.<span class="hljs-title function_">add</span>(cameraHelper);

  {
    <span class="hljs-keyword">const</span> planeSize = <span class="hljs-number">40</span>;

    <span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">TextureLoader</span>();
    <span class="hljs-keyword">const</span> texture = loader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"https://threejs.org/manual/examples/resources/images/checker.png"</span>);
    texture.<span class="hljs-property">wrapS</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">RepeatWrapping</span>;
    texture.<span class="hljs-property">wrapT</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">RepeatWrapping</span>;
    texture.<span class="hljs-property">magFilter</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">NearestFilter</span>;
    <span class="hljs-comment">//texture.colorSpace = THREE.SRGBColorSpace;</span>
    <span class="hljs-keyword">const</span> repeats = planeSize / <span class="hljs-number">2</span>;
    texture.<span class="hljs-property">repeat</span>.<span class="hljs-title function_">set</span>(repeats, repeats);

    <span class="hljs-keyword">const</span> planeGeo = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneGeometry</span>(planeSize, planeSize);
    <span class="hljs-keyword">const</span> planeMat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({
      <span class="hljs-attr">map</span>: texture,
      <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">DoubleSide</span>,
    });
    <span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(planeGeo, planeMat);
    mesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * -<span class="hljs-number">0.5</span>;
    scene.<span class="hljs-title function_">add</span>(mesh);
  }

  {
    <span class="hljs-keyword">const</span> cubeSize = <span class="hljs-number">4</span>;
    <span class="hljs-keyword">const</span> cubeGeo = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(cubeSize, cubeSize, cubeSize);
    <span class="hljs-keyword">const</span> cubeMat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-string">"#8AC"</span> });
    <span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(cubeGeo, cubeMat);
    mesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(cubeSize + <span class="hljs-number">1</span>, cubeSize / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);
    scene.<span class="hljs-title function_">add</span>(mesh);
  }

  {
    <span class="hljs-keyword">const</span> sphereRadius = <span class="hljs-number">3</span>;
    <span class="hljs-keyword">const</span> sphereWidthDivisions = <span class="hljs-number">32</span>;
    <span class="hljs-keyword">const</span> sphereHeightDivisions = <span class="hljs-number">16</span>;
    <span class="hljs-keyword">const</span> sphereGeo = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(
      sphereRadius,
      sphereWidthDivisions,
      sphereHeightDivisions,
    );
    <span class="hljs-keyword">const</span> sphereMat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-string">"#CA8"</span> });
    <span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(sphereGeo, sphereMat);
    mesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(-sphereRadius - <span class="hljs-number">1</span>, sphereRadius + <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);
    scene.<span class="hljs-title function_">add</span>(mesh);
  }

  {
    <span class="hljs-keyword">const</span> color = <span class="hljs-number">0xffffff</span>;
    <span class="hljs-keyword">const</span> intensity = <span class="hljs-number">3</span>;
    <span class="hljs-keyword">const</span> light = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(color, intensity);
    light.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>);
    light.<span class="hljs-property">target</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(-<span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    scene.<span class="hljs-title function_">add</span>(light);
    scene.<span class="hljs-title function_">add</span>(light.<span class="hljs-property">target</span>);
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">resizeRendererToDisplaySize</span>(<span class="hljs-params">renderer</span>) {
    <span class="hljs-keyword">const</span> canvas = renderer.<span class="hljs-property">domElement</span>;
    <span class="hljs-keyword">const</span> width = canvas.<span class="hljs-property">clientWidth</span>;
    <span class="hljs-keyword">const</span> height = canvas.<span class="hljs-property">clientHeight</span>;
    <span class="hljs-keyword">const</span> needResize = canvas.<span class="hljs-property">width</span> !== width || canvas.<span class="hljs-property">height</span> !== height;
    <span class="hljs-keyword">if</span> (needResize) {
      renderer.<span class="hljs-title function_">setSize</span>(width, height, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-keyword">return</span> needResize;
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">resizeRendererToDisplaySize</span>(renderer);

    <span class="hljs-comment">// 启用剪刀函数</span>
    renderer.<span class="hljs-title function_">setScissorTest</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-comment">// #region 视图1 渲染</span>
    <span class="hljs-keyword">const</span> aspect1 = <span class="hljs-title function_">setScissorForElement</span>(view1Elem);
    camera.<span class="hljs-property">left</span> = -aspect1;
    camera.<span class="hljs-property">right</span> = aspect1;
    camera.<span class="hljs-title function_">updateProjectionMatrix</span>();
    <span class="hljs-comment">// 不在视图 1中渲染 helper</span>
    cameraHelper.<span class="hljs-property">visible</span> = <span class="hljs-literal">false</span>;
    cameraHelper.<span class="hljs-title function_">update</span>();
    renderer.<span class="hljs-title function_">render</span>(scene, camera);
    <span class="hljs-comment">// #endregion</span>

    <span class="hljs-comment">// #region 视图2 渲染</span>
    <span class="hljs-keyword">const</span> aspect2 = <span class="hljs-title function_">setScissorForElement</span>(view2Elem);
    camera2.<span class="hljs-property">aspect</span> = aspect2;
    camera2.<span class="hljs-title function_">updateProjectionMatrix</span>();
    <span class="hljs-comment">// 在第二台摄像机中绘制cameraHelper</span>
    cameraHelper.<span class="hljs-property">visible</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// 单独给视图 2 设置个背景色</span>
    scene.<span class="hljs-property">background</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0x000040</span>);
    renderer.<span class="hljs-title function_">render</span>(scene, camera2);

    <span class="hljs-comment">// #endregion</span>

    <span class="hljs-title function_">requestAnimationFrame</span>(render);
  }

  <span class="hljs-title function_">requestAnimationFrame</span>(render);
}

<span class="hljs-title function_">main</span>();


</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74942e32e8464a54b040c8668eb1f636~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z54yr5LiN54Ot:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966269&amp;x-signature=%2Bph78ht6RnByyveYBi%2Bpc8PJ1ZA%3D" alt="image.png" loading="lazy"/></p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[DOM 操作实战｜原生 JS 实现 6 个高频交互效果（选项卡 / 轮播图等，附源码 + 注释）]]></title>    <link>https://juejin.cn/post/7603383059150897194</link>    <guid>https://juejin.cn/post/7603383059150897194</guid>    <pubDate>2026-02-06T07:06:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603383059150897194" data-draft-id="7603389033041330230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="DOM 操作实战｜原生 JS 实现 6 个高频交互效果（选项卡 / 轮播图等，附源码 + 注释）"/> <meta itemprop="keywords" content="HTML,JavaScript"/> <meta itemprop="datePublished" content="2026-02-06T07:06:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码煮茶"/> <meta itemprop="url" content="https://juejin.cn/user/4197279069639178"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            DOM 操作实战｜原生 JS 实现 6 个高频交互效果（选项卡 / 轮播图等，附源码 + 注释）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4197279069639178/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码煮茶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:06:04.000Z" title="Fri Feb 06 2026 07:06:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、实战前言</h3>
<p>DOM 操作是前端开发的核心基础，无论是业务开发还是框架底层，都离不开对页面元素的增删改查、事件绑定、样式修改。很多新手入门后直接学习 Vue/React 等框架，忽略了原生 DOM 操作，导致遇到框架底层问题、原生开发需求时无从下手。</p>
<p>本次实战将用纯原生 HTML+CSS+JS实现前端开发中6 个高频 DOM 交互效果，覆盖点击、鼠标悬浮、轮播、表单交互等核心场景，所有案例均遵循 <strong>「结构搭建→样式美化→JS 交互」三步法，代码附带详细注释，同时讲解DOM 核心 API</strong>、事件处理技巧和新手避坑点，实现后的代码可直接复制到项目中使用，无需依赖任何框架。</p>
<h3 data-id="heading-1">二、前置准备</h3>
<ol>
<li>工具要求：仅需 VS Code（搭配 HTML/CSS/JS 高亮插件）+ 浏览器（Chrome/Firefox），无需额外环境和依赖</li>
<li>基础储备：了解 HTML 基本标签、CSS 基础样式（浮动 / 弹性布局）、JS 基础语法（变量 / 函数 / 条件判断），零基础可跟随步骤，核心 API 会逐行讲解</li>
<li>实现原则：结构与样式与行为分离（HTML 写结构、CSS 写样式、JS 写交互），代码解耦易维护；兼容主流浏览器，考虑边界场景（如无数据、高频点击）</li>
<li>核心 DOM API：本次实战会用到的高频 API，提前梳理方便理解</li>
</ol>
<ul>
<li>元素获取：querySelector/querySelectorAll（精准获取单个 / 多个元素）</li>
<li>事件绑定：addEventListener（推荐，可绑定多个事件，支持事件移除）</li>
<li>样式修改：style（行内样式）/classList（类名操作，推荐）</li>
<li>节点操作：createElement/appendChild（创建 / 添加节点）</li>
<li>事件对象：e.target（事件源）/e.preventDefault（阻止默认行为）</li>
</ul>
<h3 data-id="heading-2">三、实战说明</h3>
<p>本次实现的 6 个 DOM 交互效果覆盖 80% 的前端基础交互场景，难度由浅入深，从简单的点击切换到复杂的自动轮播，逐步提升 DOM 操作能力：</p>
<ol>
<li>基础点击类：选项卡切换（点击切换内容）、手风琴折叠（点击展开 / 折叠）</li>
<li>鼠标悬浮类：导航栏悬浮高亮、商品卡片悬浮效果（含动画）</li>
<li>自动轮播类：简易轮播图（自动播放 + 点击切换 + 鼠标暂停）</li>
<li>表单交互类：表单非空验证（提交前校验 + 实时提示）</li>
</ol>
<h3 data-id="heading-3">四、分步实现（结构 + 样式 + JS，逐一拆解）</h3>
<p>所有案例均提供完整可运行代码，复制到 VS Code 中保存为.html文件，直接用浏览器打开即可看到效果。</p>
<h3 data-id="heading-4">案例 1：选项卡切换（点击切换内容，高频基础交互）</h3>
<p>适用场景：后台管理系统、商品详情页、资讯页面的内容切换，前端基础面试高频考点核心逻辑：给所有选项绑定点击事件，点击时给当前选项添加高亮类，移除其他选项的高亮类；同时根据选项索引，显示对应内容，隐藏其他内容。</p>
<h3 data-id="heading-5">完整代码</h3>
<p><span href="https://code.juejin.cn/pen/7603641533250142258" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7603641533250142258" data-src="https://code.juejin.cn/pen/7603641533250142258" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h5 data-id="heading-6">核心知识点 &amp; 避坑点</h5>
<ol>
<li><strong>类名操作推荐<code>classList</code></strong>：替代直接修改<code>className</code>，避免覆盖原有类名，支持<code>add/remove/toggle/contains</code>方法</li>
<li><strong><code>querySelectorAll</code>返回伪数组</strong>：可直接用<code>forEach</code>遍历，比<code>getElementsByTagName</code>更灵活（支持 CSS 选择器）</li>
<li><strong>索引匹配</strong>：利用<code>forEach</code>的第二个参数<code>index</code>，实现选项和内容的一一对应，无需手动设置自定义属性</li>
<li><strong>避坑</strong>：不要用<code>onclick</code>绑定事件（一次只能绑定一个，会被覆盖），优先使用<code>addEventListener</code></li>
</ol>
<h4 data-id="heading-7">案例 2：手风琴折叠（点击展开 / 折叠，移动端高频）</h4>
<p><strong>适用场景</strong>：移动端导航、FAQ 常见问题、侧边栏分类，核心是<strong>单开 / 多开</strong>折叠控制<strong>核心逻辑</strong>：给所有折叠项绑定点击事件，点击时切换当前项内容的显示 / 隐藏（通过类名控制高度）；单开模式下，先折叠所有内容，再展开当前内容。</p>
<h5 data-id="heading-8">完整代码</h5>
<p><span href="https://code.juejin.cn/pen/7603642291110838282" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7603642291110838282" data-src="https://code.juejin.cn/pen/7603642291110838282" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h5 data-id="heading-9">核心知识点 &amp; 避坑点</h5>
<ol>
<li><strong>过渡动画</strong>：通过<code>transition</code>给<code>height</code>添加过渡，实现平滑的展开 / 折叠，替代<code>display: none/block</code>（无动画）</li>
<li><strong>单开 / 多开切换</strong>：单开先移除所有高亮类，再添加当前；多开直接用<code>toggle</code>切换当前项的类名，一行代码实现</li>
<li><strong>父元素获取</strong>：通过<code>this.parentElement</code>获取当前标题的父元素（折叠项），无需额外获取，简化代码</li>
<li><strong>避坑</strong>：不要直接修改<code>style.height</code>为<code>auto</code>，过渡动画会失效，需设置固定高度或通过<code>scrollHeight</code>获取真实高度（适配动态内容）</li>
</ol>
<h4 data-id="heading-10">案例 3：导航栏悬浮高亮（鼠标悬浮 + 点击选中，通用导航）</h4>
<p><strong>适用场景</strong>：网站顶部导航、侧边栏导航，结合<strong>鼠标悬浮</strong>和<strong>点击选中</strong>双交互，提升用户体验<strong>核心逻辑</strong>：鼠标悬浮时，给当前导航项添加悬浮高亮类，离开时移除；点击时，给当前项添加选中类，移除其他项的选中类，选中状态持久化。</p>
<h5 data-id="heading-11">完整代码</h5>
<p><span href="https://code.juejin.cn/pen/7603642758038519846" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7603642758038519846" data-src="https://code.juejin.cn/pen/7603642758038519846" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h5 data-id="heading-12">核心知识点 &amp; 避坑点</h5>
<ol>
<li><strong>阻止默认行为</strong>：通过<code>e.preventDefault()</code>阻止 a 标签的默认跳转，适配纯前端导航（无实际链接）</li>
<li><strong>样式优先级</strong>：选中类样式高于悬浮类，通过<code>contains</code>判断是否为选中项，避免悬浮样式覆盖选中样式</li>
<li><strong>鼠标事件</strong>：<code>mouseenter/mouseleave</code>（不冒泡）优于<code>mouseover/mouseout</code>（冒泡），避免子元素触发父元素事件</li>
<li><strong>避坑</strong>：不要给 a 标签设置<code>href="#"</code>，点击会导致页面跳转到顶部，用<code>href="javascript:;"</code>更友好</li>
</ol>
<h4 data-id="heading-13">案例 4：商品卡片悬浮效果（含动画，电商高频）</h4>
<p><strong>适用场景</strong>：电商网站商品列表、资讯卡片、产品展示，结合<strong>样式动画</strong>和<strong>DOM 鼠标事件</strong>，提升页面质感<strong>核心逻辑</strong>：鼠标悬浮在卡片上时，通过<code>classList</code>添加悬浮类，实现卡片上移、阴影放大、显示遮罩层；鼠标离开时移除悬浮类，恢复原样式，所有效果通过 CSS 过渡实现，JS 仅做类名切换。</p>
<h5 data-id="heading-14">完整代码</h5>
<p><span href="https://code.juejin.cn/pen/7603643319142662153" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7603643319142662153" data-src="https://code.juejin.cn/pen/7603643319142662153" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h5 data-id="heading-15">核心知识点 &amp; 避坑点</h5>
<ol>
<li><strong>样式与行为分离</strong>：JS 仅负责类名切换，所有动画和样式由 CSS 实现，符合前端开发规范，便于维护</li>
<li><strong>CSS 过渡</strong>：给<code>card</code>添加<code>transition: all 0.3s ease</code>，实现所有样式的平滑过渡，包括<code>transform</code>、<code>box-shadow</code>、<code>opacity</code></li>
<li><strong>绝对定位</strong>：遮罩层通过<code>position: absolute</code>脱离文档流，相对于卡片（<code>relative</code>）定位，实现全屏遮罩</li>
<li><strong>避坑</strong>：给卡片添加<code>overflow: hidden</code>，避免卡片上移时超出容器，同时防止图片圆角失效</li>
</ol>
<h4 data-id="heading-16">案例 5：简易轮播图（自动播放 + 点击切换 + 鼠标暂停，高频核心）</h4>
<p><strong>适用场景</strong>：网站首页轮播、广告展示、图片集，前端 DOM 实战高频考点，融合<strong>定时器</strong>、<strong>事件绑定</strong>、<strong>样式切换</strong>核心知识点<strong>核心逻辑</strong>：通过定时器实现图片自动轮播（修改索引，切换图片和指示器）；点击左右按钮切换上一张 / 下一张（索引加减，边界判断）；点击指示器跳转到对应图片；鼠标悬浮在轮播图上暂停定时器，离开后恢复。</p>
<h5 data-id="heading-17">完整代码</h5>
<p><span href="https://code.juejin.cn/pen/7603643841714847770" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7603643841714847770" data-src="https://code.juejin.cn/pen/7603643841714847770" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h5 data-id="heading-18">核心知识点 &amp; 避坑点</h5>
<ol>
<li><strong>定时器管理</strong>：用变量保存定时器 ID，方便暂停和恢复，避免多个定时器同时运行</li>
<li><strong>边界判断</strong>：切换索引时判断是否超出范围，实现轮播循环（最后一张切到第一张，第一张切到最后一张）</li>
<li><strong>样式移动</strong>：通过修改<code>left</code>值实现图片横向滑动，结合<code>transition</code>实现平滑动画，比<code>display</code>更友好</li>
<li><strong>事件委托</strong>：轮播图的所有子元素（按钮、指示器、图片）的鼠标事件，都可以绑定在父容器上，减少事件绑定数量</li>
<li><strong>避坑</strong>：给轮播容器添加<code>overflow: hidden</code>，隐藏超出的图片；图片容器的宽度要设置为<code>单张宽度*图片数量</code>，确保横向排列</li>
</ol>
<h4 data-id="heading-19">案例 6：表单非空验证（实时提示 + 提交校验，业务高频）</h4>
<p><strong>适用场景</strong>：登录 / 注册表单、留言表单、提交表单，前端基础校验，减少无效接口请求，提升用户体验<strong>核心逻辑</strong>：给输入框绑定<code>input</code>实时事件，输入时校验是否为空，实时显示提示信息；给表单绑定<code>submit</code>提交事件，提交前校验所有必填项，若有未填项阻止提交并提示，全部填完则提交成功。</p>
<h5 data-id="heading-20">完整代码</h5>
<p><span href="https://code.juejin.cn/pen/7603644243231866926" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7603644243231866926" data-src="https://code.juejin.cn/pen/7603644243231866926" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h5 data-id="heading-21">核心知识点 &amp; 避坑点</h5>
<ol>
<li><strong>通用函数封装</strong>：将非空校验逻辑封装为<code>checkInput</code>函数，避免重复代码，便于维护和拓展（如后续添加长度校验、格式校验）</li>
<li><strong>实时校验</strong>：绑定<code>input</code>事件，输入时实时校验，比<code>blur</code>（失去焦点）更友好，提升用户体验</li>
<li><strong>表单提交事件</strong>：绑定<code>form</code>的<code>submit</code>事件，而非按钮的<code>click</code>事件，兼容回车键提交，更符合表单交互规范</li>
<li><strong>阻止默认提交</strong>：提交前必须用<code>e.preventDefault()</code>阻止默认行为，先完成前端校验，再执行接口请求或手动提交</li>
<li><strong>避坑</strong>：校验时要使用<code>trim()</code>去除输入框的首尾空格，避免用户输入空格视为非空；密码框用<code>type="password"</code>，保证安全性</li>
</ol>
<h3 data-id="heading-22">五、DOM 操作核心技巧与避坑总结</h3>
<h4 data-id="heading-23">核心技巧</h4>
<ol>
<li><strong>元素获取</strong>：优先使用<code>querySelector/querySelectorAll</code>，支持 CSS 选择器，精准且灵活，替代老旧的<code>getElementById/getElementsByClassName</code></li>
<li><strong>事件绑定</strong>：优先使用<code>addEventListener</code>，支持多事件绑定、事件移除，避免<code>onxxx</code>的覆盖问题；利用<strong>事件委托</strong>减少事件绑定数量（将子元素事件绑定到父元素）</li>
<li><strong>样式修改</strong>：优先使用<code>classList</code>操作类名，分离样式和行为，避免直接修改<code>style</code>（行内样式难维护，覆盖优先级高）</li>
<li><strong>函数封装</strong>：将重复的 DOM 操作逻辑封装为通用函数（如表单校验、类名切换），提升代码复用性和可维护性</li>
<li><strong>事件对象</strong>：熟练使用<code>e.target</code>（事件源）、<code>e.preventDefault</code>（阻止默认行为）、<code>e.stopPropagation</code>（阻止事件冒泡），解决交互中的各种问题</li>
<li><strong>定时器管理</strong>：用变量保存定时器 ID，及时清除定时器，避免内存泄漏和多次执行（如轮播图的暂停 / 恢复）</li>
</ol>
<h4 data-id="heading-24">新手常踩避坑点</h4>
<ol>
<li><strong>元素获取时机</strong>：在 DOM 节点渲染完成后再获取元素，避免获取到<code>null</code>（将 JS 写在<code>body</code>底部或使用<code>DOMContentLoaded</code>事件）</li>
<li><strong>伪数组遍历</strong>：<code>querySelectorAll</code>返回的是伪数组，可直接用<code>forEach</code>遍历，不能直接使用数组的<code>push/pop</code>方法</li>
<li><strong>this 指向问题</strong>：在箭头函数中，<code>this</code>指向父级作用域，而非事件触发的元素，事件处理函数优先使用普通函数</li>
<li><strong>样式覆盖</strong>：直接修改<code>style</code>会覆盖行内样式，优先使用类名切换；多个样式冲突时，利用 CSS 优先级解决（如选中类高于悬浮类）</li>
<li><strong>默认行为未阻止</strong>：a 标签、表单、按钮等有默认行为，交互时需用<code>e.preventDefault()</code>阻止，避免页面跳转或表单默认提交</li>
<li><strong>内存泄漏</strong>：及时移除事件监听、清除定时器、释放无用的 DOM 节点引用，避免页面长时间运行后性能下降</li>
</ol>
<h3 data-id="heading-25">六、拓展延伸（新手进阶方向）</h3>
<ol>
<li><strong>事件委托进阶</strong>：将所有子元素的事件绑定到父容器，利用<code>e.target</code>判断事件源，实现动态添加节点的事件绑定（如动态添加的商品卡片自动拥有悬浮效果）</li>
<li><strong>DOM 节点动态操作</strong>：用<code>createElement/appendChild/removeChild</code>实现动态添加 / 删除 DOM 节点（如动态添加表单项、商品卡片）</li>
<li><strong>表单校验拓展</strong>：在非空校验基础上，添加手机号、邮箱、密码强度、验证码等格式校验，封装为通用表单校验库</li>
<li><strong>轮播图升级</strong>：实现无缝轮播、触摸滑动（适配移动端）、图片预加载、轮播速度可配置等功能，打造通用轮播图组件</li>
<li><strong>本地存储结合</strong>：将表单数据、选中状态、轮播索引等保存到<code>localStorage/sessionStorage</code>，实现页面刷新后状态持久化</li>
<li><strong>封装通用组件</strong>：将 6 个案例封装为可复用的原生 JS 组件，通过参数配置（如轮播图速度、卡片宽度、表单校验规则）适配不同业务场景</li>
<li><strong>跨浏览器兼容</strong>：添加低版本浏览器的兼容代码（如<code>classList</code>的 polyfill、<code>forEach</code>的兼容），适配 IE11 等老旧浏览器</li>
</ol>
<h3 data-id="heading-26">七、总结</h3>
<p>本次实战用纯原生 HTML+CSS+JS 实现了<strong>6 个前端高频 DOM 交互效果</strong>，覆盖了点击、鼠标悬浮、自动轮播、表单交互等核心场景，所有案例均遵循<strong>结构与样式与行为分离</strong>的开发原则，代码简洁、注释详细，可直接复制到项目中使用。</p>
<p>通过本次实战，不仅能熟练掌握<strong>DOM 增删改查、事件绑定、样式修改</strong>等核心 API，还能理解前端交互的底层逻辑，掌握<strong>函数封装、代码解耦、边界处理</strong>的开发思维 —— 这些能力是学习 Vue/React 等框架的基础，也是前端开发和面试的核心要求。</p>
<p>所有案例的难度由浅入深，新手可跟随步骤逐一实现，在实现过程中理解每个 API 的使用场景和技巧，同时避开新手常踩的坑，逐步提升原生 DOM 操作能力，为后续前端开发打下坚实的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RIL 异步处理模型和命令队列详解]]></title>    <link>https://juejin.cn/post/7603359026710839306</link>    <guid>https://juejin.cn/post/7603359026710839306</guid>    <pubDate>2026-02-06T07:10:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603359026710839306" data-draft-id="7603261102795882522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RIL 异步处理模型和命令队列详解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T07:10:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RIL 异步处理模型和命令队列详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:10:47.000Z" title="Fri Feb 06 2026 07:10:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>RIL处理命令和响应的方式是确保通信顺畅的关键。RIL实现了一个异步处理模型，命令发送和响应接收是分开进行的。命令发送之后，RIL等待无线模块的响应，响应到来时，RIL会根据响应数据的内容进行相应的处理。当有多个命令需要执行时，RIL会使用队列管理这些命令，确保它们按顺序执行。</p>
<p>处理命令和响应的过程大致如下：</p>
<p>命令队列 ：所有待发送的命令放入队列中。</p>
<p>异步发送 ：从队列中取出命令，并异步发送给硬件模块。</p>
<p>响应监听 ：RIL监听来自硬件模块的响应。</p>
<p>结果回调 ：当响应到达时，RIL将结果回调给发起请求的应用程序。</p>
<h3 data-id="heading-0">1. <strong>核心数据结构</strong></h3>
<h4 data-id="heading-1">RequestInfo 结构体（待发送的命令信息）</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 来自 ril.cpp 第 126 行</span>
<span class="hljs-type">static</span> <span class="hljs-type">pthread_mutex_t</span> s_pendingRequestsMutex = PTHREAD_MUTEX_INITIALIZER;
<span class="hljs-type">static</span> RequestInfo *s_pendingRequests = <span class="hljs-literal">NULL</span>;  <span class="hljs-comment">// 待处理请求的链表头</span>
</code></pre>
<p><strong>RequestInfo 包含：</strong></p>
<ul>
<li><code>token</code> - 唯一标识符，用于匹配请求和响应</li>
<li><code>pCI</code> - 指向 CommandInfo 结构体的指针</li>
<li><code>socket_id</code> - SIM 卡 ID（多卡支持）</li>
<li><code>p_next</code> - 链表指针，指向下一个待处理请求</li>
<li><code>wasAckSent</code> - 标志异步确认是否已发送</li>
</ul>
<h4 data-id="heading-2">多 SIM 卡支持</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 多 SIM 卡的独立队列</span>
<span class="hljs-meta">#<span class="hljs-keyword">if</span> (SIM_COUNT &gt;= 2)</span>
<span class="hljs-type">static</span> <span class="hljs-type">pthread_mutex_t</span> s_pendingRequestsMutex_socket2  = PTHREAD_MUTEX_INITIALIZER;
<span class="hljs-type">static</span> RequestInfo *s_pendingRequests_socket2          = <span class="hljs-literal">NULL</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">if</span> (SIM_COUNT &gt;= 3)</span>
<span class="hljs-type">static</span> <span class="hljs-type">pthread_mutex_t</span> s_pendingRequestsMutex_socket3  = PTHREAD_MUTEX_INITIALIZER;
<span class="hljs-type">static</span> RequestInfo *s_pendingRequests_socket3          = <span class="hljs-literal">NULL</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
<span class="hljs-comment">// ...</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">2. <strong>命令队列的完整流程</strong></h3>
<h4 data-id="heading-4">步骤 1: 命令入队 - <code>addRequestToList()</code></h4>
<pre><code class="hljs language-c" lang="c">RequestInfo *
<span class="hljs-title function_">addRequestToList</span><span class="hljs-params">(<span class="hljs-type">int</span> serial, <span class="hljs-type">int</span> slotId, <span class="hljs-type">int</span> request)</span> {
    RequestInfo *pRI;
    <span class="hljs-type">int</span> ret;
    RIL_SOCKET_ID socket_id = (RIL_SOCKET_ID) slotId;
    
    <span class="hljs-comment">// 根据 slotId 选择对应的互斥锁和队列</span>
    <span class="hljs-type">pthread_mutex_t</span>* pendingRequestsMutexHook = &amp;s_pendingRequestsMutex;
    RequestInfo** pendingRequestsHook = &amp;s_pendingRequests;
    
    <span class="hljs-keyword">if</span> (socket_id == RIL_SOCKET_2) {
        pendingRequestsMutexHook = &amp;s_pendingRequestsMutex_socket2;
        pendingRequestsHook = &amp;s_pendingRequests_socket2;
    }
    <span class="hljs-comment">// ... 其他 SIM 卡处理 ...</span>
    
    <span class="hljs-comment">// 分配内存并初始化 RequestInfo</span>
    pRI = (RequestInfo *)<span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(RequestInfo));
    <span class="hljs-keyword">if</span> (pRI == <span class="hljs-literal">NULL</span>) {
        RLOGE(<span class="hljs-string">"Memory allocation failed for request %s"</span>, requestToString(request));
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    }
    
    <span class="hljs-comment">// 保存请求信息</span>
    pRI-&gt;token = serial;              <span class="hljs-comment">// 唯一标识</span>
    pRI-&gt;pCI = &amp;(s_commands[request]); <span class="hljs-comment">// 命令定义</span>
    pRI-&gt;socket_id = socket_id;        <span class="hljs-comment">// SIM 卡 ID</span>
    
    <span class="hljs-comment">// 原子操作：将请求添加到队列头部</span>
    ret = pthread_mutex_lock(pendingRequestsMutexHook);
    assert (ret == <span class="hljs-number">0</span>);
    
    pRI-&gt;p_next = *pendingRequestsHook;  <span class="hljs-comment">// 新请求指向原来的头</span>
    *pendingRequestsHook = pRI;          <span class="hljs-comment">// 新请求成为新的头</span>
    
    ret = pthread_mutex_unlock(pendingRequestsMutexHook);
    assert (ret == <span class="hljs-number">0</span>);
    
    <span class="hljs-keyword">return</span> pRI;  <span class="hljs-comment">// 返回用作 token</span>
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>使用<strong>互斥锁</strong>保护共享数据结构</li>
<li>使用<strong>链表</strong>（LIFO - 后进先出）存储待处理请求</li>
<li><code>token</code> 就是返回的 <code>RequestInfo</code> 指针本身</li>
</ul>
<hr/>
<h4 data-id="heading-5">步骤 2: 异步发送命令</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ril_service.cpp 中的命令分发</span>
<span class="hljs-type">bool</span> <span class="hljs-title function_">dispatchVoid</span><span class="hljs-params">(<span class="hljs-type">int</span> serial, <span class="hljs-type">int</span> slotId, <span class="hljs-type">int</span> request)</span> {
    <span class="hljs-comment">// 1. 将请求加入队列（创建 RequestInfo）</span>
    RequestInfo *pRI = android::addRequestToList(serial, slotId, request);
    <span class="hljs-keyword">if</span> (pRI == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 2. 异步发送给硬件模块</span>
    CALL_ONREQUEST(request, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, pRI, slotId);
    <span class="hljs-comment">// 这会调用到 vendor RIL 实现（如 QCRIL）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>实际调用链：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">dispatchVoid</span>()
    → <span class="hljs-built_in">addRequestToList</span>() 创建 RequestInfo 并加入队列
    → <span class="hljs-built_in">CALL_ONREQUEST</span>() 调用 s_vendorFunctions-&gt;<span class="hljs-built_in">onRequest</span>()
        → vendor RIL (QCRIL) 处理请求
            → 与硬件模块通信
                → 等待响应...
</code></pre>
<hr/>
<h4 data-id="heading-6">步骤 3: 响应监听和回调 - <code>RIL_onRequestComplete()</code></h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-type">void</span>
<span class="hljs-title function_">RIL_onRequestComplete</span><span class="hljs-params">(RIL_Token t, RIL_Errno e, <span class="hljs-type">void</span> *response, <span class="hljs-type">size_t</span> responselen)</span> {
    RequestInfo *pRI;
    <span class="hljs-type">int</span> ret;
    RIL_SOCKET_ID socket_id = RIL_SOCKET_1;
    
    pRI = (RequestInfo *)t;  <span class="hljs-comment">// 从 token 恢复 RequestInfo</span>
    
    <span class="hljs-comment">// 从队列中移除该请求</span>
    <span class="hljs-keyword">if</span> (!checkAndDequeueRequestInfoIfAck(pRI, <span class="hljs-literal">false</span>)) {
        RLOGE (<span class="hljs-string">"RIL_onRequestComplete: invalid RIL_Token"</span>);
        <span class="hljs-keyword">return</span>;
    }
    
    socket_id = pRI-&gt;socket_id;
    
    <span class="hljs-comment">// ... 异常处理 ...</span>
    
    <span class="hljs-keyword">if</span> (pRI-&gt;cancelled == <span class="hljs-number">0</span>) {
        <span class="hljs-type">int</span> responseType;
        
        <span class="hljs-comment">// 判断响应类型</span>
        <span class="hljs-keyword">if</span> (s_callbacks.version &gt;= <span class="hljs-number">13</span> &amp;&amp; pRI-&gt;wasAckSent == <span class="hljs-number">1</span>) {
            <span class="hljs-comment">// 异步响应：先前发送过 ack，现在发送最终响应</span>
            responseType = RESPONSE_SOLICITED_ACK_EXP;
            grabPartialWakeLock();  <span class="hljs-comment">// 获取 wake lock</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 同步响应</span>
            responseType = RESPONSE_SOLICITED;
        }
        
        <span class="hljs-comment">// 调用响应函数，返回给 Java 层</span>
        ret = pRI-&gt;pCI-&gt;responseFunction((<span class="hljs-type">int</span>) socket_id,
                responseType, pRI-&gt;token, e, response, responselen);
    }
    
    <span class="hljs-comment">// 释放内存</span>
    <span class="hljs-built_in">free</span>(pRI);
}
</code></pre>
<hr/>
<h4 data-id="heading-7">步骤 4: 移除请求 - <code>checkAndDequeueRequestInfoIfAck()</code></h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">int</span>
<span class="hljs-title function_">checkAndDequeueRequestInfoIfAck</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> RequestInfo *pRI, <span class="hljs-type">bool</span> isAck)</span> {
    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;
    <span class="hljs-type">pthread_mutex_t</span>* pendingRequestsMutexHook = &amp;s_pendingRequestsMutex;
    RequestInfo ** pendingRequestsHook = &amp;s_pendingRequests;
    
    <span class="hljs-keyword">if</span> (pRI == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-comment">// 根据 socket_id 选择对应的队列</span>
    <span class="hljs-keyword">if</span> (pRI-&gt;socket_id == RIL_SOCKET_2) {
        pendingRequestsMutexHook = &amp;s_pendingRequestsMutex_socket2;
        pendingRequestsHook = &amp;s_pendingRequests_socket2;
    }
    <span class="hljs-comment">// ...</span>
    
    pthread_mutex_lock(pendingRequestsMutexHook);
    
    <span class="hljs-comment">// 从链表中查找并移除该请求</span>
    <span class="hljs-keyword">for</span>(RequestInfo **ppCur = pendingRequestsHook
        ; *ppCur != <span class="hljs-literal">NULL</span>
        ; ppCur = &amp;((*ppCur)-&gt;p_next)
    ) {
        <span class="hljs-keyword">if</span> (pRI == *ppCur) {
            ret = <span class="hljs-number">1</span>;
            
            <span class="hljs-keyword">if</span> (isAck) {
                <span class="hljs-comment">// 标记 ack 已发送（用于异步长时间请求）</span>
                pRI-&gt;wasAckSent = <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 从链表中移除该请求</span>
                *ppCur = (*ppCur)-&gt;p_next;
            }
            <span class="hljs-keyword">break</span>;
        }
    }
    
    pthread_mutex_unlock(pendingRequestsMutexHook);
    
    <span class="hljs-keyword">return</span> ret;
}
</code></pre>
<hr/>
<h3 data-id="heading-8">3. <strong>异步处理模型时间线</strong></h3>
<pre><code class="hljs language-vbnet" lang="vbnet">时间轴：

<span class="hljs-symbol">T0:</span> 应用发起请求（如拨号）
    ↓
<span class="hljs-symbol">T1:</span> addRequestToList() 创建 RequestInfo，加入 s_pendingRequests
    │ [RequestInfo 已在队列中]
    ↓
<span class="hljs-symbol">T2:</span> CALL_ONREQUEST() 发送命令给 vendor RIL
    │ [命令异步发送，不等待]
    ↓
<span class="hljs-symbol">T3:</span> Vendor RIL 与硬件通信，处理请求
    │ [可能耗时几秒钟]
    ↓
<span class="hljs-symbol">T4a:</span> 如果支持异步确认 (RIL version &gt;= <span class="hljs-number">13</span>)
    │   → RIL_onRequestAck() 被调用
    │   → pRI-&gt;wasAckSent = <span class="hljs-number">1</span>（标记但不移除）
    │   → 返回 ACK 给应用（让应用知道已收到）
    │
    ↓ (几秒后)
    │
<span class="hljs-symbol">T4b:</span> 硬件响应，回调 RIL_onRequestComplete()
    │ → checkAndDequeueRequestInfoIfAck(pRI, <span class="hljs-literal">false</span>)
    │ → 从 s_pendingRequests 中移除
    │ → 调用 responseFunction() 返回结果给 Java 层
    │ → free(pRI) 释放内存
    ↓
<span class="hljs-symbol">T5:</span> 应用收到最终响应
</code></pre>
<hr/>
<h3 data-id="heading-9">4. <strong>多并发请求的处理</strong></h3>
<p>当多个请求同时到达时：</p>
<pre><code class="hljs language-scss" lang="scss">请求队列状态变化：

初始状态：
s_pendingRequests → NULL

请求 <span class="hljs-number">1</span> (拨号) 到达：
s_pendingRequests → <span class="hljs-selector-attr">[RequestInfo-1]</span> → NULL

请求 <span class="hljs-number">2</span> (获取信号强度) 到达：
s_pendingRequests → <span class="hljs-selector-attr">[RequestInfo-2]</span> → <span class="hljs-selector-attr">[RequestInfo-1]</span> → NULL

请求 <span class="hljs-number">3</span> (设置网络) 到达：
s_pendingRequests → <span class="hljs-selector-attr">[RequestInfo-3]</span> → <span class="hljs-selector-attr">[RequestInfo-2]</span> → <span class="hljs-selector-attr">[RequestInfo-1]</span> → NULL

请求 <span class="hljs-number">2</span> 完成，响应：
<span class="hljs-built_in">checkAndDequeueRequestInfoIfAck</span>(RequestInfo-<span class="hljs-number">2</span>, false)
s_pendingRequests → <span class="hljs-selector-attr">[RequestInfo-3]</span> → <span class="hljs-selector-attr">[RequestInfo-1]</span> → NULL
（RequestInfo-<span class="hljs-number">2</span> 被移除并释放）

请求 <span class="hljs-number">1</span> 完成，响应：
s_pendingRequests → <span class="hljs-selector-attr">[RequestInfo-3]</span> → NULL
</code></pre>
<hr/>
<h3 data-id="heading-10">5. <strong>同步保护机制</strong></h3>
<h4 data-id="heading-11">互斥锁使用</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 关键的互斥保护</span>
pthread_mutex_lock(pendingRequestsMutexHook);
    <span class="hljs-comment">// 原子操作：增加或遍历链表</span>
    pRI-&gt;p_next = *pendingRequestsHook;
    *pendingRequestsHook = pRI;
pthread_mutex_unlock(pendingRequestsMutexHook);
</code></pre>
<p><strong>保护的操作：</strong></p>
<ul>
<li>✓ 添加请求到队列</li>
<li>✓ 查找并移除请求</li>
<li>✓ 遍历列表查找特定请求</li>
</ul>
<hr/>
<h3 data-id="heading-12">6. <strong>异步应答机制（ACK）</strong></h3>
<p>对于耗时较长的请求（如拨号）：</p>
<pre><code class="hljs language-css" lang="css">双阶段确认：

Phase <span class="hljs-number">1</span>: 快速 ACK
────────────────
请求来到时（T2）
    ↓
<span class="hljs-built_in">RIL_onRequestAck</span>() 
    ├─ pRI-&gt;wasAckSent = <span class="hljs-number">1</span>
    ├─ 调用 radio::<span class="hljs-built_in">acknowledgeRequest</span>()
    └─ 立即返回给应用

应用：「收到 ACK，知道正在处理」

Phase <span class="hljs-number">2</span>: 最终响应
─────────────────
硬件完成操作（T4b）
    ↓
<span class="hljs-built_in">RIL_onRequestComplete</span>()
    ├─ responseType = RESPONSE_SOLICITED_ACK_EXP
    ├─ <span class="hljs-built_in">grabPartialWakeLock</span>()
    ├─ 调用 <span class="hljs-built_in">responseFunction</span>()
    └─ 返回实际结果

应用：「收到最终响应」
</code></pre>
<hr/>
<h3 data-id="heading-13">7. <strong>关键 API 总结</strong></h3>



































<table><thead><tr><th>API</th><th>功能</th><th>调用方</th></tr></thead><tbody><tr><td><code>addRequestToList()</code></td><td>创建 RequestInfo，加入队列</td><td>RIL Service (ril_service.cpp)</td></tr><tr><td><code>CALL_ONREQUEST()</code></td><td>异步发送命令给 vendor RIL</td><td>RIL Service</td></tr><tr><td><code>RIL_onRequestAck()</code></td><td>Vendor RIL 发送快速确认</td><td>Vendor RIL</td></tr><tr><td><code>RIL_onRequestComplete()</code></td><td>Vendor RIL 发送最终响应</td><td>Vendor RIL</td></tr><tr><td><code>checkAndDequeueRequestInfoIfAck()</code></td><td>从队列移除请求</td><td>ril.cpp 内部</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-14">8. <strong>超时和 Wake Lock 管理</strong></h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 获取 wake lock，防止系统休眠</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">grabPartialWakeLock</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (s_callbacks.version &gt;= <span class="hljs-number">13</span>) {
        acquire_wake_lock(PARTIAL_WAKE_LOCK, ANDROID_WAKE_LOCK_NAME);
        
        <span class="hljs-comment">// 200ms 后自动释放（防止长期占用）</span>
        UserCallbackInfo *p_info =
            internalRequestTimedCallback(wakeTimeoutCallback, <span class="hljs-literal">NULL</span>, 
                                        &amp;TIMEVAL_WAKE_TIMEOUT);
        s_last_wake_timeout_info = p_info;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-15">总结</h3>









































<table><thead><tr><th>特性</th><th>实现方式</th></tr></thead><tbody><tr><td><strong>队列管理</strong></td><td>链表 + 互斥锁</td></tr><tr><td><strong>并发控制</strong></td><td>Pthread mutex</td></tr><tr><td><strong>请求标识</strong></td><td>Token (RequestInfo 指针)</td></tr><tr><td><strong>多 SIM 支持</strong></td><td>每个 SIM 独立队列 + 互斥锁</td></tr><tr><td><strong>异步处理</strong></td><td>命令发送和响应分离</td></tr><tr><td><strong>快速确认</strong></td><td>RIL_onRequestAck()</td></tr><tr><td><strong>最终响应</strong></td><td>RIL_onRequestComplete()</td></tr><tr><td><strong>系统睡眠保护</strong></td><td>Wake lock + 超时释放</td></tr></tbody></table>
<p>这个设计确保了 RIL 能够高效地处理多个并发请求，同时保持通信的可靠性和系统的电源管理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[langchain-RAG高级检索策略学习总结]]></title>    <link>https://juejin.cn/post/7603309951226806322</link>    <guid>https://juejin.cn/post/7603309951226806322</guid>    <pubDate>2026-02-06T07:06:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951226806322" data-draft-id="7603263490343026697" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="langchain-RAG高级检索策略学习总结"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T07:06:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心在飞扬AI"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194366823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            langchain-RAG高级检索策略学习总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194366823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心在飞扬AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:06:06.000Z" title="Fri Feb 06 2026 07:06:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    22
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RAG高级检索策略学习总结</h2>
<h3 data-id="heading-1">1. 自定义检索器</h3>
<h4 data-id="heading-2">这是什么</h4>
<p>自定义检索器是通过继承LangChain的<code>BaseRetriever</code>基类，实现<code>_get_relevant_documents</code>方法来创建的个性化检索器。这允许开发者根据自己的业务逻辑和需求，自定义文档检索的方式。</p>
<h4 data-id="heading-3">这个有什么用</h4>
<ul>
<li>实现特定的检索逻辑，如关键词匹配、模糊搜索等</li>
<li>整合多种数据源的检索能力</li>
<li>添加业务规则和过滤条件</li>
<li>灵活控制返回文档的数量和质量</li>
</ul>
<h4 data-id="heading-4">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> langchain_core.callbacks <span class="hljs-keyword">import</span> CallbackManagerForRetrieverRun
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain_core.retrievers <span class="hljs-keyword">import</span> BaseRetriever

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomRetriever</span>(<span class="hljs-title class_ inherited__">BaseRetriever</span>):
    documents: <span class="hljs-type">List</span>[Document]
    k: <span class="hljs-built_in">int</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_relevant_documents</span>(<span class="hljs-params">
        self, query: <span class="hljs-built_in">str</span>, *, run_manager: CallbackManagerForRetrieverRun
    </span>) -&gt; <span class="hljs-type">List</span>[Document]:
        <span class="hljs-string">"""根据传入的query，获取相关联的文档列表"""</span>
        matching_documents = []
        <span class="hljs-keyword">for</span> document <span class="hljs-keyword">in</span> self.documents:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(matching_documents) &gt;= self.k:
                <span class="hljs-keyword">return</span> matching_documents
            <span class="hljs-keyword">if</span> query.lower() <span class="hljs-keyword">in</span> document.page_content.lower():
                matching_documents.append(document)
        <span class="hljs-keyword">return</span> matching_documents

<span class="hljs-comment"># 使用示例</span>
documents = [
    Document(page_content=<span class="hljs-string">"笨笨是一只很喜欢睡觉的猫咪"</span>, metadata={<span class="hljs-string">"page"</span>: <span class="hljs-number">1</span>}),
    Document(page_content=<span class="hljs-string">"猫咪在窗台上打盹，看起来非常可爱。"</span>, metadata={<span class="hljs-string">"page"</span>: <span class="hljs-number">3</span>}),
]

retriever = CustomRetriever(documents=documents, k=<span class="hljs-number">3</span>)
results = retriever.invoke(<span class="hljs-string">"猫"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-5">2. Multi-Query多查询策略</h3>
<h4 data-id="heading-6">这是什么</h4>
<p>Multi-Query检索器使用大语言模型自动生成多个不同角度的查询，然后基于这些查询进行检索，最后合并所有结果。这是一种提高检索召回率和准确性的策略。</p>
<h4 data-id="heading-7">这个有什么用</h4>
<ul>
<li>解决用户查询表述不准确的问题</li>
<li>从多个角度理解同一个问题</li>
<li>提高检索的召回率，找到更多相关文档</li>
<li>减少因查询措辞不当导致的检索失败</li>
</ul>
<h4 data-id="heading-8">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> weaviate
<span class="hljs-keyword">from</span> langchain_classic.retrievers <span class="hljs-keyword">import</span> MultiQueryRetriever
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_weaviate <span class="hljs-keyword">import</span> WeaviateVectorStore
<span class="hljs-keyword">from</span> weaviate.auth <span class="hljs-keyword">import</span> AuthApiKey

<span class="hljs-comment"># 1. 构建向量数据库与检索器</span>
db = WeaviateVectorStore(
    client=weaviate.connect_to_wcs(
        cluster_url=<span class="hljs-string">"your_cluster_url"</span>,
        auth_credentials=AuthApiKey(<span class="hljs-string">"your_api_key"</span>),
    ),
    index_name=<span class="hljs-string">"DatasetDemo"</span>,
    text_key=<span class="hljs-string">"text"</span>,
    embedding=QianfanEmbeddingsEndpoint(model=<span class="hljs-string">"embedding-v1"</span>),
)
retriever = db.as_retriever(search_type=<span class="hljs-string">"mmr"</span>)

<span class="hljs-comment"># 2. 创建多查询检索器</span>
multi_query_retriever = MultiQueryRetriever.from_llm(
    retriever=retriever,
    llm=ChatOpenAI(model=<span class="hljs-string">"moonshot-v1-8k"</span>, temperature=<span class="hljs-number">0</span>),
    include_original=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 是否包含原始查询</span>
)

<span class="hljs-comment"># 3. 执行检索</span>
docs = multi_query_retriever.invoke(<span class="hljs-string">"关于LLMOps应用配置的文档有哪些"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-9">3. RAG多查询结果融合策略</h3>
<h4 data-id="heading-10">这是什么</h4>
<p>RAG Fusion是在Multi-Query基础上，使用RRF（Reciprocal Rank Fusion，倒数排名融合）算法来智能合并多个查询结果的策略。它不仅去重，还根据文档在不同查询结果中的排名进行加权排序。</p>
<h4 data-id="heading-11">这个有什么用</h4>
<ul>
<li>消除多个查询结果中的重复文档</li>
<li>根据文档的排名位置智能计算相关性得分</li>
<li>融合多个查询的优势，提高最终结果质量</li>
<li>避免简单去重导致的信息丢失</li>
</ul>
<h4 data-id="heading-12">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> langchain_core.callbacks <span class="hljs-keyword">import</span> CallbackManagerForRetrieverRun
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain_classic.retrievers <span class="hljs-keyword">import</span> MultiQueryRetriever
<span class="hljs-keyword">from</span> langchain_core.load <span class="hljs-keyword">import</span> dumps, loads

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RAGFusionRetriever</span>(<span class="hljs-title class_ inherited__">MultiQueryRetriever</span>):
    <span class="hljs-string">"""RAG多查询结果融合策略检索器"""</span>
    k: <span class="hljs-built_in">int</span> = <span class="hljs-number">4</span>  <span class="hljs-comment"># 返回前k个文档</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_documents</span>(<span class="hljs-params">
            self, queries: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], run_manager: CallbackManagerForRetrieverRun
    </span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>]:
        <span class="hljs-string">"""重写检索文档函数，返回嵌套列表"""</span>
        documents = []
        <span class="hljs-keyword">for</span> query <span class="hljs-keyword">in</span> queries:
            docs = self.retriever.invoke(
                query, config={<span class="hljs-string">"callbacks"</span>: run_manager.get_child()}
            )
            documents.append(docs)
        <span class="hljs-keyword">return</span> documents

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">unique_union</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-type">List</span>]</span>) -&gt; <span class="hljs-type">List</span>[Document]:
        <span class="hljs-string">"""使用RRF算法来去重合并对应的文档"""</span>
        fused_result = {}

        <span class="hljs-comment"># RRF算法：根据排名计算得分</span>
        <span class="hljs-keyword">for</span> docs <span class="hljs-keyword">in</span> documents:
            <span class="hljs-keyword">for</span> rank, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(docs):
                doc_str = dumps(doc)
                <span class="hljs-keyword">if</span> doc_str <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> fused_result:
                    fused_result[doc_str] = <span class="hljs-number">0</span>
                <span class="hljs-comment"># 计算得分：排名越前，得分越高</span>
                fused_result[doc_str] += <span class="hljs-number">1</span> / (rank + <span class="hljs-number">60</span>)

        <span class="hljs-comment"># 按得分降序排序，返回前k个</span>
        reranked_results = [
            (loads(doc), score)
            <span class="hljs-keyword">for</span> doc, score <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(fused_result.items(), key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">True</span>)
        ]

        <span class="hljs-keyword">return</span> [item[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> reranked_results[:self.k]]

<span class="hljs-comment"># 使用方式与MultiQueryRetriever相同</span>
rag_fusion_retriever = RAGFusionRetriever.from_llm(
    retriever=retriever,
    llm=ChatOpenAI(model=<span class="hljs-string">"moonshot-v1-8k"</span>, temperature=<span class="hljs-number">0</span>),
)
docs = rag_fusion_retriever.invoke(<span class="hljs-string">"查询内容"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-13">4. 问题分解策略</h3>
<h4 data-id="heading-14">这是什么</h4>
<p>问题分解策略将复杂的用户问题分解成多个独立的子问题，然后对每个子问题分别进行检索和回答，最后将所有子问题的答案整合起来形成最终答案。</p>
<h4 data-id="heading-15">这个有什么用</h4>
<ul>
<li>处理复杂、多方面的查询问题</li>
<li>提高对复合问题的回答准确性</li>
<li>逐步构建答案，每个子问题都可以获得独立的上下文</li>
<li>避免单一查询无法覆盖所有相关信息的缺陷</li>
</ul>
<h4 data-id="heading-16">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> operator <span class="hljs-keyword">import</span> itemgetter
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnablePassthrough
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-comment"># 1. 构建问题分解链</span>
decomposition_prompt = ChatPromptTemplate.from_template(
    <span class="hljs-string">"你是一个乐于助人的AI助理，可以针对一个输入问题生成多个相关的子问题。\n"</span>
    <span class="hljs-string">"目标是将输入问题分解成一组可以独立回答的子问题或者子任务。\n"</span>
    <span class="hljs-string">"生成与以下问题相关的多个搜索查询：{question}\n"</span>
    <span class="hljs-string">"并使用换行符进行分割，输出（3个子问题/子查询）："</span>
)

decomposition_chain = (
    {<span class="hljs-string">"question"</span>: RunnablePassthrough()}
    | decomposition_prompt
    | ChatOpenAI(model=<span class="hljs-string">"moonshot-v1-8k"</span>, temperature=<span class="hljs-number">0</span>)
    | StrOutputParser()
    | (<span class="hljs-keyword">lambda</span> x: x.strip().split(<span class="hljs-string">"\n"</span>))
)

<span class="hljs-comment"># 2. 构建迭代问答链</span>
prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"""这是你需要回答的问题：
---
{question}
---

这是所有可用的背景问题和答案对：
---
{qa_pairs}
---

这是与问题相关的额外背景信息：
---
{context}
---"""</span>)

chain = (
    {
        <span class="hljs-string">"question"</span>: itemgetter(<span class="hljs-string">"question"</span>),
        <span class="hljs-string">"qa_pairs"</span>: itemgetter(<span class="hljs-string">"qa_pairs"</span>),
        <span class="hljs-string">"context"</span>: itemgetter(<span class="hljs-string">"question"</span>) | retriever,
    }
    | prompt
    | ChatOpenAI(model=<span class="hljs-string">"moonshot-v1-8k"</span>, temperature=<span class="hljs-number">0</span>)
    | StrOutputParser()
)

<span class="hljs-comment"># 3. 循环处理所有子问题</span>
question = <span class="hljs-string">"关于LLMOps应用配置的文档有哪些"</span>
sub_questions = decomposition_chain.invoke(question)

qa_pairs = <span class="hljs-string">""</span>
<span class="hljs-keyword">for</span> sub_question <span class="hljs-keyword">in</span> sub_questions:
    answer = chain.invoke({<span class="hljs-string">"question"</span>: sub_question, <span class="hljs-string">"qa_pairs"</span>: qa_pairs})
    qa_pair = <span class="hljs-string">f"Question: <span class="hljs-subst">{sub_question}</span>\nAnswer: <span class="hljs-subst">{answer}</span>\n\n"</span>
    qa_pairs += qa_pair
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"问题: <span class="hljs-subst">{sub_question}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"答案: <span class="hljs-subst">{answer}</span>"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-17">5. 少量示例模板（Few-Shot Prompting）</h3>
<h4 data-id="heading-18">这是什么</h4>
<p>Few-Shot提示模板通过在提示中提供少量示例来引导大语言模型生成符合预期的输出。它结合了<code>ChatPromptTemplate</code>和<code>FewShotChatMessagePromptTemplate</code>，使模型能够通过示例理解任务模式。</p>
<h4 data-id="heading-19">这个有什么用</h4>
<ul>
<li>提高模型对特定任务的理解能力</li>
<li>减少对复杂prompt工程的需求</li>
<li>通过示例快速定义输出格式和风格</li>
<li>适用于文本转换、计算、分类等各种任务</li>
</ul>
<h4 data-id="heading-20">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, FewShotChatMessagePromptTemplate
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-comment"># 1. 构建示例模板与示例</span>
example_prompt = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{question}"</span>),
    (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"{answer}"</span>),
])

examples = [
    {<span class="hljs-string">"question"</span>: <span class="hljs-string">"帮我计算下2+2等于多少？"</span>, <span class="hljs-string">"answer"</span>: <span class="hljs-string">"4"</span>},
    {<span class="hljs-string">"question"</span>: <span class="hljs-string">"帮我计算下2+3等于多少？"</span>, <span class="hljs-string">"answer"</span>: <span class="hljs-string">"5"</span>},
    {<span class="hljs-string">"question"</span>: <span class="hljs-string">"帮我计算下20*15等于多少？"</span>, <span class="hljs-string">"answer"</span>: <span class="hljs-string">"300"</span>},
]

<span class="hljs-comment"># 2. 构建少量示例提示模板</span>
few_shot_prompt = FewShotChatMessagePromptTemplate(
    example_prompt=example_prompt,
    examples=examples,
)

<span class="hljs-comment"># 3. 构建最终提示模板</span>
prompt = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个可以计算复杂数学问题的聊天机器人"</span>),
    few_shot_prompt,
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{question}"</span>),
])

<span class="hljs-comment"># 4. 创建链并调用</span>
llm = ChatOpenAI(model=<span class="hljs-string">"moonshot-v1-8k"</span>, temperature=<span class="hljs-number">0</span>)
chain = prompt | llm | StrOutputParser()

result = chain.invoke(<span class="hljs-string">"帮我计算下14*15等于多少"</span>)
<span class="hljs-built_in">print</span>(result)
</code></pre>
<hr/>
<h3 data-id="heading-21">6. 回答回退策略检索器</h3>
<h4 data-id="heading-22">这是什么</h4>
<p>回答回退（Step-Back）检索器是一种策略，它会将用户的具体问题"回退"到一个更通用或更基础的问题，然后用这个回退问题进行检索。这种方法基于这样的理念：有时从更宏观的角度搜索，能找到更全面的相关信息。</p>
<h4 data-id="heading-23">这个有什么用</h4>
<ul>
<li>解决过于具体的问题导致检索结果过少的问题</li>
<li>从更宽泛的角度获取背景信息</li>
<li>通过Few-Shot示例学习如何生成合适的回退问题</li>
<li>提高对复杂、抽象问题的检索效果</li>
</ul>
<h4 data-id="heading-24">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> langchain_core.callbacks <span class="hljs-keyword">import</span> CallbackManagerForRetrieverRun
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain_core.language_models <span class="hljs-keyword">import</span> BaseLanguageModel
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, FewShotChatMessagePromptTemplate
<span class="hljs-keyword">from</span> langchain_core.retrievers <span class="hljs-keyword">import</span> BaseRetriever
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnablePassthrough

<span class="hljs-keyword">class</span> <span class="hljs-title class_">StepBackRetriever</span>(<span class="hljs-title class_ inherited__">BaseRetriever</span>):
    <span class="hljs-string">"""回答回退检索器"""</span>
    retriever: BaseRetriever
    llm: BaseLanguageModel

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_relevant_documents</span>(<span class="hljs-params">
            self, query: <span class="hljs-built_in">str</span>, *, run_manager: CallbackManagerForRetrieverRun
    </span>) -&gt; <span class="hljs-type">List</span>[Document]:
        <span class="hljs-comment"># 1. 构建少量示例提示模板</span>
        examples = [
            {<span class="hljs-string">"input"</span>: <span class="hljs-string">"慕课网上有关于AI应用开发的课程吗？"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"慕课网上有哪些课程？"</span>},
            {<span class="hljs-string">"input"</span>: <span class="hljs-string">"慕小课出生在哪个国家？"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"慕小课的人生经历是什么样的？"</span>},
            {<span class="hljs-string">"input"</span>: <span class="hljs-string">"司机可以开快车吗？"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"司机可以做什么？"</span>},
        ]
        example_prompt = ChatPromptTemplate.from_messages([
            (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>),
            (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"{output}"</span>),
        ])
        few_shot_prompt = FewShotChatMessagePromptTemplate(
            examples=examples,
            example_prompt=example_prompt,
        )

        <span class="hljs-comment"># 2. 构建生成回退问题的模板</span>
        prompt = ChatPromptTemplate.from_messages([
            (<span class="hljs-string">"system"</span>,
             <span class="hljs-string">"你是一个世界知识的专家。你的任务是回退问题，将问题改述为更一般或者前置问题，这样更容易回答，请参考示例来实现。"</span>),
            few_shot_prompt,
            (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{question}"</span>),
        ])

        <span class="hljs-comment"># 3. 构建链应用，生成回退问题并执行检索</span>
        chain = (
                {<span class="hljs-string">"question"</span>: RunnablePassthrough()}
                | prompt
                | self.llm
                | StrOutputParser()
                | self.retriever
        )

        <span class="hljs-keyword">return</span> chain.invoke(query)

<span class="hljs-comment"># 使用示例</span>
step_back_retriever = StepBackRetriever(
    retriever=retriever,
    llm=ChatOpenAI(model=<span class="hljs-string">"moonshot-v1-8k"</span>, temperature=<span class="hljs-number">0</span>),
)

documents = step_back_retriever.invoke(<span class="hljs-string">"人工智能会让世界发生翻天覆地的变化吗？"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-25">总结</h3>
<p>这些RAG高级检索策略各有特点，可以根据实际场景选择或组合使用：</p>
<ol>
<li><strong>自定义检索器</strong>：适用于需要特殊检索逻辑的场景</li>
<li><strong>Multi-Query</strong>：适用于查询表述不准确、需要多角度检索的场景</li>
<li><strong>RAG Fusion</strong>：适用于需要智能合并多查询结果的场景</li>
<li><strong>问题分解</strong>：适用于复杂、多方面的复合问题</li>
<li><strong>Few-Shot</strong>：适用于需要引导模型理解特定输出格式的场景</li>
<li><strong>回退策略</strong>：适用于问题过于具体导致检索效果不佳的场景</li>
</ol>
<p>这些策略可以灵活组合，例如在问题分解策略中使用Multi-Query检索器，或在RAG Fusion中应用回退策略，以达到最佳的检索效果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C2U动态编译+NLP自学习：BridgeCode 与企业原有代码集成架构详解]]></title>    <link>https://juejin.cn/post/7603389033041575990</link>    <guid>https://juejin.cn/post/7603389033041575990</guid>    <pubDate>2026-02-06T07:15:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603389033041575990" data-draft-id="7603352061506207750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C2U动态编译+NLP自学习：BridgeCode 与企业原有代码集成架构详解"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-06T07:15:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C2U动态编译+NLP自学习：BridgeCode 与企业原有代码集成架构详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:15:05.000Z" title="Fri Feb 06 2026 07:15:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">摘要</h2>
<p>在企业级应用开发中，如何将自动生成的代码与现有代码库无缝集成是一个长期存在的挑战。Ooder D2B (Design to Bridge) 框架通过 BridgeCode 机制，巧妙地解决了这个问题。本文将深入剖析 BridgeCode 的核心机制，揭示它如何通过 C2U 动态编译、NLP Module 自学习、项目级模板规则配置等技术，与企业原有代码完美融合。</p>
<hr/>
<h2 data-id="heading-1">目录</h2>
<ol>
<li><a href="#1-%25E5%25BC%2595%25E8%25A8%2580" title="#1-%25E5%25BC%2595%25E8%25A8%2580">引言</a></li>
<li><a href="#2-c2u-%25E5%258A%25A8%25E6%2580%2581%25E7%25BC%2596%25E8%25AF%2591%25E6%259C%25BA%25E5%2588%25B6%25E6%25B7%25B1%25E5%25BA%25A6%25E8%25A7%25A3%25E6%259E%2590" title="#2-c2u-%25E5%258A%25A8%25E6%2580%2581%25E7%25BC%2596%25E8%25AF%2591%25E6%259C%25BA%25E5%2588%25B6%25E6%25B7%25B1%25E5%25BA%25A6%25E8%25A7%25A3%25E6%259E%2590">C2U 动态编译机制深度解析</a></li>
<li><a href="#3-nlp-module-%25E8%2587%25AA%25E5%25AD%25A6%25E4%25B9%25A0%25E6%259C%25BA%25E5%2588%25B6" title="#3-nlp-module-%25E8%2587%25AA%25E5%25AD%25A6%25E4%25B9%25A0%25E6%259C%25BA%25E5%2588%25B6">NLP Module 自学习机制</a></li>
<li><a href="#4-%25E9%25A1%25B9%25E7%259B%25AE%25E7%25BA%25A7%25E6%25A8%25A1%25E6%259D%25BF%25E8%25A7%2584%25E5%2588%2599%25E9%2585%258D%25E7%25BD%25AE" title="#4-%25E9%25A1%25B9%25E7%259B%25AE%25E7%25BA%25A7%25E6%25A8%25A1%25E6%259D%25BF%25E8%25A7%2584%25E5%2588%2599%25E9%2585%258D%25E7%25BD%25AE">项目级模板规则配置</a></li>
<li><a href="#5-bridgecode-%25E6%25A0%25B8%25E5%25BF%2583%25E6%259E%25B6%25E6%259E%2584" title="#5-bridgecode-%25E6%25A0%25B8%25E5%25BF%2583%25E6%259E%25B6%25E6%259E%2584">BridgeCode 核心架构</a></li>
<li><a href="#6-%25E6%25A8%25A1%25E6%259D%25BF%25E7%2594%259F%25E6%2580%2581%25E4%25B8%258E%25E8%2587%25AA%25E5%25AD%25A6%25E4%25B9%25A0" title="#6-%25E6%25A8%25A1%25E6%259D%25BF%25E7%2594%259F%25E6%2580%2581%25E4%25B8%258E%25E8%2587%25AA%25E5%25AD%25A6%25E4%25B9%25A0">模板生态与自学习</a></li>
<li><a href="#7-%25E6%25A1%2586%25E6%259E%25B6%25E4%25BC%2598%25E5%258A%25BF%25E6%2580%25BB%25E7%25BB%2593" title="#7-%25E6%25A1%2586%25E6%259E%25B6%25E4%25BC%2598%25E5%258A%25BF%25E6%2580%25BB%25E7%25BB%2593">框架优势总结</a></li>
<li><a href="#8-%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5" title="#8-%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5">最佳实践</a></li>
<li><a href="#9-%25E6%2580%25BB%25E7%25BB%2593" title="#9-%25E6%2580%25BB%25E7%25BB%2593">总结</a></li>
</ol>
<hr/>
<h2 data-id="heading-2">1. 引言</h2>
<h3 data-id="heading-3">1.1 代码生成与集成的挑战</h3>
<p>在企业级应用开发中，代码生成技术已经被广泛应用，但如何将生成的代码与现有代码库无缝集成仍然是一个挑战。传统的方法存在以下问题：</p>
<ol>
<li><strong>代码冲突</strong>：生成的代码可能覆盖或与手动编写的代码冲突</li>
<li><strong>维护困难</strong>：生成的代码难以维护，修改后重新生成会丢失变更</li>
<li><strong>集成复杂</strong>：生成的代码需要手动配置才能与现有系统集成</li>
<li><strong>版本管理</strong>：生成的代码难以纳入版本控制系统</li>
<li><strong>团队协作</strong>：开发人员难以理解生成的代码，影响团队协作</li>
</ol>
<h3 data-id="heading-4">1.2 Ooder D2B 的解决方案</h3>
<p>Ooder D2B (Design to Bridge) 框架通过 BridgeCode 机制，提供了一种全新的解决方案：</p>
<ol>
<li><strong>C2U 动态编译</strong>：支持运行时动态编译和加载代码，无需重启应用</li>
<li><strong>NLP Module 自学习</strong>：通过 AI 辅助完成复杂的模板库维护</li>
<li><strong>项目级配置</strong>：每个项目可以独立设置规则和模板</li>
<li><strong>元数据驱动</strong>：通过 DSM (Design System Model) 元数据驱动代码生成</li>
<li><strong>VFS 管理</strong>：通过虚拟文件系统管理生成的代码，支持版本控制</li>
</ol>
<h3 data-id="heading-5">1.3 本文结构</h3>
<p>本文将从以下几个方面深入剖析 BridgeCode 机制：</p>
<ul>
<li>C2U 动态编译机制的深度解析</li>
<li>NLP Module 自学习机制的原理</li>
<li>项目级模板规则配置的体系</li>
<li>BridgeCode 核心架构设计</li>
<li>模板生态与自学习机制</li>
<li>框架优势总结</li>
<li>最佳实践</li>
</ul>
<hr/>
<h2 data-id="heading-6">2. C2U 动态编译机制深度解析</h2>
<h3 data-id="heading-7">2.1 C2UFactory 核心职责</h3>
<p>C2UFactory 是 Ooder 框架中负责动态编译和 UI 模块管理的核心工厂类。它的主要职责包括：</p>
<ol>
<li><strong>动态编译</strong>：支持运行时动态编译 UI 模块</li>
<li><strong>模块管理</strong>：管理 UI 模块的生命周期</li>
<li><strong>模板渲染</strong>：使用 MVEL 表达式引擎渲染模板</li>
<li><strong>缓存管理</strong>：提供模块缓存机制，提高性能</li>
</ol>
<p><strong>核心代码位置</strong>：</p>
<h3 data-id="heading-8">2.2 动态编译原理</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27af9895a1334979addd8a64ebe8e689~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966904&amp;x-signature=hn7%2FllzK2eDp%2FxI36czhVNUEqwo%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-9">2.2.1 核心方法分析</h4>
<p>C2UFactory 提供了多个核心方法来实现动态编译：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 动态编译 MODULE</span>
<span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ModuleUIComponent</span>&gt; UIModule&lt;T&gt; <span class="hljs-title function_">dynBuild</span><span class="hljs-params">(Class customClass, Map&lt;String, ?&gt; valueMap)</span>

<span class="hljs-comment">// 动态编译 MODULE（完整版）</span>
<span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ModuleUIComponent</span>&gt; UIModule&lt;T&gt; <span class="hljs-title function_">dynModule</span><span class="hljs-params">(MethodConfig methodConfig, Class&lt;T&gt; customClass, UIModule <span class="hljs-keyword">module</span>, Map&lt;String, ?&gt; valueMap)</span>

<span class="hljs-comment">// 获取视图（支持缓存）</span>
<span class="hljs-keyword">public</span> UIModule <span class="hljs-title function_">getViewByMethod</span><span class="hljs-params">(MethodConfig methodAPIBean, String projectName, Map&lt;String, ?&gt; valueMap)</span>

<span class="hljs-comment">// 创建真实视图</span>
<span class="hljs-keyword">public</span> UIModule <span class="hljs-title function_">createRealView</span><span class="hljs-params">(MethodConfig methodAPIBean, Class customClass, String projectName, Map&lt;String, ?&gt; valueMap, <span class="hljs-type">boolean</span> isDyn)</span>
</code></pre>
<h4 data-id="heading-10">2.2.2 动态编译流程</h4>
<p>C2UFactory 的动态编译流程如下：</p>
<h3 data-id="heading-11">2.3 MVEL 表达式引擎</h3>
<p>C2UFactory 使用 MVEL (MVFLEX Expression Language) 表达式引擎进行模板渲染：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 核心渲染代码</span>
<span class="hljs-type">String</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> (String) TemplateRuntime.eval(json, MvelDSMRoot.getInstance(), perContext(oTopModule, component.getUIModule()));
<span class="hljs-type">T</span> <span class="hljs-variable">moduleComponent</span> <span class="hljs-operator">=</span> JSONObject.parseObject(obj, customClass);
</code></pre>
<p><strong>MVEL 的优势</strong>：</p>
<ol>
<li><strong>高性能</strong>：比传统的 JSP/FreeMarker 更快</li>
<li><strong>灵活性</strong>：支持复杂的表达式和逻辑</li>
<li><strong>轻量级</strong>：无需额外的依赖</li>
<li><strong>易用性</strong>：语法简洁，易于理解</li>
</ol>
<h3 data-id="heading-12">2.4 动态编译的关键特性</h3>
<h4 data-id="heading-13">2.4.1 线程安全</h4>
<p>C2UFactory 使用线程锁确保线程安全：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">THREAD_LOCK</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Thread Lock"</span>;

<span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ModuleUIComponent</span>&gt; UIModule&lt;T&gt; <span class="hljs-title function_">dynModule</span><span class="hljs-params">(MethodConfig methodConfig, Class&lt;T&gt; customClass, UIModule <span class="hljs-keyword">module</span>, Map&lt;String, ?&gt; valueMap)</span> {
    <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">module</span>.getClassName()) {
        <span class="hljs-comment">// 动态编译逻辑</span>
    }
}
</code></pre>
<h4 data-id="heading-14">2.4.2 缓存机制</h4>
<p>C2UFactory 提供了多层缓存机制：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 线程缓存</span>
<span class="hljs-type">Map</span> <span class="hljs-variable">contextMap</span> <span class="hljs-operator">=</span> JDSActionContext.getActionContext().getContext();

<span class="hljs-comment">// 2. 时间缓存</span>
<span class="hljs-type">Long</span> <span class="hljs-variable">createTime</span> <span class="hljs-operator">=</span> (Long) contextMap.get(url + <span class="hljs-string">"[TIME]"</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">module</span> == <span class="hljs-literal">null</span> &amp;&amp; (createTime == <span class="hljs-literal">null</span> || System.currentTimeMillis() - createTime &gt; <span class="hljs-number">500</span>)) {
    <span class="hljs-comment">// 重新加载</span>
}

<span class="hljs-comment">// 3. 模块缓存</span>
<span class="hljs-keyword">static</span> Map&lt;String, C2UFactory&gt; managerMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, C2UFactory&gt;();
</code></pre>
<h4 data-id="heading-15">2.4.3 自定义组件支持</h4>
<p>C2UFactory 支持自定义组件：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 支持自定义类</span>
<span class="hljs-keyword">if</span> (customClass == <span class="hljs-literal">null</span>) {
    customClass = methodConfig.getRealViewClass();
}

<span class="hljs-comment">// 支持动态加载视图</span>
<span class="hljs-keyword">if</span> (methodConfig.getDynDataBean() != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">module</span>.getRealClassName().equals(<span class="hljs-keyword">module</span>.getClassName())) {
    customClass = (Class&lt;T&gt;) CustomDynLoadView.class;
}
</code></pre>
<hr/>
<h2 data-id="heading-16">3. NLP Module 自学习机制</h2>
<h3 data-id="heading-17">3.1 FullNlpComponentConverter 概述</h3>
<p>FullNlpComponentConverter 是 Ooder 框架中负责将自然语言和配置转换为 NLP 组件的核心转换器。它支持三种转换模式：</p>
<ol>
<li><strong>LLM_ONLY</strong>：只使用 LLM（大语言模型）进行转换</li>
<li><strong>SKILLS_ONLY</strong>：只使用 Skills（技能）进行转换</li>
<li><strong>HYBRID</strong>：混合使用 LLM 和 Skills</li>
</ol>
<p><strong>核心代码位置</strong>：FullNlpComponentConverter.java</p>
<h3 data-id="heading-18">3.2 转换模式详解</h3>
<h4 data-id="heading-19">3.2.1 LLM_ONLY 模式</h4>
<p>只使用 LLM 进行转换：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">case</span> LLM_ONLY:
    <span class="hljs-keyword">if</span> (llmInterface != <span class="hljs-literal">null</span>) {
        config = llmInterface.convertNaturalLanguageToConfig(naturalLanguage, componentType);
    }
    <span class="hljs-keyword">break</span>;
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>需要理解复杂的自然语言描述</li>
<li>需要生成创新的组件配置</li>
<li>对准确性要求极高的场景</li>
</ul>
<h4 data-id="heading-20">3.2.2 SKILLS_ONLY 模式</h4>
<p>只使用 Skills 进行转换：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">case</span> SKILLS_ONLY:
    <span class="hljs-keyword">if</span> (skillsBridge != <span class="hljs-literal">null</span>) {
        config = skillsBridge.processNaturalLanguage(naturalLanguage, componentType);
    }
    <span class="hljs-keyword">break</span>;
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>有明确的转换规则</li>
<li>需要快速响应</li>
<li>对稳定性要求极高的场景</li>
</ul>
<h4 data-id="heading-21">3.2.3 HYBRID 模式</h4>
<p>混合使用 LLM 和 Skills：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">case</span> HYBRID:
<span class="hljs-keyword">default</span>:
    <span class="hljs-comment">// 先尝试使用 Skills，失败后使用 LLM</span>
    <span class="hljs-keyword">if</span> (skillsBridge != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">try</span> {
            config = skillsBridge.processNaturalLanguage(naturalLanguage, componentType);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// Skills 失败，使用 LLM</span>
            <span class="hljs-keyword">if</span> (llmInterface != <span class="hljs-literal">null</span>) {
                config = llmInterface.convertNaturalLanguageToConfig(naturalLanguage, componentType);
            }
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (llmInterface != <span class="hljs-literal">null</span>) {
        config = llmInterface.convertNaturalLanguageToConfig(naturalLanguage, componentType);
    }
    <span class="hljs-keyword">break</span>;
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>需要兼顾准确性和灵活性</li>
<li>需要快速响应但也要保证准确性</li>
<li>大多数生产环境场景</li>
</ul>
<h3 data-id="heading-22">3.3 NlpComponentFactory 组件工厂</h3>
<h4 data-id="heading-23">3.3.1 工厂模式</h4>
<p>NlpComponentFactory 使用工厂模式创建各种 Nlp*UIComponent 实例，支持超过 30 种组件类型：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b0532c847044046847839fea67db9d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966904&amp;x-signature=qq0mB4WGCLMuW1HC7eScyNbxT6o%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>NlpComponentFactory 使用工厂模式创建各种 Nlp*UIComponent 实例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NlpComponentFactory</span> {
    <span class="hljs-keyword">private</span> Map&lt;String, ComponentCreator&gt; creatorMap;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NlpComponentFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.creatorMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        initializeCreators();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeCreators</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 注册组件创建器</span>
        registerCreator(<span class="hljs-string">"Block"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpBlockUIComponent</span>());
        registerCreator(<span class="hljs-string">"ButtonLayout"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpButtonLayoutUIComponent</span>());
        registerCreator(<span class="hljs-string">"ContentBlock"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpContentBlockUIComponent</span>());
        registerCreator(<span class="hljs-string">"CustomLayout"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpCustomLayoutUIComponent</span>());
        registerCreator(<span class="hljs-string">"Div"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpDivUIComponent</span>());
        registerCreator(<span class="hljs-string">"ECharts"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpEChartsUIComponent</span>());
        registerCreator(<span class="hljs-string">"FChart"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpFChartUIComponent</span>());
        registerCreator(<span class="hljs-string">"Gallery"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpGalleryUIComponent</span>());
        registerCreator(<span class="hljs-string">"Group"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpGroupUIComponent</span>());
        registerCreator(<span class="hljs-string">"MTree"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpMTreeUIComponent</span>());
        registerCreator(<span class="hljs-string">"Opinion"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpOpinionUIComponent</span>());
        registerCreator(<span class="hljs-string">"Panel"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpPanelUIComponent</span>());
        registerCreator(<span class="hljs-string">"PopTree"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpPopTreeUIComponent</span>());
        registerCreator(<span class="hljs-string">"SVGPaper"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpSVGPaperUIComponent</span>());
        registerCreator(<span class="hljs-string">"Tabs"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpTabsUIComponent</span>());
        registerCreator(<span class="hljs-string">"TitleBlock"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpTitleBlockUIComponent</span>());
        registerCreator(<span class="hljs-string">"Tree"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpTreeUIComponent</span>());
        registerCreator(<span class="hljs-string">"ClassForm"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpClassFormUIComponent</span>());
        registerCreator(<span class="hljs-string">"MForm"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpMFormUIComponent</span>());
        registerCreator(<span class="hljs-string">"TableForm"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpTableFormUIComponent</span>());
        registerCreator(<span class="hljs-string">"Grid"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpGridUIComponent</span>());
        registerCreator(<span class="hljs-string">"MGrid"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpMGridUIComponent</span>());
        registerCreator(<span class="hljs-string">"TableGrid"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpTableGridUIComponent</span>());
        registerCreator(<span class="hljs-string">"MainIndex"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpMainIndexUIComponent</span>());
        registerCreator(<span class="hljs-string">"ButtonViews"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpButtonViewsUIComponent</span>());
        registerCreator(<span class="hljs-string">"FoldingTabs"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpFoldingTabsUIComponent</span>());
        registerCreator(<span class="hljs-string">"Main"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpMainUIComponent</span>());
        registerCreator(<span class="hljs-string">"MButtonViews"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpMButtonViewsUIComponent</span>());
        registerCreator(<span class="hljs-string">"MNavButtonViews"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpMNavButtonViewsUIComponent</span>());
        registerCreator(<span class="hljs-string">"NavButtonLayout"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpNavButtonLayoutUIComponent</span>());
        registerCreator(<span class="hljs-string">"NavFoldingTree"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpNavFoldingTreeUIComponent</span>());
        registerCreator(<span class="hljs-string">"NavGallery"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpNavGalleryUIComponent</span>());
        registerCreator(<span class="hljs-string">"NavGroup"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpNavGroupUIComponent</span>());
        registerCreator(<span class="hljs-string">"NavMenuBar"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpNavMenuBarUIComponent</span>());
        registerCreator(<span class="hljs-string">"NavTabs"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpNavTabsUIComponent</span>());
        registerCreator(<span class="hljs-string">"NavTree"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpNavTreeUIComponent</span>());
        registerCreator(<span class="hljs-string">"Stacks"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpStacksUIComponent</span>());
    }
}
</code></pre>
<h4 data-id="heading-24">3.3.2 支持的组件类型</h4>
<p>NlpComponentFactory 支持超过 30 种组件类型，包括：</p>
<p><strong>基础组件</strong>：</p>
<ul>
<li>Block、Div、Panel、Group</li>
<li>Form、Grid、Tree、Gallery</li>
<li>Tabs、Stacks、Layout</li>
</ul>
<p><strong>导航组件</strong>：</p>
<ul>
<li>NavButtonViews、NavGallery、NavGroup</li>
<li>NavMenuBar、NavTabs、NavTree</li>
<li>NavButtonLayout、NavFoldingTree</li>
</ul>
<p><strong>表单组件</strong>：</p>
<ul>
<li>ClassForm、MForm、TableForm</li>
<li>ButtonLayout、ContentBlock、TitleBlock</li>
</ul>
<p><strong>图表组件</strong>：</p>
<ul>
<li>ECharts、FChart</li>
<li>SVGPaper</li>
</ul>
<p><strong>主组件</strong>：</p>
<ul>
<li>MainIndex、Main</li>
<li>MButtonViews、MNavButtonViews</li>
</ul>
<h3 data-id="heading-25">3.4 LLM 和 Skills 接口</h3>
<h4 data-id="heading-26">3.4.1 LLMInterface 接口</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LLMInterface</span> {
    Object <span class="hljs-title function_">convertNaturalLanguageToConfig</span><span class="hljs-params">(String naturalLanguage, String componentType)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span>;
    String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInitialized</span><span class="hljs-params">()</span>;
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>将自然语言转换为组件配置</li>
<li>支持多种 LLM 模型</li>
<li>提供初始化和关闭机制</li>
</ul>
<h4 data-id="heading-27">3.4.2 SkillsBridge 接口</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SkillsBridge</span> {
    Object <span class="hljs-title function_">processNaturalLanguage</span><span class="hljs-params">(String naturalLanguage, String componentType)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerSkill</span><span class="hljs-params">(String skillName, Object skill)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span>;
    String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInitialized</span><span class="hljs-params">()</span>;
    Map&lt;String, Object&gt; <span class="hljs-title function_">getSkills</span><span class="hljs-params">()</span>;
    Object <span class="hljs-title function_">getSkill</span><span class="hljs-params">(String skillName)</span>;
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>处理自然语言并转换为组件配置</li>
<li>注册和管理技能</li>
<li>支持技能的动态扩展</li>
</ul>
<h3 data-id="heading-28">3.5 自学习机制原理</h3>
<h4 data-id="heading-29">3.5.1 技能注册机制</h4>
<p>SkillsBridge 支持动态注册技能：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerSkill</span><span class="hljs-params">(String skillName, Object skill)</span> {
    skills.put(skillName, skill);
}
</code></pre>
<p><strong>自学习过程</strong>：</p>
<ol>
<li>开发者定义技能规则</li>
<li>通过 registerSkill 注册技能</li>
<li>在转换时自动选择合适的技能</li>
<li>持续优化技能规则</li>
</ol>
<h4 data-id="heading-30">3.5.2 混合转换策略</h4>
<p>HYBRID 模式的混合转换策略：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72316b5196914b378380061ba5e02447~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966904&amp;x-signature=PFTgx8JKMz1fJfTPd2NVnYO%2BSfw%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p><strong>优势</strong>：</p>
<ol>
<li><strong>快速响应</strong>：Skills 通常比 LLM 更快</li>
<li><strong>高准确性</strong>：LLM 可以处理复杂场景</li>
<li><strong>高稳定性</strong>：Skills 失败时自动降级到 LLM</li>
<li><strong>持续优化</strong>：可以不断优化 Skills 规则</li>
</ol>
<hr/>
<h2 data-id="heading-31">4. 项目级模板规则配置</h2>
<h3 data-id="heading-32">4.1 UIPackagePathType 枚举</h3>
<p>UIPackagePathType 定义了 30+ 种不同的包路径类型，每种类型对应不同的系统模块：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/482f90db22d443bba5623b293bc59415~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966904&amp;x-signature=yAqcpqiKAyrzaInUFwMOPPGWTl8%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">UIPackagePathType</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IconEnumstype</span> {
    <span class="hljs-comment">// 用户工程</span>
    App(<span class="hljs-string">"App"</span>, <span class="hljs-string">"/App/"</span>, <span class="hljs-string">"用户工程"</span>, UIPackageType.sys, <span class="hljs-string">"ri-node-tree"</span>),
    
    <span class="hljs-comment">// 流程应用</span>
    bpm(<span class="hljs-string">"bpm"</span>, <span class="hljs-string">"/bpm/"</span>, <span class="hljs-string">"流程应用"</span>, UIPackageType.custom, <span class="hljs-string">"ri-node-tree"</span>),
    bpmadmin(<span class="hljs-string">"bpmadmin"</span>, <span class="hljs-string">"/bpm/admin/"</span>, <span class="hljs-string">"流程配置"</span>, UIPackageType.admin, <span class="hljs-string">"ri-settings-3-line"</span>),
    custom(<span class="hljs-string">"bpmcustom"</span>, <span class="hljs-string">"/bpm/custom/"</span>, <span class="hljs-string">"流程示例"</span>, UIPackageType.custom, <span class="hljs-string">"ri-flow-chart-line"</span>),
    bpmdisplay(<span class="hljs-string">"bpmdisplay"</span>, <span class="hljs-string">"/bpm/custom/display/"</span>, <span class="hljs-string">"流转控制"</span>, UIPackageType.custom, <span class="hljs-string">"ri-exchange-line"</span>),
    bpmlist(<span class="hljs-string">"bpmlist"</span>, <span class="hljs-string">"/bpm/custom/list/"</span>, <span class="hljs-string">"工作流"</span>, UIPackageType.custom, <span class="hljs-string">"ri-list-check-line"</span>),
    bpmform(<span class="hljs-string">"bpmform"</span>, <span class="hljs-string">"/bpm/form/"</span>, <span class="hljs-string">"工作流表单"</span>, UIPackageType.custom, <span class="hljs-string">"ri-file-line"</span>),
    
    <span class="hljs-comment">// 表单插件</span>
    formplugins(<span class="hljs-string">"formplugins"</span>, <span class="hljs-string">"/fdtform/plugins"</span>, <span class="hljs-string">"表单插件"</span>, UIPackageType.custom, <span class="hljs-string">"ri-puzzle-line"</span>),
    
    <span class="hljs-comment">// 用户定义</span>
    img(<span class="hljs-string">"img"</span>, <span class="hljs-string">"/img/"</span>, <span class="hljs-string">"图片"</span>, UIPackageType.userdef, <span class="hljs-string">"ri-image-line"</span>),
    css(<span class="hljs-string">"css"</span>, <span class="hljs-string">"/css/"</span>, <span class="hljs-string">"样式"</span>, UIPackageType.userdef, <span class="hljs-string">"ri-css3-line"</span>),
    
    <span class="hljs-comment">// JAVA 编译</span>
    java(<span class="hljs-string">"java"</span>, <span class="hljs-string">"/java/"</span>, <span class="hljs-string">"JAVA编译"</span>, UIPackageType.esd, <span class="hljs-string">"ri-code-box-line"</span>),
    debugproject(<span class="hljs-string">"debugproject"</span>, <span class="hljs-string">"/debugproject/"</span>, <span class="hljs-string">"预览"</span>, UIPackageType.esd, <span class="hljs-string">"ri-code-box-line"</span>),
    
    <span class="hljs-comment">// 嵌入模块</span>
    Module(<span class="hljs-string">"Module"</span>, <span class="hljs-string">"/Module/"</span>, <span class="hljs-string">"嵌入模块"</span>, UIPackageType.userdef, <span class="hljs-string">"ri-puzzle-line"</span>),
    
    <span class="hljs-comment">// 预览</span>
    preview(<span class="hljs-string">"preview"</span>, <span class="hljs-string">"/preview/"</span>, <span class="hljs-string">"预览"</span>, UIPackageType.admin, <span class="hljs-string">"ri-search-line"</span>),
    Debug(<span class="hljs-string">"Debug"</span>, <span class="hljs-string">"/Debug/"</span>, <span class="hljs-string">"调试运行"</span>, UIPackageType.admin, <span class="hljs-string">"ri-bug-line"</span>),
    
    <span class="hljs-comment">// 编辑器</span>
    RAD(<span class="hljs-string">"RAD"</span>, <span class="hljs-string">"/RAD/"</span>, <span class="hljs-string">"编辑器"</span>, UIPackageType.admin, <span class="hljs-string">"ri-cube-line"</span>),
    RADDB(<span class="hljs-string">"RADDB"</span>, <span class="hljs-string">"/RAD/db/"</span>, <span class="hljs-string">"数据库插件"</span>, UIPackageType.esd, <span class="hljs-string">"ri-database-line"</span>),
    RADServer(<span class="hljs-string">"RADServer"</span>, <span class="hljs-string">"/RAD/server/"</span>, <span class="hljs-string">"服务器插件"</span>, UIPackageType.esd, <span class="hljs-string">"ri-server-line"</span>),
    RADResource(<span class="hljs-string">"RADResource"</span>, <span class="hljs-string">"/RAD/resource/"</span>, <span class="hljs-string">"资源管理"</span>, UIPackageType.esd, <span class="hljs-string">"ri-box-3-line"</span>),
    RADProject(<span class="hljs-string">"RADProject"</span>, <span class="hljs-string">"/RAD/project/"</span>, <span class="hljs-string">"编辑器工程插件"</span>, UIPackageType.esd, <span class="hljs-string">"ri-node-tree"</span>),
    RADOrg(<span class="hljs-string">"RADOrg"</span>, <span class="hljs-string">"/RAD/org/"</span>, <span class="hljs-string">"协同插件"</span>, UIPackageType.esd, <span class="hljs-string">"ri-user-group-line"</span>),
    esd(<span class="hljs-string">"esd"</span>, <span class="hljs-string">"/esd/"</span>, <span class="hljs-string">"编辑器插件"</span>, UIPackageType.esd, <span class="hljs-string">"ri-puzzle-line"</span>),
    
    <span class="hljs-comment">// 系统菜单</span>
    systemnav(<span class="hljs-string">"systemnav"</span>, <span class="hljs-string">"/system/nav/"</span>, <span class="hljs-string">"导航菜单"</span>, UIPackageType.sys, <span class="hljs-string">"ri-menu-line"</span>),
    action(<span class="hljs-string">"action"</span>, <span class="hljs-string">"/action/"</span>, <span class="hljs-string">"系统菜单"</span>, UIPackageType.sys, <span class="hljs-string">"ri-css3-line"</span>),
    system(<span class="hljs-string">"system"</span>, <span class="hljs-string">"/system/"</span>, <span class="hljs-string">"统计监控"</span>, UIPackageType.sys, <span class="hljs-string">"ri-line-chart-line"</span>),
    
    <span class="hljs-comment">// 库表管理</span>
    db(<span class="hljs-string">"db"</span>, <span class="hljs-string">"/db/"</span>, <span class="hljs-string">"库表管理"</span>, UIPackageType.sys, <span class="hljs-string">"ri-database-line"</span>),
    fdt(<span class="hljs-string">"fdt"</span>, <span class="hljs-string">"/fdt/"</span>, <span class="hljs-string">"数据库示例"</span>, UIPackageType.sys, <span class="hljs-string">"ri-database-line"</span>),
    
    <span class="hljs-comment">// 工具</span>
    formula(<span class="hljs-string">"formula"</span>, <span class="hljs-string">"/admin/formula/"</span>, <span class="hljs-string">"公式管理"</span>, UIPackageType.tool, <span class="hljs-string">"ri-calculator-line"</span>),
    orgmanager(<span class="hljs-string">"orgmanager"</span>, <span class="hljs-string">"/admin/org/"</span>, <span class="hljs-string">"组织机构管理"</span>, UIPackageType.tool, <span class="hljs-string">"ri-node-tree"</span>),
    admin(<span class="hljs-string">"admin"</span>, <span class="hljs-string">"/admin/"</span>, <span class="hljs-string">"管理工具"</span>, UIPackageType.tool, <span class="hljs-string">"ri-tools-line"</span>),
    bpd(<span class="hljs-string">"bpd"</span>, <span class="hljs-string">"/admin/bpd/"</span>, <span class="hljs-string">"工作流插件"</span>, UIPackageType.tool, <span class="hljs-string">"ri-exchange-line"</span>),
    esdright(<span class="hljs-string">"esdright"</span>, <span class="hljs-string">"/esd/right/"</span>, <span class="hljs-string">"权限插件"</span>, UIPackageType.tool, <span class="hljs-string">"ri-key-line"</span>),
    esddic(<span class="hljs-string">"esddic"</span>, <span class="hljs-string">"/esd/dic/"</span>, <span class="hljs-string">"字典"</span>, UIPackageType.tool, <span class="hljs-string">"ri-book-line"</span>),
    esdpage(<span class="hljs-string">"esdpage"</span>, <span class="hljs-string">"/esd/page/"</span>, <span class="hljs-string">"页面插件"</span>, UIPackageType.tool, <span class="hljs-string">"ri-file-line"</span>),
    
    <span class="hljs-comment">// DSM 建模</span>
    dsm(<span class="hljs-string">"dsm"</span>, <span class="hljs-string">"/dsm/"</span>, <span class="hljs-string">"DSM建模"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-settings-3-line"</span>),
    dsmAgg(<span class="hljs-string">"dsm"</span>, <span class="hljs-string">"/dsm/agg/"</span>, <span class="hljs-string">"聚合模型"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-node-tree"</span>),
    dsmEsdClass(<span class="hljs-string">"dsmEsdClass"</span>, <span class="hljs-string">"/dsm/esdclass/"</span>, <span class="hljs-string">"实体关系"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-settings-3-line"</span>),
    dsmManger(<span class="hljs-string">"dsmManger"</span>, <span class="hljs-string">"/dsm/manager/"</span>, <span class="hljs-string">"领域实例"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-settings-3-line"</span>),
    dsmAdmin(<span class="hljs-string">"dsmAdmin"</span>, <span class="hljs-string">"/dsm/admin/"</span>, <span class="hljs-string">"控制台"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-speed-line"</span>),
    dsmWebSite(<span class="hljs-string">"dsmWebSite"</span>, <span class="hljs-string">"/dsm/website/"</span>, <span class="hljs-string">"模板站点"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-earth-line"</span>),
    dsmManager(<span class="hljs-string">"dsmManager"</span>, <span class="hljs-string">"/dsm/manager/"</span>, <span class="hljs-string">"DSM管理"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-tools-line"</span>),
    repository(<span class="hljs-string">"repository"</span>, <span class="hljs-string">"/dsm/repository/"</span>, <span class="hljs-string">"库表关系"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-database-line"</span>),
    dsmTable(<span class="hljs-string">"dsmTable"</span>, <span class="hljs-string">"/dsm/repository/table/"</span>, <span class="hljs-string">"资源"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-table-line"</span>),
    dsmNav(<span class="hljs-string">"dsmNav"</span>, <span class="hljs-string">"/dsm/nav/"</span>, <span class="hljs-string">"导航"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-menu-line"</span>),
    dsmTemp(<span class="hljs-string">"dsmTemp"</span>, <span class="hljs-string">"/dsm/temp/"</span>, <span class="hljs-string">"领域模板"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-file-copy-line"</span>),
    dsmWebSiteTemp(<span class="hljs-string">"dsmWebSiteTemp"</span>, <span class="hljs-string">"/dsm/website/temp/"</span>, <span class="hljs-string">"模板管理"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-file-copy-line"</span>),
    dsmSelect(<span class="hljs-string">"dsmSelect"</span>, <span class="hljs-string">"/dsm/website/select/"</span>, <span class="hljs-string">"站点模板"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-earth-line"</span>);
}
</code></pre>
<p><strong>代码位置</strong>：UIPackagePathType.java</p>
<h3 data-id="heading-33">4.2 ProjectConfig 项目配置</h3>
<p>ProjectConfig 包含项目的所有配置信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProjectConfig</span> {
    <span class="hljs-comment">// 数据库配置</span>
    <span class="hljs-keyword">private</span> List&lt;DataBaseConfig&gt; dbConfigs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;DataBaseConfig&gt;();
    
    <span class="hljs-comment">// 用户包</span>
    <span class="hljs-keyword">private</span> String usrPackage;
    
    <span class="hljs-comment">// 项目名称</span>
    <span class="hljs-keyword">private</span> String projectName;
    
    <span class="hljs-comment">// 公共路径</span>
    <span class="hljs-keyword">private</span> String publicPath;
    
    <span class="hljs-comment">// 工作空间</span>
    <span class="hljs-keyword">private</span> String workSpace;
    
    <span class="hljs-comment">// 资源类型</span>
    <span class="hljs-keyword">private</span> ProjectResourceType resourceType;
    
    <span class="hljs-comment">// API 过滤器</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; apiFilter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    
    <span class="hljs-comment">// 自定义模块过滤器</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; customModuleFilter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    
    <span class="hljs-comment">// 索引</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-string">"App.index"</span>;
    
    <span class="hljs-comment">// 公共服务器 URL</span>
    <span class="hljs-keyword">private</span> String publicServerUrl;
    
    <span class="hljs-comment">// 扩展组件</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; extcoms = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    <span class="hljs-keyword">private</span> List&lt;String&gt; extmodules = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    
    <span class="hljs-comment">// 字体、图片、样式</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; fonts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    <span class="hljs-keyword">private</span> List&lt;String&gt; imgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    <span class="hljs-keyword">private</span> List&lt;String&gt; styles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    
    <span class="hljs-comment">// 开发人员</span>
    <span class="hljs-keyword">public</span> Map&lt;ProjectRoleType, Set&lt;String&gt;&gt; devPersons = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;ProjectRoleType, Set&lt;String&gt;&gt;();
}
</code></pre>
<p><strong>代码位置</strong>：ProjectConfig.java</p>
<h3 data-id="heading-34">4.3 项目级配置的层次结构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cd3a1adf9ea40a5a0bae4cb95aa1afc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966904&amp;x-signature=WRKO2%2BJIcDrpXCwBnhqxrqrXhyM%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>4.4 项目级配置的优势</p>
<ol>
<li><strong>独立性</strong>：每个项目可以独立配置，互不影响</li>
<li><strong>灵活性</strong>：支持自定义模块、API 过滤器等</li>
<li><strong>扩展性</strong>：支持扩展组件和模块</li>
<li><strong>可维护性</strong>：配置集中管理，易于维护</li>
<li><strong>团队协作</strong>：支持多角色开发人员配置</li>
</ol>
<hr/>
<h2 data-id="heading-35">5. BridgeCode 核心架构</h2>
<h3 data-id="heading-36">5.1 BridgeCode 与传统代码生成的区别</h3>




























































<table><thead><tr><th align="left">特性</th><th align="left">传统代码生成</th><th align="left">BridgeCode</th></tr></thead><tbody><tr><td align="left">代码格式</td><td align="left">JavaScript/Java</td><td align="left">Java (注解驱动)</td></tr><tr><td align="left">生成方式</td><td align="left">静态生成</td><td align="left">动态生成 (C2U)</td></tr><tr><td align="left">集成方式</td><td align="left">手动集成</td><td align="left">自动集成</td></tr><tr><td align="left">更新方式</td><td align="left">重新生成</td><td align="left">热加载 (C2U)</td></tr><tr><td align="left">版本控制</td><td align="left">困难</td><td align="left">支持 VFS</td></tr><tr><td align="left">类型安全</td><td align="left">弱类型</td><td align="left">强类型</td></tr><tr><td align="left">维护性</td><td align="left">低</td><td align="left">高</td></tr><tr><td align="left">模板数量</td><td align="left">固定</td><td align="left">几百种 (NLP)</td></tr><tr><td align="left">配置粒度</td><td align="left">全局</td><td align="left">项目级</td></tr><tr><td align="left">自学习</td><td align="left">无</td><td align="left">支持 (NLP)</td></tr></tbody></table>
<h3 data-id="heading-37">5.2 BridgeCode 的设计理念</h3>
<p>BridgeCode 的设计理念是"声明式生成，运行时集成，自学习优化"：</p>
<ol>
<li><strong>声明式生成</strong>：通过注解和元数据声明代码的生成规则，而不是直接生成代码</li>
<li><strong>运行时集成</strong>：在运行时动态加载和集成代码，而不是在编译时静态集成</li>
<li><strong>元数据驱动</strong>：通过 DSM 元数据驱动代码生成，而不是硬编码生成逻辑</li>
<li><strong>热加载</strong>：支持运行时动态加载和更新代码，无需重启应用</li>
<li><strong>自学习优化</strong>：通过 NLP Module 自学习机制，持续优化模板规则</li>
</ol>
<h3 data-id="heading-38">5.3 BridgeCode 核心架构图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a1e8c5c160a4305919673795e69956d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966904&amp;x-signature=dzD0b%2Bdk57HjqajCde4o89TNHJo%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-39">6.1 模板数量与分类</h3>
<p>Ooder D2B 框架支持几百种模板，通过多个维度进行分类：</p>
<h4 data-id="heading-40">6.1.1 按组件类型分类</h4>
















































































<table><thead><tr><th align="left">组件类型</th><th align="left">模板数量</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">Block</td><td align="left">5+</td><td align="left">块组件模板</td></tr><tr><td align="left">Div</td><td align="left">5+</td><td align="left">DIV 容器模板</td></tr><tr><td align="left">Form</td><td align="left">10+</td><td align="left">表单组件模板</td></tr><tr><td align="left">Grid</td><td align="left">10+</td><td align="left">网格组件模板</td></tr><tr><td align="left">Tree</td><td align="left">8+</td><td align="left">树形组件模板</td></tr><tr><td align="left">Gallery</td><td align="left">5+</td><td align="left">画廊组件模板</td></tr><tr><td align="left">SVG</td><td align="left">5+</td><td align="left">SVG 绘图模板</td></tr><tr><td align="left">Tabs</td><td align="left">8+</td><td align="left">标签页模板</td></tr><tr><td align="left">Chart</td><td align="left">10+</td><td align="left">图表模板</td></tr><tr><td align="left">Panel</td><td align="left">5+</td><td align="left">面板模板</td></tr><tr><td align="left">Layout</td><td align="left">5+</td><td align="left">布局模板</td></tr><tr><td align="left">导航组件</td><td align="left">20+</td><td align="left">导航组件模板</td></tr><tr><td align="left">主组件</td><td align="left">5+</td><td align="left">主组件模板</td></tr><tr><td align="left">表单组件</td><td align="left">10+</td><td align="left">表单字段模板</td></tr></tbody></table>
<p><strong>总计</strong>：超过 100 种组件模板</p>
<h4 data-id="heading-41">6.1.2 按应用场景分类</h4>

































































<table><thead><tr><th align="left">应用场景</th><th align="left">模板数量</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">用户工程 (App)</td><td align="left">10+</td><td align="left">用户应用模板</td></tr><tr><td align="left">流程应用 (bpm)</td><td align="left">20+</td><td align="left">流程管理模板</td></tr><tr><td align="left">表单插件</td><td align="left">10+</td><td align="left">表单插件模板</td></tr><tr><td align="left">JAVA 编译</td><td align="left">15+</td><td align="left">Java 编译模板</td></tr><tr><td align="left">嵌入模块</td><td align="left">10+</td><td align="left">嵌入模块模板</td></tr><tr><td align="left">编辑器 (RAD)</td><td align="left">20+</td><td align="left">编辑器模板</td></tr><tr><td align="left">系统菜单</td><td align="left">15+</td><td align="left">系统菜单模板</td></tr><tr><td align="left">统计监控</td><td align="left">10+</td><td align="left">监控统计模板</td></tr><tr><td align="left">库表管理</td><td align="left">10+</td><td align="left">库表管理模板</td></tr><tr><td align="left">工具</td><td align="left">15+</td><td align="left">工具模板</td></tr><tr><td align="left">DSM 建模</td><td align="left">20+</td><td align="left">DSM 建模模板</td></tr></tbody></table>
<p><strong>总计</strong>：超过 150 种应用场景模板</p>
<h3 data-id="heading-42">6.2 模板的自学习机制</h3>
<h4 data-id="heading-43">6.2.1 AI 辅助维护</h4>
<p>Ooder 框架通过 AI Skills 辅助完成复杂的模板库维护：</p>
<ol>
<li><strong>规则学习</strong>：通过 Skills 学习模板使用规则</li>
<li><strong>模式识别</strong>：识别常用的模板组合模式</li>
<li><strong>智能推荐</strong>：根据使用情况推荐模板</li>
<li><strong>自动优化</strong>：自动优化模板参数</li>
</ol>
<h4 data-id="heading-44">6.2.2 模板版本管理</h4>
<p>通过 VFS 支持模板版本管理：</p>
<ol>
<li><strong>版本控制</strong>：每个模板可以有多个版本</li>
<li><strong>版本切换</strong>：支持不同版本之间的切换</li>
<li><strong>版本回滚</strong>：支持回滚到历史版本</li>
<li><strong>版本对比</strong>：支持版本之间的对比</li>
</ol>
<h4 data-id="heading-45">6.2.3 模板共享机制</h4>
<p>支持模板的共享和复用：</p>
<ol>
<li><strong>项目内共享</strong>：项目内模板共享</li>
<li><strong>跨项目共享</strong>：跨项目模板共享</li>
<li><strong>全局共享</strong>：全局模板共享</li>
<li><strong>自定义模板</strong>：支持自定义模板</li>
</ol>
<h3 data-id="heading-46">6.3 模板生态的优势</h3>
<ol>
<li><strong>丰富性</strong>：几百种模板覆盖各种场景</li>
<li><strong>灵活性</strong>：支持自定义和扩展</li>
<li><strong>智能化</strong>：AI 辅助维护，持续优化</li>
<li><strong>可维护性</strong>：版本管理，易于维护</li>
<li><strong>可复用性</strong>：支持共享和复用</li>
</ol>
<hr/>
<h2 data-id="heading-47">7. 框架优势总结</h2>
<h3 data-id="heading-48">7.1 核心优势</h3>
<p>Ooder D2B 框架相比传统代码生成方案，具有以下核心优势：</p>
<h4 data-id="heading-49">7.1.1 无缝集成</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/831fb2b199db4718b866b01c9d462587~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966904&amp;x-signature=0L9hXNF8pDd1zH9CmrksfHxCXt0%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p><strong>传统方案</strong>：</p>
<ul>
<li>需要手动配置才能与现有系统集成</li>
<li>生成的代码可能覆盖手动编写的代码</li>
<li>集成复杂，容易出错</li>
</ul>
<p><strong>BridgeCode 方案</strong>：</p>
<ul>
<li>自动集成，无需手动配置</li>
<li>通过注解声明生成规则，避免代码冲突</li>
<li>运行时动态加载，即时生效</li>
</ul>
<h4 data-id="heading-50">7.1.2 开发效率</h4>
<p><strong>传统方案</strong>：</p>
<ul>
<li>需要重新编译和重启应用</li>
<li>开发效率低，迭代周期长</li>
<li>团队协作困难</li>
</ul>
<p><strong>BridgeCode 方案</strong>：</p>
<ul>
<li>热加载，无需重启应用</li>
<li>开发效率高，快速迭代</li>
<li>支持团队协作</li>
</ul>
<h4 data-id="heading-51">7.1.3 类型安全</h4>
<p><strong>传统方案</strong>：</p>
<ul>
<li>弱类型，运行时才发现错误</li>
<li>难以保证代码质量</li>
<li>维护困难</li>
</ul>
<p><strong>BridgeCode 方案</strong>：</p>
<ul>
<li>强类型，编译时发现错误</li>
<li>保证代码质量</li>
<li>易于维护</li>
</ul>
<h4 data-id="heading-52">7.1.4 可维护性</h4>
<p><strong>传统方案</strong>：</p>
<ul>
<li>生成的代码难以理解</li>
<li>维护困难，修改后重新生成会丢失变更</li>
<li>版本管理困难</li>
</ul>
<p><strong>BridgeCode 方案</strong>：</p>
<ul>
<li>注解清晰明了，易于理解</li>
<li>通过元数据驱动，修改不会丢失</li>
<li>支持 VFS 版本管理</li>
</ul>
<h4 data-id="heading-53">7.1.5 扩展性</h4>
<p><strong>传统方案</strong>：</p>
<ul>
<li>模板数量固定，难以扩展</li>
<li>不支持自定义模板</li>
<li>扩展困难</li>
</ul>
<p><strong>BridgeCode 方案</strong>：</p>
<ul>
<li>支持几百种模板</li>
<li>支持自定义和扩展</li>
<li>AI 辅助维护，持续优化</li>
</ul>
<h3 data-id="heading-54">7.2 技术优势</h3>
<ol>
<li><strong>C2U 动态编译</strong>：支持运行时动态编译和加载</li>
<li><strong>NLP Module 自学习</strong>：通过 AI 辅助完成复杂的模板库维护</li>
<li><strong>项目级配置</strong>：每个项目可以独立设置规则和模板</li>
<li><strong>模板生态</strong>：几百种模板，覆盖各种场景</li>
<li><strong>VFS 管理</strong>：支持版本控制和共享</li>
</ol>
<h3 data-id="heading-55">7.3 业务优势</h3>
<ol>
<li><strong>降低成本</strong>：减少手动编码工作量</li>
<li><strong>提高质量</strong>：保证代码质量和一致性</li>
<li><strong>加速交付</strong>：快速迭代，加速项目交付</li>
<li><strong>降低风险</strong>：减少人为错误，降低项目风险</li>
<li><strong>提升体验</strong>：热加载，提升开发和用户体验</li>
</ol>
<hr/>
<h2 data-id="heading-56">8. 最佳实践</h2>
<h3 data-id="heading-57">8.1 C2U 动态编译最佳实践</h3>
<h4 data-id="heading-58">8.1.1 合理使用缓存</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用时间缓存避免频繁加载</span>
<span class="hljs-type">Long</span> <span class="hljs-variable">createTime</span> <span class="hljs-operator">=</span> (Long) contextMap.get(url + <span class="hljs-string">"[TIME]"</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">module</span> == <span class="hljs-literal">null</span> &amp;&amp; (createTime == <span class="hljs-literal">null</span> || System.currentTimeMillis() - createTime &gt; <span class="hljs-number">500</span>)) {
    <span class="hljs-comment">// 重新加载</span>
}
</code></pre>
<h4 data-id="heading-59">8.1.2 线程安全</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 synchronized 保证线程安全</span>
<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">module</span>.getClassName()) {
    <span class="hljs-comment">// 动态编译逻辑</span>
}
</code></pre>
<h4 data-id="heading-60">8.1.3 异常处理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 完善的异常处理</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">module</span> = buildView(methodAPIBean, <span class="hljs-literal">null</span>, projectName, valueMap, !isCache(methodAPIBean));
} <span class="hljs-keyword">catch</span> (Exception e) {
    e.printStackTrace();
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(e);
}
</code></pre>
<h3 data-id="heading-61">8.2 NLP Module 最佳实践</h3>
<h4 data-id="heading-62">8.2.1 选择合适的转换模式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 生产环境使用 HYBRID 模式</span>
<span class="hljs-type">FullNlpComponentConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FullNlpComponentConverter</span>(llmInterface, skillsBridge);
converter.setConversionMode(FullNlpComponentConverter.ConversionMode.HYBRID);
</code></pre>
<h4 data-id="heading-63">8.2.2 注册自定义技能</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 注册自定义技能</span>
skillsBridge.registerSkill(<span class="hljs-string">"customSkill"</span>, customSkillImplementation);
</code></pre>
<h4 data-id="heading-64">8.2.3 初始化和关闭</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 正确初始化和关闭</span>
llmInterface.initialize();
skillsBridge.initialize();

<span class="hljs-comment">// 使用完成后关闭</span>
llmInterface.close();
skillsBridge.close();
</code></pre>
<h3 data-id="heading-65">8.3 项目配置最佳实践</h3>
<h4 data-id="heading-66">8.3.1 合理设置项目配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 设置项目配置</span>
<span class="hljs-type">ProjectConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProjectConfig</span>();
config.setProjectName(<span class="hljs-string">"myProject"</span>);
config.setUsrPackage(<span class="hljs-string">"com.example"</span>);
config.setApiFilter(Arrays.asList(<span class="hljs-string">"api1"</span>, <span class="hljs-string">"api2"</span>));
</code></pre>
<h4 data-id="heading-67">8.3.2 使用包路径类型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 UIPackagePathType 确定包路径</span>
<span class="hljs-type">UIPackagePathType</span> <span class="hljs-variable">pathType</span> <span class="hljs-operator">=</span> UIPackagePathType.fromSystemCode(<span class="hljs-string">"bpm"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> pathType.getPattern();
</code></pre>
<h4 data-id="heading-68">8.3.3 配置开发人员</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 配置开发人员</span>
config.addDevPersons(ProjectRoleType.developer, <span class="hljs-string">"user1"</span>);
config.addDevPersons(ProjectRoleType.tester, <span class="hljs-string">"user2"</span>);
</code></pre>
<h3 data-id="heading-69">8.4 模板使用最佳实践</h3>
<h4 data-id="heading-70">8.4.1 选择合适的模板</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 根据组件类型选择模板</span>
<span class="hljs-type">String</span> <span class="hljs-variable">componentType</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Form"</span>;
<span class="hljs-type">NlpBaseUIComponent</span> <span class="hljs-variable">component</span> <span class="hljs-operator">=</span> converter.convertFromNaturalLanguage(<span class="hljs-string">"创建一个用户表单"</span>, componentType);
</code></pre>
<h4 data-id="heading-71">8.4.2 自定义模板</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义模板</span>
NlpComponentFactory.registerCreator(<span class="hljs-string">"CustomComponent"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomNlpComponent</span>());
</code></pre>
<h4 data-id="heading-72">8.4.3 版本管理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 VFS 进行版本管理</span>
<span class="hljs-type">Folder</span> <span class="hljs-variable">versionFolder</span> <span class="hljs-operator">=</span> dsmInst.getJavaFolder().createChildFolder(<span class="hljs-string">"version-1.0"</span>);
versionFolder.upload(<span class="hljs-string">"template.ftl"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(templateFile));
</code></pre>
<hr/>
<h2 data-id="heading-73">9. 总结</h2>
<h3 data-id="heading-74">9.1 核心要点</h3>
<p>本文深入剖析了 BridgeCode 如何与企业原有代码合体的核心机制：</p>
<ol>
<li><strong>C2U 动态编译</strong>：支持运行时动态编译和加载代码，无需重启应用</li>
<li><strong>NLP Module 自学习</strong>：通过 AI 辅助完成复杂的模板库维护，支持几百种模板</li>
<li><strong>项目级配置</strong>：每个项目可以独立设置规则和模板，支持 30+ 种包路径类型</li>
<li><strong>元数据驱动</strong>：通过 DSM 元数据驱动代码生成，与现有代码库无缝集成</li>
<li><strong>VFS 管理</strong>：通过虚拟文件系统管理生成的代码，支持版本控制</li>
</ol>
<h3 data-id="heading-75">9.2 技术优势</h3>
<p>BridgeCode 机制具有以下技术优势：</p>
<ol>
<li><strong>无缝集成</strong>：与企业原有代码无缝集成，无需修改现有代码</li>
<li><strong>开发效率</strong>：热加载、动态编译，提高开发效率，快速迭代</li>
<li><strong>类型安全</strong>：强类型检查，编译时发现错误</li>
<li><strong>可维护性</strong>：注解清晰明了，易于理解和维护</li>
<li><strong>扩展性</strong>：支持几百种模板，支持自定义和扩展，AI 辅助维护</li>
</ol>
<h3 data-id="heading-76">9.3 应用场景</h3>
<p>BridgeCode 机制适用于以下场景：</p>
<ol>
<li><strong>企业级应用</strong>：企业级应用开发，需要与现有代码库集成</li>
<li><strong>快速原型</strong>：快速原型开发，快速迭代</li>
<li><strong>动态扩展</strong>：动态扩展功能，无需重启应用</li>
<li><strong>代码生成</strong>：代码生成场景，自动生成代码</li>
<li><strong>元数据驱动</strong>：元数据驱动开发，基于配置生成代码</li>
</ol>
<h3 data-id="heading-77">9.4 未来展望</h3>
<p>BridgeCode 机制的未来发展方向：</p>
<ol>
<li><strong>更多模板</strong>：支持更多模板类型，覆盖更多场景</li>
<li><strong>更好的 AI</strong>：集成更先进的 AI 模型，提高自学习能力</li>
<li><strong>更好的性能</strong>：优化性能，提高编译和加载速度</li>
<li><strong>更好的工具</strong>：提供更好的开发工具，提高开发体验</li>
<li><strong>更好的社区</strong>：建立更好的社区生态，促进交流和学习</li>
</ol>
<h3 data-id="heading-78">9.5 结语</h3>
<p>BridgeCode 机制是 Ooder D2B 框架的核心创新，通过 C2U 动态编译、NLP Module 自学习、项目级配置等技术，实现了与企业原有代码的无缝集成。它不仅解决了传统代码生成的痛点，还为企业级应用开发提供了一种全新的思路和方法。</p>
<p>Ooder 框架通过几百种模板、AI 辅助维护、项目级配置等特性，构建了一个强大的代码生成生态系统。这个生态系统不仅提高了开发效率，还保证了代码质量和可维护性。</p>
<p>希望本文能够帮助读者深入理解 BridgeCode 机制，并在实际项目中应用和推广。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用星流AI做库洛米卡牌APP，每一张都颜值爆表！]]></title>    <link>https://juejin.cn/post/7603263490343075849</link>    <guid>https://juejin.cn/post/7603263490343075849</guid>    <pubDate>2026-02-06T07:16:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603263490343075849" data-draft-id="7603283691457740810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用星流AI做库洛米卡牌APP，每一张都颜值爆表！"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2026-02-06T07:16:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿星AI工作室"/> <meta itemprop="url" content="https://juejin.cn/user/2250051536050763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用星流AI做库洛米卡牌APP，每一张都颜值爆表！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2250051536050763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿星AI工作室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:16:22.000Z" title="Fri Feb 06 2026 07:16:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3f9dd3e3a25426bbfaefed31d8a9808~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=Flmh7iEGg1vnJoFzX2aZdsbXlzc%3D" alt="图片" loading="lazy"/></p>
<p>家人们，库洛米脑袋要嗨疯了，</p>
<p>我不仅把它做成了手势交互游戏，又甜又酷。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56465fbe30ee4d739acc63443bf421c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=J9MnDMQDSZ4VwJQwOqIvU0ut4BI%3D" alt="图片" loading="lazy"/></p>
<p>而且我做了全套库洛米APP，</p>
<p>可以感受暗黑甜心沉浸式体验哦。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71745a2b82ec4476a2a73ca7808e42a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=lqwxDu5KYFkuju5eieJqEZ8a4dw%3D" alt="图片" loading="lazy"/></p>
<p>这是我用星流agent做的库洛米卡牌</p>
<p>星流，就是国内版的lovart没有网络要求，小白特友好。</p>
<h2 data-id="heading-0">设计风格选择</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fefcb10dc6d644cfa41c813f90f46c65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=PAPco5duR3zRa1aFZ%2Fq7cFGnjng%3D" alt="图片" loading="lazy"/></p>
<p>而且很久之前就有做卡牌游戏的想法了，但是我在网上找素材。</p>
<p>找了很久，发现都是这种经典式的卡牌素材。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76fdbeedad194be7bceda1632936e866~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=UwrMcYrMdErkTM6AeYxRA9%2Bo%2FoU%3D" alt="图片" loading="lazy"/></p>
<p>比如说github上这个，但是我想有自己的设计风格，</p>
<p>虽然我没学过设计，</p>
<p>刚好看到有人在星流社区发布了自己做的这个库洛米的demo。</p>
<p>所以我就按照他的提示词思路来做了这一套卡牌。</p>
<p>它其实全套的78张，大概20分钟，每一张小表情都超有戏。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed6c39e04b274a1fbd482dffacc230fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=E0Lg%2B4%2BPFE4eLE0Gj0PThxwOwws%3D" alt="图片" loading="lazy"/></p>
<p>就画质在多端运行也不会糊掉，因为我用我那个超大屏幕试了还是超级清晰，我真的每张都好喜欢。</p>
<p>就是要出去开盲盒，我要能开这么多库洛米，我得快乐死，这样你就可以拥有全套库洛米卡牌了。</p>
<h2 data-id="heading-1">接入iosAPP</h2>
<p>接下来阿星想把它搬到苹果APP上，就预览一下。我得先定好全套的交互脚本视觉清单。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efe3123e92764a658f64225f2119bd1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=JopDz8nea1iqY6OHka4BzhA2HO8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">告诉星流UI组件命名清单</h2>
<p>接着我就把这些需求都丢给了星流——因为我先写好交互脚本（代码），定好了每个角色的名字（变量名），然后再把这份【命名清单】丢给星流。这样它生成的每一张图，都不需要我二次改名，实现真正的 <strong>落地即生产</strong> 。</p>
<p>跟它说：请帮我生成库洛米全套UI，命名规范如下</p>
<p>告诉星流建议的 <strong>命名规范清单，你可以把这个part所有内容直接告诉星流</strong> ：</p>
<h3 data-id="heading-3">基础资源命名规范 (Base Assets)</h3>



































<table><thead><tr><th>资源类型</th><th>命名格式</th><th>示例</th><th>作用</th></tr></thead><tbody><tr><td>启动图</td><td>img_splash</td><td>img_splash.png</td><td>对应 App 启动画面</td></tr><tr><td>背景图</td><td>bg_类型</td><td>bg_main_purple, bg_card_yellow</td><td>作为 SwiftUI ZStack 的最底层</td></tr><tr><td>按钮图</td><td>btn_功能_状态</td><td>btn_draw_normal, btn_draw_pressed</td><td>用于自定义 Button Style</td></tr><tr><td>图标</td><td>ic_名称</td><td>ic_heart, ic_star, ic_kuromi_head</td><td>用于导航栏或功能点缀</td></tr></tbody></table>
<h3 data-id="heading-4">核心卡牌资源 (重点：序列化命名)</h3>
<p>为了让那 78 张卡牌能通过 <code>ForEach</code> 循环自动渲染， <strong>严禁使用中文或无规律名称</strong> 。</p>
<ul>
<li>• <strong>命名规则：</strong> <code>card_序号</code> 或 <code>card_类型_序号</code></li>
</ul>
<h3 data-id="heading-5">iOS 组件与 UI 零件 (Component Assets)</h3>
<p>针对你让星流生成的 UI 零件，命名如下：</p>
<ul>
<li>• <strong>小组件 (Widgets):</strong></li>
<li>
<ul>
<li>• <code>widget_small_luck</code> (今日运势小组件)</li>
<li>• <code>widget_medium_history</code> (占卜历史中组件)</li>
</ul>
</li>
<li>• <strong>装饰件 (Decorations):</strong></li>
<li>
<ul>
<li>• <code>deco_frame_gold</code> (卡牌外框)</li>
<li>• <code>deco_crystal_ball</code> (水晶球动画素材)</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-6">如何在 Prompt 中要求“星流”？</h3>
<p>当你让“星流”生成图集时， <strong>结尾可以在 Prompt 结尾加上这一段指令：</strong></p>
<blockquote>
<p>请确保 UI 资源清晰分离。如果提供工作表，请将它们以网格形式排列。在命名或引用这些资源时，使用小写字母和下划线（例如，btn_start_draw、bg_tarot_main）。对于 78 张塔罗牌，遵循严格的顺序命名约定，如 card_01 到 card_78，以便于编码集成。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">开发者小贴士 <strong>切图透明度</strong></h3>
<p><strong>切图透明度：</strong>  要求星流生成图标（Icons）和按钮（Buttons）时，背景必须是 <strong>纯色（如纯黑或纯白）</strong>  ，最好要求星流直接生成带有 Alpha 通道的透明 PNG，如果星流做不到，再使用纯色背景方案。</p>
<p>它就直接按照我的开发命名规范精准生成完了。</p>
<h2 data-id="heading-8">生成UI组件素材</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/353fd4ff0f2042b8809c98abf1079c1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=WOjTxGmv58gYJgvMed5ZInozoMI%3D" alt="图片" loading="lazy"/></p>
<p>大到背景图，</p>
<p>小到交互按钮的全套截图都ok了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34c41574d01c433bbc5b65583acfc247~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=yXX0A3R06i8zaPbRag9tGQjyfy0%3D" alt="图片" loading="lazy"/></p>
<p>然后我把这些组件图片直接拖进Xcode里面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79d44e19a18c4b58b935683cfde62761~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=q%2BGikpxaLuAjQ9fcc3ff04EA2Ek%3D" alt="图片" loading="lazy"/></p>
<p>点击build就可以直接运行成功了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5fe2d1b935d4c94b4d745b9ae839e97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=33CLtY%2BBZFJSEStGIUUfilqmdCQ%3D" alt="图片" loading="lazy"/></p>
<p>要知道如果名字对不上的话，</p>
<p>咱们的这个程序是没法跑起来的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f930971b01d1493c829a74df3a37f16d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=CK2BubvpeNSqYTejFO7fmGDYAtk%3D" alt="图片" loading="lazy"/></p>
<p>而星流AI它非常出色的完成了每张UI图的命名。</p>
<p>它既扮演了设计师，就比如说给咱们用prompt出图，又扮演了前端程序员，</p>
<p>把图片上的名称和咱们在程序里面的命名方式是高度的一致，</p>
<p>这样的话才会有那种丝滑的体验。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74543178cd424cacb487be1a3e692286~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=oGsMtTb%2F%2BQm4aUcsqcqYQTG0fMk%3D" alt="图片" loading="lazy"/></p>
<p>要上架了，</p>
<p>那我们再来一套APP store广告图，</p>
<p>官方尺寸告诉新流瞬间get，省去了以往要做多种尺寸icon的重复工作。</p>
<p>这是每一个上架过IOSAPP首选最痛苦的地方。</p>
<p>因为苹果官方它有很多很多种要求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/332538b957ac4805a9809a3231186e56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=u5%2BRkFYYpSFxfYAwduM4YbCGjrc%3D" alt="图片" loading="lazy"/></p>
<p>ok。继续</p>
<p>有任何不满意的地方就可以用他们家的文字编辑txt edit和精准编辑touch edit来修改，</p>
<p>改哪里，完全不需要重新作图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3feeb2aa71ab4dd19dae366f149a439e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=t9lDdDEk%2BvgKstFvQCPiFbuttbg%3D" alt="图片" loading="lazy"/></p>
<p>总之阿星之后的独立开发的UI设计，感觉都可以用星流来代表了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03bfe1566c7a49f3b9a53d7e09da3c7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=HpTk6feCVf4nvUZtyPFegotWbN8%3D" alt="图片" loading="lazy"/></p>
<p>颜值高还懂开发需求，我有信心成为全干工程师了。</p>
<p>我自己的话是仅供自己欣赏，大家如果要发布的话是要注意版权的。</p>
<p>OK，我是阿星！</p>
<p>更多AI应用，我们下期再见👋🏻</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93ddb5496c3248ea9809ebbc90c229f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=apu4LFjfzliu5X3EE3CWkBi7Kw0%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 2.7 封装全屏弹窗组件：基于命名空间的样式定制]]></title>    <link>https://juejin.cn/post/7603283691457822730</link>    <guid>https://juejin.cn/post/7603283691457822730</guid>    <pubDate>2026-02-06T07:14:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603283691457822730" data-draft-id="7603359026710855690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 2.7 封装全屏弹窗组件：基于命名空间的样式定制"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-02-06T07:14:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="user8615818578154"/> <meta itemprop="url" content="https://juejin.cn/user/3549647826599133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 2.7 封装全屏弹窗组件：基于命名空间的样式定制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3549647826599133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    user8615818578154
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:14:40.000Z" title="Fri Feb 06 2026 07:14:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue 2.7 + Element UI 项目中，封装全屏 Iframe 弹窗常遇到样式覆盖无效的问题。特别是开启 <code>append-to-body</code> 后，弹窗 DOM 位于根节点，常规的 <code>scoped</code> 样式难以生效。</p>
<p>本文介绍一种<strong>不依赖 <code>scoped</code></strong>，通过CSS 命名空间来实现安全样式隔离的方案。</p>
<h2 data-id="heading-0">1. 核心需求</h2>
<ul>
<li><strong>全屏沉浸</strong>：弹窗无边距、无默认内边距。</li>
<li><strong>DOM 结构安全</strong>：必须使用 <code>append-to-body</code>，防止被父级容器截断。</li>
<li><strong>样式无污染</strong>：在全局样式模式下，确保只影响当前组件。</li>
</ul>
<h2 data-id="heading-1">2. 组件实现 (<code>SurveyPortal.vue</code>)</h2>
<h3 data-id="heading-2">Template 结构</h3>
<p>关键在于设置 <code>custom-class</code>。这个唯一的类名将作为我们的“样式防火墙”。</p>
<pre><code class="hljs language-ini" lang="ini">&lt;template&gt;
  &lt;el-dialog
    :<span class="hljs-attr">visible.sync</span>=<span class="hljs-string">"dialogVisible"</span>
    :<span class="hljs-attr">title</span>=<span class="hljs-string">"title"</span>
    fullscreen
    :<span class="hljs-attr">append-to-body</span>=<span class="hljs-string">"true"</span>
    :<span class="hljs-attr">destroy-on-close</span>=<span class="hljs-string">"true"</span>
    <span class="hljs-attr">custom-class</span>=<span class="hljs-string">"survey-portal-dialog"</span> 
    @<span class="hljs-attr">close</span>=<span class="hljs-string">"handleClose"</span>
  &gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"iframe-wrapper"</span> v-loading=<span class="hljs-string">"loading"</span>&gt;
      &lt;iframe
        :<span class="hljs-attr">src</span>=<span class="hljs-string">"surveyUrl"</span>
        <span class="hljs-attr">frameborder</span>=<span class="hljs-string">"0"</span>
        <span class="hljs-attr">width</span>=<span class="hljs-string">"100%"</span>
        <span class="hljs-attr">height</span>=<span class="hljs-string">"100%"</span>
        @<span class="hljs-attr">load</span>=<span class="hljs-string">"onIframeLoad"</span>
      &gt;&lt;/iframe&gt;
    &lt;/div&gt;
  &lt;/el-dialog&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-3">Script 逻辑</h3>
<p>保持标准的 Vue 2.7 写法，计算属性处理 URL，Watch 处理双向绑定。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">&lt;script setup&gt;
<span class="hljs-keyword">import</span> { ref, watch, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">visible</span>: <span class="hljs-title class_">Boolean</span>,
  <span class="hljs-attr">surveyId</span>: { <span class="hljs-attr">type</span>: [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Number</span>], <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> },
  <span class="hljs-attr">title</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>, <span class="hljs-attr">default</span>: <span class="hljs-string">'外部页面'</span> }
});

<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'update:visible'</span>, <span class="hljs-string">'close'</span>]);

<span class="hljs-keyword">const</span> dialogVisible = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>);

<span class="hljs-keyword">const</span> surveyUrl = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-string">`/wj/<span class="hljs-subst">${props.surveyId}</span>`</span>);

<span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">visible</span>, <span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> {
  dialogVisible.<span class="hljs-property">value</span> = val;
  <span class="hljs-keyword">if</span> (val) loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
});

<span class="hljs-title function_">watch</span>(dialogVisible, <span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> {
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">'update:visible'</span>, val);
});

<span class="hljs-keyword">const</span> <span class="hljs-title function_">onIframeLoad</span> = (<span class="hljs-params"/>) =&gt; {
  loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClose</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">emit</span>(<span class="hljs-string">'close'</span>);
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-4">3. 样式处理（命名空间隔离法）</h2>
<p>由于 <code>append-to-body</code> 将 DOM 移出了组件作用域，我们放弃 <code>scoped</code>，转而使用<strong>全局样式</strong>。为了防止污染全局，我们将所有样式严格包裹在 <code>custom-class</code> 定义的唯一类名中。</p>
<h3 data-id="heading-5">CSS 实现原理</h3>
<ol>
<li><strong>去掉 <code>scoped</code></strong>：让样式变为全局可见。</li>
<li><strong>顶层包裹</strong>：所有规则必须写在 <code>.survey-portal-dialog</code> 内部。</li>
<li><strong>覆盖 Element UI</strong>：直接选中 <code>.el-dialog__body</code> 进行重置。</li>
</ol>
<pre><code class="hljs language-SCSS" lang="SCSS">&lt;style lang="scss"&gt;
<span class="hljs-comment">/* * 注意：不加 scoped 
 * 通过 ".survey-portal-dialog" 这个唯一类名实现逻辑隔离
 */</span>
<span class="hljs-selector-class">.survey-portal-dialog</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;

  <span class="hljs-comment">/* 1. 修正头部样式 */</span>
  <span class="hljs-selector-class">.el-dialog__header</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span> <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ebeef5</span>;
  }

  <span class="hljs-comment">/* 2. 暴力清除 Body 内边距，实现全屏无缝 */</span>
  <span class="hljs-selector-class">.el-dialog__body</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  }

  <span class="hljs-comment">/* 3. 内部 Iframe 容器高度计算 */</span>
  <span class="hljs-selector-class">.iframe-wrapper</span> {
    <span class="hljs-comment">/* 减去 Header 高度(约54px)，避免出现双重滚动条 */</span>
    <span class="hljs-attribute">height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100vh</span> - <span class="hljs-number">54px</span>);
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
  }
}
&lt;/style&gt;
</code></pre>
<h2 data-id="heading-6">4. 方案优劣分析</h2>
<ul>
<li>
<p><strong>优点</strong>：</p>
<ul>
<li><strong>极度稳定</strong>：不受 Vue Loader 版本或 <code>scoped</code> 穿透语法（<code>/deep/</code> vs <code>::v-deep</code>）变更的影响。</li>
<li><strong>符合直觉</strong>：完美兼容 <code>append-to-body</code> 的 DOM 移动行为。</li>
</ul>
</li>
<li>
<p><strong>注意点</strong>：</p>
<ul>
<li><strong>命名唯一性</strong>：必须保证 <code>survey-portal-dialog</code> 这个类名在项目中是唯一的，避免与其他弹窗冲突。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-7">5. 总结</h2>
<p>在处理 Element UI 的 <code>append-to-body</code> 弹窗时，“全局样式 + 唯一类名包裹”是最简单且副作用最小的方案。它通过 CSS 选择器的嵌套规则，手动建立了一个“样式沙箱”，既解决了全屏覆盖问题，又规避了全局污染风险。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个月手搓 JavaScript runtime]]></title>    <link>https://juejin.cn/post/7603393977476546586</link>    <guid>https://juejin.cn/post/7603393977476546586</guid>    <pubDate>2026-02-06T07:08:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603393977476546586" data-draft-id="7603393977476530202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 一个月手搓 JavaScript runtime"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-02-06T07:08:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             一个月手搓 JavaScript runtime
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:08:17.000Z" title="Fri Feb 06 2026 07:08:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fthemackabu.dev%2Fblog%2Fjs-in-one-month" target="_blank" title="https://themackabu.dev/blog/js-in-one-month" ref="nofollow noopener noreferrer">building a javascript runtime in one month</a></p>
<p>作者：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthemackabu" target="_blank" title="https://github.com/themackabu" ref="nofollow noopener noreferrer">themackabu</a></p>
<p>日期：2026年1月2日</p>
<p>翻译：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN" target="_blank" title="https://github.com/TUARAN" ref="nofollow noopener noreferrer">TUARAN</a></p>
<p>欢迎关注 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn" ref="nofollow noopener noreferrer">前端周刊</a>，每周更新国外论坛的前端热门文章，紧跟时事，掌握前端技术动态。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">TL;DR</h2>
<p>我做了一个叫 <strong>Ant</strong> 的小型 JavaScript runtime（大概 2MB）。源码、测试和文档都在 GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthemackabu%2Fant%2F" target="_blank" title="https://github.com/themackabu/ant/" ref="nofollow noopener noreferrer">github.com/themackabu/…</a>。</p>
<hr/>
<p>我在 11 月初开始做这个项目时，脑子里只有一个简单念头：</p>
<p>如果能做一个足够小、能嵌进 C 程序里，但又足够完整、能跑真实代码的 JavaScript 引擎，会怎么样？</p>
<p>一个你可以发布出去、却不用捆上几百 MB 的 V8 或 Node 的东西。我以前也试过做“极简版 Deno”的路子，但始终不够。</p>
<p>我没想到这会花一个月；更没想到一个月真的做得出来。但不设 deadline 的项目有个特点：你会一直往前推，推着推着就做出来了。</p>
<h2 data-id="heading-1">第一周：纯纯生存模式</h2>
<p>我是一边做一边学——说白了就是不断试错，然后把每一个错误也一起“发布”出去。最开始的工作只围绕最基本的东西：</p>
<ul>
<li>数值运算</li>
<li>字符串内建函数</li>
<li>一个非常粗糙的 CommonJS 模块系统</li>
</ul>
<p>每一次提交都像是在虚无里抢回一点点地盘。</p>
<p>最核心的问题是 <strong>解析（parsing）</strong>。在其它东西能工作之前，你必须先有 parser。而 parser 往往比看起来复杂得多。JavaScript 这种语言尤其“诡异”：</p>
<ul>
<li>自动分号插入（ASI）是规范的一部分，你得处理</li>
<li><code>this</code> 的绑定会随上下文变化</li>
<li><code>var</code> 的提升（hoisting）意味着变量会在赋值前就“存在”</li>
<li>甚至 <code>window.window.window</code> 这种写法都是合法的……</li>
</ul>
<p>我前几天做的主要是把基本流程跑通，类似一个“能算数、也能调用函数”的计算器。由于动量已经起来了，我就一直继续。</p>
<p>runtime 的核心数据表示大概长这样：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-type">uint64_t</span> <span class="hljs-type">jsval_t</span>;
</code></pre>
<p>在这个 runtime 里，每一个 JavaScript 值都用一个 64 位整数表示：<strong>NaN-boxing</strong>。</p>
<p>IEEE 754 浮点规范有个“洞”：理论上存在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>53</mn></msup></mrow><annotation encoding="application/x-tex">2^{53}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">53</span></span></span></span></span></span></span></span></span></span></span></span></span> 种 NaN，其中绝大多数从来不会被用到。所以我把它们“偷”来用了。</p>
<p>如果把一个 64 位值按 double 解释时它看起来像 NaN，同时 exponent 与 mantissa 又满足你定义的模式，那么你就可以在这些 bit 里塞一个 tag。你有足够空间同时存一个指针和一个类型标签：把对象引用和类型 tag 一起塞进 64 bit，瞬间所有 JS 值都能塞进一个 machine word。</p>
<p>编译期断言也证明了前提：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">_Static_assert</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>) == <span class="hljs-number">8</span>, <span class="hljs-string">"NaN-boxing requires 64-bit IEEE 754 doubles"</span>);
<span class="hljs-keyword">_Static_assert</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>) == <span class="hljs-number">8</span>, <span class="hljs-string">"NaN-boxing requires 64-bit integers"</span>);
<span class="hljs-keyword">_Static_assert</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>) == <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>), <span class="hljs-string">"double and uint64_t must have same size"</span>);
</code></pre>
<p>这就成了 runtime 表示“一切”的心脏：每个数字、对象、字符串、函数、Promise、参数、作用域……全部都是一个 <code>jsval_t</code>。</p>
<p>没有“带标签联合体”、没有 vtable、也不需要额外分配元数据——只有 bits。为了把它调顺，我迭代了好几天；但一旦跑通，其它东西就会更快更顺。NaN 和 Infinity 当然也有坑，不过通过微调 boxing 布局也能解决。</p>
<p>大约第 4 天我让变量能用了，第 5 天函数能用了，第 6 天循环能跑了。早期提交非常散：箭头函数、IIFE、可选链、空值合并……我就是一边翻 MDN 一边想起啥加啥。</p>
<h2 data-id="heading-2">垃圾回收（GC）灾难</h2>
<p>然后就撞上了真正的硬骨头：<strong>内存管理</strong>。</p>
<p>一个 JavaScript runtime 必须有 GC，你不可能要求用户手动 free 对象。所以到第二周左右，我开始尝试自己实现 GC。</p>
<p>结果是一场噩梦：</p>
<ul>
<li>我加新特性会把 GC 搞崩</li>
<li>我修 GC 又会把性能搞崩</li>
<li>我试着接入别人写的 GC，又发现集成复杂到不可控</li>
</ul>
<p>这段时间我非常痛苦。手写的 free-list GC 被我开开关关上百次，每次都能把另一个核心模块弄坏。有些日子我明显已经快崩了：凌晨三点 debug，试图弄清为什么协程栈没被保护好、为什么内存泄漏、为什么加了 JSON 支持之后一切都坏了。</p>
<p>转折点是：<strong>放弃手写 GC，改用 bdwgc</strong>。</p>
<p>这是一个生产级 GC（很多语言都在用）。我把它和自己手写的“带前向引用跟踪的内存压缩”结合起来：它能做 mark、能做 forwarding 的哈希表、能做生产 GC 会做的所有事。</p>
<p>一旦集成上去，内存问题大部分就消失了。我写代码的“语气”也变了：东西开始更稳定地工作起来，我加了 <code>process</code> 模块、把错误信息做得更友好——速度从这里开始明显加快。</p>
<h2 data-id="heading-3">Promise / async：另一个野兽</h2>
<p>你以为 async/await 很简单，直到你尝试自己实现它。</p>
<p>要实现 async/await，你需要 Promise；Promise 需要 microtask 与定时器；microtask 与定时器又需要事件循环；事件循环还要有地方存异步操作的状态。</p>
<p>我为这件事折腾了好几天：</p>
<ul>
<li>想让 async 工作，你需要协程</li>
<li>协程需要调度</li>
<li>调度需要事件循环</li>
<li>事件循环还要知道协程什么时候结束</li>
</ul>
<p>如果协程在等 I/O，你不能阻塞；如果某个协程死了，它也不该把整个系统拖死。</p>
<p>你看提交历史就能感受到痛苦：<em>"async promise pushback"</em>、<em>"segfault when event loop empty"</em>、<em>"prevent dead task from blocking"</em>……这些坑都是做到一半才会冒出来的。</p>
<p>更要命的是：JS Promise 不能“简化”。它必须支持 <code>.then()</code> 链式调用，必须正确 reject，还要能与 async function 配合——而 async function 本质上是 generator 的语法糖，而 generator 又是 Promise 与回调的语法糖……</p>
<p>大约第 10 天，我引入了 <strong>minicoro</strong> 作为协程支持。这个决定大概救了整个项目。minicoro 很优雅：你定义基于栈的协程，然后让系统在它们之间切换。有了协程，我终于能让 async 真正跑起来。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">coroutine</span> {</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">js</span> *<span class="hljs-title">js</span>;</span>
	<span class="hljs-type">coroutine_type_t</span> type;
	<span class="hljs-type">jsval_t</span> scope;
	<span class="hljs-type">jsval_t</span> this_val;
	<span class="hljs-type">jsval_t</span> awaited_promise;
	<span class="hljs-type">jsval_t</span> result;
	<span class="hljs-type">jsval_t</span> async_func;
	<span class="hljs-type">jsval_t</span> *args;
	<span class="hljs-type">int</span> nargs;
	<span class="hljs-type">bool</span> is_settled;
	<span class="hljs-type">bool</span> is_error;
	<span class="hljs-type">bool</span> is_done;
	<span class="hljs-type">jsoff_t</span> resume_point;
	<span class="hljs-type">jsval_t</span> yield_value;
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">coroutine</span> *<span class="hljs-title">prev</span>;</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">coroutine</span> *<span class="hljs-title">next</span>;</span>
	mco_coro* mco;
	<span class="hljs-type">bool</span> mco_started;
	<span class="hljs-type">bool</span> is_ready;
} <span class="hljs-type">coroutine_t</span>;
</code></pre>
<p>所有 async 执行相关的信息都塞进了这个结构：scope、<code>this</code>、正在等待哪个 promise、是否出错……接着我只需要调度这些东西并管理事件循环。</p>
<p>有了协程以后，Promise 才“成真”：<code>.then()</code> 链能跑，<code>await</code> 会真正暂停并在之后恢复执行。runtime 的 async 侧开始成形。后面我再补齐 Promise 内建时就快很多了，因为最难的那部分已经解决。</p>
<h2 data-id="heading-4">JavaScript 的“诡异边缘案例”</h2>
<p>中间两周基本就是：不停发现 JavaScript 比我预想中更诡异。</p>
<p>不可配置属性、freeze/seal、可选链的边缘语义、严格模式……听起来都不难，但每一个背后都是几十年的规范细节，真实世界的代码会依赖这些行为。</p>
<p>我一个个啃过去：</p>
<ul>
<li>处理冻结/密封对象</li>
<li>支持不可配置属性</li>
<li>第 10 次修解构</li>
<li>给属性查找加 getter/setter 的访问器支持</li>
</ul>
<p>每天都在撞一个新边缘案例。有时候一天修好几个：我实现一个功能、跑一致性测试、发现三个 bug、修完之后又冒出五个新 bug。</p>
<p>你知道 JavaScript 有多少种方式访问原型链吗？</p>
<ul>
<li><code>__proto__</code></li>
<li><code>Object.getPrototypeOf()</code></li>
<li><code>Object.setPrototypeOf()</code></li>
<li><code>[[Prototype]]</code> 内部槽</li>
</ul>
<p>你得把它们全部做对，而且还要彼此一致。一个看起来很短的提交信息，比如 “use descriptor tables for getters/setters/properties”，背后可能就是几周的工作。</p>
<p>解构看起来也很简单：<code>const [a, b] = arr</code>。</p>
<p>但稀疏数组怎么办？对象的可枚举属性怎么办？嵌套解构、默认值、<code>...rest</code> 参数怎么办？每次修一个点都像打地鼠：修好这里，那里又坏。</p>
<p>一致性测试在“最好的意义上”非常残酷：每次跑都会失败在一个我根本不知道存在的语义上。然后我修掉它，继续失败在下一个。这个循环发生了几十次。</p>
<h2 data-id="heading-5">后半程：开始变得“能用”</h2>
<p>第二周时，我已经有了一个能执行代码的 JavaScript runtime。它不完整，但它是真的。</p>
<p>然后我开始加那些让它变得“有用”的东西：文件系统、路径工具、URL 模块、以及那个因为 Bun 而变得很有名的内建 HTTP server。突然之间，<strong>真实程序</strong>开始能在 Ant 上跑了。</p>
<p>比如一个 Web 服务器只要写：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { join } <span class="hljs-keyword">from</span> <span class="hljs-string">'ant:path'</span>;
<span class="hljs-keyword">import</span> { readFile } <span class="hljs-keyword">from</span> <span class="hljs-string">'ant:fs'</span>;
<span class="hljs-keyword">import</span> { createRouter, addRoute, findRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'rou3'</span>;

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>();

<span class="hljs-title function_">addRoute</span>(router, <span class="hljs-string">'GET'</span>, <span class="hljs-string">'/status/:id'</span>, <span class="hljs-keyword">async</span> c =&gt; {
	<span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>));

	<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'Hello'</span>);
	<span class="hljs-keyword">const</span> name = <span class="hljs-keyword">await</span> <span class="hljs-title function_">readFile</span>(<span class="hljs-title function_">join</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">dirname</span>, <span class="hljs-string">'name.txt'</span>));

	<span class="hljs-keyword">const</span> base = <span class="hljs-string">'{{name}} {{version}} server is responding with'</span>;
	<span class="hljs-keyword">const</span> data = { name, <span class="hljs-attr">version</span>: <span class="hljs-title class_">Ant</span>.<span class="hljs-title function_">version</span>() };

	<span class="hljs-keyword">return</span> c.<span class="hljs-property">res</span>.<span class="hljs-title function_">body</span>(<span class="hljs-string">`<span class="hljs-subst">${base.template(data)}</span> <span class="hljs-subst">${result}</span> <span class="hljs-subst">${c.params.id}</span>!`</span>);
});

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">c</span>) {
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'request:'</span>, c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span>, c.<span class="hljs-property">req</span>.<span class="hljs-property">uri</span>);
	<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">findRoute</span>(router, c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span>, c.<span class="hljs-property">req</span>.<span class="hljs-property">uri</span>);

	<span class="hljs-keyword">if</span> (result?.<span class="hljs-property">data</span>) {
		c.<span class="hljs-property">params</span> = result.<span class="hljs-property">params</span>;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> result.<span class="hljs-title function_">data</span>(c);
	}

	c.<span class="hljs-property">res</span>.<span class="hljs-title function_">body</span>(<span class="hljs-string">'not found: '</span> + c.<span class="hljs-property">req</span>.<span class="hljs-property">uri</span>, <span class="hljs-number">404</span>);
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'started on http://localhost:8000'</span>);
<span class="hljs-title class_">Ant</span>.<span class="hljs-title function_">serve</span>(<span class="hljs-number">8000</span>, handleRequest);
</code></pre>
<p>运行起来就是：</p>
<pre><code class="hljs language-bash" lang="bash">$ ant examples/server/server.js
started on http://localhost:8000

$ curl http://localhost:8000/status/world
Ant 0.3.2.6 server is responding with Hello world!
</code></pre>
<p>这就是“真 JavaScript”跑在 Ant 里：async/await、文件 I/O、HTTP、带参数路由、网络、字符串操作。</p>
<p>之后节奏更快：每天更自信，修更多 bug，加更多特性。然后到了“冷门但必须”的阶段：Proxy、Reflection、Symbol，甚至 class 私有字段/方法。它们也许很少人用，但规范里写了就得支持。</p>
<p>我最喜欢的一类能力之一是 <strong>Atomics</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> sharedBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedArrayBuffer</span>(<span class="hljs-number">256</span>);

<span class="hljs-keyword">const</span> int32View = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Int32Array</span>(sharedBuffer);
<span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">store</span>(int32View, <span class="hljs-number">0</span>, <span class="hljs-number">42</span>);
<span class="hljs-keyword">const</span> value = <span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">load</span>(int32View, <span class="hljs-number">0</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'stored 42, loaded:'</span>, value);

<span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">store</span>(int32View, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>);
<span class="hljs-keyword">const</span> oldValue = <span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">add</span>(int32View, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'old value:'</span>, oldValue);

<span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">store</span>(int32View, <span class="hljs-number">2</span>, <span class="hljs-number">100</span>);
<span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">compareExchange</span>(int32View, <span class="hljs-number">2</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'exchanged, new value:'</span>, <span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">load</span>(int32View, <span class="hljs-number">2</span>));
</code></pre>
<pre><code class="hljs language-bash" lang="bash">$ ant examples/atomics.js
stored 42, loaded: 42
old value: 10
exchanged, new value: 200
</code></pre>
<h2 data-id="heading-6">最后一周：多米诺骨牌一样倒下</h2>
<p>当 Ant 的核心 runtime 能跑、GC 稳了、Promise 也通了之后，其它东西就像多米诺骨牌一样：小问题被修掉、缺的方法补齐、边缘语义逐个处理。</p>
<p>我重新加回了数组 length 校验，修了对象的属性缓存失效逻辑；为了优化 hash 性能又掉进“复杂算法 + 安全影响”的兔子洞——因为我已经在打磨一个“能工作的东西”。</p>
<p>到第 28 天，我给一个真的能用的 runtime 收尾：支持 async/await、靠谱的内存管理、网络、文件 I/O、并通过 ES1–ES5 的一致性测试，还混搭了一堆更现代的特性。</p>
<p>我甚至在别人提醒之后才“想起来”打开 LTO 和一些编译器 flag 😅</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d32e5b0a1cb44e182e79748dda03079~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966501&amp;x-signature=Pjjr%2F0zBH5skHvHX9z%2BMnmjHcO8%3D" alt="uzaaft" loading="lazy"/></p>
<h2 data-id="heading-7">最终结果</h2>
<p>一个月后，Ant 作为 JavaScript runtime：</p>
<ul>
<li>通过 javascript-zoo 测试套件中 ES1 到 ES5 的每一个一致性测试（25 年规范跨度的完整兼容）</li>
<li>实现 async/await，并具备正确的 Promise 与 microtask 行为</li>
<li>拥有一个真的能用、且不漏内存的 GC</li>
<li>基于 libuv 运行 Web 服务器（和 Node 类似的网络底座）</li>
<li>支持通过 FFI 调用系统库，例如：</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { dlopen, suffix, <span class="hljs-title class_">FFIType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'ant:ffi'</span>;

<span class="hljs-keyword">const</span> sqlite3 = <span class="hljs-title function_">dlopen</span>(<span class="hljs-string">`libsqlite3.<span class="hljs-subst">${suffix}</span>`</span>);

sqlite3.<span class="hljs-title function_">define</span>(<span class="hljs-string">'sqlite3_libversion'</span>, {
	<span class="hljs-attr">args</span>: [],
	<span class="hljs-attr">returns</span>: <span class="hljs-title class_">FFIType</span>.<span class="hljs-property">string</span>
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`version: <span class="hljs-subst">${sqlite3.sqlite3_libversion()}</span>`</span>);
</code></pre>
<pre><code class="hljs language-bash" lang="bash">$ ant examples/ffi/basic/sqlite.js
version: 3.43.2
</code></pre>
<ul>
<li>支持读写文件与异步 I/O</li>
<li>支持正确的作用域、提升、变量遮蔽</li>
<li>支持 class、箭头函数、解构、展开、模板字符串、可选链</li>
<li>覆盖一些多数人根本不会想到的“怪边缘”：<code>__proto__</code> 赋值、属性描述符、不可配置属性、冻结/密封对象（可参考测试：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthemackabu%2Fant%2Fblob%2Fmaster%2Ftests%2F__proto__.js" target="_blank" title="https://github.com/themackabu/ant/blob/master/tests/__proto__.js" ref="nofollow noopener noreferrer"><code>tests/__proto__.js</code></a>）</li>
<li>实现 ES Module（import / export）</li>
<li>支持 Symbol、Proxy、Reflect、WeakMap/WeakSet、Map/Set</li>
<li>支持共享内存与 Atomics 并发原语</li>
</ul>
<p>把这些串起来，你会发现你面对的已经几乎是一个“完整的 JavaScript runtime”，不太像玩具。</p>
<h2 data-id="heading-8">代价</h2>
<p>我不知道代价是什么。</p>
<p>可能是睡眠，可能是健康，可能是本来可以拿去做任何其它事情的大把时间。</p>
<p>有些日子我连续工作 10+ 小时；有些日子一天 20+ commits。项目不会减速，只会加速：每天更自信、更快、修更多 bug、加更多特性。</p>
<p>到最后，我开始撞上那些必须去读 ECMAScript 规范、去理解 V8 行为、去对比其它引擎怎么处理某个怪角落的工作。改符号计数、优化 class、把内部属性迁移到 slots（像 V8 那样）……这类优化正常应该等代码稳定后再做，但因为地基已经稳了，我在最后一周反而有了余力去做。</p>
<h2 data-id="heading-9">发布后：优化阶段</h2>
<p>首个 release 是 11 月 26 日。之后是一段沉默——那种“发完版本之后就没声了”的沉默。直到 12 月 20 日左右，开发又恢复。</p>
<p>这一次不同：runtime 能跑、能过测试，但总有更多优化空间。xctrace 让我看清什么才是真正的瓶颈。12 月下旬和 1 月初的提交呈现一种模式：找到瓶颈 → 修复 → 测量提升。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/066c3f4daf4a42bf811380a18180ce41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966501&amp;x-signature=iLb1Fg4MH9%2B8wsdBhOBHdyxUrGI%3D" alt="fast" loading="lazy"/></p>
<p>我先为 typed array 加了 arena allocator。之前 typed array 散落在 heap 的各处；我把它们集中起来，加速分配并改善 cache locality。</p>
<p>然后我把 getter/setter/property 从“每个 descriptor 单独分配”改成“descriptor table 批处理”：更少的分配、更少的指针追逐。</p>
<p>让 <code>.</code> 运算符支持 property reference 也很烦：每次查属性都要全量解析；于是我加了 reference table 跳过重复工作。</p>
<p>我很喜欢 dispatch table。我把 FFI、JSON 等路径改为 computed goto，让 CPU 直接跳到正确的 handler：少一次分支、少一次查找。</p>
<p>把 properties 迁到 slots 是最侵入的一次重构。对象之前用的是灵活但慢的属性系统；slots 则是按对象类型固定结构，让 runtime 能做更多假设，减少 indirection。</p>
<p>某个时刻我开始拿它对比 Node：跑同样 benchmark，Ant 表现如何？结果开始变得很好——好到你会想：我是不是能在某些点上赢 Node？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9db5280b5f3f4835b5b4e4af63a7ae63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966501&amp;x-signature=iYGhJDm9lr9CzROb%2FRPV3m5ER58%3D" alt="bunnerfly wow" loading="lazy"/></p>
<p>优化 Ant 的过程中我会保留一些可工作的 snapshot：如果某次优化把东西搞坏了，我还能退回到一个稳定点。于是就能持续小步推进：每次提交都比上一次快一点。有些优化有效，有些没用，但整体模式始终成立：profile → optimize → measure → commit。</p>
<p>然后是 GC 的改进。在最初那一个月里 bdwgc 集成得挺好，但在优化阶段的某个时刻它被禁掉了，runtime 就开始漏内存。我重新加回“可延迟 GC”的机制，并把旧 GC 的大部分代码取消注释。</p>
<p>但这次不是老办法：我做的是一个 mark-copy + compact 的 GC，能真正做内存碎片整理。旧 GC 的问题是它在错误的时机运行，导致热路径卡顿。所以我让它“可延迟”：在逻辑工作单元之间再收集；同时用前向引用跟踪保证对象移动后指针不坏。GC 回来了，但更聪明：它会等到合适的点暂停，并在运行时压缩堆。</p>
<h2 data-id="heading-10">为什么会做这件事</h2>
<p>老实说，我也不知道。</p>
<p>也许是赌气？也许是想证明点什么？也许是纯粹的执念。</p>
<p>那种“进入心流”的状态：你写着写着，八小时就过去了，已经凌晨四点，然后你把代码 commit 掉，第二天又继续。</p>
<p>这个项目之所以存在，是因为我脑子里某个东西决定“它必须存在”，并且直到它真的存在之前都不会停。</p>
<p>它并不完美。代码里可能还有没发现的 bug；可能还有没做的性能优化；可能还有漏掉的规范角落。</p>
<p>但它能跑：你可以写真实 JavaScript，它会执行；你可以用 async/await；你可以写服务器；你可以拿它去做真实事情。</p>
<p>如果你曾经好奇：一个人如果足够执着、又不睡觉，能做到什么？答案就是：做出一个规范兼容的 JavaScript 引擎。</p>
<p>源码、测试与文档都在：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthemackabu%2Fant%2F" target="_blank" title="https://github.com/themackabu/ant/" ref="nofollow noopener noreferrer">github.com/themackabu/…</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《TanStack Start 深入解析：Single Flight Mutations 机制（第二篇）》]]></title>    <link>https://juejin.cn/post/7603352117638856713</link>    <guid>https://juejin.cn/post/7603352117638856713</guid>    <pubDate>2026-02-06T07:34:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603352117638856713" data-draft-id="7603352117638791177" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《TanStack Start 深入解析：Single Flight Mutations 机制（第二篇）》"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2026-02-06T07:34:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《TanStack Start 深入解析：Single Flight Mutations 机制（第二篇）》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:34:19.000Z" title="Fri Feb 06 2026 07:34:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fsingle-flight-mutations-in-tanstack-start-part-2%2F" target="_blank" title="https://frontendmasters.com/blog/single-flight-mutations-in-tanstack-start-part-2/" ref="nofollow noopener noreferrer">Single Flight Mutations in TanStack Start: Part 2</a></p>
<p>作者：Adam Rackis</p>
<p>日期：2026年1月28日</p>
<p>翻译：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN" target="_blank" title="https://github.com/TUARAN" ref="nofollow noopener noreferrer">TUARAN</a></p>
<p>欢迎关注 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn" ref="nofollow noopener noreferrer">前端周刊</a>，每周更新国外论坛的前端热门文章，紧跟时事，掌握前端技术动态。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">TL;DR</h2>
<p>这篇文章延续 Part 1 的思路：把一次 mutation 所需的 UI 更新数据，在同一次网络往返里一起带回来（避免 mutation 后再额外发请求 refetch）。</p>
<p>Part 2 的重点是把“要 refetch 哪些查询”抽成可复用的 middleware：调用 server function 时传入 react-query 的 <code>QueryKey[]</code>，middleware 会在客户端从 Query Cache 找到每个 query 对应的 <code>serverFn</code> 和参数，把这些信息通过 <code>sendContext</code> 送到服务端统一执行，然后把结果回传给客户端并用 <code>setQueryData</code> 写回缓存。</p>
<hr/>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fsingle-flight-mutations-in-tanstack-start-part-1%2F" target="_blank" title="https://frontendmasters.com/blog/single-flight-mutations-in-tanstack-start-part-1/" ref="nofollow noopener noreferrer">Part 1</a> 里，我们聊过 single flight mutations：它让你在更新数据时，同时把 UI 需要的所有相关“已更新数据”重新获取回来，并且整个过程只需要一次跨网络的往返。</p>
<p>我们当时做了个很朴素的实现：在“更新数据”的 server function 里直接把需要的东西 refetch 一遍。它确实能用，但可扩展性和灵活性都一般（耦合也偏重）。</p>
<p>这篇文章我们会实现同样的效果，但方式更通用：定义一个“refetch middleware”，把它挂到任意 server function 上。这个 middleware 允许我们通过 react-query 的 key 指定要 refetch 的数据，剩下的事情它会自动完成。</p>
<p>我们会先做一个最简单版本，然后不断加能力、加灵活性。到最后会稍微复杂一些，但请别误会：你不需要把文中讲的全部都用上。事实上，对绝大多数应用来说，single flight mutations 可能完全无关紧要。更别被“高级做法”迷惑了：对很多小应用而言，直接在 server function 里 refetch 一点数据可能就足够了。</p>
<p>不过，跟着做一遍，我们会看到一些很酷的 TanStack（甚至 TypeScript）特性。即便你永远不用 single flight mutations，这些内容也很可能在别的场景派上用场。</p>
<h2 data-id="heading-1">我们的第一个 Middleware</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Fquery%2Flatest" target="_blank" title="https://tanstack.com/query/latest" ref="nofollow noopener noreferrer">TanStack Query</a>（我们有时也会称它为 react-query，这是它的包名）已经有一套非常好用的层级 key 系统。如果我们的 middleware 能直接接收“要 refetch 的 query keys”，然后就……自动搞定，那该多好？</p>
<p>问题在于：middleware 要怎么知道“怎么 refetch”呢？第一眼看确实有点难。我们的 queries（刻意保持简单）本质上都是对 server functions 的调用。但我们没法把一个普通函数引用传到服务端；函数不可序列化，这很合理。你能把字符串/数字/布尔值序列化成 JSON 在线上传输，但一个函数可能带状态、闭包、上下文……传过去根本说不清。</p>
<p>除非——它是 TanStack Start 的 server function。</p>
<p>这个项目背后的工程师们为序列化引擎做了定制，使其支持 server functions。也就是说：你可以从客户端把一个 server function “发到”服务端，它能正常工作。底层原理是：server functions 有一个内部 ID。TanStack 会捕捉到它、发送 ID，然后在另一端把 ID 反序列化成对应的 server function。</p>
<p>为了让事情更简单，我们不妨把 server function（以及它需要的参数）直接放到我们已经定义好的 query options 上。这样 middleware 只要拿到 query keys，就能从 TanStack Query 的 cache 里找到对应的 query options，拿到“如何 refetch”的信息，然后把整个流程串起来。</p>
<h2 data-id="heading-2">开始吧</h2>
<p>首先引入一些好用的东西：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { createMiddleware, getRouterInstance } <span class="hljs-keyword">from</span> <span class="hljs-string">"@tanstack/react-start"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">QueryClient</span>, <span class="hljs-title class_">QueryKey</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@tanstack/react-query"</span>;
</code></pre>
<p>接着更新我们的 epics 列表查询（主要的 epics 列表）的 query options：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">epicsQueryOptions</span> = (<span class="hljs-params">page: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryOptions</span>({
    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>, page],
    <span class="hljs-attr">queryFn</span>: <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getEpicsList</span>({ <span class="hljs-attr">data</span>: page });
      <span class="hljs-keyword">return</span> result;
    },
    <span class="hljs-attr">staleTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
    <span class="hljs-attr">gcTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">__revalidate</span>: {
        <span class="hljs-attr">serverFn</span>: getEpicsList,
        <span class="hljs-attr">arg</span>: page,
      },
    },
  });
};
</code></pre>
<p>注意这个新增的 <code>meta</code> 区块。它允许我们往 query 上塞任何我们需要的元数据。这里我们放了 <code>getEpicsList</code> 这个 server function 的引用以及它需要的参数。这样写确实会有“重复”（<code>queryFn</code> 写了一次调用方式，<code>meta</code> 又写了一次），如果你觉得别扭，先别急，后面会处理。summary 查询（用于统计数量）我们也会同样更新，不过这里没贴代码。</p>
<p>接下来我们把 middleware 一点点拼出来：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// the server function and args are all `any`, for now, </span>
<span class="hljs-comment">// to keep things simple we'll see how to type them in a bit</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">RevalidationPayload</span> = {
  <span class="hljs-attr">refetch</span>: {
    <span class="hljs-attr">key</span>: <span class="hljs-title class_">QueryKey</span>;
    <span class="hljs-attr">fn</span>: <span class="hljs-built_in">any</span>;
    <span class="hljs-attr">arg</span>: <span class="hljs-built_in">any</span>;
  }[];
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">RefetchMiddlewareConfig</span> = {
  <span class="hljs-attr">refetch</span>: <span class="hljs-title class_">QueryKey</span>[];
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> refetchMiddleware = <span class="hljs-title function_">createMiddleware</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"function"</span> })
  .<span class="hljs-title function_">inputValidator</span>(<span class="hljs-function">(<span class="hljs-params">config?: RefetchMiddlewareConfig</span>) =&gt;</span> config)
  .<span class="hljs-title function_">client</span>(<span class="hljs-keyword">async</span> ({ next, data }) =&gt; {
    <span class="hljs-keyword">const</span> { refetch = [] } = data ?? {};
</code></pre>
<p>我们为 middleware 定义了一个输入。这个输入会自动与“挂载该 middleware 的 server function 的输入”合并。</p>
<p>我们把输入写成可选的（<code>config?</code>），因为完全可能出现这种情况：你只想调用 server function，但并不想 refetch 任何东西。</p>
<p>然后开始写 <code>.client</code> 回调（在浏览器中运行）：先拿到要 refetch 的 keys：</p>
<p><code>const { refetch = [] } = data ?? {};</code></p>
<p>接着我们拿到 <code>queryClient</code> 和它的 cache，并创建一个 payload，之后会通过 <code>sendContext</code> 发到 <code>.server</code> 回调，让它执行真正的 refetch。</p>
<p>如果你对 TanStack middleware 不熟，我之前写的 <a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fintroducing-tanstack-start-middleware%2F" target="_blank" title="https://frontendmasters.com/blog/introducing-tanstack-start-middleware/" ref="nofollow noopener noreferrer">middleware 文章</a> 可能会更适合作为入门。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> router = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRouterInstance</span>();
<span class="hljs-keyword">const</span> <span class="hljs-attr">queryClient</span>: <span class="hljs-title class_">QueryClient</span> = router.<span class="hljs-property">options</span>.<span class="hljs-property">context</span>.<span class="hljs-property">queryClient</span>;
<span class="hljs-keyword">const</span> cache = queryClient.<span class="hljs-title function_">getQueryCache</span>();

<span class="hljs-keyword">const</span> <span class="hljs-attr">revalidate</span>: <span class="hljs-title class_">RevalidationPayload</span> = {
  <span class="hljs-attr">refetch</span>: [],
};
</code></pre>
<p>我们的 <code>queryClient</code> 已经挂在 TanStack router 的 context 上，所以只要拿到 router 再取出来即可。</p>
<p>还记得我们把 <code>__revalidate</code> 塞到 query options 的 <code>meta</code> 里吗？现在我们针对每个 key 去 cache 里找对应 query，并把 <code>serverFn/arg</code> 抽出来组装成要发给服务端的 payload。</p>
<pre><code class="hljs language-ts" lang="ts">refetch.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key: QueryKey</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> entry = cache.<span class="hljs-title function_">find</span>({ <span class="hljs-attr">queryKey</span>: key, <span class="hljs-attr">exact</span>: <span class="hljs-literal">true</span> });
  <span class="hljs-keyword">if</span> (!entry) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-attr">revalidatePayload</span>: <span class="hljs-built_in">any</span> = entry?.<span class="hljs-property">meta</span>?.<span class="hljs-property">__revalidate</span> ?? <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">if</span> (revalidatePayload) {
    revalidate.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">push</span>({
      key,
      <span class="hljs-attr">fn</span>: revalidatePayload.<span class="hljs-property">serverFn</span>,
      <span class="hljs-attr">arg</span>: revalidatePayload.<span class="hljs-property">arg</span>,
    });
  }
});
</code></pre>
<p><code>if (!entry) return;</code> 是为了防止请求里包含了“当前缓存里根本不存在”的 query（也就是说，它可能从未在 UI 里被请求过）。这种情况下我们拿不到 <code>serverFn</code>，也就无法 refetch。</p>
<p>你也可以把 middleware 输入扩展得更丰富：比如对那些“无论是否在缓存里都必须执行”的 refetch，直接把 <code>serverFn + arg</code> 一起传上去。比如你打算 mutation 后 redirect，并希望新页面的数据能预取。本文不实现这个变体，但它只是同一主题的另一种组合。</p>
<p>接着我们调用 <code>next</code>，触发真正的 server function（以及其它 middleware）。通过 <code>sendContext</code> 我们把 <code>revalidate</code> 发到服务端：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
  <span class="hljs-attr">sendContext</span>: {
    revalidate,
  },
});
</code></pre>
<p><code>result</code> 是 server function 调用的返回值。它的 <code>context</code> 上会有一个 <code>payloads</code> 数组（由下方 <code>.server</code> 回调返回），其中每一项都包含 <code>key</code>（query key）和 <code>result</code>（对应数据）。我们遍历并写回 query cache。</p>
<p>我们稍后会修复这里用 <code>// @ts-expect-error</code> 遮掉的 TS 错误：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// @ts-expect-error</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> result.<span class="hljs-property">context</span>?.<span class="hljs-property">payloads</span> ?? []) {
  queryClient.<span class="hljs-title function_">setQueryData</span>(entry.<span class="hljs-property">key</span>, entry.<span class="hljs-property">result</span>);
}

<span class="hljs-keyword">return</span> result;
</code></pre>
<h2 data-id="heading-3">服务端回调</h2>
<p>服务端回调完整代码如下：</p>
<pre><code class="hljs language-ts" lang="ts">.<span class="hljs-title function_">server</span>(<span class="hljs-keyword">async</span> ({ next, context }) =&gt; {
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
    <span class="hljs-attr">sendContext</span>: {
      <span class="hljs-attr">payloads</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>[]
    }
  });

  <span class="hljs-keyword">const</span> allPayloads = context.<span class="hljs-property">revalidate</span>.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">refetchPayload</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">key</span>: refetchPayload.<span class="hljs-property">key</span>,
      <span class="hljs-attr">result</span>: refetchPayload.<span class="hljs-title function_">fn</span>({ <span class="hljs-attr">data</span>: refetchPayload.<span class="hljs-property">arg</span> })
    };
  });

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> refetchPayload <span class="hljs-keyword">of</span> allPayloads) {
    result.<span class="hljs-property">sendContext</span>.<span class="hljs-property">payloads</span>.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">key</span>: refetchPayload.<span class="hljs-property">key</span>,
      <span class="hljs-attr">result</span>: <span class="hljs-keyword">await</span> refetchPayload.<span class="hljs-property">result</span>
    });
  }

  <span class="hljs-keyword">return</span> result;
});
</code></pre>
<p>我们会立刻调用 <code>next()</code>，它会执行这个 middleware 所挂载的 server function。我们在 <code>sendContext</code> 里传入一个 <code>payloads</code> 数组：这个数组决定了“服务端最终会发回给客户端回调的数据结构”（也就是 <code>.client</code> 里循环的那份 <code>payloads</code>）。</p>
<p>然后我们遍历客户端通过 <code>sendContext</code> 传上来的 <code>revalidate</code> payload，并从 <code>context</code> 上读出来（是的：<em>send</em> context，发上来再从 context 读出来）。接着调用所有 server functions，并把结果 push 到 <code>payloads</code> 数组里。</p>
<p>把前后拼起来，这就是完整 middleware：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> refetchMiddleware = <span class="hljs-title function_">createMiddleware</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"function"</span> })
  .<span class="hljs-title function_">inputValidator</span>(<span class="hljs-function">(<span class="hljs-params">config?: RefetchMiddlewareConfig</span>) =&gt;</span> config)
  .<span class="hljs-title function_">client</span>(<span class="hljs-keyword">async</span> ({ next, data }) =&gt; {
    <span class="hljs-keyword">const</span> { refetch = [] } = data ?? {};

    <span class="hljs-keyword">const</span> router = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRouterInstance</span>();
    <span class="hljs-keyword">const</span> <span class="hljs-attr">queryClient</span>: <span class="hljs-title class_">QueryClient</span> = router.<span class="hljs-property">options</span>.<span class="hljs-property">context</span>.<span class="hljs-property">queryClient</span>;
    <span class="hljs-keyword">const</span> cache = queryClient.<span class="hljs-title function_">getQueryCache</span>();

    <span class="hljs-keyword">const</span> <span class="hljs-attr">revalidate</span>: <span class="hljs-title class_">RevalidationPayload</span> = {
      <span class="hljs-attr">refetch</span>: [],
    };

    refetch.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key: QueryKey</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> entry = cache.<span class="hljs-title function_">find</span>({ <span class="hljs-attr">queryKey</span>: key, <span class="hljs-attr">exact</span>: <span class="hljs-literal">true</span> });
      <span class="hljs-keyword">if</span> (!entry) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> <span class="hljs-attr">revalidatePayload</span>: <span class="hljs-built_in">any</span> = entry?.<span class="hljs-property">meta</span>?.<span class="hljs-property">__revalidate</span> ?? <span class="hljs-literal">null</span>;

      <span class="hljs-keyword">if</span> (revalidatePayload) {
        revalidate.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">push</span>({
          key,
          <span class="hljs-attr">fn</span>: revalidatePayload.<span class="hljs-property">serverFn</span>,
          <span class="hljs-attr">arg</span>: revalidatePayload.<span class="hljs-property">arg</span>,
        });
      }
    });

    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
      <span class="hljs-attr">sendContext</span>: {
        revalidate,
      },
    });

    <span class="hljs-comment">// @ts-expect-error</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> result.<span class="hljs-property">context</span>?.<span class="hljs-property">payloads</span> ?? []) {
      queryClient.<span class="hljs-title function_">setQueryData</span>(entry.<span class="hljs-property">key</span>, entry.<span class="hljs-property">result</span>);
    }

    <span class="hljs-keyword">return</span> result;
  })
  .<span class="hljs-title function_">server</span>(<span class="hljs-keyword">async</span> ({ next, context }) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
      <span class="hljs-attr">sendContext</span>: {
        <span class="hljs-attr">payloads</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>[],
      },
    });

    <span class="hljs-keyword">const</span> allPayloads = context.<span class="hljs-property">revalidate</span>.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">refetchPayload</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">key</span>: refetchPayload.<span class="hljs-property">key</span>,
        <span class="hljs-attr">result</span>: refetchPayload.<span class="hljs-title function_">fn</span>({ <span class="hljs-attr">data</span>: refetchPayload.<span class="hljs-property">arg</span> }),
      };
    });

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> refetchPayload <span class="hljs-keyword">of</span> allPayloads) {
      result.<span class="hljs-property">sendContext</span>.<span class="hljs-property">payloads</span>.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">key</span>: refetchPayload.<span class="hljs-property">key</span>,
        <span class="hljs-attr">result</span>: <span class="hljs-keyword">await</span> refetchPayload.<span class="hljs-property">result</span>,
      });
    }

    <span class="hljs-keyword">return</span> result;
  });
</code></pre>
<h2 data-id="heading-4">修复 TypeScript 报错</h2>
<p>为什么下面这一行是无效的？</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// @ts-expect-error</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> result.<span class="hljs-property">context</span>?.<span class="hljs-property">payloads</span> ?? []) {
</code></pre>
<p>这段代码运行在 <code>.client</code> 回调里，并且是在我们调用 <code>next()</code> 之后运行的。本质上，我们是在服务端读取“发送回客户端的数据”（通过 <code>sendContext</code> 传回来的 payload）。这段代码在运行时确实能工作，那为什么类型对不上？</p>
<p>我在上面提到的 middleware 文章里解释过：服务端回调能“看见”客户端发给它的内容，但反过来不成立。这种信息天生就不是双向可见的；类型推断也没法倒着跑。</p>
<p>解决方式很简单：把 middleware 拆成两段，让后一段 middleware 依赖前一段。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> prelimRefetchMiddleware = <span class="hljs-title function_">createMiddleware</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"function"</span> })
  .<span class="hljs-title function_">inputValidator</span>(<span class="hljs-function">(<span class="hljs-params">config?: RefetchMiddlewareConfig</span>) =&gt;</span> config)
  .<span class="hljs-title function_">client</span>(<span class="hljs-keyword">async</span> ({ next, data }) =&gt; {
    <span class="hljs-keyword">const</span> { refetch = [] } = data ?? {};

    <span class="hljs-keyword">const</span> router = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRouterInstance</span>();
    <span class="hljs-keyword">const</span> <span class="hljs-attr">queryClient</span>: <span class="hljs-title class_">QueryClient</span> = router.<span class="hljs-property">options</span>.<span class="hljs-property">context</span>.<span class="hljs-property">queryClient</span>;

    <span class="hljs-comment">// same</span>
    <span class="hljs-comment">// as</span>
    <span class="hljs-comment">// before</span>

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
      <span class="hljs-attr">sendContext</span>: {
        revalidate,
      },
    });

    <span class="hljs-comment">// those last few lines are removed</span>
  })
  .<span class="hljs-title function_">server</span>(<span class="hljs-keyword">async</span> ({ next, context }) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
      <span class="hljs-attr">sendContext</span>: {
        <span class="hljs-attr">payloads</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>[],
      },
    });

    <span class="hljs-comment">// exactly the same as before</span>

    <span class="hljs-keyword">return</span> result;
  });

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> refetchMiddleware = <span class="hljs-title function_">createMiddleware</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"function"</span> })
  .<span class="hljs-title function_">middleware</span>([prelimRefetchMiddleware]) <span class="hljs-comment">// &lt;-------- connect them!</span>
  .<span class="hljs-title function_">client</span>(<span class="hljs-keyword">async</span> ({ next }) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();

    <span class="hljs-keyword">const</span> router = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRouterInstance</span>();
    <span class="hljs-keyword">const</span> <span class="hljs-attr">queryClient</span>: <span class="hljs-title class_">QueryClient</span> = router.<span class="hljs-property">options</span>.<span class="hljs-property">context</span>.<span class="hljs-property">queryClient</span>;

    <span class="hljs-comment">// and here's those last few lines we removed from above</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> result.<span class="hljs-property">context</span>?.<span class="hljs-property">payloads</span> ?? []) {
      queryClient.<span class="hljs-title function_">setQueryData</span>(entry.<span class="hljs-property">key</span>, entry.<span class="hljs-property">result</span>);
    }

    <span class="hljs-keyword">return</span> result;
  });
</code></pre>
<p>整体逻辑不变，只是把 <code>.client</code> 回调里 <code>next()</code> 之后那部分移到了单独的 middleware 里。其余部分留在另一个 middleware 中，并作为输入传给新的这个 middleware。这样当我们在 <code>refetchMiddleware</code> 里调用 <code>next</code> 时，TypeScript 就能看到“从服务端发下来的 context 数据”，因为这些数据是在 <code>prelimRefetchMiddleware</code> 里发送的，而它又是本 middleware 的输入，因此 TS 可以完整看清类型流动。</p>
<h2 data-id="heading-5">接起来</h2>
<p>现在我们回到“更新 epic”的 server function：把之前的手动 refetch 移除，改为使用 refetch middleware。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> updateEpic = <span class="hljs-title function_">createServerFn</span>({ <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span> })
  .<span class="hljs-title function_">middleware</span>([refetchMiddleware])
  .<span class="hljs-title function_">inputValidator</span>(<span class="hljs-function">(<span class="hljs-params">obj: { id: <span class="hljs-built_in">number</span>; name: <span class="hljs-built_in">string</span> }</span>) =&gt;</span> obj)
  .<span class="hljs-title function_">handler</span>(<span class="hljs-keyword">async</span> ({ data }) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()));
    <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">update</span>(epicsTable).<span class="hljs-title function_">set</span>({ <span class="hljs-attr">name</span>: data.<span class="hljs-property">name</span> }).<span class="hljs-title function_">where</span>(<span class="hljs-title function_">eq</span>(epicsTable.<span class="hljs-property">id</span>, data.<span class="hljs-property">id</span>));
  });
</code></pre>
<p>在 React 组件中通过 <code>useServerFn</code> 来调用它；这个 hook 会自动处理错误、重定向等。</p>
<p><code>const runSave = useServerFn(updateEpic);</code></p>
<p>还记得我说过：middleware 的输入会自动与底层 server function 的输入合并吗？当我们调用这个 server function 时就能看到：</p>
<p><img alt="图 1：一个 handleSaveFinal 函数的代码片段，保存输入值并调用 runSave，参数对象包含 id 和 name。转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<p>（<code>unknown[]</code> 对 react-query 的 query key 来说就是正确类型）</p>
<p>现在我们可以这样调用它，并指定要 refetch 的查询：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">await</span> <span class="hljs-title function_">runSave</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">id</span>: epic.<span class="hljs-property">id</span>,
    <span class="hljs-attr">name</span>: newValue,
    <span class="hljs-attr">refetch</span>: [
      [<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-number">1</span>],
      [<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"summary"</span>],
    ],
  },
});
</code></pre>
<p>运行后，一切正常：epics 列表和 summary 都会在没有任何新网络请求的情况下更新。测试 single flight mutations 时，你其实不是在找“发生了什么”，而是在找“什么都没发生”——也就是 Network 面板里缺少那些本该出现的额外请求。</p>
<h2 data-id="heading-6">再改进</h2>
<p>react-query 的 query keys 是层级结构的，你可能很熟悉这种写法：</p>
<p><code>queryClient.invalidateQueries({ queryKey: ["epics", "list"] });</code></p>
<p>它会 refetch 任何 key 以 <code>["epics", "list"]</code> 开头的 queries。我们的 middleware 能不能也支持这种“key 前缀”呢？也就是只传一个 key prefix，让它找出所有匹配项并 refetch。</p>
<p>可以，开干。</p>
<p>匹配 key 会稍复杂一点：每个传入的 key 可能是 prefix，会匹配多条 cache entry，所以我们用 <code>flatMap</code> 来找出所有匹配项，再利用 <code>cache.findAll</code>（很好用）。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> allQueriesFound = refetch.<span class="hljs-title function_">flatMap</span>(
  <span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> cache.<span class="hljs-title function_">findAll</span>({ <span class="hljs-attr">queryKey</span>: k, <span class="hljs-attr">exact</span>: <span class="hljs-literal">false</span> })
);
</code></pre>
<p>然后循环并做和之前一样的事：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> allQueriesFound = refetch.<span class="hljs-title function_">flatMap</span>(
  <span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> cache.<span class="hljs-title function_">findAll</span>({ <span class="hljs-attr">queryKey</span>: k, <span class="hljs-attr">exact</span>: <span class="hljs-literal">false</span> })
);

allQueriesFound.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">revalidatePayload</span>: <span class="hljs-built_in">any</span> = entry?.<span class="hljs-property">meta</span>?.<span class="hljs-property">__revalidate</span> ?? <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">if</span> (revalidatePayload) {
    revalidate.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">key</span>: entry.<span class="hljs-property">queryKey</span>,
      <span class="hljs-attr">fn</span>: revalidatePayload.<span class="hljs-property">serverFn</span>,
      <span class="hljs-attr">arg</span>: revalidatePayload.<span class="hljs-property">arg</span>,
    });
  }
});
</code></pre>
<p>这就能用了。</p>
<h2 data-id="heading-7">更进一步</h2>
<p>不过我们的方案仍然不理想。假设用户在 epics 页面翻页：到第 2 页、到第 3 页、再回到第 1 页。我们的逻辑会找到第 1 页和 summary query，但也会把第 2、3 页一并找到（因为它们现在也在 cache 里）。然而第 2、3 页并不活跃，也不在屏幕上展示，我们不应该 refetch 它们。</p>
<p>我们可以只 refetch active queries：只要给 <code>findAll</code> 加上 <code>type</code> 参数即可。</p>
<p><code>cache.findAll({ queryKey: key, exact: false, type: "active" });</code></p>
<p>于是代码就变成这样：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> allQueriesFound = refetch.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> cache.<span class="hljs-title function_">findAll</span>({ <span class="hljs-attr">queryKey</span>: key, <span class="hljs-attr">exact</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">"active"</span> }));

allQueriesFound.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">revalidatePayload</span>: <span class="hljs-built_in">any</span> = entry?.<span class="hljs-property">meta</span>?.<span class="hljs-property">__revalidate</span> ?? <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">if</span> (revalidatePayload) {
    revalidate.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">key</span>: entry.<span class="hljs-property">queryKey</span>,
      <span class="hljs-attr">fn</span>: revalidatePayload.<span class="hljs-property">serverFn</span>,
      <span class="hljs-attr">arg</span>: revalidatePayload.<span class="hljs-property">arg</span>,
    });
  }
});
</code></pre>
<h2 data-id="heading-8">更更进一步</h2>
<p>这样就能工作了。但你仔细想想，那些 inactive 的 queries 其实应该被 invalidated。我们不希望立刻 refetch 它们（浪费资源，而且用户没在看），但如果用户又翻回那些页面，我们希望触发一次重新获取。TanStack Query 通过 <code>invalidateQueries</code> 很容易做到。</p>
<p>我们把这段加到“被依赖的那个 middleware”的 client 回调里：</p>
<pre><code class="hljs language-ts" lang="ts">data?.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
  queryClient.<span class="hljs-title function_">invalidateQueries</span>({ <span class="hljs-attr">queryKey</span>: key, <span class="hljs-attr">exact</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">"inactive"</span>, <span class="hljs-attr">refetchType</span>: <span class="hljs-string">"none"</span> });
});
</code></pre>
<p>遍历传入的 query keys，把所有匹配的 inactive queries 标记为无效，但不立刻 refetch（<code>refetchType: "none"</code>）。</p>
<p>下面是更新后的完整 middleware：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> prelimRefetchMiddleware = <span class="hljs-title function_">createMiddleware</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"function"</span> })
  .<span class="hljs-title function_">inputValidator</span>(<span class="hljs-function">(<span class="hljs-params">config?: RefetchMiddlewareConfig</span>) =&gt;</span> config)
  .<span class="hljs-title function_">client</span>(<span class="hljs-keyword">async</span> ({ next, data }) =&gt; {
    <span class="hljs-keyword">const</span> { refetch = [] } = data ?? {};

    <span class="hljs-keyword">const</span> router = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRouterInstance</span>();
    <span class="hljs-keyword">const</span> <span class="hljs-attr">queryClient</span>: <span class="hljs-title class_">QueryClient</span> = router.<span class="hljs-property">options</span>.<span class="hljs-property">context</span>.<span class="hljs-property">queryClient</span>;
    <span class="hljs-keyword">const</span> cache = queryClient.<span class="hljs-title function_">getQueryCache</span>();

    <span class="hljs-keyword">const</span> <span class="hljs-attr">revalidate</span>: <span class="hljs-title class_">RevalidationPayload</span> = {
      <span class="hljs-attr">refetch</span>: [],
    };

    <span class="hljs-keyword">const</span> allQueriesFound = refetch.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> cache.<span class="hljs-title function_">findAll</span>({ <span class="hljs-attr">queryKey</span>: key, <span class="hljs-attr">exact</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">"active"</span> }));

    allQueriesFound.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> <span class="hljs-attr">revalidatePayload</span>: <span class="hljs-built_in">any</span> = entry?.<span class="hljs-property">meta</span>?.<span class="hljs-property">__revalidate</span> ?? <span class="hljs-literal">null</span>;

      <span class="hljs-keyword">if</span> (revalidatePayload) {
        revalidate.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">key</span>: entry.<span class="hljs-property">queryKey</span>,
          <span class="hljs-attr">fn</span>: revalidatePayload.<span class="hljs-property">serverFn</span>,
          <span class="hljs-attr">arg</span>: revalidatePayload.<span class="hljs-property">arg</span>,
        });
      }
    });

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
      <span class="hljs-attr">sendContext</span>: {
        revalidate,
      },
    });
  })
  .<span class="hljs-title function_">server</span>(<span class="hljs-keyword">async</span> ({ next, context }) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
      <span class="hljs-attr">sendContext</span>: {
        <span class="hljs-attr">payloads</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>[],
      },
    });

    <span class="hljs-keyword">const</span> allPayloads = context.<span class="hljs-property">revalidate</span>.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">refetchPayload</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">key</span>: refetchPayload.<span class="hljs-property">key</span>,
        <span class="hljs-attr">result</span>: refetchPayload.<span class="hljs-title function_">fn</span>({ <span class="hljs-attr">data</span>: refetchPayload.<span class="hljs-property">arg</span> }),
      };
    });

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> refetchPayload <span class="hljs-keyword">of</span> allPayloads) {
      result.<span class="hljs-property">sendContext</span>.<span class="hljs-property">payloads</span>.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">key</span>: refetchPayload.<span class="hljs-property">key</span>,
        <span class="hljs-attr">result</span>: <span class="hljs-keyword">await</span> refetchPayload.<span class="hljs-property">result</span>,
      });
    }

    <span class="hljs-keyword">return</span> result;
  });

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> refetchMiddleware = <span class="hljs-title function_">createMiddleware</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"function"</span> })
  .<span class="hljs-title function_">middleware</span>([prelimRefetchMiddleware])
  .<span class="hljs-title function_">client</span>(<span class="hljs-keyword">async</span> ({ data, next }) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();

    <span class="hljs-keyword">const</span> router = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRouterInstance</span>();
    <span class="hljs-keyword">const</span> <span class="hljs-attr">queryClient</span>: <span class="hljs-title class_">QueryClient</span> = router.<span class="hljs-property">options</span>.<span class="hljs-property">context</span>.<span class="hljs-property">queryClient</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> result.<span class="hljs-property">context</span>?.<span class="hljs-property">payloads</span> ?? []) {
      queryClient.<span class="hljs-title function_">setQueryData</span>(entry.<span class="hljs-property">key</span>, entry.<span class="hljs-property">result</span>, { <span class="hljs-attr">updatedAt</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() });
    }

    data?.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      queryClient.<span class="hljs-title function_">invalidateQueries</span>({ <span class="hljs-attr">queryKey</span>: key, <span class="hljs-attr">exact</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">"inactive"</span>, <span class="hljs-attr">refetchType</span>: <span class="hljs-string">"none"</span> });
    });

    <span class="hljs-keyword">return</span> result;
  });
</code></pre>
<p>我们告诉 TanStack Query：把匹配 key 的 inactive queries 置为 invalid（但不 refetch）。</p>
<p>这个方案非常好用：如果你浏览到第 2、3 页，然后回到第 1 页，再编辑一个 todo，你会看到第 1 页列表和 summary 立刻更新。之后如果你再翻回第 2、3 页，你会看到网络请求触发，从而拿到新数据。</p>
<h2 data-id="heading-9">锦上添花</h2>
<p>还记得我们把 server function 和参数塞进 query options 时的写法吗？</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">epicsQueryOptions</span> = (<span class="hljs-params">page: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryOptions</span>({
    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>, page],
    <span class="hljs-attr">queryFn</span>: <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getEpicsList</span>({ <span class="hljs-attr">data</span>: page });
      <span class="hljs-keyword">return</span> result;
    },
    <span class="hljs-attr">staleTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
    <span class="hljs-attr">gcTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">__revalidate</span>: {
        <span class="hljs-attr">serverFn</span>: getEpicsList,
        <span class="hljs-attr">arg</span>: page,
      },
    },
  });
};
</code></pre>
<p>我之前提过：在 <code>meta</code> 和 <code>queryFn</code> 里重复写 serverFn/arg 有点“脏”。我们来修一下。</p>
<p>先从最简单的 helper 开始：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">refetchedQueryOptions</span>(<span class="hljs-params">queryKey: QueryKey, serverFn: <span class="hljs-built_in">any</span>, arg?: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-keyword">const</span> queryKeyToUse = [...queryKey];
  <span class="hljs-keyword">if</span> (arg != <span class="hljs-literal">null</span>) {
    queryKeyToUse.<span class="hljs-title function_">push</span>(arg);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryOptions</span>({
    <span class="hljs-attr">queryKey</span>: queryKeyToUse,
    <span class="hljs-attr">queryFn</span>: <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">serverFn</span>({ <span class="hljs-attr">data</span>: arg });
    },
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">__revalidate</span>: {
        serverFn,
        arg,
      },
    },
  });
}
</code></pre>
<p>这个 helper 会接收 query key、server function 和参数，然后返回 query options：</p>
<ul>
<li>拼好的 <code>queryKey</code>（必要时把 arg 追加进去）</li>
<li><code>queryFn</code>（直接调用 server function）</li>
<li><code>meta.__revalidate</code>（同样记录 server function 和参数）</li>
</ul>
<p>于是 epics 列表 query 就可以写成：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">epicsQueryOptions</span> = (<span class="hljs-params">page: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryOptions</span>({
    ...<span class="hljs-title function_">refetchedQueryOptions</span>([<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>], getEpicsList, page),
    <span class="hljs-attr">staleTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
    <span class="hljs-attr">gcTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
  });
};
</code></pre>
<p>它能工作，但类型不好：到处都是 <code>any</code>，意味着传给 server function 的参数不做类型检查；更糟的是，<code>queryFn</code> 的返回值也不会被检查，于是你的 query（比如这个 epics 列表）会变成返回 <code>any</code>。</p>
<p>我们来加点类型。</p>
<p>server functions 本质上是函数：接收一个对象参数；如果 server function 定义了输入，那么这个对象会包含一个 <code>data</code> 属性，里面就是输入。说一堆大白话不如看调用例子：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">runSaveSimple</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">id</span>: epic.<span class="hljs-property">id</span>,
    <span class="hljs-attr">name</span>: newValue,
  },
});
</code></pre>
<p>第二版 helper 可以这样写：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> refetchedQueryOptions&lt;T <span class="hljs-keyword">extends</span> (<span class="hljs-attr">arg</span>: { <span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span> }) =&gt; <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;&gt;(
  <span class="hljs-attr">queryKey</span>: <span class="hljs-title class_">QueryKey</span>,
  <span class="hljs-attr">serverFn</span>: T,
  <span class="hljs-attr">arg</span>: <span class="hljs-title class_">Parameters</span>&lt;T&gt;[<span class="hljs-number">0</span>][<span class="hljs-string">"data"</span>],
) {
  <span class="hljs-keyword">const</span> queryKeyToUse = [...queryKey];
  <span class="hljs-keyword">if</span> (arg != <span class="hljs-literal">null</span>) {
    queryKeyToUse.<span class="hljs-title function_">push</span>(arg);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryOptions</span>({
    <span class="hljs-attr">queryKey</span>: queryKeyToUse,
    <span class="hljs-attr">queryFn</span>: <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Awaited</span>&lt;<span class="hljs-title class_">ReturnType</span>&lt;T&gt;&gt;&gt; =&gt; {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">serverFn</span>({ <span class="hljs-attr">data</span>: arg });
    },
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">__revalidate</span>: {
        serverFn,
        arg,
      },
    },
  });
}
</code></pre>
<p>我们把 server function 约束为一个 async 函数，且它的参数对象上有 <code>data</code>；然后用它来静态推断 <code>arg</code> 的类型。这已经不错了，但当你把它用在“没有参数”的 server function 上时会报错：</p>
<pre><code class="hljs language-ts" lang="ts">...<span class="hljs-title function_">refetchedQueryOptions</span>([<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"summary"</span>], getEpicsSummary)
<span class="hljs-comment">// Expected 3 arguments, but got 2.</span>
</code></pre>
<p>你传 <code>undefined</code> 可以解决，功能也正常：</p>
<p><code>...refetchedQueryOptions(["epics", "list", "summary"], getEpicsSummary, undefined),</code></p>
<p>如果你是个正常人，你大概会觉得这已经很好了，而且确实如此。但如果你像我一样有点“怪”，你可能会想能不能做到更完美：</p>
<ul>
<li>当 server function 有参数时：必须传入且类型要正确</li>
<li>当 server function 没参数时：允许省略 arg</li>
</ul>
<p>TypeScript 有一个特性正好适合：<strong>函数重载（overloaded functions）</strong>。</p>
<p>这篇文章已经够长了，所以我直接贴代码，解读留作读者练习（以及可能的未来文章）。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">QueryKey</span>, queryOptions } <span class="hljs-keyword">from</span> <span class="hljs-string">"@tanstack/react-query"</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">AnyAsyncFn</span> = <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ServerFnArgs</span>&lt;<span class="hljs-title class_">TFn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyAsyncFn</span>&gt; = <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">TFn</span>&gt;[<span class="hljs-number">0</span>] <span class="hljs-keyword">extends</span> infer <span class="hljs-title class_">TRootArgs</span>
  ? <span class="hljs-title class_">TRootArgs</span> <span class="hljs-keyword">extends</span> { <span class="hljs-attr">data</span>: infer <span class="hljs-title class_">TResult</span> }
    ? <span class="hljs-title class_">TResult</span>
    : <span class="hljs-literal">undefined</span>
  : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ServerFnHasArgs</span>&lt;<span class="hljs-title class_">TFn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyAsyncFn</span>&gt; = <span class="hljs-title class_">ServerFnArgs</span>&lt;<span class="hljs-title class_">TFn</span>&gt; <span class="hljs-keyword">extends</span> infer U ? (U <span class="hljs-keyword">extends</span> <span class="hljs-literal">undefined</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>) : <span class="hljs-literal">false</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ServerFnWithArgs</span>&lt;<span class="hljs-title class_">TFn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyAsyncFn</span>&gt; = <span class="hljs-title class_">ServerFnHasArgs</span>&lt;<span class="hljs-title class_">TFn</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-literal">true</span> ? <span class="hljs-title class_">TFn</span> : <span class="hljs-built_in">never</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ServerFnWithoutArgs</span>&lt;<span class="hljs-title class_">TFn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyAsyncFn</span>&gt; = <span class="hljs-title class_">ServerFnHasArgs</span>&lt;<span class="hljs-title class_">TFn</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-literal">false</span> ? <span class="hljs-title class_">TFn</span> : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">RefetchQueryOptions</span>&lt;T&gt; = {
  <span class="hljs-attr">queryKey</span>: <span class="hljs-title class_">QueryKey</span>;
  queryFn?: <span class="hljs-function">(<span class="hljs-params">_: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;T&gt;;
  meta?: <span class="hljs-built_in">any</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ValidateServerFunction</span>&lt;<span class="hljs-title class_">Provided</span>, <span class="hljs-title class_">Expected</span>&gt; = <span class="hljs-title class_">Provided</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Expected</span> ? <span class="hljs-title class_">Provided</span> : <span class="hljs-string">"This server function requires an argument!"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> refetchedQueryOptions&lt;<span class="hljs-title class_">TFn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyAsyncFn</span>&gt;(
  <span class="hljs-attr">queryKey</span>: <span class="hljs-title class_">QueryKey</span>,
  <span class="hljs-attr">serverFn</span>: <span class="hljs-title class_">ServerFnWithArgs</span>&lt;<span class="hljs-title class_">TFn</span>&gt;,
  <span class="hljs-attr">arg</span>: <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">TFn</span>&gt;[<span class="hljs-number">0</span>][<span class="hljs-string">"data"</span>],
): <span class="hljs-title class_">RefetchQueryOptions</span>&lt;<span class="hljs-title class_">Awaited</span>&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-title class_">TFn</span>&gt;&gt;&gt;;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> refetchedQueryOptions&lt;<span class="hljs-title class_">TFn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyAsyncFn</span>&gt;(
  <span class="hljs-attr">queryKey</span>: <span class="hljs-title class_">QueryKey</span>,
  <span class="hljs-attr">serverFn</span>: <span class="hljs-title class_">ValidateServerFunction</span>&lt;<span class="hljs-title class_">TFn</span>, <span class="hljs-title class_">ServerFnWithoutArgs</span>&lt;<span class="hljs-title class_">TFn</span>&gt;&gt;,
): <span class="hljs-title class_">RefetchQueryOptions</span>&lt;<span class="hljs-title class_">Awaited</span>&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-title class_">TFn</span>&gt;&gt;&gt;;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> refetchedQueryOptions&lt;<span class="hljs-title class_">TFn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyAsyncFn</span>&gt;(
  <span class="hljs-attr">queryKey</span>: <span class="hljs-title class_">QueryKey</span>,
  <span class="hljs-attr">serverFn</span>: <span class="hljs-title class_">ServerFnWithoutArgs</span>&lt;<span class="hljs-title class_">TFn</span>&gt; | <span class="hljs-title class_">ServerFnWithArgs</span>&lt;<span class="hljs-title class_">TFn</span>&gt;,
  arg?: <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">TFn</span>&gt;[<span class="hljs-number">0</span>][<span class="hljs-string">"data"</span>],
): <span class="hljs-title class_">RefetchQueryOptions</span>&lt;<span class="hljs-title class_">Awaited</span>&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-title class_">TFn</span>&gt;&gt;&gt; {
  <span class="hljs-keyword">const</span> queryKeyToUse = [...queryKey];
  <span class="hljs-keyword">if</span> (arg != <span class="hljs-literal">null</span>) {
    queryKeyToUse.<span class="hljs-title function_">push</span>(arg);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryOptions</span>({
    <span class="hljs-attr">queryKey</span>: queryKeyToUse,
    <span class="hljs-attr">queryFn</span>: <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">serverFn</span>({ <span class="hljs-attr">data</span>: arg });
    },
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">__revalidate</span>: {
        serverFn,
        arg,
      },
    },
  });
}
</code></pre>
<p>有了它之后，当 server function 需要参数时，你可以这样调用：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">epicsQueryOptions</span> = (<span class="hljs-params">page: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryOptions</span>({
    ...<span class="hljs-title function_">refetchedQueryOptions</span>([<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>], getEpicsList, page),
    <span class="hljs-attr">staleTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
    <span class="hljs-attr">gcTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
  });
};
</code></pre>
<p>参数类型会被正确检查：</p>
<pre><code class="hljs language-ts" lang="ts">...<span class="hljs-title function_">refetchedQueryOptions</span>([<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>], getEpicsList, <span class="hljs-string">""</span>)
<span class="hljs-comment">// Argument of type 'string' is not assignable to parameter of type 'number'.</span>
</code></pre>
<p>如果你忘了传参数，它也会报错：</p>
<pre><code class="hljs language-ts" lang="ts">...<span class="hljs-title function_">refetchedQueryOptions</span>([<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>], getEpicsList)
<span class="hljs-comment">// Argument of type 'RequiredFetcher&lt;undefined, (page: number) =&gt; number, Promise&lt;{ id: number; name: string; }[]&gt;&gt;' is not assignable to parameter of type '"This server function requires an argument!"'.</span>
</code></pre>
<p>最后这个报错信息不算特别直观，但如果你把代码读到最后，会发现它已经在尽力提示你哪里错了，靠的就是这个小工具类型：</p>
<p><code>type ValidateServerFunction&lt;Provided, Expected&gt; = Provided extends Expected ? Provided : "This server function requires an argument!";</code></p>
<p>而对于“没有参数”的 server function，它也能正常工作。完整解释留给未来文章。</p>
<h2 data-id="heading-10">总结</h2>
<p>single flight mutations 是一个很不错的优化工具：当你做一次 mutation 后，UI 需要的更新数据不必再额外发请求获取，而是可以在同一次往返里顺便带回来。</p>
<p>希望这篇文章把各个拼图都讲清楚了：如何用 middleware 收集要 refetch 的查询、如何借助 TanStack Start 的 server function 序列化能力把“要执行的 refetch”发送到服务端、以及如何在客户端用 <code>setQueryData</code> 把数据写回缓存。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>