<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[别再让Claude乱写代码了！一个配置文件让AI准确率提升10%]]></title>    <link>https://juejin.cn/post/7576861477267079187</link>    <guid>https://juejin.cn/post/7576861477267079187</guid>    <pubDate>2025-11-26T15:04:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576861477267079187" data-draft-id="7577042546094817322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再让Claude乱写代码了！一个配置文件让AI准确率提升10%"/> <meta itemprop="keywords" content="Claude,AI编程,敏捷开发"/> <meta itemprop="datePublished" content="2025-11-26T15:04:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="技术探索家"/> <meta itemprop="url" content="https://juejin.cn/user/2735240657517816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再让Claude乱写代码了！一个配置文件让AI准确率提升10%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2735240657517816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    技术探索家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T15:04:35.000Z" title="Wed Nov 26 2025 15:04:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec42c13f23f14ba1ba71ab6b7bedd781~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5o6i57Si5a62:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764775779&amp;x-signature=rvQunk5btaRKYcHpLiS4xpeKV%2B8%3D" alt="CLAUDE.md编写技巧.jpg" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p>你有没有遇到过这种情况：满怀期待地打开Claude Code，结果它对你的项目一头雾水？明明是个React项目，它却给你生成Vue的代码；明明技术栈文档里写着用TypeScript，它偏偏输出一堆JavaScript。</p>
<p>我第一次用Claude Code的时候就踩了这个坑。当时在做一个Node.js后端项目，Claude自作主张用Express重写了我基于Koa的代码，导致整个中间件系统全部失效。那一刻我才意识到：AI再聪明，也需要你告诉它"游戏规则"。</p>
<p>解决方案比想象中简单——一个叫CLAUDE.md的配置文件。这个文件就像给AI发的一份"项目说明书"，告诉它你的技术栈、代码规范、工作流程。根据Anthropic的实际测试，配置良好的CLAUDE.md能让AI的编码准确率提升5%-10%，同时减少大量无效建议。</p>
<p>今天我想分享7个实战技巧，帮你写出真正有效的CLAUDE.md。这些技巧都是我踩过坑后总结出来的，每个都配有可以直接使用的示例代码。</p>
<h2 data-id="heading-1">CLAUDE.md到底是什么</h2>
<p>说白了，CLAUDE.md就是放在项目根目录的一个Markdown文件，专门用来指导Claude Code理解你的项目。它类似于<code>.editorconfig</code>或者<code>README.md</code>，但作用更具体——告诉AI该怎么帮你写代码。</p>
<p><strong>工作机制很直接</strong>：当你在项目里使用Claude Code时，它会自动读取这个文件。虽然官方文档说会自动加载，但社区经验告诉我们最好用<code>/init</code>命令显式提醒一次，确保AI已经"读懂"你的配置。文件内容会被加载到AI的上下文记忆里，影响它后续所有的代码生成和建议。</p>
<p>这里有个关键特性——Claude Code支持<strong>层级配置</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">project-root/

├── CLAUDE.md              <span class="hljs-comment"># 全局配置（整个项目通用）</span>
├── frontend/
│   └── .claude/
│       └── CLAUDE.md     <span class="hljs-comment"># 前端特定配置</span>
└── backend/
    └── .claude/
        └── CLAUDE.md     <span class="hljs-comment"># 后端特定配置</span>
</code></pre>
<p>这意味着你可以在根目录定义通用规范，然后在子模块里覆盖特定规则。比如前端用React，后端用Node.js，各自维护自己的配置。</p>
<h2 data-id="heading-2">四个核心总则</h2>
<p>写CLAUDE.md之前，先记住这四个原则。我一开始没注意这些，写了300多行的"史诗级"配置文件，结果Claude表现反而变差了。</p>
<h3 data-id="heading-3">1. 简洁性：100行以内原则</h3>
<p>老实说，这是我付出代价才学到的教训。CLAUDE.md不是README，不需要长篇大论。</p>
<p>为什么要简洁？从技术角度讲，Claude的上下文窗口虽然很大，但CLAUDE.md会占用你的token配额。文件越长，留给实际代码分析的token就越少。根据Arize AI的研究，100行以内的配置文件效果最佳。</p>
<p>❌ <strong>错误示例</strong>（冗长重复）：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目简介</span>
这是一个基于React的前端项目。我们使用React来构建用户界面。
React是一个由Facebook开发的JavaScript库...（此处省略200字React介绍）

<span class="hljs-section"># 技术栈</span>
我们的技术栈包括以下内容：
<span class="hljs-bullet">-</span> React - 这是我们的UI框架，版本是18.2...
<span class="hljs-bullet">-</span> TypeScript - 我们用它来做类型检查...
</code></pre>
<p>✅ <strong>正确示例</strong>（精简直接）：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 技术栈</span>
<span class="hljs-bullet">-</span> React 18.2 (Hooks优先，避免Class组件)
<span class="hljs-bullet">-</span> TypeScript (严格模式)
<span class="hljs-bullet">-</span> TailwindCSS (utilities优先)

<span class="hljs-section"># 代码规范</span>
<span class="hljs-bullet">-</span> 函数组件 + 自定义Hooks
<span class="hljs-bullet">-</span> Props解构赋值
<span class="hljs-bullet">-</span> 优先使用const，避免let
</code></pre>
<p>看到区别了吗？第二个版本只用了60个字符就传达了同样甚至更多的有效信息。</p>
<h3 data-id="heading-4">2. 特定性：说人话，别模糊</h3>
<p>这个原则听起来简单，但很容易犯错。</p>
<p>❌ <strong>错误示例</strong>（模糊不清）：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 代码风格</span>
<span class="hljs-bullet">-</span> 保持代码简洁
<span class="hljs-bullet">-</span> 使用最佳实践
<span class="hljs-bullet">-</span> 注意性能优化
</code></pre>
<p>这种写法等于没写。什么叫"简洁"？什么叫"最佳实践"？AI根本没法执行。</p>
<p>✅ <strong>正确示例</strong>（具体可执行）：</p>
<pre><code class="hljs language-markdown" lang="markdown">
<span class="hljs-section"># 代码风格</span>
<span class="hljs-bullet">-</span> 单函数不超过50行，超过则拆分
<span class="hljs-bullet">-</span> API调用必须包含错误处理和loading状态
<span class="hljs-bullet">-</span> 列表渲染必须添加key属性，用ID而非index
<span class="hljs-bullet">-</span> 避免嵌套三元表达式，改用if/else或早期return
</code></pre>
<p>现在AI知道该做什么了。每条规则都是明确的、可验证的。</p>
<h3 data-id="heading-5">3. 可迭代性：别怕改，随时更新</h3>
<p>我见过有开发者在项目初期写了CLAUDE.md，然后半年都不碰它。结果项目从Vue 2迁移到Vue 3了，配置文件还在说"使用Options API"。</p>
<p><strong>用#键快速更新</strong>：这是我最喜欢的一个技巧。在Claude Code里，按<code>#</code>键可以快速引用和编辑CLAUDE.md。当你发现AI的行为不符合预期时，立刻改配置，不要拖延。</p>
<p>真实场景：上周我在做一个项目，Claude老是用<code>axios</code>生成代码，但我们团队已经统一用<code>fetch</code> + 自定义封装。我直接按<code>#</code>键，在CLAUDE.md里加了一行：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># HTTP请求</span>
<span class="hljs-bullet">-</span> 统一使用 <span class="hljs-code">`src/utils/request.ts`</span> 封装的fetch
<span class="hljs-bullet">-</span> 禁止直接使用axios或原生fetch
</code></pre>
<p>保存后，Claude就再也没犯过这个错误。</p>
<h3 data-id="heading-6">4. 团队共享：纳入版本控制</h3>
<p>这条很多人会忽略。CLAUDE.md必须提交到Git仓库，和<code>.gitignore</code>一样重要。</p>
<p>为什么？因为你的配置代表了团队的编码共识。如果每个人本地都有不同版本的CLAUDE.md，AI给张三生成的代码风格和给李四生成的完全不同，这就乱套了。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .gitignore 中不要忽略CLAUDE.md</span>
<span class="hljs-comment"># ❌ 错误做法</span>
*.md

<span class="hljs-comment"># ✅ 正确做法</span>
*.md
!CLAUDE.md
!README.md
</code></pre>
<p>而且要在Code Review时检查CLAUDE.md的变更。如果有人改了配置，整个团队都应该知道。</p>
<h2 data-id="heading-7">必须包含的5个内容模块</h2>
<p>这是我总结的最小可用配置。少了这些模块，CLAUDE.md基本没啥用。</p>
<h3 data-id="heading-8">1. 技术栈声明</h3>
<p>必须明确列出你用的框架、库和版本。这是最基础的。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 技术栈</span>
<span class="hljs-strong">**前端**</span>
<span class="hljs-bullet">-</span> Next.js 14 (App Router)
<span class="hljs-bullet">-</span> React 18 (Server Components优先)
<span class="hljs-bullet">-</span> TypeScript 5.2
<span class="hljs-bullet">-</span> Tailwind CSS 3.4

<span class="hljs-strong">**后端**</span>
<span class="hljs-bullet">-</span> Node.js 20 LTS
<span class="hljs-bullet">-</span> Express 4.18
<span class="hljs-bullet">-</span> Prisma ORM
<span class="hljs-bullet">-</span> PostgreSQL 15
</code></pre>
<p>注意我写了版本号。如果不写版本，Claude可能用旧API生成代码。比如Next.js 13和14的路由写法完全不同，不指定版本很危险。</p>
<h3 data-id="heading-9">2. 项目结构说明</h3>
<p>告诉AI你的文件是怎么组织的，这样它才能把代码放对位置。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目结构</span>
src/
├── app/              # Next.js页面路由
├── components/       # 可复用UI组件
│   ├── ui/          # 基础组件(Button, Input)
│   └── features/    # 业务组件(UserCard, OrderList)
├── lib/             # 工具函数和hooks
├── services/        # API调用层
└── types/           # TypeScript类型定义

<span class="hljs-section"># 文件命名</span>
<span class="hljs-bullet">-</span> 组件：PascalCase (UserProfile.tsx)
<span class="hljs-bullet">-</span> 工具函数：camelCase (formatDate.ts)
<span class="hljs-bullet">-</span> 常量：UPPER<span class="hljs-emphasis">_SNAKE_</span>CASE (API<span class="hljs-emphasis">_BASE_</span>URL)

</code></pre>
<p>有了这个，Claude就知道新建一个用户卡片组件应该放在<code>components/features/UserCard.tsx</code>，而不是随便找个地方。</p>
<h3 data-id="heading-10">3. 常用命令</h3>
<p>这部分经常被忽略，但超级有用。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 开发命令</span>
npm run dev          # 启动开发服务器(localhost:3000)
npm run build        # 生产构建
npm run test         # 运行Jest测试
npm run lint         # ESLint检查
npm run type-check   # TypeScript类型检查

<span class="hljs-section"># 数据库</span>
npx prisma studio    # 打开数据库GUI
npx prisma migrate dev  # 运行数据库迁移
</code></pre>
<p>为什么要写这个？因为Claude有时候需要验证代码或者运行测试，告诉它正确的命令能避免很多问题。</p>
<h3 data-id="heading-11">4. 代码风格规范</h3>
<p>这是重头戏。要写得足够具体。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 代码规范</span>
<span class="hljs-section">## React组件</span>
<span class="hljs-bullet">-</span> 使用函数组件 + Hooks，禁止Class组件
<span class="hljs-bullet">-</span> Props类型定义在组件上方，使用interface而非type
<span class="hljs-bullet">-</span> 组件内部顺序：Props定义 → 组件函数 → 导出

<span class="hljs-section">## 状态管理</span>
<span class="hljs-bullet">-</span> 本地状态：useState/useReducer
<span class="hljs-bullet">-</span> 服务器状态：TanStack Query
<span class="hljs-bullet">-</span> 全局状态：Zustand (避免使用Context)

<span class="hljs-section">## 错误处理</span>
<span class="hljs-bullet">-</span> API调用必须try-catch
<span class="hljs-bullet">-</span> 用户可见错误使用toast提示
<span class="hljs-bullet">-</span> 开发环境console.error，生产环境上报Sentry
</code></pre>
<h3 data-id="heading-12">5. 工作流和限制</h3>
<p>告诉AI什么能做、什么不能做。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 工作流</span>
<span class="hljs-bullet">-</span> 新功能开发：先写类型定义 → 写组件 → 写测试
<span class="hljs-bullet">-</span> 修Bug：先写复现测试 → 修复代码 → 验证测试通过

<span class="hljs-section"># 限制事项</span>
<span class="hljs-bullet">-</span> ❌ 不要修改 <span class="hljs-code">`/prisma/schema.prisma`</span> (需团队评审)
<span class="hljs-bullet">-</span> ❌ 不要安装新依赖包 (需在package.json review时讨论)
<span class="hljs-bullet">-</span> ❌ 不要修改 <span class="hljs-code">`/lib/auth/*`</span> (认证逻辑敏感)
<span class="hljs-bullet">-</span> ✅ 可以自由修改 <span class="hljs-code">`/components`</span> 和 <span class="hljs-code">`/app`</span> 下的业务代码
</code></pre>
<p>这能防止AI"好心办坏事"，误改关键代码。</p>
<h2 data-id="heading-13">7个让效果翻倍的实战技巧</h2>
<h3 data-id="heading-14">技巧1：用SHOULD/MUST强调优先级</h3>
<p>不是所有规则都同等重要。用关键词区分优先级。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 规范优先级</span>
<span class="hljs-strong">**MUST (必须遵守)**</span>
<span class="hljs-bullet">-</span> MUST 使用TypeScript严格模式
<span class="hljs-bullet">-</span> MUST 为所有API添加错误处理

<span class="hljs-strong">**SHOULD (推荐遵守)**</span>
<span class="hljs-bullet">-</span> SHOULD 组件不超过200行
<span class="hljs-bullet">-</span> SHOULD 提取重复逻辑为自定义Hook

<span class="hljs-strong">**COULD (可选)**</span>
<span class="hljs-bullet">-</span> COULD 添加JSDoc注释
</code></pre>
<p>这个技巧来自RFC规范文档的写法。用了之后，Claude明显对"MUST"的规则执行得更严格。</p>
<h3 data-id="heading-15">技巧2：善用/init命令</h3>
<p>虽然官方说CLAUDE.md会自动加载，但我强烈建议每次打开项目先运行<code>/init</code>命令。</p>
<pre><code class="hljs language-bash" lang="bash">你：/init
Claude：已加载项目配置，当前技术栈：React 18 + TypeScript...
</code></pre>
<p>这就像给AI"刷新"一下记忆。特别是当你刚改完CLAUDE.md，用<code>/init</code>能让变更立即生效。</p>
<h3 data-id="heading-16">技巧3：示例代码胜过千言万语</h3>
<p>与其描述规范，不如直接给示例。</p>
<p>❌ <strong>纯文字描述</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">-</span> API函数需要包含类型定义、错误处理和loading状态
</code></pre>
<p>✅ <strong>带示例代码</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># API调用规范</span>
参考示例：
\<span class="hljs-code">`\`</span>\`typescript
// src/services/user.ts
export async function getUser(id: string): Promise<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">User</span>&gt;</span></span> {
  try {
    const response = await fetch(<span class="hljs-code">`/api/users/${id}`</span>);
    if (!response.ok) throw new Error('Failed to fetch user');
    return await response.json();
  } catch (error) {
    console.error('getUser error:', error);
    throw error;
  }
}
\<span class="hljs-code">`\`</span>\`
所有API函数都遵循此模式：类型返回值 + try-catch + 错误日志
</code></pre>
<p>Claude看到示例后，生成的代码会非常接近你的期望。</p>
<h3 data-id="heading-17">技巧4：分层配置管理（Monorepo必备）</h3>
<p>如果你的项目是Monorepo架构，一定要用分层配置。</p>
<pre><code class="hljs language-bash" lang="bash">monorepo-root/
├── CLAUDE.md                    <span class="hljs-comment"># 全局：通用规范、Git工作流</span>
├── apps/
│   ├── web/
│   │   └── .claude/CLAUDE.md   <span class="hljs-comment"># Web应用：React + Next.js</span>
│   └── mobile/
│       └── .claude/CLAUDE.md   <span class="hljs-comment"># 移动端：React Native</span>
└── packages/
    └── shared/
        └── .claude/CLAUDE.md   <span class="hljs-comment"># 共享包：纯TS工具库</span>
</code></pre>
<p><strong>根目录CLAUDE.md</strong>（全局规范）：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Monorepo通用规范</span>
<span class="hljs-bullet">-</span> 使用pnpm作为包管理器
<span class="hljs-bullet">-</span> 统一TypeScript配置继承自根目录tsconfig.json
<span class="hljs-bullet">-</span> Commit信息遵循Conventional Commits

<span class="hljs-section"># 工作流</span>
<span class="hljs-bullet">-</span> 代码修改前先运行 <span class="hljs-code">`pnpm install`</span>
<span class="hljs-bullet">-</span> 提交前运行 <span class="hljs-code">`pnpm run lint`</span> 检查所有包
</code></pre>
<p><strong>apps/web/.claude/CLAUDE.md</strong>（前端专属）：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Web应用特定配置</span>
继承根目录规范，以下是额外配置：
<span class="hljs-bullet">-</span> 技术栈：Next.js 14 + React 18
<span class="hljs-bullet">-</span> 样式：Tailwind CSS
<span class="hljs-bullet">-</span> 状态管理：Zustand
</code></pre>
<p>Claude会先读取根目录配置，然后根据你当前工作目录读取子配置。这样就不用在每个子项目重复写通用规范了。</p>
<h3 data-id="heading-18">技巧5：用❌和✅做对比</h3>
<p>人类和AI都喜欢对比学习。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 状态更新规范</span>
❌ 错误：直接修改state
\<span class="hljs-code">`\`</span>\`typescript
const [user, setUser] = useState({name: 'John', age: 30});
user.age = 31; // 错误！直接修改了对象
\<span class="hljs-code">`\`</span>\`

✅ 正确：使用不可变更新
\<span class="hljs-code">`\`</span>\`typescript
const [user, setUser] = useState({name: 'John', age: 30});
setUser(prev =&gt; ({...prev, age: 31}));
\<span class="hljs-code">`\`</span>\`
</code></pre>
<p>这种对比让规则一目了然，Claude学习效率也更高。</p>
<h3 data-id="heading-19">技巧6：记录常见错误模式</h3>
<p>把团队经常犯的错误写进去，让AI帮你把关。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># ⚠️ 常见错误和避坑指南</span>
<span class="hljs-section">## 1. 忘记清理副作用</span>
❌ 问题代码：
\<span class="hljs-code">`\`</span>\`typescript
useEffect(() =&gt; {
  const timer = setInterval(() =&gt; {/* ... <span class="hljs-emphasis">*/}, 1000);
  // 忘记清理！
}, []);
\`\`\`

✅ 正确做法：
\`\`\`typescript
useEffect(() =&gt; {
  const timer = setInterval(() =&gt; {/*</span> ... <span class="hljs-emphasis">*/}, 1000);
  return () =&gt; clearInterval(timer); // 清理定时器
}, []);
\`\`\`

## 2. 缺失依赖项
如果ESLint提示依赖项缺失，不要禁用警告，要么添加依赖，要么用useCallback/useMemo优化
</span></code></pre>
<p>有了这个，Claude在生成代码时会主动避免这些坑。</p>
<h3 data-id="heading-20">技巧7：链接到详细文档</h3>
<p>CLAUDE.md要简洁，但可以链接到详细文档。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 详细规范文档</span>
<span class="hljs-bullet">-</span> [<span class="hljs-string">API设计规范</span>](<span class="hljs-link">./docs/api-guidelines.md</span>) - RESTful API设计标准
<span class="hljs-bullet">-</span> [<span class="hljs-string">组件开发指南</span>](<span class="hljs-link">./docs/component-guide.md</span>) - 组件拆分和复用原则
<span class="hljs-bullet">-</span> [<span class="hljs-string">测试规范</span>](<span class="hljs-link">./docs/testing.md</span>) - 单元测试和集成测试要求
</code></pre>
<p>这样既保持了CLAUDE.md的简洁，又能在需要时提供详细信息。Claude可以通过这些链接获取更多上下文。</p>
<h2 data-id="heading-21">5个最容易踩的坑</h2>
<h3 data-id="heading-22">坑1：文件太长，塞一切内容</h3>
<p>新手最常犯的错误。把README、API文档、业务逻辑说明全塞进CLAUDE.md。</p>
<p><strong>问题</strong>：占用太多token，反而稀释了重要信息。</p>
<p><strong>解决</strong>：严格控制在100行以内，只写AI编码时真正需要的信息。</p>
<h3 data-id="heading-23">坑2：从不更新配置</h3>
<p>项目在变化，CLAUDE.md却一成不变。</p>
<p><strong>问题</strong>：过时的配置导致AI生成错误代码。</p>
<p><strong>解决</strong>：养成习惯，每次重大重构后更新CLAUDE.md，并在PR中review配置变更。</p>
<h3 data-id="heading-24">坑3：忘记版本控制</h3>
<p>把CLAUDE.md加入<code>.gitignore</code>或者不提交到仓库。</p>
<p><strong>问题</strong>：团队成员各自为政，代码风格混乱。</p>
<p><strong>解决</strong>：必须纳入Git，和代码一起review。</p>
<h3 data-id="heading-25">坑4：过于笼统的规则</h3>
<p>写"保持代码简洁"、"遵循最佳实践"这种空话。</p>
<p><strong>问题</strong>：AI无法执行，等于没写。</p>
<p><strong>解决</strong>：每条规则必须具体、可验证、可执行。</p>
<h3 data-id="heading-26">坑5：敏感信息泄露</h3>
<p>把API密钥、数据库密码写进CLAUDE.md。</p>
<p><strong>问题</strong>：配置文件会提交到仓库，敏感信息泄露。</p>
<p><strong>解决</strong>：只描述配置方式，不写具体值。</p>
<pre><code class="hljs language-markdown" lang="markdown">❌ 错误
\<span class="hljs-code">`\`</span>\`markdown
<span class="hljs-section"># 数据库配置</span>
DATABASE<span class="hljs-emphasis">_URL=postgresql://admin:password123@localhost:5432/mydb
\`\`\`

✅ 正确
\`\`\`markdown
# 环境变量
- DATABASE_</span>URL: 从.env.local读取，格式参考.env.example
<span class="hljs-bullet">-</span> API<span class="hljs-emphasis">_KEY: 从环境变量获取，本地开发联系@张三获取测试key
\`\`\`
</span></code></pre>
<h2 data-id="heading-27">3个真实项目案例</h2>
<h3 data-id="heading-28">案例1：React前端项目</h3>
<p>这是我目前在维护的一个电商前端项目的配置（简化版）：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 电商前端项目</span>
<span class="hljs-section">## 技术栈</span>
<span class="hljs-bullet">-</span> Next.js 14.0 (App Router)
<span class="hljs-bullet">-</span> React 18.2
<span class="hljs-bullet">-</span> TypeScript 5.2
<span class="hljs-bullet">-</span> Tailwind CSS 3.4
<span class="hljs-bullet">-</span> Zustand (状态管理)
<span class="hljs-bullet">-</span> TanStack Query (服务器状态)

<span class="hljs-section">## 项目结构</span>
src/
├── app/          # 页面路由
├── components/   # 组件
│   ├── ui/      # 基础组件
│   └── features/ # 业务组件
├── lib/         # 工具函数
└── services/    # API调用

  


<span class="hljs-section">## 代码规范</span>
<span class="hljs-bullet">-</span> 组件：函数组件 + Hooks
<span class="hljs-bullet">-</span> 状态：本地用useState，全局用Zustand，服务器用TanStack Query
<span class="hljs-bullet">-</span> 样式：Tailwind utilities，复杂布局抽取为组件
<span class="hljs-bullet">-</span> 错误处理：API调用必须try-catch


<span class="hljs-section">## 命令</span>
npm run dev      # 开发服务器
npm run build    # 生产构建
npm run lint     # 代码检查

<span class="hljs-section">## 限制</span>
<span class="hljs-bullet">-</span> 不要修改 /lib/auth/* (认证逻辑)
<span class="hljs-bullet">-</span> 不要安装新包 (需团队讨论)
</code></pre>
<p><strong>效果</strong>：用了这个配置后，Claude生成的组件结构和我手写的基本一致，节省了大量调整时间。</p>
<h3 data-id="heading-29">案例2：Node.js后端项目</h3>
<p>这是一个Express API项目的配置：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 订单管理系统API</span>
<span class="hljs-section">## 技术栈</span>
<span class="hljs-bullet">-</span> Node.js 20 LTS
<span class="hljs-bullet">-</span> Express 4.18
<span class="hljs-bullet">-</span> Prisma ORM
<span class="hljs-bullet">-</span> PostgreSQL 15
<span class="hljs-bullet">-</span> Zod (数据验证)

<span class="hljs-section">## 项目结构</span>
src/
├── routes/       # 路由定义
├── controllers/  # 业务逻辑
├── services/     # 数据库操作
├── middleware/   # 中间件
└── utils/        # 工具函数

<span class="hljs-section">## 编码规范</span>
<span class="hljs-bullet">-</span> 所有API必须包含：请求验证(Zod) + 错误处理 + 日志记录
<span class="hljs-bullet">-</span> 数据库操作统一放在services层
<span class="hljs-bullet">-</span> 控制器只做请求响应，不写业务逻辑
<span class="hljs-bullet">-</span> 使用async/await，避免回调

<span class="hljs-section">## API示例</span>
\<span class="hljs-code">`\`</span>\`typescript
// controllers/order.controller.ts
export async function createOrder(req: Request, res: Response) {
  try {
    const data = orderSchema.parse(req.body); // Zod验证
    const order = await orderService.create(data);
    logger.info('Order created', { orderId: order.id });
    res.json({ success: true, data: order });
  } catch (error) {
    logger.error('Create order failed', error);
    res.status(500).json({ success: false, error: 'Internal error' });
  }
}
\<span class="hljs-code">`\`</span>\`

<span class="hljs-section">## 命令</span>
npm run dev       # 开发模式(nodemon)
npm run build     # TypeScript编译
npm test          # Jest测试
npx prisma studio # 数据库GUI
</code></pre>
<p><strong>效果</strong>：Claude现在生成的API端点都自带Zod验证和错误处理，质量提升明显。</p>
<h3 data-id="heading-30">案例3：Monorepo架构</h3>
<p>这是一个同时包含前后端的Monorepo项目：</p>
<p><strong>根目录CLAUDE.md</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 全栈应用Monorepo</span>

<span class="hljs-section">## 架构</span>
<span class="hljs-bullet">-</span> 使用pnpm workspaces
<span class="hljs-bullet">-</span> apps/: 应用程序
<span class="hljs-bullet">-</span> packages/: 共享包

<span class="hljs-section">## 通用规范</span>
<span class="hljs-bullet">-</span> TypeScript严格模式
<span class="hljs-bullet">-</span> ESLint + Prettier统一格式化
<span class="hljs-bullet">-</span> Commit遵循Conventional Commits

<span class="hljs-section">## 命令</span>
pnpm install           # 安装所有依赖
pnpm run dev           # 同时启动前后端
pnpm run lint          # 检查所有包
pnpm --filter web dev  # 只启动web应用
</code></pre>
<p><strong>apps/web/.claude/CLAUDE.md</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Web应用配置</span>
继承根目录规范

<span class="hljs-bullet">-</span> Next.js 14 + React
<span class="hljs-bullet">-</span> 端口：3000
<span class="hljs-bullet">-</span> 详细规范见根目录CLAUDE.md
</code></pre>
<p><strong>apps/api/.claude/CLAUDE.md</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># API服务配置</span>
继承根目录规范

<span class="hljs-bullet">-</span> Express + Prisma
<span class="hljs-bullet">-</span> 端口：4000
<span class="hljs-bullet">-</span> 详细规范见根目录CLAUDE.md
</code></pre>
<p><strong>效果</strong>：Claude能根据当前工作目录自动切换上下文，在前端目录生成React代码，在后端目录生成Express代码。</p>
<h2 data-id="heading-31">结论：从今天开始优化你的CLAUDE.md</h2>
<p>看完这7个技巧，你应该对如何写好CLAUDE.md有了清晰的认识。记住最重要的三点：</p>
<ol>
<li>
<p><strong>保持简洁</strong> - 100行以内，只写必要信息</p>
</li>
<li>
<p><strong>足够具体</strong> - 每条规则都可执行、可验证</p>
</li>
<li>
<p><strong>持续更新</strong> - 项目在变，配置也要跟着变</p>
</li>
</ol>
<p>从我的实际经验来看，一个好的CLAUDE.md能把AI的工作效率提升至少30%。你不需要一次性写完所有内容，可以从最基础的技术栈声明开始，然后每次遇到AI犯错时，就往CLAUDE.md里加一条规则。</p>
<p>现在就打开你的项目，创建或优化你的CLAUDE.md吧。如果你还没开始用Claude Code，这个配置文件会是你的第一步。如果你已经在用，但AI表现不够理想，试试今天分享的这些技巧。</p>
<p>最后提醒一句：CLAUDE.md不是一次性工作，它应该和你的项目一起成长。每次重大重构、技术栈升级、规范变更，都别忘了更新这个文件。让AI真正理解你的项目，从写好CLAUDE.md开始。</p>
<blockquote>
<p>本文首发自<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.betterlink.top%2Fzh%2Fposts%2Fai%2F20251122-claude-md-writing-guide%2F" target="_blank" title="https://blog.betterlink.top/zh/posts/ai/20251122-claude-md-writing-guide/" ref="nofollow noopener noreferrer">blog.betterlink.top/zh/posts/ai…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让Trae CN SOLO自主发挥，看看能做出一个什么样的项目]]></title>    <link>https://juejin.cn/post/7576867727718662179</link>    <guid>https://juejin.cn/post/7576867727718662179</guid>    <pubDate>2025-11-26T15:20:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576867727718662179" data-draft-id="7576853741758201890" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让Trae CN SOLO自主发挥，看看能做出一个什么样的项目"/> <meta itemprop="keywords" content="前端,Trae,人工智能"/> <meta itemprop="datePublished" content="2025-11-26T15:20:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="银空飞羽"/> <meta itemprop="url" content="https://juejin.cn/user/1086796427178429"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让Trae CN SOLO自主发挥，看看能做出一个什么样的项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1086796427178429/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    银空飞羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T15:20:16.000Z" title="Wed Nov 26 2025 15:20:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>很早之前就在公司内部用过这种全栈自动化开发的大模型工具，然后当时在用的Trae CN编辑器也一直说要推出该能力，早早的就加到了候补白名单中，终于在今天收到短信，正好借着运营小姐姐告诉我的平台活动，于是来试用一下。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97c18be91de44206b54edc7a851d7471~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZO256m66aOe5769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764775370&amp;x-signature=QQqLtEBU7tp0fWXoOIELFjhXDdQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">界面展示</h2>
<p>SOLO模式本质上就是开发者啥都不用干，给大模型一个指令，然后大模型自主完成从项目设计、代码开发、自主运行、到自动debug最终上线的一整套全栈开发流程。</p>
<p>你可以提前给它设定好技术栈，或者给它详细的产品设计，让它按照你的思路搞，最后由你来验收。</p>
<p>打开Trae CN的SOLO界面</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaabe51a622f483e8d4fd1559888b595~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZO256m66aOe5769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764775370&amp;x-signature=ZdjMCCOwtLLs4kfrrsqFeyeRNd4%3D" alt="" loading="lazy"/></p>
<p>跟当初Trae国际版界面有点不同，国际版支持两种模式：小项目模式和大项目迭代模式，这里看CN版的就一种模式，左边的工具栏都是在SOLO开发中会自主调用的，包括用户自己的导入的MCP、智能体必要时也会被调用发挥作用。</p>
<p>整体能力上跟国际版的相比应该有一些阉割，不过不重要，看看对于小型项目来讲能做到什么程度吧。</p>
<h2 data-id="heading-2">自动化开发</h2>
<p>开始给它提示词让其自由发挥，在发送提示词之前，先进行一波提示词描述优化</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62991ce8b99b4948b0c2c133be2ef18f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZO256m66aOe5769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764775370&amp;x-signature=E2qc6wWVPefsXXNDqbXmjWCS2mY%3D" alt="" loading="lazy"/></p>
<p>优化后的效果如下</p>
<blockquote>
<p>设计并开发一个基于现代Web技术栈的完整网站应用，要求功能完备、具有创新性和实用性。技术实现需采用标准Web开发技术（HTML5、CSS3、JavaScript/TypeScript），可结合主流前端框架（如React、Vue或Angular）提升开发效率。网站需包含完整的用户交互流程，至少涵盖首页、核心功能模块页、用户设置页等关键页面。功能设计应具有独特性和创新性，避免简单模仿现有网站。所有用户数据和应用状态必须使用浏览器本地存储方案（localStorage/sessionStorage/IndexedDB）实现持久化管理，确保在用户刷新页面或重新访问时数据不丢失。网站需满足响应式设计要求，适配桌面端、平板和移动设备等不同屏幕尺寸。开发过程中需实现合理的代码结构、组件化设计和错误处理机制，确保应用的可维护性和稳定性。</p>
</blockquote>
<p>OK，需求明确后，让SOLO模式开工吧，首先进行任务设计</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91c19af4c84a4fe088a4a52b09cd12bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZO256m66aOe5769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764775370&amp;x-signature=L6N0ttGrWWG%2F8qCghbSTWw0%2FnTg%3D" alt="" loading="lazy"/></p>
<p>然后看到了它自由发挥了三个功能，感觉中间没有什么关联</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39c413cb5d1e4b6cb3043b880d08ae19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZO256m66aOe5769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764775370&amp;x-signature=dqqTKi6C96MXjjoxF4eJs5JdvO0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/849bb9f13425485c9a512f5766eba3e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZO256m66aOe5769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764775370&amp;x-signature=dQh2kqsViPBVZRjdv%2BlJwaHcS%2Fo%3D" alt="" loading="lazy"/></p>
<p>终于完成了，打开内置浏览器一看，报错</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fab09034ef04dc6a73cf4084feaaadf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZO256m66aOe5769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764775370&amp;x-signature=YjTQ3nje5MmS4X64Yzn3bj6i86s%3D" alt="" loading="lazy"/></p>
<p>点击右下角将报错信息添加到对话，让它改bug吧</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcf81fc1d61646658ea989f116611559~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZO256m66aOe5769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764775370&amp;x-signature=VAMp0OwGgU1lVquWWQftlOvL5Uo%3D" alt="" loading="lazy"/></p>
<p>又等了一会，OK了。尝试使用一下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b1ee576e22d43ccac0a7b58b65f180f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZO256m66aOe5769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764775370&amp;x-signature=f5cdx8jcQ%2B1DXvvcajPytmTtvq4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ddab247f14c49ee90a9f8f6b62a13ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZO256m66aOe5769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764775370&amp;x-signature=iAbV1wmQl8BjgmZzBRQoP8ZUnS8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c39d75fe00e4909a6c81479c5ca1fd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZO256m66aOe5769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764775370&amp;x-signature=YI9ptT9sVm%2B0CdGFGn2PQyQ3ae0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0e2e0380d2141679d1ad2888f5baf7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZO256m66aOe5769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764775370&amp;x-signature=PPu2002rsh%2FLbZxNb8vGAeOXutc%3D" alt="" loading="lazy"/>
感觉可以哦，是个目标任务管理网站，可以设置任务、目标，设置中还能设置主题，甚至还有进度条这种小细节，作为一个项目管理工具真心不错。</p>
<p>本次比较仓促，确实没想到什么需求，就索性直接让Trae自己创造需求，实现需求，基本是一站式开发，只有一些操作是需要我来确认的，其他基本就扔后台不管了，还是挺省心的。等以后有刚需了再好好试试。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[提升 EdgeWorker 可观测性：使用 DataStream 设置日志功能]]></title>    <link>https://juejin.cn/post/7576844295434485769</link>    <guid>https://juejin.cn/post/7576844295434485769</guid>    <pubDate>2025-11-26T15:56:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576844295434485769" data-draft-id="7576907627016732723" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="提升 EdgeWorker 可观测性：使用 DataStream 设置日志功能"/> <meta itemprop="keywords" content="人工智能,云计算"/> <meta itemprop="datePublished" content="2025-11-26T15:56:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AKAMAI"/> <meta itemprop="url" content="https://juejin.cn/user/829502942352628"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            提升 EdgeWorker 可观测性：使用 DataStream 设置日志功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/829502942352628/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AKAMAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T15:56:56.000Z" title="Wed Nov 26 2025 15:56:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关于作者：AJ Johnson 是 Akamai Technologies 的高级产品经理，专注于平台即服务（PaaS），并领导旨在扩展和优化公司云平台能力的战略计划。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d7341fdca8e4c6285d317b92d69162f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUtBTUFJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764777416&amp;x-signature=d3ZCwSaCS5NIfEp7%2BeydGtQTlTQ%3D" alt="" loading="lazy"/></p>
<p>如您所在的企业也在考虑采购云服务或进行云迁移，</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linode.com%2Fzh%2Flp%2Fakamai-cloud-computing-freetrial%2F%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejin_251126_blogarticles230" target="_blank" title="https://www.linode.com/zh/lp/akamai-cloud-computing-freetrial/?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejin_251126_blogarticles230" ref="nofollow noopener noreferrer">点击链接</a>了解Akamai Linode解决方案，现在申请试用可得高达500美元专属额度</p>
<hr/>
<p>询问任何开发者，他们都会告诉您，良好且及时的应用遥测对于构建、维护和优化应用程序至关重要。没有适当的反馈，开发人员就如同在黑暗中摸索，难以识别逻辑错误、合规性问题以及优化空间。应用日志记录是开发过程的核心部分，在代码从概念走向生产的过程中提供关键洞察。而长期以来，这一功能在 EdgeWorkers 中一直缺失。</p>
<p>EdgeWorkers 是全球分布最广的无服务器边缘计算平台，使开发人员能够将业务逻辑放置在边缘，以减少延迟、加快响应时间、提高性能，并为全球客户提供更好的用户体验。</p>
<p>我们很高兴地宣布，EdgeWorkers 的可观测性得到了极大改善！自 Akamai 推出 EdgeWorkers 与 DataStream（一个免费的集中式数据收集和交付平台）的集成以来，已经过去了几个月。借助这项新的日志记录集成，开发人员现在可以为其关键任务的 EdgeWorker 工作负载设置日志。按照日志记录的标准，提供了多种详细级别：跟踪、调试、信息、警告和错误。控制日志级别为应用程序开发人员提供了灵活性和选项，以便排查其 EdgeWorkers 逻辑故障。</p>
<p>在推出 DataStream 集成之前，EdgeWorker 开发人员会使用高级标头和手动检查来调试其代码和工作流，这种方式繁琐、耗时且容易出错，很容易错过关键洞察。此外，借助完整的日志记录功能，开发人员可以更轻松地检测那些在简单 cURL 请求中可能无法显现的异常情况。</p>
<p>DataStream 集成的一个便捷特性是，无需编辑和重新部署代码即可修改在 EdgeWorkers 代码包中定义的日志级别。使用日志"覆盖"，可以根据需要切换函数日志以设置日志级别和详细程度，允许用户仅在需要更细粒度信息之前记录错误。这样做的好处是灵活性，同时控制日志量以避免额外的可观测性成本。请参阅以下示例，了解如何通过 UI 或使用 CLI 控制日志级别。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9a0a65c66614881929790e3e4fad977~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUtBTUFJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764777416&amp;x-signature=a2eRqas9FxNMmeon8EwC9FurquU%3D" alt="" loading="lazy"/></p>
<p>使用 UI 设置日志级别（无需重新部署代码）</p>
<p>使用 Akamai CLI，您可以通过类似以下命令设置日志级别：</p>
<p>akamai ew log-level set 82236 production debug;</p>
<p>自该集成推出以来，我们已经吸纳了众多 Akamai 的 EdgeWorker 客户，他们已配置了应用程序日志流。EdgeWorker 客户可以选择将其日志数据发送到他们选择的目的地，例如流行的内部可观测性工具，如 Splunk、New Relic 等。有关支持的端点的完整列表，请参阅 DataStream 目的地列表。</p>
<p>随着许多客户采用这一新功能，早期反馈是积极的。一位欧洲游戏客户提到，他们使用新的 JavaScript 日志记录功能在上线前隔离了新业务逻辑的问题。另一位客户强调了拥有可用日志对于更快发现问题的重要性。</p>
<p>以下是 EdgeWorker 日志记录的主要目的地：</p>
<p><strong><strong>EdgeWorker DataStream 主要目的地</strong></strong></p>
<ul>
<li>AWS S3</li>
<li>Splunk</li>
<li>Datadog</li>
<li>Google Cloud Storage</li>
<li>HTTPS</li>
<li>New Relic</li>
<li>Azure Storage</li>
<li>S3 兼容存储（包括 Akamai 的对象存储）</li>
<li>TrafficPeak</li>
<li>Sumo Logic</li>
</ul>
<h4 data-id="heading-0"><strong><strong>EdgeWorker 日志记录入门</strong></strong></h4>
<p>为您的 EdgeWorkers 设置日志记录非常简单，前提是您已经在代码包中添加了日志消息。首先，确保您的合约中包含了用于 EdgeWorkers 的 DataStream。这是一项免费服务，但需要合约授权才能启用。要添加用于 EdgeWorkers 的 DataStream，请联系您的客户代表。然后，按照以下步骤启用服务：</p>
<ol>
<li>通过 Control Center 的通用服务部分导航到 DataStream 服务</li>
<li>选择"创建 EdgeWorkers 流"</li>
<li>为您的流命名</li>
<li>最后，从结构化或 JSON 格式中选择，并选择目标目的地。</li>
</ol>
<p>就这样！您现在可以编写您的 EdgeWorkers 日志记录逻辑了，一旦激活，即可启用 Datastream 来使用它。要了解更多信息并获得完整的分步说明，请参阅有关启用和配置 EdgeWorker 日志流的详细文档。请参考 EdgeWorker JavaScript DataStream 设置页面。</p>
<p>以下是一些设置过程的示例截图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9de1aba16d2149138e0cf8825a4cdf1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUtBTUFJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764777416&amp;x-signature=Qh6ptPiWuueypuMEqgOfX2VR%2BlY%3D" alt="" loading="lazy"/></p>
<p><strong>设置 EW 日志流</strong></p>
<p><strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb0702ac82784a709f64e889daaafd39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUtBTUFJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764777416&amp;x-signature=QFmOxZGrjIyOmC7pJaSZPXS6mh0%3D" alt="" loading="lazy"/></strong></p>
<p><strong>配置日志流目的地</strong></p>
<h4 data-id="heading-1"><strong><strong>EdgeWorker 可观测性有哪些新功能和即将推出的功能？</strong></strong></h4>
<p>未来的改进设想包括启用 OpenTelemetry 格式、支持数据本地化，以及可能允许基于属性的流式传输，而不是按每个 EdgeWorker 进行跟踪。关于可观测性方面，您可以在 ACC 门户中的 EdgeWorkers 执行报告中期待改进，因为我们很快将添加挂钟时间跟踪、初始化指标并简化报告。</p>
<p>一如既往，如果您对如何改进 EdgeWorker 可观测性或服务的任何其他方面有任何疑问或建议，请联系您的客户代表，或在我们<a href="https://link.juejin.cn?target=https%3A%2F%2Fcommunity.akamai.com%2Fcustomers%2Fs%2F%3Flanguage%3Dzh_CN%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251126_external1_blogarticles230" target="_blank" title="https://community.akamai.com/customers/s/?language=zh_CN?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251126_external1_blogarticles230" ref="nofollow noopener noreferrer">社区网站</a>上给我们留言。祝您日志记录愉快！</p>
<h4 data-id="heading-2"><strong><strong>了解更多关于 Akamai EdgeWorkers 的信息</strong></strong></h4>
<p>查看这些 Akamai 资源，了解 Akamai EdgeWorkers 如何使您的组织受益：</p>
<ul>
<li>EdgeWorkers TechDocs 文档</li>
<li>EdgeCompute 提供的 EdgeWorkers 代码示例</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcommunity.akamai.com%2Fcustomers%2Fs%2F%3Flanguage%3Dzh_CN%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251126_external2_blogarticles230" target="_blank" title="https://community.akamai.com/customers/s/?language=zh_CN?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251126_external2_blogarticles230" ref="nofollow noopener noreferrer">Akamai 开发者讨论论坛</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86d8e91c09a44f92ac095b95313ad95c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUtBTUFJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764777416&amp;x-signature=a6aQMDIPynw%2FDxWMTrxV02iFPhs%3D" alt="" loading="lazy"/></p>
<p>如您所在的企业也在考虑采购云服务或进行云迁移，</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linode.com%2Fzh%2Flp%2Fakamai-cloud-computing-freetrial%2F%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejin_251126_blogarticles230_end" target="_blank" title="https://www.linode.com/zh/lp/akamai-cloud-computing-freetrial/?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejin_251126_blogarticles230_end" ref="nofollow noopener noreferrer">点击链接</a>了解Akamai Linode解决方案，现在申请试用可得高达500美元专属额度</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[K8s: 如何通过kubectl命令实时监控滚动更新的详细过程？]]></title>    <link>https://juejin.cn/post/7576893180080504874</link>    <guid>https://juejin.cn/post/7576893180080504874</guid>    <pubDate>2025-11-26T14:06:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576893180080504874" data-draft-id="7576888607479562259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="K8s: 如何通过kubectl命令实时监控滚动更新的详细过程？"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-11-26T14:06:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            K8s: 如何通过kubectl命令实时监控滚动更新的详细过程？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T14:06:48.000Z" title="Wed Nov 26 2025 14:06:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Kubernetes 中实时监控滚动更新的详细过程，可以通过组合使用多个 <code>kubectl</code>命令来实现。下面这个表格汇总了最核心的命令及其用途，你可以根据不同的监控需求来选择。</p>






























<table><thead><tr><th>监控命令</th><th>主要用途</th><th>关键参数 / 说明</th></tr></thead><tbody><tr><td><code>kubectl rollout status deployment/&lt;部署名称&gt;</code></td><td><strong>核心进度监控</strong>：实时显示更新整体进度，直到完成或失败。</td><td>无特殊参数，专注于进度状态。</td></tr><tr><td><code>kubectl get pods -w -l &lt;标签&gt;</code></td><td><strong>Pod级别详情</strong>：动态显示Pod的新旧替换、状态变化等详细过程。</td><td><code>-w</code>用于实时监视；<code>-l</code>按标签筛选特定Deployment的Pod。</td></tr><tr><td><code>kubectl describe deployment &lt;部署名称&gt;</code></td><td><strong>事件与配置洞察</strong>：查看更新触发原因、ReplicaSet变化及关键事件日志。</td><td>输出信息详细，适合在更新停滞或出错时深挖原因。</td></tr><tr><td><code>kubectl get replicasets -w</code></td><td><strong>幕后视角</strong>：观察为新旧版本创建的ReplicaSet及其副本数量的变化。</td><td>了解Deployment控制器如何通过管理ReplicaSet来完成滚动更新。</td></tr></tbody></table>
<h3 data-id="heading-0">🧩 理解监控的关键节点</h3>
<p>在监控时，理解一些关键状态的含义能让你更清楚更新进行到了哪一步：</p>
<ul>
<li><strong><code>UP-TO-DATE</code></strong>：显示当前已更新到新版本的 Pod 数量。</li>
<li><strong><code>AVAILABLE</code></strong>：显示当前可供用户使用的 Pod 数量，这些 Pod 已经处于就绪（Ready）状态。</li>
<li><strong>Pod 的状态</strong>：在 <code>kubectl get pods</code>的输出中，<code>ContainerCreating</code>表示Pod正在创建，<code>Terminating</code>表示旧Pod正在终止。</li>
</ul>
<h3 data-id="heading-1">🛠️ 综合监控实战示例</h3>
<p>假设你要监控一个名为 <code>my-app</code>的 Deployment 的更新过程。</p>
<ol>
<li>
<p><strong>触发更新</strong>：首先执行更新命令，例如更新镜像版本。</p>
<pre><code class="hljs language-perl" lang="perl">kubectl set image deployment/<span class="hljs-keyword">my</span>-app <span class="hljs-keyword">my</span>-app=<span class="hljs-keyword">my</span>-app:v2.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>
</code></pre>
</li>
<li>
<p><strong>开启多个终端标签页进行综合监控</strong>：</p>
<ul>
<li>
<p><strong>标签页1：启动核心进度监控</strong></p>
<pre><code class="hljs language-bash" lang="bash">kubectl rollout status deployment/my-app
</code></pre>
<p>这个命令会持续输出类似 <code>Waiting for rollout to finish: 2 out of 3 new replicas have been updated...</code>的信息，并在成功后提示 <code>deployment "my-app" successfully rolled out</code>。</p>
</li>
<li>
<p><strong>标签页2：启动Pod详情监控</strong></p>
<pre><code class="hljs language-ini" lang="ini">kubectl get pods -w -l <span class="hljs-attr">app</span>=my-app
</code></pre>
<p>这里你可以清晰地看到Kubernetes如何逐步启动新Pod（状态从 <code>Pending</code>到 <code>ContainerCreating</code>再到 <code>Running</code>），并终止旧Pod（状态变为 <code>Terminating</code>）。</p>
</li>
<li>
<p><strong>标签页3（可选）：启动幕后视角监控</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">kubectl get replicasets -w
</code></pre>
<p>此命令可让你观察到，Deployment 会创建一个新的 ReplicaSet 来管理新版本的 Pod（其副本数从0逐步增加），而旧的 ReplicaSet 的副本数则逐渐缩减到0。</p>
</li>
</ul>
</li>
<li>
<p><strong>遇到问题时进行深度排查</strong>：如果更新卡住或失败，使用 <code>describe</code>命令查看详细信息和事件。</p>
<pre><code class="hljs language-perl" lang="perl">kubectl describe deployment <span class="hljs-keyword">my</span>-app
</code></pre>
<p>在输出结果的 <code>Events</code>部分，包含了关于滚动更新过程的详细日志，例如 <code>Scaled up replica set my-app-7c54d5c99 to 1</code>（扩容新ReplicaSet）和 <code>Scaled down replica set my-app-7d47f45c6 to 2</code>（缩容旧ReplicaSet）等，这对于排查就绪探针失败、资源不足等问题非常有帮助。</p>
</li>
</ol>
<h3 data-id="heading-2">💡 进阶技巧与注意事项</h3>
<ul>
<li>
<p><strong>就绪探针的重要性</strong>：为了使 <code>rollout status</code>命令能准确判断新Pod是否可用，你的Pod定义中必须配置有效的 <code>readinessProbe</code>（就绪探针）。Kubernetes 只有在新Pod的就绪探针检查通过后，才会认为该Pod已就绪，然后继续替换下一个旧Pod。</p>
</li>
<li>
<p><strong>进度期限</strong>：Deployment 有一个 <code>progressDeadlineSeconds</code>配置（默认为600秒）。如果更新过程超过此时间仍未完成，Kubernetes 会将其标记为失败。你可以通过 <code>kubectl describe deployment</code>命令的结果来查看状态。</p>
</li>
<li>
<p><strong>一键回滚</strong>：如果发现新版本有问题，可以快速回滚到上一个版本。</p>
<pre><code class="hljs language-bash" lang="bash">kubectl rollout undo deployment/my-app
</code></pre>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Grab 原理篇：它是怎么"偷窥" React 的？]]></title>    <link>https://juejin.cn/post/7576843726011973658</link>    <guid>https://juejin.cn/post/7576843726011973658</guid>    <pubDate>2025-11-26T14:21:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576843726011973658" data-draft-id="7576856418470707210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Grab 原理篇：它是怎么&quot;偷窥&quot; React 的？"/> <meta itemprop="keywords" content="AI编程,人工智能,React.js"/> <meta itemprop="datePublished" content="2025-11-26T14:21:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Grab 原理篇：它是怎么"偷窥" React 的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T14:21:33.000Z" title="Wed Nov 26 2025 14:21:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上一篇我们介绍了 React Grab 是什么、怎么用。</p>
<p>这一篇，我们来聊点硬核的——<strong>它到底是怎么做到的？</strong></p>
<p>当你按下 <code>⌘C</code> 点击一个按钮，它是怎么知道这个按钮：</p>
<ul>
<li>住在哪个文件</li>
<li>第几行代码</li>
<li>属于哪个组件</li>
<li>有什么样式</li>
</ul>
<p>让我们掀开它的底裤看看。</p>
<hr/>
<h2 data-id="heading-1">整体架构：三层蛋糕</h2>
<p>React Grab 的架构可以理解为三层蛋糕：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph ReactGrab["React Grab"]
        subgraph Layers["三层架构"]
            Event["🎯 事件层&lt;br/&gt;(原生 DOM)"]
            Analysis["🔍 分析层&lt;br/&gt;(bippy)"]
            UI["🎨 UI 层&lt;br/&gt;(Solid.js)"]
        end

        Core["⚙️ 核心协调器&lt;br/&gt;(core.tsx)"]
        Clipboard["📋 剪贴板 API"]

        Event --&gt; Core
        Analysis --&gt; Core
        UI --&gt; Core
        Core --&gt; Clipboard
    end

    style Event fill:#e1f5fe
    style Analysis fill:#fff3e0
    style UI fill:#f3e5f5
    style Core fill:#e8f5e9
    style Clipboard fill:#fce4ec
</code></pre>
<p><strong>第一层：事件层</strong> - 监听你的键盘和鼠标，知道你什么时候想"抓"东西</p>
<p><strong>第二层：分析层</strong> - 拿到你点击的元素后，去 React 内部"偷"信息</p>
<p><strong>第三层：UI 层</strong> - 在页面上画高亮框、显示标签</p>
<p>最后，核心协调器把所有信息打包，扔进剪贴板。</p>
<hr/>
<h2 data-id="heading-2">第一层：事件监听</h2>
<h3 data-id="heading-3">它怎么知道你要抓？</h3>
<p>用户交互的状态机：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">stateDiagram-v2
    [*] --&gt; 待命: 页面加载

    待命 --&gt; 抓取模式: 按下 ⌘C / Ctrl+C
    抓取模式 --&gt; 待命: 松开按键

    抓取模式 --&gt; 悬停高亮: 鼠标移动到元素
    悬停高亮 --&gt; 抓取模式: 鼠标移开

    悬停高亮 --&gt; 执行抓取: 鼠标点击
    执行抓取 --&gt; 复制完成: 写入剪贴板
    复制完成 --&gt; 抓取模式: 继续选择其他元素
    复制完成 --&gt; 待命: 松开按键
</code></pre>
<p>React Grab 监听三类事件：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用 AbortController 统一管理事件监听器</span>
<span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();

<span class="hljs-comment">// 1. 键盘事件：检测 Cmd+C / Ctrl+C</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> ((e.<span class="hljs-property">metaKey</span> || e.<span class="hljs-property">ctrlKey</span>) &amp;&amp; e.<span class="hljs-property">key</span> === <span class="hljs-string">'c'</span>) {
    <span class="hljs-title function_">activateGrabMode</span>();  <span class="hljs-comment">// 进入"抓取模式"</span>
  }
}, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> });

<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keyup'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Meta'</span> || e.<span class="hljs-property">key</span> === <span class="hljs-string">'Control'</span>) {
    <span class="hljs-title function_">deactivateGrabMode</span>();  <span class="hljs-comment">// 退出"抓取模式"</span>
  }
}, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> });

<span class="hljs-comment">// 2. 鼠标移动：追踪悬停位置</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, handleMouseMove, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> });

<span class="hljs-comment">// 3. 鼠标点击：执行抓取</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousedown'</span>, handleMouseDown, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> });
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseup'</span>, handleMouseUp, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> });
</code></pre>
<h3 data-id="heading-4">为什么高亮不会"抖"？</h3>
<p>如果鼠标稍微动一下就切换高亮元素，体验会很差。</p>
<p>React Grab 用了一个小技巧——<strong>稳定检测</strong>：</p>
<ul>
<li>鼠标移动超过 200px 才重新计算</li>
<li>停留 100ms 后才显示高亮</li>
<li>只有"稳定"悬停时才触发</li>
</ul>
<p>这就是为什么你快速划过元素时，高亮框不会疯狂闪烁。</p>
<hr/>
<h2 data-id="heading-5">第二层：React Fiber 访问（核心黑魔法）</h2>
<p>这是整个工具最精彩的部分。</p>
<h3 data-id="heading-6">什么是 Fiber？</h3>
<p>Fiber 是 React 16+ 的内部数据结构。你可以把它理解为 React 的"私人笔记本"，记录了每个组件的：</p>
<ul>
<li>它是谁（组件类型）</li>
<li>它长什么样（props）</li>
<li>它现在的状态（state）</li>
<li>它的家人是谁（父/子/兄弟节点）</li>
<li><strong>它从哪里来</strong>（源代码位置）</li>
</ul>
<p>最后一条是关键——React 在开发模式下，会偷偷记录每个组件的源代码位置。</p>
<h3 data-id="heading-7">怎么访问 Fiber？</h3>
<p>React Grab 使用了一个叫 <code>bippy</code> 的库（也是作者 Aiden Bai 写的）来访问 Fiber：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { _fiberRoots <span class="hljs-keyword">as</span> fiberRoots, instrument } <span class="hljs-keyword">from</span> <span class="hljs-string">"bippy"</span>;

<span class="hljs-comment">// 注册一个"间谍"，监听 React 的 commit 阶段</span>
<span class="hljs-title function_">instrument</span>({
  <span class="hljs-title function_">onCommitFiberRoot</span>(<span class="hljs-params">_, fiberRoot</span>) {
    <span class="hljs-comment">// 每次 React 渲染完成，就把 fiber 根节点收集起来</span>
    fiberRoots.<span class="hljs-title function_">add</span>(fiberRoot);
  },
});
</code></pre>
<p>这段代码做了什么？</p>
<ol>
<li>React 每次渲染完成（commit），都会触发这个回调</li>
<li><code>bippy</code> 把 Fiber 根节点存起来</li>
<li>之后我们就可以从这些根节点遍历整棵 Fiber 树</li>
</ol>
<h3 data-id="heading-8">从 DOM 到 Fiber</h3>
<p>当你点击一个 DOM 元素，React Grab 需要找到它对应的 Fiber 节点：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    DOM["🖱️ DOM 元素&lt;br/&gt;(HTMLElement)"]
    Fiber["🧬 Fiber 节点&lt;br/&gt;(_debugSource)"]
    Source["📍 源代码位置&lt;br/&gt;(fileName, lineNumber)"]

    DOM --&gt;|"__reactFiber$xxx"| Fiber
    Fiber --&gt;|"读取 _debugSource"| Source

    style DOM fill:#e3f2fd
    style Fiber fill:#fff8e1
    style Source fill:#e8f5e9
</code></pre>
<p>具体怎么做？React 会在 DOM 元素上挂一个隐藏属性，指向对应的 Fiber 节点。<code>bippy</code> 封装了这个逻辑：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> {
  getSourceFromHostInstance,
  normalizeFileName,
  isSourceFile
} <span class="hljs-keyword">from</span> <span class="hljs-string">"bippy/dist/source"</span>;

<span class="hljs-comment">// 从 DOM 元素获取源代码位置</span>
<span class="hljs-keyword">const</span> source = <span class="hljs-title function_">getSourceFromHostInstance</span>(domElement);
<span class="hljs-comment">// 返回: { fileName: 'src/Button.tsx', lineNumber: 42, columnNumber: 5 }</span>
</code></pre>
<p>一行代码，就拿到了文件路径和行号。</p>
<hr/>
<h2 data-id="heading-9">源代码位置是哪来的？</h2>
<p>你可能好奇：React 怎么知道每个组件在源代码的哪一行？</p>
<p>答案是：<strong>Babel 插件</strong>。</p>
<h3 data-id="heading-10">编译时注入</h3>
<p>整个流程是这样的：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph Dev["开发时"]
        JSX["📝 JSX 代码&lt;br/&gt;&amp;lt;Button&amp;gt;提交&amp;lt;/Button&amp;gt;"]
        Babel["🔧 Babel 编译"]
        JS["📄 带 __source 的 JS"]
    end

    subgraph Runtime["运行时"]
        React["⚛️ React 创建 Fiber"]
        Fiber["🧬 Fiber 节点&lt;br/&gt;_debugSource"]
    end

    subgraph Tool["React Grab"]
        Grab["🎯 读取 _debugSource"]
        Output["📋 输出位置信息"]
    end

    JSX --&gt;|"@babel/plugin-transform-react-jsx-source"| Babel
    Babel --&gt; JS
    JS --&gt;|"React.createElement()"| React
    React --&gt; Fiber
    Fiber --&gt;|"bippy"| Grab
    Grab --&gt; Output

    style JSX fill:#e3f2fd
    style Babel fill:#fff3e0
    style JS fill:#e8f5e9
    style React fill:#e1f5fe
    style Fiber fill:#fff8e1
    style Grab fill:#f3e5f5
    style Output fill:#fce4ec
</code></pre>
<p>当你写 JSX：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Button</span> onClick={handleClick}&gt;提交&lt;/<span class="hljs-title class_">Button</span>&gt;
</code></pre>
<p>Babel 在开发模式下会把它转换成：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title class_">Button</span>, {
  <span class="hljs-attr">onClick</span>: handleClick,
  <span class="hljs-attr">__source</span>: {
    <span class="hljs-attr">fileName</span>: <span class="hljs-string">"/src/App.tsx"</span>,
    <span class="hljs-attr">lineNumber</span>: <span class="hljs-number">42</span>,
    <span class="hljs-attr">columnNumber</span>: <span class="hljs-number">5</span>
  }
}, <span class="hljs-string">"提交"</span>)
</code></pre>
<p>看到了吗？<code>__source</code> 属性是 Babel 自动加的。</p>
<p>这是由 <code>@babel/plugin-transform-react-jsx-source</code> 插件完成的，React 脚手架（Create React App、Vite、Next.js）在开发模式下都会自动启用它。</p>
<h3 data-id="heading-11">存储在 Fiber 中</h3>
<p>React 拿到 <code>__source</code> 后，会把它存到 Fiber 节点的 <code>_debugSource</code> 字段：</p>
<pre><code class="hljs language-typescript" lang="typescript">fiber.<span class="hljs-property">_debugSource</span> = {
  <span class="hljs-attr">fileName</span>: <span class="hljs-string">"/src/App.tsx"</span>,
  <span class="hljs-attr">lineNumber</span>: <span class="hljs-number">42</span>,
  <span class="hljs-attr">columnNumber</span>: <span class="hljs-number">5</span>
}
</code></pre>
<p>这就是 React Grab 能精准定位源代码的秘密——<strong>React 自己就记着呢</strong>，它只是把信息读出来而已。</p>
<hr/>
<h2 data-id="heading-12">第三层：UI 渲染</h2>
<h3 data-id="heading-13">一个有趣的选择</h3>
<p>React Grab 的 UI（高亮框、标签）是用 <strong>Solid.js</strong> 写的，不是 React。</p>
<p>为什么？</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createSignal, createMemo, createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">'solid-js'</span>;

<span class="hljs-comment">// 响应式状态</span>
<span class="hljs-keyword">const</span> [isActive, setIsActive] = <span class="hljs-title function_">createSignal</span>(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">const</span> [hoveredElement, setHoveredElement] = createSignal&lt;<span class="hljs-title class_">Element</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

<span class="hljs-comment">// 派生状态：高亮框的位置</span>
<span class="hljs-keyword">const</span> highlightStyle = <span class="hljs-title function_">createMemo</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> el = <span class="hljs-title function_">hoveredElement</span>();
  <span class="hljs-keyword">if</span> (!el) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">const</span> rect = el.<span class="hljs-title function_">getBoundingClientRect</span>();
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">top</span>: rect.<span class="hljs-property">top</span> + <span class="hljs-string">'px'</span>,
    <span class="hljs-attr">left</span>: rect.<span class="hljs-property">left</span> + <span class="hljs-string">'px'</span>,
    <span class="hljs-attr">width</span>: rect.<span class="hljs-property">width</span> + <span class="hljs-string">'px'</span>,
    <span class="hljs-attr">height</span>: rect.<span class="hljs-property">height</span> + <span class="hljs-string">'px'</span>
  };
});
</code></pre>
<h3 data-id="heading-14">为什么不用 React？</h3>
<p>四个原因：</p>
<ol>
<li><strong>隔离性</strong> - 不会和你应用的 React 冲突。想象一下，一个检测 React 的工具自己也用 React，那不是套娃吗？</li>
<li><strong>轻量</strong> - Solid.js 的运行时只有几 KB，React 要大得多</li>
<li><strong>性能</strong> - Solid.js 是细粒度响应式，更新 UI 更高效</li>
<li><strong>无依赖</strong> - 不需要完整的 React 运行时</li>
</ol>
<p>这是一个很聪明的架构决策。</p>
<hr/>
<h2 data-id="heading-15">最后一步：剪贴板</h2>
<h3 data-id="heading-16">数据结构</h3>
<p>React Grab 把收集到的信息打包成一个结构化对象：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">GrabData</span> {
  <span class="hljs-comment">// 源代码信息</span>
  <span class="hljs-attr">source</span>: {
    <span class="hljs-attr">fileName</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">lineNumber</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">columnNumber</span>: <span class="hljs-built_in">number</span>;
  };

  <span class="hljs-comment">// 组件信息</span>
  <span class="hljs-attr">component</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">ancestors</span>: <span class="hljs-built_in">string</span>[];  <span class="hljs-comment">// 组件层级链</span>
  };

  <span class="hljs-comment">// DOM 信息</span>
  <span class="hljs-attr">dom</span>: {
    <span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">tagName</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">className</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">dimensions</span>: { <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span> };
  };

  <span class="hljs-comment">// HTML 片段</span>
  <span class="hljs-attr">htmlSnippet</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<h3 data-id="heading-17">CSS 选择器生成</h3>
<p>为了让 AI 能精准定位元素，还需要生成一个唯一的 CSS 选择器：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { finder } <span class="hljs-keyword">from</span> <span class="hljs-string">'@medv/finder'</span>;

<span class="hljs-keyword">const</span> selector = <span class="hljs-title function_">finder</span>(element);
<span class="hljs-comment">// 返回: "#app &gt; div.container &gt; button.submit-btn"</span>
</code></pre>
<p><code>@medv/finder</code> 是一个专门干这个的库，它会生成最短且唯一的选择器。</p>
<h3 data-id="heading-18">写入剪贴板</h3>
<p>最后一步，把数据写入剪贴板：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用现代 Clipboard API</span>
navigator.<span class="hljs-property">clipboard</span>.<span class="hljs-title function_">write</span>([
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClipboardItem</span>({
    <span class="hljs-string">'text/html'</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([htmlContent], { <span class="hljs-attr">type</span>: <span class="hljs-string">'text/html'</span> }),
    <span class="hljs-string">'text/plain'</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([plainText], { <span class="hljs-attr">type</span>: <span class="hljs-string">'text/plain'</span> })
  })
]);
</code></pre>
<p>注意它同时写了两种格式：</p>
<ul>
<li><code>text/html</code> - 结构化数据，AI 工具可以解析</li>
<li><code>text/plain</code> - 纯文本，直接粘贴也能看</li>
</ul>
<hr/>
<h2 data-id="heading-19">技术栈总结</h2>
<p>React Grab 用到的核心技术：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap
  root((React Grab))
    事件层
      原生 DOM API
      键盘事件
      鼠标事件
      AbortController
    分析层
      bippy
      Fiber 访问
      _debugSource
      组件层级
    UI 层
      Solid.js
      高亮框
      标签提示
      响应式更新
    输出层
      Clipboard API
      @medv/finder
      结构化数据
</code></pre>








































<table><thead><tr><th>模块</th><th>技术</th><th>作用</th></tr></thead><tbody><tr><td>事件监听</td><td>原生 DOM API</td><td>捕获键盘/鼠标事件</td></tr><tr><td>Fiber 访问</td><td>bippy</td><td>读取 React 内部数据</td></tr><tr><td>源码定位</td><td>Babel 插件</td><td>编译时注入位置信息</td></tr><tr><td>选择器生成</td><td>@medv/finder</td><td>生成唯一 CSS 选择器</td></tr><tr><td>UI 渲染</td><td>Solid.js</td><td>绘制高亮框和标签</td></tr><tr><td>数据传递</td><td>Clipboard API</td><td>复制到剪贴板</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-20">几个精妙的设计</h2>
<h3 data-id="heading-21">1. 不侵入应用代码</h3>
<p>React Grab 完全是"外挂"式的：</p>
<ul>
<li>不需要修改你的组件代码</li>
<li>不需要安装 Babel 插件（React 自带的就够了）</li>
<li>不会影响应用的正常运行</li>
</ul>
<h3 data-id="heading-22">2. 开发模式限定</h3>
<p>它依赖的 <code>_debugSource</code> 只在开发模式存在，所以：</p>
<ul>
<li>生产环境天然无效</li>
<li>不会泄露源码信息</li>
<li>不会增加生产包体积</li>
</ul>
<h3 data-id="heading-23">3. 轻量且独立</h3>
<p>用 Solid.js 而不是 React 来做 UI，既保证了轻量，又避免了和应用 React 的冲突。</p>
<hr/>
<h2 data-id="heading-24">局限性</h2>
<p>当然，这套方案也有局限：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph Works["✅ 能用"]
        React["React 16+"]
        Dev["开发模式"]
        Modern["现代浏览器"]
    end

    subgraph NotWork["❌ 不能用"]
        Vue["Vue"]
        Angular["Angular"]
        Svelte["Svelte"]
        Prod["生产环境"]
        IE["IE 浏览器"]
    end

    React -.-&gt;|"Fiber 架构"| Works
    Dev -.-&gt;|"_debugSource"| Works

    Vue -.-&gt;|"无 Fiber"| NotWork
    Angular -.-&gt;|"不同架构"| NotWork
    Svelte -.-&gt;|"编译时框架"| NotWork
    Prod -.-&gt;|"无调试信息"| NotWork

    style Works fill:#e8f5e9
    style NotWork fill:#ffebee
</code></pre>
<h3 data-id="heading-25">只能用于 React</h3>
<p>它深度依赖 React Fiber 架构，所以：</p>
<ul>
<li>❌ Vue - 没有 Fiber</li>
<li>❌ Angular - 完全不同的架构</li>
<li>❌ Svelte - 编译时框架，运行时没有组件树</li>
</ul>
<h3 data-id="heading-26">只能用于开发模式</h3>
<p>生产环境的代码：</p>
<ul>
<li>没有 <code>_debugSource</code></li>
<li>被压缩混淆了</li>
<li>Source Map 通常也不开放</li>
</ul>
<p>所以只能在开发时用。</p>
<h3 data-id="heading-27">依赖 Source Map</h3>
<p>如果你的构建工具没有生成 Source Map，或者禁用了 JSX source 插件，定位就会失效。</p>
<hr/>
<h2 data-id="heading-28">总结</h2>
<p>React Grab 的原理可以用一句话概括：</p>
<blockquote>
<p><strong>利用 React 在开发模式下自带的源码位置信息，通过 Fiber 树反向查找，把元素的"身份证"复制给 AI。</strong></p>
</blockquote>
<p>它不是什么黑科技，而是巧妙地利用了 React 已有的调试机制。</p>
<p>这也是为什么它能做到：</p>
<ul>
<li>零配置</li>
<li>零侵入</li>
<li>零性能影响</li>
</ul>
<p>因为脏活累活，React 和 Babel 已经帮你干完了。</p>
<hr/>
<h2 data-id="heading-29">相关资源</h2>
<ul>
<li><strong>React Grab GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faidenybai%2Freact-grab" target="_blank" title="https://github.com/aidenybai/react-grab" ref="nofollow noopener noreferrer">github.com/aidenybai/r…</a></li>
<li><strong>bippy（Fiber 访问库）</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faidenybai%2Fbippy" target="_blank" title="https://github.com/aidenybai/bippy" ref="nofollow noopener noreferrer">github.com/aidenybai/b…</a></li>
<li><strong>@medv/finder（选择器生成）</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantonmedv%2Ffinder" target="_blank" title="https://github.com/antonmedv/finder" ref="nofollow noopener noreferrer">github.com/antonmedv/f…</a></li>
<li><strong>Solid.js</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.solidjs.com%2F" target="_blank" title="https://www.solidjs.com/" ref="nofollow noopener noreferrer">www.solidjs.com/</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Helm深度解析：Kubernetes应用管理的利器]]></title>    <link>https://juejin.cn/post/7576888607479627795</link>    <guid>https://juejin.cn/post/7576888607479627795</guid>    <pubDate>2025-11-26T14:26:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576888607479627795" data-draft-id="7576888607479578643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Helm深度解析：Kubernetes应用管理的利器"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-11-26T14:26:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Helm深度解析：Kubernetes应用管理的利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T14:26:32.000Z" title="Wed Nov 26 2025 14:26:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：为什么我们需要Helm？</h2>
<p>在现代云原生环境中，Kubernetes已成为容器编排的事实标准。然而，当应用复杂度增加时，直接使用kubectl管理Kubernetes资源文件变得异常繁琐。每个微服务都可能涉及Deployment、Service、ConfigMap等多种资源，而多环境部署更是雪上加霜。这正是Helm的用武之地——作为Kubernetes的包管理器，它将应用打包成可复用的Chart，极大简化了部署和管理流程。</p>
<p>本文将深入解析Helm的核心机制，并通过实际案例展示其强大功能，同时揭示最佳实践和常见陷阱。</p>
<h2 data-id="heading-1">一、Helm核心架构与工作原理</h2>
<h3 data-id="heading-2">1.1 Helm三大核心概念</h3>
<p>Helm的架构建立在三个基本概念之上，它们共同构成了一个完整的应用管理生态系统：</p>
<ul>
<li><strong>Chart</strong>：Helm的应用包装格式，包含应用的所有Kubernetes资源定义模板和配置参数。类比于Linux系统中的RPM或DEB包。</li>
<li><strong>Release</strong>：Chart在Kubernetes集群中的运行实例。每次安装都会生成一个唯一的Release，记录该次部署的配置和状态。</li>
<li><strong>Repository</strong>：Chart的存储和分发中心，支持HTTP/S和OCI协议，便于团队共享和复用应用模板。</li>
</ul>
<h3 data-id="heading-3">1.2 Helm 3的革命性改进</h3>
<p>Helm 3移除了Tiller组件，直接通过kubeconfig与Kubernetes API交互，显著提升了安全性和简化了架构。这一变化解决了Helm 2中存在的安全隐患和复杂的RBAC配置问题。</p>
<h2 data-id="heading-4">二、Helm Chart深度设计与实战</h2>
<h3 data-id="heading-5">2.1 多层微服务Chart设计</h3>
<p>考虑一个典型的三层应用架构（前端、后端、数据库），Helm通过子Chart依赖关系优雅地管理这种复杂应用。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Chart.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v2</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">ecommerce-app</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">A</span> <span class="hljs-string">multi-tier</span> <span class="hljs-string">ecommerce</span> <span class="hljs-string">application</span>
<span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span>
<span class="hljs-attr">dependencies:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">frontend</span>
    <span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span>
    <span class="hljs-attr">repository:</span> <span class="hljs-string">file://../frontend</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">backend</span>
    <span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span>
    <span class="hljs-attr">repository:</span> <span class="hljs-string">file://../backend</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">database</span>
    <span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span>
    <span class="hljs-attr">repository:</span> <span class="hljs-string">file://../database</span>
</code></pre>
<p><strong>依赖管理策略</strong>有两种主要方式：</p>
<ul>
<li><strong>嵌入式依赖</strong>：子Chart作为父Chart的一部分，紧耦合，简单但不够灵活</li>
<li><strong>依赖导入式</strong>：各Chart独立开发调试，松耦合，复杂但更灵活</li>
</ul>
<h3 data-id="heading-6">2.2 模板引擎高级用法</h3>
<p>Helm使用Go模板语言实现配置的动态化。以下是一个生产环境可用的Deployment模板示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> {{ <span class="hljs-string">.Release.Name</span> }}<span class="hljs-string">-{{</span> <span class="hljs-string">.Chart.Name</span> <span class="hljs-string">}}</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> {{ <span class="hljs-string">.Chart.Name</span> }}
    <span class="hljs-attr">version:</span> {{ <span class="hljs-string">.Chart.AppVersion</span> }}
    <span class="hljs-attr">environment:</span> {{ <span class="hljs-string">.Values.environment</span> <span class="hljs-string">|</span> <span class="hljs-string">default</span> <span class="hljs-string">"prod"</span> }}
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> {{ <span class="hljs-string">.Values.replicaCount</span> }}
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> {{ <span class="hljs-string">.Chart.Name</span> }}
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> {{ <span class="hljs-string">.Chart.Name</span> }}
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> {{ <span class="hljs-string">.Chart.Name</span> }}
          <span class="hljs-attr">image:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ .Values.image.repository }}</span>:<span class="hljs-template-variable">{{ .Values.image.tag }}</span>"</span>
          <span class="hljs-attr">imagePullPolicy:</span> {{ <span class="hljs-string">.Values.image.pullPolicy</span> }}
          {{<span class="hljs-bullet">-</span> <span class="hljs-string">with</span> <span class="hljs-string">.Values.resources</span> }}
          <span class="hljs-attr">resources:</span>
            {{<span class="hljs-bullet">-</span> <span class="hljs-string">toYaml</span> <span class="hljs-string">.</span> <span class="hljs-string">|</span> <span class="hljs-string">nindent</span> <span class="hljs-number">12</span> }}
          {{<span class="hljs-bullet">-</span> <span class="hljs-string">end</span> }}
          <span class="hljs-attr">env:</span>
          {{<span class="hljs-bullet">-</span> <span class="hljs-string">range</span> <span class="hljs-string">$name</span>, <span class="hljs-string">$value</span> <span class="hljs-string">:=</span> <span class="hljs-string">.Values.env</span> }}
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> {{ <span class="hljs-string">$name</span> }}
              <span class="hljs-attr">value:</span> {{ <span class="hljs-string">$value</span> <span class="hljs-string">|</span> <span class="hljs-string">quote</span> }}
          {{<span class="hljs-bullet">-</span> <span class="hljs-string">end</span> }}
</code></pre>
<p>模板中支持复杂的控制结构、函数和管道操作，大大增强了灵活性。</p>
<h3 data-id="heading-7">2.3 值文件设计与多环境管理</h3>
<p>通过分层配置管理，可以实现一套Chart多环境部署：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># values-prod.yaml</span>
<span class="hljs-attr">global:</span>
  <span class="hljs-attr">environment:</span> <span class="hljs-string">production</span>
  <span class="hljs-attr">domain:</span> <span class="hljs-string">example.com</span>

<span class="hljs-attr">frontend:</span>
  <span class="hljs-attr">replicaCount:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">image:</span>
    <span class="hljs-attr">tag:</span> <span class="hljs-string">"stable"</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">requests:</span>
      <span class="hljs-attr">memory:</span> <span class="hljs-string">"256Mi"</span>
      <span class="hljs-attr">cpu:</span> <span class="hljs-string">"250m"</span>
    <span class="hljs-attr">limits:</span>
      <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
      <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>

<span class="hljs-attr">backend:</span>
  <span class="hljs-attr">replicaCount:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">database:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">"mysql-production"</span>
</code></pre>
<h2 data-id="heading-8">三、Helm高级特性与部署控制</h2>
<h3 data-id="heading-9">3.1 资源部署顺序控制</h3>
<p>Helm不会简单地按文件顺序部署资源，而是遵循智能的排序规则。根据源码分析，内置的资源类型优先级如下：</p>
<ol>
<li><strong>Namespace, NetworkPolicy</strong>（基础环境隔离）</li>
<li><strong>ConfigMap, Secret</strong>（配置与敏感信息）</li>
<li><strong>PersistentVolumeClaim</strong>（存储资源）</li>
<li><strong>ServiceAccount, Role, RoleBinding</strong>（权限控制）</li>
<li><strong>Service</strong>（网络访问入口）</li>
<li><strong>Deployment, StatefulSet, DaemonSet</strong>（工作负载）</li>
<li><strong>Ingress</strong>（外部流量路由）</li>
</ol>
<p>这种排序确保了"基础设施优先于应用负载"的部署逻辑。</p>
<h3 data-id="heading-10">3.2 生命周期钩子精准控制</h3>
<p>Helm钩子允许在特定时间点执行自定义操作，常见钩子类型包括：</p>
<ul>
<li><code>pre-install</code>：在安装前执行（如预检检查）</li>
<li><code>post-install</code>：在安装后执行（如初始化数据库）</li>
<li><code>pre-upgrade</code>：在升级前执行（如备份数据）</li>
<li><code>post-upgrade</code>：在升级后执行（如清理临时文件)</li>
</ul>
<p>以下是一个数据库迁移钩子的示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Job</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ .Release.Name }}</span>-db-migrate"</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">"helm.sh/hook":</span> <span class="hljs-string">post-install,post-upgrade</span>
    <span class="hljs-attr">"helm.sh/hook-weight":</span> <span class="hljs-string">"5"</span>
    <span class="hljs-attr">"helm.sh/hook-delete-policy":</span> <span class="hljs-string">hook-succeeded</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Never</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">migrate</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ .Values.image.repository }}</span>:<span class="hljs-template-variable">{{ .Values.image.tag }}</span>"</span>
        <span class="hljs-attr">command:</span> [<span class="hljs-string">'sh'</span>, <span class="hljs-string">'-c'</span>, <span class="hljs-string">'python manage.py migrate'</span>]
</code></pre>
<h3 data-id="heading-11">3.3 依赖等待与就绪检查</h3>
<p>对于有严格依赖关系的服务，可以使用initContainer实现依赖等待：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spec:</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">initContainers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">wait-for-db</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:1.35</span>
        <span class="hljs-attr">command:</span> [<span class="hljs-string">'sh'</span>, <span class="hljs-string">'-c'</span>, <span class="hljs-string">'until nc -z <span class="hljs-template-variable">{{ .Values.mysql.host }}</span> <span class="hljs-template-variable">{{ .Values.mysql.port }}</span>; do echo "等待MySQL就绪..."; sleep 2; done'</span>]
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ .Values.image.repository }}</span>:<span class="hljs-template-variable">{{ .Values.image.tag }}</span>"</span>
</code></pre>
<h2 data-id="heading-12">四、Helm在CI/CD中的实战集成</h2>
<h3 data-id="heading-13">4.1 GitOps流水线集成</h3>
<p>将Helm与Argo CD等GitOps工具结合，可以实现声明式的持续部署：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># argo-app.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">argoproj.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Application</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">production-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">destination:</span>
    <span class="hljs-attr">server:</span> <span class="hljs-string">https://kubernetes.default.svc</span>
  <span class="hljs-attr">project:</span> <span class="hljs-string">default</span>
  <span class="hljs-attr">source:</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">charts/myapp</span>
    <span class="hljs-attr">repoURL:</span> <span class="hljs-string">https://git.example.com/helm-charts.git</span>
    <span class="hljs-attr">targetRevision:</span> <span class="hljs-string">main</span>
    <span class="hljs-attr">helm:</span>
      <span class="hljs-attr">valueFiles:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">values-prod.yaml</span>
  <span class="hljs-attr">syncPolicy:</span>
    <span class="hljs-attr">automated:</span>
      <span class="hljs-attr">prune:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">selfHeal:</span> <span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-14">4.2 安全最佳实践</h3>
<ol>
<li><strong>Secret管理</strong>：避免在values.yaml中硬编码敏感信息，使用外部Secret存储：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">helm install myapp ./chart --set-file dbPassword=./secrets/pass.txt
</code></pre>
<ol>
<li><strong>版本锁定</strong>：防止依赖版本漂移导致的不可预测行为：</li>
</ol>
<pre><code class="hljs language-css" lang="css">helm dependency build <span class="hljs-attr">--verify</span>
</code></pre>
<ol>
<li><strong>RBAC最小权限</strong>：为Helm创建专属ServiceAccount，遵循最小权限原则。</li>
</ol>
<h2 data-id="heading-15">五、Helm陷阱与规避策略</h2>
<h3 data-id="heading-16">5.1 过度模板化陷阱</h3>
<p><strong>症状</strong>：模板中大量条件判断、单个Chart管理过多微服务。</p>
<p><strong>解决方案</strong>：遵循"单一Chart单一服务"原则，复杂场景拆分为Subchart。</p>
<h3 data-id="heading-17">5.2 调试技巧</h3>
<p>Helm提供多种调试工具，帮助定位问题：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 模板渲染调试</span>
helm template --debug ./chart

<span class="hljs-comment"># 与集群中实际状态差异对比</span>
helm diff upgrade myapp ./chart

<span class="hljs-comment"># 干跑模式验证</span>
helm install --dry-run --debug ./chart
</code></pre>
<h3 data-id="heading-18">5.3 版本兼容性管理</h3>
<p>严格遵循SemVer版本规范，确保升级的兼容性：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Chart.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v2</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>
<span class="hljs-attr">version:</span> <span class="hljs-number">1.2</span><span class="hljs-number">.3</span>  <span class="hljs-comment"># 主版本.次版本.修订号</span>
<span class="hljs-attr">appVersion:</span> <span class="hljs-number">2.1</span><span class="hljs-number">.0</span>
</code></pre>
<h2 data-id="heading-19">六、真实场景案例：电商平台Helm化改造</h2>
<p>某电商平台在2022年双十一前完成Helm化改造，取得了显著成效：</p>
<ul>
<li><strong>部署时间</strong>：从3小时缩短至8分钟</li>
<li><strong>回滚效率</strong>：从人工检查YAML变为一键回滚</li>
<li><strong>配置错误率</strong>：降低92%</li>
</ul>
<p>其核心改造策略包括：</p>
<ol>
<li>将20+微服务拆分为独立的子Chart</li>
<li>通过全局Values管理跨服务配置</li>
<li>使用Helm钩子处理数据库迁移和初始化</li>
<li>集成到CI/CD流水线实现自动发布</li>
</ol>
<h2 data-id="heading-20">结论</h2>
<p>Helm作为Kubernetes应用管理的强大工具，通过模板化、版本控制和依赖管理，极大地简化了复杂应用的部署和管理。然而，它也是一把双刃剑——不当使用会导致配置复杂度反而增加。</p>
<p>掌握Helm的关键在于：<strong>理解其设计哲学，遵循最佳实践，适时使用高级特性</strong>。简单场景适度使用，复杂系统深度整合，始终遵循"基础设施即代码"原则。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[黑森林突袭！FLUX.2发布，这就是我们要的“生产力怪兽”]]></title>    <link>https://juejin.cn/post/7576893180080619562</link>    <guid>https://juejin.cn/post/7576893180080619562</guid>    <pubDate>2025-11-26T14:41:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576893180080619562" data-draft-id="7577042546094800938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="黑森林突袭！FLUX.2发布，这就是我们要的“生产力怪兽”"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-26T14:41:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            黑森林突袭！FLUX.2发布，这就是我们要的“生产力怪兽”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T14:41:29.000Z" title="Wed Nov 26 2025 14:41:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>就在2025年11月25日，那个被无数AI绘画爱好者视作“技术灯塔”的黑森林实验室（Black Forest Labs），终于甩出了他们的王炸——FLUX.2。</p>
<p>如果你还在纠结上一代模型的手部细节或是由于缺乏一致性而无法将其真正投入工作流，那么这次的更新可能会让你眼前一亮。简单来说，FLUX.2 并不是一次简单的版本号叠加，它是从“以此炫技”向“生产力工具”的一次暴力转型。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-26_22.32.59-1024x528.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-26_22.32.59-1024x528.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10209cf26f6c4c8382506294cc4b68d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764772889&amp;x-signature=LgaBh2Xk1zte0xQybHz9%2FZhKWfw%3D" alt="iShot_2025-11-26_22.32.59" loading="lazy"/></a></p>
<p><strong>不再是“抽卡”游戏，而是精准控制</strong></p>
<p>以前我们玩文生图，多少带着点“抽卡”的运气成分。但FLUX.2 显然想终结这个时代。</p>
<p>这次最让人头皮发麻的功能，莫过于“多参考图像生成”。想象一下，作为设计师，你需要为一个角色画一套分镜，以前你需要无数复杂的LoRA训练和ControlNet调试来维持角色脸部不崩。现在，FLUX.2 允许你直接扔进去最多10张参考图。它能吃透角色的面部特征、服装风格甚至是特定的产品细节，然后生成高度一致的新图像。这对于做故事板、电商图或者是游戏资产的人来说，简直是降维打击。</p>
<p>而且，它变“聪明”了。得益于融合了Mistral-3视觉语言模型，FLUX.2 对于复杂的逻辑有了惊人的理解力。你告诉它“画7个苹果”，它不会给你画6个或者8个；你给它一个具体的HEX颜色代码（比如#ff0088），它能精准渲染出那个特定的粉色，而不是“大概是粉色”。它甚至能像程序员一样理解结构化的JSON提示词，这意味着我们可以像调整相机参数一样去微调画面。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-26_22.32.21-1024x787.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-26_22.32.21-1024x787.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e935303f644942269fb318490473230d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764772889&amp;x-signature=i5HWRR1tqAquuhVMRgXwgJpqh14%3D" alt="iShot_2025-11-26_22.32.21" loading="lazy"/></a></p>
<p><strong>画质与细节的狂飙</strong></p>
<p>很多开源模型在生成大图时容易出现结构崩坏，但FLUX.2 直接把分辨率支持拉到了400万像素（4MP）。这意味着生成的图片不再是只能发发朋友圈的“小样”，而是可以直接拿去精修、打印的成品。</p>
<p>文字渲染能力也提升了一个台阶。以前AI生成的图片里，文字往往是一团乱码，现在FLUX.2 已经可以处理复杂的排版和UI界面，甚至是一些细小的说明文字也能清晰可读。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-26_22.32.28-1024x600.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-26_22.32.28-1024x600.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61e98b602eb943eeb9c2ac338c91bedf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764772889&amp;x-signature=udhkeY8ytW2%2FFcPm%2FU01elkvDTs%3D" alt="iShot_2025-11-26_22.32.28" loading="lazy"/></a></p>
<p><strong>显卡燃烧？这次或许还好</strong></p>
<p>听到320亿参数（32B），你的第一反应可能是：我的显卡要炸了。</p>
<p>原始的FLUX.2模型确实庞大，加载它原本需要夸张的90GB显存。但好消息是，黑森林实验室这次和NVIDIA以及ComfyUI搞了深度合作。通过FP8量化技术和内存卸载功能，他们硬生生把显存需求砍掉了40%。</p>
<p>这意味着，虽然它依然是个大家伙，但已经不再是数据中心独享的奢侈品。很多消费级的GeForce RTX显卡现在也能跑得起来。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-26_22.32.38-1024x779.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-26_22.32.38-1024x779.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d23768699bc34968b465da3d0740774e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764772889&amp;x-signature=ErIxecEVzUV4JfLUMJLlii5duys%3D" alt="iShot_2025-11-26_22.32.38" loading="lazy"/></a></p>
<p><strong>开源与商业的平衡艺术</strong></p>
<p>黑森林实验室这次的策略非常清晰，不想让所有人“白嫖”，但也给了社区足够的诚意。</p>
<ul>
<li><strong>FLUX.2 [pro]</strong>：这是给甚至不差钱的企业准备的，闭源，性能最强，速度最快，只能通过API使用。</li>
<li><strong>FLUX.2 [dev]</strong>：这是给社区的礼物。权重开放，虽然不能商用，但研究人员和极客们可以在本地尽情折腾，基于它开发各种插件和生态。</li>
<li><strong>FLUX.2 [flex]</strong> &amp; <strong>[klein]</strong>：介于两者之间，Flex给了开发者更多参数控制权，而即将推出的Klein则是面向边缘设备的轻量版。</li>
</ul>
<p>值得一提的是，作为模型底座的VAE（变分自编码器）是完全基于Apache 2.0协议开源的，这为未来的生态互操作性打下了很好的基础。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-26_22.32.53-1024x793.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-26_22.32.53-1024x793.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/562a0240d6fb4114963130c68351c49a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764772889&amp;x-signature=hXG%2BVuF5nP1clZijpNBulg8eelI%3D" alt="iShot_2025-11-26_22.32.53" loading="lazy"/></a></p>
<p><strong>写在最后</strong></p>
<p>FLUX.2 的出现，标志着开源图生图模型真正拥有了叫板闭源顶级模型（如Midjourney v6.1或DALL-E 3）的底气。它不再仅仅是用来生成漂亮小姐姐的玩具，而是一把因为精准控制和逻辑理解而变得锋利无比的生产力瑞士军刀。</p>
<p>目前，ComfyUI已经第一时间集成了支持。如果你手头有张不错的N卡，或者只是想看看AI进化的新高度，现在就是动手的最佳时机。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再当 AI 的"人肉定位器"了：一个工具让 React 组件秒定位]]></title>    <link>https://juejin.cn/post/7576843726011908122</link>    <guid>https://juejin.cn/post/7576843726011908122</guid>    <pubDate>2025-11-26T13:53:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576843726011908122" data-draft-id="7576844295434158089" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再当 AI 的&quot;人肉定位器&quot;了：一个工具让 React 组件秒定位"/> <meta itemprop="keywords" content="前端,AI编程,AIGC"/> <meta itemprop="datePublished" content="2025-11-26T13:53:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再当 AI 的"人肉定位器"了：一个工具让 React 组件秒定位
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T13:53:14.000Z" title="Wed Nov 26 2025 13:53:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开篇</h2>
<p>想象一下这个场景：</p>
<p>你正在和 AI 助手愉快地结对编程，突然想让它帮你改一下页面上那个"有点丑"的按钮。</p>
<p>于是你输入：</p>
<blockquote>
<p>"帮我把右上角那个蓝色的按钮改成圆角的"</p>
</blockquote>
<p>AI 回复：</p>
<blockquote>
<p>"好的，请问是哪个文件？叫什么组件？我需要更多信息..."</p>
</blockquote>
<p>你翻了个白眼，开始在项目里一个个文件夹找那个按钮到底藏在哪里...</p>
<p><strong>这种痛，React Grab 懂。</strong></p>
<hr/>
<h2 data-id="heading-1">它是谁？</h2>
<p>React Grab 是一个开源的开发者工具，做的事情很简单——<strong>让你点一下页面元素，就能把它的"身份证"复制给 AI</strong>。</p>
<p>什么是"身份证"？就是这个元素的：</p>
<ul>
<li>住在哪个文件、第几行代码</li>
<li>它爸爸是谁（父组件）</li>
<li>它长什么样（DOM 结构、CSS 选择器）</li>
<li>它的完整家谱（组件层级）</li>
</ul>
<p>有了这些信息，AI 就不会再迷路了。</p>
<p><strong>项目名片</strong>：</p>
<ul>
<li>🏠 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Freact-grab.com" target="_blank" title="https://react-grab.com" ref="nofollow noopener noreferrer">react-grab.com</a></li>
<li>📦 GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faidenybai%2Freact-grab" target="_blank" title="https://github.com/aidenybai/react-grab" ref="nofollow noopener noreferrer">github.com/aidenybai/r…</a></li>
<li>👨‍💻 作者：Aiden Bai（Million.js 的作者，React 性能优化大佬）</li>
<li>📜 许可证：MIT（完全免费，放心用）</li>
</ul>
<hr/>
<h2 data-id="heading-2">为什么需要它？</h2>
<h3 data-id="heading-3">没有它之前</h3>
<p>让 AI 帮你改 UI，你需要：</p>
<ol start="0">
<li><strong>当侦探</strong> 🔍 - 在项目里翻箱倒柜找组件文件</li>
<li><strong>当翻译</strong> 📝 - 费尽口舌描述"就是那个...页面中间偏右...有个图标的...按钮"</li>
<li><strong>当复读机</strong> 🔄 - AI 理解错了？再解释一遍...</li>
<li><strong>当搬运工</strong> 📋 - 手动复制代码，粘贴，再复制，再粘贴...</li>
</ol>
<h3 data-id="heading-4">有了它之后</h3>
<ol start="0">
<li>按住 <code>⌘C</code>（Mac）或 <code>Ctrl+C</code>（Windows）</li>
<li>点一下你想改的元素</li>
<li>粘贴给 AI</li>
<li>完事</li>
</ol>
<p><strong>就这么简单。</strong></p>
<hr/>
<h2 data-id="heading-5">它能做什么？</h2>
<h3 data-id="heading-6">🎯 精准抓取</h3>
<p>按住快捷键，鼠标移到元素上，它会贴心地帮你高亮显示：</p>
<blockquote>
<p>"你要的是这个吗？它叫 <code>&lt;button&gt;</code>，住在 <code>MyComponent</code> 里"</p>
</blockquote>
<p>点一下，信息就到剪贴板了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb5686565d5d41a7abca62e7cc3e8e01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764769993&amp;x-signature=mf8GtTREVuZTFiJ7dd91P%2FJh0zI%3D" alt="image-20251126212651365.png" loading="lazy"/></p>
<h3 data-id="heading-7">📦 区域选择</h3>
<p>想一次改好几个元素？没问题。</p>
<p>按住快捷键，拖个框把它们圈起来，所有元素的信息打包带走。</p>
<h3 data-id="heading-8">🧬 完整信息</h3>
<p>复制的内容长这样：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">selected_element</span>&gt;</span>
- selector: [data-lov-name="img"]
- width: 187
- height: 40
HTML snippet:
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"root"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Main</span> <span class="hljs-attr">used-at</span>=<span class="hljs-string">"//localhost:3001/src/components/common/page.tsx:22:26"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 完整的组件层级... --&gt;</span>
    <span class="hljs-comment">&lt;!-- IMPORTANT: selected element --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"h-10 w-auto"</span> <span class="hljs-attr">data-component-path</span>=<span class="hljs-string">"src/page/login/index..."</span>
         <span class="hljs-attr">data-component-line</span>=<span class="hljs-string">"157"</span> <span class="hljs-attr">...</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">img</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Main</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">selected_element</span>&gt;</span>
</code></pre>
<p>AI 看到这个，立马就知道：</p>
<ul>
<li>这是个 <code>img</code> 标签</li>
<li>在 <code>src/page/login/index.tsx</code> 文件的第 157 行</li>
<li>它的父组件是 <code>Main</code>，定义在 <code>page.tsx</code> 的第 22 行</li>
<li>尺寸是 187×40</li>
</ul>
<p><strong>零歧义，零迷路，零废话。</strong></p>
<hr/>
<h2 data-id="heading-9">谁能用？</h2>
<p>好消息：<strong>不是 Cursor 专属</strong>！</p>





























<table><thead><tr><th>AI 助手</th><th>能用吗？</th></tr></thead><tbody><tr><td>Cursor</td><td>✅ 当然可以</td></tr><tr><td>Claude Code</td><td>✅ 完全支持</td></tr><tr><td>OpenCode</td><td>✅ 没问题</td></tr><tr><td>Windsurf</td><td>✅ 理论上都行</td></tr><tr><td>任何能粘贴的工具</td><td>✅ 只要支持剪贴板就行</td></tr></tbody></table>
<p>本质上，React Grab 只是把信息复制到剪贴板。所以只要你的 AI 工具能接收粘贴内容，就能用。</p>
<hr/>
<h2 data-id="heading-10">使用场景</h2>
<h3 data-id="heading-11">场景一：改样式</h3>
<blockquote>
<p>"帮我把这个按钮改成渐变背景，加个 hover 动效"</p>
</blockquote>
<p>以前：找文件 → 描述位置 → 可能还找错了 现在：点一下 → 粘贴 → 搞定</p>
<h3 data-id="heading-12">场景二：Debug</h3>
<blockquote>
<p>"这个卡片显示有问题，帮我看看"</p>
</blockquote>
<p>直接点击有问题的元素，AI 立刻知道去哪个文件找。</p>
<h3 data-id="heading-13">场景三：重构</h3>
<blockquote>
<p>"把这几个按钮抽成一个通用组件"</p>
</blockquote>
<p>框选多个元素，AI 能看到它们的共同模式。</p>
<h3 data-id="heading-14">场景四：学习</h3>
<blockquote>
<p>"这个动画效果是怎么实现的？"</p>
</blockquote>
<p>点一下，AI 就能定位到源码给你讲解。</p>
<hr/>
<h2 data-id="heading-15">它的脾气</h2>
<p>了解一下 React Grab 的特点，能让你们相处得更愉快：</p>
<h3 data-id="heading-16">😊 它喜欢</h3>
<ul>
<li><strong>React 项目</strong> - 这是它的主场</li>
<li><strong>开发模式</strong> - Source Map 开着，它才能准确定位</li>
<li><strong>现代浏览器</strong> - Chrome、Edge、Firefox 都 OK</li>
</ul>
<h3 data-id="heading-17">😕 它不太行</h3>
<ul>
<li><strong>Vue / Angular / Svelte</strong> - 抱歉，只认 React</li>
<li><strong>生产环境</strong> - 代码压缩后它就迷路了</li>
<li><strong>远古浏览器</strong> - IE？那是什么？</li>
</ul>
<h3 data-id="heading-18">💡 小贴士</h3>
<ul>
<li>它<strong>不会</strong>影响你的应用性能（只在按快捷键时激活）</li>
<li>它<strong>不会</strong>出现在生产环境（只要你配置正确）</li>
<li>它<strong>不会</strong>和 React DevTools 冲突（它们是好朋友）</li>
</ul>
<hr/>
<h2 data-id="heading-19">和 React DevTools 的区别</h2>
<p>经常有人问：有 React DevTools 了，还要这个干嘛？</p>
<p>它们是不同物种：</p>






























<table><thead><tr><th/><th>React Grab</th><th>React DevTools</th></tr></thead><tbody><tr><td><strong>服务对象</strong></td><td>AI 助手</td><td>人类开发者</td></tr><tr><td><strong>交互方式</strong></td><td>点击复制</td><td>面板浏览</td></tr><tr><td><strong>输出格式</strong></td><td>文本信息</td><td>可视化界面</td></tr><tr><td><strong>使用场景</strong></td><td>喂给 AI</td><td>自己看着调试</td></tr></tbody></table>
<p><strong>React DevTools 是给你看的，React Grab 是给 AI 看的。</strong></p>
<hr/>
<h2 data-id="heading-20">总结</h2>
<p>React Grab 解决的问题很纯粹：</p>
<blockquote>
<p><strong>让 AI 能"看见"你页面上的元素。</strong></p>
</blockquote>
<p>不需要你当翻译、当侦探、当搬运工。</p>
<p>点一下，粘贴，然后你就可以专注于<strong>描述你想要什么</strong>，而不是<strong>解释那是什么</strong>。</p>
<p>这就是它存在的意义。</p>
<hr/>
<h2 data-id="heading-21">怎么装？</h2>
<p>放心，安装比泡面还简单。</p>
<h3 data-id="heading-22">方式一：一行脚本搞定（推荐新手）</h3>
<p>在你的 HTML 文件里加一行：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;script
  <span class="hljs-attr">src</span>=<span class="hljs-string">"//unpkg.com/react-grab/dist/index.global.js"</span>
  <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>
  <span class="hljs-attr">data-enabled</span>=<span class="hljs-string">"true"</span>
&gt;&lt;/script&gt;
</code></pre>
<p>就这样，没了。刷新页面就能用。</p>
<h3 data-id="heading-23">方式二：Next.js App Router</h3>
<p>在 <code>app/layout.tsx</code> 里加：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Script</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'next/script'</span>;
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params">{
  children,
}: {
  children: React.ReactNode;
}</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        {process.env.NODE_ENV === 'development' &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">Script</span>
            <span class="hljs-attr">src</span>=<span class="hljs-string">"//unpkg.com/react-grab/dist/index.global.js"</span>
            <span class="hljs-attr">crossOrigin</span>=<span class="hljs-string">"anonymous"</span>
            <span class="hljs-attr">data-enabled</span>=<span class="hljs-string">"true"</span>
            <span class="hljs-attr">strategy</span>=<span class="hljs-string">"afterInteractive"</span>
          /&gt;</span><span class="xml">
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span></span>
  );
}
</code></pre>
<p>注意那个 <code>process.env.NODE_ENV === 'development'</code>——<strong>只在开发环境加载</strong>，生产环境自动消失。</p>
<h3 data-id="heading-24">方式三：Next.js Pages Router</h3>
<p>在 <code>pages/_document.tsx</code> 里加：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Html</span>, <span class="hljs-title class_">Head</span>, <span class="hljs-title class_">Main</span>, <span class="hljs-title class_">NextScript</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/document'</span>;
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Document</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Html</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Head</span>&gt;</span>
        {process.env.NODE_ENV === 'development' &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">script</span>
            <span class="hljs-attr">src</span>=<span class="hljs-string">"//unpkg.com/react-grab/dist/index.global.js"</span>
            <span class="hljs-attr">crossOrigin</span>=<span class="hljs-string">"anonymous"</span>
            <span class="hljs-attr">data-enabled</span>=<span class="hljs-string">"true"</span>
          /&gt;</span><span class="xml">
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Head</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Main</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">NextScript</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Html</span>&gt;</span></span></span>
  );
}
</code></pre>
<h3 data-id="heading-25">方式四：Vite 项目</h3>
<p>先装包：</p>
<pre><code class="hljs language-csharp" lang="csharp">npm install react-grab
<span class="hljs-meta"># 或者</span>
pnpm <span class="hljs-keyword">add</span> react-grab
<span class="hljs-meta"># 或者</span>
yarn <span class="hljs-keyword">add</span> react-grab
</code></pre>
<p>然后在 <code>index.html</code> 里加：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">DEV</span>) {
    <span class="hljs-keyword">import</span>(<span class="hljs-string">'react-grab'</span>);
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>同样，<code>import.meta.env.DEV</code> 确保只在开发时加载。</p>
<hr/>
<h2 data-id="heading-26">装完怎么用？</h2>
<ol start="0">
<li><strong>启动项目</strong> - <code>npm run dev</code></li>
<li><strong>打开浏览器</strong> - 访问你的应用</li>
<li><strong>按住快捷键</strong> - <code>⌘C</code>（Mac）或 <code>Ctrl+C</code>（Windows）</li>
<li><strong>移动鼠标</strong> - 你会看到元素被高亮</li>
<li><strong>点击</strong> - 信息自动复制</li>
<li><strong>粘贴给 AI</strong> - 开始愉快地改代码</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[30 分钟落地全栈交互：OneCode CLI+SVG 排课表实战]]></title>    <link>https://juejin.cn/post/7576859345935286326</link>    <guid>https://juejin.cn/post/7576859345935286326</guid>    <pubDate>2025-11-26T13:55:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576859345935286326" data-draft-id="7576861477266833427" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="30 分钟落地全栈交互：OneCode CLI+SVG 排课表实战"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T13:55:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            30 分钟落地全栈交互：OneCode CLI+SVG 排课表实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T13:55:47.000Z" title="Wed Nov 26 2025 13:55:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>“排课系统开发一周起步？”——别再被传统跨栈开发绑架效率了。对于教育系统高频使用的排课表模块，开发者往往陷入“前端画SVG、后端写接口、联调耗半天”的困境，而用户却在为“点击没反馈、加载慢半拍”的体验吐槽。</p>
<p>现在，OneCode CLI彻底打破这个僵局：无需切换开发工具，不用精通前后端双技术栈，仅靠一套CLI指令+低代码可视化配置，30分钟就能从环境搭建到部署上线，做出具备“悬停高亮、点击缩放、冲突闪烁预警”的全栈交互SVG排课表。本文就是你的“计时实战手册”，每一步都标注核心动作与耗时，跟着操作，结束时就能带走一个可直接用的高体验排课系统。</p>
<p>OneCode平台的全栈整合能力恰好破解这一困局，其配套的Qoder CLI工具更是打通“前端组件-动态交互-后端服务”的开发链路：无需跨工具切换，仅通过CLI指令即可完成组件生成、交互绑定、数据联调全流程，快速实现具备“悬停高亮、点击反馈、冲突预警”的动态排课表。本文以该排课表为实战案例，手把手演示如何通过OneCode+Qoder CLI构建全栈动态交互应用，既保障开发效率，更让最终产品的用户体验实现质的提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9751eac9e6b2490192c8caae18e2b149~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764770147&amp;x-signature=8VytQyF6QmcMIqQzLvKtP3z2YbM%3D" alt="程序展现SVG效果" loading="lazy"/></p>
<h2 data-id="heading-0">一、项目核心价值：30分钟落地的“效率+体验”双优方案</h2>
<h3 data-id="heading-1">1.1 项目定位</h3>
<p>本次开发的SVG动态排课表，核心解决“传统开发周期长”与“用户体验差”两大核心问题，30分钟内实现四大核心价值功能，兼顾开发者效率与终端用户体验：</p>
<ul>
<li>鼠标悬停高亮：课程块颜色渐变+微缩放，交互反馈清晰</li>
<li>点击缩放反馈：触发150ms短促动画，操作感知明确</li>
<li>冲突闪烁预警：红橙交替闪烁，排课错误即时提醒</li>
<li>数据实时同步：后端更新自动推送，无需页面刷新</li>
</ul>
<p>最终产物适配PC端与移动端，可直接嵌入现有教育管理系统。</p>
<h3 data-id="heading-2">1.2 技术栈选型</h3>
<p>依托OneCode平台的全栈整合能力，无需跨工具切换即可完成前后端开发，核心技术如下：</p>
<ul>
<li><strong>开发平台</strong>：OneCode v4.0+（SVG注解/动画组件/服务框架一体化）</li>
<li><strong>前端技术</strong>：SVG矢量图形（高清无锯齿，适配多设备）</li>
<li><strong>后端技术</strong>：Java Spring Boot（OneCode原生集成，零额外配置）</li>
<li><strong>核心工具</strong>：OneCode QoderCLI（代码生成/批量操作/逻辑补全，效率核心）</li>
</ul>
<h2 data-id="heading-3">二、环境准备：3分钟搞定，为30分钟落地抢时间</h2>
<p>核心目标：快速完成OneCode与Qoder CLI环境配置，确保后续开发“零卡顿”。以下指令复制粘贴即可执行，全程3分钟内完成。</p>
<h3 data-id="heading-4">2.1 安装OneCode CLI与项目初始化</h3>
<pre><code class="hljs language-javascript" lang="javascript"># <span class="hljs-number">1.</span> 安装<span class="hljs-title class_">OneCode</span> <span class="hljs-variable constant_">CLI</span>（多系统通用）
curl -fsSL <span class="hljs-attr">https</span>:<span class="hljs-comment">//onecode-official.oss-cn-hangzhou.aliyuncs.com/install.sh | bash</span>

# <span class="hljs-number">2.</span> 验证安装（需v2<span class="hljs-number">.0</span><span class="hljs-number">.0</span>+支持<span class="hljs-variable constant_">SVG</span>注解）
onecode --version
# 预期输出：<span class="hljs-title class_">OneCode</span> <span class="hljs-variable constant_">CLI</span> v2<span class="hljs-number">.1</span><span class="hljs-number">.5</span> (支持<span class="hljs-variable constant_">SVG</span>与<span class="hljs-title class_">MCPv2</span>协议)

# <span class="hljs-number">3.</span> 初始化排课表项目（指定<span class="hljs-title class_">Spring</span> <span class="hljs-title class_">Boot</span>框架）
onecode project create svg-schedule-demo \
  --framework <span class="hljs-attr">springboot</span>:<span class="hljs-number">2.7</span><span class="hljs-number">.0</span> \
  --description <span class="hljs-string">"OneCode SVG动态排课表示例"</span>

# <span class="hljs-number">4.</span> 进入项目目录并加载依赖
cd svg-schedule-demo
onecode deps sync
</code></pre>
<h3 data-id="heading-5">2.2 配置QoderCLI能力</h3>
<p>通过QoderCLI关联OneCode代理，确保开发过程中可实时获取辅助能力：</p>
<pre><code class="hljs language-javascript" lang="javascript"># <span class="hljs-number">1.</span> 登录<span class="hljs-title class_">OneCode</span>控制台获取<span class="hljs-variable constant_">API</span>密钥（个人中心→开发者设置）
# <span class="hljs-number">2.</span> 配置全局<span class="hljs-title class_">QoderCLI</span>密钥
onecode config set <span class="hljs-variable language_">global</span>.<span class="hljs-property">api</span>-key <span class="hljs-string">"你的OneCode API密钥"</span>

# <span class="hljs-number">3.</span> 验证<span class="hljs-title class_">QoderCLI</span>连接
qodercli mcp test onecode --check tool
# 预期输出：<span class="hljs-title class_">QoderCLI</span>代理状态：在线（支持代码生成/注解推荐）
</code></pre>
<h2 data-id="heading-6">三、核心实现：25分钟完成全栈开发（分步骤计时）</h2>
<h3 data-id="heading-7">3.0 低代码SVG画布组件：可视化开发的基石</h3>
<p>OneCode低代码SVG画布组件是衔接可视化配置与代码开发的核心载体，它打破了“低代码只能拖拽简单元素”的认知局限，提供“可视化布局+注解化配置+代码扩展”三重能力，为复杂动态排课表开发奠定基础。其核心特性如下：</p>
<ul>
<li><strong>可视化画布基座</strong>：内置SVG画布编辑器，支持拖拽添加课程块、文本、时间轴等基础组件，实时预览布局效果，生成的可视化配置可直接转化为Java注解代码，无需手动编写坐标与样式。</li>
<li><strong>组件化复用机制</strong>：提供课程块、状态标签、预警图标等预制组件库，支持自定义组件封装与团队共享，排课表中重复的课程元素可通过组件复用减少开发量。</li>
<li><strong>全栈联动能力</strong>：组件可直接绑定后端服务接口（如通过可视化配置选择关联<code>ScheduleService</code>），无需手动编写前后端对接代码，实现“组件拖拽即接口关联”。</li>
<li><strong>开放扩展接口</strong>：支持通过注解与Java代码扩展组件逻辑，低代码配置负责基础结构，代码扩展负责复杂业务，兼顾开发效率与灵活性。</li>
</ul>
<p>核心开发链路（总耗时25分钟）：低代码搭骨架（5分钟）→动画交互配置（8分钟）→后端服务开发（7分钟）→Qoder CLI优化（5分钟）。借助OneCode注解与Qoder CLI辅助，每一步都直击核心，不做冗余操作。</p>
<h3 data-id="heading-8">3.1 第一步（5分钟）：低代码+Qoder CLI，速搭SVG排课表骨架</h3>
<p>关键动作：低代码拖拽生成基础布局，Qoder CLI补全代码细节，5分钟完成“可视化→代码”转换，比纯手写快10倍。</p>
<p><strong>低代码可视化配置流程（前置操作）</strong>：登录OneCode平台→进入“SVG画布编辑器”→选择“排课表模板”→拖拽“周一至周五”时间轴组件与“课程块”组件→调整位置与基础样式（如颜色、大小）→点击“生成注解代码”，即可得到<code>WeeklyScheduleView</code>的基础类结构，后续仅需补充细节逻辑。</p>
<p>这种“低代码搭骨架+QoderCLI补细节”的模式，使排课表基础结构开发时间从1小时缩短至5分钟，且生成的代码天然符合OneCode规范。</p>
<pre><code class="hljs language-javascript" lang="javascript">package com.<span class="hljs-property">onecode</span>.<span class="hljs-property">view</span>;

<span class="hljs-keyword">import</span> com.<span class="hljs-property">onecode</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">svg</span>.*;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">onecode</span>.<span class="hljs-property">service</span>.<span class="hljs-property">ScheduleService</span>;

<span class="hljs-comment">/**
 * SVG动态排课表视图
 * 注解说明：<span class="hljs-doctag">@SVGPaperFormAnnotation</span>定义画布，<span class="hljs-doctag">@SVGRectCombAnnotation</span>定义课程块
 * QoderCLI辅助：自动补全注解属性与基础结构
 */</span>
@<span class="hljs-title class_">SVGPaperFormAnnotation</span>(
    width = <span class="hljs-string">"100%"</span>,
    height = <span class="hljs-string">"600px"</span>,
    selectable = <span class="hljs-literal">true</span>,
    customService = <span class="hljs-title class_">ScheduleService</span>.<span class="hljs-property">class</span> <span class="hljs-comment">// 关联后端服务</span>
)
public <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeeklyScheduleView</span> {
    <span class="hljs-comment">// 排课表表头（周一至周五）</span>
    @<span class="hljs-title class_">SVGText</span>
    @<span class="hljs-title class_">SVGAnnotation</span>(
        text = <span class="hljs-string">"周一"</span>,
        left = <span class="hljs-string">"150px"</span>,
        top = <span class="hljs-string">"80px"</span>,
        fontSize = <span class="hljs-string">"16px"</span>,
        fontWeight = <span class="hljs-string">"bold"</span>,
        fill = <span class="hljs-string">"#333333"</span>
    )
    private <span class="hljs-title class_">SVGText</span> mondayTitle;
    
    @<span class="hljs-title class_">SVGText</span>
    @<span class="hljs-title class_">SVGAnnotation</span>(text = <span class="hljs-string">"周二"</span>, left = <span class="hljs-string">"280px"</span>, top = <span class="hljs-string">"80px"</span>, fontSize = <span class="hljs-string">"16px"</span>, fontWeight = <span class="hljs-string">"bold"</span>)
    private <span class="hljs-title class_">SVGText</span> tuesdayTitle;
    
    <span class="hljs-comment">// 数学课课程块（核心交互元素）</span>
    @<span class="hljs-title class_">SVGRectCombAnnotation</span>
    @<span class="hljs-title class_">SVGAnnotation</span>(
        width = <span class="hljs-string">"120px"</span>,
        height = <span class="hljs-string">"80px"</span>,
        left = <span class="hljs-string">"150px"</span>,
        top = <span class="hljs-string">"100px"</span>,
        fill = <span class="hljs-string">"#4CAF50"</span>,
        stroke = <span class="hljs-string">"#388E3C"</span>,
        strokeWidth = <span class="hljs-string">"2"</span>
    )
    @<span class="hljs-title class_">SVGAttrAnnotation</span>(rx = <span class="hljs-string">"5"</span>, ry = <span class="hljs-string">"5"</span>) <span class="hljs-comment">// 圆角配置（QoderCLI推荐属性）</span>
    private <span class="hljs-title class_">SVGRectCombAnnotation</span> mondayMathClass;
    
    <span class="hljs-comment">// 课程文本内容</span>
    @<span class="hljs-title class_">SVGText</span>
    @<span class="hljs-title class_">SVGAnnotation</span>(
        text = <span class="hljs-string">"数学课\n9:00-10:30"</span>,
        left = <span class="hljs-string">"160px"</span>,
        top = <span class="hljs-string">"120px"</span>,
        fontSize = <span class="hljs-string">"14px"</span>,
        fill = <span class="hljs-string">"#FFFFFF"</span>,
        fontWeight = <span class="hljs-string">"bold"</span>
    )
    private <span class="hljs-title class_">SVGText</span> mondayMathText;
    
    <span class="hljs-comment">// 英语课课程块（通过QoderCLI批量生成）</span>
    @<span class="hljs-title class_">SVGRectCombAnnotation</span>
    @<span class="hljs-title class_">SVGAnnotation</span>(width = <span class="hljs-string">"120px"</span>, height = <span class="hljs-string">"80px"</span>, left = <span class="hljs-string">"150px"</span>, top = <span class="hljs-string">"200px"</span>, fill = <span class="hljs-string">"#2196F3"</span>)
    private <span class="hljs-title class_">SVGRectCombAnnotation</span> mondayEnglishClass;
    
    @<span class="hljs-title class_">SVGText</span>
    @<span class="hljs-title class_">SVGAnnotation</span>(text = <span class="hljs-string">"英语课\n10:40-12:10"</span>, left = <span class="hljs-string">"160px"</span>, top = <span class="hljs-string">"220px"</span>, fontSize = <span class="hljs-string">"14px"</span>, fill = <span class="hljs-string">"#FFFFFF"</span>)
    private <span class="hljs-title class_">SVGText</span> mondayEnglishText;
}
</code></pre>
<p>QoderCLI辅助技巧：当编写课程块注解时，OneCode QoderCLI会实时推荐常用属性（如圆角rx/ry、边框宽度），并自动匹配OneCode主题色，避免视觉风格混乱。</p>
<h3 data-id="heading-9">3.2 第二步（8分钟）：注解化配置，让课程块“活”起来</h3>
<p>核心优势：不用写一行JS/CSS动画代码，通过OneCode @AnimBinder注解配置，配合Qoder CLI自动补全参数，8分钟实现所有交互动效。</p>
<h4 data-id="heading-10">场景1：鼠标悬停高亮动画</h4>
<p>为课程块添加“颜色渐变+轻微缩放”的悬停效果，提升交互反馈：</p>
<pre><code class="hljs language-javascript" lang="javascript">public <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeeklyScheduleView</span> {
    <span class="hljs-comment">// 悬停动画绑定（QoderCLI生成完整配置）</span>
    @<span class="hljs-title class_">AnimBinder</span>(
        customAnim = <span class="hljs-title class_">CustomAnimType</span>.<span class="hljs-property">combine</span>, <span class="hljs-comment">// 组合动画</span>
        name = <span class="hljs-string">"classHoverEffect"</span>,
        trigger = <span class="hljs-title class_">AnimTrigger</span>.<span class="hljs-property">MOUSE_OVER</span>, <span class="hljs-comment">// 触发条件：鼠标悬停</span>
        params = {
            @<span class="hljs-title class_">AnimParam</span>(key = <span class="hljs-string">"fillColor"</span>, value = <span class="hljs-string">"#66BB6A"</span>), <span class="hljs-comment">// 高亮颜色</span>
            @<span class="hljs-title class_">AnimParam</span>(key = <span class="hljs-string">"scale"</span>, value = <span class="hljs-string">"1.05"</span>), <span class="hljs-comment">// 缩放比例</span>
            @<span class="hljs-title class_">AnimParam</span>(key = <span class="hljs-string">"duration"</span>, value = <span class="hljs-string">"300ms"</span>) <span class="hljs-comment">// 动画时长</span>
        },
        bindElements = {<span class="hljs-string">"mondayMathClass"</span>, <span class="hljs-string">"mondayEnglishClass"</span>} <span class="hljs-comment">// 绑定多个课程块</span>
    )
    private <span class="hljs-title class_">AnimBinder</span> hoverAnimation;
    
    <span class="hljs-comment">// 鼠标离开恢复动画</span>
    @<span class="hljs-title class_">AnimBinder</span>(
        customAnim = <span class="hljs-title class_">CustomAnimType</span>.<span class="hljs-property">reset</span>,
        name = <span class="hljs-string">"classResetEffect"</span>,
        trigger = <span class="hljs-title class_">AnimTrigger</span>.<span class="hljs-property">MOUSE_OUT</span>,
        params = @<span class="hljs-title class_">AnimParam</span>(key = <span class="hljs-string">"duration"</span>, value = <span class="hljs-string">"200ms"</span>),
        bindElements = {<span class="hljs-string">"mondayMathClass"</span>, <span class="hljs-string">"mondayEnglishClass"</span>}
    )
    private <span class="hljs-title class_">AnimBinder</span> resetAnimation;
}
</code></pre>
<h4 data-id="heading-11">场景2：点击反馈与课程详情弹窗</h4>
<p>点击课程块时触发“缩放+颜色加深”动画，并调用后端服务显示课程详情：</p>
<pre><code class="hljs language-javascript" lang="javascript">public <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeeklyScheduleView</span> {
    <span class="hljs-comment">// 点击动画</span>
    @<span class="hljs-title class_">AnimBinder</span>(
        customAnim = <span class="hljs-title class_">CustomAnimType</span>.<span class="hljs-property">combine</span>,
        name = <span class="hljs-string">"classClickEffect"</span>,
        trigger = <span class="hljs-title class_">AnimTrigger</span>.<span class="hljs-property">CLICK</span>,
        params = {
            @<span class="hljs-title class_">AnimParam</span>(key = <span class="hljs-string">"fillColor"</span>, value = <span class="hljs-string">"#2E7D32"</span>),
            @<span class="hljs-title class_">AnimParam</span>(key = <span class="hljs-string">"scale"</span>, value = <span class="hljs-string">"0.98"</span>),
            @<span class="hljs-title class_">AnimParam</span>(key = <span class="hljs-string">"duration"</span>, value = <span class="hljs-string">"150ms"</span>)
        },
        bindElements = {<span class="hljs-string">"mondayMathClass"</span>}
    )
    private <span class="hljs-title class_">AnimBinder</span> clickAnimation;
    
    <span class="hljs-comment">// 点击事件绑定（关联后端服务方法）</span>
    @<span class="hljs-title class_">SVGEvent</span>(
        eventEnum = <span class="hljs-title class_">SVGEventEnum</span>.<span class="hljs-property">onClick</span>,
        actions = {
            @<span class="hljs-title class_">CustomAction</span>(
                type = <span class="hljs-title class_">ActionTypeEnum</span>.<span class="hljs-property">METHOD</span>,
                name = <span class="hljs-string">"showCourseDetail"</span>,
                method = <span class="hljs-string">"getCourseById"</span> <span class="hljs-comment">// 后端服务方法</span>
            )
        }
    )
    private <span class="hljs-title class_">SVGRectCombAnnotation</span> mathClassClickEvent;
    
    <span class="hljs-comment">// 接收后端返回的课程详情</span>
    private <span class="hljs-title class_">CourseDetail</span> currentCourseDetail;
}
</code></pre>
<h4 data-id="heading-12">场景3：课程冲突预警闪烁动画</h4>
<p>当检测到同一时间段重复排课时，课程块自动触发“红橙交替闪烁”动画，提醒管理员处理：</p>
<pre><code class="hljs language-javascript" lang="javascript">public <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeeklyScheduleView</span> {
    <span class="hljs-comment">// 冲突预警动画</span>
    @<span class="hljs-title class_">AnimBinder</span>(
        customAnim = <span class="hljs-title class_">CustomAnimType</span>.<span class="hljs-property">blinkAlertLoop</span>,
        name = <span class="hljs-string">"conflictAlertEffect"</span>,
        params = {
            @<span class="hljs-title class_">AnimParam</span>(key = <span class="hljs-string">"color1"</span>, value = <span class="hljs-string">"#F44336"</span>),
            @<span class="hljs-title class_">AnimParam</span>(key = <span class="hljs-string">"color2"</span>, value = <span class="hljs-string">"#FFCDD2"</span>),
            @<span class="hljs-title class_">AnimParam</span>(key = <span class="hljs-string">"interval"</span>, value = <span class="hljs-string">"500ms"</span>)
        }
    )
    private <span class="hljs-title class_">AnimBinder</span> conflictAnimation;
    
    <span class="hljs-comment">// 接收后端冲突通知，触发动画</span>
    public <span class="hljs-keyword">void</span> <span class="hljs-title function_">onScheduleConflict</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> courseId</span>) {
        <span class="hljs-comment">// 定位冲突课程块并绑定动画</span>
        <span class="hljs-title class_">SVGRectCombAnnotation</span> conflictBlock = <span class="hljs-title function_">getCourseBlockById</span>(courseId);
        conflictAnimation.<span class="hljs-title function_">bindElement</span>(conflictBlock);
        conflictAnimation.<span class="hljs-title function_">start</span>();
        
        <span class="hljs-comment">// 显示冲突提示（OneCode内置弹窗组件）</span>
        <span class="hljs-title class_">OneCodeDialog</span>.<span class="hljs-title function_">showWarning</span>(<span class="hljs-string">"课程冲突"</span>, currentCourseDetail.<span class="hljs-title function_">getConflictReason</span>());
    }
}
</code></pre>
<h3 data-id="heading-13">3.3 第三步（7分钟）：全栈联动，后端服务一键生成</h3>
<p>核心效率点：Qoder CLI一键生成服务类基础结构，仅需补充5行业务逻辑，7分钟完成“数据加载-事件处理-主动推送”全链路服务，无需手动写接口注解与返回格式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解withContext和launch的真正区别]]></title>    <link>https://juejin.cn/post/7577001324416712754</link>    <guid>https://juejin.cn/post/7577001324416712754</guid>    <pubDate>2025-11-26T13:59:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577001324416712754" data-draft-id="7576518316137087027" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解withContext和launch的真正区别"/> <meta itemprop="keywords" content="Kotlin,Android,Android Jetpack"/> <meta itemprop="datePublished" content="2025-11-26T13:59:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="稀有猿诉"/> <meta itemprop="url" content="https://juejin.cn/user/2788017216685784"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解withContext和launch的真正区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017216685784/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    稀有猿诉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T13:59:27.000Z" title="Wed Nov 26 2025 13:59:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文译自「The Real Difference Between withContext(Dispatchers.IO) and launch(Dispatchers.IO)」，原文链接<a href="https://link.juejin.cn?target=https%3A%2F%2Fproandroiddev.com%2Fthe-real-difference-between-withcontext-dispatchers-io-and-launch-dispatchers-io-b70ec00a33f2" target="_blank" title="https://proandroiddev.com/the-real-difference-between-withcontext-dispatchers-io-and-launch-dispatchers-io-b70ec00a33f2" ref="nofollow noopener noreferrer">proandroiddev.com/the-real-di…</a>，由
Anatolii Frolov发布于2025年11月20日。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30bc5447b8124c14a0e977e4fcfb30ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764770367&amp;x-signature=Zstme%2FcfUwhZEmfTU2VpoaWcp28%3D" alt="0.png" loading="lazy"/></p>
<p>在使用 Kotlin 协程时，很容易遇到两种看起来 几乎相同的模式。它们都使用了 <code>Dispatchers.IO</code>。它们都将工作移出主线程。它们都出现在不同团队编写的仓库、服务层和 ViewModel 代码中。</p>
<p>但相似之处仅限于表面。它们的行为截然不同——这种差异会影响实际 Android 项目中的顺序、正确性，甚至线程安全。当后台操作影响 UI 状态或共享数据时，这一点尤为重要。</p>
<p>这种困惑不难理解。它们的语法几乎相同，并且都在同一个调度器上运行。但一个会暂停直到工作完成，而另一个会启动并行工作并立即返回。这创建了不同的执行路径，很容易被忽略。</p>
<p>本文解释了 <code>withContext(Dispatchers.IO)</code> 和 <code>launch(Dispatchers.IO)</code> 之间的真正区别，通过实际代码展示了它们的行为差异，并重点介绍了这种差异在生产环境 Android 应用中的重要性。</p>
<h2 data-id="heading-0">看似相同的代码行为却截然不同</h2>
<p>以下两段代码看起来几乎一样：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">withContext(Dispatchers.IO) {
    <span class="hljs-comment">// work</span>
}launch(Dispatchers.IO) {
    <span class="hljs-comment">// work</span>
}
</code></pre>
<p>它们运行在同一个调度器上。它们都将工作转移到后台线程。但它们的行为<strong>并不</strong>相同。</p>
<p>以下是并排运行它们的结果：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"Start"</span>)

    launch(Dispatchers.IO) {
        delay(<span class="hljs-number">100</span>)
        println(<span class="hljs-string">"Inside launch"</span>)
    }

    withContext(Dispatchers.IO) {
        delay(<span class="hljs-number">50</span>)
        println(<span class="hljs-string">"Inside withContext"</span>)
    }

    println(<span class="hljs-string">"End"</span>)
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-bash" lang="bash">Start
Inside withContext
End
Inside launch
</code></pre>
<p>这展示了关键区别。</p>
<p><code>withContext</code> 会等待其工作完成才会继续执行。</p>
<p><code>launch</code> 则完全不等待——它并行运行，并在稍后完成。</p>
<h2 data-id="heading-1">为什么会发生这种情况</h2>
<p><code>withContext</code> 是一个挂起函数。这意味着当前协程会在该行暂停，切换到 <code>Dispatchers.IO</code>，执行代码块，然后从中断的地方继续执行。这里的关键词是<strong>等待</strong>。在该行之后的任何代码都会等待代码块执行完毕。</p>
<p><code>launch</code> 会创建一个新的协程并立即返回。当前协程会立即继续执行，而新创建的代码块会独立执行。这是一种“触发并继续”模式。除非你显式地对新创建的协程调用 <code>join()</code>，否则不会有等待。</p>
<p>这不是一个 bug，而是协程构建器的设计决策。</p>
<p><code>withContext</code> 确保单个协程内部的执行顺序。</p>
<p><code>launch</code> 的设计本身就引入了并发性。</p>
<p>这种视觉上的相似性掩盖了行为上的差异。前者保持代码的可预测顺序，而后者引入了并行工作，这些工作可能会根据调度和负载情况随时完成。</p>
<h2 data-id="heading-2">这种差异在实际项目中的重要性</h2>
<p>在许多 Android 场景中，任务完成的确切时间至关重要。哪怕是顺序上的细微差别，都可能导致一些难以察觉的 bug，直到生产环境才会被发现。</p>
<h3 data-id="heading-3">1. 后台任务完成后更新 UI</h3>
<p>在 ViewModel 中：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">viewModelScope.launch {
    <span class="hljs-keyword">val</span> user = withContext(Dispatchers.IO) {
        userRepository.loadUser()
    }
    _state.value = user
}
</code></pre>
<p>输出（概念图）：</p>
<pre><code class="hljs language-bash" lang="bash">User loaded first
UI updated second
</code></pre>
<p>由于 <code>withContext</code> 会等待，因此 UI 只有在加载完成后才会更新。</p>
<p>但如果将其替换为 <code>launch(Dispatchers.IO)</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">viewModelScope.launch {
    <span class="hljs-keyword">var</span> result: User? = <span class="hljs-literal">null</span>

    launch(Dispatchers.IO) {
        result = userRepository.loadUser()
    }

    _state.value = result
}
</code></pre>
<p>输出（概念图）：</p>
<pre><code class="hljs language-bash" lang="bash">UI updated first
User loaded later
</code></pre>
<p>这里，UI 在后台任务完成之前就更新了。语法上的视觉相似性掩盖了执行顺序的不同。</p>
<h3 data-id="heading-4">2.协调多步骤后台操作</h3>
<p>在自定义仓库代码中，你可能需要操作严格按照顺序执行。例如，先保存数据，然后写入日志：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">withContext(Dispatchers.IO) {
    fileWriter.save(<span class="hljs-keyword">data</span>)
}

withContext(Dispatchers.IO) {
    logWriter.write(<span class="hljs-string">"Saved"</span>)
}
</code></pre>
<p><code>suspend</code> 保证了操作顺序。日志写入必须在保存完成后才能进行。</p>
<p>但使用 <code>launch</code> 则：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">launch(Dispatchers.IO) { fileWriter.save(<span class="hljs-keyword">data</span>) }
launch(Dispatchers.IO) { logWriter.write(<span class="hljs-string">"Saved"</span>) }
</code></pre>
<p>这两个操作可以以任意顺序执行。在负载较高的情况下，日志写入可能早于保存操作。这听起来似乎无关紧要，但一旦调试或审计变得困难，就会造成问题。</p>
<h3 data-id="heading-5">3. 访问共享状态</h3>
<p>使用 <code>withContext</code> 进行顺序执行在更新共享对象时更安全：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">withContext(Dispatchers.IO) {
    cache.update(item)
}
</code></pre>
<p>使用 <code>launch</code>，两个更新操作可以同时运行：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">launch(Dispatchers.IO) { cache.update(item1) }
launch(Dispatchers.IO) { cache.update(item2) }
</code></pre>
<p>除非缓存本身是线程安全的，否则并行写入可能会导致竞态条件。</p>
<h2 data-id="heading-6">为什么这种差异容易被忽略</h2>
<p>主要原因是语法。两者都使用相同的括号。两者都显示 <code>Dispatchers.IO</code>。两者都将代码包裹在代码块中。人们的注意力会集中在调度器上，而不是协程构建器上。</p>
<p>另一个原因是许多现代库已经在内部处理线程。Room DAO 方法和 Retrofit 的挂起函数不需要 <code>withContext(Dispatchers.IO)</code>。由于这些库减少了手动切换调度器，开发者看到的协程构建器之间的明显差异较少。</p>
<p>这可能会造成一种错觉，即所有调度器的用法都可以互换，但对于自定义操作来说并非如此。</p>
<h2 data-id="heading-7">与 async/await 的深入比较</h2>
<p>为了进一步突出差异，请比较以下三个示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> deferred = async(Dispatchers.IO) {
    loadData()
}<span class="hljs-keyword">val</span> result = deferred.await()
println(result)
</code></pre>
<p>输出（概念图）：</p>
<pre><code class="hljs language-bash" lang="bash">loadData completes
result printed
</code></pre>
<p><code>async</code> 的行为类似于 <code>launch</code>，但返回 <code>Deferred</code>。</p>
<p><code>await()</code> 会将其转换为顺序行为——就像 <code>withContext</code> 一样。</p>
<p>关键点：<strong>顺序行为仅在显式等待时发生。</strong></p>
<h2 data-id="heading-8">异常处理行为</h2>
<p><code>withContext</code> 直接在调用协程中抛出异常。它们不会被延迟或存储。</p>
<p><code>launch</code> 将异常报告给其父作用域。如果该作用域有 supervisor 或自定义异常处理程序，则效果不同。异常不会立即中断调用者的执行路径。</p>
<p>这意味着：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">withContext(Dispatchers.IO) { error(<span class="hljs-string">"Boom"</span>) }
println(<span class="hljs-string">"Next"</span>)
</code></pre>
<p>崩溃会在“Next”执行之前停止协程。</p>
<p>但使用 <code>launch</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">launch(Dispatchers.IO) { error(<span class="hljs-string">"Boom"</span>) }
println(<span class="hljs-string">"Next"</span>)
</code></pre>
<p>“Next”仍然会打印。启动的协程会自行崩溃。</p>
<h2 data-id="heading-9">需要记住的内容</h2>
<ul>
<li>
<p><code>withContext</code> <strong>等待</strong>代码块执行完毕后才会继续执行。</p>
</li>
<li>
<p><code>launch</code> 会启动<strong>并行</strong>工作并立即返回。</p>
</li>
<li>
<p>当<strong>结果或顺序</strong>至关重要时，请使用 <code>withContext</code>。</p>
</li>
<li>
<p>当你需要<strong>并发工作</strong>且无需阻塞调用者时，请使用 <code>launch</code>。</p>
</li>
<li>
<p>视觉上的相似性掩盖了行为上的差异——协程构建器定义了语义，而不是调度器。</p>
</li>
</ul>
<h2 data-id="heading-10">总结</h2>
<p><code>withContext(Dispatchers.IO)</code> 和 <code>launch(Dispatchers.IO)</code> 看起来相似，但行为却不同。前者会暂停并确保顺序执行，而后者会创建并发并立即继续执行。当工作顺序、共享状态、UI 更新或异常处理依赖于工作完成时间时，这种差异至关重要。</p>
<p>理解这种区别可以使协程代码更易于预测，并避免那些只有在实际应用中才会显现的细微错误。</p>
<blockquote>
<p>欢迎搜索并关注 <em>公众号<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fqrcode%3Fscene%3D10000004%26size%3D512%26__biz%3DMzU1MDg0NDczNA%3D%3D%26mid%3D2247484417%26idx%3D1%26sn%3D60c15f0d3c4be75e37748c2472a74102" target="_blank" title="https://mp.weixin.qq.com/mp/qrcode?scene=10000004&amp;size=512&amp;__biz=MzU1MDg0NDczNA==&amp;mid=2247484417&amp;idx=1&amp;sn=60c15f0d3c4be75e37748c2472a74102" ref="nofollow noopener noreferrer">「稀有猿诉」</a></em> 获取更多的优质文章！</p>
<p>保护原创，请勿转载！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[DeepAgents官方文档（一）]]></title>    <link>https://juejin.cn/post/7576859345935302710</link>    <guid>https://juejin.cn/post/7576859345935302710</guid>    <pubDate>2025-11-26T14:03:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576859345935302710" data-draft-id="7576838552472240171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="DeepAgents官方文档（一）"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-26T14:03:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桜吹雪"/> <meta itemprop="url" content="https://juejin.cn/user/1179091901098269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            DeepAgents官方文档（一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1179091901098269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桜吹雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T14:03:08.000Z" title="Wed Nov 26 2025 14:03:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>DeepAgents.js官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fjavascript%2Fdeepagents%2Foverview" target="_blank" title="https://docs.langchain.com/oss/javascript/deepagents/overview" ref="nofollow noopener noreferrer">Deep Agents</a></p>
<hr/>
<h2 data-id="heading-0">Deep Agents 概览</h2>
<p><strong>构建能够规划、使用 subagents 以及利用文件系统处理复杂任务的 agents</strong></p>
<p><code>deepagents</code> 是一个独立的库，专为构建能够处理复杂、多步骤任务的 agents 而设计。它基于 <strong>LangGraph</strong> 构建，灵感来源于 <strong>Claude Code</strong>、<strong>Deep Research</strong> 和 <strong>Manus</strong> 等应用。Deep agents 自带规划能力、用于上下文管理的文件系统，以及生成 (spawn) <strong>subagents</strong> 的能力。</p>
<h3 data-id="heading-1">何时使用 deep agents</h3>
<p>当您需要具备以下能力的 agents 时，请使用 deep agents：</p>
<ul>
<li>处理需要规划和分解的<strong>复杂、多步骤任务</strong></li>
<li>通过文件系统 tools <strong>管理大量上下文</strong></li>
<li>将<strong>工作委托</strong>给专门的 subagents 以实现上下文隔离</li>
<li>跨对话和 <strong>threads</strong> 持久化 <strong>memory</strong></li>
</ul>
<p>对于更简单的用例，请考虑使用 <strong>LangChain</strong> 的 <code>create_agent</code> 或构建自定义的 <strong>LangGraph workflow</strong>。</p>
<h3 data-id="heading-2">核心能力 (Core capabilities)</h3>
<h4 data-id="heading-3">规划与任务分解 (Planning and task decomposition)</h4>
<p>Deep agents 包含一个内置的 <code>write_todos</code> tool，使 agents 能够将复杂任务分解为离散的步骤，跟踪进度，并随着新信息的出现动态调整计划。</p>
<h4 data-id="heading-4">上下文管理 (Context management)</h4>
<p>文件系统 <strong>tools</strong> (<code>ls</code>, <code>read_file</code>, <code>write_file</code>, <code>edit_file</code>) 允许 agents 将大量上下文卸载 (offload) 到 <strong>memory</strong> 中，从而防止 <strong>context window</strong> 溢出，并支持处理变长的 tool 结果。</p>
<h4 data-id="heading-5">Subagent 生成 (Subagent spawning)</h4>
<p>内置的 <code>task</code> tool 允许 agents 生成专门的 <strong>subagents</strong> 以进行上下文隔离。这既保持了主 agent 的上下文整洁，又能针对特定的子任务进行深入处理。</p>
<h4 data-id="heading-6">长期记忆 (Long-term memory)</h4>
<p>利用 <strong>LangGraph</strong> 的 <strong>Store</strong> 扩展 agents，使其具备跨 <strong>threads</strong> 的持久化 <strong>memory</strong>。Agents 可以保存并检索先前对话中的信息。</p>
<h3 data-id="heading-7">与 LangChain 生态系统的关系</h3>
<p>Deep agents 构建于以下基础之上：</p>
<ul>
<li><strong>LangGraph</strong> - 提供底层的 graph 执行和 <strong>state</strong> 管理</li>
<li><strong>LangChain</strong> - <strong>Tools</strong> 和 <strong>model</strong> 集成可与 deep agents 无缝协作</li>
<li><strong>LangSmith</strong> - 提供 <strong>Observability</strong> (可观测性)、评估和部署支持</li>
</ul>
<p>Deep agents 应用程序可以通过 <strong>LangSmith Deployment</strong> 进行部署，并使用 <strong>LangSmith Observability</strong> 进行监控。
这里是根据 LangChain DeepAgents JavaScript 文档（参考 <code>langchain-ai/deepagentsjs</code> 官方仓库及文档结构）进行的专业翻译。</p>
<hr/>
<h2 data-id="heading-8">快速开始 (Quickstart)</h2>
<p>在几分钟内构建您的第一个DeepAgent</p>
<p>本指南将指导您创建具备规划、文件系统工具和子Agent功能的DeepAgent。您将构建一个能够进行研究并撰写报告的研究Agent。</p>
<h3 data-id="heading-9">先决条件</h3>
<p>开始前，请确保已从模型提供商（如 Anthropic、OpenAI）获取 API 密钥。</p>
<h4 data-id="heading-10">步骤1：安装依赖项</h4>
<p>首先，安装 <code>deepagents</code> 包以及必要的依赖项。</p>
<pre><code class="hljs language-bash" lang="bash">npm install deepagents @langchain/tavily  
<span class="hljs-comment"># 或  </span>
yarn add deepagents @langchain/tavily  
<span class="hljs-comment"># 或  </span>
pnpm add deepagents @langchain/tavily
</code></pre>
<h4 data-id="heading-11">步骤2：设置 API 密钥</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> ANTHROPIC_API_KEY=<span class="hljs-string">"your-api-key"</span>  
<span class="hljs-built_in">export</span> TAVILY_API_KEY=<span class="hljs-string">"your-tavily-api-key"</span>
</code></pre>
<h4 data-id="heading-12">步骤3：创建搜索工具</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { tool } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain"</span>;  
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TavilySearch</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/tavily"</span>;  
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;  

<span class="hljs-keyword">const</span> internetSearch = <span class="hljs-title function_">tool</span>(  
  <span class="hljs-keyword">async</span> ({}: {  
    <span class="hljs-attr">query</span>: <span class="hljs-built_in">string</span>;  
    maxResults?: <span class="hljs-built_in">number</span>;  
    topic?: <span class="hljs-string">"general"</span> | <span class="hljs-string">"news"</span> | <span class="hljs-string">"finance"</span>;  
    includeRawContent?: <span class="hljs-built_in">boolean</span>;  
  }) =&gt; {  
    <span class="hljs-keyword">const</span> tavilySearch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TavilySearch</span>({  
      maxResults,  
      <span class="hljs-attr">tavilyApiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">TAVILY_API_KEY</span>,  
      includeRawContent,  
      topic,  
    });  
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> tavilySearch.<span class="hljs-title function_">_call</span>({ query });  
  },  
  {  
    <span class="hljs-attr">name</span>: <span class="hljs-string">"internet_search"</span>,  
    <span class="hljs-attr">description</span>: <span class="hljs-string">"执行网络搜索"</span>,  
    <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({  
      <span class="hljs-attr">query</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"搜索查询"</span>),  
      <span class="hljs-attr">maxResults</span>: z  
        .<span class="hljs-title function_">number</span>()  
        .<span class="hljs-title function_">optional</span>()  
        .<span class="hljs-title function_">default</span>(<span class="hljs-number">5</span>)  
        .<span class="hljs-title function_">describe</span>(<span class="hljs-string">"最大返回结果数"</span>),  
      <span class="hljs-attr">topic</span>: z  
        .<span class="hljs-title function_">enum</span>([<span class="hljs-string">"general"</span>, <span class="hljs-string">"news"</span>, <span class="hljs-string">"finance"</span>])  
        .<span class="hljs-title function_">optional</span>()  
        .<span class="hljs-title function_">default</span>(<span class="hljs-string">"general"</span>)  
        .<span class="hljs-title function_">describe</span>(<span class="hljs-string">"搜索主题分类"</span>),  
      <span class="hljs-attr">includeRawContent</span>: z  
        .<span class="hljs-title function_">boolean</span>()  
        .<span class="hljs-title function_">optional</span>()  
        .<span class="hljs-title function_">default</span>(<span class="hljs-literal">false</span>)  
        .<span class="hljs-title function_">describe</span>(<span class="hljs-string">"是否包含原始内容"</span>),  
    }),  
  }  
);
</code></pre>
<h4 data-id="heading-13">步骤4：创建deep agent</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { createDeepAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">"deepagents"</span>;  

<span class="hljs-comment">// 引导Agent成为专家研究员的系统提示  </span>
<span class="hljs-keyword">const</span> researchInstructions = <span class="hljs-string">`您是一位专家研究员。您的任务是进行彻底的研究，然后撰写一份精炼的报告。

您可以通过互联网搜索工具作为主要信息收集手段。

## \`internet_search\`

使用此工具针对给定查询执行网络搜索。您可以指定返回结果的最大数量、主题以及是否包含原始内容。`</span>;  

<span class="hljs-keyword">const</span> agent = <span class="hljs-title function_">createDeepAgent</span>({  
  <span class="hljs-attr">tools</span>: [internetSearch],  
  <span class="hljs-attr">systemPrompt</span>: researchInstructions,  
});
</code></pre>
<h4 data-id="heading-14">步骤5：运行Agent</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> agent.<span class="hljs-title function_">invoke</span>({  
  <span class="hljs-attr">messages</span>: [{ <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">"什么是 LangGraph？"</span> }],  
});  

<span class="hljs-comment">// 输出Agent的最终响应  </span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result.<span class="hljs-property">messages</span>[result.<span class="hljs-property">messages</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">content</span>);
</code></pre>
<h3 data-id="heading-15">发生了什么？</h3>
<p>您的DeepAgent自动完成了以下操作：</p>
<ul>
<li><strong>规划策略</strong>：使用内置 <code>write_todos</code>工具分解研究任务</li>
<li><strong>开展研究</strong>：调用 <code>internet_search</code>工具收集信息</li>
<li><strong>上下文管理</strong>：使用文件系统工具（<code>write_file</code>、<code>read_file</code>）卸载大型搜索结果</li>
<li><strong>生成子Agent</strong>（如需）：将复杂子任务委托给专用子Agent</li>
<li><strong>综合报告</strong>：将发现编译为连贯的响应</li>
</ul>
<h3 data-id="heading-16">下一步</h3>
<p>完成首个DeepAgent后，您可以：</p>
<ul>
<li><strong>自定义Agent</strong>：学习自定义选项（系统提示、工具、子Agent）</li>
<li><strong>理解中间件</strong>：深入探究驱动DeepAgent的中间件架构</li>
<li><strong>添加长期记忆</strong>：实现跨会话的持久化记忆</li>
<li><strong>生产部署</strong>：了解 LangGraph 应用的部署方案</li>
</ul>
<hr/>
<h2 data-id="heading-17">定制DeepAgent</h2>
<p>学习如何通过系统提示、工具、子Agent等方式定制DeepAgent</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    Create[create_deep_agent] --&gt; Core[Core Config]
    Create --&gt; Features[Features]

    Core --&gt; Model[Model]
    Core --&gt; Prompt[System Prompt]
    Core --&gt; Tools[Tools]

    Features --&gt; Backend[Backend]
    Features --&gt; Sub[Subagents]
    Features --&gt; Interrupt[Interrupts]

    Model --&gt; Agent[Customized Agent]
    Prompt --&gt; Agent
    Tools --&gt; Agent
    Backend --&gt; Agent
    Sub --&gt; Agent
    Interrupt --&gt; Agent
</code></pre>
<h3 data-id="heading-18">模型</h3>
<p>默认情况下，<code>deepagents</code>使用 <code>claude-sonnet-4-5-20250929</code>。您可以通过传递任意 LangChain 模型对象进行自定义。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatAnthropic</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/anthropic"</span>;  
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;  
<span class="hljs-keyword">import</span> { createDeepAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">"deepagents"</span>;  

<span class="hljs-comment">// 使用 Anthropic 模型  </span>
<span class="hljs-keyword">const</span> agent = <span class="hljs-title function_">createDeepAgent</span>({  
  <span class="hljs-attr">model</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatAnthropic</span>({  
    <span class="hljs-attr">model</span>: <span class="hljs-string">"claude-sonnet-4-20250514"</span>,  
    <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>,  
  }),  
});  

<span class="hljs-comment">// 使用 OpenAI 模型  </span>
<span class="hljs-keyword">const</span> agent2 = <span class="hljs-title function_">createDeepAgent</span>({  
  <span class="hljs-attr">model</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({  
    <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-5"</span>,  
    <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>,  
  }),  
});
</code></pre>
<h3 data-id="heading-19">系统提示</h3>
<p>深度代理内置基于 Claude Code 系统提示的默认引导提示。该默认提示包含使用内置规划工具、文件系统工具和子代理的详细说明。</p>
<p><strong>每个面向特定场景的深度代理都应包含针对该场景的自定义系统提示</strong>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { createDeepAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">"deepagents"</span>;  

<span class="hljs-keyword">const</span> researchInstructions = <span class="hljs-string">`您是一位专家研究员。您的任务是进行彻底的研究，然后撰写一份精炼的报告。`</span>;  

<span class="hljs-keyword">const</span> agent = <span class="hljs-title function_">createDeepAgent</span>({  
  <span class="hljs-attr">systemPrompt</span>: researchInstructions,  
});
</code></pre>
<h3 data-id="heading-20">工具</h3>
<p>与工具调用代理类似，深度代理可访问一组顶层工具。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { tool } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain"</span>;  
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TavilySearch</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/tavily"</span>;  
<span class="hljs-keyword">import</span> { createDeepAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">"deepagents"</span>;  
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;  

<span class="hljs-keyword">const</span> internetSearch = <span class="hljs-title function_">tool</span>(  
  <span class="hljs-keyword">async</span> ({  
    query,  
    maxResults = <span class="hljs-number">5</span>,  
    topic = <span class="hljs-string">"general"</span>,  
    includeRawContent = <span class="hljs-literal">false</span>,  
  }: {  
    <span class="hljs-attr">query</span>: <span class="hljs-built_in">string</span>;  
    maxResults?: <span class="hljs-built_in">number</span>;  
    topic?: <span class="hljs-string">"general"</span> | <span class="hljs-string">"news"</span> | <span class="hljs-string">"finance"</span>;  
    includeRawContent?: <span class="hljs-built_in">boolean</span>;  
  }) =&gt; {  
    <span class="hljs-keyword">const</span> tavilySearch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TavilySearch</span>({  
      maxResults,  
      <span class="hljs-attr">tavilyApiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">TAVILY_API_KEY</span>,  
      includeRawContent,  
      topic,  
    });  
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> tavilySearch.<span class="hljs-title function_">_call</span>({ query });  
  },  
  {  
    <span class="hljs-attr">name</span>: <span class="hljs-string">"internet_search"</span>,  
    <span class="hljs-attr">description</span>: <span class="hljs-string">"执行网络搜索"</span>,  
    <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({  
      <span class="hljs-attr">query</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"搜索查询"</span>),  
      <span class="hljs-attr">maxResults</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">optional</span>().<span class="hljs-title function_">default</span>(<span class="hljs-number">5</span>),  
      <span class="hljs-attr">topic</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">"general"</span>, <span class="hljs-string">"news"</span>, <span class="hljs-string">"finance"</span>]).<span class="hljs-title function_">optional</span>().<span class="hljs-title function_">default</span>(<span class="hljs-string">"general"</span>),  
      <span class="hljs-attr">includeRawContent</span>: z.<span class="hljs-title function_">boolean</span>().<span class="hljs-title function_">optional</span>().<span class="hljs-title function_">default</span>(<span class="hljs-literal">false</span>),  
    }),  
  }  
);  

<span class="hljs-keyword">const</span> agent = <span class="hljs-title function_">createDeepAgent</span>({  
  <span class="hljs-attr">tools</span>: [internetSearch],  
});
</code></pre>
<p>除自定义工具外，深度代理还内置以下默认工具：</p>
<ul>
<li><code>write_todos</code>：更新代理的待办事项列表</li>
<li><code>ls</code>：列出代理文件系统中的所有文件</li>
<li><code>read_file</code>：从文件系统中读取文件</li>
<li><code>write_file</code>：向文件系统中写入新文件</li>
<li><code>edit_file</code>：编辑现有文件</li>
<li><code>task</code>：生成子代理处理特定任务</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Manim进阶：用背景图片让你的数学视频脱颖而出]]></title>    <link>https://juejin.cn/post/7576838552472191019</link>    <guid>https://juejin.cn/post/7576838552472191019</guid>    <pubDate>2025-11-26T12:12:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576838552472191019" data-draft-id="7576841976928534564" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Manim进阶：用背景图片让你的数学视频脱颖而出"/> <meta itemprop="keywords" content="Python,动效"/> <meta itemprop="datePublished" content="2025-11-26T12:12:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Manim进阶：用背景图片让你的数学视频脱颖而出
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T12:12:03.000Z" title="Wed Nov 26 2025 12:12:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>做<code>Manim</code>动画久了，你是否厌倦了那万年不变的黑色虚空？</p>
<p>很多初学者（甚至老手）都想给动画加个背景图，但往往会遇到两个问题：</p>
<ol>
<li><strong>怎么加</strong>？ 是把图片放进去，还是设置相机？</li>
<li><strong>看不清</strong>！ 背景花里胡哨，前面的文字公式瞬间“隐身”了。</li>
</ol>
<p>今天，我们就来揭开<code>Manim</code>动画中一个简单却强大的技巧--为动画添加背景。</p>
<p>通过几个小示例，分别演示两种完全不同的背景处理思路。</p>
<h2 data-id="heading-0">1. 舞台布景法</h2>
<p>使用<code>ImageMobject</code>类，这是最直观、最常用的方法。</p>
<p>它的<strong>逻辑</strong>是：背景图片只是舞台上的一个普通演员，只是它长得特别大，而且站得特别靠后。</p>
<p>这种方式的<strong>特点</strong>是：</p>
<ul>
<li>
<p><strong>高度灵活</strong>：背景就是个对象（<code>Mobject</code>），所以它可以动！你可以让背景旋转、平移、缩放，甚至改变颜色。</p>
</li>
<li>
<p><strong>层级管理</strong>：需要手动把它的 <code>z_index</code> 设低，或者最先添加它。</p>
</li>
</ul>
<p>下面的第一个示例中，实现一个简单的<strong>动态背景</strong>，操作<strong>背景</strong>和操作一般的<code>Mobject</code>是一样的。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Method1ImageMobject</span>(<span class="hljs-title class_ inherited__">Scene</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 1. 加载图片（确保这个图片是存在的）</span>
        bg = ImageMobject(<span class="hljs-string">"./assets/紫色梦幻星空.jpg"</span>)

        <span class="hljs-comment"># 2. 核心操作：撑满屏幕并允许超出</span>
        <span class="hljs-comment"># 我们把高度设为屏幕高度的 2 倍，这样才有移动的空间</span>
        bg.scale_to_fit_height(config.frame_height * <span class="hljs-number">2</span>)

        <span class="hljs-comment"># 3. 核心操作：放到最底层</span>
        bg.set_z_index(-<span class="hljs-number">100</span>)

        self.add(bg)

        <span class="hljs-comment"># 前景物体</span>
        text = Text(<span class="hljs-string">"方法一：ImageMobject"</span>, font_size=<span class="hljs-number">40</span>, color=WHITE)
        sub = Text(<span class="hljs-string">"背景可以动！"</span>, font_size=<span class="hljs-number">24</span>, color=YELLOW).next_to(text, DOWN)

        self.play(Write(text), FadeIn(sub))

        <span class="hljs-comment"># 4. 演示优势：让背景缓慢移动</span>
        self.play(bg.animate.shift(LEFT * <span class="hljs-number">2</span>), rate_func=linear)
        self.play(bg.animate.shift(UP * <span class="hljs-number">2</span>), rate_func=linear)
        self.play(bg.animate.shift(RIGHT * <span class="hljs-number">2</span>), rate_func=linear)
        self.play(bg.animate.shift(DOWN * <span class="hljs-number">2</span>), rate_func=linear)
        self.wait()
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/061bb7b7bbc04a56b9da5766fa01197c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764763923&amp;x-signature=j6qOcgtvxSDXv1NOUOc%2BjPJpDSY%3D" alt="" loading="lazy"/></p>
<p>下面的示例也很简单，就是显示一段简单的公式。</p>
<p>不过，大家可以比较看看，相比于默认的黑色背景，加一个学校的黑板背景，是不是更有亲和力？</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Method2ImageMobject</span>(<span class="hljs-title class_ inherited__">Scene</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 1. 加载图片</span>
        bg = ImageMobject(<span class="hljs-string">"./assets/黑板.jpg"</span>)

        <span class="hljs-comment"># 2. 调整大小铺满屏幕</span>
        bg.scale_to_fit_height(config.frame_height)
        bg.scale_to_fit_width(config.frame_width)

        <span class="hljs-comment"># 3. 核心操作：放到最底层</span>
        bg.set_z_index(-<span class="hljs-number">100</span>)
        self.add(bg)

        <span class="hljs-comment"># 前景物体</span>
        math = MathTex(<span class="hljs-string">r"\int_0^\infty e^{-x^2} dx = \frac{\sqrt{\pi}}{2}"</span>)
        self.play(Write(math))
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/724f8e6c53344fe8b80ecd523d8ad594~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764763923&amp;x-signature=jQeh67hJOUrKJJxZNloxY7%2Bdu88%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2. 主角光环法</h2>
<p>除了上面两种，还有一种比较特殊的方式，也就是<code>BackgroundColoredVMobjectDisplayer</code>类。</p>
<p>它是一个<strong>负责渲染</strong>的类，专门处理一种特殊情况：<strong>当物体拥有“背景色描边”时，如何遮挡住它背后的东西</strong>。</p>
<p>我们通过 <code>set_background_stroke()</code> 来调用这个机制。</p>
<p>严格来说不是 <strong>“设置全屏背景”</strong>，而是 <strong>“给物体加一个局部背景（Matte）”</strong>，这是在花哨背景下生存的必备技能。</p>
<p>它的<strong>特点</strong>是：</p>
<ul>
<li><strong>局部遮挡</strong>：在文字或公式周围生成一圈不透明的轮廓。</li>
<li><strong>增强对比</strong>：专门用于解决“背景太花，文字看不清”的问题。</li>
</ul>
<p>下面的示例故意构造了一个混乱的背景，然后比较看看，这两个一样的公式，是不是加了局部背景的公式更加清晰。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ReadableFormulaOnImage</span>(<span class="hljs-title class_ inherited__">Scene</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 1. 先设置一个很花的背景（这里为了演示，我们用随机噪点模拟一张复杂的图）</span>
        <span class="hljs-comment"># 实际使用中，请换成你的 image.jpg</span>
        noise = Rectangle(width=<span class="hljs-number">16</span>, height=<span class="hljs-number">10</span>)
        noise.set_fill(color=[BLUE, RED, GREEN, YELLOW], opacity=<span class="hljs-number">0.5</span>)
        <span class="hljs-comment"># 把它搞得乱一点</span>
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):
            line = Line(
                start=[np.random.uniform(-<span class="hljs-number">7</span>, <span class="hljs-number">7</span>), np.random.uniform(-<span class="hljs-number">4</span>, <span class="hljs-number">4</span>), <span class="hljs-number">0</span>],
                end=[np.random.uniform(-<span class="hljs-number">7</span>, <span class="hljs-number">7</span>), np.random.uniform(-<span class="hljs-number">4</span>, <span class="hljs-number">4</span>), <span class="hljs-number">0</span>],
                color=random_color(),
                stroke_width=<span class="hljs-number">5</span>,
            )
            self.add(line)
        self.add(noise)

        <span class="hljs-comment"># 2. 普通的文字（在花背景下很难看清）</span>
        bad_text = MathTex(<span class="hljs-string">r"\frac{-b \pm \sqrt{b^2 - 4ac}}{2a}"</span>)
        bad_text.shift(UP)

        <span class="hljs-comment"># 3. 【核心技巧】使用 BackgroundColoredVMobject 机制</span>
        <span class="hljs-comment"># set_background_stroke 会给文字加一层“描边”</span>
        <span class="hljs-comment"># 这层描边是不透明的，会利用 Displayer 类遮挡住背景！</span>
        good_text = MathTex(<span class="hljs-string">r"\frac{-b \pm \sqrt{b^2 - 4ac}}{2a}"</span>)
        good_text.set_background_stroke(color=BLACK, width=<span class="hljs-number">8</span>)  <span class="hljs-comment"># 黑色描边，宽度设大一点</span>
        good_text.shift(DOWN)

        <span class="hljs-comment"># 动画演示对比</span>
        self.play(Write(bad_text))

        self.play(Write(good_text))  <span class="hljs-comment"># 清晰可见！</span>
        self.wait()
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4748c568b7ab457997efa40adcd02869~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764763923&amp;x-signature=9VFU8qZ%2Bi8B%2FrD1Tl8IPW2cBao8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">3. 两种方式比较</h2>
<p>两种方式各有自己的应用场景，对比如下：</p>








































<table><thead><tr><th>特性</th><th>舞台布景法</th><th>主角光环法</th></tr></thead><tbody><tr><td>本质</td><td>场景中的一个巨大物体</td><td>物体自身的描边属性</td></tr><tr><td>主要用途</td><td>动态背景、视差滚动、多层背景</td><td>高亮主体、对抗花哨背景</td></tr><tr><td>动画能力</td><td>⭐⭐⭐⭐⭐ (极强)</td><td>⭐⭐⭐ (跟随物体运动)</td></tr><tr><td>代码复杂度</td><td>中 (需手动调大小/层级)</td><td>低 (一行设置)</td></tr><tr><td>文档对应</td><td><code>Mobject </code>类</td><td><code>BackgroundColoredVMobjectDisplayer</code></td></tr><tr><td>最佳场景</td><td>漂浮的云、移动的星空</td><td>字幕、复杂背景下的公式</td></tr></tbody></table>
<h2 data-id="heading-3">4. 总结</h2>
<p>简单来说，如果你想做一段电影感的片头，背景需要缓慢推移，请用 <strong>舞台布景法</strong>；</p>
<p>如果你发现文字看不清了，请使用 <strong>主角光环法</strong> (<code>set_background_stroke</code>) 给文字加个 <strong>“光环”</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Solidity合约升级：让你的区块链代码永葆青春的硬核攻略]]></title>    <link>https://juejin.cn/post/7576859594359668736</link>    <guid>https://juejin.cn/post/7576859594359668736</guid>    <pubDate>2025-11-26T12:22:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576859594359668736" data-draft-id="7576867727718432803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Solidity合约升级：让你的区块链代码永葆青春的硬核攻略"/> <meta itemprop="keywords" content="Solidity,智能合约"/> <meta itemprop="datePublished" content="2025-11-26T12:22:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天涯学馆"/> <meta itemprop="url" content="https://juejin.cn/user/3394916565129287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Solidity合约升级：让你的区块链代码永葆青春的硬核攻略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3394916565129287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天涯学馆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T12:22:02.000Z" title="Wed Nov 26 2025 12:22:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天咱们来聊聊Solidity里一个超硬核的技术——合约升级！区块链上的智能合约一旦部署，默认是“铁打不动”的，但现实中需求总在变，bug也得修，咋办？合约升级就是救星！它能让你在不换地址、不丢数据的情况下，悄悄把合约逻辑更新，简直像给代码换了个新皮肤！咱们会用大白话把合约升级的套路讲透，从最简单的代理模式到OpenZeppelin的透明代理和UUPS，再到多签控制升级，配合硬核代码和Hardhat测试，带你一步步实现安全的合约升级。</p>
<h2 data-id="heading-0">核心概念</h2>
<p>先来搞明白几个关键点：</p>
<ul>
<li><strong>不可变性</strong>：以太坊智能合约部署后，字节码和存储通常不可更改。</li>
<li><strong>代理模式</strong>：通过代理合约（Proxy）分离存储和逻辑，代理保存数据，逻辑合约提供代码，升级时只换逻辑合约。</li>
<li><strong>委托调用（delegatecall）</strong>：代理通过<code>delegatecall</code>调用逻辑合约，逻辑合约的代码在代理的存储上下文执行。</li>
<li><strong>存储布局</strong>：代理和逻辑合约的存储槽必须一致，否则数据会乱套。</li>
<li><strong>升级机制</strong>：更新代理指向的逻辑合约地址，实现功能升级。</li>
<li><strong>安全风险</strong>：
<ul>
<li><strong>存储冲突</strong>：新逻辑合约的存储布局变化可能覆盖旧数据。</li>
<li><strong>权限控制</strong>：谁能升级？没限制可能被黑客搞乱。</li>
<li><strong>初始化</strong>：新逻辑合约需要正确初始化。</li>
</ul>
</li>
<li><strong>OpenZeppelin</strong>：提供透明代理（Transparent Proxy）和UUPS（Universal Upgradeable Proxy Standard）实现。</li>
<li><strong>Solidity 0.8.x</strong>：自带溢出/下溢检查，安全可靠。</li>
<li><strong>Hardhat</strong>：开发和测试工具，方便部署和验证。</li>
</ul>
<p>咱们用Solidity 0.8.20，结合OpenZeppelin和Hardhat，从基础代理到高级UUPS和多签升级，逐步实现安全的合约升级。</p>
<h2 data-id="heading-1">环境准备</h2>
<p>用Hardhat搭建开发环境，写和测试合约。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> upgrade-demo
<span class="hljs-built_in">cd</span> upgrade-demo
npm init -y
npm install --save-dev hardhat @nomicfoundation/hardhat-toolbox @openzeppelin/contracts @openzeppelin/contracts-upgradeable
npm install ethers
</code></pre>
<p>初始化Hardhat：</p>
<pre><code class="hljs language-bash" lang="bash">npx hardhat init
</code></pre>
<p>选择TypeScript项目，安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash">npm install --save-dev ts-node typescript @types/node @types/mocha
</code></pre>
<p>目录结构：</p>
<pre><code class="hljs language-lua" lang="lua">upgrade-demo/
├── contracts/
│   ├── SimpleProxy.sol
│   ├── LogicV1.sol
│   ├── LogicV2.sol
│   ├── TransparentProxy.sol
│   ├── UUPSProxy.sol
│   ├── MultiSigUpgrade.sol
├── scripts/
│   ├── deploy.ts
├── test/
│   ├── Upgrade.test.ts
├── hardhat.<span class="hljs-built_in">config</span>.ts
├── tsconfig.json
├── <span class="hljs-built_in">package</span>.json
</code></pre>
<p><code>tsconfig.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ES2020"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CommonJS"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"resolveJsonModule"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"rootDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"hardhat.config.ts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"scripts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"test"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><code>hardhat.config.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HardhatUserConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat/config"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"@nomicfoundation/hardhat-toolbox"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">HardhatUserConfig</span> = {
  <span class="hljs-attr">solidity</span>: <span class="hljs-string">"0.8.20"</span>,
  <span class="hljs-attr">networks</span>: {
    <span class="hljs-attr">hardhat</span>: {
      <span class="hljs-attr">chainId</span>: <span class="hljs-number">1337</span>,
    },
  },
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> config;
</code></pre>
<p>跑本地节点：</p>
<pre><code class="hljs language-bash" lang="bash">npx hardhat node
</code></pre>
<h2 data-id="heading-2">基础代理合约</h2>
<p>先搞一个简单的代理合约，弄清楚<code>delegatecall</code>和升级的套路。</p>
<h3 data-id="heading-3">合约代码</h3>
<p><code>contracts/LogicV1.sol</code>：</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

contract LogicV1 {
    address public owner;
    uint256 public value;

    function initialize(address _owner) public {
        require(owner == address(0), "Already initialized");
        owner = _owner;
    }

    function setValue(uint256 _value) public {
        require(msg.sender == owner, "Only owner");
        value = _value;
    }

    function getValue() public view returns (uint256) {
        return value;
    }
}
</code></pre>
<p><code>contracts/LogicV2.sol</code>：</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

contract LogicV2 {
    address public owner;
    uint256 public value;

    function initialize(address _owner) public {
        require(owner == address(0), "Already initialized");
        owner = _owner;
    }

    function setValue(uint256 _value) public {
        require(msg.sender == owner, "Only owner");
        value = _value * 2; // V2 doubles the value
    }

    function getValue() public view returns (uint256) {
        return value;
    }
}
</code></pre>
<p><code>contracts/SimpleProxy.sol</code>：</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

contract SimpleProxy {
    address public implementation;
    address public owner;

    constructor(address _implementation) {
        owner = msg.sender;
        implementation = _implementation;
    }

    function upgrade(address _newImplementation) public {
        require(msg.sender == owner, "Only owner");
        implementation = _newImplementation;
    }

    fallback() external payable {
        address impl = implementation;
        require(impl != address(0), "Implementation not set");

        assembly {
            let ptr := mload(0x40)
            calldatacopy(ptr, 0, calldatasize())
            let result := delegatecall(gas(), impl, ptr, calldatasize(), 0, 0)
            let size := returndatasize()
            returndatacopy(ptr, 0, size)
            switch result
            case 0 { revert(ptr, size) }
            default { return(ptr, size) }
        }
    }

    receive() external payable {}
}
</code></pre>
<h3 data-id="heading-4">解析</h3>
<ul>
<li><strong>LogicV1</strong>：基础逻辑合约，存<code>owner</code>和<code>value</code>，提供<code>initialize</code>、<code>setValue</code>、<code>getValue</code>。</li>
<li><strong>LogicV2</strong>：升级版，<code>setValue</code>将输入值翻倍，存储布局与V1一致。</li>
<li><strong>SimpleProxy</strong>：
<ul>
<li>存<code>implementation</code>（逻辑合约地址）和<code>owner</code>。</li>
<li><code>upgrade</code>：更新逻辑合约地址，仅<code>owner</code>可调用。</li>
<li><code>fallback</code>：用<code>delegatecall</code>转发调用到<code>implementation</code>，用汇编实现低级调用。</li>
</ul>
</li>
<li><strong>delegatecall</strong>：逻辑合约的代码在代理的存储上下文执行，<code>owner</code>和<code>value</code>存在代理合约。</li>
<li><strong>安全特性</strong>：
<ul>
<li><code>onlyOwner</code>限制升级权限。</li>
<li>检查<code>implementation</code>不为空。</li>
<li>初始化检查防止重复设置。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">测试</h3>
<p><code>test/Upgrade.test.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { ethers } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;
<span class="hljs-keyword">import</span> { expect } <span class="hljs-keyword">from</span> <span class="hljs-string">"chai"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SimpleProxy</span>, <span class="hljs-title class_">LogicV1</span>, <span class="hljs-title class_">LogicV2</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../typechain-types"</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">"SimpleProxy"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">proxy</span>: <span class="hljs-title class_">SimpleProxy</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">logicV1</span>: <span class="hljs-title class_">LogicV1</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">logicV2</span>: <span class="hljs-title class_">LogicV2</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">owner</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">addr1</span>: <span class="hljs-built_in">any</span>;

  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    [owner, addr1] = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getSigners</span>();
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">LogicV1Factory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV1"</span>);
    logicV1 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">LogicV1Factory</span>.<span class="hljs-title function_">deploy</span>();
    <span class="hljs-keyword">await</span> logicV1.<span class="hljs-title function_">deployed</span>();

    <span class="hljs-keyword">const</span> <span class="hljs-title class_">ProxyFactory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"SimpleProxy"</span>);
    proxy = <span class="hljs-keyword">await</span> <span class="hljs-title class_">ProxyFactory</span>.<span class="hljs-title function_">deploy</span>(logicV1.<span class="hljs-property">address</span>);
    <span class="hljs-keyword">await</span> proxy.<span class="hljs-title function_">deployed</span>();

    <span class="hljs-keyword">const</span> <span class="hljs-title class_">LogicV2Factory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV2"</span>);
    logicV2 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">LogicV2Factory</span>.<span class="hljs-title function_">deploy</span>();
    <span class="hljs-keyword">await</span> logicV2.<span class="hljs-title function_">deployed</span>();

    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-title class_">LogicV1Factory</span>.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>);
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">initialize</span>(owner.<span class="hljs-property">address</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should initialize correctly"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV1"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">owner</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(owner.<span class="hljs-property">address</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should set and get value"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV1"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">setValue</span>(<span class="hljs-number">42</span>);
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">getValue</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">42</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should restrict setValue to owner"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV1"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">expect</span>(proxyAsLogicV1.<span class="hljs-title function_">connect</span>(addr1).<span class="hljs-title function_">setValue</span>(<span class="hljs-number">42</span>)).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">revertedWith</span>(<span class="hljs-string">"Only owner"</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should upgrade to LogicV2"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV1"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">setValue</span>(<span class="hljs-number">42</span>);
    <span class="hljs-keyword">await</span> proxy.<span class="hljs-title function_">upgrade</span>(logicV2.<span class="hljs-property">address</span>);
    <span class="hljs-keyword">const</span> proxyAsLogicV2 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV2"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">setValue</span>(<span class="hljs-number">10</span>);
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">getValue</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">20</span>);
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">owner</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(owner.<span class="hljs-property">address</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should restrict upgrade to owner"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">expect</span>(proxy.<span class="hljs-title function_">connect</span>(addr1).<span class="hljs-title function_">upgrade</span>(logicV2.<span class="hljs-property">address</span>)).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">revertedWith</span>(<span class="hljs-string">"Only owner"</span>);
  });
});
</code></pre>
<p>跑测试：</p>
<pre><code class="hljs language-bash" lang="bash">npx hardhat <span class="hljs-built_in">test</span>
</code></pre>
<ul>
<li><strong>解析</strong>：
<ul>
<li>部署：<code>LogicV1</code>和<code>SimpleProxy</code>，通过代理调用<code>initialize</code>。</li>
<li>操作：设置<code>value</code>为42，验证存储在代理。</li>
<li>升级：切换到<code>LogicV2</code>，<code>setValue(10)</code>返回20，<code>owner</code>不变。</li>
<li>权限：非<code>owner</code>无法升级。</li>
</ul>
</li>
<li><strong>存储</strong>：代理保存<code>owner</code>和<code>value</code>，<code>delegatecall</code>确保逻辑合约操作代理存储。</li>
</ul>
<h2 data-id="heading-6">存储冲突的坑</h2>
<p>存储布局不一致会导致数据错乱，来看个错误例子。</p>
<h3 data-id="heading-7">错误示例</h3>
<p><code>contracts/BadLogicV2.sol</code>：</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

contract BadLogicV2 {
    uint256 public value; // Slot 0 (wrong order)
    address public owner; // Slot 1 (wrong order)

    function initialize(address _owner) public {
        require(owner == address(0), "Already initialized");
        owner = _owner;
    }

    function setValue(uint256 _value) public {
        require(msg.sender == owner, "Only owner");
        value = _value * 2;
    }

    function getValue() public view returns (uint256) {
        return value;
    }
}
</code></pre>
<p>测试：</p>
<p><code>test/Upgrade.test.ts</code>（添加）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">it</span>(<span class="hljs-string">"should fail with storage collision"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV1"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
  <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">setValue</span>(<span class="hljs-number">42</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">BadLogicV2Factory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"BadLogicV2"</span>);
  <span class="hljs-keyword">const</span> badLogicV2 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">BadLogicV2Factory</span>.<span class="hljs-title function_">deploy</span>();
  <span class="hljs-keyword">await</span> badLogicV2.<span class="hljs-title function_">deployed</span>();
  <span class="hljs-keyword">await</span> proxy.<span class="hljs-title function_">upgrade</span>(badLogicV2.<span class="hljs-property">address</span>);
  <span class="hljs-keyword">const</span> proxyAsBadLogicV2 = <span class="hljs-title class_">BadLogicV2Factory</span>.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>);
  <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsBadLogicV2.<span class="hljs-title function_">owner</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">not</span>.<span class="hljs-title function_">equal</span>(owner.<span class="hljs-property">address</span>);
});
</code></pre>
<ul>
<li><strong>问题</strong>：<code>LogicV1</code>的<code>owner</code>(slot 0), <code>value</code>(slot 1)，<code>BadLogicV2</code>的<code>value</code>(slot 0), <code>owner</code>(slot 1)，升级后<code>owner</code>被覆盖为<code>value</code>的值。</li>
<li><strong>解决</strong>：新逻辑合约必须保持存储布局一致，或用OpenZeppelin的工具规范化。</li>
</ul>
<h2 data-id="heading-8">透明代理（Transparent Proxy）</h2>
<p>用OpenZeppelin的透明代理，解决管理员和用户调用冲突。</p>
<p><code>contracts/LogicV1.sol</code>（更新）：</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";
import "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";

contract LogicV1 is Initializable, OwnableUpgradeable {
    uint256 public value;

    function initialize(address _owner) public initializer {
        __Ownable_init(_owner);
    }

    function setValue(uint256 _value) public onlyOwner {
        value = _value;
    }

    function getValue() public view returns (uint256) {
        return value;
    }
}
</code></pre>
<p><code>contracts/LogicV2.sol</code>（更新）：</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";
import "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";

contract LogicV2 is Initializable, OwnableUpgradeable {
    uint256 public value;

    function initialize(address _owner) public initializer {
        __Ownable_init(_owner);
    }

    function setValue(uint256 _value) public onlyOwner {
        value = _value * 2;
    }

    function getValue() public view returns (uint256) {
        return value;
    }
}
</code></pre>
<p><code>contracts/TransparentProxy.sol</code>：</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts/proxy/transparent/TransparentUpgradeableProxy.sol";

contract TransparentProxy is TransparentUpgradeableProxy {
    constructor(address logic, address admin, bytes memory data)
        TransparentUpgradeableProxy(logic, admin, data)
    {}
}
</code></pre>
<h3 data-id="heading-9">解析</h3>
<ul>
<li><strong>LogicV1/V2</strong>：
<ul>
<li>用<code>Initializable</code>和<code>OwnableUpgradeable</code>，支持代理初始化。</li>
<li><code>initializer</code>确保初始化只执行一次。</li>
</ul>
</li>
<li><strong>TransparentProxy</strong>：
<ul>
<li>继承<code>TransparentUpgradeableProxy</code>。</li>
<li>构造函数设置逻辑合约、管理员地址、初始化数据。</li>
<li>透明机制：管理员调用操作代理（如升级），普通用户调用转发到逻辑合约。</li>
</ul>
</li>
<li><strong>安全特性</strong>：
<ul>
<li>防止管理员误调用逻辑合约。</li>
<li><code>OwnableUpgradeable</code>管理权限。</li>
<li>标准化的存储布局。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10">测试</h3>
<p><code>test/Upgrade.test.ts</code>（更新）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { ethers } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;
<span class="hljs-keyword">import</span> { expect } <span class="hljs-keyword">from</span> <span class="hljs-string">"chai"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TransparentProxy</span>, <span class="hljs-title class_">LogicV1</span>, <span class="hljs-title class_">LogicV2</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../typechain-types"</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">"TransparentProxy"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">proxy</span>: <span class="hljs-title class_">TransparentProxy</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">logicV1</span>: <span class="hljs-title class_">LogicV1</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">logicV2</span>: <span class="hljs-title class_">LogicV2</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">owner</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">addr1</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">admin</span>: <span class="hljs-built_in">any</span>;

  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    [owner, addr1, admin] = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getSigners</span>();
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">LogicV1Factory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV1"</span>);
    logicV1 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">LogicV1Factory</span>.<span class="hljs-title function_">deploy</span>();
    <span class="hljs-keyword">await</span> logicV1.<span class="hljs-title function_">deployed</span>();

    <span class="hljs-keyword">const</span> <span class="hljs-title class_">ProxyFactory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"TransparentProxy"</span>);
    <span class="hljs-keyword">const</span> initData = <span class="hljs-title class_">LogicV1Factory</span>.<span class="hljs-property">interface</span>.<span class="hljs-title function_">encodeFunctionData</span>(<span class="hljs-string">"initialize"</span>, [owner.<span class="hljs-property">address</span>]);
    proxy = <span class="hljs-keyword">await</span> <span class="hljs-title class_">ProxyFactory</span>.<span class="hljs-title function_">deploy</span>(logicV1.<span class="hljs-property">address</span>, admin.<span class="hljs-property">address</span>, initData);
    <span class="hljs-keyword">await</span> proxy.<span class="hljs-title function_">deployed</span>();

    <span class="hljs-keyword">const</span> <span class="hljs-title class_">LogicV2Factory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV2"</span>);
    logicV2 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">LogicV2Factory</span>.<span class="hljs-title function_">deploy</span>();
    <span class="hljs-keyword">await</span> logicV2.<span class="hljs-title function_">deployed</span>();
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should initialize correctly"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV1"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">owner</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(owner.<span class="hljs-property">address</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should set and get value"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV1"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">setValue</span>(<span class="hljs-number">42</span>);
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">getValue</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">42</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should restrict setValue to owner"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV1"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">expect</span>(proxyAsLogicV1.<span class="hljs-title function_">connect</span>(addr1).<span class="hljs-title function_">setValue</span>(<span class="hljs-number">42</span>)).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">revertedWith</span>(<span class="hljs-string">"Ownable: caller is not the owner"</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should upgrade to LogicV2"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV1"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">setValue</span>(<span class="hljs-number">42</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">ProxyAdminFactory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"ProxyAdmin"</span>, admin);
    <span class="hljs-keyword">const</span> proxyAdmin = <span class="hljs-keyword">await</span> <span class="hljs-title class_">ProxyAdminFactory</span>.<span class="hljs-title function_">deploy</span>();
    <span class="hljs-keyword">await</span> proxyAdmin.<span class="hljs-title function_">deployed</span>();
    <span class="hljs-keyword">await</span> proxyAdmin.<span class="hljs-title function_">connect</span>(admin).<span class="hljs-title function_">upgrade</span>(proxy.<span class="hljs-property">address</span>, logicV2.<span class="hljs-property">address</span>);
    <span class="hljs-keyword">const</span> proxyAsLogicV2 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV2"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">setValue</span>(<span class="hljs-number">10</span>);
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">getValue</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">20</span>);
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">owner</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(owner.<span class="hljs-property">address</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should restrict upgrade to admin"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">ProxyAdminFactory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"ProxyAdmin"</span>, admin);
    <span class="hljs-keyword">const</span> proxyAdmin = <span class="hljs-keyword">await</span> <span class="hljs-title class_">ProxyAdminFactory</span>.<span class="hljs-title function_">deploy</span>();
    <span class="hljs-keyword">await</span> proxyAdmin.<span class="hljs-title function_">deployed</span>();
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">expect</span>(proxyAdmin.<span class="hljs-title function_">connect</span>(addr1).<span class="hljs-title function_">upgrade</span>(proxy.<span class="hljs-property">address</span>, logicV2.<span class="hljs-property">address</span>)).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">revertedWith</span>(<span class="hljs-string">"Ownable: caller is not the owner"</span>);
  });
});
</code></pre>
<ul>
<li><strong>解析</strong>：
<ul>
<li>部署：<code>LogicV1</code>和<code>TransparentProxy</code>，通过<code>initData</code>初始化。</li>
<li>操作：设置<code>value</code>为42。</li>
<li>升级：用<code>ProxyAdmin</code>切换到<code>LogicV2</code>，<code>setValue(10)</code>返回20。</li>
<li>权限：只有<code>admin</code>可升级。</li>
</ul>
</li>
<li><strong>透明机制</strong>：管理员调用直接操作代理，普通用户调用转发到逻辑合约。</li>
</ul>
<h2 data-id="heading-11">UUPS代理（Universal Upgradeable Proxy Standard）</h2>
<p>UUPS把升级逻辑放逻辑合约，代理更轻量。</p>
<p><code>contracts/UUPSLogicV1.sol</code>：</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";
import "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol";

contract UUPSLogicV1 is Initializable, OwnableUpgradeable, UUPSUpgradeable {
    uint256 public value;

    function initialize(address _owner) public initializer {
        __Ownable_init(_owner);
        __UUPSUpgradeable_init();
    }

    function setValue(uint256 _value) public onlyOwner {
        value = _value;
    }

    function getValue() public view returns (uint256) {
        return value;
    }

    function _authorizeUpgrade(address newImplementation) internal override onlyOwner {}
}
</code></pre>
<p><code>contracts/UUPSLogicV2.sol</code>：</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";
import "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol";

contract UUPSLogicV2 is Initializable, OwnableUpgradeable, UUPSUpgradeable {
    uint256 public value;

    function initialize(address _owner) public initializer {
        __Ownable_init(_owner);
        __UUPSUpgradeable_init();
    }

    function setValue(uint256 _value) public onlyOwner {
        value = _value * 2;
    }

    function getValue() public view returns (uint256) {
        return value;
    }

    function _authorizeUpgrade(address newImplementation) internal override onlyOwner {}
}
</code></pre>
<p><code>contracts/UUPSProxy.sol</code>：</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts/proxy/ERC1967/ERC1967Proxy.sol";

contract UUPSProxy is ERC1967Proxy {
    constructor(address logic, bytes memory data) ERC1967Proxy(logic, data) {}
}
</code></pre>
<h3 data-id="heading-12">解析</h3>
<ul>
<li><strong>UUPSLogicV1/V2</strong>：
<ul>
<li>继承<code>UUPSUpgradeable</code>，包含升级逻辑。</li>
<li><code>_authorizeUpgrade</code>：限制升级权限。</li>
</ul>
</li>
<li><strong>UUPSProxy</strong>：
<ul>
<li>继承<code>ERC1967Proxy</code>，逻辑地址存标准槽位。</li>
<li>构造函数：设置逻辑合约和初始化数据。</li>
</ul>
</li>
<li><strong>优势</strong>：
<ul>
<li>代理合约轻量，升级逻辑在逻辑合约。</li>
<li>可通过自毁移除升级功能。</li>
</ul>
</li>
<li><strong>安全特性</strong>：
<ul>
<li><code>onlyOwner</code>控制升级。</li>
<li><code>Initializer</code>防止重复初始化。</li>
<li>ERC1967标准槽位。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-13">测试</h3>
<p><code>test/Upgrade.test.ts</code>（更新）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { ethers } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;
<span class="hljs-keyword">import</span> { expect } <span class="hljs-keyword">from</span> <span class="hljs-string">"chai"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UUPSProxy</span>, <span class="hljs-title class_">UUPSLogicV</span>1, <span class="hljs-title class_">UUPSLogicV</span>2 } <span class="hljs-keyword">from</span> <span class="hljs-string">"../typechain-types"</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">"UUPSProxy"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">proxy</span>: <span class="hljs-title class_">UUPSProxy</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">logicV1</span>: <span class="hljs-title class_">UUPSLogicV</span>1;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">logicV2</span>: <span class="hljs-title class_">UUPSLogicV</span>2;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">owner</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">addr1</span>: <span class="hljs-built_in">any</span>;

  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    [owner, addr1] = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getSigners</span>();
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">LogicV1Factory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"UUPSLogicV1"</span>);
    logicV1 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">LogicV1Factory</span>.<span class="hljs-title function_">deploy</span>();
    <span class="hljs-keyword">await</span> logicV1.<span class="hljs-title function_">deployed</span>();

    <span class="hljs-keyword">const</span> <span class="hljs-title class_">ProxyFactory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"UUPSProxy"</span>);
    <span class="hljs-keyword">const</span> initData = <span class="hljs-title class_">LogicV1Factory</span>.<span class="hljs-property">interface</span>.<span class="hljs-title function_">encodeFunctionData</span>(<span class="hljs-string">"initialize"</span>, [owner.<span class="hljs-property">address</span>]);
    proxy = <span class="hljs-keyword">await</span> <span class="hljs-title class_">ProxyFactory</span>.<span class="hljs-title function_">deploy</span>(logicV1.<span class="hljs-property">address</span>, initData);
    <span class="hljs-keyword">await</span> proxy.<span class="hljs-title function_">deployed</span>();

    <span class="hljs-keyword">const</span> <span class="hljs-title class_">LogicV2Factory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"UUPSLogicV2"</span>);
    logicV2 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">LogicV2Factory</span>.<span class="hljs-title function_">deploy</span>();
    <span class="hljs-keyword">await</span> logicV2.<span class="hljs-title function_">deployed</span>();
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should initialize correctly"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"UUPSLogicV1"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">owner</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(owner.<span class="hljs-property">address</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should set and get value"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"UUPSLogicV1"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">setValue</span>(<span class="hljs-number">42</span>);
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">getValue</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">42</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should upgrade to LogicV2"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"UUPSLogicV1"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">setValue</span>(<span class="hljs-number">42</span>);
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">upgradeTo</span>(logicV2.<span class="hljs-property">address</span>);
    <span class="hljs-keyword">const</span> proxyAsLogicV2 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"UUPSLogicV2"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">setValue</span>(<span class="hljs-number">10</span>);
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">getValue</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">20</span>);
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">owner</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(owner.<span class="hljs-property">address</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should restrict upgrade to owner"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"UUPSLogicV1"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">expect</span>(proxyAsLogicV1.<span class="hljs-title function_">connect</span>(addr1).<span class="hljs-title function_">upgradeTo</span>(logicV2.<span class="hljs-property">address</span>)).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">revertedWith</span>(<span class="hljs-string">"Ownable: caller is not the owner"</span>);
  });
});
</code></pre>
<ul>
<li><strong>解析</strong>：
<ul>
<li>部署：<code>UUPSLogicV1</code>和<code>UUPSProxy</code>，通过<code>initData</code>初始化。</li>
<li>操作：设置<code>value</code>为42。</li>
<li>升级：调用<code>upgradeTo</code>切换到<code>LogicV2</code>，<code>setValue(10)</code>返回20。</li>
<li>权限：非<code>owner</code>无法升级。</li>
</ul>
</li>
<li><strong>UUPS特点</strong>：升级逻辑在逻辑合约，代理更轻量。</li>
</ul>
<h2 data-id="heading-14">多签控制升级</h2>
<p>为升级加多签机制，需多人同意。</p>
<p><code>contracts/MultiSigUpgrade.sol</code>：</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";
import "@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";

contract MultiSigUpgrade is Initializable, UUPSUpgradeable, OwnableUpgradeable {
    address[] public owners;
    uint256 public required;
    uint256 public transactionCount;
    mapping(uint256 =&gt; Transaction) public transactions;
    mapping(uint256 =&gt; mapping(address =&gt; bool)) public confirmations;
    uint256 public value;

    struct Transaction {
        address newImplementation;
        bool executed;
        uint256 confirmationCount;
    }

    event SubmitUpgrade(uint256 indexed txId, address indexed newImplementation);
    event ConfirmUpgrade(uint256 indexed txId, address indexed owner);
    event ExecuteUpgrade(uint256 indexed txId, address indexed newImplementation);
    event RevokeConfirmation(uint256 indexed txId, address indexed owner);

    modifier onlyOwner() {
        bool isOwner = false;
        for (uint256 i = 0; i &lt; owners.length; i++) {
            if (owners[i] == msg.sender) {
                isOwner = true;
                break;
            }
        }
        require(isOwner, "Not owner");
        _;
    }

    function initialize(address[] memory _owners, uint256 _required) public initializer {
        __Ownable_init(msg.sender);
        __UUPSUpgradeable_init();
        require(_owners.length &gt; 0, "Owners required");
        require(_required &gt; 0 &amp;&amp; _required &lt;= _owners.length, "Invalid required");
        owners = _owners;
        required = _required;
    }

    function setValue(uint256 _value) public onlyOwner {
        value = _value;
    }

    function getValue() public view returns (uint256) {
        return value;
    }

    function submitUpgrade(address newImplementation) public onlyOwner {
        require(newImplementation != address(0), "Invalid implementation");
        uint256 txId = transactionCount++;
        transactions[txId] = Transaction({
            newImplementation: newImplementation,
            executed: false,
            confirmationCount: 0
        });
        emit SubmitUpgrade(txId, newImplementation);
    }

    function confirmUpgrade(uint256 txId) public onlyOwner {
        Transaction storage transaction = transactions[txId];
        require(!transaction.executed, "Transaction already executed");
        require(!confirmations[txId][msg.sender], "Already confirmed");

        confirmations[txId][msg.sender] = true;
        transaction.confirmationCount++;
        emit ConfirmUpgrade(txId, msg.sender);

        if (transaction.confirmationCount &gt;= required) {
            executeUpgrade(txId);
        }
    }

    function executeUpgrade(uint256 txId) internal {
        Transaction storage transaction = transactions[txId];
        require(!transaction.executed, "Transaction already executed");
        require(transaction.confirmationCount &gt;= required, "Insufficient confirmations");

        transaction.executed = true;
        _authorizeUpgrade(transaction.newImplementation);
        _upgradeTo(transaction.newImplementation);
        emit ExecuteUpgrade(txId, transaction.newImplementation);
    }

    function revokeConfirmation(uint256 txId) public onlyOwner {
        Transaction storage transaction = transactions[txId];
        require(!transaction.executed, "Transaction already executed");
        require(confirmations[txId][msg.sender], "Not confirmed");

        confirmations[txId][msg.sender] = false;
        transaction.confirmationCount--;
        emit RevokeConfirmation(txId, msg.sender);
    }

    function _authorizeUpgrade(address newImplementation) internal override onlyOwner {}
}
</code></pre>
<p><code>contracts/MultiSigLogicV2.sol</code>：</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";
import "@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";

contract MultiSigLogicV2 is Initializable, UUPSUpgradeable, OwnableUpgradeable {
    address[] public owners;
    uint256 public required;
    uint256 public transactionCount;
    mapping(uint256 =&gt; Transaction) public transactions;
    mapping(uint256 =&gt; mapping(address =&gt; bool)) public confirmations;
    uint256 public value;

    struct Transaction {
        address newImplementation;
        bool executed;
        uint256 confirmationCount;
    }

    event SubmitUpgrade(uint256 indexed txId, address indexed newImplementation);
    event ConfirmUpgrade(uint256 indexed txId, address indexed owner);
    event ExecuteUpgrade(uint256 indexed txId, address indexed newImplementation);
    event RevokeConfirmation(uint256 indexed txId, address indexed owner);

    modifier onlyOwner() {
        bool isOwner = false;
        for (uint256 i = 0; i &lt; owners.length; i++) {
            if (owners[i] == msg.sender) {
                isOwner = true;
                break;
            }
        }
        require(isOwner, "Not owner");
        _;
    }

    function initialize(address[] memory _owners, uint256 _required) public initializer {
        __Ownable_init(msg.sender);
        __UUPSUpgradeable_init();
        require(_owners.length &gt; 0, "Owners required");
        require(_required &gt; 0 &amp;&amp; _required &lt;= _owners.length, "Invalid required");
        owners = _owners;
        required = _required;
    }

    function setValue(uint256 _value) public onlyOwner {
        value = _value * 2; // V2 doubles the value
    }

    function getValue() public view returns (uint256) {
        return value;
    }

    function submitUpgrade(address newImplementation) public onlyOwner {
        require(newImplementation != address(0), "Invalid implementation");
        uint256 txId = transactionCount++;
        transactions[txId] = Transaction({
            newImplementation: newImplementation,
            executed: false,
            confirmationCount: 0
        });
        emit SubmitUpgrade(txId, newImplementation);
    }

    function confirmUpgrade(uint256 txId) public onlyOwner {
        Transaction storage transaction = transactions[txId];
        require(!transaction.executed, "Transaction already executed");
        require(!confirmations[txId][msg.sender], "Already confirmed");

        confirmations[txId][msg.sender] = true;
        transaction.confirmationCount++;
        emit ConfirmUpgrade(txId, msg.sender);

        if (transaction.confirmationCount &gt;= required) {
            executeUpgrade(txId);
        }
    }

    function executeUpgrade(uint256 txId) internal {
        Transaction storage transaction = transactions[txId];
        require(!transaction.executed, "Transaction already executed");
        require(transaction.confirmationCount &gt;= required, "Insufficient confirmations");

        transaction.executed = true;
        _authorizeUpgrade(transaction.newImplementation);
        _upgradeTo(transaction.newImplementation);
        emit ExecuteUpgrade(txId, transaction.newImplementation);
    }

    function revokeConfirmation(uint256 txId) public onlyOwner {
        Transaction storage transaction = transactions[txId];
        require(!transaction.executed, "Transaction already executed");
        require(confirmations[txId][msg.sender], "Not confirmed");

        confirmations[txId][msg.sender] = false;
        transaction.confirmationCount--;
        emit RevokeConfirmation(txId, msg.sender);
    }

    function _authorizeUpgrade(address newImplementation) internal override onlyOwner {}
}
</code></pre>
<h3 data-id="heading-15">解析</h3>
<ul>
<li><strong>MultiSigUpgrade</strong>：
<ul>
<li>继承<code>UUPSUpgradeable</code>，支持多签升级。</li>
<li><code>owners</code>和<code>required</code>控制多签。</li>
<li><code>submitUpgrade</code>：提交升级提案。</li>
<li><code>confirmUpgrade</code>：确认提案，达标后执行。</li>
<li><code>executeUpgrade</code>：调用<code>_upgradeTo</code>切换逻辑。</li>
<li><code>revokeConfirmation</code>：撤销确认。</li>
</ul>
</li>
<li><strong>MultiSigLogicV2</strong>：升级版，<code>setValue</code>翻倍。</li>
<li><strong>安全特性</strong>：
<ul>
<li>多签防止单人误操作。</li>
<li><code>onlyOwner</code>限制操作。</li>
<li>检查<code>newImplementation</code>有效性。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">测试</h3>
<p><code>test/Upgrade.test.ts</code>（添加）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { ethers } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;
<span class="hljs-keyword">import</span> { expect } <span class="hljs-keyword">from</span> <span class="hljs-string">"chai"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UUPSProxy</span>, <span class="hljs-title class_">MultiSigUpgrade</span>, <span class="hljs-title class_">MultiSigLogicV2</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../typechain-types"</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">"MultiSigUpgrade"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">proxy</span>: <span class="hljs-title class_">UUPSProxy</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">logicV1</span>: <span class="hljs-title class_">MultiSigUpgrade</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">logicV2</span>: <span class="hljs-title class_">MultiSigLogicV2</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">owner1</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">owner2</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">owner3</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">nonOwner</span>: <span class="hljs-built_in">any</span>;

  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    [owner1, owner2, owner3, nonOwner] = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getSigners</span>();
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">LogicV1Factory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"MultiSigUpgrade"</span>);
    logicV1 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">LogicV1Factory</span>.<span class="hljs-title function_">deploy</span>();
    <span class="hljs-keyword">await</span> logicV1.<span class="hljs-title function_">deployed</span>();

    <span class="hljs-keyword">const</span> <span class="hljs-title class_">ProxyFactory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"UUPSProxy"</span>);
    <span class="hljs-keyword">const</span> initData = <span class="hljs-title class_">LogicV1Factory</span>.<span class="hljs-property">interface</span>.<span class="hljs-title function_">encodeFunctionData</span>(<span class="hljs-string">"initialize"</span>, [
      [owner1.<span class="hljs-property">address</span>, owner2.<span class="hljs-property">address</span>, owner3.<span class="hljs-property">address</span>],
      <span class="hljs-number">2</span>,
    ]);
    proxy = <span class="hljs-keyword">await</span> <span class="hljs-title class_">ProxyFactory</span>.<span class="hljs-title function_">deploy</span>(logicV1.<span class="hljs-property">address</span>, initData);
    <span class="hljs-keyword">await</span> proxy.<span class="hljs-title function_">deployed</span>();

    <span class="hljs-keyword">const</span> <span class="hljs-title class_">LogicV2Factory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"MultiSigLogicV2"</span>);
    logicV2 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">LogicV2Factory</span>.<span class="hljs-title function_">deploy</span>();
    <span class="hljs-keyword">await</span> logicV2.<span class="hljs-title function_">deployed</span>();
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should initialize correctly"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"MultiSigUpgrade"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">owners</span>(<span class="hljs-number">0</span>)).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(owner1.<span class="hljs-property">address</span>);
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV1.required()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">2</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should set and get value"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"MultiSigUpgrade"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">setValue</span>(<span class="hljs-number">42</span>);
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">getValue</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">42</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should upgrade with multi-sig"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"MultiSigUpgrade"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">setValue</span>(<span class="hljs-number">42</span>);
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">submitUpgrade</span>(logicV2.<span class="hljs-property">address</span>);
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">connect</span>(owner2).<span class="hljs-title function_">confirmUpgrade</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">connect</span>(owner3).<span class="hljs-title function_">confirmUpgrade</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> proxyAsLogicV2 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"MultiSigLogicV2"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">setValue</span>(<span class="hljs-number">10</span>);
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">getValue</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">20</span>);
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">owners</span>(<span class="hljs-number">0</span>)).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(owner1.<span class="hljs-property">address</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should not upgrade without enough confirmations"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"MultiSigUpgrade"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">submitUpgrade</span>(logicV2.<span class="hljs-property">address</span>);
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">connect</span>(owner2).<span class="hljs-title function_">confirmUpgrade</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> proxyAsLogicV2 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"MultiSigLogicV2"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">setValue</span>(<span class="hljs-number">10</span>);
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">getValue</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">10</span>); <span class="hljs-comment">// Still V1</span>
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should allow revoking confirmation"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"MultiSigUpgrade"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">submitUpgrade</span>(logicV2.<span class="hljs-property">address</span>);
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">connect</span>(owner2).<span class="hljs-title function_">confirmUpgrade</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">connect</span>(owner2).<span class="hljs-title function_">revokeConfirmation</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">await</span> proxyAsLogicV1.<span class="hljs-title function_">connect</span>(owner3).<span class="hljs-title function_">confirmUpgrade</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> proxyAsLogicV2 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"MultiSigLogicV2"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-title function_">expect</span>(<span class="hljs-keyword">await</span> proxyAsLogicV2.<span class="hljs-title function_">getValue</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// Still V1</span>
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should restrict upgrade to owners"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> proxyAsLogicV1 = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"MultiSigUpgrade"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">attach</span>(proxy.<span class="hljs-property">address</span>));
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">expect</span>(proxyAsLogicV1.<span class="hljs-title function_">connect</span>(nonOwner).<span class="hljs-title function_">submitUpgrade</span>(logicV2.<span class="hljs-property">address</span>)).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">revertedWith</span>(<span class="hljs-string">"Not owner"</span>);
  });
});
</code></pre>
<ul>
<li><strong>解析</strong>：
<ul>
<li>部署：3个<code>owners</code>，需2人确认。</li>
<li>操作：设置<code>value</code>为42。</li>
<li>升级：提交提案，2人确认后切换到<code>LogicV2</code>，<code>setValue(10)</code>返回20。</li>
<li>撤销：撤销确认阻止升级。</li>
</ul>
</li>
<li><strong>安全</strong>：多签机制防止单人误操作。</li>
</ul>
<h2 data-id="heading-17">部署脚本</h2>
<p><code>scripts/deploy.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { ethers } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [owner, admin, owner1, owner2, owner3] = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getSigners</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title class_">LogicV1Factory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"LogicV1"</span>);
  <span class="hljs-keyword">const</span> logicV1 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">LogicV1Factory</span>.<span class="hljs-title function_">deploy</span>();
  <span class="hljs-keyword">await</span> logicV1.<span class="hljs-title function_">deployed</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`LogicV1 deployed to: <span class="hljs-subst">${logicV1.address}</span>`</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title class_">TransparentProxyFactory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"TransparentProxy"</span>);
  <span class="hljs-keyword">const</span> initData = <span class="hljs-title class_">LogicV1Factory</span>.<span class="hljs-property">interface</span>.<span class="hljs-title function_">encodeFunctionData</span>(<span class="hljs-string">"initialize"</span>, [owner.<span class="hljs-property">address</span>]);
  <span class="hljs-keyword">const</span> transparentProxy = <span class="hljs-keyword">await</span> <span class="hljs-title class_">TransparentProxyFactory</span>.<span class="hljs-title function_">deploy</span>(logicV1.<span class="hljs-property">address</span>, admin.<span class="hljs-property">address</span>, initData);
  <span class="hljs-keyword">await</span> transparentProxy.<span class="hljs-title function_">deployed</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`TransparentProxy deployed to: <span class="hljs-subst">${transparentProxy.address}</span>`</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title class_">UUPSLogicV</span>1Factory = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"UUPSLogicV1"</span>);
  <span class="hljs-keyword">const</span> uupsLogicV1 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">UUPSLogicV</span>1Factory.<span class="hljs-title function_">deploy</span>();
  <span class="hljs-keyword">await</span> uupsLogicV1.<span class="hljs-title function_">deployed</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`UUPSLogicV1 deployed to: <span class="hljs-subst">${uupsLogicV1.address}</span>`</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title class_">UUPSProxyFactory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"UUPSProxy"</span>);
  <span class="hljs-keyword">const</span> uupsProxy = <span class="hljs-keyword">await</span> <span class="hljs-title class_">UUPSProxyFactory</span>.<span class="hljs-title function_">deploy</span>(uupsLogicV1.<span class="hljs-property">address</span>, initData);
  <span class="hljs-keyword">await</span> uupsProxy.<span class="hljs-title function_">deployed</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`UUPSProxy deployed to: <span class="hljs-subst">${uupsProxy.address}</span>`</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title class_">MultiSigLogicV1Factory</span> = <span class="hljs-keyword">await</span> ethers.<span class="hljs-title function_">getContractFactory</span>(<span class="hljs-string">"MultiSigUpgrade"</span>);
  <span class="hljs-keyword">const</span> multiSigLogicV1 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">MultiSigLogicV1Factory</span>.<span class="hljs-title function_">deploy</span>();
  <span class="hljs-keyword">await</span> multiSigLogicV1.<span class="hljs-title function_">deployed</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`MultiSigUpgrade deployed to: <span class="hljs-subst">${multiSigLogicV1.address}</span>`</span>);

  <span class="hljs-keyword">const</span> multiSigInitData = <span class="hljs-title class_">MultiSigLogicV1Factory</span>.<span class="hljs-property">interface</span>.<span class="hljs-title function_">encodeFunctionData</span>(<span class="hljs-string">"initialize"</span>, [
    [owner1.<span class="hljs-property">address</span>, owner2.<span class="hljs-property">address</span>, owner3.<span class="hljs-property">address</span>],
    <span class="hljs-number">2</span>,
  ]);
  <span class="hljs-keyword">const</span> multiSigProxy = <span class="hljs-keyword">await</span> <span class="hljs-title class_">UUPSProxyFactory</span>.<span class="hljs-title function_">deploy</span>(multiSigLogicV1.<span class="hljs-property">address</span>, multiSigInitData);
  <span class="hljs-keyword">await</span> multiSigProxy.<span class="hljs-title function_">deployed</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`MultiSigProxy deployed to: <span class="hljs-subst">${multiSigProxy.address}</span>`</span>);
}

<span class="hljs-title function_">main</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
  process.<span class="hljs-property">exitCode</span> = <span class="hljs-number">1</span>;
});
</code></pre>
<p>跑部署：</p>
<pre><code class="hljs language-bash" lang="bash">npx hardhat run scripts/deploy.ts --network hardhat
</code></pre>
<ul>
<li><strong>解析</strong>：部署所有代理和逻辑合约，记录地址。</li>
</ul>
<h2 data-id="heading-18">性能分析</h2>
<ul>
<li><strong>部署</strong>：
<ul>
<li><code>SimpleProxy</code>：~0.6M gas。</li>
<li><code>TransparentProxy</code>：~1.2M gas。</li>
<li><code>UUPSProxy</code>：~0.8M gas。</li>
<li><code>LogicV1</code>/<code>UUPSLogicV1</code>：~1M gas。</li>
<li><code>MultiSigUpgrade</code>：~1.5M gas。</li>
</ul>
</li>
<li><strong>操作</strong>：
<ul>
<li>初始化：~100k gas。</li>
<li>设置值：~50k gas。</li>
<li>升级：~~60k gas（透明），~~40k gas（UUPS），~100k gas（多签）。</li>
</ul>
</li>
</ul>
<hr/>
<p>跑代码，体验Solidity合约升级的硬核玩法吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[给 TRAE SOLO 一台服务器，它能干什么？]]></title>    <link>https://juejin.cn/post/7576821684252475435</link>    <guid>https://juejin.cn/post/7576821684252475435</guid>    <pubDate>2025-11-26T12:36:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576821684252475435" data-draft-id="7576859345935089718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="给 TRAE SOLO 一台服务器，它能干什么？"/> <meta itemprop="keywords" content="Trae,Solo,AI编程"/> <meta itemprop="datePublished" content="2025-11-26T12:36:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            给 TRAE SOLO 一台服务器，它能干什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T12:36:45.000Z" title="Wed Nov 26 2025 12:36:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前一阵子刷到一个很有意思的操作：有人直接把一台服务器的权限扔给了 AI，并简单说了句目标。</p>
<p>然后，AI 就从零开始安装环境、配依赖，拉仓库，启动服务，最后成功完成了对外服务的提供。</p>
<p>今天，我们就尝试下这个思路：让 <code>TRAE SOLO</code> 自行在远程服务器中搭建一套 <code>MinerU</code> 环境。</p>
<h2 data-id="heading-0">MinerU</h2>
<p>首先，简单介绍下 <code>MinerU</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33f6d82478d04e299eb19d753a2feee7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=eyAcvMYv80Ko0lYxi894%2BhOMfN4%3D" alt="" loading="lazy"/></p>
<p><code>MinerU</code> 是一款能将<strong>PDF/图片转换为机器可读格式</strong>（例如 <code>markdown</code>、<code>JSON</code>）的工具，诞生于上海人工智能实验室出品大模型 <code>InternLM</code> 的预训练过程中。</p>
<p>核心特性：</p>
<ul>
<li><strong>多模态文档解析</strong>：支持多种文档类型，包括扫描版 PDF</li>
<li><strong>结构化还原</strong>：可识别表格、公式、分子式等</li>
<li><strong>高保真语义理解</strong>：利用布局分析和阅读顺序推理，避免传统 OCR 机械识别导致的逻辑错乱。</li>
<li><strong>本地化 &amp; 开源免费</strong>：全部模型和代码开源，可私有部署，无需调用外部 API，保障数据隐私。</li>
</ul>
<h2 data-id="heading-1">共绩算力</h2>
<p>AI 要部署的应用已经了解了，现在需要给 AI 找一个可以操作的服务器。</p>
<p>最近我使用的算力平台是“共绩算力”，<code>RTX 4090</code> 只要 <code>1.68</code> 元/小时，还能按毫秒计费、自动扩容，非常便于我根据研究的模型挑选合适的节点配置。</p>
<p>尤其是目前，平台还有福利，<strong>注册就送算力券</strong>。</p>
<h2 data-id="heading-2">实操记录</h2>
<h3 data-id="heading-3">节点建立</h3>
<p>注册并登录“共绩算力”平台。</p>
<p>在“云主机”页面选择合适的节点</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/381d765e27df439a89ad4481f0287395~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=Rc4YtH5x9fML4ri8vP5vSZVT9jw%3D" alt="" loading="lazy"/></p>
<p>选择合适的节点类型后，配置相关镜像、存储等，我这里配置了“基础镜像”，由于是测试搭建模型，未配置相关存储。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45720f1c6b0c433eb1630a9778577e87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=ZHXguh3rd2MYd2LyIXgx%2F%2FIF8wI%3D" alt="" loading="lazy"/></p>
<p>如果是第一次租用，账户余额为 0，会要求充值一下（0.01元即可），然后，需要在个人中心关注下公众号，这些按照页面提示进行即可。</p>
<p>租用成功后，会在“控制台”-“云主机列表”中看到租用的节点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ced2f6fccc284a258c6b961f3df6fc34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=c53clo2VeJABljwf1KwMHtyaP8E%3D" alt="" loading="lazy"/></p>
<p>24G 显存、63G 内存，1小时 1.68 元，并且有算力券抵扣，还很合适的。</p>
<h3 data-id="heading-4">远程连接</h3>
<p><strong>第一步</strong>，我们先来调整下 <code>SSH</code> 连接的命令，让其支持端口映射，方便访问 demo。</p>
<p>在上一步的“云主机列表”-“SSH登录信息”中，复制出登录指令，格式如下。</p>
<pre><code class="hljs language-css" lang="css">ssh root<span class="hljs-keyword">@hdy1</span>.550c.cloud -p <span class="hljs-number">40002</span>
</code></pre>
<p>增加<strong>端口映射参数</strong>。</p>
<pre><code class="hljs language-java" lang="java">ssh -vvN -L <span class="hljs-number">7860</span>:<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">7860</span> root<span class="hljs-meta">@hdy1</span>.550c.cloud -p <span class="hljs-number">40002</span>
</code></pre>
<p>其中 <code>7860</code> 是 <code>MinerU demo</code> 的服务端口。</p>
<p><strong>第二步</strong>，我们打开 <code>TRAE</code> 进行远程连接。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f9b703dfe8241f19585bdafa24cd984~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=M1BqQ%2FKJfoL%2FPVZAlOzkjla%2Fc70%3D" alt="" loading="lazy"/></p>
<p>输入上面的指令，回车即可。</p>
<p>此时会要求录入密码，再次从“云主机列表”-“SSH登录信息”中复制“登录密码”即可。</p>
<blockquote>
<p>如果同一地址连接多次，可能会在 SSH 连接中生成多个相同的 Host，此时会出现登录失败的情况，手动删除重复的 Host 即可。</p>
</blockquote>
<p>成功连接后，终端信息如下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a9b28a6d3d742e1a8102d68ad591783~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=m8gIiVOKAC5gAOWKDOX9fEqEBFc%3D" alt="" loading="lazy"/></p>
<p>正常情况下可以在编辑器中打开远程文件夹，也可以在终端执行命令了。</p>
<p>但今天，我们都交给 AI。</p>
<h3 data-id="heading-5">环境部署</h3>
<p>开发环境：国际版 <code>SOLO Coder</code> 智能体，未选择 <code>Plan</code> 模式。</p>
<p>直接在 <code>Chat</code> 窗口录入如下指令，等待完成。</p>
<p><strong>指令</strong></p>
<p>指令非常简单，让 AI 参考 <code>MinerU</code> 官方仓库文档，自行完成部署。</p>
<p>因为模型下载涉及到 <code>HuggingFace</code> 的网络问题，一般各大算力企业都会提供镜像内容，这里把“共绩算力”的镜像文档也放上了。</p>
<pre><code class="hljs language-ruby" lang="ruby">参考github文档<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/opendatalab</span><span class="hljs-regexp">/mineru?tab=readme-ov-file ，帮我完成mineru的安装，并完成demo启动。
云服务器文档：https:/</span><span class="hljs-regexp">/www.gongjiyun.com/docs</span><span class="hljs-regexp">/server/introduction</span><span class="hljs-regexp">/rznmwsy13i4a8yktuyycoxyinmg/</span> 
</code></pre>
<p><strong>过程</strong></p>
<p>过程很清晰：安装依赖、下载模型、启动Demo。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ed996c916d140cdb6e08f5c1fdf5da5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=zqHwEcUepdAd22Ase9gK8vIZOhs%3D" alt="" loading="lazy"/></p>
<p>后面还有详细的安装步骤、网络加速与镜像建议、常用参数与优化、问题排查、后续可选增强等内容，便于我们回顾审阅。</p>
<p><strong>SOLO 模式的好处就是中间遇到问题，它可以自行解决</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a961e3db9aa7494f8246f58bcf74ae20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=xQkx4ScwbTogw%2Bfyg2KosdmFI84%3D" alt="" loading="lazy"/></p>
<p>最后还给出了 demo 的访问方式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad9688c470114572ba55130ceef88e8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=BzTO%2FbDrygPDuRktGgBxwy02eHw%3D" alt="" loading="lazy"/></p>
<p><strong>结果</strong></p>
<p>命令执行完成后，<code>SOLO</code> 内置浏览器已经帮我把 demo 打开了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbb24fca4efe455ea6f1c14f79537ddb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=1diCpbeVDiDxzba0NULY8kS%2F6PU%3D" alt="" loading="lazy"/></p>
<p>这里可以通过 <code>http://localhost:7860/</code> 访问到服务器，就是因为“远程连接”章节中的 SSH 命令中增加了端口映射。</p>
<h3 data-id="heading-6">调试优化</h3>
<p>上面跑起来的 demo，上传测试的 PDF 后，转换报错。</p>
<p>不着急，我们直接让 <code>SOLO</code> 帮忙修复下。</p>
<p><strong>指令</strong></p>
<pre><code class="hljs">demo中上传后报错，请帮我修复
</code></pre>
<p><strong>过程</strong></p>
<p><code>SOLO</code> 可以从终端中获取错误信息，快速定位问题：</p>
<p>“上传解析时报错的根因是 Gradio 处理流程在解析时尝试访问 HuggingFace 获取模型元数据，出现 SSL 错误导致函数返回 None ，最终触发 TypeError: cannot unpack non-iterable NoneType object ”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/147e903ead2f409eb39b6ffa8b9c95c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=NjQAkBUNiBJd0hRoLD75Qfim%2B1c%3D" alt="" loading="lazy"/></p>
<p><strong>结果</strong></p>
<p>再次上传 <code>PDF</code>，可以看到提取结果了，已经完成了今天的既定目标了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fad90c7e2c44072961045993260da4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=nZEk2Y46KqYNQjC%2F79J7mgqmy%2FQ%3D" alt="" loading="lazy"/></p>
<p>由于模型参数未调优，识别中存在些许问题，非此次分享重点，我们就不再讨论了。</p>
<h2 data-id="heading-7">结语</h2>
<p>整个过程还是非常顺利的，除了我第一次忘记配置模型镜像下载导致的失败。</p>
<p>之前以为 AI 可以自己 <code>SOLO</code> 代码就很酷了，没想到，AI 都已经可以自己掌控服务器了。</p>
<p>给个目标，就能直接等待验收？那后续技术验证、环境搭建脚本岂不是更轻松了。</p>
<p>当部署、调试、优化也能交给 AI 自主完成后，开发者就有了更多的时间去思考“做什么”而非“怎么做”——这或许才是智能时代的生产力跃迁。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LLM 推理的“显存墙”与“通信墙”：从显存分布到部署原则]]></title>    <link>https://juejin.cn/post/7576852209565499419</link>    <guid>https://juejin.cn/post/7576852209565499419</guid>    <pubDate>2025-11-26T11:12:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576852209565499419" data-draft-id="7576838095519219763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" LLM 推理的“显存墙”与“通信墙”：从显存分布到部署原则"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-26T11:12:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mwq30123"/> <meta itemprop="url" content="https://juejin.cn/user/3403743729030686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             LLM 推理的“显存墙”与“通信墙”：从显存分布到部署原则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743729030686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mwq30123
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T11:12:53.000Z" title="Wed Nov 26 2025 11:12:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是一篇基于我们之前的对话内容整合而成的深度技术文章。文章从你提供的关于“显存与带宽限制”的精辟论述出发，深入剖析了 Llama-3-70B 的实际数据，对比了 MHA 与 GQA 的巨大差异，并探讨了 LLM 推理系统的核心瓶颈。</p>
<hr/>
<h2 data-id="heading-0">破解 LLM 推理的“显存墙”与“通信墙”：从显存分布到部署原则</h2>
<h4 data-id="heading-1">引言：推理系统的双重束缚</h4>
<p>众所周知，一般情况下 LLM 的推理都是在 GPU 上进行。单张 GPU 的显存是有限的，这构成了大模型落地的第一道物理屏障。显存的占用主要分为两大部分：</p>
<ol>
<li><strong>静态显存（Static Memory）</strong> ：用于存放模型的参数（Weights）和前向计算的临时激活值（Activations）。这部分依赖于模型的体量，一旦选定模型（如 70B 或 405B），它几乎就是一个固定的常数，是我们进入游戏的“门票”。</li>
<li><strong>动态显存（Dynamic Memory）</strong> ：主要用于存放 <strong>KV Cache</strong>。这部分不仅依赖于模型的体量，更强依赖于模型的输入长度（Context Length）和并发量（Batch Size）。在推理过程中，它是动态线性增长的。当 Context 长度足够长时，它的大小就会反客为主，占据主导地位，甚至轻松超出一张卡、一台机（8张卡）的总显存量。</li>
</ol>
<p>在 GPU 上部署模型有一个黄金原则：<strong>能一张卡部署的，就不要跨多张卡；能一台机部署的，就不要跨多台机。</strong></p>
<p>这是因为数据传输遵循严格的物理层级： <strong>“卡内通信带宽（SRAM ↔ HBM） &gt; 卡间通信带宽（NVLink） &gt; 机间通信带宽（Infiniband/Ethernet）”</strong> 。由于“木桶效应”，模型部署时跨越的物理设备越多，受低速通信带宽的“拖累”就越大。事实上，即便是目前最顶级的 H100，其卡内显存带宽（HBM3）虽然达到了 3TB/s，但对于 Short Context 推理（Memory Bound 场景）来说，这个速度依然是瓶颈，更不用说速度下降数个数量级的卡间和机间通信了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe1a1cd2190a4c8c9a82828f1387ba5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbXdxMzAxMjM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764760388&amp;x-signature=fP4lCr0rriERst%2BCyMS7rj3crJ0%3D" alt="截屏2025-11-26 19.11.37.png" loading="lazy"/></p>
<h4 data-id="heading-2">一、 显存账本：Llama-3-70B 的真实开销</h4>
<p>为了具象化理解上述原则，我们以 <strong>Llama-3-70B</strong> 模型在 <strong>FP16</strong> 精度下的部署为例，算一笔显存的账。</p>
<h5 data-id="heading-3">1. 静态显存：昂贵的入场券</h5>
<p>Llama-3-70B 拥有 700 亿参数。在 FP16 精度下，每个参数占用 2 Bytes。</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Static Usage</mtext><mo>≈</mo><mn>70</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mn>9</mn></msup><mo>×</mo><mn>2</mn><mtext> Bytes</mtext><mo>≈</mo><mrow><mn mathvariant="bold">140</mn><mtext> GB</mtext></mrow></mrow><annotation encoding="application/x-tex">\text{Static Usage} \approx 70 \times 10^9 \times 2 \text{ Bytes} \approx \mathbf{140 \text{ GB}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">Static Usage</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">70</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord">2</span><span class="mord text"><span class="mord"> Bytes</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord"><span class="mord mathbf">140</span><span class="mord text"><span class="mord"> GB</span></span></span></span></span></span></span></p>
<p>这意味着，仅仅是为了加载模型，你就至少需要 <strong>2张 80GB 的 A100/H100</strong>。如果只有一张卡，连模型都无法启动。这 140GB 是雷打不动的“固定成本”。</p>
<h5 data-id="heading-4">2. 动态显存：被忽视的隐形杀手</h5>
<p>动态显存的核心是 KV Cache。它存储了所有历史 Token 的键（Key）和值（Value），以避免重复计算。Llama-3-70B 采用了 <strong>GQA（分组查询注意力）</strong> 技术，将 KV Heads 的数量压缩到了 8 个。</p>
<p>在此架构下，每生成或处理 <strong>1 个 Token</strong>，其 KV Cache 的显存占用约为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>Mem</mtext><mtext>token</mtext></msub><mo>≈</mo><mrow><mn mathvariant="bold">0.31</mn><mtext> MB</mtext></mrow></mrow><annotation encoding="application/x-tex">\text{Mem}_{\text{token}} \approx \mathbf{0.31 \text{ MB}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord text"><span class="mord">Mem</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">token</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord"><span class="mord mathbf">0.31</span><span class="mord text"><span class="mord"> MB</span></span></span></span></span></span></span></p>
<blockquote>
<p>文章底部有计算过程</p>
</blockquote>
<p>看似很小？让我们看看在不同场景下的<strong>总账</strong>：</p>
<ul>
<li>
<p><strong>场景 A（长文档分析）</strong> ：Batch Size=1，Context=32k。</p>
<ul>
<li>KV Cache <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>10</mn><mtext> GB</mtext></mrow><annotation encoding="application/x-tex">\approx 10 \text{ GB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">10</span><span class="mord text"><span class="mord"> GB</span></span></span></span></span></span>。此时 2张卡（共160GB，剩20GB可用）还能勉强应付。</li>
</ul>
</li>
<li>
<p><strong>场景 B（高并发服务）</strong> ：Batch Size=64，Context=2k。</p>
<ul>
<li>KV Cache <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>41</mn><mtext> GB</mtext></mrow><annotation encoding="application/x-tex">\approx 41 \text{ GB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">41</span><span class="mord text"><span class="mord"> GB</span></span></span></span></span></span>。</li>
<li><strong>结果</strong>：此时总显存需求达到 181GB，<strong>2张卡直接显存溢出（OOM）</strong> ，系统崩溃。</li>
</ul>
</li>
</ul>
<p>这验证了引言中的判断：<strong>在长文本或高并发场景下，动态显存会迅速吞噬剩余空间，迫使我们增加更多昂贵的 GPU。</strong></p>
<h4 data-id="heading-5">二、 架构的演进：为何 MHA 正在被抛弃？</h4>
<p>为了解决“动态显存爆炸”的问题，现代大模型（如 Llama 3, Mistral）纷纷抛弃了传统的 <strong>MHA（多头注意力）</strong> ，转而使用 <strong>GQA（分组查询注意力）</strong> 。</p>
<p>我们可以做一个<strong>反事实假设</strong>：如果 Llama-3-70B 坚持使用 MHA，会发生什么？</p>
<p>在 MHA 架构下，KV Heads 的数量必须与 Query Heads 一致（64个），这意味着 KV Cache 的大小将直接<strong>翻 8 倍</strong>。</p>

























<table><thead><tr><th><strong>指标</strong></th><th><strong>Llama-3-70B (实际 GQA)</strong></th><th><strong>Llama-3-70B (假设 MHA)</strong></th></tr></thead><tbody><tr><td><strong>单 Token 显存占用</strong></td><td><strong>0.31 MB</strong></td><td><strong>2.5 MB</strong></td></tr><tr><td><strong>32k 长文 (BS=1)</strong></td><td>10 GB (轻松)</td><td><strong>80 GB</strong> (占满一张 H100)</td></tr><tr><td><strong>128k 超长文 (BS=1)</strong></td><td>40 GB (可接受)</td><td><strong>320 GB</strong> (灾难级)</td></tr></tbody></table>
<p>如果使用 MHA，仅为了处理一个 128k 的长文本请求，光是 KV Cache 就需要 <strong>4张 H100</strong>，加上权重则需要 <strong>6-8张</strong>。这将导致推理成本高到无法商业化。因此，从 MHA 向 GQA/MLA 的演进，本质上是一场<strong>为了在有限显存内塞入更长 Context 的自救运动</strong>。</p>
<h4 data-id="heading-6">三、 带宽瓶颈：不仅仅是存不下</h4>
<p>当我们被迫因为显存不足而增加 GPU 数量时（从单卡 -&gt; 多卡 -&gt; 多机），我们立刻撞上了第二道墙：<strong>通信带宽</strong>。</p>
<p>LLM 的推理过程（Decoding 阶段）是一个典型的 <strong>Memory Bound（内存受限）</strong> 任务。</p>
<ul>
<li><strong>计算核心（Tensor Core）</strong> 像是一个切菜极快的厨师（算力过剩）。</li>
<li><strong>显存（HBM）</strong> 像是冰箱。</li>
<li>每生成一个 Token，厨师都需要把冰箱里重达 <strong>140GB</strong> 的食材（权重）全部搬运一遍，切一刀，然后放回去。</li>
</ul>
<p>即便 H100 的 HBM3 带宽高达 3TB/s，搬运一次 140GB 数据也需要约 <strong>46ms</strong>。这意味着，<strong>理论上限</strong>每秒只能生成约 20 个 Token。</p>
<p>而一旦我们将模型切分到多台机器（Model Parallelism）：</p>
<ol>
<li>计算不再是瓶颈，<strong>网络</strong>成了瓶颈。</li>
<li>设备间通信带宽从 3TB/s 骤降至 50-100GB/s（Infiniband）。</li>
<li>每一次矩阵乘法（Matrix Multiplication）都需要在机器间同步数据。</li>
<li>原本 46ms 的延迟可能会变成 500ms 甚至更高，导致用户体验产生极其明显的卡顿。</li>
</ol>
<h4 data-id="heading-7">结语</h4>
<p>理解了显存的静态与动态分布，以及通信带宽的层级差异，我们就能明白当前大模型推理优化的核心逻辑：</p>
<ol>
<li><strong>量化（Quantization）</strong> ：通过 Int8/Int4 压缩静态权重，试图把 70B 模型塞进单卡或更少的卡中，避免跨设备通信。</li>
<li><strong>架构改良（GQA/MLA）</strong> ：通过减少 KV Cache 的体积，延缓动态显存的溢出，从而支持超长上下文（Long Context）。</li>
<li><strong>算子融合（Kernel Fusion）</strong> ：减少数据在 HBM 和 SRAM 之间的搬运次数，突破带宽瓶颈。</li>
</ol>
<p>在显存墙与带宽墙被彻底打破之前， <strong>“能单卡不跨卡，能单机不跨机”</strong> 将始终是 LLM 部署的最高准则。</p>
<h4 data-id="heading-8">单个 Token 的 KV Cache 显存占用计算</h4>
<p>以下是 <strong>Llama-3-70B</strong> 单个 Token 的 KV Cache 显存占用计算公式的详细推导过程。</p>
<h5 data-id="heading-9">1. 通用计算公式</h5>
<p>任何 Transformer 类模型的 KV Cache（每个 Token）显存占用公式如下：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>Mem</mtext><mtext>token</mtext></msub><mo>=</mo><mn>2</mn><mo>×</mo><msub><mi>n</mi><mtext>layers</mtext></msub><mo>×</mo><msub><mi>n</mi><mtext>kv_heads</mtext></msub><mo>×</mo><msub><mi>d</mi><mtext>head</mtext></msub><mo>×</mo><msub><mi>P</mi><mtext>bytes</mtext></msub></mrow><annotation encoding="application/x-tex">\text{Mem}_{\text{token}} = 2 \times n_{\text{layers}} \times n_{\text{kv\_heads}} \times d_{\text{head}} \times P_{\text{bytes}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord text"><span class="mord">Mem</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">token</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">layers</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.9503em;vertical-align:-0.367em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">kv_heads</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.367em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">head</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bytes</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></p>
<p><strong>参数含义拆解：</strong></p>
<ul>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span></span></span></span></span></strong> ：代表 <strong>Key</strong> 和 <strong>Value</strong> 两个矩阵（Query 不需要缓存）。</li>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mtext>layers</mtext></msub></mrow><annotation encoding="application/x-tex">n_{\text{layers}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">layers</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></strong> ：模型的总层数（Layers）。</li>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mtext>kv_heads</mtext></msub></mrow><annotation encoding="application/x-tex">n_{\text{kv\_heads}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7976em;vertical-align:-0.367em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">kv_heads</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.367em;"><span/></span></span></span></span></span></span></span></span></span></strong> ：用于存储 KV 的注意力头数量（GQA/MQA 架构下，这个数值小于 Query 头数）。</li>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mtext>head</mtext></msub></mrow><annotation encoding="application/x-tex">d_{\text{head}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">head</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></strong> ：单个注意力头的维度大小。</li>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mtext>bytes</mtext></msub></mrow><annotation encoding="application/x-tex">P_{\text{bytes}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bytes</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></strong> ：数据精度占用的字节数（FP16/BF16 通常为 2 Bytes）。</li>
</ul>
<hr/>
<h5 data-id="heading-10">2. Llama-3-70B 的具体参数代入</h5>
<p>根据 Llama-3-70B 的架构配置：</p>
<ol>
<li>
<p><strong>精度 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mtext>bytes</mtext></msub></mrow><annotation encoding="application/x-tex">P_{\text{bytes}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bytes</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>)</strong> ：通常推理使用 FP16，即 <strong>2 Bytes</strong>。</p>
</li>
<li>
<p><strong>层数 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mtext>layers</mtext></msub></mrow><annotation encoding="application/x-tex">n_{\text{layers}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">layers</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>)</strong> ：<strong>80 层</strong>。</p>
</li>
<li>
<p><strong>KV 头数 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mtext>kv_heads</mtext></msub></mrow><annotation encoding="application/x-tex">n_{\text{kv\_heads}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7976em;vertical-align:-0.367em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">kv_heads</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.367em;"><span/></span></span></span></span></span></span></span></span></span>)</strong> ：</p>
<ul>
<li>Llama-3-70B 使用了 <strong>GQA (Grouped Query Attention)</strong> 。</li>
<li>虽然它的 Query Heads 是 64，但 KV Heads 被压缩到了 <strong>8</strong>。</li>
</ul>
</li>
<li>
<p><strong>单头维度 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mtext>head</mtext></msub></mrow><annotation encoding="application/x-tex">d_{\text{head}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">head</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>)</strong> ：</p>
<ul>
<li>计算公式：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Hidden Size</mtext><mi mathvariant="normal">/</mi><mtext>Query Heads</mtext></mrow><annotation encoding="application/x-tex">\text{Hidden Size} / \text{Query Heads}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Hidden Size</span></span><span class="mord">/</span><span class="mord text"><span class="mord">Query Heads</span></span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8192</mn><mi mathvariant="normal">/</mi><mn>64</mn><mo>=</mo><mn mathvariant="bold">128</mn></mrow><annotation encoding="application/x-tex">8192 / 64 = \mathbf{128}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">8192/64</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord"><span class="mord mathbf">128</span></span></span></span></span></span>。</li>
</ul>
</li>
</ol>
<hr/>
<h5 data-id="heading-11">3. 计算步骤</h5>
<p>将上述数值代入公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mtext>Mem</mtext><mtext>token</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mn>2</mn><mo>×</mo><mn>80</mn><mo>×</mo><mn>8</mn><mo>×</mo><mn>128</mn><mo>×</mo><mn>2</mn><mtext> (Bytes)</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mn>160</mn><mo>×</mo><mn>8</mn><mo>×</mo><mn>256</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mn>1280</mn><mo>×</mo><mn>256</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mrow><mn mathvariant="bold">327</mn><mo separator="true">,</mo><mn mathvariant="bold">680</mn><mtext> Bytes</mtext></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} \text{Mem}_{\text{token}} &amp;= 2 \times 80 \times 8 \times 128 \times 2 \text{ (Bytes)} \\ &amp;= 160 \times 8 \times 256 \\ &amp;= 1280 \times 256 \\ &amp;= \mathbf{327,680 \text{ Bytes}} \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6em;vertical-align:-2.75em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em;"><span style="top:-5.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord text"><span class="mord">Mem</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">token</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"/><span class="mord"/></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"/></span><span style="top:-0.91em;"><span class="pstrut" style="height:3em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em;"><span style="top:-5.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">80</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">8</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">128</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">2</span><span class="mord text"><span class="mord"> (Bytes)</span></span></span></span><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">160</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">8</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">256</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">1280</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">256</span></span></span><span style="top:-0.91em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathbf">327</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathbf">680</span><span class="mord text"><span class="mord"> Bytes</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<h5 data-id="heading-12">4. 单位换算（Bytes <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> MB）</h5>
<p>将字节转换为兆字节（MB）：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>Mem</mtext><mtext>token (MB)</mtext></msub><mo>=</mo><mfrac><mrow><mn>327</mn><mo separator="true">,</mo><mn>680</mn></mrow><mrow><mn>1024</mn><mo>×</mo><mn>1024</mn></mrow></mfrac><mo>≈</mo><mrow><mn mathvariant="bold">0.3125</mn><mtext> MB</mtext></mrow></mrow><annotation encoding="application/x-tex">\text{Mem}_{\text{token (MB)}} = \frac{327,680}{1024 \times 1024} \approx \mathbf{0.3125 \text{ MB}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"/><span class="mord"><span class="mord text"><span class="mord">Mem</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">token (MB)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3005em;vertical-align:-0.4033em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8972em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1024</span><span class="mbin mtight">×</span><span class="mord mtight">1024</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">327</span><span class="mpunct mtight">,</span><span class="mord mtight">680</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord"><span class="mord mathbf">0.3125</span><span class="mord text"><span class="mord"> MB</span></span></span></span></span></span></span></p>
<p>这就是文中提到的 <strong>0.31 MB</strong> 的由来。</p>
<hr/>
<h5 data-id="heading-13">补充：如果是 MHA 会怎样？</h5>
<p>如果取消 GQA，改回传统的 MHA，则 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mtext>kv_heads</mtext></msub></mrow><annotation encoding="application/x-tex">n_{\text{kv\_heads}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7976em;vertical-align:-0.367em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">kv_heads</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.367em;"><span/></span></span></span></span></span></span></span></span></span> 会从 8 变成 64。</p>
<p>计算结果直接乘以 8：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.3125</mn><mtext> MB</mtext><mo>×</mo><mn>8</mn><mo>=</mo><mrow><mn mathvariant="bold">2.5</mn><mtext> MB</mtext></mrow></mrow><annotation encoding="application/x-tex">0.3125 \text{ MB} \times 8 = \mathbf{2.5 \text{ MB}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord">0.3125</span><span class="mord text"><span class="mord"> MB</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord"><span class="mord mathbf">2.5</span><span class="mord text"><span class="mord"> MB</span></span></span></span></span></span></span></p>
<p>这就是为什么 GQA 对于显存优化如此重要的数学证明。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[玩转 Pipelines 之修正链路错误状态码]]></title>    <link>https://juejin.cn/post/7576853741757743138</link>    <guid>https://juejin.cn/post/7576853741757743138</guid>    <pubDate>2025-11-26T11:17:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576853741757743138" data-draft-id="7576859594359504896" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="玩转 Pipelines 之修正链路错误状态码"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T11:17:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            玩转 Pipelines 之修正链路错误状态码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T11:17:17.000Z" title="Wed Nov 26 2025 11:17:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Pipelines 是一种运行在 DataKit 上的轻量级脚本语言，用于对采集到的数据进行自定义解析和修改。通过定义解析规则，它们能够将不同种类的数据细粒度地切割并转换为结构化的格式，以满足具体的数据管理需求。例如，用户可以通过 Pipelines 提取日志中的时间戳、状态和其他关键字段，并将这些信息作为标签使用。</p>
<p>DataKit 利用 Pipelines 的强大功能，使得用户能够在工作空间页面上直接编写和调试 Pipeline 脚本，从而实现对数据的更细粒度的结构化处理。这种处理不仅提高了数据的可管理性，而且通过 Pipeline 提供的丰富函数库，支持对常见数据进行标准化操作，如解析时间字符串和补全 IP 地址的地理信息等。</p>
<h2 data-id="heading-0">场景分析</h2>
<p>用户在上报应用性能监测数据的时候，如果在业务侧做了一些自定义状态码，比如自定义 4xx，但这种在业务上属于正常的心跳监控，不需要在观测云上归类为错误请求。这时候怎么在观测云上进行修正状态码，从而减少错误分析，以及误告警。</p>
<h2 data-id="heading-1">实施方案</h2>
<p>如下链路原文带有 <code>status=error</code> 的标签，实际用户在 "error_type"="com.xxx.cloud.os.service.exceptions.OsServiceException" 的错误类型下，都属于正常的业务请求，需要从源头把这类型的报错修正为正常的状态。</p>
<pre><code class="hljs language-python" lang="python">{
  <span class="hljs-string">"time"</span>: <span class="hljs-number">1761533611771</span>,
  <span class="hljs-string">"__docid"</span>: <span class="hljs-string">"T_1761533611771_d3vdtb2c600s73e27rpg"</span>,
  <span class="hljs-string">"__namespace"</span>: <span class="hljs-string">"tracing"</span>,
  <span class="hljs-string">"__source"</span>: <span class="hljs-string">"user-xxx-eks"</span>,
  <span class="hljs-string">"cluster_name_k8s"</span>: <span class="hljs-string">"eks-prod"</span>,
  <span class="hljs-string">"create_time"</span>: <span class="hljs-number">1761533612872</span>,
  <span class="hljs-string">"date"</span>: <span class="hljs-number">1761533611771</span>,
  <span class="hljs-string">"date_ns"</span>: <span class="hljs-number">1761533611771449300</span>,
  <span class="hljs-string">"dd_version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-string">"dk_fingerprint"</span>: <span class="hljs-string">"ip-xxx-16-xx-229.us-west-2.xxx.internal"</span>,
  <span class="hljs-string">"duration"</span>: <span class="hljs-number">19712</span>,
  <span class="hljs-string">"env"</span>: <span class="hljs-string">"prod"</span>,
  <span class="hljs-string">"host"</span>: <span class="hljs-string">"ip-172xxx-220.us-west-2.xxx.internal"</span>,
  <span class="hljs-string">"host_ip"</span>: <span class="hljs-string">"172.16.12.xxx"</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"{"</span>service<span class="hljs-string">":"</span>user-xxx-eks<span class="hljs-string">","</span>name<span class="hljs-string">":"</span>spring.handle<span class="hljs-string">r","</span>resource<span class="hljs-string">":"</span>PointRightPublicController.listGiftCardRight<span class="hljs-string">","</span>start<span class="hljs-string">":1761533611771449259,"</span>duration<span class="hljs-string">":19712571,"</span>erro<span class="hljs-string">r":0,"</span>meta<span class="hljs-string">":{"</span>_dd.p.tid<span class="hljs-string">":"</span>68fedeab00000000<span class="hljs-string">","</span>thread.name<span class="hljs-string">":"</span>http-nio-<span class="hljs-number">9602</span>-<span class="hljs-built_in">exec</span>-<span class="hljs-number">11</span><span class="hljs-string">","</span>language<span class="hljs-string">":"</span>jvm<span class="hljs-string">","</span>trace_128_bit_id<span class="hljs-string">":"</span>68fedeab000000003d47a83b00ad5ef0<span class="hljs-string">","</span>component<span class="hljs-string">":"</span>spring-web-controlle<span class="hljs-string">r"},"</span>metrics<span class="hljs-string">":{"</span>_dd.measured<span class="hljs-string">":1,"</span>thread.<span class="hljs-built_in">id</span><span class="hljs-string">":207},"</span><span class="hljs-built_in">type</span><span class="hljs-string">":"</span>we<span class="hljs-string">b"}"</span>,
  <span class="hljs-string">"operation"</span>: <span class="hljs-string">"spring.handler"</span>,
  <span class="hljs-string">"parent_id"</span>: <span class="hljs-string">"6497552948601585817"</span>,
  <span class="hljs-string">"pod_name"</span>: <span class="hljs-string">"user-service-xxx-xxx"</span>,
  <span class="hljs-string">"pod_namespace"</span>: <span class="hljs-string">"xxx-prod"</span>,
  <span class="hljs-string">"region"</span>: <span class="hljs-string">"us-xxx-2"</span>,
  <span class="hljs-string">"remote_ip"</span>: <span class="hljs-string">"172.16.xx.xxx"</span>,
  <span class="hljs-string">"resource"</span>: <span class="hljs-string">"PointRightPublicController.listGiftCardRight"</span>,
  <span class="hljs-string">"service"</span>: <span class="hljs-string">"user-xxx-eks"</span>,
  <span class="hljs-string">"source"</span>: <span class="hljs-string">"ddtrace"</span>,
  <span class="hljs-string">"source_type"</span>: <span class="hljs-string">"web"</span>,
  <span class="hljs-string">"span_id"</span>: <span class="hljs-string">"744311550763894067"</span>,
  <span class="hljs-string">"span_kind"</span>: <span class="hljs-string">"server"</span>,
  <span class="hljs-string">"span_type"</span>: <span class="hljs-string">"local"</span>,
  <span class="hljs-string">"start"</span>: <span class="hljs-number">1761533611771449</span>,
  <span class="hljs-string">"status"</span>: <span class="hljs-string">"error"</span>,
  <span class="hljs-string">"time_us"</span>: <span class="hljs-number">1761533611771449.2</span>,
  <span class="hljs-string">"trace_id"</span>: <span class="hljs-string">"68fedeab000000003d47a83b00ad5ef0"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-string">"zone_id"</span>: <span class="hljs-string">"usw2-xxx"</span>,
  <span class="hljs-string">"error_type"</span>: <span class="hljs-string">"com.xxx.cloud.os.service.exceptions.OsServiceException"</span>
}
</code></pre>
<p>新建 Pipelines</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee694a50582a487ea1bf843c1169065f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764760636&amp;x-signature=ruSNi6hq4wFxOiOH%2BQi%2FitS0Y0w%3D" alt="" loading="lazy"/></p>
<p>选择应用性能监控--&gt;服务选择--&gt;一键获取样本</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdfd62261cbb485788b973235f738e6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764760636&amp;x-signature=Yh4I3kTexc%2BqkElBNCz9Ck%2BwuDQ%3D" alt="" loading="lazy"/></p>
<p>判断如果是 error_type 等于com.xxxxx.cloud.os.service.exceptions.OsServiceException 则为业务自定义错误，这个可以归类为正常请求，无需到错误追踪，把 status 修正为 ok 即可</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/006e5de3287243d0aa57d13ad3807eac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764760636&amp;x-signature=u9RbYbaCbZHBdfTorEhJ4vuBJeo%3D" alt="" loading="lazy"/></p>
<p>完整的 Pipelines 规则</p>
<pre><code class="hljs language-lua" lang="lua"># <span class="hljs-number">1.</span> 提取 JSON 原始数据中的 <span class="hljs-string">"status"</span> 字段（原文为 JSON，用 _ 表示原始输入）
# 语法：json(输入源, JSON路径, 提取后字段名)，此处字段名与路径一致（均为 <span class="hljs-built_in">status</span>）
json(_, <span class="hljs-built_in">status</span>, <span class="hljs-built_in">status</span>)

# <span class="hljs-number">2.</span> 判断 <span class="hljs-built_in">status</span> 字段是否等于 <span class="hljs-string">"ok"</span>（字符串比较需带双引号）
<span class="hljs-keyword">if</span> <span class="hljs-built_in">status</span> == <span class="hljs-string">"error"</span> {
    # 满足条件时，添加新字段 kind，值为 <span class="hljs-number">1</span>（整数类型）
  json(_, error_type, error_type)
  <span class="hljs-keyword">if</span> error_type == <span class="hljs-string">"com.xxxxx.cloud.os.service.exceptions.OsServiceException"</span> {
  #set_tag(<span class="hljs-built_in">status</span>,<span class="hljs-string">"ok"</span>)
  add_key(<span class="hljs-built_in">status</span>,<span class="hljs-string">"ok"</span>)
  }

}
</code></pre>
<p>处理结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2083dc61a7d4523b981d76560f8e46f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764760636&amp;x-signature=8nVoZqNusFtUNYjRW3nfFhtTpMs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58afdf4a18df4683b3f3e8996623903a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764760636&amp;x-signature=ET0ZODm13HkNohAMPzjSlpIV2D0%3D" alt="" loading="lazy"/></p>
<p>如上演示可看到，误报到错误追踪的链路， 已经修正处理完成，正常在链路列表展示了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++26：开启新纪元]]></title>    <link>https://juejin.cn/post/7576859594359521280</link>    <guid>https://juejin.cn/post/7576859594359521280</guid>    <pubDate>2025-11-26T11:17:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576859594359521280" data-draft-id="7576676694784720930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++26：开启新纪元"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T11:17:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++26：开启新纪元
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T11:17:53.000Z" title="Wed Nov 26 2025 11:17:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>对于C++开发者而言，语言的进化从未停止。C++26，作为C++23之后的下一代标准，并非一次简单的修补，而是一次旨在重塑我们编写高性能、高维护性代码方式的雄心勃勃的尝试。它将并发编程、编译时计算和类型安全提升到了前所未有的高度，这足以颠覆我们长期以来形成的某些编程习惯和认知。</p>
<h4 data-id="heading-0"><strong>一、 并发编程的范式转移：从“手工管理”到“声明式执行”</strong></h4>
<p>传统的C++并发编程依赖于直接操作 <code>std::thread</code>、<code>std::async</code> 和 <code>std::mutex</code>。这种方式强大但繁琐，且极易出错。C++26 引入的 <code>std::execution</code> 旨在将并发编程带入声明式的新时代。</p>
<p><strong>旧认知：</strong> 我必须手动创建线程池，管理任务队列，并小心翼翼地处理线程同步。
<strong>新认知：</strong> 我只需声明任务的<strong>执行策略</strong>，运行时库会自动以最优方式调度和执行。</p>
<p><strong>代码示例：并行排序算法的演变</strong></p>
<p>假设我们有一个需要并行排序的大向量。</p>
<ul>
<li>
<p><strong>C++17/20 方式（基于 <code>std::async</code>）：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp">std::vector&lt;<span class="hljs-type">int</span>&gt; data = { ... }; <span class="hljs-comment">// 大量数据</span>
<span class="hljs-comment">// 手动分块并异步排序，再合并，代码复杂且容易出错</span>
<span class="hljs-keyword">auto</span> future = std::<span class="hljs-built_in">async</span>(std::launch::async, [&amp;data] {
    std::<span class="hljs-built_in">sort</span>(data.<span class="hljs-built_in">begin</span>(), data.<span class="hljs-built_in">end</span>());
});
future.<span class="hljs-built_in">wait</span>();
</code></pre>
</li>
<li>
<p><strong>C++26 方式（基于 <code>std::execution</code>）：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;execution&gt;</span></span>
std::vector&lt;<span class="hljs-type">int</span>&gt; data = { ... }; <span class="hljs-comment">// 大量数据</span>

<span class="hljs-comment">// 声明式并行：只需指定执行策略</span>
std::<span class="hljs-built_in">sort</span>(std::execution::par, data.<span class="hljs-built_in">begin</span>(), data.<span class="hljs-built_in">end</span>());
</code></pre>
<p><strong>颠覆性解读：</strong>
<code>std::execution::par</code> 只是一个策略。你还可以使用 <code>std::execution::par_unseq</code> 来允许向量化（与SIMD结合），或者 <code>std::execution::seq</code> 表示顺序执行。<strong>代码的核心逻辑（<code>std::sort</code>）与并发策略解耦了</strong>。这意味着我们不再关心线程是如何创建的，而是关心任务<strong>应该以何种属性</strong>被执行。这种抽象是革命性的，它让并行算法像串行算法一样易于使用。</p>
</li>
</ul>
<h4 data-id="heading-1"><strong>二、 SIMD的平民化：从内联汇编到标准库泛型</strong></h4>
<p>SIMD（单指令多数据）是性能优化的“圣杯”，但过去通常需要通过编译器内置函数（Intrinsics）或内联汇编来使用，代码既丑陋又不可移植。</p>
<p><strong>旧认知：</strong> 要想极致性能，必须深入硬件特定指令，牺牲代码可读性和可移植性。
<strong>新认知：</strong> 我可以编写可移植的、泛型的C++代码，并由标准库在底层自动映射为最优的SIMD指令。</p>
<p><strong>代码示例：数组元素乘法的性能飞跃</strong></p>
<ul>
<li>
<p><strong>传统方式：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">multiply_arrays</span><span class="hljs-params">(<span class="hljs-type">float</span>* a, <span class="hljs-type">float</span>* b, <span class="hljs-type">float</span>* result, <span class="hljs-type">size_t</span> n)</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; n; ++i) {
        result[i] = a[i] * b[i];
    }
}
<span class="hljs-comment">// 编译器可能自动向量化，但对于复杂逻辑，往往需要手动提示或使用Intrinsics。</span>
</code></pre>
</li>
<li>
<p><strong>C++26 SIMD 方式（基于提案 <code>std::simd</code>）：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;experimental/simd&gt;</span> <span class="hljs-comment">// 预计在C++26中进入std::</span></span>
<span class="hljs-keyword">namespace</span> stdx = std::experimental;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">multiply_arrays</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">float</span>* a, <span class="hljs-type">const</span> <span class="hljs-type">float</span>* b, <span class="hljs-type">float</span>* result, <span class="hljs-type">size_t</span> n)</span> </span>{
    <span class="hljs-keyword">using</span> V = stdx::native_simd&lt;<span class="hljs-type">float</span>&gt;; <span class="hljs-comment">// 自动选择当前平台最合适的向量宽度</span>
    <span class="hljs-type">size_t</span> vec_size = V::<span class="hljs-built_in">size</span>();
    
    <span class="hljs-comment">// 处理完整向量部分</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i + vec_size &lt;= n; i += vec_size) {
        <span class="hljs-function">V <span class="hljs-title">va</span><span class="hljs-params">(a + i, stdx::vector_aligned)</span></span>;
        <span class="hljs-function">V <span class="hljs-title">vb</span><span class="hljs-params">(b + i, stdx::vector_aligned)</span></span>;
        V vresult = va * vb; <span class="hljs-comment">// 运算符重载，直观的逐元素乘法</span>
        vresult.<span class="hljs-built_in">copy_to</span>(result + i, stdx::vector_aligned);
    }
    <span class="hljs-comment">// ... 处理尾部剩余元素</span>
}
</code></pre>
<p><strong>颠覆性解读：</strong>
这段代码是<strong>平台无关的</strong>。<code>stdx::native_simd&lt;float&gt;</code> 在x86 AVX2平台上可能是8个float，在ARM NEON上可能是4个，但代码无需修改。我们使用熟悉的C++运算符（<code>*</code>）来操作整个向量，而不是繁琐的 <code>_mm256_load_ps</code> 和 <code>_mm256_mul_ps</code>。这极大地降低了使用SIMD的门槛，使得数据并行编程成为广大C++开发者的常规武器，而不仅仅是少数专家的秘技。</p>
</li>
</ul>
<h4 data-id="heading-2"><strong>三、 编译时世界的边界扩张：<code>constexpr</code> 的进一步胜利</strong></h4>
<p>C++的 <code>constexpr</code> 一直在将运行时计算推向编译时。C++26继续这一趋势，允许在 <code>constexpr</code> 上下文中进行更多操作。</p>
<p><strong>旧认知：</strong> 编译时计算主要用于简单的数学运算和类型体操。
<strong>新认知：</strong> 更复杂的算法、甚至部分标准库容器和算法都可以在编译期执行，实现“零成本抽象”的终极形态。</p>
<p><strong>代码示例：编译时生成查找表</strong></p>
<ul>
<li><strong>传统方式：</strong> 在运行时初始化一个查找表，或使用模板元编程但代码极其复杂。</li>
<li><strong>C++26 方式：</strong>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-keyword">constexpr</span> std::array&lt;<span class="hljs-type">int</span>, 256&gt; <span class="hljs-title">generate_sine_lookup_table</span><span class="hljs-params">()</span> </span>{
    std::array&lt;<span class="hljs-type">int</span>, 256&gt; table{};
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; table.<span class="hljs-built_in">size</span>(); ++i) {
        <span class="hljs-type">double</span> angle = <span class="hljs-number">2</span> * <span class="hljs-number">3.1415926535</span> * i / table.<span class="hljs-built_in">size</span>();
        table[i] = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(std::<span class="hljs-built_in">sin</span>(angle) * <span class="hljs-number">1024</span>); <span class="hljs-comment">// 定点数</span>
    }
    <span class="hljs-keyword">return</span> table;
}

<span class="hljs-comment">// 此表在编译期就已计算并嵌入二进制代码，运行时零开销！</span>
<span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> SIN_LUT = <span class="hljs-built_in">generate_sine_lookup_table</span>();

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">fast_sine_approximation</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> value = SIN_LUT[<span class="hljs-number">128</span>]; <span class="hljs-comment">// 直接访问，无计算成本</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<strong>颠覆性解读：</strong>
注意，<code>std::array</code> 的析构和 <code>std::sin</code> 等函数现在都可能成为 <code>constexpr</code>。这意味着我们可以在编译期模拟几乎完整的运行时环境，将那些确定性的、耗时的初始化工作彻底从运行时剥离。这对于嵌入式系统、游戏引擎和高性能计算至关重要，它改变了我们在“开发时”和“运行时”之间分配计算负载的思维模式。</li>
</ul>
<h4 data-id="heading-3"><strong>四、 内存安全与并发安全的新工具</strong></h4>
<p>虽然C++不会变成Rust，但C++26通过库组件积极应对多线程环境下的内存安全问题。</p>
<p><strong>旧认知：</strong> 无锁编程是深渊，手动管理多线程下的对象生命周期极易导致use-after-free。
<strong>新认知：</strong> 标准库提供了如风险指针和RCU等高级范式，可以安全且高效地管理并发对象生命周期。</p>
<p><strong>代码示例：使用风险指针进行安全读取</strong></p>
<p>（此处为概念性代码，基于提案 <code>std::hazard_pointer</code>）</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 概念性代码，展示思想</span>
std::atomic&lt;MyObject*&gt; global_obj{<span class="hljs-literal">nullptr</span>};
std::hazard_pointer_domain hp_domain;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">reader</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 获取一个风险指针，并将其与当前线程关联</span>
    <span class="hljs-keyword">auto</span> hp = hp_domain.<span class="hljs-built_in">acquire</span>();
    
    MyObject* obj = <span class="hljs-literal">nullptr</span>;
    <span class="hljs-keyword">do</span> {
        <span class="hljs-comment">// 2. 安全地加载原子指针</span>
        obj = global_obj.<span class="hljs-built_in">load</span>(std::memory_order_acquire);
        <span class="hljs-comment">// 3. 将加载的指针“保护”起来，告知系统我正在使用它</span>
        hp.<span class="hljs-built_in">protect</span>(obj);
        <span class="hljs-comment">// 4. 再次检查指针是否已被其他写者修改</span>
        <span class="hljs-comment">// 如果没有，则说明我们成功保护了obj，可以安全使用</span>
    } <span class="hljs-keyword">while</span> (obj != global_obj.<span class="hljs-built_in">load</span>(std::memory_order_acquire));
    
    <span class="hljs-comment">// 5. 安全地使用obj，此时即使有写者删除了旧对象，也不会回收它</span>
    obj-&gt;<span class="hljs-built_in">do_something</span>();
    
    <span class="hljs-comment">// 6. 释放风险指针</span>
    hp.<span class="hljs-built_in">release</span>();
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">writer</span><span class="hljs-params">()</span> </span>{
    MyObject* new_obj = <span class="hljs-keyword">new</span> <span class="hljs-built_in">MyObject</span>(...);
    MyObject* old_obj = global_obj.<span class="hljs-built_in">exchange</span>(new_obj, std::memory_order_acq_rel);
    
    <span class="hljs-comment">// 尝试回收旧对象。如果旧对象正被任何风险指针保护，则延迟回收</span>
    hp_domain.<span class="hljs-built_in">retire</span>(old_obj, [](MyObject* ptr) { <span class="hljs-keyword">delete</span> ptr; });
}
</code></pre>
<p><strong>颠覆性解读：</strong>
风险指针和RCU等机制，将我们从繁琐且容易出错的“手动引用计数”或“完全无锁”中解放出来。它们提供了一种<strong>协作式</strong>的内存回收协议，读者通过风险指针宣告“我正在使用此对象”，写者则负责在确认无人使用时再进行回收。这为构建高性能、无锁的并发数据结构提供了标准化、更安全的基础。</p>
<h4 data-id="heading-4"><strong>总结：认知的颠覆与演进</strong></h4>
<p>C++26 的变革是深层次的：</p>
<ol>
<li><strong>并发抽象化：</strong> 我们从关心线程（<code>std::thread</code>）转向关心任务和策略（<code>std::execution</code>）。</li>
<li><strong>数据并行平民化：</strong> SIMD从硬件特定技巧变成了可移植的泛型编程工具。</li>
<li><strong>编译时计算常态化：</strong> 编译期与运行时的界限进一步模糊，我们可以将更多工作静态化。</li>
<li><strong>内存安全系统化：</strong> 标准库开始提供高级构件，来系统性地解决并发环境下的内存管理难题。</li>
</ol>
<p>这些变化要求我们不断更新自己的知识库和思维方式。C++26 不是在原有路径上小修小补，而是在为我们铺就一条通往更高性能、更高生产力和更高代码质量的新道路。它提醒我们，C++的哲学依然是“信任程序员，但不给程序员不必要的负担”，而如今，它正通过更强大的抽象来兑现这一承诺。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++程序执行起点不是main：颠覆你认知的真相]]></title>    <link>https://juejin.cn/post/7576861477266620435</link>    <guid>https://juejin.cn/post/7576861477266620435</guid>    <pubDate>2025-11-26T11:24:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576861477266620435" data-draft-id="7576838552472092715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++程序执行起点不是main：颠覆你认知的真相"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T11:24:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++程序执行起点不是main：颠覆你认知的真相
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T11:24:08.000Z" title="Wed Nov 26 2025 11:24:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>你以为main函数是起点？C++的运行机制远比这复杂！</p>
</blockquote>
<p>在C++学习之路上，我们都被教导过一个“基本事实”：程序从main函数开始执行。但今天，我要带你揭开这个广为流传的误解背后的真相。</p>
<h2 data-id="heading-0">一个令人惊讶的实验</h2>
<p>让我们通过一个简单例子来观察C++程序的实际启动过程：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LifecycleTracker</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">LifecycleTracker</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name) : <span class="hljs-built_in">name</span>(name) {
        cout &lt;&lt; <span class="hljs-string">"【构造】"</span> &lt;&lt; name &lt;&lt; <span class="hljs-string">" - 此时main尚未开始"</span> &lt;&lt; endl;
    }
    
    ~<span class="hljs-built_in">LifecycleTracker</span>() {
        cout &lt;&lt; <span class="hljs-string">"【析构】"</span> &lt;&lt; name &lt;&lt; <span class="hljs-string">" - 此时main已经结束"</span> &lt;&lt; endl;
    }

<span class="hljs-keyword">private</span>:
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name;
};

<span class="hljs-comment">// 全局对象</span>
<span class="hljs-function">LifecycleTracker <span class="hljs-title">global_obj</span><span class="hljs-params">(<span class="hljs-string">"全局对象"</span>)</span></span>;

<span class="hljs-comment">// 全局变量初始化</span>
<span class="hljs-type">int</span> global_var = []() {
    cout &lt;&lt; <span class="hljs-string">"【初始化】全局变量 - 在main之前"</span> &lt;&lt; endl;
    <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>;
}();

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    cout &lt;&lt; <span class="hljs-string">"【进入】main函数开始执行"</span> &lt;&lt; endl;
    <span class="hljs-function">LifecycleTracker <span class="hljs-title">local_obj</span><span class="hljs-params">(<span class="hljs-string">"局部对象"</span>)</span></span>;
    cout &lt;&lt; <span class="hljs-string">"【退出】main函数即将结束"</span> &lt;&lt; endl;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>运行这个程序，你会看到类似这样的输出：</p>
<pre><code class="hljs language-css" lang="css">【初始化】全局变量 - 在<span class="hljs-selector-tag">main</span>之前
【构造】全局对象 - 此时<span class="hljs-selector-tag">main</span>尚未开始
【进入】<span class="hljs-selector-tag">main</span>函数开始执行
【构造】局部对象 - 在<span class="hljs-selector-tag">main</span>内部
【退出】<span class="hljs-selector-tag">main</span>函数即将结束
【析构】局部对象 - 在<span class="hljs-selector-tag">main</span>之后
【析构】全局对象 - 此时<span class="hljs-selector-tag">main</span>已经结束
</code></pre>
<p>看到证据了吗？在main函数登场前，C++运行时已经做了大量准备工作！</p>
<h2 data-id="heading-1">C++程序的真实启动流程</h2>
<h3 data-id="heading-2">第一阶段：操作系统准备</h3>
<p>当你运行程序时，操作系统首先接管控制权：</p>
<ol>
<li><strong>加载可执行文件</strong>到内存</li>
<li><strong>创建进程和线程</strong>结构</li>
<li><strong>分配内存空间</strong>（栈、堆等）</li>
<li><strong>加载依赖库</strong>（动态链接库）</li>
<li><strong>传递环境变量和命令行参数</strong></li>
</ol>
<p>这就像电影开拍前，制片方要准备好场地、设备和人员。</p>
<h3 data-id="heading-3">第二阶段：C++运行时初始化</h3>
<p>操作系统完成基础准备后，将控制权交给C++运行时环境。这个阶段包括：</p>
<ul>
<li>初始化C标准库</li>
<li>设置堆内存管理器</li>
<li>准备I/O系统</li>
<li><strong>初始化全局和静态变量</strong></li>
<li><strong>调用全局对象的构造函数</strong></li>
<li>整理命令行参数</li>
</ul>
<p>只有在所有这些准备工作完成后，运行时环境才会调用我们熟悉的main函数。</p>
<h3 data-id="heading-4">第三阶段：main函数执行</h3>
<p>现在才轮到我们的“主角”登场：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 你的代码在这里执行</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">// 或者带参数版本</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>* argv[])</span> </span>{
    <span class="hljs-comment">// 使用命令行参数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>重要的是理解：<strong>main函数是被C++运行时调用的</strong>，而不是程序的真正起点。</p>
<h3 data-id="heading-5">第四阶段：程序收尾工作</h3>
<p>main函数返回后，程序的生命周期还未结束：</p>
<ol>
<li>接收main的返回值</li>
<li><strong>调用全局对象的析构函数</strong></li>
<li>清理资源</li>
<li>向操作系统返回退出码</li>
<li>结束进程</li>
</ol>
<h2 data-id="heading-6">深入理解初始化顺序问题</h2>
<p>理解C++启动机制对解决实际问题至关重要，特别是在处理全局对象时。</p>
<h3 data-id="heading-7">单文件内的初始化顺序</h3>
<p>在同一个源文件中，初始化顺序是确定的：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-type">int</span> a = []() {
    cout &lt;&lt; <span class="hljs-string">"初始化a"</span> &lt;&lt; endl;
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}();

<span class="hljs-type">int</span> b = []() {
    cout &lt;&lt; <span class="hljs-string">"初始化b，a="</span> &lt;&lt; a &lt;&lt; endl;  <span class="hljs-comment">// a已初始化</span>
    <span class="hljs-keyword">return</span> a + <span class="hljs-number">1</span>;
}();

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">MyClass</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name) {
        cout &lt;&lt; <span class="hljs-string">"构造"</span> &lt;&lt; name &lt;&lt; <span class="hljs-string">"，b="</span> &lt;&lt; b &lt;&lt; endl;
    }
};

<span class="hljs-function">MyClass <span class="hljs-title">obj1</span><span class="hljs-params">(<span class="hljs-string">"对象1"</span>)</span></span>;  <span class="hljs-comment">// b已初始化</span>
<span class="hljs-function">MyClass <span class="hljs-title">obj2</span><span class="hljs-params">(<span class="hljs-string">"对象2"</span>)</span></span>;  <span class="hljs-comment">// 按顺序构造</span>
</code></pre>
<p>输出将是可预测的：</p>
<pre><code class="hljs language-ini" lang="ini">初始化a
初始化b，<span class="hljs-attr">a</span>=<span class="hljs-number">1</span>
构造对象1，<span class="hljs-attr">b</span>=<span class="hljs-number">2</span>
构造对象2，<span class="hljs-attr">b</span>=<span class="hljs-number">2</span>
</code></pre>
<h3 data-id="heading-8">多文件间的初始化陷阱</h3>
<p>问题出现在多个源文件之间：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// file1.cpp</span>
<span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> external_var;  <span class="hljs-comment">// 在file2.cpp中定义</span>
<span class="hljs-type">int</span> my_var = external_var + <span class="hljs-number">10</span>;  <span class="hljs-comment">// 危险！external_var可能未初始化</span>

<span class="hljs-comment">// file2.cpp</span>
<span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> my_var;  <span class="hljs-comment">// 在file1.cpp中定义  </span>
<span class="hljs-type">int</span> external_var = my_var * <span class="hljs-number">2</span>;  <span class="hljs-comment">// 同样危险！</span>
</code></pre>
<p>这种<strong>静态初始化顺序问题</strong>是C++中经典的陷阱之一。</p>
<h3 data-id="heading-9">解决方案：延迟初始化</h3>
<p>使用函数内的静态变量可以优雅地解决这个问题：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 安全的全局变量访问</span>
<span class="hljs-function"><span class="hljs-type">int</span>&amp; <span class="hljs-title">getConfig</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">static</span> <span class="hljs-type">int</span> config = <span class="hljs-built_in">initializeConfig</span>();  <span class="hljs-comment">// 首次调用时初始化</span>
    <span class="hljs-keyword">return</span> config;
}

<span class="hljs-comment">// 单例模式确保初始化顺序</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Database</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">static</span> Database&amp; <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">static</span> Database instance;  <span class="hljs-comment">// 线程安全的延迟初始化</span>
        <span class="hljs-keyword">return</span> instance;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">connect</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 数据库连接操作</span>
    }
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-built_in">Database</span>() {
        <span class="hljs-comment">// 构造函数</span>
    }
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">businessLogic</span><span class="hljs-params">()</span> </span>{
    Database::<span class="hljs-built_in">getInstance</span>().<span class="hljs-built_in">connect</span>();  <span class="hljs-comment">// 首次使用时自动初始化</span>
}
</code></pre>
<h2 data-id="heading-10">实际应用价值</h2>
<p>理解C++启动过程不仅仅是理论知识，它在实际开发中极其有用：</p>
<h3 data-id="heading-11">1. 调试复杂问题</h3>
<p>当遇到程序启动时崩溃，但main函数中找不到原因时，问题可能出在全局对象的构造函数中。</p>
<h3 data-id="heading-12">2. 资源管理</h3>
<p>知道析构函数的调用时机，可以帮助我们正确管理资源生命周期。</p>
<h3 data-id="heading-13">3. 架构设计</h3>
<p>在设计库框架时，经常需要在main执行前后自动执行初始化/清理代码：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LibraryInitializer</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">LibraryInitializer</span>() {
        <span class="hljs-comment">// 库的自动初始化</span>
        <span class="hljs-built_in">initializeLibrary</span>();
    }
    
    ~<span class="hljs-built_in">LibraryInitializer</span>() {
        <span class="hljs-comment">// 库的自动清理</span>
        <span class="hljs-built_in">cleanupLibrary</span>();
    }
};

<span class="hljs-comment">// 全局实例确保自动初始化</span>
LibraryInitializer library_init;
</code></pre>
<h3 data-id="heading-14">4. 性能优化</h3>
<p>避免在全局对象构造函数中进行复杂计算，这会拖慢程序启动速度。</p>
<h2 data-id="heading-15">高级技巧：控制启动过程</h2>
<h3 data-id="heading-16">在main之前执行代码</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 方法1：全局对象构造函数</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StartupManager</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">StartupManager</span>() {
        <span class="hljs-built_in">setupLogging</span>();
        <span class="hljs-built_in">loadConfiguration</span>();
    }
};
StartupManager startup;  <span class="hljs-comment">// 在main前自动初始化</span>

<span class="hljs-comment">// 方法2：编译器特定属性（GCC/Clang）</span>
__attribute__((constructor))
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">before_main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 在main之前执行</span>
}
</code></pre>
<h3 data-id="heading-17">在main之后执行代码</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span>

<span class="hljs-comment">// 方法1：atexit函数</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">cleanup</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 清理工作</span>
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">atexit</span>(cleanup);  <span class="hljs-comment">// 注册退出时执行的函数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">// 方法2：全局对象析构函数</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ShutdownManager</span> {
<span class="hljs-keyword">public</span>:
    ~<span class="hljs-built_in">ShutdownManager</span>() {
        <span class="hljs-built_in">saveState</span>();
        <span class="hljs-built_in">closeConnections</span>();
    }
};
ShutdownManager shutdown;  <span class="hljs-comment">// 在main后自动清理</span>
</code></pre>
<h2 data-id="heading-18">总结</h2>
<p>现在你应该明白了：</p>
<ul>
<li><strong>main函数不是起点</strong>：它是被C++运行时调用的</li>
<li><strong>全局对象在main之前构造</strong>：这是初始化顺序问题的根源</li>
<li><strong>程序在main之后继续运行</strong>：完成清理工作后才真正结束</li>
<li><strong>理解这些机制至关重要</strong>：对调试、设计和性能优化都有帮助</li>
</ul>
<p>C++程序的完整生命周期更像是一部精心编排的戏剧：main函数是主角的登场，但前后都有重要的序幕和尾声。</p>
<p>下次有人问你"C++程序从哪里开始"，你可以自信地给出完整答案了！这不仅会让你在技术讨论中脱颖而出，更能帮助你写出更健壮、可靠的C++代码。</p>
<p>记住，真正的高手不仅知道怎么用语言特性，更理解它们背后的运行机制。这正是区分普通程序员和专家的关键所在！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Qoder CLI 与 OneCode 平台深度整合技术实践：CLI委托驱动的开发范式革新]]></title>    <link>https://juejin.cn/post/7576838552472125483</link>    <guid>https://juejin.cn/post/7576838552472125483</guid>    <pubDate>2025-11-26T11:26:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576838552472125483" data-draft-id="7576861477266636819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Qoder CLI 与 OneCode 平台深度整合技术实践：CLI委托驱动的开发范式革新"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T11:26:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Qoder CLI 与 OneCode 平台深度整合技术实践：CLI委托驱动的开发范式革新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T11:26:57.000Z" title="Wed Nov 26 2025 11:26:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在人工智能辅助编程技术迅猛发展的当下，开发者对智能化编码平台的依赖程度持续加深。Qoder CLI作为一款先进的AI驱动型终端编码工具，不仅具备强大的命令行编码能力，更通过创新的委托模式与OneCode平台实现深度协同，推动OneCode开发范式产生根本性变革。本文聚焦CLI委托模式的核心价值，结合OneCode可视化IDE的最新特性，系统阐述二者整合的技术路径与实践价值。</p>
<p>一、核心概念解析</p>
<p>1.1 什么是Qoder CLI？</p>
<p>Qoder CLI是基于人工智能技术构建的终端编码工具，支持开发者在命令行环境中完成复杂编码任务，无需脱离终端即可实现代码生成、重构及工作流自动化。其核心特性以“委托能力”为核心构建：</p>
<ul>
<li>
<p>智能任务委托：接收自然语言指令后，能够自动完成任务拆解与执行方案生成，支持复杂需求的端到端落地</p>
</li>
<li>
<p>项目感知能力：深度解析OneCode项目结构、依赖关系及编码规范，确保生成内容与平台的兼容性</p>
</li>
<li>
<p>MCP协议扩展：通过模型控制协议（Model Control Protocol）与OneCode平台建立稳定通信链路，实现指令与数据的双向流转</p>
</li>
<li>
<p>异步任务管理：支持将大规模代码生成、项目重构等耗时任务委托至云端执行，有效释放本地计算资源</p>
</li>
</ul>
<p>1.2 什么是OneCode平台？</p>
<p>OneCode平台是面向企业级应用开发的现代化开发框架，以“低代码开发+AI能力增强”为核心定位，旨在简化复杂项目的构建与维护流程。该平台核心能力包括：</p>
<ul>
<li>
<p>统一代码管理：集中管控多项目代码库，保障团队编码规范的一致性</p>
</li>
<li>
<p>模块化架构：支持组件化开发与复用机制，降低系统耦合度</p>
</li>
<li>
<p>自动化部署流水线：原生支持CI/CD流程集成，实现从开发到生产环境的无缝衔接</p>
</li>
<li>
<p>可视化IDE新特性：最新版本推出任务规划、图生代码多Agent模式、深度AI集成代理三大核心功能，强化人工智能与开发流程的深度融合</p>
</li>
</ul>
<p>二、整合准备工作</p>
<p>在启动整合工作前，需完成基础环境配置，确保Qoder CLI与OneCode平台之间的通信链路畅通。核心前提条件如下：</p>
<ol>
<li>
<p>已完成Qoder CLI工具的安装部署及授权配置</p>
</li>
<li>
<p>已完成OneCode平台部署，并获取相应的访问权限</p>
</li>
<li>
<p>具备基础命令行操作能力及OneCode项目管理权限</p>
</li>
</ol>
<p>2.1 安装与配置Qoder CLI</p>
<p>通过官方推荐的标准化方式完成Qoder CLI的安装部署，需确保所安装版本支持MCP协议及委托模式：</p>
<h2 data-id="heading-0">三种主流安装方式可选</h2>
<h2 data-id="heading-1">1. Curl脚本安装（通用跨平台）</h2>
<p>curl -fsSL <a href="https://link.juejin.cn?target=https%3A%2F%2Fqoder.com%2Finstall" target="_blank" title="https://qoder.com/install" ref="nofollow noopener noreferrer">qoder.com/install</a> | bash</p>
<h2 data-id="heading-2">2. Homebrew安装（macOS/Linux系统）</h2>
<p>brew install qoderai/qoder/qodercli --cask</p>
<h2 data-id="heading-3">3. NPM安装（Node.js环境依赖）</h2>
<p>npm install -g @qoder-ai/qodercli</p>
<h2 data-id="heading-4">验证安装结果及版本兼容性（需v0.3.0及以上版本支持OneCode委托模式）</h2>
<p>qodercli --version</p>
<h2 data-id="heading-5">预期输出：Qoder CLI v0.3.5 (支持OneCode委托模式)</h2>
<p>2.2 配置OneCode平台环境</p>
<p>OneCode平台需通过官方标准化工具链完成安装配置，该工具链支持Windows、macOS、Linux全系统，且无需依赖Node环境。核心流程分为CLI工具安装、API密钥配置、项目初始化三步，具体操作以官方最新文档为准：OneCode平台推荐通过Gitee仓库下载源码编译安装，该方式可获取最新稳定版本，支持按需定制功能，且适配Windows、macOS、Linux全系统。核心流程分为源码获取、编译构建、环境配置三步，需提前安装Git与Maven（3.6+）依赖：</p>
<h2 data-id="heading-6">一、OneCode CLI工具安装（多系统适配）</h2>
<h2 data-id="heading-7">1. Linux/macOS/WSL系统（推荐）</h2>
<p>curl -fsSL <a href="https://link.juejin.cn?target=https%3A%2F%2Fonecode-official.oss-cn-hangzhou.aliyuncs.com%2Finstall.sh" target="_blank" title="https://onecode-official.oss-cn-hangzhou.aliyuncs.com/install.sh" ref="nofollow noopener noreferrer">onecode-official.oss-cn-hangzhou.aliyuncs.com/install.sh</a> | bash</p>
<h2 data-id="heading-8">2. macOS系统（Homebrew辅助安装）</h2>
<p>brew tap onecode-dev/offical
brew install onecode-cli</p>
<h2 data-id="heading-9">3. Windows系统（PowerShell管理员模式）</h2>
<p>Set-ExecutionPolicy Bypass -Scope Process -Force;
iwr -useb <a href="https://link.juejin.cn?target=https%3A%2F%2Fonecode-official.oss-cn-hangzhou.aliyuncs.com%2Finstall.ps1" target="_blank" title="https://onecode-official.oss-cn-hangzhou.aliyuncs.com/install.ps1" ref="nofollow noopener noreferrer">onecode-official.oss-cn-hangzhou.aliyuncs.com/install.ps1</a> | iex</p>
<h2 data-id="heading-10">4. 版本验证（需v2.0.0及以上版本支持MCP协议与Qoder集成）</h2>
<p>onecode --version</p>
<h2 data-id="heading-11">预期输出：OneCode CLI v2.1.5 (Build: 20250610) - 支持MCPv2协议</h2>
<h2 data-id="heading-12">二、API密钥获取与配置</h2>
<h2 data-id="heading-13">1. 登录OneCode官方控制台（云版：<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.onecode.cn%25EF%25BC%259B%25E7%25A7%2581%25E6%259C%2589%25E9%2583%25A8%25E7%25BD%25B2%25E7%2589%2588%25E9%259C%2580%25E6%259B%25BF%25E6%258D%25A2%25E4%25B8%25BA%25E4%25BC%2581%25E4%25B8%259A%25E5%2586%2585%25E7%25BD%2591%25E5%259C%25B0%25E5%259D%2580%25EF%25BC%2589" target="_blank" title="https://console.onecode.cn%EF%BC%9B%E7%A7%81%E6%9C%89%E9%83%A8%E7%BD%B2%E7%89%88%E9%9C%80%E6%9B%BF%E6%8D%A2%E4%B8%BA%E4%BC%81%E4%B8%9A%E5%86%85%E7%BD%91%E5%9C%B0%E5%9D%80%EF%BC%89" ref="nofollow noopener noreferrer">console.onecode.cn；私有部署版需替换为企业内网地址）</a></h2>
<h2 data-id="heading-14">2. 进入「个人中心」→「开发者设置」→「API密钥管理」</h2>
<h2 data-id="heading-15">3. 点击「新建密钥」，备注用途为「Qoder CLI集成」，复制生成的密钥串（仅显示一次，需妥善保存）</h2>
<h2 data-id="heading-16">4. 配置全局API密钥（避免每次命令重复输入）</h2>
<p>onecode config set global.api-key "your-onecode-api-key"</p>
<h2 data-id="heading-17">三、OneCode项目初始化与环境验证</h2>
<h2 data-id="heading-18">1. 初始化课程表管理项目（指定框架与版本）</h2>
<p>onecode project create my-course-schedule <br/>
--framework springboot <br/>
--version 2.7.0 <br/>
--description "高校课程表管理系统"</p>
<h2 data-id="heading-19">2. 进入项目工作目录</h2>
<p>cd my-course-schedule</p>
<h2 data-id="heading-20">3. 加载项目依赖（自动同步OneCode平台组件）</h2>
<p>onecode deps sync</p>
<h2 data-id="heading-21">4. 启动本地开发服务（默认8080端口，冲突可通过--port指定）</h2>
<p>onecode server start --port 8080</p>
<h2 data-id="heading-22">预期输出：OneCode Development Server [RUNNING]</h2>
<h2 data-id="heading-23">Access Console: <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fonecode-console" target="_blank" title="http://localhost:8080/onecode-console" ref="nofollow noopener noreferrer">http://localhost:8080/onecode-console</a></h2>
<h2 data-id="heading-24">Service Status: HEALTHY</h2>
<h2 data-id="heading-25">5. 环境连通性测试（验证与Qoder CLI通信链路）</h2>
<p>onecode mcp test --target qoder</p>
<h2 data-id="heading-26">预期输出：MCP Link Established - Qoder CLI Compatible</h2>
<h2 data-id="heading-27">一、前置依赖准备（必装）</h2>
<h2 data-id="heading-28">1. 安装Git（版本2.30+，用于源码克隆）</h2>
<h2 data-id="heading-29">Linux</h2>
<p>sudo apt-get install git -y</p>
<h2 data-id="heading-30">macOS</h2>
<p>brew install git</p>
<h2 data-id="heading-31">Windows：下载安装包 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgit-scm.com%2Fdownload%2Fwin" target="_blank" title="https://git-scm.com/download/win" ref="nofollow noopener noreferrer">git-scm.com/download/wi…</a></h2>
<h2 data-id="heading-32">2. 安装Maven（版本3.6.3+，用于源码编译）</h2>
<h2 data-id="heading-33">Linux/macOS</h2>
<p>wget <a href="https://link.juejin.cn?target=https%3A%2F%2Farchive.apache.org%2Fdist%2Fmaven%2Fmaven-3%2F3.9.6%2Fbinaries%2Fapache-maven-3.9.6-bin.tar.gz" target="_blank" title="https://archive.apache.org/dist/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz" ref="nofollow noopener noreferrer">archive.apache.org/dist/maven/…</a>
tar -zxvf apache-maven-3.9.6-bin.tar.gz
sudo mv apache-maven-3.9.6 /usr/local/</p>
<h2 data-id="heading-34">配置Maven环境变量（Linux/macOS）</h2>
<p>echo "export MAVEN_HOME=/usr/local/apache-maven-3.9.6" &gt;&gt; ~/.bashrc
echo "export PATH=$MAVEN_HOME/bin:$PATH" &gt;&gt; ~/.bashrc
source ~/.bashrc</p>
<h2 data-id="heading-35">Windows：下载安装包 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmaven.apache.org%2Fdownload.cgi%25EF%25BC%258C%25E9%2585%258D%25E7%25BD%25AE%25E7%25B3%25BB%25E7%25BB%259F%25E7%258E%25AF%25E5%25A2%2583%25E5%258F%2598%25E9%2587%258FMAVEN_HOME" target="_blank" title="https://maven.apache.org/download.cgi%EF%BC%8C%E9%85%8D%E7%BD%AE%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8FMAVEN_HOME" ref="nofollow noopener noreferrer">maven.apache.org/download.cg…</a></h2>
<h2 data-id="heading-36">验证依赖</h2>
<p>git --version &amp;&amp; mvn --version</p>
<h2 data-id="heading-37">预期输出：Git版本≥2.30，Maven版本≥3.6.3</h2>
<h2 data-id="heading-38">二、从Gitee下载OneCode源码并编译</h2>
<h2 data-id="heading-39">1. 克隆官方源码仓库（稳定分支：release-2.1.x）</h2>
<p>git clone -b release-2.1.x <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fonecode-dev%2Fonecode-platform.git" target="_blank" title="https://gitee.com/onecode-dev/onecode-platform.git" ref="nofollow noopener noreferrer">gitee.com/onecode-dev…</a>
cd onecode-platform</p>
<h2 data-id="heading-40">2. 源码编译（跳过测试加速构建，依赖Java 8/11）</h2>
<h2 data-id="heading-41">编译核心CLI模块及平台服务</h2>
<p>mvn clean package -DskipTests -pl onecode-cli,onecode-server -am</p>
<h2 data-id="heading-42">3. 验证编译结果</h2>
<h2 data-id="heading-43">编译产物路径：onecode-cli/target/onecode-cli-2.1.5-bin.tar.gz</h2>
<p>ls onecode-cli/target | grep "onecode-cli-.*-bin.tar.gz"</p>
<h2 data-id="heading-44">预期输出：onecode-cli-2.1.5-bin.tar.gz</h2>
<h2 data-id="heading-45">三、OneCode 安装与环境配置</h2>
<h2 data-id="heading-46">1. 下载编译onecode  项目</h2>
<h2 data-id="heading-47">2. 配置全局工程</h2>
<h2 data-id="heading-48">3. 初始化课程表管理项目（衔接后续整合实践）</h2>
<p>onecode project create my-course-schedule <br/>
--framework springboot <br/>
--version 2.7.0 <br/>
--description "高校课程表管理系统"</p>
<h2 data-id="heading-49">4. 启动本地服务验证环境</h2>
<p>cd my-course-schedule
onecode server start --port 8080</p>
<h2 data-id="heading-50">预期输出：OneCode Development Server [RUNNING]</h2>
<h2 data-id="heading-51">Access Console: <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fonecode-console" target="_blank" title="http://localhost:8080/onecode-console" ref="nofollow noopener noreferrer">http://localhost:8080/onecode-console</a></h2>
<h2 data-id="heading-52">Service Status: HEALTHY</h2>
<p>三、CLI委托模式带来的OneCode开发范式革命</p>
<p>在传统OneCode开发流程中，开发者需在可视化IDE与代码编辑器之间频繁切换，完成“需求拆解-组件设计-代码编写-配置部署”的全流程操作。Qoder CLI的委托模式彻底改变这一工作模式，构建“指令输入-AI执行-结果反馈”的全新开发链路，核心变革体现在以下四个维度：</p>
<p>3.1 开发流程：从“手动操作”到“指令驱动”的跃迁</p>
<p>在传统开发模式下，开发一款课程表应用需经历“创建实体类-设计服务层-编写前端组件-配置数据库映射-部署测试”等12项手动操作步骤，总耗时约2个工作日。采用CLI委托模式后，开发者仅需输入核心需求指令，后续编码与配置工作可全部委托Qoder CLI完成：</p>
<h2 data-id="heading-53">委托Qoder CLI完成课程表应用开发</h2>
<p>qodercli delegate onecode "在当前OneCode项目中构建课程表应用，需满足以下要求：</p>
<ol>
<li>数据实体包含课程ID、课程名称、授课教师、上课时间、教室位置等核心字段</li>
<li>服务层实现数据的增删改查操作及按时间段查询功能</li>
<li>代码需符合OneCode @DBField注解规范及平台编码风格</li>
<li>自动生成数据库初始化脚本" --async</li>
</ol>
<h2 data-id="heading-54">查看委托任务执行进度</h2>
<p>qodercli task status</p>
<h2 data-id="heading-55">预期输出：Task-123 | 执行中(65%) | 已完成：实体类生成、服务层编码 | 待完成：前端组件开发、数据库脚本生成</h2>
<p>该模式可将开发周期缩短至30分钟以内，推动开发者从传统的“代码执行者”向“业务需求定义者”转变，使其能够聚焦核心业务逻辑设计而非重复编码工作。</p>
<p>3.2 任务协作：本地终端与云端能力的无缝协同</p>
<p>Qoder CLI的Quest Remote远程委派功能，可为OneCode开发提供云端算力支撑。针对大型项目的代码生成、架构重构等耗时任务，可直接委托至云端沙箱环境执行，本地终端仅需接收执行结果，实现“轻量输入-重度执行”的协同模式：</p>
<h2 data-id="heading-56">启用远程委派模式（适用于大型OneCode项目）</h2>
<p>qodercli config set delegate.mode remote</p>
<h2 data-id="heading-57">委托云端执行大规模代码重构任务</h2>
<p>qodercli delegate onecode "对现有课程表应用进行架构重构，具体要求：</p>
<ol>
<li>优化数据库查询语句性能，添加字段索引注解</li>
<li>将冗余的CourseService类拆分为查询服务与操作服务</li>
<li>重构后代码需符合OneCode模块化规范" --priority high</li>
</ol>
<h2 data-id="heading-58">任务执行完成后自动同步至本地OneCode项目</h2>
<p>qodercli task sync Task-123</p>
<p>该协作模式有效解决了本地环境算力不足、依赖冲突等问题，同时通过云端环境标准化配置，确保生成代码与OneCode平台的兼容性。</p>
<p>3.3 规范落地：从“人工检查”到“AI强制约束”的升级</p>
<p>OneCode平台的编码规范（包括注解使用、目录结构、命名规则等）在传统开发模式中需通过人工审查或IDE插件保障，存在执行不到位的风险。在CLI委托模式下，Qoder CLI已预先学习OneCode平台规范，生成代码时可自动满足约束条件，无需额外人工干预：</p>
<p>// 委托生成的CourseScheduleEntity类（自动符合OneCode规范）
@EntityMapping(
table = "course_schedule",
primaryKey = "schedule_id",
primaryKeyStrategy = PrimaryKeyStrategy.AUTO
)
@DBTable(tableName = "course_schedule", primaryKey = "schedule_id", cname = "课程表")
public class CourseScheduleEntity {</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Uid</span>
<span class="hljs-meta">@DBField</span>(dbFieldName = <span class="hljs-string">"schedule_id"</span>, dbType = <span class="hljs-title class_">ColType</span>.<span class="hljs-property">VARCHAR</span>, length = <span class="hljs-number">36</span>, isNull = <span class="hljs-literal">false</span>, cnName = <span class="hljs-string">"课程表ID"</span>)
<span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> scheduleId;

<span class="hljs-meta">@DBField</span>(dbFieldName = <span class="hljs-string">"course_name"</span>, dbType = <span class="hljs-title class_">ColType</span>.<span class="hljs-property">VARCHAR</span>, length = <span class="hljs-number">20</span>, isNull = <span class="hljs-literal">false</span>, cnName = <span class="hljs-string">"课程名称"</span>)
<span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> courseName;

<span class="hljs-comment">// 自动添加OneCode平台要求的序列化接口与toString方法</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">toString</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"CourseScheduleEntity{"</span> +
            <span class="hljs-string">"scheduleId='"</span> + scheduleId + <span class="hljs-string">'\''</span> +
            <span class="hljs-string">", courseName='"</span> + courseName + <span class="hljs-string">'\''</span> +
            <span class="hljs-string">'}'</span>;
}
</code></pre>
<p>}</p>
<p>针对项目中已存在的非规范代码，可通过委托指令实现批量修正，大幅降低代码审查成本：</p>
<h2 data-id="heading-59">委托修正项目中所有不符合规范的代码</h2>
<p>qodercli delegate onecode "扫描当前OneCode项目代码，执行以下优化操作：</p>
<ol>
<li>补全所有实体类中缺失的@DBField注解</li>
<li>修正不符合驼峰命名规范的方法名</li>
<li>删除未被引用的导入语句" --scope all</li>
</ol>
<p>3.4 集成能力：CLI与可视化IDE的双向赋能</p>
<p>Qoder CLI的委托模式并非替代OneCode可视化IDE，而是形成“CLI处理批量任务+IDE完成精细调整”的协同机制。OneCode可视化IDE的最新功能与CLI委托模式可实现无缝衔接，达成1+1&gt;2的应用效果：</p>
<ul>
<li>
<p>CLI生成的代码可直接在IDE中打开，进行可视化调整与优化</p>
</li>
<li>
<p>IDE中的任务规划结果可导出为标准化CLI指令，实现批量执行</p>
</li>
<li>
<p>图生代码功能生成的界面原型，可通过CLI委托完成业务逻辑填充</p>
</li>
</ul>
<p>四、OneCode可视化IDE新功能与CLI的协同实践</p>
<p>OneCode可视化IDE最新推出的任务规划、图生代码多Agent模式、深度AI集成代理三大功能，与Qoder CLI的委托模式形成能力互补，构建全流程AI开发体系。以下为具体协同应用场景：</p>
<p>4.1 任务规划：从可视化拆解到CLI批量执行</p>
<p>OneCode IDE的任务规划功能支持开发者通过拖拽方式将需求拆解为“实体设计-服务开发-前端组件-部署配置”等子任务，并生成标准化任务清单。该清单可直接导出为CLI指令，通过委托模式实现批量执行：</p>
<h2 data-id="heading-60">基于OneCode IDE任务规划结果生成CLI执行指令</h2>
<h2 data-id="heading-61">1. 导出IDE任务规划结果（生成task-plan.json配置文件）</h2>
<p>onecode ide export-task --format json --output task-plan.json</p>
<h2 data-id="heading-62">2. 基于任务清单执行批量委托</h2>
<p>qodercli delegate onecode --from task-plan.json --sync-ide</p>
<h2 data-id="heading-63">执行完成后同步任务状态至IDE</h2>
<p>qodercli task sync-ide Task-456</p>
<p>该模式既保留了IDE可视化规划的直观性，又发挥了CLI批量执行的高效性，特别适用于团队协作中的需求落地场景。</p>
<p>4.2 图生代码多Agent模式：CLI驱动的协同生成</p>
<p>OneCode IDE的图生代码功能支持上传UI设计图，通过多Agent协作机制生成前端组件代码（布局Agent负责页面结构、样式Agent负责视觉美化、逻辑Agent负责交互实现）。当需要批量生成相似组件时，可通过CLI委托模式驱动该流程自动化：</p>
<h2 data-id="heading-64">委托CLI调用OneCode多Agent模式批量生成前端组件</h2>
<p>qodercli delegate onecode "基于图生代码多Agent模式执行以下操作：</p>
<ol>
<li>批量处理./design目录下的5张课程表相关UI设计图</li>
<li>布局Agent采用OneCode标准栅格系统进行页面结构设计</li>
<li>样式Agent使用平台默认主题进行视觉美化</li>
<li>逻辑Agent绑定已生成的CourseService服务接口</li>
<li>组件生成后自动注册至OneCode组件库"</li>
</ol>
<h2 data-id="heading-65">查看各Agent执行日志详情</h2>
<p>qodercli task log Task-789 --agent all</p>
<p>CLI的批量处理能力与多Agent的专业分工相结合，可使前端组件开发效率提升80%以上，尤其适用于标准化程度高的企业级应用开发场景。</p>
<p>4.3 深度AI集成代理：CLI触发的全流程智能支持</p>
<p>OneCode平台的深度AI集成代理功能，可在开发全流程中提供需求分析、代码优化、缺陷修复等智能支持。通过CLI委托模式，可将该代理能力嵌入自动化流程，实现开发全周期的AI赋能：</p>
<h2 data-id="heading-66">1. 委托AI代理分析需求文档并生成开发方案</h2>
<p>qodercli delegate onecode-agent "分析./requirements/course-schedule.md需求文档，生成OneCode开发方案，内容需包含技术选型、接口设计、数据库表结构定义" --output dev-plan.md</p>
<h2 data-id="heading-67">2. 基于开发方案自动生成项目基础骨架</h2>
<p>qodercli delegate onecode --from dev-plan.md --action generate-skeleton</p>
<h2 data-id="heading-68">3. 开发完成后委托AI代理进行代码审查与优化</h2>
<p>qodercli delegate onecode-agent "审查当前项目代码，重点检查以下维度：</p>
<ul>
<li>代码与OneCode平台规范的符合性</li>
<li>数据库查询语句的性能优化空间</li>
<li>异常处理逻辑的完整性
并自动生成优化建议及修复方案" --fix auto</li>
</ul>
<p>这种“需求分析-骨架生成-开发执行-代码优化”的全流程委托模式，推动OneCode开发从“工具辅助”阶段迈向“智能驱动”的新阶段。</p>
<p>五、整合过程中的关键配置与最佳实践</p>
<p>5.1 核心配置：MCP服务器与权限管理</p>
<p>Qoder CLI与OneCode平台的通信基于MCP协议实现，需完成以下配置以确保委托功能正常运行：</p>
<h2 data-id="heading-69">1. 注册OneCode MCP服务节点（关联AI代理能力）</h2>
<h2 data-id="heading-70">命令说明：--command指定MCP服务启动指令，--env注入环境变量，--timeout设置连接超时阈值</h2>
<p>qodercli mcp add onecode <br/>
--command "onecode mcp start --port 9090" <br/>
--env ONECODE_API_KEY=your-valid-api-key <br/>
--timeout 30s</p>
<h2 data-id="heading-71">2. 多维验证MCP连接有效性</h2>
<h2 data-id="heading-72">检查项包括：网络连通性、AI代理状态、能力矩阵匹配度</h2>
<p>qodercli mcp test onecode --check all</p>
<h2 data-id="heading-73">预期输出：</h2>
<h2 data-id="heading-74">网络连接：OK（TCP 9090端口可达）</h2>
<h2 data-id="heading-75">AI代理状态：在线（版本v1.2.0）</h2>
<h2 data-id="heading-76">支持能力：代码生成、规范检查、需求解析、多Agent调度</h2>
<h2 data-id="heading-77">兼容性：Qoder CLI v0.3.5 与 OneCode v4.0 匹配</h2>
<h2 data-id="heading-78">3. 配置项目级委托策略（优先级：项目配置&gt;全局配置）</h2>
<h2 data-id="heading-79">核心策略：优先使用远程AI代理、启用任务日志同步、指定Agent执行顺序</h2>
<p>cat &gt; .qoder-delegate.json &lt;&lt; EOF
{
"defaultTarget": "onecode",
"taskPriority": "medium",
"syncIde": true,
"logSyncInterval": 10s,
"agentConfig": {
"preferRemote": true,
"logLevel": "info",
"defaultAgentOrder": ["analysis", "generate", "optimize"]
},
"retryPolicy": {
"maxRetries": 3,
"retryDelay": 5s
}
}
EOF</p>
<h2 data-id="heading-80">4. 验证配置生效状态</h2>
<p>qodercli config validate --scope project</p>
<h2 data-id="heading-81">预期输出：项目级配置有效，无冲突项</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[本地系统、虚拟机、远程服务器三者之间的核心区别]]></title>    <link>https://juejin.cn/post/7576821684252262443</link>    <guid>https://juejin.cn/post/7576821684252262443</guid>    <pubDate>2025-11-26T10:25:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576821684252262443" data-draft-id="7576859345934598198" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="本地系统、虚拟机、远程服务器三者之间的核心区别"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-26T10:25:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tomato_404"/> <meta itemprop="url" content="https://juejin.cn/user/2179677551600074"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            本地系统、虚拟机、远程服务器三者之间的核心区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179677551600074/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tomato_404
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T10:25:15.000Z" title="Wed Nov 26 2025 10:25:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🌍 一句话总结</h2>
<p>✅ 你之所以用 <strong>Tabby 连接公司服务器</strong> 不需要虚拟机，<br/>
是因为那台服务器 <strong>已经是一台运行着 Ubuntu 的独立电脑（远程机器）</strong> 。<br/>
而你要在自己的电脑上“拥有一个 Ubuntu 环境”，<br/>
就得自己“造出”这样一台虚拟的电脑——那就是虚拟机。</p>
<hr/>
<h2 data-id="heading-1">🧠 类比理解：虚拟机 vs 远程服务器</h2>





























<table><thead><tr><th>概念</th><th>是什么</th><th>在哪儿运行</th><th>你如何进入</th></tr></thead><tbody><tr><td>💻 你自己的电脑（Windows）</td><td>物理机</td><td>桌子上的电脑</td><td>直接操作</td></tr><tr><td>🧱 虚拟机（VM）</td><td>一台“在你电脑里模拟出来的另一台电脑”</td><td>运行在你的物理机里</td><td>通过虚拟机软件打开</td></tr><tr><td>🖥️ 公司服务器（Ubuntu）</td><td>一台真实存在的远程电脑（在机房或云上）</td><td>运行在公司网络</td><td>用 SSH（如 Tabby）远程连接</td></tr></tbody></table>
<p>所以区别就在于：</p>
<ul>
<li><strong>虚拟机 = 在你电脑里“模拟出另一台电脑”</strong> ；</li>
<li><strong>服务器 = 已经存在的“另一台真实电脑”</strong> ；</li>
<li><strong>SSH（Tabby） = 你用网线连过去远程操作那台电脑的“键盘和屏幕”。</strong></li>
</ul>
<hr/>
<h2 data-id="heading-2">🔍 更深入一点：Tabby 并不是运行 Ubuntu，而是在“远程登录”Ubuntu</h2>
<p>当你运行：</p>
<pre><code class="hljs language-sql" lang="sql">ssh <span class="hljs-keyword">user</span><span class="hljs-variable">@192</span><span class="hljs-number">.168</span><span class="hljs-number">.31</span><span class="hljs-number">.185</span>
</code></pre>
<p>或用 Tabby 连接公司服务器时：</p>
<ul>
<li>你的电脑只是一个<strong>终端界面</strong>（相当于“显示器 + 键盘”）；</li>
<li>运行命令、文件系统、网络配置都发生在远程服务器上；</li>
<li>所以你会看到那边的：</li>
</ul>

<ul>
<li>
<ul>
<li>Ubuntu 系统</li>
<li>已经安装好的 nginx、docker 等等；</li>
<li>你只是在操作那台远程机器。</li>
</ul>
</li>
</ul>
<p>而如果你想在<strong>自己的电脑上</strong>也有一样的 Ubuntu 环境，<br/>
因为你手上这台机器运行的可能是 <strong>Windows</strong> 或 <strong>macOS</strong>，<br/>
那就得“虚拟”出一台 Ubuntu 系统的电脑，靠虚拟机实现。</p>
<hr/>
<h2 data-id="heading-3">🧩 对比一下你的两种情况：</h2>























<table><thead><tr><th>场景</th><th>运行的系统</th><th>物理机器是谁</th><th>为什么能用 Ubuntu</th></tr></thead><tbody><tr><td>① Tabby 连公司服务器</td><td>Ubuntu</td><td>服务器（192.168.31.185）</td><td>服务器已经装好了 Ubuntu</td></tr><tr><td>② 自己电脑（Windows）</td><td>Windows</td><td>你自己的笔电 / PC</td><td>没有 Ubuntu，需要虚拟机或 WSL</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">⚙️ 那如果我想像公司服务器那样，本机也能跑 Ubuntu，有哪些选择？</h2>






























<table><thead><tr><th>方案</th><th>原理</th><th>是否需要虚拟机</th></tr></thead><tbody><tr><td><strong>VirtualBox / VMware 安装 Ubuntu</strong></td><td>直接在 Windows 上开一台“虚拟电脑”装 Ubuntu</td><td>✅ 需要虚拟机</td></tr><tr><td><strong>WSL2 (Windows Subsystem for Linux)</strong></td><td>微软提供的轻量 Linux 子系统</td><td>❌ 不需要传统虚拟机，推荐</td></tr><tr><td><strong>Docker Desktop</strong></td><td>它在底层用轻量虚拟化跑 Linux 内核</td><td>⚙️ 自动管理虚拟层，无需你配置</td></tr><tr><td><strong>买/租云服务器（远程主机）</strong></td><td>直接连远程 Ubuntu</td><td>❌ 不需要虚拟机，本身就是服务器</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-5">🧭 你可以这样理解一条主线：</h2>
<p>物理机器（你的电脑 或 公司服务器）<br/>
→ 上面运行系统（Windows 或 Ubuntu）<br/>
→ 系统里装环境（nginx、docker 等）</p>
<p>当你连接服务器时，<br/>
你是“借用公司那台 Ubuntu 机器的系统”；<br/>
当你在本机装虚拟机时，<br/>
你是在“自己电脑里再创建一台 Ubuntu 机器”。</p>
<hr/>
<h2 data-id="heading-6">🚀 推荐你目前最方便的做法（如果你是 Windows 用户）</h2>
<p>👉 <strong>使用 WSL2 + Ubuntu 子系统</strong><br/>
不需要虚拟机软件、不占太多资源、命令与公司服务器完全一致。</p>
<p>安装命令（管理员 PowerShell）：</p>
<pre><code class="hljs language-css" lang="css">wsl <span class="hljs-attr">--install</span>
</code></pre>
<p>安装完成后：</p>
<pre><code class="hljs language-bash" lang="bash">wsl -l -v   <span class="hljs-comment"># 查看 Ubuntu 是否安装成功</span>
wsl         <span class="hljs-comment"># 进入 Ubuntu 终端</span>
</code></pre>
<p>现在你就在一个真正的 Ubuntu 环境里了，<br/>
可以执行：</p>
<pre><code class="hljs language-lua" lang="lua">sudo apt update
sudo apt install nginx docker.<span class="hljs-built_in">io</span> -y
</code></pre>
<p>这时你本地环境的使用体验，就和你用 Tabby 连公司服务器非常接近。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[女朋友又给我出难题了：解锁网页禁用复制 + 一键提取图片文字]]></title>    <link>https://juejin.cn/post/7576197876717797414</link>    <guid>https://juejin.cn/post/7576197876717797414</guid>    <pubDate>2025-11-25T02:45:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576197876717797414" data-draft-id="7575102209606303770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="女朋友又给我出难题了：解锁网页禁用复制 + 一键提取图片文字"/> <meta itemprop="keywords" content="前端,JavaScript,浏览器"/> <meta itemprop="datePublished" content="2025-11-25T02:45:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不一样的少年_"/> <meta itemprop="url" content="https://juejin.cn/user/3035079961218551"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            女朋友又给我出难题了：解锁网页禁用复制 + 一键提取图片文字
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3035079961218551/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不一样的少年_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T02:45:00.000Z" title="Tue Nov 25 2025 02:45:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    900
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>女朋友做广告策划，每天要从海量网站和素材中摘抄文案。</p>
<p>微信或飞书截图都有 OCR，但她总要“切微信/飞书 → 识别 → 复制 → 切回浏览器”，来回折腾好麻烦，经常被打断思路。</p>
<p><strong>两个最常见的烦恼</strong>：</p>
<ul>
<li>
<p><strong>禁止复制的页面</strong>：设计灵感站、素材站、文库类网站，明明能看到文字，就是选不了、右键也没用，只能手敲。</p>
</li>
<li>
<p><strong>图片里的文字无法快速提取</strong>：看到一张图，得切到微信、点“提取文字”、等识别、复制、再切回来粘贴。</p>
</li>
</ul>
<p><strong>一张图，好几个步骤，来回切换三次。</strong></p>
<p>有天晚上她在赶方案，一边操作一边念叨：“太麻烦了，思路都断了……”</p>
<p>我说：“要不我给你写个插件？”</p>
<p>于是周末两天，做了这个 <strong>「图文解锁器」</strong>：</p>
<ol>
<li><strong>一键解除网页限制</strong> —— 禁选中、禁右键的网站，点一下就能正常复制</li>
<li><strong>浏览器里直接拖框识别</strong> —— 不用切微信，看到哪里框哪里，几秒出结果</li>
<li><strong>所有操作在侧边栏完成</strong> —— 不遮挡页面，不用来回切窗口</li>
</ol>
<p>周一她用上之后的评价：“终于顺手了！那些恶心的禁止复制网站现在随便复制，图片识别也不用跳来跳去了。”</p>
<p>下面讲讲开发过程和技术实现 👇</p>
</blockquote>
<h2 data-id="heading-0">效果演示: 解锁网页禁用复制 + 一键提取图片文字</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dce2ce2f9c5043b690a3184eb6f0d1de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764748905&amp;x-signature=6g1TP6c5jRKOc%2FeqrH6m5S%2FmWCs%3D" alt="copy-everything.gif" loading="lazy"/></p>
<h2 data-id="heading-1">功能特性</h2>
<h3 data-id="heading-2">1.  解除网页限制</h3>
<ul>
<li>一键解除复制限制</li>
<li>恢复右键菜单</li>
<li>允许文本选中</li>
<li>支持动态加载的网页内容解除限制</li>
</ul>
<h3 data-id="heading-3">2. OCR 文字识别（方式与特性）</h3>






























<table><thead><tr><th>方式</th><th>说明</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>页面截图</strong></td><td>快速截取当前可见区域</td><td>一键识别网页全部内容</td></tr><tr><td><strong>自选区域</strong></td><td>拖拽选择任意区域</td><td>只识别你选中的特定区域</td></tr><tr><td><strong>点击上传</strong></td><td>选择本地图片文件</td><td>识别本地图片中的文字</td></tr><tr><td><strong>拖拽上传</strong></td><td>拖入图片即可识别</td><td>方便上传图片并识别文字</td></tr></tbody></table>
<ul>
<li>基于腾讯云 OCR API（每月 1000 次免费额度）</li>
<li>内置图片预览，识别前可确认内容</li>
<li>识别结果一键复制，支持后续粘贴使用</li>
<li>识别流程：选择方式 → 预览 → 开始识别 → 复制/下载</li>
</ul>
<h2 data-id="heading-4">快速开始（安装使用）</h2>
<h3 data-id="heading-5">1. 获取代码</h3>
<ul>
<li><strong>GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fcopy-everything" target="_blank" title="https://github.com/Teernage/copy-everything" ref="nofollow noopener noreferrer">github.com/Teernage/co…</a> ⭐ 如果对您有帮助，欢迎Star</li>
<li><strong>Gitee</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxuzhenxin110%2Fcopy-everything" target="_blank" title="https://gitee.com/xuzhenxin110/copy-everything" ref="nofollow noopener noreferrer">gitee.com/xuzhenxin11…</a></li>
</ul>
<h3 data-id="heading-6">2. 安装扩展（本地加载）</h3>
<ol>
<li>打开 Chrome，地址栏输入 chrome://extensions/</li>
<li>右上角开启“开发者模式”</li>
<li>点击“加载已解压的扩展程序”</li>
<li>选择插件目录</li>
<li>安装完成</li>
</ol>
<p><code>小贴士：Side Panel 依赖较新版本 Chrome，建议 114+。</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a20851ca20744c5fb2660860839141cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764748905&amp;x-signature=QB6ADXsHczAk%2Fp4t0W88i2byf4A%3D" alt="安装copy-everything.gif" loading="lazy"/></p>
<h3 data-id="heading-7">3. 首次使用</h3>
<ul>
<li>点击插件图标打开侧边栏</li>
<li>点击「一键解除」即可解除页面复制限制</li>
<li>使用截图功能（页面截图 / 自选区域）或本地上传（点击上传 / 拖拽上传）进行 OCR 识别</li>
<li>首次体验可直接使用以下账号（每月 1000 次免费额度）：
<ul>
<li>SecretId： AKIDLUQ7aqsjNmwufWFm590d1BxXs0xgBRTH</li>
<li>SecretKey： c09OVP4aw75oIYZMvFO8j5C5uiIgspIc</li>
<li>将 SecretId 和 SecretKey 填入插件侧边栏后保存设置，即可开始图文识别</li>
</ul>
</li>
</ul>
<p><code>注：如免费额度用完，请根据下方指导申请属于你自己的账号哦。👇</code></p>
<h4 data-id="heading-8">腾讯云 OCR 开通与配置</h4>
<p>插件支持腾讯云 OCR，每月有约 1000 次免费额度，足够日常使用。首次识别前，请按以下步骤开通并配置：</p>
<ol>
<li>进入 腾讯云文字识别控制台<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.cloud.tencent.com%2Focr%2Fv2%2Foverview" target="_blank" title="https://console.cloud.tencent.com/ocr/v2/overview" ref="nofollow noopener noreferrer">console.cloud.tencent.com/ocr/v2/over…</a> ，勾选条款并开通服务。</li>
<li>前往 API 密钥管理<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.cloud.tencent.com%2Fcam%2Fcapi" target="_blank" title="https://console.cloud.tencent.com/cam/capi" ref="nofollow noopener noreferrer">console.cloud.tencent.com/cam/capi</a> 获取自己的 SecretId 和 SecretKey。</li>
<li>将 SecretId 和 SecretKey 填入插件侧边栏并保存设置，即可开始图文识别。</li>
</ol>
<h3 data-id="heading-9">注意事项</h3>
<ol>
<li>
<p><strong>API 费用</strong>：腾讯云 OCR 每个月有1000个请求的免费额度，超出后按量计费</p>
</li>
<li>
<p><strong>权限说明</strong>：</p>
<ul>
<li><code>activeTab</code>：访问当前标签页</li>
<li><code>scripting</code>：注入脚本</li>
<li><code>storage</code>：保存配置</li>
<li><code>sidePanel</code>：侧边栏功能</li>
</ul>
</li>
<li>
<p><strong>兼容性</strong>：</p>
<ul>
<li>Chrome 114+ （Side Panel API 要求）</li>
<li>部分网站可能有额外防护</li>
</ul>
</li>
</ol>
<h2 data-id="heading-10">技术实现原理</h2>
<h3 data-id="heading-11">核心技术栈</h3>
<ul>
<li><strong>Manifest V3</strong>：Chrome 扩展最新规范</li>
<li><strong>Side Panel API</strong>：侧边栏界面</li>
<li><strong>Content Scripts</strong>：页面注入脚本</li>
<li><strong>Tencent Cloud OCR</strong>：腾讯云文字识别 API</li>
<li><strong>Canvas API</strong>：图片裁剪</li>
</ul>
<h3 data-id="heading-12">架构设计</h3>
<pre><code class="hljs language-bash" lang="bash">copy-everything
├── manifest.json         <span class="hljs-comment"># 插件配置</span>
├── icons                 <span class="hljs-comment"># 插件图标</span>
├── background.js         <span class="hljs-comment"># 后台服务</span>
├── content.js            <span class="hljs-comment"># 内容脚本（核心功能）</span>
├── inject.js             <span class="hljs-comment"># 注入页面脚本（核心功能）</span>
├── sidepanel.html        <span class="hljs-comment"># 侧边栏界面</span>
├── sidepanel.js          <span class="hljs-comment"># 侧边栏界面逻辑</span>
├── sidepanel.css         <span class="hljs-comment"># 侧边栏样式</span>
└── tencentOCR.js         <span class="hljs-comment"># OCR SDK</span>

</code></pre>
<h2 data-id="heading-13">核心代码解析</h2>
<h3 data-id="heading-14">1. 解除复制限制  （五层防护）</h3>
<h4 data-id="heading-15">这是插件的核心功能之一，通过多层防护确保解除限制：</h4>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6b625ffe3f14f719c51acb48cc6483d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764748905&amp;x-signature=ke%2F2EtVHZzSQrjYga2Gt9AoHwfg%3D" alt="image.png" width="30%" loading="lazy"/>
<h4 data-id="heading-16">实现原理</h4>
<p>通过<strong>五层防护</strong>确保解除限制</p>
<h4 data-id="heading-17">第一层：CSS 强制覆盖</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> style = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'style'</span>);
style.<span class="hljs-property">textContent</span> = <span class="hljs-string">`
  html, body, * {
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    user-select: text !important;
  }
`</span>;
<span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(style);
</code></pre>
<p><strong>作用</strong>：强制允许文本选中，覆盖网站的 CSS 限制。</p>
<h4 data-id="heading-18">第二层：事件拦截（捕获阶段）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 在捕获阶段拦截所有限制事件</span>
<span class="hljs-keyword">const</span> restrictedEvents = [
  <span class="hljs-string">'copy'</span>, <span class="hljs-string">'cut'</span>, <span class="hljs-string">'paste'</span>, <span class="hljs-string">'contextmenu'</span>, 
  <span class="hljs-string">'selectstart'</span>, <span class="hljs-string">'dragstart'</span>, <span class="hljs-string">'keydown'</span>, <span class="hljs-string">'keyup'</span>, <span class="hljs-string">'keypress'</span>
];

<span class="hljs-keyword">const</span> <span class="hljs-title function_">stopEvent</span> = (<span class="hljs-params">e</span>) =&gt; {
  e.<span class="hljs-title function_">stopPropagation</span>();
  e.<span class="hljs-property">stopImmediatePropagation</span>?.(); <span class="hljs-comment">// 阻止其他监听器执行</span>
};

<span class="hljs-comment">// 在 window、document、documentElement、body 四个层级同时监听</span>
[<span class="hljs-variable language_">window</span>, <span class="hljs-variable language_">document</span>, <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>, <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">target</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (target) {
    restrictedEvents.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">eventType</span> =&gt;</span> {
      target.<span class="hljs-title function_">addEventListener</span>(eventType, stopEvent, <span class="hljs-literal">true</span>); <span class="hljs-comment">// ← 捕获阶段</span>
    });
  }
});
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>在<strong>捕获阶段</strong>拦截（优先级最高）</li>
<li>使用 <code>stopImmediatePropagation()</code> 阻止其他监听器</li>
<li>在四个层级监听（window → document → html → body）</li>
</ul>
<p><strong>为什么要用捕获阶段？</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">事件流：捕获阶段 → 目标阶段 → 冒泡阶段 
<span class="hljs-code">        ↓
  我们在这里拦截（优先级最高）
</span></code></pre>
<h4 data-id="heading-19">第三层：移除内联事件属性</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 移除所有事件属性（如 oncopy="return false"）</span>
<span class="hljs-keyword">const</span> eventAttrs = [
  <span class="hljs-string">'oncopy'</span>, <span class="hljs-string">'oncut'</span>, <span class="hljs-string">'onpaste'</span>, <span class="hljs-string">'oncontextmenu'</span>,
  <span class="hljs-string">'onselectstart'</span>, <span class="hljs-string">'onkeydown'</span>, <span class="hljs-string">'ondragstart'</span>
];

<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(eventAttrs.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> <span class="hljs-string">`[<span class="hljs-subst">${a}</span>]`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">','</span>))
  .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
    eventAttrs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">attr</span> =&gt;</span> el.<span class="hljs-title function_">removeAttribute</span>(attr));
  });
</code></pre>
<p><strong>作用</strong>：移除 HTML 标签上的内联事件（如 <code>oncopy="return false"</code>）</p>
<h4 data-id="heading-20">第四层：API 劫持（重写 preventDefault）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 注入到页面上下文，重写原生方法</span>
<span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
script.<span class="hljs-property">textContent</span> = <span class="hljs-string">`
  (function() {
    if (window.__preventDefaultDisabled) return;
    window.__preventDefaultDisabled = true;
    
    const blockedEvents = new Set(<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(restrictedEvents)}</span>);
    const originalPreventDefault = Event.prototype.preventDefault;
    
    Event.prototype.preventDefault = function() {
      if (blockedEvents.has(this.type)) return; // ← 禁用 preventDefault
      return originalPreventDefault.call(this);
    };
  })();
`</span>;
<span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">appendChild</span>(script);
script.<span class="hljs-title function_">remove</span>();
</code></pre>
<p><strong>为什么要注入 <code>&lt;script&gt;</code> 标签？</strong></p>
<ul>
<li>Content Script 运行在<strong>隔离环境</strong>（Isolated World）</li>
<li>无法直接修改页面的 <code>Event.prototype</code></li>
<li>通过 <code>&lt;script&gt;</code> 标签注入到<strong>页面上下文</strong>（Main World）</li>
</ul>
<p><code>💡 深入理解脚本通信机制</code></p>
<p>如果你想深入了解插件脚本通信机制，强烈推荐阅读： <strong><a href="https://juejin.cn/post/7573521516324732955" target="_blank" title="https://juejin.cn/post/7573521516324732955">大部分人都错了！这才是 Chrome 插件多脚本通信的正确姿势</a></strong>   <a href="https://juejin.cn/post/7573521516324732955" target="_blank" title="https://juejin.cn/post/7573521516324732955">juejin.cn/post/757352…</a> 这篇文章用原理+示例拆解了常见误区与正确做法，能帮你更透彻地理解本插件的通信机制。</p>
<h4 data-id="heading-21">第五层：动态内容监听</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 监听 DOM 变化，自动处理动态加载的元素</span>
<span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-function">(<span class="hljs-params">mutations</span>) =&gt;</span> {
  mutations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">mutation</span>) =&gt;</span> {
    mutation.<span class="hljs-property">addedNodes</span>?.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">node</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (node <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Element</span>) {
        <span class="hljs-comment">// 移除事件属性</span>
        eventAttrs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">attr</span> =&gt;</span> node.<span class="hljs-title function_">removeAttribute</span>(attr));
        <span class="hljs-comment">// 强制允许选中</span>
        node.<span class="hljs-property">style</span>?.<span class="hljs-title function_">setProperty</span>(<span class="hljs-string">'user-select'</span>, <span class="hljs-string">'text'</span>, <span class="hljs-string">'important'</span>);
      }
    });
  });
});

observer.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>, {
  <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span>
});
</code></pre>
<p><strong>作用</strong>：监听 DOM 变化，自动处理动态加载的元素（如 React/Vue 渲染的内容）。</p>
<h3 data-id="heading-22">2. 自选区域截图</h3>
<h3 data-id="heading-23">三步完成截图</h3>
<ol>
<li><strong>按下按钮</strong> → 屏幕变暗</li>
<li><strong>拖动框</strong> → ：按住鼠标拖出一个框，选出你想要的区域</li>
<li><strong>松开手</strong> → 自动截取框内内容</li>
</ol>
<h4 data-id="heading-24">实现步骤</h4>
<h3 data-id="heading-25"> 这背后发生了什么？</h3>
<h4 data-id="heading-26"><strong>步骤 1：创建选框工具</strong></h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 创建遮罩层（就像给屏幕盖了一层磨砂玻璃）</span>
<span class="hljs-keyword">const</span> overlay = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
overlay.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
  position: fixed;
  left: 0; top: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.5);  /* 半透明黑色 */
  cursor: crosshair;             /* 十字准星 */
  z-index: 999999;
`</span>;
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(overlay);

</code></pre>
<p>当你点击"自选区域"后，插件会：</p>
<ul>
<li>在屏幕上盖一层半透明黑色遮罩（让你看清楚要选什么）</li>
<li>鼠标变成十字准星（提示你可以开始拖框了）</li>
<li>准备好一个绿色边框（等你拖出来就显示）</li>
</ul>
<h4 data-id="heading-27"><strong>2. 跟随你的鼠标画框（实时反馈）</strong></h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 鼠标按下 → 记录起点</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleMouseDown</span>(<span class="hljs-params">e</span>) {
  startX = e.<span class="hljs-property">clientX</span>;  <span class="hljs-comment">// 记住你点击的 X 坐标</span>
  startY = e.<span class="hljs-property">clientY</span>;  <span class="hljs-comment">// 记住你点击的 Y 坐标</span>
}

<span class="hljs-comment">// 鼠标移动 → 实时更新框的大小</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleMouseMove</span>(<span class="hljs-params">e</span>) {
  currentX = e.<span class="hljs-property">clientX</span>;
  currentY = e.<span class="hljs-property">clientY</span>;
  
  <span class="hljs-comment">// 计算框的位置和大小（支持反向拖拽）</span>
  <span class="hljs-keyword">const</span> left = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(startX, currentX);   <span class="hljs-comment">// 取最小值作为左边界</span>
  <span class="hljs-keyword">const</span> top = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(startY, currentY);    <span class="hljs-comment">// 取最小值作为上边界</span>
  <span class="hljs-keyword">const</span> width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(currentX - startX); <span class="hljs-comment">// 宽度 = 绝对值</span>
  <span class="hljs-keyword">const</span> height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(currentY - startY);<span class="hljs-comment">// 高度 = 绝对值</span>
  
  <span class="hljs-comment">// 更新绿色边框的位置</span>
  selectionBox.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = left + <span class="hljs-string">'px'</span>;
  selectionBox.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = top + <span class="hljs-string">'px'</span>;
  selectionBox.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = width + <span class="hljs-string">'px'</span>;
  selectionBox.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = height + <span class="hljs-string">'px'</span>;
}

</code></pre>
<p>当你按住鼠标拖动时：</p>
<ul>
<li>记录你<strong>按下的位置</strong>（起点）</li>
<li>记录你<strong>当前的位置</strong>（终点）</li>
<li>用这两个点的横坐标和纵坐标的差值画出一个矩形框</li>
</ul>
<p><strong>支持反向拖拽</strong>：不管你从左上往右下拖，还是从右下往左上拖，都能正确识别！</p>
<p><strong>举个例子</strong>：</p>
<pre><code class="hljs language-js" lang="js">你从 (<span class="hljs-number">100</span>, <span class="hljs-number">100</span>) 拖到 (<span class="hljs-number">300</span>, <span class="hljs-number">300</span>)
→ 框的位置：left=<span class="hljs-number">100</span>, top=<span class="hljs-number">100</span>, width=<span class="hljs-number">200</span>, height=<span class="hljs-number">200</span> ✅

你从 (<span class="hljs-number">300</span>, <span class="hljs-number">300</span>) 拖到 (<span class="hljs-number">100</span>, <span class="hljs-number">100</span>)（反向）
→ 框的位置：left=<span class="hljs-number">100</span>, top=<span class="hljs-number">100</span>, width=<span class="hljs-number">200</span>, height=<span class="hljs-number">200</span> ✅

</code></pre>
<h4 data-id="heading-28"><strong>3. 精准裁剪（像剪刀一样裁图）</strong></h4>
<p>当你松开鼠标后，插件会：</p>
<ol>
<li><strong>先截取整个页面</strong>（就像拍了一张全屏照片）</li>
<li><strong>再裁剪出你选中的部分</strong>（就像用剪刀剪出你要的区域）</li>
</ol>
<p><strong>关键技术：Canvas 画布裁剪</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 创建一个画布（就像准备一张白纸）</span>
<span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
<span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);

<span class="hljs-comment">// 2. 设置画布大小 = 你选中区域的大小</span>
canvas.<span class="hljs-property">width</span> = width;
canvas.<span class="hljs-property">height</span> = height;

<span class="hljs-comment">// 3. 把全屏截图的"选中部分"画到画布上</span>
ctx.<span class="hljs-title function_">drawImage</span>(
  fullScreenImage,  <span class="hljs-comment">// 全屏截图</span>
  left, top,        <span class="hljs-comment">// 从哪里开始裁剪（你选中区域的左上角）</span>
  width, height,    <span class="hljs-comment">// 裁剪多大（你选中区域的宽高）</span>
  <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,             <span class="hljs-comment">// 画到画布的哪里（从画布左上角开始）</span>
  width, height     <span class="hljs-comment">// 画多大（填满整个画布）</span>
);

<span class="hljs-comment">// 4. 导出成图片</span>
<span class="hljs-keyword">const</span> croppedImage = canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-string">'image/png'</span>);

</code></pre>
<p><strong>用生活场景类比</strong>：</p>
<ul>
<li>全屏截图 = 拍了一张班级照</li>
<li>你选中的区域 = 你只想要照片里的某个人</li>
<li>Canvas 裁剪 = 用剪刀把那个人剪下来</li>
</ul>
<h4 data-id="heading-29"><strong>步骤 4：四遮罩高亮效果</strong></h4>
<p><strong>问题</strong>：如果只用一个全屏遮罩，选中的区域也会被遮住，用户看不清选了什么。</p>
<p><strong>解决方案</strong>：用 4 个遮罩块围绕选区。</p>
<pre><code class="hljs">┌─────────────────────────────────┐
│    上遮罩（半透明黑色）            │
├──────┬──────────────┬───────────┤
│ 左遮罩│   选区（高亮） │  右遮罩   │
├──────┴──────────────┴───────────┤
│    下遮罩（半透明黑色）            │
└─────────────────────────────────┘

</code></pre>
<p><strong>代码实现</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 创建 4 个遮罩块</span>
<span class="hljs-keyword">const</span> masks = [<span class="hljs-string">'top'</span>, <span class="hljs-string">'right'</span>, <span class="hljs-string">'bottom'</span>, <span class="hljs-string">'left'</span>].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">position</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> mask = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  mask.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
    position: fixed;
    background: rgba(0,0,0,0.5);
    pointer-events: none; /* 不阻挡鼠标事件 */
  `</span>;
  <span class="hljs-keyword">return</span> mask;
});

<span class="hljs-comment">// 根据选区位置更新遮罩块大小</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateMasks</span>(<span class="hljs-params">left, top, width, height</span>) {
  masks[<span class="hljs-number">0</span>].<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> += <span class="hljs-string">`left:0; top:0; width:100vw; height:<span class="hljs-subst">${top}</span>px;`</span>; <span class="hljs-comment">// 上</span>
  masks[<span class="hljs-number">1</span>].<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> += <span class="hljs-string">`left:<span class="hljs-subst">${left+width}</span>px; top:<span class="hljs-subst">${top}</span>px; width:<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.innerWidth-left-width}</span>px; height:<span class="hljs-subst">${height}</span>px;`</span>; <span class="hljs-comment">// 右</span>
  masks[<span class="hljs-number">2</span>].<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> += <span class="hljs-string">`left:0; top:<span class="hljs-subst">${top+height}</span>px; width:100vw; height:<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.innerHeight-top-height}</span>px;`</span>; <span class="hljs-comment">// 下</span>
  masks[<span class="hljs-number">3</span>].<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> += <span class="hljs-string">`left:0; top:<span class="hljs-subst">${top}</span>px; width:<span class="hljs-subst">${left}</span>px; height:<span class="hljs-subst">${height}</span>px;`</span>; <span class="hljs-comment">// 左</span>
}

</code></pre>
<h4 data-id="heading-30">高分屏适配（让图片更清晰）</h4>
<p><strong>问题</strong>：Retina 屏幕（如 MacBook）的像素密度是普通屏幕的 2 倍，如果不处理会导致截图模糊。</p>
<p><strong>解决方案</strong>：乘以设备像素比</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> scale = <span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span> || <span class="hljs-number">1</span>; <span class="hljs-comment">// Retina 屏幕 = 2，普通屏幕 = 1</span>

<span class="hljs-comment">// 设置画布大小时要乘以 scale</span>
canvas.<span class="hljs-property">width</span> = width * scale;
canvas.<span class="hljs-property">height</span> = height * scale;

<span class="hljs-comment">// 裁剪时也要乘以 scale</span>
ctx.<span class="hljs-title function_">drawImage</span>(
  fullScreenImage,
  left * scale, top * scale,     <span class="hljs-comment">// ← 乘以 scale</span>
  width * scale, height * scale, <span class="hljs-comment">// ← 乘以 scale</span>
  <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,
  width * scale, height * scale
);

</code></pre>
<h4 data-id="heading-31">完整流程</h4>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ef6def5a66b46c584a8f038e0b0ff3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764748905&amp;x-signature=Myi4TWTPsH05RTxorW%2B1%2BNqRZNw%3D" alt="image.png" width="30%" loading="lazy"/>
<h2 data-id="heading-32">时序图</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
  participant SP as Sidepanel
  participant CT as Content Script
  participant BG as Background

  SP-&gt;&gt;CT: startAreaCapture
  CT-&gt;&gt;CT: createCaptureUI + 事件绑定
  CT-&gt;&gt;CT: 用户拖拽/更新选区
  CT-&gt;&gt;CT: mouseup → captureSelectedArea
  CT-&gt;&gt;BG: captureVisible
  BG--&gt;&gt;CT: DataURL(整页可见区域)
  CT-&gt;&gt;CT: Canvas 裁剪(考虑 devicePixelRatio)
  CT-&gt;&gt;SP: areaCaptureDone(DataURL)
  SP-&gt;&gt;SP: 预览 + OCR 识别
</code></pre>
<h3 data-id="heading-33">3. 本地上传图片</h3>
<h4 data-id="heading-34">方式一：点击上传</h4>
<p><strong>HTML</strong>：</p>
<pre><code class="hljs language-js" lang="js">&lt;input type=<span class="hljs-string">"file"</span> id=<span class="hljs-string">"uploadInput"</span> accept=<span class="hljs-string">"image/*"</span> style=<span class="hljs-string">"display:none"</span>&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"document.getElementById('uploadInput').click()"</span>&gt;</span>
  📁 上传图片
<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
</code></pre>
<p><strong>JavaScript</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'uploadInput'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> file = e.<span class="hljs-property">target</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">if</span> (!file) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>();
  reader.<span class="hljs-property">onload</span> = <span class="hljs-keyword">async</span> (event) =&gt; {
    <span class="hljs-keyword">const</span> base64 = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>)[<span class="hljs-number">1</span>];
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">recognizeText</span>(base64);
  };
  reader.<span class="hljs-title function_">readAsDataURL</span>(file);
});

</code></pre>
<h4 data-id="heading-35">方式二：拖拽上传</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> dropZone = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'dropZone'</span>);

<span class="hljs-comment">// 1. 阻止默认行为</span>
[<span class="hljs-string">'dragenter'</span>, <span class="hljs-string">'dragover'</span>, <span class="hljs-string">'dragleave'</span>, <span class="hljs-string">'drop'</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">eventName</span> =&gt;</span> {
  dropZone.<span class="hljs-title function_">addEventListener</span>(eventName, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    e.<span class="hljs-title function_">preventDefault</span>();
    e.<span class="hljs-title function_">stopPropagation</span>();
  });
});

<span class="hljs-comment">// 2. 视觉反馈</span>
[<span class="hljs-string">'dragenter'</span>, <span class="hljs-string">'dragover'</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">eventName</span> =&gt;</span> {
  dropZone.<span class="hljs-title function_">addEventListener</span>(eventName, <span class="hljs-function">() =&gt;</span> {
    dropZone.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'drag-over'</span>);
  });
});

<span class="hljs-comment">// 3. 处理文件</span>
dropZone.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'drop'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> file = e.<span class="hljs-property">dataTransfer</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">if</span> (!file.<span class="hljs-property">type</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'image/'</span>)) {
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请上传图片文件！'</span>);
    <span class="hljs-keyword">return</span>;
  }
  
  <span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>();
  reader.<span class="hljs-property">onload</span> = <span class="hljs-keyword">async</span> (event) =&gt; {
    <span class="hljs-keyword">const</span> base64 = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>)[<span class="hljs-number">1</span>];
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">recognizeText</span>(base64);
  };
  reader.<span class="hljs-title function_">readAsDataURL</span>(file);
});

</code></pre>
<p><strong>CSS</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-id">#dropZone</span> {
  <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> dashed <span class="hljs-number">#ccc</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">text-align</span>: center;
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span>;
}

<span class="hljs-selector-id">#dropZone</span><span class="hljs-selector-class">.drag-over</span> {
  <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#4CAF50</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">76</span>, <span class="hljs-number">175</span>, <span class="hljs-number">80</span>, <span class="hljs-number">0.1</span>);
}

</code></pre>
<ul>
<li>作用：把图片拖进上传图片区域 ，拦住浏览器默认行为，在 drop 时读文件并识别或预览。</li>
</ul>
<h3 data-id="heading-36"> 4.页面截图</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> capturePageBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'capturePageBtn'</span>);

capturePageBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> [tab] = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">query</span>({ <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">currentWindow</span>: <span class="hljs-literal">true</span> });
  
  <span class="hljs-keyword">const</span> dataUrl = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">captureVisibleTab</span>(tab.<span class="hljs-property">windowId</span>, {
    <span class="hljs-attr">format</span>: <span class="hljs-string">'png'</span>
  });
  
  <span class="hljs-keyword">const</span> base64 = dataUrl.<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>)[<span class="hljs-number">1</span>];
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">recognizeText</span>(base64);
});
</code></pre>
<p>直接使用chrome插件的截图功能
<strong>权限配置</strong>（manifest.json）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"activeTab"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"tabs"</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-37">5. OCR 识别</h3>
<p>使用腾讯云 OCR API，通过 TC3-HMAC-SHA256 签名调用 <code>GeneralBasicOCR</code> 接口，每月 1000 次免费额度。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 核心调用代码</span>
<span class="hljs-keyword">const</span> ocr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TencentOCR</span>(secretId, secretKey);
<span class="hljs-keyword">const</span> text = <span class="hljs-keyword">await</span> ocr.<span class="hljs-title function_">recognizeText</span>(imageBase64);
</code></pre>
<h2 data-id="heading-38">总结</h2>
<p>这个插件解决了日常浏览网页时的两大痛点：</p>
<ol>
<li><strong>解除限制</strong>：让你自由复制任何内容</li>
<li><strong>OCR 识别</strong>：快速提取图片文字</li>
</ol>
<h3 data-id="heading-39">技术亮点</h3>






























<table><thead><tr><th>技术点</th><th>难点</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>解除限制</strong></td><td>网站多层防护</td><td>五层拦截 + API 劫持</td></tr><tr><td><strong>自选截图</strong></td><td>高分屏模糊</td><td>devicePixelRatio 适配</td></tr><tr><td><strong>拖拽上传</strong></td><td>视觉反馈</td><td>CSS 过渡动画</td></tr><tr><td><strong>OCR 识别</strong></td><td>API 签名</td><td>TC3-HMAC-SHA256</td></tr></tbody></table>
<p>希望这个插件能帮到大家！如果有问题或建议，欢迎在评论区交流～</p>
<h2 data-id="heading-40">🔗 相关链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fextensions%2F" target="_blank" title="https://developer.chrome.com/docs/extensions/" ref="nofollow noopener noreferrer">Chrome Extension 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F866" target="_blank" title="https://cloud.tencent.com/document/product/866" ref="nofollow noopener noreferrer">腾讯云 OCR 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FCanvas_API" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API" ref="nofollow noopener noreferrer">Canvas API 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FHTML_Drag_and_Drop_API" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_Drag_and_Drop_API" ref="nofollow noopener noreferrer">Drag and Drop API</a></li>
</ul>
<blockquote>
<p>本插件仅供学习交流使用，请遵守以下原则：</p>
<ol>
<li><strong>合法使用</strong>：请勿用于商业用途或侵犯他人知识产权</li>
<li><strong>尊重版权</strong>：遵守网站服务条款</li>
</ol>
<p>如果觉得对您有帮助，欢迎点赞 👍 收藏 ⭐ 关注 🔔 支持一下！</p>
<p><strong>往期实战推荐：</strong></p>
<ul>
<li>
<p><a href="https://juejin.cn/post/7549096640340426802" target="_blank" title="https://juejin.cn/post/7549096640340426802">Vue3 后台分页写腻了？我用 1 个 Hook 删掉 90% 重复代码（附源码）</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7511332054941188147" target="_blank" title="https://juejin.cn/post/7511332054941188147">⚡ 一个Vue自定义指令搞定丝滑拖拽列表，告别复杂组件封装
</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7543806966926802971" target="_blank" title="https://juejin.cn/post/7543806966926802971">🔥 这才是 Vue 驱动的 Chrome 插件工程化正确打开方式</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7566299971643424819" target="_blank" title="https://juejin.cn/post/7566299971643424819">  老板问我：AI真能一键画广州旅游路线图？我用 MCP 现场开图</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7559124639323242506" target="_blank" title="https://juejin.cn/post/7559124639323242506">【前端效率工具】：告别右键另存，不到 50 行代码一键批量下载网页图片</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7561612065707065390" target="_blank" title="https://juejin.cn/post/7561612065707065390"> 女朋友炸了：刚打开的网页怎么又没了？我反手甩出一键恢复按钮！</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7562859113246343178" target="_blank" title="https://juejin.cn/post/7562859113246343178"> 你家孩子又偷玩网页游戏? 试试这个防沉迷工具</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7563830723057647643" target="_blank" title="https://juejin.cn/post/7563830723057647643">  她说想要浪漫，我把浏览器鼠标换成了柴犬，点一下就有烟花（附源码）</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7566677296801071155" target="_blank" title="https://juejin.cn/post/7566677296801071155"> 女朋友被链接折磨疯了，我写了个工具一键解救</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7568055953310662707" target="_blank" title="https://juejin.cn/post/7568055953310662707"> 上班摸鱼看掘金，老板突然出现在身后...</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7570984257666056238" target="_blank" title="https://juejin.cn/post/7570984257666056238"> 【前端效率工具】再也不用 APIfox 联调！零侵入 Mock，全程不改代码、不开代理</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7573521516324732955" target="_blank" title="https://juejin.cn/post/7573521516324732955"> 大部分人都错了！这才是chrome插件多脚本通信的正确姿势</a></p>
</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO 正式发布了？我用它将像老乡鸡那样做饭小程序开源了！]]></title>    <link>https://juejin.cn/post/7576210031873409065</link>    <guid>https://juejin.cn/post/7576210031873409065</guid>    <pubDate>2025-11-25T02:46:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576210031873409065" data-draft-id="7576181242582630463" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO 正式发布了？我用它将像老乡鸡那样做饭小程序开源了！"/> <meta itemprop="keywords" content="前端,Trae,AI编程"/> <meta itemprop="datePublished" content="2025-11-25T02:46:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不如摸鱼去"/> <meta itemprop="url" content="https://juejin.cn/user/26044011388510"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO 正式发布了？我用它将像老乡鸡那样做饭小程序开源了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/26044011388510/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不如摸鱼去
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T02:46:27.000Z" title="Tue Nov 25 2025 02:46:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    172
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是不如摸鱼去，欢迎来到我的 AI 编程分享专栏。</p>
<p>一个月前我发布的一篇文章<a href="https://juejin.cn/post/7554225547117576243" target="_blank" title="https://juejin.cn/post/7554225547117576243">【老乡鸡也开源？我用 Trae SOLO 做了个像老乡鸡那样做饭小程序！】</a>，记录了作为一名爱做饭的程序员的我，使用 TRAE SOLO 快速构建了一个像老乡鸡那样做饭小程序的过程，应朋友们的要求，趁着 TRAE SOLO 正式发布，用它把这个小程序开源了。</p>
<h2 data-id="heading-0">TRAE SOLO 正式版</h2>
<p>11 月 12 日 TRAE SOLO 正式版上线了，新增三栏布局、DiffView 工具、SOLO Coder + Plan，支持多任务并行等功能，并上线了免费体验活动，人人都可以用 SOLO 了。</p>
<p>我可是 TRAE SOLO 老用户了，SOLO 模式（Beta 版）上线的时候我就拿到了 SOLO CODE，并且使用它完成了「复刻童年坦克大战」、「像老乡鸡那样做饭小程序」等实践，并且在实际工作中使用 TRAE 参与了很多任务的开发。如今正式版发布，自然不能错过。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4584916d38934f7e8e12a6e01b47e51d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=TLpMojBXj3XBaDhXyee5K0EOW%2B8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">像老乡鸡那样做饭</h2>
<p>一切都源自于老乡鸡发布的《老乡鸡菜品溯源报告》，<code>CookLikeHOC</code>是一个拥有 22k 星星的 GitHub 仓库，它收录了《老乡鸡菜品溯源报告》中公布的所有菜品。</p>
<h2 data-id="heading-2">技术栈</h2>
<p>我们延续上篇文章选择好的技术栈，这样 AI 可以在我们规划好的路线上进行开发，可以达到事半功倍的效果。</p>
<h3 data-id="heading-3">前端技术栈</h3>
<p>因为我本身就是一个前端程序员，所以前端技术栈比较熟，直接选择常用的技术栈：</p>
<ul>
<li>小程序的开发框架: uni-app</li>
<li>开发模板项目: wot-starter 地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fstarter.wot-ui.cn%2F" target="_blank" title="https://starter.wot-ui.cn/" ref="nofollow noopener noreferrer">starter.wot-ui.cn/</a></li>
<li>组件库: wot-ui 地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwot-ui.cn%2F" target="_blank" title="https://wot-ui.cn/" ref="nofollow noopener noreferrer">wot-ui.cn/</a></li>
</ul>
<h3 data-id="heading-4">后端技术栈</h3>
<p>服务端仍然选择 TRAE SOLO 集成的 Supabase 作为我们的云端服务。</p>
<h2 data-id="heading-5">开始SOLO</h2>
<p>我们之前已经搭建好小程序的基础页面了，现在可以开始优化部分功能整理开发阶段的 SQL 和脚本以便将小程序开源了。</p>
<h3 data-id="heading-6">优化 UI 样式</h3>
<blockquote>
<p>这里我们全程使用 SOLO Coder 模式，因为它更适合解决复杂编程问题。</p>
</blockquote>
<p>更新首页分类展示，支持展示全部分类。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b8993eceada4be5bc69bd61fd4a5838~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=m%2FPn4HU0c8M5WkiLefbFz4RkiHA%3D" alt="" loading="lazy"/></p>
<p>可以使用 DiffView 功能查看更新内容</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70a474beefac4f31a37350af42a44c16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=V16kAPUDrJlO8tUOHZcDaNLj0eo%3D" alt="" loading="lazy"/></p>
<p>更新后效果如下，使用 swiper 展示分类，支持左右滑动切换展示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6853318dd74e4aebac5ea01b4beba92f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=NyA%2B8qJigZi2Xc4l2kDiMawUCuA%3D" alt="" loading="lazy"/></p>
<p>同时我使用 即梦AI 给不同分类生成了个可爱的图标，非常简单的提示词。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d975f61a10304aecbd61f80e804dd397~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=%2FvCekxtsx85pqIwZ5Z1QR6BLIxc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">优化数据取值</h3>
<p>打开 TRAE SOLO 模式，可以在这里找到“集成”功能
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee498491217b4596b3d9d71244a5bd70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=%2BPEuy2a6RUgLk%2Bi3XKCBVdPV7lE%3D" alt="" loading="lazy"/></p>
<p>需要注意的是，我们在使用“集成”功能时，最好切换到 SOLO Builder 模式，因为在这个模式下才有“集成”功能，下图是 SOLO Coder 和 SOLO Builder 的区别：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43e0f0c378344ab79ae856060ad2178a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=0S0w0DcQnD%2B0pd3AqpbWMygfa0c%3D" alt="" loading="lazy"/></p>
<p>进入“集成”功能，选择连接我们的 supbase。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20f438517539486a927246697f802626~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=XTpHq0%2BYBbEKmTjp8OnbdUSZp%2B4%3D" alt="" loading="lazy"/></p>
<p>优化首页展示每日推荐菜谱的逻辑，每天随机从每个分类中查询 2 道菜展示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aebc2295121b4eb2ae0d587376fd0ceb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=qucpO5vrAWfjzXER08CC%2BoICQ9M%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88d91a6e88b344a9bdbe37e815604be9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=MsqbtMg%2Fj2wwFZ%2Fe5jQbNLl5e5A%3D" alt="" loading="lazy"/></p>
<p>优化菜谱详情页面相关推荐的逻辑，当前菜谱的相同分类中随机推荐五道菜。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/156b0d6199a64c728c790c05ae19b774~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=hinl4KG0O9dHNpcXml9av%2F5C%2BCM%3D" alt="" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d7c2f09b4a0467497e166b77d0e811f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=S5XY0OFa6ALygVmPZuSu0t87bzI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">整理脚本并开源</h3>
<p>由于这个改动涉及文件多，改动大，所以这里我们要在 SOLO Coder 下开启 plan 模式，让 TRAE 提前给出计划，我们确认后再由 TRAE 进行开发。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5e9076d234c4ae3aa3474c1b7615116~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=McOKK0g6SY7Ihaz%2BjTIbJh9co3M%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a4ed207aac84810902c68e54f5367be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=i4eq8mRXz6ulLrtSCiu4pGwB7Qs%3D" alt="" loading="lazy"/></p>
<p>我们仔细看一下 SOLO Coder 的方案，没有问题就让它开始执行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bf0d032e47c4bf3b48e780480306063~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=7%2B1TC%2BgIVd%2BCirrwMml2IMCXXLA%3D" alt="" loading="lazy"/></p>
<p>SOLO Coder 执行完毕后，我们点击查看变更，使用 DiffView 功能检查变更文件，判断 SOLO 执行是否正确。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b48b1c8323794644b92b90f592cbe5dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=1HJ7ccJmuonIqxLMwFaEj4c7H80%3D" alt="" loading="lazy"/></p>
<p>需要注意的是，如果你的操作需要操作数据库，可以切换到 SOLO Builder 模式，让它协助操作，建表、执行SQL、获取 supbase 配置，它都可以胜任。</p>
<h3 data-id="heading-9">配置CI/CD</h3>
<p>我们使用 uni-mini-ci 完成本小程序的 CI/CD持续集成，小程序一键部署不再是梦，这里就不贴完整的 GitHub Action 代码了，大家可以小程序的 GitHub 仓库中看。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/866febb66aa94aa4aa33e9fd1dad0fa2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=dBE1VUe86LNombeHW5veWLJIg8Q%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54cb9ff2f40444e0aa7940faeef6c1b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=HJ4GBMK6SFaSsNoVuY%2BNQ2Ub7sc%3D" alt="" loading="lazy"/></p>
<p>将 GitHub Action 配置文件推送到 GitHub 上，就可以按照下图操作进行手动发版，当然也可以通过打 tag 触发发版，发版执行会将代码推送到微信小程序后台。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbb678aac5e3427d9329e9997acf4a1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=DFMBEHRk9%2F1ICuvyHhzxl9PpeaM%3D" alt="" loading="lazy"/></p>
<p>我们可以在微信小程序后台看到对应的开发版本：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea6f6297bea543ec870916263ae1f315~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=Ey4cw2WZ5jVEfvDzPs3iuNa1lTw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">完整效果</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a25e26f54ce44f65a149ecd4085a419d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=pCw1tyb0Yfv4VNZz%2Fk9%2BT9aj8Qo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a76c41632884997a3c38078fd49b09f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=TMIiRJfc1a%2Fm%2Fi%2B%2BWaJlr08y5XQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20963583d96947379c373efe8e9dedd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764650998&amp;x-signature=%2Fg6TuenSlLN5el0uySNaMwVhXbQ%3D" alt="" loading="lazy"/></p>
<p><em><strong>也可以自行搜索「鱼哥菜谱」进行体验</strong></em></p>
<h2 data-id="heading-11">TRAE SOLO 正式版体验</h2>
<p>TRAE SOLO 正式版新增了 Plan 模式和 SOLO Coder 等，对编程体验的提升很大，减少了很多 AI 介入后的善后工作。不过失去 Claude 仍对其能力造成了不小的影响，期待后续可以在 SOLO 模式集成强大的 Gemini 3 和优秀的国产模型 GLM 等，IDE 与模型 2 者是相辅相成的。</p>
<h2 data-id="heading-12">总结</h2>
<p>我们几乎零代码 用 Trae SOLO 完成了「像老乡鸡那样做饭」小程序的开源与 CI/CD 流程，过程中保持数据干净、纯净上下文、增量式沟通等三个原则仍然是使我们事半功倍的利器，这其实和当下很流行的 SDD 规范相符，在这种小型项目中，基于一个优秀的项目模板和良好的需求输入和开发计划，由规范驱动开发，能让项目做的更好、走得更远。</p>
<p>好了，实现这个小程序后，大家也可以像老乡鸡那样做饭了！</p>
<h2 data-id="heading-13">参考资料</h2>
<ul>
<li>小程序：「鱼哥菜谱」</li>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMoonofweisheng%2FMyCookLikeHOC" target="_blank" title="https://github.com/Moonofweisheng/MyCookLikeHOC" ref="nofollow noopener noreferrer">github.com/Moonofweish…</a></li>
<li>CookLikeHOC：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGar-b-age%2FCookLikeHOC" target="_blank" title="https://github.com/Gar-b-age/CookLikeHOC" ref="nofollow noopener noreferrer">github.com/Gar-b-age/C…</a></li>
<li>项目模板：<a href="https://link.juejin.cn?target=https%3A%2F%2Fstarter.wot-ui.cn%2F" target="_blank" title="https://starter.wot-ui.cn/" ref="nofollow noopener noreferrer">starter.wot-ui.cn/</a></li>
</ul>
<p><em><strong>欢迎评论区沟通、讨论👇👇</strong></em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌新论文：为什么当前 AI 无法在训练后继续学习？]]></title>    <link>https://juejin.cn/post/7576181242582892607</link>    <guid>https://juejin.cn/post/7576181242582892607</guid>    <pubDate>2025-11-25T03:15:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576181242582892607" data-draft-id="7576212547235135531" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌新论文：为什么当前 AI 无法在训练后继续学习？"/> <meta itemprop="keywords" content="前端,AIGC,人工智能"/> <meta itemprop="datePublished" content="2025-11-25T03:15:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌新论文：为什么当前 AI 无法在训练后继续学习？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:15:24.000Z" title="Tue Nov 25 2025 03:15:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>相信大家都经历过这样的疑惑，在使用 AI 的过程中，为什么我明明都纠正过它的问题，但是它下次还是依然会犯同样的错误，以至于我们不得不针对性写大量的规则来约束整个 Vibe Coding 的过程。</p>
<blockquote>
<p>但是就算有详细的 rule ，有些倔强的模型依然喜欢我行我素，比如 Gemini 3 Pro 就容易出现， <strong>写的太详细的 prompt ，效果居然不如模糊的</strong>，你纠正他，他会先肯定你，然后说还是该按照我的来····</p>
</blockquote>
<h2 data-id="heading-0">问题</h2>
<p>谷歌这次公布的论文很直观的解释了这个问题：<strong>因为大模型无法在训练后继续学习</strong> ，论文把当前的大型语言模型（LLM）被比作患有 <strong>“顺行性遗忘症”（Anterograde Amnesia）</strong> 的病人 ，这种病人只能保留发病前的长期记忆，无法形成新的长期记忆，只能依靠短暂的短期记忆生活。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/369b747e84a34869b11b90b1b06394a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645324&amp;x-signature=SPT%2BjNorfMdl%2FlkYebROM39BP90%3D" alt="image-20251125103150345" loading="lazy"/></p>
<p>具体可以解释为以下三点：</p>
<h3 data-id="heading-1">A. “数字失忆症”：只有两极，没有中间态</h3>
<p>目前的模型只有两种记忆状态，中间存在巨大的断层：</p>
<ol>
<li><strong>极快且短暂的记忆</strong>（In-Context Learning）： 也就是你的 <code>Prompt</code> 或上下文窗口，这部分通过注意力机制（Attention）处理，更新极快，但这只是“临时的”，一旦窗口关闭或超出长度，信息就消失了 ，这也是为什么它并能吸取你的教训的原因</li>
<li><strong>冻结的长期记忆（Pre-trained Weights）：</strong> 对应的是模型的 <code>MLP</code> 层（参数），这部分是在预训练阶段通过海量数据“固化”下来的，一旦部署了，这些参数就是静态的，无法更改 。</li>
</ol>
<p>而目前的问题在于：当前模型缺乏将“即时对话”转化为“长期参数”的机制，也就是它们缺乏中间的频谱：<strong>那些应该从短期逐渐变为长期的记忆</strong>。</p>
<h3 data-id="heading-2">B. 维度单一：只堆叠了“深度”，忽略了“时间”</h3>
<p>在论文里，传统的“深度学习”主要关注堆叠更多的层（Depth）来增加容量 ，但这一维度是静态的。</p>
<p>研究人员发现<strong>真正的学习需要正交的另一个维度：时间（或频率）</strong> ，大脑并不是以统一的速度更新所有神经元的，而是以不同的频率（脑波）运作，而目前的 LLM 就像是一个强制所有楼层都静止不动的建筑，只有最顶层的“接待处”（Context）在工作。</p>
<h3 data-id="heading-3">C. 优化器与架构的分离</h3>
<p>在传统深度学习中，<strong>架构</strong>（如 Transformer）和<strong>优化器</strong>（如 Adam）被看作是两个独立的东西，架构负责推理，优化器负责在训练时更新参数。</p>
<p>而论文的颠覆性观点是： 优化器本质上也是一种<strong>联想记忆模块（Associative Memory）</strong> ，目前的模型在部署后丢弃了优化器，导致它们失去了“自我修改”和“压缩梯度”的能力，从而失去了学习能力。</p>
<h2 data-id="heading-4">解决办法</h2>
<p>为了解决这个问题，谷歌提出了一种新的范式，不再把模型看作一个扁平的神经网络，而是看作<strong>一组嵌套的优化问题</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/412bd2c859c6487a995362d8eb2bc841~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645324&amp;x-signature=GbFVHZaKtmRueCmIGPhwLQiTjnY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">A. 核心理念：连续记忆频谱 (Continuum Memory System)</h3>
<p>就像人类大脑有不同频率的脑波（Delta波、Theta波、Alpha波等）分别负责不同层级的记忆整合一样 ，模型也应该有不同更新频率的组件。</p>
<ul>
<li>
<p><strong>传统模型：</strong> 频率只有 0 （冻结的参数）和 ♾️（极快的 Attention）。</p>
</li>
<li>
<p><strong>嵌套学习模型：</strong> 创建一个：</p>
<ul>
<li><strong>Level 1 (极快):</strong> 处理当前的 Token。</li>
<li><strong>Level 2 (中等):</strong> 每隔 16 个 Token 更新一次，捕捉短期上下文</li>
<li><strong>Level 3 (慢速):</strong> 每隔 100万 Token 更新一次，捕捉长期知识</li>
<li><strong>Level 4 (极慢):</strong> 类似目前的预训练知识</li>
</ul>
</li>
</ul>
<p>例如，左图（Deep Learning）展示了通常理解的深度学习模型（如 RNN + Attention），是一个扁平的序列 ，这种视角隐藏了内部的梯度流动 。</p>
<p>而右图（Neural Learning Module）：*是论文的核心视角，它将模型看作一个个<strong>嵌套的立方体</strong>，每一个立方体代表一个“优化问题” ，从而实现不同 Level 的连续频谱，每一层都有自己的梯度流（Gradient Flow）和更新目标。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28937766376b45368aa2ef073529650e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645324&amp;x-signature=7yBZTFJmwdmXzYOvjKLLhmvhF3o%3D" alt="" loading="lazy"/></p>
<p>也就是 <strong>“层（Layer）”不仅仅是空间的堆叠，而是时间上的嵌套</strong>，解释了为什么模型应该包含“内部优化器”：即模型在推理时，内部的小盒子应该在不断自我优化。</p>
<h3 data-id="heading-6">B. 新架构：HOPE (Self-Modifying Titans + Continuum Memory)</h3>
<p>论文作者提出了 <strong>HOPE</strong> 的具体实现模型，它结合了两个关键技术：</p>
<ol>
<li>自我修改的 Titans** (Self-Modifying Titans)</li>
</ol>
<p>模型不再依赖外部的优化器（如 Adam）来告诉它如何更新，而是学习如何修改自己，模型内部包含了一个“学习模块”，它能在运行时计算梯度并更新自己的参数，这意味着模型在和你对话的过程中，实际上在微调它自己的部分结构</p>
<ol start="2">
<li>多级 MLP 系统</li>
</ol>
<p>HOPE 使用了一系列嵌套的 MLP（多层感知机）块，每个块有不同的“块大小”（Chunk Size）和更新频率：</p>
<ul>
<li>有些层更新得很快，负责记住刚才的对话</li>
<li>有些层更新得很慢，负责沉淀知识</li>
</ul>
<p>组合起来，就构成了“梯度记忆曲线” 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc5b0a9cccc041b0b6468a03185b4a0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645324&amp;x-signature=pBDlZP47djcKi1OWHewdrYZ0aqA%3D" alt="" loading="lazy"/></p>
<p>对比 Transformer 的极端频率，可以看出来 HOPE (左侧)这是一个连续的频谱，</p>
<ul>
<li>High Frequency FFN：块大小（Chunk Length）为 16，更新频率高 。</li>
<li>Mid Frequency FFN：块大小为 1M（一百万），更新频率中等。</li>
<li>Low Frequency FFN：更新极慢 。</li>
</ul>
<p>从而解决“无法继续学习”的问题，展示了如何填补“短期记忆”和“长期记忆”之间的空白，创建了不同速率的记忆层级。</p>
<h3 data-id="heading-7">C. 深度优化器 (Deep Optimizers)</h3>
<p>论文证明了动量梯度下降（Momentum SGD）本质上是一个 2 级的联想记忆系统 ，HOPE 利用这一发现，设计了更具表达能力的优化器，使其成为模型本身的一部分，而不是训练完就扔掉的工具。</p>
<h2 data-id="heading-8">实验结果与意义</h2>
<p>在实验中，HOPE 模型（760M 和 1.3B 参数量）在语言建模和常识推理任务上，<strong>击败了同等规模的 Transformer++、RetNet 和 Mamba (Titans)</strong> ， 更重要的是它展示了更低的困惑度（Perplexity），证明了这种“动态更新”机制的有效性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6b22fce82bb4efb87493f8830614f4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764645324&amp;x-signature=BoT%2BDUA%2BYoU2s2x8fx2pifdNY%2FI%3D" alt="" loading="lazy"/></p>
<p>另外论文的意义不仅仅在于提出了一个新模型，而在于它挑战了“深度学习”这个名字本身 ：</p>
<ul>
<li><strong>从“深度”到“嵌套”：</strong> 未来的 AI 竞争可能不再单纯是堆叠层数和参数规模（Scale），而是设计更合理的<strong>时间更新频率（Time/Frequency）</strong></li>
</ul>

<ul>
<li><strong>终身学习 (Lifelong Learning)：</strong> 如果 HOPE 架构被规模化，也许可以会看到真正的“养成系” AI，它不会在发布那天就停止成长，而是通过每一次交互，将信息从短期记忆逐渐渗透到长期记忆中，真正解决“灾难性遗忘”和“无法持续学习”的痛点。</li>
</ul>
<p>总结起来，之前的 ChatGPT 和 Gemini 像是一个只有“此时此刻”和“出厂设置”的机器；而 Google 提出的 HOPE 架构，试图赋予 AI “从此刻走向永恒”的记忆能力，让模型在运行中通过自我修改来持续进化。</p>
<blockquote>
<p>而实际上对应之前 Deepseek 利用图片来压缩记忆的实现，也是在记忆时效性上的探索。</p>
</blockquote>
<h2 data-id="heading-9">最后</h2>
<p><strong>从这个角度看，能“吃一堑长一智”的 AI 也许离我们就不远了</strong>，不过可以猜测，这种实现也有这相应的局限性问题需要处理，例如 HOPE 架构的核心在于“模型在推理过程中修改自己” ，这意味着它不能像传统 Transformer 那样只进行简单的矩阵乘法，还需要进行梯度的计算和参数更新，也就是：</p>
<ul>
<li>更多的性能开销，例如额外的 MLP 运算和实时梯度计算</li>
<li>更多的内存占用，比如 HOPE 需要存储“优化器状态” 和管理状态大小</li>
<li>HOPE 要求参数在 <code>Forward</code> 过程中动态变化 ，这种“自我修改”的代码实现难度大，且难以利用现有的底层 Kernel 优化</li>
<li>多嵌套下的梯度流管理和独立问题</li>
<li>·····</li>
</ul>
<blockquote>
<p>最后，本文解读主要参考 Gemini 分析。</p>
</blockquote>
<h2 data-id="heading-10">原文链接</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fabehrouz.github.io%2Ffiles%2FNL.pdf" target="_blank" title="https://abehrouz.github.io/files/NL.pdf" ref="nofollow noopener noreferrer">abehrouz.github.io/files/NL.pd…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[这 5 个冷门的 HTML 标签，能让你少写 100 行 JS]]></title>    <link>https://juejin.cn/post/7576468602304495654</link>    <guid>https://juejin.cn/post/7576468602304495654</guid>    <pubDate>2025-11-25T07:38:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576468602304495654" data-draft-id="7576378563574808591" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="这 5 个冷门的 HTML 标签，能让你少写 100 行 JS"/> <meta itemprop="keywords" content="前端,JavaScript,HTML"/> <meta itemprop="datePublished" content="2025-11-25T07:38:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            这 5 个冷门的 HTML 标签，能让你少写 100 行 JS
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T07:38:13.000Z" title="Tue Nov 25 2025 07:38:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9406a89e16ac4345bc2ecc9958596ff6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764661092&amp;x-signature=HKGQlG4tuN2%2BMq1ZIfmDADVmuDU%3D" alt="image.png" loading="lazy"/></p>
<p>大家好!😁。</p>
<p>Code Review 的时候，我最怕看到什么？</p>
<p>不是复杂的算法，也不是什么正则。而是<strong>明明一个 HTML 标签就能搞定的事，有人非要写几百行 JS + CSS 去重新发明轮子</strong> 。</p>
<p>前几天，我看到一个新同学为了写一个折叠面板（Accordion），引入了一个重型的第三方库，还写了一堆 <code>useState</code>、<code>onClick</code> 和动画逻辑。</p>
<p>我默默地把他的代码全删了，换成了 3 行 <code>&lt;details&gt;</code>。他看我的眼神，仿佛在看一个外星人🤣。</p>
<p>在 2025 年的今天，浏览器原生 HTML 的能力早已今非昔比。很多我们习惯用 JS 去模拟的交互，现在不仅有原生支持，而且<strong>性能更好、兼容性更强、无障碍（a11y）更完善</strong>。</p>
<p>今天，我就来盘点 5 个被严重低估的HTML标签👇。</p>
<hr/>
<h3 data-id="heading-0"><strong><code>&lt;details&gt;</code> &amp; <code>&lt;summary&gt;</code>：折叠组件</strong></h3>
<p>你是不是还在写这样的 React 代码？</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// JS 模拟版</span>
<span class="hljs-keyword">const</span> [isOpen, setIsOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"accordion"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"header"</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsOpen(!isOpen)}&gt;
      点击展开 {isOpen ? '⬆️' : '⬇️'}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    {isOpen &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"content"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
</code></pre>
<p>为了这个功能，你还得写 CSS 动画，还得处理键盘事件（Tab 键能不能选到？回车能不能展开？等等）。</p>
<p><strong>HTML 原生写法：</strong></p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">details</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">summary</span>&gt;</span>点击展开<span class="hljs-tag">&lt;/<span class="hljs-name">summary</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>
    这里是展开后的内容，原生支持 Ctrl+F 页内搜索！
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">details</span>&gt;</span>
</code></pre>
<ol>
<li><strong>没有任何JS</strong>：自带点击展开/收起交互。</li>
<li><strong>无障碍（a11y）满分</strong>：屏幕阅读器能完美识别，Tab 键、回车键原生支持。</li>
<li><strong>页内搜索</strong>：这是 JS 模拟版最大的痛点。如果内容被 JS 隐藏了（<code>display: none</code>），浏览器的 Ctrl+F 往往搜不到。但 <code>&lt;details&gt;</code> 里的内容，即使折叠，浏览器也能搜到并自动展开！</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9c863dafadc46c4a208d26d6b5641f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764661092&amp;x-signature=vMtXW6eygD%2FdQTk35yZ4ndeH5vI%3D" alt="Untitled ‑ Made with FlexClip.gif" loading="lazy"/></p>
<p>配合 CSS 👇</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">details</span> {
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-tag">summary</span> {
  <span class="hljs-attribute">cursor</span>: pointer;
  <span class="hljs-attribute">font-weight</span>: bold;
}

<span class="hljs-comment">/* 包住内容，让它能动画高度 */</span>
<span class="hljs-selector-tag">details</span> &gt; <span class="hljs-selector-class">.content</span> {
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">max-height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">transition</span>: max-height .<span class="hljs-number">45s</span> ease, opacity .<span class="hljs-number">3s</span> ease;
}

<span class="hljs-comment">/* details 处于 open 状态时 */</span>
<span class="hljs-selector-tag">details</span><span class="hljs-selector-attr">[open]</span> &gt; <span class="hljs-selector-class">.content</span> {
  <span class="hljs-attribute">max-height</span>: <span class="hljs-number">200px</span>; <span class="hljs-comment">/* 你内容高度大概多少设多少，足够大即可 */</span>
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
}
</code></pre>
<p>依然可以做动画。</p>
<hr/>
<h3 data-id="heading-1"><strong><code>&lt;dialog&gt;</code>：弹窗组件</strong></h3>
<p>写模态框（Modal）是前端最大的坑之一。你需要考虑：</p>
<ul>
<li><code>z-index</code> 层级会不会被遮挡？</li>
<li>点击遮罩层关闭？</li>
<li><strong>Focus Trap（焦点锁定）</strong> ：打开弹窗后，Tab 键不能跑到底层页面去。</li>
<li>按下 <code>Esc</code> 键关闭？</li>
</ul>
<p>为了解决这些，我们通常会引入 <code>Antd Modal</code> 或者 <code>React Portal</code>。但在轻量级场景下，原生 <code>&lt;dialog&gt;</code> 才是神🫅。</p>
<p><strong>HTML 原生：</strong></p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">dialog</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"myModal"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"dialog"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个原生模态框<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>关闭（自动）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dialog</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"myModal.showModal()"</span>&gt;</span>打开弹窗⏏<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ae231b2a4af4c8694ff5a0843a5747d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764661092&amp;x-signature=Oi6OWEl7QtlHnfEpPS3hwJBmyrw%3D" alt="Untitled ‑ Made with FlexClip.gif" loading="lazy"/></p>
<ol>
<li><strong>Top Layer（顶层特性）</strong> ：浏览器会把它渲染在所有 DOM 的最上层，<strong>彻底无视</strong>父元素的 <code>z-index</code> 和 <code>overflow: hidden</code>。</li>
<li><strong>::backdrop 伪元素</strong>：直接用 CSS 定制遮罩层样式。</li>
</ol>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 背景遮罩 */</span>
dialog<span class="hljs-selector-pseudo">::backdrop</span> {
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.45</span>);
    backdrop-<span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">3px</span>);
    <span class="hljs-attribute">transition</span>: opacity .<span class="hljs-number">3s</span> ease;
}
</code></pre>
<ol start="3">
<li><strong>原生交互</strong>：自带 <code>Esc</code> 关闭，自带焦点管理，表单提交自动关闭。</li>
</ol>
<hr/>
<h3 data-id="heading-2"><strong><code>&lt;datalist&gt;</code>：搜索自动补全</strong></h3>
<p>当产品经理要求做一个带搜索建议的输入框时，你的第一反应是不是：“快！引入 <code>Select2</code> 或者 <code>Antd AutoComplete</code>！😖</p>
<p>且慢。如果只是简单的建议列表，几 KB 的 JS 库都显得太重了。</p>
<p><strong>HTML 原生版：</strong></p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>选择你喜欢的框架：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">list</span>=<span class="hljs-string">"frameworks"</span> /&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">datalist</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"frameworks"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"React"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Vue"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Svelte"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Angular"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Solid"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">datalist</span>&gt;</span>
</code></pre>
<ol>
<li><strong>模糊搜索</strong>：浏览器原生支持模糊匹配（打 u 会出来 Vue）。</li>
<li><strong>响应式</strong>：在手机上，它会调用系统原生的下拉选择 UI，体验比网页模拟的更顺滑。</li>
<li><strong>解耦</strong>：它只是一个建议列表，用户依然可以输入列表里没有的值（这点和 Select 不同）。</li>
</ol>
<hr/>
<h3 data-id="heading-3"><strong><code>&lt;fieldset&gt;</code> &amp; <code>disabled</code>：一键禁用整个表单</strong></h3>
<p><strong>场景</strong>：用户点击提交按钮后，为了防止重复提交，我们需要<strong>禁用表单里的所有输入框</strong>。</p>
<p><strong>JS 笨办法：</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 还要一个个去拿 DOM，或者维护一个 loading 状态传给所有组件</span>
inputs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">input</span> =&gt;</span> input.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>);
buttons.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">btn</span> =&gt;</span> btn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>);
</code></pre>
<p><strong>HTML 原生写法：</strong></p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">fieldset</span> <span class="hljs-attr">disabled</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"login-group"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">legend</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">legend</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"用户名"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"密码"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">fieldset</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// 一行代码搞定状态切换</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'login-group'</span>).<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>; 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d86311c7162b449d9e6b77c5e87b4af3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764661092&amp;x-signature=GIo5a4J0SdBaWGlymX6COE7iqjU%3D" alt="clideo_editor_c3a7f45a392f482ea0added4098a5be3.gif" loading="lazy"/></p>
<p>这是一个极好的<strong>分组</strong>思维。通过给 <code>&lt;fieldset&gt;</code> 设置 <code>disabled</code>，浏览器会自动禁用内部所有的 <code>&lt;input&gt;</code>, <code>&lt;select&gt;</code>, <code>&lt;button&gt;</code>。不用写循环，不用维护复杂的 State。</p>
<hr/>
<h3 data-id="heading-4"><strong><code>&lt;input type="file" capture&gt;</code>：H5 调用手机相机</strong></h3>
<p><strong>场景</strong>：业务需要用户上传一张照片，可以是相册选的，也可以是<strong>当场拍的</strong>。</p>
<p>很多新手的反应是：是不是要接微信 JSSDK？是不是要写个 Bridge 调原生 App 能力？</p>
<p><strong>答案是不需要！</strong></p>
<p><strong>HTML 原生：</strong></p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">capture</span>=<span class="hljs-string">"environment"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/*"</span>&gt;</span>
</code></pre>
<p>只要加上 capture 属性，在移动端（iOS/Android）点击上传时，系统会直接拉起相机，而不是让你去选文件。拍完照后，你拿到的就是一个标准的 File 对象。</p>
<p>不需要什么 JS SDK，实现原生级体验👍。</p>
<hr/>
<p>我总是强调 <strong>最好的代码，是没有代码！</strong></p>
<p>HTML 标准一直在进化，很多曾经需要重型 JS 才能实现的功能，现在已经成了浏览器的出厂设置了。</p>
<p>使用这些原生标签，不仅能减少打包体积，更能让你的应用在<strong>可访问性</strong>和<strong>性能</strong>上天然领先。</p>
<p>下次再想 <code>npm install</code> 一个 UI 库之前，先查查 MDN。说不定，HTML 早就帮你做好了🤔。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[UI小姐姐要求有“Duang~Duang”的效果怎么办？]]></title>    <link>https://juejin.cn/post/7576264484688379944</link>    <guid>https://juejin.cn/post/7576264484688379944</guid>    <pubDate>2025-11-25T05:51:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576264484688379944" data-draft-id="7573950036897087528" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="UI小姐姐要求有“Duang~Duang”的效果怎么办？"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-25T05:51:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端九哥"/> <meta itemprop="url" content="https://juejin.cn/user/3659622444970574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            UI小姐姐要求有“Duang~Duang”的效果怎么办？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3659622444970574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端九哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T05:51:59.000Z" title="Tue Nov 25 2025 05:51:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9456ab9014694573909de2733acc5b69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Lmd5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764654719&amp;x-signature=w4sPNHGfhJ%2Bv0Xhu3jDr%2BmOaPz0%3D" alt="test.gif" loading="lazy"/></p>
<blockquote>
<p><strong>设计小姐姐</strong>：  “搞一下这样的<strong>回弹</strong>效果，你行不行？”<br/>
<strong>我</strong>：“行！直接梭哈 50 行 keyframes + transform + 各种百分比，搞定 ”<br/>
<strong>设计小姐姐</strong>：“太硬（撇嘴），不够 Q 弹（鄙视）”<br/>
<strong>我</strong>：(裂开)<br/>
<strong>隔壁老王</strong>：这么简单你都不行，我来一行贝塞尔 cubic-bezier(0.3, 1.15, 0.33, 1.57) 秒了😎<br/>
<strong>设计小姐姐</strong>：哇哦！（兴奋）好帅！（星星眼🌟）好Q弹！（一脸崇拜😍）<br/>
<strong>我</strong>：<strong>“？？？”</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">🧠 一、为什么一行贝塞尔就能“Duang”起来？</h2>
<h3 data-id="heading-1">1️⃣ cubic-bezier 是什么？</h3>
<p>在 CSS 动画里，我们经常写：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.5s</span> ease;
</code></pre>
<p>但其实 <code>ease</code>、<code>linear</code>、<code>ease-in-out</code> 这些都只是封装好的贝塞尔曲线。<br/>
底层原理是：</p>
<pre><code class="hljs language-css" lang="css">cubic-bezier(x1, y1, x2, y2)
</code></pre>
<p>这四个参数定义了<strong>时间函数曲线</strong>，控制动画速度的变化。</p>
<ul>
<li><code>x</code>：时间轴（必须在 0～1 之间）</li>
<li><code>y</code>：数值轴（可以超出 0～1！）</li>
</ul>
<p>👉 当 y 超过 1 或小于 0 时，动画值就会<strong>冲过终点再回弹</strong>，<br/>
这就是“回弹感”的核心。</p>
<hr/>
<h3 data-id="heading-2">2️⃣ 回弹的本质：过冲 + 衰减</h3>
<p>想象一个球掉下来：</p>
<ul>
<li><strong>过冲</strong>：球落地时会压扁（超出终点）</li>
<li><strong>回弹</strong>：然后反弹回来，再逐渐稳定</li>
</ul>
<p>在动画中，这个“过冲”就是 y&gt;1 的部分，<br/>
而“回弹”就是曲线回到 y=1 的过程。</p>
<hr/>
<h2 data-id="heading-3">🧪 二、一行贝塞尔的魔法</h2>
<h3 data-id="heading-4">✅ 火箭发射</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d945616e56f74171afda7e6b38b97c8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Lmd5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764654719&amp;x-signature=lUyE6LGLXrjzlCGpwDn2f6gf%2F8M%3D" alt="export_1764044056566.gif" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bounce"</span>&gt;</span>🚀发射！<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.bounce</span> {
 <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.8s</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.68</span>, -<span class="hljs-number">0.55</span>, <span class="hljs-number">0.27</span>, <span class="hljs-number">1.55</span>);
}
<span class="hljs-selector-class">.bounce</span><span class="hljs-selector-pseudo">:hover</span> {
 <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">500px</span>);
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><span href="https://code.juejin.cn/pen/7576535022065647654" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7576535022065647654" data-src="https://code.juejin.cn/pen/7576535022065647654" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span>
💡 <strong>参数解析：</strong></p>
<ul>
<li>y1 = -0.55 → 先轻微反向缩小</li>
<li>y2 = 1.55 → 再冲过头 55%，最后回弹到原位</li>
</ul>
<h2 data-id="heading-5">🧩 四、常用贝塞尔参数</h2>



































<table><thead><tr><th>效果描述</th><th>贝塞尔参数</th><th>备注</th></tr></thead><tbody><tr><td>微回弹（按钮）</td><td><code>cubic-bezier(0.34, 1.31, 0.7, 1)</code></td><td>轻柔弹性</td></tr><tr><td>强回弹（卡片）</td><td><code>cubic-bezier(0.68, -0.55, 0.27, 1.55)</code></td><td>爆发力强</td></tr><tr><td>柔和出入</td><td><code>cubic-bezier(0.4, 0, 0.2, 1.4)</code></td><td>iOS 风</td></tr><tr><td>弹性放大</td><td><code>cubic-bezier(0.175, 0.885, 0.32, 1.275)</code></td><td>弹簧感</td></tr><tr><td>火箭猛冲</td><td><code>cubic-bezier(0.68, -0.55, 0.27, 1.55)</code></td><td>推背感</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-6">🧰 五、调试神器推荐</h2>
<ul>
<li>
<p>🎨 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcubic-bezier.com" target="_blank" title="https://cubic-bezier.com" ref="nofollow noopener noreferrer">cubic-bezier.com</a><br/>
拖动手柄实时预览动画，复制参数一键搞定。</p>
</li>
<li>
<p>⚙️ <a href="https://link.juejin.cn?target=https%3A%2F%2Feasings.net" target="_blank" title="https://easings.net" ref="nofollow noopener noreferrer">easings.net</a><br/>
收录各种 easing 函数（含物理弹簧、阻尼等）。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[比 MySQL 轻，比 SQLite 强：终于有人把 AI 数据库做对了]]></title>    <link>https://juejin.cn/post/7576197876716748838</link>    <guid>https://juejin.cn/post/7576197876716748838</guid>    <pubDate>2025-11-25T00:19:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576197876716748838" data-draft-id="7576105442214330418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="比 MySQL 轻，比 SQLite 强：终于有人把 AI 数据库做对了"/> <meta itemprop="keywords" content="GitHub,开源,数据库"/> <meta itemprop="datePublished" content="2025-11-25T00:19:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HelloGitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1574156384091320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            比 MySQL 轻，比 SQLite 强：终于有人把 AI 数据库做对了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1574156384091320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HelloGitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T00:19:55.000Z" title="Tue Nov 25 2025 00:19:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19f57e8e53b549d2a5fa1eafd945fccb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764634795&amp;x-signature=D9%2FsddVGJGhrzo7o7qk7aloo6P8%3D" alt="" loading="lazy"/></p>
<p>前几天，我看到了一个来自 Turso 创始人 Pekka 的观点：</p>
<blockquote>
<p>SQLite 被认为是 AI agent 的理想数据库，因为它轻量级且适用于 AI agent 的各种场景，但仍然需要进化。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35d656b3e981498f9ebdcbcd8a127606~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764634795&amp;x-signature=S2tn8ybJo6m058%2BxmEtikklnojk%3D" alt="" loading="lazy"/></p>
<p>评论区里也有意思，有人会和大家分享自己为了 SQLite 的进化做了哪些事情（比如开源了 Super SQLite 之类的项目），也有人会推荐有哪些 SQLite 的进化版产品，并和大家讨论这些产品的优劣。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaea769ca6d24bcc919823f5214e32d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764634795&amp;x-signature=sCQbdeIC9PdWvm9pnQELxr03n3A%3D" alt="" loading="lazy"/></p>
<p>实际上，AI 应用开发者对轻量级数据库的诉求，远远不止 AI Agent 这一个场景。那些在 Web 时代和移动互联网时代支撑了万亿级应用的传统数据库，如今在面对 AI 应用的敏捷、轻量、高频迭代的需求时，都纷纷开始暴露出它们的水土不服。</p>
<p>除了传统数据库几个最明显的问题 —— <strong>部署复杂度高、资源占用多、过度设计影响执行效率</strong> 以外，很多 AI 应用都会把数据和模型紧密结合，在设备端（如手机、物联网设备）实现本地化运行，传统数据库通过客户端远程连接服务器的模式，也无法满足这种嵌入式，甚至离线嵌入式的需求。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91fb112cc10549f0aa304a3ad341d3da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764634795&amp;x-signature=sq6yHywgjveQ9Uv0FuuFYSUMX4Y%3D" alt="" loading="lazy"/></p>
<p>为了让 AI 开发者不浪费太多时间在与数据基础设施的搏斗上，而是能够专注于 AI 算法与应用逻辑本身。我们需要一种新型数据库，能够将自己从这种无谓的消耗中解放出来。</p>
<h2 data-id="heading-0">0x01. seekdb 的来龙去脉</h2>
<p>OceanBase 刚开始只是负责淘宝和支付宝的各种交易支付相关业务，然后是各种银行和金融机构，接下来是从泛互联网行业扩展到各行各业，详见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFng44Ft1gNKKP2mYK1vsew" target="_blank" title="https://mp.weixin.qq.com/s/Fng44Ft1gNKKP2mYK1vsew" ref="nofollow noopener noreferrer">《开源 4 年、打磨 15 年、300 万行代码的开源项目》</a>。</p>
<p>但在 AI 时代，对于开发者，类似于 SQLite 这种轻量级数据库的能力非常有限（向量能力和传统 SQL 能力难以兼得），而传统数据库又有部署复杂度高、资源占用多等问题。这两类数据库对于开发者来说，都不够友好。</p>
<p>因此，OceanBase 专门为 AI 时代的开发者，打造了一个开源免费、轻量易用、拥有强大 AI 搜索能力的数据库 —— <strong>seekdb</strong>。个人笔记本安装无压力，让大家只要有机器，就能跑 OB！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb24ebddac6f46579eebf998f5984dde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764634795&amp;x-signature=%2BRrmzUB7F0L9ADAK7XdQth5P4%2Fw%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>GitHub 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foceanbase%2Fseekdb" target="_blank" title="https://github.com/oceanbase/seekdb" ref="nofollow noopener noreferrer">github.com/oceanbase/s…</a></p>
</blockquote>
<h2 data-id="heading-1">0x10. seekdb 简介</h2>
<p><strong>seekdb</strong> 是 OceanBase 专门为开发者打造的一款开箱即用、轻量级的数据库产品，专注于为 AI 应用提供高效的混合搜索能力，支持向量、全文及多模数据的统一存储与检索，是构建 AI 应用的新选择。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5db2ad4595541008f207eb1a6bade25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764634795&amp;x-signature=nlpGMKvs34NjEGJ6JmgfdhJ0srI%3D" alt="" loading="lazy"/></p>
<p>seekdb 在继承了淘宝和支付宝背后的 OceanBase 数据库核心引擎高性能优势与 MySQL 全面兼容特性的基础上，通过深度优化数据搜索架构，为开发者提供了更符合 AI 应用数据处理需求的各项能力。</p>
<h3 data-id="heading-2">产品能力矩阵对比</h3>






























































































































<table><thead><tr><th align="left">特性</th><th align="center">seekdb</th><th align="center">OceanBase</th><th align="center">Chroma</th><th align="center">Milvus</th><th align="center">MySQL 9.0</th><th align="center">PostgreSQL + pgvector</th><th align="center">DuckDB</th><th align="center">Elasticsearch</th></tr></thead><tbody><tr><td align="left"><strong>嵌入式数据库</strong></td><td align="center">✅</td><td align="center">❌</td><td align="center">✅</td><td align="center">✅</td><td align="center">❌</td><td align="center">❌</td><td align="center">✅</td><td align="center">❌</td></tr><tr><td align="left"><strong>单机数据库</strong></td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td></tr><tr><td align="left"><strong>分布式数据库</strong></td><td align="center">❌</td><td align="center">✅</td><td align="center">❌</td><td align="center">✅</td><td align="center">❌</td><td align="center">❌</td><td align="center">❌</td><td align="center">✅</td></tr><tr><td align="left"><strong>MySQL 兼容</strong></td><td align="center">✅</td><td align="center">✅</td><td align="center">❌</td><td align="center">❌</td><td align="center">✅</td><td align="center">❌</td><td align="center">✅</td><td align="center">❌</td></tr><tr><td align="left"><strong>向量搜索</strong></td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td><td align="center">❌</td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td></tr><tr><td align="left"><strong>全文检索</strong></td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td><td align="center">⚠️</td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td></tr><tr><td align="left"><strong>混合搜索</strong></td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td><td align="center">❌</td><td align="center">⚠️</td><td align="center">❌</td><td align="center">✅</td></tr><tr><td align="left"><strong>OLTP</strong></td><td align="center">✅</td><td align="center">✅</td><td align="center">❌</td><td align="center">❌</td><td align="center">✅</td><td align="center">✅</td><td align="center">❌</td><td align="center">❌</td></tr><tr><td align="left"><strong>OLAP</strong></td><td align="center">✅</td><td align="center">✅</td><td align="center">❌</td><td align="center">❌</td><td align="center">❌</td><td align="center">✅</td><td align="center">✅</td><td align="center">⚠️</td></tr><tr><td align="left"><strong>开源协议</strong></td><td align="center">Apache 2.0</td><td align="center">MulanPubL 2.0</td><td align="center">Apache 2.0</td><td align="center">Apache 2.0</td><td align="center">GPL 2.0</td><td align="center">PostgreSQL License</td><td align="center">MIT</td><td align="center">AGPLv3+ SSPLv1+ Elastic 2.0</td></tr></tbody></table>
<blockquote>
<p>MySQL 8.0 移除了嵌入式能力</p>
</blockquote>
<h3 data-id="heading-3">seekdb 的适用场景</h3>
<ul>
<li><strong>RAG 应用</strong>：面向以智能聊天机器人、知识库、领域专家系统为代表的 RAG 场景，seekdb 支持了完整的 RAG Pipeline 解决方案。内置文档解析处理功能，集成向量嵌入（Embedding）、重排序（Rerank）及大语言模型（LLM），支持向量/全文/标量混合搜索，在一个数据库实例内实现 <strong>Doc In Data Out</strong>。</li>
<li><strong>AI 辅助编程</strong>：面向 AI 辅助编程场景，seekdb 支持对代码仓库构建向量和全文索引，基于代码关键词或代码语义，进行高效的代码搜索和生成补全。</li>
<li><strong>AI Agent 平台类应用</strong>：面向 AI Agent 开发场景，seekdb 提供了快速启动和嵌入式部署能力，支持被快速拉起提供服务。提供高频增删改和实时查询能力，避免数据库性能瓶颈引起 AI 开发效率降低的问题。提供向量搜索、全文搜索及混合搜索特性和灵活的元数据管理能力，结合会话管理与记忆存储能力，无需再引入其他库就可快速构建 AI Agent。提供 MCP Server 组件，无缝接入 AI 生态。</li>
<li><strong>语义搜索引擎</strong>：面向以电商商品搜索和推荐、多媒体内容检索、图片搜索等语义搜索场景，seekdb 支持对接主流向量嵌入模型并提供了向量搜索能力。同时提供了 Hybrid Index 功能，支持基于文本查询条件进行语义搜索，对用户屏蔽向量嵌入和查询结果 Rerank 的复杂流程。</li>
<li><strong>MySQL 应用现代化和 AI 化升级</strong>：seekdb 继承了 OceanBase 单机存储引擎、执行引擎、事务引擎、高级查询优化器的完整能力，高度兼容 MySQL，并在此基础上扩展 AI 能力。小规格可用于物联网边缘设备数据采集、小型应用开发和实验教学等场景，中大规格可用于各行业 OLTP、HTAP 或 AI 业务场景。</li>
</ul>
<h3 data-id="heading-4">seekdb 的产品架构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c0aecd44d5646d8aee38fa0fc4eae7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764634795&amp;x-signature=x3GUudtrz0ITBIxXTkA0BEfA0rM%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>部署模式</strong>：支持 Client/Server 和嵌入式两种部署模式。嵌入式模式下可将 seekdb 直接集成进 Python 应用，便于进行个人开发。</li>
<li><strong>具有 ACID 事务语义的存储层</strong>：基于 LSM-Tree 架构的行存列存一体化存储引擎，自研高效的编码压缩机制降低存储成本。支持数据高频实时写入，和面向不同负载的高性能查询。</li>
<li><strong>多模数据与索引层</strong>：支持基础类型，向量、大文本、JSON 、GIS、Array 等多模数据类型，并提供高效的索引支持。包括 HNSW / IVF 向量索引及索引量化算法，覆盖多种分词器和查询模式的基于 BM25 相关性计算算法的全文索引，适用于语义搜索的混合索引，及 JSON 多值索引、主键和二级索引、GIS 索引等。</li>
<li><strong>支持混合负载的多模计算层</strong>：支持向量、全文、标量等条件的混合搜索。提供 AI Function 能力，实现库内实时推理。支持完整的 ACID 事务特性及基于 MVCC 的多版本并发访问能力，提供高级查询优化器和具备向量化执行能力的高效执行引擎。</li>
<li><strong>统一应用接口</strong>：兼容 MySQL 原生驱动，提供基于 SQL 的支持多模数据的统一查询语言。并在此基础上提供了面向开发者更加友好的向量库/混搜 SDK。适配 LangChain、LlamaIndex、Dify 等 AI 应用开发框架。提供 MCP Server，无缝接入 AI 生态。</li>
</ul>
<h3 data-id="heading-5">seekdb 的核心特性</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fd01ba9f0714c84b779540f26a20538~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764634795&amp;x-signature=LVVDo6VRxeKlIZnBSz%2BRBsVOzIk%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>开箱即用，极速开发，易学易用</strong>：单点架构设计，无其他组件依赖。支持 yum、docker、windows/macos 桌面版部署以及原生 Python 嵌入式集成。</li>
<li><strong>支持 1C2G 小规格，垂直弹性扩缩容</strong>：服务端 1 核 CPU + 2GB 内存即可跑 VectorDBBench Performance1536D50K。</li>
<li><strong>高性能向量索引、全文索引，支持向量、全文、标量混合搜索</strong>
<ul>
<li><strong>向量搜索</strong>：支持高达 16,000 维向量存储，兼容 L2、内积、余弦相似度。</li>
<li><strong>全文搜索</strong>：基于 BM25 算法，提供 Space、Beng、Ngram、IK、Jieba 等多种分词器。</li>
<li><strong>混合搜索</strong>：一条 SQL 完成多路查询与重排序。</li>
</ul>
</li>
<li><strong>混搜场景升级，基于 Hybrid Index 指定文本也可进行语义搜索</strong>：只需写入文本数据，系统自动进行 Embedding 并生成向量索引，查询时仅需指定文本搜索条件。</li>
<li><strong>无缝对接各类模型，内置 AI Function 实现库内实时推理</strong>：通过 <code>DBMS_AI_SERVICE</code> 系统包实现模型注册和管理。内置 <code>AI_COMPLETE</code>、<code>AI_PROMPT</code>、<code>AI_EMBED</code>、<code>AI_RERANK</code> 等函数。</li>
<li><strong>基于 JSON 的动态 Schema</strong>：支持 JSON 数据类型及动态 Schema，提供 JSON 函数索引、多值索引。</li>
<li><strong>数据实时写入，实时可查</strong>：基于 LSM-Tree，数据入库成功立即可查，同步构建各类索引。</li>
<li><strong>兼容 MySQL 不止于 MySQL，支撑 HTAP 混合负载</strong>：深度兼容 MySQL 语法协议，一个实例同时支持联机交易和实时分析。</li>
</ol>
<h2 data-id="heading-6">0x11. 快速部署 seekdb 体验环境</h2>
<blockquote>
<p>服务器配置要求详见官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oceanbase.ai%2Fdocs%2Fzh-CN%2Fdeploy-seekdb-testing-environment" target="_blank" title="https://www.oceanbase.ai/docs/zh-CN/deploy-seekdb-testing-environment" ref="nofollow noopener noreferrer">deploy-seekdb-testing-environment</a></p>
</blockquote>
<h3 data-id="heading-7">1. 使用 yum install 快速部署</h3>
<p><strong>添加 seekdb 镜像源：</strong></p>
<pre><code class="hljs language-bash" lang="bash">sudo yum-config-manager --add-repo https://mirrors.aliyun.com/oceanbase/OceanBase.repo
</code></pre>
<p><strong>安装 seekdb 和 obclient 客户端：</strong></p>
<pre><code class="hljs language-bash" lang="bash">sudo yum install seekdb obclient
</code></pre>
<p>如果在启动前需要更改配置，可以直接修改 <code>/etc/oceanbase/seekdb.cnf</code>，配置项很少可按需修改。</p>
<p><strong>建议 <code>cpu_count</code> 和 <code>memory_limit</code> 最好大于 1C2G，亲测 1C1G 也 No Problem。</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 示例配置</span>
<span class="hljs-attr">port</span>=<span class="hljs-number">1234</span>
<span class="hljs-attr">base-dir</span>=/var/lib/oceanbase
<span class="hljs-attr">data-dir</span>=/var/lib/oceanbase/store
<span class="hljs-attr">redo-dir</span>=/var/lib/oceanbase/store/redo
<span class="hljs-attr">datafile_size</span>=<span class="hljs-number">2</span>G
<span class="hljs-attr">datafile_next</span>=<span class="hljs-number">2</span>G
<span class="hljs-attr">datafile_maxsize</span>=<span class="hljs-number">50</span>G
<span class="hljs-attr">cpu_count</span>=<span class="hljs-number">4</span>
<span class="hljs-attr">memory_limit</span>=<span class="hljs-number">2</span>G
<span class="hljs-attr">log_disk_size</span>=<span class="hljs-number">2</span>G
</code></pre>
<p><strong>启动与管理 seekdb：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动 seekdb</span>
sudo systemctl start seekdb

<span class="hljs-comment"># 查看启动状态 (显示 Service is ready 即成功)</span>
sudo systemctl status seekdb

<span class="hljs-comment"># 连接 seekdb</span>
obclient -h127.0.0.1 -uroot -P1234 -A oceanbase

<span class="hljs-comment"># 停止服务</span>
sudo systemctl stop seekdb

<span class="hljs-comment"># 开机启动</span>
sudo systemctl <span class="hljs-built_in">enable</span> seekdb
</code></pre>
<h3 data-id="heading-8">2. 嵌入式安装</h3>
<p>seekdb 提供了嵌入式部署方式，可以作为一个“库”运行在你的应用程序内部。</p>
<p><strong>Python 示例</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> seekdb

<span class="hljs-comment"># Open a database</span>
seekdb.<span class="hljs-built_in">open</span>()

<span class="hljs-comment"># Connect to a database</span>
conn = seekdb.connect()

<span class="hljs-comment"># Use the connection</span>
cursor = conn.cursor()
cursor.execute(<span class="hljs-string">"select version();"</span>)
results = cursor.fetchall()
<span class="hljs-built_in">print</span>(results)

<span class="hljs-comment"># Close the connection</span>
conn.close()
</code></pre>
<p><strong>运行结果</strong></p>
<pre><code class="hljs language-bash" lang="bash">$ python3 sample.py
[(<span class="hljs-string">'1.2.34-OceanBase NewProduct-v5.6.7.8'</span>,)]
</code></pre>
<h3 data-id="heading-9">3. 其他部署方式</h3>
<p>除此之外，OB 官方还提供了 seekdb 的 Docker 镜像和桌面版管理工具，篇幅有限这里就不展开介绍了，感兴趣的同学可以移步文档查看（oceanbase.ai/docs）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d85b5dd0eb994f4c809fa11de6b8d15d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764634795&amp;x-signature=n4lTC1Ft929%2BUSddEHzXLziw%2FMc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">0xFF. 写在最后</h2>
<p>回想去年，我第一次用 OceanBase 数据库做 RAG 应用，当时用 16GB 内存的 MacBook Pro 启动 OB 竟然还会因为内存不够而失败☹️，那时候的 OB 强大却略显“高冷”。</p>
<p>而 seekdb 的出现，让我有一种“士别三日当刮目相看”的感觉。OceanBase 从昔日“高不可攀”的金融级数据库，到如今“触手可及”的 seekdb，OceanBase 团队这次真正看懂了开发者在 AI 时代对数据库期望的样子：无痛的上手体验，不吃资源、配置简单、开箱即用，却依然强大可靠。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f28ced87a97448884d366a67c63a2fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764634795&amp;x-signature=BM9NWjZsJcEfZkpIo0Qd%2BNx9O48%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>GitHub 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foceanbase%2Fseekdb" target="_blank" title="https://github.com/oceanbase/seekdb" ref="nofollow noopener noreferrer">github.com/oceanbase/s…</a></p>
</blockquote>
<p>现在的 seekdb 也许还不是“最终形态”，但它绝对是一个令人兴奋的起点，让我们一起见证这款“更懂 AI 的数据库”成长之路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Web前端们！我用三年亲身经历，说说从 uniapp 到 Flutter怎么转型的，这条路我爬过，坑我踩过]]></title>    <link>https://juejin.cn/post/7576378563575545871</link>    <guid>https://juejin.cn/post/7576378563575545871</guid>    <pubDate>2025-11-25T08:10:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576378563575545871" data-draft-id="7576208176007905332" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Web前端们！我用三年亲身经历，说说从 uniapp 到 Flutter怎么转型的，这条路我爬过，坑我踩过"/> <meta itemprop="keywords" content="前端,Flutter,uni-app"/> <meta itemprop="datePublished" content="2025-11-25T08:10:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小林的跨端开发日记"/> <meta itemprop="url" content="https://juejin.cn/user/3320949647350765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Web前端们！我用三年亲身经历，说说从 uniapp 到 Flutter怎么转型的，这条路我爬过，坑我踩过
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3320949647350765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小林的跨端开发日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T08:10:26.000Z" title="Tue Nov 25 2025 08:10:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    118
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>大家好，我是【小林】</p>
<p>说来有点意思，我的后台私信，最近有点热闹热闹，点开一看，翻来覆去都是同一个问题：</p>
<p><strong>“哥们，我一Web前端，能转 RN/Flutter 吗？好转吗？水深不？”</strong></p>
<p>问的人多了，我一个个回实在有点累。而且我发现，这已经不是一个简单的“能不能”的问题，背后是 Web 开发者对未知移动端领域的一系列困惑、焦虑和好奇。</p>
<p>所以，我决定干脆写一篇文章，把我从一个纯粹的 Web 前端，一步步“爬”到 Flutter 开发的经历和思考，掰开揉碎了分享给大家。我不讲某个 API 怎么用，也不贴大段的源码，咱就聊点大实话，聊聊这条路到底是怎么回事。</p>
<p>先自报家门，让大家知道我不是在“瞎忽悠”。</p>
<p>我，22年毕业就做了 Web 前端。第一份工作在上海一家小公司，上来就是硬仗，用 <code>uni-app</code> 从0到1搞换电小程序的微信和支付宝版。后来老板为了融资，说小程序体验不行，要做 App，于是我又临危受命，在 <code>uni-app</code>、<code>RN</code>、<code>Flutter</code> 三个技术里选型，最后硬着头皮上了 <code>Flutter</code>，那时候可没现在这么多 AI 能帮你，全靠一行行手敲，愣是把 App 给干上线了。</p>
<p>后来跳槽到了北京一家上市公司，正式成为一名 Flutter 开发，做 AIGC 项目，就是大家玩的文生图、图生图那些。再后来，我又去了小米（外包），参与钱包里的 AI 记账模块，体验了一把大厂的混合开发模式。现在入职一家中厂，有专门的Flutter技术团队...</p>
<p>一路上，从 <code>uni-app</code> 的 WebView，到 Flutter 的自绘引擎，从一个人单打独斗，到和原生开发协同作战，也自己封装了几个插件发布到 pub.dev，算是混了个脸熟。</p>
<p>所以，关于“Web前端转跨平台”这个话题，我觉得我还是能聊几句的。</p>
<h2 data-id="heading-1">篇章一： 捋直概念，什么是跨平台到开发</h2>
<p>在很多 Web 同学眼里也包括曾经的我，移动端开发就俩物种：<strong>原生（Native）</strong>  和 <strong>跨平台（Cross-Platform）</strong> 。</p>
<h3 data-id="heading-2">原生开发和跨平台开发的区别在哪？</h3>
<p>这个理解没错，但有点笼统。我们用个好懂的比喻来解释。</p>
<p><strong>原生开发（Native Development）</strong></p>
<blockquote>
<p>想象一下，你要在北京和上海各开一家本地特色菜馆。</p>
<p>你会在北京请一位精通京酱肉丝、烤鸭的北京本地厨师（<strong>Android 开发者</strong>），用本地的食材和灶具（<strong>Java/Kotlin + Android SDK</strong>）。</p>
<p>你会在上海请一位精通红烧肉、腌笃鲜的上海本地厨师（<strong>iOS 开发者</strong>），用上海的食材和灶具（<strong>Objective-C/Swift + iOS SDK</strong>）。</p>
<p><strong>优点</strong>：两家菜馆都做出了最地道、最原汁原味、上菜最快的本地菜（<strong>性能最好、体验最棒、最贴合系统特性</strong>）。<br/>
<strong>缺点</strong>：你得雇两个厨师，沟通两套菜单，管理两个厨房，成本直接翻倍（<strong>开发成本高、周期长、团队维护难</strong>）。</p>
</blockquote>
<p><strong>原生开发解决的核心职责是：榨干平台性能，提供极致的用户体验。</strong>  任何与系统底层深度交互的功能，比如定制化的系统级服务、复杂的蓝牙/NFC通信、高性能的图形处理，原生都是当之无愧的王者。在我做AIGC项目时，那两个安卓和iOS的同事，他们不直接参与业务开发，但他们负责打包、负责把算法团队给的 C++ SDK 集成到原生工程里，再暴露接口给我们 Flutter 调用。这就是原生的“特区”，跨平台技术轻易不敢涉足。</p>
<p><strong>跨平台开发（Cross-Platform Development）</strong></p>
<blockquote>
<p>现在，你觉得两家店成本太高，决定开一家融合菜馆。</p>
<p>你请来一位天才大厨（<strong>跨平台框架</strong>），他带来了一套自己独门的万能厨具和标准化的烹饪流程（<strong>一套代码</strong>）。</p>
<p>他用这套流程，既能做出八九不离十的京酱肉丝，也能做出味道不错的红烧肉，而且两道菜可以同时开火，效率极高（<strong>一套代码，多端运行，降本增效</strong>）。</p>
<p><strong>优点</strong>：你只需要管理一个厨师和一个厨房，成本大大降低，上新菜也快（<strong>开发成本低、效率高、UI一致性好</strong>）。<br/>
<strong>缺点</strong>：虽然菜好吃，但终究不是本地老师傅做的，口感上可能差那么点“地道”的感觉（<strong>性能和体验通常有损耗</strong>），而且如果遇到特别刁钻的本地食材（<strong>特定系统API</strong>），这位大厨也得去请教本地厨师怎么处理（<strong>需要原生辅助</strong>）。</p>
</blockquote>
<p><strong>跨平台解决的核心职责是：在保证体验基本盘的情况下，最大化地复用代码，降低成本，提升效率。</strong>  它是商业和技术权衡下的产物，尤其适合那些业务逻辑复杂、UI多样的应用。</p>
<h3 data-id="heading-3">移动端开发需要的思维模式</h3>
<p>在聊技术之前，我们先聊点更重要的东西：<strong>思维模式</strong>。从 Web 转移动端，最大的坎不是学 Dart 或 React，而是你大脑里根深蒂固的“浏览器思维”。</p>
<ul>
<li><strong>从“无状态”的网页到“有状态”的应用</strong><br/>
Web 的世界，本质是请求-响应。用户点一下，页面刷一下，大部分时候我们不关心用户上一步干了啥。而 App 是一个<strong>活物</strong>，它有生命周期：从后台被唤醒、被一个电话打断、被系统因为内存不足而杀死……你写的每一行代码，都得像个操心的老妈子，考虑这个“活物”在各种状态下的表现。这是一种从“面向文档”到“面向状态”的根本转变。</li>
<li><strong>从“温室”的浏览器到“严酷”的移动环境</strong><br/>
在 Web 端，我们是温室里的花朵，背后有强大的服务器和稳定的网络。但在移动端，你的 App 是在一个资源极其有限、环境极其恶劣的“荒野”求生。<strong>性能</strong>不再是锦上添花，而是生死线。我做 AIGC 项目时，一张图的生成过程，如果导致 UI 掉帧，用户会立刻感觉到卡顿；如果内存控制不好，低端机直接闪退。电量、内存、网络抖动、CPU 占用……这些过去我们不太关心的指标，现在成了悬在头上的达摩克利斯之剑。</li>
<li><strong>从“文档流”的布局到“约束”的布局</strong><br/>
Web 布局是“顺流而下”，我们用 Flex、Grid 改变水流方向。而移动端布局是“戴着镣铐跳舞”，每个组件都被父级死死地“约束”在一个矩形内。你必须学会从“我想把它放哪”转变为“我该如何约束它，让它在我想要的位置”。</li>
</ul>
<p>好了，心态摆正了，我们再来看技术，你会发现很多设计的“所以然”。</p>
<h2 data-id="heading-4">篇章二：直击底层：三大跨平台框架的架构原理剖析</h2>
<h3 data-id="heading-5"> uni-app: WebView 容器的集大成者</h3>
<ul>
<li>
<p><strong>核心架构：WebView + JSBridge</strong><br/>
<code>uni-app</code> 在构建 App 时的核心思想，是将你的 Vue.js 应用运行在一个原生的“容器”之内，而这个容器的主要组件就是一个高性能的 <strong>WebView</strong>。WebView 本质上是一个嵌入在 App 内部的、被阉割和强化的浏览器内核（iOS 的 WKWebView，Android 的 WebView）。你的所有页面和组件，实际上都是在渲染一个本地的 HTML、CSS 和 JavaScript 文件。</p>
</li>
<li>
<p><strong>UI 渲染机制</strong><br/>
UI 的渲染工作完全由 WebView 的渲染引擎负责。这意味着，你写的 <code>&lt;view&gt;</code> 标签最终会被渲染成 <code>&lt;div&gt;</code>，动画效果依赖于 CSS Transitions/Animations，布局遵循标准的 Web 文档流和 Flexbox 模型。这对于 Web 开发者是零成本上手，但同时也意味着，<strong>UI 的性能上限被 WebView 本身牢牢锁死</strong>。</p>
</li>
<li>
<p><strong>逻辑与原生通信：JSBridge</strong><br/>
当你的 Web 页面（JS 代码）需要调用原生的能力时，比如扫码、获取地理位置，就需要通过 <strong>JSBridge</strong> 这个“信使”来完成。其工作流程通常是：</p>
<ol>
<li><strong>JavaScript 调用</strong>：你在 JS 中调用 <code>uni.scanCode()</code>。</li>
<li><strong>数据序列化</strong>：JSBridge 将这个调用和参数打包成一个特定格式的字符串（通常是 JSON）。</li>
<li><strong>消息传递</strong>：通过 WebView 提供给原生环境的接口，将这个字符串消息发送给原生代码。</li>
<li><strong>原生执行</strong>：原生代码接收并解析消息，执行真正的扫码操作。</li>
<li><strong>结果返回</strong>：原生将结果再次序列化，通过回调机制传回给 WebView 中的 JavaScript。</li>
</ol>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 在 uni-app 页面里</span>
uni.<span class="hljs-title function_">scanCode</span>({
  <span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'条码内容：'</span> + res.<span class="hljs-property">result</span>);
  }
});
<span class="hljs-comment">// uni.scanCode 这个JS API，底层就是通过 JSBridge</span>
<span class="hljs-comment">// 去调用了原生安卓或iOS的扫码功能</span>
</code></pre>
<p>这个过程是<strong>异步</strong>的，并且涉及多次<strong>数据序列化/反序列化</strong>和<strong>线程上下文切换</strong>（JavaScript 线程 ↔ 原生 UI 线程）。对于低频调用，这没有问题；但对于高频交互（如自定义手势、实时通信），JSBridge 就会成为明显的性能瓶颈。</p>
<ul>
<li><strong>架构总结</strong><br/>
<code>uni-app</code> 的架构是一种极致的实用主义。它用 Web 开发者最熟悉的技术栈，以最低的成本实现了跨端。但其代价是性能和体验的天花板较低，永远无法摆脱“网页感”，因为它本质上就是一个高度优化的本地网站。</li>
</ul>
<h3 data-id="heading-6">React Native: 迈向“无桥接”新时代的原生 UI 映射</h3>
<ul>
<li>
<p><strong>核心架构：JavaScript 线程 + 原生 UI 线程</strong><br/>
RN 的设计哲学与 WebView 完全不同。它并没有把你的代码跑在浏览器里，而是启动了一个独立的 <strong>JavaScript 线程</strong>（通常使用为移动端优化的 <strong>Hermes</strong> 引擎）来执行你的 React 代码（业务逻辑）。当你的组件树发生变化时，RN 会计算出最小化的 UI 更新操作，然后通过一套通信机制，告知<strong>原生 UI 线程</strong>去创建、更新或删除对应的<strong>原生 UI 组件</strong>。</p>
</li>
<li>
<p><strong>UI 渲染机制</strong><br/>
你写的 <code>&lt;View&gt;</code> 组件，最终会由 RN 转化为 iOS 上的 <code>UIView</code> 或 Android 上的 <code>android.view.View</code>。<strong>渲染工作是100%由原生系统完成的</strong>。这使得 RN 应用在外观和基础交互上能够达到与原生应用几乎无异的水平。</p>
</li>
<li>
<p><strong>逻辑与原生通信（划重点：架构的演进）</strong><br/>
RN 的通信机制是其性能演进的关键，经历了两个时代：</p>
<ul>
<li>
<p><strong>旧架构 (Bridge)</strong> ：这是 RN 早期的通信核心。它是一个<strong>异步的、可批处理的桥</strong>。JS 线程和原生线程通过这个桥来回传递序列化后的 JSON 消息。这个设计的瓶颈在于：1) <strong>异步</strong>：JS 无法同步调用原生方法并立即获得结果。2) <strong>序列化开销</strong>：对于大量或频繁的数据交换（如列表滚动时的事件数据），JSON 转换的开销很大。这导致了在复杂场景下，UI 响应可能会延迟。</p>
</li>
<li>
<p><strong>新架构 (JSI - JavaScript Interface)</strong> ：这是 RN 的革命性升级。JSI 允许 JavaScript 直接持有一个对 C++ 对象的引用，并通过这个引用<strong>同步调用</strong>该对象的方法。这意味着：</p>
<ol>
<li><strong>告别 JSON 序列化</strong>：数据可以直接在内存中共享，无需低效的字符串转换。</li>
<li><strong>实现同步调用</strong>：JS 可以像调用本地函数一样调用原生功能，这对于需要即时反馈的复杂交互至关重要。<br/>
基于 JSI，RN 推出了新的渲染器 <strong>Fabric</strong> 和新的原生模块系统 <strong>TurboModules</strong>，共同构成了“无桥接”的新时代。</li>
</ol>
</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Text</span>, <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 你写的这个 &lt;View&gt; 和 &lt;Text&gt;</span>
  <span class="hljs-comment">// 最终并不会变成 HTML 标签</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Text</span>&gt;</span>Hello, Native World!<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"Click Me"</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{()</span> =&gt;</span> console.log('Button pressed!')} /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
  );
}
<span class="hljs-comment">// React Native 会把这个组件树信息，通过 Bridge 发送给原生</span>
<span class="hljs-comment">// 原生那边收到后，就会去创建真正的 Android.View 和 Android.TextView</span>

</code></pre>
<ul>
<li>
<p><strong>痛点是什么？</strong></p>
<ul>
<li><strong>Bridge 性能瓶颈</strong>：当你的遥控器按得太快（比如频繁的动画、列表快速滚动），信号太多，电视机就可能反应不过来，导致卡顿。这是 RN 历史上一直被诟病的问题，虽然现在有了新的架构（JSI）在改进，但这个通信成本是客观存在的。</li>
<li><strong>“Write once, debug everywhere”</strong> ：因为 RN 只是“调用”原生组件，而两端原生组件的表现有时会有细微差异，所以经常会出现一个布局在 iOS 上好好的，在 Android 上就歪了的情况，需要写平台特定的代码来抹平差异。</li>
</ul>
</li>
<li>
<p><strong>架构总结</strong><br/>
RN 提供的是真正的原生 UI 体验。它的架构演进，本质上是在不断解决“如何让两个分离的世界（JS 与 Native）更高效、更同步地对话”这一核心问题。新架构极大地提升了其性能上限，使其在绝大多数场景下都表现出色。</p>
</li>
</ul>
<h3 data-id="heading-7">Flutter: AOT 编译与自绘引擎的性能猛兽</h3>
<ul>
<li>
<p><strong>核心架构：Dart AOT 编译 + C++ 渲染引擎 (Impeller/Skia)</strong><br/>
Flutter 的架构独树一帜，它完全独立于系统原生 UI 组件。其本质上更像一个游戏引擎，只不过它渲染的是 UI 元素而非游戏角色。</p>
<ul>
<li><strong>代码执行</strong>：你的 Dart 代码在发布模式下，会被 <strong>AOT (Ahead-of-Time) 编译</strong>成平台相关的原生 ARM 机器码。这意味着运行时没有中间层（如 JS 虚拟机）的解释开销，代码执行效率极高，性能稳定可预测。</li>
<li><strong>UI 渲染</strong>：Flutter 接管了整个屏幕的渲染。它要求操作系统提供一块空白的画布（<code>Surface</code>），然后调用其自带的 C++ 渲染引擎，一个像素一个像素地将整个界面绘制出来。</li>
</ul>
</li>
<li>
<p><strong>UI 渲染机制（划重点：引擎的进化）</strong><br/>
Flutter 的渲染引擎是其性能的基石，也经历了一次重大演进：</p>
<ul>
<li><strong>Skia 引擎</strong>：这是 Google 开源的 2D 图形库，也是 Chrome 和 Android 的底层图形引擎。Skia 性能强大，但存在一个被称为“<strong>着色器编译卡顿 (Shader Compilation Jank)</strong> ”的问题。即当一个复杂的动画或效果首次出现时，Skia 需要在运行时动态编译其所需的着色器（Shader），这个编译过程可能导致零点几秒的掉帧，影响首次体验的流畅度。</li>
<li><strong>Impeller 引擎</strong>：为了根治此问题，Flutter 开发了新的渲染引擎 Impeller（目前在 iOS 上已默认启用）。Impeller 的核心优势在于，它会在 App 构建时<strong>预编译所有可能用到的着色器</strong>。这样，在运行时就不再有编译开销，从根本上消除了“首次卡顿”现象，使得动画和过渡效果如黄油般丝滑。</li>
</ul>
</li>
<li>
<p><strong>逻辑与原生通信：Platform Channels</strong><br/>
当 Flutter 需要与平台原生服务（如蓝牙、电量、相机）交互时，它使用一种名为 <strong>Platform Channels</strong> 的机制。这是一种类似于 JSBridge 的异步消息传递系统，同样涉及数据序列化。但关键区别在于：<strong>Flutter 仅在需要调用原生服务时才使用它，而 UI 渲染完全不依赖它</strong>。相比之下，RN 的旧架构中，每一次 UI 更新都需要跨桥通信。</p>
</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// Dart 代码</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// 这个 Container, Center, Text 都是 Flutter 自己画的</span>
    <span class="hljs-comment">// 和原生系统的 UI 组件库没有任何关系</span>
    <span class="hljs-keyword">return</span> Container(
      color: Colors.blue,
      child: Center(
        child: Text(
          <span class="hljs-string">'Hello, I drew this myself!'</span>,
          style: TextStyle(color: Colors.white),
        ),
      ),
    );
  }
}
</code></pre>
<ul>
<li><strong>总结</strong><br/>
Flutter 的架构选择了一条“大包大揽”的道路。通过 AOT 编译和自绘引擎，它在跨平台 UI 渲染的<strong>性能</strong>和<strong>一致性</strong>上达到了巅峰。这种架构确保了复杂的 UI 也能稳定运行在 60/120fps，代价是更大的初始包体和与原生 UI 生态的隔离。</li>
</ul>
<h2 data-id="heading-8">篇章三：巅峰对决：到底谁才是“流畅度之王”？</h2>
<p>聊了这么多底层，最终都要反映在用户指尖的感受上。我们来一场不客观、但很真实的“60/120 FPS 滚动与动画”流畅度对决。</p>
<ul>
<li>
<p>🥇 <strong>并列王者：原生 iOS / Flutter (Impeller 引擎)</strong></p>
<ul>
<li><strong>原生 iOS</strong>：亲儿子，不多解释。最小的系统开销，最直接的硬件访问。</li>
<li><strong>Flutter (Impeller)</strong> ：凭借 Impeller 引擎的“提前备战”策略和 Dart AOT 编译成原生机器码的“肌肉记忆”，Flutter 在 UI 渲染上几乎抹平了与原生的差距。它就像一个顶级的游戏引擎，目标就是稳定地“刷帧”，在 UI 密集型应用中，它的表现令人惊叹。</li>
</ul>
</li>
<li>
<p>🥈 <strong>白银骑士：原生 Android</strong></p>
<ul>
<li>性能同样顶级。但由于安卓机型碎片化和 JVM 偶尔的 GC (垃圾回收) 停顿，在某些低端设备或极端情况下，可能会出现人眼可感知的微小卡顿。但这依然是标杆级的存在。</li>
</ul>
</li>
<li>
<p>🥉 <strong>青铜贵族：React Native (新架构)</strong></p>
<ul>
<li>别误会，“青铜”只是相对于前面几个“怪物”而言。在新架构的加持下，RN 在绝大多数场景下已经非常流畅。但它的“原罪”在于，<strong>JS 线程依然是业务逻辑的中心</strong>。当你的 JS 线程忙于处理复杂计算或海量数据时，它传递给 UI 线程的“心灵感应”就可能延迟，导致动画掉帧。虽然有 “Worklets” 等技术在努力绕开这个问题，但这个架构性特点决定了它的理论上限略低于 Flutter。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-9">最终章：Web前端，你的路在何方？</h2>
<p>好了，故事讲完了，我们回到现实。</p>
<ul>
<li><strong>如果你想“降维打击”小程序，或快速将 Web 应用 App 化</strong>：<br/>
<code>uni-app</code> 是你的不二之选。用你最熟悉的 Vue，快速出活，成本最低。接受它的天花板，用它来解决 80% 的常规需求。</li>
<li><strong>如果你是 React 死忠，团队技术栈统一</strong>：<br/>
拥抱 <code>React Native</code> 的新架构。它能让你在移动端的世界里最大化地复用你的 React 知识。生态庞大，社区活跃，找解决方案也更容易。</li>
<li><strong>如果你追求极致的跨平台体验，不畏惧学习，想成为“全能艺术家”</strong> ：<br/>
<strong>我个人，毫无保留地推荐你，和我一样，跳进 <code>Flutter</code> 的“坑”里</strong>。它可能需要你付出一个周末去学习 Dart，但它回馈给你的是一个性能逼近原生、UI 表现力登峰造极、未来充满想象力的全新世界。从被 WebView 性能束缚，到用 Flutter 随心所欲地绘制 UI，这种从“工匠”到“艺术家”的蜕变，带来的成就感是无与伦比的。</li>
</ul>
<p><strong>技术的演进，永无止境。</strong>  RN 在努力填平“桥”的鸿沟，Flutter 在不断打磨自己的“画笔”。没有最好的技术，只有最适合你和你的业务场景的技术。</p>
<p>从一个 Web 前端出发，这条路或许陡峭，但沿途的风景，绝对值得你为之攀登。你收获的将不仅仅是写出 App 的能力，更是对图形学、操作系统、编译原理更深层次的洞察。</p>
<p>而这些，将让你无论将来回到 Web，还是继续在移动端深耕，都站得更高，看得更远。</p>
<h2 data-id="heading-10">往期文章回顾</h2>
<h4 data-id="heading-11">Flutter 图片编辑器</h4>
<ul>
<li><a href="https://juejin.cn/post/7571067260053585946" target="_blank" title="https://juejin.cn/post/7571067260053585946">掘金文章</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fflutter_monitor_sdk" target="_blank" title="https://pub.dev/packages/flutter_monitor_sdk" ref="nofollow noopener noreferrer">pubdev</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxinqingaa%2Fflutter_monitor_sdk" target="_blank" title="https://github.com/xinqingaa/flutter_monitor_sdk" ref="nofollow noopener noreferrer">github</a></li>
</ul>
<h4 data-id="heading-12">Flutter 全链路监控 SDK</h4>
<ul>
<li><a href="https://juejin.cn/post/7564977973260173338" target="_blank" title="https://juejin.cn/post/7564977973260173338">掘金文章</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fflutter_img_editor" target="_blank" title="https://pub.dev/packages/flutter_img_editor" ref="nofollow noopener noreferrer">pubdev</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxinqingaa%2Fflutter_img_editor" target="_blank" title="https://github.com/xinqingaa/flutter_img_editor" ref="nofollow noopener noreferrer">github</a></li>
</ul>
<h4 data-id="heading-13">Flutter 全场景弹框</h4>
<ul>
<li><a href="https://juejin.cn/post/7538324216594726950" target="_blank" title="https://juejin.cn/post/7538324216594726950">掘金文章</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Funified_popups" target="_blank" title="https://pub.dev/packages/unified_popups" ref="nofollow noopener noreferrer">pubdev</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxinqingaa%2Funified_popups" target="_blank" title="https://github.com/xinqingaa/unified_popups" ref="nofollow noopener noreferrer">github</a></li>
</ul>
<h4 data-id="heading-14">Flutter日历组件</h4>
<ul>
<li><a href="https://juejin.cn/post/7531976064496123931" target="_blank" title="https://juejin.cn/post/7531976064496123931">掘金文章</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fomni_calendar_view" target="_blank" title="https://pub.dev/packages/omni_calendar_view" ref="nofollow noopener noreferrer">pubdev</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxinqingaa%2Fomni_calendar_view" target="_blank" title="https://github.com/xinqingaa/omni_calendar_view" ref="nofollow noopener noreferrer">github</a></li>
</ul>
<h4 data-id="heading-15">日期选择器</h4>
<ul>
<li>
<p><a href="https://juejin.cn/post/7524159959480991753" target="_blank" title="https://juejin.cn/post/7524159959480991753">掘金文章</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fomni_date_picker" target="_blank" title="https://pub.dev/packages/omni_date_picker" ref="nofollow noopener noreferrer">pubdev</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxinqingaa%2Fomni_date_picker" target="_blank" title="https://github.com/xinqingaa/omni_date_picker" ref="nofollow noopener noreferrer">github</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[五分钟实战 Compose 展开/收起动画]]></title>    <link>https://juejin.cn/post/7576130918078251043</link>    <guid>https://juejin.cn/post/7576130918078251043</guid>    <pubDate>2025-11-25T00:56:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576130918078251043" data-draft-id="7573892650816077839" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="五分钟实战 Compose 展开/收起动画"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-11-25T00:56:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            五分钟实战 Compose 展开/收起动画
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T00:56:34.000Z" title="Tue Nov 25 2025 00:56:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64b2a54f63f94ca7a3529032a1b7e8f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764636993&amp;x-signature=bL%2BUaRKB%2BMIDFnmKPgGF8nenGDc%3D" alt="0.png" loading="lazy"/></p>
<p>假设你正在使用 Jetpack Compose 构建一个屏幕界面，并且希望实现某些内容的展开或收起效果 —— 比如常见问题解答部分、下拉面板或筛选菜单。</p>
<p>你可能会想：</p>
<p>我要如何实现平滑的过渡效果呢？</p>
<p>好消息是：Jetpack Compose 让这个需求变得相当容易实现。</p>
<p>该篇文章，让我为大家详细介绍处理展开/收起动画的所有实用方法 —— 每种方法都适用于不同的用例。</p>
<h2 data-id="heading-0">高度的平滑增长</h2>
<p>假设你有一个方块，当用户点击它时，下方会显示一些内容，而你希望整个过程能够自然展开，不出现跳动。</p>
<p>对于这种情况，Jetpack Compose 有一个非常实用的修饰符：<code>animateContentSize()</code>。</p>
<p>下面是一个简单的示例：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ExpandableBox</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> expanded <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }
    Column(modifier = Modifier
        .clickable { expanded = !expanded }
        .background(Color.DarkGray)
        .padding(<span class="hljs-number">16.</span>dp)
        .animateContentSize() <span class="hljs-comment">// 高度变化产生动画</span>
    ) {
        Text(<span class="hljs-string">"Q: What is Compose?"</span>, color = Color.White)
        <span class="hljs-keyword">if</span> (expanded) {
            Text(
                <span class="hljs-string">"A: It's a modern UI toolkit for Android that replaces XML."</span>, color = Color.LightGray, modifier = Modifier.padding(top = <span class="hljs-number">8.</span>dp)
            )
        }
    }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e8abbf6e52f48849732afa0b3e768d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764636993&amp;x-signature=jXMRnachA4o%2BMvAIOEMsoRKgLHk%3D" alt="11.gif" loading="lazy"/></p>
<p>只需要这一个修饰符——就这样，每当高度发生变化时，就能实现平滑过渡。</p>
<p>当然，它的工作原理实际上是这样的：</p>
<p>当你将 <code>animateContentSize</code> 应用到一个 <code>Composable</code> 上时，Compose 会监听该组件内容宽高的变化。如果内容尺寸发生变化（例如，因为内部文本变长、子元素增删等），它会自动在旧尺寸和新尺寸之间执行一个平滑的过渡动画。</p>
<h2 data-id="heading-1">淡入淡出与滑动</h2>
<p>如果你不只是想增加高度，还希望内容在可见时淡入、滑入或放大。</p>
<p>这就来到了 <code>AnimatedVisibility()</code> 的用武之地。</p>
<p>假设你有一个用于显示/隐藏面板的切换按钮。以下是如何巧妙地实现动画效果：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ToggleInfoPanel</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> show <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">true</span>) }
    
    Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
        Button(onClick = { show = !show }) {
            Text(<span class="hljs-keyword">if</span> (show) <span class="hljs-string">"Hide Info"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"Show Info"</span>)
        }
        AnimatedVisibility(
            visible = show, enter = fadeIn() + slideInVertically(), exit = fadeOut() + slideOutVertically()
        ) {
            Box(
                Modifier
                    .fillMaxWidth()
                    .background(Color.Magenta)
                    .padding(<span class="hljs-number">16.</span>dp)
            ) {
                Text(<span class="hljs-string">"This is a toggleable info section"</span>, color = Color.White)
            }
        }
    }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47b901f4c52f41f4ae75b4bac16b8928~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764636993&amp;x-signature=Z4uYBkiHbGu2XDjbcrGRJM%2Bf%2FFU%3D" alt="2.gif" loading="lazy"/></p>
<p>在这里，你控制的是它如何出现或消失，而不仅仅是它是否显示。</p>
<p><code>AnimatedVisibility()</code> 包裹另一个 <code>Composable</code>，并根据其 <code>visible</code> 的值（<code>true</code>/<code>false</code>）来决定是否显示内部内容。当 <code>visible</code> 状态改变时，它会自动执行指定的进入动画或退出动画。</p>
<h2 data-id="heading-2">垂直展开/收起的滑动面板</h2>
<p>假设你正在构建一个筛选下拉菜单或手风琴式部分，并且希望它在展开时从顶部向下滑动打开，在收起时向上收缩回去。</p>
<p>你可以在 <code>AnimatedVisibility()</code> 中使用 <code>expandVertically()</code> 和 <code>shrinkVertically()</code>：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">FilterDropdown</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> expanded <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }
    Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {

        Text(<span class="hljs-string">"Filters"</span>, modifier = Modifier
            .clickable { expanded = !expanded }
            .background(Color.Gray)
            .padding(<span class="hljs-number">12.</span>dp), color = Color.White)

        AnimatedVisibility(
            visible = expanded, enter = expandVertically(), exit = shrinkVertically()
        ) {
            Column(
                Modifier
                    .fillMaxWidth()
                    .background(Color.LightGray)
                    .padding(<span class="hljs-number">16.</span>dp)
            ) {
                Text(<span class="hljs-string">"Sort by Price"</span>)
                Text(<span class="hljs-string">"Sort by Rating"</span>)
                Text(<span class="hljs-string">"Sort by Availability"</span>)
            }
        }
    }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa5d12b179b749daad88cd609a0b53dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764636993&amp;x-signature=GYby4y4yqCPFI7NVixaAHXdmlNA%3D" alt="3.gif" loading="lazy"/></p>
<p>流畅的垂直滑动效果，非常适合可展开的面板。</p>
<h2 data-id="heading-3">多个元素的动画</h2>
<p>如果你想让高度、背景颜色和透明度在展开时同步进行动画处理，该怎么做呢？</p>
<p>轮到 <code>updateTransition()</code> 大显身手了。它的使用稍微复杂一些，但能让你完全掌控动画效果：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">FancyExpandBox</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> expanded <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }
    <span class="hljs-keyword">val</span> transition = updateTransition(targetState = expanded, label = <span class="hljs-string">"transition"</span>)
    <span class="hljs-keyword">val</span> txtSize <span class="hljs-keyword">by</span> transition.animateInt(label = <span class="hljs-string">"text"</span>) {
        <span class="hljs-keyword">if</span> (it) <span class="hljs-number">24</span> <span class="hljs-keyword">else</span> <span class="hljs-number">14</span>
    }
    <span class="hljs-keyword">val</span> height <span class="hljs-keyword">by</span> transition.animateDp(label = <span class="hljs-string">"height"</span>) {
        <span class="hljs-keyword">if</span> (it) <span class="hljs-number">200.</span>dp <span class="hljs-keyword">else</span> <span class="hljs-number">60.</span>dp
    }
    <span class="hljs-keyword">val</span> bgColor <span class="hljs-keyword">by</span> transition.animateColor(label = <span class="hljs-string">"color"</span>) {
        <span class="hljs-keyword">if</span> (it) Color.Blue <span class="hljs-keyword">else</span> Color.Gray
    }
    <span class="hljs-keyword">val</span> alpha <span class="hljs-keyword">by</span> transition.animateFloat(label = <span class="hljs-string">"alpha"</span>) {
        <span class="hljs-keyword">if</span> (it) <span class="hljs-number">1f</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0.5f</span>
    }
    Box(
        modifier = Modifier
            .clickable { expanded = !expanded }
            .fillMaxWidth()
            .height(height)
            .background(bgColor.copy(alpha = alpha))
            .padding(<span class="hljs-number">16.</span>dp)
    ) {
        Text(<span class="hljs-string">"Tap to expand or collapse"</span>, color = Color.White, fontSize = txtSize.sp)
    }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47ab002bcdb04b9aa4d72fc3b6a09ff3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764636993&amp;x-signature=0jUVQU9C1p9GBfW5FLF%2Fuc9V0yw%3D" alt="4.gif" loading="lazy"/></p>
<p><em>该方法需要添加 <code>androidx.compose.animation:animation-core</code> 依赖。</em></p>
<p>你可以在这里对任何属性进行动画处理 —— 边距、形状、文字大小 —— 它们都会一起过渡变化。</p>
<p><code>updateTransition</code> 是一个状态驱动的动画协调器。它通过观察一个关键状态的变化，自动管理一组相关视觉属性的动画，将它们从旧状态的目标值流畅地过渡到新状态的目标值，非常适合处理复杂的、多步骤的 UI 状态切换动画。</p>
<h2 data-id="heading-4">为布局权重做动画</h2>
<p>如果你有两个面板并排放置或垂直堆叠，并且希望一个面板变大而另一个面板变小 —— 那就对权重进行动画处理！</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">WeightAnimationDemo</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> expanded <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }
    <span class="hljs-keyword">val</span> weight <span class="hljs-keyword">by</span> animateFloatAsState(targetValue = <span class="hljs-keyword">if</span> (expanded) <span class="hljs-number">0.8f</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0.3f</span>)
    Column(modifier = Modifier.height(<span class="hljs-number">200.</span>dp)) {
        Box(
            modifier = Modifier
                .weight(weight)
                .fillMaxWidth()
                .background(Color.Blue)
                .clickable { expanded = !expanded })
        Box(
            modifier = Modifier
                .weight(<span class="hljs-number">1f</span> - weight)
                .fillMaxWidth()
                .background(Color.DarkGray)
        )
    }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7de6907433c345b494afb5efa2a24d16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764636993&amp;x-signature=VKU%2BRViYZTo%2FR2c3ssKTFGFc114%3D" alt="5.gif" loading="lazy"/></p>
<p>点击顶部框会平滑地调整两个部分的大小。</p>
<h2 data-id="heading-5">总结</h2>
<ul>
<li>如果你的视图只是大小发生增长或缩小 —— <code>animateContentSize()</code>。</li>
<li>如果你想要淡入、滑动或缩放动画 —— <code>AnimatedVisibility()</code>。</li>
<li>对于更高级的布局变化或组合效果 —— <code>updateTransition()</code>。</li>
<li>想要使用布局权重调整大小？ —— <code>animateFloatAsState()</code>。</li>
</ul>
<p>一旦你熟悉了这些工具，你会发现在 Compose 中构建大多数展开/收起的用户界面变得超级直观 —— 而且它们比使用 <code>XML</code> 时更加流畅，更加直观，更加方便。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官说: "你怎么把 Radio 组件玩出花的，教教我！ “]]></title>    <link>https://juejin.cn/post/7576158801972969518</link>    <guid>https://juejin.cn/post/7576158801972969518</guid>    <pubDate>2025-11-25T01:59:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576158801972969518" data-draft-id="7571758212473536563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官说: &quot;你怎么把 Radio 组件玩出花的，教教我！ “"/> <meta itemprop="keywords" content="前端,开源"/> <meta itemprop="datePublished" content="2025-11-25T01:59:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官说: "你怎么把 Radio 组件玩出花的，教教我！ “
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T01:59:53.000Z" title="Tue Nov 25 2025 01:59:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>面试官问我 <code>radio</code> 组件知道怎么实现吗？我把我的组件库 <code>radio</code> 网页丢给它，我说我这个 <code>radio</code> 组件什么样式都支持，你看这是传统样式：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75c2ad19d3cb4428a13e7c8a0399aa21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764640792&amp;x-signature=ml%2BhD5AE6jLUQLfPnOhfj4l96Io%3D" alt="image.png" loading="lazy"/></p>
<p>你看，这是自定义样式，理论上什么样式都可以：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de85c9e8911649baab344ed9773f44f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764640792&amp;x-signature=iqFlFs2EvF0D0%2BMvItCLhOOOEfw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9bf5a0123034518b14bb1f05482abef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764640792&amp;x-signature=EBol8%2FM%2Bjpwly5V5FEZ%2BCVemlnY%3D" alt="image.png" loading="lazy"/></p>
<p>然后我嘿嘿一笑说："我的 <code>radio</code> 组件本质上不涉及任何样式，只负责岁月静好，使用者负责貌美如花！"</p>
<p>最后面试完毕，面试官很满意，并问这个怎么实现的，我就写一篇文章来说说吧！</p>
<p>这是上面组件的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.frontlight.tech%2Fradio%2Fexample%2Ftailwind-traditional-example" target="_blank" title="https://www.frontlight.tech/radio/example/tailwind-traditional-example" ref="nofollow noopener noreferrer">网站地址</a></p>
<p>更多组件库教程，欢迎在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flio-mengxiang%2Ft-ui" target="_blank" title="https://github.com/lio-mengxiang/t-ui" ref="nofollow noopener noreferrer">github</a> 上给个 star，加群交流哦！</p>
<p>本文章及更多案例已经在官网上了，大家也可以去看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.frontlight.tech%2Fradio" target="_blank" title="https://www.frontlight.tech/radio" ref="nofollow noopener noreferrer">本文链接</a></p>
<h2 data-id="heading-1">可自定义的核心</h2>
<p>正常的 <code>radio</code> 组件主要是通过 <code>&lt;input&gt;</code> 标签属性 <code>type="radio"</code> 实现的，浏览器都会显示一个默认的样式</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6211bf2122614c088f5f3de73dbf1438~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764640792&amp;x-signature=429AOW6GsoGnPXBmS0u5kKNk0jM%3D" alt="image.png" loading="lazy"/></p>
<p>所以我们要自定义样式，就不能使用原生的 <code>radio</code>样式，那么问题来了，你是不是只要实现了 <code>radio</code> 内在的逻辑，其实也就是实现了 <code>radio</code> 组件，有人会问？内在的逻辑是什么呢？</p>
<ul>
<li>其一，选中态逻辑，就是多个元素，我们只要点击，就是选中态（checked）</li>
<li>其二，传入 <code>disabled</code> 参数，那么这个元素就不能点击（或者 <code>cursor</code>（也就是鼠标的状态）设置为 <code>not-allowed</code> 也就是不可选中）</li>
<li>其三，原生 <code>radio</code> 并不支持  <code>readyonly</code> 状态，但我们自定义组件应该实现，在表单中， <code>readyonly</code> 是一种很常见的业务需求。所以传入 <code>readyonly</code> 参数，那么这个元素就不能改变状态，只能看。</li>
<li>最后最最重要的逻辑是多个 <code>radio</code> 元素组合时，你只能选中其中一个，即单选的逻辑。</li>
</ul>
<p>所以我们只要实现了上述逻辑，那就是跟原生的单选就没有区别了。</p>
<p>但问题来了，能不能既保持 <code>radio</code> 组件的原本的逻辑，还能支持自定义呢？也就是用户如果还是希望使用原生 <code>radio</code> 我们支持，自定义也支持呢？这样的话，语义性完好的基础上还能自由拓展，简直完美！</p>
<p>答案是肯定的，我们的组件就是这样的。</p>
<p>在介绍核心逻辑之前，我们先说一个小技巧。</p>
<h2 data-id="heading-2">radio 组件基本结构</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6211bf2122614c088f5f3de73dbf1438~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764640792&amp;x-signature=429AOW6GsoGnPXBmS0u5kKNk0jM%3D" alt="image.png" loading="lazy"/></p>
<p>首先先介绍一一个小技巧，如上图，一般 <code>radio</code> 包含了一个圆圈表示是否选中，圆圈的右边是文字，正常来说，我们点击圆圈才能选中，可这些组件库如何实现的点击圆圈右边的文字也能选中圆圈呢？这就涉及到 <code>&lt;label&gt;</code> 标签了。</p>
<p>如上图是 <code>MDN</code> 中的方式:</p>
<pre><code class="hljs language-html" lang="html">  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"huey"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"drone"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"huey"</span> <span class="hljs-attr">checked</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"huey"</span>&gt;</span>Huey<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ul>
<li>首先需要在 <code>input</code> 上使用 <code>id</code> 属性</li>
<li>然后在 <code>label</code> 组件上使用 <code>for</code>属性，跟 <code>id</code> 的值一致即可实现点击 <code>label</code> 标签就能选中对应的 <code>radio</code></li>
</ul>
<p>但这种方式比较繁琐，我们的组件使用的另一种方式达到同样的效果，就是 <code>label</code> 将 <code>input</code> 标签包裹就好：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"huey"</span> /&gt;</span>
huey
<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
</code></pre>
<p>好了，接下来我们梳理一下状态的切换逻辑，这样我们实现起来就有一个蓝图：</p>
<ul>
<li>首先点击 <code>label</code> ，也就是绑定在  <code>label</code> 上的 <code>onClick</code> 事件</li>
<li>然后这个 <code>onClick</code> 事件会触发 <code>input</code>（radio） 上的 <code>onClick</code> 事件</li>
<li><code>input</code> 上的 <code>onClick</code> 事件会触发自身的 <code>onChange</code> 事件，也就是选中的value 值在 <code>onChange</code> 的时候可以设置为点击的 <code>input</code> 的值，
<ul>
<li>这里有些新同学可能不知道 <code>input</code> 这类表单元素，目的就是收集值，也就是可以传入 <code>value</code> 属性。</li>
</ul>
</li>
</ul>
<p>整体逻辑很清晰，也很简单，但其中的坑不少，我们把坑介绍完，基本上你就可以实现一个自己的 <code>radio</code> 组件了</p>
<h2 data-id="heading-3">核心逻辑梳理</h2>
<p>如上所述，我们第一步是给 <code>label</code> 标签绑定 <code>onClick</code> 事件。</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">const</span> onLabelClick = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
    <span class="hljs-comment">// 只读或禁用时，阻止点击产生任何行为</span>
    <span class="hljs-keyword">if</span> (disabled || readonly) {
      e.<span class="hljs-title function_">preventDefault</span>();
      <span class="hljs-keyword">return</span>;
    }
    rest?.<span class="hljs-property">onClick</span>?.(e);
  };

</code></pre>
<p>需要注意</p>
<ul>
<li>当外界传入 <code>disabled</code> 或者 <code>readonly</code> 参数的时候，我们直接 <code>return</code></li>
<li>注意要使用 <code> e.preventDefault();</code> 来组织默认事件，默认事件就是点击 <code>label</code> 触发 <code>input</code> 的 <code>onClick</code> 事件，从而阻止<code>input</code> 上值被选中</li>
</ul>
<p>然后需要给 <code>input</code> 绑定 <code>onClick</code> 事件</p>
<pre><code class="hljs language-javascript" lang="javascript">onClick={<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
   <span class="hljs-comment">// 阻止 input 的点击事件冒泡，避免重复处理</span>
   e.<span class="hljs-title function_">stopPropagation</span>();
}}
</code></pre>
<p>这里需要注意的是</p>
<ul>
<li>调用 <code>e.stopPropagation();</code> 防止用户在直接点击 <code>input</code>（radio） 的时候，事件冒泡到 <code>label</code> 标签，从而多次触发 <code>label</code> 的 <code>onClick</code> 事件。</li>
</ul>
<p>最后，就是在 <code>input</code> 绑定 <code>onChange</code> 事件</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-keyword">const</span> [checked, setChecked] = <span class="hljs-title function_">useMergeValue</span>(<span class="hljs-literal">false</span>, {
    <span class="hljs-attr">value</span>: propsChecked,
    <span class="hljs-attr">defaultValue</span>: mergeProps.<span class="hljs-property">defaultChecked</span>,
  });
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onChange</span> = (<span class="hljs-params">e</span>) =&gt; {
    e.<span class="hljs-title function_">persist</span>();
    e.<span class="hljs-title function_">stopPropagation</span>();

    <span class="hljs-comment">// 禁用或只读都不改变状态，不触发外部 onChange</span>
    <span class="hljs-keyword">if</span> (disabled || readonly) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (context.<span class="hljs-property">group</span>) {
      context?.<span class="hljs-property">onChangeValue</span>?.(value, e);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(<span class="hljs-string">'checked'</span> <span class="hljs-keyword">in</span> props) &amp;&amp; !checked) {
      <span class="hljs-title function_">setChecked</span>(<span class="hljs-literal">true</span>);
    }
    <span class="hljs-keyword">if</span> (!checked) {
      propsOnChange?.(<span class="hljs-literal">true</span>, e);
    }
  };
</code></pre>
<p>其中细节很多，我们简单说一下：</p>
<ul>
<li><code>e.persist();</code> 在 <code>react</code> 17 之前需要（现在都已经 19 版本，是可以删掉这行代码的），大概介绍下它的作用</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 16 及之前版本的问题，在 setTimeout 中无法获得正常的事件对象的值</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params">e</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">type</span>); <span class="hljs-comment">// 正常访问</span>
  
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">type</span>); <span class="hljs-comment">// null 或 undefined！</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">target</span>); <span class="hljs-comment">// null！</span>
  }, <span class="hljs-number">1000</span>);
};
</code></pre>
<ul>
<li><code>e.stopPropagation();</code> 阻止事件冒泡
<ul>
<li>如果 Radio 嵌套 Radio，点击里面的 Radio 就会让 <code>onChnage</code> 事件冒泡到外层去，这不是我们希望的，所以隔离一下</li>
</ul>
</li>
<li><code>if (disabled || readonly) return;</code> 检查是否是 disabled 或者 readonly 状态，这样的状态不能让它触发 <code>onChange</code> 事件</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (context.<span class="hljs-property">group</span>) {
  context?.<span class="hljs-property">onChangeValue</span>?.(value, e);
}
</code></pre>
<p>这个我们暂且不讲，是要配合 <code>Radio.Group</code> 组件使用，这个 context 是使用 <code>useContext</code> api 获取的 <code>Radio.Group</code> 透传的数据。也就是状态最终会被  <code>Radio.Group</code> 接管。</p>
<pre><code class="hljs language-javascript" lang="javascript">} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(<span class="hljs-string">'checked'</span> <span class="hljs-keyword">in</span> props) &amp;&amp; !checked) {
  <span class="hljs-title function_">setChecked</span>(<span class="hljs-literal">true</span>);
}
</code></pre>
<ul>
<li>
<p>作用：独立使用时的状态管理</p>
</li>
<li>
<p><code>!('checked' in props)</code>：检查是否是<strong>非受控组件</strong>，这是识别是否是受控还是非受控组件的关键。</p>
<ul>
<li>没有传入 <code>checked</code> prop → 组件自己管理状态</li>
</ul>
</li>
</ul>
<p>这里非常非常细节，有人可能疑惑了，为什么要这么做，而不是用 <code>checked === undefined</code> 来判断，因为不传的值默认不是 <code>undefined</code> 吗？我们来解释一下</p>
<p>大家需要注意，假设你这样传入 <code>checked</code> 参数</p>
<pre><code class="hljs language-ini" lang="ini">&lt;Radio <span class="hljs-attr">checked</span>={undefiend} /&gt;
</code></pre>
<ul>
<li><code>'checked' in props</code> 得到的是 <code>true</code> 因为你还是传了 <code>undefined</code> 值</li>
</ul>
<p>只有这样</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Radio</span> /&gt;</span>
</code></pre>
<ul>
<li><code>'checked' in props</code> 得到的是 <code>false</code>, 也就是什么也没传，代表是非受控组件、</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(<span class="hljs-string">'checked'</span> <span class="hljs-keyword">in</span> props) &amp;&amp; !checked) {
  <span class="hljs-title function_">setChecked</span>(<span class="hljs-literal">true</span>);
}
</code></pre>
<p>然后 <code> setChecked(true);</code> 这个很关键，有的人说，<code>!('checked' in props)</code> 不是代表非受控组件吗，非受控组件是组件自己控制值，怎么还有直接 <code>setCheck</code> 控制，这不是受控组件的控制的方式吗？</p>
<p>这里需要解释两点</p>
<ul>
<li>
<p>首先，很多组件库，一般都会用受控的形式来模拟非受控，为什么呢？因为我们要确确实实拿到 Radio 组件的 <code>checked</code>（选中） 还是 非 <code>checked</code> 状态，如果都交给原生，我们获取很不方便</p>
</li>
<li>
<p>其次 <code>useMergeValue</code> 是组件库很常用函数，它把受控和非受控组合起来，是个非常实用的函数，我们来介绍一下逻辑。相信你写组件库也一定会用到。</p>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-string">'use client'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { isUndefined } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils'</span>;
<span class="hljs-keyword">import</span> { usePrevious } <span class="hljs-keyword">from</span> <span class="hljs-string">'./use-previous'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useMergeValue&lt;T&gt;(
  <span class="hljs-attr">defaultStateValue</span>: T,
  props?: {
    defaultValue?: T;
    value?: T;
  },
): [T, <span class="hljs-title class_">React</span>.<span class="hljs-property">Dispatch</span>&lt;<span class="hljs-title class_">React</span>.<span class="hljs-property">SetStateAction</span>&lt;T&gt;&gt;, T] {
  <span class="hljs-keyword">const</span> { defaultValue, value } = props || {};
  <span class="hljs-keyword">const</span> firstRenderRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> prevPropsValue = <span class="hljs-title function_">usePrevious</span>(props?.<span class="hljs-property">value</span>);

  <span class="hljs-keyword">const</span> [stateValue, setStateValue] = useState&lt;T&gt;(
    !<span class="hljs-title function_">isUndefined</span>(value) ? value : !<span class="hljs-title function_">isUndefined</span>(defaultValue) ? defaultValue : defaultStateValue,
  );

  <span class="hljs-comment">// 受控转为非受控的时候，需要做转换处理</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (firstRenderRef.<span class="hljs-property">current</span>) {
      firstRenderRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> &amp;&amp; prevPropsValue !== value) {
      <span class="hljs-title function_">setStateValue</span>(value);
    }
  }, [value]);

  <span class="hljs-keyword">const</span> mergedValue = <span class="hljs-title function_">isUndefined</span>(value) ? stateValue : value;

  <span class="hljs-keyword">return</span> [mergedValue, setStateValue, stateValue];
}
</code></pre>
<p>这里简单解释一下，其实就是你传了 <code>value</code> 我就认为你是受控组件，然后 <code>value</code> 就透传出去， <code>defaultValue</code> 或者组件库想默认给个默认值， 我会用这个值其初始化 <code>stateValue</code> 然后传出去。并且 <code>setStateValue</code> 方法能改变其值。</p>
<p><code>setStateValue</code> 其实在传入 <code>value</code> 的情况下，也没什么用，因为改变不了 <code>value</code> 的值。</p>
<h2 data-id="heading-4">如何将状态传递给子组件</h2>
<p>我们可以使用 <code>context</code> api，将最终的 <code>checked</code>, <code>disabled</code>, <code>readonly</code> 状态让子组件使用 <code>useContext</code> 来获取。</p>
<pre><code class="hljs language-javascript" lang="javascript">    &lt;<span class="hljs-title class_">RadioContext</span>.<span class="hljs-property">Provider</span> value={{ checked, disabled, readonly }}&gt;
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">label</span> {<span class="hljs-attr">...rest</span>} <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onLabelClick}</span> <span class="hljs-attr">aria-disabled</span>=<span class="hljs-string">{!!disabled}</span> <span class="hljs-attr">aria-readonly</span>=<span class="hljs-string">{!!readonly}</span> <span class="hljs-attr">aria-checked</span>=<span class="hljs-string">{!!checked}</span>&gt;</span>
        {/* 为什么没有 readonly 状态， 标准里本来也没有 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"radio"</span>&gt;</span>
        {children}
      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">RadioContext.Provider</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-5">如何保持语义性</h2>
<p>我们只需要将 <code>input</code> 组件依然接受之前我们的状态，就能保持原生 <code>radio</code> 组件的语义性，所以我们完善一下 <code>input</code> 组件,也就是把之前的状态传递过去即可：</p>
<pre><code class="hljs language-javascript" lang="javascript">    &lt;<span class="hljs-title class_">RadioContext</span>.<span class="hljs-property">Provider</span> value={{ checked, disabled, readonly }}&gt;
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">label</span> {<span class="hljs-attr">...rest</span>} <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onLabelClick}</span> <span class="hljs-attr">aria-disabled</span>=<span class="hljs-string">{!!disabled}</span> <span class="hljs-attr">aria-readonly</span>=<span class="hljs-string">{!!readonly}</span> <span class="hljs-attr">aria-checked</span>=<span class="hljs-string">{!!checked}</span>&gt;</span>
        {/* 为什么没有 readonly 状态， 标准里本来也没有 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
          <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span>
          <span class="hljs-attr">disabled</span>=<span class="hljs-string">{!!disabled}</span>
          <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>
          <span class="hljs-attr">type</span>=<span class="hljs-string">"radio"</span>
          <span class="hljs-attr">checked</span>=<span class="hljs-string">{!!checked}</span>
          <span class="hljs-attr">onChange</span>=<span class="hljs-string">{onChange}</span>
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
            // 阻止 input 的点击事件冒泡，避免重复处理
            e.stopPropagation();
          }}
          aria-readonly={!!readonly}
        /&gt;
        {children}
      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span>
    &lt;/<span class="hljs-title class_">RadioContext</span>.<span class="hljs-property">Provider</span>&gt;
</code></pre>
<h2 data-id="heading-6">Radio Group 逻辑</h2>
<p>这里简单介绍一下如何使用 <code>Radio Group</code> 组件包裹上面我们完成的 <code>Radio</code> 组件。
核心逻辑为, 使用同样是 <code>useContext</code> api，我们命名为 <code>RadioGroupContext</code> 来把当前选中的 <code>Radio</code> 标签的 <code>value</code> 传递即可 ：</p>
<pre><code class="hljs language-javascript" lang="javascript">    &lt;div role=<span class="hljs-string">"radiogroup"</span> {...rest}&gt;
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">RadioGroupContext.Provider</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">onChangeValue</span>,
          <span class="hljs-attr">type</span>,
          <span class="hljs-attr">value</span>,
          <span class="hljs-attr">disabled</span>,
          <span class="hljs-attr">readonly</span>,
          <span class="hljs-attr">group:</span> <span class="hljs-attr">true</span>,
          <span class="hljs-attr">name</span>,
        }}
      &gt;</span>
        {children}
      <span class="hljs-tag">&lt;/<span class="hljs-name">RadioGroupContext.Provider</span>&gt;</span></span>
    &lt;/div&gt;
</code></pre>
<h2 data-id="heading-7">小结</h2>
<p>文章把主要的核心逻辑梳理了一下，并没有过多解释每行代码。如果你想讨论关于如何实现自己组件库的的内容，欢迎加群一起讨论，组件还在不断拓展中，最终会对标大厂组件库。</p>
<p>其实对于一个前端来说，组件库算是囊括所有日常常见的前端技术了，无论是学习还是面试，都是绝佳的项目。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.frontlight.tech%2F" target="_blank" title="https://www.frontlight.tech/" ref="nofollow noopener noreferrer">目前的官网</a></li>
<li>感谢 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flio-mengxiang%2Ft-ui" target="_blank" title="https://github.com/lio-mengxiang/t-ui" ref="nofollow noopener noreferrer">github 点赞</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3样式深度选择器：为什么我们需要:deep()？]]></title>    <link>https://juejin.cn/post/7576129509935546387</link>    <guid>https://juejin.cn/post/7576129509935546387</guid>    <pubDate>2025-11-24T23:42:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576129509935546387" data-draft-id="7576181242581647423" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3样式深度选择器：为什么我们需要:deep()？"/> <meta itemprop="keywords" content="Vue.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-24T23:42:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="良山有风来"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3样式深度选择器：为什么我们需要:deep()？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    良山有风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T23:42:23.000Z" title="Mon Nov 24 2025 23:42:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    46
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是不是也遇到过这样的场景？在Vue 3项目里，想要修改子组件样式，结果发现不管怎么写CSS都不生效。明明代码看起来没问题，但样式就是无法穿透到子组件内部。</p>
<p>这种情况在前端开发中太常见了。特别是在使用第三方UI库的时候，想要微调某个组件的样式，却发现自己被CSS作用域限制得死死的。</p>
<p>本文将带你深入了解Vue 3中的样式深度选择器<code>:deep()</code>，从它诞生的背景到具体的使用方法，再到实际开发中的最佳实践。读完这篇文章，你将彻底掌握如何优雅地解决组件样式穿透问题，再也不用为修改子组件样式而头疼了。</p>
<h2 data-id="heading-0">为什么需要深度选择器？</h2>
<p>在理解<code>:deep()</code>之前，我们得先明白Vue组件样式的作用域问题。Vue单文件组件中的<code>&lt;style&gt;</code>标签默认是全局作用域的，这意味着你在一个组件里写的样式可能会影响到其他组件。</p>
<p>为了解决这个问题，Vue引入了<code>scoped</code>样式。当你在<code>&lt;style&gt;</code>标签上添加<code>scoped</code>属性时，Vue会自动为组件中的每个元素添加一个唯一的属性，然后通过属性选择器来确保样式只作用于当前组件。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"demo"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">child-component</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.demo</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-comment">/* 这个样式无法影响到child-component内部的元素 */</span>
<span class="hljs-selector-class">.child-content</span> {
  <span class="hljs-attribute">color</span>: red; <span class="hljs-comment">/* 不会生效！ */</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>但这样带来了新的问题：当我们确实需要修改子组件样式时，作用域样式就成了障碍。想象一下，你使用了某个UI库的按钮组件，但需要稍微调整它的内边距，这时候该怎么办？</p>
<p>这就是深度选择器诞生的原因。它提供了一种"穿透"组件样式作用域的方法，让我们能够在父组件中修改子组件的样式。</p>
<h2 data-id="heading-1">:deep()的前世今生</h2>
<p>在Vue 2时代，我们使用<code>&gt;&gt;&gt;</code>、<code>/deep/</code>或<code>::v-deep</code>来实现样式穿透。但这些语法存在一些问题：有的已经被CSS规范废弃，有的浏览器支持不一致，还有的写法比较冗长。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- Vue 2中的各种深度选择器写法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 原生CSS的深度选择器，某些浏览器不支持 */</span>
<span class="hljs-selector-class">.parent</span> &gt;&gt;&gt; <span class="hljs-selector-class">.child</span> { <span class="hljs-attribute">color</span>: red; }

<span class="hljs-comment">/* Sass等预处理器中的写法 */</span>
<span class="hljs-selector-class">.parent</span> /deep/ <span class="hljs-selector-class">.child</span> { <span class="hljs-attribute">color</span>: red; }

<span class="hljs-comment">/* Vue特有的语法 */</span>
<span class="hljs-selector-class">.parent</span> ::v-deep .child { <span class="hljs-attribute">color</span>: red; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>Vue 3团队在设计新的样式系统时，决定统一这个语法。他们选择了<code>:deep()</code>作为新的深度选择器，这既符合CSS规范的发展趋势，也提供了更好的开发体验。</p>
<p><code>:deep()</code>本质上是一个CSS伪类，它在编译时会被Vue的处理工具转换为适当的选择器，确保样式能够正确穿透到子组件。</p>
<h2 data-id="heading-2">:deep()的基本用法</h2>
<p>让我们通过几个实际的例子来看看<code>:deep()</code>怎么用。</p>
<p>最基本的用法就是在需要穿透到子组件的选择器前加上<code>:deep()</code>：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">child-component</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child-comp"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-comment">/* 使用:deep()穿透到子组件 */</span>
<span class="hljs-selector-class">.parent</span> :<span class="hljs-built_in">deep</span>(.child-comp) {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f0f0f0</span>;
}

<span class="hljs-comment">/* 也可以这样写 */</span>
:<span class="hljs-built_in">deep</span>(.child-comp) {
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
}
</span></code></pre>
<p>在实际项目中，我们经常需要修改第三方组件的样式。比如使用Element Plus的按钮组件：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"custom-btn"</span>&gt;</span>
      自定义按钮
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.page</span> :<span class="hljs-built_in">deep</span>(.custom-btn) {
  <span class="hljs-comment">/* 修改Element Plus按钮的内边距 */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span> <span class="hljs-number">24px</span>;
  
  <span class="hljs-comment">/* 修改边框半径 */</span>
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
  
  <span class="hljs-comment">/* 修改背景颜色 */</span>
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#4f46e5</span>;
}

<span class="hljs-selector-class">.page</span> :<span class="hljs-built_in">deep</span>(.custom-btn:hover) {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#4338ca</span>;
}
</span></code></pre>
<p>需要注意的是，<code>:deep()</code>应该用在选择器的开头，或者紧跟在父选择器之后。错误的使用方式会导致样式不生效：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 错误的写法 - :deep()不能放在最后 */</span>
<span class="hljs-selector-class">.parent</span> <span class="hljs-selector-class">.child</span> :<span class="hljs-built_in">deep</span>() {
  <span class="hljs-attribute">color</span>: red;
}

<span class="hljs-comment">/* 错误的写法 - 选择器结构不合理 */</span>
:<span class="hljs-built_in">deep</span>() .parent .child {
  <span class="hljs-attribute">color</span>: red;
}

<span class="hljs-comment">/* 正确的写法 */</span>
<span class="hljs-selector-class">.parent</span> :<span class="hljs-built_in">deep</span>(.child) {
  <span class="hljs-attribute">color</span>: red;
}

:<span class="hljs-built_in">deep</span>(.parent .child) {
  <span class="hljs-attribute">color</span>: red;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-3">实际场景中的应用技巧</h2>
<p>在实际开发中，我们会遇到各种需要使用<code>:deep()</code>的场景。下面分享几个实用的技巧。</p>
<p><strong>场景一：修改UI组件库的默认样式</strong></p>
<p>假设我们在使用Naive UI的表格组件，需要调整表头的样式：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"data-table"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">n-data-table</span>
      <span class="hljs-attr">:columns</span>=<span class="hljs-string">"columns"</span>
      <span class="hljs-attr">:data</span>=<span class="hljs-string">"data"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"custom-table"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.data-table</span> :<span class="hljs-built_in">deep</span>(.custom-table .n-table-thead) {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f8fafc</span>;
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
}

<span class="hljs-selector-class">.data-table</span> :<span class="hljs-built_in">deep</span>(.custom-table .n-table-th) {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span> <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
}

<span class="hljs-selector-class">.data-table</span> :<span class="hljs-built_in">deep</span>(.custom-table .n-table-td) {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">13px</span>;
}
</span></code></pre>
<p><strong>场景二：在插槽内容中应用样式</strong></p>
<p>当使用插槽时，插槽内容的样式也需要通过<code>:deep()</code>来穿透：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">modal-dialog</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-title"</span>&gt;</span>自定义标题<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">content</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这里是对话框内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">modal-dialog</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 修改对话框容器的样式 */</span>
:<span class="hljs-built_in">deep</span>(.modal-container) {
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-number">25px</span> -<span class="hljs-number">5px</span> <span class="hljs-built_in">rgb</span>(<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> / <span class="hljs-number">0.1</span>);
}

<span class="hljs-comment">/* 修改插槽内容的样式 */</span>
:<span class="hljs-built_in">deep</span>(.dialog-title) {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#1f2937</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">16px</span>;
}

:<span class="hljs-built_in">deep</span>(.dialog-content) {
  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.6</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#6b7280</span>;
}
</span></code></pre>
<p><strong>场景三：配合CSS变量使用</strong></p>
<p><code>:deep()</code>还可以与CSS变量结合，实现更灵活的样式定制：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"theme-wrapper"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">third-party-component</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"custom-theme"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.theme-wrapper</span> {
  <span class="hljs-comment">/* 定义CSS变量 */</span>
  <span class="hljs-attr">--primary-color</span>: <span class="hljs-number">#3b82f6</span>;
  <span class="hljs-attr">--secondary-color</span>: <span class="hljs-number">#ef4444</span>;
  <span class="hljs-attr">--border-radius</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.theme-wrapper</span> :<span class="hljs-built_in">deep</span>(.custom-theme) {
  <span class="hljs-comment">/* 在深度选择器中使用CSS变量 */</span>
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--primary-color);
  <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">var</span>(--secondary-color);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-built_in">var</span>(--border-radius);
}

<span class="hljs-selector-class">.theme-wrapper</span> :<span class="hljs-built_in">deep</span>(.custom-theme .item) {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--primary-color);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--border-radius) - <span class="hljs-number">2px</span>);
}
</span></code></pre>
<h2 data-id="heading-4">性能与最佳实践</h2>
<p>虽然<code>:deep()</code>很强大，但滥用会导致样式难以维护和性能问题。下面是一些最佳实践建议：</p>
<p><strong>1. 尽量少用深度选择器</strong></p>
<p>深度选择器破坏了组件的样式封装，应该作为最后的手段。优先考虑通过props传递样式配置，或者使用CSS变量。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 不推荐的写法：过度使用:deep() --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
:<span class="hljs-built_in">deep</span>(.child-component) {
  <span class="hljs-comment">/* 各种样式覆盖 */</span>
}

:<span class="hljs-built_in">deep</span>(.child-component .title) {
  <span class="hljs-comment">/* 更多样式覆盖 */</span>
}

:<span class="hljs-built_in">deep</span>(.child-component .content) {
  <span class="hljs-comment">/* 继续覆盖 */</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 推荐的写法：通过CSS变量定制 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">child-component</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"custom-child"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.custom-child</span> {
  <span class="hljs-attr">--child-primary-color</span>: <span class="hljs-number">#3b82f6</span>;
  <span class="hljs-attr">--child-padding</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attr">--child-border-radius</span>: <span class="hljs-number">8px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><strong>2. 保持选择器的简洁性</strong></p>
<p>过于复杂的选择器会影响性能，特别是在大型应用中。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 不推荐：选择器过于复杂 */</span>
<span class="hljs-selector-class">.container</span> :<span class="hljs-built_in">deep</span>(.child &gt; .grandchild .item:first-of-type span.text) {
  <span class="hljs-attribute">color</span>: red;
}

<span class="hljs-comment">/* 推荐：尽量简化选择器 */</span>
<span class="hljs-selector-class">.container</span> :<span class="hljs-built_in">deep</span>(.text-highlight) {
  <span class="hljs-attribute">color</span>: red;
}
</span></code></pre>
<p><strong>3. 使用有意义的类名</strong></p>
<p>为需要深度样式的元素添加有意义的类名，提高代码可读性。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">third-party-component</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"custom-styling"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 清晰的类名让代码更易理解 */</span>
<span class="hljs-selector-class">.custom-styling</span> :<span class="hljs-built_in">deep</span>(.tp-button--primary) {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#10b981</span>;
}

<span class="hljs-selector-class">.custom-styling</span> :<span class="hljs-built_in">deep</span>(.tp-button--primary:hover) {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#059669</span>;
}
</span></code></pre>
<h2 data-id="heading-5">常见问题与解决方案</h2>
<p>在实际使用<code>:deep()</code>时，开发者经常会遇到一些问题。这里总结几个常见的情况：</p>
<p><strong>问题一：样式不生效</strong></p>
<p>这种情况通常是因为选择器写得不对，或者Vue版本不支持。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 可能的问题：Vue版本过低 */</span>
<span class="hljs-comment">/* 确保使用Vue 3.2+ 版本 */</span>

<span class="hljs-comment">/* 可能的问题：选择器结构错误 */</span>
<span class="hljs-selector-class">.parent</span> :<span class="hljs-built_in">deep</span>(.child .grandchild) {
  <span class="hljs-comment">/* 正确的结构 */</span>
}

<span class="hljs-comment">/* 可能的问题：缺少必要的类名 */</span>
<span class="hljs-comment">/* 检查子组件是否真的有这个类名 */</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><strong>问题二：样式覆盖冲突</strong></p>
<p>当多个<code>:deep()</code>选择器 targeting 同一个元素时，可能会出现样式冲突。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 方案一：提高选择器特异性 */</span>
<span class="hljs-selector-class">.page-container</span> <span class="hljs-selector-class">.section</span> :<span class="hljs-built_in">deep</span>(.target-element) {
  <span class="hljs-attribute">color</span>: blue;
}

<span class="hljs-comment">/* 方案二：使用!important（谨慎使用） */</span>
<span class="hljs-selector-class">.page-container</span> :<span class="hljs-built_in">deep</span>(.target-element) {
  <span class="hljs-attribute">color</span>: blue <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/* 方案三：调整样式顺序 */</span>
<span class="hljs-comment">/* 后面的样式会覆盖前面的 */</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><strong>问题三：与预处理器冲突</strong></p>
<p>在使用Sass、Less等预处理器时，需要注意语法兼容性。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span>
.parent {
  padding: 20px;

  /* 在Sass中正常使用 */
  :deep(.child) {
    margin: 10px;
    
    .grandchild {
      color: red;
    }
  }
}

/* 或者使用插值语法 */
.parent :deep(#{$child-selector}) {
  background: white;
}
<span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-6">结合Composition API使用</h2>
<p>在Vue 3的Composition API中，我们还可以通过更编程式的方式来处理样式问题。</p>
<p>虽然不能直接通过Composition API修改子组件样式，但我们可以通过动态类名和样式的方式来配合<code>:deep()</code>使用：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"containerClass"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">third-party-component</span> 
      <span class="hljs-attr">:class</span>=<span class="hljs-string">"componentClass"</span>
      <span class="hljs-attr">:style</span>=<span class="hljs-string">"componentStyle"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">variant</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-string">'primary'</span>
  }
})

<span class="hljs-keyword">const</span> containerClass = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-string">'theme-container'</span>: <span class="hljs-literal">true</span>,
  [<span class="hljs-string">`theme-<span class="hljs-subst">${props.variant}</span>`</span>]: <span class="hljs-literal">true</span>
}))

<span class="hljs-keyword">const</span> componentClass = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-string">'custom-component'</span>: <span class="hljs-literal">true</span>,
  [<span class="hljs-string">`variant-<span class="hljs-subst">${props.variant}</span>`</span>]: <span class="hljs-literal">true</span>
}))

<span class="hljs-keyword">const</span> componentStyle = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-string">'--custom-primary'</span>: props.<span class="hljs-property">variant</span> === <span class="hljs-string">'primary'</span> ? <span class="hljs-string">'#3b82f6'</span> : <span class="hljs-string">'#ef4444'</span>
}))
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.theme-container</span> :<span class="hljs-built_in">deep</span>(.custom-component) {
  <span class="hljs-comment">/* 基础样式 */</span>
}

<span class="hljs-selector-class">.theme-container</span><span class="hljs-selector-class">.theme-primary</span> :<span class="hljs-built_in">deep</span>(.custom-component.variant-primary) {
  <span class="hljs-comment">/* 主要变体样式 */</span>
}

<span class="hljs-selector-class">.theme-container</span><span class="hljs-selector-class">.theme-danger</span> :<span class="hljs-built_in">deep</span>(.custom-component.variant-danger) {
  <span class="hljs-comment">/* 危险变体样式 */</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-7">总结</h2>
<p><code>:deep()</code>选择器是Vue 3样式系统中一个非常重要的特性，它为我们提供了一种标准化的方式来处理组件样式穿透的需求。从Vue 2的各种混乱语法到Vue 3的统一<code>:deep()</code>，这反映了Vue团队在改善开发者体验方面的持续努力。</p>
<p>回顾一下我们今天讨论的重点：<code>:deep()</code>解决了组件样式作用域带来的限制，让我们能够在父组件中修改子组件的样式。它的语法简洁明了，与现代CSS标准保持一致，而且与各种预处理器良好兼容。</p>
<p>但是，能力越大责任越大。我们应该谨慎使用<code>:deep()</code>，优先考虑通过组件接口(props、emits)和CSS变量来实现样式定制。只有当这些方法都无法满足需求时，才考虑使用<code>:deep()</code>。</p>
<p>在实际项目中，合理使用<code>:deep()</code>可以让我们的代码更整洁、更易维护。记住我们今天讨论的最佳实践：保持选择器简洁、使用有意义的类名、避免过度使用。</p>
<p>希望这篇文章能够帮助你更好地理解和使用Vue 3的<code>:deep()</code>选择器。现在，当你在项目中遇到需要修改子组件样式的情况时，你应该能够自信地选择最合适的解决方案了。</p>
<p>如果你在使用过程中遇到其他问题，或者有更好的使用技巧，欢迎在评论区分享你的经验。 Happy coding！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从数字到版面：得物数据产品里数字格式化的那些事]]></title>    <link>https://juejin.cn/post/7576245169844764712</link>    <guid>https://juejin.cn/post/7576245169844764712</guid>    <pubDate>2025-11-25T09:16:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576245169844764712" data-draft-id="7576338796846137384" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从数字到版面：得物数据产品里数字格式化的那些事"/> <meta itemprop="keywords" content="前端,数据分析,数据结构"/> <meta itemprop="datePublished" content="2025-11-25T09:16:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从数字到版面：得物数据产品里数字格式化的那些事
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T09:16:15.000Z" title="Tue Nov 25 2025 09:16:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前 言</h2>
<p>做数据前端，你会很快建立一个共识：</p>
<p>怎样把枯燥的数字用合适的方式展示出来，是我们的第一要务，但这只是起点。</p>
<p>如果说<strong>规范的数字排版是中后台系统的“地基”</strong> ，保证了信息的准确传达；那么<strong>可视化图表就是地基之上的“建筑”</strong> 。地基稳固，建筑才能发挥其功能——让用户从微观的读数中解放出来，更快速地识别趋势、定位异常，从而真正从数据中获取规律。</p>
<p><strong>但这篇主要想聊的，不是那座“建筑”，而是这块往往被忽视，却决定了整个系统专业度的“地基”——数字格式化。</strong></p>
<p>请看得物各业务线里的这些日常场景：</p>
<ul>
<li>商品详情页：券后价、折扣、分期单价等；</li>
<li>智珠（得物社区运营平台）、得数（自助取数平台）、智能运营（得物交易运营平台）里的 GMV、转化率、留存率、PVCTR等；</li>
<li>社区里帖子阅读量、点赞数、粉丝数。</li>
</ul>
<p>这些数字表面上只是 number，一旦出现在屏幕上，就自动变成版面的一部分：</p>
<p>对齐方式、位数长短、小数几位、有没有“万 / 亿”、单位怎么放——都会影响到整个页面的节奏和专业感。</p>
<p><strong>排版本质上是在管理信息和秩序：层级、节奏、对齐、留白。而数字不是排版的“附属品”，恰恰是这些原则最密集的载体。</strong></p>
<p>本文不发散去谈数据可视化，只专注于“数字格式化”这一件事：</p>
<ol>
<li>什么是数字格式化？它背后有哪些鲜为人知的文化差异和技术细节？</li>
<li>如果没有统一方案，失控的数字会给产品决策、UI 排版和工程维护带来什么麻烦？</li>
<li>得物数据前端在得数 / 智珠 / 智能运营里，是怎么把这件事从“工具函数”做成“基础设施”的？</li>
<li>我们基于Intl.NumberFormat和@dfx/number-format 的方案，架构是怎样的，带来了哪些实际收益？</li>
</ol>
<h2 data-id="heading-1">二、什么是“数字格式化”？不只是toFixed(2)</h2>
<p>一提到提到数字格式化，第一反应是：toFixed(2)、拼个%、加个¥就完事了或者通过正则来拼接千分符。但在真实世界里，“<strong>同一个数长成什么样</strong>”远比想象复杂。</p>
<h4 data-id="heading-2">2.1 数字写法本身就是“文化差异”</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50ae74d6a809495db83f38d7669db48b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764666974&amp;x-signature=ZG5XEBI4Hs9EfefFPfT9m%2Bz68Ig%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh.wikipedia.org%2Fwiki%2F%25E5%25B0%258F%25E6%2595%25B0%25E7%2582%25B9" target="_blank" title="https://zh.wikipedia.org/wiki/%E5%B0%8F%E6%95%B0%E7%82%B9" ref="nofollow noopener noreferrer">zh.wikipedia.org/wiki/小数点</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/869fea91289547eab5c50a48d72560b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764666974&amp;x-signature=9SyFwJfxRI6SrACQcir%2B3I0pkZg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4872c79288c348a3906ceb38efff3d79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764666974&amp;x-signature=2gzyGZfycuft2%2Bavseg4mxm7yyA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>小数分隔符的符号演变史</strong></p>
<p>据Florian Cajori 1928年的著作《数学符号史》记载，小数分隔符（旧称 separatrix）的演变经历了一个漫长的标准化过程。</p>
<p>在早期数学文献中，不同地区对小数的处理方式各异。以数值 34.65 为例，中世纪文献常采用在整数与小数间加横线或在个位数字上方加注标记的方式。英国早期曾采用竖线“|”作为分隔，后在印刷中逐渐简化为逗号或点，这与当时阿拉伯数学家主要使用逗号的习惯相呼应。</p>
<p><strong>“点”与“逗号”分流的历史成因</strong></p>
<p>17 世纪末至 18 世纪初是符号标准化的关键时期，也是英美体系与欧洲大陆体系产生分歧的起点。这一差异在很大程度上受到了微积分发明者及其符号体系的影响：</p>
<ol>
<li><strong>欧洲大陆（莱布尼茨的影响）</strong> ：德国数学家莱布尼茨提议使用“点”作为乘法符号。这一提议经由克里斯蒂安·沃尔夫等学者的推广，在欧洲大陆教科书中广泛普及。为了避免符号含义的冲突，欧洲大陆数学家普遍采用了“逗号”作为小数分隔符。</li>
<li><strong>英国（牛顿体系的延续）</strong> ：英国数学界未采纳莱布尼茨的乘法符号，而是沿用“X”表示乘法。因此，“点”在英国并未被乘法占用，得以继续作为小数分隔符使用。据统计，18 世纪初的英国教科书中，约 60% 使用点，40% 使用逗号；而到了 18 世纪末，点已成为英国的绝对主流。</li>
</ol>
<p><strong>标准的确立</strong></p>
<p>尽管比利时和意大利等国曾长期坚持使用点作为小数分隔符，但最终均向欧洲大陆的主流标准靠拢，改用了逗号。至此，英美使用“小数点”、欧洲大陆使用“小数逗号”的格局基本定型。</p>
<p>值得注意的是，直至20世纪初，符号的统一仍未完全完成，各类文献中仍可见等非标准写法。</p>
<ul>
<li>英语系 / 中国常见写法：1,234,567.89</li>
<li>很多欧洲国家：1.234.567,89（点是千分位，逗号是小数）</li>
<li>瑞士习惯：1'234.56或1'234,56，用撇号 ' 做分组。</li>
</ul>
<p>这些规则都已经被整理进Unicode CLDR和ICU数据库，现代浏览器的Intl.NumberFormat就是建立在这套数据之上，能根据 locale 自适应这些写法。</p>
<p>所以，一个简单的1,000：</p>
<ul>
<li>在美国人或中国人眼里是“ one thousand / 一千”；</li>
<li>在某些欧洲语境下可能被读成“保留三位小数的一点零”。</li>
</ul>
<p>一旦你做电商、跨境、数据产品，这种“写法”的差异，就不再是小问题，而是直接影响决策和合规的东西。</p>
<h4 data-id="heading-3">2.2 数字不只是“大小”还有语义和语气</h4>
<p>在 UI 里，我们其实经常在表达“数字的语气”：</p>
<ul>
<li>+12.3%：不是纯数学“加号”，而是一种“上涨”的信号，排版上常常配合红/绿颜色；</li>
<li>1.2M / 120 万：为了节省空间和降低认知负担，用缩写表示量级；</li>
<li>&lt; 0.01：极小数值，让用户知道“接近 0”，而不是盯着一串 0.000032 的数字尾巴发呆；</li>
<li>— /N/A：告诉用户“这里是没数据 / 异常”，而不是“就是 0”。</li>
</ul>
<p>这些都属于“<strong>数字的表达</strong>”而非“<strong>运算结果</strong>”。</p>
<p>如果我们只用toFixed和拼字符串，很难让这些语气在整个系统内保持一致。</p>
<h4 data-id="heading-4">2.3浏览器和 Node 已经给了我们一个“引擎”</h4>
<p>ECMAScript 402标准中提供的 Intl.NumberFormat，是一个专门做本地化数字格式化的构造器。</p>
<p>它支持：</p>
<ul>
<li>根据 locale 切换小数点、分组规则、数字符号；</li>
<li>货币格式：style: "currency" + currency: "CNY" | "JPY" | ...；</li>
<li>百分比：style: "percent"，自动乘 100 并加 %；</li>
<li>紧凑表示：notation: "compact"，输出 9.9M、9.9亿等缩写；</li>
<li>formatToParts()：把数字拆成整数、小数点、小数、货币符号等片段，方便做更精细的排版。</li>
</ul>
<p>所以，数字格式化的“引擎问题”其实已经有人帮我们解决了——真正难的是：</p>
<ul>
<li>怎么结合业务语义；</li>
<li>怎么结合排版规范；</li>
<li>怎么在多个系统之间做到一致；</li>
<li>怎么治理“不乱写”的工程实践。</li>
</ul>
<p>这就回到我们自己的故事。</p>
<h2 data-id="heading-5">三、如果没有统一方案：三个数据产品的日常</h2>
<p>下面这几个场景，相信你在得物或类似电商/数据平台里一定见过。</p>
<p>想象一张典型后台页面：</p>
<ul>
<li>顶部是活动看板 KPI 卡片；</li>
<li>中间是按品类/渠道拆开的表格；</li>
<li>下方是创作者表现列表。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb6e4bcd844a49108c0f3f8e646b6062~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764666974&amp;x-signature=4Q5vJZa8O5q0rhIvH9xNUWxMqdE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/373cea9240df4ca7b85787500142ff2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764666974&amp;x-signature=rjADyhgP9W35CoMS2xJtghk2TZc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8335ff638ef948d7924e43d81cb3e1bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764666974&amp;x-signature=JeJSox8PW2H5BzBU88aAgCwhOto%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h4 data-id="heading-6">3.1 价格：同一张订单，不同系统“长得不同”</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15a4b4e842a84935877591a196779c14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764666974&amp;x-signature=FoT7%2Bf%2Fr%2Fcllem9%2FyohBf6N7wVs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>那么，以前我们是怎么做的？</p>
<p>在没有统一规范的“蛮荒时代”，面对一个数字，我们的第一反应往往是：“这还不简单？拼个字符串不就完事了？”</p>
<p>这种代码，你一定写过，或者在项目的某个角落实实在在地见过：</p>
<p><strong>场景一：简单粗暴的拼接一把梭</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// "我管你什么场景，先拼上去再说"</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">formatPrice</span>(<span class="hljs-params">value: number</span>) {
  <span class="hljs-comment">// 隐患埋雷：这里是全角￥还是半角¥？null 会变成 "¥null" 吗？</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">'¥'</span> + value.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
}
</code></pre>
<p><strong>场景二：为了千分位，手写正则“炫技”</strong></p>
<pre><code class="hljs language-ini" lang="ini">// "网上一搜一大把的正则，看着能跑就行"
export const <span class="hljs-attr">formatNumberWithCommas</span> = (number: number | string) =&gt; {
  const <span class="hljs-attr">parts</span> = number.toString().split(<span class="hljs-string">'.'</span>)<span class="hljs-comment">;</span>
  
  // 经典的正则替换，但这真的覆盖了所有负数、极大值场景吗？
  parts<span class="hljs-section">[0]</span> = parts<span class="hljs-section">[0]</span>.replace(/\B(?=(\d{3})+(?!\d))/g, ',')<span class="hljs-comment">;</span>
  
  // 手动补零逻辑，不仅难维护，还容易在边界情况（如 undefined）下报错
  if (parts.length &gt; 1 &amp;&amp; parts<span class="hljs-section">[1]</span>?.<span class="hljs-attr">length</span> === <span class="hljs-number">1</span>) {
    parts<span class="hljs-section">[1]</span> = ${parts<span class="hljs-section">[1]</span>}0<span class="hljs-comment">;</span>
  }
  return parts.join('.')<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p>这看起来似乎“能用”，并且用起来貌似也没啥问题。但当业务复杂度稍微上来一点或者需要做国际化的时候，那接手这个需求的同学只能发出一句『哦吼』。</p>
<ol>
<li><strong>视觉上的“各自为政”</strong></li>
<li>
<ol>
<li><strong>符号打架</strong>： 商品卡片用半角 ⁠¥，详情页用全角 ⁠￥，甚至有的地方混用了 ⁠CNY。</li>
<li><strong>精度随心</strong>： 有的开发觉得 ⁠toFixed（2） 严谨，有的觉得 ⁠。00 太多余直接砍掉，导致同一个页面里，导致同一个页面里，数字像锯齿一样参差不齐。</li>
</ol>
</li>
<li><strong>排版上的“秩序崩塌”</strong></li>
<li>
<ol>
<li>试想一个表格列：⁠1299、⁠1，299.00、⁠1299.0 混在一起。</li>
<li>对齐基准线完全错乱，尤其在表格里，就和『狗啃过一样』，犬牙交错，参差不齐，用户的眼睛需要在不同的小数位之间来回跳跃，阅读体验极差。</li>
</ol>
</li>
<li><strong>国际化上的“死胡同”</strong></li>
<li>
<ol>
<li>这种硬编码逻辑（Hardcode），完全堵死了国际化的路。</li>
<li>一旦业务要支持 USD（美元）、JPY（日元，默认无小数）、EUR（欧元，部分国家用逗号做小数点）。</li>
<li>比如 ⁠1,234，567.89（英美）和 ⁠1.234.567，89（德意），这完全不是改个符号就能解决的，而是整个<strong>数字书写逻辑</strong>的根本差异。</li>
</ol>
</li>
</ol>
<p><strong>我们原本想省事写的小函数，最终变成了阻碍系统演进的技术债务。</strong></p>
<h4 data-id="heading-7">3.2看似智能的“万/亿”缩写，其实是硬编码的陷阱</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70447d69189446d4a63a6de64ae4c95d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764666974&amp;x-signature=P4GD2l1gaVXlZc7N5qTA8yW3PjY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>在创作者中心或内容社区，我们希望阅读量（PV）能符合用户的直觉认知：</p>
<ul>
<li><strong>小数值</strong>：⁠&lt; 10,000 时，显示完整数字，精确到个位；</li>
<li><strong>中量级</strong>：⁠≥ 10,000 时，缩写为 ⁠X.X 万；</li>
<li><strong>海量级</strong>：≥ 100,000,000 时，缩写为 ⁠X.X 亿。</li>
</ul>
<p>如果是海外版，需求又变成了：⁠1.2k/⁠3.4M/5.6B。</p>
<p>于是，我们写出了那段经典的⁠formatPv</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">formatPv</span>(count: number) {
  if (count &lt; <span class="hljs-number">10000</span>) return <span class="hljs-built_in">String</span>(count);
  if (count &lt; <span class="hljs-number">100000000</span>) return (count / <span class="hljs-number">10000</span>)<span class="hljs-selector-class">.toFixed</span>(<span class="hljs-number">1</span>) + '万';
  return (count / <span class="hljs-number">100000000</span>)<span class="hljs-selector-class">.toFixed</span>(<span class="hljs-number">1</span>) + '亿';
}
</code></pre>
<p>这段代码逻辑清晰，看似解决了问题。但在真实场景中，它却是一个“<strong>Bug 制造机</strong>”：</p>
<p><strong>1.临界点的“视觉突变”</strong></p>
<ul>
<li>9999 下一秒变成 ⁠1.0 万？产品会立刻找你：“这个数展示是不是不大对，能不能9999之后显示 1.0w 而不是 1.0 万？”</li>
<li>99950 四舍五入变成 ⁠10.0 万，要不要显示成更直观的 ⁠10 万？这些微小的细节，需要堆砌大量的 ⁠if-else 来修补。</li>
</ul>
<p><strong>2.维护上的“复制粘贴地狱”</strong></p>
<ul>
<li>中文版写一套，英文版 ⁠formatPvEn 再写一套，等咱们的业务做往世界各地的时候，那得要多少 formatPv（xx）呢？</li>
<li>A 项目拷一份，B 项目拷一份。等哪天产品说“万”后面不留小数了，你得去 N 个仓库里把这行代码找出来改一遍。最终结果就是：<strong>全站的缩写策略处于一种“相似但不一致”的薛定谔状态。</strong></li>
</ul>
<p><strong>3.文化适配上的“盲区”</strong></p>
<ul>
<li>这套逻辑是典型的“简体中文中心主义”。</li>
<li><strong>印度用户</strong>看到⁠100k 是没感觉的，他们习惯用 ⁠Lakh （10 万） 和 ⁠Crore （1000 万）；</li>
<li><strong>阿拉伯语区</strong>可能需要用东阿拉伯数字。</li>
</ul>
<p>这不仅仅是把“万”翻译成“Wan”的问题，而是<strong>数字分级逻辑</strong>在不同文化中完全不同，在前面针对符号系统我们也提到过。</p>
<p>我们在 UI 上硬塞了一套“只能在简体中文里自洽”的规则，这在国际化产品中是行不通的。</p>
<h4 data-id="heading-8">3.3 被“抹平”的语义—0、空值与极小值</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9829b94976884ec5b64815a5a79b7fb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764666974&amp;x-signature=Wr55kBhFt%2BGf4GClUCPWCqjOgRE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>在得数（自助取数平台）、智珠（得物社区运营平台）、智能运营（得物交易运营平台）这类重度数据看板中，我们充斥着各种<strong>比率型指标</strong>：</p>
<ul>
<li><strong>风控类</strong>：鉴别通过率、拦截率；</li>
<li><strong>履约类</strong>：超时率、投诉成功率；</li>
<li><strong>增长类</strong>：活动转化率、复购率。</li>
</ul>
<p>面对这些指标，以前最常见的处理方式是写一个通用的 formatPercent：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formatPercent</span>(<span class="hljs-params">value: number | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span></span>) {
  <span class="hljs-comment">// "没数据就当 0 算呗，省得报错"</span>
  <span class="hljs-keyword">return</span> ((value || <span class="hljs-number">0</span>) * <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>) + <span class="hljs-string">'%'</span>;
}
</code></pre>
<p>这行代码虽然只有一句话，却在业务层面犯了<strong>三个严重的错误：</strong></p>
<p><strong>1. 混淆了“事实”与“缺失”</strong></p>
<ul>
<li>⁠null 代表数据未产出或链路异常（就是没数），而 ⁠0 代表业务结果确实为零。</li>
<li>代码粗暴地将 ⁠null 转为 ⁠0.00%，会让用户误以为“今天没人投诉”或“转化率为 0”，从而掩盖了背后的系统故障或数据延迟。</li>
</ul>
<p><strong>2. “抹杀”了长尾数据的价值</strong></p>
<ul>
<li>对于 AB 或算法模型来说，⁠0.000032 是一个具备统计意义的概率值。</li>
<li>被这行代码强行截断为 ⁠0.00% 后，业务同学会困惑：“为什么 P 值还能是 0 的嘛？”这直接损害了数据的公信力，严重点来说，都会影响业务决策。</li>
</ul>
<p><strong>3. 阻断了精细化表达的可能</strong></p>
<p>当你想把极小值优化为 ⁠&lt; 0.01% 这种更科学的表达时，你通过 vscode 一搜代码，500+ 文件，直接就两眼一黑。</p>
<p>从排版设计的角度看，这三者本应拥有完全不同的视觉层级：</p>
<ul>
<li><strong>空值（No Data）</strong> ：使用 ⁠— 或灰色占位符，表示“此处无信息”，降低视觉干扰；</li>
<li><strong>异常值（Error）</strong> ：使用 ⁠N/A 或警示色，提示用户“数据有问题”；</li>
<li><strong>极小值（Tiny Value）</strong> ：使用 ⁠&lt; 0.01% 或者≈ 0，保留数据的存在感，同时传达“接近于零”的准确语义。</li>
</ul>
<p>得数DataHub在治理展示层时发现，大量“同一个指标在不同页面长得不一样”，根源就在于这些各自为政、缺乏语义区分的格式化规则。</p>
<h2 data-id="heading-9">四、从“写工具函数”到“定义展示语义”</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a75a01a0ad6c4a9092e43f0b2141d167~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764666974&amp;x-signature=OQX7zmusHsyF9zdVRPa9pp9ct3M%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>回顾上述场景，透过那些混乱的代码片段，可以发现三个共性的系统性难题：</p>
<ol>
<li><strong>逻辑熵增</strong>：每个业务线、甚至每个页面都在重复造轮子。⁠formatPrice、⁠formatPercent 遍地开花，前后端逻辑割裂，维护成本随着业务扩张呈指数级上升。</li>
<li><strong>无法治理</strong>：想把全站的“万 / 亿”阈值统一？或者把某种费率的精度从两位改成四位？这几乎是不可能的任务。</li>
<li><strong>体验失控</strong>：设计规范虽然写着“空值用 —”，但落实到代码里全看开发心情。结果就是用户在不同系统间切换时，看到的是一种“似是而非”的统一，严重影响了产品的专业感。</li>
</ol>
<p><strong>为了解决这些问题，在数据域产品中，我们对“格式化”这件事进行了重新定义：</strong></p>
<p>它不只是前端的 UI 渲染逻辑，而是指标定义的一部分。</p>
<p>我们不仅要定义“指标的计算口径”，更要定义“指标的展示语义”。</p>
<p>在 Galaxy（指标管理平台）定义好“数是怎么算出来的”之后，得数 DataHub 承担起了定义“数该怎么被看见”的职责。我们将这层逻辑抽象为 <strong>“展示语义”（Visualization Semantics）</strong> ：</p>
<ul>
<li><strong>定类型（Type）</strong> ：它是金额（Currency）、比率（Ratio），还是计数（Integer）？</li>
<li><strong>定单位（Unit）</strong> ：默认是元 / 万元，还是 %、‰ （千分比） 或 bp （基点）？</li>
<li><strong>定精度（Precision）</strong> ：小数位是固定保留两位，还是根据数值大小动态截断？</li>
<li><strong>定状态（State）</strong> ：遇到 Null（空值）、Error（异常）或 Epsilon（极小值），展示层该如何兜底？</li>
<li><strong>定场景（Context）</strong> ： 在空间局促的 KPI 卡片里（追求简洁），和需要财务核对的 明细表格里（追求精确），是否应用不同的渲染策略？</li>
</ul>
<p><strong>这是一种架构上的升维：</strong></p>
<p>这些关于“长什么样”的逻辑，从此不再散落在业务代码的 ⁠if-else 里，而是被统一收拢到元数据系统中进行管理。</p>
<p>从这一刻起，数字格式化不再是前端模板里的一个小工具，而是成为了得数体系的一项<strong>基础设施</strong>——一层独立、可配置、可治理的<strong>数据领域服务</strong>。</p>
<h2 data-id="heading-10">五、开始造轮子：站在Intl.NumberFormat 肩膀上</h2>
<p>在着手开发之前，首先确立了一个原则：<strong>底层能力不造轮子，拥抱 Web 标准。</strong></p>
<p>ECMAScript 402 标准中的 ⁠Intl.NumberFormat 已经为我们提供了一个极其强大的本地化格式化引擎。它的能力远超大多数手写的正则替换：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> n = <span class="hljs-number">123456.789</span>;


<span class="hljs-comment">// 德国：点号分组、逗号小数</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">'de-DE'</span>).<span class="hljs-title function_">format</span>(n);
<span class="hljs-comment">// "123.456,789"</span>


<span class="hljs-comment">// 印度：lakh/crore 分组</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">'en-IN'</span>).<span class="hljs-title function_">format</span>(n);
<span class="hljs-comment">// "1,23,456.789"</span>


<span class="hljs-comment">// 日元货币：默认 0 位小数</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">'ja-JP'</span>, {
  <span class="hljs-attr">style</span>: <span class="hljs-string">'currency'</span>,
  <span class="hljs-attr">currency</span>: <span class="hljs-string">'JPY'</span>,
}).<span class="hljs-title function_">format</span>(n);
<span class="hljs-comment">// "￥123,457"</span>
</code></pre>
<p>它完美解决了那些最让前端头疼的<strong>国际化底层问题</strong>：</p>
<ul>
<li><strong>文化差异</strong>：全球各地的千分位、小数点、数字符号习惯；</li>
<li><strong>货币规则</strong>：不同币种的标准小数位（如日元 0 位，美元 2 位）和符号位置；</li>
<li><strong>多态支持</strong>：内置了百分比、紧凑缩写（Compact Notation）、科学计数法等模式；</li>
<li><strong>排版能力</strong>：通过 <strong>⁠formatToParts（）</strong> 将数字拆解为数组（整数部分、小数部分、符号等），为精细化排版提供了可能，比如在小数或百分比符号比整数小 2 个字号。</li>
</ul>
<p><strong>但是，它天然“不懂”业务：</strong></p>
<ul>
<li>它不懂<strong>中文的习惯</strong>：无法直接实现“<strong>兆/京/垓</strong>”这种中文超大数缩写逻辑（标准最多支持到亿）；</li>
<li>它不懂<strong>得数的规范</strong>：不知道 ⁠*_rate 类型的指标在空值时要显示 ⁠"-"，在极小值时要显示 ⁠&lt; 0.01%；</li>
<li>它不懂<strong>业务的上下文</strong>：不知道 GMV 在 KPI 卡片里要按“万元”展示，而在财务报表里必须精确到“厘”。</li>
</ul>
<p><strong>因此，我们的最终的架构策略是：</strong></p>
<p>以 ⁠Intl.NumberFormat 为底层的“渲染引擎”；</p>
<p>在其之上搭建一层“数字领域层”（Domain Layer）；</p>
<p>专门用于转译得物的业务规则和排版语义。</p>
<h2 data-id="heading-11">六、@dfx/number-format：构建数字的“领域层”</h2>
<p>在得物数据前端的大仓里，我们把这层能力实现为一个独立包：@dfx/number-format。专门服务得数、智珠、智能运营等内部系统。</p>
<p>可以把它理解为三件事的组合：</p>
<ul>
<li>一个统一封装了Intl.NumberFormat的<strong>核心引擎</strong>（含缓存、解析）；</li>
<li>一套可以被配置的<strong>业务规则 / 预设 （preset）和插件系统</strong>；</li>
<li>一组面向 React 和 Node 环境的<strong>接口</strong>（组件 + Hook + FP 函数）。</li>
</ul>
<h4 data-id="heading-12">6.1 声明式开发：把“数字长什么样”抽象成规则</h4>
<p>在业务开发侧，最终期望的目标是：<strong>让开发者只关心“这是什么指标”，而不关心“它该怎么展示”。</strong></p>
<p><strong>场景一：基础格式化</strong></p>
<p>我们可以直接使用组件，以声明式的方式调用：</p>
<pre><code class="hljs language-ini" lang="ini">import { NumberFormat } from '@dfx/number-format'<span class="hljs-comment">;</span>
// 无论在哪个页面，价格都只需这样写
&lt;NumberFormat
  <span class="hljs-attr">value</span>={price}
  <span class="hljs-attr">options</span>={{ style: <span class="hljs-string">'currency'</span>, currency: <span class="hljs-string">'CNY'</span> }}
/&gt;
</code></pre>
<p><strong>场景二：基于语义的自动格式化</strong></p>
<p>更进阶的用法是，在系统层面定义好“规则集”，业务组件只需传入指标名称：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NumberFormatProvider</span>, <span class="hljs-title class_">AutoMetricNumber</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@dfx/number-format'</span>;
<span class="hljs-comment">// 1. 定义规则：所有 "price.cny" 类型的指标，都遵循人民币格式</span>
<span class="hljs-keyword">const</span> rules = [
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'price.cny'</span>, <span class="hljs-attr">options</span>: { <span class="hljs-attr">style</span>: <span class="hljs-string">'currency'</span>, <span class="hljs-attr">currency</span>: <span class="hljs-string">'CNY'</span> } },
];
<span class="hljs-comment">// 2. 注入上下文</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">NumberFormatProvider</span> <span class="hljs-attr">options</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">rules</span> }}&gt;</span>
  {/* 3. 业务使用：完全解耦，只传语义 */}
  <span class="hljs-tag">&lt;<span class="hljs-name">AutoMetricNumber</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"price.cny"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{price}</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">NumberFormatProvider</span>&gt;</span></span>
</code></pre>
<p><strong>收益显而易见：</strong></p>
<ul>
<li><strong>自动化</strong>：CNY 自动带两位小数，切到 JPY 自动变 0 位小数，逻辑完全由底层接管。</li>
<li><strong>一致性</strong>：全站所有 ⁠price.cny 的地方，千分位、符号位置严格统一，版面节奏自然对齐。</li>
</ul>
<p><strong>场景三：批量匹配比率指标</strong></p>
<p>对于成百上千个转化率指标，我们不需要逐一定义，只需一条正则规则：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> rules = [
  <span class="hljs-comment">// 匹配所有以 _rate 结尾的指标，自动转为百分比，保留2位小数</span>
  { <span class="hljs-attr">pattern</span>: <span class="hljs-regexp">/_rate$/i</span>, <span class="hljs-attr">options</span>: { <span class="hljs-attr">style</span>: <span class="hljs-string">'percent'</span>, <span class="hljs-attr">maximumFractionDigits</span>: <span class="hljs-number">2</span> } },
];


<span class="hljs-comment">// 页面代码极其干净</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AutoMetricNumber</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"conversion_rate"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{conversionRate}</span> /&gt;</span></span>
</code></pre>
<p>空值与异常值如何展示、极小值是否显示 &lt; 0.01%、两位小数从哪里来，全部在规则 + 插件里处理。</p>
<h4 data-id="heading-13">6.2插件系统：收口那些“奇怪但常见”的需求</h4>
<p>得物的业务场景中，存在大量 ⁠Intl 标准无法直接覆盖的边缘需求。我们将这些需求统一建模为<strong>插件（Format Plugin）</strong> ，介入格式化的生命周期：</p>
<ul>
<li><strong>千分比 / 基点 （bps）</strong> ：需在 ⁠pre-process 阶段将数值乘 1000 或 10000；</li>
<li><strong>中文大写金额</strong>：会计与合同场景的特殊转换；</li>
<li><strong>极小值兜底</strong>：设定阈值，当数值小于 ⁠0.0001 时，⁠post-process 阶段输出 ⁠&lt; 0.01%；</li>
<li><strong>会计格式</strong>：负数使用括号 ⁠（1，234.56） 而非负号；</li>
<li><strong>动态精度策略</strong>：根据数值大小动态决定保留几位小数。</li>
</ul>
<p><strong>这套插件机制的意义在于“治理”：</strong></p>
<p>它让“在某个业务仓库里偷偷写一个特殊正则”成为过去式。任何新的格式化需求，都必须以插件形式接入，由数据前端统一评审、沉淀，最终复用到全站。</p>
<h4 data-id="heading-14">6.3 全链路打通：从Galaxy元数据到UI渲染</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60ccb2a6339c4eb68d7f2915714592e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764666974&amp;x-signature=9QYAo6JXNJmsp5kb%2BiheKIS%2BgUc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>最后，将这套系统与得数的中台能力打通（也是目前我们正在做的），形成了一条完整的渲染链路。</p>
<p>在Galaxy和得数的元数据里，指标本身已经有code、label、type 等字段。我们只需要再加一点约定：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"metricCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gmv"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"label"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"GMV"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"currency"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 基础类型</span>
  <span class="hljs-attr">"meta"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"formatConfig"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"currency"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"maximumFractionDigits"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"交易指标"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"displayConfig"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"table"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"precise"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"card"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"compact"</span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>前端渲染时</strong>：</p>
<ul>
<li>配置下发：页面加载时，获取指标的 ⁠Code 及元信息，转换为前端的 ⁠MetricFormatRule[]。</li>
<li>上下文注入：在应用根节点通过 ⁠NumberFormatProvider 注入规则集。</li>
<li>傻瓜式使用：表格、卡片、图表组件只需消费指标 ID：</li>
</ul>
<p>这样一来就实现了真正的『数据驱动 UI』：</p>
<ul>
<li>“指标长什么样”只在得数元数据管理中定义一次。</li>
<li>修改展示规则（如调整精度），只需改配置，<strong>无需批量修改前端代码，更无需重新发版；</strong></li>
<li>前台业务与中台报表看到的同一个指标，格式永远是物理上的一致。</li>
</ul>
<h2 data-id="heading-15">七、统一之后：重塑设计、工程与业务的价值</h2>
<p>从我们的视角出发，这套统一数字格式方案的落地，带来的收益远不止“代码整洁”那么简单，它在三个层面产生了深远的影响。</p>
<h4 data-id="heading-16">7.1 对设计与排版：版面终于可控了</h4>
<p>曾经，产品需要在每个页面的验收中反复纠结数字的对齐和精度。现在，设计规范只需在文档中定义一次：</p>
<ul>
<li><strong>金额类</strong>：统一保留两位小数，强制右对齐，货币符号半角化；</li>
<li><strong>比率类</strong>：空值兜底为 ⁠—，异常值显示 ⁠N/A，极小值转译为 ⁠&lt; 0.01%；</li>
<li><strong>缩写策略</strong>：全站统一遵循“中文万/亿、英文 k/M/B”的梯度逻辑。</li>
</ul>
<p>开发同学不再是『古法手搓』，而是直接接入统一的 Preset 和插件。</p>
<p>无论是看板、详情页，还是导出的 Excel 报表，数字风格保持了像素级的一致。从视觉角度看，我们相当于<strong>给数字建立了一套Design Token</strong>：精度、单位、占位符都有了标准索引，让整个平台呈现出高度统一的<strong>专业感和节奏感</strong>。</p>
<h4 data-id="heading-17">7.2 对工程质量与效率：从“搜索toFixed”到“改一处生效全站”</h4>
<p>所有数字格式逻辑集中在一个领域层和配置中心。</p>
<p>一类指标的规则变更（精度、单位、空值策略）可以配置化调整。</p>
<p>规约可以进入 Lint（数字格式化限制） / Code Review：</p>
<ul>
<li>禁止直接在业务代码中new Intl.NumberFormat、toFixed拼字符串；</li>
<li>鼓励所有数字展示全部走@dfx/number-format与 DataHub 规则。</li>
</ul>
<p>这就是工程治理层面的价值：它将“依赖开发者自觉”的软约束，变成了 <strong>“可配置、可维护、可迭代”的系统能力</strong>。</p>
<h4 data-id="heading-18">7.3 对业务和数据信任：从“怀疑这数有问题”到“愿意用来决策”</h4>
<p>统一数字格式还有一个最隐性、却最核心的价值：<strong>重构数据信任。</strong></p>
<ul>
<li><strong>消除歧义</strong>：前台商品价格与中台报表金额完全一致，运营不再因为“显示精度不同”而去质疑数据准确性；</li>
<li><strong>精准语义</strong>：空值（Null）和零（Zero）被清晰区分，避免了因格式问题导致的错误决策。</li>
</ul>
<p>在得物，<strong>严谨是需要刻在基因里的关键词</strong>。</p>
<p>作为数据前端，我们深知：<strong>懂数据，并能用最专业的方式呈现数据，是这一岗位的核心素养</strong>。 当我们不仅能交付代码，还能通过精准的数字展示消除歧义、传递信任时，技术与业务之间就建立起了一种深层的默契。</p>
<p>这种对数字细节的极致追求，不仅是对用户体验的尊重，更是对得物“正品感”品牌心智在数字世界的延伸。</p>
<h2 data-id="heading-19">八、数字，是版面的『最后一公里』</h2>
<p>回头看，得物数据前端在得数、智珠智能运营这条线做的，其实有两件事：</p>
<ul>
<li><strong>给予数字应有的“设计尊严”</strong></li>
</ul>
<p>我们不再将数字视为模板字符串里一个随时可替换的“黑洞”，而是将其视作与字体、色彩、间距同等重要的排版元素，纳入统一的设计语言系统。</p>
<ul>
<li><strong>为数字构建专属的“基础设施”</strong></li>
</ul>
<p>我们以 Web 标准⁠Intl.NumberFormat为引擎，以 ⁠@dfx/number-format为领域层，以得数 Schema 为配置中枢，将“数字如何展示”这一命题，从硬编码的泥潭中解放出来，转变为一种<strong>可配置、可治理、可演进的系统能力。</strong></p>
<p>当你再回头看公司产品的各个页面——</p>
<ul>
<li>前台商品详情页的价格和券后价；</li>
<li>社区里的阅读和点赞数字；</li>
<li>智珠的策略看板；</li>
<li>得数的自助分析报表。</li>
</ul>
<p>你会发现它们拥有了一个共同的特征：</p>
<p><strong>这些数字不再是各说各话的噪点，而是共同操着同一种精准、优雅的“排版语言”。</strong></p>
<p><strong>这就是我们做“数字格式化”的初衷：用技术的确定性，换取业务的专注力。</strong></p>
<p>此时此刻，彼时彼刻，作为前端开发，你可以坚定地说出：我这展示的没问题，是数出问题了～</p>
<h2 data-id="heading-20">九、走出数据域：从内部门户到全业务</h2>
<p>前面的篇幅，更多围绕着得数、智珠、智能运营等中后台系统展开。在这些场景下，数字格式化的核心用户是运营、分析师和算法同学——帮助他们透过数据看清业务走势。</p>
<p>但这套能力并不应局限于“后台”。它完全具备走出数据域的潜力，成为得物全业务线共享的一层<strong>关键基础设施</strong>。</p>
<h4 data-id="heading-21">9.1 跨业务线：从“运营看板”走向“交易链路”</h4>
<p>目前@dfx/number-format 虽然生长于数据土壤，但其解决的问题是通用的。未来，它可以自然地渗透到更广阔的业务场景：</p>
<ul>
<li><strong>交易域</strong>： 统一商品详情页、结算页的价格、分期费率、税费展示逻辑；</li>
<li><strong>社区域</strong>： 标准化社区详情页中的风险分、阈值、命中率精度；</li>
<li><strong>客服域</strong>： 规范赔付金额、工单时长的展示口径。</li>
</ul>
<p><strong>这在工程上意味着一次“升维”：</strong></p>
<ul>
<li><strong>依赖升级</strong>：将 ⁠@dfx/number-format 从数据域私有包提升为公司级的基础依赖；</li>
<li><strong>开发范式</strong>：新业务在处理数字展示时，默认动作不再是“手写一个 format 函数”，而是查阅现有的 Preset 和插件；</li>
</ul>
<p><strong>最终带来的体验质变是：</strong></p>
<p>用户无论是在得物 App的前台页面，还是在内部的各类管理系统中，看到的数字都拥有<strong>同一套呼吸感和视觉习惯</strong>。这种跨端的一致性，是品牌专业感最直接的体现。</p>
<h4 data-id="heading-22">9.2 跨地区与汇率：构建独立的“全球化价格能力”</h4>
<p>随着得物业务的出海，多地区、多币种是绕不开的挑战。此时，数字领域层不仅要负责“长什么样”，更要承担起“展示策略”的职责。</p>
<p>我们可以设想一个**「全球化价格组件」**：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;MultiRegionPrice
  <span class="hljs-attr">skuId</span>=<span class="hljs-string">"123456"</span>
  <span class="hljs-attr">basePriceCny</span>={price}
  <span class="hljs-attr">regions</span>={[
    { locale: <span class="hljs-string">'zh-CN'</span>, currency: <span class="hljs-string">'CNY'</span> },
    { locale: <span class="hljs-string">'en-US'</span>, currency: <span class="hljs-string">'USD'</span> },
    { locale: <span class="hljs-string">'ja-JP'</span>, currency: <span class="hljs-string">'JPY'</span> },
  ]}
/&gt;
</code></pre>
<p>这个组件将负责两层逻辑的解耦：</p>
<ul>
<li><strong>计算层</strong>： 负责实时汇率换算、多币种价格计算。</li>
<li><strong>展示策略层</strong>：</li>
<li>
<ul>
<li><strong>对照展示</strong>： 是否显示“原币种 + 本地参考价”（如 ⁠JP¥ 20,000 （≈ $135.00））；</li>
<li><strong>文化适配</strong>： 是否遵循当地的“心理价位”策略（如 ⁠<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>199.99</mn><mi>v</mi><mi>s</mi><mtext>⁠</mtext></mrow><annotation encoding="application/x-tex">199.99 vs ⁠</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">199.99</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">s</span><span class="mord">⁠</span></span></span></span></span>200）；</li>
<li><strong>格式渲染</strong>： 最终调用 ⁠@dfx/number-format，确保日元无小数、美元有小数、分节号正确。</li>
</ul>
</li>
</ul>
<p>从工程视角看，这避免了“汇率算对了、数字排版全乱了”的尴尬；从产品视角看，这正是得物沉淀“<strong>出海技术套件</strong>”的重要一步（比如国际智能运营）。</p>
<h4 data-id="heading-23">9.3 时间与日期：用同样的思路，去做第二条“格式化主线”</h4>
<p>数字是一类挑战，“时间”则是另一类。跨时区转换、相对时间（此刻）、不同地区的日期写法（⁠DD/MM vs ⁠MM/DD），其复杂度丝毫不亚于数字。</p>
<p>既然浏览器提供了<strong>Intl.DateTimeFormat</strong>，我们完全可以复刻数字领域层的成功路径，再赢一次：</p>
<ul>
<li><strong>基础设施</strong>：构建 ⁠@dfx/date-format，统一封装时间格式化与相对时间逻辑；</li>
<li><strong>预设管理</strong>：定义标准 Preset（如“运营报表用 ⁠YYYY-MM-DD”、“C 端动态用 ⁠今天 12:30”）；</li>
<li><strong>组件化</strong>：提供 ⁠ 和 ⁠ 组件；</li>
<li><strong>元数据打通</strong>：在得数的元数据中，针对时间型的维度也同样进行配置。</li>
</ul>
<p>这样，数据前端的展示层就拥有了两条清晰的主线：</p>
<ul>
<li><strong>数值主线</strong>：⁠Intl.NumberFormat → ⁠@dfx/number-format → <strong>数字展示规范</strong></li>
<li><strong>时间主线</strong>：⁠Intl.DateTimeFormat → ⁠@dfx/date-format → <strong>时间展示规范</strong></li>
</ul>
<p>未来，我们甚至可以抽象出更上层的 ⁠@dfx/data-format，让“任何字段该怎么展示”，完全由 Schema 配置 + 领域层规则共同决定。</p>
<h2 data-id="heading-24">十、最后：把“展示”这件事做到极致</h2>
<p>如果只看代码，我们做的事情似乎很简单：</p>
<p>把 ⁠Intl 标准用到极致，封装了一层领域库，并接通了元数据配置，写了个工具库。</p>
<p>但如果从产品体验和工程演进的角度看，我们其实完成了一次<strong>基础设施的升级</strong>：</p>
<p>把前端开发中最琐碎、最容易被忽视的“数字与时间展示”，从“到处粘贴的小工具”，升级成了“有统一规范、有可观测性、有迭代空间的系统能力”。</p>
<p>现在，这套能力已经让得数、智珠、智能运营的部分模块长出了统一的“数字气质”。</p>
<p>未来，期望它能够走出数据平台，支撑得物更广泛的业务场景，<strong>让同一件商品，在不同地区、不同语言、不同终端上，既算得对，又看得顺。</strong></p>
<p>参考资料：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcldr.unicode.org%2F" target="_blank" title="https://cldr.unicode.org/" ref="nofollow noopener noreferrer">cldr.unicode.org/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbook.douban.com%2Fsubject%2F1927608%2F" target="_blank" title="https://book.douban.com/subject/1927608/" ref="nofollow noopener noreferrer">book.douban.com/subject/192…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.reddit.com%2Fr%2FAskHistorians%2Fcomments%2F104tkkj%2Fwhy_is_it_that_some_countries_use_the_and_as_a%2F%3Ftl%3Dzh-hans" target="_blank" title="https://www.reddit.com/r/AskHistorians/comments/104tkkj/why_is_it_that_some_countries_use_the_and_as_a/?tl=zh-hans" ref="nofollow noopener noreferrer">www.reddit.com/r/AskHistor…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fecma-international.org%2Fpublications-and-standards%2Fstandards%2Fecma-402%2F" target="_blank" title="https://ecma-international.org/publications-and-standards/standards/ecma-402/" ref="nofollow noopener noreferrer">ecma-international.org/publication…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fglobalization%2Flocale%2Fnumber-formatting" target="_blank" title="https://learn.microsoft.com/en-us/globalization/locale/number-formatting" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/globa…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh.wikipedia.org%2Fwiki%2F%25E5%25B0%258F%25E6%2595%25B8%25E9%25BB%259E" target="_blank" title="https://zh.wikipedia.org/wiki/%E5%B0%8F%E6%95%B8%E9%BB%9E" ref="nofollow noopener noreferrer">zh.wikipedia.org/wiki/%E5%B0…</a></li>
</ul>
<h4 data-id="heading-25">往期回顾</h4>
<ol>
<li>
<p>一文解析得物自建 Redis 最新技术演进</p>
</li>
<li>
<p>Golang HTTP请求超时与重试：构建高可靠网络请求｜得物技术</p>
</li>
<li>
<p>RN与hawk碰撞的火花之C++异常捕获｜得物技术</p>
</li>
<li>
<p>得物TiDB升级实践</p>
</li>
<li>
<p>得物管理类目配置线上化：从业务痛点到技术实现</p>
</li>
</ol>
<h4 data-id="heading-26">文 /柏锐</h4>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain1.0实战之多模态RAG系统（二）——多模态RAG系统图片分析与语音转写功能实现]]></title>    <link>https://juejin.cn/post/7576155969606303779</link>    <guid>https://juejin.cn/post/7576155969606303779</guid>    <pubDate>2025-11-25T03:53:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576155969606303779" data-draft-id="7574967214128906266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain1.0实战之多模态RAG系统（二）——多模态RAG系统图片分析与语音转写功能实现"/> <meta itemprop="keywords" content="人工智能,LangChain,MCP"/> <meta itemprop="datePublished" content="2025-11-25T03:53:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型真好玩"/> <meta itemprop="url" content="https://juejin.cn/user/3140624091453053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain1.0实战之多模态RAG系统（二）——多模态RAG系统图片分析与语音转写功能实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3140624091453053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型真好玩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T03:53:32.000Z" title="Tue Nov 25 2025 03:53:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>上篇分享《<a href="https://juejin.cn/post/7572836557142491136" target="_blank" title="https://juejin.cn/post/7572836557142491136">LangChain1.0实战之多模态RAG系统（一）——多模态RAG系统核心架构及智能问答功能开发</a>》中笔者系统介绍了基于 LangChain 1.0 构建多模态 RAG 系统的整体架构设计，并完成了智能问答基础模块的开发，实现了对话历史管理、流式响应等核心功能。</p>
<p>本篇笔者将在此基础上，进一步实现多模态 RAG 系统的两个重要扩展功能：<strong>图片内容分析</strong>与<strong>语音信息转写</strong>。通过引入对图像和语音数据的处理能力，让 RAG 系统真正具备理解和响应多种模态信息的能力。</p>
<p><strong>学习前置要求</strong>：本文是系列的第二篇，强烈建议大家先掌握第一篇中介绍的项目架构、环境配置和基础代码实现，这将有助于大家更好地理解本文的内容。</p>
<p>本系列内容适合所有对 LangChain 感兴趣的学习者，无论之前是否接触过 LangChain。当然，如果大家已经学习过我的专栏<a href="https://juejin.cn/column/7526240014499495972" title="https://juejin.cn/column/7526240014499495972" target="_blank">《深入浅出LangChain&amp;LangGraph AI Agent 智能体开发》</a>，相信可以更快上手。该专栏基于笔者在实际项目中的深度使用经验，系统讲解了使用LangChain/LangGraph如何开发智能体，目前已更新 27讲，并持续补充实战与拓展内容。欢迎感兴趣的同学关注笔者的掘金账号与专栏，也可关注笔者的同名微信公众号 <strong>大模型真好玩</strong>，每期分享涉及的代码均可在公众号私信: <strong>LangChain智能体开发</strong>免费获取。</p>
<h2 data-id="heading-1">一、图片分析功能实现</h2>
<h3 data-id="heading-2">1.1 传统图片分析系统建设思路</h3>
<p>在构建图片分析系统时，传统技术方案通常采用多阶段处理流程：</p>
<p><strong>核心技术路径：</strong></p>
<ul>
<li><strong>图像预处理</strong>：使用 OpenCV、PIL 等 Python 库对原始图像进行尺寸调整、色彩校正、噪声过滤等预处理操作</li>
<li><strong>文字信息提取</strong>：通过 OCR 模型（如 MonkeyOCR、DeepSeek-OCR）识别并提取图像中的文本内容</li>
<li><strong>语义理解分析</strong>：借助多模态大模型（如 Qwen-VL 系列）对图像进行深度语义解析，理解图像场景、对象关系等高层语义信息</li>
</ul>
<p>这种分层处理架构虽然技术成熟，但存在流程复杂、误差累积等问题。随着多模态大模型能力的提升，笔者这里采用更简洁高效的端到端解决方案。</p>
<h3 data-id="heading-3">1.2 多模态 RAG 图片分析实现</h3>
<p>本系统得益于Qwen3-Omni在文本、图像、音频全模态任务中保持的顶尖性能，实现一体化的图片分析功能。</p>
<h4 data-id="heading-4">1.2.1 数据结构回顾与设计</h4>
<p>首先回顾笔者在<a href="https://juejin.cn/post/7572836557142491136" target="_blank" title="https://juejin.cn/post/7572836557142491136">LangChain1.0实战之多模态RAG系统（一）——多模态RAG系统核心架构及智能问答功能开发</a>中定义的核心数据结构，多模态RAG系统会将图片经过base64编码转化为字符串中存储在<code>ContentBlock</code>中，与文字内容同步送入Qwen3-Omni大模型处理，这里不需要变动数据结构：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentBlock</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">type</span>: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"内容类型: text, image, audio"</span>)
    content: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = Field(description=<span class="hljs-string">"内容数据"</span>)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    content_blocks: <span class="hljs-type">List</span>[ContentBlock] = Field(default=[], description=<span class="hljs-string">"内容块"</span>)
    history: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]] = Field(default=[], description=<span class="hljs-string">"对话历史"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageResponse</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    content: <span class="hljs-built_in">str</span>
    timestamp: <span class="hljs-built_in">str</span>
    role: <span class="hljs-built_in">str</span>
</code></pre>
<h4 data-id="heading-5">1.2.2 图像编码处理工具</h4>
<p>在项目根目录创建 <code>utils.py</code> 文件，实现图像编码工具类，图像编码工具类负责识别用户上传图片格式并将其编码为base64字符串:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> UploadFile, HTTPException


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageProcessor</span>:
    <span class="hljs-string">"""图像处理工具类"""</span>

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">image_to_base64</span>(<span class="hljs-params">image_file: UploadFile</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 读取文件内容</span>
            contents = image_file.file.read()
            <span class="hljs-comment"># 进行base64编码</span>
            base64_encoded = base64.b64encode(contents).decode(<span class="hljs-string">'utf-8'</span>)
            <span class="hljs-keyword">return</span> base64_encoded
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"图像编码失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_image_mime_type</span>(<span class="hljs-params">filename: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        extension = filename.split(<span class="hljs-string">'.'</span>)[-<span class="hljs-number">1</span>].lower()
        mime_types = {
            <span class="hljs-string">'jpg'</span>: <span class="hljs-string">'image/jpeg'</span>,
            <span class="hljs-string">'jpeg'</span>: <span class="hljs-string">'image/jpeg'</span>,
            <span class="hljs-string">'png'</span>: <span class="hljs-string">'image/png'</span>,
            <span class="hljs-string">'gif'</span>: <span class="hljs-string">'image/gif'</span>,
            <span class="hljs-string">'bmp'</span>: <span class="hljs-string">'image/bmp'</span>,
            <span class="hljs-string">'webp'</span>: <span class="hljs-string">'image/webp'</span>
        }
        <span class="hljs-keyword">return</span> mime_types.get(extension, <span class="hljs-string">'image/jpeg'</span>)
</code></pre>
<h4 data-id="heading-6">1.2.3 多模态消息构建</h4>
<p>修改多模态消息构建逻辑，支持图像数据的处理，识别图片后缀格式并将其处理为base64字符串，构造格式为<code>{"type":"image_url", "image_url":{"url": 图片base64格式}}</code>的多模态大模型访问请求。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_multimodal_message</span>(<span class="hljs-params">request: MessageRequest, image_file: UploadFile</span>) -&gt; HumanMessage:
    <span class="hljs-string">"""创建多模态消息"""</span>
    message_content = []

    <span class="hljs-comment"># 如果有图片</span>
    <span class="hljs-keyword">if</span> image_file:
        processor = ImageProcessor()
        mime_type = processor.get_image_mime_type(image_file.filename)
        base64_image = processor.image_to_base64(image_file)
        message_content.append({
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
            <span class="hljs-string">"image_url"</span>: {
                <span class="hljs-string">"url"</span>: <span class="hljs-string">f"data:<span class="hljs-subst">{mime_type}</span>;base64,<span class="hljs-subst">{base64_image}</span>"</span>
            },
        })

    <span class="hljs-comment"># 处理内容块</span>
    <span class="hljs-keyword">for</span> i, block <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(request.content_blocks):
        <span class="hljs-keyword">if</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"text"</span>:
            message_content.append({
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: block.content
            })
        <span class="hljs-keyword">elif</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"image"</span>:
            <span class="hljs-comment"># 只有base64格式的消息才会被接入</span>
            <span class="hljs-keyword">if</span> block.content.startswith(<span class="hljs-string">"data:image"</span>):
                message_content.append({
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                    <span class="hljs-string">"image_url"</span>: {
                        <span class="hljs-string">"url"</span>: block.content
                    },
                })
    <span class="hljs-keyword">return</span> HumanMessage(content=message_content)
</code></pre>
<h4 data-id="heading-7">1.2.4 历史记录多模态支持</h4>
<p>增强历史记录处理函数，添加图像分析的系统提示和多模态内容支持：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert_history_to_messages</span>(<span class="hljs-params">history: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-type">List</span>[BaseMessage]:
    <span class="hljs-string">"""将历史记录转换为 LangChain 消息格式，支持多模态内容"""</span>
    messages = []

    <span class="hljs-comment"># 添加系统消息</span>
    system_prompt = <span class="hljs-string">"""
        你是一个专业的多模态 RAG 助手，具备如下能：
        1. 与用户对话的能力。
        2. 图像内容识别和分析能力(OCR, 对象检测， 场景理解)
        
        重要指导原则：
        - 当用户上传图片并提出问题时，请结合图片内容和用户的具体问题来回答
        - 仔细分析图片中的文字、图表、对象、场景等所有可见信息
        - 根据用户的问题重点，有针对性地分析图片相关部分
        - 如果图片包含文字，请准确识别并在回答中引用
        - 如果用户只上传图片没有问题，则提供图片的全面分析
        
        请以专业、准确、友好的方式回答
    """</span>

    messages.append(SystemMessage(content=system_prompt))

    <span class="hljs-comment"># 转换历史消息</span>
    <span class="hljs-keyword">for</span> i, msg <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(history):
        content = msg.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
        content_blocks = msg.get(<span class="hljs-string">"content_blocks"</span>, [])
        message_content = []
        <span class="hljs-keyword">if</span> msg[<span class="hljs-string">"role"</span>] == <span class="hljs-string">"user"</span>:
            <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> content_blocks:
                <span class="hljs-keyword">if</span> block.get(<span class="hljs-string">"type"</span>) == <span class="hljs-string">"text"</span>:
                    message_content.append({
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                        <span class="hljs-string">"text"</span>: block.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
                    })
                <span class="hljs-keyword">elif</span> block.get(<span class="hljs-string">"type"</span>) == <span class="hljs-string">"image"</span>:
                    image_data = block.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
                    <span class="hljs-keyword">if</span> image_data.startswith(<span class="hljs-string">"data:image"</span>):
                        message_content.append({
                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                            <span class="hljs-string">"image_url"</span> : {
                                <span class="hljs-string">"url"</span>: image_data
                            }
                        })
            messages.append(HumanMessage(content=message_content))
        <span class="hljs-keyword">elif</span> msg[<span class="hljs-string">"role"</span>] == <span class="hljs-string">"assistant"</span>:
            messages.append(AIMessage(content=content))

    <span class="hljs-keyword">return</span> messages
</code></pre>
<h4 data-id="heading-8">1.2.5 接口格式调整</h4>
<p>由于现在需要同时支持 JSON 数据和文件上传，将接口调整为 <code>multipart/form-data</code> 格式，修改<code>chat_stream</code>接口如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/api/chat/stream"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_stream</span>(<span class="hljs-params">
        image_file: UploadFile = File(<span class="hljs-params">...</span>),
        content_blocks: <span class="hljs-built_in">str</span> = Form(<span class="hljs-params">default=<span class="hljs-string">"[]"</span></span>),
        history: <span class="hljs-built_in">str</span> = Form(<span class="hljs-params">default=<span class="hljs-string">"[]"</span></span>)
</span>):
    <span class="hljs-string">"""流式聊天接口（支持多模态）"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 解析 JSON 字符串</span>
        <span class="hljs-keyword">try</span>:
            content_blocks_data = json.loads(content_blocks)
            history_data = json.loads(history)
        <span class="hljs-keyword">except</span> json.JSONDecodeError <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-string">f"JSON 解析错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)

        <span class="hljs-comment"># 创建请求对象（用于传递给其他函数）</span>
        request_data = MessageRequest(content_blocks=content_blocks_data, history=history_data)

        <span class="hljs-comment"># 转换消息历史</span>
        messages = convert_history_to_messages(request_data.history)

        <span class="hljs-comment"># 添加当前用户消息（支持多模态）</span>
        current_message = create_multimodal_message(request_data, image_file)
        messages.append(current_message)

        <span class="hljs-comment"># 返回流式响应</span>
        <span class="hljs-keyword">return</span> StreamingResponse(
            generate_streaming_response(messages),
            media_type=<span class="hljs-string">"text/event-stream"</span>,
            headers={
                <span class="hljs-string">"Cache-Control"</span>: <span class="hljs-string">"no-cache"</span>,
                <span class="hljs-string">"Connection"</span>: <span class="hljs-string">"keep-alive"</span>,
                <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/event-stream"</span>,
            }
        )
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-built_in">str</span>(e))
</code></pre>
<p>完成以上五个核心模块的修改后，系统就具备了完整的图片分析能力，可以处理用户上传的图像并进行智能问答~</p>
<h3 data-id="heading-9">1.3 图片分析功能测试</h3>
<p>完成代码开发后，我们通过 Postman 对图片分析功能进行完整测试。</p>
<h4 data-id="heading-10">测试配置步骤</h4>
<p><strong>1. 请求头设置</strong><br/>
在 Postman 的 Headers 选项卡中配置：</p>
<ul>
<li><code>Content-Type</code>: <code>multipart/form-data</code></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79d0bbb40ce04007acdefbd6c7f5014d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647612&amp;x-signature=WSSGEbzKXxwY4A6%2BuZqbQd%2FLYNw%3D" alt="0.png" loading="lazy"/></p>
<p><strong>2. 请求体配置</strong><br/>
在 Body 选项卡中选择 <code>form-data</code> 格式，添加以下参数：</p>

























<table><thead><tr><th>字段名</th><th>类型</th><th>值</th></tr></thead><tbody><tr><td><code>image_file</code></td><td>File</td><td>选择 Gemini 3.0 Logo 图片文件</td></tr><tr><td><code>content_blocks</code></td><td>Text</td><td><code>[{"type": "text", "content": "请分析这张图片"}]</code></td></tr><tr><td><code>history</code></td><td>Text</td><td><code>[]</code></td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7952e8bbe8d34d339c12833cf661790c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647612&amp;x-signature=am8rJbG3YKlpgHzHE1i%2BQLirLZA%3D" alt="2.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb12dbca73d54784ac8447e2801115bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647612&amp;x-signature=uuC4hnkm%2B94MfssbaPrXsrPU7wc%3D" alt="1.png" loading="lazy"/></p>
<p><strong>3. 测试执行</strong><br/>
向 <code>/api/chat/stream</code> 端点发送 POST 请求，系统返回流式响应。</p>
<h4 data-id="heading-11">测试结果验证</h4>
<p>从响应结果可见，系统成功识别并分析了测试图片：</p>
<ul>
<li>准确识别出图片包含 Gemini 3.0 的 Logo</li>
<li>详细描述了 Logo 的设计元素和视觉特征</li>
<li>提供了完整的图片内容分析</li>
</ul>
<p>测试结果表明，图片分析功能已正常集成到多模态 RAG 系统中，能够正确处理用户上传的图片并结合问题进行智能分析。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dd03b25877941bd85574d5f26e8113c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647612&amp;x-signature=kQhFHuiDpMLYpYD4d0KxMeBNpFk%3D" alt="3.png" loading="lazy"/></p>
<h2 data-id="heading-12">二、音频分析功能实现</h2>
<h3 data-id="heading-13">2.1 多模态RAG音频处理的实现</h3>
<p>音频分析功能的实现思路与图片分析类似，主要通过 Base64 编码和格式转换实现音频数据的处理与传输。</p>
<h4 data-id="heading-14">2.1.1 数据结构设计</h4>
<p>音频数据采用与图片相同的存储方式，通过 Base64 编码存储在 <code>content</code> 字段中：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentBlock</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">type</span>: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"内容类型: text, image, audio"</span>)
    content: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = Field(description=<span class="hljs-string">"内容数据"</span>)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    content_blocks: <span class="hljs-type">List</span>[ContentBlock] = Field(default=[], description=<span class="hljs-string">"内容块"</span>)
    history: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]] = Field(default=[], description=<span class="hljs-string">"对话历史"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageResponse</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    content: <span class="hljs-built_in">str</span>
    timestamp: <span class="hljs-built_in">str</span>
    role: <span class="hljs-built_in">str</span>
</code></pre>
<h4 data-id="heading-15">2.1.2 音频处理工具类</h4>
<p>在 <code>utils.py</code> 中添加音频处理工具类，支持多种音频格式，针对音频格式的处理笔者额外添加了上传文件大小的相关限制：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AudioProcessor</span>:
    <span class="hljs-string">"""音频处理工具类"""</span>

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">audio_to_base64</span>(<span class="hljs-params">audio_file: UploadFile</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 验证文件类型</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> AudioProcessor.is_valid_audio_type(audio_file.content_type, audio_file.filename):
                <span class="hljs-keyword">raise</span> HTTPException(
                    status_code=<span class="hljs-number">400</span>,
                    detail=<span class="hljs-string">"不支持的音频格式，支持的格式有: MP3, WAV, OGG, M4A, FLAC"</span>
                )

            <span class="hljs-comment"># 读取文件内容</span>
            contents = audio_file.file.read()

            <span class="hljs-comment"># 验证文件大小（可选：限制为10MB）</span>
            max_size = <span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>  <span class="hljs-comment"># 10MB</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(contents) &gt; max_size:
                <span class="hljs-keyword">raise</span> HTTPException(
                    status_code=<span class="hljs-number">400</span>,
                    detail=<span class="hljs-string">f"音频文件过大，最大支持 <span class="hljs-subst">{max_size // <span class="hljs-number">1024</span> // <span class="hljs-number">1024</span>}</span>MB"</span>
                )

            base64_encoded = base64.b64encode(contents).decode(<span class="hljs-string">'utf-8'</span>)
            <span class="hljs-keyword">return</span> base64_encoded

        <span class="hljs-keyword">except</span> HTTPException:
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"音频编码失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_audio_mime_type</span>(<span class="hljs-params">filename: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        extension = filename.split(<span class="hljs-string">'.'</span>)[-<span class="hljs-number">1</span>].lower()
        mime_types = {
            <span class="hljs-string">'mp3'</span>: <span class="hljs-string">'audio/mpeg'</span>,
            <span class="hljs-string">'wav'</span>: <span class="hljs-string">'audio/wav'</span>,
            <span class="hljs-string">'m4a'</span>: <span class="hljs-string">'audio/mp4'</span>,
        }
        <span class="hljs-keyword">return</span> mime_types.get(extension, <span class="hljs-string">'audio/mpeg'</span>)  <span class="hljs-comment"># 默认为MP3</span>

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_valid_audio_type</span>(<span class="hljs-params">content_type: <span class="hljs-built_in">str</span>, filename: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-comment"># 获取支持的MIME类型列表</span>
        supported_mimes = {
            <span class="hljs-string">'audio/mpeg'</span>, <span class="hljs-string">'audio/wav'</span>, <span class="hljs-string">'audio/mp4'</span>
        }

        <span class="hljs-comment"># 检查content_type</span>
        <span class="hljs-keyword">if</span> content_type <span class="hljs-keyword">and</span> content_type <span class="hljs-keyword">in</span> supported_mimes:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

        <span class="hljs-comment"># 检查文件扩展名</span>
        file_extension = filename.split(<span class="hljs-string">'.'</span>)[-<span class="hljs-number">1</span>].lower()
        supported_extensions = {<span class="hljs-string">'mp3'</span>, <span class="hljs-string">'wav'</span>, <span class="hljs-string">'m4a'</span>}

        <span class="hljs-keyword">return</span> file_extension <span class="hljs-keyword">in</span> supported_extensions
</code></pre>
<h4 data-id="heading-16">2.1.3 多模态消息构建增强</h4>
<p>扩展 <code>create_multimodal_message</code> 函数，支持音频数据的处理, 首先提取音频文件后缀并将其处理为base64格式，同时构造格式为<code>{"type":"audio_url", "audio_url":{"url": 音频base64格式}}</code>多模态大模型访问请求：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_multimodal_message</span>(<span class="hljs-params">request: MessageRequest, image_file: UploadFile | <span class="hljs-literal">None</span>, audio_file:UploadFile | <span class="hljs-literal">None</span></span>) -&gt; HumanMessage:
    <span class="hljs-string">"""创建多模态消息"""</span>
    message_content = []

    <span class="hljs-comment"># 如果有图片</span>
    <span class="hljs-keyword">if</span> image_file:
        processor = ImageProcessor()
        mime_type = processor.get_image_mime_type(image_file.filename)
        base64_image = processor.image_to_base64(image_file)
        message_content.append({
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
            <span class="hljs-string">"image_url"</span>: {
                <span class="hljs-string">"url"</span>: <span class="hljs-string">f"data:<span class="hljs-subst">{mime_type}</span>;base64,<span class="hljs-subst">{base64_image}</span>"</span>
            },
        })
    <span class="hljs-keyword">if</span> audio_file:
        processor = AudioProcessor()
        mime_type = processor.get_audio_mime_type(audio_file.filename)
        base64_audio = processor.audio_to_base64(audio_file)
        message_content.append({
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"audio_url"</span>,
            <span class="hljs-string">"audio_url"</span>: {
                <span class="hljs-string">"url"</span>: <span class="hljs-string">f"data:<span class="hljs-subst">{mime_type}</span>;base64,<span class="hljs-subst">{base64_audio}</span>"</span>
            },
        })
    <span class="hljs-comment"># 处理内容块</span>
    <span class="hljs-keyword">for</span> i, block <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(request.content_blocks):
        <span class="hljs-keyword">if</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"text"</span>:
            message_content.append({
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: block.content
            })
        <span class="hljs-keyword">elif</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"image"</span>:
            <span class="hljs-comment"># 只有base64格式的消息才会被接入</span>
            <span class="hljs-keyword">if</span> block.content.startswith(<span class="hljs-string">"data:image"</span>):
                message_content.append({
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                    <span class="hljs-string">"image_url"</span>: {
                        <span class="hljs-string">"url"</span>: block.content
                    },
                })
        <span class="hljs-keyword">elif</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"audio"</span>:
            <span class="hljs-keyword">if</span> block.content.startswith(<span class="hljs-string">"data:audio"</span>):
                message_content.append({
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"audio_url"</span>,
                    <span class="hljs-string">"audio_url"</span>: {
                        <span class="hljs-string">"url"</span>: block.content
                    },
                })

    <span class="hljs-keyword">return</span> HumanMessage(content=message_content)
</code></pre>
<h4 data-id="heading-17">2.1.4 历史记录处理增强</h4>
<p>更新系统提示词，添加音频处理能力，并增强历史记录处理逻辑：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert_history_to_messages</span>(<span class="hljs-params">history: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-type">List</span>[BaseMessage]:
    <span class="hljs-string">"""将历史记录转换为 LangChain 消息格式，支持多模态内容"""</span>
    messages = []

    <span class="hljs-comment"># 添加系统消息</span>
    system_prompt = <span class="hljs-string">"""
        你是一个专业的多模态 RAG 助手，具备如下能：
        1. 与用户对话的能力。
        2. 图像内容识别和分析能力(OCR, 对象检测， 场景理解)
        3. 音频转写与分析
        
        重要指导原则：
        - 当用户上传图片并提出问题时，请结合图片内容和用户的具体问题来回答
        - 仔细分析图片中的文字、图表、对象、场景等所有可见信息
        - 根据用户的问题重点，有针对性地分析图片相关部分
        - 如果图片包含文字，请准确识别并在回答中引用
        - 如果用户只上传图片没有问题，则提供图片的全面分析
        
        请以专业、准确、友好的方式回答
    """</span>

    messages.append(SystemMessage(content=system_prompt))

    <span class="hljs-comment"># 转换历史消息</span>
    <span class="hljs-keyword">for</span> i, msg <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(history):
        content = msg.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
        content_blocks = msg.get(<span class="hljs-string">"content_blocks"</span>, [])
        message_content = []
        <span class="hljs-keyword">if</span> msg[<span class="hljs-string">"role"</span>] == <span class="hljs-string">"user"</span>:
            <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> content_blocks:
                <span class="hljs-keyword">if</span> block.get(<span class="hljs-string">"type"</span>) == <span class="hljs-string">"text"</span>:
                    message_content.append({
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                        <span class="hljs-string">"text"</span>: block.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
                    })
                <span class="hljs-keyword">elif</span> block.get(<span class="hljs-string">"type"</span>) == <span class="hljs-string">"image"</span>:
                    image_data = block.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
                    <span class="hljs-keyword">if</span> image_data.startswith(<span class="hljs-string">"data:image"</span>):
                        message_content.append({
                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                            <span class="hljs-string">"image_url"</span> : {
                                <span class="hljs-string">"url"</span>: image_data
                            }
                        })
                <span class="hljs-keyword">elif</span> block.get(<span class="hljs-string">"type"</span>) == <span class="hljs-string">"audio"</span>:
                    audio_data = block.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
                    <span class="hljs-keyword">if</span> audio_data.startswith(<span class="hljs-string">"data:audio"</span>):
                        message_content.append({
                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"audio_url"</span>,
                            <span class="hljs-string">"image_url"</span>: {
                                <span class="hljs-string">"url"</span>: audio_data
                            }
                        })
            messages.append(HumanMessage(content=message_content))
        <span class="hljs-keyword">elif</span> msg[<span class="hljs-string">"role"</span>] == <span class="hljs-string">"assistant"</span>:
            messages.append(AIMessage(content=content))

    <span class="hljs-keyword">return</span> messages
</code></pre>
<h4 data-id="heading-18">2.1.5 接口完整实现</h4>
<p>更新聊天接口，同时支持图片和音频文件上传：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/api/chat/stream"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_stream</span>(<span class="hljs-params">
        image_file: UploadFile | <span class="hljs-literal">None</span> = File(<span class="hljs-params"><span class="hljs-literal">None</span></span>),
        content_blocks: <span class="hljs-built_in">str</span> = Form(<span class="hljs-params">default=<span class="hljs-string">"[]"</span></span>),
        history: <span class="hljs-built_in">str</span> = Form(<span class="hljs-params">default=<span class="hljs-string">"[]"</span></span>),
        audio_file: UploadFile | <span class="hljs-literal">None</span> = File(<span class="hljs-params"><span class="hljs-literal">None</span></span>)
</span>):
    <span class="hljs-string">"""流式聊天接口（支持多模态）"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 解析 JSON 字符串</span>
        <span class="hljs-keyword">try</span>:
            content_blocks_data = json.loads(content_blocks)
            history_data = json.loads(history)
        <span class="hljs-keyword">except</span> json.JSONDecodeError <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-string">f"JSON 解析错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)

        <span class="hljs-comment"># 创建请求对象（用于传递给其他函数）</span>
        request_data = MessageRequest(content_blocks=content_blocks_data, history=history_data)

        <span class="hljs-comment"># 转换消息历史</span>
        messages = convert_history_to_messages(request_data.history)

        <span class="hljs-comment"># 添加当前用户消息（支持多模态）</span>
        current_message = create_multimodal_message(request_data, image_file=image_file, audio_file=audio_file)
        messages.append(current_message)

        <span class="hljs-comment"># 返回流式响应</span>
        <span class="hljs-keyword">return</span> StreamingResponse(
            generate_streaming_response(messages),
            media_type=<span class="hljs-string">"text/event-stream"</span>,
            headers={
                <span class="hljs-string">"Cache-Control"</span>: <span class="hljs-string">"no-cache"</span>,
                <span class="hljs-string">"Connection"</span>: <span class="hljs-string">"keep-alive"</span>,
                <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/event-stream"</span>,
            }
        )
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-built_in">str</span>(e))
</code></pre>
<h3 data-id="heading-19">2.2 功能测试</h3>
<p>完成代码开发后，通过 Postman 对音频分析功能进行测试。</p>
<p><strong>测试配置：</strong></p>
<ul>
<li><strong>请求头</strong>：<code>Content-Type: multipart/form-data</code></li>
<li><strong>请求体</strong>（form-data格式）：</li>
</ul>

























<table><thead><tr><th>字段名</th><th>类型</th><th>值</th></tr></thead><tbody><tr><td><code>audio_file</code></td><td>File</td><td>选择测试音频文件（包含"你好"的录音）</td></tr><tr><td><code>content_blocks</code></td><td>Text</td><td><code>[{"type": "text", "content": "请解析音频内容"}]</code></td></tr><tr><td><code>history</code></td><td>Text</td><td><code>[]</code></td></tr></tbody></table>
<p><strong>测试结果：</strong><br/>
系统成功识别并转写了音频内容，准确输出三个"你好"，验证了音频分析功能的正确性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3c07ecb430d4db79d611bb0fba1123b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764647612&amp;x-signature=6MrKCRb7euGwZhFKRgtVY6SmsZg%3D" alt="5.png" loading="lazy"/></p>
<h2 data-id="heading-20">三、总结</h2>
<p>本期分享通过集成全模态大模型的能力，成功构建了支持图片和音频分析的多模态 RAG 系统。这种端到端的解决方案大大简化了传统多模态处理的复杂性，展现了未来大模型技术的发展趋势。下期分享笔者将和大家一起处理多模态PDF文档，也是我们多模态RAG系统的核心功能，大家敬请期待~</p>
<p><a href="https://juejin.cn/column/7526240014499495972" title="https://juejin.cn/column/7526240014499495972" target="_blank">《深入浅出LangChain&amp;LangGraph AI Agent 智能体开发》</a>专栏内容源自笔者在实际学习和工作中对 LangChain 与 LangGraph 的深度使用经验，旨在帮助大家系统性地、高效地掌握 AI Agent 的开发方法，在各大技术平台获得了不少关注与支持。目前已更新28讲，正在更新实战篇和LangChain1.0实战项目多模态RAG系统开发，并随时补充笔者在实际工作中总结的拓展知识点。如果大家感兴趣，欢迎关注笔者的掘金账号与专栏，也可关注笔者的同名微信公众号 <strong>大模型真好玩</strong>，每期分享涉及的代码均可在公众号私信: <strong>LangChain智能体开发</strong>免费获取。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[涨见识了，Error.cause 让 JavaScript 错误调试更轻松]]></title>    <link>https://juejin.cn/post/7576371992615649316</link>    <guid>https://juejin.cn/post/7576371992615649316</guid>    <pubDate>2025-11-25T10:03:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576371992615649316" data-draft-id="7576276707332177926" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="涨见识了，Error.cause 让 JavaScript 错误调试更轻松"/> <meta itemprop="keywords" content="前端,JavaScript,Node.js"/> <meta itemprop="datePublished" content="2025-11-25T10:03:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            涨见识了，Error.cause 让 JavaScript 错误调试更轻松
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T10:03:58.000Z" title="Tue Nov 25 2025 10:03:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>在 JavaScript 中，抛出错误很容易，但追溯原因却有些麻烦，这就是 <code>cause</code>属性的用武之地。</p>
<p>这是我们传统的处理错误的做法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span> {
  <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">"{ bad json }"</span>);
} <span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Something went wrong: "</span> + err.<span class="hljs-property">message</span>);
}
</code></pre>
<p>虽然包装了错误，但已经丢失了原始的堆栈信息和错误类型。</p>
<p>当问题发生时，你只能看到最顶层的错误信息，却不知道根本原因是什么。</p>
<p>你好，我是冴羽。前端资讯、前端干货，欢迎关注公众号：冴羽</p>
<h2 data-id="heading-1">2. 引入 Error.cause</h2>
<p>ES2022 引入了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FError%2Fcause" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Error/cause" ref="nofollow noopener noreferrer">Error.cause</a> 属性，可以保留原始错误信息：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">"{ bad json }"</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Something went wrong"</span>, { <span class="hljs-attr">cause</span>: err });
  }
} <span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err.<span class="hljs-property">stack</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Caused by:"</span>, err.<span class="hljs-property">cause</span>.<span class="hljs-property">stack</span>);
}
</code></pre>
<p>此时你可以看到完整的错误链：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Error</span>: <span class="hljs-title class_">Something</span> went wrong
    at ...
<span class="hljs-title class_">Caused</span> <span class="hljs-attr">by</span>: <span class="hljs-title class_">SyntaxError</span>: <span class="hljs-title class_">Unexpected</span> token b <span class="hljs-keyword">in</span> <span class="hljs-title class_">JSON</span> at position <span class="hljs-number">2</span>
    at <span class="hljs-title class_">JSON</span>.<span class="hljs-property">parse</span> (&lt;anonymous&gt;)
    at ...
</code></pre>
<p>现在，你既保留了原始错误，又能提供清晰的顶层错误信息。</p>
<h2 data-id="heading-2">3. 实际应用示例</h2>
<p>让我们看一个更实际的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUserData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">"{ broken: true }"</span>); <span class="hljs-comment">// ← 这里会失败</span>
  } <span class="hljs-keyword">catch</span> (parseError) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Failed to fetch user data"</span>, { <span class="hljs-attr">cause</span>: parseError });
  }
}

<span class="hljs-keyword">try</span> {
  <span class="hljs-title function_">fetchUserData</span>();
} <span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err.<span class="hljs-property">message</span>); <span class="hljs-comment">// "Failed to fetch user data"</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err.<span class="hljs-property">cause</span>); <span class="hljs-comment">// [SyntaxError: Unexpected token b in JSON]</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err.<span class="hljs-property">cause</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">SyntaxError</span>); <span class="hljs-comment">// true</span>
}
</code></pre>
<p>可以看到代码非常清晰直观。</p>
<p><strong>而且 cause 属性被定义为不可枚举</strong>，因此它不会污染日志或 for...in 循环，除非你显式访问它。</p>
<h2 data-id="heading-3">4. 自定义错误类</h2>
<p>你可以在自定义错误类中使用 <code>cause</code> 属性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Error</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">message, { cause } = {}</span>) {
    <span class="hljs-variable language_">super</span>(message, { cause });
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">"DatabaseError"</span>;
  }
}
</code></pre>
<p>如果你的运行环境是 ES2022+，这已经足够了：<code>super(message, { cause })</code> 会自动处理一切。</p>
<p>对于 TypeScript 用户，确保 <code>tsconfig.json</code> 配置了：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es2022"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"es2022"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>否则，在将 <code>{ cause }</code> 传递给 Error 构造函数时可能会看到类型错误。</p>
<h2 data-id="heading-4">5. 更好的测试断言</h2>
<p>假设你的服务抛出了一个 <code>UserCreationError</code>，这是由一个 <code>ValidationError</code> 引发的。</p>
<p>你可以这样写断言：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">expect</span>(err.<span class="hljs-property">cause</span>).<span class="hljs-title function_">toBeInstanceOf</span>(<span class="hljs-title class_">ValidationError</span>);
</code></pre>
<p>这样测试会更清晰、更健壮。</p>
<h2 data-id="heading-5">6. 注意事项</h2>
<p>默认情况下，<code>console.error(err)</code> 只会打印顶层错误。<code>cause</code>链不会自动显示，因此需要手动打印：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Caused by:"</span>, err.<span class="hljs-property">cause</span>);
</code></pre>
<p>尽管 cause 很好，但也不要滥用。每个小错误都包装可能更乱，因此只在真正需要上下文的时候使用。</p>
<h2 data-id="heading-6">7. 递归打印完整错误链</h2>
<p>这是一个安全遍历错误链的工具函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">logErrorChain</span>(<span class="hljs-params">err, level = <span class="hljs-number">0</span></span>) {
  <span class="hljs-keyword">if</span> (!err) <span class="hljs-keyword">return</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">" "</span>.<span class="hljs-title function_">repeat</span>(level * <span class="hljs-number">2</span>) + <span class="hljs-string">`<span class="hljs-subst">${err.name}</span>: <span class="hljs-subst">${err.message}</span>`</span>);

  <span class="hljs-keyword">if</span> (err.<span class="hljs-property">cause</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
    <span class="hljs-title function_">logErrorChain</span>(err.<span class="hljs-property">cause</span>, level + <span class="hljs-number">1</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (err.<span class="hljs-property">cause</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">" "</span>.<span class="hljs-title function_">repeat</span>((level + <span class="hljs-number">1</span>) * <span class="hljs-number">2</span>) + <span class="hljs-title class_">String</span>(err.<span class="hljs-property">cause</span>));
  }
}
</code></pre>
<p>如果需要完整堆栈信息：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">logFullErrorChain</span>(<span class="hljs-params">err</span>) {
  <span class="hljs-keyword">let</span> current = err;
  <span class="hljs-keyword">while</span> (current) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(current.<span class="hljs-property">stack</span>);
    current = current.<span class="hljs-property">cause</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span> ? current.<span class="hljs-property">cause</span> : <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<p>对于结构复杂、可能在不同层级出现多种故障的系统来说，这非常有用。</p>
<h2 data-id="heading-7">8. 跨层错误链示例</h2>
<p>假设调用流程如下：</p>
<ol>
<li>数据库连接失败，抛出 <code>ConnectionTimeoutError</code></li>
<li>捕获后包装成 <code>DatabaseError</code></li>
<li>再次捕获并包装成 <code>ServiceUnavailableError</code></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionTimeoutError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Error</span> {}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Error</span> {}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceUnavailableError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Error</span> {}

<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionTimeoutError</span>(<span class="hljs-string">"DB connection timed out"</span>);
    } <span class="hljs-keyword">catch</span> (networkErr) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatabaseError</span>(<span class="hljs-string">"Failed to connect to database"</span>, { <span class="hljs-attr">cause</span>: networkErr });
    }
  } <span class="hljs-keyword">catch</span> (dbErr) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceUnavailableError</span>(<span class="hljs-string">"Unable to save user data"</span>, { <span class="hljs-attr">cause</span>: dbErr });
  }
} <span class="hljs-keyword">catch</span> (finalErr) {
  <span class="hljs-title function_">logErrorChain</span>(finalErr);
}
</code></pre>
<p>控制台输出：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">ServiceUnavailableError</span>: <span class="hljs-title class_">Unable</span> to save user data
  <span class="hljs-title class_">DatabaseError</span>: <span class="hljs-title class_">Failed</span> to connect to database
    <span class="hljs-title class_">ConnectionTimeoutError</span>: <span class="hljs-variable constant_">DB</span> connection timed out
</code></pre>
<p>可以看到，错误链提供了一个清晰的视图，告诉你发生了什么以及在哪里发生的。</p>
<h2 data-id="heading-8">9. 支持度</h2>
<p><code>.cause</code> 参数在所有现代环境中都支持：</p>
<ul>
<li>✅ Chrome 93+、Firefox 91+、Safari 15+、Edge 93+</li>
<li>✅ Node.js 16.9+</li>
<li>✅ Bun 和 Deno（当前版本）</li>
</ul>
<p>需要注意的是，开发者工具可能不会自动显示 cause。</p>
<p>所以需要显式记录它（<code>console.error('Caused by:', err.cause)</code>）。</p>
<p>还要注意：如果使用 Babel 或 TypeScript 进行转译，此功能不会被 polyfill。</p>
<h2 data-id="heading-9">10. 异步操作中的错误处理</h2>
<p>Error.cause 同样适用于异步操作。结合 async/await 可以这样使用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/api/data"</span>);
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP error! Status: <span class="hljs-subst">${response.status}</span>`</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"数据获取失败:"</span>, error);
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Failed to fetch data"</span>, { <span class="hljs-attr">cause</span>: error });
  }
}
</code></pre>
<p>这种方式让异步代码的错误处理逻辑看起来与同步代码无异，大大提升了可读性和可维护性。</p>
<h2 data-id="heading-10">11. 总结</h2>
<p>总结一下，<strong>现代错误链处理的最佳实践</strong>：</p>
<ul>
<li>使用 <code>new Error(message, { cause })</code> 保留上下文</li>
<li>适用于内置错误类和自定义错误类</li>
<li>所有现代运行时环境都支持（浏览器、Node.js、Deno、Bun）</li>
<li>可以改善日志、调试和测试断言</li>
<li>注意 TypeScript：设置 <code>"target": "es2022"</code> 和 <code>"lib": ["es2022"]</code></li>
<li>注意记录 <code>err.cause</code> 或手动遍历错误链</li>
</ul>
<p>从而实现更清晰的堆栈跟踪、更好的上下文、更愉快的调试体验。</p>
<p>Error.cause 就是你错误处理中缺少的那一环。</p>
<h2 data-id="heading-11">12. 参考链接</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fallthingssmitty.com%2F2025%2F11%2F10%2Ferror-chaining-in-javascript-cleaner-debugging-with-error-cause%2F" target="_blank" title="https://allthingssmitty.com/2025/11/10/error-chaining-in-javascript-cleaner-debugging-with-error-cause/" ref="nofollow noopener noreferrer">allthingssmitty.com/2025/11/10/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FError%2Fcause" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Error/cause" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通义千问Qwen3-Coder模型帮我总结的typescript笔记]]></title>    <link>https://juejin.cn/post/7576844295433699337</link>    <guid>https://juejin.cn/post/7576844295433699337</guid>    <pubDate>2025-11-26T10:31:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576844295433699337" data-draft-id="7576838095519170611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通义千问Qwen3-Coder模型帮我总结的typescript笔记"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-26T10:31:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="炒米2333"/> <meta itemprop="url" content="https://juejin.cn/user/1283857659996893"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通义千问Qwen3-Coder模型帮我总结的typescript笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1283857659996893/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    炒米2333
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T10:31:43.000Z" title="Wed Nov 26 2025 10:31:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>简单学了学typescript，但是又觉得做笔记麻烦，于是找AI帮帮忙，提示词为“帮我总结typescript的常用知识点，并生成一篇markdown。” 生成了下面的内容。</p>
<hr/>
<h2 data-id="heading-0">TypeScript 常用知识点速查</h2>
<p>TypeScript (TS) 是 JavaScript 的超集，添加了静态类型系统，有助于提高代码质量和开发效率。以下是其核心和常用的特性总结。</p>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tongyi.com%2F%3Fst%3Dnull%26bizPassParams%3D%2526x-platform%253DexternalH5%26sessionId%3D6ab83cd9bd4e4652b985bbb9ba54cedc%23%25E5%259F%25BA%25E7%25A1%2580%25E7%25B1%25BB%25E5%259E%258B" target="_blank" title="https://www.tongyi.com/?st=null&amp;bizPassParams=%26x-platform%3DexternalH5&amp;sessionId=6ab83cd9bd4e4652b985bbb9ba54cedc#%E5%9F%BA%E7%A1%80%E7%B1%BB%E5%9E%8B" ref="nofollow noopener noreferrer">基础类型</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tongyi.com%2F%3Fst%3Dnull%26bizPassParams%3D%2526x-platform%253DexternalH5%26sessionId%3D6ab83cd9bd4e4652b985bbb9ba54cedc%23%25E5%258F%2598%25E9%2587%258F%25E5%25A3%25B0%25E6%2598%258E%25E4%25B8%258E%25E7%25B1%25BB%25E5%259E%258B%25E6%25B3%25A8%25E8%25A7%25A3" target="_blank" title="https://www.tongyi.com/?st=null&amp;bizPassParams=%26x-platform%3DexternalH5&amp;sessionId=6ab83cd9bd4e4652b985bbb9ba54cedc#%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E4%B8%8E%E7%B1%BB%E5%9E%8B%E6%B3%A8%E8%A7%A3" ref="nofollow noopener noreferrer">变量声明与类型注解</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tongyi.com%2F%3Fst%3Dnull%26bizPassParams%3D%2526x-platform%253DexternalH5%26sessionId%3D6ab83cd9bd4e4652b985bbb9ba54cedc%23%25E6%258E%25A5%25E5%258F%25A3-interfaces" target="_blank" title="https://www.tongyi.com/?st=null&amp;bizPassParams=%26x-platform%3DexternalH5&amp;sessionId=6ab83cd9bd4e4652b985bbb9ba54cedc#%E6%8E%A5%E5%8F%A3-interfaces" ref="nofollow noopener noreferrer">接口 (Interfaces)</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tongyi.com%2F%3Fst%3Dnull%26bizPassParams%3D%2526x-platform%253DexternalH5%26sessionId%3D6ab83cd9bd4e4652b985bbb9ba54cedc%23%25E7%25B1%25BB%25E5%259E%258B%25E5%2588%25AB%25E5%2590%258D-type-aliases" target="_blank" title="https://www.tongyi.com/?st=null&amp;bizPassParams=%26x-platform%3DexternalH5&amp;sessionId=6ab83cd9bd4e4652b985bbb9ba54cedc#%E7%B1%BB%E5%9E%8B%E5%88%AB%E5%90%8D-type-aliases" ref="nofollow noopener noreferrer">类型别名 (Type Aliases)</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tongyi.com%2F%3Fst%3Dnull%26bizPassParams%3D%2526x-platform%253DexternalH5%26sessionId%3D6ab83cd9bd4e4652b985bbb9ba54cedc%23%25E8%2581%2594%25E5%2590%2588%25E7%25B1%25BB%25E5%259E%258B-union-types--%25E4%25BA%25A4%25E5%258F%2589%25E7%25B1%25BB%25E5%259E%258B-intersection-types" target="_blank" title="https://www.tongyi.com/?st=null&amp;bizPassParams=%26x-platform%3DexternalH5&amp;sessionId=6ab83cd9bd4e4652b985bbb9ba54cedc#%E8%81%94%E5%90%88%E7%B1%BB%E5%9E%8B-union-types--%E4%BA%A4%E5%8F%89%E7%B1%BB%E5%9E%8B-intersection-types" ref="nofollow noopener noreferrer">联合类型 (Union Types) &amp; 交叉类型 (Intersection Types)</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tongyi.com%2F%3Fst%3Dnull%26bizPassParams%3D%2526x-platform%253DexternalH5%26sessionId%3D6ab83cd9bd4e4652b985bbb9ba54cedc%23%25E6%2595%25B0%25E7%25BB%2584%25E4%25B8%258E%25E5%2585%2583%25E7%25BB%2584-tuples" target="_blank" title="https://www.tongyi.com/?st=null&amp;bizPassParams=%26x-platform%3DexternalH5&amp;sessionId=6ab83cd9bd4e4652b985bbb9ba54cedc#%E6%95%B0%E7%BB%84%E4%B8%8E%E5%85%83%E7%BB%84-tuples" ref="nofollow noopener noreferrer">数组与元组 (Tuples)</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tongyi.com%2F%3Fst%3Dnull%26bizPassParams%3D%2526x-platform%253DexternalH5%26sessionId%3D6ab83cd9bd4e4652b985bbb9ba54cedc%23%25E5%2587%25BD%25E6%2595%25B0%25E7%25B1%25BB%25E5%259E%258B" target="_blank" title="https://www.tongyi.com/?st=null&amp;bizPassParams=%26x-platform%3DexternalH5&amp;sessionId=6ab83cd9bd4e4652b985bbb9ba54cedc#%E5%87%BD%E6%95%B0%E7%B1%BB%E5%9E%8B" ref="nofollow noopener noreferrer">函数类型</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tongyi.com%2F%3Fst%3Dnull%26bizPassParams%3D%2526x-platform%253DexternalH5%26sessionId%3D6ab83cd9bd4e4652b985bbb9ba54cedc%23%25E7%25B1%25BB-classes" target="_blank" title="https://www.tongyi.com/?st=null&amp;bizPassParams=%26x-platform%3DexternalH5&amp;sessionId=6ab83cd9bd4e4652b985bbb9ba54cedc#%E7%B1%BB-classes" ref="nofollow noopener noreferrer">类 (Classes)</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tongyi.com%2F%3Fst%3Dnull%26bizPassParams%3D%2526x-platform%253DexternalH5%26sessionId%3D6ab83cd9bd4e4652b985bbb9ba54cedc%23%25E6%25B3%259B%25E5%259E%258B-generics" target="_blank" title="https://www.tongyi.com/?st=null&amp;bizPassParams=%26x-platform%3DexternalH5&amp;sessionId=6ab83cd9bd4e4652b985bbb9ba54cedc#%E6%B3%9B%E5%9E%8B-generics" ref="nofollow noopener noreferrer">泛型 (Generics)</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tongyi.com%2F%3Fst%3Dnull%26bizPassParams%3D%2526x-platform%253DexternalH5%26sessionId%3D6ab83cd9bd4e4652b985bbb9ba54cedc%23%25E6%25A8%25A1%25E5%259D%2597-modules-%25E5%2592%258C-%25E5%25AF%25BC%25E5%2585%25A5%25E5%25AF%25BC%25E5%2587%25BA" target="_blank" title="https://www.tongyi.com/?st=null&amp;bizPassParams=%26x-platform%3DexternalH5&amp;sessionId=6ab83cd9bd4e4652b985bbb9ba54cedc#%E6%A8%A1%E5%9D%97-modules-%E5%92%8C-%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA" ref="nofollow noopener noreferrer">模块 (Modules) 和 导入/导出</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tongyi.com%2F%3Fst%3Dnull%26bizPassParams%3D%2526x-platform%253DexternalH5%26sessionId%3D6ab83cd9bd4e4652b985bbb9ba54cedc%23%25E8%25A3%2585%25E9%25A5%25B0%25E5%2599%25A8-decorators" target="_blank" title="https://www.tongyi.com/?st=null&amp;bizPassParams=%26x-platform%3DexternalH5&amp;sessionId=6ab83cd9bd4e4652b985bbb9ba54cedc#%E8%A3%85%E9%A5%B0%E5%99%A8-decorators" ref="nofollow noopener noreferrer">装饰器 (Decorators)</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tongyi.com%2F%3Fst%3Dnull%26bizPassParams%3D%2526x-platform%253DexternalH5%26sessionId%3D6ab83cd9bd4e4652b985bbb9ba54cedc%23%25E5%25AE%259E%25E7%2594%25A8%25E5%25B7%25A5%25E5%2585%25B7%25E7%25B1%25BB%25E5%259E%258B-utility-types" target="_blank" title="https://www.tongyi.com/?st=null&amp;bizPassParams=%26x-platform%3DexternalH5&amp;sessionId=6ab83cd9bd4e4652b985bbb9ba54cedc#%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7%E7%B1%BB%E5%9E%8B-utility-types" ref="nofollow noopener noreferrer">实用工具类型 (Utility Types)</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">基础类型</h3>
<p>TypeScript 提供了一系列基础数据类型：</p>
<ul>
<li><code>number</code>: 数字类型 (整数或浮点数)。</li>
<li><code>string</code>: 字符串类型。</li>
<li><code>boolean</code>: 布尔值 (<code>true</code> 或 <code>false</code>)。</li>
<li><code>null</code> 和 <code>undefined</code>: 它们有自己的类型 <code>null</code> 和 <code>undefined</code>。但在 <code>strictNullChecks</code> 模式下（推荐），它们只能赋值给 <code>any</code> 和各自的类型；否则（非严格模式），它们是所有类型的子类型。</li>
<li><code>symbol</code>: ES6 新增的原始数据类型，表示独一无二的值。</li>
<li><code>bigint</code>: 大整数类型。</li>
<li><code>void</code>: 通常用于表示没有返回值的函数的返回类型。</li>
<li><code>any</code>: 允许任何类型的值，会跳过类型检查（不推荐滥用）。</li>
<li><code>unknown</code>: 代表任何值。与 <code>any</code> 不同的是，在对 <code>unknown</code> 类型的值执行操作前，必须进行类型检查或类型断言。</li>
<li><code>never</code>: 表示永不存在的值的类型。例如，总是抛出异常或根本不可能有返回值的函数表达式的返回类型。</li>
<li><code>object</code>: 非原始类型（即除 number, string, boolean, symbol, null, undefined, bigint 之外的类型）。注意：它不同于 <code>{}</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-3">变量声明与类型注解</h3>
<p>使用 <code>let</code>, <code>const</code>, <code>var</code> 声明变量，并通过冒号 <code>:</code> 添加类型注解。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">isDone</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">decimal</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">6</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">color</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"blue"</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">list</span>: <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">let</span> <span class="hljs-attr">u</span>: <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">n</span>: <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// 函数参数和返回值的类型注解</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> x + y;
}
</code></pre>
<hr/>
<h3 data-id="heading-4">接口 (Interfaces)</h3>
<p>接口用于定义对象的结构（Shape），是一种契约。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
    address?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 可选属性</span>
    <span class="hljs-keyword">readonly</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 只读属性</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">Person</span> = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>,
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>
};
<span class="hljs-comment">// user.id = 2; // Error: Cannot assign to 'id' because it is a read-only property.</span>

<span class="hljs-comment">// 函数类型接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SearchFunc</span> {
    (<span class="hljs-attr">source</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">subString</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">boolean</span>;
}
<span class="hljs-keyword">let</span> <span class="hljs-attr">mySearch</span>: <span class="hljs-title class_">SearchFunc</span>;
mySearch = <span class="hljs-keyword">function</span>(<span class="hljs-params">src, sub</span>) { <span class="hljs-comment">// 参数名不必与接口中定义的名字相匹配</span>
    <span class="hljs-keyword">let</span> result = src.<span class="hljs-title function_">search</span>(sub);
    <span class="hljs-keyword">return</span> result &gt; -<span class="hljs-number">1</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-5">类型别名 (Type Aliases)</h3>
<p>类型别名为类型创建一个新的名称。它可以用于原始值、联合类型、元组以及其它任何你需要手写的类型。</p>
<pre><code class="hljs language-ini" lang="ini">type <span class="hljs-attr">Name</span> = string<span class="hljs-comment">;</span>
type <span class="hljs-attr">NameResolver</span> = () =&gt; string<span class="hljs-comment">;</span>
type <span class="hljs-attr">NameOrResolver</span> = Name | NameResolver<span class="hljs-comment">;</span>

function getName(n: NameOrResolver): Name {
    if (typeof <span class="hljs-attr">n</span> === <span class="hljs-string">'string'</span>) {
        return n<span class="hljs-comment">;</span>
    } else {
        return n()<span class="hljs-comment">;</span>
    }
}

// 也可以像接口一样描述对象形状
type <span class="hljs-attr">Point</span> = {
    x: number<span class="hljs-comment">;</span>
    y: number<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 类型别名可以使用交集和联合
type <span class="hljs-attr">PartialPoint</span> = { x: number<span class="hljs-comment">; } | { y: number; };</span>
</code></pre>
<p><strong>接口 vs 类型别名</strong>:</p>
<ul>
<li>接口可以“打开”并扩展（Declaration Merging）。</li>
<li>类型别名不能被重新打开以添加新的属性。</li>
<li>接口通常用于定义对象的结构，而类型别名更通用。</li>
</ul>
<hr/>
<h3 data-id="heading-6">联合类型 (Union Types) &amp; 交叉类型 (Intersection Types)</h3>
<ul>
<li>
<p><strong>联合类型</strong>: 表示一个值可以是几种类型之一。使用 <code>|</code> 分隔每个类型。</p>
<pre><code class="hljs language-ini" lang="ini">let value: string | number<span class="hljs-comment">;</span>
<span class="hljs-attr">value</span> = <span class="hljs-string">"hello"</span><span class="hljs-comment">; // OK</span>
<span class="hljs-attr">value</span> = <span class="hljs-number">42</span><span class="hljs-comment">;      // OK</span>
// <span class="hljs-attr">value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">; // Error</span>
</code></pre>
</li>
<li>
<p><strong>交叉类型</strong>: 将多个类型合并为一个类型。使用 <code>&amp;</code> 连接。</p>
<pre><code class="hljs language-ini" lang="ini">interface Colorful {
    color: string<span class="hljs-comment">;</span>
}
interface Circle {
    radius: number<span class="hljs-comment">;</span>
}

type <span class="hljs-attr">ColorfulCircle</span> = Colorful &amp; Circle<span class="hljs-comment">;</span>

const cc: <span class="hljs-attr">ColorfulCircle</span> = {
    color: "red",
    radius: 10
}<span class="hljs-comment">; // 必须同时满足 Colorful 和 Circle 的要求</span>
</code></pre>
</li>
</ul>
<hr/>
<h3 data-id="heading-7">数组与元组 (Tuples)</h3>
<ul>
<li>
<p><strong>数组</strong>: 存储相同类型的元素。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">list1</span>: <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">let</span> <span class="hljs-attr">list2</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]; <span class="hljs-comment">// 泛型语法</span>
</code></pre>
</li>
<li>
<p><strong>元组</strong>: 允许表示一个已知元素数量和类型的数组，各元素的类型不必相同。</p>
<pre><code class="hljs language-python" lang="python">let <span class="hljs-built_in">tuple</span>: [string, number] = [<span class="hljs-string">'hello'</span>, <span class="hljs-number">10</span>];
// <span class="hljs-built_in">tuple</span>[<span class="hljs-number">0</span>] = <span class="hljs-number">10</span>; // Error: <span class="hljs-type">Type</span> <span class="hljs-string">'number'</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> assignable to <span class="hljs-built_in">type</span> <span class="hljs-string">'string'</span>.
</code></pre>
</li>
</ul>
<hr/>
<h3 data-id="heading-8">函数类型</h3>
<ul>
<li>
<p><strong>函数声明/表达式中的类型注解</strong>:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">greet</span>(<span class="hljs-params">name: <span class="hljs-keyword">string</span></span>): <span class="hljs-title">string</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, "</span> + name;
}

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">greeter</span> = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name: <span class="hljs-keyword">string</span></span>): <span class="hljs-title">string</span> </span>{
     <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, "</span> + name;
};

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">arrowGreeter</span> = (name: <span class="hljs-keyword">string</span>): <span class="hljs-keyword">string</span> =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, "</span> + name;
};
</code></pre>
</li>
<li>
<p><strong>可选参数和默认参数</strong>:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildName</span>(<span class="hljs-params">firstName: <span class="hljs-keyword">string</span>, lastName?: <span class="hljs-keyword">string</span></span>) </span>{ ... } <span class="hljs-comment">// lastName 是可选的</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildNameWithDefault</span>(<span class="hljs-params">firstName: <span class="hljs-keyword">string</span>, lastName = <span class="hljs-string">"Smith"</span></span>) </span>{ ... } <span class="hljs-comment">// 默认参数</span>
</code></pre>
</li>
<li>
<p><strong>剩余参数</strong>:</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">function <span class="hljs-title">buildNameRest</span>(<span class="hljs-params">firstName: <span class="hljs-built_in">string</span>, ...restOfName: <span class="hljs-built_in">string</span>[]</span>)</span> {
    <span class="hljs-keyword">return</span> firstName + <span class="hljs-string">" "</span> + restOfName.<span class="hljs-keyword">join</span>(<span class="hljs-string">" "</span>);
}
</code></pre>
</li>
</ul>
<hr/>
<h3 data-id="heading-9">类 (Classes)</h3>
<p>TypeScript 支持面向对象编程的类。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 私有属性</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-attr">species</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 受保护的属性</span>
    <span class="hljs-keyword">readonly</span> <span class="hljs-attr">legs</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">4</span>; <span class="hljs-comment">// 只读属性</span>

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">theName: <span class="hljs-built_in">string</span>, theAge: <span class="hljs-built_in">number</span>, theSpecies: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = theName;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = theAge;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">species</span> = theSpecies;
    }

    <span class="hljs-title function_">move</span>(<span class="hljs-params">distanceInMeters: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span></span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> moved <span class="hljs-subst">${distanceInMeters}</span>m.`</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
    <span class="hljs-attr">breed</span>: <span class="hljs-built_in">string</span>;

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age: <span class="hljs-built_in">number</span>, species: <span class="hljs-built_in">string</span>, breed: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-variable language_">super</span>(name, age, species); <span class="hljs-comment">// 调用父类构造函数</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">breed</span> = breed;
    }

    <span class="hljs-title function_">bark</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Woof! Woof!'</span>);
    }

    <span class="hljs-title function_">move</span>(<span class="hljs-params">distanceInMeters = <span class="hljs-number">5</span></span>) { <span class="hljs-comment">// 重写父类方法</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Running..."</span>);
        <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">move</span>(distanceInMeters);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-10">泛型 (Generics)</h3>
<p>泛型允许你编写可复用的组件，这些组件可以工作在多种类型之上。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 泛型函数</span>
<span class="hljs-keyword">function</span> identity&lt;T&gt;(<span class="hljs-attr">arg</span>: T): T {
    <span class="hljs-keyword">return</span> arg;
}
<span class="hljs-keyword">let</span> output1 = identity&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">"myString"</span>); <span class="hljs-comment">// type argument specified</span>
<span class="hljs-keyword">let</span> output2 = <span class="hljs-title function_">identity</span>(<span class="hljs-string">"myString"</span>); <span class="hljs-comment">// type argument inferred</span>

<span class="hljs-comment">// 泛型接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">GenericIdentityFn</span>&lt;T&gt; {
    (<span class="hljs-attr">arg</span>: T): T;
}
<span class="hljs-keyword">let</span> <span class="hljs-attr">myIdentity</span>: <span class="hljs-title class_">GenericIdentityFn</span>&lt;<span class="hljs-built_in">number</span>&gt; = identity;

<span class="hljs-comment">// 泛型类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericNumber</span>&lt;T&gt; {
    <span class="hljs-attr">zeroValue</span>: T;
    <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params">x: T, y: T</span>) =&gt;</span> T;
}

<span class="hljs-keyword">let</span> myGenericNumber = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericNumber</span>&lt;<span class="hljs-built_in">number</span>&gt;();
myGenericNumber.<span class="hljs-property">zeroValue</span> = <span class="hljs-number">0</span>;
myGenericNumber.<span class="hljs-property">add</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">x, y</span>) { <span class="hljs-keyword">return</span> x + y; };

<span class="hljs-comment">// 泛型约束</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Lengthwise</span> {
    <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">function</span> loggingIdentity&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Lengthwise</span>&gt;(<span class="hljs-attr">arg</span>: T): T {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arg.<span class="hljs-property">length</span>); <span class="hljs-comment">// Now we know it has a .length property, so no more error</span>
    <span class="hljs-keyword">return</span> arg;
}
<span class="hljs-comment">// loggingIdentity(3); // Error, number doesn't have a .length property</span>
<span class="hljs-title function_">loggingIdentity</span>({<span class="hljs-attr">length</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">3</span>}); <span class="hljs-comment">// OK</span>
</code></pre>
<hr/>
<h3 data-id="heading-11">模块 (Modules) 和 导入/导出</h3>
<p>将代码组织到不同的文件中，并控制它们之间的可见性。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// math.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> pi = <span class="hljs-number">3.14</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">return</span> x + y;
}
<span class="hljs-comment">// 或者统一导出</span>
<span class="hljs-comment">// const pi = 3.14;</span>
<span class="hljs-comment">// function add(x: number, y: number) { return x + y; }</span>
<span class="hljs-comment">// export { pi, add };</span>

<span class="hljs-comment">// main.ts</span>
<span class="hljs-keyword">import</span> { pi, add } <span class="hljs-keyword">from</span> <span class="hljs-string">'./math'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(pi); <span class="hljs-comment">// 3.14</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)); <span class="hljs-comment">// 3</span>

<span class="hljs-comment">// 导入重命名</span>
<span class="hljs-keyword">import</span> { add <span class="hljs-keyword">as</span> sum } <span class="hljs-keyword">from</span> <span class="hljs-string">'./math'</span>;

<span class="hljs-comment">// 导入整个模块</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> math <span class="hljs-keyword">from</span> <span class="hljs-string">'./math'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(math.<span class="hljs-property">pi</span>);

<span class="hljs-comment">// 默认导出</span>
<span class="hljs-comment">// export default class Calculator { ... }</span>
<span class="hljs-comment">// import Calculator from './Calculator'; // 注意没有花括号 {}</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">装饰器 (Decorators)</h3>
<p>一种特殊类型的声明，可以被附加到类声明，方法，访问符，属性或参数上。装饰器使用 <code>@expression</code> 这种形式，<code>expression</code> 求值后必须为一个函数，该函数会在运行时被调用。</p>
<p>需要启用实验性支持 (<code>"experimentalDecorators": true</code> in <code>tsconfig.json</code>)。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 类装饰器示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sealed</span>(<span class="hljs-params">constructor: <span class="hljs-built_in">Function</span></span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">seal</span>(constructor);
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">seal</span>(constructor.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
}

<span class="hljs-meta">@sealed</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Greeter</span> {
    <span class="hljs-attr">greeting</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">message: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">greeting</span> = message;
    }
    <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, "</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">greeting</span>;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-13">实用工具类型 (Utility Types)</h3>
<p>TypeScript 内置了一些非常有用的工具类型来简化常见的类型转换。</p>
<ul>
<li><code>Partial&lt;T&gt;</code>: 构造类型 <code>T</code>，并将它所有的属性设置为可选的。</li>
<li><code>Readonly&lt;T&gt;</code>: 构造类型 <code>T</code>，并将它所有的属性设置为只读的。</li>
<li><code>Record&lt;K, T&gt;</code>: 构造一个类型，其属性名的类型是 <code>K</code>，属性值的类型是 <code>T</code>。</li>
<li><code>Pick&lt;T, K&gt;</code>: 从类型 <code>T</code> 中选择出属性 <code>K</code>，构造成一个新的类型。</li>
<li><code>Omit&lt;T, K&gt;</code>: 从类型 <code>T</code> 中排除掉属性 <code>K</code>，构造成一个新的类型。</li>
<li><code>Exclude&lt;T, U&gt;</code>: 从 <code>T</code> 中排除掉那些可以赋值给 <code>U</code> 的类型。</li>
<li><code>Extract&lt;T, U&gt;</code>: 从 <code>T</code> 中提取那些可以赋值给 <code>U</code> 的类型。</li>
<li><code>NonNullable&lt;T&gt;</code>: 从 <code>T</code> 中排除 <code>null</code> 和 <code>undefined</code>。</li>
<li><code>Parameters&lt;T&gt;</code>: 获取函数类型的参数类型组成的元组类型。</li>
<li><code>ReturnType&lt;T&gt;</code>: 获取函数类型的返回值类型。</li>
<li><code>InstanceType&lt;T&gt;</code>: 获取构造函数类型的实例类型。</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">interface Todo {
  title: string<span class="hljs-comment">;</span>
  description: string<span class="hljs-comment">;</span>
  completed: boolean<span class="hljs-comment">;</span>
}

type <span class="hljs-attr">TodoPreview</span> = Pick&lt;Todo, <span class="hljs-string">'title'</span> | <span class="hljs-string">'completed'</span>&gt;<span class="hljs-comment">; // { title: string; completed: boolean; }</span>

type <span class="hljs-attr">TodoInfo</span> = Omit&lt;Todo, <span class="hljs-string">'description'</span>&gt;<span class="hljs-comment">; // { title: string; completed: boolean; }</span>

type <span class="hljs-attr">Status</span> = <span class="hljs-string">'pending'</span> | <span class="hljs-string">'fulfilled'</span> | <span class="hljs-string">'rejected'</span><span class="hljs-comment">;</span>
type <span class="hljs-attr">SyncStatus</span> = Exclude&lt;Status, <span class="hljs-string">'pending'</span>&gt;<span class="hljs-comment">; // 'fulfilled' | 'rejected'</span>

function f1(s: string) { return { a: 1, b: s }<span class="hljs-comment">; }</span>
type <span class="hljs-attr">F1Params</span> = Parameters&lt;typeof f1&gt;<span class="hljs-comment">; // [s: string]</span>
type <span class="hljs-attr">F1ReturnType</span> = ReturnType&lt;typeof f1&gt;<span class="hljs-comment">; // { a: number; b: string; }</span>
</code></pre>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端日常工作开发技巧汇总]]></title>    <link>https://juejin.cn/post/7576863819981504521</link>    <guid>https://juejin.cn/post/7576863819981504521</guid>    <pubDate>2025-11-26T10:41:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576863819981504521" data-draft-id="7574621387574050862" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端日常工作开发技巧汇总"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-26T10:41:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="__花花世界"/> <meta itemprop="url" content="https://juejin.cn/user/1724480211391783"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端日常工作开发技巧汇总
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1724480211391783/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    __花花世界
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T10:41:21.000Z" title="Wed Nov 26 2025 10:41:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、JS篇</h2>
<h4 data-id="heading-1">1. structuredClone 深拷贝</h4>
<p><strong>JavaScript</strong> 内置了一个 <code>structuredClone()</code> 的方法， 此方法提供了一种简单有效的方法来深度克隆对象，<strong>支持复杂数据类型</strong>，包括 <code>Date</code>、<code>RegExp</code>、<code>Map</code>、<code>Set</code>、<code>ArrayBuffer</code>、<code>Blob</code>、<code>File</code> 等。浏览器底层实现，通常比手动递归或 JSON 方法更高效。</p>
<p><strong>兼容性</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f56dcee5695b4ea081d4baee7741274b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX1_oirHoirHkuJbnlYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764758481&amp;x-signature=t1FHAqcqBJ1xz6FK0H9ziIf%2Fsek%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-2">2. 函数式编程</h4>
<p><strong>ES14</strong> 更新了许多数组方法或者为原有的数组方法增加<strong>不会带来突变(without mutation)</strong> 的互补方法。<code>意味着它们会基于原数组创建新的数组，而不是直接修改原数组。</code></p>
<p>新增的互补方法有</p>
<ul>
<li><code>Array.sort() -&gt; Array.toSorted()</code></li>
<li><code>Array.splice() -&gt; Array.toSpliced()</code></li>
<li><code>Array.reverse() -&gt; Array.toReversed()</code></li>
</ul>
<p>新增的新数组方法有：<code>Array.with()</code>、<code>Array.findLast()</code>、<code>Array.findLastIndex()</code></p>
<ul>
<li><code>Array.with()</code><br/>返回一个<strong>新数组</strong>，将原数组中指定索引 <code>index</code> 的元素替换为 <code>value</code>，<strong>不修改原数组</strong></li>
</ul>
<p><strong>语法</strong>  <br/><code>index</code>：要替换的元素的索引（可以是负数，表示从末尾开始计数）。<br/>
<code>value</code>：替换后的新值</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> newArray = array.<span class="hljs-title function_">with</span>(index, value)

<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>];
<span class="hljs-keyword">const</span> newArr = arr.<span class="hljs-title function_">with</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"hello"</span>); <span class="hljs-comment">// 替换索引 1 的元素 </span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr);    <span class="hljs-comment">// [1, 2, 3, 4]（原数组不变）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newArr); <span class="hljs-comment">// [1, "hello", 3, 4]（新数组）</span>

<span class="hljs-comment">// 支持负数索引（从末尾开始）</span>
<span class="hljs-keyword">const</span> newArr2 = arr.<span class="hljs-title function_">with</span>(-<span class="hljs-number">2</span>, <span class="hljs-string">"world"</span>); <span class="hljs-comment">// 替换倒数第 2 个元素</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newArr2); <span class="hljs-comment">// [1, 2, "world", 4]</span>
</code></pre>
<ul>
<li>
<p><code>Array.findLast()</code><br/>从数组<strong>末尾向前</strong>查找第一个满足 <code>callback</code> 条件的元素，并返回该元素。如果未找到，返回 <code>undefined</code></p>
</li>
<li>
<p><code>Array.findLastIndex()</code> <br/>从数组<strong>末尾向前</strong>查找第一个满足 <code>callback</code> 条件的元素，并返回其<strong>索引</strong>。如果未找到，返回 <code>-1</code></p>
</li>
</ul>
<h4 data-id="heading-3">3. 惰性函数</h4>
<p>JavaScript 中的 <strong>惰性函数（Lazy Function）</strong> 是一种优化技术，其核心思想是：<strong>函数在第一次调用时执行一些初始化或判断逻辑，并在执行后将自身重定义为一个更高效或更简单的版本，后续调用就直接使用这个新版本，避免重复开销</strong>。</p>
<p><strong>普通写法</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">copyToClipboard</span>(<span class="hljs-params">text</span>) {
    <span class="hljs-comment">// 优先使用Clipboard API</span>
    <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">clipboard</span>) {
      <span class="hljs-keyword">return</span> navigator.<span class="hljs-property">clipboard</span>
        .<span class="hljs-title function_">writeText</span>(text)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-title class_">Message</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">'复制成功'</span>)
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        })
        .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'使用Clipboard API复制失败: '</span>, err)
          <span class="hljs-comment">// 如果Clipboard API失败，尝试使用降级方案</span>
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">copyUsingExecCommand</span>(text)
        })
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 如果不支持Clipboard API，直接使用降级方案</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">copyUsingExecCommand</span>(text)
    }
}
</code></pre>
<p><strong>惰性写法</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">copyToClipboard</span>(<span class="hljs-params">text</span>) {
  <span class="hljs-comment">// 第一次调用时进行能力检测，并重定义自身</span>
  <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">clipboard</span>) {
    <span class="hljs-comment">// 支持 Clipboard API</span>
    copyToClipboard = <span class="hljs-keyword">function</span> (<span class="hljs-params">text</span>) {
      <span class="hljs-keyword">return</span> navigator.<span class="hljs-property">clipboard</span>
        .<span class="hljs-title function_">writeText</span>(text)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文本已成功复制到剪贴板'</span>);
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        })
        .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Clipboard API 复制失败:'</span>, err);
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        });
    };
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 不支持 Clipboard API，使用 execCommand 降级方案</span>
    copyToClipboard = <span class="hljs-keyword">function</span> (<span class="hljs-params">text</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">copyUsingExecCommand</span>(text);
    };
  }

  <span class="hljs-comment">// 执行第一次调用</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">copyToClipboard</span>(text);
}
</code></pre>
<h2 data-id="heading-4">二、CSS篇</h2>
<h4 data-id="heading-5">1. 滚动吸附</h4>
<pre><code class="hljs language-javascript" lang="javascript">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Snap"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">overflow-x</span>: scroll;
  // 吸附效果 mandatory: 必须吸附  proximity: 靠近时吸附
  scroll-snap-type: x mandatory;
  <span class="hljs-selector-class">.item</span> {
    <span class="hljs-attribute">flex-shrink</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">justify-content</span>: center;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">30px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ccc</span>;
    // 吸附位置
    <span class="hljs-attribute">scroll-snap-align</span>: start;
    <span class="hljs-attribute">scroll-snap-stop</span>: always;
    &amp;<span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f56c6c</span>;
    }
    &amp;<span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>) {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#67c23a</span>;
    }
    &amp;<span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">3</span>) {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#409eff</span>;
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h5 data-id="heading-6">兼容性较高</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4327c9d267b84ae8bcf5aa54f36681c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX1_oirHoirHkuJbnlYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764758481&amp;x-signature=np5sbIn%2B2aSmOTYIg3slPaJF2aU%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">2. 字体自适应容器大小</h4>
<pre><code class="hljs language-javascript" lang="javascript">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>字体自适应容器大小<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">name</span>=<span class="hljs-string">""</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
  <span class="hljs-attribute">resize</span>: both;
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">background-color</span>: aquamarine;
  container-type: inline-size; // 启用容器查询 size:基于宽高 / inline-size 基于宽度 / normal 不启用
  p {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">5</span>cqh;
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h5 data-id="heading-8">兼容性还行</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e230868923f34c4dbca1b082b089f37d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX1_oirHoirHkuJbnlYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764758481&amp;x-signature=r4u88S18aAeewAVFsBFoTVZO4Lg%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">3. 选择器</h4>
<ul>
<li><strong>选择器特定性</strong>（通常叫做选择器权重）</li>
</ul>
<p>当希望某个css属性优先级高于其他属性值时，尽量不要使用<code>!important</code>，<code>!important</code>会打破这些固有的级联规则，使得样式的应用变得不那么可预测。这可能会导致样式表难以维护和理解，尤其是在大型项目中。增加调试难度，也限制了样式的灵活性。</p>
<p><strong>替代方案：</strong>
通过编写更具体（或更精确）的选择器来覆盖样式，或者叠加选择器，比如：222</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.el-button</span><span class="hljs-selector-class">.el-button</span> {
    <span class="hljs-attribute">color</span>: red;
}
</code></pre>
<ul>
<li><strong>新型选择器</strong></li>
</ul>
<p><strong><code>:has()</code>选择器：</strong> 根据一个元素是否包含某些特定的后代元素，或者其后的同级元素是否满足某些条件，来选中该元素本身。这实现了“向下”观察的能力。</p>
<p><strong>示例1：</strong> 选择包含 <code>&lt;img&gt;</code> 的 <code>&lt;div&gt;</code></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>这个 div 没有图片，不会被选中<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"example.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"示例图片"</span>&gt;</span>
    这个 div 包含图片，会被红色边框包围
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 选择包含 &lt;img&gt; 的 div */</span> 
<span class="hljs-selector-tag">div</span><span class="hljs-selector-pseudo">:has</span>(<span class="hljs-selector-tag">img</span>) {
    <span class="hljs-attribute">border</span>: <span class="hljs-number">3px</span> solid red; <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
}
</code></pre>
<p><strong>示例2：</strong> 选择紧跟着 <code>&lt;p&gt;</code> 的 <code>&lt;h2&gt;</code></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>这个 h2 后面没有紧跟着 p，不会被选中<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>分隔内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>这个 h2 后面紧跟着 p<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这个 p 是 h2 的紧邻兄弟元素，因此 h2 会变成蓝色斜体<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 选择后面紧跟着 &lt;p&gt; 的 h2 */</span>
<span class="hljs-selector-tag">h2</span><span class="hljs-selector-pseudo">:has</span>(+ <span class="hljs-selector-tag">p</span>) {
    <span class="hljs-attribute">color</span>: blue; <span class="hljs-attribute">font-style</span>: italic;
}
</code></pre>
<p><strong>兼容性</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efa8564f41134e47ae0fcfdef826952b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX1_oirHoirHkuJbnlYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764758481&amp;x-signature=sDA5b43VZ5wPnfwjzbdece7iJlU%3D" alt="image.png" loading="lazy"/></p>
<p><strong><code>:is()</code>选择器：</strong> 它接受一个逗号分隔的选择器列表作为参数，并匹配其中任意一个选择器。这有助于减少冗余代码，提高可读性。<code>:is()</code> 的权重等于它括号里所有选择器中权重最高的那个。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>这是 header 的 h1（紫色）<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>这是 main 的 h1（紫色）<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>这是 footer 的 h1（紫色）<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>这个 h1 不在 :is() 范围内，保持默认颜色<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 统一设置 header、main、footer 下的 h1 样式 */</span>
<span class="hljs-selector-pseudo">:is</span>(<span class="hljs-selector-tag">header</span>, <span class="hljs-selector-tag">main</span>, <span class="hljs-selector-tag">footer</span>) <span class="hljs-selector-tag">h1</span> {
    <span class="hljs-attribute">color</span>: purple; <span class="hljs-attribute">font-family</span>: Arial, sans-serif;
}
</code></pre>
<p><strong>兼容性</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/892277d505d948f6b61481cc02b3d4ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX1_oirHoirHkuJbnlYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764758481&amp;x-signature=3YQLihRTHYObL6AU3nb0rNQYAdw%3D" alt="image.png" loading="lazy"/></p>
<p><strong><code>:where()</code>选择器：</strong> 与 <code>:is()</code> 类似，但权重永远为 0，适合默认样式。</p>
<p><strong>兼容性</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5818dff5442848959d448ea4fa93f8aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX1_oirHoirHkuJbnlYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764758481&amp;x-signature=MYqlBPUofbEppMEMhfD911X6ga0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-10">三、VUE篇</h2>
<h4 data-id="heading-11">1. v-memo</h4>
<p>Vue 3 提供的性能优化指令，其作用是通过缓存模板子树的渲染结果，仅在依赖项变化时重新渲染，从而减少不必要的虚拟 DOM 计算和更新操作。</p>
<p><code>v-memo</code> 接收一个依赖数组，只有当数组中的值发生变化时才会重新渲染。</p>
<p><strong>示例</strong>：优化大型列表渲染，避免全量更新。
当 <code>item.id</code> 或 <code>item.status</code> 变化时，仅更新对应项；其他项复用缓存结果</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in list"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span> <span class="hljs-attr">v-memo</span>=<span class="hljs-string">"[item.id, item.status]"</span>&gt;</span>
  {{ item.content }}
  <span class="hljs-tag">&lt;<span class="hljs-name">StatusBadge</span> <span class="hljs-attr">:status</span>=<span class="hljs-string">"item.status"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-12">2. watch —— 副作用和深度监听</h4>
<h4 data-id="heading-13">3. customRef ——— 自定义响应式依赖追踪</h4>
<h4 data-id="heading-14">4. 组件的二次封装</h4>
<h2 data-id="heading-15">四、Chrome浏览器调试技巧</h2>
<h4 data-id="heading-16">1. <code>$0</code></h4>
<h4 data-id="heading-17">2. 模拟聚焦网页</h4>
<h4 data-id="heading-18">3. 重放XHR</h4>
<h2 data-id="heading-19">五、VSCode编辑器插件分享</h2>
<h4 data-id="heading-20">1. i18n Ally</h4>
<ul>
<li>代码内直接预览翻译文本</li>
<li>快速生成初始翻译</li>
<li>一键跳转至对应翻译条目</li>
<li>集中管理</li>
</ul>

<pre><code class="hljs language-json" lang="json">  <span class="hljs-attr">"i18n-ally.localesPaths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/i18n/lang/locales"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 翻译文件夹路径</span>
  <span class="hljs-attr">"i18n-ally.pathMatcher"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{locale}/**/{namespace}.json"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 翻译目标文件路径匹配</span>
  <span class="hljs-attr">"i18n-ally.keystyle"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nested"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 翻译路径格式,</span>
  <span class="hljs-attr">"i18n-ally.sourceLanguage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zh-CN"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 翻译源语言</span>
  <span class="hljs-attr">"i18n-ally.displayLanguage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zh-CN"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//显示语言， 这里也可以设置显示英文为en</span>
  <span class="hljs-attr">"i18n-ally.sortKeys"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 是否自动排序</span>
  <span class="hljs-attr">"i18n-ally.namespace"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 是否启用命名空间，一般在积攒多个待翻译文案时启用，可以自动编辑至对应文件中</span>
  <span class="hljs-attr">"i18n-ally.enabledParsers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"ts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"js"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"json"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 翻译文件可允许的格式，默认json</span>
</code></pre>
<h4 data-id="heading-21">2. koroFileHeader @4.9.2</h4>
<p>用于生成文件头部注释和函数注释的插件</p>
<p><strong>快捷键</strong>‌：</p>
<ul>
<li>头部注释：<code>Ctrl+Win+I</code>（Windows/Linux）或 <code>Ctrl+Cmd+I</code>（Mac）</li>
<li>函数注释：<code>Ctrl+Win+T</code>（Windows/Linux）或 <code>Ctrl+Cmd+T</code>（Mac）</li>
</ul>

<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 头部注释</span>
<span class="hljs-attr">"fileheader.customMade"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-attr">"Author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git config user.name &amp;&amp; git config user.email"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 同时获取用户名与邮箱</span>
<span class="hljs-attr">"Date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Do not edit"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 文件创建时间</span>
<span class="hljs-attr">"LastEditors"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git config user.name &amp;&amp; git config user.email"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 文件最后编辑者 与Author字段一致</span>
<span class="hljs-attr">"LastEditTime"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Do not edit"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 文件最后编辑时间</span>
<span class="hljs-attr">"FilePath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Do not edit"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 文件在项目中的相对路径 自动更新</span>
<span class="hljs-attr">"Description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span> <span class="hljs-comment">// 文件描述</span>
<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[栈（Stack）详解：从原理到实现，再到括号匹配应用]]></title>    <link>https://juejin.cn/post/7576859594359439360</link>    <guid>https://juejin.cn/post/7576859594359439360</guid>    <pubDate>2025-11-26T10:45:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576859594359439360" data-draft-id="7576681897298231311" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="栈（Stack）详解：从原理到实现，再到括号匹配应用"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-26T10:45:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="www_stdio"/> <meta itemprop="url" content="https://juejin.cn/user/631558156323657"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            栈（Stack）详解：从原理到实现，再到括号匹配应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/631558156323657/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    www_stdio
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T10:45:29.000Z" title="Wed Nov 26 2025 10:45:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">栈（Stack）详解：从原理到实现，再到括号匹配应用</h2>
<p>栈是一种基础而重要的线性数据结构，在计算机科学中被广泛应用于函数调用、表达式求值、回溯算法等场景。本文将围绕栈的定义、抽象数据类型（ADT）、ES6 实现方式（数组与链表）、性能对比，以及一个经典应用场景——<strong>括号匹配问题</strong>，进行系统讲解。</p>
<hr/>
<h3 data-id="heading-1">一、什么是栈？</h3>
<p>栈（Stack）是一种遵循 <strong>先进后出（First In Last Out, FILO）</strong> 原则的线性数据结构。你可以把它想象成一摞盘子：你只能从顶部放入（入栈）或取出（出栈）盘子，不能从中间或底部操作。</p>
<h4 data-id="heading-2">栈的核心操作包括：</h4>
<ul>
<li><strong>push(x)</strong> ：将元素 x 压入栈顶。</li>
<li><strong>pop()</strong> ：弹出并返回栈顶元素。</li>
<li><strong>peek() / top()</strong> ：查看栈顶元素但不移除。</li>
<li><strong>isEmpty()</strong> ：判断栈是否为空。</li>
<li><strong>size()</strong> ：获取栈中元素个数。</li>
</ul>
<hr/>
<h3 data-id="heading-3">二、栈的抽象数据类型（ADT）</h3>
<p>抽象数据类型（Abstract Data Type, ADT）是对数据结构行为的规范描述，不涉及具体实现。栈的 ADT 应包含以下属性和方法：</p>

































<table><thead><tr><th>属性/方法</th><th>描述</th></tr></thead><tbody><tr><td><code>size</code></td><td>只读属性，返回当前栈的大小</td></tr><tr><td><code>isEmpty()</code></td><td>判断栈是否为空</td></tr><tr><td><code>push(val)</code></td><td>入栈操作</td></tr><tr><td><code>pop()</code></td><td>出栈操作，若栈空则抛出异常</td></tr><tr><td><code>peek()</code></td><td>返回栈顶元素，若栈空则抛出异常</td></tr><tr><td><code>toArray()</code></td><td>（可选）将栈内容转换为数组，便于调试或输出</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-4">三、ES6 Class 实现栈</h3>
<p>ES6 引入了 <code>class</code> 语法，使面向对象编程更加清晰。结合私有字段（<code>#</code>）、<code>get</code> 访问器等特性，可以优雅地封装栈的实现细节。</p>
<h4 data-id="heading-5">1. 基于链表实现栈（LinkedListStack）</h4>
<p>链表天然适合动态增长，每个节点包含值和指向下一个节点的指针。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ListNode</span> {
    <span class="hljs-keyword">constructor</span>(<span class="hljs-keyword">val</span>) {
        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">val</span> = <span class="hljs-keyword">val</span>;
        <span class="hljs-keyword">this</span>.next = <span class="hljs-literal">null</span>;
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedListStack</span> {
    #stackPeek = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 私有栈顶指针</span>
    #size = <span class="hljs-number">0</span>;

    push(num) {
        <span class="hljs-keyword">const</span> node = new ListNode(num);
        node.next = <span class="hljs-keyword">this</span>.#stackPeek;
        <span class="hljs-keyword">this</span>.#stackPeek = node;
        <span class="hljs-keyword">this</span>.#size++;
    }

    pop() {
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.#stackPeek) <span class="hljs-keyword">throw</span> new Error(<span class="hljs-string">'栈为空'</span>);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> = <span class="hljs-keyword">this</span>.#stackPeek.<span class="hljs-keyword">val</span>;
        <span class="hljs-keyword">this</span>.#stackPeek = <span class="hljs-keyword">this</span>.#stackPeek.next;
        <span class="hljs-keyword">this</span>.#size--;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">val</span>;
    }

    peek() {
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.#stackPeek) <span class="hljs-keyword">throw</span> new Error(<span class="hljs-string">'栈为空'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#stackPeek.<span class="hljs-keyword">val</span>;
    }

    <span class="hljs-keyword">get</span> size() { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#size; }
    isEmpty() { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#size === <span class="hljs-number">0</span>; }

    toArray() {
        let node = <span class="hljs-keyword">this</span>.#stackPeek;
        <span class="hljs-keyword">const</span> res = new Array(<span class="hljs-keyword">this</span>.#size);
        <span class="hljs-keyword">for</span> (let i = res.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
            res[i] = node.<span class="hljs-keyword">val</span>;
            node = node.next;
        }
        <span class="hljs-keyword">return</span> res;
    }
}
</code></pre>
<blockquote>
<p>✅ <strong>优点</strong>：动态扩容，无空间浪费；插入/删除均为 O(1)<br/>
❌ <strong>缺点</strong>：每个节点需额外存储指针，内存开销略大</p>
</blockquote>
<hr/>
<h4 data-id="heading-6">2. 基于数组实现栈（ArrayStack）</h4>
<p>利用 JavaScript 数组的 <code>push</code> 和 <code>pop</code> 方法，可快速实现栈。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayStack</span> {
    #stack = [];

    <span class="hljs-keyword">get</span> size() { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#stack.length; }
    isEmpty() { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.size === <span class="hljs-number">0</span>; }

    push(num) {
        <span class="hljs-keyword">this</span>.#stack.push(num);
    }

    pop() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isEmpty()) <span class="hljs-keyword">throw</span> new Error(<span class="hljs-string">"栈为空"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#stack.pop();
    }

    peek() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isEmpty()) <span class="hljs-keyword">throw</span> new Error(<span class="hljs-string">"栈为空"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#stack[<span class="hljs-keyword">this</span>.size - <span class="hljs-number">1</span>];
    }

    toArray() {
        <span class="hljs-keyword">return</span> [...<span class="hljs-keyword">this</span>.#stack]; <span class="hljs-comment">// 返回副本更安全</span>
    }
}
</code></pre>
<blockquote>
<p>✅ <strong>优点</strong>：缓存友好，访问快；代码简洁<br/>
❌ <strong>缺点</strong>：扩容时需复制整个数组（O(n)），但均摊时间复杂度仍为 O(1)</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">四、数组 vs 链表实现栈：性能对比</h3>






























<table><thead><tr><th>维度</th><th>数组实现</th><th>链表实现</th></tr></thead><tbody><tr><td><strong>时间效率</strong></td><td>平均 O(1)，扩容时 O(n)</td><td>稳定 O(1)</td></tr><tr><td><strong>空间效率</strong></td><td>可能有预分配空间浪费</td><td>每个节点多一个指针开销</td></tr><tr><td><strong>内存布局</strong></td><td>连续内存，缓存命中率高</td><td>离散内存，缓存局部性差</td></tr><tr><td><strong>适用场景</strong></td><td>数据量可预估、追求速度</td><td>动态性强、内存敏感</td></tr></tbody></table>
<blockquote>
<p>💡 在大多数实际应用中，<strong>数组实现的栈更常用</strong>，因为其简单高效，且现代 JavaScript 引擎对数组优化极佳。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">五、实战应用：括号匹配问题</h3>
<p>栈的经典应用场景之一是<strong>验证括号字符串是否合法</strong>。例如：<code>"([{}])"</code> 合法，而 <code>"([)]"</code> 不合法。</p>
<h4 data-id="heading-9">解题思路：</h4>
<ol>
<li>遇到左括号 <code>(</code>、<code>[</code>、<code>{</code>，将其对应的右括号压入栈；</li>
<li>遇到右括号，检查是否与栈顶元素匹配；</li>
<li>若不匹配或栈为空，则非法；</li>
<li>遍历结束后，栈必须为空才合法。</li>
</ol>
<h4 data-id="heading-10">代码实现：</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> leftToRight = {
    <span class="hljs-string">"("</span>: <span class="hljs-string">")"</span>,
    <span class="hljs-string">"["</span>: <span class="hljs-string">"]"</span>,
    <span class="hljs-string">"{"</span>: <span class="hljs-string">"}"</span>
};

<span class="hljs-function">function <span class="hljs-title">isValid</span><span class="hljs-params">(s)</span> </span>{
    <span class="hljs-keyword">if</span> (!s) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-type">const</span> stack = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> ch of s) {
        <span class="hljs-keyword">if</span> (ch in leftToRight) {
            stack.<span class="hljs-built_in">push</span>(leftToRight[ch]); <span class="hljs-comment">// 压入期望的右括号</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (!stack.length || stack.<span class="hljs-built_in">pop</span>() !== ch) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 不匹配或栈空</span>
            }
        }
    }
    <span class="hljs-keyword">return</span> stack.length === <span class="hljs-number">0</span>; <span class="hljs-comment">// 必须完全匹配</span>
}
</code></pre>
<blockquote>
<p>✅ 时间复杂度：O(n)<br/>
✅ 空间复杂度：O(n)（最坏情况全为左括号）</p>
</blockquote>
<hr/>
<h3 data-id="heading-11">六、总结</h3>
<ul>
<li>栈是一种 <strong>FILO</strong> 的线性结构，核心操作为 <code>push</code>、<code>pop</code>、<code>peek</code>。</li>
<li>ES6 的 <code>class</code>、私有字段 <code>#</code> 和 <code>get</code> 访问器，让栈的实现更安全、更清晰。</li>
<li><strong>数组实现</strong>简单高效，适合大多数场景；<strong>链表实现</strong>动态灵活，适合不确定规模的场景。</li>
<li>栈在算法中用途广泛，如括号匹配、表达式求值、深度优先搜索（DFS）等。</li>
</ul>
<p>掌握栈，不仅是理解数据结构的第一步，更是打开算法世界大门的钥匙。</p>
<hr/>
<blockquote>
<p>📌 提示：在实际开发中，除非有特殊需求（如限制使用内置数组方法），否则直接使用 <code>Array</code> 的 <code>push</code>/<code>pop</code> 即可高效模拟栈行为。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue.js中父组件调用子组件的内部方法示例]]></title>    <link>https://juejin.cn/post/7576821684252311595</link>    <guid>https://juejin.cn/post/7576821684252311595</guid>    <pubDate>2025-11-26T10:38:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576821684252311595" data-draft-id="7576841976928321572" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue.js中父组件调用子组件的内部方法示例"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-26T10:38:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ai分享"/> <meta itemprop="url" content="https://juejin.cn/user/1734350779716649"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue.js中父组件调用子组件的内部方法示例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1734350779716649/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ai分享
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T10:38:22.000Z" title="Wed Nov 26 2025 10:38:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Vue.js开发中，组件化架构使得代码更模块化和可维护，但有时父组件需要直接调用子组件的内部方法，例如触发子组件的特定功能或状态更新。本文将重点讲解如何使用refs实现这一需求，避免泛泛而谈，确保内容深度和逻辑清晰。</p>
<h2 data-id="heading-0">引言</h2>
<p>Vue.js组件通常通过props向下传递数据和事件向上通信来保持独立性。然而，在某些场景下，父组件可能需要直接访问子组件的内部方法，比如在父组件中触发子组件的重置或计算操作。使用refs是一种直接且高效的方式，但它需要谨慎使用以避免破坏组件的封装性。</p>
<h2 data-id="heading-1">使用refs调用子组件方法</h2>
<p>refs是Vue.js提供的特性，允许父组件通过引用直接访问子组件的实例。这种方法简单直接，但需注意子组件的生命周期，确保在组件挂载后调用。</p>
<h3 data-id="heading-2">实现步骤</h3>
<ol>
<li><strong>在子组件中定义内部方法</strong>：子组件需要暴露一个可供调用的方法。</li>
<li><strong>在父组件模板中添加ref属性</strong>：为子组件标签设置ref，以便在父组件中引用。</li>
<li>**在父组件中通过<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>e</mi><mi>f</mi><mi>s</mi><mtext>调用方法</mtext><mo>∗</mo><mo>∗</mo><mtext>：使用</mtext><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">refs调用方法**：使用this.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">re</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">s</span><span class="mord cjk_fallback">调用方法</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">∗</span><span class="mord cjk_fallback">：使用</span><span class="mord mathnormal">t</span><span class="mord mathnormal">hi</span><span class="mord mathnormal">s</span><span class="mord">.</span></span></span></span></span>refs访问子组件实例并执行方法。</li>
</ol>
<h3 data-id="heading-3">代码示例</h3>
<p>以下是一个完整的示例，展示父组件调用子组件的internalMethod方法。示例基于Vue 2.x版本，代码严谨且可运行。</p>
<h4 data-id="heading-4">子组件代码 (ChildComponent.vue)</h4>
<pre><code class="hljs language-javascript" lang="javascript">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>子组件内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">internalMethod</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 内部方法示例：更新数据或执行操作</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子组件内部方法被调用'</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">'方法执行成功'</span>;
    }
  },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">message</span>: <span class="hljs-string">''</span>
    };
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-5">父组件代码 (ParentComponent.vue)</h4>
<pre><code class="hljs language-javascript" lang="javascript">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">child-component</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"childRef"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">child-component</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"callChildMethod"</span>&gt;</span>调用子组件方法<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>状态: {{ status }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChildComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ChildComponent.vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">ChildComponent</span>
  },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">status</span>: <span class="hljs-string">''</span>
    };
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">callChildMethod</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 通过refs调用子组件方法</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">childRef</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">childRef</span>.<span class="hljs-title function_">internalMethod</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'子组件方法已调用'</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'子组件未正确引用'</span>);
      }
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-6">注意事项</h3>
<ul>
<li><strong>生命周期确保</strong>：在父组件中调用子组件方法时，需确保子组件已挂载（例如，在mounted钩子后调用），否则可能访问不到$refs。</li>
<li><strong>封装性考虑</strong>：过度使用refs可能违反组件设计原则，建议优先使用props和事件进行通信，仅在必要时采用此方法。</li>
<li><strong>错误处理</strong>：在实际项目中，应添加错误处理，例如检查$refs是否存在，以避免运行时错误。</li>
</ul>
<h2 data-id="heading-7">其他方法比较</h2>
<p>除了refs，Vue.js还支持通过事件或props回调实现类似功能，但这些方式更适用于子组件主动通信。下表简要比较不同方法：</p>

































<table><thead><tr><th>方法</th><th>描述</th><th>适用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>refs</td><td>直接访问子组件实例</td><td>父组件需直接调用子组件方法</td><td>简单直接，性能高</td><td>可能破坏封装，需注意生命周期</td></tr><tr><td>事件</td><td>子组件发射事件，父组件监听</td><td>子组件主动通知父组件</td><td>符合Vue数据流原则</td><td>需要子组件配合，不适用于直接调用</td></tr><tr><td>props回调</td><td>通过props传递函数</td><td>父组件向子组件传递回调</td><td>灵活，易于测试</td><td>代码可能冗长，不适合复杂场景</td></tr></tbody></table>
<h2 data-id="heading-8">总结</h2>
<p>通过refs，父组件可以高效调用子组件的内部方法，但开发者应权衡封装性和便利性。在实际应用中，建议结合项目需求选择合适的方法，并遵循Vue.js的最佳实践以保持代码可维护性。本示例提供了完整的实现代码，帮助读者快速上手应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大道至简-Shadcn/ui设计系统初体验（下）：Theme与色彩系统实战]]></title>    <link>https://juejin.cn/post/7576838095519203379</link>    <guid>https://juejin.cn/post/7576838095519203379</guid>    <pubDate>2025-11-26T10:51:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576838095519203379" data-draft-id="7576863819981488137" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大道至简-Shadcn/ui设计系统初体验（下）：Theme与色彩系统实战"/> <meta itemprop="keywords" content="前端,前端框架"/> <meta itemprop="datePublished" content="2025-11-26T10:51:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ArkPppp"/> <meta itemprop="url" content="https://juejin.cn/user/4484239094198752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大道至简-Shadcn/ui设计系统初体验（下）：Theme与色彩系统实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4484239094198752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ArkPppp
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T10:51:10.000Z" title="Wed Nov 26 2025 10:51:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大道至简-Shadcn/ui设计系统初体验（下）：Theme与色彩系统实战</h2>
<h3 data-id="heading-1">前言</h3>
<p>在上篇文章中，我们探讨了shadcn/ui的安装、组件引入和基础定制。本文将继续深入，关注一个更核心的话题——主题系统设计。作为前端工程师，我们都明白一个好的设计系统不仅要有美观的组件，更需要一套完整、可维护、可扩展的色彩体系。本文将通过实际项目实践，详细分析shadcn/ui如何通过CSS变量和TailwindCSS构建这套体系。</p>
<h3 data-id="heading-2">一、自定义主题配置：从CSS变量到TailwindCSS</h3>
<h4 data-id="heading-3">1.1 shadcn/ui的主题系统原理</h4>
<p>shadcn/ui采用了基于CSS自定义属性（CSS Variables）的设计模式。每个主题实际上就是一套CSS变量的集合。不同于传统组件库通过JavaScript动态计算颜色值，shadcn/ui选择在CSS层面定义好所有颜色状态，然后通过类名切换来实现主题变换。</p>
<p>这种设计的优势显而易见：</p>
<ul>
<li>无需JavaScript计算，避免频繁的重排重绘</li>
<li>颜色值在构建阶段就已经确定，性能更好</li>
<li>CSS变量天然支持继承和级联，便于管理复杂的色彩体系</li>
</ul>
<p>让我们查看项目的核心配置文件：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* src/index.css */</span>
<span class="hljs-keyword">@import</span> <span class="hljs-string">"tailwindcss"</span>;

<span class="hljs-keyword">@custom-variant</span> dark (&amp;:is(.dark *));

<span class="hljs-keyword">@theme</span> {
  <span class="hljs-attr">--color-border</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-built_in">var</span>(--border));
  <span class="hljs-attr">--color-input</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-built_in">var</span>(--input));
  <span class="hljs-attr">--color-ring</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-built_in">var</span>(--ring));
  <span class="hljs-attr">--color-background</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-built_in">var</span>(--background));
  <span class="hljs-attr">--color-foreground</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-built_in">var</span>(--foreground));
  <span class="hljs-comment">/* ... 更多颜色变量 */</span>
}
</code></pre>
<p>注意这里使用TailwindCSS 4的新语法 <code>@theme</code> 替代了传统的 <code>tailwind.config.js</code> 配置。这种方式将主题配置直接内联到CSS文件中，更加直观。</p>
<h4 data-id="heading-4">1.2 主题色彩定义</h4>
<p>shadcn/ui使用HSL色彩空间来定义颜色。HSL由色相(Hue)、饱和度(Saturation)、亮度(Lightness)三个分量组成，相比RGB更容易理解和调整。</p>
<p>我们项目的实际配色：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-comment">/* 背景与前景色 */</span>
  <span class="hljs-attr">--background</span>: <span class="hljs-number">210</span> <span class="hljs-number">20%</span> <span class="hljs-number">96%</span>;
  <span class="hljs-attr">--foreground</span>: <span class="hljs-number">222</span> <span class="hljs-number">15%</span> <span class="hljs-number">15%</span>;

  <span class="hljs-comment">/* 主色调 - 浅蓝色系 */</span>
  <span class="hljs-attr">--primary</span>: <span class="hljs-number">205</span> <span class="hljs-number">85%</span> <span class="hljs-number">60%</span>;
  <span class="hljs-attr">--primary-foreground</span>: <span class="hljs-number">210</span> <span class="hljs-number">40%</span> <span class="hljs-number">98%</span>;

  <span class="hljs-comment">/* 次要色 - 浅绿色系 */</span>
  <span class="hljs-attr">--secondary</span>: <span class="hljs-number">145</span> <span class="hljs-number">65%</span> <span class="hljs-number">60%</span>;
  <span class="hljs-attr">--secondary-foreground</span>: <span class="hljs-number">222</span> <span class="hljs-number">15%</span> <span class="hljs-number">15%</span>;

  <span class="hljs-comment">/* 强调色 - 青绿色系 */</span>
  <span class="hljs-attr">--accent</span>: <span class="hljs-number">175</span> <span class="hljs-number">70%</span> <span class="hljs-number">55%</span>;
  <span class="hljs-attr">--accent-foreground</span>: <span class="hljs-number">210</span> <span class="hljs-number">40%</span> <span class="hljs-number">98%</span>;
}

<span class="hljs-selector-class">.dark</span> {
  <span class="hljs-comment">/* 深色主题配色 */</span>
  <span class="hljs-attr">--background</span>: <span class="hljs-number">210</span> <span class="hljs-number">15%</span> <span class="hljs-number">10%</span>;
  <span class="hljs-attr">--foreground</span>: <span class="hljs-number">210</span> <span class="hljs-number">15%</span> <span class="hljs-number">92%</span>;
  <span class="hljs-attr">--primary</span>: <span class="hljs-number">205</span> <span class="hljs-number">85%</span> <span class="hljs-number">65%</span>;
  <span class="hljs-attr">--secondary</span>: <span class="hljs-number">145</span> <span class="hljs-number">60%</span> <span class="hljs-number">65%</span>;
  <span class="hljs-attr">--accent</span>: <span class="hljs-number">175</span> <span class="hljs-number">65%</span> <span class="hljs-number">60%</span>;
  <span class="hljs-comment">/* ... */</span>
}
</code></pre>
<p>配色方案的设计遵循以下原则：</p>
<ol>
<li><strong>语义化命名</strong>：每个颜色都有明确的语义（background、primary、secondary等）</li>
<li><strong>状态配套</strong>：每个主要颜色都有对应的foreground色，保证可读性</li>
<li><strong>明暗适配</strong>：深色模式下适当调整亮度和饱和度</li>
</ol>
<h4 data-id="heading-5">1.3 扩展色系：成功与警告</h4>
<p>除了标准的设计语言色彩，shadcn/ui还允许定义扩展色系，用于表达特定状态：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--success</span>: <span class="hljs-number">145</span> <span class="hljs-number">60%</span> <span class="hljs-number">50%</span>;
  <span class="hljs-attr">--success-light</span>: <span class="hljs-number">145</span> <span class="hljs-number">65%</span> <span class="hljs-number">60%</span>;
  <span class="hljs-attr">--success-dark</span>: <span class="hljs-number">145</span> <span class="hljs-number">55%</span> <span class="hljs-number">45%</span>;

  <span class="hljs-attr">--warning</span>: <span class="hljs-number">45</span> <span class="hljs-number">85%</span> <span class="hljs-number">60%</span>;
  <span class="hljs-attr">--warning-light</span>: <span class="hljs-number">45</span> <span class="hljs-number">90%</span> <span class="hljs-number">65%</span>;
  <span class="hljs-attr">--warning-dark</span>: <span class="hljs-number">45</span> <span class="hljs-number">80%</span> <span class="hljs-number">55%</span>;
}
</code></pre>
<p>这种命名方式（基础色-light-dark）为每个语义色提供了三个亮度级别，在实际开发中可以根据不同场景选择合适的深浅。</p>
<h3 data-id="heading-6">二、颜色系统设计：CSS变量与OKLCH色彩空间</h3>
<h4 data-id="heading-7">2.1 CSS变量的高级特性</h4>
<p>CSS自定义属性（CSS Variables）不仅仅是简单的键值对，它具备许多强大的特性：</p>
<p><strong>1. 继承性</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-built_in">var</span>(--primary));
}

<span class="hljs-selector-class">.card-header</span> {
  <span class="hljs-comment">/* 自动继承父元素的 --primary */</span>
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-built_in">var</span>(--primary));
}
</code></pre>
<p><strong>2. 动态计算</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--primary-light</span>: <span class="hljs-number">205</span> <span class="hljs-number">85%</span> <span class="hljs-built_in">calc</span>(<span class="hljs-number">60%</span> + <span class="hljs-number">10%</span>);
}
</code></pre>
<p><strong>3. 作用域控制</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 全局作用域 */</span>
<span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--global-primary</span>: blue;
}

<span class="hljs-comment">/* 局部作用域 */</span>
<span class="hljs-selector-class">.theme-dark</span> {
  <span class="hljs-attr">--local-primary</span>: red;
}
</code></pre>
<p>这些特性使得CSS变量非常适合构建复杂的颜色系统。</p>
<h4 data-id="heading-8">2.2 OKLCH色彩空间：下一代色彩标准</h4>
<p>传统的HSL色彩空间有一个明显缺陷：<strong>感知不均匀性</strong>。也就是说，在HSL中同样数值的变化，人眼感知的差异并不一致。例如，HSL中饱和度从50%到60%的变化，看起来比60%到70%的变化更明显。</p>
<p>OKLCH（Lightness-Chroma-Hue）色彩空间解决了这个问题。OKLCH是基于CIELAB色彩空间的现代色彩模型，具有以下优势：</p>
<ul>
<li><strong>感知均匀</strong>：数值的微小变化对应人眼感知的微小变化</li>
<li><strong>色域更广</strong>：支持更多可见色彩</li>
<li><strong>对比度可控</strong>：更容易满足WCAG可访问性标准</li>
</ul>
<p>虽然浏览器对OKLCH的支持还在逐步完善中，但TailwindCSS已经开始采用OKLCH。未来shadcn/ui很可能会迁移到OKLCH色彩空间。</p>
<h4 data-id="heading-9">2.3 构建语义化颜色系统</h4>
<p>一个好的颜色系统需要避免直接使用底层色彩值，而是通过语义化变量来使用：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* ❌ 不好的做法 - 直接使用底层颜色 */</span>
<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">59</span>, <span class="hljs-number">130</span>, <span class="hljs-number">246</span>);
}

<span class="hljs-comment">/* ✅ 好的做法 - 使用语义化变量 */</span>
<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-built_in">var</span>(--primary));
}
</code></pre>
<p>这种设计的好处：</p>
<ol>
<li><strong>可维护性强</strong>：修改主题时只需更改CSS变量定义</li>
<li><strong>一致性保证</strong>：全站使用统一的语义化色彩</li>
<li><strong>灵活性高</strong>：可以针对不同区域覆盖特定变量</li>
</ol>
<h3 data-id="heading-10">三、项目实践：TodoList的主题更新实现</h3>
<h4 data-id="heading-11">3.1 ThemeProvider设计</h4>
<p>shadcn/ui提供了一个独立的ThemeProvider实现，位于 <code>src/components/theme-provider.tsx</code>。这个实现替代了传统的next-themes，更轻量且完全基于原生Web API。</p>
<p>核心实现分析：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeProvider</span>(<span class="hljs-params">{
  children,
  defaultTheme = <span class="hljs-string">'system'</span>,
  storageKey = <span class="hljs-string">'vite-ui-theme'</span>,
}: ThemeProviderProps</span>) {
  <span class="hljs-keyword">const</span> [theme, setTheme] = useState&lt;<span class="hljs-title class_">Theme</span>&gt;(
    <span class="hljs-function">() =&gt;</span> (<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(storageKey) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Theme</span>) || defaultTheme
  )

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> root = <span class="hljs-variable language_">window</span>.<span class="hljs-property">document</span>.<span class="hljs-property">documentElement</span>

    root.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'light'</span>, <span class="hljs-string">'dark'</span>)

    <span class="hljs-keyword">if</span> (theme === <span class="hljs-string">'system'</span>) {
      <span class="hljs-keyword">const</span> systemTheme = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">'(prefers-color-scheme: dark)'</span>)
        .<span class="hljs-property">matches</span>
        ? <span class="hljs-string">'dark'</span>
        : <span class="hljs-string">'light'</span>

      root.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(systemTheme)
      <span class="hljs-keyword">return</span>
    }

    root.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(theme)
  }, [theme])

  <span class="hljs-keyword">const</span> value = {
    theme,
    <span class="hljs-attr">setTheme</span>: <span class="hljs-function">(<span class="hljs-params">theme: Theme</span>) =&gt;</span> {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(storageKey, theme)
      <span class="hljs-title function_">setTheme</span>(theme)
    },
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeProviderContext.Provider</span> {<span class="hljs-attr">...props</span>} <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeProviderContext.Provider</span>&gt;</span></span>
  )
}
</code></pre>
<p>关键点分析：</p>
<ol>
<li>
<p><strong>三种主题模式</strong></p>
<ul>
<li><code>light</code>: 强制使用浅色主题</li>
<li><code>dark</code>: 强制使用深色主题</li>
<li><code>system</code>: 跟随系统设置</li>
</ul>
</li>
<li>
<p><strong>本地存储持久化</strong>
使用localStorage保存用户偏好，应用重启后自动恢复。</p>
</li>
<li>
<p><strong>类名切换机制</strong>
通过操作documentElement的classList来切换主题，避免频繁的style重写。</p>
</li>
</ol>
<h4 data-id="heading-12">3.2 TodoList中的主题切换按钮</h4>
<p>在TodoList组件中，主题切换按钮的实现：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useTheme } <span class="hljs-keyword">from</span> <span class="hljs-string">'./theme-provider'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { theme, setTheme } = <span class="hljs-title function_">useTheme</span>()

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setTheme</span>(theme === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>)
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
      <span class="hljs-attr">variant</span>=<span class="hljs-string">"ghost"</span>
      <span class="hljs-attr">size</span>=<span class="hljs-string">"icon"</span>
      <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleTheme}</span>
      <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"切换主题"</span>
    &gt;</span>
      {theme === 'light' ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">Moon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-4 w-4"</span> /&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">Sun</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-4 w-4"</span> /&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
  )
}
</code></pre>
<p>注意这里的实现细节：</p>
<ul>
<li>使用aria-label提升可访问性</li>
<li>根据当前主题显示对应图标（月亮/太阳）</li>
<li>variant设为ghost保持视觉简洁</li>
</ul>
<h4 data-id="heading-13">3.3 主题变量的实际应用</h4>
<p>在TodoList组件中，我们看到各种shadcn/ui组件都使用了语义化的颜色变量：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;div className=<span class="hljs-string">"min-h-screen bg-background text-foreground transition-colors"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"border-border"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">CardHeader</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">CardTitle</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-gradient-to-r from-primary via-secondary to-accent bg-clip-text text-transparent"</span>&gt;</span>
        待办事项列表
      <span class="hljs-tag">&lt;/<span class="hljs-name">CardTitle</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">CardHeader</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span></span>
&lt;/div&gt;
</code></pre>
<p>关键点：</p>
<ul>
<li><code>bg-background</code> 和 <code>text-foreground</code>：使用语义变量确保文本可读性</li>
<li><code>border-border</code>：边框颜色随主题变化</li>
<li>渐变色使用CSS变量，保持主题一致性</li>
</ul>
<h3 data-id="heading-14">四、shadcn/ui的设计哲学总结</h3>
<p>通过上下两篇文章的分析，我们可以总结shadcn/ui的设计哲学：</p>
<h4 data-id="heading-15">4.1 零抽象成本</h4>
<p>shadcn/ui不将组件封装为黑盒，而是提供完整源代码。这种"代码所有权"模式让开发者可以：</p>
<ul>
<li>任意修改组件实现</li>
<li>深入理解组件逻辑</li>
<li>无框架依赖，便于迁移</li>
</ul>
<h4 data-id="heading-16">4.2 原子化设计</h4>
<p>每个组件都是独立的、无样式基础的（headless），样式完全通过TailwindCSS类控制。这带来：</p>
<ul>
<li>样式完全可控</li>
<li>避免CSS优先级冲突</li>
<li>更好的Tree-shaking效果</li>
</ul>
<h4 data-id="heading-17">4.3 设计令牌驱动</h4>
<p>通过CSS变量系统，shadcn/ui建立了完整的设计令牌（Design Tokens）体系：</p>
<ul>
<li>颜色、字体、间距等都有对应的令牌</li>
<li>令牌支持层级继承</li>
<li>便于实现设计系统的一致性</li>
</ul>
<h4 data-id="heading-18">4.4 可访问性优先</h4>
<p>基于Radix UI构建，所有组件都具备：</p>
<ul>
<li>完整的键盘导航支持</li>
<li>正确的ARIA属性</li>
<li>语义化的HTML结构</li>
</ul>
<h4 data-id="heading-19">4.5 现代化工具链</h4>
<p>shadcn/ui深度集成了现代前端工具：</p>
<ul>
<li>TailwindCSS 4（最新语法）</li>
<li>TypeScript（完整类型定义）</li>
<li>Vite（快速构建）</li>
<li>ESLint（代码规范）</li>
</ul>
<h3 data-id="heading-20">5.成果展示</h3>
<p>让我们看看最终的成果吧。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d971df593d3a4b6c963d6199e81fa00e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXJrUHBwcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759070&amp;x-signature=0dXKeedhKGCjORg6egGJnd3sgr0%3D" alt="LightMode.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bad9e9cb53384119b7949f065dc3ddd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXJrUHBwcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759070&amp;x-signature=laIwrGY4GGVXmgysiVvZytDIHxk%3D" alt="NightMode.png" loading="lazy"/></p>
<h3 data-id="heading-21">结语</h3>
<p><code>shadcn/ui</code>不仅仅是一个组件库，更是一套完整的设计系统实现方案。它通过CSS变量、TailwindCSS和现代React模式的结合，为我们提供了一种全新的组件库构建思路。</p>
<p>这种"大道至简"的设计理念——将复杂的UI抽象还原为简单的CSS变量和可组合的组件——或许正是前端开发的一种新范式。在AI编程工具日益成熟，Vibe Coding愈发普遍的今天，一个开放、可定制、无黑盒的组件库将更具生命力。</p>
<hr/>
<h3 data-id="heading-22">参考：</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fui.shadcn.com%2Fdocs" target="_blank" title="https://ui.shadcn.com/docs" ref="nofollow noopener noreferrer">shadcn/ui官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2Fdocs%2Ftheme" target="_blank" title="https://tailwindcss.com/docs/theme" ref="nofollow noopener noreferrer">TailwindCSS主题配置</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FCSS%2FUsing_CSS_custom_properties" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_custom_properties" ref="nofollow noopener noreferrer">CSS自定义属性MDN文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fevilmartians.com%2Fchronicles%2Foklch-in-css-why-quotas-from-a-perceptual-point-of-view" target="_blank" title="https://evilmartians.com/chronicles/oklch-in-css-why-quotas-from-a-perceptual-point-of-view" ref="nofollow noopener noreferrer">OKLCH色彩空间介绍</a></li>
<li>Claude Code参与部分编写工作</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小米开源首个跨域具身基座模型MiMo-Embodied，29个榜单SOTA]]></title>    <link>https://juejin.cn/post/7576863819981537289</link>    <guid>https://juejin.cn/post/7576863819981537289</guid>    <pubDate>2025-11-26T10:53:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576863819981537289" data-draft-id="7576852209565466651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小米开源首个跨域具身基座模型MiMo-Embodied，29个榜单SOTA"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-26T10:53:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小米开源首个跨域具身基座模型MiMo-Embodied，29个榜单SOTA
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T10:53:53.000Z" title="Wed Nov 26 2025 10:53:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>该研究由<strong>小米具身智能团队（Xiaomi Embodied Intelligence Team）</strong> 共同完成。由该团队的<strong>郝孝帅</strong>担任核心贡献第一作者，项目负责人则是小米智驾团队首席科学家<strong>陈龙</strong>。团队致力于打破单一领域的界限，构建能够同时理解物理世界并进行复杂推理的通用智能体（模型），汇聚了自动驾驶与具身智能领域的顶尖研究力量。</p>
<h2 data-id="heading-0"/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/691f5ab3db894f518b3eb54a368c85a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759233&amp;x-signature=x41e4w7StjueWSlIq%2FANyd5umoY%3D" alt="图片" loading="lazy"/></p>
<p>大语言模型（LLM）与多模态大语言模型（MLLM）的浪潮正以前所未有的速度席卷 AI 领域，但当算法试图走出数字世界，迈入物理实体时，却遭遇了严重的“水土不服”。</p>
<p>在传统的具身智能研发范式中，<strong>自动驾驶</strong>（Autonomous Driving）<strong>与具身智能</strong>（Embodied AI）长期被视为两条平行线。前者在户外高速动态环境中，通过激光雷达与相机感知车流与红绿灯；后者则在室内静态或低速环境中，依赖机器人本体进行精细的导航和操作任务。</p>
<p>这种“各管一摊”的局面，导致了严重的领域割裂。现有的专用模型往往“偏科”严重：自动驾驶模型（如 DriveLMM）缺乏对物体部件级的精细理解，而机器人模型（如 RoboBrain2.0）则难以应对复杂的交通博弈与高动态场景。</p>
<p>结果就是，我们始终缺乏一个能够打通室内外、融合动静态感知的统一“大脑”。</p>
<p>在11.21日发表的技术报告《MiMo-Embodied: X-Embodied Foundation Model》中，小米具身智能团队指出了这一痛点，并发布了 <strong>MiMo-Embodied</strong>——这是首个开源的、成功融合了自动驾驶与具身智能的跨域基座模型。</p>
<p>研究数据显示，MiMo-Embodied 在<strong>17个具身智能基准</strong>和<strong>12个自动驾驶基准</strong>上均刷新了记录（SOTA），不仅大幅超越了开源基线，更在空间推理与规划等关键指标上击败了 GPT-4o、Gemini-Pro 等闭源模型，证明了跨域知识融合的巨大潜力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8393b7afac6541cf8cb3d8a5d22d3b8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759233&amp;x-signature=JoY6XOQ3bvdwBM3lLR2NjGElz0Q%3D" alt="图片" loading="lazy"/></p>
<p><strong>论文题目：</strong>  </p>
<p>MiMo-Embodied: X-Embodied Foundation Model**</p>
<p><strong>论文链接：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.16518" target="_blank" title="https://arxiv.org/abs/2511.16518" ref="nofollow noopener noreferrer">arxiv.org/abs/2511.16…</a>**</p>
<p><strong>项目主页：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FXiaomiMiMo%2FMiMo-Embodied" target="_blank" title="https://github.com/XiaomiMiMo/MiMo-Embodied" ref="nofollow noopener noreferrer">github.com/XiaomiMiMo/…</a></p>
<h4 data-id="heading-1"/>
<h4 data-id="heading-2">统一物理世界的认知基座</h4>
<p>要解决领域割裂，不能简单地进行模型拼接。MiMo-Embodied 的核心在于构建了一个统一的感知与推理模型架构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0510190c715345f59e3d31842b757123~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759233&amp;x-signature=MjxVjKbdZS%2FS5FBkCqRItIDFwKo%3D" alt="图片" loading="lazy"/></p>
<p>该模型基于小米自研的 <strong>MiMo-VL</strong> 架构（包含 Vision Transformer 视觉编码器与 MLP 投影层），将物理世界的交互能力解构为六大核心维度：</p>
<p>在<strong>自动驾驶侧</strong>，模型不仅要进行环境感知（识别车道、障碍物），更需具备状态预测（Status Prediction）<strong>与</strong>驾驶规划（Driving Planning）能力——即像老司机一样，预测旁车意图，并生成符合交通规则的驾驶轨迹。</p>
<p>在<strong>具身智能侧</strong>，模型重点攻克<strong>可供性预测（Affordance Prediction）与空间理解（Spatial Understanding）</strong> 。这意味着模型不仅要识别物体，还要理解物体“哪里能抓”、“哪里能放”，并能解析复杂的空间介词（如“在...左边的物体，在...的前方区域”）。</p>
<h4 data-id="heading-3">四阶段进化：从“看懂”到“决策”</h4>
<h4 data-id="heading-4"/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5085e6eb9f94310a6905fbdd7c61b0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759233&amp;x-signature=7KAtGQxoX8WpbODynfAtyEfITnA%3D" alt="图片" loading="lazy"/></p>
<p>如何在单一模型中融合差异巨大的跨域数据，同时避免“灾难性遗忘”？小米团队设计了一套严谨的<strong>四阶段渐进式训练策略（Progressive Four-stage Training Strategy）</strong> ，这也是该模型性能卓越的关键。</p>
<p>简单的混合训练往往会导致“灾难性遗忘”。团队首先利用海量通用数据与具身数据奠定基础，建立模型对物体与空间的初级认知；随后引入大规模自动驾驶数据，通过混合监督学习，让模型在掌握高速动态感知的同时，保留对室内精细操作的理解。</p>
<p><strong>阶段一：具身与通用知识奠基。</strong> 这一阶段类似于人类的“通识教育”。模型利用海量通用图文数据（Visual Grounding、OCR）和具身智能数据（如 RoboRefIt、Cosmos-Reason1）进行监督微调。这建立了模型对细粒度物体部件的定位能力，以及对基础空间关系的理解，使其学会“看懂”静态物理世界。</p>
<p><strong>阶段二：自动驾驶知识注入与混合监督。</strong> 模型随后进入“驾校”。团队引入了包括 CODA-LM（长尾场景）、nuScenes-QA 在内的大规模自动驾驶数据。关键创新在于<strong>混合监督（Mixed Supervision）</strong> ——在注入高速动态驾驶知识的同时，保留部分具身数据。这确保模型在学习识别红绿灯和车道线时，不会遗忘如何识别室内的水杯和把手。</p>
<p><strong>阶段三：思维链推理（CoT）的逻辑升华。</strong> 只会感知还不够，智能体必须具备逻辑推理能力。团队构建了包含显式推理步骤（Rationale）的数据集，利用 <strong>Chain-of-Thought (CoT)</strong>  技术进行微调。 例如，在面对“车辆是否应该变道？”的问题时，模型不再直接输出“是/否”，而是生成一段完整的思考路径：“检测到前方拥堵 -&gt; 左侧车道空闲 -&gt; 且后方无快速来车 -&gt; 因此建议变道”。这种显式的逻辑生成，极大提升了模型在长尾复杂场景下的鲁棒性与可解释性。</p>
<p><strong>阶段四：强化学习（RL）的终极打磨。</strong> 这是画龙点睛的一笔。针对多模态模型常有的“幻觉”问题（如生成的坐标不准确），团队利用 <strong>GRPO</strong>算法。通过设计针对性的奖励函数，RL 算法迫使模型在面对同一个问题时，从多个候选答案中收敛到逻辑更严密、坐标更精准的输出。这就像是考前的“高强度刷题”，将模型的执行精度推向了极致。</p>
<p>总体数据集规模与配置如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/130fa3863769409f952c1461758e7048~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759233&amp;x-signature=uGNUiTunMJhfxyj0bqDBi9SrIRs%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-5"/>
<h4 data-id="heading-6">实验结果：正向迁移引发的性能跃升</h4>
<p>这种“四步走”策略带来的效果是结构性的。实验表明，MiMo-Embodied 并非两个领域的简单叠加，而是实现了<strong>正向迁移</strong>。</p>
<h3 data-id="heading-7">🎯 具身智能基准测试：17项SOTA全面突破</h3>
<h3 data-id="heading-8"/>
<p>在17个具身智能基准测试中，MiMo-Embodied 在可供性预测（Affordance Prediction）、任务规划（Task Planning）和空间理解（Spatial Understanding）三大核心能力上全面刷新记录。</p>
<h4 data-id="heading-9">可供性预测能力</h4>
<h4 data-id="heading-10"/>
<p>MiMo-Embodied 模型在 RoboRefIt、Where2Place、VABench-Point、Part-Afford 和 RoboAfford-Eval 五个专业基准上均达到最优性能。特别值得注意的是，MiMo-Embodied 在 VABench-Point、Part-Afford 和 RoboAfford-Eval 上大幅领先其他具身智能模型，展现出在精细可供性推理方面的强大能力。</p>
<h4 data-id="heading-11">任务规划能力</h4>
<h4 data-id="heading-12"/>
<p>MiMo-Embodied 在 RoboVQA 基准上表现最优，展示了在因果推理和目标导向结果理解方面的卓越能力。在长时规划基准 EgoPlan2 上也取得了极具竞争力的成绩，充分证明了模型在长时推理方面的有效性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ba49befc420443c802fe29f2a4ecd97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759233&amp;x-signature=f1riC19%2BAMxT6Yys2I1EQ64gXIE%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-13"/>
<h4 data-id="heading-14">空间理解能力</h4>
<h4 data-id="heading-15"/>
<p>MiMo-Embodied在综合空间智能任务 CV-Bench 上取得最优结果，在空间关系推理的 RoboSpatial、RefSpatial-Bench 和 CRPE 关系子集上均领先。这些结果验证了 MiMo-Embodied 在物理世界具身推理方面的强大能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15193a63ee76473491ae2b2a2537f634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759233&amp;x-signature=2UzBZ5%2B61cSVT%2BXQXnWvm3i6o0g%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-16"/>
<h3 data-id="heading-17">🚗 自动驾驶基准测试：12项指标全面领先</h3>
<h3 data-id="heading-18"/>
<p>MiMo-Embodied 在12个自动驾驶基准上表现卓越，涵盖环境感知、状态预测和驾驶规划三大维度。</p>
<h4 data-id="heading-19">环境感知能力</h4>
<h4 data-id="heading-20"/>
<p>在全景语义理解任务上展现最优表现，在具有挑战性的局部感知场景中也表现出卓越的鲁棒性。实验结果令人信服地证明，MiMo-Embodied 具备多层次、高保真的环境感知能力。</p>
<h4 data-id="heading-21">状态预测能力</h4>
<h4 data-id="heading-22"/>
<p>在单图像基准 MME-RealWorld 和多视图图像基准 DriveLM 上均取得强劲表现，准确捕捉个体行为意图并有效建模多智能体间的复杂交互。</p>
<h4 data-id="heading-23">驾驶规划能力</h4>
<h4 data-id="heading-24"/>
<p>在所有面向规划的基准测试中均表现突出。这种持续的优越性充分说明，模型不仅能生成准确、符合情境的驾驶决策，还能产生与现实世界交通逻辑和驾驶规范相符的连贯、可解释的推理过程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf4198ec70e746caa4cf43c61d77acfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759233&amp;x-signature=ZTaqq53%2FWK9Es4yBVgoK70XcRB8%3D" alt="图片" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edf587d15ac64299ac42e5a0a78f99be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759233&amp;x-signature=1A4hv2%2BTSo3OPM7sHHuToqev4AQ%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-25"/>
<h3 data-id="heading-26">💪 真实世界场景验证：从仿真到实战</h3>
<h3 data-id="heading-27"/>
<h4 data-id="heading-28">具身导航与操作</h4>
<h4 data-id="heading-29"/>
<p>团队在具身导航和操作两个基础下游应用中验证了模型的实用性。在导航任务中，MiMo-Embodied 在四个家庭导航场景中表现优异：定位卧室中的床、在餐厅找到吸尘器、在书房识别植物、在浴室定位马桶。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56fc6923fbff4882af8fe56c1f58e4f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759233&amp;x-signature=tgxKht1uYkX0WnmQTTAgWVvQKuQ%3D" alt="图片" loading="lazy"/></p>
<p>在操作任务中，模型展现了出色的可供性预测和空间推理整合能力，在识别粉色勺子的可抓取把手、定位底排橙子之间的中间放置位置、选择最左侧面包等功能导向任务中均表现出色。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53519e77aec649c69d5128126df5772a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759233&amp;x-signature=gFESgZd9nbwBI5KMnqDMe%2BSGMHg%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-30"/>
<h4 data-id="heading-31">自动驾驶轨迹规划</h4>
<h4 data-id="heading-32"/>
<h5 data-id="heading-33">公开基准表现。在 NAVSIM 基准上，MiMo-Embodied 显著超越竞争模型，在模仿学习（IL）阶段和强化学习（RL）阶段均取得最优性能。</h5>
<p>定性结果表明，MiMo-Embodied 能够处理多样化的自动驾驶场景并完成具有挑战性的任务，包括路口转弯、弯道掉头、跟车和变道超车。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/923b1d5bbaff4a8ea1a984e88cf67fd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759233&amp;x-signature=ruXsh9yxwORWQXYjlx3bw10nsm8%3D" alt="图片" loading="lazy"/></p>
<h5 data-id="heading-34"/>
<h5 data-id="heading-35">专有数据集验证。在大规模专有数据集上的评估显示，MiMo-Embodied 在所有评估类别中均显著超越基线。特别值得注意的是，在复杂的交互任务（如转弯、绕障和变道）中性能提升最为显著。</h5>
<p>这种在高复杂度场景中的大幅改进，有力证明了具身训练范式赋予模型在复杂驾驶情境中更强的推理能力，并转化为更准确、更符合人类专家驾驶行为的轨迹生成。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a99b3ecdc69c406faad254c67af869a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759233&amp;x-signature=F%2FejU72iTPa9Syc0mIq054izDJ8%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-36"/>
<h3 data-id="heading-37">🔬 消融实验：多阶段策略的关键作用</h3>
<h3 data-id="heading-38"/>
<p>为验证多阶段训练策略的有效性，团队进行了系统性消融实验。结果显示：</p>
<ul>
<li>
<p>仅使用具身数据训练的模型在两个领域均表现强劲，但仅使用自动驾驶数据训练的模型在具身任务上性能显著下降</p>
</li>
<li>
<p>直接混合训练两个领域的数据，具身任务有所改进，但自动驾驶性能略有下降</p>
</li>
<li>
<p>采用多阶段训练策略的 MiMo-Embodied 在具身任务上平均达到62.4%（相比混合训练提升4%），在自动驾驶任务上达到最优的63.3%（相比混合训练提升8.1%）</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0612da37efd64f2294e504881b9a1c06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764759233&amp;x-signature=lIBNcZ1fqIcLoksTHXvw9GBRDBA%3D" alt="图片" loading="lazy"/></p>
<p>这充分证明，<strong>多阶段训练策略能够在不牺牲单一任务性能的前提下，实现具身智能和自动驾驶能力的协同提升</strong>，为构建统一的具身基座模型提供了有效的训练范式。</p>
<h4 data-id="heading-39">结语</h4>
<p>MiMo-Embodied 的出现，标志着具身智能研究进入了一个新的阶段。</p>
<p>它证明了物理世界的认知逻辑是统一的——无论是控制机器人还是驾驶汽车，都依赖于对三维空间、因果关系及行为预测的深刻理解。小米具身智能团队通过构建统一的跨域基座模型，成功打破了长期以来的领域壁垒，让数据在不同具身形态间产生了“化学反应”。</p>
<p>这项工作不仅为构建通用的 <strong>VLA（Vision-Language-Action）</strong>  模型提供了基础，也让“一个大脑，通用于百变机身”的未来愿景变得触手可及。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[无需源码的 iOS 加固方案 面向外包项目与存量应用的多层安全体系]]></title>    <link>https://juejin.cn/post/7576821684251901995</link>    <guid>https://juejin.cn/post/7576821684251901995</guid>    <pubDate>2025-11-26T09:11:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576821684251901995" data-draft-id="7576821684251885611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="无需源码的 iOS 加固方案 面向外包项目与存量应用的多层安全体系"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T09:11:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aiopencode"/> <meta itemprop="url" content="https://juejin.cn/user/1898230261493865"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            无需源码的 iOS 加固方案 面向外包项目与存量应用的多层安全体系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1898230261493865/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aiopencode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T09:11:19.000Z" title="Wed Nov 26 2025 09:11:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 iOS 开发圈，越来越多团队遇到一种现实：
<strong>项目只有 IPA，没有源码，但仍需要进行加固、安全检测或重新上线。</strong></p>
<p>典型场景包括：</p>
<ul>
<li>外包公司只交付成品包</li>
<li>多年前的存量项目源码缺失</li>
<li>某些模块由第三方提供闭源 SDK</li>
<li>安全团队需在不改源码的情况下加一层混淆</li>
<li>渠道包、定制版 App 需要额外保护</li>
<li>产品要在提交审核前进行“成品级加固”</li>
</ul>
<p>传统的 Swift/ObjC 源码混淆（Swift Shield、obfuscator-llvm 等）在这种情况下都无法使用。
因此，真正可行的路径是：<strong>以 IPA 为中心建立一套完整的“无需源码加固方案”</strong>，覆盖符号混淆、资源保护、结构扰动、完整性校验、重签验证等环节。</p>
<p>本文基于真实开发经验，总结一套可直接落地的工程化流程。</p>
<hr/>
<h3 data-id="heading-0">一、为什么“无需源码”的加固必须存在？</h3>
<p>因为很多项目结构天然复杂，源码不可控：</p>
<h4 data-id="heading-1"><strong>1）外包项目交付不完整</strong></h4>
<p>只给成品包，不给项目工程。</p>
<h4 data-id="heading-2"><strong>2）存量项目已无人维护</strong></h4>
<p>多人接手多年，源码有缺失或不一致问题。</p>
<h4 data-id="heading-3"><strong>3）部分模块是闭源 SDK</strong></h4>
<p>源码不可改，只能在 IPA 层处理。</p>
<h4 data-id="heading-4"><strong>4）多版本分发下需要逐包保护</strong></h4>
<p>如渠道包、灰度包、白标 App。</p>
<h4 data-id="heading-5"><strong>5）安全合规要求必须加固</strong></h4>
<p>但又不允许修改内部工程。</p>
<p>因此，加固必须从“源码思维”转向“成品包思维”。</p>
<hr/>
<h2 data-id="heading-6">二、无需源码的 iOS 加固需要哪些工具？（核心能力矩阵）</h2>













































<table><thead><tr><th>加固环节</th><th>工具</th><th>作用</th></tr></thead><tbody><tr><td>静态分析</td><td>MobSF、class-dump</td><td>了解可读符号、资源分布</td></tr><tr><td>符号混淆（核心）</td><td>Ipa Guard CLI</td><td>无需源码混淆类名/方法名/变量名</td></tr><tr><td>资源保护</td><td>Ipa Guard、脚本工具</td><td>重命名图片、JSON、JS、H5 等</td></tr><tr><td>MD5 扰动</td><td>Ipa Guard</td><td>防止资源替换与篡改</td></tr><tr><td>动态逆向检查</td><td>Frida、Hopper</td><td>测试 Hook 与反编译难度</td></tr><tr><td>重签名验证</td><td>kxsign</td><td>验证加固后 IPA 是否能正常运行</td></tr><tr><td>映射治理</td><td>KMS、Bugly/Sentry</td><td>符号表存储与崩溃定位</td></tr></tbody></table>
<p>完整加固依赖工具链协作，而不是单点操作。</p>
<hr/>
<h3 data-id="heading-7">三、无需源码的 IPA 加固流程（工程化可直接复制）</h3>
<p>下面给出的流程适用于所有项目，只要你能获得 IPA。</p>
<hr/>
<h3 data-id="heading-8"><strong>步骤 1：静态分析（了解 IPA 内部结构）</strong></h3>
<h4 data-id="heading-9">使用 MobSF</h4>
<p>识别：</p>
<ul>
<li>JS、JSON、图片、H5 路径</li>
<li>资源结构</li>
<li>SDK 调用</li>
<li>网络接口</li>
</ul>
<h4 data-id="heading-10">使用 class-dump</h4>
<pre><code class="hljs language-lua" lang="lua">class-<span class="hljs-built_in">dump</span> app.ipa &gt; <span class="hljs-built_in">dump</span>.txt
</code></pre>
<p>识别：</p>
<ul>
<li>Swift/ObjC 类名</li>
<li>方法名</li>
<li>属性名</li>
<li>selector</li>
<li>调用结构</li>
</ul>
<p>这些信息决定后续哪些符号要混淆、哪些要保留。</p>
<hr/>
<h3 data-id="heading-11"><strong>步骤 2：导出可混淆符号（Ipa Guard 核心功能）</strong></h3>
<p>无需源码即可导出符号：</p>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli parse app.ipa -o sym.json
</code></pre>
<p><code>sym.json</code> 中包含：</p>
<ul>
<li>所有可混淆的类名、方法名、变量名</li>
<li>Flutter/RN Bridge 名称</li>
<li>JS/H5 引用位置</li>
<li>与资源相关的文件引用</li>
<li>是否安全混淆的提示字段</li>
</ul>
<p>这份文件是策略的核心。</p>
<hr/>
<h3 data-id="heading-12"><strong>步骤 3：编辑混淆策略（必须手动审核）</strong></h3>
<h4 data-id="heading-13"><strong>不能混淆（否则会崩溃）：</strong></h4>
<ul>
<li>selector 反射方法</li>
<li>Storyboard id</li>
<li>JSBridge 回调方法</li>
<li>Flutter MethodChannel</li>
<li>RN Bridge</li>
<li>第三方 SDK 初始化接口</li>
</ul>
<p>通过在 sym.json 中设置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"confuse"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
</code></pre>
<p>避免破坏运行逻辑。</p>
<hr/>
<h4 data-id="heading-14"><strong>必须混淆（提高逆向成本）：</strong></h4>
<ul>
<li>业务类名</li>
<li>控制器</li>
<li>工具类、内部逻辑</li>
<li>Swift 方法名</li>
<li>ObjC 方法名</li>
<li>私有变量名</li>
<li>内部模型体系</li>
</ul>
<p>这些字段是攻击者最依赖的入口。</p>
<hr/>
<h3 data-id="heading-15"><strong>步骤 4：执行 IPA 混淆与资源扰动</strong></h3>
<p>真正提高安全性的核心命令：</p>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli protect app.ipa -c sym.json --email dev@team.com --image --js -o protected.ipa
</code></pre>
<p>效果包括：</p>
<p>✔ Swift/ObjC 符号混淆
✔ 方法名、类名、变量名乱码化
✔ 图片、json、plist、JS、H5 路径改名
✔ 资源 MD5 扰动
✔ 输出映射表</p>
<p>在没有源码的情况下，能做到这样已经非常强大。</p>
<hr/>
<h3 data-id="heading-16"><strong>步骤 5：重签名并进行全量测试（必做）</strong></h3>
<p>使用 kxsign：</p>
<pre><code class="hljs language-bash" lang="bash">kxsign sign protected.ipa -c cert.p12 -p <span class="hljs-built_in">pwd</span> \
  -m dev.mobileprovision -z signed.ipa -i
</code></pre>
<p>测试：</p>
<ul>
<li>启动</li>
<li>页面跳转</li>
<li>JS/H5 渲染</li>
<li>Flutter/RN 初始化</li>
<li>登录、支付、推送模块</li>
<li>性能是否正常</li>
</ul>
<p>确保混淆没有破坏业务功能。</p>
<hr/>
<h3 data-id="heading-17"><strong>步骤 6：验证防护效果（逆向难度测试）</strong></h3>
<h4 data-id="heading-18">① Hopper/IDA 验证</h4>
<p>确认：</p>
<ul>
<li>类名是否乱码</li>
<li>方法结构是否不可读</li>
<li>是否仍能推断业务逻辑</li>
</ul>
<h4 data-id="heading-19">② Frida Hook 测试</h4>
<pre><code class="hljs language-css" lang="css">frida -U -f com<span class="hljs-selector-class">.app</span> <span class="hljs-attr">--no-pause</span> -l hook<span class="hljs-selector-class">.js</span>
</code></pre>
<p>确认：</p>
<ul>
<li>关键方法是否难以 Hook</li>
<li>字符串是否被混淆隐藏</li>
<li>JSBridge 是否难以定位</li>
</ul>
<p>这两步是“防护效果”的最终验证。</p>
<hr/>
<h3 data-id="heading-20"><strong>步骤 7：映射治理（保证长期可维护）</strong></h3>
<p>保存以下内容：</p>
<ul>
<li>混淆映射表</li>
<li>sym.json</li>
<li>构建号</li>
<li>签名指纹</li>
<li>IPA 版本与对应策略</li>
</ul>
<p>存放在：</p>
<ul>
<li>KMS</li>
<li>Git 加密仓库</li>
<li>CI 自动归档</li>
</ul>
<p>用于回滚与崩溃定位。</p>
<hr/>
<h3 data-id="heading-21">四、最终效果：无需源码也能实现专业级加固</h3>
<p>完成上述流程后，你会得到一个：</p>
<p>反编译后完全不可读的 IPA
类名、方法名、变量名全乱码
调用链无法推断
JS/H5 路径被完全改写
图片与 JSON 资源不可替换
Hook 难度大幅提升
二次修改容易导致崩溃
加固策略可持续维护、有映射可回滚</p>
<p>这就是现代企业级 iOS 加固应有的样子。</p>
<hr/>
<h3 data-id="heading-22">真正的“无需源码加固”，靠的是流程，而不是某个工具</h3>
<p>推荐的完整技术组合：</p>
<h4 data-id="heading-23"><strong>分析层</strong></h4>
<p>MobSF、class-dump</p>
<h4 data-id="heading-24"><strong>加固层（核心能力）</strong></h4>
<p>Ipa Guard CLI</p>
<ul>
<li>无需源码混淆</li>
<li>资源扰动</li>
<li>方法/类名变量名混淆</li>
<li>全平台支持</li>
<li>可用于渠道包、小版本快速处理</li>
</ul>
<h4 data-id="heading-25"><strong>验证层</strong></h4>
<p>kxsign（重签）、Frida（动态 Hook 测试）、Hopper（反编译验证）</p>
<h4 data-id="heading-26"><strong>治理层</strong></h4>
<p>KMS、Bugly/Sentry、Git 加密仓库</p>
<p>即使没有源码，也能构建一个完整、可维护、可回滚的 iOS 加固体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apache Geaflow推理框架Geaflow-infer 解析系列（七）数据读写流程]]></title>    <link>https://juejin.cn/post/7576681897297903631</link>    <guid>https://juejin.cn/post/7576681897297903631</guid>    <pubDate>2025-11-26T09:12:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576681897297903631" data-draft-id="7576827115968069667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apache Geaflow推理框架Geaflow-infer 解析系列（七）数据读写流程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T09:12:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apache Geaflow推理框架Geaflow-infer 解析系列（七）数据读写流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T09:12:35.000Z" title="Wed Nov 26 2025 09:12:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第7章：数据读写流程</h2>
<h3 data-id="heading-1">章节导读</h3>
<p>本章讲解 <code>InferDataWriter</code> 和 <code>InferDataReader</code> 如何在共享内存上进行高效的数据读写。理解本章内容，你将掌握：</p>
<ul>
<li>数据帧格式（4字节长度 + 数据体）</li>
<li>字节序处理（Little Endian）</li>
<li>流式 I/O 与缓冲区管理</li>
</ul>
<h5 data-id="heading-2">核心设计</h5>
<pre><code class="hljs language-css" lang="css">✓ 自描述的数据帧（长度头）
✓ 统一的字节序约定
✓ 标准的 Java <span class="hljs-selector-tag">I</span>/O 接口
✓ 流式处理支持大数据
✓ 无锁高性能
</code></pre>
<hr/>
<h3 data-id="heading-3">7.1 InferDataWriter 实现</h3>
<h4 data-id="heading-4">核心职责</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InferDataWriter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Closeable</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">HEADER_LENGTH</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;  <span class="hljs-comment">// 4 字节长度头</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataQueueOutputStream outputStream;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] dataHeaderBytes;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ByteBuffer headerByteBuffer;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InferDataWriter</span><span class="hljs-params">(DataExchangeQueue queue)</span> {
        <span class="hljs-built_in">this</span>.outputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataQueueOutputStream</span>(queue);
        <span class="hljs-comment">// 准备长度头缓冲区</span>
        <span class="hljs-built_in">this</span>.dataHeaderBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[HEADER_LENGTH];
        <span class="hljs-built_in">this</span>.headerByteBuffer = ByteBuffer.wrap(dataHeaderBytes);
        <span class="hljs-built_in">this</span>.headerByteBuffer.order(ByteOrder.LITTLE_ENDIAN);
    }
    
    <span class="hljs-comment">/**
     * 写入单条记录
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] record)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">return</span> write(record, <span class="hljs-number">0</span>, record.length);
    }
    
    <span class="hljs-comment">/**
     * 写入部分数据（支持 offset）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] record, <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> length)</span> 
            <span class="hljs-keyword">throws</span> IOException {
        
        <span class="hljs-comment">// 总大小 = 4 字节长度头 + 数据体</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">outputSize</span> <span class="hljs-operator">=</span> HEADER_LENGTH + (length - offset);
        
        <span class="hljs-comment">// 1. 预留空间（无锁检查）</span>
        <span class="hljs-keyword">if</span> (!outputStream.tryReserveBeforeWrite(outputSize)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 队列已满</span>
        }
        
        <span class="hljs-comment">// 2. 生成长度头（Little Endian）</span>
        <span class="hljs-type">byte</span>[] headerData = extractHeaderData(length);
        
        <span class="hljs-comment">// 3. 先写长度头</span>
        outputStream.write(headerData, <span class="hljs-number">0</span>, HEADER_LENGTH);
        
        <span class="hljs-comment">// 4. 再写数据体</span>
        outputStream.write(record, offset, length);
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-comment">/**
     * 生成 Little Endian 长度头
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] extractHeaderData(<span class="hljs-type">int</span> length) {
        headerByteBuffer.clear();
        headerByteBuffer.putInt(length);
        <span class="hljs-keyword">return</span> dataHeaderBytes;
    }
}
</code></pre>
<h4 data-id="heading-5">数据帧格式</h4>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────────────────┐
│  InferDataWriter 写入的数据格式   │
├──────────────────────────────────┤
│ <span class="hljs-selector-attr">[4字节长度头 (Little Endian)]</span>     │
│  <span class="hljs-number">0</span>x0A <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00  → <span class="hljs-number">10</span>       │
│  (表示后续 <span class="hljs-number">10</span> 字节的数据)         │
├──────────────────────────────────┤
│ <span class="hljs-selector-attr">[数据体 10字节]</span>                   │
│  <span class="hljs-number">0</span>x48 <span class="hljs-number">0</span>x65 <span class="hljs-number">0</span>x6C <span class="hljs-number">0</span>x6C ...        │
│  (H    e    l    l    o    ...)  │
└──────────────────────────────────┘

示例: 序列化 <span class="hljs-string">"Hello World"</span> (<span class="hljs-number">11</span> 字节)

第一帧:
  Length: <span class="hljs-number">0</span>x0B <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00
  Data:   <span class="hljs-number">0</span>x48 <span class="hljs-number">0</span>x65 <span class="hljs-number">0</span>x6C <span class="hljs-number">0</span>x6C <span class="hljs-number">0</span>x6F <span class="hljs-number">0</span>x20 (H e l l o [space])

第二帧:
  Length: <span class="hljs-number">0</span>x05 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00
  Data:   <span class="hljs-number">0</span>x57 <span class="hljs-number">0</span>x6F <span class="hljs-number">0</span>x72 <span class="hljs-number">0</span>x6C <span class="hljs-number">0</span>x64 (W o r l d)
</code></pre>
<h4 data-id="heading-6">字节序处理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Little Endian vs Big Endian</span>

整数 <span class="hljs-number">0x12345678</span>

Big <span class="hljs-title function_">Endian</span> <span class="hljs-params">(网络字节序)</span>:
  ├─ <span class="hljs-type">byte</span> <span class="hljs-number">0</span>: <span class="hljs-number">0x12</span>
  ├─ <span class="hljs-type">byte</span> <span class="hljs-number">1</span>: <span class="hljs-number">0x34</span>
  ├─ <span class="hljs-type">byte</span> <span class="hljs-number">2</span>: <span class="hljs-number">0x56</span>
  └─ <span class="hljs-type">byte</span> <span class="hljs-number">3</span>: <span class="hljs-number">0x78</span>

Little <span class="hljs-title function_">Endian</span> <span class="hljs-params">(x86/ARM 原生)</span>:
  ├─ <span class="hljs-type">byte</span> <span class="hljs-number">0</span>: <span class="hljs-number">0x78</span>
  ├─ <span class="hljs-type">byte</span> <span class="hljs-number">1</span>: <span class="hljs-number">0x56</span>
  ├─ <span class="hljs-type">byte</span> <span class="hljs-number">2</span>: <span class="hljs-number">0x34</span>
  └─ <span class="hljs-type">byte</span> <span class="hljs-number">3</span>: <span class="hljs-number">0x12</span>

<span class="hljs-comment">// Java ByteBuffer 支持两种方式</span>
<span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">bb</span> <span class="hljs-operator">=</span> ByteBuffer.wrap(bytes);

<span class="hljs-comment">// 方式 1: Big Endian (默认)</span>
bb.putInt(<span class="hljs-number">0x12345678</span>);  
<span class="hljs-comment">// 结果: [0x12, 0x34, 0x56, 0x78]</span>

<span class="hljs-comment">// 方式 2: Little Endian (GeaFlow 使用)</span>
bb.order(ByteOrder.LITTLE_ENDIAN);
bb.putInt(<span class="hljs-number">0x12345678</span>);
<span class="hljs-comment">// 结果: [0x78, 0x56, 0x34, 0x12]</span>

<span class="hljs-comment">// 为什么选择 Little Endian?</span>
<span class="hljs-comment">// ✓ x86/ARM 处理器原生支持</span>
<span class="hljs-comment">// ✓ 避免字节序转换开销</span>
<span class="hljs-comment">// ✓ Java 和 Python mmap 都能快速访问</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">7.2 InferDataReader 实现</h3>
<h4 data-id="heading-8">核心职责</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InferDataReader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Closeable</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">HEADER_LENGTH</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataInputStream input;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">END</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">false</span>);
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InferDataReader</span><span class="hljs-params">(DataExchangeQueue queue)</span> {
        <span class="hljs-type">DataQueueInputStream</span> <span class="hljs-variable">dataQueueInputStream</span> <span class="hljs-operator">=</span> 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataQueueInputStream</span>(queue);
        <span class="hljs-built_in">this</span>.input = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataInputStream</span>(dataQueueInputStream);
    }
    
    <span class="hljs-comment">/**
     * 读取一条记录
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] read() <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-comment">// 1. 读取 4 字节长度头</span>
        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[HEADER_LENGTH];
        <span class="hljs-type">int</span> <span class="hljs-variable">bytesNum</span> <span class="hljs-operator">=</span> input.read(buffer);
        
        <span class="hljs-comment">// 处理 EOF 或读取失败</span>
        <span class="hljs-keyword">if</span> (bytesNum &lt; <span class="hljs-number">0</span>) {
            END.set(<span class="hljs-literal">true</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-comment">// 如果长度头未读完，继续读</span>
        <span class="hljs-keyword">if</span> (bytesNum &lt; buffer.length) {
            input.readFully(buffer, bytesNum, buffer.length - bytesNum);
        }
        
        <span class="hljs-comment">// 2. 解析长度（Little Endian）</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> fromInt32LE(buffer);
        
        <span class="hljs-comment">// 3. 读取数据体</span>
        <span class="hljs-type">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[len];
        input.readFully(data);  <span class="hljs-comment">// 阻塞直到读满</span>
        
        <span class="hljs-keyword">return</span> data;
    }
    
    <span class="hljs-comment">/**
     * 从 Little Endian 字节转换为整数
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fromInt32LE</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> {
        <span class="hljs-keyword">return</span> (bytes[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xFF</span>) 
            | ((bytes[<span class="hljs-number">1</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">8</span>) 
            | ((bytes[<span class="hljs-number">2</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">16</span>) 
            | ((bytes[<span class="hljs-number">3</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">24</span>);
    }
}
</code></pre>
<h4 data-id="heading-9">读取流程</h4>
<pre><code class="hljs language-scss" lang="scss">DataQueueInputStream
  ↓
底层连接到 DataExchangeQueue
  ├─ 轮询等待数据
  ├─ 当数据到达时，返回
  └─ 支持阻塞/超时

DataInputStream
  ↓
包装 DataQueueInputStream
  ├─ 提供缓冲 <span class="hljs-selector-tag">I</span>/O
  ├─ <span class="hljs-built_in">readFully</span>() 确保读足 N 字节
  └─ 处理 EOF 和错误
</code></pre>
<hr/>
<h3 data-id="heading-10">7.3 数据帧设计的优雅性</h3>
<h4 data-id="heading-11">为什么要有长度头？</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">方案</span> <span class="hljs-attr">1:</span> <span class="hljs-string">无长度头（直接写数据）</span>
  <span class="hljs-string">问题:</span> <span class="hljs-string">Reader</span> <span class="hljs-string">不知道何时停止</span>
  <span class="hljs-attr">Example:</span>
    <span class="hljs-string">Writer</span> <span class="hljs-string">写入:</span> [<span class="hljs-number">0x48</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0x6F</span>]
    <span class="hljs-string">Reader</span> <span class="hljs-string">读取:</span> <span class="hljs-string">应该读</span> <span class="hljs-number">5</span> <span class="hljs-string">个字节还是</span> <span class="hljs-number">10</span> <span class="hljs-string">个？无法判断</span>

<span class="hljs-string">方案</span> <span class="hljs-attr">2:</span> <span class="hljs-string">有长度头（推荐）</span>
  <span class="hljs-string">优点:</span> <span class="hljs-string">数据自描述，Reader</span> <span class="hljs-string">知道何时停止</span>
  <span class="hljs-attr">Example:</span>
    <span class="hljs-string">Writer</span> <span class="hljs-string">写入:</span> [<span class="hljs-number">0x05</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>][<span class="hljs-number">0x48</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0x6F</span>]
    <span class="hljs-attr">Reader:</span> <span class="hljs-string">先读</span> <span class="hljs-number">4</span> <span class="hljs-string">字节长度</span> <span class="hljs-string">=</span> <span class="hljs-number">5</span><span class="hljs-string">，再读</span> <span class="hljs-number">5</span> <span class="hljs-string">字节数据</span> <span class="hljs-string">✓</span>

<span class="hljs-string">方案</span> <span class="hljs-attr">3:</span> <span class="hljs-string">分界符（不推荐）</span>
  <span class="hljs-string">问题:</span> <span class="hljs-string">数据可能包含分界符，需要转义</span>
  <span class="hljs-string">复杂度:</span> <span class="hljs-string">高</span>
</code></pre>
<h4 data-id="heading-12">字节序的必要性</h4>
<pre><code class="hljs language-ini" lang="ini">场景 1: Java 写，Python 读（都用 Little Endian）
  Java:   int <span class="hljs-attr">length</span> = <span class="hljs-number">10</span>
          将其编码为 <span class="hljs-section">[0x0A, 0x00, 0x00, 0x00]</span>
          写入共享内存
  
  Python: 从共享内存读取 <span class="hljs-section">[0x0A, 0x00, 0x00, 0x00]</span>
          使用 struct.unpack('&lt;I', ...) 解析
          得到 10 ✓

场景 2: 如果 Java 用 Big Endian, Python 用 Little Endian
  Java:   int <span class="hljs-attr">length</span> = <span class="hljs-number">10</span>
          编码为 <span class="hljs-section">[0x00, 0x00, 0x00, 0x0A]</span>  ← Big Endian
          写入共享内存
  
  Python: 从共享内存读取 <span class="hljs-section">[0x00, 0x00, 0x00, 0x0A]</span>
          使用 struct.unpack('&lt;I', ...) 解析
          得到 167772160 ✗ 完全错误!

结论: 双方必须约定同一种字节序
</code></pre>
<hr/>
<h3 data-id="heading-13">7.4 流式 I/O 与缓冲</h3>
<h4 data-id="heading-14">DataQueueOutputStream</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataQueueOutputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OutputStream</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataExchangeQueue queue;
    
    <span class="hljs-comment">/**
     * 预留空间（无锁检查）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReserveBeforeWrite</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span> {
        <span class="hljs-comment">// 检查队列是否有足够空间</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">writeIndex</span> <span class="hljs-operator">=</span> UNSAFE.getVolatileLong(<span class="hljs-built_in">this</span>, WRITE_PTR);
        <span class="hljs-type">long</span> <span class="hljs-variable">readIndex</span> <span class="hljs-operator">=</span> UNSAFE.getVolatileLong(<span class="hljs-built_in">this</span>, READ_PTR);
        
        <span class="hljs-type">long</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> (readIndex + capacity) - writeIndex;
        <span class="hljs-keyword">return</span> available &gt;= size;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-type">int</span> b)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1</span>];
        bytes[<span class="hljs-number">0</span>] = (<span class="hljs-type">byte</span>) b;
        write(bytes);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] b, <span class="hljs-type">int</span> off, <span class="hljs-type">int</span> len)</span> 
            <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-comment">// 调用 DataExchangeQueue 的底层写方法</span>
        queue.put(b, off, len);
    }
}
</code></pre>
<h4 data-id="heading-15">DataQueueInputStream</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataQueueInputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputStream</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataExchangeQueue queue;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">DEFAULT_TIMEOUT</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 1 秒</span>
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1</span>];
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> read(buffer);
        <span class="hljs-keyword">return</span> n &gt; <span class="hljs-number">0</span> ? buffer[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xFF</span> : -<span class="hljs-number">1</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] b, <span class="hljs-type">int</span> off, <span class="hljs-type">int</span> len)</span> 
            <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-comment">// 轮询等待数据（带超时）</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-type">byte</span>[] data = queue.get();  <span class="hljs-comment">// 非阻塞</span>
            
            <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">null</span>) {
                System.arraycopy(data, <span class="hljs-number">0</span>, b, off, len);
                <span class="hljs-keyword">return</span> len;
            }
            
            <span class="hljs-comment">// 超时检查</span>
            <span class="hljs-keyword">if</span> (System.currentTimeMillis() - startTime 
                    &gt; DEFAULT_TIMEOUT) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SocketTimeoutException</span>(
                    <span class="hljs-string">"读取队列数据超时"</span>);
            }
            
            Thread.sleep(<span class="hljs-number">10</span>);  <span class="hljs-comment">// 让出 CPU，避免忙轮询</span>
        }
    }
}
</code></pre>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[书海拾遗：《枪炮、病菌与钢铁》]]></title>    <link>https://juejin.cn/post/7576843726011039770</link>    <guid>https://juejin.cn/post/7576843726011039770</guid>    <pubDate>2025-11-26T09:12:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576843726011039770" data-draft-id="7575363120798826496" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="书海拾遗：《枪炮、病菌与钢铁》"/> <meta itemprop="keywords" content="电子书,笔记"/> <meta itemprop="datePublished" content="2025-11-26T09:12:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="凉凉的知识库"/> <meta itemprop="url" content="https://juejin.cn/user/3280598428311326"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            书海拾遗：《枪炮、病菌与钢铁》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598428311326/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    凉凉的知识库
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T09:12:54.000Z" title="Wed Nov 26 2025 09:12:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>《枪炮、病菌与钢铁》推荐的人非常多，最近终于花时间读完了本书。其中许多观点确实让人耳目一新。实际上作者的观点在书中都有着严谨的推理和证明，受限于篇幅我只是非常简陋的概括了本书作者的结论，如果你对这些观点感兴趣，强烈建议你仔细的阅读原书</p>
</blockquote>
<p>《枪炮、病菌与钢铁》是贾雷德·戴蒙德（Jared Diamond）1997年出版的著作，1998年即获得普利策奖。作者是美国演化生物学家、生理学家与地理学家，美国国家科学院院士。本书核心的解释了这样的一个问题：为何在过去13,000年间，不同大陆的人类社会呈现出如此巨大的发展差异？为何是欧亚大陆文明征服了美洲、非洲和大洋洲，而不是相反。</p>
<p>是因为不同地区技术发展差异导致的么？那技术差异是如何产生的？是不同地区的文化、制度差异导致的么？那不同的文化、制度差异又是如何产生的？作者戴蒙德希望探寻这一切的终极因，在全书开篇即亮出了颠覆性的核心观点：“不同民族的历史遵循不同的道路前进，其原因是地理环境的差异，而不是民族自身在生物学上的差异”</p>
<p>各大洲的环境有许多不同的特征，每个特征都能影响人类历史的发展，作者认为其中四组是最重要的。</p>
<p><strong>第一组因素是环境差异，各大洲上可供驯化的动植物资源不同。</strong> 全球仅有少数几个独立农业起源中心，其他地区的主要作物和大型家畜都是从发源地传播而来，这并不是因为各地区种族驯化动植物的能力差距，而是驯化资源的分布不均。</p>
<p>作者给出的理由之一是即使现代社会科技发展水平如此之高，人类并没有驯化出更多的动植物。因为驯化的候选动物必须具备许多特质才能脱颖而出（作者也分析了哪些特质这里不赘述），少了任何一点都有可能功败垂成。以可供驯化的生物资源来说，欧亚大陆最得天独厚，非洲次之，美洲就差多了，而澳大利亚简直是不毛之地，这种农业发展时间差为欧亚大陆文明赢得了关键发展先机。</p>
<p>食物生产非常重要，相比狩猎—采集方式，农业产出更多食物的同时需要人们定居，促成了人口密度的增加，盈余的食物又可以来供养不事生产的专家或者官僚，人类族群逐步从简单的人人平等的游族不断演进到部落、酋邦、国家，形成复杂的社会制度。</p>
<p>定居、集权、社会分层、经济复杂、技术创新的社会，专家可以技术创新发明工具、文字或者武器提升农业与军事水平，官僚阶级可以趋势奴隶与军队修建大型农业设施或对外战争。最早豢养家畜的人类还会和家养动物一起演化的病菌，当这些拥有抗体的人与从来不曾感染过这类病菌的人们接触时会造成传染病的大流行。</p>
<p>作物和牲畜的有无，从根本上解释了为何帝国、文字、钢铁武器最早在欧亚大陆出现，而在其他地方较晚甚至没有出现。再加上马匹和骆驼在军事上的作用，以及源自动物的病菌的杀伤力，足以征服其他落后的族群。</p>
<p><strong>第二组因素是影响传播与迁徙速度的条件，各大洲在这方面有很大的差异。</strong> 在欧亚大陆上，传播与迁徙的速度最快，因为欧亚大陆的大陆轴线是东西向的，而且生态与地理障碍比较少。对牲口与农作物的传播而言，发育、滋长受气候的影响，而气候又受纬度影响。相比于非洲南北向轴线，不同地区的气候不同，严重阻碍了农业技术的传播。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56d5aae71c7c456c94734ec269cf6a73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YeJ5YeJ55qE55-l6K-G5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753591&amp;x-signature=Q2sPgSvQDyrNy2EKi4DewHnxa8M%3D" alt="世界地图" loading="lazy"/></p>
<p><strong>第三组因素是各大洲之间传播的难易程度不同</strong>。作物、牲口、技术，也可以通过各大洲之间的传播获得，从欧亚大陆到撒哈拉以南非洲的传播是最容易的，澳大利亚土著与欧亚大陆隔着大洋难度最大。</p>
<p><strong>第四组也是最后一组因素，是各大洲在面积或人口总数上的差异。</strong> 面积越大、人口总数越多的大洲，发明家越多，相互竞争的社会越多，创新也越多——采借和保持创新的压力更大，因为不这么做就会被竞争对手淘汰。世界上的各个陆块中，欧亚大陆的面积最大，相互竞争的社会数量也最多。美洲的面积虽然很大，在地理和生态上却很碎片化，实际上像是没有紧密联系的几个小陆块。</p>
<p>由此构建了清晰的因果关系链：各大陆不同的地理环境条件（尤其是可驯化动植物资源）→ 粮食生产出现时间与传播速度差异 → 人口密度、社会分工与技术创新差异 → 枪炮、病菌与钢铁的发展不平衡 → 欧洲对美洲等地的征服。</p>
<p>虽然作者士在书中把环境因素视为历史发展的终极因，但他也认识到环境因素不可能是唯一的，历史系统即使有终极的确定性，也仍旧是复杂、不可预测的。但通过把人类社会的历史可以当作科学来研究，就像研究恐龙一样，我们的收获对当今的社会有益，因为我们会明白什么塑造了现代世界，什么又可能塑造我们的未来。</p>
<hr/>
<p>✨ 微信公众号【<strong>凉凉的知识库</strong>】同步更新，欢迎关注获取最新最有用的知识 ✨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[美团2026届后端一二面（附详细参考答案）]]></title>    <link>https://juejin.cn/post/7576853741757300770</link>    <guid>https://juejin.cn/post/7576853741757300770</guid>    <pubDate>2025-11-26T09:16:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576853741757300770" data-draft-id="7576827115968102435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="美团2026届后端一二面（附详细参考答案）"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-26T09:16:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JavaGuide"/> <meta itemprop="url" content="https://juejin.cn/user/166781497383294"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            美团2026届后端一二面（附详细参考答案）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781497383294/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JavaGuide
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T09:16:09.000Z" title="Wed Nov 26 2025 09:16:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2026 届秋招陆续开奖公司的越来越多了，大家比较期待的美团也开了！</p>
<p>根据网上已经爆出的薪资来看，下面是美团后端和其他部分岗位今年已经开奖的薪资情况：</p>
<ul>
<li>后端：23k * 15.5，北京，白菜，</li>
<li>后端：（25~26)k * 15.5，北京，小 SP</li>
<li>后端：28k * 15.5，北京，大 SP，</li>
<li>后端：（30~32）k * 15.5，北京，SSP</li>
<li>前端：23k * 15.5，北京，白菜</li>
<li>测开：23K*15.5，北京，白菜</li>
<li>大模型（北斗计划）：48*15.5，北京</li>
</ul>
<p>和去年开的差不多，区别不大！后端白菜年包也有接近 35.5w+ ，还是不错的。美团的公积金缴纳比例各地不同，北京可达 12%，上海为 7%，成都为 8%。</p>
<p>美团对新人的培养还是不错的，有很多培训的课程，公司里也有很多技术大佬。你平时如果看美团技术团队的文章的话，应该对美团的技术水平是比较认可的。团队氛围的话，这个要看具体的项目组，大部分应该都是比较和谐的。</p>
<p>下面是星球里一位在美团实习并转正的球友对美团的一些感受：</p>
<blockquote>
<p>刚进入美团实习时，我对美团的完善的基研体系感到震惊（相较于学校而言）。大部分时候，我们可以直接使用现成的解决方案，而不需要重复造轮子。此外，美团还有完善的内部文档系统，大家都写得很好（这点让我有点卷）。在实习的三个月里，我也经历了一些困难和压力，但是我意识到打工就是这样，不管去哪里都是一样的。在实习期间，我更多地学习了一些思维方式，坚信只要我不会的东西，我就可以学会。每天都取得一点进步，保持前进。</p>
</blockquote>
<p>今年秋招也有不少球友进了美团。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11ec095ca4e1489bbe931de9f663550e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753368&amp;x-signature=W9FDgNEk4YNIhT4ovfSYJZLXRjQ%3D" alt="" loading="lazy"/></p>
<p>美团的面试难度还是相对偏高一点的，技术一面和二面可能加起来能拷打你两个多小时。</p>
<p>下面给大家分享一篇美团今年秋招的后端面经。我精选了一二面中的一些比较典型的面试问题进行解答， 大家可以感受一下美团的面试难度如何。</p>
<h2 data-id="heading-0">拷打项目</h2>
<p>面试对着项目提问架构设计以及一些功能的开发思路。</p>
<p>这里记录一些比较有代表性的项目拷打问题，涉及太项目细节的部分就省略了。</p>
<h3 data-id="heading-1">你为什么选择 JWT 做身份验证？</h3>
<p>相比于 Session 认证的方式来说，使用 JWT 进行身份认证主要有下面 4 个优势：</p>
<ol>
<li><strong>无状态</strong>：JWT 自身包含了身份验证所需要的所有信息，因此，我们的服务器不需要存储 Session 信息。这显然增加了系统的可用性和伸缩性，大大减轻了服务端的压力。不过，也正是由于 JWT 的无状态，也导致了它最大的缺点：<strong>不可控！</strong></li>
<li><strong>有效避免了 CSRF 攻击</strong>：使用 JWT 进行身份验证不需要依赖 Cookie ，因此可以避免 CSRF 攻击。</li>
<li><strong>适合移动端应用</strong>：使用 Session 进行身份认证的话，需要保存一份信息在服务器端，而且这种方式会依赖到 Cookie（需要 Cookie 保存 <code>SessionId</code>），所以不适合移动端。但是，使用 JWT 进行身份认证就不会存在这种问题，因为只要 JWT 可以被客户端存储就能够使用，而且 JWT 还可以跨语言使用。</li>
<li><strong>单点登录友好</strong>：使用 Session 进行身份认证的话，实现单点登录，需要我们把用户的 Session 信息保存在一台电脑上，并且还会遇到常见的 Cookie 跨域的问题。但是，使用 JWT 进行认证的话， JWT 被保存在客户端，不会存在这些问题。</li>
</ol>
<p>但 JWT 并不是银弹，依然存在很多问题需要解决，例如：</p>
<ol>
<li><strong>注销登录等场景下 JWT 还有效</strong>：这个问题不存在于 Session 认证方式中，因为在 Session 认证方式中，遇到这种情况的话服务端删除对应的 Session 记录即可。但是，使用 JWT 认证的方式就不好解决了。我们也说过了，JWT 一旦派发出去，如果后端不增加其他逻辑的话，它在失效之前都是有效的。</li>
<li><strong>续签问题</strong>：JWT 通常有一个有效期（<code>exp</code> 字段），当令牌过期时，用户需要重新登录或获取一个新的令牌，这就是所谓的续签（refresh）问题。</li>
<li><strong>JWT 体积太大</strong>：JWT 结构复杂（Header、Payload 和 Signature），包含了更多额外的信息，还需要进行 Base64Url 编码，这会使得 JWT 体积较大，增加了网络传输的开销。</li>
</ol>
<p>实际项目中，不用 JWT 直接使用普通的 Token(随机生成的 ID，不包含具体的信息) 结合 Redis 来做身份认证也是可以的。传统的 Token 通常只是一个唯一标识符，对应的信息（例如用户 ID、Token 过期时间、权限信息）存储在服务端，通常会通过 Redis 保存。传统 Token 体积更小，也更容易解决 JWT 存在的一些问题。</p>
<p>关于 JWT 的详细介绍以及常见问题的解决可以阅读我写的这两篇文章：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fsystem-design%2Fsecurity%2Fjwt-intro.html" target="_blank" title="https://javaguide.cn/system-design/security/jwt-intro.html" ref="nofollow noopener noreferrer">JWT 基础概念详解</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fsystem-design%2Fsecurity%2Fadvantages-and-disadvantages-of-jwt.html" target="_blank" title="https://javaguide.cn/system-design/security/advantages-and-disadvantages-of-jwt.html" ref="nofollow noopener noreferrer">JWT 身份认证优缺点分析</a></li>
</ul>
<h3 data-id="heading-2">敏感词脱敏如何实现的？</h3>
<p>后端返回数据给前端的时候，一般需要对敏感词脱敏，类似于下面这样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1aa14b01e5a248659b9aa1df73610a24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753368&amp;x-signature=xb4PvQUciKIkHApPuXYl%2BNnzn9o%3D" alt="" loading="lazy"/></p>
<p>脱敏的规则有很多种，例如：</p>
<ul>
<li>替换(常用)：将敏感数据中的特定字符或字符序列替换为其他字符。例如，将信用卡号中的中间几位数字替换为星号（*）或其他字符。</li>
<li>删除：将敏感数据中的部分内容随机删除。例如，将电话号码的随机 3 位数字进行删除。</li>
<li>重排：将原始数据中的某些字符或字段的顺序打乱。例如，将身份证号码的随机位交错互换。</li>
<li>加噪：在数据中注入一些误差或者噪音，达到对数据脱敏的效果。例如，在敏感数据中添加一些随机生成的字符。</li>
<li>......</li>
</ul>
<p>这里以最常用的替换为例进行介绍，这也是我的项目用到的方法。</p>
<p>我是利用 Hutool 提供的 <code>DesensitizedUtil</code>脱敏工具类配合 Jackson 通过注解的方式完成数据脱敏的。</p>
<p>如果不想引入 Hutool 的话，也可以自己实现一个脱敏工具类，实现逻辑非常简单。</p>
<p>详细介绍可以看笔者写的这篇文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FvVhB8uJBz4WMlOZHJ2Zbog" target="_blank" title="https://mp.weixin.qq.com/s/vVhB8uJBz4WMlOZHJ2Zbog" ref="nofollow noopener noreferrer">你的项目敏感词脱敏是如何实现的？</a> 。</p>
<h3 data-id="heading-3">讲一下 MySQL 同步 ES 的实现</h3>
<p>使用 Canal 可以做到业务代码完全解耦，API 完全解耦，零代码实现准实时同步, Canal 通过解析 MySQL 的 binlog 日志文件进行数据同步。</p>
<p>Canal 的原理本质上是 <strong>模拟了 MySQL 的主从复制协议</strong> ：</p>
<ol>
<li><strong>伪装成从库 (Slave)：</strong> Canal Server 会向 MySQL Master 发送和标准 MySQL Slave 完全一样的握手包，将自己伪装成一个从库。</li>
<li><strong>订阅 Binlog：</strong> MySQL Master 验证通过后，就会把它当成一个真正的从库。从 Canal 指定的位点（Position 或 GTID）开始，持续地、流式地把二进制日志（Binlog）推送给 Canal。Binlog 记录了数据库中所有的数据变更操作（INSERT, UPDATE, DELETE）。</li>
<li><strong>解析与投递：</strong> Canal 接收到这些原始的二进制日志流后，会在内部进行解析，将它们转换成结构化的、易于消费的数据格式（比如 JSON）。最后，再将这些结构化的变更事件投递出去，通常是投递到像 Kafka 或 RocketMQ 这样的消息队列中，由下游的消费程序（比如我们的同步服务）订阅并写入到 Elasticsearch。</li>
</ol>
<p>不过，Canal 仅仅支持增量同步。实际项目中，可以借助全量导入工具实现全量同步，例如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2FDataX" target="_blank" title="https://github.com/alibaba/DataX" ref="nofollow noopener noreferrer">Datax</a> ，后续再通过 Canal 实现增量同步，相对比较麻烦。</p>
<p>为了进一步提高系统性能和可维护性，我们通常会引入消息队列 (MQ) 作为中间层，解耦 Canal 和 Elasticsearch，</p>
<p>引入 MQ 的优势:</p>
<ul>
<li><strong>异步处理:</strong> Canal 将数据变更消息发送到 MQ 后，无需等待 ES 处理完成即可返回，提高 Canal 的吞吐量。</li>
<li><strong>流量控制:</strong> MQ 作为缓冲区，可以削峰填谷，避免 Elasticsearch 瞬时写入压力过大。</li>
<li><strong>数据处理:</strong> 可以在消费 MQ 消息的过程中进行数据清洗、转换等操作，例如数据格式化、字段映射等。</li>
<li><strong>系统解耦:</strong> Canal 和 Elasticsearch 之间不再直接依赖，提高系统的可扩展性和可维护性。</li>
</ul>
<p>引入 MQ 后，MySQL 数据同步到 Elasticsearch 的流程如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4374febf287491da7a99c3d9fea60fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753368&amp;x-signature=9IjbF4vEorQyUbGKA9owS42guGU%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>监听解析:</strong> Canal 读取 binlog，解析变更事件。</li>
<li><strong>发送消息:</strong> Canal 将事件封装成消息发送到 MQ。</li>
<li><strong>消费消息:</strong> 消费端监听 MQ，获取变更消息。</li>
<li><strong>同步数据:</strong> 消费端处理消息，更新 Elasticsearch 索引。</li>
</ol>
<p>Canal 从 1.1.1 版本开始，默认支持将接收到的 binlog 数据直接投递到 MQ，简化了集成流程。 你只需要配置 Canal 连接 MQ 的相关信息，即可实现 Canal 与 MQ 的联动。</p>
<h3 data-id="heading-4">项目中用了哪些多线程的知识</h3>
<p>在我们的订单系统中，用户下单成功后，系统需要执行一系列非核心的后续操作，比如：发送下单成功短信、为用户增加积分、通知物流系统备货。这些操作都比较耗时，如果让用户在下单接口里同步等待它们全部完成，会导致接口响应时间变得很长，体验很差。</p>
<p>我的解决方案是， 将这些非核心操作全部抽取成独立的 Service 方法，并用 <code>@Async</code> 注解标记，将它们异步化。这样，主下单流程可以迅速完成并向用户返回成功，而这些耗时操作则被提交到后台线程池中慢慢执行，极大地优化了主流程的性能和用户体验。</p>
<p><code>@Async</code> 注解由 Spring 框架提供，被该注解标注的类或方法会在 <strong>异步线程</strong> 中执行。这意味着当方法被调用时，调用者将不会等待该方法执行完成，而是可以继续执行后续的代码。</p>
<p><code>@Async</code> 注解的使用非常简单，需要两个步骤：</p>
<ol>
<li>在启动类上添加注解 <code>@EnableAsync</code> ，开启异步任务。</li>
<li>在需要异步执行的方法或类上添加注解 <code>@Async</code> 。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-comment">// 开启异步任务</span>
<span class="hljs-meta">@EnableAsync</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YourApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(YourApplication.class, args);
    }
}

<span class="hljs-comment">// 异步服务类</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> {

    <span class="hljs-comment">// 推荐使用自定义线程池，这里只是演示基本用法</span>
    <span class="hljs-meta">@Async</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">doSomethingAsync</span><span class="hljs-params">()</span> {

        <span class="hljs-comment">// 这里会有一些业务耗时操作</span>
        <span class="hljs-comment">// ...</span>
        <span class="hljs-comment">// 使用 CompletableFuture 可以更方便地处理异步任务的结果，避免阻塞主线程</span>
        <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-string">"Async Task Completed"</span>);
    }

}
</code></pre>
<h3 data-id="heading-5">使用 @Async 注解实现异步有什么需要注意的吗？执行出现异常怎么办？</h3>
<p>如果没有显式地配置线程池，在 <code>@Async</code> 底层会先在 <code>BeanFactory</code> 中尝试获取线程池，如果获取不到，则会创建一个 <code>SimpleAsyncTaskExecutor</code> 实现。<code>SimpleAsyncTaskExecutor</code> 本质上不算是一个真正的线程池，因为它对于每个请求都会启动一个新线程而不重用现有线程，这会带来一些潜在的问题，例如资源消耗过大。</p>
<p>一定要显式配置一个线程池，推荐<code>ThreadPoolTaskExecutor</code>。并且，还可以根据任务的性质和需求，为不同的异步方法指定不同的线程池。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAsync</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConfig</span> {

    <span class="hljs-meta">@Bean(name = "executor1")</span>
    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">executor1</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.setCorePoolSize(<span class="hljs-number">3</span>);
        executor.setMaxPoolSize(<span class="hljs-number">5</span>);
        executor.setQueueCapacity(<span class="hljs-number">50</span>);
        executor.setThreadNamePrefix(<span class="hljs-string">"AsyncExecutor1-"</span>);
        executor.initialize();
        <span class="hljs-keyword">return</span> executor;
    }

    <span class="hljs-meta">@Bean(name = "executor2")</span>
    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">executor2</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.setCorePoolSize(<span class="hljs-number">2</span>);
        executor.setMaxPoolSize(<span class="hljs-number">4</span>);
        executor.setQueueCapacity(<span class="hljs-number">100</span>);
        executor.setThreadNamePrefix(<span class="hljs-string">"AsyncExecutor2-"</span>);
        executor.initialize();
        <span class="hljs-keyword">return</span> executor;
    }
}
</code></pre>
<p>异步方法中抛出的异常默认不会被调用者捕获。为了管理这些异常，建议使用<code>CompletableFuture</code>的异常处理功能，或者配置一个全局的<code>AsyncUncaughtExceptionHandler</code>来处理没有正确捕获的异常。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAsync</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncConfigurer</span>{

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> AsyncUncaughtExceptionHandler <span class="hljs-title function_">getAsyncUncaughtExceptionHandler</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomAsyncExceptionHandler</span>();
    }

}

<span class="hljs-comment">// 自定义异常处理器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomAsyncExceptionHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncUncaughtExceptionHandler</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleUncaughtException</span><span class="hljs-params">(Throwable ex, Method method, Object... params)</span> {
        <span class="hljs-comment">// 日志记录或其他处理逻辑</span>
    }
}
</code></pre>
<p>JavaGuide 网站对这块内容有详细介绍，感兴趣可以看看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fsystem-design%2Fframework%2Fspring%2Fasync.html" target="_blank" title="https://javaguide.cn/system-design/framework/spring/async.html" ref="nofollow noopener noreferrer">Async 注解原理分析</a>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8a95788770049708b27f5823fcb8899~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753368&amp;x-signature=PspGW8DNLpTpN3W7rfgRpao9Bvc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">怎么使用 Arthas 排查问题的？</h3>
<p>可以参考笔者分享的这篇文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fgi5IovECxwpX3v6OcMbQxA" target="_blank" title="https://mp.weixin.qq.com/s/gi5IovECxwpX3v6OcMbQxA" ref="nofollow noopener noreferrer">自从学会 Arthas，日常开发效率直接起飞！</a>。</p>
<h3 data-id="heading-7">项目中 Jmeter 压测是怎么做的</h3>
<p>做 JMeter 压测，主要遵循四步流程：</p>
<ol>
<li><strong>规划</strong>：会先定好明确的性能目标，比如 QPS 要达到多少，响应时间要低于多少。</li>
<li><strong>准备脚本</strong>：用 JMeter 写好请求脚本，并且对用户 ID、商品 ID 这些变量进行参数化，让请求更真实。</li>
<li><strong>执行和监控</strong> ：在用 JMeter 加压的同时，我们会重点监控服务器的 CPU、内存、GC 等指标。因为真正的瓶颈信息在服务器端，而不是在 JMeter 的报告里。</li>
<li><strong>分析和调优</strong> ： 压测结束后，我们会根据监控数据和报告来分析瓶颈。比如，如果是 CPU 高了，我们就用 Arthas 去看热点代码；如果是数据库慢了，就去优化 SQL。优化完再压一轮，直到达到目标为止。</li>
</ol>
<h2 data-id="heading-8">MySQL</h2>
<h3 data-id="heading-9">MySQL 存储引擎知道哪些，有什么区别?</h3>
<p>MySQL 支持多种存储引擎，你可以通过 <code>SHOW ENGINES</code> 命令来查看 MySQL 支持的所有存储引擎。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4370a86ad04844c0ac3ce0a63954d618~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753368&amp;x-signature=NFNWBdJctv97kb5ntAfJKwcXrRw%3D" alt="查看 MySQL 提供的所有存储引擎" loading="lazy"/></p>
<p>从上图我们可以查看出， MySQL 当前默认的存储引擎是 InnoDB。并且，所有的存储引擎中只有 InnoDB 是事务性存储引擎，也就是说只有 InnoDB 支持事务。</p>
<p>我这里使用的 MySQL 版本是 8.x，不同的 MySQL 版本之间可能会有差别。</p>
<p>MySQL 5.5.5 之前，MyISAM 是 MySQL 的默认存储引擎。5.5.5 版本之后，InnoDB 是 MySQL 的默认存储引擎。</p>
<p>你可以通过 <code>SELECT VERSION()</code> 命令查看你的 MySQL 版本。</p>
<pre><code class="hljs language-bash" lang="bash">mysql&gt; SELECT VERSION();
+-----------+
| VERSION() |
+-----------+
| 8.0.27    |
+-----------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)
</code></pre>
<p>你也可以通过 <code>SHOW VARIABLES LIKE '%storage_engine%'</code> 命令直接查看 MySQL 当前默认的存储引擎。</p>
<pre><code class="hljs language-bash" lang="bash">mysql&gt; SHOW VARIABLES  LIKE <span class="hljs-string">'%storage_engine%'</span>;
+---------------------------------+-----------+
| Variable_name                   | Value     |
+---------------------------------+-----------+
| default_storage_engine          | InnoDB    |
| default_tmp_storage_engine      | InnoDB    |
| disabled_storage_engines        |           |
| internal_tmp_mem_storage_engine | TempTable |
+---------------------------------+-----------+
4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)
</code></pre>
<p>关于 MyISAM 和 InnoDB 的对比内容较多，可以参考笔者写的这篇文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fdatabase%2Fmysql%2Fmysql-questions-01.html" target="_blank" title="https://javaguide.cn/database/mysql/mysql-questions-01.html" ref="nofollow noopener noreferrer">MySQL 常见面试题总结</a>（MySQL 基础、存储引擎、事务、索引、锁、性能优化等）。</p>
<p>更多 MySQL 高频知识点和面试题总结，可以阅读笔者写的这几篇文章：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fdatabase%2Fmysql%2Fmysql-index.html" target="_blank" title="https://javaguide.cn/database/mysql/mysql-index.html" ref="nofollow noopener noreferrer">MySQL 索引详解</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fdatabase%2Fmysql%2Fmysql-logs.html" target="_blank" title="https://javaguide.cn/database/mysql/mysql-logs.html" ref="nofollow noopener noreferrer">MySQL 三大日志(binlog、redo log 和 undo log)详解</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fdatabase%2Fmysql%2Ftransaction-isolation-level.html" target="_blank" title="https://javaguide.cn/database/mysql/transaction-isolation-level.html" ref="nofollow noopener noreferrer">MySQL 事务隔离级别详解</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fdatabase%2Fmysql%2Finnodb-implementation-of-mvcc.html" target="_blank" title="https://javaguide.cn/database/mysql/innodb-implementation-of-mvcc.html" ref="nofollow noopener noreferrer">InnoDB 存储引擎对 MVCC 的实现</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fdatabase%2Fmysql%2Fhow-sql-executed-in-mysql.html" target="_blank" title="https://javaguide.cn/database/mysql/how-sql-executed-in-mysql.html" ref="nofollow noopener noreferrer">SQL 语句在 MySQL 中的执行过程</a></li>
</ul>
<h3 data-id="heading-10">SELECT * 会导致索引失效吗？</h3>
<p><code>SELECT *</code> 不会直接导致索引失效（如果不走索引大概率是因为 where 查询范围过大导致的），但它可能会带来一些其他的性能问题比如造成网络传输和数据处理的浪费、无法使用索引覆盖。</p>
<h3 data-id="heading-11">索引失效的原因有哪些？</h3>
<ol>
<li>创建了组合索引，但查询条件未遵守最左匹配原则;</li>
<li>在索引列上进行计算、函数、类型转换等操作;</li>
<li>以 % 开头的 LIKE 查询比如 <code>LIKE '%abc';</code>;</li>
<li>查询条件中使用 OR，且 OR 的前后条件中有一个列没有索引，涉及的索引都不会被使用到;</li>
<li>IN 的取值范围较大时会导致索引失效，走全表扫描(NOT IN 和 IN 的失效场景相同);</li>
<li>发生<a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fdatabase%2Fmysql%2Findex-invalidation-caused-by-implicit-conversion.html" title="https://javaguide.cn/database/mysql/index-invalidation-caused-by-implicit-conversion.html" target="_blank" ref="nofollow noopener noreferrer">隐式转换</a>;</li>
</ol>
<h3 data-id="heading-12">MySQL 的默认隔离级别是什么?可以解决幻读问题吗？</h3>
<p>简化版参考答案：MySQL InnoDB 存储引擎的默认支持的隔离级别是 <strong>REPEATABLE-READ（可重读）</strong>。标准的 SQL 隔离级别定义里，REPEATABLE-READ(可重复读)是不可以防止幻读的，但 InnoDB 实现的 REPEATABLE-READ 隔离级别其实是可以解决幻读问题发生的。</p>
<p>详细参考答案：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FN4WHYAa00ZhDjMLaqnlgRQ" target="_blank" title="https://mp.weixin.qq.com/s/N4WHYAa00ZhDjMLaqnlgRQ" ref="nofollow noopener noreferrer">MySQL 的默认隔离级别是什么?可以解决幻读问题吗？</a></p>
<h2 data-id="heading-13">Redis</h2>
<h3 data-id="heading-14">为什么要用 Redis？</h3>
<h3 data-id="heading-15">项目中引入 Redis 具体做了哪些事情？</h3>
<p>Redis 除了可以用来缓存高频访问的数据之外，还以用来实现：</p>
<ul>
<li><strong>分布式锁</strong>：通过 Redis 来做分布式锁是一种比较常见的方式。通常情况下，我们都是基于 Redisson 来实现分布式锁。关于 Redis 实现分布式锁的详细介绍，可以看我写的这篇文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fy8kAflIenRpa4zIwCP_8iA" target="_blank" title="https://mp.weixin.qq.com/s/y8kAflIenRpa4zIwCP_8iA" ref="nofollow noopener noreferrer">如何基于 Redis 实现分布式锁？</a>。</li>
<li><strong>限流</strong>：一般是通过 Redis + Lua 脚本的方式来实现限流。如果不想自己写 Lua 脚本的话，也可以直接利用 Redisson 中的 <code>RRateLimiter</code> 来实现分布式限流，其底层实现就是基于 Lua 代码+令牌桶算法。</li>
<li><strong>消息队列</strong>：Redis 自带的 List 数据结构可以作为一个简单的队列使用。Redis 5.0 中增加的 Stream 类型的数据结构更加适合用来做消息队列。它比较类似于 Kafka，有主题和消费组的概念，支持消息持久化以及 ACK 机制。</li>
<li><strong>延时队列</strong>：Redisson 内置了延时队列（基于 Sorted Set 实现的）。</li>
<li><strong>分布式 Session</strong> ：利用 String 或者 Hash 数据类型保存 Session 数据，所有的服务器都可以访问。</li>
<li><strong>复杂业务场景</strong>：通过 Redis 以及 Redis 扩展（比如 Redisson）提供的数据结构，我们可以很方便地完成很多复杂的业务场景比如通过 Bitmap 统计活跃用户、通过 Sorted Set 维护排行榜。</li>
</ul>
<p>面试中，根据你项目的实际情况去回答即可！</p>
<p>更多 Redis 高频面试题总结，可以阅读笔者写的这两篇文章：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fdatabase%2Fredis%2Fredis-questions-01.html" target="_blank" title="https://javaguide.cn/database/redis/redis-questions-01.html" ref="nofollow noopener noreferrer">Redis 常见面试题总结（上）</a>（Redis 基础、应用、数据类型、持久化机制、线程模型等）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fdatabase%2Fredis%2Fredis-questions-02.html" target="_blank" title="https://javaguide.cn/database/redis/redis-questions-02.html" ref="nofollow noopener noreferrer">Redis 常见面试题总结(下)</a>（Redis 事务、性能优化、生产问题、集群、使用规范等）</li>
</ul>
<h3 data-id="heading-16">使用 HyperLogLog 统计页面 UV 怎么做的？</h3>
<p>使用 HyperLogLog 统计页面 UV 主要需要用到下面这两个命令：</p>
<ul>
<li><code>PFADD key element1 element2 ...</code>：添加一个或多个元素到 HyperLogLog 中。</li>
<li><code>PFCOUNT key1 key2</code>：获取一个或者多个 HyperLogLog 的唯一计数。</li>
</ul>
<p>1、将访问指定页面的每个用户 ID 添加到 <code>HyperLogLog</code> 中。</p>
<pre><code class="hljs language-bash" lang="bash">PFADD PAGE_1:UV USER1 USER2 ...... USERn
</code></pre>
<p>2、统计指定页面的 UV。</p>
<pre><code class="hljs language-bash" lang="bash">PFCOUNT PAGE_1:UV
</code></pre>
<h3 data-id="heading-17">如果缓存的数据量太大，内存不够用怎么办？</h3>
<ol>
<li><strong>垂直扩展（增加硬件配置）：</strong> 最直接的方式是升级现有 Redis 服务器的内存容量，选择配置更高、内存更大的服务器来部署 Redis 实例。 不过，这会受到硬件成本和单机内存容量上限的限制。</li>
<li><strong>水平扩展（Redis 切片集群）：</strong> Redis 切片集群就是部署多台 Redis 主节点（master），这些节点之间平等，并没有主从之说，同时对外提供读/写服务。缓存的数据库相对均匀地分布在这些 Redis 实例上，客户端的请求通过路由规则转发到目标 master 上。Redis 切片集群对于横向扩展非常友好，只需要增加 Redis 节点到集群中即可。</li>
</ol>
<h3 data-id="heading-18">Redis 切片集群如何实现？</h3>
<p>Redis 3.0 官方推出了分片集群解决方案 Redis Cluster 。经过多个版本的持续完善，Redis Cluster 成为 Redis 切片集群的首选方案，满足绝大部分高并发业务场景需求。</p>
<p>如果项目使用的是 Redis 3.0 之前的版本，可以使用 Twemproxy、Codis 这类开源分片集群方案。Twemproxy、Codis 就相当于是 Proxy 层，负责维护路由规则，实现负载均衡。</p>
<h2 data-id="heading-19">操作系统</h2>
<h3 data-id="heading-20">进程线程区别</h3>
<p>进程是操作系统分配资源的基本单位，具备独立的地址空间；线程是 CPU 调度的基本单位，复用所属进程的资源。二者核心差异在于隔离性与共享性：进程彼此隔离，线程间共享内存。引入线程的目的，是在单一应用内部实现低开销、高效率的并发，降低资源占用与通信成本，充分释放多核潜能。</p>
<p>详细介绍：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FyFggyRl3xYtGlHKVXWQDCw" target="_blank" title="https://mp.weixin.qq.com/s/yFggyRl3xYtGlHKVXWQDCw" ref="nofollow noopener noreferrer">进程和线程有什么区别？有了进程为什么还需要线程?</a>。</p>
<h3 data-id="heading-21">进程的调度算法有哪些?</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3967d1ed573543f193fe76971c85edb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753368&amp;x-signature=TyzZvJ8lTHCzSg1GKS7C2iXoLd4%3D" alt="常见进程调度算法" loading="lazy"/></p>
<p>进程调度算法的核心目标是决定就绪队列中的哪个进程应该获得 CPU 资源，其设计目标通常是在<strong>吞吐量、周转时间、响应时间</strong>和<strong>公平性</strong>之间做权衡。</p>
<p>我习惯将这些算法分为两大类：<strong>非抢占式</strong>和<strong>抢占式</strong>。</p>
<p><strong>第一类：非抢占式调度 (Non-Preemptive)</strong></p>
<p>这种方式下，一旦 CPU 分配给一个进程，它就会一直运行下去，直到任务完成或主动放弃（比如等待 I/O）。</p>
<ol>
<li><strong>先到先服务调度算法(FCFS，First Come, First Served)</strong> : 这是最简单的，就像排队，谁先来谁先用。优点是公平、实现简单。但缺点很明显，如果一个很长的任务先到了，后面无数个短任务都得等着，这会导致平均等待时间很长，我们称之为“护航效应”。</li>
<li><strong>短作业优先的调度算法(SJF，Shortest Job First)</strong> : 从就绪队列中选出一个估计运行时间最短的进程为之分配资源。理论上，它的平均等待时间是最短的，吞吐量很高。但缺点是，它需要预测运行时间，这很难做到，而且可能会导致长作业“饿死”，永远得不到执行。</li>
</ol>
<p><strong>第二类：抢占式调度 (Preemptive)</strong></p>
<p>操作系统可以强制剥夺当前进程的 CPU 使用权，分配给其他更重要的进程。现代操作系统基本都采用这种方式。</p>
<ul>
<li><strong>时间片轮转调度算法（RR，Round-Robin）</strong> : 这是最经典、最公平的抢占式算法。它给每个进程分配一个固定的时间片，用完了就把它放到队尾，切换到下一个进程。它非常适合分时系统，保证了每个进程都能得到响应，但时间片的设置很关键：太长了退化成 FCFS，太短了则会导致过于频繁的上下文切换，增加系统开销。</li>
<li><strong>优先级调度算法（Priority）</strong>：每个进程都有一个优先级，进程调度器总是选择优先级最高的进程，具有相同优先级的进程以 FCFS 方式执行。这很灵活，可以根据内存要求，时间要求或任何其他资源要求来确定优先级，但同样可能导致低优先级进程“饿死”。</li>
</ul>
<p>前面介绍的几种进程调度的算法都有一定的局限性，如：<strong>短进程优先的调度算法，仅照顾了短进程而忽略了长进程</strong> 。那有没有一种结合了上面这些进程调度算法优点的呢？</p>
<p><strong>多级反馈队列调度算法（MFQ，Multi-level Feedback Queue）</strong> 是现实世界中最常用的一种算法，比如早期的 UNIX。它非常聪明，结合了 RR 和优先级调度。它设置了多个不同优先级的队列，每个队列使用 RR 调度，时间片大小也不同。新进程先进入最高优先级队列；如果在一个时间片内没执行完，就会被降级到下一个队列。这样既照顾了短作业（在高优先级队列中快速完成），也保证了长作业不会饿死（最终会在低优先级队列中得到执行），是一种非常均衡的方案。</p>
<h3 data-id="heading-22">死锁，死锁条件</h3>
<p>死锁（Deadlock）描述的是这样一种情况：多个进程/线程同时被阻塞，它们中的一个或者全部都在等待某个资源被释放。由于进程/线程被无限期地阻塞，因此程序不可能正常终止。</p>
<p>一个最经典的例子就是**“交叉持锁”**。想象有两个线程和两个锁:</p>
<ul>
<li>线程 1 先拿到了锁 A，然后尝试去获取锁 B。</li>
<li>几乎同时，线程 2 拿到了锁 B，然后尝试去获取锁 A。</li>
</ul>
<p>这时，线程 1 等着线程 2 释放锁 B，而线程 2 等着线程 1 释放锁 A，双方都持有对方需要的资源，并等待对方释放，就形成了一个“死结”。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/887a8e98ab9e425296400f217973164d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753368&amp;x-signature=DvbwaWoH5dw%2FuQr%2BXx5LnRqsWz0%3D" loading="lazy"/>
<p>死锁的发生并不是偶然的，它需要同时满足<strong>四个必要条件</strong>：</p>
<ol>
<li><strong>互斥</strong>：资源必须处于非共享模式，即一次只有一个进程可以使用。如果另一进程申请该资源，那么必须等待直到该资源被释放为止。</li>
<li><strong>占有并等待</strong>：一个进程至少应该占有一个资源，并等待另一资源，而该资源被其他进程所占有。</li>
<li><strong>非抢占</strong>：资源不能被抢占。只能在持有资源的进程完成任务后，该资源才会被释放。</li>
<li><strong>循环等待</strong>：有一组等待进程 {P0, P1,..., Pn}， P0 等待的资源被 P1 占有，P1 等待的资源被 P2 占有，……，Pn-1 等待的资源被 Pn 占有，Pn 等待的资源被 P0 占有。</li>
</ol>
<p><strong>注意 ⚠️</strong>：这四个条件是产生死锁的 <strong>必要条件</strong> ，也就是说只要系统发生死锁，这些条件必然成立，而只要上述条件之一不满足，就不会发生死锁。</p>
<h3 data-id="heading-23">中断和轮询的区别</h3>






























<table><thead><tr><th>对比维度</th><th>轮询（Polling）</th><th>中断（Interrupt）</th></tr></thead><tbody><tr><td>核心逻辑</td><td>CPU 主动循环查询设备状态</td><td>设备主动发信号通知 CPU</td></tr><tr><td>CPU 资源占用</td><td>高（忙等，无效循环浪费算力）</td><td>低（仅响应时占用，平时不干扰）</td></tr><tr><td>实时性</td><td>低（依赖查询间隔，有延迟）</td><td>高（即时响应，延迟极低）</td></tr><tr><td>适用场景</td><td>设备数据频率固定、简单场景（如单片机读取低速传感器）</td><td>设备数据随机、实时性要求高的场景（如键盘、磁盘 IO、网络通信）</td></tr></tbody></table>
<p>更多操作系统高频知识点和面试题总结，可以阅读笔者写的这几篇文章：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fcs-basics%2Foperating-system%2Foperating-system-basic-questions-01.html" target="_blank" title="https://javaguide.cn/cs-basics/operating-system/operating-system-basic-questions-01.html" ref="nofollow noopener noreferrer">操作系统常见面试题总结(上)</a>（操作系统基础、进程和线程、死锁）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fcs-basics%2Foperating-system%2Foperating-system-basic-questions-02.html" target="_blank" title="https://javaguide.cn/cs-basics/operating-system/operating-system-basic-questions-02.html" ref="nofollow noopener noreferrer">操作系统常见面试题总结(下)</a>（内存管理、文件系统）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fcs-basics%2Foperating-system%2Flinux-intro.html" target="_blank" title="https://javaguide.cn/cs-basics/operating-system/linux-intro.html" ref="nofollow noopener noreferrer">Linux 基础知识总结</a></li>
</ul>
<h2 data-id="heading-24">网络</h2>
<h3 data-id="heading-25">DNS 解析的过程</h3>
<p>整个过程的步骤比较多，我单独写了一篇文章详细介绍：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fcs-basics%2Fnetwork%2Fdns.html" target="_blank" title="https://javaguide.cn/cs-basics/network/dns.html" ref="nofollow noopener noreferrer">DNS 域名系统详解（应用层）</a>。</p>
<h3 data-id="heading-26">用户输入网址到显示对应页面的全过程</h3>
<p>先来看一张图（来源于《图解 HTTP》）：</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bc5c0f9ce864d4c86e502901c639db4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753368&amp;x-signature=eh90LYq7mgUieMuKL35FMG24QhA%3D" loading="lazy"/>
<p>上图有一个错误需要注意：是 OSPF 不是 OPSF。 OSPF（Open Shortest Path First，ospf）开放最短路径优先协议, 是由 Internet 工程任务组开发的路由选择协议</p>
<p>总体来说分为以下几个步骤:</p>
<ol>
<li>在浏览器中输入指定网页的 URL。</li>
<li>浏览器通过 DNS 协议，获取域名对应的 IP 地址。</li>
<li>浏览器根据 IP 地址和端口号，向目标服务器发起一个 TCP 连接请求。</li>
<li>浏览器在 TCP 连接上，向服务器发送一个 HTTP 请求报文，请求获取网页的内容。</li>
<li>服务器收到 HTTP 请求报文后，处理请求，并返回 HTTP 响应报文给浏览器。</li>
<li>浏览器收到 HTTP 响应报文后，解析响应体中的 HTML 代码，渲染网页的结构和样式，同时根据 HTML 中的其他资源的 URL（如图片、CSS、JS 等），再次发起 HTTP 请求，获取这些资源的内容，直到网页完全加载显示。</li>
<li>浏览器在不需要和服务器通信时，可以主动关闭 TCP 连接，或者等待服务器的关闭请求</li>
</ol>
<p>详细介绍：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fcs-basics%2Fnetwork%2Fthe-whole-process-of-accessing-web-pages.html" target="_blank" title="https://javaguide.cn/cs-basics/network/the-whole-process-of-accessing-web-pages.html" ref="nofollow noopener noreferrer">访问网页的全过程（知识串联）</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端三大权限场景全解析：设计、实现、存储与企业级实践]]></title>    <link>https://juejin.cn/post/7576821684251918379</link>    <guid>https://juejin.cn/post/7576821684251918379</guid>    <pubDate>2025-11-26T09:13:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576821684251918379" data-draft-id="7576575703166402566" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 前端三大权限场景全解析：设计、实现、存储与企业级实践"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-26T09:13:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             前端三大权限场景全解析：设计、实现、存储与企业级实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T09:13:00.000Z" title="Wed Nov 26 2025 09:13:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="arduino-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#434f54}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#00979d}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code,.hljs-literal{color:#d35400}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#00979d}.hljs-deletion,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#005c5f}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-comment{color:rgba(149,165,166,.8)}.hljs-meta-keyword{color:#728e00}.hljs-meta{color:#434f54}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-function{color:#728e00}.hljs-number{color:#8a7b52}</style><p>权限控制是前端应用（尤其是中大型系统）的核心安全与体验保障，完整的权限体系需覆盖「路由权限、页面元素权限、接口权限」三大场景。本文结合真实项目落地经验，系统梳理各场景的应用逻辑、实现方案、设计模式与存储安全，补充企业级开发的关键细节与避坑要点。</p>
<h2 data-id="heading-0">一、路由权限：页面访问的 “第一道门槛”</h2>
<h3 data-id="heading-1">1. 核心应用场景</h3>
<ul>
<li><strong>角色差异化访问</strong>：企业后台中，管理员可访问用户管理、系统配置页，运营仅能访问订单管理、商品管理页。</li>
<li><strong>SaaS 多租户定制</strong>：不同租户（客户）开通不同功能模块（如 A 租户有报表分析模块，B 租户无），后端根据租户 ID 返回对应路由。</li>
<li><strong>权限动态变更</strong>：管理员在后台修改用户角色后，前端无需重启应用，实时更新可访问页面。</li>
<li><strong>刷新丢失修复</strong>：单页应用（SPA）刷新后，动态添加的路由会丢失，需重新加载路由配置。</li>
<li><strong>路由懒加载适配</strong>：大型应用中，路由组件体积大，需结合权限预校验实现按需加载，避免无效资源请求。</li>
</ul>
<h3 data-id="heading-2">2. 企业级实现方式</h3>
<h4 data-id="heading-3">（1）混合式路由配置（前端预设 + 后端过滤）</h4>
<p>纯后端返回路由灵活性差，纯前端预设路由难以应对权限变更，实际项目常用混合方案：</p>
<ul>
<li>前端预设「基础路由」（登录页、404 页、首页）和「权限路由模板」（含 meta.permission 标识页面所需权限）。</li>
<li>登录后，后端返回用户「权限标识列表」，前端过滤出可访问的权限路由，动态添加到路由实例。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端预设路由模板</span>
<span class="hljs-keyword">const</span> asyncRoutes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/user-manage'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'UserManage'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../views/UserManage.vue'</span>),
    <span class="hljs-attr">meta</span>: { <span class="hljs-attr">permission</span>: <span class="hljs-string">'user:manage'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'用户管理'</span> } <span class="hljs-comment">// 页面所需权限标识</span>
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/system-config'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'SystemConfig'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../views/SystemConfig.vue'</span>),
    <span class="hljs-attr">meta</span>: { <span class="hljs-attr">permission</span>: <span class="hljs-string">'system:config'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'系统配置'</span> }
  }
];

<span class="hljs-comment">// 生成可访问路由（核心逻辑）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">generateAccessibleRoutes</span> = (<span class="hljs-params">permissions</span>) =&gt; {
  <span class="hljs-keyword">return</span> asyncRoutes.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">route</span> =&gt;</span> {
    <span class="hljs-comment">// 无权限标识的路由默认可访问，有权限标识需匹配用户权限</span>
    <span class="hljs-keyword">return</span> !route.<span class="hljs-property">meta</span>?.<span class="hljs-property">permission</span> || permissions.<span class="hljs-title function_">includes</span>(route.<span class="hljs-property">meta</span>.<span class="hljs-property">permission</span>);
  });
};
</code></pre>
<h4 data-id="heading-4">（2）路由守卫的 “责任链校验”</h4>
<p>将登录校验、权限校验、刷新修复等逻辑拆分为独立守卫，按顺序执行，降低耦合：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">router.beforeEach(<span class="hljs-keyword">async</span> (<span class="hljs-keyword">to</span>, <span class="hljs-keyword">from</span>, <span class="hljs-keyword">next</span>) =&gt; {
  <span class="hljs-keyword">const</span> token = localStorage.getItem(<span class="hljs-comment">'token');</span>
  <span class="hljs-keyword">const</span> userPermissions = store.getters.userPermissions;

  // <span class="hljs-number">1</span>. 未登录拦截（责任链第一环）
  <span class="hljs-keyword">if</span> (!token &amp;&amp; <span class="hljs-keyword">to</span>.path !== <span class="hljs-comment">'/login') {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">next</span>(<span class="hljs-comment">'/login?redirect=' + to.fullPath); // 记录跳转目标，登录后回跳</span>
  }

  // <span class="hljs-number">2</span>. 已登录但无权限访问（责任链第二环）
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">to</span>.meta.permission &amp;&amp; !userPermissions.includes(<span class="hljs-keyword">to</span>.meta.permission)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">next</span>(<span class="hljs-comment">'/403'); // 跳转到自定义无权限页，提升体验</span>
  }

  // <span class="hljs-number">3</span>. 刷新后动态路由丢失修复（责任链第三环）
  <span class="hljs-keyword">if</span> (store.getters.accessRoutes.length === <span class="hljs-number">0</span> &amp;&amp; token) {
    <span class="hljs-keyword">const</span> accessibleRoutes = generateAccessibleRoutes(userPermissions);
    store.dispatch(<span class="hljs-comment">'setAccessRoutes', accessibleRoutes);</span>
    accessibleRoutes.forEach(route =&gt; router.addRoute(route));
    // 重新触发路由跳转，避免空白页
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">next</span>({ ...<span class="hljs-keyword">to</span>, replace: <span class="hljs-literal">true</span> });
  }

  <span class="hljs-keyword">next</span>();
});
</code></pre>
<h4 data-id="heading-5">（3）路由独享守卫增强</h4>
<p>针对敏感页面（如财务对账、用户权限配置），添加二次校验：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">const</span> routes = [
  {
    path: <span class="hljs-comment">'/financial-reconciliation',</span>
    component: FinancialReconciliation,
    meta: { permission: <span class="hljs-comment">'financial:view' },</span>
    beforeEnter: (<span class="hljs-keyword">to</span>, <span class="hljs-keyword">from</span>, <span class="hljs-keyword">next</span>) =&gt; {
      // 额外校验：仅工作时间可访问
      <span class="hljs-keyword">const</span> hour = <span class="hljs-built_in">new</span> <span class="hljs-type">Date</span>().getHours();
      <span class="hljs-keyword">if</span> (hour &lt; <span class="hljs-number">9</span> || hour &gt; <span class="hljs-number">18</span>) {
        ElMessage.warning(<span class="hljs-comment">'仅工作时间（9:00-18:00）可访问');</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">next</span>(<span class="hljs-keyword">from</span>.path);
      }
      <span class="hljs-keyword">next</span>();
    }
  }
];
</code></pre>
<h3 data-id="heading-6">3. 设计模式</h3>
<ul>
<li><strong>责任链模式</strong>：路由守卫按 “登录校验→权限校验→刷新修复” 的顺序执行，每个守卫负责单一职责，可灵活增删调整。</li>
<li><strong>策略模式</strong>：根据用户角色（如 admin、editor）应用不同的路由过滤策略，例如管理员保留所有权限路由，运营仅保留业务相关路由。</li>
<li><strong>观察者模式</strong>：权限变更时（如管理员修改用户权限），触发路由重新加载事件，更新可访问路由列表。</li>
</ul>
<h3 data-id="heading-7">4. 权限存储与安全性</h3>
<h4 data-id="heading-8">（1）存储方案</h4>
<ul>
<li>路由配置：存储在 Vuex/Pinia（内存），刷新后重新请求后端获取，避免 localStorage 存储敏感路由规则（如接口地址、权限标识）。</li>
<li>用户权限标识：采用 “localStorage（持久化）+ Vuex/Pinia（内存访问）” 双存储，localStorage 确保刷新后不丢失，Vuex/Pinia 提升访问效率。</li>
<li>Token：存储在 localStorage 或 sessionStorage，建议设置过期时间（如 2 小时），降低泄露风险。</li>
</ul>
<h4 data-id="heading-9">（2）安全性保障</h4>
<ul>
<li>权限标识加密：对 localStorage 中的权限标识做简单加密（如 Base64），避免明文泄露（虽不能防破解，但能提升基础安全）。</li>
<li>防 URL 绕过：即使前端隐藏路由，用户直接输入 URL 访问时，后端需对 “页面初始化接口” 做权限校验（如访问<code>/system-config</code>时，后端校验<code>system:config</code>权限）。</li>
<li>敏感路由隐藏：无权限的路由不添加到路由实例，同时在菜单渲染时过滤，避免用户感知未授权功能。</li>
</ul>
<h2 data-id="heading-10">二、页面元素权限：细粒度的 “功能可见性控制”</h2>
<h3 data-id="heading-11">1. 核心应用场景</h3>
<ul>
<li><strong>操作权限差异化</strong>：同一页面中，管理员可看到 “删除用户”“批量导出” 按钮，普通用户仅能看到 “查看详情” 按钮。</li>
<li><strong>数据列权限</strong>：表格中，管理员可查看 “手机号”“身份证号” 列，运营仅能查看 “用户名”“订单号” 列。</li>
<li><strong>复杂权限组合</strong>：按钮显示需满足 “角色为 editor + 拥有 order:edit 权限 + 数据归属本部门” 等多条件组合。</li>
<li><strong>灰度功能发布</strong>：新功能上线时，仅对部分用户（如内部测试账号）显示入口，逐步全量开放。</li>
<li><strong>权限动态更新</strong>：管理员修改用户权限后，页面元素实时刷新（如立即隐藏 “删除” 按钮）。</li>
</ul>
<h3 data-id="heading-12">2. 企业级实现方式</h3>
<h4 data-id="heading-13">（1）权限中心封装（解决碎片化问题）</h4>
<p>构建全局权限中心，统一管理权限校验逻辑，避免散落在各组件中：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// src/utils/permissionCenter.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionCenter</span> {
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.permissions = []; <span class="hljs-comment">// 权限码列表（如["user:add", "order:edit"]）</span>
    <span class="hljs-keyword">this</span>.roles = []; <span class="hljs-comment">// 角色列表（如["admin", "editor"]）</span>
    <span class="hljs-keyword">this</span>.customRules = new Map(); <span class="hljs-comment">// 自定义权限规则（应对复杂场景）</span>
    <span class="hljs-keyword">this</span>.cache = new Map(); <span class="hljs-comment">// 校验结果缓存，提升性能</span>
  }

  <span class="hljs-comment">// 初始化权限数据</span>
  <span class="hljs-keyword">init</span>(permissions, roles) {
    <span class="hljs-keyword">this</span>.permissions = permissions;
    <span class="hljs-keyword">this</span>.roles = roles;
    <span class="hljs-keyword">this</span>.cache.clear(); <span class="hljs-comment">// 初始化时清空缓存</span>
  }

  <span class="hljs-comment">// 基础权限校验（权限码匹配）</span>
  hasPermission(code) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cache.has(code)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cache.<span class="hljs-keyword">get</span>(code);
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">this</span>.permissions.includes(code);
    <span class="hljs-keyword">this</span>.cache.<span class="hljs-keyword">set</span>(code, result); <span class="hljs-comment">// 缓存校验结果</span>
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-comment">// 角色校验</span>
  hasRole(role) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.roles.includes(role);
  }

  <span class="hljs-comment">// 复杂规则校验（支持多条件组合）</span>
  checkCustomRule(ruleName, ...args) {
    <span class="hljs-keyword">const</span> rule = <span class="hljs-keyword">this</span>.customRules.<span class="hljs-keyword">get</span>(ruleName);
    <span class="hljs-keyword">if</span> (!rule) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> rule(...args);
  }

  <span class="hljs-comment">// 注册自定义规则</span>
  registerCustomRule(ruleName, ruleFn) {
    <span class="hljs-keyword">this</span>.customRules.<span class="hljs-keyword">set</span>(ruleName, ruleFn);
  }

  <span class="hljs-comment">// 权限更新（触发元素重新渲染）</span>
  updatePermissions(permissions, roles) {
    <span class="hljs-keyword">this</span>.<span class="hljs-keyword">init</span>(permissions, roles);
    <span class="hljs-comment">// 触发Vue响应式更新（需结合Vuex/Pinia）</span>
    store.dispatch(<span class="hljs-string">'updateUserPermissions'</span>, { permissions, roles });
  }
}

export default new PermissionCenter();
</code></pre>
<h4 data-id="heading-14">（2）指令 + 组件的双层控制</h4>
<ul>
<li><strong>全局指令（v-perm）</strong> ：负责基础权限校验，快速隐藏无权限元素：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// 注册全局权限指令
app.directive('perm', {
  mounted(el, binding) {
    const { value, arg } = binding<span class="hljs-comment">;</span>
    let <span class="hljs-attr">hasAccess</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>

    // 支持权限码校验（<span class="hljs-attr">v-perm</span>=<span class="hljs-string">"user:delete"</span>）和自定义规则校验（v-perm:rule=<span class="hljs-string">"xxx"</span>）
    if (<span class="hljs-attr">arg</span> === <span class="hljs-string">'rule'</span>) {
      const { name, args } = value<span class="hljs-comment">;</span>
      <span class="hljs-attr">hasAccess</span> = permissionCenter.checkCustomRule(name, ...args)<span class="hljs-comment">;</span>
    } else {
      <span class="hljs-attr">hasAccess</span> = permissionCenter.hasPermission(value)<span class="hljs-comment">;</span>
    }

    // 无权限时移除元素（避免用户通过DOM操作显示）
    if (!hasAccess) {
      el.parentNode?.removeChild(el)<span class="hljs-comment">;</span>
    }
  },
  // 权限更新时重新校验（如管理员修改权限后）
  updated(el, binding) {
    // 复用mounted逻辑，重新校验权限
    this.mounted(el, binding)<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><strong>权限组件（PermissionWrap）</strong> ：应对复杂场景（如多条件组合、权限变更刷新）：</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- components/PermissionWrap.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"hasAccess"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> permissionCenter <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/permissionCenter'</span>;

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-comment">// 权限码（单个或数组）</span>
  <span class="hljs-attr">perm</span>: { <span class="hljs-attr">type</span>: [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Array</span>], <span class="hljs-attr">default</span>: <span class="hljs-string">''</span> },
  <span class="hljs-comment">// 角色（单个或数组）</span>
  <span class="hljs-attr">role</span>: { <span class="hljs-attr">type</span>: [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Array</span>], <span class="hljs-attr">default</span>: <span class="hljs-string">''</span> },
  <span class="hljs-comment">// 自定义规则</span>
  <span class="hljs-attr">customRule</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>, <span class="hljs-attr">default</span>: <span class="hljs-literal">null</span> }
});

<span class="hljs-comment">// 权限校验逻辑</span>
<span class="hljs-keyword">const</span> hasAccess = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 权限码校验</span>
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">perm</span>) {
    <span class="hljs-keyword">const</span> perms = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(props.<span class="hljs-property">perm</span>) ? props.<span class="hljs-property">perm</span> : [props.<span class="hljs-property">perm</span>];
    <span class="hljs-keyword">if</span> (!perms.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">perm</span> =&gt;</span> permissionCenter.<span class="hljs-title function_">hasPermission</span>(perm))) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">// 角色校验</span>
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">role</span>) {
    <span class="hljs-keyword">const</span> roles = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(props.<span class="hljs-property">role</span>) ? props.<span class="hljs-property">role</span> : [props.<span class="hljs-property">role</span>];
    <span class="hljs-keyword">if</span> (!roles.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> permissionCenter.<span class="hljs-title function_">hasRole</span>(role))) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">// 自定义规则校验</span>
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">customRule</span>) {
    <span class="hljs-keyword">const</span> { name, args } = props.<span class="hljs-property">customRule</span>;
    <span class="hljs-keyword">if</span> (!permissionCenter.<span class="hljs-title function_">checkCustomRule</span>(name, ...args)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-15">（3）页面中使用示例</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 基础权限按钮 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-perm</span>=<span class="hljs-string">"user:delete"</span>&gt;</span>删除用户<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 角色+权限组合控制 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">PermissionWrap</span> <span class="hljs-attr">perm</span>=<span class="hljs-string">"order:export"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"admin"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>批量导出订单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">PermissionWrap</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 复杂自定义规则（仅能操作自己创建的订单） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">PermissionWrap</span> <span class="hljs-attr">:custom-rule</span>=<span class="hljs-string">"{ name: 'canOperateOrder', args: [order] }"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"editOrder(order.id)"</span>&gt;</span>编辑订单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">PermissionWrap</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 表格列权限 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"手机号"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"permissionCenter.hasPermission('user:view:phone')"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">"scope"</span>&gt;</span>{{ scope.row.phone }}<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
</code></pre>
<h3 data-id="heading-16">3. 设计模式</h3>
<ul>
<li><strong>装饰器模式</strong>：通过<code>v-perm</code>指令或<code>PermissionWrap</code>组件包装原有元素，添加权限控制逻辑，不修改元素本身代码，符合开闭原则。</li>
<li><strong>组合模式</strong>：将基础权限校验、角色校验、自定义规则校验组合为复杂权限逻辑，支持灵活组合与扩展。</li>
<li><strong>单例模式</strong>：权限中心（PermissionCenter）采用单例设计，确保全应用权限数据一致，避免重复初始化。</li>
</ul>
<h3 data-id="heading-17">4. 权限存储与安全性</h3>
<h4 data-id="heading-18">（1）存储方案</h4>
<ul>
<li>权限码 / 角色列表：存储在 Vuex/Pinia（内存）+ localStorage（持久化），与路由权限共用存储，确保数据一致性。</li>
<li>自定义规则：存储在权限中心实例中（内存），初始化时注册，无需持久化。</li>
<li>校验结果缓存：存储在权限中心的<code>cache</code>属性（内存），页面刷新后清空，避免缓存过期。</li>
</ul>
<h4 data-id="heading-19">（2）安全性保障</h4>
<ul>
<li>防 DOM 篡改：仅用<code>v-if</code>隐藏元素不够，需用<code>el.remove()</code>彻底移除，避免用户通过浏览器控制台修改 DOM 显示无权限元素。</li>
<li>二次校验：按钮点击事件中添加权限二次校验，防止用户通过控制台触发事件：</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">const</span> handleDelete = (userId) =&gt; {
  <span class="hljs-keyword">if</span> (!permissionCenter.hasPermission(<span class="hljs-string">'user:delete'</span>)) {
    ElMessage.<span class="hljs-type">error</span>(<span class="hljs-string">'无删除权限'</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-comment">// 执行删除逻辑</span>
};
</code></pre>
<ul>
<li>权限更新同步：管理员修改用户权限后，前端调用<code>permissionCenter.updatePermissions</code>更新权限数据，触发元素重新渲染。</li>
</ul>
<h2 data-id="heading-20">三、接口权限：系统安全的 “最后一道防线”</h2>
<h3 data-id="heading-21">1. 核心应用场景</h3>
<ul>
<li><strong>敏感操作接口控制</strong>：<code>/api/user/delete</code>（删除用户）、<code>/api/order/update-status</code>（修改订单状态）等高危接口，仅授权角色可调用。</li>
<li><strong>数据范围权限</strong>：<code>/api/order/list</code>接口，管理员返回所有订单，普通用户仅返回自己创建的订单。</li>
<li><strong>接口频率限制</strong>：免费用户调用<code>/api/search</code>接口每分钟最多 10 次，付费用户无限制。</li>
<li><strong>接口版本权限</strong>：新版本接口（如<code>/api/v2/order</code>）仅对已升级版本的租户开放。</li>
<li><strong>Token 失效 / 权限变更处理</strong>：Token 过期或权限被回收时，接口返回 403/401，前端需优雅处理（如登出、刷新 Token）。</li>
</ul>
<h3 data-id="heading-22">2. 企业级实现方式</h3>
<h4 data-id="heading-23">（1）请求 / 响应拦截器的全链路控制</h4>
<ul>
<li><strong>请求拦截器</strong>：添加 Token、权限预判、数据范围参数：</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-comment">// 1. 添加Token（鉴权基础）</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>);
    <span class="hljs-keyword">if</span> (token) {
      config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
    }

    <span class="hljs-comment">// 2. 接口权限预判（减少无效请求）</span>
    <span class="hljs-keyword">const</span> { url, method } = config;
    <span class="hljs-comment">// 生成接口权限标识（如"DELETE:/api/user/delete" → "user:delete"）</span>
    <span class="hljs-keyword">const</span> apiPerm = <span class="hljs-title function_">generateApiPermissionKey</span>(method, url);
    <span class="hljs-keyword">if</span> (apiPerm &amp;&amp; !permissionCenter.<span class="hljs-title function_">hasPermission</span>(apiPerm)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`无接口权限：<span class="hljs-subst">${apiPerm}</span>`</span>));
    }

    <span class="hljs-comment">// 3. 数据范围参数（配合后端过滤）</span>
    <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/api/order/list'</span>) &amp;&amp; !permissionCenter.<span class="hljs-title function_">hasRole</span>(<span class="hljs-string">'admin'</span>)) {
      config.<span class="hljs-property">params</span> = { ...config.<span class="hljs-property">params</span>, <span class="hljs-attr">creatorId</span>: store.<span class="hljs-property">getters</span>.<span class="hljs-property">userId</span> };
    }

    <span class="hljs-comment">// 4. 幂等性处理（敏感接口防重复调用）</span>
    <span class="hljs-keyword">if</span> ([<span class="hljs-string">'POST'</span>, <span class="hljs-string">'PUT'</span>, <span class="hljs-string">'DELETE'</span>].<span class="hljs-title function_">includes</span>(method)) {
      config.<span class="hljs-property">headers</span>[<span class="hljs-string">'X-Request-Id'</span>] = <span class="hljs-title function_">uuidv4</span>();
    }

    <span class="hljs-keyword">return</span> config;
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
);
</code></pre>
<ul>
<li><strong>响应拦截器</strong>：处理权限异常、Token 失效：</li>
</ul>
<pre><code class="hljs language-go" lang="go">axios.interceptors.response.use(
  (response) =&gt; {
    <span class="hljs-comment">// 缓存频繁调用的非敏感接口（如用户信息）</span>
    <span class="hljs-keyword">if</span> (response.config.url === <span class="hljs-string">'/api/user/info'</span> &amp;&amp; response.status === <span class="hljs-number">200</span>) {
      store.dispatch(<span class="hljs-string">'cacheUserInfo'</span>, response.data);
    }
    <span class="hljs-keyword">return</span> response;
  },
  (<span class="hljs-type">error</span>) =&gt; {
    <span class="hljs-keyword">const</span> { status, data } = <span class="hljs-type">error</span>.response || {};
    <span class="hljs-keyword">switch</span> (status) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
        <span class="hljs-comment">// Token失效，登出并跳转登录页</span>
        ElMessage.<span class="hljs-type">error</span>(data.msg || <span class="hljs-string">'登录已失效，请重新登录'</span>);
        store.dispatch(<span class="hljs-string">'logout'</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">403</span>:
        <span class="hljs-comment">// 区分接口权限不足和数据权限不足</span>
        <span class="hljs-keyword">const</span> msg = data.msg || <span class="hljs-string">'无接口访问权限'</span>;
        ElMessage.<span class="hljs-type">error</span>(msg);
        <span class="hljs-comment">// 敏感操作权限不足，可记录日志</span>
        <span class="hljs-keyword">if</span> (msg.includes(<span class="hljs-string">'敏感操作'</span>)) {
          reportPermissionError({ url: <span class="hljs-type">error</span>.config.url, msg });
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">429</span>:
        ElMessage.<span class="hljs-type">error</span>(<span class="hljs-string">'接口调用过于频繁，请稍后再试'</span>);
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">return</span> Promise.reject(<span class="hljs-type">error</span>);
  }
);
</code></pre>
<h4 data-id="heading-24">（2）接口权限标识生成规则</h4>
<p>统一接口与权限码的映射关系，避免混乱：</p>
<pre><code class="hljs language-ini" lang="ini">// 生成接口权限标识（method + 接口路径简化）
const <span class="hljs-attr">generateApiPermissionKey</span> = (method, url) =&gt; {
  // 示例：DELETE /api/user/123 → user:delete
  // 示例：GET /api/order/list → order:list
  const <span class="hljs-attr">pathParts</span> = url.replace(/^/api//, <span class="hljs-string">''</span>).split(<span class="hljs-string">'/'</span>)<span class="hljs-comment">;</span>
  if (<span class="hljs-attr">pathParts.length</span> === <span class="hljs-number">0</span>) return <span class="hljs-string">''</span><span class="hljs-comment">;</span>
  const <span class="hljs-attr">resource</span> = pathParts[<span class="hljs-number">0</span>]<span class="hljs-comment">; // 资源名（user/order）</span>
  let <span class="hljs-attr">action</span> = method.toLowerCase()<span class="hljs-comment">; // 操作（get/post/delete）</span>
  // 特殊映射：get列表 → list，get详情 → view
  if (<span class="hljs-attr">method</span> === <span class="hljs-string">'GET'</span> &amp;&amp; pathParts.includes(<span class="hljs-string">'list'</span>)) action = <span class="hljs-string">'list'</span><span class="hljs-comment">;</span>
  if (<span class="hljs-attr">method</span> === <span class="hljs-string">'GET'</span> &amp;&amp; pathParts.length &gt;= <span class="hljs-number">2</span> &amp;&amp; !isNaN(pathParts[<span class="hljs-number">1</span>])) action = <span class="hljs-string">'view'</span><span class="hljs-comment">;</span>
  return `${resource}:${action}`<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-25">3. 设计模式</h3>
<ul>
<li><strong>代理模式</strong>：请求拦截器作为接口调用的代理，统一添加鉴权信息、权限预判、数据范围参数，不修改业务请求代码。</li>
<li><strong>责任链模式</strong>：后端接口校验按 “Token 校验→权限码校验→数据范围校验→频率限制” 的顺序执行，前端响应拦截器按 “401 处理→403 处理→429 处理” 顺序处理异常。</li>
<li><strong>缓存模式</strong>：对非敏感接口结果进行缓存，减少重复请求，提升性能（需在权限变更时清空缓存）。</li>
</ul>
<h3 data-id="heading-26">4. 权限存储与安全性</h3>
<h4 data-id="heading-27">（1）存储方案</h4>
<ul>
<li>Token：存储在 localStorage（持久化）或 sessionStorage（会话级），建议设置<code>HttpOnly</code>和<code>Secure</code>属性（需后端配合），防止 XSS 攻击。</li>
<li>接口权限标识映射规则：前端预设（如<code>user:delete</code>对应<code>/api/user/delete</code>），无需持久化，确保与后端一致。</li>
<li>接口缓存：存储在 Vuex/Pinia（内存），缓存 key 包含用户 ID 和权限标识，避免多用户数据混淆。</li>
</ul>
<h4 data-id="heading-28">（2）安全性保障</h4>
<ul>
<li>后端绝对校验：前端权限预判仅为体验优化，后端必须对每个接口做独立权限校验，防止用户通过 Postman 等工具绕过前端拦截。</li>
<li>Token 加密传输：所有接口采用 HTTPS 协议，Token 在传输过程中加密，避免中间人攻击。</li>
<li>敏感接口二次验证：核心接口（如删除用户、转账）需添加二次验证（如输入密码、短信验证码），即使权限校验通过，也需确认操作意图。</li>
<li>权限日志记录：前端调用敏感接口时，传递操作人、操作时间、IP 地址等信息，后端存储日志，便于安全追溯。</li>
</ul>
<h2 data-id="heading-29">四、限设计的额外关键要点</h2>
<h3 data-id="heading-30">1. 权限可视化配置</h3>
<ul>
<li>管理员通过系统后台的 “权限配置页面”，勾选角色对应的权限（如 “用户管理”→“删除用户”），后端存储角色 - 权限映射关系。</li>
<li>前端渲染 “权限树”，支持按模块折叠 / 展开，便于管理员操作；支持批量分配权限（如给 “运营” 角色分配所有订单相关权限）。</li>
</ul>
<h3 data-id="heading-31">2. 权限动态更新与同步</h3>
<ul>
<li>管理员修改用户权限后，前端通过 WebSocket 或轮询实时获取最新权限，调用<code>permissionCenter.updatePermissions</code>更新数据，无需用户刷新页面。</li>
<li>跨标签页权限同步：通过<code>localStorage</code>监听事件，一个标签页修改权限后，其他标签页自动更新权限状态。</li>
</ul>
<h3 data-id="heading-32">3. 跨端权限统一管理</h3>
<ul>
<li>若项目包含 PC 端、移动端、小程序，设计统一的权限中心（后端），各端共用一套权限码和角色体系（如<code>user:delete</code>在所有端含义一致）。</li>
<li>前端各端复用权限校验逻辑（如<code>permissionCenter</code>工具类），确保权限控制行为一致。</li>
</ul>
<h3 data-id="heading-33">4. 性能优化</h3>
<ul>
<li>权限校验缓存：对频繁校验的权限码（如表格列权限）进行缓存，避免重复计算。</li>
<li>动态路由懒加载：动态添加的路由组件采用懒加载（<code>() =&gt; import('../views/xxx.vue')</code>），减少首屏加载时间。</li>
<li>权限数据批量请求：登录后一次性获取用户角色、权限码、路由配置，避免多次请求后端。</li>
</ul>
<h3 data-id="heading-34">5. 灰度发布与 A/B 测试</h3>
<ul>
<li>权限中心支持 “灰度规则”，如 “用户 ID 在白名单内”“部门为测试部” 的用户可访问新功能路由和按钮。</li>
<li>通过权限配置实现 A/B 测试，给不同用户组分配不同权限，验证功能效果后全量开放。</li>
</ul>
<h2 data-id="heading-35">五、总结</h2>
<h3 data-id="heading-36">1. 权限设计的三层逻辑</h3>
<ul>
<li>前端路由权限：控制 “能否访问页面”，优化用户体验，减少无效请求。</li>
<li>前端元素权限：控制 “能否看到功能”，隐藏无权限元素，避免用户困惑。</li>
<li>后端接口权限：控制 “能否执行操作”，是安全核心，必须绝对可靠。</li>
</ul>
<h3 data-id="heading-37">2. 安全性原则</h3>
<ul>
<li>前端权限是 “体验层”，不能替代后端校验；后端权限是 “安全层”，必须覆盖所有敏感操作。</li>
<li>敏感信息（Token、权限标识）需加密存储和传输，防止泄露。</li>
<li>权限变更需实时同步，避免权限不一致导致的安全隐患。</li>
</ul>
<h3 data-id="heading-38">3. 可扩展性原则</h3>
<ul>
<li>采用设计模式（如责任链、装饰器、单例）降低代码耦合，便于后期扩展权限规则。</li>
<li>预留自定义权限规则接口，应对复杂业务场景（如多条件组合权限）。</li>
<li>权限配置可视化、动态化，减少前端发版频率，提升运营效率。</li>
</ul>
<p>项目中，权限设计并非一成不变，需根据业务规模和安全要求逐步迭代：初期可采用 “角色 + 静态权限”，中期引入 “权限码 + 动态路由”，后期升级为 “可视化配置 + 细粒度数据权限”，最终实现 “安全、灵活、易维护” 的权限体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一键去水印｜5 款免费小红书解析工具推荐]]></title>    <link>https://juejin.cn/post/7576852209565106203</link>    <guid>https://juejin.cn/post/7576852209565106203</guid>    <pubDate>2025-11-26T09:14:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576852209565106203" data-draft-id="7576852209565089819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一键去水印｜5 款免费小红书解析工具推荐"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-26T09:14:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员凌览"/> <meta itemprop="url" content="https://juejin.cn/user/3350967174565198"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一键去水印｜5 款免费小红书解析工具推荐
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3350967174565198/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员凌览
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T09:14:28.000Z" title="Wed Nov 26 2025 09:14:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>刷短视频时，看到喜欢的内容想存到手机里，结果点"保存"却提示"不允许"？别慌，不是手机坏了，而是作者或平台把下载开关关掉了。下面教你几招，照样能把视频"救"回来——适用于抖音、小红书、快手等主流 App，全程大白话，一看就会。</p>
<h2 data-id="heading-1">二、<strong>直接保存到相册</strong></h2>
<p>对于未限制下载权限的视频，操作步骤如下：</p>
<ol>
<li>点击<strong>分享</strong>按钮。</li>
<li>在弹出的选项中，选择<strong>保存到相册</strong>。</li>
<li>视频会自动保存到手机相册中。</li>
</ol>
<h2 data-id="heading-2">三、<strong>无法直接保存的视频</strong></h2>
<p>有些视频因创作者设置了"禁止下载"功能，<strong>保存到相册</strong>按钮会显示为灰色，无法直接点击。这种情况下，可以尝试以下方法：</p>
<h3 data-id="heading-3">1. 屏幕录制</h3>
<ul>
<li>利用手机自带的屏幕录制功能，手动录制视频内容。</li>
<li>缺点：可能需要后续裁剪多余的内容。</li>
</ul>
<h3 data-id="heading-4"><strong>2. 借助第三方工具</strong></h3>
<p>下面几个在线工具亲测可用，支持抖音 + 小红书。请按需选择，用完即走：</p>









































<table><thead><tr><th>工具名称 &amp; 入口</th><th>支持平台</th><th>速度/稳定性</th><th>特色小功能</th></tr></thead><tbody><tr><td><strong>去水印下载鸭</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fnologo.code24.top%2F" target="_blank" title="https://nologo.code24.top/" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fnologo.code24.top" target="_blank" title="https://nologo.code24.top" ref="nofollow noopener noreferrer">nologo.code24.top</a></td><td>抖音、小红书、快手等</td><td>快（CDN 国内双线）</td><td>浏览器插件+小程序；自动识别剪贴板</td></tr><tr><td><strong>小红书专用下载</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.xhs-download.online%2F" target="_blank" title="https://www.xhs-download.online/" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.xhs-download.online" target="_blank" title="https://www.xhs-download.online" ref="nofollow noopener noreferrer">www.xhs-download.online</a></td><td>仅小红书</td><td>极快（节点在香港，晚高峰也稳）</td><td>专注小红书高清去水印下载</td></tr><tr><td><strong>下载狗</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.xiazaitool.com%2Fxhs" target="_blank" title="https://www.xiazaitool.com/xhs" ref="nofollow noopener noreferrer">www.xiazaitool.com/xhs</a></td><td>抖音、小红书、快手等</td><td>中等（教育网可用）</td><td>轻量级小红书去水印神器，图片、视频一键在线去水印；无广告</td></tr><tr><td><strong>小红刷</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.xiaohongshua.com%2F" target="_blank" title="https://www.xiaohongshua.com/" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.xiaohongshua.com" target="_blank" title="https://www.xiaohongshua.com" ref="nofollow noopener noreferrer">www.xiaohongshua.com</a></td><td>仅小红书</td><td>快</td><td>界面极简，三步搞定</td></tr><tr><td>RedNote 视频下载器 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rednote-downloader.com%2Fzh" target="_blank" title="https://www.rednote-downloader.com/zh" ref="nofollow noopener noreferrer">www.rednote-downloader.com/zh</a></td><td>仅小红书</td><td>快</td><td>界面极简</td></tr></tbody></table>
<p><strong>使用流程（大同小异）：</strong></p>
<ol>
<li>在 App 里点"分享 → 复制链接"</li>
<li>把链接粘贴到对应网页的输入框</li>
<li>等待 3-5 秒出现下载按钮 → 右键/长按保存即可</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次 Kettle 中文乱码写入失败的完整排查实录]]></title>    <link>https://juejin.cn/post/7576838552471224363</link>    <guid>https://juejin.cn/post/7576838552471224363</guid>    <pubDate>2025-11-26T08:37:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576838552471224363" data-draft-id="7576838552471207979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次 Kettle 中文乱码写入失败的完整排查实录"/> <meta itemprop="keywords" content="数据库,后端"/> <meta itemprop="datePublished" content="2025-11-26T08:37:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="枫叶梨花"/> <meta itemprop="url" content="https://juejin.cn/user/3913917123816055"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次 Kettle 中文乱码写入失败的完整排查实录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917123816055/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    枫叶梨花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T08:37:44.000Z" title="Wed Nov 26 2025 08:37:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天在用 Kettle（PDI）做数据迁移时，踩了一个典型的中文编码坑。错误信息看起来挺吓人：</p>
<pre><code class="hljs language-sql" lang="sql">Incorrect string <span class="hljs-keyword">value</span>: <span class="hljs-string">'\xC9\xDC\xD0\xCB\xCA\xD0...'</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">column</span> <span class="hljs-string">'content'</span> <span class="hljs-keyword">at</span> <span class="hljs-type">row</span> <span class="hljs-number">1</span>
</code></pre>
<p>乍一看以为是目标库字符集问题，结果一路排查下来，发现根源藏得特别深。今天把整个过程记录下来，希望能帮到遇到同样问题的朋友。</p>
<hr/>
<h2 data-id="heading-0">起因：一个看似简单的数据同步任务</h2>
<p>我的任务很明确：</p>
<ul>
<li><strong>源库</strong>：MySQL 8.0，IP <code>180.23.1.1:3306</code>，库名 <code>oldtest</code></li>
<li><strong>目标库</strong>：另一个 MySQL 8.0 实例，端口 <code>3315</code>，库名 <code>newtest</code></li>
<li><strong>工具</strong>：Kettle 7.1（别问为什么不用新版，老项目）</li>
</ul>
<p>两个表结构几乎一样，<code>content</code> 字段都是 <code>LONGTEXT</code> 类型。我以为直接“表输入 → 表输出”就能搞定，结果一跑就报错。</p>
<hr/>
<h2 data-id="heading-1">第一阶段：误判为连接参数格式错误</h2>
<p>最初报的错根本不是编码问题，而是：</p>
<pre><code class="hljs language-python" lang="python">Invalid ID <span class="hljs-keyword">for</span> region-based ZoneId, invalid <span class="hljs-built_in">format</span>: Asia/Shanghai;Driver <span class="hljs-keyword">class</span>=...
</code></pre>
<p>我一开始完全懵了：明明 URL 写得好好的，怎么 driver class 被拼进参数值里了？</p>
<p>🔍 <strong>排查过程</strong>：</p>
<ul>
<li>反复检查 Custom URL，确认没有多余字符</li>
<li>突然想到：会不会是 “Options” 表格里写了东西？</li>
<li>打开一看——果然！之前测试时随手在 Options 里填过一行，Value 列不小心粘贴进了 <code>Driver class=...</code> 这种非法内容</li>
</ul>
<p>✅ <strong>解决</strong>：清空 Options 表格，所有参数统一写进 Custom URL，用 <code>&amp;</code> 分隔。</p>
<p>教训：<strong>Kettle 的 Options 表格和 Custom URL 是合并使用的，脏数据会污染整个连接串</strong>。</p>
<hr/>
<h2 data-id="heading-2">第二阶段：真正的敌人——中文编码问题浮出水面</h2>
<p>清理完连接参数后，能连上数据库了，但一写数据就报：</p>
<pre><code class="hljs language-c" lang="c">Incorrect <span class="hljs-built_in">string</span> value: <span class="hljs-string">'\xC9\xDC\xD0\xCB\xCA\xD0...'</span> <span class="hljs-keyword">for</span> column <span class="hljs-string">'content'</span>
</code></pre>
<p><code>\xC9\xDC</code> 是啥？查了一下，这是 GBK 编码下“深”字的十六进制。说明数据源里存的是 GBK 字节，但 MySQL 当 UTF8 解析，自然失败。</p>
<p>🔍 <strong>初步判断</strong>：</p>
<ul>
<li>源表声明是 <code>utf8</code>，但实际存的是 GBK 数据（历史遗留）</li>
<li>目标表是 <code>utf8mb4</code>，理论上兼容，但前提是传入的是合法 UTF8 字符串</li>
</ul>
<p>于是我在两个连接里分别加了编码参数：</p>
<ul>
<li>源库：<code>characterEncoding=GBK</code></li>
<li>目标库：<code>characterEncoding=utf8</code></li>
</ul>
<p>但还是失败！</p>
<hr/>
<h2 data-id="heading-3">第三阶段：被忽略的关键参数——useUnicode=true</h2>
<p>这时候我开始怀疑人生：配置明明没错，为什么还是不行？</p>
<p>灵机一动，想起以前看过 MySQL JDBC 文档提到：<strong>从 5.1 开始，必须显式开启 Unicode 支持，否则 characterEncoding 可能被忽略</strong>。</p>
<p>赶紧加上 <code>useUnicode=true</code>：</p>
<pre><code class="hljs language-text" lang="text"># 源库
jdbc:mysql://...?useUnicode=true&amp;characterEncoding=GBK&amp;...

# 目标库
jdbc:mysql://...?useUnicode=true&amp;characterEncoding=utf8&amp;...
</code></pre>
<p>改完之后，<strong>还是失败</strong>。</p>
<p>我差点放弃，直到做了最后一件事——<strong>重启 Spoon</strong>。</p>
<p>神奇的事情发生了：转换成功跑通，中文正常写入！</p>
<hr/>
<h2 data-id="heading-4">为什么重启才生效？</h2>
<p>后来复盘发现，Kettle 7.1 有个隐藏坑点：</p>
<blockquote>
<p><strong>数据库连接对象会被缓存，即使你修改了 URL，旧的连接可能还在用</strong></p>
</blockquote>
<p>也就是说，我虽然改了连接配置，但 Kettle 内部仍然用着之前没加 <code>useUnicode=true</code> 的连接池实例。只有重启 Spoon，才能彻底清空缓存，让新配置生效。</p>
<hr/>
<h2 data-id="heading-5">最终验证：确保每一步都正确</h2>
<p>为了保险，我在“表输入”和“表输出”之间加了个“写日志”步骤，打印 <code>content</code> 字段。看到控制台输出的是“深圳市某某单位”这样的正常中文，心里才踏实。</p>
<p>同时确认目标表确实是 <code>utf8mb4</code>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> target_table;
<span class="hljs-comment">-- 输出包含：CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci</span>
</code></pre>
<hr/>
<h2 data-id="heading-6">经验总结</h2>
<ol>
<li>
<p><strong>不要相信表的字符集声明</strong><br/>
很多老系统把 GBK 数据塞进 <code>utf8</code> 表，实际存储的是 GBK 字节。要通过 <code>HEX(content)</code> 验证真实编码。</p>
</li>
<li>
<p><strong>JDBC 连接必须显式开启 Unicode</strong><br/>
光写 <code>characterEncoding=GBK</code> 不够，一定要加 <code>useUnicode=true</code>。</p>
</li>
<li>
<p><strong>Kettle 的 Options 表格是双刃剑</strong><br/>
宁可全写进 Custom URL，也不要混用，避免参数污染。</p>
</li>
<li>
<p><strong>改完配置记得重启 Spoon</strong><br/>
Kettle 7.1 的连接缓存机制会让你误以为配置没生效。</p>
</li>
<li>
<p><strong>用“写日志”步骤验证中间数据</strong><br/>
在关键节点打印字段值，能快速定位是读取问题还是写入问题。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-7">附：推荐的完整连接配置</h2>
<p><strong>源库（读取 GBK 数据）</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">jdbc:mysql://180.23.1.1:3306/oldtest?
  <span class="hljs-attr">useUnicode</span>=<span class="hljs-literal">true</span>&amp;
  <span class="hljs-attr">characterEncoding</span>=GBK&amp;
  <span class="hljs-attr">useSSL</span>=<span class="hljs-literal">false</span>&amp;
  <span class="hljs-attr">allowPublicKeyRetrieval</span>=<span class="hljs-literal">true</span>&amp;
  <span class="hljs-attr">serverTimezone</span>=Asia/Shanghai
</code></pre>
<p><strong>目标库（写入 UTF8MB4）</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">jdbc:mysql://180.23.1.1:3315/newtest?
  <span class="hljs-attr">useUnicode</span>=<span class="hljs-literal">true</span>&amp;
  <span class="hljs-attr">characterEncoding</span>=utf8&amp;
  <span class="hljs-attr">useSSL</span>=<span class="hljs-literal">false</span>&amp;
  <span class="hljs-attr">allowPublicKeyRetrieval</span>=<span class="hljs-literal">true</span>&amp;
  <span class="hljs-attr">serverTimezone</span>=Asia/Shanghai
</code></pre>
<p>连接类型选 <strong>Generic database</strong>，Driver class 填 <code>com.mysql.cj.jdbc.Driver</code>，Options 表格留空。</p>
<hr/>
<p>这次排查花了我大半天时间，但搞清楚原理后，以后再遇到类似问题就能秒解。希望这篇记录能帮你少走弯路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Paimon源码解读 -- PartialUpdateMerge]]></title>    <link>https://juejin.cn/post/7576838095518793779</link>    <guid>https://juejin.cn/post/7576838095518793779</guid>    <pubDate>2025-11-26T08:45:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576838095518793779" data-draft-id="7576307259385282587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Paimon源码解读 -- PartialUpdateMerge"/> <meta itemprop="keywords" content="后端,大数据,Flink"/> <meta itemprop="datePublished" content="2025-11-26T08:45:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="expect7g"/> <meta itemprop="url" content="https://juejin.cn/user/3514471387235735"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Paimon源码解读 -- PartialUpdateMerge
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3514471387235735/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    expect7g
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T08:45:49.000Z" title="Wed Nov 26 2025 08:45:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一.父接口MergeFunction</h2>
<p>其实现子类如下图</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daf9fba698f7473fa2181dbd37491923~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZXhwZWN0N2c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751549&amp;x-signature=155mxf12PrZdVJ0K2qzUUPgTt5w%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到，Paimon中所有的Merge Engine都实现了MergeFunction接口，那么继续看该接口中的4个抽象方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MergeFunction</span>&lt;T&gt; {

    <span class="hljs-comment">/**
     * 重置方法，该方法在add()前或getResult()后被调用
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">reset</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 合并方法：将输入的kv加入到合并function中，进行合并
     * <span class="hljs-doctag">@param</span> kv
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(KeyValue kv)</span>;

    <span class="hljs-comment">/**
     * 获取结果：获取当前合并后的结果
     * <span class="hljs-doctag">@return</span>
     */</span>
    T <span class="hljs-title function_">getResult</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 缓存：按需复制输入来的kv，放入内存中
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">requireCopy</span><span class="hljs-params">()</span>;
}
</code></pre>
<h2 data-id="heading-1">二.PartialUpdateMergeFunction</h2>
<h3 data-id="heading-2">1.属性和关键函数</h3>
<h4 data-id="heading-3">(1) 属性和构造函数</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SEQUENCE_GROUP</span> <span class="hljs-operator">=</span> <span class="hljs-string">"sequence-group"</span>; <span class="hljs-comment">// 序列组的标识字符串，后续会判断有没有配置sequence-group</span>
    <span class="hljs-comment">// 1.配置相关</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> InternalRow.FieldGetter[] getters; <span class="hljs-comment">// 字段取值器，可以理解为反射获取Row中字段的值</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> ignoreDelete; <span class="hljs-comment">// 是否忽略DEKETE类型，这也是和配置'ignore-delete'绑定</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;WrapperWithFieldIndex&lt;FieldsComparator&gt;&gt; fieldSeqComparators; <span class="hljs-comment">// 比较器，用于决定聚合操作中的文件的聚合顺序</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> fieldSequenceEnabled; <span class="hljs-comment">// 是否启用了field-sequnce，和配置'sequnce-group'绑定，默认是none</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;WrapperWithFieldIndex&lt;FieldAggregator&gt;&gt; fieldAggregators; <span class="hljs-comment">// field聚合器，和配置'fields.xxx.aggregate-function'绑定</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> removeRecordOnDelete; <span class="hljs-comment">// 当rowkind收到-D，是否移除该行数据，和配置'partial-update.remove-record-on-delete'绑定，默认是false不移除</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;Integer&gt; sequenceGroupPartialDelete; <span class="hljs-comment">// 当sequnce-group-delete绑定的字段收到-D，是否移除改行字段，和配置'partial-update.remove-record-on-sequence-group'绑定，默认是none，不绑定sg的delete字段</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span>[] nullables; <span class="hljs-comment">// 标识每个字段是否允许为null</span>
    <span class="hljs-comment">// 2.状态相关</span>
    <span class="hljs-keyword">private</span> InternalRow currentKey; <span class="hljs-comment">// 当前正在处理的Key主键</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> latestSequenceNumber; <span class="hljs-comment">// 当前该Key下记录的最新sequnceNumber序列号</span>
    <span class="hljs-keyword">private</span> GenericRow row; <span class="hljs-comment">// 用于缓存聚合中间结果的对象</span>
    <span class="hljs-keyword">private</span> KeyValue reused; <span class="hljs-comment">// 复用的KV对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> currentDeleteRow; <span class="hljs-comment">// 标记当前聚合的结果是否为Delete类型</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> notNullColumnFilled; <span class="hljs-comment">// 标记是否已经填充了非null列</span>

    <span class="hljs-comment">/**
     * 如果首个值为回退retract操作，且未收到insert记录，则该行的rowkind应该为RowKind.DELETE
     * 注意：如果没有收到RowKind.INSERT的数据，那么pu表的seuqnce-group可能无法正确设置currentDeleteRow
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> meetInsert; <span class="hljs-comment">// 标记是否遇到过 INSERT 类型的记录，用于处理复杂的删除逻辑。</span>

    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">PartialUpdateMergeFunction</span><span class="hljs-params">(
            InternalRow.FieldGetter[] getters,
            <span class="hljs-type">boolean</span> ignoreDelete,
            Map&lt;Integer, FieldsComparator&gt; fieldSeqComparators,
            Map&lt;Integer, FieldAggregator&gt; fieldAggregators,
            <span class="hljs-type">boolean</span> fieldSequenceEnabled,
            <span class="hljs-type">boolean</span> removeRecordOnDelete,
            Set&lt;Integer&gt; sequenceGroupPartialDelete,
            <span class="hljs-type">boolean</span>[] nullables)</span> {
        <span class="hljs-built_in">this</span>.getters = getters;
        <span class="hljs-built_in">this</span>.ignoreDelete = ignoreDelete;
        <span class="hljs-built_in">this</span>.fieldSeqComparators = getKeySortedListFromMap(fieldSeqComparators);
        <span class="hljs-built_in">this</span>.fieldAggregators = getKeySortedListFromMap(fieldAggregators);
        <span class="hljs-built_in">this</span>.fieldSequenceEnabled = fieldSequenceEnabled;
        <span class="hljs-built_in">this</span>.removeRecordOnDelete = removeRecordOnDelete;
        <span class="hljs-built_in">this</span>.sequenceGroupPartialDelete = sequenceGroupPartialDelete;
        <span class="hljs-built_in">this</span>.nullables = nullables;
    }
</code></pre>
<h4 data-id="heading-4">(2) fieldSeqComparators的创建方法</h4>
<p>该fieldSeqComparators是在Factory的构造函数中创建的，很长，我们就看相关代码即可</p>
<p><strong>这是关键点！！！</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/* 案例如下
"fields.se_sign.sequence-group" : "uids,pids,views",
"fields.views.aggregate-function" : "sum",
*/</span>
<span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : options.toMap().entrySet()) {
    <span class="hljs-type">String</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> entry.getKey(); <span class="hljs-comment">// "fields.se_sign.sequence-group"</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> entry.getValue(); <span class="hljs-comment">// "uids,pids,views"</span>
    <span class="hljs-keyword">if</span> (k.startsWith(FIELDS_PREFIX) &amp;&amp; k.endsWith(SEQUENCE_GROUP)) {
        List&lt;String&gt; sequenceFields =
                Arrays.stream(
                                k.substring(
                                                FIELDS_PREFIX.length() + <span class="hljs-number">1</span>,
                                                k.length()
                                                        - SEQUENCE_GROUP.length()
                                                        - <span class="hljs-number">1</span>)
                                        .split(FIELDS_SEPARATOR))
                        .map(fieldName -&gt; validateFieldName(fieldName, fieldNames))
                        .collect(Collectors.toList()); <span class="hljs-comment">// [se_sign]</span>
        allSequenceFields.addAll(sequenceFields); <span class="hljs-comment">// [se_sign]</span>

        Supplier&lt;FieldsComparator&gt; userDefinedSeqComparator =
                () -&gt; UserDefinedSeqComparator.create(rowType, sequenceFields, <span class="hljs-literal">true</span>); <span class="hljs-comment">// se_sign的比较器</span>
        Arrays.stream(v.split(FIELDS_SEPARATOR))
                .map(
                        fieldName -&gt;
                                fieldNames.indexOf(
                                        validateFieldName(fieldName, fieldNames)))
                .forEach(<span class="hljs-comment">// 遍历[uids,pids,views]的index</span>
                        field -&gt; {
                            <span class="hljs-keyword">if</span> (fieldSeqComparators.containsKey(field)) {
                                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(
                                        String.format(
                                                <span class="hljs-string">"Field %s is defined repeatedly by multiple groups: %s"</span>,
                                                fieldNames.get(field), k));
                            }
                            fieldSeqComparators.put(field, userDefinedSeqComparator);
                            <span class="hljs-comment">/* 生成一个map三个键值对
                              uids的index -&gt; se_sign的比较器
                              pids的index -&gt; se_sign的比较器
                              views的index -&gt; se_sign的比较器
                             */</span>
                        });

        <span class="hljs-comment">// add self</span>
        sequenceFields.forEach(
                fieldName -&gt; {
                    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> fieldNames.indexOf(fieldName);
                    fieldSeqComparators.put(index, userDefinedSeqComparator); <span class="hljs-comment">// 最后放se_sign的index -&gt; se_sign的比较器</span>
                    sequenceGroupMap.put(fieldName, index);
                });
    }
}
</code></pre>
<h3 data-id="heading-5">2.<code>reset()</code>重置方法</h3>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * 重置合并函数的所有内部状态
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reset</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.currentKey = <span class="hljs-literal">null</span>;
        <span class="hljs-built_in">this</span>.meetInsert = <span class="hljs-literal">false</span>;
        <span class="hljs-built_in">this</span>.notNullColumnFilled = <span class="hljs-literal">false</span>;
        <span class="hljs-built_in">this</span>.row = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericRow</span>(getters.length); <span class="hljs-comment">// 创建一个新的GenericRow对象作为合并结果的载体，长度与字段数量（getters.length）一致。</span>
        <span class="hljs-comment">// 注意：这里row是创建新对象而非复用旧对象，避免旧分组的数据残留影响新分组的结果</span>
        <span class="hljs-built_in">this</span>.latestSequenceNumber = <span class="hljs-number">0</span>;
        fieldAggregators.forEach(w -&gt; w.getValue().reset()); <span class="hljs-comment">// 遍历所有字段聚合器（FieldAggregator），并调用它们各自的reset()方法。这是因为聚合器（如 SUM、MAX 等）自身也维护着中间状态（例如累加和），需要为新分组重置这些状态。</span>
    }
</code></pre>
<h3 data-id="heading-6">3.<code>add()</code>合并方法 -- 核心逻辑</h3>
<h4 data-id="heading-7">(1) <code>add()</code></h4>
<ul>
<li>kv：当前来的数据</li>
<li>row：缓存的中间聚合后的数据</li>
</ul>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * 合并逻辑的核心操作
     * <span class="hljs-doctag">@param</span> kv
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(KeyValue kv)</span> {
        <span class="hljs-comment">// refresh key object to avoid reference overwritten</span>
        currentKey = kv.key();
        currentDeleteRow = <span class="hljs-literal">false</span>;
        <span class="hljs-comment">// 1.处理回撤记录，就是处理RowKind为-U或-D的</span>
        <span class="hljs-keyword">if</span> (kv.valueKind().isRetract()) {
            <span class="hljs-comment">// 初始化空行：如果还未填充非空列，则调initRow()初始化进行赋值</span>
            <span class="hljs-keyword">if</span> (!notNullColumnFilled) {
                initRow(row, kv.value());
                notNullColumnFilled = <span class="hljs-literal">true</span>;
            }

            <span class="hljs-comment">// In 0.7- versions, the delete records might be written into data file even when</span>
            <span class="hljs-comment">// ignore-delete configured, so ignoreDelete still needs to be checked</span>
            <span class="hljs-comment">// 解决Paimon0.7版本的bug，当时配置了ignore-delete不会生效，因此，这里仍然要判断一下，实现配置了ignore-delete=true 不处理</span>
            <span class="hljs-comment">// CASE-1: 若配置了ignore-delete为true，则直接跳过该条数据的处理</span>
            <span class="hljs-keyword">if</span> (ignoreDelete) {
                <span class="hljs-keyword">return</span>;
            }

            latestSequenceNumber = kv.sequenceNumber(); <span class="hljs-comment">// 更新latestSequenceNumber</span>

            <span class="hljs-comment">// CASE-2: 若开启了field-sequnece，也就是配置了'sequence-group'，则调retractWithSequenceGroup()，进行更细化的回撤处理</span>
            <span class="hljs-keyword">if</span> (fieldSequenceEnabled) {
                retractWithSequenceGroup(kv);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-comment">// CASE-3: 若配置了partial-update.remove-record-on-delete为true，且当前RowKink是-D，那么调initRow()，并标记currentDeleteRow = true 重置该行数据</span>
            <span class="hljs-keyword">if</span> (removeRecordOnDelete) {
                <span class="hljs-keyword">if</span> (kv.valueKind() == RowKind.DELETE) {
                    currentDeleteRow = <span class="hljs-literal">true</span>;
                    row = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericRow</span>(getters.length);
                    initRow(row, kv.value());
                }
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-comment">// 最后，若什么都没配置，则抛出异常，提醒用户必须选择一种回撤流的处理方式</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span>
                    String.join(
                            <span class="hljs-string">"\n"</span>,
                            <span class="hljs-string">"By default, Partial update can not accept delete records,"</span>
                                    + <span class="hljs-string">" you can choose one of the following solutions:"</span>,
                            <span class="hljs-string">"1. Configure 'ignore-delete' to ignore delete records."</span>,
                            <span class="hljs-string">"2. Configure 'partial-update.remove-record-on-delete' to remove the whole row when receiving delete records."</span>,
                            <span class="hljs-string">"3. Configure 'sequence-group's to retract partial columns. Also configure 'partial-update.remove-record-on-sequence-group' to remove the whole row when receiving deleted records of `specified sequence group`."</span>);

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(msg);
        }
        <span class="hljs-comment">// 处理正常流，也就是RowKind为+I、+U的数据</span>
        latestSequenceNumber = kv.sequenceNumber(); <span class="hljs-comment">// 更新latestSequenceNumber</span>
        <span class="hljs-keyword">if</span> (fieldSeqComparators.isEmpty()) { <span class="hljs-comment">// 若没有字段级的比较器，则调updateNonNullFields()去非空覆盖</span>
            updateNonNullFields(kv);
        } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 若配置了字段级的比较器，则调updateNonNullFields()去按sequnce-group去更新</span>
            updateWithSequenceGroup(kv); <span class="hljs-comment">// 这是重点</span>
        }
        meetInsert = <span class="hljs-literal">true</span>;
        notNullColumnFilled = <span class="hljs-literal">true</span>;
    }
</code></pre>
<h4 data-id="heading-8">(2) 调用的<code>initRow()</code>和<code>updateNonNullFields()</code></h4>
<p>这俩方法都比较简单，就是初始化赋值，字段不允许为null，但是field值为null，则抛出异常
其实就是非空覆盖</p>
<p><strong>疑问：为什么这里是覆盖，而不能聚合呢？那如果我就是建pu表的时候配置了聚合函数呢？</strong>
<strong>解答</strong>：1.3版本后，若partial-update表里面要配置aggregate-function，必须用sequnce-group指定，否则DDL就会报错<code>[ERROR] Could not execute SQL statement. Reason:   java.lang.IllegalArgumentException: Must use sequence group for aggregation functions but not found for field views.</code></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">// 初始化赋值，字段不允许为null，但是field值为null，则抛出异常</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initRow</span><span class="hljs-params">(GenericRow row, InternalRow value)</span> {
        <span class="hljs-comment">// 遍历Row类型的每一个字段，检查是否允许为null，不允许，则抛异常</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; getters.length; i++) {
            <span class="hljs-type">Object</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> getters[i].getFieldOrNull(value); <span class="hljs-comment">// 该行数据对应位置的字段值，若没有，则给null。</span>
            <span class="hljs-keyword">if</span> (!nullables[i]) {
                <span class="hljs-keyword">if</span> (field != <span class="hljs-literal">null</span>) {
                    row.setField(i, field); <span class="hljs-comment">// 给该字段进行赋值</span>
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Field "</span> + i + <span class="hljs-string">" can not be null"</span>);
                }
            }
        }
    }
    
    <span class="hljs-comment">// 逻辑和initRow类似，都是字段不允许null，但field值为null，则抛出异常</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateNonNullFields</span><span class="hljs-params">(KeyValue kv)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; getters.length; i++) {
            <span class="hljs-type">Object</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> getters[i].getFieldOrNull(kv.value());
            <span class="hljs-keyword">if</span> (field != <span class="hljs-literal">null</span>) {
                row.setField(i, field);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (!nullables[i]) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Field "</span> + i + <span class="hljs-string">" can not be null"</span>);
                }
            }
        }
    }
</code></pre>
<h4 data-id="heading-9">(3) 调用的<code>updateWithSequenceGroup()</code> -- 核心1</h4>
<p>该方法是针对配置了sequnce-group的一个合并逻辑，并且也涉及到pu模型的aggregate-function聚合操作 -- 重点！！！</p>
<p>案例：</p>
<blockquote>
<p>"fields.se_sign.sequence-group" : "uids,pids,views",<br/>
"fields.views.aggregate-function" : "sum",</p>
</blockquote>
<p>那么，sequnce-group的标记字段为：se_sign，绑定字段为：uids、pids、views</p>
<p><strong>流程如下：重点！！！</strong></p>
<ol>
<li>迭代sequnce-group的标记字段的比较器，这里是se_sign；</li>
<li>迭代field-aggregate-function字段的聚合器，这里是views的sum；</li>
<li>遍历所有字段进行比较和聚合处理：
<ol>
<li>匹配找到当前位置i的字段对应的比较器和聚合器；</li>
<li>获取i位置字段当前的累加和，row中的i位置字段值；</li>
<li>CASE-1: 处理没有匹配到的比较器的字段，说明该字段没有被sequnce-group绑定，因此直接进行更新(有聚合，就聚合；没有就直接覆盖)；</li>
<li>CASE-2：处理有匹配到的比较器的字段：
<ul>
<li>若当前行数据的sequnce-group标记字段为null，则直接跳过绑定字段和标记字段的全部处理；</li>
<li>若当前记录kv的序列值 &gt;= 缓存行row的序列值，执行聚合更新，当前行的se_sign的值 &gt;= row中的se_sign值；
<ol>
<li>当前字段是sequnce-group的<strong>标记字段</strong>，如se_sign，则进行原子性操作；</li>
<li>当前字段是sequnce-group的<strong>绑定字段</strong>，如uids、views，则直接执行覆盖或聚合操作；</li>
</ol>
</li>
<li>若当前记录kv的序列 &lt; 缓存行row的序列，但有聚合器，则仍然进行聚合；</li>
</ul>
<blockquote>
<p>这里个人认为是一个BUG，后续希望社区能修改吧，其实可以开启一个开关，针对2种不同情况</p>
<ol>
<li>有的业务是不允许覆盖维度，但是指标还是要的；</li>
<li>有的业务是维度和指标原子绑定，要么一起更新，要么全都不更新；</li>
</ol>
</blockquote>
</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateWithSequenceGroup</span><span class="hljs-params">(KeyValue kv)</span> {
        <span class="hljs-comment">/* 例如：
        "fields.se_sign.sequence-group" : "uids,pids,views",
        "fields.views.aggregate-function" : "sum",
         */</span>
        <span class="hljs-comment">// 1.迭代sequnce-group的标记字段的比较器，就是se_sign</span>
        Iterator&lt;WrapperWithFieldIndex&lt;FieldsComparator&gt;&gt; comparatorIter =
                fieldSeqComparators.iterator(); <span class="hljs-comment">// se_sign</span>
        WrapperWithFieldIndex&lt;FieldsComparator&gt; curComparator =
                comparatorIter.hasNext() ? comparatorIter.next() : <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// 2.迭代field-aggregate-function字段的聚合器</span>
        Iterator&lt;WrapperWithFieldIndex&lt;FieldAggregator&gt;&gt; aggIter = fieldAggregators.iterator(); <span class="hljs-comment">// views</span>
        WrapperWithFieldIndex&lt;FieldAggregator&gt; curAgg = aggIter.hasNext() ? aggIter.next() : <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// 记录哪些字段所属的sequnce-group为null，避免对同一个空sg组进行重复处理</span>
        <span class="hljs-type">boolean</span>[] isEmptySequenceGroup = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[getters.length];
        <span class="hljs-comment">// 3.遍历所有字段进行比较和聚合处理</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; getters.length; i++) {
            <span class="hljs-comment">// 3-1：为当前字段匹配对应的比较器和聚合器</span>
            <span class="hljs-type">FieldsComparator</span> <span class="hljs-variable">seqComparator</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (curComparator != <span class="hljs-literal">null</span> &amp;&amp; curComparator.fieldIndex == i) {
                seqComparator = curComparator.getValue();
                curComparator = comparatorIter.hasNext() ? comparatorIter.next() : <span class="hljs-literal">null</span>;
            }

            <span class="hljs-type">FieldAggregator</span> <span class="hljs-variable">aggregator</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (curAgg != <span class="hljs-literal">null</span> &amp;&amp; curAgg.fieldIndex == i) {
                aggregator = curAgg.getValue();
                curAgg = aggIter.hasNext() ? aggIter.next() : <span class="hljs-literal">null</span>;
            }

            <span class="hljs-type">Object</span> <span class="hljs-variable">accumulator</span> <span class="hljs-operator">=</span> row.getField(i); <span class="hljs-comment">// 获取i位置字段当前的累加和</span>
            <span class="hljs-comment">/* 这里的row是当前主键分组下正在构建的合并结果行
            当处理属于同一个主键的多条记录时，所有更新操作都会累积到这个 row 对象上
            当切换到下一个主键分组时，reset() 会创建一个新的 row，旧的 row 会被丢弃或输出
             */</span>
            <span class="hljs-comment">// 3-2：处理没有匹配的比较器的字段</span>
            <span class="hljs-keyword">if</span> (seqComparator == <span class="hljs-literal">null</span>) {
                <span class="hljs-type">Object</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> getters[i].getFieldOrNull(kv.value());
                <span class="hljs-keyword">if</span> (aggregator != <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 若有聚合器，则执行相应的聚合操作，如SUM、MAX等</span>
                    row.setField(i, aggregator.agg(accumulator, field));
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (field != <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 无聚合器，但字段不为null，则覆盖 其实就相当于默认是非空覆盖</span>
                    row.setField(i, field);
                }
            } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 3-3：处理有匹配的比较器的字段</span>
                <span class="hljs-comment">// CASE-1: 如果sequnce-group的标记字段是null,则跳过该绑定字段的处理，比如当前行中uids、pids、views的se_sign为null，则会跳过这三个字段的处理</span>
                <span class="hljs-keyword">if</span> (isEmptySequenceGroup(kv, seqComparator, isEmptySequenceGroup)) {
                    <span class="hljs-comment">// skip null sequence group</span>
                    <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// 跳过的是当前sequence-group标记字段的处理</span>
                }
                <span class="hljs-comment">// 当sequnce-group的标记字段不为null的情况进行处理，se_sign不为null</span>
                <span class="hljs-type">Object</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> getters[i].getFieldOrNull(kv.value());
                <span class="hljs-comment">// CASE-2: 当前记录的序列 &gt;= 缓存行的序列，执行聚合更新，就是比较se_sign的值</span>
                <span class="hljs-keyword">if</span> (seqComparator.compare(kv.value(), row) &gt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> i;

                    <span class="hljs-comment">// Multiple sequence fields should be updated at once.</span>
                    <span class="hljs-comment">// 针对多个sequnce-group标记字段，如"fields.a,b.sequence-group" : "d,e,f", 那么就会对a和b进行原子操作</span>
                    <span class="hljs-comment">// 如果当前i位置的字段是sequnce-group的标记字段，如se_sign，那么就会执行下面的if+for的原子性操作</span>
                    <span class="hljs-keyword">if</span> (Arrays.stream(seqComparator.compareFields())
                            .anyMatch(seqIndex -&gt; seqIndex == index)) {
                        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> fieldIndex : seqComparator.compareFields()) {
                            row.setField(
                                    fieldIndex, getters[fieldIndex].getFieldOrNull(kv.value()));
                        }
                        <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// 跳过的是当前sequence-group标记字段的处理</span>
                    }
                    <span class="hljs-comment">/* 更新聚合操作
                        1.有聚合器，按照聚合逻辑去操作；
                        2.无聚合器，直接覆盖
                        注意：这里的覆盖不是非空覆盖，因此，为了解决null的覆盖问题，需要配置"fields.default-aggregate-function" : "last_non_null_value", 因为默认是none
                     */</span>
                    row.setField(
                            i, aggregator == <span class="hljs-literal">null</span> ? field : aggregator.agg(accumulator, field));
                }
                <span class="hljs-comment">// CASE-3: 当前记录的序列 &lt; 结果行的序列，但有聚合器，仍然进行聚合，这个aggReversed(accumulator, field)其实就是agg(field,accumulator)参数位置换了，没区别</span>
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (aggregator != <span class="hljs-literal">null</span>) {
                    row.setField(i, aggregator.aggReversed(accumulator, field));
                }
            }
        }
    }
</code></pre>
<h4 data-id="heading-10">(4) 调用的<code>isEmptySequenceGroup()</code></h4>
<p>该方法主要用于判断sequnce-group的标记字段是否全为null的</p>
<p><strong>注意</strong>：只有全部的标记字段都为null才会进入缓存，然后再处理后续的标记字段时，只需要用缓存判断第一个字段是否为true即可</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmptySequenceGroup</span><span class="hljs-params">(
            KeyValue kv, FieldsComparator comparator, <span class="hljs-type">boolean</span>[] isEmptySequenceGroup)</span> {

        <span class="hljs-comment">// If any flag of the sequence fields is set, it means the sequence group is empty.</span>
        <span class="hljs-comment">// CASE-1. 缓存命中：快速判断序列组第一个标记字段是否为空，为空，则直接return true了</span>
        <span class="hljs-comment">// 这里需要结合CASE-3才能解释，只有全部的标记字段都为null才会进入缓存，然后再处理后续的标记字段时，只需要用缓存判断第一个字段是否为true即可</span>
        <span class="hljs-keyword">if</span> (isEmptySequenceGroup[comparator.compareFields()[<span class="hljs-number">0</span>]]) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-comment">// CASE-2.遍历全部的sequnce-group的标记字段，进行能判空，有一个不为null，则return false；</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> fieldIndex : comparator.compareFields()) {
            <span class="hljs-keyword">if</span> (getters[fieldIndex].getFieldOrNull(kv.value()) != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }

        <span class="hljs-comment">// Set the flag of all the sequence fields of the sequence group.</span>
        <span class="hljs-comment">// CASE-3.缓存全部为null的sequnce-group标记字段</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> fieldIndex : comparator.compareFields()) {
            isEmptySequenceGroup[fieldIndex] = <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
</code></pre>
<h4 data-id="heading-11">(5) 调用的<code>retractWithSequenceGroup()</code> -- 核心2</h4>
<p>代码处理逻辑和<code>updateWithSequenceGroup()</code>类似，只是最后处理有点不同，涉及到回撤操作</p>
<p>还是以上面的案例</p>
<ol>
<li>迭代sequnce-group的标记字段的比较器，这里是se_sign；</li>
<li>迭代field-aggregate-function字段的聚合器，这里是views的sum；</li>
<li>遍历所有字段进行比较和聚合处理：
<ol>
<li>匹配找到当前位置i的字段对应的比较器和聚合器；</li>
<li>只处理有匹配的比较器的字段，因为只有配置了sequnce-group的才会走到这个方法内
<ul>
<li>若当前行数据的sequnce-group标记字段为null，则直接跳过绑定字段和标记字段的全部处理；</li>
<li>若当前记录kv的序列值 &gt;= 缓存行row的序列值，执行聚合更新，当前行的se_sign的值 &gt;= row中的se_sign值；
<ol>
<li><strong>回撤标记字段</strong>，如se_sign，则调<code>init()</code>实现原子性回撤操作；</li>
<li><strong>回撤其他字段</strong>；无聚合器如uids，用null覆盖；有聚合器如views，调<code>aggregator.retract()</code>去进行回撤</li>
</ol>
<blockquote>
<p>底层如sum是做减法，max和min是没有回撤的，调FieldAggregator的会抛出异常，具体看FieldAggregator的子类</p>
</blockquote>
</li>
<li>若当前记录kv的序列 &lt; 缓存行row的序列，但有聚合器，调<code>aggregator.retract()</code>去进行回撤；</li>
</ul>
</li>
</ol>
</li>
</ol>
<blockquote>
<p>注意: 即使我们配置了"fields.default-aggregate-function" : "last_non_null_value"回撤的时候仍然是null，因为FieldLastNonNullValueAgg函数的retract就是回撤流的字段值非空则给null，空给accumulator</p>
</blockquote>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">retractWithSequenceGroup</span><span class="hljs-params">(KeyValue kv)</span> {
        <span class="hljs-comment">// 0.初始化updatedSequenceFields</span>
        Set&lt;Integer&gt; updatedSequenceFields = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        <span class="hljs-comment">// 1.迭代比较器，如se_sign</span>
        Iterator&lt;WrapperWithFieldIndex&lt;FieldsComparator&gt;&gt; comparatorIter =
                fieldSeqComparators.iterator();
        WrapperWithFieldIndex&lt;FieldsComparator&gt; curComparator =
                comparatorIter.hasNext() ? comparatorIter.next() : <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// 2.迭代聚合器，如views的sum</span>
        Iterator&lt;WrapperWithFieldIndex&lt;FieldAggregator&gt;&gt; aggIter = fieldAggregators.iterator();
        WrapperWithFieldIndex&lt;FieldAggregator&gt; curAgg = aggIter.hasNext() ? aggIter.next() : <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// 记录哪些字段所属的sequnce-group为null，避免对同一个空sg组进行重复处理，每一轮都会new一个新的，防止缓存影响</span>
        <span class="hljs-type">boolean</span>[] isEmptySequenceGroup = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[getters.length];
        <span class="hljs-comment">// 3.遍历所有字段进行比较和聚合处理</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; getters.length; i++) {
            <span class="hljs-comment">// 3-1：为当前字段匹配对应的比较器和聚合器</span>
            <span class="hljs-type">FieldsComparator</span> <span class="hljs-variable">seqComparator</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (curComparator != <span class="hljs-literal">null</span> &amp;&amp; curComparator.fieldIndex == i) {
                seqComparator = curComparator.getValue();
                curComparator = comparatorIter.hasNext() ? comparatorIter.next() : <span class="hljs-literal">null</span>;
            }

            <span class="hljs-type">FieldAggregator</span> <span class="hljs-variable">aggregator</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (curAgg != <span class="hljs-literal">null</span> &amp;&amp; curAgg.fieldIndex == i) {
                aggregator = curAgg.getValue();
                curAgg = aggIter.hasNext() ? aggIter.next() : <span class="hljs-literal">null</span>;
            }
            <span class="hljs-comment">// 3-2：只处理有匹配的比较器的字段，因为只有配置了sequnce-group的才会走到这个方法内</span>
            <span class="hljs-keyword">if</span> (seqComparator != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// CASE-1: 如果sequnce-group的标记字段是null,则跳过该绑定字段的处理，比如当前行中uids、pids、views的se_sign为null，则会跳过这三个字段的处理</span>
                <span class="hljs-keyword">if</span> (isEmptySequenceGroup(kv, seqComparator, isEmptySequenceGroup)) {
                    <span class="hljs-comment">// skip null sequence group</span>
                    <span class="hljs-keyword">continue</span>;
                }
                <span class="hljs-comment">// CASE-2: 当前记录kv的序列 &gt;= 缓存行row的序列，执行聚合更新，就是比较se_sign的值</span>
                <span class="hljs-keyword">if</span> (seqComparator.compare(kv.value(), row) &gt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> i;

                    <span class="hljs-comment">// Multiple sequence fields should be updated at once.</span>
                    <span class="hljs-comment">// (1) 原子性回撤更新序列组内的标记字段</span>
                    <span class="hljs-keyword">if</span> (Arrays.stream(seqComparator.compareFields())
                            .anyMatch(field -&gt; field == index)) {
                        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> field : seqComparator.compareFields()) {
                            <span class="hljs-comment">// 没处理过该标记字段，则进行处理</span>
                            <span class="hljs-keyword">if</span> (!updatedSequenceFields.contains(field)) {
                                <span class="hljs-comment">// 若当前的RowKind为-D，且配置的partial-update.remove-record-on-sequence-group字段为当前的标记field，则进行初始化row，然后return出去</span>
                                <span class="hljs-keyword">if</span> (kv.valueKind() == RowKind.DELETE
                                        &amp;&amp; sequenceGroupPartialDelete.contains(field)) {
                                    currentDeleteRow = <span class="hljs-literal">true</span>;
                                    row = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericRow</span>(getters.length);
                                    initRow(row, kv.value());
                                    <span class="hljs-keyword">return</span>;
                                } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 否则，直接覆盖到缓存row中</span>
                                    row.setField(field, getters[field].getFieldOrNull(kv.value()));
                                    updatedSequenceFields.add(field);
                                }
                            }
                        }
                    }
                    <span class="hljs-comment">// (2) 回撤其他字段</span>
                    <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// retract normal field</span>
                        <span class="hljs-comment">// 若没有聚合器，则用null覆盖</span>
                        <span class="hljs-keyword">if</span> (aggregator == <span class="hljs-literal">null</span>) {
                            row.setField(i, <span class="hljs-literal">null</span>);
                        } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 若有聚合器，则调aggregator.retract()去进行回撤，底层如sum是做减法，max和min是没有回撤的，调FieldAggregator的会抛出异常，具体看FieldAggregator的子类</span>
                            <span class="hljs-comment">// retract agg field</span>
                            <span class="hljs-type">Object</span> <span class="hljs-variable">accumulator</span> <span class="hljs-operator">=</span> getters[i].getFieldOrNull(row);
                            row.setField(
                                    i,
                                    aggregator.retract(
                                            accumulator, getters[i].getFieldOrNull(kv.value())));
                        }
                    }
                }
                <span class="hljs-comment">// CASE-3: 当前记录的序列 &lt; 结果行的序列，但有聚合器，调aggregator.retract()去进行回撤</span>
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (aggregator != <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// retract agg field for old sequence</span>
                    <span class="hljs-type">Object</span> <span class="hljs-variable">accumulator</span> <span class="hljs-operator">=</span> getters[i].getFieldOrNull(row);
                    row.setField(
                            i,
                            aggregator.retract(accumulator, getters[i].getFieldOrNull(kv.value())));
                }
            }
        }
    }
</code></pre>
<h3 data-id="heading-12">4.<code>getResult()</code>获取合并后的结果</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取合并后的结果</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> KeyValue <span class="hljs-title function_">getResult</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 采用reused缓存kv实例，避免频繁创建对象</span>
    <span class="hljs-keyword">if</span> (reused == <span class="hljs-literal">null</span>) {
        reused = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyValue</span>();
    }
    <span class="hljs-comment">/* 根据两个状态判断最终的变更类型
        1. currentDeleteRow：标记 “当前记录是否需要被删除”，在上面retractWithSequenceGroup中执行-D回撤的时候会赋true
        2. !meetInsert：标记 “当前记录是否不满足插入条件”，重置是false，add会给true
    若currentDeleteRow为true 或 !meetInsert为true：生成RowKind.DELETE
     */</span>
    <span class="hljs-type">RowKind</span> <span class="hljs-variable">rowKind</span> <span class="hljs-operator">=</span> currentDeleteRow || !meetInsert ? RowKind.DELETE : RowKind.INSERT;
    <span class="hljs-keyword">return</span> reused.replace(currentKey, latestSequenceNumber, rowKind, row); <span class="hljs-comment">// 更新合并后的结果并返回</span>
}
</code></pre>
<h3 data-id="heading-13">5.<code>requireCopy()</code></h3>
<p>不需要复制</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">requireCopy</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h2 data-id="heading-14">三.总结</h2>
<p>首先是参数配置</p>
<ol>
<li>private final boolean ignoreDelete; -&gt; 由<code>ignore-delete</code>配置绑定;</li>
<li>private final List&lt;WrapperWithFieldIndex&gt; fieldSeqComparators; -&gt; 由<code>sequnce-group</code>配置绑定;</li>
<li>private final boolean fieldSequenceEnabled; -&gt; 上面参数fieldSeqComparators不为空，则它为true;</li>
<li>private final List&lt;WrapperWithFieldIndex&gt; fieldAggregators; -&gt; 由<code>aggregate-function</code>绑定;</li>
<li>private final boolean removeRecordOnDelete; -&gt; 由<code>partial-update.remove-record-on-delete</code>配置绑定;</li>
<li>private final Set sequenceGroupPartialDelete; -&gt; 由<code>partial-update.remove-record-on-sequence-group</code>配置绑定；</li>
</ol>
<p>其次是add聚合流程
案例：</p>
<blockquote>
<p>"fields.se_sign.sequence-group" : "uids,pids,views",<br/>
"fields.views.aggregate-function" : "sum",</p>
</blockquote>
<ol>
<li>若当前行kv数据的RowKind为-U/-D，则进行回撤操作;</li>
<li>若当前行kv数据的RowKind为+I/+U，则进行update聚合更新操作;</li>
<li>重点是配置sequnce-group的字段，分为标记字段和绑定字段
<ul>
<li>标记字段：如se_sign，会进行原子性回撤/更新 -- 其实就是覆盖</li>
<li>绑定字段：如uids、views，会进行回撤/更新
<ul>
<li>非聚合的：回撤会直接给null；更新是直接覆盖</li>
<li>聚合的：调聚合器的retract()回撤，如sum就是做减法；更新是直接调agg()聚合，如sum是做加法</li>
</ul>
</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[游戏上架 App Store 的完整发行流程，从构建、合规到审核的多角色协同指南]]></title>    <link>https://juejin.cn/post/7576698454925672454</link>    <guid>https://juejin.cn/post/7576698454925672454</guid>    <pubDate>2025-11-26T09:15:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576698454925672454" data-draft-id="7576821684251951147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="游戏上架 App Store 的完整发行流程，从构建、合规到审核的多角色协同指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T09:15:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bcbnb"/> <meta itemprop="url" content="https://juejin.cn/user/895474073078377"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            游戏上架 App Store 的完整发行流程，从构建、合规到审核的多角色协同指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474073078377/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bcbnb
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T09:15:52.000Z" title="Wed Nov 26 2025 09:15:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>移动游戏的 iOS 上架流程，与普通工具类应用相比要复杂得多。
除了基本的构建、证书管理、素材提交之外，游戏类应用需要额外面对内容审查、支付规范、账号体系、数据配置、玩法展示等多维检查。对一个游戏团队而言，上架并不是单纯的技术交付，而是一套 <strong>技术、合规、运营、版本管理、审核沟通</strong> 协同的过程。</p>
<p>本文以“游戏上架 App Store”为主题，从团队视角拆解上架前中后的关键步骤，并给出不同工具链在协作中的实际分工方式。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、上架前的准备：账号体系、内容合规与内部版本冻结</strong></h2>
<h3 data-id="heading-1"><strong>1. 开发者账号与权限管理</strong></h3>
<p>游戏属于高复杂度应用，必须准备：</p>
<ul>
<li>Apple Developer Program（组织类型更适合游戏团队）</li>
<li>App Store Connect 角色划分</li>
<li>专人负责证书与密钥管理</li>
<li>审核沟通账号</li>
</ul>
<p>多人游戏或服务端依赖强的产品，通常需要多人权限协同，因此账号结构在上架前就需要设置到位。</p>
<hr/>
<h3 data-id="heading-2"><strong>2. 内容合规预审（避免 4.3、4.7、5.1 等拒审）</strong></h3>
<p>游戏比工具类应用多几个特殊审查点：</p>
<ul>
<li>是否包含赌博、抽奖、开箱概率机制</li>
<li>是否有玩家间互动（需隐私说明 + 举报机制）</li>
<li>是否包含用户生成内容（UGC）</li>
<li>是否涉及实名认证、账号绑定</li>
<li>是否包含未披露的第三方 SDK</li>
<li>是否含“敏感情节”或可能被误判的内容元素</li>
</ul>
<p>在正式提交前，运营或策划通常需要做一次内容自查。</p>
<hr/>
<h3 data-id="heading-3"><strong>3. 内部版本冻结</strong></h3>
<p>游戏团队通常在上架前进行一次 freeze（冻结版本）：</p>
<ul>
<li>代码锁定</li>
<li>玩法不再改动</li>
<li>文案与引导不再修改</li>
<li>与服务端协议保持一致</li>
</ul>
<p>这样能有效降低审核期间的返工概率。</p>
<hr/>
<h2 data-id="heading-4"><strong>二、构建 IPA：游戏类项目的特殊要求</strong></h2>
<p>无论是 Unity、Cocos Creator、Unreal，还是原生开发，游戏的构建链路普遍较重。</p>
<h3 data-id="heading-5"><strong>1. Unity / Cocos / Unreal 项目：导出 Xcode 工程</strong></h3>
<p>主流游戏引擎输出流程一致：</p>
<ul>
<li>引擎构建</li>
<li>导出 Xcode 项目</li>
<li>在 Xcode 中 Archive</li>
<li>生成 App Store 构建包（IPA）</li>
</ul>
<p>针对游戏资源量大的特点，必须注意：</p>
<ul>
<li>场景资源压缩</li>
<li>包体大小（避免超过下载限制）</li>
<li>加载速度与首次启动体验（审核会检查）</li>
</ul>
<hr/>
<h3 data-id="heading-6"><strong>2. Hybrid + 游戏引擎混合方案</strong></h3>
<p>某些轻游戏会采用：</p>
<ul>
<li>H5 + 原生壳</li>
<li>WebGL + 原生容器</li>
</ul>
<p>这类组合需要特别关注：</p>
<ul>
<li>首屏加载速度</li>
<li>网络资源请求是否稳定</li>
<li>权限是否由原生触发</li>
</ul>
<p>避免触发 2.1（功能不可用）拒审。</p>
<hr/>
<h3 data-id="heading-7"><strong>3. 构建环境差异：本地 Mac 与云构建</strong></h3>
<p>游戏工程量大，本地打包常出现：</p>
<ul>
<li>内存不足</li>
<li>Unity 版本不一致</li>
<li>Xcode 版本冲突</li>
</ul>
<p>越来越多团队使用：</p>
<ul>
<li>GitHub Actions</li>
<li>Codemagic</li>
<li>Appcircle</li>
</ul>
<p>进行 iOS 构建，使流程更稳定。</p>
<hr/>
<h2 data-id="heading-8"><strong>三、IPA 上传：多人协作下的多工具组合策略</strong></h2>
<p>游戏上架通常需要多次反复提交（TF 测试、多轮审核、紧急热修等），上传工具的角色显得更加重要。</p>
<h3 data-id="heading-9"><strong>1. Transporter（官方 Mac 工具）</strong></h3>
<p>适用于本地上传测试版：</p>
<ul>
<li>上传成功率高</li>
<li>错误反馈清晰</li>
<li>但局限于 macOS</li>
</ul>
<hr/>
<h3 data-id="heading-10"><strong>2. 开心上架（Appuploader）跨平台命令行工具：适合高频构建场景</strong></h3>
<p>游戏团队常使用能够在 <strong>Windows / Linux / macOS</strong> 上运行的命令行上传工具，用于：</p>
<ul>
<li>自动化发布流水线</li>
<li>多人并行上传</li>
<li>TF 连续测试版迭代</li>
</ul>
<p>典型使用场景示例：</p>
<pre><code class="hljs language-sql" lang="sql">appuploader_cli \
  <span class="hljs-operator">-</span>u game_team<span class="hljs-variable">@studio</span>.com \
  <span class="hljs-operator">-</span>p xxx<span class="hljs-operator">-</span>xxx<span class="hljs-operator">-</span>xxx<span class="hljs-operator">-</span>xxx \
  <span class="hljs-operator">-</span>c <span class="hljs-number">2</span> \
  <span class="hljs-operator">-</span>f .<span class="hljs-operator">/</span><span class="hljs-keyword">release</span><span class="hljs-operator">/</span>game_build.ipa
</code></pre>
<p>适合：</p>
<ul>
<li>版本迭代频繁的竞技类游戏</li>
<li>TF 测试量大的多人游戏</li>
<li>多系统协作的项目团队</li>
</ul>
<p>上传成功后会自动出现在 TestFlight 或“准备提交”中。</p>
<p>图形化界面：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cd1f84b3bc1483d86ac49d5b3ccbf75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmNibmI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753352&amp;x-signature=Fmaxv390EpVSrxlTtFgdryNuvgM%3D" alt="ipa上传" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-11"><strong>四、App Store Connect 提交阶段：游戏需要额外关注的内容</strong></h2>
<p>与工具类应用相比，游戏提交阶段的内容更加细化。</p>
<hr/>
<h3 data-id="heading-12"><strong>1. 评级（Age Rating）</strong></h3>
<p>游戏通常涉及：</p>
<ul>
<li>暴力</li>
<li>竞赛</li>
<li>用户互动</li>
<li>虚拟货币</li>
<li>成就系统</li>
</ul>
<p>评级问卷填写必须精准，否则会因“评级不一致”被拒审。</p>
<hr/>
<h3 data-id="heading-13"><strong>2. 内购（IAP）配置</strong></h3>
<p>游戏的 IAP 结构比普通应用复杂得多，包括：</p>
<ul>
<li>虚拟货币</li>
<li>月卡 / 订阅</li>
<li>道具</li>
<li>付费解锁</li>
<li>加速包等</li>
</ul>
<p>常见拒审原因：</p>
<ul>
<li>商品未绑定到构建版本</li>
<li>购买流程失败</li>
<li>商品图标与说明不一致</li>
<li>未提供退款机制说明</li>
</ul>
<p>团队通常在 TF 阶段先验证所有 IAP。</p>
<hr/>
<h3 data-id="heading-14"><strong>3. 隐私政策 + 数据收集说明</strong></h3>
<p>游戏普遍使用大量第三方 SDK：</p>
<ul>
<li>日志</li>
<li>广告</li>
<li>分析</li>
<li>登录（微信、Facebook）</li>
<li>崩溃上报</li>
<li>云存档</li>
</ul>
<p>必须全部在 App Store Connect 中披露。</p>
<hr/>
<h3 data-id="heading-15"><strong>4. 截图与预览视频</strong></h3>
<p>游戏类别对视觉素材要求更高：</p>
<ul>
<li>截图必须展示游戏真实玩法</li>
<li>不得展示未上线内容</li>
<li>文案不能夸大宣传</li>
</ul>
<p>预览视频的审核难度比截图更高，团队通常先提交截图，通过审核后再补视频。</p>
<hr/>
<h2 data-id="heading-16"><strong>五、审核阶段：游戏应用专属的风险点</strong></h2>
<p>游戏审核时间通常比工具类更长，常见 3–7 天。</p>
<p>下面是最易触发拒审的几个类别。</p>
<hr/>
<h3 data-id="heading-17"><strong>1. 2.1 – 功能不可用（最常见）</strong></h3>
<p>原因包括：</p>
<ul>
<li>服务器无法访问</li>
<li>登陆失败</li>
<li>新手引导异常</li>
<li>网络加载超时</li>
<li>多人战斗无法匹配</li>
</ul>
<p>审核环境与真实玩家环境不同，因此稳定性必须提前处理。</p>
<hr/>
<h3 data-id="heading-18"><strong>2. 3.1.1 – 使用未公开的支付方式</strong></h3>
<p>例如：</p>
<ul>
<li>引导玩家去网页充值</li>
<li>引导外部购买道具</li>
<li>非 IAP 的虚拟货币入口</li>
</ul>
<p>游戏最常见的违规点。</p>
<hr/>
<h3 data-id="heading-19"><strong>3. 5.1.1 – 数据收集未披露</strong></h3>
<p>游戏登录常包含：</p>
<ul>
<li>设备信息</li>
<li>广告 ID</li>
<li>行为数据</li>
</ul>
<p>必须与“隐私营养标签”一致。</p>
<hr/>
<h3 data-id="heading-20"><strong>4. 4.3 – 重复内容</strong></h3>
<p>如果多个游戏共享同一套引擎资源、模板、UI 结构，可能被判定为重复。</p>
<hr/>
<h2 data-id="heading-21"><strong>六、发布后的运营协同</strong></h2>
<h3 data-id="heading-22"><strong>1. TF 多轮验证</strong></h3>
<p>典型流程：</p>
<ol>
<li>提交 TF</li>
<li>玩法测试</li>
<li>内购验证</li>
<li>崩溃监控（Crashlytics）</li>
<li>性能优化</li>
<li>正式提交审核</li>
</ol>
<hr/>
<h3 data-id="heading-23"><strong>2. 版本策略</strong></h3>
<p>游戏正式版本应避免过度频繁更新，因为每次都要重新审核。</p>
<hr/>
<h3 data-id="heading-24"><strong>3. 异常回滚与紧急修复</strong></h3>
<p>游戏团队一般会保留：</p>
<ul>
<li>快速构建通道</li>
<li>快速上传通道</li>
<li>TF 热修版本</li>
</ul>
<p>避免上线故障影响用户。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[逐步手写，实现符合 Promise A+ 规范的 Promise]]></title>    <link>https://juejin.cn/post/7576681897297625103</link>    <guid>https://juejin.cn/post/7576681897297625103</guid>    <pubDate>2025-11-26T08:23:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576681897297625103" data-draft-id="7576827115967561763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="逐步手写，实现符合 Promise A+ 规范的 Promise"/> <meta itemprop="keywords" content="前端,JavaScript,算法"/> <meta itemprop="datePublished" content="2025-11-26T08:23:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹿鹿鹿鹿isNotDefined"/> <meta itemprop="url" content="https://juejin.cn/user/4227000939061086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            逐步手写，实现符合 Promise A+ 规范的 Promise
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4227000939061086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹿鹿鹿鹿isNotDefined
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T08:23:17.000Z" title="Wed Nov 26 2025 08:23:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>之前找工作的时候凭感觉做了一个<strong>实现 Promise A+ 规范的 Promise</strong>的练习，最近在准备新的工作机会，又看到了这个面试题。</p>
<p>我感觉之前的实现有很大优化空间。之前用前次调用结果作为标记来实现 Promise 多次 resolve 和 reject 触发的正确逻辑，感觉有点太麻烦了，<del>通过和 AI 的深入交流</del>，这完全可以用简单的布尔值标记做到。</p>
<p>这篇博客权当是复习吧...</p>
<h2 data-id="heading-1">简介 Promise A+ 规范</h2>
<h3 data-id="heading-2">变量和术语</h3>
<p>Promise 表示异步操作的最终结果。</p>
<ol>
<li>Promise 具有 3 种状态：pending（等待中）、fulfilled（成功执行）、rejected（失败拒绝），初始状态为 pending，切换为 fulfilled 或者 rejected 后就不能再转换。处于非 pending 状态时称为 settled。</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> testPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-comment">// DO SOMETHING</span>
})
</code></pre>
<p>像这样子，传入的函数我们称为<code>executor</code>，<code>resolve</code>和<code>reject</code>会触发 Promise 的状态改变以及数据更新。</p>
<p><code>value</code>表示成功执行（fulfilled 状态）的 Promise 的结果，<code>reason</code>表示失败拒绝（rejected 状态）的 Promise 的原因，它们可以取 JS 中任何合法的值。</p>
<blockquote>
<p>Promise A+ 规范的 Promise 上的方法只有简单的<code>then</code>，<code>catch</code>、<code>finally</code>之类的方法并不包含。</p>
</blockquote>
<pre><code class="hljs language-mermaid" lang="mermaid">graph
    A[创建Promise] --&gt; B["执行executor(resolve, reject)"]
    
    
    F{"executor执行结果?"}
    C --&gt;|settled|G[忽略重复调用]
    C --&gt;|not settled|E
    B --&gt; F
    
    F --&gt;|"调用resolve(value)"| I{"Promise settled?"}
    I --&gt;|settled|G
    I --&gt;|not settled| D["状态: pending → fulfilled&lt;br&gt;存储value"]
    
    F --&gt;|抛出异常| C
    F --&gt;|"调用reject(reason)"| C{"Promise settled?"}
    E["状态: pending → rejected&lt;br&gt;存储reason"]
    

    F --&gt;|"当前未执行resolve和reject，没有抛出异常"| H[pending]
    
    style A fill:#e1f5ff
    style B fill:#e1f5ff
</code></pre>
<h3 data-id="heading-3">then 方法</h3>
<ol start="2">
<li><code>then</code>方法具有<code>onFulfilled</code>和<code>onRejected</code>两个入参，返回一个 Promise（链式调用）。</li>
</ol>
<p>举个栗子：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> temp = testPromise.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">onFulfilled</span> (value) {
  <span class="hljs-comment">// DO SOMETHING</span>
}, <span class="hljs-keyword">function</span> <span class="hljs-title function_">onRejected</span> (reason) {
  <span class="hljs-comment">// DO SOMETHING</span>
})
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(temp <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(temp === testPromise) <span class="hljs-comment">// false</span>
</code></pre>
<ul>
<li>
<p>Promise 从 pending 状态切换到 fulfilled 或者 rejected 时，执行此前<code>then</code>传入的<code>onFulfilled</code>或<code>onRejected</code>。fulfilled 状态的 Promise 会执行<code>then</code>传入的<code>onFulfilled</code>，rejected 状态的 Promise 会执行<code>then</code>传入的<code>onRejected</code>。</p>
</li>
<li>
<p>执行<code>onFulfilled</code>或<code>onRejected</code>的结果会被传入新的 Promise <code>temp</code>的<code>resolve</code>方法中，如果发生了错误则传入<code>reject</code>中，改变的状态和数据。</p>
</li>
<li>
<p><code>onFulfilled</code>或者<code>onRejected</code>不是函数时，返回的 Promise 与原 Promise 具有相同的状态和数据（传值穿透）。</p>
</li>
</ul>
<p>用一个流程图总结一下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph 
    
    F["调用promise.then(onFulfilled, onRejected)"] --&gt; G{"当前状态?"}
    
    G --&gt;|pending| H["注册回调到队列&lt;br&gt;等待状态改变"]
    G --&gt;|fulfilled| I["异步执行onFulfilled(value)"]
    G --&gt;|rejected| J["异步执行onRejected(reason)"]
    
    I --&gt; K{"onFulfilled返回值?"}
    J --&gt; L{"onRejected返回值?"}
    
    K --&gt;|正常返回| M["Promise Resolution Procedure"]
    L --&gt;|正常返回| M
    K --&gt;|抛出异常| O["调用新Promise的reject&lt;br&gt;状态: rejected"]
    L --&gt;|抛出异常| O
    
    H --&gt;|状态变为fulfilled| I
    H --&gt;|状态变为rejected| J
    
    O --&gt; Z[返回新Promise]

    style F fill:#fff2e1
    style G fill:#f0e1ff
    style M fill:#e8f5e9
    style H fill:#fff9c4
</code></pre>
<h3 data-id="heading-4">Promise Resolution Procedure</h3>
<ol start="3">
<li><code>resolve</code>被触发时发生什么事了？此时 Promise 的状态仍未真正变化，会进入一段处理程序，规范称之为 Promise Resolution Procedure，主要逻辑是如果传入的是非 thenable 对象或者基本类型则直接修改 Promise 的状态和数据，是 thenable 就执行下面 thenable 相关逻辑。</li>
</ol>
<ul>
<li>此外，不支持我返回我自己，<code>onFulfilled</code>或者<code>onRejected</code>返回该<code>then</code>返回的 Promise 时，抛出<code>TypeError</code>错误，例如：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> temp = testPromise.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">onFulfilled</span> (value) {
  <span class="hljs-keyword">return</span> temp
})
</code></pre>
<h3 data-id="heading-5">处理 thenable 对象</h3>
<ol start="4">
<li>thenable 的对象是具有<code>then</code>方法的对象或者函数。<code>then</code>方法接受两个回调函数<code>onResolvePromise</code>和<code>onRejectPromise</code>，类似于这里的 Promise 的<code>then</code>。thenable 实际上包括实现了 Promise A+ 规范的 Promise，例如 ES6 原生的 Promise。举个 thenable 对象的栗子：</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> thenable = {
  <span class="hljs-attr">then</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">onResolvePromise, onRejectPromise</span>) {
    <span class="hljs-title function_">onResolvePromise</span>(<span class="hljs-string">'miao~~'</span>)
  }
}
</code></pre>
<ul>
<li>
<p>如果触发了<code>onFulfilled</code>，返回了一个 thenable。如果是该 Promise 的实例，不是当前 Promise，则传入当前 Promise 的<code>resolve</code>和<code>reject</code>，调用<code>then</code>方法。</p>
</li>
<li>
<p>兼容其他 thenable：调用<code>then</code>方法，传入当前 Promise 的<code>resolve</code>和<code>reject</code>，像该 Promise 实例一样解析。</p>
</li>
<li>
<p><del>允许其他 thenable 对象乱写</del>，这里需要处理 thenable 对象重复触发<code>onResolvePromise</code>或/和<code>onRejectPromise</code>的情况，这两个回调函数最多只能改变 1 次 Promise 的状态。</p>
</li>
</ul>
<ol start="5">
<li>其他详细见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpromisesaplus.com%2F" target="_blank" title="https://promisesaplus.com/" ref="nofollow noopener noreferrer">Promise A+</a> 规范。</li>
</ol>
<p>这里再用个流程图总结一下</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph 
    M["Promise Resolution Procedure"]
    
    M --&gt; P{返回值是thenable?}
    P --&gt;|是| Q{是否返回自身?}
    Q --&gt;|是| R[抛出TypeError]
    Q --&gt;|否| S["调用thenable.then(resolvePromise, rejectPromise)"]
    
    P --&gt;|否| N
    
    S --&gt; T{thenable行为?}
    T --&gt;|"调用resolvePromise(x)"| U{Promise settled?}
    T --&gt;|"调用rejectPromise(reason)"| V{Promise settled?}
    T --&gt;|抛出异常| O[调用新Promise的reject&lt;br&gt;状态: rejected]
    
    U --&gt;|not settled| W["状态: fulfilled&lt;br&gt;value = x"]
    V --&gt;|not settled| X["状态: rejected&lt;br&gt;reason = reason"]
    U --&gt;|settled| Y[忽略重复调用]
    V --&gt;|settled| Y
    
    N[调用新Promise的resolve&lt;br&gt;状态: fulfilled] --&gt; Z[返回新Promise]
    O --&gt; Z
    W --&gt; Z
    X --&gt; Z
    R --&gt; AA["返回rejected Promise&lt;br&gt;reason = TypeError"]

    style M fill:#e8f5e9
</code></pre>
<h2 data-id="heading-6">前期准备</h2>
<p>先定义好类型和一个发起微任务的辅助函数。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">PromiseState</span> {
  fulfilled = <span class="hljs-string">'fulfilled'</span>,
  pending = <span class="hljs-string">'pending'</span>,
  rejected = <span class="hljs-string">'rejected'</span>
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Executor</span>&lt;T&gt; = <span class="hljs-function">(<span class="hljs-params">
  resolve: (value: T | PromiseLike&lt;T&gt;) =&gt; <span class="hljs-built_in">void</span>,
  reject: (reason?: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">void</span>
</span>) =&gt;</span> <span class="hljs-built_in">void</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">scheduleMicrotask</span> = (<span class="hljs-params">callback: () =&gt; <span class="hljs-built_in">void</span></span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> queueMicrotask === <span class="hljs-string">'function'</span>) {
    <span class="hljs-title function_">queueMicrotask</span>(callback)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> process !== <span class="hljs-string">'undefined'</span> &amp;&amp; process.<span class="hljs-property">nextTick</span>) {
    process.<span class="hljs-title function_">nextTick</span>(callback)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(callback)
  }
}
</code></pre>
<h2 data-id="heading-7">简单地写一个 Promise</h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ShikaPromise</span>&lt;T = <span class="hljs-built_in">any</span>&gt; {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">state</span>: <span class="hljs-title class_">PromiseState</span> = <span class="hljs-title class_">PromiseState</span>.<span class="hljs-property">pending</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">value</span>: T | <span class="hljs-literal">undefined</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">reason</span>: <span class="hljs-built_in">any</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">executor: Executor&lt;T&gt;</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-title function_">executor</span>(
        <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolve</span>(value),
        <span class="hljs-function">(<span class="hljs-params">reason</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reject</span>(reason)
      )
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reject</span>(error)
    }
  }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-attr">value</span>: T): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 不支持 resolve 自己</span>
    <span class="hljs-keyword">if</span> (value === <span class="hljs-variable language_">this</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Cannot resolve promise with itself'</span>))
      <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-title function_">scheduleMicrotask</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-title class_">PromiseState</span>.<span class="hljs-property">fulfilled</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value
    })
  }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">reject</span>(<span class="hljs-attr">reason</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-title function_">scheduleMicrotask</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-title class_">PromiseState</span>.<span class="hljs-property">rejected</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason
    })
  }
  then&lt;<span class="hljs-title class_">TResult1</span> = T, <span class="hljs-title class_">TResult2</span> = <span class="hljs-built_in">never</span>&gt;(
    onFulfilled?: (<span class="hljs-function">(<span class="hljs-params">value: T</span>) =&gt;</span> <span class="hljs-title class_">TResult1</span> | <span class="hljs-title class_">PromiseLike</span>&lt;<span class="hljs-title class_">TResult1</span>&gt;) | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>,
    onRejected?: (<span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-title class_">TResult2</span> | <span class="hljs-title class_">PromiseLike</span>&lt;<span class="hljs-title class_">TResult2</span>&gt;) | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>
  ) {
    <span class="hljs-comment">// TODO</span>
  }
}
</code></pre>
<p>下面就来写<code>then</code>方法实现异步的链式调用。</p>
<h2 data-id="heading-8">then 方法</h2>
<p><code>then</code>返回一个 Promise，虽然 Promise A+ 规范没有说明需要返回的 Promise 不能和原有的是同一个，但是考虑到后续链式调用也会涉及到 Promise 状态的改变，所以这里就返回一个新的 Promise。</p>
<h3 data-id="heading-9">fulfilled 和 rejected 状态</h3>
<p>假设<code>const promise2 = promise1.then(onFulfilled, onRejected)</code>，调用<code>promise1.then</code>时创建一个新的 Promise <code>promise2</code>返回出去。用过 ES6 的<code>Promise</code>很好理解，如果原有<code>promise1</code>是 fulfilled 的，则在新的<code>promise2</code>的<code>executor</code>中的<code>resolve</code>传入<code>onFulfilled</code>的结果，如果<code>promise1</code>处于失败状态，rejected 了，则在<code>promise2</code>的<code>resolve</code>中传入<code>onRejected</code>的结果。</p>
<p>举个栗子：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> promiseTmp1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'ok'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> reason)
<span class="hljs-comment">// 此时 promiseTmp1.value 是 'ok'</span>
<span class="hljs-keyword">const</span> promiseTmp2 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'error'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> reason)
<span class="hljs-comment">// 此时 promiseTmp2.value 是 'error'</span>
</code></pre>
<p>下面编写 fulfilled 和 rejected 状态的处理逻辑。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ...</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ShikaPromise</span> {
  <span class="hljs-comment">// ...</span>
  then&lt;<span class="hljs-title class_">TResult1</span> = T, <span class="hljs-title class_">TResult2</span> = <span class="hljs-built_in">never</span>&gt;(
    onFulfilled?: (<span class="hljs-function">(<span class="hljs-params">value: T</span>) =&gt;</span> <span class="hljs-title class_">TResult1</span> | <span class="hljs-title class_">PromiseLike</span>&lt;<span class="hljs-title class_">TResult1</span>&gt;) | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>,
    onRejected?: (<span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-title class_">TResult2</span> | <span class="hljs-title class_">PromiseLike</span>&lt;<span class="hljs-title class_">TResult2</span>&gt;) | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>
  ): <span class="hljs-title class_">ShikaPromise</span>&lt;<span class="hljs-title class_">TResult1</span> | <span class="hljs-title class_">TResult2</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShikaPromise</span>&lt;<span class="hljs-title class_">TResult1</span> | <span class="hljs-title class_">TResult2</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCallback</span> = (<span class="hljs-params">isFulfilled: <span class="hljs-built_in">boolean</span></span>) =&gt; {
        <span class="hljs-title function_">scheduleMicrotask</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">const</span> callback = isFulfilled ? onFulfilled : onRejected
          <span class="hljs-keyword">const</span> data = isFulfilled ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>
          <span class="hljs-comment">// 传值穿透</span>
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">'function'</span>) {
            <span class="hljs-keyword">if</span> (isFulfilled) {
              <span class="hljs-title function_">resolve</span>(data <span class="hljs-keyword">as</span> <span class="hljs-title class_">TResult1</span>)
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-title function_">reject</span>(data)
            }
            <span class="hljs-keyword">return</span>
          }

          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">callback</span>(data)
            <span class="hljs-title function_">resolve</span>(result)
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">reject</span>(error)
          }
        })
      }

      <span class="hljs-keyword">switch</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">PromiseState</span>.<span class="hljs-property">fulfilled</span>:
          <span class="hljs-title function_">handleCallback</span>(<span class="hljs-literal">true</span>)
          <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">PromiseState</span>.<span class="hljs-property">rejected</span>:
          <span class="hljs-title function_">handleCallback</span>(<span class="hljs-literal">false</span>)
          <span class="hljs-keyword">break</span>
        <span class="hljs-attr">default</span>:
          <span class="hljs-comment">// TODO</span>
      }
    })
  }
}
</code></pre>
<h3 data-id="heading-10">pending 状态</h3>
<p><code>promise1</code>在等待的时候，可以在<code>promise1</code>上新建两个属性<code>fulfilledHandlers</code>、<code>rejectedHandlers</code>缓存给<code>promise2</code>触发<code>resolve</code>和<code>reject</code>的回调函数。<code>promise2</code>处于 pending 状态，<code>promise1</code>切换状态后触发这些回调函数，用来改变<code>promise2</code>的状态。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ...</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ShikaPromise</span> {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-comment">// 记录等待 fulfilled 或者 rejected 后执行的回调函数</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">fulfilledHandlers</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt; = []
  <span class="hljs-keyword">private</span> <span class="hljs-attr">rejectedHandlers</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt; = []
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-attr">value</span>: T): <span class="hljs-built_in">void</span> {
    <span class="hljs-title function_">scheduleMicrotask</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-title class_">PromiseState</span>.<span class="hljs-property">fulfilled</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value

      <span class="hljs-keyword">const</span> handlers = <span class="hljs-variable language_">this</span>.<span class="hljs-property">fulfilledHandlers</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>)
      handlers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> <span class="hljs-title function_">h</span>())
    })
  }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">reject</span>(<span class="hljs-attr">reason</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-title function_">scheduleMicrotask</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-title class_">PromiseState</span>.<span class="hljs-property">rejected</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason

      <span class="hljs-keyword">const</span> handlers = <span class="hljs-variable language_">this</span>.<span class="hljs-property">rejectedHandlers</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>)
      handlers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> <span class="hljs-title function_">h</span>())
    })
  }
  <span class="hljs-comment">// ...</span>
  then (onFulfilled?: <span class="hljs-title class_">ThenCallback</span>, onRejected?: <span class="hljs-title class_">ThenCallback</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShikaPromise</span>&lt;<span class="hljs-title class_">TResult1</span> | <span class="hljs-title class_">TResult2</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-comment">// ...</span>
      <span class="hljs-keyword">switch</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>) {
        <span class="hljs-comment">// ...</span>
        <span class="hljs-attr">default</span>:
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">fulfilledHandlers</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">handleCallback</span>(<span class="hljs-literal">true</span>))
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">rejectedHandlers</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">handleCallback</span>(<span class="hljs-literal">false</span>))
      }
    })
  }
}
</code></pre>
<h2 data-id="heading-11">防止多次触发</h2>
<p>我们通过添加标记<code>isResolved</code>记录是否已经触发<code>resolve</code>。当重复触发<code>resolve</code>和<code>reject</code>时，遇到<code>isResolved</code>为<code>true</code>就返回。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ...</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ShikaPromise</span>&lt;T = <span class="hljs-built_in">any</span>&gt; {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">private</span> isResolved = <span class="hljs-literal">false</span>
  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-attr">value</span>: T | <span class="hljs-title class_">PromiseLike</span>&lt;T&gt;): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isResolved</span>) <span class="hljs-keyword">return</span>
    
    <span class="hljs-keyword">if</span> (value === <span class="hljs-variable language_">this</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Cannot resolve promise with itself'</span>))
      <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> thenable 处理</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fulfill</span>(value <span class="hljs-keyword">as</span> T)
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">fulfill</span>(<span class="hljs-attr">value</span>: T): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isResolved</span>) <span class="hljs-keyword">return</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isResolved</span> = <span class="hljs-literal">true</span>
    
    <span class="hljs-title function_">scheduleMicrotask</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-title class_">PromiseState</span>.<span class="hljs-property">fulfilled</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value

      <span class="hljs-keyword">const</span> handlers = <span class="hljs-variable language_">this</span>.<span class="hljs-property">fulfilledHandlers</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>)
      handlers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> <span class="hljs-title function_">h</span>())
    })
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">reject</span>(<span class="hljs-attr">reason</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isResolved</span>) <span class="hljs-keyword">return</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isResolved</span> = <span class="hljs-literal">true</span>
    <span class="hljs-comment">// ...</span>
  }
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h2 data-id="heading-12">解析 thenable 对象</h2>
<p>如果遇到 thenable 对象，等待其进入 fulfilled 或者 rejected 状态，同样的，thenable 对象也需要防止重复进入 fulfilled 和 rejected 状态。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ShikaPromise</span>&lt;T = <span class="hljs-built_in">any</span>&gt; {
  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-attr">value</span>: T | <span class="hljs-title class_">PromiseLike</span>&lt;T&gt;): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">const</span> thenable = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getThenable</span>(value)
    <span class="hljs-keyword">if</span> (thenable) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolveThenable</span>(thenable)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fulfill</span>(value <span class="hljs-keyword">as</span> T)
    }
  }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getThenable</span>(<span class="hljs-attr">value</span>: <span class="hljs-built_in">any</span>): { <span class="hljs-attr">then</span>: <span class="hljs-title class_">Function</span>; <span class="hljs-attr">target</span>: <span class="hljs-built_in">any</span> } | <span class="hljs-literal">null</span> {
    <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">null</span> &amp;&amp; (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span> || <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'function'</span>)) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 在规范中有 Let then be x.then 的描述，测试用例中 value.then 只能被取一次</span>
        <span class="hljs-keyword">const</span> then = value.<span class="hljs-property">then</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> then === <span class="hljs-string">'function'</span>) {
          <span class="hljs-keyword">return</span> { then, <span class="hljs-attr">target</span>: value }
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reject</span>(error)
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">resolveThenable</span>(<span class="hljs-attr">thenable</span>: { <span class="hljs-attr">then</span>: <span class="hljs-title class_">Function</span>; <span class="hljs-attr">target</span>: <span class="hljs-built_in">any</span> }): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>

    <span class="hljs-keyword">try</span> {
      thenable.<span class="hljs-property">then</span>.<span class="hljs-title function_">call</span>(
        thenable.<span class="hljs-property">target</span>,
        <span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>
          called = <span class="hljs-literal">true</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">resolvevaluey</span>)
        },
        <span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>
          called = <span class="hljs-literal">true</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reject</span>(reason)
        }
      )
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (!called) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reject</span>(error)
    }
  }
}
</code></pre>
<h2 data-id="heading-13">其他方法</h2>
<h3 data-id="heading-14">JS 的 Promise</h3>
<p>下面就来实现一下 JS 的 Promse 的<code>catch</code>和<code>finally</code>。<code>catch</code>就是<code>then</code>方法只提供第二个参数。<code>finally</code>方法回调函数不接收任何参数，返回一个状态和数据与原来相同的 Promise。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ShikaPromise</span> {
  <span class="hljs-keyword">catch</span>&lt;<span class="hljs-title class_">TResult</span> = <span class="hljs-built_in">never</span>&gt;(
    onRejected?: (<span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-title class_">TResult</span> | <span class="hljs-title class_">PromiseLike</span>&lt;<span class="hljs-title class_">TResult</span>&gt;) | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>
  ): <span class="hljs-title class_">ShikaPromise</span>&lt;T | <span class="hljs-title class_">TResult</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">null</span>, onRejected)
  }

  <span class="hljs-title function_">finally</span>(onFinally?: (<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>): <span class="hljs-title class_">ShikaPromise</span>&lt;T&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(
      <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
        onFinally?.()
        <span class="hljs-keyword">return</span> value
      },
      <span class="hljs-function">(<span class="hljs-params">reason</span>) =&gt;</span> {
        onFinally?.()
        <span class="hljs-keyword">throw</span> reason
      }
    )
  }
}
</code></pre>
<p>还有<code>Promise.resolve</code>和<code>Promise.reject</code>两个静态方法：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ShikaPromise</span> {
  <span class="hljs-keyword">static</span> resolve&lt;T&gt;(<span class="hljs-attr">value</span>: T | <span class="hljs-title class_">PromiseLike</span>&lt;T&gt;): <span class="hljs-title class_">ShikaPromise</span>&lt;T&gt; {
    <span class="hljs-keyword">return</span> value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">ShikaPromise</span> ? value : <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShikaPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-title function_">resolve</span>(value))
  }
  <span class="hljs-keyword">static</span> reject&lt;T = <span class="hljs-built_in">never</span>&gt;(reason?: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">ShikaPromise</span>&lt;T&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShikaPromise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(reason))
  }
}
</code></pre>
<h3 data-id="heading-15">如果 Promise 可以停止</h3>
<p>如果想要 Promise 后面的<code>then</code>（<code>catch</code>、<code>finally</code>）都不会触发，这里只需要返回一个 pending 状态的 Promise。这里实现一个时链式调用停止的<code>cancel</code>方法和返回 pending 的 Promise 的<code>wait</code>方法：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ShikaPromise</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">wait</span>(): <span class="hljs-title class_">ShikaPromise</span>&lt;<span class="hljs-built_in">never</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShikaPromise</span>(<span class="hljs-function">() =&gt;</span> {})
  }
  <span class="hljs-title function_">cancel</span>(): <span class="hljs-title class_">ShikaPromise</span>&lt;<span class="hljs-built_in">never</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShikaPromise</span>(<span class="hljs-function">() =&gt;</span> {})
  }
}
</code></pre>
<h2 data-id="heading-16">Promise A+ 测试</h2>
<p>下载 promises-aplus-tests 包：</p>
<pre><code class="hljs language-cmd" lang="cmd">npm i promises-aplus-tests
</code></pre>
<p>要求 Promise 所在文件采用 <strong>commonjs</strong> 方式导出。还需要在 Promise 上实现静态方法：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ShikaPromise</span> {
  <span class="hljs-keyword">static</span> deferred&lt;T&gt;() {
    <span class="hljs-keyword">let</span> resolve!: <span class="hljs-function">(<span class="hljs-params">value: T | PromiseLike&lt;T&gt;</span>) =&gt;</span> <span class="hljs-built_in">void</span>
    <span class="hljs-keyword">let</span> reject!: <span class="hljs-function">(<span class="hljs-params">reason?: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>

    <span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShikaPromise</span>&lt;T&gt;(<span class="hljs-function">(<span class="hljs-params">res, rej</span>) =&gt;</span> {
      resolve = res
      reject = rej
    })

    <span class="hljs-keyword">return</span> { promise, resolve, reject }
  }
}
</code></pre>
<p><code>promises-aplus-tests Promise 的所在文件</code>即可运行，如果你在用 TS，文件为编译后的文件，例如：</p>
<pre><code class="hljs language-cmd" lang="cmd">promises-aplus-tests dist/文件名.js
</code></pre>
<p>Promise A+ 的测试用例覆盖面非常全，<del>调试时烦死了x</del>，通过了所有 817 条用例，就说明你的 Promise 实现了 Promise A+ 标准了。</p>
<p>我把 TS 编译和运行测试用例在 package.json 组装成一条命令：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// ...</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc &amp;&amp; promises-aplus-tests dist/文件名.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// ...</span>
<span class="hljs-punctuation">}</span>

</code></pre>
<p>这里 <code>tsc</code> 会默认编译 tsconfig.json 设置的根目录（这里是 ./src），然后放到输出目录中（这里是 ./dist）。</p>
<h2 data-id="heading-17">最终实现</h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">PromiseState</span> {
  fulfilled = <span class="hljs-string">'fulfilled'</span>,
  pending = <span class="hljs-string">'pending'</span>,
  rejected = <span class="hljs-string">'rejected'</span>
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Executor</span>&lt;T&gt; = <span class="hljs-function">(<span class="hljs-params">
  resolve: (value: T | PromiseLike&lt;T&gt;) =&gt; <span class="hljs-built_in">void</span>,
  reject: (reason?: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">void</span>
</span>) =&gt;</span> <span class="hljs-built_in">void</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">scheduleMicrotask</span> = (<span class="hljs-params">callback: () =&gt; <span class="hljs-built_in">void</span></span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> queueMicrotask === <span class="hljs-string">'function'</span>) {
    <span class="hljs-title function_">queueMicrotask</span>(callback)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> process !== <span class="hljs-string">'undefined'</span> &amp;&amp; process.<span class="hljs-property">nextTick</span>) {
    process.<span class="hljs-title function_">nextTick</span>(callback)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(callback)
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ShikaPromise</span>&lt;T = <span class="hljs-built_in">any</span>&gt; {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">state</span>: <span class="hljs-title class_">PromiseState</span> = <span class="hljs-title class_">PromiseState</span>.<span class="hljs-property">pending</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">value</span>: T | <span class="hljs-literal">undefined</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">reason</span>: <span class="hljs-built_in">any</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">fulfilledHandlers</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt; = []
  <span class="hljs-keyword">private</span> <span class="hljs-attr">rejectedHandlers</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt; = []
  <span class="hljs-keyword">private</span> isResolved = <span class="hljs-literal">false</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">executor: Executor&lt;T&gt;</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-title function_">executor</span>(
        <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolve</span>(value),
        <span class="hljs-function">(<span class="hljs-params">reason</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reject</span>(reason)
      )
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reject</span>(error)
    }
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-attr">value</span>: T | <span class="hljs-title class_">PromiseLike</span>&lt;T&gt;): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isResolved</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">if</span> (value === <span class="hljs-variable language_">this</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Cannot resolve promise with itself'</span>))
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">const</span> thenable = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getThenable</span>(value)
    <span class="hljs-keyword">if</span> (thenable) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolveThenable</span>(thenable)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fulfill</span>(value <span class="hljs-keyword">as</span> T)
    }
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">fulfill</span>(<span class="hljs-attr">value</span>: T): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isResolved</span>) <span class="hljs-keyword">return</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isResolved</span> = <span class="hljs-literal">true</span>

    <span class="hljs-title function_">scheduleMicrotask</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-title class_">PromiseState</span>.<span class="hljs-property">fulfilled</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value

      <span class="hljs-keyword">const</span> handlers = <span class="hljs-variable language_">this</span>.<span class="hljs-property">fulfilledHandlers</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>)
      handlers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> <span class="hljs-title function_">h</span>())
    })
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">reject</span>(<span class="hljs-attr">reason</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isResolved</span>) <span class="hljs-keyword">return</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isResolved</span> = <span class="hljs-literal">true</span>

    <span class="hljs-title function_">scheduleMicrotask</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-title class_">PromiseState</span>.<span class="hljs-property">rejected</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason

      <span class="hljs-keyword">const</span> handlers = <span class="hljs-variable language_">this</span>.<span class="hljs-property">rejectedHandlers</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>)
      handlers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> <span class="hljs-title function_">h</span>())
    })
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getThenable</span>(<span class="hljs-attr">value</span>: <span class="hljs-built_in">any</span>): { <span class="hljs-attr">then</span>: <span class="hljs-title class_">Function</span>; <span class="hljs-attr">target</span>: <span class="hljs-built_in">any</span> } | <span class="hljs-literal">null</span> {
    <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">null</span> &amp;&amp; (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span> || <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'function'</span>)) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> then = value.<span class="hljs-property">then</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> then === <span class="hljs-string">'function'</span>) {
          <span class="hljs-keyword">return</span> { then, <span class="hljs-attr">target</span>: value }
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reject</span>(error)
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">resolveThenable</span>(<span class="hljs-attr">thenable</span>: { <span class="hljs-attr">then</span>: <span class="hljs-title class_">Function</span>; <span class="hljs-attr">target</span>: <span class="hljs-built_in">any</span> }): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>

    <span class="hljs-keyword">try</span> {
      thenable.<span class="hljs-property">then</span>.<span class="hljs-title function_">call</span>(
        thenable.<span class="hljs-property">target</span>,
        <span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>
          called = <span class="hljs-literal">true</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolve</span>(value)
        },
        <span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>
          called = <span class="hljs-literal">true</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reject</span>(reason)
        }
      )
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (!called) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reject</span>(error)
    }
  }

  then&lt;<span class="hljs-title class_">TResult1</span> = T, <span class="hljs-title class_">TResult2</span> = <span class="hljs-built_in">never</span>&gt;(
    onFulfilled?: (<span class="hljs-function">(<span class="hljs-params">value: T</span>) =&gt;</span> <span class="hljs-title class_">TResult1</span> | <span class="hljs-title class_">PromiseLike</span>&lt;<span class="hljs-title class_">TResult1</span>&gt;) | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>,
    onRejected?: (<span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-title class_">TResult2</span> | <span class="hljs-title class_">PromiseLike</span>&lt;<span class="hljs-title class_">TResult2</span>&gt;) | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>
  ): <span class="hljs-title class_">ShikaPromise</span>&lt;<span class="hljs-title class_">TResult1</span> | <span class="hljs-title class_">TResult2</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShikaPromise</span>&lt;<span class="hljs-title class_">TResult1</span> | <span class="hljs-title class_">TResult2</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCallback</span> = (<span class="hljs-params">isFulfilled: <span class="hljs-built_in">boolean</span></span>) =&gt; {
        <span class="hljs-title function_">scheduleMicrotask</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">const</span> callback = isFulfilled ? onFulfilled : onRejected
          <span class="hljs-keyword">const</span> data = isFulfilled ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>

          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">'function'</span>) {
            <span class="hljs-keyword">if</span> (isFulfilled) {
              <span class="hljs-title function_">resolve</span>(data <span class="hljs-keyword">as</span> <span class="hljs-title class_">TResult1</span>)
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-title function_">reject</span>(data)
            }
            <span class="hljs-keyword">return</span>
          }

          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">callback</span>(data)
            <span class="hljs-title function_">resolve</span>(result)
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">reject</span>(error)
          }
        })
      }

      <span class="hljs-keyword">switch</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">PromiseState</span>.<span class="hljs-property">fulfilled</span>:
          <span class="hljs-title function_">handleCallback</span>(<span class="hljs-literal">true</span>)
          <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">PromiseState</span>.<span class="hljs-property">rejected</span>:
          <span class="hljs-title function_">handleCallback</span>(<span class="hljs-literal">false</span>)
          <span class="hljs-keyword">break</span>
        <span class="hljs-attr">default</span>:
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">fulfilledHandlers</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">handleCallback</span>(<span class="hljs-literal">true</span>))
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">rejectedHandlers</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">handleCallback</span>(<span class="hljs-literal">false</span>))
      }
    })
  }

  <span class="hljs-keyword">catch</span>&lt;<span class="hljs-title class_">TResult</span> = <span class="hljs-built_in">never</span>&gt;(
    onRejected?: (<span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-title class_">TResult</span> | <span class="hljs-title class_">PromiseLike</span>&lt;<span class="hljs-title class_">TResult</span>&gt;) | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>
  ): <span class="hljs-title class_">ShikaPromise</span>&lt;T | <span class="hljs-title class_">TResult</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">null</span>, onRejected)
  }

  <span class="hljs-title function_">finally</span>(onFinally?: (<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>): <span class="hljs-title class_">ShikaPromise</span>&lt;T&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(
      <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
        onFinally?.()
        <span class="hljs-keyword">return</span> value
      },
      <span class="hljs-function">(<span class="hljs-params">reason</span>) =&gt;</span> {
        onFinally?.()
        <span class="hljs-keyword">throw</span> reason
      }
    )
  }

  <span class="hljs-keyword">static</span> resolve&lt;T&gt;(<span class="hljs-attr">value</span>: T | <span class="hljs-title class_">PromiseLike</span>&lt;T&gt;): <span class="hljs-title class_">ShikaPromise</span>&lt;T&gt; {
    <span class="hljs-keyword">return</span> value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">ShikaPromise</span> ? value : <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShikaPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-title function_">resolve</span>(value))
  }

  <span class="hljs-keyword">static</span> reject&lt;T = <span class="hljs-built_in">never</span>&gt;(reason?: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">ShikaPromise</span>&lt;T&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShikaPromise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(reason))
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">wait</span>(): <span class="hljs-title class_">ShikaPromise</span>&lt;<span class="hljs-built_in">never</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShikaPromise</span>(<span class="hljs-function">() =&gt;</span> {})
  }

  <span class="hljs-title function_">cancel</span>(): <span class="hljs-title class_">ShikaPromise</span>&lt;<span class="hljs-built_in">never</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShikaPromise</span>(<span class="hljs-function">() =&gt;</span> {})
  }

  <span class="hljs-keyword">static</span> deferred&lt;T&gt;() {
    <span class="hljs-keyword">let</span> resolve!: <span class="hljs-function">(<span class="hljs-params">value: T | PromiseLike&lt;T&gt;</span>) =&gt;</span> <span class="hljs-built_in">void</span>
    <span class="hljs-keyword">let</span> reject!: <span class="hljs-function">(<span class="hljs-params">reason?: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>

    <span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShikaPromise</span>&lt;T&gt;(<span class="hljs-function">(<span class="hljs-params">res, rej</span>) =&gt;</span> {
      resolve = res
      reject = rej
    })

    <span class="hljs-keyword">return</span> { promise, resolve, reject }
  }
}

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">ShikaPromise</span>

</code></pre>
<h2 data-id="heading-18">结尾</h2>
<p>这里实现了一个 Promise A+ 规范的 Promise，重新理解 Promise A+ 规范也修复了我以前对此的认识不足之处。</p>
<blockquote>
<p>大家的阅读是我发帖的动力，本文首发于我的博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeerblog.gu-nami.com%2Fweb%2Farticle%2F158" target="_blank" title="https://deerblog.gu-nami.com/web/article/158" ref="nofollow noopener noreferrer">deerblog.gu-nami.com/</a>，欢迎大家来玩<del>喵</del>，
转载请注明出处。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>