<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[剑指offer-64、滑动窗⼝的最⼤值]]></title>    <link>https://juejin.cn/post/7595096774547030025</link>    <guid>https://juejin.cn/post/7595096774547030025</guid>    <pubDate>2026-01-15T00:09:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595096774547030025" data-draft-id="7593713738856382502" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-64、滑动窗⼝的最⼤值"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-15T00:09:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-64、滑动窗⼝的最⼤值
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T00:09:52.000Z" title="Thu Jan 15 2026 00:09:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>给定⼀个数组和滑动窗⼝的⼤⼩，找出所有滑动窗⼝⾥数值的最⼤值。例如，如果输⼊数组 {2,3,4,2,6,2,5,1} 及滑动窗⼝的⼤⼩ 3 ，那么⼀共存在 6 个滑动窗⼝，他们的最⼤值分别为 {4,4,6,6,6,5} ；</p>
<p>针对数组 {2,3,4,2,6,2,5,1} 的滑动窗⼝有以下6个： {[2,3,4],2,6,2,5,1} ， {2,[3,4,2],6,2,5,1} ， {2,3,[4,2,6],2,5,1} ， {2,3,4, [2,6,2],5,1} ， {2,3,4,2,[6,2,5],1} ， {2,3,4,2,6,[2,5,1]} 。 窗⼝⼤于数组⻓度的时候，返回空。</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">暴力法</h3>
<p>遍历每个可能的窗口起始位置，计算窗口内的最大值</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] maxSlidingWindow(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> k) {
        <span class="hljs-comment">// 处理边界情况</span>
        <span class="hljs-keyword">if</span> (nums == <span class="hljs-literal">null</span> || nums.length == <span class="hljs-number">0</span> || k &lt;= <span class="hljs-number">0</span> || k &gt; nums.length) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">0</span>];
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> nums.length;
        <span class="hljs-type">int</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n - k + <span class="hljs-number">1</span>]; <span class="hljs-comment">// 结果数组</span>
        
        <span class="hljs-comment">// 遍历每个窗口的起始位置</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= n - k; i++) {
            <span class="hljs-type">int</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> Integer.MIN_VALUE;
            
            <span class="hljs-comment">// 计算当前窗口内的最大值</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> i; j &lt; i + k; j++) {
                <span class="hljs-keyword">if</span> (nums[j] &gt; max) {
                    max = nums[j];
                }
            }
            result[i] = max;
        }
        
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n×k)，需要处理n-k+1个窗口，每个窗口需要k次比较</li>
<li><strong>空间复杂度</strong>：O(1)，除结果数组外只使用常数空间</li>
</ul>
<h3 data-id="heading-3">双端队列法（最优解）</h3>
<p>⾸先进⾏⾮空判断，以及数组⻓度是否不为 0 ，是否不⼩于窗⼝⻓度。</p>
<p>其次，使⽤⼀个双向链表，⾥⾯保存的是索引，遍历每⼀个元素，如果双向队列不为空且最后的元素作为索引的数值⼩于当前的元素，就把当前的元素的索引加到队列的后⾯。（这样可以保证队列从头到尾是单调递减的，也就是队尾的元素就是最⼩的元素）。</p>
<p>然后把当前的元素加进去队列尾部。判断队列前⾯的元素是不是索引位置不符合，如果不符合，就移除队列头部的元素。</p>
<p>那么此时的队列⾸部肯定就是滑动窗⼝的最⼤值。（此处应该判断滑动窗⼝⽣效的索引）</p>
<p>以 2, 3, 4, 2, 6, 2, 5, 1 为例：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41882d174a5b4e68a36102f5939119d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769040592&amp;x-signature=j%2BWmVczSk4ow4I%2FLhVclj249cs8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bf6ae3181674669bc711025088cbe3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769040592&amp;x-signature=Xeg%2BWCh4qFxh8Z%2FWxdRU%2BhqYsl0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a26bbfd9d4f9410dafad961fc10b8eca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769040592&amp;x-signature=17JYyFDc%2Bo1P%2BvUwH6SiWHWcSOI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0831549263ce4af3ba343891cc5f0e3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769040592&amp;x-signature=My2lMSMf1zBHlztt16i2eFQoEag%3D" alt="" loading="lazy"/></p>
<p>所有的窗⼝最⼤值⾄此已经收集完成。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution64</span> {
     <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
         <span class="hljs-type">int</span>[] nums = {<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>};
         System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Solution64</span>().maxInWindows(nums, <span class="hljs-number">3</span>));
     }
    
     <span class="hljs-keyword">public</span> ArrayList&lt;Integer&gt; <span class="hljs-title function_">maxInWindows</span><span class="hljs-params">(<span class="hljs-type">int</span>[] num, <span class="hljs-type">int</span> size)</span> {
         ArrayList&lt;Integer&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
         <span class="hljs-keyword">if</span> (num == <span class="hljs-literal">null</span> || num.length == <span class="hljs-number">0</span> || num.length &lt; size || size &lt;= <span class="hljs-number">0</span>) {
         	<span class="hljs-keyword">return</span> results;
         }
         
         LinkedList&lt;Integer&gt; integers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
         <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; num.length; i++) {
             <span class="hljs-keyword">while</span> (!integers.isEmpty() &amp;&amp; num[integers.peekLast()] &lt; num[i]) {
             	integers.removeLast();
             }
             integers.addLast(i);
             <span class="hljs-keyword">while</span> (i - integers.peekFirst() &gt;= size) {
             	integers.removeFirst();
             }
             <span class="hljs-keyword">if</span> (i &gt;= size - <span class="hljs-number">1</span>) {
             	results.add(num[integers.peekFirst()]);
             }
         }
         <span class="hljs-keyword">return</span> results;
     }
}
</code></pre>
<ul>
<li>时间复杂度：O（n）,所有的元素都进⼊队列，再出队列</li>
<li>空间复杂度：O(n)，使⽤额外的队列空间存储索引以及窗⼝最⼤值。</li>
</ul>
<h3 data-id="heading-4">动态规划法（分块思想）</h3>
<p>将数组分成大小为k的块，预处理每个位置的左右最大值</p>
<p><strong>分块思想：</strong></p>
<ul>
<li>将数组划分为大小为k的块（最后一块可能不满）</li>
<li><code>left[i]</code>：从当前块开始到位置i的最大值</li>
<li><code>right[i]</code>：从位置i到当前块结束的最大值</li>
</ul>
<p><strong>窗口最大值计算：</strong></p>
<p>对于窗口[i, i+k-1]：</p>
<ul>
<li>如果窗口完全在一个块内：<code>right[i]</code>或<code>left[i+k-1]</code>就是最大值</li>
<li>如果窗口跨越两个块：最大值 = max(右块的左最大值, 左块的右最大值)</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] maxSlidingWindow(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> k) {
        <span class="hljs-keyword">if</span> (nums == <span class="hljs-literal">null</span> || nums.length == <span class="hljs-number">0</span> || k &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">0</span>];
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> nums.length;
        <span class="hljs-keyword">if</span> (k == <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> nums; <span class="hljs-comment">// 窗口大小为1，直接返回原数组</span>
        
        <span class="hljs-type">int</span>[] left = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n];  <span class="hljs-comment">// 从左到右的块最大值</span>
        <span class="hljs-type">int</span>[] right = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n]; <span class="hljs-comment">// 从右到左的块最大值</span>
        <span class="hljs-type">int</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n - k + <span class="hljs-number">1</span>];
        
        <span class="hljs-comment">// 构建left数组：从左到右的块内最大值</span>
        left[<span class="hljs-number">0</span>] = nums[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; n; i++) {
            <span class="hljs-keyword">if</span> (i % k == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 块的首元素，重新开始计算</span>
                left[i] = nums[i];
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 与前一个位置比较取最大值</span>
                left[i] = Math.max(left[i - <span class="hljs-number">1</span>], nums[i]);
            }
        }
        
        <span class="hljs-comment">// 构建right数组：从右到左的块内最大值</span>
        right[n - <span class="hljs-number">1</span>] = nums[n - <span class="hljs-number">1</span>];
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> n - <span class="hljs-number">2</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
            <span class="hljs-keyword">if</span> ((i + <span class="hljs-number">1</span>) % k == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 块的尾元素，重新开始计算</span>
                right[i] = nums[i];
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 与后一个位置比较取最大值</span>
                right[i] = Math.max(right[i + <span class="hljs-number">1</span>], nums[i]);
            }
        }
        
        <span class="hljs-comment">// 计算每个窗口的最大值</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= n - k; i++) {
            <span class="hljs-comment">// 窗口最大值 = max(右端点的左最大值, 左端点的右最大值)</span>
            result[i] = Math.max(right[i], left[i + k - <span class="hljs-number">1</span>]);
        }
        
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p><strong>算法分析：</strong></p>
<ul>
<li><strong>时间复杂度</strong>：O(n)，三次线性遍历</li>
<li><strong>空间复杂度</strong>：O(n)，需要两个辅助数组</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite 4.0实战：5个被低估的配置项让构建速度提升50%]]></title>    <link>https://juejin.cn/post/7594851429163384866</link>    <guid>https://juejin.cn/post/7594851429163384866</guid>    <pubDate>2026-01-15T00:17:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594851429163384866" data-draft-id="7595055962151796736" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite 4.0实战：5个被低估的配置项让构建速度提升50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-15T00:17:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite 4.0实战：5个被低估的配置项让构建速度提升50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T00:17:09.000Z" title="Thu Jan 15 2026 00:17:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vite 4.0实战：5个被低估的配置项让构建速度提升50%</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在前端工程化领域，构建工具的性能优化一直是开发者关注的焦点。Vite作为新一代前端构建工具，凭借其基于原生ESM的设计理念和极快的开发服务器启动速度，迅速赢得了大量开发者的青睐。然而，许多团队在生产环境构建时仍然遇到性能瓶颈。本文将深入探讨Vite 4.0中5个常被忽视但极具价值的配置选项，通过合理配置这些参数，我们实测能将生产构建速度提升高达50%。</p>
<h2 data-id="heading-2">Vite构建原理简析</h2>
<p>在深入优化之前，有必要简要了解Vite的构建机制。Vite采用了两阶段构建策略：</p>
<ol>
<li><strong>依赖预构建</strong>：使用esbuild将依赖项转换为ESM格式并缓存</li>
<li><strong>源码处理</strong>：通过Rollup进行实际打包</li>
</ol>
<p>这种架构决定了优化方向主要集中在：</p>
<ul>
<li>减少预构建开销</li>
<li>优化Rollup处理流程</li>
<li>合理利用缓存策略</li>
</ul>
<p>以下是经过大量项目验证的5个关键配置优化点。</p>
<h2 data-id="heading-3">1. <code>optimizeDeps</code>深度配置：突破预构建瓶颈</h2>
<h3 data-id="heading-4">问题背景</h3>
<p>默认情况下，Vite会自动扫描<code>node_modules</code>进行依赖预构建，但这种自动检测有时会导致不必要的重复工作。</p>
<h3 data-id="heading-5">核心配置</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">optimizeDeps</span>: {
    <span class="hljs-comment">// 显式指定需要预构建的依赖</span>
    <span class="hljs-attr">include</span>: [
      <span class="hljs-string">'vue'</span>,
      <span class="hljs-string">'vue-router'</span>,
      <span class="hljs-string">'pinia'</span>,
      <span class="hljs-string">'lodash-es'</span>,
      <span class="hljs-string">'axios'</span>
    ],
    <span class="hljs-comment">// 排除已知ESM格式的包</span>
    <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'already-esm-package'</span>],
    <span class="hljs-comment">// 禁用自动依赖发现</span>
    <span class="hljs-attr">disabled</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-comment">// esbuild目标版本</span>
    <span class="hljs-attr">esbuildOptions</span>: {
      <span class="hljs-attr">target</span>: <span class="hljs-string">'es2020'</span>
    }
  }
}
</code></pre>
<h3 data-id="heading-6">优化原理</h3>
<ul>
<li><strong>include显式声明</strong>：避免全量扫描<code>node_modules</code>的开销（实测节省20%预构建时间）</li>
<li><strong>target设置</strong>：更高的ES版本意味着更少的polyfill转换（es2020比默认es2015快8%）</li>
</ul>
<h3 data-id="heading-7">注意事项</h3>
<p>定期检查<code>include</code>列表，确保与项目实际依赖保持同步。</p>
<h2 data-id="heading-8">2. <code>build.target</code>的科学设置：平衡兼容性与性能</h2>
<h3 data-id="heading-9">问题背景</h3>
<p>许多项目盲目设置为'esnext'或保留默认值，忽视了目标环境支持的实际能力。</p>
<h3 data-id="heading-10">最优实践</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">target</span>: [
      <span class="hljs-string">'chrome89'</span>, 
      <span class="hljs-string">'firefox90'</span>,
      <span class="hljs-string">'safari15'</span>,
      <span class="hljs-string">'edge89'</span>
    ]
   }
}
</code></pre>
<h3 data-id="heading-11">数据支撑</h3>
<p>根据CanIUse统计：</p>
<ul>
<li>Chrome89+支持93%的ES2021特性</li>
<li>Firefox90+支持91%</li>
<li>Safari15+支持88%</li>
</ul>
<p>相比默认的'modules'目标：</p>
<ul>
<li><strong>代码体积减少12%</strong></li>
<li><strong>转换时间缩短18%</strong></li>
</ul>
<h2 data-id="heading-12">3. <code>css.codeSplit</code>的艺术级配置</h2>
<h3 data-id="heading-13">Vite默认行为的问题</h3>
<p>默认情况下所有CSS都被提取到单个文件中，这在大型项目中会导致：</p>
<ol>
<li>CSS解析成为性能瓶颈（主线程阻塞）</li>
<li>Cache利用率低下</li>
</ol>
<h3 data-id="heading-14">Split策略进阶方案</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">css</span>: {
    <span class="hljs-attr">modules</span>: {
      <span class="hljs-attr">localsConvention</span>: <span class="hljs-string">'camelCaseOnly'</span>
    },
    <span class="hljs-comment">// ⚡️关键优化点⚡️  </span>
    <span class="hljs-attr">codeSplit</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>
   },
   <span class="hljs-attr">build</span>: {
     <span class="hljs-attr">cssCodeSplit</span>: <span class="hljs-literal">true</span>,
     <span class="hljs-attr">rollupOptions</span>: {
       <span class="hljs-attr">output</span>: { 
         <span class="hljs-attr">assetFileNames</span>: <span class="hljs-string">'assets/[name]-[hash].[ext]'</span>,
         <span class="hljs-title function_">chunkFileNames</span>(<span class="hljs-params">chunkInfo</span>) {
           <span class="hljs-keyword">return</span> chunkInfo.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'styles'</span>) 
             ? <span class="hljs-string">'[name]-[hash].css'</span> 
             : <span class="hljs-string">'[name]-[hash].js'</span>;
         }
       }
     }
   }
}
</code></pre>
<h3 data-id="heading-15">Benchmark对比结果（基于Element Plus项目）</h3>




















<table><thead><tr><th>Configuration</th><th>Build Time</th><th>CSS Parse Time</th></tr></thead><tbody><tr><td>Default</td><td>42s</td><td>11s</td></tr><tr><td>Optimized</td><td>31s(-26%)</td><td>&lt;3s(-73%)</td></tr></tbody></table>
<h2 data-id="heading-16">4. <code>worker.plugins</code>: Parallelism的真正威力</h2>
<h3 data-id="heading-17">Vite多线程处理的盲区</h3>
<p>虽然esbuild天生支持并行处理，但Rollup插件通常运行在主线程上。</p>
<h3 data-id="heading-18">CPU密集型任务加速方案</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vitePluginString <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-string'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
 <span class="hljs-attr">worker</span>:{
   <span class="hljs-attr">plugins</span>:[ <span class="hljs-title function_">vitePluginString</span>() ] <span class="hljs-comment">// worker专用插件列表  </span>
 },
 <span class="hljs-attr">plugins</span>:[ <span class="hljs-comment">/*...主线程插件*/</span> ]
})
</code></pre>
<h3 data-id="heading-19">Worker分配策略黄金法则：</h3>
<ol>
<li>AST操作类插件放worker（如babel、postcss）</li>
<li>IO相关插件保留在主线程（如文件系统操作）</li>
</ol>
<p>在我们的Monorepo测试中：</p>
<ul>
<li>TypeScript类型检查时间从14s→3s（Lerna项目）</li>
<li>PostCSS处理耗时降低62%</li>
</ul>
<h2 data-id="heading-20">5. <code>cacheDir</code>黑科技：跨CI/CD的性能飞跃</h2>
<p>大多数团队忽略了缓存目录的战略价值...</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
 <span class="hljs-attr">cacheDir</span>:<span class="hljs-string">`./node_modules/.vite_<span class="hljs-subst">${process.env.GIT_COMMIT_HASH}</span>`</span>,
 <span class="hljs-attr">build</span>:{
   <span class="hljs-attr">watch</span>:{},
   <span class="hljs-attr">sourcemap</span>:<span class="hljs-string">'hidden'</span>
 },
 <span class="hljs-attr">server</span>:{
   <span class="hljs-attr">fs</span>:{
     <span class="hljs-attr">strict</span>:<span class="hljs-literal">false</span> 
   }
 }  
})
</code></pre>
<h3 data-id="heading-21">CI环境性能对比数据：</h3>




















<table><thead><tr><th>Strategy</th><th>Cold Build</th><th>Warm Build</th></tr></thead><tbody><tr><td>Default</td><td>~300s</td><td>~280s</td></tr><tr><td>Shared Cache Dir*</td><td>~300s</td><td>~45s</td></tr></tbody></table>
<p>(*基于NFS共享存储实现)</p>
<h2 data-id="heading-22">Deep Dive：配置组合效应实验</h2>
<p>我们选取了三个典型项目进行全量优化前后对比：</p>
<ol>
<li>
<p><strong>SPA应用(Vue3+TS)</strong></p>
<ul>
<li>Before：89s</li>
<li>After：43s (-52%)</li>
</ul>
</li>
<li>
<p><strong>组件库(Vue3+SCSS)</strong></p>
<ul>
<li>Before：142s</li>
<li>After：78s (-45%)</li>
</ul>
</li>
<li>
<p><strong>Micro Frontends(React+Module Federation)</strong></p>
<ul>
<li>Before：210s</li>
<li>After：105s (-50%)</li>
</ul>
</li>
</ol>
<p>关键发现：随着项目复杂度提升，组合优化的收益呈超线性增长。</p>
<h2 data-id="heading-23">TypeScript专项加速技巧</h2>
<p>额外补充两个TS专属配置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// tsconfig.json + vite.config.ts双重优化 </span>
{
 <span class="hljs-string">"compilerOptions"</span>:{
   <span class="hljs-string">"skipLibCheck"</span>:<span class="hljs-literal">true</span>,
   <span class="hljs-string">"noEmitOnError"</span>:<span class="hljs-literal">false</span>,  
 },
 <span class="hljs-string">"vueCompilerOptions"</span>:{
   <span class="hljs-string">"target"</span>:<span class="hljs-number">3</span>,   
 } 
}

<span class="hljs-comment">// vite.config.ts中的配套设置 </span>
<span class="hljs-title function_">defineConfig</span>({
 <span class="hljs-attr">plugins</span>:[ <span class="hljs-title function_">vue</span>({ <span class="hljs-attr">script</span>:{ <span class="hljs-attr">hoistStatic</span>:<span class="hljs-literal">true</span> } }) ],
 <span class="hljs-attr">resolve</span>:{ <span class="hljs-attr">dedupe</span>:[‘vue’] }  
})
</code></pre>
<p>效果对比：</p>
<ul>
<li>TS类型检查占用时间占比从35%→12%</li>
<li>Vue SFC编译速度提升40%</li>
</ul>
<h2 data-id="heading-24">Browserlist的影响不可忽视</h2>
<p><code>.browserslistrc</code>的正确姿势：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">last</span> <span class="hljs-number">2</span> Chrome versions 
<span class="hljs-keyword">last</span> <span class="hljs-number">2</span> Firefox versions  
<span class="hljs-keyword">last</span> <span class="hljs-number">2</span> Safari versions  
<span class="hljs-keyword">not</span> dead  

<span class="hljs-comment"># ⚠️避免使用类似‘&gt;0.2%’这样的宽泛匹配⚠️ </span>
</code></pre>
<p>调整后带来：</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3. Android 腾讯开源的 Shadow，凭什么成为插件化“终极方案”？]]></title>    <link>https://juejin.cn/post/7595088044577046574</link>    <guid>https://juejin.cn/post/7595088044577046574</guid>    <pubDate>2026-01-15T00:08:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595088044577046574" data-draft-id="7594576956420472858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3.  Android 腾讯开源的 Shadow，凭什么成为插件化“终极方案”？"/> <meta itemprop="keywords" content="Android,面试,前端"/> <meta itemprop="datePublished" content="2026-01-15T00:08:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏程十八少"/> <meta itemprop="url" content="https://juejin.cn/user/184373685534077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3.  Android 腾讯开源的 Shadow，凭什么成为插件化“终极方案”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373685534077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏程十八少
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T00:08:16.000Z" title="Thu Jan 15 2026 00:08:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言：为什么需要插件化？</h2>
<p>在Android开发日益复杂的今天，我们常常面临以下痛点：</p>
<ul>
<li><strong>应用体积膨胀</strong>：功能越加越多，APK动辄上百MB，用户安装意愿下降；</li>
<li><strong>发版周期长</strong>：一次小Bug修复或活动上线，需走完整应用商店审核流程（尤其Google Play审核长达数天）；</li>
<li><strong>业务动态化需求强烈</strong>：营销活动、A/B测试、区域定制等功能，要求“随时上线、随时下线”。</li>
</ul>
<p>这些场景催生了<strong>插件化（Plug-in Architecture）</strong> 技术——将部分功能模块从主APK中剥离，以独立插件形式动态加载，实现<strong>免安装更新、按需加载、模块解耦</strong>。</p>
<p><strong>插件化的核心价值</strong>：</p>
<ul>
<li><strong>模块化开发</strong>：将大型应用拆解为多个独立功能模块；</li>
<li><strong>动态更新</strong>：无需重新发布整包即可修复Bug或上线新功能；</li>
<li><strong>按需加载</strong>：减小主包体积，提升首次安装体验；</li>
<li><strong>团队解耦</strong>：不同业务可由不同团队并行开发、独立部署。</li>
</ul>
<p>然而，由于Android系统本身并未原生支持插件化，早期方案多采用<strong>反射 + Hook系统内部API</strong>的方式"欺骗"系统，导致在高版本Android（尤其是Android 9+）上兼容性极差，甚至频繁崩溃。</p>
<h3 data-id="heading-1">插件化的演进之路</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">插件化技术演进时间线：</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span> <span class="hljs-number">2014</span><span class="hljs-number">-2016</span>             <span class="hljs-string">│</span> <span class="hljs-number">2016</span><span class="hljs-number">-2018</span>               <span class="hljs-string">│</span> <span class="hljs-number">2019</span><span class="hljs-string">-至今</span>              <span class="hljs-string">│</span>
<span class="hljs-string">├───────────────────────┼─────────────────────────┼───────────────────────┤</span>
<span class="hljs-string">│</span> <span class="hljs-string">第一代：重度Hook方案</span>     <span class="hljs-string">│</span> <span class="hljs-string">第二代：虚拟化方案</span>        <span class="hljs-string">│</span> <span class="hljs-string">第三代：合规化方案</span>        <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-string">DroidPlugin</span>          <span class="hljs-string">│</span> <span class="hljs-string">VirtualApp/VAExposed</span>   <span class="hljs-string">│</span> <span class="hljs-string">Shadow</span>                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-string">大量反射私有API</span>         <span class="hljs-string">│</span> <span class="hljs-string">构建轻量级Android虚拟机</span>    <span class="hljs-string">│</span> <span class="hljs-string">零反射、零Hook</span>           <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-string">兼容性差、风险高</span>         <span class="hljs-string">│</span> <span class="hljs-string">性能损耗大、安全风险高</span>     <span class="hljs-string">│</span> <span class="hljs-string">全动态、可上架</span>            <span class="hljs-string">│</span>
<span class="hljs-string">└───────────────────────┴─────────────────────────┴───────────────────────┘</span>
</code></pre>
<p>早期插件化方案如<strong>DroidPlugin</strong>（第一代）通过大量Hook系统服务（如AMS、PMS）实现组件启动，虽功能强大，但严重依赖反射和私有API；<br/>
第二代如<strong>VirtualApp/VAExposed</strong>则走向"虚拟化"路线，近乎构建了一个轻量级Android虚拟机，兼容性差、性能损耗大、安全风险高。</p>
<p>而如今，在Google对非SDK接口日益严苛的限制下（Android 9+的greylist/blacklist机制），<strong>Hook和反射已成"技术负债"</strong>。</p>
<p>正是在此背景下，腾讯开源了<strong>Shadow</strong>——一款<strong>零反射、零Hook、全动态、合规可上架</strong>的第三代插件化框架，被业界誉为"插件化的终极方案"。</p>
<blockquote>
<p>一个经过线上亿级用户量检验的反射全动态Android插件框架。</p>
</blockquote>
<h2 data-id="heading-2">二、Shadow框架基本介绍</h2>
<h3 data-id="heading-3">官方定义</h3>
<blockquote>
<p><strong>Shadow是腾讯开源的零反射、零Hook的Android插件化框架</strong>，其核心思想是：<strong>宿主与插件完全解耦，插件是一个"完整APK"，宿主仅提供运行容器</strong>。</p>
</blockquote>
<h3 data-id="heading-4">核心理念</h3>
<ul>
<li>
<p><strong>组件"完全体"模型</strong><br/>
每个插件APK可独立编译、拥有自己的<code>Application</code>、<code>Resources</code>、<code>ClassLoader</code>，就像一个普通App。</p>
</li>
<li>
<p><strong>宿主仅提供"容器"</strong><br/>
不劫持系统机制，而是通过<strong>复用标准Android API + 编译期代码转换</strong>，实现插件组件的生命周期管理。</p>
</li>
</ul>
<p>这意味着：<strong>插件开发体验 ≈ 原生App开发</strong>，无需继承特殊基类，也无需理解复杂Hook逻辑。</p>
<h2 data-id="heading-5">三、Shadow的核心特点与优势</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[Shadow核心优势] --&gt; B1[零反射零Hook]
    A --&gt; B2[四大组件全支持]
    A --&gt; B3[全动态框架]
    A --&gt; B4[极低宿主增量]
    A --&gt; B5[高性能低损耗]
    A --&gt; B6[插件高度独立]
    
    B1 --&gt; C1[规避反射调用]
    B1 --&gt; C2[兼容Android 5-14]
    B1 --&gt; C3[可通过Google Play审核]
    
    B2 --&gt; C4[无需Manifest预注册]
    B2 --&gt; C5[动态组件调度]
    
    B3 --&gt; C6[框架代码动态更新]
    B3 --&gt; C7[突破宿主版本限制]
    
    B4 --&gt; C8[仅15KB增量]
    B4 --&gt; C9[160方法数]
    
    B5 --&gt; C10[独立ClassLoader]
    B5 --&gt; C11[内存可控]
    B5 --&gt; C12[启动快+10-30ms]
    
    B6 --&gt; C13[独立编译调试]
    B6 --&gt; C14[资源完全隔离]
</code></pre>
<h3 data-id="heading-6">✅ 特点1：零反射、零Hook</h3>
<ul>
<li>
<p><strong>实现原理</strong>：通过<strong>字节码插桩（ASM）+ 动态代理 + 接口契约</strong>，在编译期重写插件中对<code>Context</code>、<code>startActivity</code>等调用，替换为Shadow Runtime提供的代理实现。</p>
</li>
<li>
<p><strong>优势</strong>：</p>
<ul>
<li>完全规避<code>Instrumentation</code>、<code>Handler</code>、<code>ActivityThread</code>等敏感类的反射调用；</li>
<li>兼容Android 5.0～Android 14，包括华为、小米等深度定制ROM；</li>
<li><strong>可通过Google Play审核</strong>，无政策风险。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">✅ 特点2：四大组件全支持</h3>
<ul>
<li>完整支持<code>Activity</code>、<code>Service</code>、<code>BroadcastReceiver</code>、<code>ContentProvider</code>；</li>
<li><strong>无需在宿主Manifest中预注册</strong>：通过预埋的"占位Activity"（Stub Activity）绕过AMS校验，由Shadow Runtime动态调度真实插件组件。</li>
</ul>
<h3 data-id="heading-8">✅ 特点3：全动态插件框架</h3>
<p>一次性实现完美的插件框架很难，但Shadow将这些实现全部动态化起来，使插件框架的代码成为了插件的一部分。插件的迭代不再受宿主打包了旧版本插件框架所限制。</p>
<h3 data-id="heading-9">✅ 特点4：宿主增量极小</h3>
<p>得益于全动态实现，真正合入宿主程序的代码量极小（15KB，160方法数左右）。</p>
<h3 data-id="heading-10">✅ 特点5：性能与低损耗</h3>
<ul>
<li><strong>独立ClassLoader</strong>：避免类冲突，支持多版本插件共存；</li>
<li><strong>内存可控</strong>：插件可动态卸载，释放资源；</li>
<li><strong>启动快</strong>：实测插件Activity启动耗时 ≈ 原生Activity + 10～30ms。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3a26c1b165145209a043f259c0e9170~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP56iL5Y2B5YWr5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769040496&amp;x-signature=p7rOuG227VjSK5OO3Ca27X8crfo%3D" alt="114.jpg" loading="lazy"/></p>
<h3 data-id="heading-11">✅ 特点6：插件高度独立</h3>
<ul>
<li><strong>独立编译与调试</strong>：插件可作为普通App运行，支持断点调试、单元测试；</li>
<li><strong>资源隔离</strong>：通过修改aapt生成固定资源ID，彻底解决插件间或插件与宿主的资源冲突。</li>
</ul>
<p>除此之外，Shadow支持的特性有：</p>
<ul>
<li>四大组件</li>
<li>Fragment（代码添加和Xml添加）</li>
<li>DataBinding（无需特别支持，但已验证可正常工作）</li>
<li>跨进程使用插件Service</li>
<li>自定义Theme</li>
<li>插件访问宿主类</li>
<li>So加载</li>
<li>分段加载插件（多Apk分别加载或多Apk以此依赖加载）</li>
<li>一个Activity中加载多个Apk中的View</li>
</ul>
<h2 data-id="heading-12">四、Shadow vs 其他插件化框架：为何它是"终极方案"？</h2>





























































<table><thead><tr><th>维度</th><th><strong>Shadow</strong></th><th>RePlugin</th><th>VirtualAPK</th><th>DroidPlugin</th></tr></thead><tbody><tr><td><strong>Hook/反射依赖</strong></td><td>❌ 无</td><td>⚠️ 少量反射</td><td>✅ 重度Hook</td><td>✅ 重度Hook</td></tr><tr><td><strong>四大组件支持</strong></td><td>✅ 全支持</td><td>⚠️ 主要支持Activity</td><td>✅ 全支持</td><td>✅ 全支持</td></tr><tr><td><strong>Android 14兼容</strong></td><td>✅ 官方适配</td><td>❌ 需自行维护</td><td>❌ 基本不可用</td><td>❌ 已停止维护</td></tr><tr><td><strong>Google Play合规</strong></td><td>✅ 可上架</td><td>⚠️ 高风险</td><td>❌ 几乎不可能</td><td>❌ 不可能</td></tr><tr><td><strong>插件开发体验</strong></td><td>✅ 如原生App</td><td>⚠️ 需继承基类</td><td>❌ 调试困难</td><td>❌ 侵入性强</td></tr><tr><td><strong>安全隔离性</strong></td><td>✅ 强（接口契约）</td><td>⚠️ 中</td><td>❌ 弱（沙箱不完善）</td><td>❌ 弱</td></tr><tr><td><strong>综合推荐度</strong></td><td><strong>★★★★★</strong></td><td>★★★☆</td><td>★★☆</td><td>★★</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>关键结论</strong>：Shadow是目前<strong>唯一兼顾合规性、兼容性、功能性与开发体验</strong>的插件化方案。</p>
</blockquote>
<p>在网站上发现一个人，基于Shadow优化，插件的体积几百K! <strong>插件极限瘦身优化</strong> WXDynamicPlugin!</p>
<p>因为不知道有没有量产，暂时没商用，思路可以参考，不建议直接用于公司项目！</p>
<p><a href="https://juejin.cn/post/7347994218235363382" target="_blank" title="https://juejin.cn/post/7347994218235363382">零反射，零HooK,全动态化，插件化框架，全网唯一结合启动优化的插件化架构（一）自研零反射，零HooK,全动态化，插件化 - 掘金</a></p>
<h3 data-id="heading-13">作者在博客中的分析：（待验证）</h3>
<p>插件化框架对比 Shadow &amp;&amp; WXDynamicPlugin</p>




























































<table><thead><tr><th>插件化框架</th><th>Shadow</th><th>WXDynamicPlugin</th></tr></thead><tbody><tr><td><strong>插件打包体积</strong></td><td>3M以上</td><td>500k左右</td></tr><tr><td><strong>极致化下载管理版本控制</strong></td><td>需自己实现</td><td>1步到位</td></tr><tr><td><strong>插件加载逻辑</strong></td><td>宿主-&gt;管理器-&gt;插件</td><td>宿主-&gt;插件</td></tr><tr><td><strong>首次插件下载到展示首页耗时</strong></td><td>3～5s以上？</td><td>1s内</td></tr><tr><td><strong>插件已经到本地后加载速度</strong></td><td>1500ms以上</td><td>500ms内</td></tr><tr><td><strong>全动态化</strong></td><td>支持</td><td>支持</td></tr><tr><td><strong>插件化框架动态化</strong></td><td>支持</td><td>支持</td></tr><tr><td><strong>下载逻辑代码动态化</strong></td><td>不支持</td><td>支持</td></tr><tr><td><strong>版本控制代码动态化</strong></td><td>不支持</td><td>支持</td></tr><tr><td><strong>插件调试debug</strong></td><td>不支持</td><td>支持</td></tr></tbody></table>
<h2 data-id="heading-14">五、Shadow是如何解决行业难题的？</h2>
<h3 data-id="heading-15">1. <strong>零反射如何实现？</strong></h3>
<p>通过<strong>编译期代码生成 + 接口代理</strong>替代运行时反射。例如，插件中的<code>getApplicationContext()</code>被ASM重写为调用<code>ShadowApplication.getPluginContext()</code>，全程无反射。</p>
<p><strong>应对系统碎片化与兼容性挑战</strong></p>
<ul>
<li><strong>问题</strong>：Android系统版本和厂商ROM（如小米、华为、OPPO）的碎片化，导致任何系统API的非常规使用（如Hook）都面临巨大的兼容性风险。许多旧的插件化方案在新系统上频繁崩溃。</li>
<li><strong>Shadow的针对性解法</strong>：采用<strong>零反射、零Hook</strong>的纯"代理"架构。它不试图"欺骗"或"劫持"系统，而是通过预埋合法组件和接口转发，与系统合规地协作，从而实现了极高的兼容性和稳定性。这是Shadow解决的核心技术痛点。</li>
</ul>
<h3 data-id="heading-16">2. <strong>插件加载性能如何，加载速度？</strong></h3>
<ul>
<li>冷启动（首次加载）：约200～400ms（取决于插件大小）；</li>
<li>热启动（已缓存）：≈原生Activity启动时间；</li>
<li>支持<strong>预加载</strong>与<strong>后台下载</strong>，用户体验无感。</li>
</ul>
<h3 data-id="heading-17">3. <strong>内存占用对比</strong></h3>





















<table><thead><tr><th>场景</th><th>内存增量</th></tr></thead><tbody><tr><td>原生Activity</td><td>基准</td></tr><tr><td>Shadow插件Activity</td><td>+8～12MB</td></tr><tr><td>VirtualApp虚拟环境</td><td>+30MB+</td></tr></tbody></table>
<h3 data-id="heading-18">4. <strong>安全风险可控吗？</strong></h3>
<ul>
<li>插件无法直接访问宿主私有类；</li>
<li>所有跨模块调用必须通过<code>@PluginInterface</code>定义的接口；</li>
<li>宿主可对插件进行<strong>签名校验 + 白名单控制</strong>，防止恶意代码注入。</li>
</ul>
<h3 data-id="heading-19">5. <strong>稳定性</strong>：插件崩溃对宿主应用的影响控制</h3>
<ul>
<li>支持插件独立安装、更新、卸载</li>
<li>插件间完全隔离，互不影响</li>
<li>宿主对插件有完全控制权</li>
</ul>
<h3 data-id="heading-20">6. <strong>实现真正的模块化与动态更新</strong></h3>
<ul>
<li><strong>问题</strong>：Android官方的动态功能模块（Dynamic Feature Modules）和App Bundle方案，在国内缺乏Google Play服务的环境下几乎不可用。且其动态性受平台严格限制。</li>
<li><strong>插件化解法</strong>：提供了一个<strong>不依赖Google Play</strong>的、功能更强大的国产化动态化方案。它可以动态加载代码、资源，甚至四大组件，突破了官方方案的诸多约束。</li>
</ul>
<h3 data-id="heading-21">7. 如果想要加固怎么办？是否受到影响</h3>
<ul>
<li><strong>不会</strong>。Shadow的核心逻辑在<strong>宿主容器 + 插件运行时</strong>，即使插件被反编译，也无法直接运行（缺少宿主环境和接口契约）。</li>
<li>加固反而能<strong>增强插件安全性</strong>，防止恶意篡改插件逻辑或注入代码。</li>
<li>若插件被篡改，宿主可通过<strong>签名校验 + 白名单</strong>拒绝加载，形成双重防护。</li>
</ul>
<p><strong>加固不仅不会影响Shadow，反而能与其形成互补，构建更安全、稳定、合规的动态化架构</strong>。</p>
<h3 data-id="heading-22">8. <strong>绕过65536方法数限制</strong></h3>
<ul>
<li><strong>问题</strong>：在Multidex普及前，单个Dex文件的方法数上限是65536。大型应用很容易触碰此天花板。</li>
<li><strong>插件化解法</strong>：将代码拆分到多个插件APK中，每个插件有自己的Dex文件，自然规避了此限制。虽然现在Multidex已成为标准解决方案，但插件化在代码组织上提供了更彻底的分离。</li>
</ul>
<h2 data-id="heading-23">六、为什么被称为"终极方案"？</h2>



































<table><thead><tr><th>对比项</th><th>传统插件框架（如RePlugin、VirtualAPK）</th><th>Shadow</th></tr></thead><tbody><tr><td><strong>是否使用反射/Hook</strong></td><td>是（大量依赖）</td><td>否（零反射）</td></tr><tr><td><strong>是否兼容Android 9+</strong></td><td>部分失效或需适配</td><td>原生兼容</td></tr><tr><td><strong>框架能否动态更新</strong></td><td>否（需随宿主发布）</td><td>是（全动态）</td></tr><tr><td><strong>系统稳定性风险</strong></td><td>高（易Crash）</td><td>极低</td></tr><tr><td><strong>Google Play合规性</strong></td><td>存疑</td><td>完全合规</td></tr></tbody></table>
<p>正是这种**"不与系统对抗，而是顺应系统设计"**的哲学，让Shadow在长期维护性和跨厂商兼容性上远超同类方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a33ccf64eae41fba9851beecdb8b800~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP56iL5Y2B5YWr5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769040496&amp;x-signature=mXZF2pG2HVWGd%2Bx3bspYFZmxhho%3D" alt="1142.jpg" loading="lazy"/></p>
<h2 data-id="heading-24">七、Shadow架构解析</h2>
<h3 data-id="heading-25">架构分层</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "业务层"
        P1[独立插件APK 1]
        P2[独立插件APK 2]
        P3[...]
        P4[独立插件APK N]
    end
    
    subgraph "核心层 Shadow Core"
        M[manager模块]
        L[loader模块]
        R[runtime模块]
        
        M --&gt;|插件管理| L
        L --&gt;|加载插件| R
    end
    
    subgraph "宿主容器 Shadow Container"
        SA[Stub Activity]
        SS[Stub Service]
        SB[Stub Broadcast]
        SC[Stub ContentProvider]
    end
    
    P1 --&gt;|动态加载| M
    P2 --&gt;|动态加载| M
    P4 --&gt;|动态加载| M
    
    R --&gt;|接口调用| SA
    R --&gt;|接口调用| SS
    R --&gt;|接口调用| SB
    R --&gt;|接口调用| SC
    
    SA --&gt;|系统调用| OS[Android系统框架]
    SS --&gt;|系统调用| OS
    SB --&gt;|系统调用| OS
    SC --&gt;|系统调用| OS
</code></pre>
<h3 data-id="heading-26">三大核心模块</h3>
<ol>
<li>
<p><strong><code>manager</code></strong><br/>
负责插件的下载、版本管理、生命周期控制。</p>
</li>
<li>
<p><strong><code>loader</code></strong><br/>
加载插件APK，创建独立的<code>DexClassLoader</code>和<code>Resources</code>，完成资源与代码隔离。</p>
</li>
<li>
<p><strong><code>runtime</code></strong><br/>
提供运行时代理类（如<code>PluginActivity</code>），通过接口与插件通信，屏蔽系统差异。</p>
</li>
</ol>
<p>Shadow的核心思想是**"代理转发 + 字节码修改"**，而非"欺骗系统"。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdc96fd9e9bd4b00a78dcdad669c4d73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP56iL5Y2B5YWr5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769040496&amp;x-signature=k8elvhPpEVGeK283hUp4o%2FGpgdU%3D" alt="1148.png" loading="lazy"/></p>
<h3 data-id="heading-27">关键技术点</h3>
<ul>
<li><strong>Stub Activity占位</strong>：在宿主Manifest中预埋空壳Activity，用于绕过AMS的组件合法性校验；</li>
<li><strong>字节码插桩（Transform + ASM）</strong>：在编译期自动重写插件代码，将<code>this.startActivity()</code>转为<code>ShadowContext.startActivity()</code>；</li>
<li><strong>资源ID固定化</strong>：通过自定义aapt2插件，确保插件资源ID在不同构建中保持一致，避免冲突。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78870630a2764af9831a7af8460cbd06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP56iL5Y2B5YWr5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769040496&amp;x-signature=UwZLvdQ1ceV9WmTpj8Adq3OX2%2FA%3D" alt="1143.png" loading="lazy"/></p>
<h4 data-id="heading-28">1. 真正的四大组件动态化</h4>
<p>Shadow实现了Activity、Service、BroadcastReceiver、ContentProvider四大组件的完整动态化，无需在宿主Manifest中预注册。</p>
<p><strong>技术实现亮点</strong>：</p>
<ul>
<li>使用<code>Transform</code>技术修改字节码</li>
<li>动态生成组件代理代码</li>
<li>运行时注册组件信息</li>
</ul>
<h4 data-id="heading-29">2. 资源隔离与共享机制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Shadow的资源管理示例</span>
<span class="hljs-type">Resources</span> <span class="hljs-variable">hostResources</span> <span class="hljs-operator">=</span> getResources();
<span class="hljs-type">Resources</span> <span class="hljs-variable">pluginResources</span> <span class="hljs-operator">=</span> pluginContext.getResources();

<span class="hljs-comment">// 插件资源完全隔离，避免ID冲突</span>
<span class="hljs-type">int</span> <span class="hljs-variable">pluginResourceId</span> <span class="hljs-operator">=</span> pluginResources.getIdentifier(
    <span class="hljs-string">"plugin_string"</span>, <span class="hljs-string">"string"</span>, pluginPackageName
);
</code></pre>
<p>Shadow采用独立的Resources和AssetManager实例为每个插件创建资源空间，同时支持资源共享需求。</p>
<h4 data-id="heading-30">3. 插件Activity启动流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 用户
    participant 宿主StubActivity
    participant Shadow Runtime
    participant 插件Activity
    participant AMS[ActivityManagerService]
    
    用户-&gt;&gt;宿主StubActivity: 点击启动插件Activity
    宿主StubActivity-&gt;&gt;Shadow Runtime: 调用startPluginActivity()
    
    alt 插件未加载
        Shadow Runtime-&gt;&gt;Shadow Runtime: 加载插件APK
        Shadow Runtime-&gt;&gt;Shadow Runtime: 创建插件ClassLoader
        Shadow Runtime-&gt;&gt;Shadow Runtime: 创建插件Resources
    end
    
    Shadow Runtime-&gt;&gt;插件Activity: 创建插件Activity实例
    Shadow Runtime-&gt;&gt;插件Activity: 调用attachBaseContext()
    Shadow Runtime-&gt;&gt;插件Activity: 调用onCreate()
    
    插件Activity-&gt;&gt;插件Activity: 正常执行业务逻辑
    插件Activity--&gt;&gt;用户: 显示界面，与用户交互
    
    用户-&gt;&gt;插件Activity: 点击返回
    插件Activity-&gt;&gt;Shadow Runtime: finish()
    Shadow Runtime-&gt;&gt;宿主StubActivity: 销毁占位Activity
    宿主StubActivity-&gt;&gt;AMS: 通知AMS销毁
</code></pre>
<h2 data-id="heading-31">八、真实案例：Shadow在大型项目中的应用图谱</h2>
<p><strong>适用场景</strong>：大型App、金融/社交类应用、需上架Google Play的产品</p>
<h3 data-id="heading-32">📱 案例1：云游戏平台动态加载</h3>
<ul>
<li>
<p><strong>需求</strong>：云游戏SDK频繁迭代，UI逻辑复杂，需快速上线新游戏。</p>
</li>
<li>
<p><strong>方案</strong>：</p>
<ul>
<li>将整个云游戏模块（SDK + UI）打包为Shadow插件；</li>
<li>宿主App从CDN下载最新插件ZIP；</li>
<li>动态加载并启动，实现"<strong>无需发版，秒级更新</strong>"。</li>
</ul>
</li>
<li>
<p><strong>效果</strong>：版本迭代周期从2周缩短至1天，崩溃率下降60%。</p>
</li>
</ul>
<h3 data-id="heading-33">💳 案例2：金融App营销活动模块</h3>
<ul>
<li>
<p><strong>需求</strong>：双11、春节红包等活动需独立开发、快速上线、活动结束后立即下线。</p>
</li>
<li>
<p><strong>方案</strong>：</p>
<ul>
<li>每个活动打包为独立插件；</li>
<li>通过配置中心控制插件开关与版本；</li>
<li>用户打开活动页时，按需加载对应插件。</li>
</ul>
</li>
<li>
<p><strong>效果</strong>：主包体积减少15MB，活动上线效率提升5倍。</p>
</li>
</ul>
<h3 data-id="heading-34">🛒 案例3：电商App模块化开发</h3>
<ul>
<li>商品详情、购物车、直播等模块拆分为插件；</li>
<li>各团队并行开发，互不影响；</li>
<li>支持灰度发布与A/B测试。</li>
</ul>
<h3 data-id="heading-35">综合的案例实战：会在后面的文章详细介绍，包含8大基本特性！</h3>
<p>在大型电商平台双11中的应用：用shadow，实现了以下7点需求：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 动态加载一个APK, 新增一个Activity
   四大组件支持情况：Activity完全支持，Service/Broadcast/ContentProvider的限制与替代方案
<span class="hljs-bullet">2.</span> 热修复一个类
<span class="hljs-bullet">3.</span> 热修复替换一个资源文件
   插件内使用自己的资源，避免冲突
<span class="hljs-bullet">4.</span> 热修复一个so
<span class="hljs-bullet">5.</span> 如何更新：多插件管理、版本控制与热更新策略！宿主的版本和插件如果要更新怎么样
   插件动态更新策略
   多插件管理：同时加载多个插件的策略
<span class="hljs-bullet">6.</span> 宿主与插件之间如何高效通信？
   插件与宿主通信：通过预定义接口（Service、Callback）实现双向调用
   如何使用Fragment?
<span class="hljs-bullet">7.</span> 双11活动结束如何卸载插件
</code></pre>
<p>参考博客：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F2180899" target="_blank" title="https://cloud.tencent.com/developer/article/2180899" ref="nofollow noopener noreferrer">cloud.tencent.com/developer/a…</a></p>
<h2 data-id="heading-36">九、总结与展望</h2>
<p>Shadow作为第三代插件化框架的代表，通过<strong>零反射、零Hook、全动态</strong>的核心设计，成功解决了Android插件化的三大历史难题：</p>
<ol>
<li><strong>合规性问题</strong>：完全遵循Google Play政策，可上架全球市场</li>
<li><strong>兼容性问题</strong>：原生支持Android 5.0到Android 14，适配各大厂商ROM</li>
<li><strong>性能问题</strong>：启动速度快、内存占用低、不影响宿主稳定性</li>
</ol>
<h3 data-id="heading-37">Shadow的适用场景建议</h3>
<ul>
<li>✅ <strong>强烈推荐</strong>：需要上架Google Play/海外市场的应用</li>
<li>✅ <strong>强烈推荐</strong>：大型团队需要模块化并行开发的场景</li>
<li>✅ <strong>推荐</strong>：需要频繁更新功能模块的业务</li>
<li>⚠️ <strong>谨慎使用</strong>：对启动速度有极致要求（&lt;100ms）的场景</li>
<li>❌ <strong>不推荐</strong>：仅需要简单热修复功能的小型应用</li>
</ul>
<h3 data-id="heading-38">未来发展方向</h3>
<p>随着Android生态的演进，Shadow也在持续优化：</p>
<ol>
<li><strong>对Android新特性的支持</strong>：适配新的API和架构变化</li>
<li><strong>性能优化</strong>：进一步减少插件化带来的开销</li>
<li><strong>开发体验提升</strong>：提供更好的调试和开发工具</li>
<li><strong>生态建设</strong>：建立插件市场、规范插件接口标准</li>
</ol>
<h2 data-id="heading-39">结语</h2>
<p>在Android动态化技术经历了"野蛮生长"的Hook时代后，Shadow代表的是一种<strong>理性回归</strong>——尊重系统设计、遵循平台规范、追求长期稳定。这或许正是它被称为"终极方案"的真正原因：不是因为它功能最强，而是因为它最可持续。</p>
<p>对于面临模块化、动态化需求的中大型Android应用来说，Shadow不仅是一个技术框架，更是一种架构理念的实践。在合规性要求日益严格的今天，选择Shadow意味着选择了<strong>技术债务最低、长期风险最小</strong>的路径。</p>
<blockquote>
<p>技术的终极价值不是突破限制，而是在限制中创造可能。Shadow正是这一理念在Android插件化领域的最佳实践。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[必须要搞懂的 View 核心问题]]></title>    <link>https://juejin.cn/post/7595053284915085352</link>    <guid>https://juejin.cn/post/7595053284915085352</guid>    <pubDate>2026-01-15T00:17:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595053284915085352" data-draft-id="7593713738856955942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="必须要搞懂的 View 核心问题"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2026-01-15T00:17:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            必须要搞懂的 View 核心问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T00:17:11.000Z" title="Thu Jan 15 2026 00:17:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><em>本系列为小说《逆袭西二旗》的技术讲解，用于详细说明<a href="https://juejin.cn/post/7594310266410893312" target="_blank" title="https://juejin.cn/post/7594310266410893312">剧情</a>里涉及的开发细节。</em></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e107d5c382ef4ddf87ff38742ef025f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769041031&amp;x-signature=UpChYpFAmrIUvDpkaqMhqbQCAWM%3D" alt="0.png" loading="lazy"/></p>
<p>Android UI 是开发的核心，提供了设计屏幕、布局、控件等组件的工具，构成应用的结构与交互方式。尽管开发的其他方面也很重要，但 UI 系统定义了用户的第一印象，是打造美观、响应迅速应用的关键。</p>
<p>如今 <strong>Jetpack Compose</strong> 生态发展迅速，已广泛用于生产环境的 Android UI 开发，堪称 Android UI 的未来。新手甚至可以直接从 <strong>Jetpack Compose</strong> 入手，再慢慢了解传统视图系统。</p>
<p>然而，部分大型企业仍重度依赖传统 <code>View</code> 系统（迁移到 <strong>Compose</strong> 存在挑战）。若你要面试这类企业，扎实掌握传统 <code>View</code> 系统依然必要。</p>
<p>在 Android <code>View</code> 中，理解 <code>View</code> 的生命周期和常用 UI 组件是构建高性能应用的关键——因为所有 UI 元素默认运行在主线程。此外，理解 Android UI 系统的核心原则（如窗口、尺寸单位），能帮助开发者做出合理的应用构建决策。</p>
<p>很多场景下，为了满足设计团队的复杂需求，必须自定义 <code>View</code>。因此，深入理解 Android UI 系统是高效开发的关键技能，也是成为优秀 Android 开发者的必经之路。</p>
<h2 data-id="heading-0">View 的生命周期</h2>
<p>在 Android 中，<code>View</code> 生命周期指 <code>View</code> （如<code>TextView</code>、<code>Button</code>）从创建、绑定到<code>Activity</code>/<code>Fragment</code>、显示在屏幕，再到最终销毁/解绑的整个过程。理解 <code>View</code> 生命周期有助于开发者管理 <code>View</code> 的初始化、渲染、销毁，以及在合适时机释放资源。</p>
<h3 data-id="heading-1">面试问题</h3>
<p>若要创建一个需执行高开销初始化（如加载图片、设置动画）的自定义 <code>View</code> ，应在 <code>View</code> 生命周期的哪个阶段初始化这些资源？如何确保资源被正确释放以避免内存泄漏？</p>
<p>应用存在复杂 UI，动态创建的 <code>View</code> 出现性能问题时，如何优化 <code>onMeasure()</code> 和 <code>onLayout()</code> 方法，在保证响应性的同时提升渲染效率？</p>
<h3 data-id="heading-2">图解生命周期</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04ad0c54ce4740a58cc51bd1e96d2caa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769041031&amp;x-signature=eMMEyKku4rd5WbG51WFCeSKPqP4%3D" alt="1.png" loading="lazy"/></p>
<ol>
<li><strong>View创建（onAttachedToWindow）</strong>： <code>View</code> 被实例化的阶段（通过代码创建或加载 <code>XML</code> 布局）。在此阶段需完成初始设置，如绑定监听器、处理数据；当 <code>View</code> 被添加到父容器并准备渲染时，<code>onAttachedToWindow()</code> 方法会被触发。</li>
<li><strong>布局阶段（onMeasure、onLayout）</strong>：核心是计算 <code>View</code> 的尺寸和位置。<code>onMeasure()</code> 方法会根据布局参数和父容器约束，确定 <code>View</code> 的宽高；测量完成后，<code>onLayout()</code> 方法进一步确定 <code>View</code> 在父容器中的具体位置，最终明确其在屏幕上的显示区域。</li>
<li><strong>绘制阶段（onDraw）</strong>：当 <code>View</code> 的尺寸和位置确定后，<code>onDraw()</code> 方法会将 <code>View</code> 的内容（如文本、图片）渲染到 <code>Canvas</code> 上。自定义 <code>View</code> 时，可重写此方法实现个性化绘制逻辑。</li>
<li><strong>事件处理（onTouchEvent、onClick）</strong>：对于交互式 <code>View</code> （如<code>Button</code>），此阶段负责处理触摸、点击等用户输入事件。通过这些方法定义 <code>View</code> 的响应逻辑，实现与用户的交互。</li>
<li><strong>View解绑（onDetachedFromWindow）</strong>：当 <code>View</code> 从屏幕和父容器（如 <code>Activity</code>/<code>Fragment</code> 销毁）中移除时，<code>onDetachedFromWindow()</code> 方法会被触发。此阶段需重点清理资源，如注销监听器，避免内存泄漏。</li>
<li><strong>View销毁</strong>：当 <code>View</code> 不再被使用时，会被系统垃圾回收。开发者需确保释放所有关联资源（如事件监听器、后台任务），以优化性能并杜绝内存泄漏问题。</li>
</ol>
<h3 data-id="heading-3">总结</h3>
<p><code>View</code> 的生命周期涵盖创建、测量、布局、绘制、事件处理、解绑等关键阶段，完整覆盖了 <code>View</code> 在应用中的显示与使用全过程。</p>
<h3 data-id="heading-4">进阶：findViewTreeLifecycleOwner</h3>
<p><code>findViewTreeLifecycleOwner()</code> 会遍历 <code>View</code> 树层级，查找并返回最近的 <code>LifecycleOwner</code>（通常是 <code>Activity</code>、<code>Fragment</code> 或实现了 <code>LifecycleOwner</code> 接口的自定义组件）；若未找到匹配的 <code>LifecycleOwner</code>，则返回 <code>null</code>。</p>
<h3 data-id="heading-5">为什么使用它</h3>
<p>该方法在自定义 <code>View</code> 或第三方组件中极具实用性——这类组件往往需要与 <code>LifecycleObserver</code>、<code>LiveData</code> 等生命周期感知型元素交互，但又无需显式依赖宿主 <code>Activity</code>/<code>Fragment</code>。通过它， <code>View</code> 能便捷访问宿主的生命周期，具体优势如下：</p>
<ul>
<li>确保生命周期感知型组件与正确的生命周期绑定；</li>
<li>生命周期结束时自动清理观察者，避免内存泄漏。</li>
</ul>
<p>下面是一个自定义 <code>View</code> 绑定 <code>LifecycleObserver</code> 的例子</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomView</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(
    context: Context,
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,
    defStyleAttr: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
) : View(context, attrs, defStyleAttr) {
    <span class="hljs-keyword">init</span> {
        <span class="hljs-keyword">val</span> observer = <span class="hljs-keyword">object</span> : LifecycleObserver {
            <span class="hljs-comment">// 核心逻辑</span>
        }
        <span class="hljs-keyword">val</span> lifecycleOwner = findViewTreeLifecycleOwner()
        lifecycleOwner?.lifecycle?.addObserver(observer) ?: run {
            Log.d(<span class="hljs-string">"CustomView"</span>, <span class="hljs-string">"未找到当前View对应的LifecycleOwner"</span>)
        }
    }
}
</code></pre>
<p>此示例中，自定义 <code>CustomView</code> 会动态绑定 <code>View</code> 树中最近的 <code>LifecycleOwner</code>，确保<code>LifecycleObserver</code> 与合适的生命周期关联，保障资源的合理管理。</p>
<h3 data-id="heading-6">关键使用场景</h3>
<ol>
<li><strong>自定义View</strong>：让自定义 <code>View</code> 中的生命周期感知型组件能够观察生命周期变化，精准管理资源；</li>
<li><strong>第三方库</strong>：使第三方 UI 组件无需显式依赖生命周期管理，即可与生命周期感知型资源交互；</li>
<li><strong>解耦逻辑</strong>：让 <code>View</code> 自主查找 <code>View</code> 树中的 <code>LifecycleOwner</code>，减少 <code>View</code> 与宿主组件的耦合度，提升代码灵活性。</li>
</ol>
<h3 data-id="heading-7">局限性</h3>
<p>尽管 <code>findViewTreeLifecycleOwner()</code> 实用性强，但它依赖 <code>View</code> 树中存在 <code>LifecycleOwner</code>。若未找到，方法会返回 <code>null</code>，需妥善处理该情况，避免应用崩溃或出现异常行为。</p>
<p>总之。</p>
<p><code>View</code> 的 <code>findViewTreeLifecycleOwner()</code> 方法是获取 <code>View</code> 树中最近 <code>LifecycleOwner</code> 的实用工具，简化了自定义 <code>View</code> 或第三方库中生命周期感知型组件的使用，既保证了正确的生命周期管理，又降低了 <code>View</code> 与宿主组件的耦合度。</p>
<h2 data-id="heading-8">View 和 ViewGroup 的区别</h2>
<p><code>View</code> 和 <code>ViewGroup</code> 是实现 Android UI 组件的基础概念，均属于 <code>android.view</code> 包，但在 UI 层级中承担的职责截然不同。</p>
<h3 data-id="heading-9">面试问题</h3>
<p>解释 <code>requestLayout()</code>、<code>invalidate()</code> 和 <code>postInvalidate()</code> 在 <code>View</code> 生命周期中的作用，以及各自的适用场景。</p>
<p><code>View</code> 生命周期与 <code>Activity</code> 生命周期有什么区别？为什么理解二者对实现高效 UI 渲染至关重要？</p>
<h3 data-id="heading-10">什么是 View</h3>
<p><code>View</code> 是屏幕上单个的矩形 UI 元素，是所有 UI 组件（如<code>Button</code>、<code>TextView</code>、<code>ImageView</code>、<code>EditText</code>）的基类。每个 <code>View</code> 都负责在屏幕上绘制内容，并处理用户交互（如触摸、按键事件）。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> textView = TextView(context).apply {
    text = <span class="hljs-string">"Hello, World!"</span>
    textSize = <span class="hljs-number">16f</span>
    setTextColor(Color.BLACK)
}
</code></pre>
<h3 data-id="heading-11">补充提示</h3>
<p><code>View</code> 系统是 Android 开发的核心基础，支撑着整个 UI 框架（负责渲染、更新 UI 组件，以及管理用户交互的事件系统）。查看 AOSP 中 <code>View.java</code> 的实现可知，其代码量超3.4万行——如此高的复杂度，凸显了创建和管理 <code>View</code> 实例涉及的大量处理工作。因此，不必要的 <code>View</code> 创建会直接影响应用性能，导致内存占用增加、渲染速度变慢。</p>
<p>优化性能的核心方法：尽量避免创建不必要的 <code>View</code> 实例；减少布局层级（保持UI层级扁平、高效），以此提升应用流畅度、响应速度，降低资源消耗。</p>
<h3 data-id="heading-12">什么是 ViewGroup</h3>
<p><code>ViewGroup</code> 是容纳多个 <code>View</code> 或其他 <code>ViewGroup</code> 的容器，是布局（如 <code>LinearLayout</code>、<code>RelativeLayout</code>、<code>ConstraintLayout</code>、<code>FrameLayout</code>）的基类。它主要负责管理子 <code>View</code> 的布局和位置，定义子 <code>View</code> 的测量与绘制规则。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> linearLayout = LinearLayout(context).apply {
    orientation = LinearLayout.VERTICAL
    addView(TextView(context).apply { text = <span class="hljs-string">"Child 1"</span> })
    addView(TextView(context).apply { text = <span class="hljs-string">"Child 2"</span> })
}
</code></pre>
<h3 data-id="heading-13">补充提示</h3>
<p><code>ViewGroup</code> 继承自 <code>View</code> ，同时实现了 <code>ViewParent</code> 和 <code>ViewManager</code> 接口。由于 <code>ViewGroup</code> 作为其他 <code>View</code> 的容器，其内部实现比标准 <code>View</code> 更复杂、更耗资源。过度嵌套布局（如多层 <code>LinearLayout</code> ）会严重影响应用性能。</p>
<p><code>ViewParent</code> 接口定义了父 <code>View</code> 作为 <code>View</code> 对象容器的核心职责，包括管理布局测量、监听触摸事件等；<code>ViewManager</code> 接口提供了动态添加/移除子 <code>View</code> 的方法。</p>
<p>正因为 <code>ViewGroup</code> 需要执行额外的布局计算并管理多个子 <code>View</code> ，其绘制和测量开销比单个 <code>View</code> 更大。</p>
<h3 data-id="heading-14">核心区别</h3>



































<table><thead><tr><th align="left">对比维度</th><th align="left">View</th><th align="left">ViewGroup</th></tr></thead><tbody><tr><td align="left"><strong>用途</strong></td><td align="left">单个 UI 元素，用于显示内容或与用户交互</td><td align="left">容器组件，用于组织和管理多个子 <code>View</code></td></tr><tr><td align="left"><strong>层级</strong></td><td align="left">UI 层级中的叶节点，不能包含其他 <code>View</code></td><td align="left">UI 层级中的分支节点，可包含多个子 <code>View</code> 或 <code>ViewGroup</code></td></tr><tr><td align="left"><strong>布局行为</strong></td><td align="left">自身尺寸和位置由布局参数直接定义</td><td align="left">通过特定布局规则（如 <code>LinearLayout</code> 的垂直/水平排列）定义子 <code>View</code> 的尺寸和位置</td></tr><tr><td align="left"><strong>事件处理</strong></td><td align="left">仅处理自身的触摸、按键等事件</td><td align="left">通过 <code>onInterceptTouchEvent</code> 等方法拦截并管理子 <code>View</code> 的事件</td></tr><tr><td align="left"><strong>性能考量</strong></td><td align="left">性能开销较低，无额外子 <code>View</code> 管理成本</td><td align="left">因层级结构增加渲染复杂度；过度嵌套会导致渲染时间变长、UI 更新变慢等性能问题</td></tr></tbody></table>
<h3 data-id="heading-15">总结</h3>
<p><code>View</code> 是所有 UI 元素的基础，<code>ViewGroup</code> 是组织管理多个 <code>View</code> 的容器，二者共同构成了 Android 复杂用户界面的核心构建块。理解它们的角色与区别，是优化布局结构、确保应用具备响应式用户体验的关键。</p>
<h2 data-id="heading-16">ViewStub</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a92496aa4164bac8fdba66e93cb1fb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769041031&amp;x-signature=ZauWMRP1HNOCVcok7EKdpupRm5M%3D" alt="2.png" loading="lazy"/></p>
<p><code>ViewStub</code> 是 Android 中一种轻量级的不可见占位 <code>View</code>，用于延迟加载布局，直到明确需要显示它时才进行加载。它的核心价值在于优化性能——避免加载应用生命周期中可能无需展示的 <code>View</code>，从而减少初始化阶段的系统开销。</p>
<h3 data-id="heading-17">面试问题</h3>
<p><code>ViewStub</code>加载后会发生什么？</p>
<p>它对 <code>View</code> 树的布局性能和内存使用有何具体影响？</p>
<h3 data-id="heading-18">核心特性</h3>
<ol>
<li><strong>轻量级</strong>：<code>ViewStub</code> 在加载目标布局前，仅作为占位符存在，占用极小的内存空间，且不占用实际布局位置；</li>
<li><strong>延迟加载</strong>：目标布局资源仅在调用 <code>inflate()</code> 方法，或 <code>ViewStub</code> 被设置为可见时才会加载；</li>
<li><strong>单次使用</strong>：布局加载完成后，<code>ViewStub</code> 会从 <code>View</code> 树中被替换为加载的布局，无法重复使用。</li>
</ol>
<h3 data-id="heading-19">常见使用场景</h3>
<ol>
<li><strong>条件布局</strong>：适用于需根据条件显示的布局（如错误提示、加载进度条、可选功能模块的 UI 元素）；</li>
<li><strong>减少初始加载时间</strong>：延迟加载复杂或耗资源的 <code>View</code> （如大数据列表、图表），提升 <code>Activity</code>/<code>Fragment</code> 的初始加载速度；</li>
<li><strong>动态UI元素</strong>：仅在用户触发特定操作（如点击按钮）时，才向屏幕添加动态内容，优化内存使用效率。</li>
</ol>
<h3 data-id="heading-20">如何使用 ViewStub</h3>
<p>首先，在 <code>XML</code> 布局中定义 <code>ViewStub</code></p>
<p>在 <code>XML</code> 布局文件中添加 <code>ViewStub</code>，并通过 <code>android:layout</code> 属性指定需要延迟加载的布局资源：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span>
    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 常规显示的View --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/tv_main"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Main Content"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- 占位ViewStub，关联目标布局optional_content --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ViewStub</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/viewStub"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout</span>=<span class="hljs-string">"@layout/optional_content"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>
</code></pre>
<p>然后，在代码中加载 <code>ViewStub</code>。</p>
<p>在 <code>Activity</code> 或 <code>Fragment</code> 中，通过 <code>findViewById</code> 获取 <code>ViewStub</code> 实例，在需要时调用 <code>inflate()</code> 方法加载目标布局：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        <span class="hljs-keyword">val</span> viewStub = findViewById&lt;ViewStub&gt;(R.id.viewStub)
        <span class="hljs-comment">// 仅在需要时加载目标布局</span>
        <span class="hljs-keyword">val</span> inflatedView = viewStub.inflate()
        <span class="hljs-comment">// 访问加载布局中的子View并设置内容</span>
        <span class="hljs-keyword">val</span> optionalTextView = inflatedView.findViewById&lt;TextView&gt;(R.id.optionalText)
        optionalTextView.text = <span class="hljs-string">"Inflated Content"</span>
    }
}
</code></pre>
<h3 data-id="heading-21">优势</h3>
<ol>
<li><strong>性能优化</strong>：延迟加载非必需的 <code>View</code> ，减少应用初始化时的内存占用，提升初始渲染速度；</li>
<li><strong>简化布局管理</strong>：无需手动添加或移除 <code>View</code> ，即可灵活管理可选 UI 元素，降低布局维护成本；</li>
<li><strong>易用性强</strong>：API 简洁直观，支持 <code>XML</code> 直接集成，是开发者优化 UI 性能的便捷工具。</li>
</ol>
<h3 data-id="heading-22">局限性</h3>
<ol>
<li><strong>单次使用</strong>：布局加载后，<code>ViewStub</code> 会从 <code>View</code> 树中移除，无法再次触发加载操作；</li>
<li><strong>功能受限</strong>：作为纯占位 <code>View</code> ，加载前无法处理用户交互，也不能执行复杂的业务逻辑。</li>
</ol>
<h3 data-id="heading-23">总结</h3>
<p><code>ViewStub</code> 是 Android 中优化 UI 性能的实用工具，通过延迟加载布局的核心机制，有效减少内存使用，尤其适用于条件布局或非必需 <code>View</code> 的场景，能显著提升应用响应速度。合理使用 <code>ViewStub</code>，可帮助开发者打造更高效、流畅的用户体验。</p>
<h2 data-id="heading-24">自定义 View</h2>
<p>实现自定义 <code>View</code> 是创建具备特定外观和行为 UI 组件的核心方式，尤其适用于需在多屏幕中复用的场景。</p>
<p>自定义 <code>View</code> 能统一视觉呈现和交互逻辑，保证应用内 UI 风格的一致性和代码的可维护性；同时还能封装复杂 UI 逻辑、提升组件复用率、简化项目整体结构。</p>
<h3 data-id="heading-25">面试问题</h3>
<p>如何在自定义 <code>View</code> 中高效使用自定义属性，同时确保 <code>XML</code> 布局的向后兼容性？</p>
<h3 data-id="heading-26">创建自定义 View 类</h3>
<p>若应用需要标准 UI 组件无法实现的独特设计元素（如自定义形状、特殊动画效果），则必须通过自定义 <code>View</code> 实现。在 Android 开发中，可通过以下步骤结合 <code>XML</code> 创建自定义 <code>View</code> 。</p>
<p>首先，定义一个继承自基础 <code>View</code> 类（如 <code>View</code>、<code>ImageView</code>、<code>TextView</code>）的新类，然后根据需求重写必要的构造函数和核心方法（如 <code>onDraw()</code>、<code>onMeasure()</code>、<code>onLayout()</code>），以实现自定义行为：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomCircleView</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(
    context: Context,
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,
    defStyleAttr: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
) : View(context, attrs, defStyleAttr) {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onDraw(canvas)
        <span class="hljs-keyword">val</span> paint = Paint().apply {
            color = Color.RED
            style = Paint.Style.FILL
        }
        <span class="hljs-comment">// 在View中心绘制红色圆形</span>
        canvas.drawCircle(width / <span class="hljs-number">2f</span>, height / <span class="hljs-number">2f</span>, width / <span class="hljs-number">4f</span>, paint)
    }
}
</code></pre>
<h3 data-id="heading-27">在 XML 布局中使用自定义 View</h3>
<p>创建自定义 <code>View</code> 类后，可在 <code>XML</code> 布局文件中直接引用它（需使用完整包名作为 <code>XML</code> 标签）。后续还可通过自定义属性向该 <code>View</code> 传递配置参数（详见下面步骤）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">com.example.CustomCircleView</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"200dp"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"200dp"</span>
    <span class="hljs-attr">android:layout_gravity</span>=<span class="hljs-string">"center"</span> /&gt;</span>
</code></pre>
<h3 data-id="heading-28">添加自定义属性（可选）</h3>
<p>若需支持从 <code>XML</code> 布局中配置自定义 <code>View</code> 的属性（如颜色、尺寸），需在<code>res/values</code>文件夹的<code>attrs.xml</code>中定义自定义属性：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">declare-styleable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"CustomCircleView"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"circleColor"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"color"</span> /&gt;</span> <span class="hljs-comment">&lt;!-- 圆形颜色属性 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">attr</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"circleRadius"</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"dimension"</span> /&gt;</span> <span class="hljs-comment">&lt;!-- 圆形半径属性 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">declare-styleable</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>
</code></pre>
<p>在自定义 <code>View</code> 的构造函数中，通过 <code>context.obtainStyledAttributes()</code> 获取 <code>XML</code> 中配置的自定义属性值：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomCircleView</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(
    context: Context,
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,
    defStyleAttr: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
) : View(context, attrs, defStyleAttr) {
    <span class="hljs-keyword">var</span> circleColor: <span class="hljs-built_in">Int</span> = Color.RED <span class="hljs-comment">// 默认红色</span>
    <span class="hljs-keyword">var</span> circleRadius: <span class="hljs-built_in">Float</span> = <span class="hljs-number">50f</span> <span class="hljs-comment">// 默认半径50px</span>
    <span class="hljs-keyword">init</span> {
        <span class="hljs-keyword">val</span> typedArray = context.obtainStyledAttributes(attrs, R.styleable.CustomCircleView)
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取XML中配置的circleColor，未配置则使用默认值Color.RED</span>
            circleColor = typedArray.getColor(
                R.styleable.CustomCircleView_circleColor,
                Color.RED
            )
            <span class="hljs-comment">// 获取XML中配置的circleRadius，未配置则使用默认值50f</span>
            circleRadius = typedArray.getDimension(
                R.styleable.CustomCircleView_circleRadius,
                <span class="hljs-number">50f</span>
            )
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 回收TypedArray，避免资源泄漏</span>
            typedArray.recycle()
        }
    }
}
</code></pre>
<h3 data-id="heading-29">处理布局测量（可选）</h3>
<p>若需自定义 <code>View</code> 的尺寸计算逻辑（如固定宽高比例、自适应父容器），可重写 <code>onMeasure()</code> 方法，自定义测量规则：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMeasure</span><span class="hljs-params">(widthMeasureSpec: <span class="hljs-type">Int</span>, heightMeasureSpec: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-keyword">val</span> desiredSize = <span class="hljs-number">200</span> <span class="hljs-comment">// 期望默认尺寸200px</span>
    <span class="hljs-comment">// 根据父容器约束和期望尺寸，计算最终宽高</span>
    <span class="hljs-keyword">val</span> width = resolveSize(desiredSize, widthMeasureSpec)
    <span class="hljs-keyword">val</span> height = resolveSize(desiredSize, heightMeasureSpec)
    <span class="hljs-comment">// 设置测量后的宽高</span>
    setMeasuredDimension(width, height)
}
</code></pre>
<h3 data-id="heading-30">补充提示</h3>
<p>当应用需要适配特定需求的可复用、专用组件，或需实现标准 <code>View</code> 无法完成的动画、计算逻辑、自定义属性等功能时，自定义 <code>View</code> 是最优选择。</p>
<h3 data-id="heading-31">总结</h3>
<p>通过 <code>XML</code> 结合代码的方式在 Android 中实现自定义 <code>View</code> ，能为 UI 设计带来极高的灵活性。开发者可通过自定义 <code>View</code> 系统和 <strong>Compose</strong> 创建各类个性化控件。</p>
<h3 data-id="heading-32">进阶：谨慎使用 @JvmOverloads</h3>
<p><code>@JvmOverloads</code> 是 Kotlin 中用于简化 Kotlin 与 Java 互操作性的注解，它会为 Kotlin 函数或类自动生成多个重载方法/构造函数（尤其适用于 Kotlin 的默认参数——Java 原生不支持默认参数特性）。</p>
<p>使用 <code>@JvmOverloads</code> 时，Kotlin 编译器会在编译后的字节码中生成多个方法/构造函数签名，以覆盖所有带默认值参数的组合。但在实现自定义 <code>View</code> 时，若不谨慎使用 <code>@JvmOverloads</code>，可能会意外覆盖默认 <code>View</code> 样式，导致自定义 <code>View</code> 丢失预期的系统样式——这一问题在扩展 <code>Button</code>、<code>TextView</code> 等预定义样式的 Android  <code>View</code> 时尤为突出。</p>
<p>我们看看下面这个示例，实现自定义 <code>TextInputEditText</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ElasticTextInputEditText</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(
    context: Context,
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,
    defStyleAttr: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
) : TextInputEditText(context, attrs, defStyleAttr) {
    <span class="hljs-comment">// 自定义业务逻辑</span>
}
</code></pre>
<p>在此示例中，将 <code>ElasticTextInputEditText</code> 作为常规 <code>TextInputEditText</code> 使用时，可能会出现意外行为或崩溃——原因是 <code>defStyleAttr</code> 被重写为 <code>0</code>，导致自定义 <code>View</code> 无法继承 <code>TextInputEditText</code> 的默认样式。</p>
<p>当从 <code>XML</code> 加载 <code>View</code> 时，系统会调用双参数构造函数（包含 <code>Context</code> 和 <code>AttributeSet</code> 的那个），而该双参数构造函数会进一步调用三参数构造函数：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ElasticTextInputEditText</span><span class="hljs-params">(Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs)</span> {
    <span class="hljs-built_in">this</span>(context, attrs, <span class="hljs-number">0</span>);
}
</code></pre>
<p>三参数构造函数的 <code>defStyleAttr</code> 参数，在自定义实现中常被默认设为 <code>0</code>，但根据 Android 官方文档描述，其用途为：</p>
<blockquote>
<p>从 <code>XML</code> 加载 <code>View</code> 时，应用主题属性中该类的特定基础样式。 <code>View</code> 的此构造函数允许子类在 <code>inflate</code> 时使用自身的基础样式——例如，<code>Button</code> 的构造函数会调用此版本的父类构造函数，并传入 <code>com.android.internal.R.attr.buttonStyle</code> 作为 <code>defStyleAttr</code>，使 <code>Button</code> 的样式可通过主题进行修改。</p>
</blockquote>
<p>若省略正确的 <code>defStyleAttr</code> 值（如 <code>R.attr.editTextStyle</code>），会导致自定义 <code>View</code> 无法正确继承系统或主题定义的基础样式，在 <code>XML</code> <code>inflate</code> 时出现样式不一致或异常行为。</p>
<h3 data-id="heading-33">TextInputEditText 的内部实现</h3>
<p>查看 <code>TextInputEditText</code> 的内部源码可知，它会主动传入 <code>R.attr.editTextStyle</code> 作为 <code>defStyleAttr</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextInputEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Rect</span> <span class="hljs-variable">parentRect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rect</span>();
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TextInputEditText</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context)</span> {
        <span class="hljs-built_in">this</span>(context, <span class="hljs-literal">null</span>);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TextInputEditText</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs)</span> {
        <span class="hljs-built_in">this</span>(context, attrs, R.attr.editTextStyle);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TextInputEditText</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {
        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);
    }
}
</code></pre>
<p>在 <code>TextInputEditText</code> 的实现中，双参数构造函数会将 <code>android.R.attr.editTextStyle</code> 作为第三个参数（<code>defStyleAttr</code>）传递给父类，确保样式的正确继承。</p>
<h3 data-id="heading-34">修复方法</h3>
<p>要解决样式继承问题，需在自定义 <code>View</code> 的构造函数中，指定正确的 <code>defStyleAttr</code> 默认值（如 <code>R.attr.editTextStyle</code>）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ElasticTextInputEditText</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(
    context: Context,
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,
    defStyleAttr: <span class="hljs-built_in">Int</span> = android.R.attr.editTextStyle
) : TextInputEditText(context, attrs, defStyleAttr) {
    <span class="hljs-keyword">private</span> boolean mTextInputLayoutFocusedRectEnabled;
    <span class="hljs-comment">// 自定义业务逻辑</span>
}
</code></pre>
<p>通过显式将 <code>androidx.appcompat.R.attr.editTextStyle</code> 设为 <code>defStyleAttr</code> 的默认值，可确保自定义 <code>View</code> 在 <code>XML</code> <code>inflate</code> 时，正确继承 <code>TextInputEditText</code> 的预期基础样式，与原生 <code>TextInputEditText</code> 的行为保持一致。</p>
<h2 data-id="heading-35">Canvas</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68250179027d44f99740fe98b8df128d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769041031&amp;x-signature=YLqmecbCFftsxqfaDBTkAQGzn24%3D" alt="3.png" loading="lazy"/></p>
<p><code>Canvas</code> 是 Android 自定义绘制的核心组件，提供了直接在屏幕或其他绘制表面（如 <code>Bitmap</code>）上渲染图形的接口。开发者通过 <code>Canvas</code> 可完全控制绘制过程，常用于创建自定义 <code>View</code> 、复杂动画和个性化视觉效果。</p>
<h3 data-id="heading-36">实战问题</h3>
<p>如何创建一个自定义 <code>View</code> ，以渲染标准库不支持的复杂形状或 UI 元素？</p>
<p>你会使用哪些 <code>Canvas</code> 方法和相关 API？</p>
<h3 data-id="heading-37">工作原理</h3>
<p><code>Canvas</code> 类代表一个 2D 绘制表面，开发者可在其上绘制形状、文本、图片等内容。</p>
<p>它与 <code>Paint</code> 类紧密配合——<code>Paint</code> 负责定义绘制内容的外观（包括颜色、样式、笔触宽度、字体大小等）；当重写自定义 <code>View</code> 的 <code>onDraw()</code> 方法时，系统会自动传入一个 <code>Canvas</code> 对象，供开发者定义具体的绘制内容。</p>
<h3 data-id="heading-38">基础绘制示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomView</span>(context: Context) : View(context) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> paint = Paint().apply {
        color = Color.BLUE <span class="hljs-comment">// 绘制颜色：蓝色</span>
        style = Paint.Style.FILL <span class="hljs-comment">// 填充样式：实心</span>
    }
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onDraw(canvas)
        <span class="hljs-comment">// 在自定义View的中心绘制一个半径为100px的蓝色圆形</span>
        canvas.drawCircle(width / <span class="hljs-number">2f</span>, height / <span class="hljs-number">2f</span>, <span class="hljs-number">100f</span>, paint)
    }
}
</code></pre>
<p>在此示例中，<code>onDraw()</code> 方法通过系统传入的 <code>Canvas</code> 对象，在自定义 <code>View</code> 的中心位置绘制了一个蓝色实心圆形。</p>
<h3 data-id="heading-39">Canvas 的常用操作</h3>
<p><code>Canvas</code> 支持多种绘制操作，满足不同场景的需求：</p>
<ul>
<li><strong>绘制形状</strong>：通过 <code>drawCircle()</code>（圆形）、<code>drawRect()</code>（矩形）、<code>drawLine()</code>（线条）、<code>drawOval()</code>（椭圆）等方法，绘制基础几何形状；</li>
<li><strong>绘制文本</strong>：通过 <code>drawText()</code> 方法，按指定坐标、字体大小和颜色渲染文本内容；</li>
<li><strong>绘制图片</strong>：通过 <code>drawBitmap()</code> 方法，将 <code>Bitmap</code> 对象渲染到指定位置；</li>
<li><strong>绘制自定义路径</strong>：结合 <code>Path</code> 对象和 <code>drawPath()</code> 方法，绘制不规则的复杂形状（如多边形、曲线）。</li>
</ul>
<h3 data-id="heading-40">变换操作</h3>
<p><code>Canvas</code> 支持缩放、旋转、平移等坐标系变换操作，便于绘制复杂场景，具体包括：</p>
<ul>
<li><strong>平移</strong>：通过 <code>canvas.translate(dx, dy)</code> 将 <code>Canvas</code> 的原点 <code>(0,0)</code> 移动到新坐标 <code>(dx, dy)</code>；</li>
<li><strong>缩放</strong>：通过 <code>canvas.scale(sx, sy)</code> 按比例（<code>sx</code> 为 <code>x</code> 轴缩放比，<code>sy</code> 为 <code>y</code> 轴缩放比）缩放后续绘制的内容；</li>
<li><strong>旋转</strong>：通过 <code>canvas.rotate(degrees)</code> 将 <code>Canvas</code> 按指定角度（顺时针为正方向）旋转。</li>
</ul>
<p>需注意：这些变换操作是累积的，会影响后续所有的绘制行为。若需恢复原始坐标系，可结合 <code>canvas.save()</code> 和 <code>canvas.restore()</code> 方法实现。</p>
<h3 data-id="heading-41">使用场景</h3>
<p><code>Canvas</code> 在需要高级自定义图形的场景中尤为实用，典型场景包括：</p>
<ol>
<li><strong>自定义View</strong>：绘制标准控件无法实现的独特 UI 组件（如自定义进度条、仪表盘）；</li>
<li><strong>游戏开发</strong>：精确控制游戏中的图形渲染（如角色、道具、场景元素）；</li>
<li><strong>图表与示意图</strong>：以自定义格式可视化数据（如折线图、饼图、流程图）；</li>
<li><strong>图像处理</strong>：通过代码修改图片内容（如添加水印、裁剪、颜色调整）或合成多张图片。</li>
</ol>
<h3 data-id="heading-42">总结</h3>
<p><code>Canvas</code> 为 Android 开发者提供了在屏幕上渲染自定义图形的灵活方式。</p>
<p>通过其丰富的绘制方法（形状、文本、图片）和变换操作，开发者可创建多样化的视觉效果和自定义体验，广泛应用于需要高级图形能力的自定义 <code>View</code> 开发中。</p>
<h2 data-id="heading-43">重绘</h2>
<p>重绘（<strong>Invalidation</strong>）是 Android  <code>View</code> 系统中 UI 更新的基础机制，指标记 <code>View</code> 需要重绘的过程。当 <code>View</code> 被标记为需要重绘后，系统会在下次绘制周期（<strong>Vsync</strong> 信号触发）中刷新该区域的屏幕，确保用户能看到最新的 UI 状态。</p>
<h3 data-id="heading-44">面试问题</h3>
<p><code>invalidate()</code> 方法的工作原理是什么？它与 <code>postInvalidate()</code> 有何区别？请分别给出适合使用它们的真实场景。</p>
<p>若需要从后台线程更新 UI 元素，如何确保重绘操作安全地在主线程执行？</p>
<h3 data-id="heading-45">工作原理</h3>
<p>当开发者调用 <code>invalidate()</code> 或 <code>postInvalidate()</code> 等方法时，会触发重绘流程：系统首先将目标 <code>View</code> 标记为“脏（dirty）”状态（表示该 <code>View</code> 的 UI 已发生变化，需要重绘）；随后在下一帧绘制时，系统会扫描所有标记为“脏”的 <code>View</code> ，将其纳入绘制流程，重新渲染该 <code>View</code> 的视觉呈现。</p>
<p>例如，当 <code>View</code> 的位置、尺寸、颜色或内容等属性发生变化时，通过重绘机制可确保这些变化及时反映在屏幕上。</p>
<h3 data-id="heading-46">重绘的核心方法</h3>
<ol>
<li><strong>invalidate()</strong>：标记单个 <code>View</code> 为重绘，告知系统在下一次布局绘制流程中重绘该 <code>View</code> 。该方法不会立即触发重绘，而是将重绘请求加入消息队列，等待下一帧执行；</li>
<li><strong>invalidate(Rect dirty)</strong>：<code>invalidate()</code> 的重载版本，允许指定 <code>View</code> 中需要重绘的特定矩形区域（<code>dirty</code> 参数）。通过仅重绘局部区域，可减少不必要的绘制开销，优化性能；</li>
<li><strong>postInvalidate()</strong>：专门用于在非 UI 线程中标记 <code>View</code> 重绘。该方法会自动将重绘请求投递到主线程的消息队列，确保重绘操作在 UI 线程安全执行，避免线程安全问题。</li>
</ol>
<h3 data-id="heading-47">使用 invalidate</h3>
<p>以下是自定义 <code>View</code> 的示例：当 <code>View</code> 的状态（如圆形半径）变化时，通过调用 <code>invalidate()</code> 标记 <code>View</code> 重绘，触发重绘以更新 UI：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomView</span>(context: Context) : View(context) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> circleRadius = <span class="hljs-number">50f</span> <span class="hljs-comment">// 圆形初始半径50px</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onDraw(canvas)
        <span class="hljs-comment">// 绘制当前半径的红色圆形</span>
        canvas.drawCircle(
            width / <span class="hljs-number">2f</span>, height / <span class="hljs-number">2f</span>, circleRadius,
            Paint().apply { color = Color.RED }
        )
    }
    <span class="hljs-comment">// 增加圆形半径的方法</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">increaseRadius</span><span class="hljs-params">()</span></span> {
        circleRadius += <span class="hljs-number">20f</span>
        invalidate() <span class="hljs-comment">// 标记View重绘，触发重绘</span>
    }
}
</code></pre>
<p>在上述示例中，调用 <code>increaseRadius()</code> 方法后，圆形半径增大，<code>invalidate()</code> 会标记 <code>View</code> 为重绘，系统在下一帧会调用 <code>onDraw()</code> 方法，绘制更新后的圆形。</p>
<h3 data-id="heading-48">最佳实践</h3>
<ul>
<li><strong>局部更新优先使用 invalidate(Rect dirty)</strong>：仅当 <code>View</code> 的特定区域发生变化时（如文本内容更新、局部颜色变化），使用该方法指定重绘区域，避免全区域重绘造成的性能浪费；</li>
<li><strong>避免频繁/不必要的 invalidate() 调用</strong>：在动画循环或高频数据刷新场景中，过度调用 <code>invalidate()</code> 会导致绘制压力过大，引发性能瓶颈，需合理控制调用频率；</li>
<li><strong>非 UI 线程必须使用 postInvalidate()</strong>：Android 要求所有 UI 操作（包括重绘）必须在主线程执行，因此在后台线程（如网络请求线程、子线程）中需通过 <code>postInvalidate()</code> 发起重绘请求，确保线程安全。</li>
</ul>
<h3 data-id="heading-49">总结</h3>
<p>重绘是 Android 渲染流水线中的关键概念，是 UI 更新能够直观呈现的核心保障。通过 <code>invalidate()</code>、<code>invalidate(Rect dirty)</code> 或 <code>postInvalidate()</code> 等方法，开发者可高效刷新 <code>View</code>，同时保持应用的流畅性能。合理运用重绘机制，能有效减少不必要的重绘操作，打造更优化、响应更迅速的应用体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[继续AI编排实战：带截图的连麦切片文章生成]]></title>    <link>https://juejin.cn/post/7595115707160576041</link>    <guid>https://juejin.cn/post/7595115707160576041</guid>    <pubDate>2026-01-15T00:26:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595115707160576041" data-draft-id="7595115707160559657" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="继续AI编排实战：带截图的连麦切片文章生成"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-15T00:26:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="摸鱼的春哥"/> <meta itemprop="url" content="https://juejin.cn/user/1714893870865303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            继续AI编排实战：带截图的连麦切片文章生成
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893870865303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    摸鱼的春哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T00:26:23.000Z" title="Thu Jan 15 2026 00:26:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><p>相比于前面的单纯通过声音洗新闻稿件的文字内容，本次我们提升了一定的难度，面向连麦切片场景。</p>
<blockquote>
<p>你怎么知道我喜欢看听勇哥和大冰的连麦？</p>
</blockquote>
<p>那么，我们要处理的核心难点包括：</p>
<ol>
<li>区分不同的发言人</li>
<li>最好能配一些连麦截图到文章里</li>
</ol>
<p>先看看成品效果：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e8b778381af448c9531c307acc1ab8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pG46bG855qE5pil5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769041582&amp;x-signature=hsMFjhPh%2BjLixQwzZZTEwrNE8sc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1. 架构总览</h2>
<p>这套工作流通过 并行处理 极大提高了效率：</p>
<ul>
<li>
<p>输入端：支持 YouTube URL 下载或本地视频文件。</p>
</li>
<li>
<p>音频线：提取音频 -&gt; Deepgram (语音转文字 + 角色分离) -&gt; 文本清洗。</p>
</li>
<li>
<p>视频线：智能截图 (FFmpeg) -&gt; Qshell (上传七牛云) -&gt; 生成图片链接。</p>
</li>
<li>
<p>汇聚端：文本 + 图片链接 -&gt; DeepSeek (AI 深度改写与排版) -&gt; 本地 Markdown 文件。</p>
</li>
</ul>
<h2 data-id="heading-1">2. 环境准备</h2>
<p>可以参考我之前的文章，基于node 16构建一个 debian 镜像，并内置 <code>yt-dlp</code> 和 <code>FFmpeg</code>。
除此之外，需要安装一个 <code>OSS</code> 工具，因为我用的七牛云，所以是 <code>Qshell</code>，这个根据自己的情况定制就行。</p>
<p>以下是我的 <code>Dockerfile</code>，仅供参考吧：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM node:20-bookworm

# 1. 接收构建参数
ARG HTTP_PROXY
ARG HTTPS_PROXY

USER root

# 2. 【系统层代理】
ENV http_proxy=${HTTP_PROXY}
ENV https_proxy=${HTTPS_PROXY}

# 安装系统工具 (Debian环境)
# 增加了 unzip，虽然 tar 也可以，但 unzip 处理某些 zip 包更方便，不过 qshell 是 tar.gz，这里只用 tar 即可
RUN apt-get update &amp;&amp; \
    apt-get install -y python3 python3-pip ffmpeg wget &amp;&amp; \
    rm -rf /var/lib/apt/lists/*

# -------------------------------------------------------
# 2.5 安装工具集：yt-dlp 和 Qshell (七牛命令行)
# -------------------------------------------------------
# 安装 yt-dlp
RUN wget https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -O /usr/local/bin/yt-dlp &amp;&amp; \
    chmod a+rx /usr/local/bin/yt-dlp

# 安装 Qshell (添加到这里)
# Qshell v2.13.0 是目前比较稳定的版本
RUN wget https://devtools.qiniu.com/qshell-v2.13.0-linux-amd64.tar.gz -O /tmp/qshell.tar.gz &amp;&amp; \
    tar -zxvf /tmp/qshell.tar.gz -C /tmp &amp;&amp; \
    # 注意：解压后的文件夹名称通常包含版本号，移动并重命名为 qshell
    mv /tmp/qshell /usr/local/bin/qshell &amp;&amp; \
    chmod +x /usr/local/bin/qshell &amp;&amp; \
    rm /tmp/qshell.tar.gz
# -------------------------------------------------------

# 3. 【NPM 层代理】安装 n8n
RUN npm config set proxy ${HTTP_PROXY} &amp;&amp; \
    npm config set https-proxy ${HTTPS_PROXY} &amp;&amp; \
    npm install -g n8n &amp;&amp; \
    npm config delete proxy &amp;&amp; \
    npm config delete https-proxy

# 4. 权限与清理
RUN mkdir -p /home/node/.n8n /files &amp;&amp; \
    chown -R node:node /home/node/.n8n /files

# 清理环境变量
ENV http_proxy=""
ENV https_proxy=""

USER node
ENTRYPOINT ["n8n"]
</code></pre>
<p><strong>启动命令 (在 docker-compose.yml 所在目录):</strong></p>
<pre><code class="hljs language-bash" lang="bash">docker-compose up -d --build
</code></pre>
<hr/>
<h2 data-id="heading-2">3. 核心节点配置详解</h2>
<p>看看节点布置吧。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d9127fb06644627b7b3e61d6cdaa224~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pG46bG855qE5pil5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769041582&amp;x-signature=LFRwMB6Gp0mF2HECWkEZlvee5PQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">3.1 截图节点 (Execute Command)</h3>
<p>首先是截图，相比于新闻类的视频，连麦视频对于截图的精准性要求低很多。</p>
<p>以“大冰”的连麦视频为例，反正截来截去就是大冰一张瘦脸怼在哪里，所以啥时候截图问题不大，关键有图效果就会好很多。</p>
<p>不使用固定秒数，而是基于视频时长的 <strong>33%</strong> 和 <strong>66%</strong> 处截图，并加上 <strong>日期时间戳</strong> 防止文件名冲突。</p>
<ul>
<li><strong>Command Shell 脚本:</strong></li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/sh</span>

<span class="hljs-comment"># ---------------- 配置区域 ----------------</span>
VIDEO_PATH=<span class="hljs-string">"{{ <span class="hljs-variable">$json</span>.full_path }}"</span>
FOLDER_NAME=<span class="hljs-string">"{{ <span class="hljs-variable">$json</span>.clean_name }}"</span>

<span class="hljs-comment"># 1. 确定输出目录</span>
PARENT_DIR=$(<span class="hljs-built_in">dirname</span> <span class="hljs-string">"<span class="hljs-variable">$VIDEO_PATH</span>"</span>)
OUTPUT_DIR=<span class="hljs-string">"<span class="hljs-variable">$PARENT_DIR</span>/<span class="hljs-variable">$FOLDER_NAME</span>"</span>
<span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$OUTPUT_DIR</span>"</span>

<span class="hljs-comment"># 2. 获取视频时长 &amp; 计算切入点</span>
DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 <span class="hljs-string">"<span class="hljs-variable">$VIDEO_PATH</span>"</span>)
T1=$(awk <span class="hljs-string">"BEGIN {print <span class="hljs-variable">$DURATION</span> * 0.33}"</span>)
T2=$(awk <span class="hljs-string">"BEGIN {print <span class="hljs-variable">$DURATION</span> * 0.66}"</span>)

<span class="hljs-comment"># 3. 生成当前系统时间戳 (防止文件名重复)</span>
<span class="hljs-comment"># 格式: 20250114-103005</span>
NOW_STR=$(<span class="hljs-built_in">date</span> +<span class="hljs-string">"%Y%m%d-%H%M%S"</span>)

<span class="hljs-comment"># 4. 定义文件名 (带上序号)</span>
IMG1=<span class="hljs-string">"<span class="hljs-variable">$OUTPUT_DIR</span>/<span class="hljs-variable">${NOW_STR}</span>-1.jpg"</span>
IMG2=<span class="hljs-string">"<span class="hljs-variable">$OUTPUT_DIR</span>/<span class="hljs-variable">${NOW_STR}</span>-2.jpg"</span>

<span class="hljs-comment"># 5. 执行极速截图 (-ss 放在 -i 之前)</span>
ffmpeg -ss <span class="hljs-string">"<span class="hljs-variable">$T1</span>"</span> -i <span class="hljs-string">"<span class="hljs-variable">$VIDEO_PATH</span>"</span> -frames:v 1 -q:v 2 -y <span class="hljs-string">"<span class="hljs-variable">$IMG1</span>"</span> &gt; /dev/null 2&gt;&amp;1
ffmpeg -ss <span class="hljs-string">"<span class="hljs-variable">$T2</span>"</span> -i <span class="hljs-string">"<span class="hljs-variable">$VIDEO_PATH</span>"</span> -frames:v 1 -q:v 2 -y <span class="hljs-string">"<span class="hljs-variable">$IMG2</span>"</span> &gt; /dev/null 2&gt;&amp;1

<span class="hljs-comment"># 6. 输出 JSON 给后续节点</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"{\"img1_path\": \"<span class="hljs-variable">$IMG1</span>\", \"img2_path\": \"<span class="hljs-variable">$IMG2</span>\", \"folder_path\": \"<span class="hljs-variable">$OUTPUT_DIR</span>\", \"clean_name\": \"<span class="hljs-variable">$FOLDER_NAME</span>\"}"</span>
</code></pre>
<h3 data-id="heading-4">3.2 上传节点 (Execute Command - Qshell)</h3>
<p>直接调用七牛云 CLI 上传文件夹，比 n8n 原生 S3 节点更稳定。</p>
<ul>
<li><strong>Command Shell 脚本:</strong></li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/sh</span>

<span class="hljs-comment"># -------- 配置区域 --------</span>
AK=<span class="hljs-string">"你的AccessKey"</span>
SK=<span class="hljs-string">"你的SecretKey"</span>
BUCKET=<span class="hljs-string">"你的存储桶名称"</span>
DOMAIN=<span class="hljs-string">"https://你的域名"</span> <span class="hljs-comment"># 注意：末尾不要带斜杠</span>
<span class="hljs-comment"># -------------------------</span>

LOCAL_FOLDER=<span class="hljs-string">"{{ JSON.parse(<span class="hljs-variable">$json</span>.stdout).folder_path }}"</span>

<span class="hljs-comment"># 1. 登录七牛 (清理旧配置以防报错)</span>
<span class="hljs-built_in">rm</span> -rf ~/.qshell/account.db &gt; /dev/null 2&gt;&amp;1
qshell account <span class="hljs-string">"<span class="hljs-variable">$AK</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$SK</span>"</span> default

<span class="hljs-comment"># 2. 遍历上传并生成链接</span>
IMG_URLS=<span class="hljs-string">""</span>
<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">$LOCAL_FOLDER</span>"</span>/*.jpg; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> ]; <span class="hljs-keyword">then</span>
        FILENAME=$(<span class="hljs-built_in">basename</span> <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span>)
        <span class="hljs-comment"># 构造云端路径: pic/n8n/文件夹名/文件名</span>
        KEY=<span class="hljs-string">"pic/n8n/{{ JSON.parse(<span class="hljs-variable">$json</span>.stdout).clean_name }}/<span class="hljs-variable">$FILENAME</span>"</span>
        
        qshell fput <span class="hljs-string">"<span class="hljs-variable">$BUCKET</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$KEY</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> --overwrite &gt; /dev/null 2&gt;&amp;1
        IMG_URLS=<span class="hljs-string">"<span class="hljs-variable">$IMG_URLS</span> <span class="hljs-variable">$DOMAIN</span>/<span class="hljs-variable">$KEY</span>"</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>

<span class="hljs-comment"># 3. 输出 URL 列表</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$IMG_URLS</span>"</span>
</code></pre>
<h3 data-id="heading-5">3.3 音频处理 (Deepgram)</h3>
<p><code>Deepgram</code> 是目前最强的声音处理AI厂商，关键还能白嫖200刀的额度。比如说连麦场景，它可以轻松分辨出不同发言人的声音。</p>
<p>这对我们的场景来说非常关键。</p>
<ul>
<li><strong>Method</strong>: POST</li>
<li><strong>URL</strong>: <code>https://api.deepgram.com/v1/listen?model=nova-2&amp;language=zh&amp;diarize=true</code></li>
<li><strong>关键点</strong>: 必须开启 <code>diarize=true</code> 才能区分不同说话人。</li>
</ul>
<h3 data-id="heading-6">3.4 数据汇聚 (Merge Node - <strong>关键</strong>)</h3>
<p>为了让 DeepSeek 同时拿到“文本”和“图片”，必须正确设置 Merge 节点。</p>
<ul>
<li><strong>Mode (模式)</strong>: <code>Combine</code> (合并)</li>
<li><strong>Combine By (合并方式)</strong>: <code>Merge By Position</code> (按位置合并)</li>
<li><strong>效果</strong>: 将上游两条线的数据合并为同一个 JSON 对象。</li>
</ul>
<h3 data-id="heading-7">3.5 AI 写作 (DeepSeek Chat Model)</h3>
<p>这是赋予文章灵魂的一步。</p>
<ul>
<li><strong>System Prompt</strong>: 设定为资深科技主笔。</li>
<li><strong>User Prompt (Expression 模式)</strong>:</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">【对话素材】
{{ $json.<span class="hljs-property">text</span> }} 

【可用配图列表】
{{ $json.<span class="hljs-property">markdown_list</span> }}
(共 {{ $json.<span class="hljs-property">count</span> }} 张图片)

【任务】
请基于以上对话素材撰写文章，并遵循以下规则：
<span class="hljs-number">1.</span> **智能配图**：你拥有 {{ $json.<span class="hljs-property">count</span> }} 张图片的支配权。请根据文章篇幅和叙事节奏，将这些图片**均匀地**插入到文中（例如：文章前<span class="hljs-number">1</span>/<span class="hljs-number">3</span>处插入第一张，后<span class="hljs-number">1</span>/<span class="hljs-number">3</span>处插入第二张）。必须原样输出<span class="hljs-title class_">Markdown</span>图片链接。
<span class="hljs-number">2.</span> **角色识别**：
   - 核心观点输出者是“{{ $(<span class="hljs-string">'表单'</span>).<span class="hljs-property">item</span>.<span class="hljs-property">json</span>.<span class="hljs-property">player1</span> }}”（例如：大冰）。
   - 寻求建议者是“{{ $(<span class="hljs-string">'表单'</span>).<span class="hljs-property">item</span>.<span class="hljs-property">json</span>.<span class="hljs-property">player2</span> }}”（例如：连麦人）。
   - 请识别文本中的 [发言人<span class="hljs-number">0</span>] 和 [发言人<span class="hljs-number">1</span>] 分别对应谁，并在文章中正确称呼，不要使用“发言人<span class="hljs-number">0</span>”这种代号。
<span class="hljs-number">3.</span> **风格要求**：拒绝流水账，使用深度分析或故事叙述风格，自动提炼小标题。
</code></pre>
<hr/>
<h2 data-id="heading-8">4. 使用说明</h2>
<ol>
<li><strong>启动工作流</strong>：点击 n8n 界面上的 <code>Test Workflow</code> 或使用 Webhook。</li>
<li><strong>填写表单</strong>：
<ul>
<li><strong>Mode</strong>: 选择 <code>download</code> (下载 YouTube) 或 <code>local_video</code> (处理 Docker 目录下的文件)。</li>
<li><strong>URL</strong>: 视频链接或文件名。</li>
<li><strong>核心角色</strong>: 填入“大冰”或“罗翔”等。</li>
<li><strong>对话人</strong>: 填入“连麦观众”或“学生”等。</li>
</ul>
</li>
<li><strong>查看结果</strong>：
<ul>
<li>运行结束后，在 Docker 挂载的 <code>/files</code> 目录下会生成一个 <code>视频文件名__对话.md</code> 文件。</li>
<li>文件内已自动排版并插入了七牛云的图片链接。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-9">5. 常见问题排查</h2>
<ul>
<li><strong>Qshell 报错 <code>executable file not found</code></strong>:
<ul>
<li>说明 Docker 镜像没构建好。请确保运行了 <code>docker-compose up -d --build</code>。</li>
</ul>
</li>
<li><strong>DeepSeek 读不到文本或图片</strong>:
<ul>
<li>检查 <strong>Merge</strong> 节点是否设置为了 <code>Combine</code> + <code>Merge By Position</code>。这是最常见的错误点。</li>
</ul>
</li>
<li><strong>文件无法写入</strong>:
<ul>
<li>检查 Docker 挂载目录的权限。宿主机上执行 <code>chmod -R 777 ./local_files</code> 解决权限问题。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Compose Multiplatform 1.10.0 重磅发布！三大核心升级，跨平台开发效率再提升]]></title>    <link>https://juejin.cn/post/7595088044577161262</link>    <guid>https://juejin.cn/post/7595088044577161262</guid>    <pubDate>2026-01-15T00:28:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595088044577161262" data-draft-id="7595088044577144878" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Compose Multiplatform 1.10.0 重磅发布！三大核心升级，跨平台开发效率再提升"/> <meta itemprop="keywords" content="Android,Android Jetpack"/> <meta itemprop="datePublished" content="2026-01-15T00:28:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="黄林晴"/> <meta itemprop="url" content="https://juejin.cn/user/3985057546510423"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Compose Multiplatform 1.10.0 重磅发布！三大核心升级，跨平台开发效率再提升
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3985057546510423/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    黄林晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T00:28:14.000Z" title="Thu Jan 15 2026 00:28:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一次编写，处处预览；一键热更，即时生效。</p>
<blockquote>
<p>JetBrains 正式发布 Compose Multiplatform 1.10.0，这是跨平台 UI 框架的又一重要里程碑。本次更新带来了<strong>统一 @Preview 注解</strong>、<strong>Navigation 3 导航库</strong>、<strong>Compose Hot Reload 正式版</strong>三大核心功能，让多平台开发体验更加顺滑。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">统一 @Preview 注解：告别平台差异</h2>
<h3 data-id="heading-1">更新内容</h3>
<p>以往在 Compose Multiplatform 中使用预览功能时，需要针对不同平台使用不同的注解：</p>
<ul>
<li>Desktop 用 <code>androidx.compose.desktop.ui.tooling.preview.Preview</code></li>
<li>旧版通用 <code>org.jetbrains.compose.ui.tooling.preview.Preview</code></li>
</ul>
<p><strong>现在只需一个注解</strong>：<code>androidx.compose.ui.tooling.preview.Preview</code>，可直接在 <code>commonMain</code> 源集中使用，真正实现"一次编写，处处预览"。</p>
<h3 data-id="heading-2">使用方式</h3>
<p><strong>步骤 1：更新依赖</strong></p>
<p>在 <code>build.gradle.kts</code> 中添加：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">commonMain.dependencies {
    implementation(compose.uiTooling)
}
</code></pre>
<p><strong>步骤 2：编写预览代码</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.compose.ui.tooling.preview.Preview
<span class="hljs-keyword">import</span> androidx.compose.runtime.Composable

<span class="hljs-meta">@Preview</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">GreetingPreview</span><span class="hljs-params">()</span></span> {
    MaterialTheme {
        Text(<span class="hljs-string">"Hello, Compose Multiplatform!"</span>)
    }
}
</code></pre>
<p><strong>步骤 3：迁移旧代码（IDE 自动提示）</strong></p>
<p>IDE 会自动检测旧注解并提供 Quick Fix，一键完成迁移。</p>
<hr/>
<h2 data-id="heading-3">Navigation 3：全新导航体验</h2>
<h3 data-id="heading-4">更新内容</h3>
<p>Navigation 3 是一套<strong>全新的导航库</strong>，与传统 Navigation 2 最大的区别在于：<strong>可以直接操作导航栈</strong>。</p>
<p>不再需要通过隐晦的 <code>navigate()</code> 方法传递参数，而是像操作普通列表一样添加、删除目的地，逻辑更加直观。</p>
<h3 data-id="heading-5">使用方式</h3>
<p><strong>步骤 1：添加依赖</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">commonMain.dependencies {
    implementation(<span class="hljs-string">"org.jetbrains.androidx.navigation3:navigation3-ui:1.0.0-alpha06"</span>)
    implementation(<span class="hljs-string">"org.jetbrains.androidx.lifecycle:lifecycle-viewmodel-navigation3:2.10.0-alpha06"</span>)
}
</code></pre>
<p><strong>步骤 2：基础导航示例</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义导航目的地</span>
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Screen</span> {
    <span class="hljs-keyword">object</span> Home : Screen()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Detail</span>(<span class="hljs-keyword">val</span> id: String) : Screen()
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">AppNavigation</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 创建可观察的导航栈</span>
    <span class="hljs-keyword">var</span> backStack <span class="hljs-keyword">by</span> remember { mutableStateOf(listOf&lt;Screen&gt;(Screen.Home)) }

    NavDisplay(
        backStack = backStack,
        onBack = { backStack = backStack.dropLast(<span class="hljs-number">1</span>) }
    ) { screen -&gt;
        <span class="hljs-keyword">when</span> (screen) {
            <span class="hljs-keyword">is</span> Screen.Home -&gt; HomeScreen(
                onNavigateToDetail = { id -&gt;
                    <span class="hljs-comment">// 直接添加到栈中</span>
                    backStack = backStack + Screen.Detail(id)
                }
            )
            <span class="hljs-keyword">is</span> Screen.Detail -&gt; DetailScreen(screen.id)
        }
    }
}
</code></pre>
<p><strong>步骤 3：平台特定手势支持</strong></p>
<p><strong>iOS 返回手势：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">EndEdgePanGestureBehavior(enabled = <span class="hljs-literal">true</span>)
</code></pre>
<p><strong>Web 键盘支持：</strong></p>
<ul>
<li>按 <code>Esc</code> 键自动返回上一页</li>
<li>自动关闭 Dialog、Popup 等组件</li>
</ul>
<hr/>
<h2 data-id="heading-6">Compose Hot Reload 正式版：即时预览，无需重启</h2>
<h3 data-id="heading-7">更新内容</h3>
<p>Compose Hot Reload 经过长期打磨，现已<strong>升级为 v1.0.0 正式版</strong>，并且：</p>
<ul>
<li>✅ <strong>内置于 Compose Multiplatform Gradle 插件</strong></li>
<li>✅ <strong>默认启用，无需任何配置</strong></li>
<li>✅ <strong>支持 Desktop 项目即时热更新</strong></li>
</ul>
<p>修改代码后，UI 立即刷新，无需重新编译整个应用。</p>
<h3 data-id="heading-8">使用方式</h3>
<p><strong>对于新项目：</strong></p>
<p>只需引入 Compose 插件，Hot Reload 自动启用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">plugins {
    id(<span class="hljs-string">"org.jetbrains.compose"</span>) version <span class="hljs-string">"1.10.0"</span>
    id(<span class="hljs-string">"org.jetbrains.kotlin.multiplatform"</span>) version <span class="hljs-string">"2.1.20"</span>
}
</code></pre>
<p><strong>对于现有项目：</strong></p>
<p>如果之前手动添加了 Hot Reload 插件，现在可以安全删除：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 不再需要</span>
plugins {
    id(<span class="hljs-string">"org.jetbrains.compose-hot-reload"</span>) <span class="hljs-comment">// 可删除</span>
}
</code></pre>
<p><strong>版本要求：</strong></p>
<ul>
<li>Kotlin 版本 ≥ 2.1.20</li>
<li>若 Kotlin 版本过低，Hot Reload 自动禁用，不影响编译</li>
</ul>
<hr/>
<h2 data-id="heading-9">其他重要更新</h2>



































<table><thead><tr><th>功能</th><th>说明</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>Skia 升级至 M138</strong></td><td>渲染性能提升，支持更多图形特性</td><td>复杂动画、图形密集型应用</td></tr><tr><td><strong>iOS UIKit 自适应尺寸</strong></td><td>原生组件自动调整大小，无需手动计算</td><td>混合 UIKit 组件开发</td></tr><tr><td><strong>Web Esc 键导航</strong></td><td>浏览器中 Esc 键触发返回</td><td>Web 应用导航体验优化</td></tr><tr><td><strong>DialogWindow modalityType</strong></td><td>Desktop 对话框支持模态类型设置</td><td>桌面应用窗口管理</td></tr><tr><td><strong>AGP 9.0.0 支持</strong></td><td>兼容最新 Android Gradle Plugin</td><td>Android 项目</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">升级指南</h2>
<h3 data-id="heading-11">最低版本要求</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// settings.gradle.kts</span>
pluginManagement {
    plugins {
        kotlin(<span class="hljs-string">"multiplatform"</span>) version <span class="hljs-string">"2.1.20"</span>  <span class="hljs-comment">// 最低要求</span>
        id(<span class="hljs-string">"org.jetbrains.compose"</span>) version <span class="hljs-string">"1.10.0"</span>
    }
}
</code></pre>
<h3 data-id="heading-12">依赖别名迁移</h3>
<p>从 1.10.0 开始，Gradle 插件中的依赖别名（如 <code>compose.ui</code>）已弃用，建议直接声明版本：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 旧方式（已弃用）</span>
implementation(compose.ui)

<span class="hljs-comment">// ✅ 新方式</span>
implementation(<span class="hljs-string">"org.jetbrains.compose.ui:ui:1.10.0"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-13">六、总结</h2>
<p>Compose Multiplatform 1.10.0 三大核心升级：</p>

























<table><thead><tr><th>功能</th><th>状态</th><th>核心价值</th></tr></thead><tbody><tr><td>统一 @Preview</td><td>✅ 稳定</td><td>一个注解，跨平台预览</td></tr><tr><td>Navigation 3</td><td>🧪 Alpha</td><td>直接操作导航栈</td></tr><tr><td>Hot Reload</td><td>✅ 稳定</td><td>即时热更新，开发效率翻倍</td></tr></tbody></table>
<p><strong>立即升级，体验更高效的跨平台开发！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年终复盘：当 AI 工具链从生产力进化为我的生活秩序]]></title>    <link>https://juejin.cn/post/7595043440520495110</link>    <guid>https://juejin.cn/post/7595043440520495110</guid>    <pubDate>2026-01-14T16:28:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595043440520495110" data-draft-id="7594791357144891434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 年终复盘：当 AI 工具链从生产力进化为我的生活秩序"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-14T16:28:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一点一木"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986187486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 年终复盘：当 AI 工具链从生产力进化为我的生活秩序
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986187486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一点一木
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T16:28:50.000Z" title="Wed Jan 14 2026 16:28:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 <strong>一点一木</strong>。在我的 2025 年终总结里，我分成了两篇：第一篇更专注技术：<a href="https://juejin.cn/post/7592119218029166626" target="_blank" title="https://juejin.cn/post/7592119218029166626">《2025 年终技术复盘：从传统编程到 Vibe Coding 的工作流跃迁》</a>；第二篇更私人化：也就是这篇。但我不想写成纯生活日记。生活和工作在我看来需要分开，而且坦白说，大家也不关心一个陌生人的日常具体怎么样。我更想分享的是：<strong>这些变化对我有用，也希望对你有用</strong>。这篇的中心只有一句话：</p>
<blockquote>
<p><code>AI</code> 提效不是为了更卷，而是为了把时间还给自己。</p>
</blockquote>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e1d6ab888274a2b927ea5e870eab0a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=7hR0hLbyDZtY3mkP4tRlsZ2JnPE%3D" alt="sskwKoKoqaC1sQgf3oJxW" loading="lazy"/></p>
<p>回想年初，我还是那个社畜式开发者：工作占 80% 时间，剩下 20% 用来担心「<code>AI</code> 会不会取代我」。但 <code>Vibe Coding</code> 改变了这一切。它不是什么高大上的概念，就是用自然语言把想法推到可运行的东西。比如，用 <code>Claude</code> 或豆包，几句描述就能生成代码草稿；再用 <code>Cursor</code> 迭代，原型就出来了。这让我在工作中省下大量调试时间——以前修个 <code>bug</code> 可能卡半天，现在 <code>AI</code> 帮我模拟场景，效率至少提升 30%。</p>
<p>更有意思的是，这种提效不是单向的，而是一个闭环：</p>
<blockquote>
<p><strong>工作更快 → 有精力学新东西 → 学到的新东西反过来优化工作 → 继续变快。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-0">告别忙碌的假象：我的能量守恒定律</h3>
<p>2025 年我最明显的变化是：<strong>我不再把所有时间都塞进工作中。</strong></p>
<p>这听起来有点凡尔赛，但本质上是 <strong><code>AI</code> 提效后的红利分配问题</strong>。得益于 <code>Vibe Coding</code> 和 <code>AI</code> 工具链的深度融合，我完成同样质量的工作所花的时间大幅缩减。我没有选择用省下来的时间去接更多的活，而是把它们投入到了<strong>信号捕捉</strong>和<strong>自我迭代</strong>中。</p>
<p><strong>我的逻辑很简单：</strong></p>
<ul>
<li><strong><code>AI</code> 负责执行：</strong> 琐碎的代码实现、文章配图、数据清洗交给 <code>AI</code>。</li>
</ul>

<ul>
<li><strong>我负责决策与链接：</strong> 判断哪个信号值得追、参加什么活动、怎么把学到的东西写成文章、社区互动、学习和使用 <code>AI</code> 相关的内容等等。</li>
</ul>
<p>这种相辅相成的状态，让我终于从「工作-疲惫-休息-焦虑」的死循环，进入了「学习-实践-产出-正反馈」的螺旋上升。</p>
<hr/>
<h3 data-id="heading-1">创作者心态：看到信号，立刻行动</h3>
<p>2025 年我还刻意训练了一件事：<strong>把灵感当成任务，把想法变成交付</strong>。</p>
<p>以前看到一个新技术，我脑子里第一反应是：「我要不要学一下？环境好难搭，等以后有时间再说。」现在我的路径更短，也更现实：：<strong>看到信号 -&gt; 用 <code>Trae</code> / <code>Cursor</code> 快速搭个 <code>Demo</code> -&gt; 在 <code>Obsidian</code> 快速记下核心逻辑 -&gt; 发到社区平台看看反馈。</strong></p>
<p><code>Vibe Coding</code> 对我最大的改变不是写代码更快，而是：<strong>让执行变得极其便宜</strong>。当你能在很短时间内做出一个可展示的版本，你就不会再被<strong>准备成本</strong>劝退；而当你开始把输出交给反馈去校准，学习就不再是孤立的自嗨，而是带方向、带复利的成长。</p>
<hr/>
<h3 data-id="heading-2"><code>AI</code> 全栈工具地图</h3>
<p>为了维持这套流水线的高效运转，我深度体验并筛选了一套工具矩阵。这里分享给大家，希望能帮大家节省筛选时间：</p>
<h4 data-id="heading-3">1.信息猎手层：情报获取与真伪验证</h4>
<p><strong>逻辑：</strong> 在 <code>AI</code> 时代，<strong>信源的确定性</strong>比获取速度更重要。</p>





























<table><thead><tr><th>核心工具</th><th>定位</th><th>核心功能</th><th>用法</th></tr></thead><tbody><tr><td>秘塔<code>AI</code>搜索 / <code>Perplexity</code></td><td>主力</td><td>实时搜索、信源追踪、要点提炼</td><td>用秘塔拉出关键词地图扫盲，用 <code>Perplexity</code> 进行多源交叉验证，彻底杜绝 <code>AI</code> 幻觉。</td></tr><tr><td><code>V2EX</code> / <code>HN</code> / <code>Lobsters</code></td><td>全球信号源</td><td>趋势捕捉、技术黑话、真实槽点洞察</td><td>每天刷 <code>HN</code> 抓全球风向，在 <code>V2EX</code> 翻看真实环境下的踩坑讨论。</td></tr><tr><td><code>DEV</code> / 掘金 / <code>CSDN</code></td><td>中文信号源</td><td>实践教程、技术热点反馈</td><td>寻找落地型教程，观察国内开发者的真实痛点和业务应用场景。</td></tr></tbody></table>
<h4 data-id="heading-4">2.大脑外挂层：深度推理与创作思考</h4>
<p><strong>逻辑：</strong> 既然是 <code>Vibe Coding</code>，就要把最枯燥的逻辑组织交给最强的模型，人负责拍砖决策。</p>









































<table><thead><tr><th>核心工具</th><th>定位</th><th>核心功能</th><th>用法</th></tr></thead><tbody><tr><td><code>Claude</code> (+ <code>Claude Code</code>)</td><td>主力</td><td>长上下文、代码重构、逻辑对齐</td><td><strong>年度最佳损友：</strong> 逻辑极其严密，最适合半夜写长文或修复杂 <code>Bug</code> 时的深度陪跑。</td></tr><tr><td><code>ChatGPT</code> / <code>Gemini</code> / <code>DeepSeek</code></td><td>主力</td><td>通用对话、多模型交叉对照</td><td>同样的问题丢给不同模型，取长补短，对比不同模型的推理路径。</td></tr><tr><td>豆包 / 千问 (<code>Qwen</code>)</td><td>备选</td><td>中文语境、接地气表达</td><td>专门用于微调中文语感，把 <code>AI</code> 腔调转化为更具感染力的技术随笔。</td></tr><tr><td><code>Grok</code></td><td>试验</td><td>幽默对话、脑洞碰撞</td><td>灵感枯竭时去和它互怼，往往能蹦出意想不到的选题金句或毒舌视角。</td></tr><tr><td>沉浸式翻译</td><td>辅助</td><td>术语统一、双语对照消化</td><td>全速消化 <code>GitHub</code> 文档和英文长推，保持全球信息同步零时差。</td></tr></tbody></table>
<h4 data-id="heading-5">3.生产力中心层：代码工程与自动化</h4>
<p><strong>逻辑：</strong> 将想法转化为现实的加速器。</p>



































<table><thead><tr><th>核心工具</th><th>定位</th><th>核心功能</th><th>用法</th></tr></thead><tbody><tr><td><code>Trae</code> / <code>Cursor</code></td><td>主力</td><td><code>AI</code> 驱动 <code>IDE</code>、<code>Builder</code> 模式</td><td><strong>核心生产力：</strong> 用 <code>Trae</code> 自动拆解任务，我只负责关键节点审计，实现 80% 代码免写。</td></tr><tr><td><code>Google Antigravity</code></td><td>高阶</td><td><code>Agent</code> 编排、自主执行与验证</td><td><strong>从程序员升级为指挥官：</strong> 开启 <code>Mission Control</code> 模式，让多个 <code>Agent</code> 并行处理前后端任务。</td></tr><tr><td><code>n8n</code> / <code>Dify</code> / <code>Coze</code></td><td>主力</td><td>工作流编排、<code>Agent</code> 自动化</td><td>只要一个流程重复 3 次，就搭成自动化工厂，把碎碎念的需求变成标准产线。</td></tr><tr><td><code>Ollama</code> / <code>OpenRouter</code></td><td>备选</td><td>本地推理与模型路由切换</td><td>敏感代码跑 <code>Ollama</code>；通过 <code>OpenRouter</code> 一键切换最新发布的各种大模型。</td></tr></tbody></table>
<h4 data-id="heading-6">4.视觉艺术层：高质量内容美化</h4>
<p><strong>逻辑：</strong> 好的技术文章需要顶级的视觉资产来辅助表达。</p>





























<table><thead><tr><th>核心工具</th><th>定位</th><th>核心功能</th><th>用法</th></tr></thead><tbody><tr><td>豆包图像创作模型 4/4.5</td><td>主力</td><td>高稳定中文理解、风格一致性</td><td><strong>头号画师：</strong> 本年所有文章封面和作品 <code>UI</code> 几乎全由它承载，中文 <code>Prompt</code> 极度友好。</td></tr><tr><td>即梦 <code>AI</code> / <code>Sora</code> / <code>MJ</code></td><td>备选</td><td>视频生成与顶尖艺术风格</td><td>演讲时的动态演示用即梦；需要电影级视觉质感时召唤 <code>Midjourney</code>。</td></tr><tr><td><code>Nano Banana</code></td><td>试验</td><td>聊天式图像编辑</td><td><strong>对话即修图：</strong> 像聊天一样微调图像局部，不需要复杂的参数，调整细节非常顺手。</td></tr></tbody></table>
<h4 data-id="heading-7">5.数字化底座：数据承载与知识沉淀</h4>
<p><strong>逻辑：</strong> 所有的输出必须有迹可循，构建可检索的「第二大脑」。</p>





























<table><thead><tr><th>核心工具</th><th>定位</th><th>核心功能</th><th>用法</th></tr></thead><tbody><tr><td>飞书多维表格</td><td>主力</td><td>结构化存储、选题/数据仓库</td><td><strong>乱七八糟终点站：</strong> 所有 <code>Workflow</code> 跑出来的原始素材和发文计划全落在这里。</td></tr><tr><td><code>Typora</code> / <code>Obsidian</code></td><td>主力</td><td>沉浸式写作与双链知识库</td><td><code>Typora</code> 负责轻量化的草稿输出，<code>Obsidian</code> 负责构建长期的知识图谱。</td></tr><tr><td><code>PyTorch</code> / <code>TensorFlow</code></td><td>学习</td><td>底层框架深度学习</td><td><strong>硬核组：</strong> 即使 <code>AI</code> 再强，也要通过这些框架理解神经网络的黑盒逻辑。</td></tr></tbody></table>
<h4 data-id="heading-8">总结与分析：我的工具哲学</h4>
<p>通过这一年的高强度使用，我总结了三条<strong>工具使用守则</strong>，也分享给大家：</p>
<ol>
<li><strong>不要做工具的搬运工，要做流程的建筑师</strong>： 工具本身不值钱，值钱的是你如何用 <code>n8n</code> 或 <code>Coze</code> 将它们串联起来。</li>
<li><strong>多模型交叉验证 (<code>Cross-Check</code>) 是消除幻觉的唯一出路</strong>： 永远不要迷信某一个模型。我的习惯是：<code>Claude</code> 写逻辑，秘塔查事实，豆包调语感。在关键决策上，至少要过三个模型。</li>
<li><strong>沉淀大于产出</strong>： 如果没有飞书多维表格和 <code>Obsidian</code> 的沉淀，这些工具只会让你变得忙碌而不是成长。所有的 <code>AI</code> 产出，必须落入你自己的数据库，才能变成你的第二大脑。</li>
</ol>
<hr/>
<h3 data-id="heading-9">闪光瞬间：从屏幕后走向讲台</h3>
<p>2025 年对我来说，一个很具象的变化是：<strong>我开始从屏幕后走向讲台</strong>。</p>
<p>如果说过去的成长更多发生在我和代码的世界里，那么今年，我通过 <strong>四次重要活动</strong>和<strong>两次演讲</strong>，第一次完整经历了创作者路径的另一半：<strong>输出 → 被看见 → 获得反馈 → 反过来逼自己更清晰</strong>。</p>
<p>这不是我变得更会说，而是我逐渐确认了一件事：</p>
<blockquote>
<p><strong>分享的价值，不在于证明我懂多少，而在于它会逼我把经验沉淀成别人也能用的东西。</strong></p>
</blockquote>
<p><strong>深圳人工智能与机器人发展论坛：</strong> 让我看到了 <code>AI</code> 落地工业界的宏大叙事。</p>
<p>现场照片：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4d1bde38f8542bd8be20ab38db4c432~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=cXmH7D5RLRTjUd3adikSmAmA4zM%3D" alt="20260112-223141" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e08db5fb0654fcab87bef15f9b25911~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=RxukP2R9EJ%2FkOa1b2Ubp5s%2Fd3Nc%3D" alt="ops-coffee-1768370306789.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b626a75d214c4e3ea160ae71c95b4977~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=GzsgatJiYo18cHp8pv0sboIbTH0%3D" alt="ops-coffee-1768370342547.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8671196d20804c9aad4de582f1d1ac13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=VvSHvCWUHP3yfuX847dyRuKaADM%3D" alt="20260112-223352" loading="lazy"/></p>
<p><strong>豆包系列活动（<code>Workshop</code>/挑战赛）：</strong> 从 <strong><code>TOP</code> 创作者面对面直播分享</strong>，到 <strong>创作派对现场演讲</strong>，我最强的体感是：<strong>分享技术带来的快乐，远大于独自跑通代码。</strong></p>
<p><code>Workshop</code> 现场照片：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bf3a0ee6568418ca009605f0cf084f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=SuodQh3awV9Jc2WENhMnefqTsY0%3D" alt="20260113-184823" loading="lazy"/></p>
<p>挑战赛现场照片：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/883a7fe6f65345ebaa83d674cdcefbfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=u7q%2BtoasYd7Ty1duzL940gBfTZU%3D" alt="20260114-135400.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02a88a4bc99744b2b57934f9b67ba934~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=wQHwcgtVw4JgF1IFzVfkyPGEiD0%3D" alt="20260114-135411.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a92bfc9eb9d46f9b0f337d972bbe840~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=E5u83rpu2QaTBo%2Bnqud2GEc131g%3D" alt="20260113-184750.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e19e0eb616004199aacd4e53e869c134~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=IrFhPs1SOhgHTyibuFnMWYXbxzI%3D" alt="20260114-135406.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4b706fcb03e498dba00ea5532ec47e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=Sg1OcFyKOBTT0eVeg8jP1zaav1U%3D" alt="20260114-135416" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4e7d3d3119e4ab68e0829f1067395ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=7axLhfYl4R3cI3G7mO8WU35WbCg%3D" alt="20260114-135557.jpg" loading="lazy"/></p>
<p><strong><code>PromptPilot</code> 产品发布会：</strong> 让我思考如何将 <code>AI</code> 能力产品化，这也是我 2026 年的方向。这场发布会让我更清楚地意识到：<code>AI</code> 能力人人可用，但把能力做成产品才是更难的部分。</p>
<p>从做一个能跑的 <code>demo</code>，到做一个别人愿意持续使用、能形成长期价值的产品，中间差的不是几个功能，而是一整套系统：体验、稳定性、数据闭环、可维护性。</p>
<p>这也逐渐变成我 2026 年更想投入的方向之一：<strong>把工作流做成可以复用、可持续迭代的产品形态。</strong></p>
<p>现场照片：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46cc58bf896e450699568492e0cc3950~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=6CkErXBG9%2F4SSEuoNJBG090wp98%3D" alt="image-20250920190046128.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d608576d3c542cdbd6bf1e3765ea0ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=LCKr5xY22B8Hbq8PCioJE8ms6SQ%3D" alt="20260113-184820.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7aa64c3ed1a44343b9f1498fe881b020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=xEeUcfkcchgQc6iF5pfASP7RRRA%3D" alt="20260113-184539.jpg" loading="lazy"/></p>
<p>借着去北京参加发布会的机会，我也短暂地逃离了代码，去感受了这座城市的烟火气息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8306da9b15e4b4e9d31b9a33c09d1c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=p%2Fz1PJdF8RsV30YER7c0dHV6u9I%3D" alt="20260113-184548.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48c4459455a447c39bb60759fbcf39dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=Ho2o8DDfRr3HHS90JxKXziKqAHk%3D" alt="20260113-184554.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d51fe9c219d409681a696923579386c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=GlfEapDUio8SRkXG6W4OpaRx0PU%3D" alt="20260113-184551.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07eedceb6f7b4eb99a8387e6feb7006f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769012930&amp;x-signature=xMQ0DjPfKa8AbhHjblU0q422OWo%3D" alt="20260113-184614.jpg" loading="lazy"/></p>
<p><strong>关于广告</strong>：商业价值是价值创造的副产物。</p>
<p>今年我也尝试性地接了几个广告。说实话，我把它看作创作者路径闭环的一部分：当你的输出持续为他人创造价值，商业价值往往是顺带出现的结果。</p>
<p>当然，这也会反过来提醒我：<strong>内容的长期信任比短期收益更重要</strong>。所以我会更谨慎地选择合作，也更希望它不影响大家的正常阅读体验。</p>
<hr/>
<h3 data-id="heading-10">2026：在不确定中构建确定性</h3>
<p>面对即将到来的 2026，我不想再什么都写一点，而是要先兑现 2025 年的硬核承诺，再稳扎稳打地向 <code>AI</code> 深水区进发。我的计划分为两个阶段：<strong>补齐基石</strong>与<strong>全面拓荒</strong>。</p>
<h4 data-id="heading-11">填坑与补齐：兑现 2025 的硬核承诺</h4>
<p>2025 年我开了三个极具护城河的长期方向，但因为活动、工具迭代和新灵感太多，更新节奏断了。这些坑不补，后面再开新坑只会更乱。所以 2026 年优先级最高的就是把它们补成完整、可复用的系列。</p>
<ul>
<li><strong>《<code>GEO</code> 生成式引擎优化从入门到精通》专栏</strong>：<code>GEO</code> 是 <code>AI</code> 时代的新 <code>SEO</code>。我会系统讲透如何让内容被 <code>ChatGPT</code>、<code>Perplexity</code>、豆包、<code>DeepSeek</code> 等引擎优先引用。从 <code>RAG</code> 优化、语义理解到 <code>E-E-A-T</code> 权重提升，目标是让创作者从<strong>被算法喂</strong>进化为<strong>懂算法喂人</strong>。</li>
<li><strong>《纯前端用 <code>TensorFlow.js</code> 实现智能图像应用》系列</strong>：坚持在浏览器里跑 <code>AI</code>，这是前端人的尊严。我将补齐从环境搭建、模型加载到 <code>WebGL</code> 加速优化的全链路教程，并配套可复用的 <code>Demo</code> 仓库，带大家在网页里玩转实时滤镜与物体检测。</li>
<li><strong>《<code>GitHub</code> 热门项目与技术趋势前沿》月更计划</strong>：继续担任大家的技术哨兵。每月精选 10 个真正能落地的热门项目，拆解亮点、分享避坑指南，帮大家在信息爆炸中筛选出真正的生产力工具。</li>
</ul>
<h4 data-id="heading-12">拓荒与进化：全面拥抱 <code>AI 2.0</code> 生态</h4>
<p>在打好地基后，我会将精力投向更具自主性与产品化的 <code>AI</code> 主题：</p>
<ul>
<li><strong><code>AI Agent</code>（智能体）实战：</strong> 探索从简单 <code>Prompt</code> 到多 <code>Agent</code> 协作系统的演进，研究如何利用 <code>n8n</code>、<code>Coze</code>、<code>Dify</code> 构建真正能跑通业务的数字员工。</li>
<li><strong>大模型底层与多模态应用：</strong> 持续输出关于模型推理、工具调用、<code>RAG</code> 架构及大模型微调的测评与科普文章。</li>
<li><strong>作品化输出：</strong> 不再满足于写 <code>Demo</code>，尝试做更完整、能解决具体痛点的 <code>AI</code> 原型或小工具。</li>
</ul>
<h4 data-id="heading-13">节奏机制：先交付，再扩张</h4>
<p>为了避免再次“断更”，我为自己设定了一套可持续的节奏：</p>
<ul>
<li><strong>保底：</strong> 每月稳定交付 1-2 篇高质量（补欠优先，三条欠更不断更）</li>
<li><strong>冲刺：</strong> 状态好时加更 <code>AI Agent</code> 或大模型相关的实战教程与互动案例</li>
<li><strong>复盘：</strong> 每季度淘汰低价值方向，<code>All-in</code> 高复利赛道</li>
</ul>
<hr/>
<h3 data-id="heading-14">结语</h3>
<p>2025 年我最大的收获，不是用了多少工具，也不是写了多少篇文章，而是我逐渐建立起一种<strong>更可持续的生命状态</strong>：</p>
<ul>
<li><strong>执行层：</strong> 用 <code>AI</code> 消除重复劳动，让执行变得极度廉价</li>
<li><strong>资产层：</strong> 把省下的时间投入长期资产（如 <code>GEO</code>、<code>TensorFlow.js</code>），让灵感通向闭环</li>
<li><strong>成长层：</strong> 通过活动与演讲，将独自学习转化为带反馈的社交进化</li>
</ul>
<p>生活和工作不应该是割裂的，<code>AI</code> 给了我们一个把它们重新缝合的机会。如果你也感受到了 <code>AI</code> 带来的冲击，我建议你尝试转换视角：<strong>不要把 <code>AI</code> 当成更强的搜索引擎，而要把它当成你个人系统的执行层。</strong></p>
<p>你负责判断、表达与决策；工具负责执行、校验与复用。长期来看，这会让你活得越来越从容。</p>
<p>感谢掘金这个平台，让我找到了属于自己的节奏。2026 年，我依然会在这里，做一个<strong>很能折腾却不卷</strong>的 <code>AI</code> 创作者。</p>
<p><strong>最后，送给大家一句话：不要害怕工具迭代太快，要害怕你失去了看到信号就立刻行动的勇气。</strong></p>
<hr/>
<p>如果你对我的 <strong><code>AI</code> 工具流（如 <code>n8n</code> 与 <code>Coze</code> 的联动）</strong> 或是 <strong><code>AI</code> 辅助写作流程</strong> 感兴趣，或者想聊聊 <strong><code>AI Agent</code></strong> 的未来，欢迎在评论区留言。我们 2026 见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拒绝 `setInterval`！手撕“死了么”生命倒计时，带你看看 60FPS 下的 Web Worker 优雅多线程]]></title>    <link>https://juejin.cn/post/7594851429163270178</link>    <guid>https://juejin.cn/post/7594851429163270178</guid>    <pubDate>2026-01-14T17:50:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594851429163270178" data-draft-id="7594851429163253794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝 `setInterval`！手撕“死了么”生命倒计时，带你看看 60FPS 下的 Web Worker 优雅多线程"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-14T17:50:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zzpper"/> <meta itemprop="url" content="https://juejin.cn/user/3560673121928058"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝 `setInterval`！手撕“死了么”生命倒计时，带你看看 60FPS 下的 Web Worker 优雅多线程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3560673121928058/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zzpper
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T17:50:22.000Z" title="Wed Jan 14 2026 17:50:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">拒绝 <code>setInterval</code>！手撕“死了么”生命倒计时，带你看看 60FPS 下的 Web Worker 优雅多线程</h2>
<blockquote>
<p><strong>摘要</strong>：还在用 <code>setInterval</code> 写倒计时？难怪你的 App 切到后台就“假死”。今天从“死了么”APP 的核心痛点出发，带你用 Web Worker + RAF 重构高精度计时器。拒绝时间偏差，这才是理工男对待生命的严谨态度。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/454709f8971c47b0a8a2493115d78c3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgenpwcGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769017822&amp;x-signature=%2FNu9SeM2UOW0GTC7GYBGBhnqfhk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">写在前面：焦虑的具象化 🕒</h3>
<p>最近朋友圈被一款叫“死了么”的 APP 刷屏了（其实就是各种 Life Countdown 类应用）。看着屏幕上那个不断跳动的数字，精确到毫秒地计算着你离“删库跑路”（划掉）——离“百年之后”还剩多少时间，确实让人有一种<strong>被时间追着砍</strong>的紧迫感。</p>
<p>作为一个“代码洁癖患者”，我第一时间下载体验了一下。UI 很酷，但当我把它挂在后台，刷了一会儿掘金再切回来时，发现倒计时竟然<strong>卡顿了一瞬间</strong>，然后才跳到了正确的时间。</p>
<p><strong>不能忍！绝对不能忍！</strong> 😡</p>
<p>对于普通用户这叫“卡顿”，对于我们开发者来说，这是<strong>对 Event Loop 的亵渎</strong>！很多同学在大一学 JS 的时候，老师都教过 <code>setInterval</code> 做倒计时，但今天我要告诉你：<strong>在生产环境的高精度倒计时里，<code>setInterval</code> 就是个骗子。</strong></p>
<p>今天，我们就来扒开“时间”的底裤，用 <strong>Web Worker</strong> + <strong>requestAnimationFrame</strong> 手搓一个<strong>永不偏差、丝般顺滑</strong>的生命倒计时组件。</p>
<hr/>
<h3 data-id="heading-2">1. 为什么 <code>setInterval</code> 是个“渣男”？💔</h3>
<p>在面试的时候，如果面试官问你：“setInterval(fn, 1000) 真的是每 1000ms 执行一次吗？”</p>
<p>你要是敢说是，那基本就回去等通知了。</p>
<h4 data-id="heading-3">1.1 单线程的“银行柜台”悲剧</h4>
<p>JS 的主线程就像只有一个柜台的银行。</p>
<p>setInterval 并不是“准时执行”，而是“准时把任务扔进排队大厅（任务队列）”。</p>
<p>如果柜台正在处理一个大客户（比如一段耗时的 <code>for</code> 循环，或者复杂的 DOM 渲染），你的定时器回调就得在后面干等。</p>
<blockquote>
<p>⚠️ <strong>高能预警</strong>：这就是著名的 <strong>Event Loop 阻塞</strong>。你以为过了 1 秒，实际可能已经过了 1.5 秒。</p>
</blockquote>
<h4 data-id="heading-4">1.2 浏览器的“节能模式”背刺</h4>
<p>更坑的是，为了省电，现代浏览器（Chrome/Safari）对<strong>后台标签页</strong>极其残忍。如果你的页面切到了后台，<code>setInterval</code> 的执行频率会被强行降频到 <strong>1 秒甚至更久</strong>。</p>
<p>这也是为什么我切回 APP 时会看到时间“跳变”的原因——<strong>因为计时器在后台“睡着”了。</strong></p>
<hr/>
<h3 data-id="heading-5">2. 破局：Web Worker —— 找个“分身”来计时 🕵️‍♂️</h3>
<p>既然主线程（UI 线程）又忙又不靠谱，那我们就开个“外挂”。</p>
<p><strong>Web Worker</strong> 允许我们在主线程之外运行脚本。它就像是银行里的 <strong>VIP 专属柜台</strong>，完全不受主线程 DOM 渲染和 UI 卡顿的影响。哪怕主线程在进行复杂的 Canvas 渲染，Worker 里的计时器依然稳如老狗。</p>
<h4 data-id="heading-6">2.1 架构设计：主仆分离</h4>
<p>我们要实现一个<strong>优雅的架构</strong>：</p>
<ol>
<li><strong>Worker 线程</strong>：只负责“滴答”，每隔一段固定时间（比如 100ms）向主线程发一个“心跳包”。</li>
<li><strong>Main 线程</strong>：负责“渲染”，接收到心跳后，利用 <code>requestAnimationFrame</code> 更新 UI。</li>
</ol>
<p>这种模式在游戏开发中叫 <strong>“逻辑与渲染分离”</strong> ，非常高级。😎</p>
<hr/>
<h3 data-id="heading-7">3. Talk is Cheap, Show me the Code 💻</h3>
<p>我们要实现一个 Hook：<code>useLifeCountdown</code>。</p>
<h4 data-id="heading-8">Step 1: 编写那个“不知疲倦”的 Worker</h4>
<p>首先，创建一个 <code>timer.worker.js</code>。这是我们的<strong>独立时间守护者</strong>。</p>
<p>JavaScript</p>
<pre><code class="hljs language-ini" lang="ini">// timer.worker.js

let <span class="hljs-attr">timerId</span> = null<span class="hljs-comment">;</span>
let <span class="hljs-attr">interval</span> = <span class="hljs-number">1000</span><span class="hljs-comment">;</span>

// 监听主线程指令
<span class="hljs-attr">self.onmessage</span> = (e) =&gt; {
  const { action, payload } = e.data<span class="hljs-comment">;</span>

  if (<span class="hljs-attr">action</span> === <span class="hljs-string">'START'</span>) {
    <span class="hljs-attr">interval</span> = payload || <span class="hljs-number">1000</span><span class="hljs-comment">;</span>
    // 💡 即使在这里用 setInterval，由于 Worker 是独立线程
    // 它不会受主线程 UI 卡顿影响，也不会因为页面后台而轻易降频（大部分情况）
    <span class="hljs-attr">timerId</span> = setInterval(() =&gt; {
      // 只发送“脉冲”，不发送具体时间，减少数据传输量
      self.postMessage({ type: 'TICK' })<span class="hljs-comment">;</span>
    }, interval)<span class="hljs-comment">;</span>
  } else if (<span class="hljs-attr">action</span> === <span class="hljs-string">'STOP'</span>) {
    if (timerId) {
      clearInterval(timerId)<span class="hljs-comment">;</span>
      <span class="hljs-attr">timerId</span> = null<span class="hljs-comment">;</span>
    }
  }
}<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-9">Step 2: 主线程的“优雅”接收 (Vue3/React 通用逻辑)</h4>
<p>这里用 TypeScript 写一个 Class 来封装，显得咱们比较专业。</p>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// PreciseTimer.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreciseTimer</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">worker</span>: <span class="hljs-title class_">Worker</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">startTime</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">duration</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 倒计时总时长（毫秒）</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">callback</span>: <span class="hljs-function">(<span class="hljs-params">remaining: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">duration: <span class="hljs-built_in">number</span>, callback: (time: <span class="hljs-built_in">number</span>) =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">duration</span> = duration;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span> = callback;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

    <span class="hljs-comment">// 💡 实例化 Worker (注意 Vite/Webpack 的引入方式可能不同)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./timer.worker.js'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>));
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'TICK'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">syncTime</span>();
      }
    };
  }

  <span class="hljs-comment">// 核心：基于系统时间的校准机制</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">syncTime</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-comment">// 逝去的时间</span>
    <span class="hljs-keyword">const</span> elapsed = now - <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>; 
    <span class="hljs-comment">// 剩余时间</span>
    <span class="hljs-keyword">const</span> remaining = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">duration</span> - elapsed);

    <span class="hljs-comment">// 🔥 重点：虽然 Worker 触发了 update，但我们要用 requestAnimationFrame </span>
    <span class="hljs-comment">// 确保 UI 更新与屏幕刷新率同步，避免画面撕裂</span>
    <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callback</span>(remaining);
    });

    <span class="hljs-keyword">if</span> (remaining &lt;= <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stop</span>();
    }
  }

  <span class="hljs-keyword">public</span> <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 告诉 Worker：每 16ms (约 60FPS) 叫我一次</span>
    <span class="hljs-comment">// 实际上我们可以设置得大一点，比如 50ms，因为 syncTime 会计算精准插值</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">action</span>: <span class="hljs-string">'START'</span>, <span class="hljs-attr">payload</span>: <span class="hljs-number">20</span> }); 
  }

  <span class="hljs-keyword">public</span> <span class="hljs-title function_">stop</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">action</span>: <span class="hljs-string">'STOP'</span> });
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span>.<span class="hljs-title function_">terminate</span>(); <span class="hljs-comment">// 杀掉 Worker，释放内存</span>
  }
}
</code></pre>
<blockquote>
<p>💡 极客细节：</p>
<p>细心的同学发现了，我在 syncTime 里重新计算了 Date.now() - startTime。</p>
<p>为什么要这么做？</p>
<p>因为 Worker 的 setInterval 虽然稳定，但长期运行依然会有微小的累积误差。“时间戳差值法” 是消除误差的终极奥义——无论中间 tick 此时准不准，我每次计算的都是物理世界的绝对时间差。这就是**“无状态”**计时的精髓。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">4. 视觉层：让焦虑“流动”起来 (Canvas 粒子) 🎨</h3>
<p>有了精准的时间内核，剩下的就是皮囊了。为了致敬“死了么”，我们不用枯燥的 <code>&lt;div&gt;</code> 文字，我们用 Canvas 画一个<strong>生命进度条</strong>。</p>
<p><em>(为了不占篇幅，这里只放核心渲染逻辑)</em></p>
<p>JavaScript</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">drawLifeBar</span>(ctx, percentage) {
  <span class="hljs-comment">// 清空画布</span>
  ctx<span class="hljs-selector-class">.clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);
  
  <span class="hljs-comment">// 渐变色：从生机勃勃的绿 -&gt; 焦虑的黄 -&gt; 绝望的红</span>
  const gradient = ctx<span class="hljs-selector-class">.createLinearGradient</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, <span class="hljs-number">0</span>);
  gradient<span class="hljs-selector-class">.addColorStop</span>(<span class="hljs-number">0</span>, '#<span class="hljs-number">4</span>ade80'); <span class="hljs-comment">// Green</span>
  gradient<span class="hljs-selector-class">.addColorStop</span>(<span class="hljs-number">0.5</span>, '#facc15'); <span class="hljs-comment">// Yellow</span>
  gradient<span class="hljs-selector-class">.addColorStop</span>(<span class="hljs-number">1</span>, '#ef4444'); <span class="hljs-comment">// Red</span>
  
  ctx<span class="hljs-selector-class">.fillStyle</span> = gradient;
  
  <span class="hljs-comment">// 使用贝塞尔曲线画出液体的流动感</span>
  <span class="hljs-comment">// 这里的 offset 可以根据 performance.now() 动态变化，产生波浪效果</span>
  ctx<span class="hljs-selector-class">.beginPath</span>();
  ctx<span class="hljs-selector-class">.moveTo</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
  ctx<span class="hljs-selector-class">.lineTo</span>(width * percentage, <span class="hljs-number">0</span>);
  ctx<span class="hljs-selector-class">.lineTo</span>(width * percentage, height);
  ctx<span class="hljs-selector-class">.lineTo</span>(<span class="hljs-number">0</span>, height);
  ctx<span class="hljs-selector-class">.fill</span>();
}
</code></pre>
<p>当 PreciseTimer 的回调触发时，我们将 remaining / total 传给这个 drawLifeBar。</p>
<p>你会发现，哪怕你此时在狂拖浏览器窗口，或者并在几十个 Tab 页中反复横跳，这个进度条的推进依然稳如泰山，丝滑如德芙。</p>
<hr/>
<h3 data-id="heading-11">总结与升华：技术之外的思考 🤔</h3>
<p>这就是我们作为技术人对“生命倒计时”的回应。</p>
<p>我们用 <strong>Web Worker</strong> 对抗了浏览器的后台节流，用 <strong>时间戳差值</strong> 对抗了运行时的累积误差，用 <strong>RAF</strong> 对抗了视觉卡顿。</p>
<p>我们总是试图在代码里追求 <strong>0ms 的误差</strong>，追求 <strong>O(1) 的复杂度</strong>。但回到现实，我们自己人生的“倒计时”——那个最终的 <code>clearInterval</code>，却是无法重构的。</p>
<p><strong>“死了么”APP 火爆的背后，不是因为技术多牛，而是它戳中了当代年轻人的“时间焦虑”。</strong></p>
<p>所以，写完这个 Demo，我合上电脑，决定今晚不修那个该死的 Bug 了。
人生苦短，对老己好一点，出去吃个宵夜犒劳一下老己，好好休息一下（有空记得给老妈打电话）。</p>
<p><strong>毕竟，代码可以回滚，人生只有一次 Commit。</strong></p>
<hr/>
<h4 data-id="heading-12">互动时刻 💬</h4>
<blockquote>
<p><strong>你的“生命倒计时”还剩多少？</strong></p>
<ol>
<li>不到 30%，求求别卷了，躺平吧 🛌</li>
<li>刚过 20%，扶我起来，我还能学！📚</li>
<li><strong>本人</strong>：我觉得我和前端加一起还能再活 500 年！（手动狗头）</li>
</ol>
<p><strong>码字不易，如果你觉得这个 <code>Worker</code> 方案有点东西，给小老弟点个赞吧！👍</strong></p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Livewire4 正式发布！PHP 也可以无需写一行 Javascript 代码就能实现 Vue 的功能]]></title>    <link>https://juejin.cn/post/7594832320030801963</link>    <guid>https://juejin.cn/post/7594832320030801963</guid>    <pubDate>2026-01-14T23:32:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594832320030801963" data-draft-id="7595033052796469289" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Livewire4 正式发布！PHP 也可以无需写一行 Javascript 代码就能实现 Vue 的功能"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2026-01-14T23:32:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Livewire4 正式发布！PHP 也可以无需写一行 Javascript 代码就能实现 Vue 的功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T23:32:45.000Z" title="Wed Jan 14 2026 23:32:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Livewire4 正式发布！PHP 也可以无需写一行 Javascript 代码就能实现 Vue 的功能</h2>
<p>Livewire 4 正式发布，这是迄今为止最大的一次版本更新。</p>
<p>这次更新的重点不是增加复杂度，而是更好的默认配置、更少的摩擦、更强大的工具。团队花了几个月时间重新思考 Livewire 组件应该是什么样子。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Flivewire-4-everything-new" target="_blank" title="https://catchadmin.com/post/2026-01/livewire-4-everything-new" ref="nofollow noopener noreferrer">原文 Livewire4 正式发布！PHP 也可以无需写一行 Javascript 代码就能实现 Vue 的功能</a></p>
<h3 data-id="heading-1">基于视图的组件</h3>
<p>Livewire 4 最直观的变化是组件的写法。以前需要在 PHP 类和 Blade 文件之间来回切换，现在可以把所有东西放在一个文件里：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-comment">// resources/views/components/⚡counter.blade.php</span>
 
<span class="hljs-keyword">use</span> <span class="hljs-title">Livewire</span>\<span class="hljs-title">Component</span>;
 
<span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Component</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$count</span> = <span class="hljs-number">0</span>;
 
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">increment</span>(<span class="hljs-params"/>)
    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;count++;
    }
};
<span class="hljs-meta">?&gt;</span>
 
&lt;div&gt;
    &lt;h1&gt;{{ <span class="hljs-variable">$count</span> }}&lt;/h1&gt;
    &lt;button wire:click=<span class="hljs-string">"increment"</span>&gt;+&lt;/button&gt;
&lt;/div&gt;
 
&lt;style&gt;
    <span class="hljs-comment">/* Scoped CSS... */</span>
&lt;/style&gt;
 
&lt;script&gt;
    <span class="hljs-comment">/* Component JavaScript... */</span>
&lt;/script&gt;
</code></pre>
<p>运行 <code>php artisan make:livewire</code> 时默认就是这种格式。文件名里的闪电符号让 Livewire 组件在文件树里一眼就能认出来，不会和普通 Blade 组件混淆。（不喜欢 emoji 的话可以关掉。）</p>
<p>对于大型组件，还有一种多文件格式，把相关文件放在同一个目录下：</p>
<pre><code class="hljs language-text" lang="text">⚡counter/
├── counter.php
├── counter.blade.php
├── counter.css          (可选)
├── counter.js           (可选)
└── counter.test.php     (可选)
</code></pre>
<p>用 <code>--mfc</code> 参数创建多文件组件，随时可以用 <code>php artisan livewire:convert</code> 在两种格式之间转换。</p>
<h3 data-id="heading-2">路由</h3>
<p>组件引用方式统一了。Livewire 4 引入了 <code>Route::livewire()</code>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 之前 (v3) - 仍然支持</span>
<span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/posts/create'</span>, <span class="hljs-title class_">CreatePost</span>::<span class="hljs-variable language_">class</span>);
 
<span class="hljs-comment">// 现在 (v4)</span>
<span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">livewire</span>(<span class="hljs-string">'/posts/create'</span>, <span class="hljs-string">'pages::post.create'</span>);
</code></pre>
<p>新语法用名称而不是类来引用组件，和应用其他地方渲染组件的方式一致。</p>
<h3 data-id="heading-3">命名空间</h3>
<p>Livewire 现在对应用结构有了自己的约定。默认提供两个命名空间：<code>pages::</code> 用于页面组件，<code>layouts::</code> 用于布局——其他组件和 Blade 组件一起放在 <code>resources/views/components</code> 目录下。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">livewire</span>(<span class="hljs-string">'/dashboard'</span>, <span class="hljs-string">'pages::dashboard'</span>);
</code></pre>
<p>对于模块化应用，可以注册自定义命名空间。把管理后台组件放在 <code>admin::</code> 下，计费相关的放在 <code>billing::</code> 下，按你的架构来组织。</p>
<h3 data-id="heading-4">脚本和样式</h3>
<p>组件的 JavaScript 和 CSS 现在可以和组件放在一起。直接在模板里加 <code>&lt;script&gt;</code> 和 <code>&lt;style&gt;</code> 标签：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>{{ $count }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">wire:click</span>=<span class="hljs-string">"$js.celebrate"</span>&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
 
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.title</span> {
    <span class="hljs-attribute">color</span>: blue;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2rem</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
 
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$js</span>.<span class="hljs-property">celebrate</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">confetti</span>()
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>样式自动限定在组件范围内——你的 <code>.title</code> 类不会影响页面其他部分。需要全局样式的话，加上 <code>global</code> 属性：<code>&lt;style global&gt;</code>。</p>
<p>脚本里可以用 <code>this</code> 访问组件上下文——相当于你可能用过的 <code>$wire</code> 的别名。</p>
<p>两者都会作为原生 <code>.js</code>/<code>.css</code> 文件发送到浏览器，自动缓存以获得最佳性能。</p>
<h3 data-id="heading-5">Islands</h3>
<p>Islands 是 Livewire 4 的重头戏。它可以在组件内创建独立更新的隔离区域：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    @island
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            Revenue: {{ $this-&gt;revenue }}
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">wire:click</span>=<span class="hljs-string">"$refresh"</span>&gt;</span>Refresh<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    @endisland
 
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 这部分在 island 更新时不会重新渲染 --&gt;</span>
        Other content...
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>点击"Refresh"时，只有 island 部分重新渲染，其他内容保持不变。以前要实现类似的隔离效果，需要把这部分提取成单独的子组件，还要处理 props 和 events 的传递。</p>
<p>性能提升不只是 DOM 更新层面。当 islands 和计算属性配合使用时，只有该 island 需要的数据才会被获取。如果组件有三个 island，各自引用不同的计算属性，刷新一个 island 只会执行那个 island 的查询。从数据库到渲染 HTML，整个链路的开销都被隔离了。</p>
<p>Islands 支持懒加载（<code>lazy: true</code>）、命名以便跨组件定位（<code>name: 'revenue'</code>），以及追加内容用于无限滚动：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">wire:click</span>=<span class="hljs-string">"loadMore"</span> <span class="hljs-attr">wire:island.append</span>=<span class="hljs-string">"feed"</span>&gt;</span>
    Load more
<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">插槽和属性转发</h3>
<p>如果你用过 Blade 组件的插槽和属性转发，这里会很熟悉。</p>
<p>插槽让父组件可以向子组件注入内容，同时保持响应式：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">livewire:card</span> <span class="hljs-attr">:</span>$<span class="hljs-attr">post</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{{ $post-&gt;title }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">wire:click</span>=<span class="hljs-string">"delete({{ $post-&gt;id }})"</span>&gt;</span>Delete<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">livewire:card</span>&gt;</span>
</code></pre>
<p>插槽内容在父组件的上下文中求值，所以 <code>wire:click="delete"</code> 调用的是父组件的方法。</p>
<p>属性转发可以把 HTML 属性传递下去：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">livewire:post.show</span> <span class="hljs-attr">:</span>$<span class="hljs-attr">post</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mt-4"</span> /&gt;</span>
 
<span class="hljs-comment">&lt;!-- post.show 组件内部 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> {{ $<span class="hljs-attr">attributes</span> }}&gt;</span>
    ...
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-7">拖拽排序</h3>
<p>内置拖拽排序，不需要外部库：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">wire:sort</span>=<span class="hljs-string">"reorder"</span>&gt;</span>
    @foreach ($items as $item)
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">wire:key</span>=<span class="hljs-string">"{{ $item-&gt;id }}"</span> <span class="hljs-attr">wire:sort:item</span>=<span class="hljs-string">"{{ $item-&gt;id }}"</span>&gt;</span>
            {{ $item-&gt;title }}
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    @endforeach
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reorder</span>(<span class="hljs-params"><span class="hljs-variable">$item</span>, <span class="hljs-variable">$position</span></span>)
</span>{
    <span class="hljs-comment">// $item 是 ID，$position 是新的索引</span>
}
</code></pre>
<p>动画效果自动处理。用 <code>wire:sort:handle</code> 添加拖拽手柄，用 <code>wire:sort:ignore</code> 防止交互元素触发拖拽，用 <code>wire:sort:group</code> 在多个列表之间拖拽。</p>
<h3 data-id="heading-8">平滑过渡</h3>
<p><code>wire:transition</code> 指令使用浏览器的 View Transitions API 添加硬件加速动画：</p>
<pre><code class="hljs language-html" lang="html">@if ($showAlertMessage)
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">wire:transition</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 消息平滑淡入淡出 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
@endif
</code></pre>
<p>对于步骤向导或轮播这种需要方向感的场景，可以指定过渡类型：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">#[Transition</span>(<span class="hljs-attr">type</span>: <span class="hljs-string">'forward'</span>)<span class="hljs-meta">]</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span>(<span class="hljs-params"/>) </span>{ <span class="hljs-variable language_">$this</span>-&gt;step++; }
 
<span class="hljs-meta">#[Transition</span>(<span class="hljs-attr">type</span>: <span class="hljs-string">'backward'</span>)<span class="hljs-meta">]</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">previous</span>(<span class="hljs-params"/>) </span>{ <span class="hljs-variable language_">$this</span>-&gt;step--; }
</code></pre>
<p>然后用 <code>::view-transition-old()</code> 和 <code>::view-transition-new()</code> 伪元素为每个方向自定义 CSS 动画。</p>
<h3 data-id="heading-9">乐观更新</h3>
<p>让界面响应更即时。这些指令会立即更新页面，不需要等待服务器响应。</p>
<p><code>wire:show</code> 用 CSS 切换可见性（不移除 DOM，不发网络请求）：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">wire:show</span>=<span class="hljs-string">"showModal"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 立即显示/隐藏 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><code>wire:text</code> 立即更新文本内容：</p>
<pre><code class="hljs language-html" lang="html">Likes: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">wire:text</span>=<span class="hljs-string">"likes"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
</code></pre>
<p><code>wire:bind</code> 响应式绑定任意 HTML 属性：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">wire:model</span>=<span class="hljs-string">"message"</span> <span class="hljs-attr">wire:bind:class</span>=<span class="hljs-string">"message.length &gt; 240 &amp;&amp; 'text-red-500'"</span>&gt;</span>
</code></pre>
<p><code>$dirty</code> 跟踪未保存的更改：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">wire:show</span>=<span class="hljs-string">"$dirty"</span>&gt;</span>You have unsaved changes<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">wire:show</span>=<span class="hljs-string">"$dirty('title')"</span>&gt;</span>Title modified<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">加载状态</h3>
<p>除了 v3 已有的 <code>wire:loading</code>，Livewire 4 会自动给触发网络请求的元素添加 <code>data-loading</code> 属性。</p>
<p>这样可以直接用 CSS 设置加载状态样式，还能定位兄弟、父级或子元素：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">wire:click</span>=<span class="hljs-string">"save"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"data-loading:opacity-50"</span>&gt;</span>
    Save <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"not-in-data-loading:hidden"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h3 data-id="heading-11">内联占位符</h3>
<p>对于懒加载组件和 islands，<code>@placeholder</code> 指令可以在内容旁边直接定义加载状态：</p>
<pre><code class="hljs language-html" lang="html">@placeholder
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"animate-pulse h-32 bg-gray-200 rounded"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
@endplaceholder
 
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 实际内容加载到这里 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>不需要单独的占位符视图或方法——骨架屏就在组件里面。</p>
<h3 data-id="heading-12">JavaScript 工具</h3>
<p>需要用 JavaScript 的时候，Livewire 4 也能配合。</p>
<p><code>wire:ref</code> 给元素命名以便定位：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">livewire:modal</span> <span class="hljs-attr">wire:ref</span>=<span class="hljs-string">"modal"</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">dispatch</span>(<span class="hljs-string">'close'</span>)-&gt;<span class="hljs-title function_ invoke__">to</span>(<span class="hljs-attr">ref</span>: <span class="hljs-string">'modal'</span>);
</code></pre>
<p>也可以在组件脚本里访问 refs：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">wire:ref</span>=<span class="hljs-string">"search"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> /&gt;</span>
 
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">search</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-comment">// 处理键盘事件...</span>
    })
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><code>#[Json]</code> 方法直接返回数据给 JavaScript：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">#[Json</span><span class="hljs-meta">]</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">search</span>(<span class="hljs-params"><span class="hljs-variable">$query</span></span>)
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Post</span>::<span class="hljs-title function_ invoke__">where</span>(<span class="hljs-string">'title'</span>, <span class="hljs-string">'like'</span>, <span class="hljs-string">"%<span class="hljs-subst">{$query}</span>%"</span>)-&gt;<span class="hljs-title function_ invoke__">get</span>();
}
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">let</span> results = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">search</span>(<span class="hljs-string">'livewire'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(results)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><code>$js</code> actions 只在客户端运行：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">wire:click</span>=<span class="hljs-string">"$js.bookmark"</span>&gt;</span>Bookmark<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
 
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$js</span>.<span class="hljs-property">bookmark</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">bookmarked</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">bookmarked</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">save</span>()
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>拦截器可以在各个层级钩入请求：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">intercept</span>(<span class="hljs-string">'save'</span>, <span class="hljs-function">(<span class="hljs-params">{ onSuccess, onError }</span>) =&gt;</span> {
        <span class="hljs-title function_">onSuccess</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">showToast</span>(<span class="hljs-string">'Saved!'</span>))
        <span class="hljs-title function_">onError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">showToast</span>(<span class="hljs-string">'Failed to save'</span>, <span class="hljs-string">'error'</span>))
    })
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>用全局拦截器处理应用级别的问题，比如会话过期：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Livewire</span>.<span class="hljs-title function_">interceptRequest</span>(<span class="hljs-function">(<span class="hljs-params">{ onError }</span>) =&gt;</span> {
    <span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">{ response, preventDefault }</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> === <span class="hljs-number">419</span>) {
            <span class="hljs-title function_">preventDefault</span>()
            <span class="hljs-keyword">if</span> (<span class="hljs-title function_">confirm</span>(<span class="hljs-string">'Session expired. Refresh?'</span>)) {
                <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>()
            }
        }
    })
})
</code></pre>
<h3 data-id="heading-13">升级</h3>
<p>Livewire 4 保持了很好的向后兼容性。现有组件可以继续使用——新的单文件格式是新组件的默认选项，但基于类的组件仍然完全支持。</p>
<p>查看升级指南 →</p>
<p>如果想看实际演示，我在 Laracasts 上录了一个新系列，用真实案例深入讲解每个特性。观看 Livewire 4 系列 →</p>
<p>Livewire 4 现在可用：</p>
<pre><code class="hljs language-bash" lang="bash">composer require livewire/livewire:^4.0
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flaravel-livewire.catchadmin.com" target="_blank" title="https://laravel-livewire.catchadmin.com" ref="nofollow noopener noreferrer">Laravel Livewire 中文文档正式发布</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[“提供溢出的情绪价值”是AI产品极具可能性的方向]]></title>    <link>https://juejin.cn/post/7595033052796485673</link>    <guid>https://juejin.cn/post/7595033052796485673</guid>    <pubDate>2026-01-15T00:02:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595033052796485673" data-draft-id="7594832320030834731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="“提供溢出的情绪价值”是AI产品极具可能性的方向"/> <meta itemprop="keywords" content="人工智能,后端,产品"/> <meta itemprop="datePublished" content="2026-01-15T00:02:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序新视界"/> <meta itemprop="url" content="https://juejin.cn/user/3368559359568696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            “提供溢出的情绪价值”是AI产品极具可能性的方向
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3368559359568696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序新视界
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T00:02:41.000Z" title="Thu Jan 15 2026 00:02:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上篇文章《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FA2gs0P7UAcdUsWL1QLIPRQ" target="_blank" title="https://mp.weixin.qq.com/s/A2gs0P7UAcdUsWL1QLIPRQ" ref="nofollow noopener noreferrer">面对AI的飞速发展，我们的职业路径有什么变化？</a>》中，我们聊了AI对从业者的影响，这篇文章我们聊聊AI对产品的一个方向的增益。</p>
<p>在过去的一两周里，互联网上有两个意外爆火的事件：“合川呆呆”事件和“死了么”APP。这两个事件看似风马牛不相及，但反映着共同的底层逻辑——情绪价值的满足。</p>
<p>关于这两个事件的始末可自行搜索，这里不做展开。但这两件事都映射了一个现象：人们在满足了物质之后，对精神层面的渴望与追求。当然，这也符合马斯洛需求层级。</p>
<p>这些精深层面的渴望与追求，可能包含焦虑、孤独、怀旧以及对联结的渴望。随着城市化的发展，个体的独立，亲情的淡漠，经济的波动，以及服务业对日常生活的极致满足，更凸显出人在快节奏的社会生活中被压抑的情感，以及寻求认同与情绪价值的满足。</p>
<p>在提供情绪价值这方面能够胜出的产品，不一定是技术多领先的产品，也不一定是功能多强大的产品，而是具有“最懂人心，最能够提供情绪价值”的产品。</p>
<p>放眼目前的技术领域，AI的出现几乎能够完美的解决这类问题。AI技术能够做到更懂你，也能够做到更好的切合你的心理去表达，也能够与你拥有更多的“共同记忆”，而且还能够做到随时随地的陪伴着你。当然，要实现这一功能的产品，还需要懂得用户心理的产品设计者。</p>
<p>就大模型本身而言，大多数还是停留在中规中矩的表达中。不过，最近在与ChatGPT 4.1交互中，发现ChatGPT模型本身已经具备了一些基础的、通用的情绪价值提供。</p>
<p>比如它的回答偶尔会出现：“你提了一个很棒的问题！”、“你的理解很接近实际定义！”等带有情绪化（积极、鼓励性的）的表达。这些表达虽然很泛化的、很表面化，但也算是提供了“认可和鼓励”这类基本的情绪表达。个人感觉，未来基础模型，很可能会更多的满足用户的这一基本需求。</p>
<p>如果是基于大模型构建的Agent工程，想实现提供满满的情绪价值就更容易了，只需要在Prompt工程中定义好角色，描述好倾向性就能够满足基础的需求，但这还远远不够。</p>
<p>因为这些情绪价值往往只是浮于表面，如果想往更深层走，还是需要针对用户的既往经历、性格特征等数据进行建模，发掘用户个性化的、更深层次的内在需求，再结合Agent工程、RAG技术，长短期记忆相结合等技术手段来实现，才能真正做出触动用户内心，满足用户核心需求的产品。</p>
<p>除了技术层面，还需要从用户心理、产品交互以及产品定位等出发，把握住当代人在高度原子化、数字化的社会生活中最迫切的情感需求。当然，对于不同用户群体，不用产品形态，还需要对应领域专家的专业Know-how来加持。能够促发用户毫不犹豫买单的，往往是溢出的情绪价值。</p>
<p>对于相关从业的产品和技术人员来说，“现有的所有产品，都可以利用AI来重做一遍（个人觉得虽然有些夸张，但是一个不错是视角）”，需要充分利用这波技术红利，把握好职业及技能的发展方向，未来还是可期的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[10分钟复刻爆火「死了么」App：vibe coding 实战（Expo+Supabase+MCP）]]></title>    <link>https://juejin.cn/post/7594791357144940586</link>    <guid>https://juejin.cn/post/7594791357144940586</guid>    <pubDate>2026-01-14T18:38:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594791357144940586" data-draft-id="7595029084284256310" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="10分钟复刻爆火「死了么」App：vibe coding 实战（Expo+Supabase+MCP）"/> <meta itemprop="keywords" content="VibeCoding,React Native,AI编程"/> <meta itemprop="datePublished" content="2026-01-14T18:38:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mCell"/> <meta itemprop="url" content="https://juejin.cn/user/2280829967146779"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            10分钟复刻爆火「死了么」App：vibe coding 实战（Expo+Supabase+MCP）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2280829967146779/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mCell
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T18:38:14.000Z" title="Wed Jan 14 2026 18:38:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>视频链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1yEr4BJE8B%2F" target="_blank" title="https://www.bilibili.com/video/BV1yEr4BJE8B/" ref="nofollow noopener noreferrer">10分钟复刻爆火「死了么」App：vibe coding 实战</a></p>
<p>仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fminorcell%2Fsileme-clone" target="_blank" title="https://github.com/minorcell/sileme-clone" ref="nofollow noopener noreferrer">github.com/minorcell/s…</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b092795a9c6f46caa0b6dcaf8e8ca9ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbUNlbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769020693&amp;x-signature=GAy6ygo99Walq4qbBoBGYZKq8AI%3D" alt="202602" loading="lazy"/></p>
<p>最近“死了么”App 突然爆火：内容极简——<strong>签到</strong> + <strong>把紧急联系人邮箱填进去</strong>。
它的产品形态很轻，但闭环很完整：
你每天打卡即可；如果你连续两天没打，系统就给紧急联系人发邮件。</p>
<p>恰好我最近在做 Supabase 相关调研，就顺手把它当成一次“极限验证”：</p>
<ul>
<li>我想看看：<strong>Expo + Supabase</strong> 能不能把后端彻底“抹掉”</li>
<li>我也想看看：<strong>Codex + MCP</strong> 能不能把“建表 / 配置 / 写代码”这整套流程进一步压缩</li>
<li>以及：vibe coding 到底能不能真的做到：<strong>跑起来、能用、闭环通</strong></li>
</ul>
<p>结论是：能。并且我录了全过程，<strong>从建仓库到 App 跑起来能用，全程 10 分钟</strong>。</p>
<h2 data-id="heading-0">我复刻的目标：只保留“核心闭环”</h2>
<p>我没打算做一个完整产品，只做最小闭环：</p>
<ol>
<li><strong>用户注册 / 登录</strong>（邮箱 + 密码 + 邮箱验证码）</li>
<li><strong>首页打卡</strong>：每天只能打一次，展示“连续打卡 xx 天”</li>
<li><strong>我的</strong>：查看打卡记录 / 连续天数</li>
<li><strong>紧急联系人</strong>：设置一个邮箱</li>
<li><strong>连续两天没打卡就发邮件</strong>（定时任务 + 邮件发送）</li>
</ol>
<p>页面风格：简约、有活力（但不追求 UI 细节）。</p>
<h2 data-id="heading-1">技术栈：把“后端”交给 Supabase，把“体力活”交给 Agent</h2>
<ul>
<li><strong>前端</strong>：React Native + Expo（TypeScript）</li>
<li><strong>后端</strong>：Supabase（Auth + Postgres + RLS）</li>
<li><strong>自动化</strong>：Supabase Cron + Edge Functions
Supabase 的定时任务本质是 <code>pg_cron</code>，可以跑 SQL / 调函数 / 发 HTTP 请求（包括调用 Edge Function）。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fsupabase.com%2Fdocs%2Fguides%2Fcron%3Futm_source%3Dchatgpt.com" title="https://supabase.com/docs/guides/cron?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">Supabase</a>)</li>
<li><strong>Agent</strong>：Codex（通过 <strong>Supabase MCP</strong> 直接连 Supabase）
Supabase 官方有 MCP 指南，并且强调了安全最佳实践（比如 scope、权限、避免误操作）。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fsupabase.com%2Fdocs%2Fguides%2Fgetting-started%2Fmcp%3Futm_source%3Dchatgpt.com" title="https://supabase.com/docs/guides/getting-started/mcp?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">Supabase</a>)</li>
</ul>
<p>我整个过程的体验是：</p>
<blockquote>
<p>以前你要在“前端 / SQL / 控制台 / 文档”之间来回切。
现在你只需要把需求写清楚，然后盯着它干活，偶尔接管一下关键配置。</p>
</blockquote>
<h2 data-id="heading-2">两天没打卡发邮件：用 Cron + Edge Function，把事情做完</h2>
<p>这是这个 App 最关键的“闭环”。</p>
<h3 data-id="heading-3">方案：每天跑一次定时任务</h3>
<ul>
<li><strong>Cron</strong>：每天固定时间跑（比如 UTC 00:10）</li>
<li><strong>任务内容</strong>：找出“已经两天没打卡”的用户</li>
<li><strong>动作</strong>：调用 Edge Function 发邮件</li>
</ul>
<p>Supabase 官方文档推荐的组合是：<code>pg_cron</code> + <code>pg_net</code>，定时调用 Edge Functions。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fsupabase.com%2Fdocs%2Fguides%2Ffunctions%2Fschedule-functions%3Futm_source%3Dchatgpt.com" title="https://supabase.com/docs/guides/functions/schedule-functions?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">Supabase</a>)</p>
<blockquote>
<p>你也可以不调用 Edge Function，直接让 Cron 发 HTTP webhook 给你自己的服务。
但既然目标是“不写后端”，那就让 Edge Function 处理就行。</p>
</blockquote>
<h3 data-id="heading-4">Edge Function：负责“发邮件”</h3>
<p>注意：Supabase Auth 的邮件（验证码）是它自己的系统邮件；
你要给紧急联系人发提醒，通常需要接第三方邮件服务（Resend / SendGrid / Mailgun / SES 之类）。</p>
<p>Supabase 文档里也提到：定时调用函数时，敏感 token 建议放到 <strong>Supabase Vault</strong> 里。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fsupabase.com%2Fdocs%2Fguides%2Ffunctions%2Fschedule-functions%3Futm_source%3Dchatgpt.com" title="https://supabase.com/docs/guides/functions/schedule-functions?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">Supabase</a>)</p>
<p>Edge Function（伪代码示意）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 1) 查数据库：哪些人超过 2 天没打卡</span>
<span class="hljs-comment">// 2) 取紧急联系人邮箱</span>
<span class="hljs-comment">// 3) 调用邮件服务 API 发送提醒</span>
</code></pre>
<p>Cron 每天跑一次就够了：
这个产品的语义不是“立刻报警”，而是“连续两天都没动静”。</p>
<h2 data-id="heading-5">MCP + Codex：我觉得最爽的地方</h2>
<p>如果你只看结果，你会觉得“这不就是一个 CRUD App 吗”。</p>
<p>但我觉得真正有意思的是过程：</p>
<ul>
<li>它不仅写前端代码</li>
<li>它还能“像个人一样”去把 Supabase 后台的事情做掉：建表、加约束、开 RLS、写策略、甚至提示你哪里要手动补配置</li>
</ul>
<p>而 Supabase MCP 的官方定位，就是让模型通过标准化工具安全地操作你的 Supabase 项目（并且强调先读安全最佳实践）。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fsupabase.com%2Fdocs%2Fguides%2Fgetting-started%2Fmcp%3Futm_source%3Dchatgpt.com" title="https://supabase.com/docs/guides/getting-started/mcp?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">Supabase</a>)</p>
<p>我这次几乎没写代码，最大的精力消耗其实是两件事：</p>
<ol>
<li><strong>把提示词写清楚</strong>（尤其是“规则”和“边界条件”）</li>
<li><strong>对关键点做人工复核</strong>（RLS、唯一约束、邮件配置）</li>
</ol>
<h2 data-id="heading-6">我现在会怎么写提示词</h2>
<p>我发现 vibe coding 成功率最高的提示词，不insane，反而“啰嗦”：</p>
<ul>
<li>先写“模块和流程”</li>
<li>再写“数据约束”（每天只能一次、断档怎么处理）</li>
<li>再写“安全策略”（RLS 怎么开）</li>
<li>最后写“验收标准”（做到什么算跑通）</li>
</ul>
<p>你给得越具体，它越像一个靠谱同事；
你给得越模糊，它越容易“自作主张”。</p>
<h2 data-id="heading-7">附录</h2>
<h3 data-id="heading-8">我这次用的提示词（原文）</h3>
<pre><code class="hljs language-markdown" lang="markdown">需求：使用expo和supabase开发一个移动端APP： 死了么

<span class="hljs-section">## 功能：</span>

<span class="hljs-section">### 用户注册：</span>

<span class="hljs-bullet">1.</span> 描述：在app进入页面，用户需要输入邮箱和密码以及确认密码，进行注册。
<span class="hljs-bullet">2.</span> 流程：
<span class="hljs-bullet">   -</span> 使用supabase的auth进行校验，发送验证码注册邮箱到用户邮箱，用户需要在页面输入邮箱中的验证码。
<span class="hljs-bullet">   -</span> 注册成功之后即可进入app首页

<span class="hljs-section">### 首页打卡：</span>

<span class="hljs-bullet">1.</span> 描述：用户进入首页，只有一个大大的打卡功能；“今日活着”，点击即可完成打卡功能
<span class="hljs-bullet">2.</span> 流程：
<span class="hljs-bullet">   -</span> supabase需要记录用户的打卡信息
<span class="hljs-bullet">   -</span> 打开成功时，提示用户已经“你已连续打卡xx日，又活了一天”

<span class="hljs-section">### “我的”</span>

<span class="hljs-bullet">1.</span> 用户可以在“我的”页面查看自己的打卡记录，连续打卡时间
<span class="hljs-bullet">2.</span> 用户可以设置紧急联系人，当检测到用户连续两天没有打卡时，会发送一封紧急联系的邮件到紧急联系人邮箱

<span class="hljs-section">## 其他：</span>

<span class="hljs-bullet">1.</span> 用户每天只能打卡一次
<span class="hljs-bullet">2.</span> 页面简约、有活力

<span class="hljs-quote">&gt; 你可以使用supabase的mcp进行所有的操作，</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个致力于为 C# 程序员提供更佳的编码体验和效率的 Visual Studio 扩展插件]]></title>    <link>https://juejin.cn/post/7595029084284190774</link>    <guid>https://juejin.cn/post/7595029084284190774</guid>    <pubDate>2026-01-14T16:50:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595029084284190774" data-draft-id="7595033052796354601" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个致力于为 C# 程序员提供更佳的编码体验和效率的 Visual Studio 扩展插件"/> <meta itemprop="keywords" content="后端,C#,Visual Studio"/> <meta itemprop="datePublished" content="2026-01-14T16:50:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个致力于为 C# 程序员提供更佳的编码体验和效率的 Visual Studio 扩展插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T16:50:16.000Z" title="Wed Jan 14 2026 16:50:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>今天大姚给大家分享一个致力于为 C# 程序员提供更佳的编码体验和效率的 Visual Studio 扩展插件：<strong>Codist</strong>。</p>
<h2 data-id="heading-1">Codist 插件介绍</h2>
<p>Codist 是一个使用 .NET 编写、开源免费的 Visual Studio 扩展插件，致力于为 C# 程序员提供更好的编程体验和生产效率。它不仅强化了语法高亮、快速信息提示、导航栏、滚动条和显示质量，还集成了自动版本号更新、括号自动补全、支持高级编辑功能的智能工具栏、代码分析等功能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bca1996341f4afdb76d6ba010fd7c3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769014216&amp;x-signature=CmGnlw6%2FkJ9xJe9ZfE5xF5%2BDOFw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">支持 Visual Studio 版本</h2>
<ul>
<li>Visual Studio 2026 (amd64)、2022 (amd64)、2019、2017</li>
</ul>
<h2 data-id="heading-3">插件安装</h2>
<h3 data-id="heading-4">插件市场下载安装</h3>
<ul>
<li>插件市场地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dwmj.Codist" target="_blank" title="https://marketplace.visualstudio.com/items?itemName=wmj.Codist" ref="nofollow noopener noreferrer">marketplace.visualstudio.com/items?itemN…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9648f1e92324b0687e3fca91515041a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769014216&amp;x-signature=10n4OuVft2KeXJFgXMFczDe8wqU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">Visual Studio 管理拓展器安装</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4fb3e1a77904928b4d7bb185e3877e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769014216&amp;x-signature=jkVLUOwbsg8n7IsEwIwmR4rmays%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1092bde6434846898b1fefd92c1b94c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769014216&amp;x-signature=bcphbwVNGk5VztEEuiFIZnYhQmI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">插件功能</h2>
<h3 data-id="heading-7">高级语法高亮</h3>
<p>高级语法高亮（支持任意语言），以及注释标记器可高亮显示类 TODO 风格的注释。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98a0d4615d3344fba9468c7115df1577~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769014216&amp;x-signature=BKQnifbWSFcYIna9nWb06EFZBC0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">超强快速信息提示</h3>
<p>超强快速信息提示，支持扩展的 XML 文档、符号工具提示、可选中内容、外观自定义等功能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77602fba2aaa40c389821b001875949a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769014216&amp;x-signature=mm1LVP22WvWwGYoTp%2Bwh%2B1skTg0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">带拖放功能和可筛选成员列表的导航栏</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd46ecb4a5824a6a907f08a223ec593a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769014216&amp;x-signature=WnGmPqJt2PQ12hgmDr9N8ZPK66g%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">智能工具栏</h3>
<p>智能工具栏，集成常用编辑命令、C# 代码重构功能及符号引用分析器。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b15f0527a6084cc5942149f2423d6b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769014216&amp;x-signature=k9yIuDJTLgF5oegbujQG9kbuasM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">滚动条标记功能</h3>
<p>滚动条标记绘制强大的迷你代码地图。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47c2336e7eb049acb28c8fbd38decb6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769014216&amp;x-signature=xTlmVp4gXRP%2BfEmjKLhAdcvA5U0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">插件源代码</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f088f07804f4384aab02c92c740ef1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769014216&amp;x-signature=wn4ixGmJIqWjngDcMbmnE6Ld38E%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">项目源码地址</h2>
<p>更多项目实用功能和特性欢迎前往项目开源地址查看👀，别忘了给项目一个Star支持💖。</p>
<ul>
<li><strong>GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwmjordan%2FCodist" target="_blank" title="https://github.com/wmjordan/Codist" ref="nofollow noopener noreferrer">github.com/wmjordan/Co…</a></li>
</ul>
<h2 data-id="heading-14">优秀项目和框架精选</h2>
<p>该项目已收录到C#/.NET/.NET Core优秀项目和框架精选中，关注优秀项目和框架精选能让你及时了解C#、.NET和.NET Core领域的最新动态和最佳实践，提高开发工作效率和质量。坑已挖，欢迎大家踊跃提交PR推荐或自荐（<strong>让优秀的项目和框架不被埋没🤞</strong>）。</p>
<ul>
<li><strong>GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
<li><strong>Gitee开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fysgdaydayup%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">gitee.com/ysgdaydayup…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 ThreadLocal + Deque 打造一个“线程专属的调用栈” —— Spring Insight 的上下文管理术]]></title>    <link>https://juejin.cn/post/7595067620949934106</link>    <guid>https://juejin.cn/post/7595067620949934106</guid>    <pubDate>2026-01-14T15:16:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595067620949934106" data-draft-id="7595030559565070387" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 ThreadLocal + Deque 打造一个“线程专属的调用栈” —— Spring Insight 的上下文管理术"/> <meta itemprop="keywords" content="后端,Java,架构"/> <meta itemprop="datePublished" content="2026-01-14T15:16:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏渡苇"/> <meta itemprop="url" content="https://juejin.cn/user/729731453429159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 ThreadLocal + Deque 打造一个“线程专属的调用栈” —— Spring Insight 的上下文管理术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731453429159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏渡苇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T15:16:56.000Z" title="Wed Jan 14 2026 15:16:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用 ThreadLocal + Deque 打造一个“线程专属的调用栈” —— Spring Insight 的上下文管理术</h2>
<blockquote>
<p><strong>作者</strong>：苏渡苇</p>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fiweidujiang%2Fspring-insight" target="_blank" title="https://github.com/iweidujiang/spring-insight" ref="nofollow noopener noreferrer">github.com/iweidujiang…</a>（感谢 Star ！）</p>
</blockquote>
<h3 data-id="heading-1">一、引言</h3>
<p>在开发分布式追踪系统（比如 Zipkin、Jaeger，或者我正在做的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fiweidujiang%2Fspring-insight" target="_blank" title="https://github.com/iweidujiang/spring-insight" ref="nofollow noopener noreferrer">Spring Insight</a>）时，有一个核心问题必须解决：</p>
<blockquote>
<p><strong>如何在一个请求的整个生命周期中，准确地记录它经过了哪些方法、服务、数据库？</strong></p>
</blockquote>
<p>而要回答这个问题，关键在于——<strong>追踪上下文（Trace Context）</strong> 的管理。</p>
<p>今天，我们就来聊聊 <strong>Spring Insight</strong> 中一段看似简单、实则精巧的代码（王婆卖瓜了属于是，哈哈）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Deque&lt;TraceSpan&gt;&gt; SPAN_STACK =
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamedThreadLocal</span>&lt;&gt;(<span class="hljs-string">"Spring Insight Trace Context"</span>) {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> Deque&lt;TraceSpan&gt; <span class="hljs-title function_">initialValue</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();
        }
    };
</code></pre>
<p>别小看这短短几行，它背后藏着 Java 并发编程和链路追踪设计的双重智慧。</p>
<p>为了说明我为什么这么写，我们先深入认识一下它的两个“主角”：<code>ThreadLocal</code> 和 <code>Deque</code>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cc6148e5f5d43b5b07bb45c199fc0cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5rih6IuH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769008616&amp;x-signature=S59ipK9C2sqpBa%2FDRorXmqNMTY4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">二、ThreadLocal：每个线程的“私人保险箱”</h3>
<h4 data-id="heading-3">ThreadLocal 是什么？</h4>
<p><code>ThreadLocal</code> 是 Java 提供的一个类，用于<strong>为每个线程维护一份独立的变量副本</strong>。</p>
<p>你可以把它想象成每个线程都有一个“专属抽屉”，彼此互不干扰。</p>
<pre><code class="hljs language-java" lang="java">ThreadLocal&lt;String&gt; threadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
threadLocal.set(<span class="hljs-string">"Hello from Thread-"</span> + Thread.currentThread().getName());
System.out.println(threadLocal.get()); <span class="hljs-comment">// 每个线程看到的值都不同</span>
</code></pre>
<h4 data-id="heading-4">典型使用场景</h4>
<h5 data-id="heading-5">1. <strong>用户会话/安全上下文（Security Context）</strong></h5>
<p>在 <strong>Spring Security</strong> 中，<code>SecurityContextHolder</code> 默认就使用 <code>ThreadLocal</code> 存储当前用户的认证信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Authentication</span> <span class="hljs-variable">auth</span> <span class="hljs-operator">=</span> SecurityContextHolder.getContext().getAuthentication();
<span class="hljs-comment">// 这个 auth 对象是当前线程独有的，不会被其他请求污染</span>
</code></pre>
<p>这样，在 Controller、Service、DAO 层都能随时获取当前用户，而无需层层传递参数。</p>
<h5 data-id="heading-6">2. <strong>事务管理（Transaction Context）</strong></h5>
<p><strong>Spring</strong> 的声明式事务（<code>@Transactional</code>）依赖 <code>ThreadLocal</code> 来绑定当前线程的数据库连接和事务状态。</p>
<p>同一个线程内多次调用 DAO 方法，能复用同一个 Connection，保证事务一致性。</p>
<h5 data-id="heading-7">3. <strong>日志追踪（MDC - Mapped Diagnostic Context）</strong></h5>
<p>SLF4J + Logback 中的 <code>MDC</code> 就是基于 <code>ThreadLocal</code> 实现的。</p>
<p>你可以在请求入口处设置 traceId：</p>
<pre><code class="hljs language-java" lang="java">MDC.put(<span class="hljs-string">"traceId"</span>, UUID.randomUUID().toString());
logger.info(<span class="hljs-string">"Processing request..."</span>); <span class="hljs-comment">// 日志自动带上 traceId</span>
</code></pre>
<p>这样，即使高并发下多个请求混在一起打日志，也能通过 traceId 追踪完整链路。</p>
<h5 data-id="heading-8">4. <strong>多租户（Tenant ID）隔离</strong></h5>
<p>SaaS 系统中，常通过 <code>ThreadLocal</code> 在请求开始时解析租户 ID，并在线程内全局可用：</p>
<pre><code class="hljs language-java" lang="java">TenantContext.setTenantId(tenantId);
<span class="hljs-comment">// 后续所有 DB 查询自动加上 tenant_id = ? 条件</span>
</code></pre>
<h4 data-id="heading-9">注意事项</h4>
<ul>
<li><strong>内存泄漏风险</strong>：线程池中的线程长期存活，如果 <code>ThreadLocal</code> 不手动 <code>remove()</code>，其引用的对象无法被 GC。</li>
<li><strong>异步场景失效</strong>：<code>CompletableFuture</code>、<code>@Async</code> 等会切换线程，导致 <code>ThreadLocal</code> 上下文丢失（需用 <code>TransmittableThreadLocal</code> 解决）。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfc2b45e1c6a416b9553c493bff884f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5rih6IuH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769008616&amp;x-signature=wt8vCwcEiK6KSnUyj3grKubgDlE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">三、Deque：不只是队列，更是高效的“栈”</h3>
<h4 data-id="heading-11">Deque 是什么？</h4>
<p><code>Deque</code>（Double-ended Queue）是 Java 集合框架中的双端队列接口，支持从<strong>头部和尾部</strong>高效插入/删除元素。</p>
<p>虽然名字叫“队列”，但它完全可以当作<strong>栈（Stack）</strong> 或 <strong>普通队列（Queue）</strong> 使用。</p>
<pre><code class="hljs language-java" lang="java">Deque&lt;String&gt; deque = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();
deque.push(<span class="hljs-string">"A"</span>); <span class="hljs-comment">// 栈操作：压入</span>
deque.push(<span class="hljs-string">"B"</span>);
System.out.println(deque.pop()); <span class="hljs-comment">// 输出 "B"（LIFO）</span>
</code></pre>
<h4 data-id="heading-12">✅ 为什么用 Deque 而不是 Stack？</h4>
<p>Java 自带的 <code>Stack</code> 类：</p>
<ul>
<li>继承自 <code>Vector</code>，所有方法都是 <code>synchronized</code>，性能差；</li>
<li>设计老旧，不符合现代集合规范。</li>
</ul>
<p>而 <code>ArrayDeque</code>：</p>
<ul>
<li><strong>非同步</strong>，性能高；</li>
<li><strong>底层是循环数组</strong>，内存连续，缓存友好；</li>
<li>官方文档明确推荐：“<strong>This class is likely to be faster than Stack when used as a stack</strong>”。</li>
</ul>
<h4 data-id="heading-13">典型使用场景</h4>
<h5 data-id="heading-14">1. <strong>方法调用栈模拟</strong></h5>
<p>编译器、解释器常用栈来管理函数调用。每进入一个函数，压入栈帧；返回时弹出。</p>
<h5 data-id="heading-15">2. <strong>括号匹配、表达式求值</strong></h5>
<p>算法题经典场景：用栈判断 <code>({[]})</code> 是否合法，或计算 <code>3 + (2 * 5)</code>。</p>
<h5 data-id="heading-16">3. <strong>撤销（Undo）操作</strong></h5>
<p>图形编辑器、文本编辑器的“撤销”功能，本质就是把操作记录压入栈，撤销时弹出并反向执行。</p>
<h5 data-id="heading-17">4. <strong>深度优先搜索（DFS）</strong></h5>
<p>递归容易栈溢出？可以用显式栈（<code>Deque</code>）实现非递归 DFS。</p>
<h5 data-id="heading-18">5. <strong>链路追踪中的 Span 嵌套</strong></h5>
<p>这正是 Spring Insight 的用法！每个方法调用对应一个 <code>TraceSpan</code>，用栈来维护父子关系：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">push</span>(rootSpan)
  → <span class="hljs-built_in">push</span>(serviceSpan)
    → <span class="hljs-built_in">push</span>(repoSpan)
    ← <span class="hljs-built_in">pop</span>(repoSpan)
  ← <span class="hljs-built_in">pop</span>(serviceSpan)
← <span class="hljs-built_in">pop</span>(rootSpan)
</code></pre>
<h3 data-id="heading-19">四、组合技：ThreadLocal + Deque = 线程专属调用栈</h3>
<p>现在，把两者结合起来：</p>
<pre><code class="hljs language-java" lang="java">ThreadLocal&lt;Deque&lt;TraceSpan&gt;&gt; SPAN_STACK
</code></pre>
<p>这句话的意思是：</p>
<blockquote>
<p><strong>每个线程都拥有一个独立的 Span 栈，用来记录当前请求的调用链路。</strong></p>
</blockquote>
<h4 data-id="heading-20">这解决了什么问题？</h4>
<p>假设一个 HTTP 请求进来，执行流程如下：</p>
<pre><code class="hljs">Controller → Service → Repository → DB
</code></pre>
<p>我们希望为每一步生成一个 <code>TraceSpan</code>，并形成父子关系：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2202897a1145443283c25817f830068e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5rih6IuH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769008616&amp;x-signature=mrH7Anxqb2zmCZ13MmtUaY%2FNs5k%3D" alt="" loading="lazy"/></p>
<p>而 <code>SPAN_STACK</code> 正是实现这种嵌套结构的关键：</p>
<ol>
<li><strong>进入 Controller</strong>：创建根 Span，<code>push</code> 到栈；</li>
<li><strong>进入 Service</strong>：以栈顶 Span 为父，创建子 Span，再 <code>push</code>；</li>
<li><strong>退出 Repository</strong>：<code>pop()</code> 出当前 Span，结束计时，上报；</li>
<li><strong>最终回到 Controller</strong>：<code>pop()</code> 根 Span，完成整条链路。</li>
</ol>
<blockquote>
<p>💡 <strong>关键点</strong>：因为栈是 <code>ThreadLocal</code> 的，所以即使有 1000 个并发请求，每个线程的调用栈也完全独立，不会串错！</p>
</blockquote>
<h4 data-id="heading-21">示意图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4624903a5adc4f5cb9e508224fab6949~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5rih6IuH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769008616&amp;x-signature=7KHRP%2BR%2Fov4Ih%2FJdHJ%2BqvDEgxYE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-22">五、在 Spring Insight 中的实际应用（思路预览）</h3>
<p>虽然 Spring Insight 项目还在开发中，但这段代码已经奠定了<strong>上下文管理的核心骨架</strong>：</p>
<ul>
<li><code>TraceContext.startSpan("operation")</code>：内部调用 <code>SPAN_STACK.get().push(newSpan)</code></li>
<li><code>TraceContext.endSpan()</code>：<code>pop()</code> 并结束计时</li>
<li><code>TraceContext.currentSpan()</code>：<code>peek()</code> 获取当前 Span，用于传递 traceId/spanId</li>
<li>请求结束时调用 <code>TraceContext.clear()</code>：防止线程池复用导致上下文污染</li>
</ul>
<blockquote>
<p>✅ <strong>这种设计天然支持异步吗？</strong><br/>
暂时不支持！但未来可通过 <code>TransmittableThreadLocal</code>（阿里开源）扩展，实现跨线程上下文传递。</p>
</blockquote>
<h3 data-id="heading-23">六、总结：小结构，大作用</h3>

























<table><thead><tr><th>组件</th><th>作用</th><th>真实世界类比</th></tr></thead><tbody><tr><td><code>ThreadLocal</code></td><td>线程隔离的上下文存储</td><td>每个服务员有自己的点菜单</td></tr><tr><td><code>Deque</code>（作栈用）</td><td>管理嵌套调用的生命周期</td><td>函数调用的“回溯路径”</td></tr><tr><td><code>SPAN_STACK</code></td><td>二者结合，构建线程安全的追踪栈</td><td>每个请求的“行车记录仪”</td></tr></tbody></table>
<p>这就像给每个线程配了一个“行车记录仪”，全程记录它干了啥、花了多久、有没有出错。</p>
<p>而这一切，都始于那几行看似平淡的初始化代码。</p>
<h3 data-id="heading-24">🌟 最后：欢迎关注 Spring Insight！</h3>
<p>如果你对链路追踪、APM、Java Agent 感兴趣，欢迎关注我的开源项目：</p>
<blockquote>
<p>🔗 <strong>GitHub 地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fiweidujiang%2Fspring-insight" target="_blank" title="https://github.com/iweidujiang/spring-insight" ref="nofollow noopener noreferrer">github.com/iweidujiang…</a></p>
</blockquote>
<p>目前项目包含：</p>
<ul>
<li>Agent 模块：自动埋点、Span 采集</li>
<li>Collector 模块：接收并存储链路数据</li>
<li>Storage 模块：基于 MyBatis-Plus 的持久化</li>
<li>后续将加入 Web UI、拓扑图、告警等能力！</li>
</ul>
<p><strong>你的 Star 是对我最大的鼓励！</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b8abe2c420a4bc1b7d73cfa5f0de8bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5rih6IuH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769008616&amp;x-signature=%2BbzergimyariRdR5h5w5v582FZ4%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nano Banana进行AI绘画中文总是糊？一招可重新渲染，清晰到可直接汇报]]></title>    <link>https://juejin.cn/post/7595088396440256562</link>    <guid>https://juejin.cn/post/7595088396440256562</guid>    <pubDate>2026-01-14T14:09:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595088396440256562" data-draft-id="7595088396440240178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nano Banana进行AI绘画中文总是糊？一招可重新渲染，清晰到可直接汇报"/> <meta itemprop="keywords" content="人工智能,AIGC"/> <meta itemprop="datePublished" content="2026-01-14T14:09:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mantch"/> <meta itemprop="url" content="https://juejin.cn/user/2788017218532232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nano Banana进行AI绘画中文总是糊？一招可重新渲染，清晰到可直接汇报
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017218532232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mantch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T14:09:16.000Z" title="Wed Jan 14 2026 14:09:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>平时用 <code>Nano Banana</code> 生成架构图、海报、流程图时，你可能也遇到过这种“又爱又恨”的情况：
图片整体效果很好、构图很强、理解也到位，但<strong>一到中文就翻车</strong>——要么字糊成一团，要么笔画缺失、错位，甚至出现“像中文但不是中文”的诡异字符。用来内部讨论还行，一旦要发群、做汇报、写方案，就很难直接用。</p>
<p>就像这样🙃🙃：</p>
<div>
<div>
<div class="cxd-Flex" data-role="container">
  <span class="cxd-TplField fr-view">
    <span>
        <img class="image-container" src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f11571c01720443aa58d12d49cd73996~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWFudGNo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769004555&amp;x-signature=FHfOgIUuAaLnNi7a5OoeVOAnnWY%3D" alt="" loading="lazy"/>
    </span>
  </span>
</div>
</div>
<br/><br/>
</div>
<p>于是呢就想着国内的视觉模型也很强，并且对中文非常友好，何不结合起来试试？果然成功了！😎</p>
<p>这篇文章分享一个非常实用、成功率很高的工作流：
用 <strong>Nano Banana 负责生成图（构图/布局/理解）</strong> ，再用 <strong>字节跳动 Seedream 4.5 负责把中文文字重新渲染清晰</strong>。两者配合，就是典型的“中西合璧”。</p>
<hr/>
<h2 data-id="heading-0">1. 为什么 Nano Banana 生成的中文经常不清晰？</h2>
<p>核心原因通常不是你提示词写得不够细，而是模型训练导致的能力偏差：</p>
<ul>
<li>
<p>Nano Banana 的训练数据中 <strong>英文/拉丁字符占比更大</strong></p>
</li>
<li>
<p>中文字体的<strong>笔画密度高、结构复杂</strong>，尤其在小字号、细线条、图形叠加背景的情况下，对模型的像素级渲染要求更高</p>
</li>
<li>
<p>结果就是：布局很对，中文却容易出现</p>
<ul>
<li>笔画粘连、断裂</li>
<li>偏旁部首错位</li>
<li>字体“像手写但不清晰”</li>
<li>甚至生成“伪中文”</li>
</ul>
</li>
</ul>
<p>所以，与其反复改提示词“让中文更清晰”，不如承认模型强项：
<strong>nano banana 负责“图”，Seedream 负责“字”。</strong></p>
<hr/>
<h2 data-id="heading-1">2. 解决思路：Nano Banana + Seedream 4.5 的两段式工作流</h2>
<p>这个方案的关键点是“分工”：</p>
<blockquote>
<ul>
<li><strong>第一步（Nano Banana）</strong> ：生成你想要的架构图/海报版式/内容结构
优先追求：布局清晰、模块合理、图形美观、风格正确</li>
<li><strong>第二步（Seedream 4.5）</strong> ：保持图形不变，仅对文字做“重绘/重排/重新渲染”
优先追求：中文字体清晰、笔画正确、对齐不乱、风格一致</li>
</ul>
</blockquote>
<p>最终效果通常是：
<strong>画面依旧是 Nano Banana 的高级感，但中文达到了可交付水平。</strong></p>
<hr/>
<h2 data-id="heading-2">3. 实战：先用 Nano Banana 生成架构图（中文会糊）</h2>
<p>先用 Nano Banana Pro，输入如下提示词生成“简洁架构图”：</p>
<pre><code class="hljs language-markdown" lang="markdown">算法体系建设的总体架构描述如下：
'''
一、 核心目标与总体思路

核心目标： 构建一个覆盖数据、特征、模型、部署、运维全生命周期的标准化算法生产体系，实现车联网数据驱动下的模型“工业化”生产与“规模化”价值输出。

总体思路： 以MLOps理念为框架，以车辆网联数据为基石，以具体业务场景（如状态感知、意图识别）为牵引，通过流程规范化、工具平台化、协作标准化，打通从数据到价值的端到端链路，确保算法项目可管理、可重复、可追溯、可迭代。本规划将重点阐述以算力平台为承载的算法工程体系核心模块、内部流程及其与业务域的映射关系。
'''

请根据以上描述使用 nano banana pro 画一副简洁架构图。

生成的简洁架构图要求如下：

<span class="hljs-bullet">-</span> 不需要Mermaid图，需要生成一张简洁的架构图片，让领导一看就明白。
<span class="hljs-bullet">-</span> 图片当中的语言文字使用中文。
<span class="hljs-bullet">-</span> 不要出现 nano banana pro 的logo。
</code></pre>
<p>这一步通常能得到：</p>
<ul>
<li>架构分层合理</li>
<li>模块之间关系明确</li>
<li>图形语言统一
但你会发现：<strong>图上的中文文字扭曲、不清晰</strong>，甚至有错字/缺笔画。</li>
</ul>
<div>
<div>
<div class="cxd-Flex" data-role="container">
  <span class="cxd-TplField fr-view">
    <span>
        <img class="image-container" src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/063c1eb002214f6cbdd35399751f6a0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWFudGNo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769004555&amp;x-signature=S2Nznqzjjx73A2nUCp8yNeCQZGk%3D" alt="" loading="lazy"/>
    </span>
  </span>
</div>
</div>
<br/><br/>
</div>
<p>别急，这正是我们要进入下一步的时机。</p>
<hr/>
<h2 data-id="heading-3">4. 部署 Personal LLM API，并配置 Seedream 4.5</h2>
<p>接下来我们用 <code>Personal LLM API</code> 项目来接入 <code>Seedream 4.5</code>。<code>Personal LLM API</code>经对 Seedream 做了适配，包括自动读取输入图片的宽高比、分辨率等信息，减少手动配置成本。</p>
<ol>
<li>部署 Personal LLM API，详细介绍：<a href="https://link.juejin.cn?target=http%3A%2F%2Fera.dx3906.info%2F%23%2Fblog-detail%3Fblog_id%3D79305249130964" target="_blank" rel="noopener" title="http://era.dx3906.info/#/blog-detail?blog_id=79305249130964" ref="nofollow noopener noreferrer">个人 LLM 接口服务开源项目：一个简洁的 AI 入口</a></li>
<li>在模型配置中添加/启用 <strong>Seedream4.5 视觉模型</strong></li>
</ol>
<div>
<div>
<div class="cxd-Flex" data-role="container">
  <span class="cxd-TplField fr-view">
    <span>
        <img class="image-container" src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82ea4cee0e5b4a47ad029b5435fd21b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWFudGNo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769004555&amp;x-signature=EAUnUGAAiT%2FDzQmkh%2Fau2LnqjDI%3D" alt="" loading="lazy"/>
    </span>
  </span>
</div>
</div>
<br/><br/>
</div>
<hr/>
<h2 data-id="heading-4">5. 用 Cherry Studio 配置已部署的 LLM 接口</h2>
<p>然后用 <code>Cherry Studio</code> 作为本地客户端，配置你刚部署好的接口：</p>
<ul>
<li>新增自定义模型服务</li>
<li>填写 base_url / api_key（按你项目实际配置）</li>
<li>在模型列表中添加  <code>Seedream 4.5</code> 模型。</li>
</ul>
<div>
<div>
<div class="cxd-Flex" data-role="container">
  <span class="cxd-TplField fr-view">
    <span>
        <img class="image-container" src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aa706dc1ca24d04ba768f076e7d2290~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWFudGNo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769004555&amp;x-signature=PGjMkInWUNbqe2mTLj4W8G43DJg%3D" alt="" loading="lazy"/>
    </span>
  </span>
</div>
</div>
<br/><br/>
</div>
<p>这样你就拥有了一个非常顺手的“图片文字重渲染工作台”：</p>
<blockquote>
<p>把图拖进去 + 一句话提示词 → 等几十秒 → 出清晰版本。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">6. 关键一步：用 Seedream 4.5 对“中文文字重新渲染”</h2>
<p>现在把 <code>Nano Banana</code> 生成的那张中文糊掉的架构图上传给 Seedream 4.5，<code>Cherry Studio</code>选择模型，并使用以下提示词：</p>
<blockquote>
<p>请把图片上的文字重新渲染，样式颜色要一致，文字也要一致，其他的不需要改动。生成的图片要4k分辨率，宽高比是智能适应原图的宽高比。</p>
</blockquote>
<p>这句提示词的“有效点”在于：</p>
<ul>
<li><strong>只改文字</strong>：避免模型重绘导致版式跑掉</li>
<li><strong>样式颜色一致</strong>：保持原图观感统一</li>
<li><strong>文字也要一致</strong>：强调不要改字、不总结、不替换</li>
<li><strong>4K + 自适应比例</strong>：直接拿去汇报/插文档，清晰度足够。<strong>已尝试过 2k 分辨率，不能够达到文字重新渲染的精度。</strong></li>
</ul>
<p>由于 <code>Personal LLM API</code> 做了适配，这一步通常不需要你再手动写“原图尺寸是多少”，它会自动处理宽高比和分辨率策略。</p>
<p>等待几十秒后，你会得到一张“几乎一模一样，但中文清晰了”的新图。<strong>如果稍微有点瑕疵可重复生成1到2次即可。</strong></p>
<hr/>
<h2 data-id="heading-6">7. 效果对比：字清晰、无错位、图形保持不变</h2>
<p>对比 <code>Nano Banana</code> 的原图 vs <code>Seedream</code> 重渲染后的图，常见提升非常明显：</p>
<ul>
<li>中文笔画完整，不再粘连</li>
<li>字体边缘锐利，不再糊成块</li>
<li>对齐更稳定，错位显著减少</li>
<li>背景、连线、色块、布局基本保持</li>
</ul>
<p>也就是说：
<strong>Nano Banana 给你“高级的架构图”，Seedream4.5 给你“能交付的中文”。</strong> 以下是对比图：</p>
<div>
<div>
<div class="cxd-Flex" data-role="container">
  <span class="cxd-TplField fr-view">
    <span>
        <img class="image-container" src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe143c6c766047849028b6e33c2ec4f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWFudGNo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769004555&amp;x-signature=H5Wjm76anb0AvmpEXJTkItAeX%2BA%3D" alt="" loading="lazy"/>
    </span>
  </span>
</div>
</div>
<br/><br/>
</div>
<div>
<div>
<div class="cxd-Flex" data-role="container">
  <span class="cxd-TplField fr-view">
    <span>
        <img class="image-container" src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/133e5d70eb7a453ead1563c51b4c6fec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWFudGNo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769004555&amp;x-signature=sjGSiR%2FOQE6JDmFqsf9sBgB8FqU%3D" alt="" loading="lazy"/>
    </span>
  </span>
</div>
</div>
<br/><br/>
</div>
<hr/>
<h2 data-id="heading-7">8. 这个技巧能用在哪些场景？</h2>
<ul>
<li>架构图 / 流程图 / 时序图（非 Mermaid）</li>
<li>PPT 封面、海报型页面（中文标题清晰）</li>
<li>产品功能结构图、业务闭环图</li>
<li>活动宣传图、课程海报、Banner</li>
<li>任何“图很漂亮，但字不行”的 AI 生成图</li>
</ul>
<p>一句话：
<strong>先生成，再重渲染文字</strong>，是目前中文图片交付的一条高性价比路径。</p>
<p>很多人卡在“生成一张能用的图”这一步，其实并不是模型不行，而是没有采用组合式工作流。</p>
<p>当你掌握了：</p>
<ul>
<li><strong>nano banana：</strong> 负责构图、审美、结构理解</li>
<li><strong>Seedream 4.5：</strong> 负责中文像素级渲染</li>
</ul>
<p>你就能把 AI 出图从“玩具”变成“生产工具”，真正做到可交付、可复用、可规模化。</p>
<hr/>
<p><strong>想知道如何使用 Nano Banana 生成更多高质量图吗？</strong></p>
<p>我也为大家整理了一份  <strong>《高质量Nano Banana生图提示词集合》</strong> ，涵盖了科技风、扁平风、手绘风等多种风格，关注公众号并回复  <strong>“nano banana提示词”</strong>  即可获取！</p>
<p>详见：</p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fera.dx3906.info%2F%23%2Fblog-detail%3Fblog_id%3D79894071326906" target="_blank" rel="noopener" title="http://era.dx3906.info/#/blog-detail?blog_id=79894071326906" ref="nofollow noopener noreferrer">建议收藏 | 玩转 Nano Banana AI，这 11 组提示词让你秒变大神！</a></p>
<hr/>
<p><em>本文涉及的开源项目 Personal LLM API，欢迎 star 共建👏：</em></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FNLP-LOVE%2Fpersonal-llm-api" target="_blank" rel="noopener" title="https://github.com/NLP-LOVE/personal-llm-api" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FNLP-LOVE%2Fpersonal-llm-api" target="_blank" title="https://github.com/NLP-LOVE/personal-llm-api" ref="nofollow noopener noreferrer">github.com/NLP-LOVE/pe…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从C++到C#的转型完全指南]]></title>    <link>https://juejin.cn/post/7595029084283928630</link>    <guid>https://juejin.cn/post/7595029084283928630</guid>    <pubDate>2026-01-14T14:10:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595029084283928630" data-draft-id="7595043440520101894" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从C++到C#的转型完全指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-14T14:10:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从C++到C#的转型完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T14:10:18.000Z" title="Wed Jan 14 2026 14:10:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>小李</strong>：王哥，我从C++转C#已经两周了，感觉代码写得很别扭。很多C++的习惯在C#里好像都不对劲，你能不能给我一些建议？</p>
<p><strong>王哥</strong>：当然可以！我当初转型时也经历过这个阶段。咱们就从几个最重要的方面开始吧。首先，你要完成一个最重要的心态转变——</p>
<h2 data-id="heading-0">心态转变：从“控制一切”到“信任框架”</h2>
<p><strong>王哥</strong>：在C++里，我们习惯了掌控一切：内存、资源、底层实现。但在C#里，你需要学会信任.NET框架和垃圾回收器。</p>
<p><strong>小李</strong>：我确实总是想手动管理一切，看到<code>new</code>就下意识想找<code>delete</code>。</p>
<p><strong>王哥</strong>：这正是第一个要改的习惯！我给你看个例子：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// C++思维（错误）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BadExample</span>
{
    <span class="hljs-keyword">private</span> List&lt;<span class="hljs-built_in">int</span>&gt; data = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt;();
    
    ~BadExample()  <span class="hljs-comment">// 错误！不要写析构函数</span>
    {
        <span class="hljs-comment">// 想手动清理</span>
        data.Clear();
        data = <span class="hljs-literal">null</span>;
    }
}

<span class="hljs-comment">// C#思维（正确）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GoodExample</span>
{
    <span class="hljs-keyword">private</span> List&lt;<span class="hljs-built_in">int</span>&gt; data = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt;();
    
    <span class="hljs-comment">// 如果持有非托管资源才需要IDisposable</span>
    <span class="hljs-keyword">private</span> FileStream file;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Cleanup</span>()</span>
    {
        <span class="hljs-comment">// 不需要手动清理data，GC会处理</span>
        <span class="hljs-comment">// 只需要处理特殊资源</span>
        <span class="hljs-keyword">if</span> (file != <span class="hljs-literal">null</span>)
        {
            file.Dispose();
            file = <span class="hljs-literal">null</span>;
        }
    }
}
</code></pre>
<p><strong>小李</strong>：那我怎么知道什么时候需要手动清理？</p>
<p><strong>王哥</strong>：记住这个<strong>黄金法则</strong>：</p>
<ol>
<li><strong>纯托管对象</strong>（都是C#类）：交给GC</li>
<li><strong>非托管资源</strong>（文件、网络、数据库连接）：实现<code>IDisposable</code></li>
<li><strong>大对象</strong>：考虑对象池</li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 正确的资源管理</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ResourceHandler</span> : <span class="hljs-title">IDisposable</span>
{
    <span class="hljs-keyword">private</span> FileStream _file;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> _disposed = <span class="hljs-literal">false</span>;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Process</span>()</span>
    {
        <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> stream = <span class="hljs-keyword">new</span> FileStream(<span class="hljs-string">"data.txt"</span>, FileMode.Open))
        {
            <span class="hljs-comment">// 自动释放</span>
        }
        
        <span class="hljs-comment">// 或者</span>
        <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> reader = <span class="hljs-keyword">new</span> StreamReader(<span class="hljs-string">"file.txt"</span>);
        <span class="hljs-comment">// 离开作用域自动释放</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span>
    {
        Dispose(<span class="hljs-literal">true</span>);
        GC.SuppressFinalize(<span class="hljs-keyword">this</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> disposing</span>)</span>
    {
        <span class="hljs-keyword">if</span> (!_disposed)
        {
            <span class="hljs-keyword">if</span> (disposing)
            {
                _file?.Dispose();
            }
            _disposed = <span class="hljs-literal">true</span>;
        }
    }
}
</code></pre>
<h2 data-id="heading-1">类型系统：引用类型 vs 值类型</h2>
<p><strong>小李</strong>：我经常搞不清什么时候用<code>class</code>，什么时候用<code>struct</code>。</p>
<p><strong>王哥</strong>：这是一个关键区别！我总结了一个<strong>决策树</strong>给你：</p>
<pre><code class="hljs language-arduino" lang="arduino">需要类型吗？
├── 需要继承或多态吗？
│   ├── 是 → 用<span class="hljs-keyword">class</span>
│   └── 否 → 
│       ├── 对象很小（&lt;<span class="hljs-number">16</span>字节）吗？
│       │   ├── 是 → 考虑<span class="hljs-keyword">struct</span>
│       │   └── 否 → 用<span class="hljs-keyword">class</span>
│       └── 需要值语义（赋值时复制）吗？
│           ├── 是 → 用<span class="hljs-keyword">struct</span>
│           └── 否 → 用<span class="hljs-keyword">class</span>
</code></pre>
<p><strong>小李</strong>：值语义是什么意思？</p>
<p><strong>王哥</strong>：看这个例子就明白了：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// struct - 值语义</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> Point
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> X, Y;
    
    <span class="hljs-comment">// 推荐：让struct不可变</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Point</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> x, <span class="hljs-built_in">int</span> y</span>)</span> =&gt; (X, Y) = (x, y);
}

Point p1 = <span class="hljs-keyword">new</span> Point(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);
Point p2 = p1;  <span class="hljs-comment">// 复制整个结构体</span>
p2.X = <span class="hljs-number">30</span>;      <span class="hljs-comment">// 不影响p1</span>
Console.WriteLine(p1.X); <span class="hljs-comment">// 输出10</span>

<span class="hljs-comment">// class - 引用语义</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Person</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Name;
}

Person person1 = <span class="hljs-keyword">new</span> Person { Name = <span class="hljs-string">"Alice"</span> };
Person person2 = person1;  <span class="hljs-comment">// 只复制引用</span>
person2.Name = <span class="hljs-string">"Bob"</span>;      <span class="hljs-comment">// 修改的是同一个对象</span>
Console.WriteLine(person1.Name); <span class="hljs-comment">// 输出Bob！</span>
</code></pre>
<p><strong>王哥</strong>：还有几个<strong>血的教训</strong>要记住：</p>
<ol>
<li><strong>不要在大struct里放引用类型</strong>（会有意外共享）</li>
<li><strong>避免频繁装箱拆箱</strong></li>
<li><strong>struct适合小型的、逻辑上表示单个值的数据</strong></li>
</ol>
<h2 data-id="heading-2">字符串处理：忘记C++的习惯</h2>
<p><strong>小李</strong>：我经常用<code>==</code>比较字符串，有什么问题吗？</p>
<p><strong>王哥</strong>：在C++里，你可能习惯了用<code>strcmp</code>。在C#里，字符串比较有几个<strong>坑</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> s1 = <span class="hljs-string">"hello"</span>;
<span class="hljs-built_in">string</span> s2 = <span class="hljs-string">"HELLO"</span>;

<span class="hljs-comment">// ❌ 问题1：大小写敏感</span>
<span class="hljs-keyword">if</span> (s1 == s2)  <span class="hljs-comment">// false，但你可能想要true</span>

<span class="hljs-comment">// ✅ 正确做法</span>
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.Equals(s1, s2, StringComparison.OrdinalIgnoreCase))

<span class="hljs-comment">// ❌ 问题2：文化敏感性</span>
<span class="hljs-built_in">string</span> s3 = <span class="hljs-string">"straße"</span>;
<span class="hljs-built_in">string</span> s4 = <span class="hljs-string">"strasse"</span>;
<span class="hljs-keyword">if</span> (s3 == s4)  <span class="hljs-comment">// false（德语文化中相同）</span>

<span class="hljs-comment">// ✅ 明确指定比较规则</span>
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.Equals(s3, s4, StringComparison.InvariantCulture))

<span class="hljs-comment">// ❌ 问题3：字符串不可变</span>
<span class="hljs-built_in">string</span> text = <span class="hljs-string">"hello"</span>;
text.ToUpper();  <span class="hljs-comment">// 返回新字符串，text仍然是"hello"</span>

<span class="hljs-comment">// ✅ 需要重新赋值</span>
text = text.ToUpper();
</code></pre>
<p><strong>王哥</strong>：还有一个重要建议：<strong>多用字符串插值</strong>，少用字符串连接。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ❌ 性能差</span>
<span class="hljs-built_in">string</span> message = <span class="hljs-string">"Hello "</span> + name + <span class="hljs-string">", you are "</span> + age + <span class="hljs-string">" years old"</span>;

<span class="hljs-comment">// ✅ 性能好，可读性好</span>
<span class="hljs-built_in">string</span> message = <span class="hljs-string">$"Hello <span class="hljs-subst">{name}</span>, you are <span class="hljs-subst">{age}</span> years old"</span>;

<span class="hljs-comment">// 大量拼接用StringBuilder</span>
<span class="hljs-keyword">var</span> sb = <span class="hljs-keyword">new</span> StringBuilder();
<span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++)
{
    sb.Append(i).Append(<span class="hljs-string">", "</span>);
}
<span class="hljs-built_in">string</span> result = sb.ToString();
</code></pre>
<h2 data-id="heading-3">集合类的使用：忘记手动数组管理</h2>
<p><strong>小李</strong>：我总想用数组，然后自己管理大小。</p>
<p><strong>王哥</strong>：这是C++后遗症！在C#里，<strong>优先使用泛型集合</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ❌ C++思维</span>
<span class="hljs-built_in">int</span>[] array = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[<span class="hljs-number">10</span>];
<span class="hljs-built_in">int</span> count = <span class="hljs-number">0</span>;
<span class="hljs-comment">// ... 手动管理插入、删除</span>

<span class="hljs-comment">// ✅ C#方式</span>
List&lt;<span class="hljs-built_in">int</span>&gt; list = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt;();
list.Add(<span class="hljs-number">1</span>);
list.Add(<span class="hljs-number">2</span>);
list.Remove(<span class="hljs-number">1</span>);

<span class="hljs-comment">// 字典的使用</span>
Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">int</span>&gt; dict = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">int</span>&gt;();
dict[<span class="hljs-string">"key"</span>] = <span class="hljs-number">10</span>;

<span class="hljs-comment">// 安全访问</span>
<span class="hljs-keyword">if</span> (dict.TryGetValue(<span class="hljs-string">"key"</span>, <span class="hljs-keyword">out</span> <span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span>))
{
    <span class="hljs-comment">// 使用value</span>
}

<span class="hljs-comment">// 集合初始化器（语法糖）</span>
<span class="hljs-keyword">var</span> numbers = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt; { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span> };
<span class="hljs-keyword">var</span> person = <span class="hljs-keyword">new</span> Person { Name = <span class="hljs-string">"John"</span>, Age = <span class="hljs-number">30</span> };
</code></pre>
<p><strong>王哥</strong>：记住这些<strong>集合使用法则</strong>：</p>
<ol>
<li><strong>查询多、修改少</strong> → 用<code>List&lt;T&gt;</code></li>
<li><strong>快速查找</strong> → 用<code>Dictionary&lt;TKey, TValue&gt;</code></li>
<li><strong>需要排序</strong> → 用<code>SortedDictionary</code>或<code>SortedList</code></li>
<li><strong>唯一性要求</strong> → 用<code>HashSet&lt;T&gt;</code></li>
<li><strong>先进先出</strong> → 用<code>Queue&lt;T&gt;</code></li>
<li><strong>后进先出</strong> → 用<code>Stack&lt;T&gt;</code></li>
</ol>
<h2 data-id="heading-4">现代C#特性：拥抱变化</h2>
<p><strong>小李</strong>：我看到很多<code>=&gt;</code>、<code>var</code>、<code>$""</code>，这些需要都学吗？</p>
<p><strong>王哥</strong>：<strong>必须学</strong>！这些都是提高生产力的利器。我给你个<strong>渐进学习路径</strong>：</p>
<h3 data-id="heading-5">阶段1：立即掌握的</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 1. var类型推断</span>
<span class="hljs-keyword">var</span> list = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;();  <span class="hljs-comment">// 编译器知道类型</span>
<span class="hljs-keyword">var</span> count = <span class="hljs-number">10</span>;                  <span class="hljs-comment">// 知道是int</span>

<span class="hljs-comment">// 2. 属性初始化器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Person</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-string">"Unknown"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Age { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}

<span class="hljs-comment">// 3. 字符串插值</span>
Console.WriteLine(<span class="hljs-string">$"Result: <span class="hljs-subst">{Calculate()}</span>"</span>);

<span class="hljs-comment">// 4. 空条件运算符</span>
<span class="hljs-built_in">string</span> name = person?.Name ?? <span class="hljs-string">"Default"</span>;
</code></pre>
<h3 data-id="heading-6">阶段2：尽快学习的</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 1. 模式匹配（C# 7+）</span>
<span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> <span class="hljs-built_in">int</span> i &amp;&amp; i &gt; <span class="hljs-number">0</span>)
{
    <span class="hljs-comment">// 直接使用i</span>
}

<span class="hljs-comment">// 2. switch表达式</span>
<span class="hljs-built_in">string</span> result = <span class="hljs-keyword">value</span> <span class="hljs-keyword">switch</span>
{
    <span class="hljs-number">1</span> =&gt; <span class="hljs-string">"One"</span>,
    <span class="hljs-number">2</span> =&gt; <span class="hljs-string">"Two"</span>,
    _ =&gt; <span class="hljs-string">"Many"</span>
};

<span class="hljs-comment">// 3. 记录类型（C# 9+）</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title">Person</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> FirstName, <span class="hljs-built_in">string</span> LastName</span>)</span>;

<span class="hljs-comment">// 4. with表达式</span>
<span class="hljs-keyword">var</span> newPerson = person <span class="hljs-keyword">with</span> { LastName = <span class="hljs-string">"Smith"</span> };
</code></pre>
<h3 data-id="heading-7">阶段3：深度掌握的</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 1. 可空引用类型（C# 8+）</span>
<span class="hljs-meta">#nullable enable</span>
<span class="hljs-built_in">string</span>? nullableString = <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 明确可空</span>
<span class="hljs-built_in">string</span> nonNullString = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">// 明确非空</span>

<span class="hljs-comment">// 2. 顶级语句（C# 9+）</span>
<span class="hljs-comment">// 不需要写namespace、class、Main方法</span>
Console.WriteLine(<span class="hljs-string">"Hello World!"</span>);

<span class="hljs-comment">// 3. 文件范围的命名空间（C# 10+）</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">MyApp</span>;
<span class="hljs-comment">// 整个文件都在这个命名空间里</span>
</code></pre>
<h2 data-id="heading-8">异步编程：从回调地狱到天堂</h2>
<p><strong>小李</strong>：<code>async/await</code>看起来像黑魔法，不太敢用。</p>
<p><strong>王哥</strong>：这是C#最棒的特性之一！想象一下，你从<strong>原始社会</strong>升级到了<strong>现代社会</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 😰 C++/C#旧方式（回调地狱）</span>
client.GetData(url, result =&gt;
{
    ProcessData(result, processed =&gt;
    {
        SaveData(processed, saved =&gt;
        {
            UpdateUI(saved);
        });
    });
});

<span class="hljs-comment">// 😊 C# async/await方式</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ProcessAsync</span>()</span>
{
    <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">await</span> client.GetDataAsync(url);
    <span class="hljs-keyword">var</span> processed = <span class="hljs-keyword">await</span> ProcessDataAsync(data);
    <span class="hljs-keyword">var</span> saved = <span class="hljs-keyword">await</span> SaveDataAsync(processed);
    UpdateUI(saved);
}
</code></pre>
<p><strong>王哥</strong>：记住这些<strong>async/await黄金法则</strong>：</p>
<ol>
<li><strong>async传染性</strong>：一旦用了async，调用链上通常都需要async</li>
<li><strong>命名规范</strong>：异步方法以<code>Async</code>结尾</li>
<li><strong>避免async void</strong>：除了事件处理器，都用<code>async Task</code></li>
<li><strong>配置等待</strong>：<code>ConfigureAwait(false)</code>避免死锁</li>
<li><strong>不要阻塞</strong>：绝对不要用<code>.Result</code>或<code>.Wait()</code></li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ❌ 错误做法</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">GetData</span>()</span>
{
    <span class="hljs-keyword">return</span> GetDataAsync().Result;  <span class="hljs-comment">// 可能导致死锁！</span>
}

<span class="hljs-comment">// ✅ 正确做法</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">string</span>&gt; <span class="hljs-title">GetDataAsync</span>()</span>
{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> httpClient.GetStringAsync(url);
}

<span class="hljs-comment">// ✅ 在控制台程序可以这样</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
{
    <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">await</span> GetDataAsync();
    Console.WriteLine(data);
}
</code></pre>
<h2 data-id="heading-9">调试和排错：新的思维方式</h2>
<p><strong>小李</strong>：在C#里调试有什么不同？</p>
<p><strong>王哥</strong>：调试体验更好，但要注意一些新问题：</p>
<h3 data-id="heading-10">1. <strong>异常而不是错误码</strong></h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ❌ C++思维</span>
<span class="hljs-built_in">int</span> result = DoOperation();
<span class="hljs-keyword">if</span> (result != SUCCESS)
{
    <span class="hljs-comment">// 处理错误</span>
}

<span class="hljs-comment">// ✅ C#方式</span>
<span class="hljs-keyword">try</span>
{
    <span class="hljs-keyword">await</span> DoOperationAsync();
}
<span class="hljs-keyword">catch</span> (OperationCanceledException ex)
{
    <span class="hljs-comment">// 任务被取消</span>
}
<span class="hljs-keyword">catch</span> (HttpRequestException ex)
{
    <span class="hljs-comment">// 网络错误</span>
}
<span class="hljs-keyword">catch</span> (Exception ex)  <span class="hljs-comment">// 最后兜底</span>
{
    _logger.LogError(ex, <span class="hljs-string">"操作失败"</span>);
    <span class="hljs-keyword">throw</span>;  <span class="hljs-comment">// 重新抛出，保留堆栈</span>
}
</code></pre>
<h3 data-id="heading-11">2. <strong>使用日志而不是printf</strong></h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 结构化日志</span>
_logger.LogInformation(<span class="hljs-string">"用户 {UserId} 执行了操作 {Action}"</span>, 
    userId, actionName);

<span class="hljs-comment">// 带有异常信息的日志</span>
<span class="hljs-keyword">try</span>
{
    <span class="hljs-comment">// ...</span>
}
<span class="hljs-keyword">catch</span> (Exception ex)
{
    _logger.LogError(ex, <span class="hljs-string">"处理用户 {UserId} 时出错"</span>, userId);
}
</code></pre>
<h3 data-id="heading-12">3. <strong>利用Visual Studio的强大功能</strong></h3>
<ul>
<li><strong>条件断点</strong>：右键断点设置条件</li>
<li><strong>数据断点</strong>：监视对象变化</li>
<li><strong>即时窗口</strong>：执行任意代码</li>
<li><strong>诊断工具</strong>：内存分析、性能分析</li>
</ul>
<h2 data-id="heading-13">项目管理：忘记makefile</h2>
<p><strong>小李</strong>：怎么管理C#项目依赖？</p>
<p><strong>王哥</strong>：忘记makefile和手动拷贝dll吧！C#有<strong>NuGet</strong>：</p>
<ol>
<li><strong>依赖管理</strong>：在<code>.csproj</code>文件里定义</li>
<li><strong>包恢复</strong>：自动下载依赖</li>
<li><strong>版本控制</strong>：语义化版本管理</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 项目文件示例 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Project</span> <span class="hljs-attr">Sdk</span>=<span class="hljs-string">"Microsoft.NET.Sdk"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">PropertyGroup</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">TargetFramework</span>&gt;</span>net6.0<span class="hljs-tag">&lt;/<span class="hljs-name">TargetFramework</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Nullable</span>&gt;</span>enable<span class="hljs-tag">&lt;/<span class="hljs-name">Nullable</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">PropertyGroup</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">ItemGroup</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 添加NuGet包 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">PackageReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"Newtonsoft.Json"</span> <span class="hljs-attr">Version</span>=<span class="hljs-string">"13.0.1"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">PackageReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"AutoMapper"</span> <span class="hljs-attr">Version</span>=<span class="hljs-string">"10.1.1"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ItemGroup</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Project</span>&gt;</span>
</code></pre>
<p><strong>王哥</strong>：给你的<strong>日常检查清单</strong>：</p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 代码中是否还有<code>public</code>字段？（应该用属性）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否实现了<code>IDisposable</code>？（如果有非托管资源）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 异步方法是否以<code>Async</code>结尾？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否处理了可能的<code>null</code>？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用了合适的集合类型？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 字符串比较是否指定了比较规则？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否避免了装箱拆箱？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否用了<code>using</code>管理资源？</li>
</ul>
<h2 data-id="heading-14">最后的忠告</h2>
<p><strong>王哥</strong>：小李，转型最大的障碍不是技术，而是<strong>思维习惯</strong>。你需要：</p>
<ol>
<li><strong>从控制狂到信任者</strong>：相信GC，相信框架</li>
<li><strong>从手动挡到自动挡</strong>：让工具为你工作</li>
<li><strong>从微观到宏观</strong>：关注业务逻辑而不是内存布局</li>
<li><strong>从复杂到简洁</strong>：利用现代语言特性</li>
</ol>
<p><strong>小李</strong>：感觉要学的好多啊！</p>
<p><strong>王哥</strong>：别急，我给你一个<strong>30天学习计划</strong>：</p>
<p><strong>第1周</strong>：掌握基础</p>
<ul>
<li>值类型vs引用类型</li>
<li>属性vs字段</li>
<li>基本集合使用</li>
</ul>
<p><strong>第2周</strong>：深入核心</p>
<ul>
<li>async/await</li>
<li>LINQ基础</li>
<li>异常处理</li>
</ul>
<p><strong>第3周</strong>：现代特性</p>
<ul>
<li>模式匹配</li>
<li>记录类型</li>
<li>可空引用类型</li>
</ul>
<p><strong>第4周</strong>：生态系统</p>
<ul>
<li>Entity Framework</li>
<li>ASP.NET Core基础</li>
<li>依赖注入</li>
</ul>
<p>记住，<strong>不要试图一次性掌握所有东西</strong>。写代码时遇到问题再查，实践中学习最快。有问题随时问我！</p>
<p><strong>小李</strong>：太感谢了！我现在明白多了。我会先从改掉C++的习惯开始。</p>
<p><strong>王哥</strong>：对了，最后送你一句话：<strong>"写C#代码，不要用C++思维"</strong>。祝你转型顺利！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TCP心跳机制：看不见的“生命线”]]></title>    <link>https://juejin.cn/post/7594791357144629290</link>    <guid>https://juejin.cn/post/7594791357144629290</guid>    <pubDate>2026-01-14T14:12:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594791357144629290" data-draft-id="7595043440520118278" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TCP心跳机制：看不见的“生命线”"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-14T14:12:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TCP心跳机制：看不见的“生命线”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T14:12:59.000Z" title="Wed Jan 14 2026 14:12:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>我</strong>：（凌晨2点被电话吵醒）“喂...怎么了？”</p>
<p><strong>运维同事</strong>：“王工，咱们的在线游戏服务器又挂了！五万玩家突然集体掉线！”</p>
<p><strong>我</strong>：（瞬间清醒）“什么？连接数不是一直很稳定吗？”</p>
<p><strong>同事</strong>：“就是啊！流量监控显示一切正常，但玩家就是连不上。NAT网关日志显示所有长连接都被清空了...”</p>
<p><strong>我</strong>：“心跳机制没生效？”</p>
<p><strong>同事</strong>：“啊？心跳？我们TCP不是已经建立连接了吗？”</p>
<hr/>
<h2 data-id="heading-0">第一问：TCP不是已经建立连接了吗，为什么还需要心跳？</h2>
<h3 data-id="heading-1">对话重现：</h3>
<p><strong>新人小李</strong>：“王哥，我有个问题想不通。TCP三次握手建立连接后，不是就有了一条可靠的通道吗？为什么还要额外搞个心跳机制？”</p>
<p><strong>我</strong>：“好问题！想象一下这个场景：你正在和远方的朋友打电话，突然他的手机没电自动关机了。”</p>
<p><strong>小李</strong>：“那我这边会听到忙音或者直接断线？”</p>
<p><strong>我</strong>：“在电话里是的，但在TCP世界里，你可能永远不知道对方已经‘消失’了。TCP连接建立后，如果对端突然崩溃、网络中间设备重启，或者NAT网关超时，你的TCP连接在本地看来依然是‘ESTABLISHED’状态。”</p>
<p><strong>小李</strong>：“等等，TCP不是有超时重传机制吗？”</p>
<p><strong>我</strong>：“没错，但重传超时通常是分钟级别的。RFC里规定的RTO最小值是1秒，最大可能到几分钟。而且，如果中间路由器把连接重置了，但重置包丢失了呢？”</p>
<h3 data-id="heading-2">技术内幕：</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 这就是问题所在 - TCP连接状态</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">tcp_state</span> {
    TCP_ESTABLISHED = <span class="hljs-number">1</span>,  <span class="hljs-comment">// 连接建立</span>
    TCP_CLOSE_WAIT = <span class="hljs-number">8</span>,   <span class="hljs-comment">// 被动关闭</span>
    <span class="hljs-comment">// ... 但没有"对方已死但我不知道"的状态</span>
};

<span class="hljs-comment">// 实际场景</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">check_connection</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd)</span> </span>{
    <span class="hljs-comment">// 即使对端已崩溃，这个检查可能仍然返回成功</span>
    <span class="hljs-type">int</span> error = <span class="hljs-number">0</span>;
    <span class="hljs-type">socklen_t</span> len = <span class="hljs-built_in">sizeof</span>(error);
    <span class="hljs-built_in">getsockopt</span>(sockfd, SOL_SOCKET, SO_ERROR, &amp;error, &amp;len);
    <span class="hljs-keyword">return</span> error == <span class="hljs-number">0</span>;  <span class="hljs-comment">// 可能返回true，即使连接实际已失效</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-3">第二问：TCP不是有Keepalive选项吗？直接用不就行了？</h2>
<h3 data-id="heading-4">对话重现：</h3>
<p><strong>架构师老张</strong>：“小王，我看你又在实现应用层心跳。系统不是有TCP Keepalive吗？别重复造轮子。”</p>
<p><strong>我</strong>：“张总，这个问题我们实测过。上周咱们的移动端APP，在4G网络下，TCP Keepalive完全失效了。”</p>
<p><strong>老张</strong>：“失效？怎么可能？”</p>
<p><strong>我</strong>：“我们抓包分析发现，运营商的GGSN网关会把TCP Keepalive包过滤掉。而且，Linux默认设置是7200秒后开始探测，对实时应用来说，两小时太长了。”</p>
<h3 data-id="heading-5">实测数据对比：</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 不同场景下的心跳需求对比表</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">HeartbeatRequirement</span> {
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* scenario;      <span class="hljs-comment">// 场景</span>
    <span class="hljs-type">int</span> max_allowed_gap;       <span class="hljs-comment">// 允许的最大间隔（秒）</span>
    <span class="hljs-type">bool</span> tcp_keepalive_works;  <span class="hljs-comment">// TCP Keepalive是否有效</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* reason;        <span class="hljs-comment">// 原因</span>
};

HeartbeatRequirement requirements[] = {
    {<span class="hljs-string">"移动4G/5G网络"</span>,     <span class="hljs-number">20</span>,  <span class="hljs-literal">false</span>, <span class="hljs-string">"运营商过滤Keepalive包"</span>},
    {<span class="hljs-string">"企业NAT网关"</span>,       <span class="hljs-number">300</span>, <span class="hljs-literal">true</span>,  <span class="hljs-string">"默认5分钟超时"</span>},
    {<span class="hljs-string">"阿里云SLB"</span>,         <span class="hljs-number">60</span>,  <span class="hljs-literal">false</span>, <span class="hljs-string">"会话超时设置"</span>},
    {<span class="hljs-string">"游戏服务器"</span>,         <span class="hljs-number">30</span>,  <span class="hljs-literal">false</span>, <span class="hljs-string">"玩家体验要求"</span>},
    {<span class="hljs-string">"金融交易系统"</span>,       <span class="hljs-number">10</span>,  <span class="hljs-literal">false</span>, <span class="hljs-string">"合规要求"</span>},
    {<span class="hljs-string">"IoT设备"</span>,           <span class="hljs-number">120</span>, <span class="hljs-literal">true</span>,  <span class="hljs-string">"省电模式限制"</span>}
};
</code></pre>
<hr/>
<h2 data-id="heading-6">第三问：心跳包会不会造成网络拥塞？</h2>
<h3 data-id="heading-7">对话重现：</h3>
<p><strong>测试工程师小刘</strong>：“王哥，我们压力测试时发现，心跳包占了总流量的30%！这正常吗？”</p>
<p><strong>我</strong>：“当然不正常！你们是怎么实现的？”</p>
<p><strong>小刘</strong>：“就是每个连接每秒发一个心跳包啊。”</p>
<p><strong>我</strong>：（扶额）“每秒？咱们有十万并发连接，每个心跳包就算只有10字节，算算带宽...”</p>
<p><strong>小刘</strong>：“10字节 × 10万连接 × 8位 × 1秒 = 8Mbps？天哪！”</p>
<h3 data-id="heading-8">优化方案对话：</h3>
<p><strong>我</strong>：“心跳设计有三个原则：够用、经济、智能。”</p>
<p><strong>小刘</strong>：“怎么个智能法？”</p>
<p><strong>我</strong>：“比如动态心跳间隔。连接刚建立时密集一些，稳定后拉长间隔。还有‘捎带确认’——有业务数据时就不发独立心跳包。”</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartHeartbeat</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">calculate_interval</span><span class="hljs-params">(<span class="hljs-type">const</span> ConnectionStats&amp; stats)</span> </span>{
        <span class="hljs-comment">// 基于网络质量动态调整</span>
        <span class="hljs-keyword">if</span> (stats.rtt &gt; <span class="hljs-number">1000</span>) {          <span class="hljs-comment">// 高延迟网络</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">60</span>;                   <span class="hljs-comment">// 60秒</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (stats.packet_loss &gt; <span class="hljs-number">0.1</span>) { <span class="hljs-comment">// 高丢包率</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">30</span>;                   <span class="hljs-comment">// 30秒</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_mobile_network</span>()) { <span class="hljs-comment">// 移动网络</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">45</span>;                   <span class="hljs-comment">// 45秒（考虑NAT超时）</span>
        } <span class="hljs-keyword">else</span> {                         <span class="hljs-comment">// 稳定网络</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">180</span>;                  <span class="hljs-comment">// 3分钟</span>
        }
    }
    
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">should_piggyback</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 如果最近有数据交互，可以跳过这次心跳</span>
        <span class="hljs-keyword">auto</span> now = std::chrono::steady_clock::<span class="hljs-built_in">now</span>();
        <span class="hljs-keyword">auto</span> elapsed = std::chrono::<span class="hljs-built_in">duration_cast</span>&lt;std::chrono::seconds&gt;(
            now - last_data_time_);
        <span class="hljs-keyword">return</span> elapsed.<span class="hljs-built_in">count</span>() &lt; heartbeat_interval_ / <span class="hljs-number">2</span>;
    }
};
</code></pre>
<hr/>
<h2 data-id="heading-9">第四问：心跳机制如何应对复杂的网络环境？</h2>
<h3 data-id="heading-10">真实案例讨论：</h3>
<p><strong>客户</strong>：“我们的车联网设备经常在隧道里失联，出来后重连很慢。”</p>
<p><strong>我</strong>：“隧道场景很典型。GPS信号丢失、网络切换、信号衰减...心跳机制在这里特别关键。”</p>
<p><strong>客户</strong>：“但设备在隧道里本来就没信号啊，发心跳不是浪费电吗？”</p>
<p><strong>我</strong>：“所以需要‘退避策略’。进入隧道时快速检测失败，然后进入指数退避，避免无效尝试。”</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TunnelAwareHeartbeat</span> {
    <span class="hljs-keyword">enum class</span> <span class="hljs-title class_">NetworkState</span> {
        NORMAL,
        ENTERING_TUNNEL,   <span class="hljs-comment">// 信号减弱</span>
        IN_TUNNEL,         <span class="hljs-comment">// 无信号</span>
        EXITING_TUNNEL     <span class="hljs-comment">// 信号恢复</span>
    };
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">adjust_for_tunnel</span><span class="hljs-params">(NetworkState state)</span> </span>{
        <span class="hljs-keyword">switch</span> (state) {
            <span class="hljs-keyword">case</span> NetworkState::ENTERING_TUNNEL:
                interval_ = <span class="hljs-number">10</span>;  <span class="hljs-comment">// 快速检测是否真进入隧道</span>
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> NetworkState::IN_TUNNEL:
                interval_ = <span class="hljs-number">300</span>; <span class="hljs-comment">// 隧道内，5分钟一次</span>
                max_retries_ = <span class="hljs-number">1</span>; <span class="hljs-comment">// 减少重试</span>
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> NetworkState::EXITING_TUNNEL:
                interval_ = <span class="hljs-number">5</span>;   <span class="hljs-comment">// 快速探测网络恢复</span>
                aggressive_mode_ = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">break</span>;
        }
    }
};
</code></pre>
<hr/>
<h2 data-id="heading-11">第五问：心跳机制的安全考虑是什么？</h2>
<h3 data-id="heading-12">安全团队质询：</h3>
<p><strong>安全工程师</strong>：“你们的心跳协议可能被DDoS攻击利用。攻击者可以建立大量连接，只发心跳包消耗服务器资源。”</p>
<p><strong>我</strong>：“我们有几个防护措施。首先，心跳协议要验证...”</p>
<p><strong>安全工程师</strong>：“验证什么？心跳包那么小，能验证什么？”</p>
<p><strong>我</strong>：“即使是心跳包，也可以带签名。比如时间戳+序列号的HMAC签名。”</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SecureHeartbeat</span> {
    <span class="hljs-type">uint32_t</span> timestamp;
    <span class="hljs-type">uint32_t</span> sequence;
    <span class="hljs-type">uint8_t</span>  hmac_signature[<span class="hljs-number">32</span>];  <span class="hljs-comment">// HMAC-SHA256</span>
    
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">validate</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* secret_key, <span class="hljs-type">size_t</span> key_len)</span> </span>{
        <span class="hljs-comment">// 检查时间戳（防止重放攻击）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(<span class="hljs-built_in">get_current_time</span>() - timestamp) &gt; <span class="hljs-number">30</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 时间偏差太大</span>
        }
        
        <span class="hljs-comment">// 验证HMAC签名</span>
        <span class="hljs-type">uint8_t</span> computed_hmac[<span class="hljs-number">32</span>];
        <span class="hljs-built_in">compute_hmac</span>(secret_key, key_len, 
                    <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span>*&gt;(<span class="hljs-keyword">this</span>), 
                    <span class="hljs-built_in">sizeof</span>(SecureHeartbeat) - <span class="hljs-number">32</span>,
                    computed_hmac);
        
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">memcmp</span>(hmac_signature, computed_hmac, <span class="hljs-number">32</span>) == <span class="hljs-number">0</span>;
    }
};
</code></pre>
<p><strong>安全工程师</strong>：“那序列号重复攻击呢？”</p>
<p><strong>我</strong>：“服务端会记录最近收到的序列号，拒绝重复或乱序的包。”</p>
<hr/>
<h2 data-id="heading-13">第六问：如何平衡心跳的及时性和系统开销？</h2>
<h3 data-id="heading-14">性能优化讨论：</h3>
<p><strong>性能团队</strong>：“心跳检测线程占用了5%的CPU，连接数上涨后可能成为瓶颈。”</p>
<p><strong>我</strong>：“我们正在从线性扫描改为时间轮算法。十万连接检测从O(n)降到O(1)。”</p>
<p><strong>性能团队</strong>：“时间轮？具体说说。”</p>
<p><strong>我</strong>：“把时间分成槽，每个槽存放这个时间点需要检查的连接。指针每跳一格，只检查当前槽位的连接。”</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 时间轮实现示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeWheelHeartbeat</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Slot</span> {
        std::vector&lt;<span class="hljs-type">int</span>&gt; connections;
        std::chrono::steady_clock::time_point expected_time;
    };
    
    std::vector&lt;Slot&gt; wheel_;
    <span class="hljs-type">size_t</span> current_slot_;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">tick</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">auto</span>&amp; slot = wheel_[current_slot_];
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> conn_id : slot.connections) {
            <span class="hljs-built_in">check_connection</span>(conn_id);  <span class="hljs-comment">// 只检查当前槽位的连接</span>
        }
        slot.connections.<span class="hljs-built_in">clear</span>();
        current_slot_ = (current_slot_ + <span class="hljs-number">1</span>) % wheel_.<span class="hljs-built_in">size</span>();
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add_connection</span><span class="hljs-params">(<span class="hljs-type">int</span> conn_id, <span class="hljs-type">int</span> timeout_sec)</span> </span>{
        <span class="hljs-type">size_t</span> target_slot = (current_slot_ + timeout_sec) % wheel_.<span class="hljs-built_in">size</span>();
        wheel_[target_slot].connections.<span class="hljs-built_in">push_back</span>(conn_id);
    }
};
</code></pre>
<p><strong>性能团队</strong>：“那内存占用呢？”</p>
<p><strong>我</strong>：“每个连接只在时间轮里存一个ID，O(n)内存。检测时O(1)时间复杂度。”</p>
<hr/>
<h2 data-id="heading-15">第七问：在微服务架构中，心跳机制如何设计？</h2>
<h3 data-id="heading-16">架构讨论会：</h3>
<p><strong>微服务架构师</strong>：“现在我们服务拆得很细，服务网格里每个Pod都有心跳，是不是太多了？”</p>
<p><strong>我</strong>：“确实需要分层设计。我建议三级心跳体系...”</p>
<p><strong>架构师</strong>：“三级？哪三级？”</p>
<p><strong>我</strong>：“第一级：TCP层Keepalive，系统级保底。第二级：应用层基础心跳，服务间保活。第三级：业务级健康检查，带负载和状态信息。”</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 微服务心跳体系</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MicroserviceHeartbeatSystem</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Level1</span> {
        <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">enable_tcp_keepalive</span><span class="hljs-params">(Connection&amp; conn)</span> </span>{
            conn.<span class="hljs-built_in">set_option</span>(TCP_KEEPALIVE, <span class="hljs-literal">true</span>);
            conn.<span class="hljs-built_in">set_option</span>(TCP_KEEPIDLE, <span class="hljs-number">60</span>);
        }
    };
    
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Level2</span> {
        <span class="hljs-comment">// 应用层心跳，携带服务标识</span>
        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">AppHeartbeat</span> {
            ServiceId service_id;
            InstanceId instance_id;
            Timestamp timestamp;
        };
        
        <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">send_to_service_mesh</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-comment">// 通过服务网格发送</span>
        }
    };
    
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Level3</span> {
        <span class="hljs-comment">// 业务健康检查</span>
        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">HealthCheck</span> {
            CPUUsage cpu_usage;
            MemoryUsage memory;
            QueueLength request_queue;
            CustomMetrics business_metrics;
        };
        
        <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">report_to_monitoring</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-comment">// 上报到监控系统</span>
        }
    };
};
</code></pre>
<hr/>
<h2 data-id="heading-17">结语：心跳的艺术</h2>
<p><strong>我</strong>：（总结会议）“所以，心跳机制不是简单的定时发送。它是...”</p>
<p><strong>团队</strong>：（异口同声）“连接的生命线、系统的听诊器、网络的探照灯！”</p>
<p><strong>我</strong>：“没错！在设计心跳机制时，我们要问自己八个问题...”</p>
<h3 data-id="heading-18">设计检查表：</h3>
<ol>
<li>❓ 心跳间隔能否应对最差网络环境？</li>
<li>❓ NAT超时时间考虑了吗？</li>
<li>❓ 心跳流量占总流量比例合理吗？</li>
<li>❓ 断线检测延迟业务能接受吗？</li>
<li>❓ 心跳失败后的重连策略是什么？</li>
<li>❓ 心跳协议能否防止恶意攻击？</li>
<li>❓ 心跳机制本身的高可用如何保证？</li>
<li>❓ 有没有监控和动态调整能力？</li>
</ol>
<hr/>
<p><strong>后记</strong>：
三个月后，那个深夜告警的问题终于找到了根本原因。不是代码bug，不是硬件故障，而是心跳机制与NAT超时时间的不匹配。我们将心跳间隔从60秒调整到45秒后，再也没有发生过大规模掉线。</p>
<p>有时候，技术中最不起眼的细节，恰恰是最关键的生命线。TCP心跳机制，就是这样一条看不见的、却至关重要的“生命线”。</p>
<p><strong>记住</strong>：在网络的世界里，沉默不一定是金——它可能意味着连接已经悄然死亡。而一个好的心跳机制，就是让沉默“说话”的艺术。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[markstream-vue实战踩坑笔记]]></title>    <link>https://juejin.cn/post/7595043440520151046</link>    <guid>https://juejin.cn/post/7595043440520151046</guid>    <pubDate>2026-01-14T14:21:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595043440520151046" data-draft-id="7594791357144563754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="markstream-vue实战踩坑笔记"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-14T14:21:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桜吹雪"/> <meta itemprop="url" content="https://juejin.cn/user/1179091901098269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            markstream-vue实战踩坑笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1179091901098269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桜吹雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T14:21:55.000Z" title="Wed Jan 14 2026 14:21:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近新开始做了一个ai对话的项目，打算重构一下老项目的markdown渲染和交互。老项目使用marked对md进行渲染成html，然后使用v-html渲染，搞到后面发现太多技术债了，所以打算换一个实现方法。经过一番对比，发现 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSimon-He95%2Fmarkstream-vue" target="_blank" title="https://github.com/Simon-He95/markstream-vue" ref="nofollow noopener noreferrer">markstream-vue</a> 的star是最多的，去看了一下官方文档发现特性也很多。所以这里决定就用这个组件了。</p>
<h2 data-id="heading-0">需求说明</h2>
<p>这里实现的一个项目是ai对话的应用，特点是可能markdown里要混着各种业务组件，以及一些md的节点可以点击交互，比如列表项或者链接点击代替用户自动发送信息。</p>
<h2 data-id="heading-1">安装使用</h2>
<p>安装就不多浪费口水了，官方文档写的非常详细，我们先看看案例markdown，以及使用库提供的markdown解析成节点：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { getMarkdown, <span class="hljs-title class_">MarkdownRender</span>, parseMarkdownToStructure } <span class="hljs-keyword">from</span> <span class="hljs-string">'markstream-vue'</span>

<span class="hljs-keyword">const</span> md = <span class="hljs-string">`
&lt;thinking&gt;
这是推理内容
&lt;/thinking&gt;

请选择办理方式
- 线上办理
- 线下办理

&lt;a data-send="其他办理方式"&gt;其他办理方式&lt;/a&gt;
`</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-title function_">parseMarkdownToStructure</span>(md, <span class="hljs-title function_">getMarkdown</span>()), <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>))
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7be94536002148d8b70d6a9bfcd61d2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qGc5ZC56Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769005314&amp;x-signature=kNOqj2NP6wudRlYphQsRa4cL4x4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">对list_item和link进行自定义</h3>
<p>如果只是渲染上面的md，很简单：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">MarkdownRender</span> <span class="hljs-attr">:content</span>=<span class="hljs-string">"md"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>但是我需要实现对list_item和link进行自定义渲染，那就需要使用到 <code>setCustomComponents</code> 以及对renderer设置custom-id</p>
<p>参考官方的思考block渲染组件：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSimon-He95%2Fmarkstream-vue%2Fblob%2Fmain%2Fplayground%2Fsrc%2Fcomponents%2FThinkingNode.vue" target="_blank" title="https://github.com/Simon-He95/markstream-vue/blob/main/playground/src/components/ThinkingNode.vue" ref="nofollow noopener noreferrer">github.com/Simon-He95/…</a></p>
<p>我们先试试thinking的渲染：</p>
<pre><code class="hljs language-ts" lang="ts">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MarkdownRender</span>, setCustomComponents } <span class="hljs-keyword">from</span> <span class="hljs-string">'markstream-vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ThinkingNode</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ThinkingNode.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'markstream-vue/index.css'</span>

<span class="hljs-keyword">const</span> md = <span class="hljs-string">`
&lt;thinking&gt;
这是推理内容
&lt;/thinking&gt;


请选择办理方式
- 线上办理
- 线下办理

&lt;a data-send="其他办理方式"&gt;其他办理方式&lt;/a&gt;
`</span>
<span class="hljs-title function_">setCustomComponents</span>(<span class="hljs-string">'doc'</span>, {
  <span class="hljs-attr">thinking</span>: <span class="hljs-title class_">ThinkingNode</span>,
})
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">MarkdownRender</span> <span class="hljs-attr">custom-id</span>=<span class="hljs-string">"doc"</span> <span class="hljs-attr">:content</span>=<span class="hljs-string">"md"</span> <span class="hljs-attr">:custom-html-tags</span>=<span class="hljs-string">"['thinking']"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8eeebcd302549a08bb62bde0107a5b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qGc5ZC56Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769005314&amp;x-signature=ZpFlywCVXVQF%2BdgANdhslBtlV4o%3D" alt="image.png" loading="lazy"/></p>
<p>没啥问题，接下来对link节点自定义，我们只需要直接去官方仓库copy出来改就好了</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSimon-He95%2Fmarkstream-vue%2Fblob%2Fmain%2Fsrc%2Fcomponents%2FLinkNode%2FLinkNode.vue" target="_blank" title="https://github.com/Simon-He95/markstream-vue/blob/main/src/components/LinkNode/LinkNode.vue" ref="nofollow noopener noreferrer">github.com/Simon-He95/…</a></p>
<p>因为我们不需要花里胡哨的特效，这里对源代码进行删减，并且对点击事件进行调整</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// LinkNode.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HtmlInlineNode</span>, <span class="hljs-title class_">ImageNode</span>, <span class="hljs-title class_">StrikethroughNode</span>, <span class="hljs-title class_">StrongNode</span>, <span class="hljs-title class_">TextNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'markstream-vue'</span>
<span class="hljs-keyword">import</span> { computed, useAttrs } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { extractAnchorAttributes } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.ts'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LinkNodeNode</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'link'</span>
  <span class="hljs-attr">href</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>
  <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">children</span>: { <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">raw</span>: <span class="hljs-built_in">string</span> }[]
  <span class="hljs-attr">raw</span>: <span class="hljs-built_in">string</span>
  loading?: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-comment">// 定义链接节点</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LinkNodeProps</span> {
  <span class="hljs-attr">node</span>: <span class="hljs-title class_">LinkNodeNode</span>
  indexKey?: <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>
  customId?: <span class="hljs-built_in">string</span>
  showTooltip?: <span class="hljs-built_in">boolean</span>
  color?: <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">// 接收props — 把动画/颜色相关配置暴露为props，并通过CSS变量注入样式</span>
<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">withDefaults</span>(defineProps&lt;<span class="hljs-title class_">LinkNodeProps</span>&gt;(), {
  <span class="hljs-attr">showTooltip</span>: <span class="hljs-literal">true</span>,
})

<span class="hljs-keyword">const</span> emits = defineEmits&lt;{
  <span class="hljs-attr">send</span>: [<span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>]
}&gt;()

<span class="hljs-keyword">const</span> cssVars = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-string">'--link-color'</span>: props.<span class="hljs-property">color</span> ?? <span class="hljs-string">'#0366d6'</span>,
  } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;
})

<span class="hljs-comment">// Available node components for child rendering</span>
<span class="hljs-keyword">const</span> nodeComponents = {
  <span class="hljs-attr">text</span>: <span class="hljs-title class_">TextNode</span>,
  <span class="hljs-attr">strong</span>: <span class="hljs-title class_">StrongNode</span>,
  <span class="hljs-attr">strikethrough</span>: <span class="hljs-title class_">StrikethroughNode</span>,
  <span class="hljs-attr">image</span>: <span class="hljs-title class_">ImageNode</span>,
  <span class="hljs-attr">html_inline</span>: <span class="hljs-title class_">HtmlInlineNode</span>,
}

<span class="hljs-comment">// forward any non-prop attributes (e.g. custom-id) to the rendered element</span>
<span class="hljs-keyword">const</span> attrs = <span class="hljs-title function_">useAttrs</span>()

<span class="hljs-keyword">const</span> linkAttrs = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">extractAnchorAttributes</span>(props.<span class="hljs-property">node</span>.<span class="hljs-property">raw</span>))

<span class="hljs-keyword">const</span> linkHref = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> href = props.<span class="hljs-property">node</span>.<span class="hljs-property">href</span>
  <span class="hljs-keyword">if</span> (href?.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'javascript:'</span>) || !href) {
    <span class="hljs-comment">// 如果 href 以 javascript: 开头，一律返回 void(0) 防止执行恶意代码</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'javascript:void(0)'</span>
  }
  <span class="hljs-keyword">return</span> href
})

<span class="hljs-keyword">const</span> linkTarget = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (linkAttrs.<span class="hljs-property">value</span>?.<span class="hljs-property">target</span>) {
    <span class="hljs-keyword">return</span> linkAttrs.<span class="hljs-property">value</span>?.<span class="hljs-property">target</span>
  }
  <span class="hljs-keyword">if</span> (!props.<span class="hljs-property">node</span>.<span class="hljs-property">href</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'_self'</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-string">'_blank'</span>
})

<span class="hljs-keyword">const</span> title = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">String</span>(props.<span class="hljs-property">node</span>.<span class="hljs-property">title</span> ?? props.<span class="hljs-property">node</span>.<span class="hljs-property">href</span> ?? <span class="hljs-string">''</span>))

<span class="hljs-keyword">function</span> <span class="hljs-title function_">onClick</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (linkAttrs.<span class="hljs-property">value</span>?.[<span class="hljs-string">'data-send'</span>]) {
    <span class="hljs-title function_">emits</span>(<span class="hljs-string">'send'</span>, linkAttrs.<span class="hljs-property">value</span>?.[<span class="hljs-string">'data-send'</span>])
  }
}
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">a</span>
    <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!node.loading"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"link-node"</span>
    <span class="hljs-attr">:href</span>=<span class="hljs-string">"linkHref"</span>
    <span class="hljs-attr">:target</span>=<span class="hljs-string">"linkTarget"</span>
    <span class="hljs-attr">rel</span>=<span class="hljs-string">"noopener noreferrer"</span>
    <span class="hljs-attr">:title</span>=<span class="hljs-string">"showTooltip ? '' : title"</span>
    <span class="hljs-attr">:aria-label</span>=<span class="hljs-string">"`Link: ${title}`"</span>
    <span class="hljs-attr">:aria-hidden</span>=<span class="hljs-string">"node.loading ? 'true' : 'false'"</span>
    <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"attrs"</span>
    <span class="hljs-attr">:style</span>=<span class="hljs-string">"cssVars"</span>
    @<span class="hljs-attr">click</span>=<span class="hljs-string">"onClick"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">component</span>
      <span class="hljs-attr">:is</span>=<span class="hljs-string">"nodeComponents[child.type]"</span>
      <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(child, index) in node.children"</span>
      <span class="hljs-attr">:key</span>=<span class="hljs-string">"`${indexKey || 'emphasis'}-${index}`"</span>
      <span class="hljs-attr">:node</span>=<span class="hljs-string">"child"</span>
      <span class="hljs-attr">:custom-id</span>=<span class="hljs-string">"props.customId"</span>
      <span class="hljs-attr">:index-key</span>=<span class="hljs-string">"`${indexKey || 'link-text'}-${index}`"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"link-loading inline-flex items-baseline gap-1.5"</span> <span class="hljs-attr">:aria-hidden</span>=<span class="hljs-string">"!node.loading ? 'true' : 'false'"</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"attrs"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"cssVars"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"link-text-wrapper relative inline-flex"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"link-text leading-[normal]"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"link-text leading-[normal]"</span>&gt;</span>{{ node.text }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.link-node</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--link-color, <span class="hljs-number">#0366d6</span>);
  <span class="hljs-attribute">text-decoration</span>: none;
}

<span class="hljs-selector-class">.link-loading</span> <span class="hljs-selector-class">.link-text-wrapper</span> {
  <span class="hljs-attribute">position</span>: relative;
}

<span class="hljs-selector-class">.link-loading</span> <span class="hljs-selector-class">.link-text</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">2</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// utils.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">extractAnchorAttributes</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 1. 基础类型检查</span>
  <span class="hljs-keyword">if</span> (!str)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

  <span class="hljs-comment">// 去除首尾空格，方便处理</span>
  <span class="hljs-keyword">const</span> trimmed = str.<span class="hljs-title function_">trim</span>()

  <span class="hljs-comment">// 2. 快速判断：必须以 &lt;a 开头（忽略大小写），且后面必须跟空白字符</span>
  <span class="hljs-comment">// 这一步只做检测，不提取，避免复杂的正则回溯</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/^&lt;a\s/i</span>.<span class="hljs-title function_">test</span>(trimmed)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
  }

  <span class="hljs-comment">// 3. 提取 &lt;a ... &gt; 中间的内容</span>
  <span class="hljs-comment">// 既然我们已经确信它是 &lt;a 开头，直接找第一个 &gt; 的位置即可</span>
  <span class="hljs-comment">// 这种使用 indexOf + slice 的方式是 O(n) 的，绝对没有 ReDoS 风险</span>
  <span class="hljs-keyword">const</span> closeTagIndex = trimmed.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'&gt;'</span>)
  <span class="hljs-keyword">if</span> (closeTagIndex === -<span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

  <span class="hljs-comment">// 截取 &lt;a 和 &gt; 中间的字符串</span>
  <span class="hljs-comment">// &lt;a href="..."&gt; -&gt; 截取 " href="..."</span>
  <span class="hljs-comment">// 我们不需要精确去掉 &lt;a 后的空格，因为后面的属性正则会自动处理空格</span>
  <span class="hljs-keyword">const</span> attrString = trimmed.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>, closeTagIndex)

  <span class="hljs-comment">// 4. 解析属性键值对</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">attributes</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {}

  <span class="hljs-comment">// 优化后的正则：</span>
  <span class="hljs-comment">// ([^\s=]+)  匹配属性名 (非空格、非等号)</span>
  <span class="hljs-comment">// \s*=\s*    匹配等号及周围空格</span>
  <span class="hljs-comment">// (["'])     捕获引号</span>
  <span class="hljs-comment">// (.*?)      捕获值 (非贪婪)</span>
  <span class="hljs-comment">// \2         匹配闭合引号</span>
  <span class="hljs-keyword">const</span> attrRegex = <span class="hljs-regexp">/([^\s=]+)\s*=\s*(["'])(.*?)\2/g</span>

  <span class="hljs-comment">// 5. 使用 matchAll 替代 while 赋值循环</span>
  <span class="hljs-comment">// matchAll 返回一个迭代器，完美解决 ESLint no-cond-assign 问题</span>
  <span class="hljs-keyword">const</span> matches = attrString.<span class="hljs-title function_">matchAll</span>(attrRegex)

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> match <span class="hljs-keyword">of</span> matches) {
    <span class="hljs-keyword">if</span> (!match[<span class="hljs-number">1</span>])
      <span class="hljs-keyword">continue</span>
    <span class="hljs-comment">// match[1] 是 key, match[3] 是 value</span>
    attributes[match[<span class="hljs-number">1</span>]] = match[<span class="hljs-number">3</span>] || <span class="hljs-string">''</span>
  }

  <span class="hljs-keyword">return</span> attributes
}
</code></pre>
<p>因为我的业务需要将一些属性加到标签的属性上，这里我让哈基米3pro帮我写了一段正则，从raw的html上面提取属性。</p>
<p>很完美，可以正常捕获点击了，但是如果像上面那样配置thinking节点一样配置，我们就没办法拿到事件了，这里我们要取个巧，在外面将这个link组件包多一层，拿到emit：</p>
<pre><code class="hljs language-ts" lang="ts">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { h } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MarkdownRender</span>, setCustomComponents } <span class="hljs-keyword">from</span> <span class="hljs-string">'markstream-vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ThinkingNode</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ThinkingNode.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">LinkNode</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./LinkNode.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'markstream-vue/index.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">LinkNodeNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./LinkNode.vue'</span>

<span class="hljs-keyword">const</span> md = <span class="hljs-string">`
&lt;thinking&gt;
这是推理内容
&lt;/thinking&gt;


请选择办理方式
- 线上办理
- 线下办理

&lt;a data-send="其他办理方式"&gt;其他办理方式&lt;/a&gt;
`</span>
<span class="hljs-title function_">setCustomComponents</span>(<span class="hljs-string">'doc'</span>, {
  <span class="hljs-attr">thinking</span>: <span class="hljs-title class_">ThinkingNode</span>,
  <span class="hljs-attr">link</span>: <span class="hljs-function">(<span class="hljs-params">props: { node: LinkNodeNode }</span>) =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">LinkNode</span>, {
    ...props,
    <span class="hljs-title function_">onSend</span>(<span class="hljs-params">text</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(text)
    },
  }),
})
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">MarkdownRender</span> <span class="hljs-attr">custom-id</span>=<span class="hljs-string">"doc"</span> <span class="hljs-attr">:content</span>=<span class="hljs-string">"md"</span> <span class="hljs-attr">:custom-html-tags</span>=<span class="hljs-string">"['thinking']"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<p>list_item也是类似的操作，不过有点区别是需要自定义list节点，没办法单独自定义list_item，不过方法也是类似的，把源代码copy出来改就可以：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ListNode.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ListItemNode</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ListItemNode.vue'</span>

<span class="hljs-comment">// 节点子元素类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">NodeChild</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">raw</span>: <span class="hljs-built_in">string</span>
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">unknown</span>
}

<span class="hljs-comment">// 列表项类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ListItem</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'list_item'</span>
  <span class="hljs-attr">children</span>: <span class="hljs-title class_">NodeChild</span>[]
  <span class="hljs-attr">raw</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">const</span> { node, customId, indexKey, typewriter } = defineProps&lt;{
  <span class="hljs-attr">node</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'list'</span>
    <span class="hljs-attr">ordered</span>: <span class="hljs-built_in">boolean</span>
    start?: <span class="hljs-built_in">number</span>
    <span class="hljs-attr">items</span>: <span class="hljs-title class_">ListItem</span>[]
    <span class="hljs-attr">raw</span>: <span class="hljs-built_in">string</span>
  }
  customId?: <span class="hljs-built_in">string</span>
  indexKey?: <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>
  typewriter?: <span class="hljs-built_in">boolean</span>
}&gt;()

<span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'copy'</span>])
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">component</span>
    <span class="hljs-attr">:is</span>=<span class="hljs-string">"node.ordered ? 'ol' : 'ul'"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"list-node"</span>
    <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ 'list-decimal': node.ordered, 'list-disc': !node.ordered }"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ListItemNode</span>
      <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in node.items"</span>
      <span class="hljs-attr">:key</span>=<span class="hljs-string">"`${indexKey || 'list'}-${index}`"</span>
      <span class="hljs-attr">v-memo</span>=<span class="hljs-string">"[item]"</span>
      <span class="hljs-attr">:item</span>=<span class="hljs-string">"item"</span>
      <span class="hljs-attr">:custom-id</span>=<span class="hljs-string">"customId"</span>
      <span class="hljs-attr">:index-key</span>=<span class="hljs-string">"`${indexKey || 'list'}-${index}`"</span>
      <span class="hljs-attr">:typewriter</span>=<span class="hljs-string">"typewriter"</span>
      <span class="hljs-attr">:value</span>=<span class="hljs-string">"node.ordered ? (node.start ?? 1) + index : undefined"</span>
      @<span class="hljs-attr">copy</span>=<span class="hljs-string">"$emit('copy', $event)"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">component</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.list-node</span> {
  <span class="hljs-keyword">@apply</span> my-<span class="hljs-number">5</span> pl-[calc(<span class="hljs-number">13</span>/<span class="hljs-number">8</span>*<span class="hljs-number">1em</span>)];
}
<span class="hljs-selector-class">.list-decimal</span> {
  <span class="hljs-attribute">list-style-type</span>: decimal;
}
<span class="hljs-selector-class">.list-disc</span> {
  <span class="hljs-attribute">list-style-type</span>: disc;
  <span class="hljs-keyword">@apply</span> <span class="hljs-attribute">max-lg</span>:my-[calc(<span class="hljs-number">4</span>/<span class="hljs-number">3</span>*<span class="hljs-number">1em</span>)] <span class="hljs-attribute">max-lg</span>:pl-[calc(<span class="hljs-number">14</span>/<span class="hljs-number">9</span>*<span class="hljs-number">1em</span>)];
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<pre><code class="hljs language-ts" lang="ts">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { computed, watchEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MarkdownRender</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'markstream-vue'</span>

<span class="hljs-comment">// 节点子元素类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">NodeChild</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">raw</span>: <span class="hljs-built_in">string</span>
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">unknown</span>
}

<span class="hljs-comment">// 列表项类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ListItem</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'list_item'</span>
  <span class="hljs-attr">children</span>: <span class="hljs-title class_">NodeChild</span>[]
  <span class="hljs-attr">raw</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">const</span> props = defineProps&lt;{
  <span class="hljs-attr">item</span>: <span class="hljs-title class_">ListItem</span>
  indexKey?: <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>
  value?: <span class="hljs-built_in">number</span>
  customId?: <span class="hljs-built_in">string</span>
  <span class="hljs-comment">/** Forwarded flag to enable/disable non-code node enter transition */</span>
  typewriter?: <span class="hljs-built_in">boolean</span>
}&gt;()

defineEmits&lt;{
  <span class="hljs-attr">copy</span>: [<span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>]
}&gt;()

<span class="hljs-keyword">const</span> liValueAttr = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span>
  props.<span class="hljs-property">value</span> == <span class="hljs-literal">null</span> ? {} : { <span class="hljs-attr">value</span>: props.<span class="hljs-property">value</span> },
)

<span class="hljs-keyword">function</span> <span class="hljs-title function_">onClick</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(props.<span class="hljs-property">item</span>.<span class="hljs-property">children</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">raw</span>)
}
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"my-2 list-item pl-1.5"</span>
    <span class="hljs-attr">dir</span>=<span class="hljs-string">"auto"</span>
    <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"liValueAttr"</span>
    @<span class="hljs-attr">click.capture</span>=<span class="hljs-string">"onClick"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">MarkdownRender</span> <span class="hljs-attr">:nodes</span>=<span class="hljs-string">"item.children"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-tag">ol</span> &gt; <span class="hljs-selector-class">.list-item</span><span class="hljs-selector-pseudo">::marker</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--list-item-counter-marker, <span class="hljs-number">#64748b</span>);
  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.6</span>;
}
<span class="hljs-selector-tag">ul</span> &gt; <span class="hljs-selector-class">.list-item</span><span class="hljs-selector-pseudo">::marker</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--list-item-marker, <span class="hljs-number">#cbd5e1</span>);
}

<span class="hljs-comment">/* 大列表滚动到视口时，嵌套 NodeRenderer 需要立即绘制内容，避免空白 */</span>
<span class="hljs-selector-class">.list-item</span> :<span class="hljs-built_in">deep</span>(.markdown-renderer) {
  <span class="hljs-attribute">content-visibility</span>: visible;
  <span class="hljs-attribute">contain</span>-intrinsic-size: <span class="hljs-number">0px</span> <span class="hljs-number">0px</span>;
  <span class="hljs-attribute">contain</span>: none;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-3">vmr组件</h3>
<p>除了这些原生的html节点之外，还有一个叫vmr组件的东西，可以渲染一些自定义的组件，使用文档可以看：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkstream-vue-docs.simonhe.me%2Fzh%2Fguide%2Fcomponents.html%23vmrcontainernode-%25E2%2580%2594-%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589-%25E5%25AE%25B9%25E5%2599%25A8" target="_blank" title="https://markstream-vue-docs.simonhe.me/zh/guide/components.html#vmrcontainernode-%E2%80%94-%E8%87%AA%E5%AE%9A%E4%B9%89-%E5%AE%B9%E5%99%A8" ref="nofollow noopener noreferrer">markstream-vue-docs.simonhe.me/zh/guide/co…</a></p>
<p>我们要接受emit也是同样的道理</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> vmrComponents = {
<span class="hljs-comment">// 你的一些业务组件</span>
}
<span class="hljs-title function_">setCustomComponents</span>(customIdComputed.<span class="hljs-property">value</span>, {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">vmr_container</span>: <span class="hljs-function">(<span class="hljs-params">{ node }: { node: <span class="hljs-built_in">any</span> }</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> component = props.<span class="hljs-property">vmrComponents</span>?.[node.<span class="hljs-property">name</span>] || (<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, {}, <span class="hljs-string">'unknown component'</span>))
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(component, {
      node,
      <span class="hljs-title function_">onEvent</span>(<span class="hljs-params">value: VmrComponentEvent</span>) {
        <span class="hljs-title function_">emits</span>(<span class="hljs-string">'event'</span>, value)
      },
    })
  },
})
</code></pre>
<p>因为我是将marksteam组件封装多了一层，作为公共组件，所以我就将所有业务相关的事件封装到一个emit事件里面了，然后使用ts对事件做区分，实现类型提示：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">MarkdownComponentEvent</span> = <span class="hljs-title class_">EventA</span> | <span class="hljs-title class_">EventB</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">EventA</span> {
  <span class="hljs-attr">eventName</span>: <span class="hljs-string">'a'</span>
  <span class="hljs-attr">eventValue</span>: {
    <span class="hljs-comment">// ...</span>
  }
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">EventB</span> {
  <span class="hljs-attr">eventName</span>: <span class="hljs-string">'b'</span>
  <span class="hljs-attr">eventValue</span>: {
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别密码焦虑！开源密码神器 password-XL：安全、美观、全能的私有密码管家]]></title>    <link>https://juejin.cn/post/7595053284914692136</link>    <guid>https://juejin.cn/post/7595053284914692136</guid>    <pubDate>2026-01-14T14:34:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595053284914692136" data-draft-id="7594851429163040802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别密码焦虑！开源密码神器 password-XL：安全、美观、全能的私有密码管家"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-01-14T14:34:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别密码焦虑！开源密码神器 password-XL：安全、美观、全能的私有密码管家
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T14:34:49.000Z" title="Wed Jan 14 2026 14:34:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在这个数字化的时代，我们每个人工作或者学习中都需要记住数十甚至上百个账号密码。写在文档或者纸上容易丢，使用商业密码管理器又要花钱……如果你也有这些困扰，那么今天我要介绍的这个开源项目，可能会成为你的工作生活中的管家。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/216d258b9f174af9a4cd725574407f48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006089&amp;x-signature=xufxWlAxUXphbqv0Jfzpdf%2Bccb8%3D" alt="password-xl-logo.md.png" loading="lazy"/></p>
<p>password-xl-logo.md.png</p>
<h2 data-id="heading-0">🚀 认识 password-XL：你的私有密码管家</h2>
<p><strong>password-XL</strong> 是一款 开源的密码管理工具，专注于：</p>
<ul>
<li>🔐 安全可靠：支持私有部署，数据完全由用户掌控</li>
<li>🎨 界面美观：现代化 UI，支持多端使用</li>
<li>🧩 功能丰富：覆盖个人与团队常见密码管理场景</li>
<li>🏠 部署灵活：支持官网即用、Docker、Jar、NAS 等多种部署方式</li>
</ul>
<p>无论是个人使用，还是在 NAS / 服务器中自建私有密码库，password-XL 都可以满足你的需求。</p>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpeng0105%2Fpassword-xl" target="_blank" title="https://github.com/peng0105/password-xl" ref="nofollow noopener noreferrer">github.com/peng0105/pa…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43e187bf67724dbb9e69e8359fd3fabe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006089&amp;x-signature=cjMoE%2BnQ43SR8ircSmb05XX4Hgw%3D" alt="password-xj-github.png" loading="lazy"/></p>
<p>password-xj-github.png</p>
<h2 data-id="heading-1">🐳 docker-compose部署</h2>
<p>此项目使用docker整体部署较为简单</p>
<h3 data-id="heading-2">第一步： 创建docker-compose.yml文件</h3>
<p>在服务器上创建部署目录 <code>password-xj</code>,在此目录下创建docker-compose.yml文件，内容如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">password-xl-service:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">ccr.ccs.tencentyun.com/password-xl/password-xl-service:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">password-xl-service</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9080:8080"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./data:/password-xl-service</span>
</code></pre>
<h3 data-id="heading-3">第二步： 启动容器，修改挂载目录权限</h3>
<p>在docker-compose.yml的同级目录下使用以下命令启动容器</p>
<pre><code class="hljs">docker-compose up -d
</code></pre>
<p>启动之后修改挂载目录权限</p>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">chmod</span> -R 777 ./data
</code></pre>
<p>查看启动日志</p>
<pre><code class="hljs">docker-compose logs -f
</code></pre>
<p>启动日志中有初始话的主密码和用户，需要记住，在登录的时候使用</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/435000bd32024e5b8672f51a9338e8ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006089&amp;x-signature=VTdkTNW7N0OvbF1J84eGSdJRiVs%3D" alt="password-xl-start-log.png" loading="lazy"/></p>
<p>password-xl-start-log.png</p>
<p>到此，我们的服务就部署完了</p>
<h2 data-id="heading-4">💻 使用</h2>
<p>在浏览器中打开我们的服务地址访问服务<a href="https://link.juejin.cn?target=http%3A%2F%2Fip%3Aport" target="_blank" title="http://ip:port" ref="nofollow noopener noreferrer">http://ip:port</a></p>
<h3 data-id="heading-5">登录</h3>
<p>在登录页使用私有服务登录，账号密码在启动日志中有打印 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdb4da9cdbc444e7a838308cb9da44b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006089&amp;x-signature=FHQcpCyKjwhR0TU8IDk4%2BThkm2s%3D" alt="password-xk-login.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb78f6378f05442b935fceb7db58526e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006089&amp;x-signature=5LoPuI78eO5QtBCJtTTTwKa4CRY%3D" alt="password-xj-login-serve.png" loading="lazy"/></p>
<p>password-xj-login-serve.png</p>
<p>登录之后需要设置图形密码</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/377bff09f87e4e3f83d519015c68463d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006089&amp;x-signature=c4i3CQRMkKwVaBt76U9CvuMpz0U%3D" alt="password-xl-imagep.png" loading="lazy"/></p>
<p>password-xl-imagep.png</p>
<h3 data-id="heading-6">使用</h3>
<p>正常使用较为简单，有密码和笔记</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf50c98e85f84df0bf0d505c986edb1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006089&amp;x-signature=6CNESCCfRnKBRKOHBV19mvE9m1Q%3D" alt="password-xl-padd.png" loading="lazy"/></p>
<p>password-xl-padd.png</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bc2ed80e9db4e8db869a1281f1cb72f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006089&amp;x-signature=3tF3e6fanwhPB1C0OFTGGRnKoHY%3D" alt="password-xl-list.png" loading="lazy"/></p>
<p>password-xl-list.png</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9408352e4e244811871284e07fd7eac2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006089&amp;x-signature=4ac%2FakDcLYhU8B4QvQ36rmkArL0%3D" alt="password-xl-note.png" loading="lazy"/></p>
<p>password-xl-note.png</p>
<h3 data-id="heading-7">修改用户及主密码</h3>
<p>页面上不支持修改主密码及用户，若需要修改主密码及用户，则需要修改服务挂载目录下的<code>password-xl.toml</code>文件中的信息，然后重启容器即可生效</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ec47691e281467b958834c1a287f130~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006089&amp;x-signature=zJqD1FkEY33W4zhzIWM%2BcAQnrsw%3D" alt="password-xl-puinfo.png" loading="lazy"/></p>
<p>password-xl-puinfo.png</p>
<h2 data-id="heading-8">💎结语</h2>
<p>password-XL是一款极具潜力的开源密码管理工具，它在隐私保护、成本控制和技术创新方面表现出色，特别适合对数据主权有要求的用户。</p>
<p>然而，与成熟的商业产品相比，在用户体验、生态完善度和企业功能方面仍有提升空间。对于普通用户，如果不怕折腾且重视隐私，password-XL是绝佳选择；对于追求极致便利和全面功能的企业用户，可能需要等待其进一步发展。</p>
<p>总的来说，password-XL代表着开源密码管理工具的正确方向——安全、可控、透明。 随着社区的壮大和功能的完善，它有望成为更多人信赖的密码管理解决方案。</p>
<h2 data-id="heading-9">❗❗❗ 重要安全提示</h2>
<blockquote>
<p>[!NOTE] 【重要安全提示】请务必妥善保管个人银行卡密码及重要软件密码，切勿向他人泄露或使用简单易猜的密码组合。定期更换密码，避免多账户共用同一密码。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不靠模仿的第三条路：DeepSeek 凭数学推导，为何撞上 Google 的工程直觉？]]></title>    <link>https://juejin.cn/post/7595034434976497702</link>    <guid>https://juejin.cn/post/7595034434976497702</guid>    <pubDate>2026-01-14T14:38:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595034434976497702" data-draft-id="7595030559564955699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不靠模仿的第三条路：DeepSeek 凭数学推导，为何撞上 Google 的工程直觉？"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2026-01-14T14:38:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不靠模仿的第三条路：DeepSeek 凭数学推导，为何撞上 Google 的工程直觉？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T14:38:53.000Z" title="Wed Jan 14 2026 14:38:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Google 在 2025 年 6 月推出 Gemma 3n 时，技术圈的反响截然两极。</p>
<p>工程团队为其在移动端的极致轻量化折服——2GB 内存即可运行 80 亿参数模型，多模态推理流畅如常；而学术界却对 PLE（Per-Layer Embeddings）与 AltUp 等非传统设计心存疑虑，视其为为适配硬件而强行压缩的工程捷径。</p>
<p>直到半年后，2026 年 1 月，DeepSeek 连续发布 mHC与 Engram两篇奠基性论文。</p>
<p>深入剖析其核心——U 型 Scaling Law 与流形约束（Manifold Constraints）——我们清晰看到：</p>
<p>DeepSeek 通过数学推导得出的最优架构范式，竟与 Google 半年前凭直觉构建的 Gemma 3n 形成惊人共振。</p>
<p>Gemma 3n 的 PLE，其本质正是 DeepSeek 在 Engram 中证明高效的“条件记忆”机制：将静态知识嵌入低维可查表结构，剥离推理负担；</p>
<p>Gemma 3n 的 AltUp，则在实现层面构成了 mHC 理论中“宽残差流稀疏扩展”的一个具体实例：以非对称参数更新策略，在不增加显存开销的前提下，稳定扩展信息通路。</p>
<p>这绝非偶然的趋同，而是架构演进的必然交汇。DeepSeek 的理论，为 Gemma 3n 的工程选择提供了前所未有的数学合法性。</p>
<p>Google 用直觉踩中了最优解的脉搏，而 DeepSeek 用公式还原了它的证明。</p>
<p>本文将以 DeepSeek 的新理论为透镜，解构 Gemma 3n 的黑箱设计，揭示两个顶尖团队如何在不同时间、不同路径上，共同开辟了大模型架构的第三条道路——一条不依赖纯参数堆砌，而以“记忆分离”与“约束稳定”为支柱的高效之路。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<h2 data-id="heading-0">01.静态记忆的Scaling Law</h2>
<p>Gemma 3n 架构中最引人争议的创新，体现在其 Embedding 的实现机制上。</p>
<p>与传统 Transformer 仅在输入与输出端部署 Embedding 的设计不同，Gemma 3n 为每一层都配置了独立的静态 Embedding 表（本文将这一特性命名为 PLE，Per-Layer Embeddings）。</p>
<p>据 Google 的工程阐释，此举旨在协同 NPU/CPU 的异构计算能力，借助 Conditional parameter loading 技术，将超过 2B 的 PLE 参数动态卸载至系统内存，从而确保核心的 MLP 与 Attention 模块始终在 NPU 上保持高效运行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb3238224dca4cadacaf5f2fcbd2fdee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006333&amp;x-signature=NOBEtyXJj5nF3qmOFR%2BJIlhW59I%3D" alt="图片" loading="lazy"/></p>
<p>图1. Gemma 3n 的参数分布与有效内存负载对比。</p>
<p>该图所示数据表明，借助 PLE 技术，模型能够将绝大部分参数迁移至系统内存，仅在计算单元中保留关键参数，从而达成卓越的参数利用效率。</p>
<p>DeepSeek 的 Engram 论文不仅以实证验证了该架构可显著降低内存开销，更通过结构清晰的图示，系统性地阐明了其背后的理论原型。</p>
<h3 data-id="heading-1">1.1 机理还原</h3>
<p>Engram 不是传统意义上的 N-gram 统计表，而是一个具备可微分特性的神经模块。</p>
<p>DeepSeek 在论文开篇即提出其核心思想：对经典的 N-gram 查表机制进行神经化重构，使其能够作为‌条件记忆‌（Conditional Memory）无缝嵌入深度神经网络架构之中。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c80217522a04d29982cf53d845eba00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006333&amp;x-signature=GR33C36z6J83rh%2F%2FIHmb0ApUYHw%3D" alt="图片" loading="lazy"/></p>
<p>图2. Engram 的概念模型。它展示了如何将离散的 N-gram 统计信息转化为可微的 Embedding 查找操作，从而弥补 Transformer 在知识检索上的短板。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/948e5fc889104d21a03fb902482f0df4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006333&amp;x-signature=atqgih9KFc%2FEzkc2UGEnEyGjBMQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8da59ed1c43f44aaa6ca0bea8ac09fb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006333&amp;x-signature=4xFmURTu4IuWrLnPPkaJ23ENq68%3D" alt="图片" loading="lazy"/></p>
<p>图3. Engram 模块的集成架构示意图。左侧为标准 Transformer 层（计算），右侧为 Engram 模块（存储）。</p>
<p>通过简单的查表（Lookup）和投影（Projection），静态记忆被无缝融入到神经网络的隐状态流中。这正是 Gemma 3n PLE 机制的数学解剖图。</p>
<h3 data-id="heading-2">1.2 寻找 Loss 的最低点：U 型曲线</h3>
<p>在把握架构本质后，DeepSeek 进一步凝练出 ‌Sparsity Allocation‌（稀疏分配）这一核心议题。</p>
<p>基于海量实验，DeepSeek 揭示：当模型总参数规模恒定时，‌静态记忆参数‌（Engram/PLE）与‌动态计算参数‌（MLP/Attention）之间的配比，成为左右模型表现的关键因子。</p>
<p>观测到的验证集 Loss 曲线，清晰呈现出典型的 ‌U 型 Scaling Law‌，随静态参数比例上升而先降后升。</p>
<p>量化结果指出，最优静态参数占比并非零值，而是稳定收敛于 ‌10% – 30%‌ 区间内（具体数值依总参数量而异）。</p>
<p>由此可得：将相当可观的参数资源投向“死记硬背”（查表）机制，非但未造成浪费，反而有效腾挪出神经网络的计算资源，使其更专注应对高阶逻辑推理任务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c170cb3750447f783c5bd6403e626cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006333&amp;x-signature=vG1XU7ek6F4bRgBirJiC6EkGkAk%3D" alt="图片" loading="lazy"/></p>
<p>图4. 横轴为 Engram（静态参数）占比，纵轴为 Validation Loss。</p>
<p>可以看到曲线呈现清晰的 U 型，最低点并非纯 MLP 模型，而是混合架构。这从理论上背书了 Gemma 3n 分配大量参数给 PLE 的合理性。</p>
<h3 data-id="heading-3">1.3 层级化是关键</h3>
<p>Gemma 3n 的 PLE 以分层挂载（Per-Layer）为核心设计，这一架构选择并非随意，而是源于 DeepSeek 在 Engram 论文中揭示的深层规律：他们不仅验证了可行性，更明确了实现的必要路径。</p>
<p>在 Engram 的消融实验中，插入位置被证明是性能的关键变量：</p>
<p>若将查表机制仅置于 Input Layer（Layer 0），如同传统 N-gram 模型那样，模型尚缺乏充分的语义上下文支撑有效门控（Gating），因而对整体性能的增益几乎可以忽略。</p>
<p>唯有将 Engram 置于网络中间层，借助深层架构所构建的 Context 来引导静态知识的精准检索与动态融合，方能显著压低 PPL（困惑度）。</p>
<p>这正是 Gemma 3n 必须将 PLE 复杂化、并分散部署于每一个 Transformer Block 的根本原因。</p>
<p>从计算机制上看，DeepSeek 强调 Engram 的本质优势在于上下文感知门控（Context-aware Gating）。</p>
<p>其采用了一种高效率的对数概率融合策略：直接将 Engram 查表所得的 Logits，经由门控权重加权后，线性叠加至神经网络输出的 Logits 上。</p>
<p>该设计彻底规避了繁琐的概率插值运算，与 Gemma 3n 在推理阶段“并行计算神经网络、实时查表、最终加权融合”的工程实践高度一致。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa20719c879341aaa94a7b0d6c2e761c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006333&amp;x-signature=Oc8c0i%2FTHphYvI%2BVLfN2W7YXeJw%3D" alt="图片" loading="lazy"/></p>
<p>图5. Engram 门控机制的可视化。红色区域表示门控激活，意味着模型在处理特定词组（如实体名）时，会高度依赖静态记忆表的查表结果，而非神经网络的推理</p>
<h2 data-id="heading-4">02.宽度的边界</h2>
<p>除了记忆之外，Gemma 3n 的另一显著特征是其“宽”性。为实现端侧的并行加速，业界普遍推测其采用了类似 AltUp (Alternating Updates) 的机制以拓展模型宽度。</p>
<p>尽管 DeepSeek 的 mHC 论文聚焦于更普适的超宽网络训练议题，其理论框架却精准刻画了 Gemma 3n 宽架构所遵循的设计边界。</p>
<h3 data-id="heading-5">2.1 什么是宽网络及其代价？</h3>
<p>DeepSeek 在论文开篇定义了 Hyper-Connections (HC)，这是一种打破传统残差网络（ResNet）宽度限制的架构。</p>
<p>通过极大地扩展残差流的宽度，模型可以获得极高的并行处理能力和容量。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/565dcb66a769479cbbe2671f82c1d41c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006333&amp;x-signature=zJWMB2jrErupfECLF%2B0gVqcHTyI%3D" alt="图片" loading="lazy"/></p>
<p>图6. Hyper-Connections (HC) 架构与传统残差连接的对比。</p>
<p>HC 通过大幅拓宽残差层的宽度以提升模型容量，这一策略与 Gemma 3n 致力于端侧并行计算的架构理念高度契合。</p>
<p>但 DeepSeek 揭示，该设计潜藏一项关键缺陷：当宽度过度扩张时，将扰动恒等映射（Identity Mapping）所依赖的方差稳定性。</p>
<p>若缺乏有效约束，深层网络中的信号方差将迅速膨胀，进而引发 Jacobian 矩阵奇异值分布的全面失衡。</p>
<p>下图清晰展示了这种崩塌现象。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6721d59b1dd4d2fbd7ca0125b7186b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006333&amp;x-signature=vIFHsBCt3W%2FU43R3iz9QCcNRtbA%3D" alt="图片" loading="lazy"/></p>
<p>图7. 左图显示普通宽网络随着深度增加，训练 Loss 和梯度迅速发散；右图显示引入流形约束（Manifold Constraint）后，模型训练保持稳定。</p>
<h3 data-id="heading-6">2.2 AltUp 的稀疏近似</h3>
<p>面对“宽度扩展引发的训练崩塌”这一挑战，Google 在 AltUp 论文中提出了一种极具工程智慧的规避路径。</p>
<p>为同步缓解计算负担与训练不稳的双重困境，AltUp 引入了预测-校正（Predictor-Corrector）框架。</p>
<p>它并未直接执行超宽稠密矩阵的完整运算，而是将高维向量划分为若干 Block。在每轮推理中，先通过轻量预测模块锁定活跃 Block，再仅对这些子集进行实际计算。</p>
<p>这种刻意设计的稀疏性，在工程层面构成了对残差路径能量的物理约束，从而隐式抑制了方差爆炸。这正是“因算力受限而被迫精简，却意外达成稳定提升”的典型工程悖论式突破。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/223e68eb1b87474caf5d456299348960~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006333&amp;x-signature=yWOUflwxXigchxH3RDkRORgIZ%2FM%3D" alt="图片" loading="lazy"/></p>
<p>图8. AltUp 的 Predict-and-Compute 流程示意图。原本 d 维的宽向量被隐式操作，通过扩展算子（Up-projection）和稀疏修正来模拟宽网络的效果。</p>
<h3 data-id="heading-7">2.3 mHC 的流形约束</h3>
<p>DeepSeek 主动迎向这一挑战。mHC 指出，若真欲训练稠密的超宽网络，势必要对权重矩阵施加流形约束。</p>
<p>其本质在于，将权重矩阵投影至 Stiefel 流形（）或其它特定流形，以精准调控奇异值的分布形态。</p>
<p>在论文的方法论章节中，DeepSeek 对此过程进行了系统推演：每次参数更新后，均显式引入一步投影操作（如借助 Sinkhorn-Knopp 算法实施归一化），强制将权重矩阵拉回流形约束流形。</p>
<p>该机制主动重塑了权重矩阵的几何结构，使 Jacobian 矩阵的奇异值被约束于 1 附近，从根本上重建了宽网络的恒等映射能力，显著提升训练过程的收敛稳定性。</p>
<p>DeepSeek 的洞见极具前瞻视野：AltUp 实质上是“宽网络”框架下的一种稀疏变体，而 mHC 则构建了操控“宽网络”的普适数学范式。</p>
<p>未来，我们或可彻底摒弃 AltUp 所依赖的复杂稀疏掩码机制，转而直接训练出极宽、极浅、推理效率极高的主干网络。</p>
<h2 data-id="heading-8">03.弹性推理的终局</h2>
<p>Gemma 3n 的核心技术收官之作，正是 MatFormer。</p>
<p>根据 Gemma 3n Model Overview 文档 ，Google 清晰揭示了其“套娃”架构：‌E4B 模型完整继承了 E2B 模型的所有参数‌。</p>
<p>这一架构的理论根基，源自 MatFormer 论文所提出的 ‌Matryoshka（俄罗斯套娃）范式‌——在训练过程中，不再聚焦于单一规模的模型，而是协同优化一个包含多层次嵌套子模型的超网络。</p>
<p>MatFormer 的突破性贡献，在于对 Transformer Block 内部结构的重构：它引入了‌嵌套前馈网络（Nested FFN）‌，使单个模块可动态适配不同参数规模，实现高效多粒度推理与训练。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9902efaef1b346f5b687bf8fe7c00c45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006333&amp;x-signature=MpdRjxlrEVP%2FV5ICbvJJj5v7V2Q%3D" alt="图片" loading="lazy"/></p>
<p>图9. MatFormer 的架构原理图。左侧展示了 MatFormer Block 内部的嵌套 FFN 设计，权重矩阵被物理划分为多个层级；右侧展示了训练和推理时的“Mix'n'Match”机制，即不同层级的小模型可以直接从大模型中提取出来使用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1a88ace376749db8c75898751ca4e2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769006333&amp;x-signature=6BxYec6GAi5KokS%2BTYPMV6ilavo%3D" alt="图片" loading="lazy"/></p>
<p>为了让套娃结构中的每一层都能高效运作，MatFormer 在训练中设计了一种独特的联合优化策略。</p>
<p>训练过程中，系统会随机抽取不同的子模型，并针对每个被选中的子网络单独计算损失函数。这一机制的本质，是同步最小化所有嵌套子模型（Sub-models）的总体损失。</p>
<p>该训练范式迫使模型将最基础的通用表征压缩至核心参数区域（如前数百个神经元），而将高维细节信息分配至扩展参数维度。</p>
<p>这也正是 Gemma 3n 能够实现 ‌"Select parameters and assemble models in intermediate sizes"‌，并在 2B 至 4B 参数区间内达成平滑性能伸缩的根本原因。</p>
<p>DeepSeek 的 mHC、Engram 与 Google 的 Gemma 3n，虽诞生于不同阶段，却各自独立破解了端侧 AI 不可能三角的瓶颈。</p>
<p>容量（Capacity）‌：DeepSeek mHC 通过流形约束，成功训练出超宽线性层，并结合 Google AltUp 的稀疏计算架构，化解了大容量需求与有限算力之间的冲突。</p>
<p>记忆（Memory）‌：DeepSeek Engram 展现了静态查表机制的极致效率，协同 Google PLE 的显存卸载方案，突破了海量知识存储与有限显存的限制。</p>
<p>适应性（Adaptability）‌：MatFormer 以嵌套权重结构与联合优化机制，实现了单一模型在异构硬件环境中的动态适配，弥合了模型统一性与硬件碎片化之间的鸿沟。</p>
<h2 data-id="heading-9">04.总结</h2>
<p>DeepSeek mHC 与 Engram 的问世，为行业划下了一道清晰的分水岭：参数规模的无脑扩张，正逼近其边际收益的极限。</p>
<p>Google 于 2025 年在 Gemma 3n 上实证了“计算与存储分离”在工程落地层面的可行性；而 DeepSeek 在 2026 年初，则以严谨的数学推演揭示：这条路径不仅可行，更蕴含更高的运算效率。</p>
<p>二者异曲同工，共同指向一个趋势——端侧模型的架构正经历根本性重构。它将不再依附于封闭的端到端神经网络，而是蜕变为“逻辑核心（NPU）+ 静态知识库（RAM）”这一高度协同的精密系统。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3D字体TextGeometry]]></title>    <link>https://juejin.cn/post/7595043061729165346</link>    <guid>https://juejin.cn/post/7595043061729165346</guid>    <pubDate>2026-01-14T14:42:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595043061729165346" data-draft-id="7595040803581034511" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3D字体TextGeometry"/> <meta itemprop="keywords" content="前端,WebGL,three.js"/> <meta itemprop="datePublished" content="2026-01-14T14:42:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烛阴"/> <meta itemprop="url" content="https://juejin.cn/user/950397795841032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3D字体TextGeometry
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/950397795841032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烛阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T14:42:09.000Z" title="Wed Jan 14 2026 14:42:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引入字体加载器</h2>
<p>由于 <code>TextGeometry</code> 不是核心库的一部分，我们需要单独引入：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">FontLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/examples/jsm/loaders/FontLoader.js'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TextGeometry</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/examples/jsm/geometries/TextGeometry.js'</span>;
</code></pre>
<h2 data-id="heading-1">2. 加载 JSON 字体并创建</h2>
<p>Three.js 不直接读取 <code>.ttf</code>，它读取的是专用的 JSON 字体文件。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FontLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/examples/jsm/loaders/FontLoader.js'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TextGeometry</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/examples/jsm/geometries/TextGeometry.js'</span>;
<span class="hljs-keyword">import</span> local_font <span class="hljs-keyword">from</span> <span class="hljs-string">'../../assets/font/helvetiker_bold.typeface.json'</span>;

<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-number">0x222222</span>); <span class="hljs-comment">// 深灰色背景</span>

<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">75</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>);
camera.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = <span class="hljs-number">5</span>;

<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> });
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);

<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FontLoader</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始加载字体...'</span>);

<span class="hljs-keyword">let</span> font = loader.<span class="hljs-title function_">parse</span>(local_font);
<span class="hljs-keyword">const</span> textGeometry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextGeometry</span>(<span class="hljs-string">'Hello Three.js!'</span>, {
    <span class="hljs-attr">font</span>: font,
    <span class="hljs-attr">size</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">depth</span>: <span class="hljs-number">0.5</span>,
    <span class="hljs-attr">curveSegments</span>: <span class="hljs-number">12</span>,
    <span class="hljs-attr">bevelEnabled</span>: <span class="hljs-literal">false</span>,
});

textGeometry.<span class="hljs-title function_">center</span>();

<span class="hljs-keyword">const</span> textMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshNormalMaterial</span>();
<span class="hljs-keyword">let</span> textMesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(textGeometry, textMaterial);
textMesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 确保在原点</span>
scene.<span class="hljs-title function_">add</span>(textMesh);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文字网格已添加到场景'</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">requestAnimationFrame</span>(animate);

    <span class="hljs-keyword">if</span> (textMesh) {
        textMesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.01</span>;
    }

    renderer.<span class="hljs-title function_">render</span>(scene, camera);
}
<span class="hljs-title function_">animate</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'动画循环已启动'</span>);
</code></pre>
<p>📂 <strong>核心代码与完整示例：</strong>    <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fqq790git%2Fmy-three-app.git" target="_blank" title="https://github.com/qq790git/my-three-app.git" ref="nofollow noopener noreferrer">my-three-app</a></p>
<h2 data-id="heading-2">总结</h2>
<p><strong>如果你喜欢本教程，记得点赞+收藏！关注我获取更多Three.js开发干货</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[圆满循环：Akamai 的演进如何为 AI 推理时代奠定基石]]></title>    <link>https://juejin.cn/post/7594851429162926114</link>    <guid>https://juejin.cn/post/7594851429162926114</guid>    <pubDate>2026-01-14T13:13:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594851429162926114" data-draft-id="7594813727054495778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="圆满循环：Akamai 的演进如何为 AI 推理时代奠定基石"/> <meta itemprop="keywords" content="人工智能,云计算"/> <meta itemprop="datePublished" content="2026-01-14T13:13:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AKAMAI"/> <meta itemprop="url" content="https://juejin.cn/user/829502942352628"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            圆满循环：Akamai 的演进如何为 AI 推理时代奠定基石
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/829502942352628/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AKAMAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T13:13:34.000Z" title="Wed Jan 14 2026 13:13:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着AI 推理从集中式服务器走向边缘，它正从根本上重新分配计算资源。Akamai 的架构正是为此而建：首先，我们开创了内容的交付；如今，我们正引领智能的交付。</p>
<p>凭借二十多年的经验，我们正基于同一核心理念为AI 构建未来：将推理带到更接近决策产生的地方。这是云架构演进的下一个阶段——其范围正从集中式区域扩展到分布式边缘，从而重新定义云的架构。</p>
<p>IDC 近期发布的报告《<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fresources%2Fresearch-paper%2Fidc-report-cloud-evolution%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260114_external1_blogarticles242" target="_blank" title="https://www.akamai.com/zh/resources/research-paper/idc-report-cloud-evolution?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260114_external1_blogarticles242" ref="nofollow noopener noreferrer">Akamai：驰骋云疆界——从CDN 到分布式云提供商的转型</a>》捕捉了这一转变。它追溯了我们如何从网络最初的交付先锋，演进为为AI 驱动的未来做好准备的分布式云提供商。</p>
<p>对于正在为未来发展做准备的领导者而言，这份IDC 报告值得细读。它展示了Akamai 如何一直在构建即将到来的AI 时代所需的那种分布式基础，以及我们过去的经验教训如何塑造着未来的架构。</p>
<p><strong><strong>贯穿始终的自我重塑</strong></strong></p>
<p>Akamai 诞生于万维网的第一个瓶颈期。</p>
<p>1995 年，万维网发明者Tim Berners-Lee 向麻省理工学院的研究人员提出挑战，要求找到一种更快、更智能的在线内容交付方式。我们的联合创始人 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fcompany%2Fleadership%2Fexecutive-team%2Ftom-leighton%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260114_external2_blogarticles242" target="_blank" title="https://www.akamai.com/zh/company/leadership/executive-team/tom-leighton?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260114_external2_blogarticles242" ref="nofollow noopener noreferrer">Tom Leighton</a>博士和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fcompany%2Fleadership%2Fakamai-remembers-danny-lewin%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260114_external3_blogarticles242" target="_blank" title="https://www.akamai.com/zh/company/leadership/akamai-remembers-danny-lewin?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260114_external3_blogarticles242" ref="nofollow noopener noreferrer">Danny Lewin</a> 通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-a-cdn%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260114_external4_blogarticles242" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-a-cdn?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260114_external4_blogarticles242" ref="nofollow noopener noreferrer">创建内容交付网络</a>作出了回应——这种设计在全球分布的服务器网络上复制和路由内容。它解决了当时俗称的“全球等待”问题。</p>
<p>自此，同样的原则——近则快——一直指引着我们。随着互联网的成熟，我们认识到，加速内容交付的分布式设计同样也能保护内容安全。早在<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-zero-trust-networking%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260114_external5_blogarticles242" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-zero-trust-networking?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260114_external5_blogarticles242" ref="nofollow noopener noreferrer">零信任</a>成为主流之前，我们就开始通过战略收购（如 Prolexic、Soha Systems 和 Guardicore），将业务从交付扩展到安全领域。</p>
<p>随后，在2022 年，我们对Linode 的收购将开发者友好的云计算纳入版图。IDC 称此次收购是重新定义Akamai 发展轨迹的“奠基性”时刻——一次深思熟虑的向云基础设施的转型，使我们能够运行计算工作负载，而不仅仅是交付内容。</p>
<p>从许多方面来看，这是我们演进过程中顺理成章的下一步：曾经传输内容比特的分布式网络，如今也在传输计算工作负载。</p>
<p><strong><strong>从交付到分布式云</strong></strong></p>
<p>IDC 清晰地描述了Akamai 今天的业务：三个相互关联的支柱——交付、安全和云计算。三者相辅相成，共同构成了一个集性能、防护和可扩展性于一体的统一架构。</p>
<p>这种互联性正是我们与传统超大规模提供商的不同之处。尽管大多数超大规模提供商将计算集中在少数几个大型区域数据中心，但我们一直在将计算向外延伸，将新的核心和分布式云站点直接集成到我们现有的、遍布134 个国家、超过4,400 个位置的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-edge-computing%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260114_external6_blogarticles242" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-edge-computing?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260114_external6_blogarticles242" ref="nofollow noopener noreferrer">边缘网络</a>中。</p>
<p>其结果是一个从核心到边缘无缝衔接的计算连续体，专为低延迟、高可用性和原生（而非叠加的）安全性而设计。IDC 认为，这种架构是Akamai 在边缘计算和AI 推理时代的决定性优势所在，在这个时代，毫秒之差与距离远近至关重要。</p>
<p><strong><strong>分布式为 AI 带来的优势</strong></strong></p>
<p>每一次重大的技术浪潮都会重塑基础设施：</p>
<ul>
<li>网络将数据推向边缘以实现更快访问。</li>
<li>移动将计算推向更靠近设备的位置。</li>
<li>云为追求规模而重新集中工作负载。</li>
<li>而如今，AI 为了速度、隐私和成本，正在再次将这些工作负载去中心化。</li>
</ul>
<p>从训练到推理的转变也不例外。推理工作负载要求计算更接近用户和数据源，而非局限于集中式区域。正如IDC 所指出的，这种邻近性“降低了延迟，增强了AI 应用的实时响应能力”。</p>
<p>这正是我们的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fproducts%2Fakamai-inference-cloud-platform%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260114_external7_blogarticles242" target="_blank" title="https://www.akamai.com/zh/products/akamai-inference-cloud-platform?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260114_external7_blogarticles242" ref="nofollow noopener noreferrer">Akamai 推理云</a>的构建目标。通过在边缘运行推理，我们可以降低远距离传输数据进行处理的成本和延迟。这是我们25 年来让计算更接近用户这一使命的延续。</p>
<p>这也是对AI 经济性的务实回应。</p>
<p>超大规模训练将始终占有一席之地，但随着模型投入生产——赋能聊天机器人、推荐引擎、视频智能和实时分析——推理效率将成为真正的差异化因素。我们的全球分布式网络赋予了我们天然的优势：与集中式架构相比，我们可以更快、更经济、更安全地交付这些工作负载。</p>
<p>对于任何希望大规模部署AI 应用的企业领导者而言，这种架构差异至关重要。</p>
<p><strong><strong>以差异化竞争</strong></strong></p>
<p>IDC 的报告强调，Akamai 正有意避免与超大规模提供商正面交锋。我们并非复制他们的全球区域布局和庞杂的功能目录，而是专注于我们的传统优势领域：分布式性能、可预测的定价和集成的安全。</p>
<ul>
<li><strong><strong>分布式性能：</strong></strong> 我们的全球布局使工作负载能够在更靠近用户的地方运行，为媒体、游戏和AI 推理实现个位数毫秒级的延迟。</li>
<li><strong><strong>可预测的定价：</strong></strong> 我们在内容交付方面的经验带来了极具竞争力的出站流量定价，帮助客户避免超大规模云通常带来的不断攀升的数据传输成本。</li>
<li><strong><strong>集成化安全：</strong></strong> 从<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-ddos%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260114_external8_blogarticles242" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-ddos?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260114_external8_blogarticles242" ref="nofollow noopener noreferrer">分布式拒绝服务</a>攻击缓解到<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-ztna%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260114_external9_blogarticles242" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-ztna?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260114_external9_blogarticles242" ref="nofollow noopener noreferrer">零信任网络访问</a>，内置的保护功能与计算本身如影随形。</li>
</ul>
<p>IDC 将这种模式描述为“一种专注于低延迟、高性价比和安全解决方案的差异化云体验”。换句话说，我们并非试图成为最大的云，我们正在打造的是能将AI 带到他人无法触及之处的云。</p>
<p><strong><strong>展望未来</strong></strong></p>
<p>如果说有一条主线贯穿Akamai 的历史，那就是适应。每一波技术浪潮都将我们先前奠定的基础转变为下一次跃升的跳板。</p>
<p>我们解决了网络拥塞问题，随后又利用同样的分布式架构来保障其安全。随着云计算的加入，我们开始让工作负载在更靠近用户的地方运行——为今天赋能和保护AI 的工作奠定了基础。</p>
<p>IDC 认为，这是 Akamai “独特地定位于利用边缘计算和AI 推理爆炸式增长”的一个关键原因。这证实了，坚守我们分布式的基因将持续带来回报。</p>
<p>AI 时代不会仅仅奖赏规模。它将青睐能够<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fblog%2Fcloud%2Fai-edge-all-you-need%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260114_external10_blogarticles242" target="_blank" title="https://www.akamai.com/zh/blog/cloud/ai-edge-all-you-need?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260114_external10_blogarticles242" ref="nofollow noopener noreferrer">将智能移动到任何需要之处</a>、尽可能贴近交互时刻的基础设施。这正是我们一直以来致力构建的敏捷性。</p>
<p><strong><strong>为“AI 无处不在”的未来而构建</strong></strong></p>
<p>AI 代表了一种新的计算范式。为了兑现其承诺，企业需要与其所支持的智能一样灵活的基础设施。我们在<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-a-distributed-cloud%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260114_external11_blogarticles242" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-a-distributed-cloud?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260114_external11_blogarticles242" ref="nofollow noopener noreferrer">分布式云</a>区域、开发者体验和集成安全方面的工作，正汇聚于一个共同目标：创建一个面向未来、边缘优先的平台。</p>
<p>IDC 的分析并未忽视未来的挑战——扩张的资本密集度、与超大规模提供商的认知差距，以及引导企业采用<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-multicloud%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260114_external12_blogarticles242" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-multicloud?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260114_external12_blogarticles242" ref="nofollow noopener noreferrer">多云</a>策略的复杂性。但正是我们将挑战转化为催化剂的历史，让此刻如此令人兴奋。</p>
<p>报告总结道，机遇在于“边缘AI 推理、云成本优化和统一的多云运营”——这些领域都与我们的分布式架构天然契合。</p>
<p>我们完成了一个循环：从解决“全球等待”问题，到帮助世界应对“AI无处不在”的挑战。正如从前一样，解决方案始于更靠近用户。</p>
<p><strong><strong>了解更多</strong></strong></p>
<p>阅读完整的IDC 供应商报告《Akamai：驰骋云疆界》，探索Akamai 的分布式云如何为下一代AI 应用塑造基础设施基石。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 中 computed 和 watch 的深度解析：别再用错了！]]></title>    <link>https://juejin.cn/post/7595041883145060398</link>    <guid>https://juejin.cn/post/7595041883145060398</guid>    <pubDate>2026-01-14T13:23:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595041883145060398" data-draft-id="7595041883145044014" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 中 computed 和 watch 的深度解析：别再用错了！"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-14T13:23:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 中 computed 和 watch 的深度解析：别再用错了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T13:23:36.000Z" title="Wed Jan 14 2026 13:23:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好！今天我们来聊聊 Vue.js 中两个非常重要的概念：<strong>computed</strong> 和 <strong>watch</strong>。很多 Vue 初学者甚至有一定经验的开发者，对这两个功能的使用场景和区别仍然存在困惑。</p>
<p>“什么时候用 computed？什么时候用 watch？” 这可能是 Vue 开发者最常遇到的问题之一。</p>
<h2 data-id="heading-0">一、先看一个真实场景</h2>
<p>假设我们正在开发一个电商网站，需要计算购物车总价：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 购物车数据</span>
<span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">cartItems</span>: [
      { <span class="hljs-attr">name</span>: <span class="hljs-string">'商品A'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">2</span> },
      { <span class="hljs-attr">name</span>: <span class="hljs-string">'商品B'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">1</span> }
    ],
    <span class="hljs-attr">discount</span>: <span class="hljs-number">0.9</span> <span class="hljs-comment">// 9折优惠</span>
  }
}
</code></pre>
<p>现在我们需要计算：</p>
<ol>
<li>
<ol>
<li>商品总价（单价×数量之和）</li>
</ol>
</li>
<li>
<ol start="2">
<li>折后总价</li>
</ol>
</li>
</ol>
<p>该怎么实现呢？</p>
<h2 data-id="heading-1">二、Computed（计算属性）：用于派生数据</h2>
<p><strong>computed 的核心思想：基于现有数据计算出一个新的数据值</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">computed</span>: {
  <span class="hljs-comment">// 计算商品总价</span>
  <span class="hljs-title function_">totalPrice</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cartItems</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, item</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> sum + item.<span class="hljs-property">price</span> * item.<span class="hljs-property">quantity</span>
    }, <span class="hljs-number">0</span>)
  },
  
  <span class="hljs-comment">// 计算折后价</span>
  <span class="hljs-title function_">finalPrice</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalPrice</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">discount</span>
  }
}
</code></pre>
<p><strong>computed 的特点：</strong></p>
<ol>
<li>1. <strong>声明式编程</strong>：你只需要告诉 Vue "我需要什么数据"，Vue 会自动处理依赖和更新</li>
<li>2. <strong>缓存机制</strong>：只有当依赖的数据发生变化时，才会重新计算</li>
<li>3. <strong>同步计算</strong>：适合执行同步操作</li>
<li>4. <strong>返回一个新值</strong>：必须返回一个值</li>
</ol>
<h2 data-id="heading-2">三、Watch（侦听器）：用于观察数据变化</h2>
<p><strong>watch 的核心思想：当某个数据变化时，执行特定的操作</strong></p>
<p>假设我们希望在购物车商品变化时，自动保存到本地存储：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">watch</span>: {
  <span class="hljs-comment">// 深度监听购物车变化</span>
  <span class="hljs-attr">cartItems</span>: {
    <span class="hljs-title function_">handler</span>(<span class="hljs-params">newVal, oldVal</span>) {
      <span class="hljs-comment">// 保存到本地存储</span>
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'cart'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(newVal))
      <span class="hljs-comment">// 可以发送到服务器</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveCartToServer</span>(newVal)
    },
    <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 深度监听</span>
    <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 立即执行一次</span>
  },
  
  <span class="hljs-comment">// 监听总价变化</span>
  <span class="hljs-title function_">totalPrice</span>(<span class="hljs-params">newPrice</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`总价变为：<span class="hljs-subst">${newPrice}</span>`</span>)
    <span class="hljs-keyword">if</span> (newPrice &gt; <span class="hljs-number">1000</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showDiscountTip</span>() <span class="hljs-comment">// 显示优惠提示</span>
    }
  }
}
</code></pre>
<p><strong>watch 的特点：</strong></p>
<ol>
<li>1. <strong>命令式编程</strong>：你告诉 Vue "当这个数据变化时，执行这些代码"</li>
<li>2. <strong>无缓存</strong>：每次变化都会执行</li>
<li>3. <strong>可以执行异步操作</strong>：适合 API 调用、复杂业务逻辑</li>
<li>4. <strong>不返回值</strong>：主要目的是执行副作用操作</li>
</ol>
<h2 data-id="heading-3">四、核心区别对比表</h2>








































<table><thead><tr><th>特性</th><th>computed</th><th>watch</th></tr></thead><tbody><tr><td><strong>目的</strong></td><td>派生新数据</td><td>响应数据变化</td></tr><tr><td><strong>缓存</strong></td><td>✅ 有缓存</td><td>❌ 无缓存</td></tr><tr><td><strong>返回值</strong></td><td>✅ 必须返回值</td><td>❌ 不返回值</td></tr><tr><td><strong>异步</strong></td><td>❌ 不支持异步</td><td>✅ 支持异步</td></tr><tr><td><strong>语法</strong></td><td>函数形式</td><td>对象或函数形式</td></tr><tr><td><strong>使用场景</strong></td><td>模板中的计算逻辑</td><td>数据变化时的副作用</td></tr></tbody></table>
<h2 data-id="heading-4">五、什么时候用 computed？什么时候用 watch？</h2>
<h3 data-id="heading-5">使用 computed 的场景：</h3>
<ol>
<li>
<p>1. <strong>模板中需要复杂表达式时</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 不推荐 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ cartItems.reduce((sum, item) =&gt; sum + item.price, 0) }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 推荐 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ totalPrice }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
</li>
<li>
<p>2. <strong>一个数据依赖多个数据时</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">computed: {
  fullName() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.firstName + <span class="hljs-string">' '</span> + <span class="hljs-keyword">this</span>.lastName
  }
}
</code></pre>
</li>
<li>
<p>3. <strong>需要缓存优化性能时</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 复杂计算只会在依赖变化时执行</span>
<span class="hljs-attr">computed</span>: {
  <span class="hljs-title function_">filteredList</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 假设这是很耗时的筛选操作</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">hugeList</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
  }
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-6">使用 watch 的场景：</h3>
<ol>
<li>
<p>1. <strong>数据变化时需要执行异步操作</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">watch</span>: {
  <span class="hljs-title function_">searchQuery</span>(<span class="hljs-params">newQuery</span>) {
    <span class="hljs-comment">// 防抖搜索</span>
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">searchAPI</span>(newQuery)
    }, <span class="hljs-number">500</span>)
  }
}
</code></pre>
</li>
<li>
<p>2. <strong>数据变化时需要执行复杂业务逻辑</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">watch</span>: {
  <span class="hljs-title function_">userLevel</span>(<span class="hljs-params">newLevel, oldLevel</span>) {
    <span class="hljs-keyword">if</span> (newLevel === <span class="hljs-string">'vip'</span> &amp;&amp; oldLevel !== <span class="hljs-string">'vip'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showVIPWelcome</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendVIPNotification</span>()
    }
  }
}
</code></pre>
</li>
<li>
<p>3. <strong>需要观察对象内部变化时</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">watch</span>: {
  <span class="hljs-attr">formData</span>: {
    <span class="hljs-title function_">handler</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateForm</span>()
    },
    <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>
  }
}
</code></pre>
</li>
</ol>
<h2 data-id="heading-7">六、常见误区和最佳实践</h2>
<h3 data-id="heading-8">误区1：用 watch 实现本该用 computed 的功能</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 不推荐：用 watch 计算全名</span>
<span class="hljs-keyword">data</span>() {
  <span class="hljs-keyword">return</span> {
    firstName: <span class="hljs-string">'张'</span>,
    lastName: <span class="hljs-string">'三'</span>,
    fullName: <span class="hljs-string">''</span>
  }
},
watch: {
  firstName() {
    <span class="hljs-keyword">this</span>.fullName = <span class="hljs-keyword">this</span>.firstName + <span class="hljs-keyword">this</span>.lastName
  },
  lastName() {
    <span class="hljs-keyword">this</span>.fullName = <span class="hljs-keyword">this</span>.firstName + <span class="hljs-keyword">this</span>.lastName
  }
}

<span class="hljs-comment">// ✅ 推荐：用 computed 计算全名</span>
computed: {
  fullName() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.firstName + <span class="hljs-string">' '</span> + <span class="hljs-keyword">this</span>.lastName
  }
}
</code></pre>
<h3 data-id="heading-9">误区2：在 computed 中执行副作用操作</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 不推荐：在 computed 中修改数据</span>
computed: {
  processedData() {
    <span class="hljs-comment">// 不要这样做！</span>
    <span class="hljs-keyword">this</span>.someOtherData = <span class="hljs-string">'changed'</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>.map(item =&gt; item * <span class="hljs-number">2</span>)
  }
}

<span class="hljs-comment">// ✅ 推荐：用 watch 执行副作用</span>
watch: {
  <span class="hljs-keyword">data</span>(newData) {
    <span class="hljs-keyword">this</span>.someOtherData = <span class="hljs-string">'changed'</span>
  }
}
</code></pre>
<h2 data-id="heading-10">七、性能考量</h2>
<p><strong>computed 的缓存机制</strong>是 Vue 性能优化的重要手段：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">computed</span>: {
  <span class="hljs-comment">// 假设这是一个计算量很大的函数</span>
  <span class="hljs-title function_">expensiveCalculation</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'重新计算！'</span>)
    <span class="hljs-comment">// 复杂计算...</span>
    <span class="hljs-keyword">return</span> result
  }
}
</code></pre>
<p>在模板中多次使用：</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span>&gt;{{ expensiveCalculation }}&lt;/<span class="hljs-selector-tag">div</span>&gt;
&lt;<span class="hljs-selector-tag">div</span>&gt;{{ expensiveCalculation }}&lt;/<span class="hljs-selector-tag">div</span>&gt;
&lt;<span class="hljs-selector-tag">div</span>&gt;{{ expensiveCalculation }}&lt;/<span class="hljs-selector-tag">div</span>&gt;
</code></pre>
<p>只会输出一次 "重新计算！"，因为 computed 会缓存结果。</p>
<h2 data-id="heading-11">八、组合式 API 中的使用</h2>
<p>在 Vue 3 的 Composition API 中，使用方式略有不同：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, computed, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">const</span> doubleCount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>)
    
    <span class="hljs-title function_">watch</span>(count, <span class="hljs-function">(<span class="hljs-params">newValue, oldValue</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`count从<span class="hljs-subst">${oldValue}</span>变为<span class="hljs-subst">${newValue}</span>`</span>)
    })
    
    <span class="hljs-keyword">return</span> { count, doubleCount }
  }
}
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p>记住这个简单的<strong>决策流程</strong>：</p>
<ol>
<li>1. <strong>需要基于现有数据计算一个新值吗？</strong>  → 用 <code>computed</code></li>
<li>2. <strong>需要在数据变化时执行某些操作吗？</strong>  → 用 <code>watch</code></li>
<li>3. <strong>这个计算需要在模板中简洁表达吗？</strong>  → 用 <code>computed</code></li>
<li>4. <strong>需要处理异步操作或复杂业务逻辑吗？</strong>  → 用 <code>watch</code></li>
</ol>
<p><strong>黄金法则</strong>：能用 computed 实现的，优先使用 computed；只有在需要"副作用"操作时，才使用 watch。</p>
<p>希望这篇文章能帮助你更好地理解和使用 Vue 中的 computed 和 watch！在实际开发中灵活运用这两个特性，能让你的代码更加清晰、高效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 技巧揭秘：一个事件触发多个方法，你竟然还不知道？]]></title>    <link>https://juejin.cn/post/7595021656428445723</link>    <guid>https://juejin.cn/post/7595021656428445723</guid>    <pubDate>2026-01-14T13:30:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595021656428445723" data-draft-id="7595041883145109550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 技巧揭秘：一个事件触发多个方法，你竟然还不知道？"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-14T13:30:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 技巧揭秘：一个事件触发多个方法，你竟然还不知道？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T13:30:40.000Z" title="Wed Jan 14 2026 13:30:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>解锁 v-on 的高级用法，让你的 Vue 代码更加优雅高效！</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>在 Vue 开发中，<code>v-on</code>（或 <code>@</code>）是我们最常用的指令之一。但你是否曾经遇到过这样的场景：<strong>一个按钮点击后需要执行多个操作</strong>？比如点击"提交"按钮时，既要验证表单，又要发送请求，还要显示加载状态。</p>
<p>你会怎么处理？嵌套调用？写一个包装函数？其实，Vue 早就为我们提供了更优雅的解决方案！</p>
<h2 data-id="heading-1">一、答案是肯定的：可以绑定多个方法！</h2>
<p>让我们直接看答案：<strong>Vue 的 <code>v-on</code> 确实可以绑定多个方法</strong>，而且有不止一种实现方式。</p>
<p>先来看一个最常见的需求场景：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 常见的“不优雅”做法 --&gt;
    &lt;button @click="handleSubmit"&gt;
      提交订单
    &lt;/button&gt;
    
    &lt;!-- 更优雅的多方法绑定 --&gt;
    &lt;button @click="validateForm(), submitData(), logActivity()"&gt;
      智能提交
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  methods: {
    handleSubmit() {
      // 传统方式：把所有逻辑写在一个方法里
      this.validateForm()
      this.submitData()
      this.logActivity()
    },
    
    validateForm() {
      console.log('验证表单...')
    },
    
    submitData() {
      console.log('提交数据...')
    },
    
    logActivity() {
      console.log('记录用户行为...')
    }
  }
}
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-2">二、四种实现方式详解</h2>
<h3 data-id="heading-3">方式一：直接调用多个方法（最简洁）</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;button @click="method1(), method2(), method3()"&gt;
    点击执行三个方法
  &lt;/button&gt;
&lt;/template&gt;
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>✅ 最直观，直接在模板中调用</li>
<li>✅ 可以传递参数</li>
<li>❌ 模板会显得有点"拥挤"</li>
</ul>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 传递参数 --&gt;
    &lt;button @click="
      logClick('按钮被点击了'),
      incrementCounter(1),
      sendAnalytics('button_click')
    "&gt;
      带参数的多方法调用
    &lt;/button&gt;
    
    &lt;!-- 访问事件对象 --&gt;
    &lt;button @click="
      handleClick1($event),
      handleClick2($event),
      preventDefaults($event)
    "&gt;
      使用事件对象
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  methods: {
    logClick(message) {
      console.log(message)
    },
    incrementCounter(amount) {
      this.count += amount
    },
    sendAnalytics(eventName) {
      // 发送分析数据
    },
    preventDefaults(event) {
      event.preventDefault()
    }
  }
}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-4">方式二：调用一个包装函数（最传统）</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;button @click="handleAllMethods"&gt;
    包装函数方式
  &lt;/button&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  methods: {
    handleAllMethods() {
      this.method1()
      this.method2()
      this.method3()
    },
    method1() { /* ... */ },
    method2() { /* ... */ },
    method3() { /* ... */ }
  }
}
&lt;/script&gt;
</code></pre>
<p><strong>适用场景：</strong></p>
<ul>
<li>方法之间有复杂的执行顺序</li>
<li>需要条件判断</li>
<li>需要错误处理</li>
</ul>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;
export default {
  methods: {
    async handleComplexClick() {
      // 1. 先验证
      const isValid = this.validateForm()
      if (!isValid) return
      
      // 2. 显示加载
      this.showLoading = true
      
      try {
        // 3. 执行多个异步操作
        await Promise.all([
          this.submitData(),
          this.logActivity(),
          this.updateCache()
        ])
        
        // 4. 显示成功提示
        this.showSuccess()
      } catch (error) {
        // 5. 错误处理
        this.handleError(error)
      } finally {
        // 6. 隐藏加载
        this.showLoading = false
      }
    }
  }
}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-5">方式三：使用对象语法（最灵活）</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;button v-on="{ click: [method1, method2, method3] }"&gt;
    对象语法（数组形式）
  &lt;/button&gt;
  
  &lt;!-- 或者 --&gt;
  &lt;button v-on="eventHandlers"&gt;
    对象语法（响应式对象）
  &lt;/button&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  data() {
    return {
      eventHandlers: {
        click: this.handleClick,
        mouseenter: this.handleMouseEnter,
        mouseleave: this.handleMouseLeave
      }
    }
  },
  methods: {
    handleClick() {
      this.method1()
      this.method2()
    },
    method1() { /* ... */ },
    method2() { /* ... */ }
  }
}
&lt;/script&gt;
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>✅ 可以动态绑定事件处理器</li>
<li>✅ 支持多个不同事件类型</li>
<li>✅ 适合需要动态切换事件处理逻辑的场景</li>
</ul>
<h3 data-id="heading-6">方式四：修饰符组合（最 Vue）</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 结合修饰符 --&gt;
  &lt;button @click.stop.prevent="method1(), method2()"&gt;
    带修饰符的多方法
  &lt;/button&gt;
  
  &lt;!-- 键盘事件多方法 --&gt;
  &lt;input 
    @keyup.enter="
      validateInput(),
      submitForm(),
      clearInput()
    "
    @keyup.esc="cancelEdit(), resetForm()"
  &gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-7">三、实战案例：一个完整的表单组件</h2>
<p>让我们来看一个实际的业务场景：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="smart-form"&gt;
    &lt;form @submit.prevent="handleSmartSubmit"&gt;
      &lt;input v-model="formData.email" placeholder="邮箱"&gt;
      &lt;input v-model="formData.password" type="password" placeholder="密码"&gt;
      
      &lt;button 
        type="submit"
        :disabled="isSubmitting"
        @click="
          $event.stopPropagation(),
          validateBeforeSubmit(),
          trackButtonClick('submit_button')
        "
        @mouseenter="showTooltip = true"
        @mouseleave="showTooltip = false"
      &gt;
        {{ isSubmitting ? '提交中...' : '智能提交' }}
      &lt;/button&gt;
      
      &lt;div v-if="showTooltip" class="tooltip"&gt;
        点击后执行：验证 → 提交 → 记录 → 分析
      &lt;/div&gt;
    &lt;/form&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  data() {
    return {
      formData: {
        email: '',
        password: ''
      },
      isSubmitting: false,
      showTooltip: false
    }
  },
  
  methods: {
    async handleSmartSubmit() {
      if (this.isSubmitting) return
      
      this.isSubmitting = true
      
      try {
        // 并行执行多个操作
        await Promise.all([
          this.submitToServer(),
          this.logUserActivity(),
          this.updateLocalStorage()
        ])
        
        // 串行执行后续操作
        this.showSuccessMessage()
        this.redirectToDashboard()
        this.sendAnalytics('form_submit_success')
        
      } catch (error) {
        this.handleError(error)
        this.sendAnalytics('form_submit_error', { error: error.message })
      } finally {
        this.isSubmitting = false
      }
    },
    
    validateBeforeSubmit() {
      if (!this.formData.email) {
        throw new Error('邮箱不能为空')
      }
      // 更多验证逻辑...
    },
    
    trackButtonClick(buttonName) {
      console.log(`按钮被点击: ${buttonName}`)
      // 实际项目中这里可能是发送到分析平台
    },
    
    async submitToServer() {
      // API 调用
      const response = await fetch('/api/submit', {
        method: 'POST',
        body: JSON.stringify(this.formData)
      })
      return response.json()
    },
    
    logUserActivity() {
      // 记录用户行为
      console.log('用户提交表单', this.formData)
    },
    
    updateLocalStorage() {
      // 保存到本地
      localStorage.setItem('lastSubmit', new Date().toISOString())
    },
    
    showSuccessMessage() {
      this.$emit('success', '提交成功！')
    },
    
    redirectToDashboard() {
      setTimeout(() =&gt; {
        this.$router.push('/dashboard')
      }, 1500)
    },
    
    sendAnalytics(eventName, data = {}) {
      // 发送分析数据
      console.log(`分析事件: ${eventName}`, data)
    },
    
    handleError(error) {
      console.error('提交错误:', error)
      this.$emit('error', error.message)
    }
  }
}
&lt;/script&gt;

&lt;style scoped&gt;
.smart-form {
  max-width: 400px;
  margin: 0 auto;
}

.tooltip {
  background: #f0f0f0;
  padding: 8px;
  border-radius: 4px;
  margin-top: 8px;
  font-size: 12px;
  color: #666;
}
&lt;/style&gt;
</code></pre>
<h2 data-id="heading-8">四、最佳实践和注意事项</h2>
<h3 data-id="heading-9">1. <strong>保持模板简洁</strong></h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 不推荐：模板过于复杂 --&gt;
&lt;button @click="
  validateForm($event, formData, true),
  submitForm(formData, config),
  logEvent('submit', { time: Date.now() }),
  showLoading(),
  redirectAfter(3000)
"&gt;
  提交
&lt;/button&gt;

&lt;!-- 推荐：复杂逻辑放在方法中 --&gt;
&lt;button @click="handleComplexSubmit"&gt;
  提交
&lt;/button&gt;
</code></pre>
<h3 data-id="heading-10">2. <strong>错误处理很重要</strong></h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;
export default {
  methods: {
    safeMultiMethods() {
      try {
        this.method1()
        this.method2()
        this.method3()
      } catch (error) {
        console.error('方法执行失败:', error)
        this.handleGracefully(error)
      }
    }
  }
}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-11">3. <strong>考虑执行顺序</strong></h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 注意：方法按顺序执行 --&gt;
  &lt;button @click="
    firstMethod(),  // 先执行
    secondMethod(), // 然后执行
    thirdMethod()   // 最后执行
  "&gt;
    顺序执行
  &lt;/button&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-12">4. <strong>异步方法处理</strong></h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;
export default {
  methods: {
    async handleAsyncMethods() {
      // 并行执行
      await Promise.all([
        this.asyncMethod1(),
        this.asyncMethod2()
      ])
      
      // 串行执行
      await this.asyncMethod3()
      await this.asyncMethod4()
    }
  }
}
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-13">五、性能考虑</h2>
<h3 data-id="heading-14">1. <strong>避免在模板中执行复杂计算</strong></h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 不推荐 --&gt;
&lt;button @click="
  heavyCalculation(data),
  processResults(result)
"&gt;
  执行
&lt;/button&gt;

&lt;!-- 推荐 --&gt;
&lt;button @click="handleHeavyOperations"&gt;
  执行
&lt;/button&gt;
</code></pre>
<h3 data-id="heading-15">2. <strong>使用 computed 属性减少重复调用</strong></h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;
export default {
  computed: {
    // 缓存计算结果
    processedData() {
      return this.heavyCalculation(this.data)
    }
  },
  
  methods: {
    handleClick() {
      // 直接使用缓存结果
      this.processResults(this.processedData)
      this.logAction()
    }
  }
}
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-16">六、Vue 3 中的变化</h2>
<p>在 Vue 3 的 Composition API 中，用法基本保持一致：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;button @click="method1(), method2()"&gt;
    Vue 3 多方法
  &lt;/button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'

const count = ref(0)

const method1 = () =&gt; {
  console.log('方法1')
  count.value++
}

const method2 = () =&gt; {
  console.log('方法2')
}
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-17">总结</h2>
<p><strong>v-on 绑定多个方法的四种方式：</strong></p>
<ol>
<li><strong>直接调用多个方法</strong> - 适合简单场景</li>
<li><strong>包装函数</strong> - 适合复杂逻辑和复用</li>
<li><strong>对象语法</strong> - 适合动态事件处理</li>
<li><strong>修饰符组合</strong> - 适合需要事件修饰的场景</li>
</ol>
<p><strong>选择建议：</strong></p>
<ul>
<li>简单逻辑：使用方式一（直接调用）</li>
<li>复杂业务：使用方式二（包装函数）</li>
<li>动态需求：使用方式三（对象语法）</li>
<li>事件控制：使用方式四（修饰符组合）</li>
</ul>
<p>记住，<strong>没有绝对的最佳方式，只有最适合当前场景的方式</strong>。关键是保持代码的可读性和可维护性。</p>
<p>希望这篇文章能帮助你更好地使用 Vue 的事件处理机制！如果有更多问题或技巧分享，欢迎在评论区讨论。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 设计架构演进历程]]></title>    <link>https://juejin.cn/post/7595088396440092722</link>    <guid>https://juejin.cn/post/7595088396440092722</guid>    <pubDate>2026-01-14T13:38:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595088396440092722" data-draft-id="7594822511437316122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 设计架构演进历程"/> <meta itemprop="keywords" content="Android,Android Jetpack"/> <meta itemprop="datePublished" content="2026-01-14T13:38:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jony_"/> <meta itemprop="url" content="https://juejin.cn/user/3403743732709767"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 设计架构演进历程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743732709767/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jony_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T13:38:55.000Z" title="Wed Jan 14 2026 13:38:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>Android 设计架构的演进历程：
MVC -&gt; MVP -&gt; MVVM -&gt; MVI</p>
<p>在演进的过程中具备如下特征：</p>
<ol>
<li>降低业务逻辑与 UI 层的耦合</li>
<li>数据驱动</li>
<li>单项数据流</li>
</ol>
<h2 data-id="heading-1">一、MVC</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d26d44d8b64747b6b301a2f794af9984~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9ueV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769002735&amp;x-signature=f%2BY4IKwtZEaCJ7YxyEYerEbsPPQ%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>M：Model 层，通常负责发起网络请求，数据处理</li>
<li>V：View 层，指 Activity/Fragment 等</li>
<li>C：Controller 层，处理业务逻辑，用户行为，通常来说，这一层的执行的逻辑也是放在了Activity/Fragment 中，导致 UI 层耦合严重</li>
</ol>
<p>Model 和 Controller 相互持有，Controller 层负责接收用户的行为，Model 处理网络数据，完成之后，通过 Callback 更新 UI。</p>
<h2 data-id="heading-2">二、MVP</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7d37dad035b4de098379aa383e55c0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9ueV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769002735&amp;x-signature=qRWcYMIEJdJgYYNYHKXsrUtAL6g%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>M：Model 层，通常负责发起网络请求，数据处理</li>
<li>V：View 层，指 Activity/Fragment 等</li>
<li>C：Presenter 层，负责处理用户发起的行为，这里的逻辑不再写在 Activity/Fragment 中</li>
</ol>
<p>和 MVC 的区别是，这里的业务逻辑不再写在Activity/Fragment中，另外 View 层所依赖的不再是某个具体的 Presenter 实例，而是 Presenter 抽象接口。</p>
<p>相对于 MVC，MVP 把繁重的业务逻辑从 View 层抽离出去了，同时解决了 View 层和 Model 层的直接依赖。但是由于 View 依赖了 Presenter 的大量接口，会造成后续接口冗余，大量未使用到的接口也需要实现。</p>
<ol>
<li>为什么是依赖 Presenter 接口？</li>
</ol>
<p>依赖抽象，符合设计模式的要求，在后续的扩展中，如果 View 层的 Presenter 发生变动，不需要修改 View 层原有的逻辑。</p>
<ol start="3">
<li>为什么会出现接口冗余？</li>
</ol>
<p>现假设，PresenterV1 和 PresenterV2 都实现了 IPresenter，在 V2 改版中新增的了一个接口方法，原来的 V1 版本是不是也得实现？或者是，在 V2 版本的中，已经没有 V1 中的某个逻辑了，但是由于实现了 IPresenter，在 V2 版本中就不得不实现。</p>
<h2 data-id="heading-3">三、MVVM</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/600d92d8a35c408d93977ba2baccdadb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9ueV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769002735&amp;x-signature=d9T4kWYuASwC6LHbzNCMkltUoQ8%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>M：Model 层，通常负责发起网络请求，数据处理</li>
<li>V：View 层，指 Activity/Fragment 等</li>
<li>VM：ViewModel 层，响应用户行为，通过观察者模式更新 UI</li>
</ol>
<p>彻底解耦了 View 层和逻辑层的双向持有问题，降低了内存泄漏的机率，ViewModel 层不再持有 UI 层，而是通过 LiveData 自动通知 UI 自动更新。它最大的特点便是数据驱动。</p>
<h2 data-id="heading-4">四、MVI</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c53bc12dc18412eaef3dc59c8e7f411~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9ueV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769002735&amp;x-signature=FnjZ5STos%2FxfRGRB5MKC6MMK1jE%3D" alt="image.png" loading="lazy"/></p>
<p>在 MVI 的设计架构中，</p>
<ol>
<li>V：Activity/ Fragment</li>
<li>I：指Intent，View 通过 Intent 和 ViewModel 交互，ViewModel 持有 Domain Layer（非必须），后者持有 Data Layer（Model 层）</li>
<li>M：指 Data Layer，数据层</li>
</ol>
<p>MVI 架构具有的特点是：单项数据流、Intent 驱动</p>
<p>参考文章：</p>
<p><a href="https://juejin.cn/post/7496335490577825855" target="_blank" title="https://juejin.cn/post/7496335490577825855">1. 「架构篇 1」认识 MVC / MVP / MVVM / MVI</a></p>
<p><a href="https://juejin.cn/post/7496345177129582646" target="_blank" title="https://juejin.cn/post/7496345177129582646">2. 「架构篇 2」认识 MVC / MVP / MVVM / MVI</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 的 nextTick：破解异步更新的玄机]]></title>    <link>https://juejin.cn/post/7595034434976350246</link>    <guid>https://juejin.cn/post/7595034434976350246</guid>    <pubDate>2026-01-14T13:42:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595034434976350246" data-draft-id="7595088396440141874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 的 nextTick：破解异步更新的玄机"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-14T13:42:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 的 nextTick：破解异步更新的玄机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T13:42:29.000Z" title="Wed Jan 14 2026 13:42:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、先看现象：为什么数据变了，DOM 却没更新？</h2>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;div ref="message"&gt;{{ msg }}&lt;/div&gt;
    &lt;button @click="changeMessage"&gt;点击我&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  data() {
    return { msg: '初始消息' }
  },
  methods: {
    changeMessage() {
      this.msg = '新消息'
      console.log('数据已更新:', this.msg)
      console.log('DOM内容:', this.$refs.message?.textContent) // 还是'初始消息'！
    }
  }
}
&lt;/script&gt;
</code></pre>
<p><strong>执行结果：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">数据已更新: 新消息</span>
<span class="hljs-section">DOM内容: 初始消息  ← 问题在这里！</span>
</code></pre>
<p>数据明明已经改了，为什么 DOM 还是旧值？这就是 <code>nextTick</code> 要解决的问题。</p>
<h2 data-id="heading-1">二、核心原理：Vue 的异步更新队列</h2>
<p>Vue 的 DOM 更新是<strong>异步</strong>的。当你修改数据时，Vue 不会立即更新 DOM，而是：</p>
<ol>
<li><strong>开启一个队列</strong>，缓冲同一事件循环中的所有数据变更</li>
<li><strong>移除重复的 watcher</strong>，避免不必要的计算</li>
<li><strong>下一个事件循环</strong>中，刷新队列并执行实际 DOM 更新</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue 内部的简化逻辑</span>
<span class="hljs-keyword">let</span> queue = []
<span class="hljs-keyword">let</span> waiting = <span class="hljs-literal">false</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">queueWatcher</span>(<span class="hljs-params">watcher</span>) {
  <span class="hljs-comment">// 1. 去重</span>
  <span class="hljs-keyword">if</span> (!queue.<span class="hljs-title function_">includes</span>(watcher)) {
    queue.<span class="hljs-title function_">push</span>(watcher)
  }
  
  <span class="hljs-comment">// 2. 异步执行</span>
  <span class="hljs-keyword">if</span> (!waiting) {
    waiting = <span class="hljs-literal">true</span>
    <span class="hljs-title function_">nextTick</span>(flushQueue)
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">flushQueue</span>(<span class="hljs-params"/>) {
  queue.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">watcher</span> =&gt;</span> watcher.<span class="hljs-title function_">run</span>())
  queue = []
  waiting = <span class="hljs-literal">false</span>
}
</code></pre>
<h2 data-id="heading-2">三、nextTick 的本质：微任务调度器</h2>
<p><code>nextTick</code> 的核心任务：<strong>在 DOM 更新完成后执行回调</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue 2.x 中的 nextTick 实现（简化版）</span>
<span class="hljs-keyword">let</span> callbacks = []
<span class="hljs-keyword">let</span> pending = <span class="hljs-literal">false</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">nextTick</span>(<span class="hljs-params">cb</span>) {
  callbacks.<span class="hljs-title function_">push</span>(cb)
  
  <span class="hljs-keyword">if</span> (!pending) {
    pending = <span class="hljs-literal">true</span>
    
    <span class="hljs-comment">// 优先级：Promise &gt; MutationObserver &gt; setImmediate &gt; setTimeout</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Promise</span> !== <span class="hljs-string">'undefined'</span>) {
      <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(flushCallbacks)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">MutationObserver</span> !== <span class="hljs-string">'undefined'</span>) {
      <span class="hljs-comment">// 用 MutationObserver 模拟微任务</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">setTimeout</span>(flushCallbacks, <span class="hljs-number">0</span>)
    }
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">flushCallbacks</span>(<span class="hljs-params"/>) {
  pending = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">const</span> copies = callbacks.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>)
  callbacks.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>
  copies.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>())
}
</code></pre>
<h2 data-id="heading-3">四、四大核心使用场景</h2>
<h3 data-id="heading-4">场景1：获取更新后的 DOM</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;
export default {
  methods: {
    async updateAndLog() {
      this.msg = '更新后的消息'
      
      // ❌ 错误：此时 DOM 还未更新
      console.log('同步获取:', this.$refs.message.textContent)
      
      // ✅ 正确：使用 nextTick
      this.$nextTick(() =&gt; {
        console.log('nextTick获取:', this.$refs.message.textContent)
      })
      
      // ✅ 更优雅：async/await 版本
      this.msg = '另一个消息'
      await this.$nextTick()
      console.log('await获取:', this.$refs.message.textContent)
    }
  }
}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-5">场景2：操作第三方 DOM 库</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div ref="chartContainer"&gt;&lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import echarts from 'echarts'

export default {
  data() {
    return { data: [] }
  },
  
  async mounted() {
    // ❌ 错误：容器可能还未渲染
    // this.chart = echarts.init(this.$refs.chartContainer)
    
    // ✅ 正确：确保 DOM 就绪
    this.$nextTick(() =&gt; {
      this.chart = echarts.init(this.$refs.chartContainer)
      this.renderChart()
    })
  },
  
  methods: {
    async updateChart(newData) {
      this.data = newData
      
      // 等待 Vue 更新 DOM 和图表数据
      await this.$nextTick()
      
      // 此时可以安全操作图表实例
      this.chart.setOption({
        series: [{ data: this.data }]
      })
    }
  }
}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-6">场景3：解决计算属性依赖问题</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;
export default {
  data() {
    return {
      list: [1, 2, 3],
      newItem: ''
    }
  },
  
  computed: {
    filteredList() {
      // 依赖 list 的变化
      return this.list.filter(item =&gt; item &gt; 1)
    }
  },
  
  methods: {
    async addItem(item) {
      this.list.push(item)
      
      // ❌ filteredList 可能还未计算完成
      console.log('列表长度:', this.filteredList.length)
      
      // ✅ 确保计算属性已更新
      this.$nextTick(() =&gt; {
        console.log('正确的长度:', this.filteredList.length)
      })
    }
  }
}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-7">场景4：优化批量更新性能</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 批量操作示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">batchUpdate</span>(<span class="hljs-params">items</span>) {
  <span class="hljs-comment">// 开始批量更新</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">updating</span> = <span class="hljs-literal">true</span>
  
  <span class="hljs-comment">// 所有数据变更都在同一个事件循环中</span>
  items.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataList</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">processItem</span>(item))
  })
  
  <span class="hljs-comment">// 只触发一次 DOM 更新</span>
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$nextTick()
  
  <span class="hljs-comment">// 此时 DOM 已更新完成</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">updating</span> = <span class="hljs-literal">false</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showCompletionMessage</span>()
  
  <span class="hljs-comment">// 继续其他操作</span>
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$nextTick()
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">triggerAnimation</span>()
}
</code></pre>
<h2 data-id="heading-8">五、性能陷阱与最佳实践</h2>
<h3 data-id="heading-9">陷阱1：嵌套的 nextTick</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 性能浪费：创建多个微任务</span>
<span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 操作1</span>
  <span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 操作2</span>
    <span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 操作3</span>
    })
  })
})

<span class="hljs-comment">// ✅ 优化：合并到同一个回调中</span>
<span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 操作1</span>
  <span class="hljs-comment">// 操作2  </span>
  <span class="hljs-comment">// 操作3</span>
})
</code></pre>
<h3 data-id="heading-10">陷阱2：与宏任务混用</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 顺序不可控</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">msg</span> = <span class="hljs-string">'更新'</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">message</span>.<span class="hljs-property">textContent</span>)
}, <span class="hljs-number">0</span>)

<span class="hljs-comment">// ✅ 明确使用 nextTick</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">msg</span> = <span class="hljs-string">'更新'</span>
<span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">message</span>.<span class="hljs-property">textContent</span>)
})
</code></pre>
<h3 data-id="heading-11">最佳实践：使用 async/await</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">methods</span>: {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">reliableUpdate</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 更新数据</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>()
    
    <span class="hljs-comment">// 2. 等待 DOM 更新</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$nextTick()
    
    <span class="hljs-comment">// 3. 操作更新后的 DOM</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">scrollToBottom</span>()
    
    <span class="hljs-comment">// 4. 如果需要，再次等待</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$nextTick()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">triggerAnimation</span>()
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">'更新完成'</span>
  }
}
</code></pre>
<h2 data-id="heading-12">六、Vue 3 的变化与优化</h2>
<p>Vue 3 的 <code>nextTick</code> 更加精简高效：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue 3 中的使用</span>
<span class="hljs-keyword">import</span> { nextTick } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 方式1：回调函数</span>
<span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'DOM 已更新'</span>)
})

<span class="hljs-comment">// 方式2：Promise</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'DOM 已更新'</span>)

<span class="hljs-comment">// 方式3：Composition API</span>
<span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    state.<span class="hljs-property">value</span> = <span class="hljs-string">'新值'</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>()
    <span class="hljs-comment">// 操作 DOM</span>
  }
  
  <span class="hljs-keyword">return</span> { handleClick }
}
</code></pre>
<p><strong>Vue 3 的优化：</strong></p>
<ul>
<li>使用 <code>Promise.resolve().then()</code> 作为默认策略</li>
<li>移除兼容性代码，更小的体积</li>
<li>更好的 TypeScript 支持</li>
</ul>
<h2 data-id="heading-13">七、源码级理解</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue 2.x nextTick 核心逻辑</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">nextTick</span>(<span class="hljs-params">cb, ctx</span>) {
  <span class="hljs-keyword">let</span> _resolve
  
  <span class="hljs-comment">// 1. 将回调推入队列</span>
  callbacks.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (cb) {
      <span class="hljs-keyword">try</span> {
        cb.<span class="hljs-title function_">call</span>(ctx)
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-title function_">handleError</span>(e, ctx, <span class="hljs-string">'nextTick'</span>)
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_resolve) {
      <span class="hljs-title function_">_resolve</span>(ctx)
    }
  })
  
  <span class="hljs-comment">// 2. 如果未在等待，开始异步执行</span>
  <span class="hljs-keyword">if</span> (!pending) {
    pending = <span class="hljs-literal">true</span>
    <span class="hljs-title function_">timerFunc</span>() <span class="hljs-comment">// 触发异步更新</span>
  }
  
  <span class="hljs-comment">// 3. 支持 Promise 链式调用</span>
  <span class="hljs-keyword">if</span> (!cb &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Promise</span> !== <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
      _resolve = resolve
    })
  }
}
</code></pre>
<h2 data-id="heading-14">八、实战：手写简易 nextTick</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyVue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span> = []
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pending</span> = <span class="hljs-literal">false</span>
  }
  
  $nextTick(cb) {
    <span class="hljs-comment">// 返回 Promise 支持 async/await</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">wrappedCallback</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">if</span> (cb) <span class="hljs-title function_">cb</span>()
        <span class="hljs-title function_">resolve</span>()
      }
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span>.<span class="hljs-title function_">push</span>(wrappedCallback)
      
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">pending</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">pending</span> = <span class="hljs-literal">true</span>
        
        <span class="hljs-comment">// 优先使用微任务</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Promise</span> !== <span class="hljs-string">'undefined'</span>) {
          <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flushCallbacks</span>())
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flushCallbacks</span>(), <span class="hljs-number">0</span>)
        }
      }
    })
  }
  
  <span class="hljs-title function_">flushCallbacks</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pending</span> = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">const</span> copies = <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span>.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>
    copies.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>())
  }
  
  <span class="hljs-comment">// 模拟数据更新</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">setData</span>(<span class="hljs-params">key, value</span>) {
    <span class="hljs-variable language_">this</span>[key] = value
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$nextTick()
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`DOM 已更新: <span class="hljs-subst">${key}</span> = <span class="hljs-subst">${value}</span>`</span>)
  }
}
</code></pre>
<h2 data-id="heading-15">总结</h2>
<h3 data-id="heading-16">nextTick 的三层理解：</h3>
<ol>
<li><strong>表象层</strong>：在 DOM 更新后执行代码</li>
<li><strong>原理层</strong>：Vue 异步更新队列的调度器</li>
<li><strong>实现层</strong>：基于 JavaScript 事件循环的微任务管理器</li>
</ol>
<h3 data-id="heading-17">使用原则：</h3>
<ol>
<li><strong>需要访问更新后的 DOM 时，必须用 nextTick</strong></li>
<li><strong>操作第三方库前，先等 Vue 更新完成</strong></li>
<li><strong>批量操作后，用 nextTick 统一处理副作用</strong></li>
<li><strong>优先使用 async/await 语法，更清晰直观</strong></li>
</ol>
<h3 data-id="heading-18">一句话概括：</h3>
<p><strong>nextTick 是 Vue 给你的一个承诺："等我把 DOM 更新完，再执行你的代码"。</strong></p>
<p>记住这个承诺，你就能完美掌控 Vue 的更新时机。</p>
<hr/>
<p><strong>思考题：</strong>
如果连续修改同一个数据 1000 次，Vue 会触发多少次 DOM 更新？
（答案：得益于 nextTick 的队列机制，只会触发 1 次）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app使用html5+创建webview，可以控制窗口大小、显隐、与uni通信]]></title>    <link>https://juejin.cn/post/7594863660297994282</link>    <guid>https://juejin.cn/post/7594863660297994282</guid>    <pubDate>2026-01-14T11:03:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594863660297994282" data-draft-id="7594262760939700258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app使用html5+创建webview，可以控制窗口大小、显隐、与uni通信"/> <meta itemprop="keywords" content="前端,Trae"/> <meta itemprop="datePublished" content="2026-01-14T11:03:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李剑一"/> <meta itemprop="url" content="https://juejin.cn/user/4147782344247918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app使用html5+创建webview，可以控制窗口大小、显隐、与uni通信
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4147782344247918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李剑一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T11:03:25.000Z" title="Wed Jan 14 2026 11:03:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近使用 uni-app 开发安卓端的 App，因为要嵌入一个原本已经开发完的系统，打算使用 web-view 的方式进行嵌入。</p>
<p>因为项目工期比较紧，所以是两个前端并行开发，最后再合到一起。</p>
<p>结果就是这个过程中出问题了...</p>
<h2 data-id="heading-0">需求</h2>
<p>需求方面是：</p>
<p><code>A同学</code>负责通讯方面的工作，所以页面应该在首页加载的时候就被挂载上去，这样一来启动系统的时候就注册了通讯模块，不影响收发信息。</p>
<p><code>B同学</code>负责其他部分，在首页展示系统内部的统计数据，可以算是一个安卓端的简易大屏。</p>
<p>原本<code>A同学</code>的方案是在系统页面上创建一个 <code>web-view</code>，然后嵌入系统。这样一来也不影响B同学开发新系统。</p>
<h2 data-id="heading-1">问题</h2>
<p>结果整合代码的时候才发现，<code>web-view</code>标签 是<strong>自动铺满整个页面</strong>的，而且是<strong>无法隐藏</strong>的。</p>
<p>这就尴尬了，App进来以后直接看到的就是 <code>A同学</code>的通讯页面，无法看到<code>B同学</code>的大屏了。</p>
<p>问题抛到了我手里，我经过一番简单的调研，再加上一顿猛如虎的操作，又通过 <strong>Trae</strong> 一顿AI，最后回复他们说：<strong>无解</strong>！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43f8dfd3e0884546ab40824d14f7de63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5YmR5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768993404&amp;x-signature=lUwkIJyI5td7ffl7BJad83W77OI%3D" alt="image.png" loading="lazy"/></p>
<p>对此 <strong>Trae</strong> 给出的原因是：uni-app 中内置的 <code>web-view</code> 标签本身没有隐藏的API，在 web-view 标签外增加 view 标签，绑定 <code>v-show</code> 方法不生效。</p>
<p>只能绑定 <code>v-if</code> 生效，但是绑定 <code>v-if=false</code> 的时候相当于 web-view 直接被<strong>销毁</strong>了，会导致通讯模块收不到信息。</p>
<h2 data-id="heading-2">解决</h2>
<p>好在天无绝人之路，uni-app 官方文档中表示：在 html5+ 中其实存在 web-view 的 API，能够操作窗口的大小。</p>
<p>那么既然能够操作窗口的大小，肯定也能够控制显隐。</p>
<p>于是乎我使用 <strong>Trae</strong> 让他使用 html5+ 中的 <code>create</code> 方法创建 web-view，并给出完整的解决方案。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createWebView</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> that = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewIns</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewIns</span> = plus.<span class="hljs-property">webview</span>.<span class="hljs-title function_">create</span>(
        <span class="hljs-string">'http://192.168.25.110'</span>,
        <span class="hljs-string">'1008610010'</span> <span class="hljs-comment">// ID（必须唯一）</span>
        {
            <span class="hljs-attr">top</span>: <span class="hljs-string">'24px'</span>,
            <span class="hljs-attr">bottom</span>: <span class="hljs-string">'0px'</span>,
            <span class="hljs-attr">width</span>: <span class="hljs-string">'300px'</span>,
            <span class="hljs-attr">height</span>: <span class="hljs-string">'600px'</span>,
            <span class="hljs-attr">scrollIndicator</span>: <span class="hljs-string">'none'</span>,
            <span class="hljs-attr">scalable</span>: <span class="hljs-literal">false</span>
        }
    );

    <span class="hljs-comment">// 设置页面默认隐藏</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewIns</span>.<span class="hljs-title function_">hide</span>();
}
</code></pre>
<p>这时候已经成功创建了 web-view 并且处于隐藏状态，不耽误传参。</p>
<p>但是又遇到了一个问题，web-view无法与uni-app<strong>通信</strong>。</p>
<p>Trae 先给出了 uni-app 官方提供的方法，使用 <code>uni.postMessage</code> 方法，但是在通讯系统中插入了这个方法以后，不报错，并且显示发送消息成功，但uni-app 这边却无法接收到。</p>
<p>Trae 又使用 <code>evalJS</code> 方法插入相应的脚本，但是也没有反应。同样是发送成功，但是接收不到。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0b779ce4c0a4794bd4cdced445bdf0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5YmR5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768993404&amp;x-signature=wYXK%2FZQTfX9bGYH%2B5khBzLiAuOE%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<p>两种方案均不可用，我又详细看了看 uni-app 的官方文档，让 Trae 分析 web-view 标签上绑定的 <code>@message</code> 方法应该是经过特殊封装的，能够捕获到 view-view 内使用 <code>uni.postMessage</code> 方法发送的数据。</p>
<p>Trae给出的解释是：由于我现在使用 <code>plus.web-view.create</code> 创建窗口，绕过了uni-app 所以即便是绑定 <code>message</code> 也无效了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b0c925c31d3435ab879f6a3908f9626~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5YmR5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768993404&amp;x-signature=Z%2B%2Fx0VnhbT5iKgYi9Gqpbs1TiiU%3D" alt="image.png" loading="lazy"/></p>
<p>所以采用 html+ 原生方法发送数据，在 web-view 中使用 <code>plus.webview.postMessageToUniNView</code> 方法发送数据。</p>
<p>在 uni-app 端使用 <code>plus.globalEvent.addEventListener</code> 接收数据。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 发送数据</span>
<span class="hljs-title function_">pushMessage</span>(<span class="hljs-params"/>) {
    plus.<span class="hljs-property">webview</span>.<span class="hljs-title function_">postMessageToUniNView</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'tpUniAPP'</span>,
        <span class="hljs-attr">args</span>: {
            <span class="hljs-attr">args1</span>: <span class="hljs-string">'test123'</span>
        }
    }, <span class="hljs-string">'__uniapp__service'</span>);
}
</code></pre>
<p>接收数据方法写在 <code>createWebView</code> 方法内。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 接收数据</span>
<span class="hljs-title function_">createWebView</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> that = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewIns</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 创建一个新的 WebView</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewIns</span> = plus.<span class="hljs-property">webview</span>.<span class="hljs-title function_">create</span>(
        ...
    );
    
    <span class="hljs-comment">// web-view加载完成</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewIns</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'loaded'</span>, <span class="hljs-function">() =&gt;</span> {
        plus.<span class="hljs-property">globalEvent</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'plusMessage'</span>, <span class="hljs-function">(<span class="hljs-params">message</span>)=&gt;</span>{
            <span class="hljs-keyword">let</span> data = message?.<span class="hljs-property">data</span>?.<span class="hljs-property">args</span>?.<span class="hljs-property">data</span>;
            <span class="hljs-keyword">if</span>(data?.<span class="hljs-property">name</span> === <span class="hljs-string">'postMessage'</span>) {
                <span class="hljs-keyword">if</span> (data?.<span class="hljs-property">arg</span>?.<span class="hljs-property">type</span> === <span class="hljs-string">'show'</span>) {
                    <span class="hljs-comment">// 显示</span>
                    that.<span class="hljs-property">webviewIns</span>.<span class="hljs-title function_">show</span>();
                }
                <span class="hljs-keyword">if</span> (data?.<span class="hljs-property">arg</span>?.<span class="hljs-property">type</span> === <span class="hljs-string">'hide'</span>) {
                    <span class="hljs-comment">// 隐藏</span>
                    that.<span class="hljs-property">webviewIns</span>.<span class="hljs-title function_">hide</span>();
                }
            }
        })
    });
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewIns</span>.<span class="hljs-title function_">hide</span>();
},
</code></pre>
<h2 data-id="heading-3">结论</h2>
<p>目前主要解决了两个问题：</p>
<ol>
<li>web-view 大小、显隐不可控问题。</li>
<li>web-view 与 uni-app 通信问题。</li>
</ol>
<p>发送数据方法可以卸载 Pinia 的公共方法中，或者使用 EventBus，统一处理。</p>
<p>Ps: 第二个问题解决方案不是太优雅，如果有兄弟有更好的方案可以分享一下。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SFT、RAG 调优效率翻倍！垂直领域大模型评估实战指南]]></title>    <link>https://juejin.cn/post/7594791357144383530</link>    <guid>https://juejin.cn/post/7594791357144383530</guid>    <pubDate>2026-01-14T11:29:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594791357144383530" data-draft-id="7594791357144367146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SFT、RAG 调优效率翻倍！垂直领域大模型评估实战指南"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-14T11:29:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ConardLi"/> <meta itemprop="url" content="https://juejin.cn/user/3949101466785709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SFT、RAG 调优效率翻倍！垂直领域大模型评估实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3949101466785709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ConardLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T11:29:48.000Z" title="Wed Jan 14 2026 11:29:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本期视频教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1CRrVB7Eb4%2F" target="_blank" title="https://www.bilibili.com/video/BV1CRrVB7Eb4/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1CR…</a></p>
<hr/>
<ul>
<li>如何评估模型在垂直领域下的表现？</li>
<li>如何评估模型微调前后的效果？</li>
<li>如何量化 RAG 系统的召回率？</li>
<li>如何从领域知识创建模型评估数据集？</li>
</ul>
<hr/>
<p>大家好，欢迎来到 code秘密花园，我是花园老师（ConardLi）。</p>
<p>现在大家都在搞大模型落地，不管是做 RAG（检索增强生成）还是 SFT（监督微调），最让开发者头秃的其实不是 “怎么训练”，而是 “怎么知道训练得好不好”。</p>
<p>在上一期教程：《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FkQIcb6gggF5wf08qjuJcyQ" target="_blank" title="https://mp.weixin.qq.com/s/kQIcb6gggF5wf08qjuJcyQ" ref="nofollow noopener noreferrer">世界最顶级的大模型，都在 PK 些啥？ （大模型评估完全指南）</a>》 中，我们主要介绍了大模型评估的核心流程和业界主流的一些通用 Benchmark（基准测试）。</p>
<p>这些基准一般都用于通用大模型的能力测试，榜单（像 <code>MMLU、ARC</code> ）分数再高，一旦用到具体的业务场景，比如法律合同审核、医疗报告分析、或者公司内部的维修手册，这些通用分数的参考意义就非常有限了。</p>
<p>今天我们就来聊聊，在垂直领域，我们具体应该怎么评估模型的表现？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f69bc972fa7478ab01abdb07c742366~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=7M2e%2FogNyaJjTylym0fMHqIg%2FVM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">第一部分：理论篇</h2>
<h3 data-id="heading-1">1. 为什么通用评估不够用？</h3>
<p>通用模型往往在公开互联网语料上表现良好，但对于企业内部文档、未公开的行业规范等“长尾知识”表现不佳，必须进行专项评估。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84026c8ee4e0426ba5e19741619e7124~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=EBPd5Wf%2FHmUhTzEnbY%2BWJYBTWzI%3D" alt="" loading="lazy"/></p>
<p>我们在实际业务中，评估模型通常是为了解决三个很具体的问题：</p>
<ul>
<li>
<p><strong>选型心里没底：</strong>
开源模型那么多（Qwen, DeepSeek, MiniMax...），在没微调之前，谁对我的业务文档理解能力更强？如果不跑一遍自己的数据，盲选很容易踩坑。</p>
</li>
<li>
<p><strong>微调效果验证（SFT）：</strong>
你花钱花时间微调了一个模型，Loss 曲线看着挺好，但模型真的变聪明了吗？还是说它只是记住了训练集？更糟糕的是，它会不会学会了专业知识，却把通用的对话能力搞丢了（灾难性遗忘）？这需要对比测试才知道。</p>
</li>
<li>
<p><strong>RAG 系统的“甩锅”依据：</strong>
在检索增强生成（RAG）架构中，模型是否准确利用了检索到的上下文？是否存在幻觉？这需要针对性的评估指标。</p>
</li>
</ul>
<h3 data-id="heading-2">2. 主流的评估方法</h3>
<p>传统的垂直领域评估通常需要 “懂行的人” 来阅卷。但是，行业专家的工作时间是极其昂贵的，几十条数据还能看，成千上万条数据靠纯人工就不太现实了。</p>
<p>而且人的主观标准变动很大，例如，一个文案是“准确”还是“生动”？这种主观性会导致评估结果波动大，难以作为模型对比的硬指标。</p>
<p>在真实的业务场景中，模型在特定领域表现的评估通常靠以下几类评估方法：</p>
<h4 data-id="heading-3">方案一：确定性评估</h4>
<p>标准答案和模型回答的完全匹配是最直接、成本最低的方式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7de01379e7b546968b719cee7290a5a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=3QdSqpHJSuGqgYafLeWuGKLy41g%3D" alt="" loading="lazy"/></p>
<p>这类评估只能限制在某些特定的题目类型上，就像我们在考试的时候做的判断题、单选题、多选题。</p>
<p>它们的答案是固定的，非黑即白，是否得分还是很好评估的。</p>
<p>但是，此类数据集的制定还是有一定成本的，通用评估集（如 MMLU）涵盖面广但深度不足。针对特定业务的、包含标准答案的高质量题库非常稀缺，往往需要资深专家手工编写，效率极低。</p>
<h4 data-id="heading-4">方案二：基于统计的文本相似度</h4>
<p>比如我们经常听到的 <code>BLEU</code>、<code>ROUGE</code>、<code>METEOR</code> 这些指标是自然语言处理（NLP）领域最常用的自动文本生成评估指标，核心作用是量化机器生成文本（如翻译、摘要、对话回复）与人工标注的参考文本之间的相似度，判断生成结果的质量。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51db7177823d45b0a02541728013814c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=kC4vu%2BGUp6bYI86CgS9oGbsMtUg%3D" alt="" loading="lazy"/></p>
<p>这类指标计算的本质上都是生成文本与参考文本的词汇重叠度。在 LLM 时代，意思相同但表达方式不同的情况是非常普遍的（标准答案是 “利率上调”，模型回答 “加息”。字面上没重合，得分很低，但意思完全一样。），所以参考价值不大了。</p>
<p>在垂直领域知识评估中，这类指标的权重正在被大幅降低，因为它们很容易误杀好模型。</p>
<h4 data-id="heading-5">方案三：基于模型的语义评估</h4>
<p>也就是我们上期教程中提到的 <code>LLM as a Judge</code>。</p>
<p>这是目前搞开放式问答的最优解。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0321e2150ece4d14adc588feb6a9bf0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=em%2FNcB21L%2FUXEALvFwE9RIp2tu4%3D" alt="" loading="lazy"/></p>
<p>核心逻辑：用一个更强、更聪明的模型（比如 <code>GPT-5</code>）当裁判，去给业务模型（比如 <code>Qwen3-7B</code> 的小模型）打分。</p>
<p>此类评估的关键不在流程，而是评分细则（Prompt），不同类型的数据集通常需要制定特定的评估标准。</p>
<h3 data-id="heading-6">3. 真实工作中面临的痛点</h3>
<p>在真实的评估工作中，我们往往面临着以下痛点：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a07537b47624439a38612a0b6d689d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=GdOHQ1UlNgcM0X8H%2Bl0USGEOA3Y%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>测试集难构造：和模型微调训练面临的问题一样，企业里有海量的 PDF 手册、Markdown 技术文档，但没有现成的 QA 对（问答对）。要评估模型，首先得把非结构化的文档变成结构化的测试集。</p>
</li>
<li>
<p>定性容易，定量难：大家常说“这个模型感觉比那个好”。但在工程上，“感觉”是不值钱的。我们需要具体的指标 — 是召回率提升了？还是幻觉率下降了？所以我们需要一套可量化的指标，并且可以直观的观测。</p>
</li>
<li>
<p>自动化与人工的割裂：完全靠人工测，测不动；完全靠脚本测，不准（尤其是长文本生成）。如何把 “自动化的规模” 和 “人工的精准” 结合起来，是一个普遍性难题。</p>
</li>
</ul>
<h2 data-id="heading-7">第二部分：实战篇</h2>
<p>在实战章节，我们将使用一款工具（<code>Easy Dataset</code>）解决以上痛点。</p>
<blockquote>
<p>Easy Dataset 是一个专为创建大型语言模型数据集而设计的应用程序。通过 Easy Dataset，你可以将领域知识转化为结构化数据集，兼容所有遵循 OpenAI 格式的 LLM API，使数据集构造过程变得简单高效：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FConardLi%2Feasy-dataset%2F" target="_blank" title="https://github.com/ConardLi/easy-dataset/" ref="nofollow noopener noreferrer">github.com/ConardLi/ea…</a></p>
</blockquote>
<p>在，<code>Easy Dataset</code> 的 1.7.0 版本，支持了全新的 “评估” 模块，能够做到 <strong>自动化生成测试集</strong> + <strong>低成本的创建评估任务</strong> + <strong>可视化的评估结果</strong>。</p>
<h3 data-id="heading-8">1.评估数据集（测试集）生成</h3>
<blockquote>
<p><strong>评估数据集是什么？</strong></p>
<ul>
<li>评估数据集（测试集）是一组“题目 + 标准答案/参考答案 + 评分规则/选项”的集合。你可以用它来：做不同模型的对比评估，长期追踪效果变化。</li>
</ul>
</blockquote>
<h4 data-id="heading-9">题目类型</h4>
<p>一个好的模型评估数据集（测试集）是衡量模型真实能力的基石。在 <code>Easy Dataset</code> 中，评估集不仅仅是问题的集合，更是包含标准答案、考点标签和业务逻辑的综合知识库。</p>
<p>为了全面考察模型能力，我们设计了五种题型：</p>
<ul>
<li><strong>判断题：</strong>
这是最直接的。考察模型对核心事实是否搞混。比如文档里说“温度不能超过 100 度”，题目问“温度是否可以达到 105 度？”，能有效检测幻觉。</li>
<li><strong>单选题：</strong>
4个选项（A-D），单选答案 | 考察模型在干扰项下的知识提取和辨析能力。</li>
<li><strong>多选题：</strong>
多个选项，答案为字母数组（如 <code>["A", "C"]</code>） | 极具挑战性，漏掉一个信息点就选不对。</li>
<li><strong>简答题（短答案）：</strong>
提供标准短答案（20字以内），可测试模型获取核心知识点并精简表达的能力。如：2025 年美团的营收是多少亿？</li>
<li><strong>开放题（长答案）：</strong>
考察推理和总结能力。比如“根据文档描述，分析一下为什么会出现设备异响？”。这种题没有标准死答案，最考验模型的逻辑。</li>
</ul>
<p>并且，在任务配置中 <strong>支持配置各题目类型生成的比例</strong>（比如：我要 30% 的判断题用于测幻觉，70% 的简答题测理解）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4caf47bc3d2d454c929f79a566ace467~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=iY%2Bvke5A8lT%2BeKtDKe8lY8Rp2ms%3D" alt="" loading="lazy"/></p>
<p>在 <code>Easy Dataset</code> 中，你可以通过多种方式生成和配置评估数据集（测试集）：</p>
<ul>
<li>从领域文献中提取测试集</li>
<li>从训练集添加或生成测试集变体</li>
<li>导入自定义/平台内置测试集</li>
</ul>
<h4 data-id="heading-10">从领域文献生成测试集</h4>
<p>不管是 PDF 还是 Docx 格式的领域文献，系统支持直接导入。后台会把这些长文本切分成小块（Chunk），然后通过提示词工程，让大模型基于这些文本块自动生成题目。</p>
<p>我们首先来到【数据源-文献处理】模块，导入一份小米 2025 Q3 季度的财报文档：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90562dd550c84b85a6946ee78125c6a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=AHYf6ZDksSDmAsYuMGGsMKcrW7s%3D" alt="" loading="lazy"/></p>
<p>系统解析完成后，会对文档进行自动切块，为了保证后续在文本块上生成的测试集更符合主题，我们批量编辑文本块：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54c9e8ffb19348699b70cf9756b0b38c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=7ZrydmqV2xzrV1C%2Bz%2Bv9Szjq0qg%3D" alt="" loading="lazy"/></p>
<p>在每个文本块的开头增加全局摘要信息：</p>
<blockquote>
<p>全局摘要：当前文本为 <strong>小米集团</strong> 2025 Q3 季度的财报文档的一部分。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab2aec2441f84ee2ab986481394a84bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=zI4XAXtW9Zf3nABmDArQ3kwJ9J0%3D" alt="" loading="lazy"/></p>
<p>然后，我们可以选择基于单个文本块生成测试集，或自动生成测试集（后台自动读取并处理未生成测试集的文本块），系统将根据我们前面在项目设置中设置的几种题目类型的比例自动生成测试题目（默认的题目类型判断题、单选题、多选题、简答题、开放题为 <code>1:1:1:1:1</code>）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bfe29455c2f482faf2aa9c72960257e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=38O7Sa%2FwAIk7XMvdO49GQL8cszM%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>建议：</p>
<ul>
<li>先用 “单个生成” 跑通流程，确认题型质量与期望一致，在执行自动生成任务。</li>
<li>比例配置先从保守开始：开放题比例不要太高（后续教师模型评估成本更高）</li>
</ul>
</blockquote>
<h4 data-id="heading-11">测试题管理</h4>
<p>点击每个文本块上的 <strong>已生成测试题</strong> 标签，我们将跳转至【评估-评估数据集】模块，在这里你可以看到已经生成的所有数据集，你可以根据题目类型、题目内容和标签进行筛选：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47463c166c3e4f2e98f879ccaa8a9c01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=DGPOrlZm1l27TydSuV5UjqedZOo%3D" alt="" loading="lazy"/></p>
<p>点击单个题目，可以查看题目详情：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54881f7c153e48798b7af126dc9d1a80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=cgH9SPYF5gQ3u6lQeZPB8h1EEp8%3D" alt="" loading="lazy"/></p>
<p>问题、选项、答案都可以自由编辑，你也可以对题目进行打标签、备注、删除等等：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/601f7268a08c4162aae0a03954caf8b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=Hf9S4DEsIANWf1C0%2BiI0p6OXJYQ%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">从数据集添加</h4>
<p>在以前的项目中，你可能已经使用  <code>Easy Dataset</code> 生成过数据集（训练集），我们也支持直接从已有数据集上标注和生成测试集。</p>
<p>下面我们来到【数据集-单论问答数据集】模块，可以看到之前生成过的数据集：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab7f5c6b253847b6b2cb2029e73953f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=LJXud%2BgUF6YYSgoBIKx0IUgW8W0%3D" alt="" loading="lazy"/></p>
<p>进入数据集详情页，我们可以直接将当前数据集添加到评估数据集（测试集），同时，系统给原数据集打上 Eval 标签（用于后续筛选/识别）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a1bd7191b4e4847873538eca6f50a2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=I5M%2FqOumePsJevUG4CjelNgzbzs%3D" alt="" loading="lazy"/></p>
<p>如果训练集太少或多样性不足，模型有时候会 “死记硬背”。我们也可以把一道现有的数据集题目自动改写生成评估集变体（比如换个问法，或者把选择题改成判断题），看看模型是不是真的理解了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9f4928ed4fd4edb9d152f49aa5321fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=R6N5K11DTLnLoc2Njz8ftdi%2Bb1M%3D" alt="" loading="lazy"/></p>
<p>点击：【生成评估集变体】可以选择要生成的题目类型和数量：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a87b5c66261343e592fe59438650a671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=PqxrxZdqRpQRlrFuznt%2FVK0LUU4%3D" alt="" loading="lazy"/></p>
<p>在常规的思路中，一般我们要从所有数据集中划分出一定比例（如 15%）作为测试集。</p>
<p>但是，在小规模的数据集上，如果直接划分出一定比例的测试集可能会导致原有的训练集数量和多样性不足，导致模型训练效果差。</p>
<p>如果使用 <code>Easy Dataset</code> 生成的数据集，我们可以全部用于训练集，另外一部分测试集我们可以直接在现有的数据集上生成变体，或重新从文本块提取。这样既能保证训练集的多样性不会受到损失，还能保证有足够丰富的测试集来支撑最终模型效果的评估。</p>
<h4 data-id="heading-13">导入导出测试集</h4>
<p>如果你已经有准备好的测试集，只是想使用 <code>Easy Dataset</code> 来做评估任务，可以到【评估-评估数据集】模块直接进行导入：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d4720bd8e1f49efa79e7083ab1308ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=0ehA3YwrkJQbLbq9AfqSn%2F5lZDc%3D" alt="" loading="lazy"/></p>
<p>目前支持从 <code>JSON、XLS、XLSX</code> 几种类型的文件进行导入，需要将文件处理成规定格式：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f3e3893fc554dfb841e3f596d8e6df0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=u4oHme5Z%2F9txz78y9w9xjCy7jaU%3D" alt="" loading="lazy"/></p>
<p>你可以直接下载对应题型和文件类型的模版，然后按照模版进行补充：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae275ad3b906470f8c1d009669ebe36e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=cfRU9Wjt8%2Fys8hAua367%2F9GwvpM%3D" alt="" loading="lazy"/></p>
<p>另外，平台还内置了丰富的领域知识数据集，如果你想测试模型在特定领域下的表现，可以直接选择【导入内置数据集】并选择对应学科进行导入：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32778826ddc7415c948c69d6575eaa48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=mf%2FVaB8vUlPXhk2iEzwLFYTaslo%3D" alt="" loading="lazy"/></p>
<p>每个学科下都内置了几百道不同难度的题目（大部分为单选或多选题）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c96570a3a764814bbcb3e1006e6e5f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=0Bfp%2BsL2g5Qpjy%2Fqi%2FgnyK07CoE%3D" alt="" loading="lazy"/></p>
<p>测试集处理完成后，我们也可以直接进行导出（支持自定义导出范围和格式），你可用于其他评估系统：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e1d4e7954c943acb85bb527b8db94f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=2IRLLCEVB1fWrD9yo2yqDAxIhn4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">2. 怎么打分？（自动评估任务）</h3>
<p>题出好了，接下来就是让业务模型来做题，系统来判卷。系统支持两种阅卷模式：</p>
<h4 data-id="heading-15">模式一：直接计算得分（针对客观题）</h4>
<p>对于<strong>判断题、单选题、多选题</strong>，答案是唯一的。
系统不需要调用大模型，直接用规则代码比对。</p>
<p>我们来到【评估-自动评估任务】模块，点击创建任务，您可以同时勾选多个模型，系统会并发执行多个任务：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/418f1e4b15ad41268dca5088351da9ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=FBUHmgA%2BuhuPNmxqtBLDSfesKZE%3D" alt="" loading="lazy"/></p>
<p>就像要真实要对模型进行一场考试一样，我们可以配置本次 “考卷” 的具体题目范围：</p>
<ul>
<li><strong>题型筛选</strong>：比如本次之考察选择题和判断题。</li>
<li><strong>标签筛选</strong>：比如只考查标签为 <code>医疗知识</code> 的题目。</li>
<li><strong>动态采样</strong>：如果您想快速获得结果，可以从 1000 道题中随机抽样 50 道。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce8d7497beb740cb8abd475537c55ccc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=u32ZtfMpZDNW0I7OBrxbQEMK%2FEU%3D" alt="任务执行中" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79a68f82299141ab9ec1e4d50eec1351~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=yfhUR2HJIY9Kgh70hzDlmJt792o%3D" alt="任务执行完成" loading="lazy"/></p>
<p>进入评估任务详情，你可以看到模型在不同题目上的具体得分情况，我们可以根据题目回答结果（正确/错误）以及题目类型（判断、单选、多选）进行筛选：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56629816f35b4a5ba2b001c4ebafb7fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=gIGcBjTtGGN%2BVQbVvcVKjEPFdOI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-16">模式二：教师模型评估（针对主观题）</h4>
<p>对于客观题（选择、判断），系统可以自动对齐答案。但对于 <strong>简答题</strong> 和 <strong>开放题</strong>，答案往往是多样化的。我们可以选择一个更智慧的 “教师模型”（就像判断老师一样） 对测试模型的回答进行深度评测，给出量化的分数和定性的评语。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/312f4c8f116a4654905c19c10b0815fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=OCdaAlZ8CKyD6e7nMESfw84k%2BNM%3D" alt="" loading="lazy"/></p>
<p>系统内置了一份评分标准，不过通用的标准比较宽泛，不一定适用于所有场景，如果你想得到更准确的评估结果，建议根据实际业务场景和数据集的特点定制具体的评分规则：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b274baae7064d57a18e11eb36f81fb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=QCPVvyQRBoNCkhzbr%2FA2%2Bjd6D6g%3D" alt="" loading="lazy"/></p>
<p>在评估报告详情中，你可以看到每个题目的具体得分，教师模型的打分以及具体的打分理由：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33f31315d0414e32893fa59a1c7ff815~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=mKF70N1TjWPegx%2FTDVEotWOAxEI%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>建议：</p>
<ul>
<li>同一套评估长期对比时，尽量固定教师模型与评分配置，否则分数不可直接横向对比</li>
<li>先在小样本（如 20 题）跑通，确认裁判标准符合预期，再扩大规模</li>
</ul>
</blockquote>
<h3 data-id="heading-17">3. 人工盲测：回归真实直觉的 “竞技场”</h3>
<p>虽然自动化评估很方便，但在模型上线的最后阶段，或者两个模型分数咬得很死的时候，还是需要人来看一眼。</p>
<blockquote>
<p><strong>盲测任务是什么？</strong></p>
<ul>
<li>盲测任务 = 把多个模型的回答“匿名化”，让评审者只看回答质量做选择/打分</li>
<li>适合：
<ul>
<li>你希望排除“模型名偏见”</li>
<li>你更在意主观体验（可读性、风格、说服力、完整性等）</li>
<li>开放题/对话型内容的最终质量评估</li>
</ul>
</li>
</ul>
</blockquote>
<p>就像在上个章节中我们讲到到 <code>LMArena</code>，人工盲测对于垂直领域的模型评估同等重要，在实际测试中，系统会隐藏两个模型的回答结果，评判者仅根据回答的质量、逻辑、语气进行主观判断，彻底消除对特定品牌的固有偏见。</p>
<p>我们来到【评估-人工盲测任务】模块，然后点击创建任务，然后配置：</p>
<ul>
<li><strong>两两对比</strong>：从模型库中选择两个你最想对比的模型。</li>
<li><strong>题目范围</strong>：选择简答题或开放题并设置抽样数量。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a285420962c456898a224517afe4637~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=Ygmq4EgT76Cfelwmy0nE6bLzip4%3D" alt="" loading="lazy"/></p>
<p>任务开启后，您将进入一个类似 <strong>Chatbot Arena</strong> 的沉浸式的对比界面：</p>
<ul>
<li><strong>左右对照</strong>：左边展示候选 A 的回答，右边展示候选 B 的回答，但不告诉标注人员具体是哪个模型。</li>
<li><strong>流式加载</strong>：系统支持流式输出，您可以实时看到模型的生成过程。</li>
<li><strong>四选一投票</strong>：标注人员只需要根据直观感受，选择“左边好”、“右边好”或者“平局”。
<ul>
<li><strong>👈 左边更好</strong>：左侧回答在准确性、流畅度或安全性上更优。</li>
<li><strong>👉 右边更好</strong>：右侧回答更符合你的预期。</li>
<li><strong>🤝 平局</strong>：两者难分伯仲，或都存在明显的严重错误。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c547fb0ce7b34e45ac5571c2f5826283~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=6aBpZxSeH7kH%2Fi1vWAktb6DMMi8%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>这种 Side-by-Side 的比较数据，是目前公认最符合人类真实体感的评估方式。</p>
</blockquote>
<p>当所有题目投票完成后，系统会 “揭晓谜底” 并生成胜率统计，系统将展示每个模型在对比中获胜的百分比。如果平局较多，说明这两个模型在当前题库下的表现非常接近。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b4b6f87ce4a4acca5c93370e4df418d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=2uiIcrN1RBn6zCHf%2F5pRAChldf4%3D" alt="" loading="lazy"/></p>
<p>你还可以回顾具体某个题目的回答结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79e1b67cd96f458bbc4ed348d89b88b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=oT6dZMGZXMmUw9quD6UhvERQEwU%3D" alt="" loading="lazy"/></p>
<p>回到任务列表，我们能清晰的看到每次盲测任务的结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30fb91c3cdd6477eb1d8d691a0c16ed5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=J0vetIzt7%2BzZFpsfpWkmeqe0Lx8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-18">4. 高级用法：自定义评估</h3>
<p>如果你有更定制化的模型评估需求（如需要定制处理的风格和侧重点、希望教师模型更关注某些特定维度），可以到【更多-项目设置-提示词配置模型】对模型评估的提示词进行更改，系统全面开放了评估系统的全套提示词，包括：</p>
<ul>
<li>从领域文献生成测试集的提示词：判断题、单选题、多选题、简答题、开放问题的生成</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95cfa6f145294b40b075218d0cc3513f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=nPwAeQdzjgV1etNYKsJIRN8JVxM%3D" alt="" loading="lazy"/></p>
<ul>
<li>不同题目执行测评的提示词：从原始题目获取答案</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99912934edb04fb7ab1319a01d33a5e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=P1iXgr%2BLV1X%2Bs3AHU3peCxjLaKo%3D" alt="" loading="lazy"/></p>
<ul>
<li>LLM 评估提示词：包括简答题和开放问题的评估</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6bddf44817b4e8389f0e515f631d79c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=v2J2tU1p7ju3OR7iueeVqNNzs5o%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>具体的评分细则在创建任务中是可以配置的，实际影响的就是提示词中的 <code>{{scoreAnchors}}</code> 变量，在这里的设置可以直接覆盖这个变量，自由度更高。</p>
</blockquote>
<h2 data-id="heading-19">最后</h2>
<p>希望阅读完本期教程，你将学会以下内容：</p>
<ol>
<li>理解通用基准在垂直领域的局限性，明确评估的三大核心目标（选型验证、微调效果、RAG优化）</li>
<li>掌握三类垂直领域评估方法的适用场景（确定性评估、文本相似度评估、LLM as Judge）</li>
<li>学会多方式构建垂直领域评估测试集（文献提取、训练集转化、自定义导入）</li>
<li>掌握客观题规则判分、主观题教师模型打分的自动化评估方法</li>
<li>能设计并执行人工盲测任务，获取贴合实际体感的模型对比结果</li>
<li>可通过自定义提示词适配不同垂直领域的评估需求</li>
<li>建立“测试集构建—自动化评估—人工验证”的评估闭环，实现模型效果量化判断</li>
</ol>
<p>关注《code秘密花园》从此学习 AI 不迷路，相关链接：</p>
<ul>
<li>Easy Dataset：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FConardLi%2Feasy-dataset" target="_blank" title="https://github.com/ConardLi/easy-dataset" ref="nofollow noopener noreferrer">github.com/ConardLi/ea…</a></li>
<li>AI 教程完整汇总：<a href="https://link.juejin.cn?target=https%3A%2F%2Frncg5jvpme.feishu.cn%2Fwiki%2FU9rYwRHQoil6vBkitY8cbh5tnL9" target="_blank" title="https://rncg5jvpme.feishu.cn/wiki/U9rYwRHQoil6vBkitY8cbh5tnL9" ref="nofollow noopener noreferrer">rncg5jvpme.feishu.cn/wiki/U9rYwR…</a></li>
<li>相关学习资源汇总在：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FConardLi%2Feasy-learn-ai" target="_blank" title="https://github.com/ConardLi/easy-learn-ai" ref="nofollow noopener noreferrer">github.com/ConardLi/ea…</a></li>
</ul>
<p>如果本期对你有所帮助，希望得到一个免费的三连，感谢大家支持</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年终总结-都在喊前端已死，这一年我的焦虑、挣扎与重组：AI 时代如何摆正自己的位置]]></title>    <link>https://juejin.cn/post/7594835618120925224</link>    <guid>https://juejin.cn/post/7594835618120925224</guid>    <pubDate>2026-01-14T11:32:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594835618120925224" data-draft-id="7595034434976006182" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年终总结-都在喊前端已死，这一年我的焦虑、挣扎与重组：AI 时代如何摆正自己的位置"/> <meta itemprop="keywords" content="前端,后端,AI编程"/> <meta itemprop="datePublished" content="2026-01-14T11:32:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="猪猪拆迁队"/> <meta itemprop="url" content="https://juejin.cn/user/2541726613638973"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年终总结-都在喊前端已死，这一年我的焦虑、挣扎与重组：AI 时代如何摆正自己的位置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2541726613638973/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    猪猪拆迁队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T11:32:43.000Z" title="Wed Jan 14 2026 11:32:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>前言</strong></p>
<p>今年这一年，我整个人一直处于一种紧绷的焦虑状态。</p>
<p>这种焦虑来自于一种真切的危机感：作为前端，我发现自己曾经引以为傲的“技术壁垒”在 AI 面前像纸一样薄。但最近，我突然想通了。当我意识到 <strong>AI 只是工具，全栈才是唯一出路，知识广度才是护城河</strong> 的时候，我的焦虑缓解了。</p>
<p>这一年我写了很多文章、折腾了开源项目、学了新语言，原本以为是在浪费时间“乱撞”，现在回头看，这恰恰是我加速转型的护城河。</p>
<p>今天想把这一年的思考总结出来，分享一下。</p>
<hr/>
<h2 data-id="heading-0">一、 认清时代的洪流：人是阻挡不了趋势的</h2>
<p>很多人私下里对 AI 处于一种**“间歇性积极，持续性排斥”**的状态。这种心态通常分为三个阶段：</p>
<ol>
<li><strong>轻视/嘲讽：</strong> 找 AI 的逻辑错误，通过嘲讽来获得心理安慰。</li>
<li><strong>焦虑/抗拒：</strong> 意识到它很强，但通过拒绝接触来延缓危机，觉得用了它就“输了”。</li>
<li><strong>妥协/共生：</strong> 既然无法打败，就把它当成身体的一部分。</li>
</ol>
<p><strong>我们要清醒一点：人是阻挡不了时代洪流的。</strong> 现在的业务逻辑，你手动写 100 遍也不会有任何提升。把时间浪费在无意义的重复劳动上，不仅是在消耗生命，更是对职业生涯的自杀。</p>
<hr/>
<h2 data-id="heading-1">二、 核心思维：从“单一职业”向“学科重组”切换</h2>
<p>这是我今年最大的认知提升：<strong>作为“岗位”的前端和后端会逐渐消亡，但作为“学科”的前端和后端会发生重组。</strong></p>
<h3 data-id="heading-2">1. 摆脱单一职业的束缚</h3>
<p>不要把自己锁死在“前端”这个标签里。如果你只盯着那几个 API 和框架，你的路会越走越窄。AI 时代，我们需要的是<strong>知识广度</strong>。</p>
<h3 data-id="heading-3">2. 思维改变是第一步，但要有“作品”支撑</h3>
<p>不要只是空想，要去实施一套 <strong>“AI 驱动的开发流”</strong> 。</p>
<ul>
<li><strong>你可以不写代码，但你必须能瞬间看出 AI 写的代码哪里有坑。</strong></li>
<li>你的价值不在于“使用 AI 编码”，而在于你拥有<strong>全局思考</strong>的能力，能定义边界，能把控风险。</li>
</ul>
<hr/>
<h2 data-id="heading-4">三、 实操方法：如何把 AI 练成你的“外骨骼”？</h2>
<h3 data-id="heading-5">1. 建立场景化的 Prompt 资产库</h3>
<p>不要把 AI 当成简单的搜索引擎。你需要针对不同的场景（如：复杂表单逻辑、组件边界设计、性能优化）建立专用的 Prompt。</p>
<blockquote>
<p><strong>心得：</strong> 明确设计组件的边界，给 AI 定好规矩，它产出的代码才不会跑偏。</p>
</blockquote>
<h3 data-id="heading-6">2. 在掌控范围内使用</h3>
<p>不要把代码完全交给 AI 后就撒手不管。<strong>要把 AI 限制在你能把控的范围内</strong>，防止代码库由于不受控而崩坏。这种“把控力”就是 senior 和 junior 的分水岭。</p>
<h3 data-id="heading-7">3. 数据对比：感知效率的代差</h3>
<p>我曾做过对比，传统的 Spec 确认到开发完成，和现在的 <strong>Spec Coding（基于规格说明书编程）</strong> 模式相比，效率是量级的差别。这种效率红利，就是你转型的动力。</p>
<hr/>
<h2 data-id="heading-8">四、 关于全栈：唯一的路，也是最好的练习场</h2>
<p>很多人问：我想切全栈，但后端语法、环境配置乱七八糟，怎么学？</p>
<ol>
<li><strong>拿公司项目练手：</strong> 不要怕环境乱。环境配置、部署链路这些繁琐的事，恰恰是 AI 最擅长的。让 AI 带你跑通公司的后端流程，这是成本最低的练习方式。</li>
<li><strong>快速切换语法：</strong> 不要死背语法书。利用 AI 快速对比新旧语言的异同（比如：TS 的 Interface 在 Go 里怎么实现？）。</li>
<li><strong>时间规划：</strong> 抛弃那种“等我学完再做”的想法。直接带着任务去问 AI，在实战中扩充技术栈。</li>
</ol>
<hr/>
<h2 data-id="heading-9">五、 总结：护城河从未消失，只是换了地方</h2>
<p>这一年，我虽然焦虑，但并没闲着。我发现：</p>
<ul>
<li>焦虑时写的文章，打磨了我的<strong>逻辑表达</strong>；</li>
<li>焦虑时折腾的开源项目，扩充了我的<strong>技术底座</strong>；</li>
<li>焦虑时学的后端语言，提升了我的<strong>系统观</strong>。</li>
</ul>
<p>这些看似乱撞的经历，最终都转化成了我<strong>快速转型的技术能力</strong>。</p>
<p><strong>当开发模式从传统编程演变成 Spec Coding 时，你的认知、你的经验、你对复杂业务的洞察，依然是 AI 无法拿走的护城河。</strong></p>
<p>不要在没有意义的事情上浪费时间。顺应时代，保持思考。如果这个时代注定要重组，那我们要做的，就是成为那个亲手重组自己的人。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AWS RDS 可观测性最佳实践]]></title>    <link>https://juejin.cn/post/7595043061728722978</link>    <guid>https://juejin.cn/post/7595043061728722978</guid>    <pubDate>2026-01-14T11:33:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595043061728722978" data-draft-id="7594745643892883491" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AWS RDS 可观测性最佳实践"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-01-14T11:33:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AWS RDS 可观测性最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T11:33:48.000Z" title="Wed Jan 14 2026 11:33:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AWS RDS 介绍</h2>
<p>AWS RDS（Amazon Relational Database Service）是一种由亚马逊提供的完全托管的关系数据库服务，支持多种流行的数据库引擎，如 MySQL、MariaDB、PostgreSQL、Oracle 和 SQL Server。这项服务的主要优势在于简化了在云中部署、操作和扩展关系数据库的复杂性，无需用户自行管理底层的基础设施。它提供了自动备份和恢复、自动维护、高可用性和容错能力、可扩展性以及安全性等关键特性。</p>
<p>尽管 AWS RDS 极大地降低了数据库管理的复杂性，但对其进行监控和可观测性仍然是至关重要的。监控可以帮助优化数据库性能，通过分析性能指标如 CPU、内存使用率、磁盘 I/O 和网络流量等，及时识别并解决性能瓶颈。此外，监控还有助于故障检测，可以快速识别并响应数据库的异常情况，如连接失败、查询超时等。它还支持容量规划，通过分析历史使用数据预测资源需求，以合理规划和分配资源。安全性方面，监控可以帮助检测潜在的安全威胁，如未授权访问和 SQL 注入攻击，从而采取相应的防御措施。此外，监控还有助于成本控制，通过识别不必要的资源消耗来优化成本，同时也可以满足某些行业或地区对于数据库可观测性的特定合规要求。</p>
<h2 data-id="heading-1">观测云</h2>
<p>观测云是一款专为 IT 工程师打造的全链路可观测产品，它集成了基础设施监控、应用程序性能监控和日志管理，为整个技术栈提供实时可观察性。这款产品能够帮助工程师全面了解端到端的用户体验追踪，了解应用内函数的每一次调用，以及全面监控云时代的基础设施。此外，观测云还具备快速发现系统安全风险的能力，为数字化时代提供安全保障。</p>
<h3 data-id="heading-2">采集器配置</h3>
<ol>
<li>登陆观测云控制台</li>
<li>点击【集成】菜单，选择【云账号管理】</li>
<li>点击【添加云账号】，选择【AWS】，填写界面所需的信息，如之前已配置过云账号信息，则忽略此步骤</li>
<li>点击【测试】，测试成功后点击【保存】，如果测试失败，请检查相关配置信息是否正确，并重新测试</li>
<li>点击【云账号管理】列表上可以看到已添加的云账号，点击相应的云账号，进入详情页</li>
<li>点击云账号详情页的【集成】按钮，在未安装列表下，找到AWS RDS Mysql，点击【安装】按钮，弹出安装界面安装即可。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef2a6f850768419184f08dcb5c09f3ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995228&amp;x-signature=Gglf4fTC32dxQdBYFQM6E%2B1C5Fc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">关键指标</h3>



































































































































































































































<table><thead><tr><th>指标</th><th>控制台名称</th><th>描述</th><th>单位</th></tr></thead><tbody><tr><td>BinLogDiskUsage</td><td>二进制日志磁盘使用情况（MB）</td><td>二进制日志所占的磁盘空间大小。如果为 MySQL 和 MariaDB 实例（包括只读副本）启用了自动备份，则会创建二进制日志。</td><td>字节</td></tr><tr><td>BurstBalance</td><td>突发余额（百分比）</td><td>可用的通用型 SSD (GP2) 突增存储桶 I/O 点数的百分比。</td><td>百分比</td></tr><tr><td>CheckpointLag</td><td>检查点滞后（毫秒）</td><td>自最近一次检查点以来的时间。仅适用于 RDS for PostgreSQL。</td><td>毫秒</td></tr><tr><td>ConnectionAttempts</td><td>连接尝试（计数）</td><td>尝试连接实例的次数，无论成功与否。</td><td>计数</td></tr><tr><td>CPUUtilization</td><td>CPU 利用率（百分比）</td><td>CPU 使用百分率。</td><td>百分比</td></tr><tr><td>CPUCreditUsage</td><td>CPU 额度使用（计数）</td><td>（T2 实例）实例为保持 CPU 使用率而花费的 CPU 积分数。一个 CPU 积分等于一个 vCPU 以 100% 的使用率运行一分钟或等同的 vCPU、使用率与时间的组合。例如，您可以有一个 vCPU 按 50% 使用率运行两分钟，或者两个 vCPU 按 25% 使用率运行两分钟。CPU 积分指标仅每 5 分钟提供一次。如果您指定一个大于五分钟的时间段，请使用Sum 统计数据，而非 Average 统计数据。</td><td>积分 (vCPU 分钟)</td></tr><tr><td>CPUCreditBalance</td><td>CPU 额度余额（计数）</td><td>（T2 实例）实例自启动后已累积获得的 CPU 积分数。对于 T2 标准，CPUCreditBalance 还包含已累积的启动积分数。在获得积分后，积分将在积分余额中累积；在花费积分后，将从积分余额中扣除积分。积分余额具有最大值限制，这是由实例大小决定的。在达到限制后，将丢弃获得的任何新积分。对于 T2 标准，启动积分不计入限制。实例可以花费 CPUCreditBalance 中的积分，以便突增到基准 CPU 使用率以上。在实例运行过程中，CPUCreditBalance 中的积分不会过期。在实例停止时，CPUCreditBalance 不会保留，并且所有累积的积分都将丢失。CPU 信用指标仅每 5 分钟提供一次。启动积分在 Amazon RDS 中的作用方式与在 Amazon EC2 中的作用方式相同。</td><td>积分（vCPU 分钟）</td></tr><tr><td>DatabaseConnections</td><td>数据库连接（计数）</td><td>连接至数据库实例的客户端网络连接数。数据库会话数可能高于指标值，因为指标值不包括以下内容：不再具有网络连接但数据库尚未清理的会话数据库引擎出于自身目的创建的会话由数据库引擎的并行执行功能创建的会话由数据库引擎任务计划程序创建的会话Amazon RDS 连接</td><td>计数</td></tr><tr><td>DiskQueueDepth</td><td>队列深度（计数）</td><td>等待访问磁盘的未完成 I/O（读取/写入请求）的数量。</td><td>计数</td></tr><tr><td>EBSByteBalance</td><td>EBS 字节余额（百分比）</td><td>RDS 数据库突增存储桶中剩余的吞吐量积分的百分比 此指标仅对基本监控可用。该指标值基于包括根卷在内的所有卷的吞吐量和 IOPS，而不是仅基于那些包含数据库文件的卷。</td><td>百分比</td></tr><tr><td>EBSIOBalance</td><td>EBS IO 余额（百分比）</td><td>RDS 数据库突增存储桶中剩余的 I/O 积分的百分比 此指标仅对基本监控可用。该指标值基于包括根卷在内的所有卷的吞吐量和 IOPS，而不是仅基于那些包含数据库文件的卷。</td><td>百分比</td></tr><tr><td>FailedSQLServerAgentJobsCount</td><td>失败的 SQL Server Agent 作业计数（计数/分钟）</td><td>过去 1 分钟内失败的 Microsoft SQL Server Agent 作业的数量。</td><td>每分钟计数</td></tr><tr><td>FreeableMemory</td><td>可用内存（MB）</td><td>随机存取内存的可用大小。对于 MariaDB、MySQL、Oracle 和 PostgreSQL 数据库实例，此指标报告 MemAvailable 的 /proc/meminfo 字段的值。</td><td>字节</td></tr><tr><td>FreeLocalStorage</td><td>可用本地存储（MB）</td><td>可用本地存储空间的大小。此指标仅适用于具有 NVMe SSD 实例存储卷的数据库实例类。</td><td>字节</td></tr><tr><td>FreeStorageSpace</td><td>可用存储空间 (MB)</td><td>可用存储空间的大小。</td><td>字节</td></tr><tr><td>MaximumUsedTransactionIDs</td><td>最大已用事务 ID（计数）</td><td>已使用的最大事务 ID。仅适用于 PostgreSQL。</td><td>计数</td></tr><tr><td>NetworkReceiveThroughput</td><td>网络接收吞吐量（MB/秒）</td><td>数据库实例的传入（接收）网络流量，包括用于监控和复制的客户数据库流量和 Amazon RDS 流量。</td><td>每秒字节数</td></tr><tr><td>NetworkTransmitThroughput</td><td>网络传输吞吐量（MB/秒）</td><td>数据库实例的传出（传输）网络流量，包括用于监控和复制的客户数据库流量和 Amazon RDS 流量。</td><td>每秒字节数</td></tr><tr><td>OldestReplicationSlotLag</td><td>最早副本槽滞后 (MB)</td><td>在接收预写日志 (WAL) 数据方面最滞后的副本的滞后大小。适用于 PostgreSQL。</td><td>字节</td></tr><tr><td>ReadIOPS</td><td>读取 IOPS（计数/秒）</td><td>每秒平均磁盘读取 I/O 操作数。</td><td>每秒计数</td></tr><tr><td>ReadIOPSLocalStorage</td><td>读取 IOPS 本地存储（计数/秒）</td><td>每秒至本地存储的平均磁盘读取输入/输出操作数。此指标仅适用于具有 NVMe SSD 实例存储卷的数据库实例类。</td><td>每秒计数</td></tr><tr><td>ReadLatency</td><td>读取延迟（毫秒）</td><td>每个磁盘 I/O 操作所需的平均时间。</td><td>毫秒</td></tr><tr><td>ReadLatencyLocalStorage</td><td>读取延迟本地存储（毫秒）</td><td>每个磁盘对本地存储输入/输出操作所需的平均时间。此指标仅适用于具有 NVMe SSD 实例存储卷的数据库实例类。</td><td>毫秒</td></tr><tr><td>ReadThroughput</td><td>读取吞吐量（MB/秒）</td><td>每秒从磁盘读取的平均字节数。</td><td>每秒字节数</td></tr><tr><td>ReadThroughputLocalStorage</td><td>读取吞吐量本地存储（MB/秒）</td><td>每秒从磁盘至本地存储读取的平均字节数。此指标仅适用于具有 NVMe SSD 实例存储卷的数据库实例类。</td><td>每秒字节数</td></tr><tr><td>ReplicaLag</td><td>副本滞后（毫秒）</td><td>对于只读副本配置，只读副本数据库实例滞后于源数据库实例的时间量。适用于 MariaDB、Microsoft SQL Server、MySQL、Oracle 和 PostgreSQL 只读副本。对于多可用区数据库集群，写入器数据库实例上的最新事务与读取器数据库实例上的最新应用事务之间的时间差异。</td><td>毫秒</td></tr><tr><td>ReplicationSlotDiskUsage</td><td>副本插槽磁盘使用情况（MB）</td><td>副本槽文件使用的磁盘空间。适用于 PostgreSQL。</td><td>字节</td></tr><tr><td>SwapUsage</td><td>交换区使用情况（MB）</td><td>数据库实例上使用的交换空间的大小。此指标对于 SQL Server 不可用。</td><td>字节</td></tr><tr><td>TransactionLogsDiskUsage</td><td>事务日志磁盘使用情况（MB）</td><td>事务日志使用的磁盘空间。适用于 PostgreSQL。</td><td>字节</td></tr><tr><td>TransactionLogsGeneration</td><td>事务日志生成（MB/秒）</td><td>每秒生成的事务日志的大小。适用于 PostgreSQL。</td><td>每秒字节数</td></tr><tr><td>WriteIOPS</td><td>写入 IOPS（计数/秒）</td><td>每秒平均磁盘写入 I/O 操作数。</td><td>每秒计数</td></tr><tr><td>WriteIOPSLocalStorage</td><td>写入 IOPS 本地存储（计数/秒）</td><td>本地存储上的每秒平均磁盘写入 I/O 操作数。此指标仅适用于具有 NVMe SSD 实例存储卷的数据库实例类。</td><td>每秒计数</td></tr><tr><td>WriteLatency</td><td>写入延迟（毫秒）</td><td>每个磁盘 I/O 操作所需的平均时间。</td><td>毫秒</td></tr><tr><td>WriteLatencyLocalStorage</td><td>写入延迟本地存储（毫秒）</td><td>本地存储上每个磁盘 I/O 操作所需的平均时间。此指标仅适用于具有 NVMe SSD 实例存储卷的数据库实例类。</td><td>毫秒</td></tr><tr><td>WriteThroughput</td><td>写入吞吐量（MB/秒）</td><td>每秒写入磁盘的平均字节数。</td><td>每秒字节数</td></tr><tr><td>WriteThroughputLocalStorage</td><td>写入吞吐量本地存储（MB/秒）</td><td>本地存储每秒写入磁盘的平均字节数。此指标仅适用于具有 NVMe SSD 实例存储卷的数据库实例类。</td><td>每秒字节数</td></tr></tbody></table>
<h3 data-id="heading-4">场景视图</h3>
<p>登录观测云控制台，点击「场景」 -「新建仪表板」，输入 “AWS RDS”， 选择 “AWS RDS MySQL 监控视图”，点击 “确定” 即可添加视图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98bf951ccd604973bc04c1558be63b3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995228&amp;x-signature=ObEuzEmbe4bK1nbCf63PQKyvMv4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">监控器（告警）</h3>
<p>观测云内置了监控器模板，可以选择从模版创建监控器，并开启适合业务的监控器以及时通知相关成员关注问题，触发条件、频率等信息可以依据实际业务进行调整。</p>
<p>登录观测云控制台，点击「监控」 -「新建监控器」，输入 “AWS RDS”， 选择对应的监控器，点击 “确定” 即可添加。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dc94873d6f94239ad54e130f080a6f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995228&amp;x-signature=3yM2HW%2Beitjgj1BqXqVZEIgdmBE%3D" alt="" loading="lazy"/></p>
<p>AWS RDS Mysql 实例名称为 {{DBInstanceIdentifier}} CPU 使用率过高</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4864a23848cb4eab9010023d16715b19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995228&amp;x-signature=L5k85Z8Zqq4EfGBjV1tpT36zku4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">总结</h2>
<p>通过将 AWS RDS 的原生监控数据集成到观测云平台，用户可以实现对关系数据库服务（RDS）实例的实时性能监控、资源使用分析以及安全事件的可视化。观测云平台提供的高级分析和可视化功能，包括实时仪表板、智能告警和根因分析，能够帮助用户快速定位数据库性能问题、优化资源成本，并确保数据的高可用性和安全性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（41）Hibernate的延迟加载和急加载的区别是什么？]]></title>    <link>https://juejin.cn/post/7594863660298076202</link>    <guid>https://juejin.cn/post/7594863660298076202</guid>    <pubDate>2026-01-14T11:54:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594863660298076202" data-draft-id="7594791357144449066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（41）Hibernate的延迟加载和急加载的区别是什么？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-14T11:54:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（41）Hibernate的延迟加载和急加载的区别是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T11:54:03.000Z" title="Wed Jan 14 2026 11:54:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Hibernate的延迟加载和急加载</h3>
<p>Hibernate中的延迟加载（Lazy Loading）和急加载（Eager Loading）是两种常见的数据加载策略，用于决定如何从数据库中加载关联实体。</p>
<ul>
<li><strong>延迟加载（Lazy Loading）</strong>：在访问关联实体时才加载数据。这种策略可以提高性能，因为只有在需要时才会访问数据库。</li>
<li><strong>急加载（Eager Loading）</strong>：在加载主实体时立即加载所有关联实体。这种策略可以减少数据库访问次数，但可能会导致加载不必要的数据，从而影响性能。</li>
</ul>
<h3 data-id="heading-1">配置延迟加载和急加载</h3>
<p>在Hibernate中，我们可以通过使用JPA注解（如<code>@OneToMany</code>、<code>@ManyToOne</code>、<code>@OneToOne</code>、<code>@ManyToMany</code>等）来指定加载策略。</p>
<h3 data-id="heading-2">示例代码</h3>
<h4 data-id="heading-3">步骤一：定义实体类</h4>
<p>我们假设有两个实体类<code>Product</code>和<code>Category</code>，其中一个<code>Product</code>可以属于多个<code>Category</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;
<span class="hljs-keyword">import</span> java.util.HashSet;
<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-meta">@ManyToMany(fetch = FetchType.LAZY)</span> <span class="hljs-comment">// 延迟加载</span>
    <span class="hljs-meta">@JoinTable(
        name = "product_category",
        joinColumns = @JoinColumn(name = "product_id"),
        inverseJoinColumns = @JoinColumn(name = "category_id")
    )</span>
    <span class="hljs-keyword">private</span> Set&lt;Category&gt; categories = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">getPrice</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> price;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPrice</span><span class="hljs-params">(Double price)</span> {
        <span class="hljs-built_in">this</span>.price = price;
    }

    <span class="hljs-keyword">public</span> Set&lt;Category&gt; <span class="hljs-title function_">getCategories</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> categories;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCategories</span><span class="hljs-params">(Set&lt;Category&gt; categories)</span> {
        <span class="hljs-built_in">this</span>.categories = categories;
    }
}

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "category")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Category</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@ManyToMany(mappedBy = "categories", fetch = FetchType.EAGER)</span> <span class="hljs-comment">// 急加载</span>
    <span class="hljs-keyword">private</span> Set&lt;Product&gt; products = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> Set&lt;Product&gt; <span class="hljs-title function_">getProducts</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> products;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProducts</span><span class="hljs-params">(Set&lt;Product&gt; products)</span> {
        <span class="hljs-built_in">this</span>.products = products;
    }
}
</code></pre>
<h4 data-id="heading-4">步骤二：配置Hibernate</h4>
<p>我们仍然需要一个配置文件来配置Hibernate连接和映射。</p>
<h5 data-id="heading-5">Hibernate配置文件 <code>hibernate.cfg.xml</code></h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Category"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-6">步骤三：实用类HibernateUtil</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h4 data-id="heading-7">步骤四：测试延迟加载和急加载</h4>
<p>通过一个简单的操作来测试延迟加载和急加载的效果。</p>
<h5 data-id="heading-8">测试类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> com.example.domain.Product;
<span class="hljs-keyword">import</span> com.example.domain.Category;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateLoadingStrategyExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 查询示例数据并测试加载策略</span>
        testLoadingStrategies(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Product</span> <span class="hljs-variable">product1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">"Laptop"</span>, <span class="hljs-number">1000.0</span>);
            <span class="hljs-type">Product</span> <span class="hljs-variable">product2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">"Smartphone"</span>, <span class="hljs-number">500.0</span>);

            <span class="hljs-type">Category</span> <span class="hljs-variable">category1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Category</span>(<span class="hljs-string">"Electronics"</span>);
            <span class="hljs-type">Category</span> <span class="hljs-variable">category2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Category</span>(<span class="hljs-string">"Mobile Devices"</span>);

            product1.getCategories().add(category1);
            product1.getCategories().add(category2);
            product2.getCategories().add(category2);

            category1.getProducts().add(product1);
            category2.getProducts().add(product1);
            category2.getProducts().add(product2);

            session.save(product1);
            session.save(product2);
            session.save(category1);
            session.save(category2);

            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLoadingStrategies</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// Lazy Loading</span>
            System.out.println(<span class="hljs-string">"Testing Lazy Loading:"</span>);
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> session.get(Product.class, <span class="hljs-number">1L</span>);
            System.out.println(<span class="hljs-string">"Product: "</span> + product.getName());
            System.out.println(<span class="hljs-string">"Categories: "</span> + product.getCategories().size()); <span class="hljs-comment">// 这里会触发数据库查询</span>

            <span class="hljs-comment">// Eager Loading</span>
            System.out.println(<span class="hljs-string">"\nTesting Eager Loading:"</span>);
            <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> session.get(Category.class, <span class="hljs-number">1L</span>);
            System.out.println(<span class="hljs-string">"Category: "</span> + category.getName());
            System.out.println(<span class="hljs-string">"Products: "</span> + category.getProducts().size()); <span class="hljs-comment">// 这里不会触发额外的数据库查询</span>
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-9">详细解释</h3>
<ol>
<li>
<p><strong>定义实体类</strong>：</p>
<ul>
<li>在<code>Product</code>类中，<code>@ManyToMany</code>关联使用了<code>fetch = FetchType.LAZY</code>，表示在访问<code>categories</code>集合时才加载数据。</li>
<li>在<code>Category</code>类中，<code>@ManyToMany</code>关联使用了<code>fetch = FetchType.EAGER</code>，表示在加载<code>Category</code>实体时立即加载<code>products</code>集合。</li>
</ul>
</li>
<li>
<p><strong>配置文件</strong>：</p>
<ul>
<li>标准的Hibernate配置文件，用于数据库连接和映射类的配置。</li>
</ul>
</li>
<li>
<p><strong>实用类HibernateUtil</strong>：</p>
<ul>
<li>提供了创建和获取<code>SessionFactory</code>实例的方法。</li>
</ul>
</li>
<li>
<p><strong>测试类</strong>：</p>
<ul>
<li>插入一些示例数据，包括一些<code>Product</code>和<code>Category</code>实体，以及它们之间的关联关系。</li>
<li>通过<code>testLoadingStrategies</code>方法来测试延迟加载和急加载的效果。对于延迟加载，在访问关联集合时会触发数据库查询；而对于急加载，关联集合会在加载主实体时立即加载。</li>
</ul>
</li>
</ol>
<p>通过这种方式，我们可以灵活地配置和测试Hibernate中的延迟加载和急加载策略，以优化应用程序的性能和数据访问效率。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（42）在Hibernate中如何实现分页？]]></title>    <link>https://juejin.cn/post/7594863660298092586</link>    <guid>https://juejin.cn/post/7594863660298092586</guid>    <pubDate>2026-01-14T11:54:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594863660298092586" data-draft-id="7595043440519839750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（42）在Hibernate中如何实现分页？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-14T11:54:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（42）在Hibernate中如何实现分页？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T11:54:46.000Z" title="Wed Jan 14 2026 11:54:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Hibernate中实现分页非常简单，可以使用Hibernate的<code>Criteria API</code>或<code>HQL</code>（Hibernate Query Language）来实现。分页的核心思想是使用<code>setFirstResult</code>和<code>setMaxResults</code>方法来控制查询的起始位置和返回的记录数。</p>
<h3 data-id="heading-0">使用HQL实现分页</h3>
<p>首先，我们来看一下如何使用HQL来实现分页。</p>
<h4 data-id="heading-1">步骤一：定义实体类</h4>
<p>为了演示，我们将使用一个简单的<code>Product</code>实体类。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">getPrice</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> price;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPrice</span><span class="hljs-params">(Double price)</span> {
        <span class="hljs-built_in">this</span>.price = price;
    }
}
</code></pre>
<h4 data-id="heading-2">步骤二：配置Hibernate</h4>
<p>我们需要一个配置文件来配置Hibernate连接和映射。</p>
<h5 data-id="heading-3">Hibernate配置文件 <code>hibernate.cfg.xml</code></h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">步骤三：实用类HibernateUtil</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h4 data-id="heading-5">步骤四：实现分页功能</h4>
<p>现在，我们可以编写一个方法来实现分页查询。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.query.Query;
<span class="hljs-keyword">import</span> com.example.domain.Product;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernatePaginationExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 分页查询数据</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">pageNumber</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">pageSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
        List&lt;Product&gt; products = getProductsPaginated(sessionFactory, pageNumber, pageSize);

        <span class="hljs-comment">// 打印结果</span>
        <span class="hljs-keyword">for</span> (Product product : products) {
            System.out.println(product.getId() + <span class="hljs-string">": "</span> + product.getName() + <span class="hljs-string">" - $"</span> + product.getPrice());
        }

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Product&gt; <span class="hljs-title function_">getProductsPaginated</span><span class="hljs-params">(SessionFactory sessionFactory, <span class="hljs-type">int</span> pageNumber, <span class="hljs-type">int</span> pageSize)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        List&lt;Product&gt; products = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">hql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"FROM Product"</span>;
            Query&lt;Product&gt; query = session.createQuery(hql);
            query.setFirstResult((pageNumber - <span class="hljs-number">1</span>) * pageSize);
            query.setMaxResults(pageSize);

            products = query.getResultList();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }

        <span class="hljs-keyword">return</span> products;
    }
}
</code></pre>
<h3 data-id="heading-6">使用Criteria API实现分页</h3>
<p>也可以使用Hibernate的Criteria API来实现分页查询。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Criteria;
<span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.criterion.Restrictions;
<span class="hljs-keyword">import</span> com.example.domain.Product;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateCriteriaPaginationExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 分页查询数据</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">pageNumber</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">pageSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
        List&lt;Product&gt; products = getProductsPaginated(sessionFactory, pageNumber, pageSize);

        <span class="hljs-comment">// 打印结果</span>
        <span class="hljs-keyword">for</span> (Product product : products) {
            System.out.println(product.getId() + <span class="hljs-string">": "</span> + product.getName() + <span class="hljs-string">" - $"</span> + product.getPrice());
        }

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Product&gt; <span class="hljs-title function_">getProductsPaginated</span><span class="hljs-params">(SessionFactory sessionFactory, <span class="hljs-type">int</span> pageNumber, <span class="hljs-type">int</span> pageSize)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        List&lt;Product&gt; products = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Criteria</span> <span class="hljs-variable">criteria</span> <span class="hljs-operator">=</span> session.createCriteria(Product.class);
            criteria.setFirstResult((pageNumber - <span class="hljs-number">1</span>) * pageSize);
            criteria.setMaxResults(pageSize);

            products = criteria.list();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }

        <span class="hljs-keyword">return</span> products;
    }
}
</code></pre>
<h3 data-id="heading-7">详细解释</h3>
<ol>
<li>
<p><strong>定义实体类</strong>：</p>
<ul>
<li><code>Product</code>类是一个简单的实体类，包含<code>id</code>、<code>name</code>和<code>price</code>属性。</li>
</ul>
</li>
<li>
<p><strong>配置文件</strong>：</p>
<ul>
<li><code>hibernate.cfg.xml</code>配置文件用于设置数据库连接、Hibernate属性和映射类。</li>
</ul>
</li>
<li>
<p><strong>实用类HibernateUtil</strong>：</p>
<ul>
<li><code>HibernateUtil</code>类提供了获取<code>SessionFactory</code>实例的方法。</li>
</ul>
</li>
<li>
<p><strong>实现分页功能</strong>：</p>
<ul>
<li>使用HQL和Criteria API分别实现了分页查询。</li>
<li><code>setFirstResult</code>方法用于指定查询的起始位置，<code>setMaxResults</code>方法用于指定返回的最大记录数。</li>
<li>在<code>getProductsPaginated</code>方法中，通过分页参数（<code>pageNumber</code>和<code>pageSize</code>）来控制查询结果的分页。</li>
</ul>
</li>
</ol>
<p>通过这种方式，可以轻松实现Hibernate中的分页查询，以处理大量数据并提高查询性能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code 最佳实践的 8 条黄金法则]]></title>    <link>https://juejin.cn/post/7594813727054364706</link>    <guid>https://juejin.cn/post/7594813727054364706</guid>    <pubDate>2026-01-14T11:55:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594813727054364706" data-draft-id="7595043061728755746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code 最佳实践的 8 条黄金法则"/> <meta itemprop="keywords" content="Claude"/> <meta itemprop="datePublished" content="2026-01-14T11:55:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿DD"/> <meta itemprop="url" content="https://juejin.cn/user/131597123993358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code 最佳实践的 8 条黄金法则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597123993358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿DD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T11:55:25.000Z" title="Wed Jan 14 2026 11:55:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>为什么同样是调用 Claude，有的人能写出工业级代码，而有的人只是在不断堆积“技术债”？ 今天分享一位拥有 7 年 Amazon、Disney 大厂经验、现任创业公司 CTO 分享的实战指南。他把 Claude Code 当作每日主力工具，并总结出了一套高阶玩家手册。从“先思考后敲字”的架构铁律，到让 AI 秒懂你的 CLAUDE.md 深度配置，全是避坑指南。如果你想让 AI 真正成为你的生产力飞轮，这篇文章绝对值得收藏反复读！</p>
<p><img src="https://static.didispace.com/images4/e1b3fb9075d2bdf55456fd056ac5270e.png" alt="f02adbeb1a8c005df0134224ed8c0d1b.png" loading="lazy"/></p>
<p>下面是对这篇文章的总结解读，如果对原文感兴趣也可以戳这里查看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Feyad_khrais%2Fstatus%2F2010076957938188661" target="_blank" title="https://x.com/eyad_khrais/status/2010076957938188661" ref="nofollow noopener noreferrer">《The complete claude code tutorial 》</a></p>
<h2 data-id="heading-0">法则一：先思考，再输入：计划模式是你最强大的武器。</h2>
<p>大多数人认为使用AI工具的第一步就是直接开始输入提示词。这是你能犯下的最大错误之一。真正至关重要且必须先做的第一步是——思考和计划。</p>
<p>我100%的经验表明，使用“计划模式”（连按两次 Shift+Tab 键进入）得到的输出，远胜于直接滔滔不绝地输入想法。这种差距是压倒性的。</p>
<p>当然，对于一些经验不足的工程师来说，这可能说起来容易做起来难。对此，我有两条建议：</p>
<ol>
<li>开始学习。 即使每次只学一点，也必须开始积累。如果你永远不掌握规划能力，你就是在给自己设置障碍。</li>
<li>与AI深度交流。 和Claude进行一场深入的、双向的对话。详细描述你想构建什么，询问它在系统设计上有什么不同的选择，最终共同确定一个方案。你和AI应该互相提问，而不是单行道。</li>
</ol>
<h2 data-id="heading-1">法则二：CLAUDE.md不是文档，而是AI的大脑。</h2>
<p>CLAUDE.md是一个极其重要但常被误用的配置文件。在你每次启动会话时，Claude都会首先读取它。大多数人要么完全忽略它，要么用一些垃圾信息填满它，结果反而让Claude的表现更糟。</p>
<p>要写好一个CLAUDE.md，请遵循以下四个关键法则：</p>
<ul>
<li>保持简短： Claude一次只能可靠地遵循大约150-200条指令，而系统提示本身已经占用了大约50条。你的每一条新指令都在争夺它的注意力。如果你的CLAUDE.md写得像本小说，Claude就会开始随机忽略某些内容。</li>
<li>专注于项目特性： 不要告诉它什么是“组件”文件夹，它早就知道了。你应该告诉它你项目里那些“奇怪”的东西，比如你特有的bash命令或工作流程。</li>
<li>解释“为什么”，而不仅是“做什么”： 当你给出指令背后的原因时，Claude能更好地理解意图并做出更优的判断。只说“使用TypeScript严格模式”是可以的，但说“使用TypeScript严格模式，因为我们曾因隐式any类型导致过生产环境的bug”效果会好得多。</li>
<li>持续更新： CLAUDE.md应该是一份“活文档”。当你工作时，可以按 # 键快速将当前指令添加到文件中。每当你发现自己第二次纠正Claude同一个问题时，这就是一个明确的信号：这条规则应该被写入CLAUDE.md。</li>
</ul>
<p>一个糟糕的 CLAUDE.md 读起来像是给新员工写的入职文档。而一个优秀的 CLAUDE.md 读起来像是你为明天会失忆的自己留下的核心笔记。</p>
<h2 data-id="heading-2">法则三：200k上下文是甜蜜的陷阱，别掉进去。</h2>
<p>这是一个反直觉的事实：模型性能的下降远在上下文窗口被完全填满之前就开始了，通常在使用率达到20-40%时就会出现明显的衰减。</p>
<p>这就是为什么有时候即使你压缩了上下文（使用 /compact 命令），Claude仍然会给出糟糕的输出。因为在压缩之前，模型的性能就已经退化了。</p>
<p>以下是有效管理上下文的几个实用策略：</p>
<ul>
<li>划分对话范围 (Scope your conversations): 每个功能或任务使用一个独立的对话。不要在同一个对话里既构建认证系统又重构数据库层。</li>
<li>使用外部记忆 (Use external memory): 对于复杂的任务，让Claude将计划和进度写入像 SCRATCHPAD.md 这样的外部文件中。这样第二天你回来时，Claude可以读取文件，从上次中断的地方继续。</li>
<li>“复制-粘贴”重置法 (The copy-paste reset): 当上下文变得臃肿时，复制对话中的关键信息，运行 /compact 和 /clear 清空上下文，然后只把最重要的信息粘贴回来。一个清爽的上下文远胜于退化的上下文。</li>
<li>果断清空 (Know when to clear): 如果一个对话已经偏离了轨道，直接用 /clear 重新开始。这几乎总是比试图纠正一个混乱的对话要好。</li>
</ul>
<p>记住这个心智模型：Claude是无状态的。除了你明确给它的东西，每个对话都是从零开始。请据此规划。</p>
<h2 data-id="heading-3">法则四：架构决定一切，规划无可替代。</h2>
<p>架构至关重要，尤其是在软件工程中。如果你不先思考结构，AI生成的代码就会有巨大的“自由发挥”空间，而这恰恰是问题的根源。你不能跳过规划。</p>
<p>比较一下这两种提问方式的天壤之别：模糊的请求是“给我建一个认证系统”，而一个经过规划的、具体的请求是“使用现有的User模型构建电子邮件/密码认证功能，将session存储在Redis中并设置24小时过期，并添加中间件保护/api/protected下的所有路由。”</p>
<p>前者给了AI过多的自由，结果可能是混乱的。后者给了它一个清晰的蓝图，结果会精准得多。花5分钟进行架构规划，可以为你省下后续数小时的调试时间。</p>
<h2 data-id="heading-4">法则五：停止抱怨模型，糟糕的输出源于你糟糕的输入。</h2>
<p>当得到不理想的结果时，人们的第一反应往往是抱怨模型。但现实是残酷的：别再怪模型了。如果你用Opus 4.5还得不到好结果，问题出在你身上，而不是AI。你的输入和提示方式烂透了，句号。</p>
<p>想要提升输出质量，先要提升你的输入质量：</p>
<ul>
<li>具体说明你想要什么 (Be specific about what you want)： 你的指令越清晰、越具体，结果就越好。</li>
<li>告诉它不要做什么 (Tell it what NOT to do)： Claude 4.5尤其有过度设计的倾向。如果你想要一个简约的方案，就明确告诉它：“保持简单，不要添加我没要求的抽象，如果可能的话，只用一个文件。”</li>
<li>提供“为什么”的背景 (Give it context about why)： 告诉它“这个功能需要在每个请求上运行，所以性能至关重要”，或者“这只是一个原型，用完就扔”，这些约束会彻底改变模型解决问题的思路。</li>
</ul>
<p>一个专家级的工作流是：用Opus进行规划和架构设计，然后切换到Sonnet进行具体实现。 Opus更擅长复杂推理，而Sonnet更快、更便宜，非常适合执行明确的任务。当然，如果你是通过API按量付费，用Opus写每一行代码，那你可能得考虑卖掉一个肾了。</p>
<p>记住这个真理：如果你的输出很糟糕，那是因为你的输入很糟糕。没有捷径可走。</p>
<h2 data-id="heading-5">法则六：勇于实验，配置决定你的上限。</h2>
<p>Claude拥有一个极其丰富的功能生态系统：MCP服务器、Hooks、自定义斜杠命令、settings.json配置等等。你不需要全部掌握，但你应该去尝试和实验。</p>
<ul>
<li>MCP (Model Context Protocol): 让Claude连接到外部服务，如Slack、GitHub、数据库。如果你发现自己总是在复制粘贴信息，很可能有MCP服务器能帮你自动化。</li>
<li>Hooks: 让代码在Claude修改前后自动运行。想让Prettier格式化每个文件？用Hook。想在每次编辑后进行类型检查？用Hook。这能立即捕获问题。</li>
<li>自定义斜杠命令: 把你重复使用的提示词打包成命令。在.claude/commands文件夹里创建markdown文件，然后你就可以用/commandname来运行它们。</li>
</ul>
<p>这些模型每周都在进步。一个月前行不通的功能，现在可能已经可以了。保持好奇心，不断重新测试。</p>
<h2 data-id="heading-6">法则七：当你被卡住时，停止强推，改变方法。</h2>
<p>有时Claude会陷入一个循环：尝试、失败、再尝试、再失败。在这种情况下，人的本能是继续解释、提供更多指令。但更好的做法是彻底改变你的方法。</p>
<ul>
<li>清空对话 (Clear the conversation)： 累积的上下文可能正在迷惑它，一个全新的开始可以解决问题。</li>
<li>简化任务 (Simplify the task)： 如果一个复杂任务让Claude举步维艰，把它分解成更小的部分。顺便说一句，如果Claude处理复杂任务很吃力，这通常意味着你的初始计划就不够充分。</li>
<li>展示而非告知 (Show instead of tell)： 如果Claude一直无法理解，亲手写一个最小化的正确示例，然后告诉它：“看，最终输出应该像这样。现在把这个模式应用到其他部分。”</li>
<li>重构问题 (Be creative)： 换一个角度来描述你的问题。有时候你最初的表述方式可能不符合Claude的“思维模型”。</li>
</ul>
<p>如果你发现自己已经重复解释了三遍，是时候改变策略了。</p>
<h2 data-id="heading-7">法则八：超越聊天模式，构建自动化系统。</h2>
<p>真正从Claude中获得巨大价值的人，并不仅仅把它当作一个交互式工具。他们正在构建以Claude为核心组件的自动化系统。</p>
<p>通过 -p 标志，你可以在无头模式（headless mode）下运行Claude。这意味着你可以编写脚本，将它的输出通过管道传递给其他工具，与bash命令链接，并将其集成到自动化工作流中。</p>
<p>企业正在用这种方式实现自动化的代码审查（PR review）、支持工单响应、日志记录和文档更新。所有这些都是可记录、可审计的，并且随着时间的推移不断改进。</p>
<p>这就形成了一个强大的飞轮效应：Claude犯了一个错误，你审查日志，然后改进CLAUDE.md或相关工具，下一次Claude就会做得更好。这种改进是复合式的。如果你只在交互模式下使用Claude，你正在错失它真正的价值。</p>
<h2 data-id="heading-8">结语：你的AI，你的责任</h2>
<p>真正掌握像Claude这样的AI开发工具，关键在于思维模式的转变——从一个简单的指令发出者，转变为一个 meticulous 的规划者、配置者和系统构建者。你不是在和它聊天，你是在编程它。</p>
<p>最后，留给你一个问题思考： 如果你不把Claude当作聊天机器人，而是看作一个可编程的团队成员，你最先会自动化工作流程的哪个部分？</p>
<p>更多关于AI Coding的内容可关注我的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdidispace.com" target="_blank" title="https://didispace.com" ref="nofollow noopener noreferrer">博客</a>获取持续更新。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Three.js 开发快速入门]]></title>    <link>https://juejin.cn/post/7595041883144568878</link>    <guid>https://juejin.cn/post/7595041883144568878</guid>    <pubDate>2026-01-14T10:07:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595041883144568878" data-draft-id="7595021656428019739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Three.js 开发快速入门"/> <meta itemprop="keywords" content="three.js"/> <meta itemprop="datePublished" content="2026-01-14T10:07:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王校长"/> <meta itemprop="url" content="https://juejin.cn/user/2295436010076631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Three.js 开发快速入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2295436010076631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王校长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T10:07:53.000Z" title="Wed Jan 14 2026 10:07:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>本文档将介绍Three.js开发中的快速入门知识点，包括控制器使用、物体变换、材质纹理、雾效、模型加载等内容。通过这些实例，您将掌握Three.js的核心概念和实用技巧。</p>
<h2 data-id="heading-1">第一部分：控制器和辅助坐标系</h2>
<h3 data-id="heading-2">1. 轨道控制器（OrbitControls）</h3>
<p>轨道控制器允许用户通过鼠标拖拽、滚轮缩放等方式来改变相机视角，这对于3D场景的浏览非常有用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入轨道控制器</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/controls/OrbitControls.js"</span>;

<span class="hljs-comment">// 添加轨道控制器</span>
<span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>);
<span class="hljs-comment">// 设置带阻尼的惯性</span>
controls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>;
<span class="hljs-comment">// 设置阻尼系数</span>
controls.<span class="hljs-property">dampingFactor</span> = <span class="hljs-number">0.05</span>;
<span class="hljs-comment">// 设置自动旋转（可选）</span>
controls.<span class="hljs-property">autoRotate</span> = <span class="hljs-literal">true</span>;
</code></pre>
<h3 data-id="heading-3">2. 辅助坐标系（AxesHelper）</h3>
<p>辅助坐标系可以帮助开发者可视化场景中的坐标轴方向：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加世界坐标辅助器</span>
<span class="hljs-keyword">const</span> axesHelper = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AxesHelper</span>(<span class="hljs-number">5</span>);
scene.<span class="hljs-title function_">add</span>(axesHelper);
</code></pre>
<h3 data-id="heading-4">3. 动画循环中更新控制器</h3>
<p>为了使控制器的阻尼效果生效，需要在动画循环中调用<code>controls.update()</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
  controls.<span class="hljs-title function_">update</span>();  <span class="hljs-comment">// 必须在动画循环中调用</span>
  <span class="hljs-title function_">requestAnimationFrame</span>(animate);
  renderer.<span class="hljs-title function_">render</span>(scene, camera);
}
<span class="hljs-title function_">animate</span>();
</code></pre>
<h2 data-id="heading-5">第二部分：物体变换和层级关系</h2>
<h3 data-id="heading-6">1. 物体位移</h3>
<p>Three.js中每个对象都有position属性，用于控制物体的位置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 设置物体位置</span>
cube.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = <span class="hljs-number">2</span>;
cube.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 同时设置xyz坐标</span>
</code></pre>
<h3 data-id="heading-7">2. 父子层级关系</h3>
<p>在Three.js中，可以建立物体间的父子关系，子物体的变换会受到父物体的影响：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建父物体</span>
<span class="hljs-keyword">let</span> parentCube = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, parentMaterial);
<span class="hljs-comment">// 创建子物体</span>
<span class="hljs-keyword">const</span> cube = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, material);
<span class="hljs-comment">// 将子物体添加到父物体上</span>
parentCube.<span class="hljs-title function_">add</span>(cube);
<span class="hljs-comment">// 设置父物体位置</span>
parentCube.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(-<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
<span class="hljs-comment">// 设置子物体位置（相对于父物体）</span>
cube.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
</code></pre>
<h3 data-id="heading-8">3. 旋转和缩放</h3>
<p>除了位置变换，还可以对物体进行旋转和缩放：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 旋转 - 使用弧度制</span>
cube.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">4</span>;  <span class="hljs-comment">// 绕X轴旋转45度</span>
<span class="hljs-comment">// 缩放</span>
cube.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>);  <span class="hljs-comment">// 在xyz轴上都放大2倍</span>
</code></pre>
<h2 data-id="heading-9">第三部分：响应式画布与全屏控制</h2>
<h3 data-id="heading-10">1. 响应式设计</h3>
<p>为了让Three.js应用在窗口大小改变时自适应，需要监听resize事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 监听窗口变化</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"resize"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 重置渲染器宽高比</span>
  renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
  <span class="hljs-comment">// 重置相机宽高比</span>
  camera.<span class="hljs-property">aspect</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
  <span class="hljs-comment">// 更新相机投影矩阵</span>
  camera.<span class="hljs-title function_">updateProjectionMatrix</span>();
});
</code></pre>
<h3 data-id="heading-11">2. 全屏功能</h3>
<p>可以通过浏览器API实现全屏功能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 全屏</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">requestFullscreen</span>();

<span class="hljs-comment">// 退出全屏</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">exitFullscreen</span>();
</code></pre>
<h3 data-id="heading-12">3. 自定义全屏按钮</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"button"</span>);
btn.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"点击全屏"</span>;
btn.<span class="hljs-property">style</span>.<span class="hljs-property">position</span> = <span class="hljs-string">"absolute"</span>;
btn.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">"10px"</span>;
btn.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">"10px"</span>;
btn.<span class="hljs-property">style</span>.<span class="hljs-property">zIndex</span> = <span class="hljs-string">"999"</span>;
btn.<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">requestFullscreen</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"全屏"</span>);
};
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(btn);
</code></pre>
<h2 data-id="heading-13">第四部分：使用lil-gui进行调试</h2>
<p>lil-gui是一个轻量级的图形界面库，非常适合用于Three.js开发过程中的参数调试。</p>
<h3 data-id="heading-14">1. 基本使用</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入lil-gui</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">GUI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/libs/lil-gui.module.min.js"</span>;

<span class="hljs-comment">// 创建GUI实例</span>
<span class="hljs-keyword">const</span> gui = <span class="hljs-keyword">new</span> <span class="hljs-title function_">GUI</span>();
</code></pre>
<h3 data-id="heading-15">2. 添加控件</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加按钮</span>
gui.<span class="hljs-title function_">add</span>(eventObj, <span class="hljs-string">"Fullscreen"</span>).<span class="hljs-title function_">name</span>(<span class="hljs-string">"全屏"</span>);

<span class="hljs-comment">// 添加范围滑块</span>
gui.<span class="hljs-title function_">add</span>(cube.<span class="hljs-property">position</span>, <span class="hljs-string">"x"</span>, -<span class="hljs-number">5</span>, <span class="hljs-number">5</span>).<span class="hljs-title function_">name</span>(<span class="hljs-string">"立方体x轴位置"</span>);

<span class="hljs-comment">// 创建文件夹组织控件</span>
<span class="hljs-keyword">let</span> folder = gui.<span class="hljs-title function_">addFolder</span>(<span class="hljs-string">"立方体位置"</span>);
folder
  .<span class="hljs-title function_">add</span>(cube.<span class="hljs-property">position</span>, <span class="hljs-string">"x"</span>)
  .<span class="hljs-title function_">min</span>(-<span class="hljs-number">10</span>)
  .<span class="hljs-title function_">max</span>(<span class="hljs-number">10</span>)
  .<span class="hljs-title function_">step</span>(<span class="hljs-number">1</span>)
  .<span class="hljs-title function_">name</span>(<span class="hljs-string">"立方体x轴位置"</span>);

<span class="hljs-comment">// 添加颜色选择器</span>
gui.<span class="hljs-title function_">addColor</span>(colorParams, <span class="hljs-string">"cubeColor"</span>)
  .<span class="hljs-title function_">name</span>(<span class="hljs-string">"立方体颜色"</span>)
  .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> {
    cube.<span class="hljs-property">material</span>.<span class="hljs-property">color</span>.<span class="hljs-title function_">set</span>(val);
  });
</code></pre>
<h2 data-id="heading-16">第五部分：BufferGeometry详解</h2>
<h3 data-id="heading-17">1. BufferGeometry vs Geometry</h3>
<p>BufferGeometry是Three.js中更高效的几何体表示方式，它直接使用缓冲区存储顶点数据。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建BufferGeometry</span>
<span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferGeometry</span>();

<span class="hljs-comment">// 创建顶点数据（每三个数值代表一个顶点的xyz坐标）</span>
<span class="hljs-keyword">const</span> vertices = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>([
  -<span class="hljs-number">1.0</span>, -<span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>,  <span class="hljs-comment">// 第一个顶点</span>
  <span class="hljs-number">1.0</span>, -<span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>,   <span class="hljs-comment">// 第二个顶点</span>
  <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>,    <span class="hljs-comment">// 第三个顶点</span>
  -<span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>    <span class="hljs-comment">// 第四个顶点</span>
]);

<span class="hljs-comment">// 设置顶点属性</span>
geometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"position"</span>, <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferAttribute</span>(vertices, <span class="hljs-number">3</span>));
</code></pre>
<h3 data-id="heading-18">2. 使用索引绘制</h3>
<p>通过索引可以减少重复顶点数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建索引</span>
<span class="hljs-keyword">const</span> indices = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint16Array</span>([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>]);
<span class="hljs-comment">// 设置索引属性</span>
geometry.<span class="hljs-title function_">setIndex</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferAttribute</span>(indices, <span class="hljs-number">1</span>));
</code></pre>
<h2 data-id="heading-19">第六部分：顶点组与材质</h2>
<h3 data-id="heading-20">1. 多材质网格</h3>
<p>一个网格可以使用多个材质：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建多种材质</span>
<span class="hljs-keyword">const</span> cubematerial0 = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0x00ff00</span> });
<span class="hljs-keyword">const</span> cubematerial1 = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0xff0000</span> });
<span class="hljs-comment">// ... 更多材质</span>

<span class="hljs-comment">// 将多个材质传递给网格</span>
<span class="hljs-keyword">const</span> cube = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(cubegeometry, [
  cubematerial0,
  cubematerial1,
  <span class="hljs-comment">// ... 其他材质</span>
]);
</code></pre>
<h3 data-id="heading-21">2. 顶点组</h3>
<p>通过顶点组可以指定哪些面使用哪个材质：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 设置2个顶点组，形成2个材质区域</span>
geometry.<span class="hljs-title function_">addGroup</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>);  <span class="hljs-comment">// 从索引0开始的3个面使用第0个材质</span>
geometry.<span class="hljs-title function_">addGroup</span>(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>);  <span class="hljs-comment">// 从索引3开始的3个面使用第1个材质</span>
</code></pre>
<h2 data-id="heading-22">第七部分：材质与纹理</h2>
<h3 data-id="heading-23">1. 纹理加载</h3>
<p>Three.js提供了多种纹理类型，可以为材质添加丰富的视觉效果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建纹理加载器</span>
<span class="hljs-keyword">let</span> textureLoader = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">TextureLoader</span>();
<span class="hljs-comment">// 加载纹理</span>
<span class="hljs-keyword">let</span> texture = textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"./texture/image.png"</span>);
</code></pre>
<h3 data-id="heading-24">2. 不同类型的纹理映射</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基础颜色贴图</span>
planeMaterial.<span class="hljs-property">map</span> = texture;

<span class="hljs-comment">// AO贴图（环境遮挡）</span>
planeMaterial.<span class="hljs-property">aoMap</span> = aoMap;
planeMaterial.<span class="hljs-property">aoMapIntensity</span> = <span class="hljs-number">1</span>;

<span class="hljs-comment">// 透明度贴图</span>
planeMaterial.<span class="hljs-property">alphaMap</span> = alphaMap;

<span class="hljs-comment">// 高光贴图</span>
planeMaterial.<span class="hljs-property">specularMap</span> = specularMap;
</code></pre>
<h3 data-id="heading-25">3. 纹理颜色空间</h3>
<p>不同的纹理应使用适当的颜色空间：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 设置颜色空间</span>
texture.<span class="hljs-property">colorSpace</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">SRGBColorSpace</span>;      <span class="hljs-comment">// 颜色贴图</span>
<span class="hljs-comment">// texture.colorSpace = THREE.LinearSRGBColorSpace;  // 法线贴图等</span>
</code></pre>
<h2 data-id="heading-26">第八部分：雾效（Fog）</h2>
<p>Three.js提供了两种雾效类型：线性雾和指数雾。</p>
<h3 data-id="heading-27">1. 线性雾</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 线性雾：在指定距离范围内逐渐显现雾效</span>
scene.<span class="hljs-property">fog</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Fog</span>(<span class="hljs-number">0x999999</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">50</span>);  <span class="hljs-comment">// 颜色, 近距离, 远距离</span>
</code></pre>
<h3 data-id="heading-28">2. 指数雾</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 指数雾：随距离呈指数增长的雾效</span>
scene.<span class="hljs-property">fog</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">FogExp2</span>(<span class="hljs-number">0x999999</span>, <span class="hljs-number">0.1</span>);  <span class="hljs-comment">// 颜色, 密度</span>
</code></pre>
<h2 data-id="heading-29">第九部分：GLTF模型加载</h2>
<p>GLTF是一种通用的3D模型格式，Three.js提供了专门的加载器。</p>
<h3 data-id="heading-30">1. 基本GLTF加载</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">GLTFLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/loaders/GLTFLoader.js"</span>;

<span class="hljs-comment">// 实例化加载器</span>
<span class="hljs-keyword">const</span> gltfLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GLTFLoader</span>();

<span class="hljs-comment">// 加载模型</span>
gltfLoader.<span class="hljs-title function_">load</span>(
  <span class="hljs-string">"./model/model.glb"</span>,  <span class="hljs-comment">// 模型路径</span>
  <span class="hljs-function">(<span class="hljs-params">gltf</span>) =&gt;</span> {          <span class="hljs-comment">// 加载完成回调</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gltf);
    scene.<span class="hljs-title function_">add</span>(gltf.<span class="hljs-property">scene</span>);
  }
);
</code></pre>
<h3 data-id="heading-31">2. 使用DRACO压缩</h3>
<p>DRACO是一种3D几何压缩技术，可以显著减小模型文件大小：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">DRACOLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/loaders/DRACOLoader.js"</span>;

<span class="hljs-comment">// 实例化DRACO加载器</span>
<span class="hljs-keyword">const</span> dracoLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DRACOLoader</span>();
<span class="hljs-comment">// 设置DRACO解码器路径</span>
dracoLoader.<span class="hljs-title function_">setDecoderPath</span>(<span class="hljs-string">"./draco/"</span>);
<span class="hljs-comment">// 设置GLTF加载器使用DRACO解码器</span>
gltfLoader.<span class="hljs-title function_">setDRACOLoader</span>(dracoLoader);
</code></pre>
<h2 data-id="heading-32">第十部分：光线投射与物体交互</h2>
<p>光线投射（Raycasting）是检测鼠标与3D物体交互的重要技术。</p>
<h3 data-id="heading-33">1. 基本光线投射</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建射线</span>
<span class="hljs-keyword">const</span> raycaster = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Raycaster</span>();
<span class="hljs-comment">// 创建鼠标向量</span>
<span class="hljs-keyword">const</span> mouse = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector2</span>();

<span class="hljs-comment">// 监听鼠标点击事件</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 设置鼠标向量的x,y值（转换为标准化设备坐标）</span>
  mouse.<span class="hljs-property">x</span> = (event.<span class="hljs-property">clientX</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>) * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>;
  mouse.<span class="hljs-property">y</span> = -((event.<span class="hljs-property">clientY</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>) * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>);

  <span class="hljs-comment">// 通过相机和鼠标位置更新射线</span>
  raycaster.<span class="hljs-title function_">setFromCamera</span>(mouse, camera);

  <span class="hljs-comment">// 计算物体和射线的交点</span>
  <span class="hljs-keyword">const</span> intersects = raycaster.<span class="hljs-title function_">intersectObjects</span>([sphere1, sphere2, sphere3]);

  <span class="hljs-keyword">if</span> (intersects.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 处理交点</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(intersects[<span class="hljs-number">0</span>].<span class="hljs-property">object</span>);
  }
});
</code></pre>
<h2 data-id="heading-34">第十一部分：Tween补间动画</h2>
<p>Tween.js提供了一种简单的方式来创建平滑的动画效果。</p>
<h3 data-id="heading-35">1. 基本补间动画</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">TWEEN</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/libs/tween.module.js"</span>;

<span class="hljs-comment">// 创建补间动画</span>
<span class="hljs-keyword">const</span> tween = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">TWEEN</span>.<span class="hljs-title class_">Tween</span>(sphere1.<span class="hljs-property">position</span>);
tween.<span class="hljs-title function_">to</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">4</span> }, <span class="hljs-number">1000</span>);  <span class="hljs-comment">// 在1000毫秒内移动到x=4的位置</span>

<span class="hljs-comment">// 启动动画</span>
tween.<span class="hljs-title function_">start</span>();
</code></pre>
<h3 data-id="heading-36">2. 动画回调和链式调用</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加回调函数</span>
tween
  .<span class="hljs-title function_">onStart</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开始"</span>))
  .<span class="hljs-title function_">onComplete</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"结束"</span>))
  .<span class="hljs-title function_">onUpdate</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"更新"</span>));

<span class="hljs-comment">// 链式动画</span>
<span class="hljs-keyword">let</span> tween2 = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">TWEEN</span>.<span class="hljs-title class_">Tween</span>(sphere1.<span class="hljs-property">position</span>);
tween2.<span class="hljs-title function_">to</span>({ <span class="hljs-attr">x</span>: -<span class="hljs-number">4</span> }, <span class="hljs-number">1000</span>);

tween.<span class="hljs-title function_">chain</span>(tween2);   <span class="hljs-comment">// tween完成后执行tween2</span>
tween2.<span class="hljs-title function_">chain</span>(tween);   <span class="hljs-comment">// tween2完成后执行tween</span>
</code></pre>
<h3 data-id="heading-37">3. 在动画循环中更新</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
  controls.<span class="hljs-title function_">update</span>();
  <span class="hljs-title function_">requestAnimationFrame</span>(animate);
  renderer.<span class="hljs-title function_">render</span>(scene, camera);
  <span class="hljs-comment">// 更新tween动画</span>
  <span class="hljs-variable constant_">TWEEN</span>.<span class="hljs-title function_">update</span>();
}
<span class="hljs-title function_">animate</span>();
</code></pre>
<h2 data-id="heading-38">总结</h2>
<p>通过本教程，我们学习了Three.js开发中的多个重要概念：</p>
<ol>
<li><strong>控制器和辅助工具</strong>：轨道控制器帮助我们更好地浏览3D场景，辅助坐标系帮助我们理解空间关系</li>
<li><strong>物体变换</strong>：位置、旋转、缩放以及父子层级关系的处理</li>
<li><strong>响应式设计</strong>：适配不同屏幕尺寸和全屏功能的实现</li>
<li><strong>调试工具</strong>：使用lil-gui方便地调整参数</li>
<li><strong>几何体</strong>：BufferGeometry的使用方法和优势</li>
<li><strong>材质和纹理</strong>：如何为3D对象添加丰富的视觉效果</li>
<li><strong>雾效</strong>：增强场景深度感的技术</li>
<li><strong>模型加载</strong>：加载外部3D模型的方法</li>
<li><strong>交互</strong>：光线投射实现用户与3D对象的交互</li>
<li><strong>动画</strong>：使用Tween.js创建流畅的补间动画</li>
</ol>
<p>这些知识为深入学习Three.js奠定了坚实的基础，接下来可以继续学习光照、阴影、后期处理等更高级的特性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[antd6的table排序功能]]></title>    <link>https://juejin.cn/post/7595021077665759283</link>    <guid>https://juejin.cn/post/7595021077665759283</guid>    <pubDate>2026-01-14T10:09:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595021077665759283" data-draft-id="7595034434975678502" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="antd6的table排序功能"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-14T10:09:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子玖"/> <meta itemprop="url" content="https://juejin.cn/user/2154698523811047"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            antd6的table排序功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2154698523811047/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子玖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T10:09:52.000Z" title="Wed Jan 14 2026 10:09:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">antd6的table排序功能</h2>
<ul>
<li>技术栈：react 19 / ts / react-query</li>
<li>效果：升序-&gt;降序-&gt;去掉排序-&gt;升序一直循环</li>
<li>如果不需要接口，可跳到实现 <code>父组件</code></li>
<li>请求参数 ：
<ul>
<li>sort_by ：排序字段（created_at/updated_at）</li>
<li>order_by ：排序方向（asc/desc，默认asc）</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">接口实现</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src\api\test.ts</span>
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">SortField</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/types/device"</span>;
<span class="hljs-keyword">import</span> { apiClient } <span class="hljs-keyword">from</span> <span class="hljs-string">"./http"</span>; <span class="hljs-comment">// 只是axios请求</span>
<span class="hljs-keyword">import</span> { useQuery } <span class="hljs-keyword">from</span> <span class="hljs-string">"@tanstack/react-query"</span>;

<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">Response</span> {
  <span class="hljs-attr">list</span>: []
  <span class="hljs-attr">page</span>: number
  <span class="hljs-attr">size</span>: number
  <span class="hljs-attr">total</span>: number
}

<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">Params</span> {
  page?: number;
  pageSize?: number;
  sort_by?: <span class="hljs-title class_">SortField</span> | <span class="hljs-string">''</span>;
  order_by?: <span class="hljs-string">'asc'</span> | <span class="hljs-string">'desc'</span> | <span class="hljs-string">''</span>;
}


<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useGetList</span> = (<span class="hljs-params">params: Params</span>) =&gt; {
  <span class="hljs-keyword">return</span> useQuery&lt;<span class="hljs-title class_">Response</span>&gt;({
    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">'useGetList'</span>, params],
    <span class="hljs-attr">queryFn</span>: <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: response } = <span class="hljs-keyword">await</span> apiClient.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/test'</span>, { <span class="hljs-attr">params</span>: params })
      <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
    },
  })
}
</code></pre>
<h2 data-id="heading-2">定义类型</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src\types\test.ts</span>
<span class="hljs-comment">// 可排序字段</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SORTABLE_FIELDS</span> = [
  <span class="hljs-string">'created_at'</span>,
  <span class="hljs-string">'updated_at'</span>,
] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-keyword">export</span> type <span class="hljs-title class_">SortField</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-variable constant_">SORTABLE_FIELDS</span>[number];

<span class="hljs-keyword">export</span> type <span class="hljs-title class_">SortOrderBE</span> = <span class="hljs-string">'asc'</span> | <span class="hljs-string">'desc'</span> | <span class="hljs-literal">undefined</span>;
<span class="hljs-keyword">export</span> type <span class="hljs-title class_">SortOrderUI</span> = <span class="hljs-string">'ascend'</span> | <span class="hljs-string">'descend'</span>;
</code></pre>
<h2 data-id="heading-3">父组件</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// src\views\test\index.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useGetList, <span class="hljs-keyword">type</span> <span class="hljs-title class_">Device</span>, <span class="hljs-keyword">type</span> useGetDeviceListParams, } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/test'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">SortField</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types/test'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-title class_">DeviceTable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/DeviceTable'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">INIT_VALUES</span> = { <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span> };

<span class="hljs-keyword">const</span> <span class="hljs-title class_">DeviceManagement</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {

  <span class="hljs-keyword">const</span> [params, setParams] = <span class="hljs-title function_">useState</span>({ ...<span class="hljs-variable constant_">INIT_VALUES</span> });
  
<span class="hljs-comment">// ⭐这里是重点</span>
  <span class="hljs-comment">// 排序处理</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSortChange</span> = (<span class="hljs-params">sortBy?: SortField | <span class="hljs-string">''</span>, orderBy?: <span class="hljs-string">'asc'</span> | <span class="hljs-string">'desc'</span> | <span class="hljs-string">''</span></span>) =&gt; {
    <span class="hljs-title function_">setParams</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> ({
      ...prev,
      <span class="hljs-attr">sort_by</span>: sortBy ?? <span class="hljs-string">''</span>,
      <span class="hljs-attr">order_by</span>: orderBy ?? <span class="hljs-string">''</span>,
    }));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">DeviceTable</span>
      // <span class="hljs-attr">多余的配置参数省略</span>，<span class="hljs-attr">也就是一些配置page</span>/<span class="hljs-attr">data之类</span>
        <span class="hljs-attr">sortBy</span>=<span class="hljs-string">{params.sort_by}</span>
        <span class="hljs-attr">orderBy</span>=<span class="hljs-string">{params.order_by}</span>
        <span class="hljs-attr">onSortChange</span>=<span class="hljs-string">{handleSortChange}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
};
  
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">DeviceManagement</span>;
</code></pre>
<h2 data-id="heading-4">子组件</h2>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Table</span>, type <span class="hljs-title class_">TableProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">Device</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/device'</span>;
<span class="hljs-keyword">import</span> {  type <span class="hljs-title class_">SortField</span>, type <span class="hljs-title class_">SortOrderBE</span>, type <span class="hljs-title class_">SortOrderUI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types/test'</span>;

interface <span class="hljs-title class_">DeviceTableProps</span> {
  sortBy?: <span class="hljs-title class_">SortField</span> | <span class="hljs-string">''</span>;
  orderBy?: <span class="hljs-title class_">SortOrderBE</span> | <span class="hljs-string">''</span>; <span class="hljs-comment">// 改为后端类型，允许空字符串</span>
  onSortChange?: <span class="hljs-function">(<span class="hljs-params">sortBy: SortField | <span class="hljs-string">''</span>, orderBy: SortOrderBE | <span class="hljs-string">''</span></span>) =&gt;</span> <span class="hljs-keyword">void</span>;
}


<span class="hljs-comment">// ⭐这里是重点</span>
<span class="hljs-comment">/* ---------- 工具 ---------- */</span>
<span class="hljs-keyword">const</span> toUIOrder = (be?: <span class="hljs-title class_">SortOrderBE</span> | <span class="hljs-string">''</span>): <span class="hljs-title class_">SortOrderUI</span> | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span>{
  <span class="hljs-keyword">return</span> be === <span class="hljs-string">'asc'</span> ? <span class="hljs-string">'ascend'</span> : be === <span class="hljs-string">'desc'</span> ? <span class="hljs-string">'descend'</span> : <span class="hljs-literal">undefined</span>;
}
<span class="hljs-comment">/**
 * 设备表格组件
 * 展示设备列表数据并提供分页和编辑功能
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">DeviceTable</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">DeviceTableProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
  sortBy,
  orderBy,
  onSortChange,
}</span>) =&gt;</span> {

  <span class="hljs-comment">// 表格列配置</span>
  <span class="hljs-keyword">const</span> columns = [
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'ID'</span>,
      <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">'id'</span>,
      <span class="hljs-attr">key</span>: <span class="hljs-string">'id'</span>,
      <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>,
    },
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'创建时间'</span>,
      <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">'created_at'</span>,
      <span class="hljs-attr">key</span>: <span class="hljs-string">'created_at'</span>,
      <span class="hljs-attr">width</span>: <span class="hljs-number">170</span>,
      <span class="hljs-attr">sorter</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">sortOrder</span>: sortBy === <span class="hljs-string">'created_at'</span> ? <span class="hljs-title function_">toUIOrder</span>(orderBy) : <span class="hljs-literal">null</span>,
    },
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'更新时间'</span>,
      <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">'updated_at'</span>,
      <span class="hljs-attr">key</span>: <span class="hljs-string">'updated_at'</span>,
      <span class="hljs-attr">width</span>: <span class="hljs-number">170</span>,
      <span class="hljs-attr">sorter</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">sortOrder</span>: sortBy === <span class="hljs-string">'updated_at'</span> ? <span class="hljs-title function_">toUIOrder</span>(orderBy) : <span class="hljs-literal">null</span>,
    },
  ];

<span class="hljs-comment">// ⭐这里是重点</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">handleTableChange</span>: <span class="hljs-title class_">TableProps</span>&lt;<span class="hljs-title class_">Device</span>&gt;[<span class="hljs-string">'onChange'</span>] = <span class="hljs-function">(<span class="hljs-params">_, __, sorter</span>) =&gt;</span> {
  <span class="hljs-comment">// 如果 sorter 是数组或者没有字段，直接返回</span>
  <span class="hljs-keyword">const</span> single = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(sorter) ? sorter[<span class="hljs-number">0</span>] : sorter;
  <span class="hljs-keyword">const</span> field = single.<span class="hljs-property">field</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">SortField</span>;
  <span class="hljs-comment">// 三态：ascend → descend → null（取消）</span>
  <span class="hljs-keyword">if</span> (!single.<span class="hljs-property">order</span>) {
    <span class="hljs-comment">// 第三次点击：把 undefined 传出去</span>
    onSortChange?.(<span class="hljs-string">''</span>, <span class="hljs-string">''</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">const</span> order = single.<span class="hljs-property">order</span> === <span class="hljs-string">'ascend'</span> ? <span class="hljs-string">'asc'</span> : <span class="hljs-string">'desc'</span>;
  onSortChange?.(field, order);
};

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Table</span>
        <span class="hljs-attr">columns</span>=<span class="hljs-string">{columns}</span>
        // <span class="hljs-attr">其他配置省略</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleTableChange}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">DeviceTable</span>;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[图片标注框选组件]]></title>    <link>https://juejin.cn/post/7594320543219417134</link>    <guid>https://juejin.cn/post/7594320543219417134</guid>    <pubDate>2026-01-12T17:21:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594320543219417134" data-draft-id="7594309641867051046" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="图片标注框选组件"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-12T17:21:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FanetheDivine"/> <meta itemprop="url" content="https://juejin.cn/user/4246761716322491"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            图片标注框选组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4246761716322491/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FanetheDivine
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T17:21:18.000Z" title="Mon Jan 12 2026 17:21:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">实际效果</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b0610d273084ccea6292aa3ce8037b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768959999&amp;x-signature=W25g%2FE%2B24v%2FJgYxagcOhQlZsu2k%3D" alt="1.gif" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7a13c3d470d4cc7ab97d7c3daefbdd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768959999&amp;x-signature=9oR2QoEL95%2ByjaNf7xYYEV1%2BbUU%3D" alt="动画.gif" loading="lazy"/></p>
<h2 data-id="heading-1">主要思路</h2>
<ul>
<li>从img标签获取图片原始尺寸 获取图片容器尺寸</li>
<li>计算图片实际展示的宽高 将基于原始尺寸的坐标转化为基于展示尺寸的 并设置相应的拖拽区</li>
<li>选择框框使用motion.div构建 用x/y/width/height四个motion value描述</li>
<li>选择框框整体拖拽使用motion自带功能即可 但四边、四角的拖拽逻辑要手写</li>
<li>选择框按照左上角的位置进行排序 设置zindex 越靠上越靠左z越小 尽可能避免某个拖拽框被完全遮盖</li>
</ul>
<h2 data-id="heading-2">代码结构</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20d73b4c92b34716a08fdbc7a3778aa9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768959999&amp;x-signature=wvDyDmpTCjYLky8zuBFCYUaOnb4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">实际代码</h2>
<h3 data-id="heading-4">common.ts</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { match } <span class="hljs-keyword">from</span> <span class="hljs-string">'ts-pattern'</span>

<span class="hljs-comment">/** 选择框 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">SelectBox</span> = {
  <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 左上角坐标和右下角坐标 */</span>
  <span class="hljs-attr">position</span>: [<span class="hljs-attr">x1</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">y1</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">x2</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">y2</span>: <span class="hljs-built_in">number</span>]
  style?: {
    fill?: <span class="hljs-built_in">string</span>
    border?: <span class="hljs-built_in">string</span>
    borderWidth?: <span class="hljs-built_in">number</span>
  }
}

<span class="hljs-comment">/** 区域或图片的大小 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Size</span> = {
  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/** 获取图片的原始尺寸 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getImageNaturalSize</span>(<span class="hljs-params">src: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>()
  img.<span class="hljs-property">src</span> = src
  <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-property">withResolvers</span>&lt;<span class="hljs-title class_">Size</span>&gt;()
  img.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">width</span>: img.<span class="hljs-property">naturalWidth</span>, <span class="hljs-attr">height</span>: img.<span class="hljs-property">naturalHeight</span> })
  })
  img.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, reject)
  <span class="hljs-keyword">return</span> promise
}

<span class="hljs-comment">/** 计算图片的展示尺寸 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getDisplaySize</span>(<span class="hljs-params">naturalSize: Size, containerSize: Size</span>) {
  <span class="hljs-keyword">const</span> scaleX = containerSize.<span class="hljs-property">width</span> / naturalSize.<span class="hljs-property">width</span>
  <span class="hljs-keyword">const</span> scaleY = containerSize.<span class="hljs-property">height</span> / naturalSize.<span class="hljs-property">height</span>
  <span class="hljs-keyword">const</span> scale = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(scaleX, scaleY)
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">width</span>: naturalSize.<span class="hljs-property">width</span> * scale,
    <span class="hljs-attr">height</span>: naturalSize.<span class="hljs-property">height</span> * scale,
  }
}

<span class="hljs-comment">/** 计算选择框的z-index 使所有选择框都可以点击 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getBoxZIndexs</span>(<span class="hljs-params">boxs: SelectBox[]</span>) {
  <span class="hljs-keyword">const</span> keyMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">SelectBox</span>[<span class="hljs-string">'key'</span>], <span class="hljs-built_in">number</span>&gt;()
  <span class="hljs-comment">// 矩形靠上、靠左的 z较低</span>
  <span class="hljs-keyword">const</span> sorted = [...boxs].<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">A, B</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> {
      <span class="hljs-attr">position</span>: [<span class="hljs-title class_">Ax1</span>, <span class="hljs-title class_">Ay1</span>],
    } = A
    <span class="hljs-keyword">const</span> {
      <span class="hljs-attr">position</span>: [<span class="hljs-title class_">Bx1</span>, <span class="hljs-title class_">By1</span>],
    } = B
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Ay1</span> !== <span class="hljs-title class_">By1</span> ? <span class="hljs-title class_">Ay1</span> - <span class="hljs-title class_">By1</span> : <span class="hljs-title class_">Ax1</span> - <span class="hljs-title class_">Bx1</span>
  })
  sorted.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, i</span>) =&gt;</span> {
    keyMap.<span class="hljs-title function_">set</span>(item.<span class="hljs-property">key</span>, i)
  })
  <span class="hljs-keyword">return</span> boxs.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> keyMap.<span class="hljs-title function_">get</span>(item.<span class="hljs-property">key</span>))
}

<span class="hljs-comment">/**
 * 将基于原始尺寸的坐标转化为基于展示尺寸的坐标 或者反过来/
 * 转化后的坐标不小于0 不大于目标尺寸的最大值
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">convertPosition</span>(<span class="hljs-params">
  position: SelectBox[<span class="hljs-string">'position'</span>],
  naturalSize: Size,
  displaySize: Size,
  to: <span class="hljs-string">'natural'</span> | <span class="hljs-string">'display'</span>,
</span>) {
  <span class="hljs-keyword">const</span> [originSize, resultSize] = <span class="hljs-title function_">match</span>(to)
    .<span class="hljs-title function_">with</span>(<span class="hljs-string">'display'</span>, <span class="hljs-function">() =&gt;</span> [naturalSize, displaySize])
    .<span class="hljs-title function_">with</span>(<span class="hljs-string">'natural'</span>, <span class="hljs-function">() =&gt;</span> [displaySize, naturalSize])
    .<span class="hljs-title function_">exhaustive</span>()
  <span class="hljs-keyword">const</span> scaleX = resultSize.<span class="hljs-property">width</span> / originSize.<span class="hljs-property">width</span>
  <span class="hljs-keyword">const</span> scaleY = resultSize.<span class="hljs-property">height</span> / originSize.<span class="hljs-property">height</span>
  <span class="hljs-keyword">const</span> maxX = resultSize.<span class="hljs-property">width</span>
  <span class="hljs-keyword">const</span> maxY = resultSize.<span class="hljs-property">height</span>
  <span class="hljs-keyword">const</span> [x1, y1, x2, y2] = position
  <span class="hljs-keyword">return</span> [
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(x1 * scaleX, maxX)),
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(y1 * scaleY, maxY)),
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(x2 * scaleX, maxX)),
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(y2 * scaleY, maxY)),
  ] <span class="hljs-keyword">as</span> <span class="hljs-title class_">SelectBox</span>[<span class="hljs-string">'position'</span>]
}

<span class="hljs-comment">/** 获取符合左上右下顺序的position */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getLegalPosition</span>(<span class="hljs-params">position: SelectBox[<span class="hljs-string">'position'</span>]</span>) {
  <span class="hljs-keyword">const</span> [_x1, _y1, _x2, _y2] = position
  <span class="hljs-keyword">const</span> [x1, x2] = _x1 &lt;= _x2 ? [_x1, _x2] : [_x2, _x1]
  <span class="hljs-keyword">const</span> [y1, y2] = _y1 &lt;= _y2 ? [_y1, _y2] : [_y2, _y1]
  <span class="hljs-keyword">return</span> [x1, y1, x2, y2] <span class="hljs-keyword">as</span> <span class="hljs-title class_">SelectBox</span>[<span class="hljs-string">'position'</span>]
}

<span class="hljs-comment">/** 拖拽方向类型 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">DragDirection</span> =
  | <span class="hljs-string">'top'</span>
  | <span class="hljs-string">'top-left'</span>
  | <span class="hljs-string">'top-right'</span>
  | <span class="hljs-string">'left'</span>
  | <span class="hljs-string">'right'</span>
  | <span class="hljs-string">'bottom'</span>
  | <span class="hljs-string">'bottom-left'</span>
  | <span class="hljs-string">'bottom-right'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">DirectionCursorMap</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">DragDirection</span>, <span class="hljs-built_in">string</span>&gt; = {
  <span class="hljs-attr">top</span>: <span class="hljs-string">'ns-resize'</span>,
  <span class="hljs-attr">bottom</span>: <span class="hljs-string">'ns-resize'</span>,
  <span class="hljs-attr">left</span>: <span class="hljs-string">'ew-resize'</span>,
  <span class="hljs-attr">right</span>: <span class="hljs-string">'ew-resize'</span>,
  <span class="hljs-string">'top-left'</span>: <span class="hljs-string">'nwse-resize'</span>,
  <span class="hljs-string">'bottom-right'</span>: <span class="hljs-string">'nwse-resize'</span>,
  <span class="hljs-string">'top-right'</span>: <span class="hljs-string">'nesw-resize'</span>,
  <span class="hljs-string">'bottom-left'</span>: <span class="hljs-string">'nesw-resize'</span>,
}

<span class="hljs-comment">/** 根据拖拽方向获取鼠标指针样式 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCursorStyle</span>(<span class="hljs-params">dir: DragDirection</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">DirectionCursorMap</span>[dir]
}

</code></pre>
<h3 data-id="heading-5">index.tsx</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> {
  useRef,
  forwardRef,
  useImperativeHandle,
  useState,
  useMemo,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Skeleton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>
<span class="hljs-keyword">import</span> { useMemoizedFn, useSize } <span class="hljs-keyword">from</span> <span class="hljs-string">'ahooks'</span>
<span class="hljs-keyword">import</span> useSWR <span class="hljs-keyword">from</span> <span class="hljs-string">'swr'</span>
<span class="hljs-keyword">import</span> { match, P } <span class="hljs-keyword">from</span> <span class="hljs-string">'ts-pattern'</span>
<span class="hljs-keyword">import</span> { cn } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SelectBoxComponent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SelectBoxComponent'</span>
<span class="hljs-keyword">import</span> {
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">SelectBox</span>,
  convertPosition,
  getImageNaturalSize,
  getDisplaySize,
  getBoxZIndexs,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'./common'</span>

<span class="hljs-keyword">export</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">SelectBox</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">ImageSelectBoxProps</span> = <span class="hljs-title class_">Style</span> &amp; {
  <span class="hljs-attr">src</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">boxs</span>: <span class="hljs-title class_">SelectBox</span>[]
  <span class="hljs-attr">onPositionChange</span>: <span class="hljs-function">(<span class="hljs-params">key: SelectBox[<span class="hljs-string">'key'</span>], position: SelectBox[<span class="hljs-string">'position'</span>]</span>) =&gt;</span> <span class="hljs-built_in">void</span>
  onCreateBox?: <span class="hljs-function">(<span class="hljs-params">position: SelectBox[<span class="hljs-string">'position'</span>]</span>) =&gt;</span> <span class="hljs-built_in">void</span>
  onClick?: <span class="hljs-function">(<span class="hljs-params">boxKey: SelectBox[<span class="hljs-string">'key'</span>] | <span class="hljs-literal">undefined</span>, e: React.MouseEvent</span>) =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">ImageSelectBoxInstance</span> = {
  <span class="hljs-comment">/** 调用此函数后 在拖拽区点击 便可创建一个新的区域并开启其拖拽 */</span>
  <span class="hljs-attr">createBox</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ImageSelectBox</span> = forwardRef&lt;<span class="hljs-title class_">ImageSelectBoxInstance</span>, <span class="hljs-title class_">ImageSelectBoxProps</span>&gt;(
  <span class="hljs-function">(<span class="hljs-params">props, ref</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { src, boxs, onPositionChange, onCreateBox, onClick, className, style } = props

    <span class="hljs-comment">// 图片和拖拽区的尺寸</span>
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: naturalSize, isValidating, error } = <span class="hljs-title function_">useSWR</span>(src, getImageNaturalSize)
    <span class="hljs-keyword">const</span> containerRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>)
    <span class="hljs-keyword">const</span> containerSize = <span class="hljs-title function_">useSize</span>(containerRef)
    <span class="hljs-comment">// 计算展示尺寸</span>
    <span class="hljs-keyword">const</span> displaySize = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (!naturalSize || !containerSize) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
      <span class="hljs-keyword">const</span> size = <span class="hljs-title function_">getDisplaySize</span>(naturalSize, containerSize)
      <span class="hljs-keyword">return</span> size
    }, [containerSize, naturalSize])
    <span class="hljs-keyword">const</span> dragRange = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>)

    <span class="hljs-comment">// 为选择框设置zindex 避免重叠遮挡</span>
    <span class="hljs-keyword">const</span> zIndexList = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> zList = <span class="hljs-title function_">getBoxZIndexs</span>(boxs)
      <span class="hljs-keyword">return</span> zList
    }, [boxs])
    
    <span class="hljs-comment">// 用于点击选择框事件 如果指针移动 则不触发此事件</span>
    <span class="hljs-keyword">const</span> pointerMoved = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>)

    <span class="hljs-comment">// 创建选择框</span>
    <span class="hljs-keyword">const</span> isCreating = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>)
    <span class="hljs-keyword">const</span> [creatingInitPosition, setInitPosition] = useState&lt;<span class="hljs-title class_">SelectBox</span>[<span class="hljs-string">'position'</span>]&gt;()
    <span class="hljs-keyword">const</span> createBox = <span class="hljs-title function_">useMemoizedFn</span>(<span class="hljs-function">() =&gt;</span> {
      isCreating.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>
    })
    <span class="hljs-title function_">useImperativeHandle</span>(
      ref,
      <span class="hljs-function">() =&gt;</span> ({
        createBox,
      }),
      [createBox],
    )
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">{cn(</span>
          '<span class="hljs-attr">relative</span> <span class="hljs-attr">flex</span> <span class="hljs-attr">h-full</span> <span class="hljs-attr">w-full</span> <span class="hljs-attr">items-center</span> <span class="hljs-attr">justify-center</span> <span class="hljs-attr">overflow-hidden</span>',
          <span class="hljs-attr">className</span>,
        )}
        <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
          if (e.target === e.currentTarget) {
            onClick?.(undefined, e)
          }
        }}
        ref={containerRef}
      &gt;
        {match({ isValidating, error: error as Error | null, naturalSize, displaySize })
          .with({ isValidating: false, error: P.nonNullable }, () =&gt; '图片加载失败')
          .with(
            { isValidating: false, naturalSize: P.nonNullable, displaySize: P.nonNullable },
            ({ naturalSize, displaySize }) =&gt; (
              <span class="hljs-tag">&lt;&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{src}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'h-full w-full object-contain'</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
                  <span class="hljs-attr">className</span>=<span class="hljs-string">'absolute top-1/2 left-1/2 z-10 -translate-x-1/2 -translate-y-1/2'</span>
                  <span class="hljs-attr">style</span>=<span class="hljs-string">{displaySize}</span>
                  <span class="hljs-attr">ref</span>=<span class="hljs-string">{dragRange}</span>
                  <span class="hljs-attr">onPointerDownCapture</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
                    pointerMoved.current = false
                    if (!isCreating.current) return
                    if (!dragRange.current) return
                    e.stopPropagation()
                    const { clientX, clientY } = e
                    const { x = 0, y = 0 } = dragRange.current.getBoundingClientRect()
                    const x1 = clientX - x
                    const y1 = clientY - y
                    setInitPosition([x1, y1, x1, y1])
                  }}
                  onPointerMoveCapture={()=&gt;{
                    pointerMoved.current = true
                  }}
                &gt;
                  {boxs.map((b, i) =&gt; (
                    <span class="hljs-tag">&lt;<span class="hljs-name">SelectBoxComponent</span>
                      <span class="hljs-attr">key</span>=<span class="hljs-string">{b.key}</span>
                      <span class="hljs-attr">position</span>=<span class="hljs-string">{convertPosition(b.position,</span> <span class="hljs-attr">naturalSize</span>, <span class="hljs-attr">displaySize</span>, '<span class="hljs-attr">display</span>')}
                      <span class="hljs-attr">dragRange</span>=<span class="hljs-string">{dragRange}</span>
                      <span class="hljs-attr">onPositionChange</span>=<span class="hljs-string">{(val)</span> =&gt;</span>
                        onPositionChange?.(
                          b.key,
                          convertPosition(val, naturalSize, displaySize, 'natural'),
                        )
                      }
                      onClick={(e) =&gt; {
                        // 如果鼠标移动了 不触发点击
                        if (pointerMoved.current) return
                        onClick?.(b.key, e)
                      }}
                      style={{ zIndex: zIndexList[i] }}
                    /&gt;
                  ))}
                  {creatingInitPosition ? (
                    <span class="hljs-tag">&lt;<span class="hljs-name">SelectBoxComponent</span>
                      <span class="hljs-attr">position</span>=<span class="hljs-string">{creatingInitPosition}</span>
                      <span class="hljs-attr">defaultDragDirection</span>=<span class="hljs-string">'bottom-right'</span>
                      <span class="hljs-attr">dragRange</span>=<span class="hljs-string">{dragRange}</span>
                      <span class="hljs-attr">onPositionChange</span>=<span class="hljs-string">{(val)</span> =&gt;</span> {
                        onCreateBox?.(convertPosition(val, naturalSize, displaySize, 'natural'))
                        setInitPosition(undefined)
                      }}
                      style={{ zIndex: 9999 }}
                    /&gt;
                  ) : null}
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;/&gt;</span></span>
            ),
          )
          .<span class="hljs-title function_">otherwise</span>(<span class="hljs-function">() =&gt;</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Skeleton</span> <span class="hljs-attr">active</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'p-4'</span> /&gt;</span></span>
          ))}
      &lt;/div&gt;
    )
  },
)

</code></pre>
<h3 data-id="heading-6">SelectBoxComponent/index.tsx</h3>
<p>这个文件包含了拖拽逻辑 包括溢出和翻转等</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useLayoutEffect, <span class="hljs-variable constant_">FC</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { useMemoizedFn, useMount } <span class="hljs-keyword">from</span> <span class="hljs-string">'ahooks'</span>
<span class="hljs-keyword">import</span> { motion, useMotionValue } <span class="hljs-keyword">from</span> <span class="hljs-string">'motion/react'</span>
<span class="hljs-keyword">import</span> { cn } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils'</span>
<span class="hljs-keyword">import</span> {
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">SelectBox</span>,
  getLegalPosition,
  getCursorStyle,
  <span class="hljs-title class_">DirectionCursorMap</span>,
  <span class="hljs-title class_">DragDirection</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common'</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./styles.module.css'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">SelectBoxComponentProps</span> = <span class="hljs-title class_">Style</span> &amp; {
  <span class="hljs-attr">position</span>: <span class="hljs-title class_">SelectBox</span>[<span class="hljs-string">'position'</span>]
  <span class="hljs-attr">dragRange</span>: { <span class="hljs-attr">current</span>: <span class="hljs-title class_">HTMLElement</span> | <span class="hljs-literal">null</span> }
  onPositionChange?: <span class="hljs-function">(<span class="hljs-params">val: SelectBox[<span class="hljs-string">'position'</span>]</span>) =&gt;</span> <span class="hljs-built_in">void</span>
  onClick?: <span class="hljs-function">(<span class="hljs-params">e: React.MouseEvent</span>) =&gt;</span> <span class="hljs-built_in">void</span>
  boxStyle?: <span class="hljs-title class_">SelectBox</span>[<span class="hljs-string">'style'</span>]
  <span class="hljs-comment">/** 传入此项 则选择框初始可拖拽 */</span>
  defaultDragDirection?: <span class="hljs-title class_">DragDirection</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">SelectBoxComponent</span>: <span class="hljs-variable constant_">FC</span>&lt;<span class="hljs-title class_">SelectBoxComponentProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">props</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> {
    position,
    dragRange,
    boxStyle,
    onPositionChange,
    onClick,
    defaultDragDirection,
    className,
    style,
  } = props
  <span class="hljs-keyword">const</span> { fill = <span class="hljs-string">'#ff000010'</span>, border = <span class="hljs-string">'#ff0000'</span>, borderWidth = <span class="hljs-number">2</span> } = boxStyle ?? {}

  <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">useMotionValue</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> y = <span class="hljs-title function_">useMotionValue</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> width = <span class="hljs-title function_">useMotionValue</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> height = <span class="hljs-title function_">useMotionValue</span>(<span class="hljs-number">0</span>)
  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> [x1, y1, x2, y2] = <span class="hljs-title function_">getLegalPosition</span>(position)
    x.<span class="hljs-title function_">set</span>(x1)
    y.<span class="hljs-title function_">set</span>(y1)
    width.<span class="hljs-title function_">set</span>(x2 - x1)
    height.<span class="hljs-title function_">set</span>(y2 - y1)
  }, [height, position, width, x, y])
  <span class="hljs-keyword">const</span> onDragEnd = <span class="hljs-title function_">useMemoizedFn</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> x1 = x.<span class="hljs-title function_">get</span>()
    <span class="hljs-keyword">const</span> y1 = y.<span class="hljs-title function_">get</span>()
    <span class="hljs-keyword">const</span> x2 = x1 + width.<span class="hljs-title function_">get</span>()
    <span class="hljs-keyword">const</span> y2 = y1 + height.<span class="hljs-title function_">get</span>()
    onPositionChange?.([x1, y1, x2, y2])
  })

  <span class="hljs-comment">/**
   * 拖拽区应当跟随鼠标移动 因此可以根据鼠标位置设置矩形四点的位置
   */</span>
  <span class="hljs-keyword">const</span> startHandlerDrag = <span class="hljs-title function_">useMemoizedFn</span>(<span class="hljs-function">(<span class="hljs-params">dir: DragDirection</span>) =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(styles.<span class="hljs-property">dragging</span>)
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">style</span>.<span class="hljs-title function_">setProperty</span>(<span class="hljs-string">'--cursor-style'</span>, <span class="hljs-title function_">getCursorStyle</span>(dir))
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'pointermove'</span>, onHandlerDrag)
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'pointerup'</span>, stopHandlerDrag)

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">stopHandlerDrag</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(styles.<span class="hljs-property">dragging</span>)
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">style</span>.<span class="hljs-title function_">removeProperty</span>(<span class="hljs-string">'--cursor-style'</span>)
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'pointermove'</span>, onHandlerDrag)
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'pointerup'</span>, stopHandlerDrag)
      <span class="hljs-title function_">onDragEnd</span>()
    }

    <span class="hljs-keyword">let</span> currentDirection = dir
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">onHandlerDrag</span>(<span class="hljs-params">e: PointerEvent</span>) {
      <span class="hljs-keyword">if</span> (!dragRange.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">const</span> { clientX, clientY } = e
      <span class="hljs-keyword">const</span> {
        <span class="hljs-attr">x</span>: rangeX,
        <span class="hljs-attr">y</span>: rangeY,
        <span class="hljs-attr">width</span>: maxWidth,
        <span class="hljs-attr">height</span>: maxHeight,
      } = dragRange.<span class="hljs-property">current</span>.<span class="hljs-title function_">getBoundingClientRect</span>()

      <span class="hljs-comment">// 在允许水平拖拽时计算x/width</span>
      <span class="hljs-comment">// 注意矩形翻转的问题</span>
      <span class="hljs-keyword">if</span> (currentDirection.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'left'</span>) || currentDirection.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'right'</span>)) {
        <span class="hljs-keyword">const</span> currentX1 = x.<span class="hljs-title function_">get</span>()
        <span class="hljs-keyword">const</span> currentX2 = currentX1 + width.<span class="hljs-title function_">get</span>()
        <span class="hljs-keyword">const</span> isLeft = currentDirection.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'left'</span>)
        <span class="hljs-keyword">let</span> [newCurrentX1, newCurrentX2] = isLeft
          ? [clientX - rangeX, currentX2]
          : [currentX1, clientX - rangeX]
        <span class="hljs-comment">// newCurrentX1 &gt; newCurrentX2 说明之前的左上点变为了右上点 矩形翻转了</span>
        <span class="hljs-comment">// 翻转后 拖拽防线同样需要更改</span>
        <span class="hljs-keyword">if</span> (newCurrentX1 &gt; newCurrentX2) {
          ;[newCurrentX1, newCurrentX2] = [newCurrentX2, newCurrentX1]
          currentDirection = (
            isLeft
              ? currentDirection.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'left'</span>, <span class="hljs-string">'right'</span>)
              : currentDirection.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'right'</span>, <span class="hljs-string">'left'</span>)
          ) <span class="hljs-keyword">as</span> <span class="hljs-title class_">DragDirection</span>
        }
        <span class="hljs-comment">// 矩形大小溢出</span>
        <span class="hljs-keyword">if</span> (newCurrentX1 &lt; <span class="hljs-number">0</span>) {
          newCurrentX1 = <span class="hljs-number">0</span>
        }
        <span class="hljs-keyword">if</span> (newCurrentX2 &gt; maxWidth) {
          newCurrentX2 = maxWidth
        }
        x.<span class="hljs-title function_">set</span>(newCurrentX1)
        width.<span class="hljs-title function_">set</span>(newCurrentX2 - newCurrentX1)
      }
      <span class="hljs-comment">// 在允许竖直拖拽时计算y/height 逻辑类似</span>
      <span class="hljs-keyword">if</span> (currentDirection.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'top'</span>) || currentDirection.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'bottom'</span>)) {
        <span class="hljs-keyword">const</span> currentY1 = y.<span class="hljs-title function_">get</span>()
        <span class="hljs-keyword">const</span> currentY2 = currentY1 + height.<span class="hljs-title function_">get</span>()
        <span class="hljs-keyword">const</span> isTop = currentDirection.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'top'</span>)
        <span class="hljs-keyword">let</span> [newCurrentY1, newCurrentY2] = isTop
          ? [clientY - rangeY, currentY2]
          : [currentY1, clientY - rangeY]
        <span class="hljs-keyword">if</span> (newCurrentY1 &gt; newCurrentY2) {
          ;[newCurrentY1, newCurrentY2] = [newCurrentY2, newCurrentY1]
          currentDirection = (
            isTop
              ? currentDirection.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'top'</span>, <span class="hljs-string">'bottom'</span>)
              : currentDirection.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'bottom'</span>, <span class="hljs-string">'top'</span>)
          ) <span class="hljs-keyword">as</span> <span class="hljs-title class_">DragDirection</span>
        }
        <span class="hljs-keyword">if</span> (newCurrentY1 &lt; <span class="hljs-number">0</span>) {
          newCurrentY1 = <span class="hljs-number">0</span>
        }
        <span class="hljs-keyword">if</span> (newCurrentY2 &gt; maxHeight) {
          newCurrentY2 = maxHeight
        }
        y.<span class="hljs-title function_">set</span>(newCurrentY1)
        height.<span class="hljs-title function_">set</span>(newCurrentY2 - newCurrentY1)
      }
    }
  })

  <span class="hljs-title function_">useMount</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (defaultDragDirection) {
      <span class="hljs-title function_">startHandlerDrag</span>(defaultDragDirection)
    }
  })
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">{cn(</span>'<span class="hljs-attr">absolute</span> <span class="hljs-attr">top-0</span> <span class="hljs-attr">left-0</span>', <span class="hljs-attr">styles.selectBox</span>, <span class="hljs-attr">className</span>)}
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        // @<span class="hljs-attr">ts-expect-error</span> <span class="hljs-attr">为拖拽手柄提供css变量</span>
        '<span class="hljs-attr">--handler-width</span>'<span class="hljs-attr">:</span> `${<span class="hljs-attr">borderWidth</span>}<span class="hljs-attr">px</span>`,
        '<span class="hljs-attr">--handler-background-color</span>'<span class="hljs-attr">:</span> <span class="hljs-attr">border</span>,
        <span class="hljs-attr">backgroundColor:</span> <span class="hljs-attr">fill</span>,
        <span class="hljs-attr">x</span>,
        <span class="hljs-attr">y</span>,
        <span class="hljs-attr">width</span>,
        <span class="hljs-attr">height</span>,
        <span class="hljs-attr">...style</span>,
      }}
      <span class="hljs-attr">drag</span>
      <span class="hljs-attr">dragElastic</span>=<span class="hljs-string">{0}</span>
      <span class="hljs-attr">dragMomentum</span>=<span class="hljs-string">{false}</span>
      <span class="hljs-attr">dragConstraints</span>=<span class="hljs-string">{dragRange}</span>
      <span class="hljs-attr">onDragEnd</span>=<span class="hljs-string">{onDragEnd}</span>
      <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span>
    &gt;</span>
      {Object.keys(DirectionCursorMap).map((dir) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">key</span>=<span class="hljs-string">{dir}</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">{cn(styles.handler,</span> <span class="hljs-attr">styles</span>[<span class="hljs-attr">dir</span>])}
          <span class="hljs-attr">onPointerDownCapture</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
            e.stopPropagation()
            startHandlerDrag(dir as DragDirection)
          }}
        &gt;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span></span>
  )
}


</code></pre>
<h3 data-id="heading-7">SelectBoxComponent/styles.module.css</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span><span class="hljs-selector-class">.dragging</span> {

  &amp;,
  &amp; * {
    <span class="hljs-attribute">cursor</span>: <span class="hljs-built_in">var</span>(--cursor-style) <span class="hljs-meta">!important</span>;
  }
}

<span class="hljs-selector-class">.selectBox</span> {
  <span class="hljs-selector-class">.handler</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">width</span>: <span class="hljs-built_in">var</span>(--handler-width);
    <span class="hljs-attribute">height</span>: <span class="hljs-built_in">var</span>(--handler-width);
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--handler-background-color);

    <span class="hljs-comment">/* 角落手柄 - 正方形 */</span>
    &amp;<span class="hljs-selector-class">.top-left</span> {
      <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">cursor</span>: nwse-resize;
    }

    &amp;<span class="hljs-selector-class">.top-right</span> {
      <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">cursor</span>: nesw-resize;
    }

    &amp;<span class="hljs-selector-class">.bottom-left</span> {
      <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">cursor</span>: nesw-resize;
    }

    &amp;<span class="hljs-selector-class">.bottom-right</span> {
      <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">cursor</span>: nwse-resize;
    }

    <span class="hljs-comment">/* 边缘手柄 - 矩形 */</span>
    &amp;<span class="hljs-selector-class">.top</span> {
      <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">left</span>: <span class="hljs-built_in">var</span>(--handler-width);
      <span class="hljs-attribute">right</span>: <span class="hljs-built_in">var</span>(--handler-width);
      <span class="hljs-attribute">width</span>: auto;
      <span class="hljs-attribute">cursor</span>: ns-resize;
    }

    &amp;<span class="hljs-selector-class">.bottom</span> {
      <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">left</span>: <span class="hljs-built_in">var</span>(--handler-width);
      <span class="hljs-attribute">right</span>: <span class="hljs-built_in">var</span>(--handler-width);
      <span class="hljs-attribute">width</span>: auto;
      <span class="hljs-attribute">cursor</span>: ns-resize;
    }

    &amp;<span class="hljs-selector-class">.left</span> {
      <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">top</span>: <span class="hljs-built_in">var</span>(--handler-width);
      <span class="hljs-attribute">bottom</span>: <span class="hljs-built_in">var</span>(--handler-width);
      <span class="hljs-attribute">height</span>: auto;
      <span class="hljs-attribute">cursor</span>: ew-resize;
    }

    &amp;<span class="hljs-selector-class">.right</span> {
      <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">top</span>: <span class="hljs-built_in">var</span>(--handler-width);
      <span class="hljs-attribute">bottom</span>: <span class="hljs-built_in">var</span>(--handler-width);
      <span class="hljs-attribute">height</span>: auto;
      <span class="hljs-attribute">cursor</span>: ew-resize;
    }
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter最佳实践：路由弹窗终极版NSlidePopupRoute]]></title>    <link>https://juejin.cn/post/7594835618120630312</link>    <guid>https://juejin.cn/post/7594835618120630312</guid>    <pubDate>2026-01-14T10:16:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594835618120630312" data-draft-id="7589835342146093066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter最佳实践：路由弹窗终极版NSlidePopupRoute"/> <meta itemprop="keywords" content="前端,Flutter"/> <meta itemprop="datePublished" content="2026-01-14T10:16:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SoaringHeart"/> <meta itemprop="url" content="https://juejin.cn/user/3544481219481374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter最佳实践：路由弹窗终极版NSlidePopupRoute
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3544481219481374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SoaringHeart
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T10:16:37.000Z" title="Wed Jan 14 2026 10:16:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、需求来源</h2>
<p>最近需要实现弹窗，动画方向分为：</p>
<ol>
<li>从屏幕顶部滑动到屏幕内，top-&gt;Center。</li>
<li>从屏幕底部滑动到屏幕内，bottom-&gt;Center。</li>
<li>从屏幕左侧滑动到屏幕内，left-&gt;Center。</li>
<li>从屏幕右侧滑动到屏幕内，right-&gt;Center。</li>
<li>直接显示在屏幕中间，Center-&gt;Center。</li>
</ol>
<p>最终实现以 Alignment 参数为动画方向，弹窗内容高度和宽度自定义，实现从哪个方向弹出就从哪个方向消失的高自由度。彻底突破了 ModalBottomSheet 的方向显示。
效果图如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd6f61c328cc465680fc258b4d35532a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29hcmluZ0hlYXJ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990597&amp;x-signature=eMH6yEtL597plNJlh4VeqSckpOE%3D" alt="Simulator Screenshot - iPhone 16 - 2025-12-27 at 11.36.41.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87f3e1c4b6ef489284f60f724d27aff5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29hcmluZ0hlYXJ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990597&amp;x-signature=DvtcquIvOq51wx2YWHZxjcs9BXY%3D" alt="Simulator Screenshot - iPhone 16 - 2025-12-27 at 11.36.43.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/704337ca7ab647ada987bcbdab647bcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29hcmluZ0hlYXJ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990597&amp;x-signature=yOK7BSeHA%2B8ET%2FTdJJnez3k1qe4%3D" alt="Simulator Screenshot - iPhone 16 - 2025-12-27 at 11.36.45.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db0ac7dd3ddf4250badb36380399b30b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29hcmluZ0hlYXJ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990597&amp;x-signature=3bizmxzCvugyies37u1Kbqk0zy0%3D" alt="Simulator Screenshot - iPhone 16 - 2025-12-27 at 11.36.48.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c08f35a5439944718bcee41989cd1d36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29hcmluZ0hlYXJ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990597&amp;x-signature=JjxJnJlUDV%2FNi1OFv8GCsYlAJtg%3D" alt="Simulator Screenshot - iPhone 16 - 2025-12-27 at 11.36.51.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b5bfdc5a98d4ec6930a06ff11e04eb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29hcmluZ0hlYXJ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990597&amp;x-signature=fzfhzL2qprpbAVVCWxT%2FORQ75OQ%3D" alt="Simulator Screenshot - iPhone 16 - 2025-12-27 at 11.36.53.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19e4f2f3dd39403fb1a0520f1c555eb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29hcmluZ0hlYXJ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990597&amp;x-signature=9Lvik1Watkronx72JXJYKm8G2B0%3D" alt="Simulator Screenshot - iPhone 16 - 2025-12-27 at 11.36.59.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f46415d2022e474fa6d8dc9beacc82d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29hcmluZ0hlYXJ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990597&amp;x-signature=Q%2FbQaGCp9lZ0wm4IYvRgpnhRvdw%3D" alt="Simulator Screenshot - iPhone 16 - 2025-12-27 at 11.37.01.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe7aa9ee81064c33a819b4e2bafab1df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29hcmluZ0hlYXJ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990597&amp;x-signature=2lOcbRtDLADN0Yfv7bhSJi0SodM%3D" alt="Simulator Screenshot - iPhone 16 - 2025-12-27 at 11.37.04.png" loading="lazy"/></p>
<h2 data-id="heading-1">二、使用示例</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> '<span class="hljs-selector-tag">package</span>:<span class="hljs-selector-tag">flutter</span>/<span class="hljs-selector-tag">material</span><span class="hljs-selector-class">.dart</span>';
<span class="hljs-selector-tag">import</span> '<span class="hljs-selector-tag">package</span>:<span class="hljs-selector-tag">n_slide_popup</span>/<span class="hljs-selector-tag">n_slide_popup</span><span class="hljs-selector-class">.dart</span>';

<span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>() {
  <span class="hljs-selector-tag">runApp</span>(const <span class="hljs-built_in">MyApp</span>());
}

<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">MyApp</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">StatelessWidget</span> {
  <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">MyApp</span>({<span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.key</span>});

  <span class="hljs-comment">// This widget is the root of your application.</span>
  @<span class="hljs-selector-tag">override</span>
  <span class="hljs-selector-tag">Widget</span> <span class="hljs-selector-tag">build</span>(BuildContext context) {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">MaterialApp</span>(
      <span class="hljs-attribute">title</span>: <span class="hljs-string">'Flutter Demo'</span>,
      <span class="hljs-attribute">theme</span>: <span class="hljs-built_in">ThemeData</span>(
        <span class="hljs-attribute">colorScheme</span>: ColorScheme.<span class="hljs-built_in">fromSeed</span>(<span class="hljs-attribute">seedColor</span>: Colors.blue),
        <span class="hljs-attribute">useMaterial3</span>: true,
      ),
      <span class="hljs-attribute">home</span>: const <span class="hljs-built_in">MyHomePage</span>(<span class="hljs-attribute">title</span>: <span class="hljs-string">'Home Page'</span>),
    );
  }
}

<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">MyHomePage</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">StatefulWidget</span> {
  <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">MyHomePage</span>({<span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.key</span>, <span class="hljs-selector-tag">required</span> <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.title</span>});

  <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">title</span>;

  @<span class="hljs-selector-tag">override</span>
  <span class="hljs-selector-tag">State</span>&lt;<span class="hljs-selector-tag">MyHomePage</span>&gt; <span class="hljs-selector-tag">createState</span>() =&gt; <span class="hljs-selector-tag">_MyHomePageState</span>();
}

<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">_MyHomePageState</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">State</span>&lt;<span class="hljs-selector-tag">MyHomePage</span>&gt; {
  <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Alignment</span>&gt; <span class="hljs-selector-tag">alignments</span> = <span class="hljs-selector-attr">[    Alignment.topLeft,    Alignment.topCenter,    Alignment.topRight,    Alignment.centerLeft,    Alignment.center,    Alignment.centerRight,    Alignment.bottomLeft,    Alignment.bottomCenter,    Alignment.bottomRight,  ]</span>;

  <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">alignment</span> = <span class="hljs-selector-tag">Alignment</span><span class="hljs-selector-class">.center</span>;

  @<span class="hljs-selector-tag">override</span>
  <span class="hljs-selector-tag">Widget</span> <span class="hljs-selector-tag">build</span>(BuildContext context) {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Scaffold</span>(
      <span class="hljs-attribute">appBar</span>: <span class="hljs-built_in">AppBar</span>(
        <span class="hljs-attribute">backgroundColor</span>: Theme.<span class="hljs-built_in">of</span>(context).colorScheme.inversePrimary,
        <span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(widget.title),
      ),
      <span class="hljs-attribute">body</span>: <span class="hljs-built_in">Column</span>(
        <span class="hljs-attribute">mainAxisAlignment</span>: MainAxisAlignment.center,
        <span class="hljs-attribute">children</span>: &lt;Widget&gt;[
          const <span class="hljs-built_in">Text</span>(<span class="hljs-string">"direction from Alignment."</span>),
          <span class="hljs-built_in">Wrap</span>(
            <span class="hljs-attribute">spacing</span>: <span class="hljs-number">8</span>,
            <span class="hljs-attribute">runSpacing</span>: <span class="hljs-number">8</span>,
            <span class="hljs-attribute">children</span>: [
              ...alignments.<span class="hljs-built_in">map</span>((e) {
                var name = e.<span class="hljs-built_in">toString</span>().<span class="hljs-built_in">split</span>(<span class="hljs-string">'.'</span>)[<span class="hljs-number">1</span>];
                return <span class="hljs-built_in">ElevatedButton</span>(
                  <span class="hljs-attribute">style</span>: ElevatedButton.<span class="hljs-built_in">styleFrom</span>(
                    <span class="hljs-attribute">backgroundColor</span>: Colors.blue,
                    <span class="hljs-attribute">elevation</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-attribute">tapTargetSize</span>: MaterialTapTargetSize.shrinkWrap,
                    <span class="hljs-attribute">minimumSize</span>: const <span class="hljs-built_in">Size</span>(<span class="hljs-number">64</span>, <span class="hljs-number">36</span>),
                  ),
                  <span class="hljs-attribute">onPressed</span>: () {
                    alignment = e;
                    <span class="hljs-built_in">debugPrint</span>(<span class="hljs-string">"$alignment ${alignment.x} ${alignment.y}"</span>);
                    <span class="hljs-built_in">onPopupRoute</span>();
                  },
                  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(
                    name,
                    <span class="hljs-attribute">style</span>: <span class="hljs-built_in">TextStyle</span>(<span class="hljs-attribute">color</span>: Colors.white),
                  ),
                );
              }),
            ],
          )
        ],
      ),
    );
  }

  <span class="hljs-selector-tag">Future</span>&lt;<span class="hljs-selector-tag">void</span>&gt; <span class="hljs-selector-tag">onPopupRoute</span>() <span class="hljs-selector-tag">async</span> {
    <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">route</span> = <span class="hljs-selector-tag">NSlidePopupRoute</span>(
      <span class="hljs-attribute">from</span>: alignment,
      <span class="hljs-attribute">builder</span>: (_) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">buildPopupView</span>(<span class="hljs-attribute">alignment</span>: alignment, <span class="hljs-attribute">argsDismiss</span>: {"<span class="hljs-selector-tag">b</span>": "<span class="hljs-number">88</span>"});
      },
    );
    <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">Navigator</span><span class="hljs-selector-class">.of</span>(context)<span class="hljs-selector-class">.push</span>(route);
    <span class="hljs-selector-tag">print</span>([<span class="hljs-string">"result"</span>, result.runtimeType, result]);
  }

  <span class="hljs-selector-tag">Widget</span> <span class="hljs-selector-tag">buildPopupView</span>({<span class="hljs-selector-tag">required</span> <span class="hljs-selector-tag">Alignment</span> <span class="hljs-selector-tag">alignment</span>, <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">dynamic</span>&gt;? <span class="hljs-selector-tag">argsDismiss</span>}) {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Align</span>(
      <span class="hljs-attribute">alignment</span>: alignment,
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Container</span>(
        <span class="hljs-attribute">width</span>: <span class="hljs-number">300</span>,
        <span class="hljs-attribute">height</span>: <span class="hljs-number">400</span>,
        <span class="hljs-attribute">alignment</span>: Alignment.center,
        <span class="hljs-attribute">decoration</span>: <span class="hljs-built_in">BoxDecoration</span>(
          <span class="hljs-attribute">color</span>: Colors.green,
          <span class="hljs-attribute">border</span>: Border.<span class="hljs-built_in">all</span>(<span class="hljs-attribute">color</span>: Colors.blue),
          <span class="hljs-attribute">borderRadius</span>: BorderRadius.<span class="hljs-built_in">all</span>(Radius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">0</span>)),
        ),
        <span class="hljs-attribute">child</span>: <span class="hljs-built_in">ElevatedButton</span>(
          <span class="hljs-attribute">onPressed</span>: () {
            Navigator.<span class="hljs-built_in">of</span>(context).<span class="hljs-built_in">pop</span>(argsDismiss);
          },
          <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">"dismiss"</span>),
        ),
      ),
    );
  }
}
</code></pre>
<h2 data-id="heading-2">三、源码</h2>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">//</span>
<span class="hljs-comment">//  NSlidePopupRoute.dart</span>
<span class="hljs-comment">//  n_slide_popup</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//  Created by shang on 2025/12/27.</span>
<span class="hljs-comment">//  Copyright © 2025/12/27 shang. All rights reserved.</span>
<span class="hljs-comment">//</span>


import <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-comment">/// 最新滑入弹窗</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NSlidePopupRoute</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">PopupRoute</span>&lt;<span class="hljs-title">T</span>&gt; </span>{
  <span class="hljs-title function_ invoke__">NSlidePopupRoute</span>({
    super.settings,
    required this.builder,
    this.<span class="hljs-keyword">from</span> = Alignment.bottomCenter,
    this.barrierColor = <span class="hljs-keyword">const</span> <span class="hljs-title function_ invoke__">Color</span>(<span class="hljs-number">0x80000000</span>),
    this.barrierDismissible = <span class="hljs-literal">true</span>,
    this.duration = <span class="hljs-keyword">const</span> <span class="hljs-title function_ invoke__">Duration</span>(<span class="hljs-attr">milliseconds</span>: <span class="hljs-number">300</span>),
    this.barrierLabel,
    this.curve = Curves.easeOutCubic,
  });

  <span class="hljs-keyword">final</span> WidgetBuilder builder;

  <span class="hljs-comment">/// 从哪个方向进入（推荐：topCenter / bottomCenter / centerLeft / centerRight）</span>
  <span class="hljs-keyword">final</span> Alignment <span class="hljs-keyword">from</span>;

  <span class="hljs-keyword">final</span> Duration duration;

  <span class="hljs-keyword">final</span> Curve curve;

  @override
  <span class="hljs-keyword">final</span> <span class="hljs-keyword">bool</span> barrierDismissible;

  @override
  <span class="hljs-keyword">final</span> Color barrierColor;

  @override
  <span class="hljs-keyword">final</span> String? barrierLabel;

  @override
  Duration get transitionDuration =&gt; duration;

  <span class="hljs-comment">// 展示</span>
  <span class="hljs-built_in">static</span> Future&lt;T<span class="hljs-meta">?&gt;</span> show&lt;T&gt;({
    required BuildContext context,
    required WidgetBuilder builder,
    Alignment <span class="hljs-keyword">from</span> = Alignment.bottomCenter,
    Duration duration = <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">Duration</span>(milliseconds: <span class="hljs-number">300</span>),
    Curve curve = Curves.easeOutCubic,
    Color barrierColor = <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">Color</span>(<span class="hljs-number">0x80000000</span>),
    <span class="hljs-keyword">bool</span> barrierDismissible = <span class="hljs-literal">true</span>,
    String? barrierLabel,
    <span class="hljs-keyword">bool</span> useRootNavigator = <span class="hljs-literal">true</span>,
    RouteSettings? routeSettings,
  }) {
    <span class="hljs-keyword">return</span> Navigator.<span class="hljs-title function_ invoke__">of</span>(context, <span class="hljs-attr">rootNavigator</span>: useRootNavigator).<span class="hljs-title function_ invoke__">push</span>(
      NSlidePopupRoute&lt;T&gt;(
        <span class="hljs-attr">builder</span>: builder,
        <span class="hljs-attr">from</span>: <span class="hljs-keyword">from</span>,
        <span class="hljs-attr">duration</span>: duration,
        <span class="hljs-attr">curve</span>: curve,
        <span class="hljs-attr">barrierColor</span>: barrierColor,
        <span class="hljs-attr">barrierDismissible</span>: barrierDismissible,
        <span class="hljs-attr">barrierLabel</span>: barrierLabel,
        <span class="hljs-attr">settings</span>: routeSettings,
      ),
    );
  }

  @override
  Widget <span class="hljs-title function_ invoke__">buildPage</span>(
    BuildContext context,
    Animation&lt;<span class="hljs-keyword">double</span>&gt; animation,
    Animation&lt;<span class="hljs-keyword">double</span>&gt; secondaryAnimation,
  ) {
    <span class="hljs-comment">// 直接返回背景和内容，不应用动画</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Material</span>(
      <span class="hljs-attr">color</span>: barrierColor,
      <span class="hljs-attr">child</span>: <span class="hljs-keyword">const</span> SizedBox.<span class="hljs-title function_ invoke__">expand</span>(), // 只负责背景
    );
  }

  @override
  Widget <span class="hljs-title function_ invoke__">buildTransitions</span>(
    BuildContext context,
    Animation&lt;<span class="hljs-keyword">double</span>&gt; animation,
    Animation&lt;<span class="hljs-keyword">double</span>&gt; secondaryAnimation,
    Widget child,
  ) {
    <span class="hljs-keyword">final</span> content = <span class="hljs-title function_ invoke__">builder</span>(context);

    <span class="hljs-comment">// ⭐ 中心弹窗：Fade</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">from</span> == Alignment.center) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">FadeTransition</span>(
        <span class="hljs-attr">opacity</span>: animation.<span class="hljs-title function_ invoke__">drive</span>(
          <span class="hljs-title function_ invoke__">CurveTween</span>(<span class="hljs-attr">curve</span>: Curves.easeOut),
        ),
        <span class="hljs-attr">child</span>: content,
      );
    }

    <span class="hljs-comment">// ⭐ 其余方向：Slide</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">FadeTransition</span>(
      <span class="hljs-attr">opacity</span>: animation,
      <span class="hljs-attr">child</span>: <span class="hljs-title function_ invoke__">SlideTransition</span>(
        <span class="hljs-attr">position</span>: animation.<span class="hljs-title function_ invoke__">drive</span>(
          Tween&lt;Offset&gt;(
            <span class="hljs-attr">begin</span>: <span class="hljs-title function_ invoke__">_alignmentToOffset</span>(<span class="hljs-keyword">from</span>),
            <span class="hljs-attr">end</span>: Offset.zero,
          ).<span class="hljs-title function_ invoke__">chain</span>(
            <span class="hljs-title function_ invoke__">CurveTween</span>(<span class="hljs-attr">curve</span>: curve),
          ),
        ),
        <span class="hljs-attr">child</span>: content,
      ),
    );
  }

  <span class="hljs-comment">/// Alignment → Offset（关键点）</span>
  Offset <span class="hljs-title function_ invoke__">_alignmentToOffset</span>(Alignment alignment) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Offset</span>(
      alignment.x.sign,
      alignment.y.sign,
    );
  }
}
</code></pre>
<h2 data-id="heading-3">最后、总结</h2>
<ol>
<li>NSlidePopupRoute 代码实现极简，没有过多的底层封装，是为了追求极致的自由度。</li>
<li>当 alignment == Alignment.center 时，它是 Dialog弹窗。</li>
<li>从顶部滑出时，它可以是顶部通知 Toast。</li>
<li>从底部滑出时，它可以是 ModalBottomSheet，SnackBar。</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshang1219178163%2Fn_slide_popup" target="_blank" title="https://github.com/shang1219178163/n_slide_popup" ref="nofollow noopener noreferrer">github</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fn_slide_popup" target="_blank" title="https://pub.dev/packages/n_slide_popup" ref="nofollow noopener noreferrer">pub.dev</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通过AI从零开发RN到在安卓手机上运行]]></title>    <link>https://juejin.cn/post/7594302398687608886</link>    <guid>https://juejin.cn/post/7594302398687608886</guid>    <pubDate>2026-01-13T04:03:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594302398687608886" data-draft-id="7594389431835246633" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通过AI从零开发RN到在安卓手机上运行"/> <meta itemprop="keywords" content="前端,React Native,Cursor"/> <meta itemprop="datePublished" content="2026-01-13T04:03:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小遁哥"/> <meta itemprop="url" content="https://juejin.cn/user/1697301683524472"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通过AI从零开发RN到在安卓手机上运行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1697301683524472/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小遁哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T04:03:04.000Z" title="Tue Jan 13 2026 04:03:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我借助 AI，基于 React Native 技术开发了一个 APP，各方面结合在一起，促成我想做这件事。</p>
<p>用的是Cursor，之前在公司网络上使用很丝滑，但是到家里却总是出现网络故障，根本就无法使用，灾难级别。换了个梯子才大幅度改善。</p>
<p>字节的国内版和国外版都未出现过这种情况，很多场景下，免费的也很够用。</p>
<ul>
<li>因为我是从来没做过RN开发的，虽说web端还是有很多共性。想试一下全靠自然语言和AI沟通能否完成。</li>
<li>生活中确实存在相关使用需求，</li>
<li>市面上现有应用不仅操作繁琐，还存在大量开屏广告，且状态缓存差，再次打开时要么重复出现广告，要么回退到初始状态。</li>
</ul>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaodun%2Fsf-app" target="_blank" title="https://github.com/xiaodun/sf-app" ref="nofollow noopener noreferrer">xiaodun/sf-app</a></p>
<h2 data-id="heading-0">核心功能</h2>
<h3 data-id="heading-1">1. 集合管理 (Collection Management)</h3>
<ul>
<li><strong>创建与管理</strong>：首页展示所有集合，支持新增和删除集合。</li>
<li><strong>数据持久化</strong>：所有数据存储在本地，支持自动保存和状态同步。</li>
</ul>
<h3 data-id="heading-2">2. 层级与单元系统 (Level &amp; Unit System)</h3>
<ul>
<li><strong>层级结构</strong>：每个集合包含多个层级（Level），层级内包含多个单元（Unit）。</li>
<li><strong>单元编辑</strong>：支持编辑单元名称。</li>
<li><strong>状态流转</strong>：单元可以在“普通”、“推荐”、“回收站”和“收藏”状态间流转。</li>
</ul>
<h3 data-id="heading-3">3. 特性系统 (Features System)</h3>
<p>应用提供灵活的“特性”系统，允许用户为单元添加额外的属性维度：</p>
<ul>
<li><strong>全局定义</strong>：特性是全局共享的（Global），一旦创建，所有集合中的单元都可以使用。</li>
<li><strong>类型支持</strong>：
<ul>
<li><strong>数值型 (Numeric)</strong>：适合记录分数、数量、等级等（如：评分、数量）。</li>
<li><strong>单选型 (Single Choice)</strong>：适合记录布尔状态（如：是否完成、是否拥有）。</li>
</ul>
</li>
<li><strong>管理与应用</strong>：
<ul>
<li>在首页点击“特性管理”可添加、编辑或删除全局特性。</li>
<li>在单元详情页或编辑弹窗中，可以为特定单元设置这些特性的具体值。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">4. 导入与导出 (Import &amp; Export)</h3>
<p>为了方便数据备份、迁移和分享，应用提供了完整的 JSON 数据导入导出功能：</p>
<ul>
<li><strong>导出数据</strong>：
<ul>
<li>在首页点击菜单中的“导出”按钮。</li>
<li>系统会将当前应用内的<strong>所有数据</strong>（包括集合、层级、单元、特性、收藏记录等）打包成一个 JSON 字符串。</li>
<li>该字符串会自动复制到您的系统剪贴板，您可以将其粘贴到备忘录、微信或其他地方保存。</li>
</ul>
</li>
<li><strong>导入数据</strong>：
<ul>
<li>在首页点击菜单中的“导入”按钮。</li>
<li>将之前导出的 JSON 字符串粘贴到输入框中（或点击“从剪贴板粘贴”）。</li>
<li>系统会校验数据格式，验证通过后将覆盖当前应用数据，实现数据恢复。</li>
<li><strong>注意</strong>：导入操作会完全覆盖现有数据，请谨慎操作。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">5. 手势交互 (Interactive Gestures)</h3>
<p>为了提供流畅且防误触的操作体验，应用实现了定制化的手势系统：</p>
<ul>
<li><strong>滑动操作</strong>：
<ul>
<li><strong>上滑</strong>：将单元移动到“推荐”列表。</li>
<li><strong>下滑</strong>：将单元移动到“回收站”。</li>
</ul>
</li>
<li><strong>双击操作</strong>：
<ul>
<li>双击单元格可弹出编辑菜单。</li>
<li><strong>修改名称</strong>：可以快速修改当前单元的名称。</li>
<li><strong>编辑特性</strong>：可以设置单元的各项特性值（如评分、状态等）。</li>
<li><strong>收藏/取消收藏</strong>：可以一键收藏单元并添加收藏理由，或取消已有的收藏。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">6. 层级排序系统 (Level Sorting)</h3>
<ul>
<li><strong>排序模式</strong>：点击右上角菜单进入排序模式。</li>
<li><strong>按钮排序</strong>：通过点击单元格右侧的 <strong>“上移”/“下移”箭头按钮</strong> 调整层级顺序。</li>
</ul>
<p>开发过程中，从框架搭建到功能实现，全程由 AI 主导完成，也遇到一些卡住的地方。</p>
<p>如删除操作AI设置二次确认弹窗，生成的代码在逻辑层面看似没有问题，实际运行时弹窗却并未弹出，导致点击操作毫无响应。而我如果只跟AI说点击没有反应，他是无法解决这个问题，最后我看了代码，明确告诉它时弹窗没有展示。</p>
<p>手势交互适配问题，Web 端的上滑、下移、拖动、双击等操作均能正常运行，但移植到 APP 端直接失效。尝试让AI采用通用解决方案修复，却引发 APP 闪退，最后只能切换为原生策略才解决该问题。</p>
<p>而且在手机上也拿不报错，尝试添加日志功能也没效果，如果只是让AI解决闪退问题，其实是没有一个明确的方案的，导致这个问题卡住了好长时间，再加上我对RN也不熟悉，最后只能让它使用最原生的，才保证了功能，最后就是灵敏度的优化。</p>
<h2 data-id="heading-7">打包</h2>
<p>打包时通过eas这个命令，先去<a href="https://link.juejin.cn?target=https%3A%2F%2Fexpo.dev%2F" target="_blank" title="https://expo.dev/" ref="nofollow noopener noreferrer">expo.dev/</a> 注册账号，在本地登陆后，会对项目做一个初始化，对node版本有要求，一定要在本地安装git。</p>
<p>一开始是通过本地执行<code>npx eas-cli build --platform android --profile preview</code> 其实也是向远程发起了构建指令，构建过程可以通过网页看到，后面使用这个命令会卡住，就直接从网站上构建了。</p>
<p>网站本身就支持从gihub上拉仓库</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cc2e4c89f05495987af01ded5ca1315~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6YGB5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881784&amp;x-signature=R9o674mOt7zGsjAknJSG8qEz%2BjM%3D" alt="image.png" loading="lazy"/></p>
<p>EAS Build profile 很重要，我的应用要改为preview，对应项目的eas.json有一下配置</p>
<pre><code class="hljs language-json" lang="json">    <span class="hljs-attr">"preview"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"distribution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"internal"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"android"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"buildType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"apk"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre>
<p>"buildType": "apk" 否则构建出来会是abb文件，不能直接安装。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cd96d759f2a468386f5595aac63b2bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6YGB5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881784&amp;x-signature=iVFYNf%2F1ATjBVUpVMNKLiIPOBuc%3D" alt="image.png" loading="lazy"/></p>
<p>这个平台有免费次数限制，超出限制后需要等待 18 天才能再次使用。</p>
<p>由于这款 APP 功能相对简单，我便没有在本地搭建安卓环境，也未进行 USB 调试等验证操作，目前整体功能已基本开发完成。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 三剑客：组件、插件、插槽的深度辨析]]></title>    <link>https://juejin.cn/post/7594681318828425266</link>    <guid>https://juejin.cn/post/7594681318828425266</guid>    <pubDate>2026-01-13T14:19:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594681318828425266" data-draft-id="7594682922683695113" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 三剑客：组件、插件、插槽的深度辨析"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-13T14:19:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 三剑客：组件、插件、插槽的深度辨析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T14:19:43.000Z" title="Tue Jan 13 2026 14:19:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue 三剑客：组件、插件、插槽的深度辨析</h2>
<blockquote>
<p>组件、插件、插槽是 Vue 生态中的三个核心概念，理解它们的差异是掌握 Vue 架构设计的关键。让我们通过一个完整的对比体系来彻底搞懂它们。</p>
</blockquote>
<h3 data-id="heading-1">一、核心概念全景图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[Vue 核心概念] --&gt; B[Component 组件]
    A --&gt; C[Plugin 插件]
    A --&gt; D[Slot 插槽]
    
    B --&gt; B1[UI 复用单元]
    B --&gt; B2[局部作用域]
    B --&gt; B3[父子通信]
    
    C --&gt; C1[全局功能扩展]
    C --&gt; C2[一次配置]
    C --&gt; C3[多组件共享]
    
    D --&gt; D1[内容分发]
    D --&gt; D2[灵活占位]
    D --&gt; D3[模板组合]
    
    B --&gt; E[使用插件]
    B --&gt; F[包含插槽]
    C --&gt; G[增强组件]
    D --&gt; H[扩展组件]
</code></pre>
<h3 data-id="heading-2">二、三者的本质区别：一句话概括</h3>

























<table><thead><tr><th>概念</th><th>本质</th><th>类比</th></tr></thead><tbody><tr><td><strong>组件</strong></td><td><strong>可复用的 UI 单元</strong></td><td>乐高积木块</td></tr><tr><td><strong>插件</strong></td><td><strong>全局功能扩展包</strong></td><td>乐高工具箱</td></tr><tr><td><strong>插槽</strong></td><td><strong>组件的内容占位符</strong></td><td>乐高积木上的接口</td></tr></tbody></table>
<h3 data-id="heading-3">三、组件 (Component) - Vue 的基石</h3>
<h4 data-id="heading-4">定义与核心特征</h4>
<p><strong>组件是 Vue 应用的构建块</strong>，每个组件都是自包含的、可复用的 Vue 实例。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- UserCard.vue - 组件示例 --&gt;
&lt;template&gt;
  &lt;div class="user-card"&gt;
    &lt;img :src="avatar" alt="用户头像" /&gt;
    &lt;h3&gt;{{ name }}&lt;/h3&gt;
    &lt;p&gt;{{ bio }}&lt;/p&gt;
    &lt;!-- 使用插槽提供扩展点 --&gt;
    &lt;slot name="actions"&gt;&lt;/slot&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  // 组件定义
  name: 'UserCard',
  props: {
    name: String,
    avatar: String,
    bio: String
  },
  // 局部状态
  data() {
    return {
      isActive: false
    }
  },
  // 生命周期
  mounted() {
    console.log('组件已挂载')
  }
}
&lt;/script&gt;

&lt;style scoped&gt;
.user-card {
  border: 1px solid #ccc;
  padding: 20px;
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-5">组件的核心能力：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 组件注册</span>
<span class="hljs-comment">// 全局注册</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">component</span>(<span class="hljs-string">'global-component'</span>, {
  <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;div&gt;全局组件&lt;/div&gt;'</span>
})

<span class="hljs-comment">// 局部注册</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">LocalComponent</span> = {
  <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;div&gt;局部组件&lt;/div&gt;'</span>
}

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">components</span>: {
    <span class="hljs-string">'local-component'</span>: <span class="hljs-title class_">LocalComponent</span>
  }
})

<span class="hljs-comment">// 2. 组件通信体系</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ParentComponent</span> = {
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;child-component 
      :title="parentTitle" 
      @child-event="handleChildEvent"
    /&gt;
  `</span>,
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleChildEvent</span>(<span class="hljs-params">payload</span>) {
      <span class="hljs-comment">// 处理子组件事件</span>
    }
  }
}
</code></pre>
<h3 data-id="heading-6">四、插件 (Plugin) - Vue 的扩展系统</h3>
<h4 data-id="heading-7">定义与核心特征</h4>
<p><strong>插件是对 Vue 的全局增强</strong>，用于添加全局级的功能。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// my-plugin.js - 自定义插件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MyPlugin</span> = {
  <span class="hljs-title function_">install</span>(<span class="hljs-params">Vue, options</span>) {
    <span class="hljs-comment">// 1. 添加全局方法或属性</span>
    <span class="hljs-title class_">Vue</span>.<span class="hljs-property">myGlobalMethod</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'全局方法'</span>)
    }
    
    <span class="hljs-comment">// 2. 添加全局资源（指令/过滤器/组件）</span>
    <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'my-directive'</span>, {
      <span class="hljs-title function_">bind</span>(<span class="hljs-params">el, binding</span>) {
        <span class="hljs-comment">// 指令逻辑</span>
      }
    })
    
    <span class="hljs-comment">// 3. 注入组件选项</span>
    <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">mixin</span>({
      <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'所有组件都会执行'</span>)
      }
    })
    
    <span class="hljs-comment">// 4. 添加实例方法</span>
    <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$myMethod</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'实例方法'</span>)
    }
  }
}

<span class="hljs-comment">// 使用插件</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">MyPlugin</span>, { <span class="hljs-attr">someOption</span>: <span class="hljs-literal">true</span> })
</code></pre>
<h4 data-id="heading-8">常见插件类型：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. UI 组件库插件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ElementUI</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'element-ui'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'element-ui/lib/theme-chalk/index.css'</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">ElementUI</span>)

<span class="hljs-comment">// 2. 功能增强插件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueRouter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VueRouter</span>)

<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vuex</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex'</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Vuex</span>)

<span class="hljs-comment">// 3. 工具类插件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueLazyload</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-lazyload'</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VueLazyload</span>, {
  <span class="hljs-attr">loading</span>: <span class="hljs-string">'/loading.gif'</span>
})
</code></pre>
<h4 data-id="heading-9">插件 vs 组件的关键差异：</h4>






























<table><thead><tr><th>对比维度</th><th>组件</th><th>插件</th></tr></thead><tbody><tr><td><strong>作用范围</strong></td><td>局部（需要显式引入）</td><td>全局（一次配置，处处可用）</td></tr><tr><td><strong>主要目的</strong></td><td>构建 UI 界面</td><td>增强 Vue 本身的能力</td></tr><tr><td><strong>使用频率</strong></td><td>高频率、多次使用</td><td>一次性配置</td></tr><tr><td><strong>典型示例</strong></td><td>Button、Modal、Form</td><td>Router、Vuex、i18n</td></tr></tbody></table>
<h3 data-id="heading-10">五、插槽 (Slot) - 组件的灵活扩展点</h3>
<h4 data-id="heading-11">定义与核心特征</h4>
<p><strong>插槽是组件的内容分发出口</strong>，让父组件可以向子组件传递模板内容。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- BaseLayout.vue - 包含插槽的组件 --&gt;
&lt;template&gt;
  &lt;div class="container"&gt;
    &lt;header&gt;
      &lt;!-- 具名插槽 --&gt;
      &lt;slot name="header"&gt;&lt;/slot&gt;
    &lt;/header&gt;
    
    &lt;main&gt;
      &lt;!-- 默认插槽 --&gt;
      &lt;slot&gt;
        &lt;!-- 后备内容（当父组件不提供内容时显示） --&gt;
        &lt;p&gt;默认内容&lt;/p&gt;
      &lt;/slot&gt;
    &lt;/main&gt;
    
    &lt;footer&gt;
      &lt;slot name="footer"&gt;&lt;/slot&gt;
    &lt;/footer&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-12">插槽的三种类型：</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 父组件使用 --&gt;
&lt;template&gt;
  &lt;BaseLayout&gt;
    &lt;!-- 具名插槽 --&gt;
    &lt;template v-slot:header&gt;
      &lt;h1&gt;页面标题&lt;/h1&gt;
    &lt;/template&gt;
    
    &lt;!-- 默认插槽（简写） --&gt;
    &lt;p&gt;主要内容区域&lt;/p&gt;
    &lt;p&gt;这是默认插槽的内容&lt;/p&gt;
    
    &lt;!-- 作用域插槽 --&gt;
    &lt;template v-slot:footer="slotProps"&gt;
      &lt;p&gt;页脚: {{ slotProps.year }} 年&lt;/p&gt;
    &lt;/template&gt;
    
    &lt;!-- 动态插槽名 --&gt;
    &lt;template v-slot:[dynamicSlotName]&gt;
      动态内容
    &lt;/template&gt;
  &lt;/BaseLayout&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-13">作用域插槽（高级模式）：</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- TodoList.vue --&gt;
&lt;template&gt;
  &lt;ul&gt;
    &lt;li v-for="todo in todos" :key="todo.id"&gt;
      &lt;!-- 作用域插槽：向父组件暴露数据 --&gt;
      &lt;slot :todo="todo" :index="index"&gt;
        &lt;!-- 默认显示 --&gt;
        {{ todo.text }}
      &lt;/slot&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/template&gt;

&lt;!-- 父组件接收数据 --&gt;
&lt;template&gt;
  &lt;TodoList :todos="todos"&gt;
    &lt;template v-slot:default="slotProps"&gt;
      &lt;span :class="{ completed: slotProps.todo.done }"&gt;
        {{ slotProps.index + 1 }}. {{ slotProps.todo.text }}
      &lt;/span&gt;
    &lt;/template&gt;
  &lt;/TodoList&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-14">六、三者协同工作的完整示例</h3>
<p>让我们通过一个实战项目理解三者如何协同：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 首先安装路由插件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueRouter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VueRouter</span>)  <span class="hljs-comment">// 🔴 插件：全局启用路由功能</span>

<span class="hljs-comment">// 2. 定义可复用的布局组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AppLayout</span> = {
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;div class="app-layout"&gt;
      &lt;slot name="navbar"&gt;&lt;/slot&gt;
      &lt;div class="content"&gt;
        &lt;!-- 默认插槽用于显示页面内容 --&gt;
        &lt;slot&gt;&lt;/slot&gt;
      &lt;/div&gt;
      &lt;slot name="footer"&gt;&lt;/slot&gt;
    &lt;/div&gt;
  `</span>
}

<span class="hljs-comment">// 3. 创建页面组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HomePage</span> = {
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;AppLayout&gt;
      &lt;template v-slot:navbar&gt;
        &lt;!-- 向布局组件传递自定义导航栏 --&gt;
        &lt;NavBar title="首页" /&gt;
      &lt;/template&gt;
      
      &lt;!-- 默认插槽内容 --&gt;
      &lt;h1&gt;欢迎访问&lt;/h1&gt;
      &lt;ProductList&gt;
        &lt;!-- 作用域插槽自定义产品显示 --&gt;
        &lt;template v-slot:product="props"&gt;
          &lt;ProductCard :product="props.product" /&gt;
        &lt;/template&gt;
      &lt;/ProductList&gt;
      
      &lt;template v-slot:footer&gt;
        &lt;AppFooter /&gt;
      &lt;/template&gt;
    &lt;/AppLayout&gt;
  `</span>,
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">AppLayout</span>,      <span class="hljs-comment">// 🔵 组件：布局组件</span>
    <span class="hljs-title class_">NavBar</span>,         <span class="hljs-comment">// 🔵 组件：导航栏组件</span>
    <span class="hljs-title class_">ProductList</span>,    <span class="hljs-comment">// 🔵 组件：产品列表</span>
    <span class="hljs-title class_">ProductCard</span>,    <span class="hljs-comment">// 🔵 组件：产品卡片</span>
    <span class="hljs-title class_">AppFooter</span>       <span class="hljs-comment">// 🔵 组件：页脚组件</span>
  }
}

<span class="hljs-comment">// 4. 配置路由（使用插件提供的功能）</span>
<span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VueRouter</span>({
  <span class="hljs-attr">routes</span>: [
    {
      <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
      <span class="hljs-attr">component</span>: <span class="hljs-title class_">HomePage</span>  <span class="hljs-comment">// 使用组件作为路由页面</span>
    }
  ]
})

<span class="hljs-comment">// 5. 创建Vue实例</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  router,  <span class="hljs-comment">// 🔴 插件提供的路由实例</span>
  <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;router-view&gt;&lt;/router-view&gt;'</span>  <span class="hljs-comment">// 🟡 插槽：路由视图占位</span>
}).$mount(<span class="hljs-string">'#app'</span>)
</code></pre>
<h3 data-id="heading-15">七、设计模式与最佳实践</h3>
<h4 data-id="heading-16">何时使用什么？</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[需求分析] --&gt; B{需要什么?}
    
    B --&gt;|构建UI界面| C[使用组件]
    B --&gt;|全局功能扩展| D[使用插件]
    B --&gt;|自定义组件内容| E[使用插槽]
    
    C --&gt; F{组件需要灵活性?}
    F --&gt;|是| G[在组件中添加插槽]
    F --&gt;|否| H[创建完整组件]
    
    D --&gt; I{功能需要复用?}
    I --&gt;|是| J[开发为插件]
    I --&gt;|否| K[使用局部混入]
</code></pre>
<h4 data-id="heading-17">组件设计原则：</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 好的组件设计示例 --&gt;
&lt;template&gt;
  &lt;!-- 提供清晰的插槽接口 --&gt;
  &lt;div class="card"&gt;
    &lt;div class="card-header" v-if="$slots.header"&gt;
      &lt;slot name="header"&gt;&lt;/slot&gt;
    &lt;/div&gt;
    
    &lt;div class="card-body"&gt;
      &lt;slot&gt;
        &lt;!-- 合理的默认内容 --&gt;
        &lt;p&gt;暂无内容&lt;/p&gt;
      &lt;/slot&gt;
    &lt;/div&gt;
    
    &lt;!-- 作用域插槽提供数据 --&gt;
    &lt;div class="card-footer" v-if="$slots.footer"&gt;
      &lt;slot name="footer" :data="footerData"&gt;&lt;/slot&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-18">插件开发规范：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 良好的插件结构</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">WellDesignedPlugin</span> = {
  <span class="hljs-title function_">install</span>(<span class="hljs-params">Vue, options = {}</span>) {
    <span class="hljs-comment">// 1. 参数验证</span>
    <span class="hljs-keyword">if</span> (!options.<span class="hljs-property">requiredConfig</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'插件需要配置 requiredConfig'</span>)
    }
    
    <span class="hljs-comment">// 2. 安全的全局扩展</span>
    <span class="hljs-keyword">const</span> version = <span class="hljs-title class_">Number</span>(<span class="hljs-title class_">Vue</span>.<span class="hljs-property">version</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>)[<span class="hljs-number">0</span>])
    <span class="hljs-keyword">if</span> (version &gt;= <span class="hljs-number">2</span>) {
      <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$safeMethod</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 兼容性处理</span>
      }
    }
    
    <span class="hljs-comment">// 3. 提供卸载方法</span>
    <span class="hljs-keyword">const</span> originalDestroy = <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$destroy</span>
    <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$destroy</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 清理逻辑</span>
      originalDestroy.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>)
    }
  }
}
</code></pre>
<h3 data-id="heading-19">八、常见误区与澄清</h3>
<h4 data-id="heading-20">误区1：插件可以替代组件</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误：用插件实现UI组件</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>({
  <span class="hljs-title function_">install</span>(<span class="hljs-params">Vue</span>) {
    <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$showModal</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">content</span>) {
      <span class="hljs-comment">// 这应该是组件，不是插件</span>
    }
  }
})

<span class="hljs-comment">// ✅ 正确：组件实现UI，插件封装工具</span>
<span class="hljs-comment">// Modal.vue - 作为组件</span>
<span class="hljs-comment">// modal-plugin.js - 如果需要全局调用，可以包装为插件</span>
</code></pre>
<h4 data-id="heading-21">误区2：插槽就是子组件</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- ❌ 误解：插槽是子组件 --&gt;
&lt;Parent&gt;
  &lt;Child /&gt;  &lt;!-- 这是组件，不是插槽内容 --&gt;
&lt;/Parent&gt;

&lt;!-- ✅ 正确理解 --&gt;
&lt;Parent&gt;
  &lt;!-- 这是插槽内容，会被分发到Parent的&lt;slot&gt;位置 --&gt;
  &lt;template v-slot:default&gt;
    &lt;Child /&gt;
  &lt;/template&gt;
&lt;/Parent&gt;
</code></pre>
<h4 data-id="heading-22">误区3：过度使用混入（Mixin）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 过度使用：应该用插槽或组合式API代替</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">mixin</span>({
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">globalData</span>: <span class="hljs-string">'应该避免'</span>
    }
  }
})

<span class="hljs-comment">// ✅ 更好的方式：组合式函数（Vue 3）</span>
<span class="hljs-comment">// 或使用作用域插槽传递数据</span>
</code></pre>
<h3 data-id="heading-23">九、Vue 3 中的演进</h3>
<h4 data-id="heading-24">组合式 API 的影响：</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Vue 3 中三者关系更加清晰 --&gt;
&lt;script setup&gt;
// 1. 组件 - 更简洁的定义
import { defineComponent } from 'vue'

// 2. 插件 - 通过 provide/inject 更好地集成
import { provide } from 'vue'
provide('pluginData', data)

// 3. 插槽 - 更灵活的用法
defineProps(['modelValue'])
defineEmits(['update:modelValue'])
&lt;/script&gt;

&lt;template&gt;
  &lt;!-- 插槽作用域解构 --&gt;
  &lt;slot name="item" v-bind="{ id, name }"&gt;&lt;/slot&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-25">十、总结：三位一体的 Vue 架构</h3>





























<table><thead><tr><th>概念</th><th>角色</th><th>关键特征</th><th>最佳实践</th></tr></thead><tbody><tr><td><strong>组件</strong></td><td>构建者</td><td>局部作用域、props/events接口、可复用</td><td>单一职责、合理拆分、明确接口</td></tr><tr><td><strong>插件</strong></td><td>增强者</td><td>全局作用域、一次配置、功能扩展</td><td>轻量封装、提供选项、良好文档</td></tr><tr><td><strong>插槽</strong></td><td>连接者</td><td>内容分发、模板组合、作用域暴露</td><td>明确命名、提供后备、作用域数据</td></tr></tbody></table>
<p><strong>记住这个核心公式：</strong></p>
<blockquote>
<p><strong>应用 = 插件增强的Vue实例 + 组件构建的UI树 + 插槽连接的组件关系</strong></p>
</blockquote>
<h4 data-id="heading-26">最终决策指南：</h4>
<ol>
<li>
<p><strong>当你需要...</strong></p>
<ul>
<li><strong>复用UI片段</strong> → 创建组件</li>
<li><strong>添加全局功能</strong> → 开发插件</li>
<li><strong>自定义组件内部结构</strong> → 使用插槽</li>
</ul>
</li>
<li>
<p><strong>在架构中...</strong></p>
<ul>
<li>插件在最外层配置全局能力</li>
<li>组件在中间层构建功能模块</li>
<li>插槽在最内层实现灵活定制</li>
</ul>
</li>
<li>
<p><strong>进化方向...</strong></p>
<ul>
<li>Vue 2：Options API + 三者分明</li>
<li>Vue 3：Composition API + 更灵活的组合</li>
</ul>
</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react native中实现视频转歌]]></title>    <link>https://juejin.cn/post/7594813727054184482</link>    <guid>https://juejin.cn/post/7594813727054184482</guid>    <pubDate>2026-01-14T10:11:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594813727054184482" data-draft-id="7594813727053594658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react native中实现视频转歌"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2026-01-14T10:11:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sure282"/> <meta itemprop="url" content="https://juejin.cn/user/1410005296489149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react native中实现视频转歌
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1410005296489149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sure282
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T10:11:06.000Z" title="Wed Jan 14 2026 10:11:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">先放图</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09aacdf1da394d5993ddd34791777099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=R6N8%2FdErsyHTnSh4gU%2BE3P%2FbG3M%3D" alt="微信图片_20260114172105_165_23.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09d71febeb2f42aa8939a161a6c425ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=bEKEGe415jX93Pm61VP5um3Zpmw%3D" alt="微信图片_20260114172111_166_23.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/283bb84b69d74d7cb2206f6538d9a3cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=xnzjaaLTdQAoIEwmELpzaMyJh3Q%3D" alt="微信图片_20260114172102_162_23.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce8f66a562dc4198a637a6be5e14bc1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=fvVHD2vqha2B2rdkqkqKc5fcOsQ%3D" alt="微信图片_20260114172103_163_23.jpg" loading="lazy"/></p>
<h2 data-id="heading-1">前言</h2>
<p>先解释一下视频转歌:它的本质是<strong>提取视频文件的音频部分为独立文件</strong>，底层技术原理是不是这样我也不是特别清楚。提取后存到设备内存中 ，音乐播放器可以读取播放该文件。该功能是我在某个音乐播放器应用上看到功能菜单有一个<strong>视频转歌</strong>功能，并简单尝试了，它的效果就是将选择的视频转换为音频，不过该软件转换后的文件是.vts格式，想要使用转换产物肯定要支持.vts或者了解这种文件怎么读取，至于为什么是这样大家应该都能理解，这也不是今天的重点。</p>
<h2 data-id="heading-2">项目环境关键依赖</h2>
<p>在rn应用中，依赖版本对应性很重要，一旦有一点不匹配就会各种问题，各种失败，而且是使用expo创建的rn项目在需要原生功能时安装的依赖通常需要开发构建，下面是关键依赖以及版本：</p>
<ul>
<li>"expo": "~54.0.31",</li>
<li>"kroog-ffmpeg-kit-react-native": "^6.0.9",</li>
<li>"react": "19.1.0",</li>
</ul>
<p>实现<strong>视频转歌</strong>的核心依赖是kroog-ffmpeg-kit-react-native，这个依赖很明显是folk的分支，原包ffmpeg-kit好像已经不再维护，前段时间有个新闻说谷歌AI发现该依赖的漏洞，一段时间如果不修复，谷歌会公布漏洞，该项目团队回应说(通俗地说)你要是有良心就捐点money，你也是大用户，带头白嫖巴拉巴的。</p>
<p>核心依赖找到后，除了如何使用依赖外，流程非常清晰:<strong>选择视频文件-&gt;获取uri等信息-&gt;交给ffmpeg-&gt;转化-&gt;监听处理转换进度 -&gt;更新进度-&gt;获取转换后的缓存结果-&gt;保存到设备</strong>:</p>
<p><strong>1.选取视频文件</strong></p>
<p>选取视频可以使用两种依赖库，分别是expo-media-library和expo-document-picker，
这里我们使用前者获取设备中MediaType.video类型的数据渲染成列表，供用户选择，选取后我们拿到uri</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { getAssetsAsync, <span class="hljs-title class_">MediaType</span>, requestPermissionsAsync, <span class="hljs-keyword">type</span> <span class="hljs-title class_">AssetsOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-media-library'</span>;
    <span class="hljs-comment">/**
     * 请求权限并获取视频列表
     *
     * 此方法会先请求媒体库读取权限，如果授权成功则调用 fetchVideos 方法加载视频数据。
     * 如果未获得权限，则弹出提示框告知用户。
     *
     * <span class="hljs-doctag">@param</span> reset 是否重置当前已有的视频列表，默认为 false
     * <span class="hljs-doctag">@returns</span> Promise&lt;void&gt;
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">requestPermissionAndGetVideos</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">reset = <span class="hljs-literal">true</span></span>) =&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
            <span class="hljs-comment">// 请求媒体库权限</span>
            <span class="hljs-keyword">const</span> { status } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestPermissionsAsync</span>();
            <span class="hljs-keyword">if</span> (status !== <span class="hljs-string">'granted'</span>) {
                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'需要访问媒体库权限才能获取视频文件，请在设置中开启权限。'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span> });
                <span class="hljs-title function_">setHasPermission</span>(<span class="hljs-literal">false</span>);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-title function_">setHasPermission</span>(<span class="hljs-literal">true</span>);
            <span class="hljs-comment">// 获取视频文件，重新请求权限时默认重置列表</span>
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchVideos</span>(reset);
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'获取视频文件失败，请重试'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
        }
    };
        <span class="hljs-comment">/**
         * 使用expo-media-library 获取视频文件列表
         * 和expo-document-picker 获取视频文件列表结果不太一样，expo-media-library 会返回更多的视频文件
         * 调用系统 API 获取指定范围内的视频资源，并更新状态以渲染到界面。
         * 支持分页加载与刷新功能。
         *
         * <span class="hljs-doctag">@param</span> reset 是否清空已有数据后重新加载，默认为 false
         * <span class="hljs-doctag">@returns</span> Promise&lt;void&gt;
         */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchVideos</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">reset = <span class="hljs-literal">false</span></span>) =&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">AssetsOptions</span> = {
                <span class="hljs-attr">mediaType</span>: <span class="hljs-title class_">MediaType</span>.<span class="hljs-property">video</span>, <span class="hljs-comment">// 只获取视频文件</span>
                first, <span class="hljs-comment">// 每次加载根据列数动态调整</span>
                <span class="hljs-attr">after</span>: reset ? <span class="hljs-literal">undefined</span> : after, <span class="hljs-comment">// 分页加载</span>
                <span class="hljs-attr">sortBy</span>: [[<span class="hljs-string">'modificationTime'</span>, <span class="hljs-literal">true</span>]], <span class="hljs-comment">// 按修改时间降序排序</span>
            };
            <span class="hljs-keyword">const</span> { assets = [], endCursor, hasNextPage } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getAssetsAsync</span>(options);
            <span class="hljs-keyword">const</span> videoList = assets.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">asset</span> =&gt;</span> ({
                ...asset,
                <span class="hljs-attr">durationString</span>: <span class="hljs-title function_">formatTime</span>(asset.<span class="hljs-property">duration</span>),
            }));
            <span class="hljs-keyword">if</span> (reset) {
                <span class="hljs-title function_">setVideos</span>(videoList);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">setVideos</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, ...videoList]);
            }
            <span class="hljs-title function_">setAfter</span>(endCursor);
            <span class="hljs-title function_">setHasMore</span>(hasNextPage);
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'获取视频列表失败，请重试'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
        }
    };
</code></pre>
<p>通过以上代码我们拿到视频列表，使用expo-media-library的好处在于可以分批获取视频文件，非常便于分页加载</p>
<p><strong>2.核心操作 使用ffmpeg-kit从指定文件中提取音频：</strong>
当用户选取视频后我们存储uri，并使用expo-file-system检查文件uri是否存在，expo-file-system目前有新版和legacy版本，API区别很大，新版有三个核心依赖:Paths File Directory,API不像老版本直观，目前可以使用legacy版本，根据自己情况选择即可
文件存在则将文件存入缓存目录，使用FFmpegKi类执行命令： <code>-i "${nativeInputPath}" -vn -c:a aac -b:a 192k "${nativeOutputPath}"</code>;
目前该依赖库并不能转换成mp3但是可以转换成m4a格式音频:</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">FFmpegKit</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">FFmpegSession</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">Log</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">FFmpegSessionCompleteCallback</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">LogCallback</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'kroog-ffmpeg-kit-react-native'</span>;

    <span class="hljs-comment">/**
     * 异步处理视频转音频的核心逻辑函数。
     * 
     * 主要功能包括：
     * 1. 检查并创建用于 FFmpeg 的本地工作目录；
     * 2. 将选中的视频文件复制到缓存目录以确保访问权限；
     * 3. 使用 FFmpeg 提取音频流并进行格式转换；
     * 4. 在转换过程中更新进度条；
     * 5. 完成后将结果保存至应用私有目录，并提示用户；
     * 6. 包含详细的错误处理与取消机制支持。
     *
     * <span class="hljs-doctag">@param</span> <span class="hljs-variable">video</span> - 视频资源对象，必须包含 uri 和其他必要元数据（如 duration、filename 等）。
     * <span class="hljs-doctag">@returns</span> 无返回值。副作用包括 UI 更新、文件操作及可能的弹窗提示。
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleConvertVideo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">video: VideoAsset</span>) =&gt; {
        <span class="hljs-comment">/**
         * 检查当前是否有选中的视频文件，没有则提示用户选择视频文件
         */</span>
        <span class="hljs-keyword">if</span> (!video) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'请选择视频文件'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span> });
            <span class="hljs-keyword">return</span>;
        };
        <span class="hljs-comment">/**保存视频资源对象 */</span>
        convertVideoRef.<span class="hljs-property">current</span> = video;
        <span class="hljs-comment">/**
         * 先检查源文件是否存在，源文件不存在停止执行
         * 后续会检查缓存文件是否存在，
         * 如果存在就不缓存，直接使用缓存文件
         */</span>
        <span class="hljs-keyword">const</span> sourceFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(video.<span class="hljs-property">uri</span>);
        <span class="hljs-keyword">if</span> (!sourceFile.<span class="hljs-property">exists</span>) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'视频文件不存在'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">const</span> { <span class="hljs-variable language_">document</span>, cache } = <span class="hljs-title class_">Paths</span>;
        <span class="hljs-comment">/**
         *  存储转换后的音频文件用的FFmpeg 的本地工作目录
         */</span>
        <span class="hljs-keyword">let</span> <span class="hljs-attr">ffmpegFolder</span>: <span class="hljs-title class_">Directory</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
        <span class="hljs-comment">/**
         * 检测目录是否存在，不存在则创建
         */</span>
        <span class="hljs-keyword">try</span> {

            <span class="hljs-comment">/**
             * 新版expo-file-system 检测文件是否是文件夹使用
             * Paths.info(uri)静态方法方法可以检测文件是否是文件夹
             * 返回对象{exists: boolean, isDirectory: boolean}
             * 或者直接使用new Dictory(ffmpegDir)返回对象，目录是否存在，不存在调用返回值create方法创建
             * 如果路径中包含中文文字必须使用encodeURI进行编码,否则报错
             * 使用encodeURI可以完整路径转码，使用encodeURIComponent
             * 可能转换过多导致路径报错，主要是路径中的中文名部分要转换
             * 第二个参数文件夹名前后写不写/都可以
             */</span>

            ffmpegFolder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Directory</span>(<span class="hljs-title class_">Paths</span>.<span class="hljs-property">document</span>, <span class="hljs-variable constant_">MUSIC_FILE_FILE_NAME</span>);
            <span class="hljs-keyword">if</span> (!ffmpegFolder.<span class="hljs-property">exists</span>) {
                <span class="hljs-keyword">let</span> <span class="hljs-attr">obj</span>: <span class="hljs-title class_">DirectoryCreateOptions</span> = { <span class="hljs-attr">intermediates</span>: <span class="hljs-literal">true</span> };
                <span class="hljs-comment">/**
                 * 创建目录
                 */</span>
                ffmpegFolder.<span class="hljs-title function_">create</span>(obj)
            };
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'无法创建存储文件夹'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
            <span class="hljs-keyword">return</span>;
        };
        <span class="hljs-comment">/**
         * 开始转换视频为音频
         * 1. 复制视频到缓存目录
         * 2. 构建FFmpeg命令
         * 3. 执行转换
         * 4. 清理临时文件
         * 设置开始转换状态为true，重置进度值为0，并设置取消标志为false
         */</span>
        <span class="hljs-title function_">setIsConverting</span>(<span class="hljs-literal">true</span>);
        <span class="hljs-title function_">setProgress</span>(<span class="hljs-number">0</span>);
        cancelledRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> { filename } = video;
            <span class="hljs-keyword">const</span> baseName = filename ? filename.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.[^/.]+$/</span>, <span class="hljs-string">''</span>) : <span class="hljs-string">`video_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
            <span class="hljs-comment">/**先将目标文件复制到缓存目录中 */</span>
            <span class="hljs-keyword">const</span> cacheDir = cache.<span class="hljs-property">uri</span> ?? <span class="hljs-variable language_">document</span>.<span class="hljs-property">uri</span> ?? <span class="hljs-string">'/'</span>;
            <span class="hljs-comment">//方式1: 手动拼接文件要保存到缓存目录路径</span>
            <span class="hljs-keyword">const</span> cachedInputUri = <span class="hljs-string">`<span class="hljs-subst">${cacheDir}</span><span class="hljs-subst">${filename ?? baseName}</span>`</span>;
            cachedInputUriRef.<span class="hljs-property">current</span> = cachedInputUri;
            <span class="hljs-comment">// 方式2: 使用File构造函数链式创建目标文件</span>
            <span class="hljs-comment">// const cachedInputUri = new File(Paths.cache, filename ?? baseName).uri;</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">/**
                 * 创建缓存目标文件对象检查是否存在
                 * 如果缓存文件存在，直接使用缓存文件,不存在则缓存视频文件
                 */</span>
                <span class="hljs-keyword">const</span> targetFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(cachedInputUri);
                <span class="hljs-keyword">if</span> (!targetFile.<span class="hljs-property">exists</span>) {
                    sourceFile.<span class="hljs-title function_">copy</span>(targetFile);
                };
            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'复制视频到缓存目录失败'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
            };

            <span class="hljs-comment">// 添加时间戳到文件名，避免文件名冲突</span>
            <span class="hljs-keyword">const</span> timestamp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[:.]/g</span>, <span class="hljs-string">'-'</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">19</span>);
            <span class="hljs-comment">/**
             * 输出文件名，不带extension，
             * 因为要生成图片时使用名称作为文件名，所以不能带扩展名
             * cachedOutputUri: 缓存输出文件路径
             * finalOutputUri: 最终输出文件路径
             */</span>
            <span class="hljs-keyword">const</span> outputFileName = <span class="hljs-string">`<span class="hljs-subst">${baseName}</span>_<span class="hljs-subst">${timestamp}</span>`</span>;
            <span class="hljs-keyword">const</span> cachedOutputUri = <span class="hljs-string">`<span class="hljs-subst">${cacheDir}</span><span class="hljs-subst">${outputFileName}</span>.m4a`</span>;
            <span class="hljs-keyword">const</span> finalOutputUri = <span class="hljs-string">`<span class="hljs-subst">${ffmpegFolder.uri}</span><span class="hljs-subst">${outputFileName}</span>.m4a`</span>;
            outFileNameRef.<span class="hljs-property">current</span> = outputFileName;
            <span class="hljs-comment">// 保存临时文件路径用于清理</span>
            cachedOutputUriRef.<span class="hljs-property">current</span> = cachedOutputUri;
            lastOutputUriRef.<span class="hljs-property">current</span> = finalOutputUri;
            <span class="hljs-comment">/**
             * 创建进出路径，用于command命令拼接
             */</span>
            <span class="hljs-keyword">const</span> nativeInputPath = cachedInputUri.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'file://'</span>) ? cachedInputUri.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'file://'</span>, <span class="hljs-string">''</span>) : cachedInputUri;
            <span class="hljs-keyword">const</span> nativeOutputPath = cachedOutputUri.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'file://'</span>) ? cachedOutputUri.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'file://'</span>, <span class="hljs-string">''</span>) : cachedOutputUri;
            <span class="hljs-comment">/** 
             * 构建命令 暂不支持mp3，暂时使用m4a
             * 转换命令参考：
             * 
            */</span>
            <span class="hljs-keyword">const</span> command = <span class="hljs-string">`-i "<span class="hljs-subst">${nativeInputPath}</span>" -vn -c:a aac -b:a 192k "<span class="hljs-subst">${nativeOutputPath}</span>"`</span>;
            <span class="hljs-comment">/**
             * 转换完成回调函数
             * 1.获取转换码
             * 2.检查转换是否成功
             * 3.如果成功，检查是否取消，取消不保存文件
             * 4.如果未取消，保存输出文件
             * 5.清理临时文件
             * 6.创建视频缩略图保存到cover目录中
             * 7.将歌曲信息和图片信息写入musicList文件夹下的convertList.json文件中
             * <span class="hljs-doctag">@param</span> session FFmpegSession
             * <span class="hljs-doctag">@returns</span> 
             */</span>
            <span class="hljs-keyword">const</span> <span class="hljs-attr">completeCallback</span>: <span class="hljs-title class_">FFmpegSessionCompleteCallback</span> = <span class="hljs-keyword">async</span> (<span class="hljs-attr">session</span>: <span class="hljs-title class_">FFmpegSession</span>) =&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 获取转换码</span>
                    <span class="hljs-keyword">const</span> returnCode = <span class="hljs-keyword">await</span> session.<span class="hljs-title function_">getReturnCode</span>();
                    <span class="hljs-comment">/**
                     * 检查是否成功
                     * 方法1：调用ReturnCode的成员方法isValueSuccess返回布尔值
                     * 方法2：调用ReturnCode的静态方法isSuccess传递ReturnCode对象实例然后返回
                     * 布尔值
                     * 成员方法getCode 返回ReturnCode对象实例的code属性值，0 是success 255 是cancel
                     */</span>
                    <span class="hljs-comment">/**方式1 调用成员方法检测 */</span>
                    <span class="hljs-keyword">const</span> success = returnCode.<span class="hljs-title function_">isValueSuccess</span>();
                    <span class="hljs-comment">/**方式2 调用成员方法getValue获取执行值，再调用静态方法isSuccess 检查是否成功 */</span>
                    <span class="hljs-comment">// success = ReturnCode.isSuccess(returnCode);</span>
                    <span class="hljs-keyword">if</span> (success) {
                        <span class="hljs-comment">// 如果转换已取消，则跳过保存</span>
                        <span class="hljs-keyword">if</span> (cancelledRef.<span class="hljs-property">current</span>) {
                            <span class="hljs-comment">// 即使取消也要清理临时文件</span>
                            <span class="hljs-keyword">try</span> {
                                <span class="hljs-keyword">if</span> (cachedInputUri) {
                                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(cachedInputUri).<span class="hljs-title function_">delete</span>();
                                }
                            } <span class="hljs-keyword">catch</span> (error) {
                                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'清理输入缓存文件失败'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                            }
                            <span class="hljs-keyword">return</span>;
                        };
                        <span class="hljs-comment">// 检查输出文件是否存在且非空</span>
                        <span class="hljs-keyword">try</span> {
                            <span class="hljs-keyword">const</span> { exists } = <span class="hljs-title class_">Paths</span>.<span class="hljs-title function_">info</span>(cachedOutputUriRef.<span class="hljs-property">current</span>!);
                            <span class="hljs-keyword">if</span> (!exists) {
                                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'生成的音频文件为空或不存在'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                                <span class="hljs-keyword">return</span>;
                            };
                        } <span class="hljs-keyword">catch</span> (error) {
                            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'无法验证输出文件'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                            <span class="hljs-keyword">return</span>;
                        };
                        isSuccessRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">/**
                         * 转换失败后获取状态码解释原因
                         */</span>
                        <span class="hljs-keyword">const</span> returnCodeValue = returnCode.<span class="hljs-title function_">getValue</span>();
                        <span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>&gt; = {
                            <span class="hljs-number">255</span>: <span class="hljs-string">'转换已取消'</span>,
                            <span class="hljs-number">1</span>: <span class="hljs-string">'输入文件不存在或无法读取'</span>,
                            <span class="hljs-number">2</span>: <span class="hljs-string">'输出路径无效或无写入权限'</span>,
                        }
                        <span class="hljs-keyword">let</span> errorMessage = config[returnCodeValue] ?? <span class="hljs-string">`转换失败 (错误码: <span class="hljs-subst">${returnCodeValue}</span>)`</span>;
                        <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: errorMessage, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                    }
                } <span class="hljs-keyword">catch</span> (e) {
                    <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'转换过程中发生错误'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                } <span class="hljs-keyword">finally</span> {
                    cancelledRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
                    <span class="hljs-title function_">setIsConverting</span>(<span class="hljs-literal">false</span>);
                    <span class="hljs-title function_">setProgress</span>(<span class="hljs-number">0</span>);
                    <span class="hljs-keyword">if</span> (isSuccessRef.<span class="hljs-property">current</span>) {
                        <span class="hljs-title function_">setVisible</span>(<span class="hljs-literal">true</span>);
                    }
                }
            };
            <span class="hljs-comment">/**
             * 转换过程中日志处理,更新转换进度
             * 使用生产环境友好的日志回调
             * <span class="hljs-doctag">@param</span> log Log 日志对象
             */</span>
            <span class="hljs-comment">// 为了兼容现有的日志解析逻辑，保留原有的进度计算</span>
            <span class="hljs-keyword">const</span> <span class="hljs-attr">legacyLogCallback</span>: <span class="hljs-title class_">LogCallback</span> = <span class="hljs-function">(<span class="hljs-params">log: Log</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> message = log.<span class="hljs-title function_">getMessage</span>();
                <span class="hljs-keyword">if</span> (message.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'time='</span>)) {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-keyword">const</span> timeMatch = message.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/time=(\d+):(\d+):(\d+\.\d+)/</span>);
                        <span class="hljs-keyword">if</span> (timeMatch) {
                            <span class="hljs-keyword">const</span> hours = <span class="hljs-built_in">parseFloat</span>(timeMatch[<span class="hljs-number">1</span>]);
                            <span class="hljs-keyword">const</span> minutes = <span class="hljs-built_in">parseFloat</span>(timeMatch[<span class="hljs-number">2</span>]);
                            <span class="hljs-keyword">const</span> seconds = <span class="hljs-built_in">parseFloat</span>(timeMatch[<span class="hljs-number">3</span>]);
                            <span class="hljs-keyword">const</span> currentTimeInSeconds = hours * <span class="hljs-number">3600</span> + minutes * <span class="hljs-number">60</span> + seconds;
                            <span class="hljs-keyword">const</span> totalTimeInSeconds = (video &amp;&amp; (video.<span class="hljs-property">duration</span> ?? <span class="hljs-number">0</span>)) || <span class="hljs-number">120</span>;
                            <span class="hljs-keyword">const</span> calculatedProgress = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">100</span>, (currentTimeInSeconds / totalTimeInSeconds) * <span class="hljs-number">100</span>);
                            <span class="hljs-title function_">setProgress</span>(calculatedProgress);
                        }
                    } <span class="hljs-keyword">catch</span> (error) {
                        <span class="hljs-keyword">if</span> (__DEV__) {
                            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'进度解析失败'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                        }
                    }
                }
            };
            <span class="hljs-comment">/** 开始转换 */</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">/**
                 * 存在如下方法
                 * FFmpegKit.execute(cmd): Promise&lt;FFmpegSession&gt;
                 * executeAsync(command: string, completeCallback?: FFmpegSessionCompleteCallback, logCallback?: LogCallback, statisticsCallback?: StatisticsCallback): Promise&lt;FFmpegSession&gt;
                 */</span>
                conversionSessionRef.<span class="hljs-property">current</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">FFmpegKit</span>.<span class="hljs-title function_">executeAsync</span>(command, completeCallback, legacyLogCallback);
            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'转换过程中发生错误'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
            }
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'转换过程中发生错误'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-title function_">setProgress</span>(<span class="hljs-number">0</span>);
        }
    };
</code></pre>
<p>completeCallback中是转换完成时执行的回调函数，而legacyLogCallback回调函数则是转换过程的日志回调函数 ，在该函数中可以做转换进度更新，也就是说我们核心就是使用调用conversionSessionRef.current = await FFmpegKit.executeAsync(command, completeCallback, legacyLogCallback);
并且在转换过程中添加取消转换和转换失败处理：基本效果就是如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7aa828de432847ffa6ba80a24bc21e47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=2MEM1%2F%2B%2B4mA2R2Q0ZkqXilwcM8g%3D" alt="微信图片_20260114164854_149_23.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c581ef0dd6241a7a6325784e2cb5398~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=iN7K%2FucYW7HZfiaeP35udVd5saA%3D" alt="微信图片_20260114164855_150_23.jpg" loading="lazy"/></p>
<p><strong>3.取消转换</strong></p>
<p>转换途中万一发现不是自己想要转换的，可以终止转换，我们要清理转换前创建的文件等:</p>
<pre><code class="hljs language-ts" lang="ts">    <span class="hljs-comment">/**
     * 取消转换
     * <span class="hljs-doctag">@returns</span> Promise&lt;void&gt;
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCancel</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// mark as cancelled so callbacks skip saving</span>
        cancelledRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (!conversionSessionRef.<span class="hljs-property">current</span>) {
            <span class="hljs-title function_">setIsConverting</span>(<span class="hljs-literal">false</span>);
            <span class="hljs-title function_">setProgress</span>(<span class="hljs-number">0</span>);
            <span class="hljs-keyword">return</span>;
        };

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">/**
             * 优先尝试 session.cancel()
             */</span>
            <span class="hljs-keyword">await</span> conversionSessionRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">cancel</span>();
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-comment">/**
             * 调用cancel方法失败，尝试通过 sessionId 使用 FFmpegKit.cancel
             */</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> sessionId = conversionSessionRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">getSessionId</span>();
                <span class="hljs-keyword">await</span> <span class="hljs-title class_">FFmpegKit</span>.<span class="hljs-title function_">cancel</span>(sessionId)
                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'已取消转换'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'success'</span> });
            } <span class="hljs-keyword">catch</span> (err) {
                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'取消转换失败'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
            }
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 清理状态</span>
            conversionSessionRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
            <span class="hljs-title function_">setIsConverting</span>(<span class="hljs-literal">false</span>);
            <span class="hljs-title function_">setProgress</span>(<span class="hljs-number">0</span>);
            <span class="hljs-comment">// 删除临时输出文件，避免残留</span>
            <span class="hljs-keyword">if</span> (cachedOutputUriRef.<span class="hljs-property">current</span>) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">const</span> file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(cachedOutputUriRef.<span class="hljs-property">current</span>);
                    <span class="hljs-keyword">if</span> (file.<span class="hljs-property">exists</span>) {
                        file.<span class="hljs-title function_">delete</span>();
                    }
                } <span class="hljs-keyword">catch</span> (delErr) {
                    <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'删除临时输出文件失败'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                }
                cachedOutputUriRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">if</span> (lastOutputUriRef.<span class="hljs-property">current</span>) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">const</span> file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(lastOutputUriRef.<span class="hljs-property">current</span>);
                    <span class="hljs-keyword">if</span> (file.<span class="hljs-property">exists</span>) {
                        file.<span class="hljs-title function_">delete</span>();
                    }
                } <span class="hljs-keyword">catch</span> (delErr) {
                    <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'删除临时输出文件失败'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                }
                lastOutputUriRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
            }
        }
    };
</code></pre>
<p><strong>4.转换完成可以提示用户修改歌曲信息：</strong></p>
<pre><code class="hljs language-ts" lang="ts">    <span class="hljs-comment">/**
     * 保存转换后的文件
     * 将其从转换完成中提取出来，添加转换后可以填写信息，不填写则使用默认信息
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">saveConvertFile</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">info?: UpdateSongInfoConfig</span>) =&gt; {
        <span class="hljs-keyword">if</span> (!convertVideoRef.<span class="hljs-property">current</span> || !isSuccessRef.<span class="hljs-property">current</span>) {
            <span class="hljs-keyword">return</span>;
        };
        <span class="hljs-comment">// 复制文件到应用私有目录</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> { uri, duration, durationString } = convertVideoRef.<span class="hljs-property">current</span>;
            <span class="hljs-keyword">const</span> file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(cachedOutputUriRef.<span class="hljs-property">current</span>!);
            <span class="hljs-keyword">const</span> privateFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(lastOutputUriRef.<span class="hljs-property">current</span>!);
            file.<span class="hljs-title function_">copy</span>(privateFile);
            <span class="hljs-comment">/**创建对应视频的封面图 */</span>
            <span class="hljs-keyword">const</span> coverUrl = <span class="hljs-keyword">await</span> <span class="hljs-title function_">addAudioCover</span>(uri, outFileNameRef.<span class="hljs-property">current</span>!) ?? <span class="hljs-string">''</span>;
            <span class="hljs-comment">/**
             * 转换后的音频文件存在
             * 执行添加音频json文件操作
             */</span>
            <span class="hljs-keyword">const</span> { exists, creationTime, md5, <span class="hljs-attr">uri</span>: musicUri, modificationTime } = privateFile;
            <span class="hljs-keyword">if</span> (exists) {
                <span class="hljs-comment">/**
                 * 这里必须手动解构，无法直接...rest,File对象上的属性不可枚举
                 * 类的内部是get方法写的
                 * 调整为存储到数据表
                 */</span>
                <span class="hljs-keyword">const</span> { title = outFileNameRef.<span class="hljs-property">current</span>!, artist = <span class="hljs-string">'未知歌手'</span>, album = <span class="hljs-string">'未知专辑'</span> } = info ?? {};
                <span class="hljs-keyword">const</span> time = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
                <span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: <span class="hljs-title class_">SqliteSongInfo</span> = {
                    <span class="hljs-attr">id</span>: md5 || <span class="hljs-string">`<span class="hljs-subst">${time}</span>`</span>,
                    <span class="hljs-attr">uri</span>: musicUri,
                    artist,
                    title,
                    <span class="hljs-attr">duration</span>: duration,
                    durationString,
                    <span class="hljs-attr">modificationTime</span>: modificationTime ?? time,
                    coverUrl,
                    <span class="hljs-attr">isCollection</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-attr">isPrivate</span>: <span class="hljs-number">1</span>,
                    <span class="hljs-attr">creationTime</span>: creationTime ?? time,
                    album,
                    <span class="hljs-attr">lyrics</span>: <span class="hljs-string">''</span>,
                };
                <span class="hljs-keyword">const</span> bool = <span class="hljs-keyword">await</span> <span class="hljs-title function_">addSong</span>(obj, <span class="hljs-variable constant_">SQLITE_CONVERTED_TABLE_NAME</span>);
                <span class="hljs-keyword">if</span> (bool) {
                    convertVideoRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
                    isSuccessRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
                    <span class="hljs-keyword">const</span> cacheInputFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(cachedInputUriRef.<span class="hljs-property">current</span>!);
                    <span class="hljs-keyword">if</span> (cacheInputFile.<span class="hljs-property">exists</span>) {
                        cacheInputFile.<span class="hljs-title function_">delete</span>();
                        cachedInputUriRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
                    }
                    <span class="hljs-comment">/**删除转换后的缓存音频文件 */</span>
                    file.<span class="hljs-title function_">delete</span>();
                    <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'音频文件已成功保存'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'success'</span> });
                };
            };
        } <span class="hljs-keyword">catch</span> (copyError) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'无法保存音频文件到应用文件夹'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
        }
    }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cee4a3dfe2ba4b389caada9a1c052872~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=JoXCm3aWr8wh2vFhz3VtGn7G65U%3D" alt="微信图片_20260114164856_151_23.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f347ce46aed482c90a30fc368b4950d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=e2HRatZSDgHLHr3Pa9N4Y5ZvVNA%3D" alt="微信图片_20260114164857_152_23.jpg" loading="lazy"/></p>
<p>用户可以确定和取消，都将保存转换后的文件</p>
<p><strong>5.查看转换后的歌曲列表，在这里可以修改和删除:</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f30190007667469e969a8f0a43fc0001~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=kIqRV04n1gakQZ9G6kj3rKkLkAs%3D" alt="微信图片_20260114164859_154_23.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bfef8b023e041368ecddfb4d1e4321a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=ve%2FPfwHMSEnQ4igGJitW0oNyr4M%3D" alt="微信图片_20260114164900_155_23.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c27acd4243144dcaae2d50150f1c509~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=lkXMJudM7yIAB0QdLJHsRy0jbRI%3D" alt="微信图片_20260114164901_156_23.jpg" loading="lazy"/></p>
<p>当前还可以播放：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fef5ac9f362f4aebb10b5f6e42f017e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=3VwtgliZjP5YA4m31eKAwknnKkA%3D" alt="微信图片_20260114170201_157_23.jpg" loading="lazy"/></p>
<p>关于音乐播放，当前项目中使用了react-native-audio-pro和expo-audio，在转换管理界面的播放使用了exp-audio，其实目前rn音乐播放器使用react-native-track-player依赖库最好，但是对于新版本rn和expo有难以解决的bug，react-native-audio-pro则bug少一点</p>
<p><strong>6.创建音频文件的封面图</strong></p>
<p>核心使用expo-video-thumbnails依赖库，获取指定时间的图像，并设置图片质量，但是格式就只能是jpg</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { getThumbnailAsync, <span class="hljs-keyword">type</span> <span class="hljs-title class_">VideoThumbnailsOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-video-thumbnails'</span>;
<span class="hljs-comment">/**
 * 为音频添加封面
 * 使用expo-video-thumbnails库生成音频封面
 * 将图片保存到应用私有目录的cover文件夹中，图片格式.jpg,默认最低画质
 * <span class="hljs-doctag">@param</span> audioUri 音频uri
 * <span class="hljs-doctag">@param</span> coverName 封面名称 通常与音频文件名相同
 * <span class="hljs-doctag">@returns</span> 封面uri
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> addAudioCover = <span class="hljs-keyword">async</span> (<span class="hljs-attr">audioUri</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">coverName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">seconds</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">2000</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt; =&gt; {
    <span class="hljs-keyword">if</span> (!coverName.<span class="hljs-title function_">trim</span>()) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    <span class="hljs-keyword">const</span> { exists } = <span class="hljs-title class_">Paths</span>.<span class="hljs-title function_">info</span>(audioUri);
    <span class="hljs-keyword">if</span> (!exists) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    };
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: <span class="hljs-title class_">VideoThumbnailsOptions</span> = {
            <span class="hljs-attr">time</span>: seconds,
            <span class="hljs-attr">quality</span>: <span class="hljs-number">.7</span>,<span class="hljs-comment">//0~1,0最低1最高</span>
        };
        <span class="hljs-comment">/**
         * 获取视频文件指定秒数的音频封面
         */</span>
        <span class="hljs-keyword">const</span> { uri } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getThumbnailAsync</span>(audioUri, obj);
        <span class="hljs-comment">/**
         * 获取扩展名便于生成封面uri
         */</span>
        <span class="hljs-keyword">const</span> ext = uri.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">at</span>(-<span class="hljs-number">1</span>);
        <span class="hljs-keyword">const</span> file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(uri);
        <span class="hljs-comment">/**
         * 创建封面目录
         * 如果目录不存在则创建
         */</span>
        <span class="hljs-keyword">const</span> coverUrl = <span class="hljs-string">`<span class="hljs-subst">${Paths.<span class="hljs-variable language_">document</span>.uri + COVER_FILE_FILE_NAME}</span>/`</span>
        <span class="hljs-keyword">const</span> { exists, isDirectory } = <span class="hljs-title class_">Paths</span>.<span class="hljs-title function_">info</span>(coverUrl);
        <span class="hljs-keyword">if</span> (!exists || !isDirectory) {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Directory</span>(<span class="hljs-title class_">Paths</span>.<span class="hljs-property">document</span>, <span class="hljs-string">'cover'</span>).<span class="hljs-title function_">create</span>({ <span class="hljs-attr">intermediates</span>: <span class="hljs-literal">true</span> });
        };
        <span class="hljs-comment">/**
         * 创建封面文件
         * 并copy到封面目录
         */</span>
        <span class="hljs-keyword">const</span> finnalUri = <span class="hljs-string">`<span class="hljs-subst">${coverUrl + coverName}</span>.<span class="hljs-subst">${ext}</span>`</span>;
        <span class="hljs-comment">/**
         *  检测是否重名
         */</span>
        <span class="hljs-keyword">const</span> info = <span class="hljs-title class_">Paths</span>.<span class="hljs-title function_">info</span>(finnalUri);
        <span class="hljs-keyword">if</span> (info.<span class="hljs-property">exists</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        file.<span class="hljs-title function_">copy</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(finnalUri));
        file.<span class="hljs-title function_">delete</span>();
        <span class="hljs-keyword">return</span> finnalUri;
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }
}
</code></pre>
<p><strong>7.使用FFmpegKit获取已有mp3文件的封面图，并不是所有文件都有</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">FFmpegKit</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'kroog-ffmpeg-kit-react-native'</span>;
<span class="hljs-comment">/**
 * 使用FFmpeg提取MP3音频文件的封面图片
 * <span class="hljs-doctag">@param</span> audioUri 音频文件的URI路径
 * <span class="hljs-doctag">@param</span> coverName 封面图片的名称（不带扩展名）
 * <span class="hljs-doctag">@returns</span> 封面图片的完整URI路径，如果提取失败返回null
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> extractMp3Cover = <span class="hljs-keyword">async</span> (<span class="hljs-attr">audioUri</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">coverName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt; =&gt; {
    <span class="hljs-keyword">if</span> (!audioUri || !coverName.<span class="hljs-title function_">trim</span>()) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 创建cover目录</span>
        <span class="hljs-keyword">const</span> coverDir = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Directory</span>(<span class="hljs-title class_">Paths</span>.<span class="hljs-property">document</span>, <span class="hljs-string">'cover'</span>);
        <span class="hljs-keyword">if</span> (!coverDir.<span class="hljs-property">exists</span>) {
            coverDir.<span class="hljs-title function_">create</span>({ <span class="hljs-attr">intermediates</span>: <span class="hljs-literal">true</span> });
        }

        <span class="hljs-comment">// 构建输出路径</span>
        <span class="hljs-keyword">const</span> coverPath = <span class="hljs-string">`<span class="hljs-subst">${Paths.<span class="hljs-variable language_">document</span>.uri}</span>cover/<span class="hljs-subst">${coverName}</span>.jpg`</span>;
        <span class="hljs-keyword">const</span> coverFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(coverPath);

        <span class="hljs-comment">// 检查封面是否已存在</span>
        <span class="hljs-keyword">if</span> (coverFile.<span class="hljs-property">exists</span>) {
            <span class="hljs-keyword">return</span> coverPath;
        }

        <span class="hljs-comment">// 使用FFmpeg提取封面图片</span>
        <span class="hljs-comment">// -an: 不处理音频</span>
        <span class="hljs-comment">// -vcodec copy: 直接复制视频流（封面）</span>
        <span class="hljs-comment">// -y: 覆盖已存在的文件</span>
        <span class="hljs-keyword">const</span> command = <span class="hljs-string">`-i "<span class="hljs-subst">${audioUri}</span>" -an -vcodec copy -y "<span class="hljs-subst">${coverPath}</span>"`</span>;
        <span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title class_">FFmpegKit</span>.<span class="hljs-title function_">execute</span>(command);
        <span class="hljs-keyword">const</span> returnCode = <span class="hljs-keyword">await</span> session.<span class="hljs-title function_">getReturnCode</span>();

        <span class="hljs-keyword">if</span> (returnCode.<span class="hljs-title function_">isValueSuccess</span>()) {
            <span class="hljs-comment">// 检查文件是否真的创建成功</span>
            <span class="hljs-keyword">if</span> (coverFile.<span class="hljs-property">exists</span>) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`成功提取封面: <span class="hljs-subst">${coverName}</span>`</span>);
                <span class="hljs-keyword">return</span> coverPath;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 如果文件没有创建，说明没有嵌入封面</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">const</span> output = <span class="hljs-keyword">await</span> session.<span class="hljs-title function_">getOutput</span>();
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'提取封面失败:'</span>, output);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'提取MP3封面出错:'</span>, error);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
};
</code></pre>
<p><strong>8.完整代码:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { useRef, useState, useEffect, <span class="hljs-keyword">type</span> <span class="hljs-variable constant_">FC</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TitleBar</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/music/TitleBar'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VideoList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/VideoList'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Ionicons</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@expo/vector-icons'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">VideoAsset</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types'</span>;
<span class="hljs-keyword">import</span> { router } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-router'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FFmpegKit</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">FFmpegSession</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">Log</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">FFmpegSessionCompleteCallback</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">LogCallback</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'kroog-ffmpeg-kit-react-native'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Modal</span>, <span class="hljs-title class_">StyleSheet</span>, <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Pressable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> { useSafeAreaInsets } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-safe-area-context'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemedView</span>, <span class="hljs-title class_">ThemedText</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/theme/ThemedComponents'</span>;
<span class="hljs-keyword">import</span> { useThemeNotification } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useTheme'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">File</span>, <span class="hljs-title class_">Paths</span>, <span class="hljs-title class_">Directory</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">DirectoryCreateOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-file-system'</span>;
<span class="hljs-keyword">import</span> { addAudioCover } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/audioManager'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">SqliteSongInfo</span>, <span class="hljs-title class_">UpdateSongInfoConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">UpdateOrDeleteModal</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/music/localComp/UpdateOrDeleteModal'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ProcessTip</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/ProcessTip'</span>;
<span class="hljs-keyword">import</span> { addSong } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/libs/sqlite'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">SQLITE_CONVERTED_TABLE_NAME</span>, <span class="hljs-variable constant_">MUSIC_FILE_FILE_NAME</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/constants/SongList'</span>;
<span class="hljs-comment">/**
 * 视频转歌曲页面
 * <span class="hljs-doctag">@returns</span> 
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">FfmpegKitPage</span>: <span class="hljs-variable constant_">FC</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> { top, bottom } = <span class="hljs-title function_">useSafeAreaInsets</span>();
    <span class="hljs-keyword">const</span> [isConverting, setIsConverting] = useState&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> [progress, setProgress] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
    <span class="hljs-comment">/**是否转换成功 */</span>
    <span class="hljs-keyword">const</span> isSuccessRef = useRef&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);
    <span class="hljs-comment">/**保存需要转换的视频文件 */</span>
    <span class="hljs-keyword">const</span> convertVideoRef = useRef&lt;<span class="hljs-title class_">VideoAsset</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-comment">/**保存转换后的文件名 */</span>
    <span class="hljs-keyword">const</span> outFileNameRef = useRef&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> cachedInputUriRef = useRef&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-comment">// 添加状态管理</span>
    <span class="hljs-keyword">const</span> cachedOutputUriRef = useRef&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> lastOutputUriRef = useRef&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> conversionSessionRef = useRef&lt;<span class="hljs-title class_">FFmpegSession</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> cancelledRef = useRef&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> showNotification = <span class="hljs-title function_">useThemeNotification</span>();
    <span class="hljs-keyword">const</span> [visible, setVisible] = useState&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleBack</span> = (<span class="hljs-params"/>) =&gt; {
        router.<span class="hljs-title function_">dismiss</span>();
    };
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">cleanUp</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">if</span> (cachedOutputUriRef.<span class="hljs-property">current</span>) {
            <span class="hljs-keyword">const</span> file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(cachedOutputUriRef.<span class="hljs-property">current</span>);
            <span class="hljs-keyword">if</span> (file.<span class="hljs-property">exists</span>) {
                file.<span class="hljs-title function_">delete</span>();
            }
        }
        cachedOutputUriRef.<span class="hljs-property">current</span> &amp;&amp;= <span class="hljs-literal">null</span>;
        conversionSessionRef.<span class="hljs-property">current</span> &amp;&amp;= <span class="hljs-literal">null</span>;
    };
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">cleanUp</span>();
        }
    }, [])
    <span class="hljs-comment">/**
     * 保存转换后的文件
     * 将其从转换完成中提取出来，添加转换后可以填写信息，不填写则使用默认信息
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">saveConvertFile</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">info?: UpdateSongInfoConfig</span>) =&gt; {
        <span class="hljs-keyword">if</span> (!convertVideoRef.<span class="hljs-property">current</span> || !isSuccessRef.<span class="hljs-property">current</span>) {
            <span class="hljs-keyword">return</span>;
        };
        <span class="hljs-comment">// 复制文件到应用私有目录</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> { uri, duration, durationString } = convertVideoRef.<span class="hljs-property">current</span>;
            <span class="hljs-keyword">const</span> file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(cachedOutputUriRef.<span class="hljs-property">current</span>!);
            <span class="hljs-keyword">const</span> privateFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(lastOutputUriRef.<span class="hljs-property">current</span>!);
            file.<span class="hljs-title function_">copy</span>(privateFile);
            <span class="hljs-comment">/**创建对应视频的封面图 */</span>
            <span class="hljs-keyword">const</span> coverUrl = <span class="hljs-keyword">await</span> <span class="hljs-title function_">addAudioCover</span>(uri, outFileNameRef.<span class="hljs-property">current</span>!) ?? <span class="hljs-string">''</span>;
            <span class="hljs-comment">/**
             * 转换后的音频文件存在
             * 执行添加音频json文件操作
             */</span>
            <span class="hljs-keyword">const</span> { exists, creationTime, md5, <span class="hljs-attr">uri</span>: musicUri, modificationTime } = privateFile;
            <span class="hljs-keyword">if</span> (exists) {
                <span class="hljs-comment">/**
                 * 这里必须手动解构，无法直接...rest,File对象上的属性不可枚举
                 * 类的内部是get方法写的
                 * 调整为存储到数据表
                 */</span>
                <span class="hljs-keyword">const</span> { title = outFileNameRef.<span class="hljs-property">current</span>!, artist = <span class="hljs-string">'未知歌手'</span>, album = <span class="hljs-string">'未知专辑'</span> } = info ?? {};
                <span class="hljs-keyword">const</span> time = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
                <span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: <span class="hljs-title class_">SqliteSongInfo</span> = {
                    <span class="hljs-attr">id</span>: md5 || <span class="hljs-string">`<span class="hljs-subst">${time}</span>`</span>,
                    <span class="hljs-attr">uri</span>: musicUri,
                    artist,
                    title,
                    <span class="hljs-attr">duration</span>: duration,
                    durationString,
                    <span class="hljs-attr">modificationTime</span>: modificationTime ?? time,
                    coverUrl,
                    <span class="hljs-attr">isCollection</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-attr">isPrivate</span>: <span class="hljs-number">1</span>,
                    <span class="hljs-attr">creationTime</span>: creationTime ?? time,
                    album,
                    <span class="hljs-attr">lyrics</span>: <span class="hljs-string">''</span>,
                };
                <span class="hljs-keyword">const</span> bool = <span class="hljs-keyword">await</span> <span class="hljs-title function_">addSong</span>(obj, <span class="hljs-variable constant_">SQLITE_CONVERTED_TABLE_NAME</span>);
                <span class="hljs-keyword">if</span> (bool) {
                    convertVideoRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
                    isSuccessRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
                    <span class="hljs-keyword">const</span> cacheInputFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(cachedInputUriRef.<span class="hljs-property">current</span>!);
                    <span class="hljs-keyword">if</span> (cacheInputFile.<span class="hljs-property">exists</span>) {
                        cacheInputFile.<span class="hljs-title function_">delete</span>();
                        cachedInputUriRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
                    }
                    <span class="hljs-comment">/**删除转换后的缓存音频文件 */</span>
                    file.<span class="hljs-title function_">delete</span>();
                    <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'音频文件已成功保存'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'success'</span> });
                };
            };
        } <span class="hljs-keyword">catch</span> (copyError) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'无法保存音频文件到应用文件夹'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
        }
    }
    <span class="hljs-comment">/**
     * 异步处理视频转音频的核心逻辑函数。
     * 
     * 主要功能包括：
     * 1. 检查并创建用于 FFmpeg 的本地工作目录；
     * 2. 将选中的视频文件复制到缓存目录以确保访问权限；
     * 3. 使用 FFmpeg 提取音频流并进行格式转换；
     * 4. 在转换过程中更新进度条；
     * 5. 完成后将结果保存至应用私有目录，并提示用户；
     * 6. 包含详细的错误处理与取消机制支持。
     *
     * <span class="hljs-doctag">@param</span> <span class="hljs-variable">video</span> - 视频资源对象，必须包含 uri 和其他必要元数据（如 duration、filename 等）。
     * <span class="hljs-doctag">@returns</span> 无返回值。副作用包括 UI 更新、文件操作及可能的弹窗提示。
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleConvertVideo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">video: VideoAsset</span>) =&gt; {
        <span class="hljs-comment">/**
         * 检查当前是否有选中的视频文件，没有则提示用户选择视频文件
         */</span>
        <span class="hljs-keyword">if</span> (!video) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'请选择视频文件'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span> });
            <span class="hljs-keyword">return</span>;
        };
        <span class="hljs-comment">/**保存视频资源对象 */</span>
        convertVideoRef.<span class="hljs-property">current</span> = video;
        <span class="hljs-comment">/**
         * 先检查源文件是否存在，源文件不存在停止执行
         * 后续会检查缓存文件是否存在，
         * 如果存在就不缓存，直接使用缓存文件
         */</span>
        <span class="hljs-keyword">const</span> sourceFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(video.<span class="hljs-property">uri</span>);
        <span class="hljs-keyword">if</span> (!sourceFile.<span class="hljs-property">exists</span>) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'视频文件不存在'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">const</span> { <span class="hljs-variable language_">document</span>, cache } = <span class="hljs-title class_">Paths</span>;
        <span class="hljs-comment">/**
         *  存储转换后的音频文件用的FFmpeg 的本地工作目录
         */</span>
        <span class="hljs-keyword">let</span> <span class="hljs-attr">ffmpegFolder</span>: <span class="hljs-title class_">Directory</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
        <span class="hljs-comment">/**
         * 检测目录是否存在，不存在则创建
         */</span>
        <span class="hljs-keyword">try</span> {

            <span class="hljs-comment">/**
             * 新版expo-file-system 检测文件是否是文件夹使用
             * Paths.info(uri)静态方法方法可以检测文件是否是文件夹
             * 返回对象{exists: boolean, isDirectory: boolean}
             * 或者直接使用new Dictory(ffmpegDir)返回对象，目录是否存在，不存在调用返回值create方法创建
             * 如果路径中包含中文文字必须使用encodeURI进行编码,否则报错
             * 使用encodeURI可以完整路径转码，使用encodeURIComponent
             * 可能转换过多导致路径报错，主要是路径中的中文名部分要转换
             * 第二个参数文件夹名前后写不写/都可以
             */</span>

            ffmpegFolder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Directory</span>(<span class="hljs-title class_">Paths</span>.<span class="hljs-property">document</span>, <span class="hljs-variable constant_">MUSIC_FILE_FILE_NAME</span>);
            <span class="hljs-keyword">if</span> (!ffmpegFolder.<span class="hljs-property">exists</span>) {
                <span class="hljs-keyword">let</span> <span class="hljs-attr">obj</span>: <span class="hljs-title class_">DirectoryCreateOptions</span> = { <span class="hljs-attr">intermediates</span>: <span class="hljs-literal">true</span> };
                <span class="hljs-comment">/**
                 * 创建目录
                 */</span>
                ffmpegFolder.<span class="hljs-title function_">create</span>(obj)
            };
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'无法创建存储文件夹'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
            <span class="hljs-keyword">return</span>;
        };
        <span class="hljs-comment">/**
         * 开始转换视频为音频
         * 1. 复制视频到缓存目录
         * 2. 构建FFmpeg命令
         * 3. 执行转换
         * 4. 清理临时文件
         * 设置开始转换状态为true，重置进度值为0，并设置取消标志为false
         */</span>
        <span class="hljs-title function_">setIsConverting</span>(<span class="hljs-literal">true</span>);
        <span class="hljs-title function_">setProgress</span>(<span class="hljs-number">0</span>);
        cancelledRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> { filename } = video;
            <span class="hljs-keyword">const</span> baseName = filename ? filename.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.[^/.]+$/</span>, <span class="hljs-string">''</span>) : <span class="hljs-string">`video_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
            <span class="hljs-comment">/**先将目标文件复制到缓存目录中 */</span>
            <span class="hljs-keyword">const</span> cacheDir = cache.<span class="hljs-property">uri</span> ?? <span class="hljs-variable language_">document</span>.<span class="hljs-property">uri</span> ?? <span class="hljs-string">'/'</span>;
            <span class="hljs-comment">//方式1: 手动拼接文件要保存到缓存目录路径</span>
            <span class="hljs-keyword">const</span> cachedInputUri = <span class="hljs-string">`<span class="hljs-subst">${cacheDir}</span><span class="hljs-subst">${filename ?? baseName}</span>`</span>;
            cachedInputUriRef.<span class="hljs-property">current</span> = cachedInputUri;
            <span class="hljs-comment">// 方式2: 使用File构造函数链式创建目标文件</span>
            <span class="hljs-comment">// const cachedInputUri = new File(Paths.cache, filename ?? baseName).uri;</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">/**
                 * 创建缓存目标文件对象检查是否存在
                 * 如果缓存文件存在，直接使用缓存文件,不存在则缓存视频文件
                 */</span>
                <span class="hljs-keyword">const</span> targetFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(cachedInputUri);
                <span class="hljs-keyword">if</span> (!targetFile.<span class="hljs-property">exists</span>) {
                    sourceFile.<span class="hljs-title function_">copy</span>(targetFile);
                };
            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'复制视频到缓存目录失败'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
            };

            <span class="hljs-comment">// 添加时间戳到文件名，避免文件名冲突</span>
            <span class="hljs-keyword">const</span> timestamp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[:.]/g</span>, <span class="hljs-string">'-'</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">19</span>);
            <span class="hljs-comment">/**
             * 输出文件名，不带extension，
             * 因为要生成图片时使用名称作为文件名，所以不能带扩展名
             * cachedOutputUri: 缓存输出文件路径
             * finalOutputUri: 最终输出文件路径
             */</span>
            <span class="hljs-keyword">const</span> outputFileName = <span class="hljs-string">`<span class="hljs-subst">${baseName}</span>_<span class="hljs-subst">${timestamp}</span>`</span>;
            <span class="hljs-keyword">const</span> cachedOutputUri = <span class="hljs-string">`<span class="hljs-subst">${cacheDir}</span><span class="hljs-subst">${outputFileName}</span>.m4a`</span>;
            <span class="hljs-keyword">const</span> finalOutputUri = <span class="hljs-string">`<span class="hljs-subst">${ffmpegFolder.uri}</span><span class="hljs-subst">${outputFileName}</span>.m4a`</span>;
            outFileNameRef.<span class="hljs-property">current</span> = outputFileName;
            <span class="hljs-comment">// 保存临时文件路径用于清理</span>
            cachedOutputUriRef.<span class="hljs-property">current</span> = cachedOutputUri;
            lastOutputUriRef.<span class="hljs-property">current</span> = finalOutputUri;
            <span class="hljs-comment">/**
             * 创建进出路径，用于command命令拼接
             */</span>
            <span class="hljs-keyword">const</span> nativeInputPath = cachedInputUri.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'file://'</span>) ? cachedInputUri.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'file://'</span>, <span class="hljs-string">''</span>) : cachedInputUri;
            <span class="hljs-keyword">const</span> nativeOutputPath = cachedOutputUri.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'file://'</span>) ? cachedOutputUri.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'file://'</span>, <span class="hljs-string">''</span>) : cachedOutputUri;
            <span class="hljs-comment">/** 
             * 构建命令 暂不支持mp3，暂时使用m4a
             * 
             */</span>
            <span class="hljs-keyword">const</span> command = <span class="hljs-string">`-i "<span class="hljs-subst">${nativeInputPath}</span>" -vn -c:a aac -b:a 192k "<span class="hljs-subst">${nativeOutputPath}</span>"`</span>;
            <span class="hljs-comment">/**
             * 转换完成回调函数
             * 1.获取转换码
             * 2.检查转换是否成功
             * 3.如果成功，检查是否取消，取消不保存文件
             * 4.如果未取消，保存输出文件
             * 5.清理临时文件
             * 6.创建视频缩略图保存到cover目录中
             * 7.将歌曲信息和图片信息写入SQlite数据库表
             * <span class="hljs-doctag">@param</span> session FFmpegSession
             * <span class="hljs-doctag">@returns</span> 
             */</span>
            <span class="hljs-keyword">const</span> <span class="hljs-attr">completeCallback</span>: <span class="hljs-title class_">FFmpegSessionCompleteCallback</span> = <span class="hljs-keyword">async</span> (<span class="hljs-attr">session</span>: <span class="hljs-title class_">FFmpegSession</span>) =&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 获取转换码</span>
                    <span class="hljs-keyword">const</span> returnCode = <span class="hljs-keyword">await</span> session.<span class="hljs-title function_">getReturnCode</span>();
                    <span class="hljs-comment">/**
                     * 检查是否成功
                     * 方法1：调用ReturnCode的成员方法isValueSuccess返回布尔值
                     * 方法2：调用ReturnCode的静态方法isSuccess传递ReturnCode对象实例然后返回
                     * 布尔值
                     * 成员方法getCode 返回ReturnCode对象实例的code属性值，0 是success 255 是cancel
                     */</span>
                    <span class="hljs-comment">/**方式1 调用成员方法检测 */</span>
                    <span class="hljs-keyword">const</span> success = returnCode.<span class="hljs-title function_">isValueSuccess</span>();
                    <span class="hljs-comment">/**方式2 调用成员方法getValue获取执行值，再调用静态方法isSuccess 检查是否成功 */</span>
                    <span class="hljs-comment">// success = ReturnCode.isSuccess(returnCode);</span>
                    <span class="hljs-keyword">if</span> (success) {
                        <span class="hljs-comment">// 如果转换已取消，则跳过保存</span>
                        <span class="hljs-keyword">if</span> (cancelledRef.<span class="hljs-property">current</span>) {
                            <span class="hljs-comment">// 即使取消也要清理临时文件</span>
                            <span class="hljs-keyword">try</span> {
                                <span class="hljs-keyword">if</span> (cachedInputUri) {
                                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(cachedInputUri).<span class="hljs-title function_">delete</span>();
                                }
                            } <span class="hljs-keyword">catch</span> (error) {
                                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'清理输入缓存文件失败'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                            }
                            <span class="hljs-keyword">return</span>;
                        };
                        <span class="hljs-comment">// 检查输出文件是否存在且非空</span>
                        <span class="hljs-keyword">try</span> {
                            <span class="hljs-keyword">const</span> { exists } = <span class="hljs-title class_">Paths</span>.<span class="hljs-title function_">info</span>(cachedOutputUriRef.<span class="hljs-property">current</span>!);
                            <span class="hljs-keyword">if</span> (!exists) {
                                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'生成的音频文件为空或不存在'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                                <span class="hljs-keyword">return</span>;
                            };
                        } <span class="hljs-keyword">catch</span> (error) {
                            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'无法验证输出文件'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                            <span class="hljs-keyword">return</span>;
                        };
                        isSuccessRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">/**
                         * 转换失败后获取状态码解释原因
                         */</span>
                        <span class="hljs-keyword">const</span> returnCodeValue = returnCode.<span class="hljs-title function_">getValue</span>();
                        <span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>&gt; = {
                            <span class="hljs-number">255</span>: <span class="hljs-string">'转换已取消'</span>,
                            <span class="hljs-number">1</span>: <span class="hljs-string">'输入文件不存在或无法读取'</span>,
                            <span class="hljs-number">2</span>: <span class="hljs-string">'输出路径无效或无写入权限'</span>,
                        }
                        <span class="hljs-keyword">let</span> errorMessage = config[returnCodeValue] ?? <span class="hljs-string">`转换失败 (错误码: <span class="hljs-subst">${returnCodeValue}</span>)`</span>;
                        <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: errorMessage, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                    }
                } <span class="hljs-keyword">catch</span> (e) {
                    <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'转换过程中发生错误'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                } <span class="hljs-keyword">finally</span> {
                    cancelledRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
                    <span class="hljs-title function_">setIsConverting</span>(<span class="hljs-literal">false</span>);
                    <span class="hljs-title function_">setProgress</span>(<span class="hljs-number">0</span>);
                    <span class="hljs-keyword">if</span> (isSuccessRef.<span class="hljs-property">current</span>) {
                        <span class="hljs-title function_">setVisible</span>(<span class="hljs-literal">true</span>);
                    }
                }
            };
            <span class="hljs-comment">/**
             * 转换过程中日志处理,更新转换进度
             * 使用生产环境友好的日志回调
             * <span class="hljs-doctag">@param</span> log Log 日志对象
             */</span>
            <span class="hljs-comment">// 为了兼容现有的日志解析逻辑，保留原有的进度计算</span>
            <span class="hljs-keyword">const</span> <span class="hljs-attr">legacyLogCallback</span>: <span class="hljs-title class_">LogCallback</span> = <span class="hljs-function">(<span class="hljs-params">log: Log</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> message = log.<span class="hljs-title function_">getMessage</span>();
                <span class="hljs-keyword">if</span> (message.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'time='</span>)) {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-keyword">const</span> timeMatch = message.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/time=(\d+):(\d+):(\d+\.\d+)/</span>);
                        <span class="hljs-keyword">if</span> (timeMatch) {
                            <span class="hljs-keyword">const</span> hours = <span class="hljs-built_in">parseFloat</span>(timeMatch[<span class="hljs-number">1</span>]);
                            <span class="hljs-keyword">const</span> minutes = <span class="hljs-built_in">parseFloat</span>(timeMatch[<span class="hljs-number">2</span>]);
                            <span class="hljs-keyword">const</span> seconds = <span class="hljs-built_in">parseFloat</span>(timeMatch[<span class="hljs-number">3</span>]);
                            <span class="hljs-keyword">const</span> currentTimeInSeconds = hours * <span class="hljs-number">3600</span> + minutes * <span class="hljs-number">60</span> + seconds;
                            <span class="hljs-keyword">const</span> totalTimeInSeconds = (video &amp;&amp; (video.<span class="hljs-property">duration</span> ?? <span class="hljs-number">0</span>)) || <span class="hljs-number">120</span>;
                            <span class="hljs-keyword">const</span> calculatedProgress = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">100</span>, (currentTimeInSeconds / totalTimeInSeconds) * <span class="hljs-number">100</span>);
                            <span class="hljs-title function_">setProgress</span>(calculatedProgress);
                        }
                    } <span class="hljs-keyword">catch</span> (error) {
                        <span class="hljs-keyword">if</span> (__DEV__) {
                            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'进度解析失败'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                        }
                    }
                }
            };
            <span class="hljs-comment">/** 开始转换 */</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">/**
                 * 存在如下方法
                 * FFmpegKit.execute(cmd): Promise&lt;FFmpegSession&gt;
                 * executeAsync(command: string, completeCallback?: FFmpegSessionCompleteCallback, logCallback?: LogCallback, statisticsCallback?: StatisticsCallback): Promise&lt;FFmpegSession&gt;
                 */</span>
                conversionSessionRef.<span class="hljs-property">current</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">FFmpegKit</span>.<span class="hljs-title function_">executeAsync</span>(command, completeCallback, legacyLogCallback);
            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'转换过程中发生错误'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
            }
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'转换过程中发生错误'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-title function_">setProgress</span>(<span class="hljs-number">0</span>);
        }
    };
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleConvertManage</span> = (<span class="hljs-params"/>) =&gt; {
        router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/ConvertManage'</span>);
    };
    <span class="hljs-comment">/**
     * 取消转换
     * <span class="hljs-doctag">@returns</span> Promise&lt;void&gt;
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCancel</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// 修改标记</span>
        cancelledRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (!conversionSessionRef.<span class="hljs-property">current</span>) {
            <span class="hljs-title function_">setIsConverting</span>(<span class="hljs-literal">false</span>);
            <span class="hljs-title function_">setProgress</span>(<span class="hljs-number">0</span>);
            <span class="hljs-keyword">return</span>;
        };

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">/**
             * 优先尝试 session.cancel()
             */</span>
            <span class="hljs-keyword">await</span> conversionSessionRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">cancel</span>();
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-comment">/**
             * 调用cancel方法失败，尝试通过 sessionId 使用 FFmpegKit.cancel
             */</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> sessionId = conversionSessionRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">getSessionId</span>();
                <span class="hljs-keyword">await</span> <span class="hljs-title class_">FFmpegKit</span>.<span class="hljs-title function_">cancel</span>(sessionId)
                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'已取消转换'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'success'</span> });
            } <span class="hljs-keyword">catch</span> (err) {
                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'取消转换失败'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
            }
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 清理状态</span>
            conversionSessionRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
            <span class="hljs-title function_">setIsConverting</span>(<span class="hljs-literal">false</span>);
            <span class="hljs-title function_">setProgress</span>(<span class="hljs-number">0</span>);
            <span class="hljs-comment">// 删除临时输出文件，避免残留</span>
            <span class="hljs-keyword">if</span> (cachedOutputUriRef.<span class="hljs-property">current</span>) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">const</span> file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(cachedOutputUriRef.<span class="hljs-property">current</span>);
                    <span class="hljs-keyword">if</span> (file.<span class="hljs-property">exists</span>) {
                        file.<span class="hljs-title function_">delete</span>();
                    }
                } <span class="hljs-keyword">catch</span> (delErr) {
                    <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'删除临时输出文件失败'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                }
                cachedOutputUriRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">if</span> (lastOutputUriRef.<span class="hljs-property">current</span>) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">const</span> file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(lastOutputUriRef.<span class="hljs-property">current</span>);
                    <span class="hljs-keyword">if</span> (file.<span class="hljs-property">exists</span>) {
                        file.<span class="hljs-title function_">delete</span>();
                    }
                } <span class="hljs-keyword">catch</span> (delErr) {
                    <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'删除临时输出文件失败'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
                }
                lastOutputUriRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
            }
        }
    };
    <span class="hljs-comment">/**
     * 确定修改信息
     * <span class="hljs-doctag">@param</span> info 
     * <span class="hljs-doctag">@returns</span> Promise&lt;void&gt;
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleConfirm</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">info?: UpdateSongInfoConfig | <span class="hljs-built_in">boolean</span></span>) =&gt; {
        <span class="hljs-keyword">if</span> (!convertVideoRef.<span class="hljs-property">current</span> || <span class="hljs-keyword">typeof</span> info === <span class="hljs-string">'boolean'</span>) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">saveConvertFile</span>(info)
            <span class="hljs-title function_">setVisible</span>(<span class="hljs-literal">false</span>);
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'更新文件信息失败，请检查文件权限'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
        }
    };
    <span class="hljs-comment">/**
     * 取消修改 按默认名称保存
     * <span class="hljs-doctag">@returns</span> Promise&lt;void&gt;
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCancelModify</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">saveConvertFile</span>();
    };
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemedView</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.container,</span> { <span class="hljs-attr">paddingTop:</span> <span class="hljs-attr">top</span>, <span class="hljs-attr">paddingBottom:</span> <span class="hljs-attr">bottom</span> + <span class="hljs-attr">10</span> }]}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">TitleBar</span>
                <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.top}</span>
                <span class="hljs-attr">leftComponent</span>=<span class="hljs-string">{</span>
                    &lt;<span class="hljs-attr">Pressable</span>
                        <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handleBack}</span>
                        <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.topLeft}</span>
                    &gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Ionicons</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"chevron-back"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">{22}</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"#fff"</span> /&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">ThemedText</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.title}</span>&gt;</span>视频转歌<span class="hljs-tag">&lt;/<span class="hljs-name">ThemedText</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">Pressable</span>&gt;</span>
                }
                rightComponent={
                    <span class="hljs-tag">&lt;<span class="hljs-name">ThemedText</span>
                        <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.title}</span>
                        <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handleConvertManage}</span>
                    &gt;</span>
                        转换管理
                    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemedText</span>&gt;</span>
                }
            /&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">VideoList</span>
                <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handleConvertVideo}</span>
            /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Modal</span>
                <span class="hljs-attr">visible</span>=<span class="hljs-string">{isConverting}</span>
                <span class="hljs-attr">transparent</span>
                <span class="hljs-attr">animationType</span>=<span class="hljs-string">"fade"</span>
            &gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.modalContainer}</span>&gt;</span>
                    &lt; ProcessTip
                        progress={progress}
                        handleCancel={handleCancel}
                    /&gt;
                <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Modal</span>&gt;</span></span>
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UpdateOrDeleteModal</span>
                <span class="hljs-attr">visible</span>=<span class="hljs-string">{visible}</span>
                <span class="hljs-attr">needDeleteFile</span>=<span class="hljs-string">{false}</span>
                <span class="hljs-attr">setVisible</span>=<span class="hljs-string">{()</span> =&gt;</span> setVisible(false)}
                onConfirm={handleConfirm}
                onCancel={handleCancelModify}
                modalType='rename'
                audio={convertVideoRef.current as VideoAsset}
                fileName={outFileNameRef.current as string}
            /&gt;</span>
        &lt;/<span class="hljs-title class_">ThemedView</span>&gt;
    );
};

<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">container</span>: {
        <span class="hljs-attr">flex</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
    },
    <span class="hljs-attr">top</span>: {
        <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>,
    },
    <span class="hljs-attr">title</span>: {
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">15</span>,
        <span class="hljs-attr">textAlign</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">fontWeight</span>: <span class="hljs-string">'bold'</span>,
    },
    <span class="hljs-attr">topLeft</span>: {
        <span class="hljs-attr">flexDirection</span>: <span class="hljs-string">'row'</span>,
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
    },
    <span class="hljs-attr">modalContainer</span>: {
        <span class="hljs-attr">flex</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
    },
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">FfmpegKitPage</span>;
</code></pre>
<p><strong>小结</strong></p>
<p>开始咱们说流程很清晰，关键在于获取要转换的文件转换文件和保存文件以及后续的修改，具体的细节其实还是比较多 的，但是代码没有什么高深的特技，就像这篇文件一样，平铺直叙。如果说有困难应该在FFmpegKit依赖库的文档方面，因为这个依赖库好像已经没人维护了，有些API我是看的node_modules里的TS类型定义和AI辅助编写的，刚开始即便借助AI也是囫囵吞枣，出现大量转换失败的情况，然后就是调试过程中产生大量缓存文件没有清理，后来打印输出缓存也是挺有美感</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f407f13af3624ed7a05e10244fddbf1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=zcYZHEzd4lPfaYK%2B9L%2F64XjjgcM%3D" alt="123.png" loading="lazy"/></p>
<p>文笔非常一般，但是也算干货满满，文笔不行图片来凑，而且今天我打包了APK安装到手机上，目前测很流畅，比开发构建版本的运行流畅，目前该应用只开发了android版本，ios没有设没有针对性处理调试，接下来再放一些其他模块图片，但是其他有技术难度的值得宣讲的不多，因为该应用没有配套后台，纯本地，就涉及到了数据存取问题，就是使用了Sqlite数据库，后面有时间考虑写一篇文章讲解项目中歌单存取处理，多个单切换设计，播放队列管理等，再放点图吧，上面细节不明白的有问题的欢迎留言探讨</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08e77e9191374c99839b3d0dfac5fbde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=j%2FjjbItUfnfBWhhf6RcQ%2FHRqrO0%3D" alt="微信图片_20260114172112_167_23.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/752e8189009f407a8f75f723612451fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=iADjmcL5rp%2BbUd%2BY%2FbKM7062w1I%3D" alt="微信图片_20260114172113_168_23.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/634a2db8924f4171ac851751d4fdcbe5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=lfc5Mcj%2FI%2FupulfRXCYvA0KlR24%3D" alt="微信图片_20260114172114_169_23.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bf101db37f7432e95c74879ef4f0744~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=TKEj6Si0VFZ82b8MuQmCBGIKTTk%3D" alt="微信图片_20260114172115_170_23.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8579af878f8f49da8908a9d597f5977b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990265&amp;x-signature=uy8ZrwPtbss35ebAL2D8XQf548M%3D" alt="微信图片_20260114172116_171_23.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端项目缓存控制与自动版本检查方案实现]]></title>    <link>https://juejin.cn/post/7595043440519479302</link>    <guid>https://juejin.cn/post/7595043440519479302</guid>    <pubDate>2026-01-14T10:18:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595043440519479302" data-draft-id="7595043440519446534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端项目缓存控制与自动版本检查方案实现"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-14T10:18:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TakeItEasy"/> <meta itemprop="url" content="https://juejin.cn/user/2181053384767518"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端项目缓存控制与自动版本检查方案实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2181053384767518/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TakeItEasy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T10:18:27.000Z" title="Wed Jan 14 2026 10:18:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前端项目缓存控制与自动版本检查方案实现</h2>
<p>在前端项目部署迭代过程中，浏览器缓存常常导致用户无法及时获取最新版本资源，出现页面错乱、功能异常等问题。本文将分享一套“全方位缓存控制 + 自动版本检查”的完整解决方案，通过 HTML 配置、Vite 构建优化、版本文件生成及定时检查机制，彻底解决缓存困扰，提升用户体验。</p>
<h3 data-id="heading-1">一、方案核心思路</h3>
<p>本方案从“主动禁止缓存”和“被动版本校验”两个维度保障资源新鲜度：</p>
<ol>
<li>通过 HTML 元标签和 Vite 构建配置，从源头控制浏览器缓存策略；</li>
<li>构建时自动生成版本信息文件，前端项目启动后定时检查版本差异；</li>
<li>检测到新版本时主动提示用户更新，确保用户使用最新功能。</li>
</ol>
<h3 data-id="heading-2">二、第一步：全方位缓存控制配置</h3>
<p>缓存控制需兼顾页面本身和静态资源（JS、CSS、图片等），需分别在 HTML 页面和 Vite 配置中进行设置。</p>
<h4 data-id="heading-3">2.1 HTML 页面级缓存控制</h4>
<p>在 index.html 的 head 标签中添加缓存控制元标签，告知浏览器不缓存当前页面，同时强制验证后续资源有效性。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"pragma"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"no-cache"</span>&amp;<span class="hljs-attr">gt</span>; &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">禁止浏览器缓存</span> <span class="hljs-attr">--</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"Cache-Control"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"no-cache, must-revalidate"</span>&amp;<span class="hljs-attr">gt</span>; &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">禁止浏览器缓存</span> <span class="hljs-attr">--</span>&gt;</span>
  <span class="hljs-symbol">&amp;lt;</span>meta http-equiv="expires" content="0"<span class="hljs-symbol">&amp;gt;</span> <span class="hljs-comment">&lt;!-- 禁止浏览器缓存 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>页面标题<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 页面内容 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>说明：HTML 元标签仅对当前页面生效，无法控制页面引入的静态资源缓存，需配合 Vite 构建配置实现全链路缓存控制。</p>
<h4 data-id="heading-4">2.2 Vite 构建级缓存优化</h4>
<p>通过 Vite 配置实现两点核心优化：一是为静态资源添加哈希命名（内容变更时哈希自动更新），二是为开发/生产环境的资源响应头设置缓存禁止策略。</p>
<pre><code class="hljs language-php" lang="php">import { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
import { generateVersionFile } <span class="hljs-keyword">from</span> <span class="hljs-string">"./scripts/generateVersionFile"</span>; 

<span class="hljs-comment">// 引入版本文件生成插件</span>
<span class="hljs-title function_ invoke__">generateVersionFile</span>()

export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  // 构建配置：通过文件名哈希和资源响应头强化缓存控制
  <span class="hljs-attr">build</span>: {
    // 为静态资源文件名添加哈希值，避免资源缓存（文件内容变化时哈希值改变，触发重新加载）
    <span class="hljs-attr">assetsDir</span>: <span class="hljs-string">'assets'</span>,
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">output</span>: {
        // 配置静态资源（JS、CSS、图片等）的文件名格式：[name]-[hash].[ext]
        <span class="hljs-attr">assetFileNames</span>: <span class="hljs-string">'[name]-[hash].[ext]'</span>,
        <span class="hljs-attr">chunkFileNames</span>: <span class="hljs-string">'chunks/[name]-[hash].js'</span>,
        <span class="hljs-attr">entryFileNames</span>: <span class="hljs-string">'entry/[name]-[hash].js'</span>,
      },
    },
  },
  // 开发服务器配置（本地开发时的缓存控制）
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">headers</span>: {
      // 禁止服务器返回的资源被缓存
      <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'no-cache, no-store, must-revalidate'</span>,
      <span class="hljs-string">'Pragma'</span>: <span class="hljs-string">'no-cache'</span>,
      <span class="hljs-string">'Expires'</span>: <span class="hljs-string">'0'</span>,
    },
  },
  // 生产环境静态资源服务配置（若使用 Vite 预览生产包）
  <span class="hljs-attr">preview</span>: {
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'no-cache, no-store, must-revalidate'</span>,
      <span class="hljs-string">'Pragma'</span>: <span class="hljs-string">'no-cache'</span>,
      <span class="hljs-string">'Expires'</span>: <span class="hljs-string">'0'</span>,
    },
  },
});
</code></pre>
<p>关键说明：静态资源的哈希命名是核心，当文件内容发生变更时，构建后的文件名会随之改变，浏览器会将其识别为新资源并重新请求，从根本上解决静态资源缓存问题。</p>
<h3 data-id="heading-5">三、第二步：自动版本检查机制实现</h3>
<p>通过编写脚本生成版本信息文件，并在前端项目中实现定时版本检查逻辑，当检测到新版本时提示用户刷新页面更新资源。</p>
<h4 data-id="heading-6">3.1 版本信息生成脚本</h4>
<p>编写两个核心脚本：generateVersionInfo.ts（生成版本信息）和 generateVersionFile.ts（Vite 插件，打包时生成版本文件）。</p>
<h5 data-id="heading-7">3.1.1 生成版本信息（generateVersionInfo.ts）</h5>
<p>从 package.json 中读取项目版本号，结合构建时间生成版本信息对象。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { readFileSync } <span class="hljs-keyword">from</span> <span class="hljs-string">"fs"</span>;
<span class="hljs-keyword">import</span> { resolve } <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">import</span> { cwd } <span class="hljs-keyword">from</span> <span class="hljs-string">"process"</span>;

<span class="hljs-comment">/**
 * 生成版本信息
 * <span class="hljs-doctag">@returns</span> 版本信息对象，包含 version、buildTime、timestamp，失败时返回 null
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateVersionInfo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 读取 package.json 获取版本号（从项目根目录）</span>
    <span class="hljs-keyword">const</span> packageJsonPath = <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">"package.json"</span>);
    <span class="hljs-keyword">const</span> packageJson = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title function_">readFileSync</span>(packageJsonPath, <span class="hljs-string">"utf-8"</span>));
    <span class="hljs-keyword">const</span> version = packageJson.<span class="hljs-property">version</span> || <span class="hljs-string">"1.0.0"</span>;
    <span class="hljs-keyword">const</span> buildTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">replace</span>(<span class="hljs-string">"T"</span>, <span class="hljs-string">" "</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">19</span>);

    <span class="hljs-comment">// 生成版本信息对象</span>
    <span class="hljs-keyword">return</span> {
      version,
      buildTime,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    };
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"❌ 读取版本信息失败:"</span>, error);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h5 data-id="heading-8">3.1.2 生成版本文件（generateVersionFile.ts）</h5>
<p>实现 Vite 插件，在打包结束时将版本信息写入 dist 目录的 version.json 文件，供前端项目请求校验。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { writeFileSync } <span class="hljs-keyword">from</span> <span class="hljs-string">"fs"</span>;
<span class="hljs-keyword">import</span> { resolve } <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">import</span> { cwd } <span class="hljs-keyword">from</span> <span class="hljs-string">"process"</span>;
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"vite"</span>;
<span class="hljs-keyword">import</span> { generateVersionInfo } <span class="hljs-keyword">from</span> <span class="hljs-string">"./generateVersionInfo"</span>;

<span class="hljs-comment">/**
 * 生成版本号文件的 Vite 插件
 * - 打包时在 dist 目录生成 version.json
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateVersionFile</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Plugin</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"generate-version-file"</span>,
    <span class="hljs-comment">// 打包时生成版本文件到 dist 目录</span>
    <span class="hljs-title function_">closeBundle</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> versionInfo = <span class="hljs-title function_">generateVersionInfo</span>();
        <span class="hljs-keyword">if</span> (versionInfo) {
          <span class="hljs-keyword">const</span> versionJson = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(versionInfo, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>);

          <span class="hljs-comment">// 写入版本号文件到 dist 目录（打包后的根目录）</span>
          <span class="hljs-keyword">const</span> distPath = <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">"dist/version.json"</span>);
          <span class="hljs-title function_">writeFileSync</span>(distPath, versionJson, <span class="hljs-string">"utf-8"</span>);
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ 版本号文件已生成，版本号: <span class="hljs-subst">${versionInfo.version}</span>，构建时间: <span class="hljs-subst">${versionInfo.buildTime}</span>`</span>);
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"❌ 生成版本号文件失败:"</span>, error);
      }
    }
  };
}
</code></pre>
<h4 data-id="heading-9">3.2 前端版本检查逻辑（App.vue）</h4>
<p>在 Vue 根组件中实现版本检查核心逻辑：页面挂载后立即检查版本，之后每隔 24 小时定时检查，检测到新版本时通过弹窗提示用户更新。</p>
<h5 data-id="heading-10">3.2.1 代码核心逻辑拆解</h5>
<p>App.vue 中的版本检查代码可分为「核心配置定义」「核心功能函数」「生命周期钩子绑定」三个核心部分，各部分职责清晰、耦合度低，便于维护和扩展：</p>
<h6 data-id="heading-11">1. 核心配置常量定义</h6>
<p>定义版本检查相关的固定配置，集中管理关键参数，后续需调整时可直接修改此处，无需改动核心逻辑：</p>
<ul>
<li><code>VERSION_STORAGE_KEY</code>：本地存储版本号的键名，用于将当前版本号持久化到 localStorage，避免页面刷新后丢失版本信息；</li>
<li><code>VERSION_CHECK_INTERVAL</code>：版本检查时间间隔，此处设置为 24 小时（单位：毫秒），可根据项目迭代频率灵活调整；</li>
<li><code>versionCheckTimer</code>：定时检查计时器的引用，用于在组件卸载时清理计时器，避免内存泄漏。</li>
</ul>
<h6 data-id="heading-12">2. 核心功能函数实现</h6>
<p>包含 3 个核心函数，分别负责版本检查、启动检查流程、清理检查资源，单一函数只做单一职责：</p>
<ul>
<li><code>checkVersionUpdate</code>（核心版本检查函数）： - 环境判断：开发环境直接跳过检查，避免开发过程中频繁触发版本校验； - 路径适配：动态构建 version.json 的请求路径，适配不同部署目录（如根目录、子目录部署），提升通用性； - 缓存禁用：请求版本文件时通过 headers 和 cache 配置禁用缓存，确保获取的是最新版本文件； - 异常处理：对网络错误、文件不存在、数据格式错误等场景做静默处理，不阻塞应用正常运行； - 版本对比：从 localStorage 读取历史版本号，与最新版本号对比，首次访问时直接保存版本号，检测到新版本时提示用户更新并刷新页面。</li>
<li><code>startVersionCheck</code>（启动版本检查函数）： - 立即执行一次版本检查，确保用户进入页面后能第一时间获取版本状态； - 启动定时检查计时器，按照设定的时间间隔重复执行版本检查。</li>
<li><code>stopVersionCheck</code>（停止版本检查函数）： - 清理定时检查计时器，避免组件卸载后计时器仍在运行导致内存泄漏，符合 Vue 组件的资源管理规范。</li>
</ul>
<h6 data-id="heading-13">3. 生命周期钩子绑定</h6>
<p>结合 Vue 组件生命周期，实现版本检查流程的自动启动和资源清理：</p>
<ul>
<li><code>onMounted</code>：组件挂载完成后调用 <code>startVersionCheck</code>，启动版本检查流程，确保组件渲染完成后再执行异步请求相关逻辑；</li>
<li><code>onBeforeUnmount</code>：组件卸载前调用 <code>stopVersionCheck</code>，清理计时器资源，避免内存泄漏。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, onMounted, onBeforeUnmount } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessageBox</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"element-plus"</span>;

<span class="hljs-comment">/** 版本检查相关配置 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">VERSION_STORAGE_KEY</span> = <span class="hljs-string">"app_version"</span>; <span class="hljs-comment">// 本地存储版本号的 key</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">VERSION_CHECK_INTERVAL</span> = <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>; <span class="hljs-comment">// 版本检查间隔（24小时）</span>
<span class="hljs-keyword">const</span> versionCheckTimer = ref&lt;<span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 定时检查计时器</span>

<span class="hljs-comment">/**
 * 检查版本更新
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkVersionUpdate</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 开发环境不进行版本检查</span>
    <span class="hljs-comment">// @ts-ignore - Vite 内置环境变量</span>
    <span class="hljs-keyword">const</span> isDev = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">MODE</span> === <span class="hljs-string">"development"</span>;
    <span class="hljs-keyword">if</span> (isDev) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 构建版本文件路径，适配不同部署目录（获取 index.html 所在目录）</span>
    <span class="hljs-keyword">const</span> currentPath = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span>;
    <span class="hljs-keyword">const</span> lastSlashIndex = currentPath.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">"/"</span>);
    <span class="hljs-keyword">const</span> directoryPath = lastSlashIndex &gt;= <span class="hljs-number">0</span> ? currentPath.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, lastSlashIndex + <span class="hljs-number">1</span>) : <span class="hljs-string">"/"</span>;
    <span class="hljs-keyword">const</span> versionUrl = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.location.origin}</span><span class="hljs-subst">${directoryPath}</span>version.json?t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;

    <span class="hljs-comment">// 请求版本文件（禁用缓存，确保获取最新版本）</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(versionUrl, {
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">"Cache-Control"</span>: <span class="hljs-string">"no-cache"</span>,
        <span class="hljs-title class_">Pragma</span>: <span class="hljs-string">"no-cache"</span>
      },
      <span class="hljs-attr">cache</span>: <span class="hljs-string">"no-store"</span>
    });

    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"版本文件不存在或网络错误，跳过版本检查"</span>, response.<span class="hljs-property">status</span>);
      <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> === <span class="hljs-number">404</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"版本文件不存在，跳过版本检查"</span>);
      }
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> versionData = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();

    <span class="hljs-comment">// 验证返回数据格式</span>
    <span class="hljs-keyword">if</span> (!versionData || !versionData.<span class="hljs-property">version</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"版本文件格式错误，跳过版本检查"</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> currentVersion = versionData.<span class="hljs-property">version</span>;
    <span class="hljs-keyword">const</span> storedVersion = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">VERSION_STORAGE_KEY</span>);

    <span class="hljs-comment">// 首次访问，保存版本号到本地存储</span>
    <span class="hljs-keyword">if</span> (!storedVersion) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"首次访问，保存版本号"</span>, currentVersion);
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">VERSION_STORAGE_KEY</span>, currentVersion);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 检测到新版本：更新本地版本号并提示用户</span>
    <span class="hljs-keyword">if</span> (currentVersion !== storedVersion) {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">VERSION_STORAGE_KEY</span>, currentVersion);
      <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(
        <span class="hljs-string">`检测到新版本（<span class="hljs-subst">${currentVersion}</span>），是否立即更新？`</span>, 
        <span class="hljs-string">"版本更新提示"</span>, 
        {
          <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">"立即更新"</span>,
          <span class="hljs-attr">cancelButtonText</span>: <span class="hljs-string">"稍后更新"</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">"info"</span>,
          <span class="hljs-attr">customClass</span>: <span class="hljs-string">"custom-el-message"</span>
        }
      ).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>(); <span class="hljs-comment">// 刷新页面加载最新资源</span>
      });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"当前版本与最新版本一致，跳过版本检查"</span>);
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 静默处理错误，不阻塞应用运行</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"版本检查失败："</span>, error);
  }
};

<span class="hljs-comment">/**
 * 启动版本检查（立即检查 + 定时检查）
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">startVersionCheck</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">checkVersionUpdate</span>(); <span class="hljs-comment">// 页面挂载后立即检查一次</span>
  <span class="hljs-comment">// 设置定时检查</span>
  versionCheckTimer.<span class="hljs-property">value</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">checkVersionUpdate</span>();
  }, <span class="hljs-variable constant_">VERSION_CHECK_INTERVAL</span>);
};

<span class="hljs-comment">/**
 * 清理版本检查定时器（组件卸载时）
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">stopVersionCheck</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (versionCheckTimer.<span class="hljs-property">value</span>) {
    <span class="hljs-built_in">clearInterval</span>(versionCheckTimer.<span class="hljs-property">value</span>);
    versionCheckTimer.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
  }
};

<span class="hljs-comment">// 组件生命周期钩子</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">startVersionCheck</span>();
});

<span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">stopVersionCheck</span>();
});
</code></pre>
<h3 data-id="heading-14">三、方案优势与注意事项</h3>
<h4 data-id="heading-15">3.1 核心优势</h4>
<ul>
<li>全链路缓存控制：覆盖页面、静态资源、接口请求三个层面，彻底杜绝缓存残留；</li>
<li>自动化程度高：版本文件自动生成，版本检查自动触发，无需人工干预；</li>
<li>用户体验友好：新版本静默检测，仅在有更新时提示，不干扰正常使用；</li>
<li>适配多环境：开发环境跳过检查，生产环境精准控制，兼顾开发与部署效率。</li>
</ul>
<h4 data-id="heading-16">3.2 注意事项</h4>
<ul>
<li>版本号管理：需在 package.json 中规范管理版本号（如遵循语义化版本），确保版本变更可追溯；</li>
<li>部署适配：version.json 文件需与 index.html 同级部署，确保前端能正确请求到；</li>
<li>错误兼容：版本检查逻辑添加了完善的错误捕获，避免因网络问题或文件缺失导致应用崩溃；</li>
<li>间隔配置：可根据项目迭代频率调整 VERSION_CHECK_INTERVAL（如迭代频繁可改为 12 小时）。</li>
</ul>
<h3 data-id="heading-17">四、总结</h3>
<p>本文提出的“缓存控制 + 版本检查”方案，通过 HTML 元标签、Vite 构建配置、版本文件生成脚本和前端定时检查逻辑的协同工作，完美解决了前端项目部署后的缓存问题。该方案实现简单、通用性强，可直接适配 Vue + Vite 技术栈的各类项目，也可稍作修改移植到其他前端框架中，为用户提供稳定、新鲜的应用体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coding指南]]></title>    <link>https://juejin.cn/post/7594832320030244907</link>    <guid>https://juejin.cn/post/7594832320030244907</guid>    <pubDate>2026-01-14T10:17:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594832320030244907" data-draft-id="7594854295759077419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coding指南"/> <meta itemprop="keywords" content="VibeCoding"/> <meta itemprop="datePublished" content="2026-01-14T10:17:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Gaaraa"/> <meta itemprop="url" content="https://juejin.cn/user/35624744391213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coding指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/35624744391213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Gaaraa
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T10:17:42.000Z" title="Wed Jan 14 2026 10:17:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vibe Coding 指南</h2>
<blockquote>
<p>与 AI 协作的现代编程范式</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">目录</h3>
<ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-vibe-coding" title="#%E4%BB%80%E4%B9%88%E6%98%AF-vibe-coding">什么是 Vibe Coding？</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E7%90%86%E5%BF%B5" title="#%E6%A0%B8%E5%BF%83%E7%90%86%E5%BF%B5">核心理念</a></li>
<li><a href="#%E5%AE%8C%E7%BE%8E%E6%8F%90%E7%A4%BA%E8%AF%8D%E7%9A%84%E5%85%AD%E5%A4%A7%E8%A6%81%E7%B4%A0" title="#%E5%AE%8C%E7%BE%8E%E6%8F%90%E7%A4%BA%E8%AF%8D%E7%9A%84%E5%85%AD%E5%A4%A7%E8%A6%81%E7%B4%A0">完美提示词的六大要素</a></li>
<li><a href="#%E9%AB%98%E7%BA%A7%E6%8A%80%E5%B7%A7" title="#%E9%AB%98%E7%BA%A7%E6%8A%80%E5%B7%A7">高级技巧</a></li>
<li><a href="#%E4%B8%89%E7%A7%8D%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F" title="#%E4%B8%89%E7%A7%8D%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F">三种工作模式</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1%E4%B8%8E%E9%81%BF%E5%9D%91%E6%8C%87%E5%8D%97" title="#%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1%E4%B8%8E%E9%81%BF%E5%9D%91%E6%8C%87%E5%8D%97">常见陷阱与避坑指南</a></li>
<li><a href="#%E9%BB%84%E9%87%91%E5%85%AC%E5%BC%8F" title="#%E9%BB%84%E9%87%91%E5%85%AC%E5%BC%8F">黄金公式</a></li>
<li><a href="#%E8%BF%9B%E9%98%B6%E5%BF%83%E6%B3%95" title="#%E8%BF%9B%E9%98%B6%E5%BF%83%E6%B3%95">进阶心法</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B" title="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B">实战案例</a></li>
<li><a href="#%E6%80%A7%E8%83%BD%E4%B8%8E%E6%88%90%E6%9C%AC%E4%BC%98%E5%8C%96" title="#%E6%80%A7%E8%83%BD%E4%B8%8E%E6%88%90%E6%9C%AC%E4%BC%98%E5%8C%96">性能与成本优化</a></li>
<li><a href="#%E9%99%84%E5%BD%95" title="#%E9%99%84%E5%BD%95">附录</a></li>
</ul>
<hr/>
<h3 data-id="heading-2">什么是 Vibe Coding？</h3>
<p><strong>Vibe Coding</strong> 是一种全新的编程范式，它改变了我们与代码交互的方式。</p>
<h4 data-id="heading-3">传统编程 vs Vibe Coding</h4>



































<table><thead><tr><th>维度</th><th>传统编程</th><th>Vibe Coding</th></tr></thead><tbody><tr><td><strong>工作方式</strong></td><td>手写每一行代码</td><td>描述意图，AI 生成代码</td></tr><tr><td><strong>关注点</strong></td><td>如何实现（How）</td><td>要实现什么（What）</td></tr><tr><td><strong>开发流程</strong></td><td>编码 → 调试 → 优化</td><td>描述 → 审查 → 迭代</td></tr><tr><td><strong>技能要求</strong></td><td>精通语法和 API</td><td>清晰表达 + 代码审查</td></tr><tr><td><strong>效率提升</strong></td><td>线性增长</td><td>指数级增长</td></tr></tbody></table>
<h4 data-id="heading-4">核心价值</h4>
<p><strong>Vibe Coding 不是让 AI 替你写代码，而是让 AI 成为你的编程伙伴</strong>：</p>
<ul>
<li><strong>你负责</strong>：架构设计、业务逻辑、质量把控</li>
<li><strong>AI 负责</strong>：代码生成、重复劳动、方案探索</li>
<li><strong>共同完成</strong>：快速迭代、持续优化、创造价值</li>
</ul>
<hr/>
<h3 data-id="heading-5">核心理念</h3>
<h4 data-id="heading-6">1. Think in Outcomes, Not Implementation</h4>
<p><strong>关注结果，而非实现细节</strong></p>
<pre><code class="hljs language-ini" lang="ini">❌ 传统思维：
"帮我写一个 for 循环，遍历 users 数组，判断 <span class="hljs-attr">status</span> === <span class="hljs-string">'active'</span>，
然后 push 到新数组，最后 map 提取 name 和 email"

✅ Vibe Coding 思维：
"从 users 中筛选出所有活跃用户，返回他们的姓名和邮箱"
</code></pre>
<p><strong>为什么这样更好？</strong></p>
<ul>
<li>AI 可能使用更优雅的 <code>filter</code> + <code>map</code> 组合</li>
<li>AI 可能考虑到性能优化（如使用 <code>reduce</code> 一次遍历）</li>
<li>AI 可能添加类型安全和错误处理</li>
</ul>
<h4 data-id="heading-7">2. Iterate, Don't Perfect</h4>
<p><strong>快速迭代，而非追求一次完美</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">第<span class="hljs-number">1</span>轮：实现基础功能（能用）
  <span class="hljs-string">"实现用户登录功能，支持手机号+验证码"</span>

第<span class="hljs-number">2</span>轮：优化用户体验（好用）
  <span class="hljs-string">"添加验证码倒计时、输入框自动聚焦、错误提示"</span>

第<span class="hljs-number">3</span>轮：性能优化（快用）
  <span class="hljs-string">"优化登录接口调用，添加请求缓存和防抖"</span>

第<span class="hljs-number">4</span>轮：完善细节（爱用）
  <span class="hljs-string">"添加登录动画、记住登录状态、支持生物识别"</span>
</code></pre>
<h4 data-id="heading-8">3. Context is King</h4>
<p><strong>上下文决定代码质量</strong></p>
<p>AI 需要了解你的"世界观"：</p>
<ul>
<li><strong>技术栈</strong>：Vue 3 + TypeScript + Pinia</li>
<li><strong>项目结构</strong>：页面、组件、API、Store 的组织方式</li>
<li><strong>编码规范</strong>：命名规则、代码风格、注释要求</li>
<li><strong>业务逻辑</strong>：用户角色、权限系统、业务流程</li>
</ul>
<p><strong>提供上下文的方式</strong>：</p>
<ul>
<li>使用 <code>@文件名</code> 引用相关文件</li>
<li>在 <code>.cursorrules</code> 中定义项目规范</li>
<li>在提示词中说明技术约束</li>
<li>提供参考示例或类似功能</li>
</ul>
<hr/>
<h3 data-id="heading-9">完美提示词的六大要素</h3>
<h4 data-id="heading-10">1. 明确的目标 (What)</h4>
<p><strong>说清楚要做什么</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">✅ 好的目标：
<span class="hljs-string">"实现用户登录功能，支持手机号+验证码和账号+密码两种方式"</span>

❌ 模糊的目标：
<span class="hljs-string">"做个登录"</span>
</code></pre>
<h4 data-id="heading-11">2. 清晰的上下文 (Where &amp; Why)</h4>
<p><strong>说明在哪里做，为什么做</strong></p>
<pre><code class="hljs language-perl" lang="perl">✅ 好的上下文：
<span class="hljs-string">"在 @src/pages/login/index.vue 中实现，
因为现有的登录只支持账号密码，
产品要求增加验证码登录方式以提升用户体验"</span>

❌ 缺少上下文：
<span class="hljs-string">"加个验证码登录"</span>
</code></pre>
<h4 data-id="heading-12">3. 技术约束 (How)</h4>
<p><strong>说明使用什么技术，如何实现</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">✅ 好的技术约束：
<span class="hljs-string">"使用 Vue 3 Composition API + TypeScript，
调用 POST /api/v1/auth/login 接口，
验证码倒计时 60 秒，使用 uni.request 发送请求"</span>

❌ 缺少技术约束：
<span class="hljs-string">"用 Vue 做"</span>
</code></pre>
<h4 data-id="heading-13">4. 边界条件 (Constraints)</h4>
<p><strong>说明不能做什么，有什么限制</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">✅ 好的边界条件：
<span class="hljs-string">"不要修改现有的账号密码登录逻辑，
验证码输入框只允许数字，
发送验证码前要校验手机号格式（11位数字），
同一手机号 60 秒内只能发送一次验证码"</span>

❌ 没有边界条件：
（任何约束都没有提）
</code></pre>
<h4 data-id="heading-14">5. 预期结果 (Success Criteria)</h4>
<p><strong>说明完成后应该是什么样子</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">✅ 好的预期结果：
"完成后应该能够：
<span class="hljs-bullet">1.</span> 输入手机号，点击发送验证码
<span class="hljs-bullet">2.</span> 60秒倒计时，期间按钮禁用显示剩余秒数
<span class="hljs-bullet">3.</span> 输入6位数字验证码
<span class="hljs-bullet">4.</span> 点击登录按钮，显示加载状态
<span class="hljs-bullet">5.</span> 登录成功后保存 token 并跳转到首页
<span class="hljs-bullet">6.</span> 登录失败显示错误提示"

❌ 没有验收标准：
（不知道怎么算完成）
</code></pre>
<h4 data-id="heading-15">6. 示例或参考 (Examples)</h4>
<p><strong>提供参考实现或设计稿</strong></p>
<pre><code class="hljs language-perl" lang="perl">✅ 好的参考：
<span class="hljs-string">"参考 @src/pages/login/password.vue 的样式和布局，
验证码输入框类似支付宝的 6 位数字输入（每位一个框），
整体风格保持与现有登录页一致"</span>

❌ 没有参考：
（AI 只能猜测你想要什么样式）
</code></pre>
<hr/>
<h3 data-id="heading-16">高级技巧</h3>
<h4 data-id="heading-17">技巧 1：分层提示（Layer Prompting）</h4>
<p><strong>不要一次性要求所有细节，而是分层递进</strong></p>
<h5 data-id="heading-18">第1层：架构层</h5>
<pre><code class="hljs language-diff" lang="diff">"设计一个用户认证系统，包含以下功能：
<span class="hljs-deletion">- 登录（手机号+验证码、账号+密码）</span>
<span class="hljs-deletion">- 注册（手机号+验证码）</span>
<span class="hljs-deletion">- 找回密码</span>
<span class="hljs-deletion">- 修改密码</span>
请给出整体架构设计和文件组织结构"
</code></pre>
<h5 data-id="heading-19">第2层：功能层</h5>
<pre><code class="hljs language-diff" lang="diff">"先实现登录功能，支持手机号+验证码和账号+密码两种方式，
包括：
<span class="hljs-deletion">- 登录页面 UI</span>
<span class="hljs-deletion">- 表单验证</span>
<span class="hljs-deletion">- API 调用</span>
<span class="hljs-deletion">- Token 存储</span>
<span class="hljs-deletion">- 路由跳转"</span>
</code></pre>
<h5 data-id="heading-20">第3层：实现层</h5>
<pre><code class="hljs language-markdown" lang="markdown">"实现手机号+验证码登录，具体包括：
<span class="hljs-bullet">1.</span> 手机号输入框（带格式校验）
<span class="hljs-bullet">2.</span> 发送验证码按钮（带倒计时）
<span class="hljs-bullet">3.</span> 验证码输入框（6位数字）
<span class="hljs-bullet">4.</span> 登录按钮（带加载状态）
<span class="hljs-bullet">5.</span> 错误提示"
</code></pre>
<h5 data-id="heading-21">第4层：细节层</h5>
<pre><code class="hljs language-diff" lang="diff">"优化验证码输入体验：
<span class="hljs-deletion">- 自动聚焦到第一个输入框</span>
<span class="hljs-deletion">- 输入一位后自动跳到下一位</span>
<span class="hljs-deletion">- 支持粘贴6位验证码自动填充</span>
<span class="hljs-deletion">- 输入完成后自动触发登录</span>
<span class="hljs-deletion">- 支持删除时自动回到上一位"</span>
</code></pre>
<h4 data-id="heading-22">技巧 2：对话式调试（Conversational Debugging）</h4>
<p><strong>把 AI 当作结对编程的伙伴</strong></p>
<pre><code class="hljs language-perl" lang="perl">你：<span class="hljs-string">"这个登录功能有问题，点击按钮没反应"</span>

AI：<span class="hljs-string">"让我检查一下... 发现 handleLogin 方法没有绑定到按钮的 @click 事件"</span>

你：<span class="hljs-string">"修复后还是不行，控制台报错 'token is undefined'"</span>

AI：<span class="hljs-string">"看起来 API 返回的数据结构不对，让我检查 @src/api/auth.ts...
    发现接口返回的是 data.access_token，但代码中用的是 data.token"</span>

你：<span class="hljs-string">"对，后端改了字段名，同步更新一下类型定义和 mock 数据"</span>

AI：<span class="hljs-string">"已更新 @src/types/auth.ts 中的 ILoginResponse 接口，
    同时更新了 @src/mock/data/auth.ts 中的 mock 数据"</span>
</code></pre>
<h4 data-id="heading-23">技巧 3：模板化常见任务（Template Prompts）</h4>
<p><strong>为重复性任务创建提示词模板</strong></p>
<h5 data-id="heading-24">模板 1：创建 CRUD 页面</h5>
<pre><code class="hljs language-diff" lang="diff">创建 [资源名称] 的 CRUD 页面：

文件结构：
<span class="hljs-deletion">- 列表页：@src/pages/[资源]/list.vue</span>
<span class="hljs-deletion">- 详情页：@src/pages/[资源]/detail.vue</span>
<span class="hljs-deletion">- 编辑页：@src/pages/[资源]/edit.vue</span>
<span class="hljs-deletion">- API：@src/api/[资源].ts</span>
<span class="hljs-deletion">- 类型：@src/types/[资源].ts</span>
<span class="hljs-deletion">- Store：@src/stores/use[资源]Store.ts</span>

列表页功能：
<span class="hljs-deletion">- 搜索栏（[字段1]、[字段2]）</span>
<span class="hljs-deletion">- 数据表格（[列1]、[列2]、操作列）</span>
<span class="hljs-deletion">- 分页组件</span>
<span class="hljs-deletion">- 新增按钮</span>

详情页功能：
<span class="hljs-deletion">- 展示所有字段</span>
<span class="hljs-deletion">- 编辑按钮</span>
<span class="hljs-deletion">- 删除按钮</span>

编辑页功能：
<span class="hljs-deletion">- 表单（所有可编辑字段）</span>
<span class="hljs-deletion">- 表单验证</span>
<span class="hljs-deletion">- 保存按钮</span>
<span class="hljs-deletion">- 取消按钮</span>

使用项目规范，参考 @src/pages/user 的实现
</code></pre>
<h5 data-id="heading-25">模板 2：创建业务组件</h5>
<pre><code class="hljs language-ini" lang="ini">创建 <span class="hljs-section">[组件名称]</span> 组件：

文件位置：@src/components/<span class="hljs-section">[组件名称]</span>/index.vue

Props：
- <span class="hljs-section">[prop1]</span> (类型): 描述
- <span class="hljs-section">[prop2]</span> (类型): 描述

Emits：
- <span class="hljs-section">[event1]</span>: 描述
- <span class="hljs-section">[event2]</span>: 描述

功能：
1. <span class="hljs-section">[功能1描述]</span>
2. <span class="hljs-section">[功能2描述]</span>

样式要求：
- <span class="hljs-section">[样式要求1]</span>
- <span class="hljs-section">[样式要求2]</span>

参考：@src/components/<span class="hljs-section">[类似组件]</span>
</code></pre>
<h5 data-id="heading-26">模板 3：API 接口对接</h5>
<pre><code class="hljs language-ini" lang="ini">对接 <span class="hljs-section">[接口名称]</span> 接口：

接口信息：
- 路径：<span class="hljs-section">[METHOD]</span> /api/v1/<span class="hljs-section">[path]</span>
- 描述：<span class="hljs-section">[接口功能描述]</span>

请求参数：
- <span class="hljs-section">[param1]</span> (类型, 必填/可选): 描述
- <span class="hljs-section">[param2]</span> (类型, 必填/可选): 描述

返回数据：
- <span class="hljs-section">[field1]</span> (类型): 描述
- <span class="hljs-section">[field2]</span> (类型): 描述

需要：
1. 在 @src/api/<span class="hljs-section">[模块]</span>.ts 中添加接口方法
2. 在 @src/types/<span class="hljs-section">[模块]</span>.ts 中定义类型
3. 在 @src/mock/handlers.ts 中添加 mock
4. 在 <span class="hljs-section">[调用位置]</span> 中调用接口
</code></pre>
<h4 data-id="heading-27">技巧 4：增量式重构（Incremental Refactoring）</h4>
<p><strong>不要一次性重构整个文件，而是逐步优化</strong></p>
<pre><code class="hljs language-perl" lang="perl">第<span class="hljs-number">1</span>步：<span class="hljs-string">"提取 @src/pages/user/list.vue 中的搜索逻辑到 useSearch composable"</span>
  ↓
第<span class="hljs-number">2</span>步：<span class="hljs-string">"将表格配置抽离到 @src/pages/user/config/tableConfig.ts"</span>
  ↓
第<span class="hljs-number">3</span>步：<span class="hljs-string">"优化分页逻辑，使用 @src/composables/base/usePagination.ts"</span>
  ↓
第<span class="hljs-number">4</span>步：<span class="hljs-string">"添加列表数据缓存，避免重复请求"</span>
  ↓
第<span class="hljs-number">5</span>步：<span class="hljs-string">"添加骨架屏加载状态"</span>
</code></pre>
<h4 data-id="heading-28">技巧 5：约束驱动开发（Constraint-Driven Development）</h4>
<p><strong>通过约束引导 AI 生成更好的代码</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">实现用户列表功能，严格遵守以下约束：

代码质量约束：
<span class="hljs-bullet">1.</span> 单个函数不超过 50 行
<span class="hljs-bullet">2.</span> 单个文件不超过 300 行
<span class="hljs-bullet">3.</span> 所有异步操作必须有错误处理
<span class="hljs-bullet">4.</span> 使用 TypeScript 严格模式，不允许 any
<span class="hljs-bullet">5.</span> 所有函数必须有 JSDoc 注释

架构约束：
<span class="hljs-bullet">1.</span> 组件拆分：搜索栏、表格、分页各自独立
<span class="hljs-bullet">2.</span> 逻辑抽离：使用 composable 管理状态
<span class="hljs-bullet">3.</span> 类型定义：所有接口和数据结构必须定义类型
<span class="hljs-bullet">4.</span> 错误处理：使用统一的 errorHandler

性能约束：
<span class="hljs-bullet">1.</span> 支持 10000 条数据的虚拟滚动
<span class="hljs-bullet">2.</span> 搜索防抖 300ms
<span class="hljs-bullet">3.</span> 图片懒加载
<span class="hljs-bullet">4.</span> 列表数据缓存 5 分钟

可访问性约束：
<span class="hljs-bullet">1.</span> 支持键盘导航（Tab、Enter、Esc）
<span class="hljs-bullet">2.</span> 支持屏幕阅读器
<span class="hljs-bullet">3.</span> 颜色对比度符合 WCAG 2.1 AA 标准
</code></pre>
<h4 data-id="heading-29">技巧 6：元提示（Meta Prompting）</h4>
<p><strong>让 AI 帮你写提示词</strong></p>
<pre><code class="hljs language-diff" lang="diff">"我想实现一个复杂的数据可视化功能，
但不知道如何描述清楚，
请帮我生成一个完整的提示词，
包含所有必要的信息和约束条件。

需求概述：
<span class="hljs-deletion">- 展示用户增长趋势图（折线图）</span>
<span class="hljs-deletion">- 支持按日/周/月切换</span>
<span class="hljs-deletion">- 支持数据导出</span>
<span class="hljs-deletion">- 需要响应式设计</span>

请生成一个结构化的提示词"
</code></pre>
<p>或者：</p>
<pre><code class="hljs language-markdown" lang="markdown">"根据我的需求，生成一个分步骤的实现计划：

需求：实现一个支持多人协作的在线白板
技术栈：Vue 3 + TypeScript + WebSocket + Canvas

请给出：
<span class="hljs-bullet">1.</span> 整体架构设计
<span class="hljs-bullet">2.</span> 详细的实现步骤
<span class="hljs-bullet">3.</span> 每一步的具体提示词
<span class="hljs-bullet">4.</span> 需要注意的技术难点"
</code></pre>
<hr/>
<h3 data-id="heading-30">三种工作模式</h3>
<h4 data-id="heading-31">模式 1：探索模式（Exploration Mode）</h4>
<p><strong>适用场景</strong>：不确定如何实现，需要探索方案</p>
<pre><code class="hljs language-markdown" lang="markdown">"我想实现一个拖拽排序的功能，
但不确定用什么库比较好，
项目是 Vue 3 + TypeScript + uni-app，
需要支持移动端触摸拖拽，
请给我几个方案对比，包括：
<span class="hljs-bullet">1.</span> 推荐的库（开源、维护活跃、支持 TypeScript）
<span class="hljs-bullet">2.</span> 各方案的优缺点
<span class="hljs-bullet">3.</span> 性能对比
<span class="hljs-bullet">4.</span> 集成难度
<span class="hljs-bullet">5.</span> 你的推荐和理由"
</code></pre>
<p><strong>AI 的回应方式</strong>：</p>
<ul>
<li>提供多个方案对比</li>
<li>分析每个方案的适用场景</li>
<li>给出具体的推荐和理由</li>
</ul>
<h4 data-id="heading-32">模式 2：执行模式（Execution Mode）</h4>
<p><strong>适用场景</strong>：明确知道要做什么，快速实现</p>
<pre><code class="hljs language-less" lang="less">"在 <span class="hljs-variable">@src</span>/components/DragList.vue 中使用 Sortable.js 实现拖拽排序：

<span class="hljs-number">1</span>. 安装依赖：
   - sortablejs
   - <span class="hljs-variable">@types</span>/sortablejs

<span class="hljs-number">2</span>. 创建 <span class="hljs-variable">@src</span>/composables/useDraggable.ts 封装拖拽逻辑

<span class="hljs-number">3</span>. 功能要求：
   - 支持拖拽排序
   - 拖拽时显示占位符
   - 拖拽结束触发 <span class="hljs-variable">@change</span> 事件，返回新的排序
   - 支持禁用拖拽（通过 disabled prop）

<span class="hljs-number">4</span>. 样式要求：
   - 拖拽中的元素半透明
   - 占位符显示虚线边框
   - 拖拽手柄显示拖拽图标

参考 <span class="hljs-variable">@src</span>/components/SortableTable.vue 的实现"
</code></pre>
<p><strong>AI 的回应方式</strong>：</p>
<ul>
<li>直接生成代码</li>
<li>按步骤实现功能</li>
<li>提供必要的说明</li>
</ul>
<h4 data-id="heading-33">模式 3：优化模式（Optimization Mode）</h4>
<p><strong>适用场景</strong>：功能已实现，需要优化</p>
<pre><code class="hljs language-markdown" lang="markdown">"优化 @src/components/DragList.vue 的性能和用户体验：

性能优化：
<span class="hljs-bullet">1.</span> 分析当前性能瓶颈（使用 Vue DevTools）
<span class="hljs-bullet">2.</span> 优化拖拽时的重渲染问题（使用 v-memo）
<span class="hljs-bullet">3.</span> 添加虚拟滚动支持大列表（1000+ 项）
<span class="hljs-bullet">4.</span> 优化事件监听（使用事件委托）

体验优化：
<span class="hljs-bullet">1.</span> 优化移动端触摸体验（增大触摸区域）
<span class="hljs-bullet">2.</span> 添加拖拽动画（使用 FLIP 技术）
<span class="hljs-bullet">3.</span> 添加触觉反馈（移动端震动）
<span class="hljs-bullet">4.</span> 改进无障碍支持（键盘操作）

监控：
<span class="hljs-bullet">1.</span> 添加性能监控埋点
<span class="hljs-bullet">2.</span> 记录拖拽操作日志
<span class="hljs-bullet">3.</span> 监控错误和异常"
</code></pre>
<p><strong>AI 的回应方式</strong>：</p>
<ul>
<li>分析现有代码</li>
<li>指出优化点</li>
<li>提供优化方案</li>
<li>实施优化</li>
</ul>
<hr/>
<h3 data-id="heading-34">常见陷阱与避坑指南</h3>
<h4 data-id="heading-35">陷阱 1：过度依赖 AI</h4>
<p><strong>问题表现</strong>：</p>
<ul>
<li>完全不看 AI 生成的代码，直接复制粘贴</li>
<li>不理解代码逻辑，出问题无法调试</li>
<li>代码风格不统一，不符合项目规范</li>
</ul>
<p><strong>正确做法</strong>：</p>
<pre><code class="hljs">✅ 审查每一行代码
✅ 理解核心逻辑
✅ 验证类型定义
✅ 检查错误处理
✅ 确保符合项目规范
✅ 运行测试验证功能
</code></pre>
<h4 data-id="heading-36">陷阱 2：提示词过于模糊</h4>
<p><strong>问题表现</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">❌ <span class="hljs-string">"优化一下性能"</span>
❌ <span class="hljs-string">"改好看一点"</span>
❌ <span class="hljs-string">"修复一下 bug"</span>
</code></pre>
<p><strong>正确做法</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">✅ <span class="hljs-string">"优化列表渲染性能，目标：1000条数据渲染时间从 500ms 降到 100ms 以内"</span>
✅ <span class="hljs-string">"按照 Figma 设计稿调整样式，主要是：间距、颜色、圆角、阴影"</span>
✅ <span class="hljs-string">"修复登录按钮点击无反应的问题，控制台报错：'Cannot read property token of undefined'"</span>
</code></pre>
<h4 data-id="heading-37">陷阱 3：忽略上下文</h4>
<p><strong>问题表现</strong>：</p>
<ul>
<li>每次都从零开始描述</li>
<li>不引用相关文件</li>
<li>AI 不了解项目结构</li>
</ul>
<p><strong>正确做法</strong>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-operator">✅</span> 使用 <span class="hljs-meta">@文件名</span> 引用相关文件
<span class="hljs-operator">✅</span> 说明项目技术栈和规范
<span class="hljs-operator">✅</span> 提供参考实现
<span class="hljs-operator">✅</span> 说明业务背景
</code></pre>
<h4 data-id="heading-38">陷阱 4：一次性要求太多</h4>
<p><strong>问题表现</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">❌ <span class="hljs-string">"实现整个电商系统，包括：
   商品管理、订单管理、用户管理、
   支付系统、物流系统、营销系统、
   数据分析、客服系统..."</span>
</code></pre>
<p><strong>正确做法</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">✅ 第<span class="hljs-number">1</span>步：<span class="hljs-string">"先实现商品列表页，包括搜索、筛选、分页"</span>
✅ 第<span class="hljs-number">2</span>步：<span class="hljs-string">"实现商品详情页，包括图片轮播、规格选择、加入购物车"</span>
✅ 第<span class="hljs-number">3</span>步：<span class="hljs-string">"实现购物车功能，包括商品列表、数量修改、结算"</span>
✅ ...逐步推进
</code></pre>
<h4 data-id="heading-39">陷阱 5：不验证结果</h4>
<p><strong>问题表现</strong>：</p>
<ul>
<li>AI 说完成了就完成了</li>
<li>不运行代码测试</li>
<li>不检查类型错误</li>
<li>不测试边界情况</li>
</ul>
<p><strong>正确做法</strong>：</p>
<pre><code class="hljs">✅ 运行代码，测试功能
✅ 检查 TypeScript 类型错误
✅ 测试边界情况（空数据、错误数据、极端数据）
✅ 检查性能（大数据量、慢网络）
✅ 测试兼容性（不同浏览器、不同设备）
</code></pre>
<h4 data-id="heading-40">陷阱 6：忽视代码质量</h4>
<p><strong>问题表现</strong>：</p>
<ul>
<li>只关注功能实现，不关注代码质量</li>
<li>代码重复、结构混乱</li>
<li>没有注释、类型定义不完整</li>
</ul>
<p><strong>正确做法</strong>：</p>
<pre><code class="hljs">✅ 要求 AI 遵守代码规范
✅ 要求添加注释和类型定义
✅ 要求代码模块化、可复用
✅ 要求添加错误处理
✅ 定期重构优化
</code></pre>
<hr/>
<h3 data-id="heading-41">黄金公式</h3>
<h4 data-id="heading-42">完美提示词 = 7 个要素</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[角色设定]</span> + <span class="hljs-selector-attr">[任务目标]</span> + <span class="hljs-selector-attr">[上下文]</span> + <span class="hljs-selector-attr">[技术栈]</span> + <span class="hljs-selector-attr">[约束条件]</span> + <span class="hljs-selector-attr">[预期结果]</span> + <span class="hljs-selector-attr">[参考示例]</span>
</code></pre>
<h4 data-id="heading-43">实战示例</h4>
<pre><code class="hljs language-markdown" lang="markdown">你是一个 Vue 3 + TypeScript 专家（角色设定），

帮我在 @src/pages/product/list.vue 中实现商品列表功能（任务目标），

这是一个电商小程序项目，需要展示商品列表并支持筛选，
商品数据来自后端 API，用户可以通过分类、价格、销量等条件筛选商品（上下文），

使用 Vue 3 Composition API + TypeScript + Pinia + uni-app，
调用 GET /api/v1/products 接口获取商品列表（技术栈），

要求：
<span class="hljs-bullet">1.</span> 不修改现有的 TabBar 组件和路由配置
<span class="hljs-bullet">2.</span> 支持下拉刷新和上拉加载更多
<span class="hljs-bullet">3.</span> 筛选条件包括：分类、价格区间、销量排序
<span class="hljs-bullet">4.</span> 单个组件不超过 300 行，复杂逻辑抽离到 composable
<span class="hljs-bullet">5.</span> 所有类型必须明确定义，不使用 any
<span class="hljs-bullet">6.</span> 图片使用懒加载
<span class="hljs-bullet">7.</span> 列表数据缓存 5 分钟
（约束条件）

完成后应该能够：
<span class="hljs-bullet">1.</span> 进入页面自动加载第一页数据（20条）
<span class="hljs-bullet">2.</span> 下拉刷新重置列表并重新加载
<span class="hljs-bullet">3.</span> 滚动到底部自动加载下一页
<span class="hljs-bullet">4.</span> 点击筛选按钮打开筛选面板
<span class="hljs-bullet">5.</span> 选择筛选条件后列表自动更新
<span class="hljs-bullet">6.</span> 点击商品卡片跳转到详情页
<span class="hljs-bullet">7.</span> 显示加载状态和空状态
（预期结果）

参考 @src/pages/order/list.vue 的列表实现方式和
@src/components/FilterPanel.vue 的筛选面板样式
（参考示例）
</code></pre>
<h4 data-id="heading-44">简化版（日常使用）</h4>
<p>对于简单任务，可以使用简化版：</p>
<pre><code class="hljs language-less" lang="less">在 <span class="hljs-variable">@src</span>/components/ProductCard.vue 中实现商品卡片组件：
- <span class="hljs-attribute">Props</span>: product (IProduct 类型)
- 显示：商品图片、名称、价格、销量
- 点击跳转到商品详情页
- 样式参考 <span class="hljs-variable">@src</span>/components/OrderCard.vue
</code></pre>
<hr/>
<h3 data-id="heading-45">进阶心法</h3>
<h4 data-id="heading-46">心法 1：Think Like a Product Manager</h4>
<p><strong>不要只想"怎么实现"，要想"为什么实现"、"用户会怎么用"</strong></p>
<pre><code class="hljs language-diff" lang="diff">不只是："实现搜索功能"

而是：
"实现搜索功能，因为用户需要快速找到商品，
支持：
<span class="hljs-deletion">- 模糊搜索（匹配商品名称、描述、标签）</span>
<span class="hljs-deletion">- 搜索历史（最多保存 10 条，支持删除）</span>
<span class="hljs-deletion">- 热门搜索推荐（显示 TOP 10 热搜词）</span>
<span class="hljs-deletion">- 搜索结果高亮关键词</span>
<span class="hljs-deletion">- 无结果时推荐相关商品</span>
<span class="hljs-deletion">- 搜索防抖（300ms）</span>
<span class="hljs-deletion">- 支持语音搜索（调用微信语音识别 API）"</span>
</code></pre>
<h4 data-id="heading-47">心法 2：Embrace Iteration</h4>
<p><strong>第一版不需要完美，快速出原型，然后迭代优化</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">V1: 基础功能（能用）
<span class="hljs-bullet">  -</span> 实现核心功能
<span class="hljs-bullet">  -</span> 基本的 UI
<span class="hljs-bullet">  -</span> 简单的错误处理

V2: 优化体验（好用）
<span class="hljs-bullet">  -</span> 优化交互流程
<span class="hljs-bullet">  -</span> 改进视觉设计
<span class="hljs-bullet">  -</span> 添加加载状态
<span class="hljs-bullet">  -</span> 完善错误提示

V3: 性能优化（快用）
<span class="hljs-bullet">  -</span> 优化渲染性能
<span class="hljs-bullet">  -</span> 添加缓存机制
<span class="hljs-bullet">  -</span> 图片懒加载
<span class="hljs-bullet">  -</span> 请求防抖节流

V4: 完善细节（爱用）
<span class="hljs-bullet">  -</span> 添加动画效果
<span class="hljs-bullet">  -</span> 优化无障碍支持
<span class="hljs-bullet">  -</span> 完善边界情况
<span class="hljs-bullet">  -</span> 添加埋点统计
</code></pre>
<h4 data-id="heading-48">心法 3：Build a Knowledge Base</h4>
<p><strong>把常用的提示词、代码模板、最佳实践整理成文档</strong></p>
<p>建议创建以下文档：</p>
<pre><code class="hljs language-perl" lang="perl">docs/
├── prompts/
│   ├── component-templates.md      <span class="hljs-comment"># 组件开发模板</span>
│   ├── api-integration.md          <span class="hljs-comment"># API 对接模板</span>
│   ├── page-templates.md           <span class="hljs-comment"># 页面开发模板</span>
│   └── refactoring-checklist.md   <span class="hljs-comment"># 重构检查清单</span>
├── standards/
│   ├── code-style.md               <span class="hljs-comment"># 代码风格规范</span>
│   ├── naming-conventions.md      <span class="hljs-comment"># 命名规范</span>
│   ├── typescript-guide.md        <span class="hljs-comment"># TypeScript 使用指南</span>
│   └── performance-checklist.md   <span class="hljs-comment"># 性能优化清单</span>
└── best-practices/
    ├── vue3-patterns.md            <span class="hljs-comment"># Vue 3 最佳实践</span>
    ├── error-handling.md           <span class="hljs-comment"># 错误处理最佳实践</span>
    ├── <span class="hljs-keyword">state</span>-management.md         <span class="hljs-comment"># 状态管理最佳实践</span>
    └── testing-guide.md            <span class="hljs-comment"># 测试指南</span>
</code></pre>
<h4 data-id="heading-49">心法 4：Teach the AI Your Style</h4>
<p><strong>通过 <code>.cursorrules</code> 或项目规范文件，让 AI 了解你的编码风格</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// .cursorrules 示例</span>

# 项目规范

## 技术栈
- <span class="hljs-title class_">Vue</span> <span class="hljs-number">3</span> + <span class="hljs-title class_">TypeScript</span> + <span class="hljs-title class_">Pinia</span> + uni-app
- 使用 <span class="hljs-title class_">Composition</span> <span class="hljs-variable constant_">API</span> + <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span>
- 使用 SCSS 预处理器

## 代码规范
- 组件使用 PascalCase 命名
- 文件名使用 kebab-case
- 所有函数必须有 JSDoc 注释
- 使用 interface 而不是 type（除非必要）
- Props 和 Emits 必须定义 TypeScript 类型
- 不使用 any，必要时使用 unknown

## 错误处理
- 所有异步操作必须有 try-catch
- 使用统一的 errorHandler 处理错误
- 错误信息要用户友好，不暴露技术细节

## 性能要求
- 列表超过 100 项使用虚拟滚动
- 图片必须懒加载
- 请求必须防抖或节流
- 避免不必要的重渲染

## 文件组织
- 页面文件放在 src/pages/
- 公共组件放在 src/components/
- 业务组件放在页面目录下的 components/
- API 接口放在 src/api/
- 类型定义放在 src/types/
- 工具函数放在 src/utils/
- Composables 放在 src/composables/
</span></code></pre>
<h4 data-id="heading-50">心法 5：Review Like a Senior Developer</h4>
<p><strong>不要盲目信任 AI，要像 Code Review 一样审查代码</strong></p>
<h5 data-id="heading-51">Code Review 检查清单</h5>
<pre><code class="hljs language-arduino" lang="arduino">□ 功能正确性
  □ 实现了所有需求
  □ 边界情况处理正确
  □ 错误处理完善

□ 代码质量
  □ 逻辑清晰，易于理解
  □ 命名规范，见名知意
  □ 注释充分，解释清楚
  □ 没有重复代码

□ 类型安全
  □ 所有类型定义完整
  □ 没有使用 any
  □ Props 和 Emits 类型正确
  □ API 响应类型定义

□ 性能
  □ 没有不必要的重渲染
  □ 列表渲染优化（key、v-memo）
  □ 图片懒加载
  □ 请求防抖节流

□ 安全性
  □ 用户输入验证
  □ XSS 防护
  □ 敏感信息不暴露
  □ 权限检查

□ 可维护性
  □ 代码模块化
  □ 职责单一
  □ 易于测试
  □ 易于扩展

□ 用户体验
  □ 加载状态
  □ 错误提示
  □ 空状态处理
  □ 交互反馈

□ 规范遵守
  □ 符合项目编码规范
  □ 符合 Git 提交规范
  □ 符合命名规范
  □ 符合文件组织规范
</code></pre>
<hr/>
<h3 data-id="heading-52">实战案例</h3>
<h4 data-id="heading-53">案例 1：从零实现用户登录功能</h4>
<h5 data-id="heading-54">第1轮：架构设计</h5>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">设计用户登录功能的整体架构：
<span class="hljs-deletion">- 支持手机号+验证码登录</span>
<span class="hljs-deletion">- 支持账号+密码登录</span>
<span class="hljs-deletion">- 需要记住登录状态</span>
<span class="hljs-deletion">- 需要 Token 管理和自动刷新</span>
请给出文件组织结构和技术方案
</code></pre>
<p><strong>AI 回应</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">文件组织：
src/
├── pages/login/
│   ├── index.vue           <span class="hljs-comment"># 登录页（选择登录方式）</span>
│   ├── phone.vue           <span class="hljs-comment"># 手机号登录</span>
│   └── password.vue        <span class="hljs-comment"># 密码登录</span>
├── api/auth.ts             <span class="hljs-comment"># 认证相关 API</span>
├── types/auth.ts           <span class="hljs-comment"># 认证相关类型</span>
├── stores/useAuthStore.ts  <span class="hljs-comment"># 认证状态管理</span>
└── composables/
    └── useAuth.ts          <span class="hljs-comment"># 认证逻辑封装</span>

技术方案：
1. Token 存储：uni.setStorageSync
2. Token 刷新：拦截器自动刷新
3. 登录状态：Pinia Store 管理
4. 路由守卫：检查登录状态
</code></pre>
<h5 data-id="heading-55">第2轮：实现手机号登录</h5>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-less" lang="less">在 <span class="hljs-variable">@src</span>/pages/login/phone.vue 中实现手机号+验证码登录：

功能：
<span class="hljs-number">1</span>. 手机号输入（<span class="hljs-number">11</span>位数字，实时校验）
<span class="hljs-number">2</span>. 发送验证码按钮（<span class="hljs-number">60</span>秒倒计时）
<span class="hljs-number">3</span>. 验证码输入（<span class="hljs-number">6</span>位数字）
<span class="hljs-number">4</span>. 登录按钮（表单验证通过后可点击）

API：
- 发送验证码：POST /api/v1/auth/send-code
- 登录：POST /api/v1/auth/login

技术要求：
- 使用 Vue <span class="hljs-number">3</span> Composition API + TypeScript
- 表单验证使用 uni-app 内置验证
- 调用 <span class="hljs-variable">@src</span>/api/auth.ts 中的接口
- 登录成功后保存 token 到 <span class="hljs-variable">@src</span>/stores/useAuthStore.ts
- 跳转到首页

样式：
- 参考 <span class="hljs-variable">@src</span>/pages/login/index.vue 的整体风格
- 输入框使用圆角卡片样式
- 按钮使用渐变色
</code></pre>
<h5 data-id="heading-56">第3轮：优化用户体验</h5>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">优化 @src/pages/login/phone.vue 的用户体验：

<span class="hljs-bullet">1.</span> 输入优化：
<span class="hljs-bullet">   -</span> 手机号输入自动添加空格（3-4-4 格式）
<span class="hljs-bullet">   -</span> 验证码输入自动聚焦到下一位
<span class="hljs-bullet">   -</span> 支持粘贴验证码自动填充

<span class="hljs-bullet">2.</span> 反馈优化：
<span class="hljs-bullet">   -</span> 发送验证码成功显示 Toast
<span class="hljs-bullet">   -</span> 登录中显示 Loading
<span class="hljs-bullet">   -</span> 登录失败显示错误提示
<span class="hljs-bullet">   -</span> 表单验证失败高亮错误字段

<span class="hljs-bullet">3.</span> 动画效果：
<span class="hljs-bullet">   -</span> 页面进入淡入动画
<span class="hljs-bullet">   -</span> 按钮点击缩放反馈
<span class="hljs-bullet">   -</span> 错误提示抖动动画

<span class="hljs-bullet">4.</span> 边界情况：
<span class="hljs-bullet">   -</span> 网络错误重试
<span class="hljs-bullet">   -</span> 验证码过期提示
<span class="hljs-bullet">   -</span> 频繁发送验证码限制
</code></pre>
<h4 data-id="heading-57">案例 2：优化现有商品列表性能</h4>
<h5 data-id="heading-58">第1轮：性能分析</h5>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">分析 @src/pages/product/list.vue 的性能问题：
<span class="hljs-deletion">- 当前有 1000+ 商品数据</span>
<span class="hljs-deletion">- 滚动时有明显卡顿</span>
<span class="hljs-deletion">- 图片加载慢</span>
<span class="hljs-deletion">- 筛选条件改变时整个列表重新渲染</span>

请使用 Vue DevTools 分析性能瓶颈，
并给出优化方案
</code></pre>
<h5 data-id="heading-59">第2轮：实施优化</h5>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">优化 @src/pages/product/list.vue 的性能：

<span class="hljs-bullet">1.</span> 列表渲染优化：
<span class="hljs-bullet">   -</span> 使用虚拟滚动（uni-app 的 recycle-view）
<span class="hljs-bullet">   -</span> 使用 v-memo 避免不必要的重渲染
<span class="hljs-bullet">   -</span> 优化 key 的使用

<span class="hljs-bullet">2.</span> 图片加载优化：
<span class="hljs-bullet">   -</span> 使用图片懒加载
<span class="hljs-bullet">   -</span> 使用缩略图（小尺寸）
<span class="hljs-bullet">   -</span> 添加占位图

<span class="hljs-bullet">3.</span> 筛选优化：
<span class="hljs-bullet">   -</span> 筛选条件改变时只更新数据，不重新渲染整个列表
<span class="hljs-bullet">   -</span> 使用防抖避免频繁筛选

<span class="hljs-bullet">4.</span> 数据优化：
<span class="hljs-bullet">   -</span> 添加列表数据缓存
<span class="hljs-bullet">   -</span> 分页加载，每页 20 条

目标：
<span class="hljs-bullet">-</span> 1000 条数据渲染时间 &lt; 100ms
<span class="hljs-bullet">-</span> 滚动帧率 &gt; 55fps
<span class="hljs-bullet">-</span> 图片加载使用渐进式加载
</code></pre>
<h4 data-id="heading-60">案例 3：重构混乱的组件</h4>
<h5 data-id="heading-61">第1轮：代码审查</h5>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">审查 @src/pages/order/detail.vue 的代码质量：
<span class="hljs-deletion">- 文件有 800+ 行</span>
<span class="hljs-deletion">- 逻辑混乱，难以维护</span>
<span class="hljs-deletion">- 没有类型定义</span>
<span class="hljs-deletion">- 没有注释</span>

请分析存在的问题，并给出重构方案
</code></pre>
<h5 data-id="heading-62">第2轮：拆分组件</h5>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">重构 @src/pages/order/detail.vue，按以下方案拆分：

<span class="hljs-bullet">1.</span> 拆分组件：
<span class="hljs-bullet">   -</span> OrderHeader.vue（订单头部信息）
<span class="hljs-bullet">   -</span> OrderProducts.vue（商品列表）
<span class="hljs-bullet">   -</span> OrderAddress.vue（收货地址）
<span class="hljs-bullet">   -</span> OrderPrice.vue（价格明细）
<span class="hljs-bullet">   -</span> OrderActions.vue（操作按钮）

<span class="hljs-bullet">2.</span> 抽离逻辑：
<span class="hljs-bullet">   -</span> useOrderDetail.ts（订单详情逻辑）
<span class="hljs-bullet">   -</span> useOrderActions.ts（订单操作逻辑）

<span class="hljs-bullet">3.</span> 类型定义：
<span class="hljs-bullet">   -</span> 在 @src/types/order.ts 中定义所有类型

<span class="hljs-bullet">4.</span> 要求：
<span class="hljs-bullet">   -</span> 每个组件 &lt; 200 行
<span class="hljs-bullet">   -</span> 所有 Props 和 Emits 定义类型
<span class="hljs-bullet">   -</span> 添加 JSDoc 注释
<span class="hljs-bullet">   -</span> 保持功能不变
</code></pre>
<hr/>
<h3 data-id="heading-63">总结</h3>
<h4 data-id="heading-64">Vibe Coding 的本质</h4>
<p><strong>Vibe Coding 不是让 AI 替你写代码，而是让 AI 成为你的编程伙伴</strong></p>
<h4 data-id="heading-65">三个关键点</h4>
<ol>
<li><strong>清晰表达</strong>：用准确的语言描述你的意图</li>
<li><strong>持续迭代</strong>：不追求一次完美，快速迭代优化</li>
<li><strong>代码审查</strong>：始终审查 AI 生成的代码，确保质量</li>
</ol>
<h4 data-id="heading-66">记住这些原则</h4>
<blockquote>
<p><strong>最好的提示词不是最长的，而是最清晰的</strong></p>
</blockquote>
<blockquote>
<p><strong>最好的代码不是 AI 生成的，而是你审查过的</strong></p>
</blockquote>
<blockquote>
<p><strong>最好的开发者不是不用 AI 的，而是会用 AI 的</strong></p>
</blockquote>
<h4 data-id="heading-67">持续学习</h4>
<p>Vibe Coding 是一个不断进化的领域：</p>
<ul>
<li><strong>关注 AI 能力更新</strong>：新功能、新特性</li>
<li><strong>总结最佳实践</strong>：记录有效的提示词模板</li>
<li><strong>分享经验</strong>：与团队分享 Vibe Coding 技巧</li>
<li><strong>保持好奇</strong>：探索 AI 的边界和可能性</li>
</ul>
<hr/>
<h3 data-id="heading-68">性能与成本优化</h3>
<h4 data-id="heading-69">Token 使用优化策略</h4>
<p>在使用 AI 编码工具时，合理控制 Token 消耗不仅能降低成本，还能提升响应速度。</p>
<h5 data-id="heading-70">1. 精准的上下文管理</h5>
<p><strong>只添加必要的文件到上下文</strong></p>
<pre><code class="hljs language-perl" lang="perl">❌ 不好：让 AI 读取整个项目
<span class="hljs-string">"帮我看看项目中所有的登录相关代码"</span>

✅ 更好：精确引用需要的文件
<span class="hljs-string">"检查 @src/pages/login/phone.vue 和 @src/api/auth.ts 中的登录逻辑"</span>
</code></pre>
<p><strong>及时清理上下文</strong></p>
<ul>
<li>对话过长时（&gt;50 轮）开启新对话</li>
<li>完成一个功能模块后，总结要点，开启新对话</li>
<li>避免在同一对话中处理多个不相关的任务</li>
</ul>
<p><strong>分层提问策略</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">❌ 低效方式：
<span class="hljs-string">"帮我实现一个完整的订单系统，包括列表、详情、支付等所有功能"</span>
<span class="hljs-comment">// 这会生成大量 token，可能不准确</span>

✅ 高效方式：
第<span class="hljs-number">1</span>步：<span class="hljs-string">"设计订单系统的整体架构和文件组织"</span>
第<span class="hljs-number">2</span>步：<span class="hljs-string">"实现订单列表页，参考 @src/pages/product/list.vue"</span>
第<span class="hljs-number">3</span>步：<span class="hljs-string">"实现订单详情页，使用 @src/types/order.ts 的类型定义"</span>
第<span class="hljs-number">4</span>步：<span class="hljs-string">"集成支付功能"</span>
<span class="hljs-comment">// 精确引用，减少上下文，提高准确度</span>
</code></pre>
<h5 data-id="heading-71">2. 减少 Token 消耗的技巧</h5>
<p><strong>使用代码引用而非完整代码</strong></p>
<pre><code class="hljs language-perl" lang="perl">❌ 不好：把整个文件内容粘贴进来
<span class="hljs-string">"这是我的代码：[粘贴 500 行代码]，帮我优化"</span>

✅ 更好：使用文件引用和行号
<span class="hljs-string">"优化 @src/pages/order/list.vue 第 45-60 行的列表渲染逻辑"</span>
</code></pre>
<p><strong>明确的问题描述</strong></p>
<pre><code class="hljs language-perl" lang="perl">❌ 模糊描述（AI 需要多轮对话确认）：
<span class="hljs-string">"这个组件有问题，帮我看看"</span>

✅ 精确描述（一次性解决）：
<span class="hljs-string">"CategoryTabs 组件在切换时状态不更新，
怀疑是 props 响应式问题，
请检查 @src/pages/index/components/CategoryTabs.vue 第 45-60 行"</span>
</code></pre>
<p><strong>利用项目规则</strong></p>
<ul>
<li>在 <code>.cursorrules</code> 中定义项目规范</li>
<li>AI 会自动遵循这些规则，无需每次重复</li>
<li>减少"请使用 TypeScript"、"请用 Vue 3 Composition API"等重复指令</li>
</ul>
<h5 data-id="heading-72">3. 提高生成速度的策略</h5>
<p><strong>使用快捷指令</strong></p>
<p>根据项目规则定义快捷方式：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 在 .cursorrules 中定义</span>
- <span class="hljs-string">'figma2vue'</span> - 快速从设计生成页面
- <span class="hljs-string">'组件拆分'</span> - 快速拆分组件
- <span class="hljs-string">'跑多语言'</span> - 快速处理国际化
</code></pre>
<p><strong>批量操作</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 一次性提问多个相关问题</span>
<span class="hljs-string">"请帮我：
1. 创建 OrderList 组件的类型定义
2. 实现分页逻辑
3. 添加加载状态
参考 @src/pages/product/list.vue 的实现"</span>

<span class="hljs-comment">// 而不是分三次问，每次都要重新理解上下文</span>
</code></pre>
<p><strong>使用模板和代码片段</strong></p>
<p>创建常用的代码模板，减少重复生成：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// templates/page-template.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 添加具体逻辑</span>
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- <span class="hljs-doctag">TODO:</span> 添加内容 --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.page</span> {
  // TODO: 添加样式
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h5 data-id="heading-73">4. 智能使用不同的 AI 模型</h5>
<p><strong>根据任务选择模型</strong></p>



































<table><thead><tr><th>任务类型</th><th>推荐模型</th><th>原因</th></tr></thead><tbody><tr><td>简单重复任务</td><td>GPT-3.5 / Claude Haiku</td><td>更快更便宜</td></tr><tr><td>代码格式化、简单重构</td><td>GPT-3.5</td><td>成本低，速度快</td></tr><tr><td>复杂架构设计</td><td>GPT-4 / Claude Sonnet</td><td>理解力强，质量高</td></tr><tr><td>代码审查</td><td>Claude Sonnet</td><td>注重细节，准确度高</td></tr><tr><td>算法优化</td><td>GPT-4 Turbo</td><td>推理能力强</td></tr></tbody></table>
<p><strong>Cursor 快捷键优化</strong></p>
<pre><code class="hljs language-css" lang="css">Cmd/Ctrl + K - 快速编辑（适合小改动，token 消耗少）
Cmd/Ctrl + L - 聊天模式（适合复杂问题）
Cmd/Ctrl + <span class="hljs-selector-tag">I</span> - 内联编辑（最省 token）
</code></pre>
<h5 data-id="heading-74">5. 代码复用和组件化</h5>
<p><strong>建立组件库</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 优先使用现有组件，减少重复生成</span>
components/
├── <span class="hljs-title class_">Base</span>/          <span class="hljs-comment">// 基础组件（高复用）</span>
│   ├── <span class="hljs-title class_">BaseButton</span>.<span class="hljs-property">vue</span>
│   ├── <span class="hljs-title class_">BaseInput</span>.<span class="hljs-property">vue</span>
│   └── <span class="hljs-title class_">BaseEmpty</span>.<span class="hljs-property">vue</span>
├── <span class="hljs-title class_">Business</span>/      <span class="hljs-comment">// 业务组件（中复用）</span>
│   ├── <span class="hljs-title class_">RegionPicker</span>/
│   └── <span class="hljs-title class_">SkuPopup</span>/
└── [<span class="hljs-title class_">Page</span>]/        <span class="hljs-comment">// 页面组件（低复用）</span>
</code></pre>
<p><strong>使用 Composables 复用逻辑</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// composables/useOrder.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useOrder</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 订单相关逻辑</span>
    <span class="hljs-keyword">const</span> orders = <span class="hljs-title function_">ref</span>([])
    <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchOrders</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// ...</span>
    }

    <span class="hljs-keyword">return</span> { orders, loading, fetchOrders }
}

<span class="hljs-comment">// 在多个页面中复用，而不是重复生成</span>
<span class="hljs-keyword">import</span> { useOrder } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables'</span>
</code></pre>
<h5 data-id="heading-75">6. 增量式开发</h5>
<p><strong>先骨架后细节</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">第一步：生成页面结构和路由（快速搭建）
  <span class="hljs-string">"创建订单列表页面的基础结构"</span>

第二步：实现核心功能（能用）
  <span class="hljs-string">"实现订单列表的数据加载和展示"</span>

第三步：添加交互（好用）
  <span class="hljs-string">"添加搜索、筛选、排序功能"</span>

第四步：优化体验（爱用）
  <span class="hljs-string">"添加加载状态、空状态、错误处理"</span>

第五步：性能优化（快用）
  <span class="hljs-string">"优化列表渲染性能，添加虚拟滚动"</span>
</code></pre>
<p><strong>使用 TODO 标记</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 让 AI 只实现关键部分</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 添加表单验证</span>
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 调用 API</span>
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 处理错误</span>
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 成功后跳转</span>
}

<span class="hljs-comment">// 然后分别让 AI 实现每个 TODO</span>
<span class="hljs-comment">// 每次只消耗少量 token</span>
</code></pre>
<h5 data-id="heading-76">7. 利用缓存和记忆</h5>
<p><strong>使用 Cursor 的记忆功能</strong></p>
<pre><code class="hljs language-diff" lang="diff">让 AI 记住：
<span class="hljs-deletion">- 项目特定的约定和规范</span>
<span class="hljs-deletion">- 常用的代码模式</span>
<span class="hljs-deletion">- 你的偏好设置</span>
<span class="hljs-deletion">- 团队的命名规则</span>

这样每次对话不需要重复说明
</code></pre>
<p><strong>本地代码搜索优先</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">工作流程：
<span class="hljs-bullet">1.</span> ✅ 先用 Cmd/Ctrl + P 搜索现有代码
<span class="hljs-bullet">2.</span> ✅ 再用 Cmd/Ctrl + Shift + F 全局搜索
<span class="hljs-bullet">3.</span> ✅ 查看项目文档和注释
<span class="hljs-bullet">4.</span> ❌ 最后才问 AI（如果找不到）

这样可以节省 50-70% 的 AI 调用
</code></pre>
<h5 data-id="heading-77">8. 成本对比与选择</h5>
<p><strong>主流 AI 模型成本对比（2026年1月）</strong></p>



































<table><thead><tr><th>模型</th><th>输入成本</th><th>输出成本</th><th>适用场景</th></tr></thead><tbody><tr><td>GPT-4 Turbo</td><td>$0.01/1K tokens</td><td>$0.03/1K tokens</td><td>复杂架构、算法设计</td></tr><tr><td>Claude Sonnet</td><td>$0.003/1K tokens</td><td>$0.015/1K tokens</td><td>代码审查、重构</td></tr><tr><td>GPT-3.5 Turbo</td><td>$0.0005/1K tokens</td><td>$0.0015/1K tokens</td><td>简单任务、格式化</td></tr><tr><td>Claude Haiku</td><td>$0.00025/1K tokens</td><td>$0.00125/1K tokens</td><td>重复性任务</td></tr></tbody></table>
<p><strong>节省成本的策略</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 简单问题用便宜模型
<span class="hljs-bullet">   -</span> 代码格式化 → GPT-3.5
<span class="hljs-bullet">   -</span> 简单重构 → Claude Haiku
<span class="hljs-bullet">   -</span> 类型定义 → GPT-3.5

<span class="hljs-bullet">2.</span> 复杂问题用高级模型
<span class="hljs-bullet">   -</span> 架构设计 → GPT-4 Turbo
<span class="hljs-bullet">   -</span> 性能优化 → Claude Sonnet
<span class="hljs-bullet">   -</span> 算法实现 → GPT-4

<span class="hljs-bullet">3.</span> 批量处理
<span class="hljs-bullet">   -</span> 一次性处理多个相关任务
<span class="hljs-bullet">   -</span> 减少对话轮次
<span class="hljs-bullet">   -</span> 提高 token 利用率

<span class="hljs-bullet">4.</span> 使用本地工具
<span class="hljs-bullet">   -</span> ESLint（代码检查）
<span class="hljs-bullet">   -</span> Prettier（代码格式化）
<span class="hljs-bullet">   -</span> TypeScript（类型检查）
<span class="hljs-bullet">   -</span> 不需要 AI 的不用 AI
</code></pre>
<h5 data-id="heading-78">9. 其他 AI 编码工具对比</h5>
<p><strong>GitHub Copilot</strong></p>
<ul>
<li><strong>优势</strong>：实时补全，速度快，IDE 集成好</li>
<li><strong>适用</strong>：日常编码、快速补全、代码片段</li>
<li><strong>成本</strong>：$10/月（固定费用）</li>
<li><strong>推荐场景</strong>：作为基础工具，处理 80% 的日常编码</li>
</ul>
<p><strong>Codeium</strong></p>
<ul>
<li><strong>优势</strong>：免费，支持多种 IDE，功能全面</li>
<li><strong>适用</strong>：预算有限的开发者、学习阶段</li>
<li><strong>成本</strong>：免费（个人版）</li>
<li><strong>推荐场景</strong>：个人项目、学习练习</li>
</ul>
<p><strong>Tabnine</strong></p>
<ul>
<li><strong>优势</strong>：可本地部署，隐私性好，企业级</li>
<li><strong>适用</strong>：企业级项目、隐私敏感项目</li>
<li><strong>成本</strong>：$12-39/月</li>
<li><strong>推荐场景</strong>：企业项目、对代码隐私有要求</li>
</ul>
<p><strong>Cursor</strong></p>
<ul>
<li><strong>优势</strong>：深度集成，上下文理解好，多模型支持</li>
<li><strong>适用</strong>：复杂项目、架构设计、代码重构</li>
<li><strong>成本</strong>：$20/月（Pro）</li>
<li><strong>推荐场景</strong>：专业开发、复杂业务逻辑</li>
</ul>
<p><strong>推荐组合方案</strong></p>
<pre><code class="hljs language-diff" lang="diff">方案 1：性价比最高
<span class="hljs-deletion">- 日常编码：GitHub Copilot（$10/月）</span>
<span class="hljs-deletion">- 复杂问题：Cursor + Claude Sonnet（$20/月）</span>
<span class="hljs-deletion">- 总成本：$30/月</span>

方案 2：预算有限
<span class="hljs-deletion">- 日常编码：Codeium（免费）</span>
<span class="hljs-deletion">- 复杂问题：Claude API 直接调用（按需付费）</span>
<span class="hljs-deletion">- 总成本：&lt;$10/月</span>

方案 3：专业开发
<span class="hljs-deletion">- 日常编码：GitHub Copilot（$10/月）</span>
<span class="hljs-deletion">- 架构设计：Cursor + GPT-4（$20/月）</span>
<span class="hljs-deletion">- 代码审查：Claude Sonnet API（按需）</span>
<span class="hljs-deletion">- 总成本：$30-40/月</span>

方案 4：团队协作
<span class="hljs-deletion">- 统一使用 Cursor Team（$40/月/人）</span>
<span class="hljs-deletion">- 配置团队规则和知识库</span>
<span class="hljs-deletion">- 共享最佳实践和提示词模板</span>
</code></pre>
<h5 data-id="heading-79">10. 实战优化示例</h5>
<p><strong>优化前（低效方式）</strong></p>
<pre><code class="hljs language-diff" lang="diff">对话轮次：15 轮
Token 消耗：约 50,000 tokens
时间：45 分钟
成本：约 $0.75

问题：
<span class="hljs-deletion">- 每次都重新描述需求</span>
<span class="hljs-deletion">- 没有引用相关文件</span>
<span class="hljs-deletion">- 一次性要求太多功能</span>
<span class="hljs-deletion">- 频繁修改和调整</span>
</code></pre>
<p><strong>优化后（高效方式）</strong></p>
<pre><code class="hljs language-diff" lang="diff">对话轮次：5 轮
Token 消耗：约 15,000 tokens
时间：15 分钟
成本：约 $0.23

改进：
<span class="hljs-deletion">- 使用 @文件名 精确引用</span>
<span class="hljs-deletion">- 分步骤实现，每步明确</span>
<span class="hljs-deletion">- 利用项目规则，减少重复说明</span>
<span class="hljs-deletion">- 使用模板和参考实现</span>
</code></pre>
<p><strong>节省效果</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">Token 节省：<span class="hljs-number">70</span><span class="hljs-comment">%</span>
时间节省：<span class="hljs-number">67</span><span class="hljs-comment">%</span>
成本节省：<span class="hljs-number">69</span><span class="hljs-comment">%</span>
质量提升：代码更规范，bug 更少
</code></pre>
<h5 data-id="heading-80">11. 最佳实践清单</h5>
<p><strong>开始编码前</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 明确任务目标和范围</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 准备好相关文件引用</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 检查是否有类似实现可参考</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 确认技术栈和约束条件</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 选择合适的 AI 模型</li>
</ul>
<p><strong>编码过程中</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 只添加必要文件到上下文</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 使用 <code>@文件名</code> 精确引用</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 问题描述清晰具体</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 分步骤实现，逐步验证</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 及时清理长对话</li>
</ul>
<p><strong>代码生成后</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 审查每一行代码</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 验证类型定义</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 测试功能和边界情况</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 检查性能和安全性</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 确保符合项目规范</li>
</ul>
<p><strong>持续优化</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 总结有效的提示词模板</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 建立项目知识库</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 记录常见问题和解决方案</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 定期回顾和优化工作流</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 与团队分享最佳实践</li>
</ul>
<h4 data-id="heading-81">性能优化总结</h4>
<p>通过以上策略，你可以：</p>
<ul>
<li><strong>降低 50-70% 的 Token 消耗</strong></li>
<li><strong>提升 2-3 倍的开发效率</strong></li>
<li><strong>减少 60-80% 的成本</strong></li>
<li><strong>提高代码质量和一致性</strong></li>
</ul>
<p>记住：<strong>最好的优化不是少用 AI，而是更智能地使用 AI</strong>。</p>
<hr/>
<h3 data-id="heading-82">附录</h3>
<h4 data-id="heading-83">常用提示词模板库</h4>
<h5 data-id="heading-84">1. 功能实现类</h5>
<pre><code class="hljs language-ini" lang="ini">在 @<span class="hljs-section">[文件路径]</span> 中实现 <span class="hljs-section">[功能名称]</span>：

功能描述：
- <span class="hljs-section">[功能点1]</span>
- <span class="hljs-section">[功能点2]</span>

技术要求：
- <span class="hljs-section">[技术要求1]</span>
- <span class="hljs-section">[技术要求2]</span>

约束条件：
- <span class="hljs-section">[约束1]</span>
- <span class="hljs-section">[约束2]</span>

参考：@<span class="hljs-section">[参考文件]</span>
</code></pre>
<h5 data-id="heading-85">2. Bug 修复类</h5>
<pre><code class="hljs language-ini" lang="ini">修复 @<span class="hljs-section">[文件路径]</span> 中的问题：

问题描述：
- 现象：<span class="hljs-section">[问题表现]</span>
- 预期：<span class="hljs-section">[期望结果]</span>
- 错误信息：<span class="hljs-section">[错误日志]</span>

复现步骤：
1. <span class="hljs-section">[步骤1]</span>
2. <span class="hljs-section">[步骤2]</span>

环境信息：
- <span class="hljs-section">[浏览器/设备/版本]</span>
</code></pre>
<h5 data-id="heading-86">3. 性能优化类</h5>
<pre><code class="hljs language-ini" lang="ini">优化 @<span class="hljs-section">[文件路径]</span> 的性能：

当前问题：
- <span class="hljs-section">[性能问题1]</span>
- <span class="hljs-section">[性能问题2]</span>

优化目标：
- <span class="hljs-section">[具体指标]</span>

优化方向：
- <span class="hljs-section">[方向1]</span>
- <span class="hljs-section">[方向2]</span>
</code></pre>
<h5 data-id="heading-87">4. 代码重构类</h5>
<pre><code class="hljs language-diff" lang="diff">重构 @[文件路径]：

重构目标：
<span class="hljs-deletion">- [目标1]</span>
<span class="hljs-deletion">- [目标2]</span>

重构方案：
<span class="hljs-deletion">- [方案描述]</span>

要求：
<span class="hljs-deletion">- 保持功能不变</span>
<span class="hljs-deletion">- 添加必要的注释</span>
<span class="hljs-deletion">- 提高代码可读性</span>
</code></pre>
<p><strong>Keep Vibing, Keep Coding! 🚀</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python+OpenCV 图片浏览器核心功能实现与技术细节深度解析]]></title>    <link>https://juejin.cn/post/7595028805158600714</link>    <guid>https://juejin.cn/post/7595028805158600714</guid>    <pubDate>2026-01-14T10:28:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595028805158600714" data-draft-id="7595021077665841203" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python+OpenCV 图片浏览器核心功能实现与技术细节深度解析"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-14T10:28:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="errorPage"/> <meta itemprop="url" content="https://juejin.cn/user/3546344178319914"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python+OpenCV 图片浏览器核心功能实现与技术细节深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3546344178319914/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    errorPage
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T10:28:43.000Z" title="Wed Jan 14 2026 10:28:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><span href="https://code.juejin.cn/pen/7595162007155048498" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7595162007155048498" data-src="https://code.juejin.cn/pen/7595162007155048498" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
 <h2 data-id="heading-0">Python+OpenCV 图片浏览器核心功能实现与技术细节深度解析</h2> <h3 data-id="heading-1">前言</h3> <p>在Python可视化开发中，基于OpenCV实现图片浏览器/简易图片编辑器是非常经典的实战场景，其中包含了OpenCV图片加载的避坑技巧、Numpy与OpenCV的底层关联、图像数据的内存管理、等比例缩放的核心算法、工业级代码的健壮性设计等多个高频考点与易踩坑细节。</p> <p>本文将结合实际业务代码，从核心业务流程、图片加载最优实现、图像矩阵本质、深拷贝避坑、缩放算法原理、健壮性判断解析六大维度，深度拆解图片浏览器的核心实现逻辑，同时解答开发中极易产生的疑问，所有知识点均贴合生产级代码规范，兼具实战性与理论深度。</p> <div class="tip"> 本文所有解析基于如下核心业务代码展开（工业级标准写法）：<br/> 1. 图片加载核心方法 load_image<br/> 2. 图片等比例缩放计算方法 calculate_fill_scale<br/> 3. 基于发布订阅模式的事件总线解耦设计 </div> <h3 data-id="heading-2">一、核心业务场景与整体流程梳理</h3> <h4 data-id="heading-3">1.1 核心业务需求</h4> <p>实现一个具备「图片加载、等比例自适应缩放、原图保护、画布适配、异常兜底」的图片浏览器核心能力，核心诉求：</p> <ul> <li>支持中文路径的图片加载，兼容各类图片格式；</li> <li>加载图片后自动计算缩放比例，让图片完整且最大化的撑满显示容器；</li> <li>区分「原始图片」和「当前编辑图片」，保证原图永不被修改，支持随时重置；</li> <li>所有核心逻辑具备健壮性，避免程序崩溃或显示异常；</li> <li>通过事件总线解耦业务逻辑与UI更新，保证代码扩展性。</li> </ul> <h4 data-id="heading-4">1.2 核心变量分工（黄金设计规范）</h4> <p>代码中定义了两个核心的图像变量，是所有逻辑的基础，所有Python图片处理类程序的标准设计：</p> <pre><code class="hljs language-lua" lang="lua"><span class="hljs-built_in">self</span>.original_image # 存储原始、无任何修改的图片数据，只读不写，作为底图 <span class="hljs-built_in">self</span>.current_image # 存储当前展示、缩放后的图片数据，可任意修改，作为工作图</code></pre> <h4 data-id="heading-5">1.3 整体执行流程</h4> <ol> <li>调用load_image(path)传入图片路径 → 读取图片二进制流并解码为图像矩阵</li> <li>对原始图像做深拷贝，赋值给工作图像，重置缩放/偏移参数</li> <li>通过事件总线发布「图片加载完成」事件，携带图片元信息（宽、高、大小）</li> <li>发布「计算自适应缩放比例」事件，触发calculate_fill_scale执行</li> <li>计算最优缩放比例后，发布「缩放更新」和「请求重绘」事件，更新UI展示</li> <li>所有异常在try-except中捕获，发布错误事件，友好提示用户</li> </ol> <h3 data-id="heading-6">二、OpenCV加载图片的最优实现（解决中文路径+二进制解码）</h3> <h4 data-id="heading-7">2.1 为什么不用cv2.imread()直接加载？</h4> <p><code>cv2.imread(path)</code> 是OpenCV官方提供的图片读取方法，但存在致命缺陷：无法读取路径中包含中文/特殊字符的图片文件，会直接返回None导致加载失败，这是OpenCV的原生编码问题，无法通过简单配置解决。</p> <h4 data-id="heading-8">2.2 最优加载方案：np.fromfile + cv2.imdecode 黄金组合</h4> <p>这是Python+OpenCV加载图片的工业级最优写法，完美解决中文路径问题，也是本文代码中采用的方案，核心代码：</p> <pre><code class="hljs language-lua" lang="lua">def load_image(<span class="hljs-built_in">self</span>, <span class="hljs-built_in">path</span>=None): <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">path</span>: <span class="hljs-keyword">return</span> try: <span class="hljs-built_in">path</span> = <span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.normpath(<span class="hljs-built_in">path</span>) # <span class="hljs-number">1.</span> 读取图片的原始二进制字节流 file_data = np.fromfile(<span class="hljs-built_in">path</span>, dtype=np.uint8) # <span class="hljs-number">2.</span> 将二进制流解码为OpenCV可处理的图像矩阵 <span class="hljs-built_in">self</span>.original_image = cv2.imdecode(file_data, cv2.IMREAD_COLOR) <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.original_image is None: raise ValueError(<span class="hljs-string">"无法读取图片"</span>) # 后续逻辑... except Exception as e: event_bus.publish(<span class="hljs-string">"ERROR_OCCURRED"</span>, message=f<span class="hljs-string">"加载失败：{str(e)}"</span>)</code></pre> <h4 data-id="heading-9">2.3 逐行解析核心方法</h4> <p><strong>np.fromfile(path, dtype=np.uint8)</strong></p> <ul> <li>核心作用：从指定文件路径读取原始二进制字节流，不识别文件路径的字符编码，完美兼容中文路径；</li> <li>参数dtype=np.uint8：图片的像素数据本质是 0~255 的无符号8位整数，这是图片存储的通用标准，必须指定该类型；</li> <li>返回值：一维的Numpy数组，存储图片的所有二进制数据。</li> </ul> <p><strong>cv2.imdecode(file_data, cv2.IMREAD_COLOR)</strong></p> <ul> <li>核心作用：将图片的二进制字节流，解码为OpenCV可直接处理的图像矩阵；</li> <li>第一个参数file_data：上一步读取的二进制Numpy数组，是解码的数据源；</li> <li>第二个参数cv2.IMREAD_COLOR：指定彩色图片加载模式，返回3通道BGR格式的图像矩阵（OpenCV标准格式）；补充：cv2.IMREAD_GRAYSCALE为灰度图，cv2.IMREAD_UNCHANGED保留透明通道；</li> <li>异常兜底：解码失败（路径错误/文件损坏/非图片格式）会返回None，需主动抛出异常做兜底处理。</li> </ul> <h3 data-id="heading-10">三、核心底层原理：OpenCV的图像矩阵 = Numpy多维数组</h3> <p>这是开发中最易混淆、也是最核心的知识点，也是解答「为什么可以用Numpy的深拷贝」的关键，无例外的Python-OpenCV底层设计规则：</p> <div class="tip"> <strong>在Python版本的OpenCV中，所有的图像数据，都是以「Numpy多维数组(numpy.ndarray)」的形式存在和流转的。</strong> </div> <h4 data-id="heading-11">3.1 直观验证</h4> <p>对解码后的图像执行类型和维度校验，结果一目了然：</p> <pre><code class="hljs language-lua" lang="lua"><span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(<span class="hljs-built_in">self</span>.original_image)) # 输出：&lt;class <span class="hljs-string">'numpy.ndarray'</span>&gt; <span class="hljs-built_in">print</span>(<span class="hljs-built_in">self</span>.original_image.shape) # 输出：(图片高度, 图片宽度, 通道数)</code></pre> <h4 data-id="heading-12">3.2 关键结论</h4> <ul> <li>OpenCV没有自己独立的图像数据类型，所有图像操作本质都是对Numpy数组的操作；</li> <li>无论是cv2.imdecode解码的图像、cv2.imread读取的图像、还是cv2.resize处理后的图像，返回值都是Numpy数组；</li> <li>所有Numpy的数组操作（切片、拷贝、维度变换）都可以直接作用于OpenCV图像矩阵，二者无缝衔接。</li> </ul> <h3 data-id="heading-13">四、图像深拷贝的必要性与实现（绝对避坑点）</h3> <h4 data-id="heading-14">4.1 业务代码中的核心拷贝逻辑</h4> <pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">self.current_image</span> = self.original_image.copy()</code></pre> <p>这行代码是图片浏览器的灵魂代码，也是最容易被新手写错的地方，核心结论：</p> <div class="tip"> ✔️ 该行代码中的.copy()是Numpy数组原生的深拷贝方法；<br/> ✔️ 该操作实现的是「完全深拷贝」，新数组拥有独立的内存空间，与原数组无任何引用关系；<br/> ✔️ 这是保护原图不被修改的唯一正确方式。 </div> <h4 data-id="heading-15">4.2 两种赋值方式的天壤之别</h4> <div class="warning"> <strong>❌ 错误写法：浅引用（无拷贝，绝对禁止）</strong><br/> <code>self.current_image = self.original_image</code><br/> 这不是拷贝，只是变量的引用赋值，两个变量指向同一块内存地址。此时对self.current_image做任何修改（缩放、画框、裁剪），都会同步修改self.original_image，导致「原图被污染」，用户永远无法恢复原图，是图片处理程序的致命bug。 </div> <div class="tip"> <strong>✅ 正确写法：深拷贝（完全拷贝，唯一推荐）</strong><br/> <code>self.current_image = self.original_image.copy()</code><br/> Numpy数组的.copy()方法会创建一个全新的数组，拷贝原始图像的所有像素数据，新数组拥有独立的内存空间。修改self.current_image的任何像素、尺寸，都不会对self.original_image产生任何影响，完美实现「原图只读、工作图可写」的业务诉求。 </div> <h4 data-id="heading-16">4.3 深拷贝的业务价值</h4> <ul> <li>原图永远作为「底图」，支持用户随时点击「重置图片」恢复原始状态；</li> <li>工作图可以任意进行缩放、平移、标注等操作，无需担心影响原图；</li> <li>内存隔离，避免数据混乱，保证程序逻辑的稳定性。</li> </ul> <h3 data-id="heading-17">五、图片等比例撑满画布的核心缩放算法（黄金公式）</h3> <h4 data-id="heading-18">5.1 核心业务需求</h4> <p>图片缩放的第一优先级永远是：保证图片完整显示，不裁剪、不变形；第二优先级是：尽可能撑满显示容器，提升视觉体验。这也是所有图片查看器（系统相册、Photoshop、画图工具）的默认缩放逻辑。</p> <h4 data-id="heading-19">5.2 核心缩放算法实现</h4> <pre><code class="hljs language-rust" lang="rust">def <span class="hljs-title function_ invoke__">calculate_fill_scale</span>(<span class="hljs-keyword">self</span>, display_width=<span class="hljs-literal">None</span>, display_height=<span class="hljs-literal">None</span>): <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.current_image is <span class="hljs-literal">None</span>: <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> not display_width or not display_height: <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> display_width &lt; <span class="hljs-number">100</span> or display_height &lt; <span class="hljs-number">100</span>: <span class="hljs-keyword">return</span> h, w = <span class="hljs-keyword">self</span>.current_image.shape[:<span class="hljs-number">2</span>] # 获取图片真实宽高（高在前，宽在后） scale_x = display_width / w # 宽度方向的适配比例 scale_y = display_height / h # 高度方向的适配比例 <span class="hljs-keyword">self</span>.scale_factor = <span class="hljs-title function_ invoke__">min</span>(scale_x, scale_y) # 核心公式：取最小比例 event_bus.<span class="hljs-title function_ invoke__">publish</span>(<span class="hljs-string">"SCALE_UPDATED"</span>, scale=<span class="hljs-title function_ invoke__">int</span>(<span class="hljs-keyword">self</span>.scale_factor*<span class="hljs-number">100</span>)) event_bus.<span class="hljs-title function_ invoke__">publish</span>(<span class="hljs-string">"REQUEST_RENDER"</span>)</code></pre> <h4 data-id="heading-20">5.3 黄金公式解析：self.scale_factor = min(scale_x, scale_y)</h4> <p>这是图片等比例缩放的核心精髓，该公式的设计逻辑完美兼顾两个优先级：</p> <ul> <li>取两个方向的最小缩放比例，可以保证图片在「宽度、高度」两个维度都能完整适配画布，不会出现任何溢出和裁剪；</li> <li>该公式对「大图」和「小图」的处理是完全对称且自适应的： <ul> <li>当图片尺寸 &gt; 画布尺寸：计算出&lt; 1的缩放比例，图片被等比例缩小，撑满画布且无溢出；</li> <li>当图片尺寸 &lt; 画布尺寸：计算出&gt; 1的缩放比例，图片被等比例放大，撑满画布且无变形。</li> </ul> </li> </ul> <h4 data-id="heading-21">5.4 关键细节：为什么shape[0]是高度，shape[1]是宽度？</h4> <p>因为Numpy数组是行优先存储，图片的每一行对应数组的一个维度，shape属性返回的元组遵循固定规范：</p> <pre><code class="hljs language-scss" lang="scss">彩色图：(图片高度, 图片宽度, 通道数) → (h, w, <span class="hljs-number">3</span>) 灰度图：(图片高度, 图片宽度) → (h, w)</code></pre> <p>这是OpenCV+Numpy的固定规范，无需纠结，记住即可。</p> <h3 data-id="heading-22">六、关键健壮性判断解析：if display_width &lt; 100 or display_height &lt; 100</h3> <h4 data-id="heading-23">6.1 最常见的误区纠正</h4> <div class="tip"> <strong>重中之重</strong><br/> ✔️ 该判断的是「显示容器(画布)的尺寸」，不是「图片本身的尺寸」；<br/> ✔️ 哪怕图片真实尺寸只有50x50像素（超小图），也完全不受该判断的影响；<br/> ✔️ 该判断的变量display_width/display_height是图片的展示窗口/控件尺寸，而非self.current_image.shape的图片尺寸。 </div> <h4 data-id="heading-24">6.2 该判断的三大核心作用（缺一不可的工业级健壮性设计）</h4> <p>这行代码不是多余的，而是防止程序崩溃、避免无效计算、节省性能的关键，是从「demo级代码」到「生产级代码」的必经之路，优先级从高到低：</p> <ul> <li><strong>作用1：规避除零异常与浮点计算精度问题（核心）</strong>：程序运行时，画布尺寸可能为0或极小值，会导致缩放比例异常、渲染失败甚至程序闪退。</li> <li><strong>作用2：规避无意义的极端缩放比例</strong>：画布过小会计算出极小的缩放比例，图片缩到几乎看不见，无业务意义。100像素是合理的最小有效显示阈值。</li> <li><strong>作用3：节省无意义的性能开销</strong>：图片缩放和渲染是CPU密集型操作，画布过小时跳过计算，提升程序流畅度。</li> </ul> <h4 data-id="heading-25">6.3 小尺寸图片的处理逻辑（核心顾虑解答）</h4> <p><strong>结论：小尺寸图片会被正常处理，无任何影响！</strong></p> <p>举个例子：图片尺寸80x90像素，画布尺寸800x600像素，判断条件为False，程序正常执行缩放计算：scale_x=800/80=10.0，scale_y=600/90≈6.666，最终缩放比例为6.666，图片被等比例放大6.666倍，完美适配画布。</p> <h3 data-id="heading-26">七、发布订阅模式（事件总线）的解耦应用</h3> <p>本文代码中大量使用<code>event_bus.publish()</code>发布事件，这是工程化开发的最佳实践，核心价值是彻底解耦业务逻辑与UI更新：</p> <ul> <li>业务层（图片加载、缩放计算）只负责处理核心逻辑，无需关心「UI如何更新、哪些控件需要刷新」；</li> <li>UI层只需订阅对应的事件，事件触发时执行更新逻辑即可；</li> <li>新增功能时，只需新增事件订阅者，无需修改原有业务代码，完美符合「开闭原则」。</li> </ul> <p>核心发布的事件及作用：</p> <ul> <li>LOAD_IMAGE_PATH：通知文件夹服务加载当前图片所在文件夹；</li> <li>IMAGE_LOADED：图片加载完成，携带图片元信息，更新UI的图片信息展示；</li> <li>REQUEST_CALCULATE_FILL_SCALE：请求计算自适应缩放比例；</li> <li>SCALE_UPDATED：缩放比例更新，同步UI的缩放滑块和标签；</li> <li>REQUEST_RENDER：请求重绘图片，更新画布展示；</li> <li>ERROR_OCCURRED：捕获异常，展示错误提示。</li> </ul> <h3 data-id="heading-27">八、核心避坑点与最佳实践汇总</h3> <h4 data-id="heading-28">核心避坑点（开发中必踩，记牢即可）</h4> <ul> <li>不要使用cv2.imread()加载中文路径的图片，必出问题；</li> <li>不要直接赋值self.current_image = self.original_image，会导致原图被污染；</li> <li>不要用max(scale_x, scale_y)做缩放比例，会导致图片溢出画布被裁剪；</li> <li>不要混淆「画布尺寸」和「图片尺寸」，display_width &lt;100判断的是画布不是图片；</li> <li>不要忽略cv2.imdecode的返回值校验，解码失败会返回None，必抛异常。</li> </ul> <h4 data-id="heading-29">最佳实践（生产级代码规范，直接复用）</h4> <ul> <li>图片加载必用np.fromfile + cv2.imdecode黄金组合，兼容中文路径；</li> <li>原图与工作图必用numpy.copy()做深拷贝，保证内存隔离；</li> <li>等比例缩放必用min(scale_x, scale_y)黄金公式，兼顾完整显示与撑满画布；</li> <li>所有外部传入的参数必做合法性校验，避免异常；</li> <li>核心业务逻辑必加try-except异常捕获，友好兜底；</li> <li>业务与UI必用事件总线解耦，提升代码扩展性。</li> </ul> <h3 data-id="heading-30">总结</h3> <p>本文围绕Python+OpenCV实现图片浏览器的核心功能，深度解析了从「图片加载」到「缩放渲染」的全流程技术细节，核心知识点可总结为以下5点：</p> <ol> <li>OpenCV加载图片的最优解是np.fromfile + cv2.imdecode，解决中文路径问题，返回值为Numpy数组；</li> <li>Python中OpenCV的图像矩阵本质就是Numpy多维数组，所有Numpy操作均可直接作用于图像；</li> <li>图像深拷贝是保护原图的唯一方式，numpy.copy()是最优实现，浅引用绝对禁止；</li> <li>图片等比例缩放的核心是min(scale_x, scale_y)，完美兼顾完整显示与撑满画布；</li> <li>工业级代码的核心是「健壮性」，所有边界条件都要做校验，避免程序崩溃。</li> </ol> <p>这些知识点并非孤立存在，而是贯穿于所有Python+OpenCV的图像可视化开发中，掌握这些细节，不仅能写出稳定的图片浏览器，更能应对各类图像处理的实战场景。技术的深度，往往体现在对这些细节的理解与把控中。</p>  技术博客 | Python+OpenCV 图片浏览器核心解析 | 完   </div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🌟 JavaScript 数组终极指南：从零基础到工程级实战]]></title>    <link>https://juejin.cn/post/7594785614178353192</link>    <guid>https://juejin.cn/post/7594785614178353192</guid>    <pubDate>2026-01-14T10:24:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594785614178353192" data-draft-id="7594835618120679464" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🌟 JavaScript 数组终极指南：从零基础到工程级实战"/> <meta itemprop="keywords" content="前端,JavaScript,前端框架"/> <meta itemprop="datePublished" content="2026-01-14T10:24:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yira"/> <meta itemprop="url" content="https://juejin.cn/user/262123324974122"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🌟 JavaScript 数组终极指南：从零基础到工程级实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/262123324974122/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yira
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T10:24:53.000Z" title="Wed Jan 14 2026 10:24:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🌟 JavaScript 数组终极指南：从零基础到工程级实战</h2>
<p>在 JavaScript 的世界里，<strong>数组（Array）</strong>  不仅仅是一个“装东西的盒子”，它是一种高度灵活、功能强大、可扩展的数据结构。无论是处理用户列表、管理购物车商品、解析 API 返回数据，还是实现复杂算法，都离不开数组。</p>
<p>本文将带你<strong>彻底搞懂 JavaScript 数组</strong>——包括它的本质、创建方式、核心特性、常用方法、性能注意事项、常见陷阱，以及在现代开发中的最佳实践。</p>
<hr/>
<h3 data-id="heading-1">一、JavaScript 中到底有没有“真正的”数组？</h3>
<p>这是一个常被误解的问题。</p>
<h4 data-id="heading-2">✅ 答案：有，但和传统语言不同</h4>
<p>在 C/C++、Java 等静态语言中，数组是：</p>
<ul>
<li><strong>连续内存块</strong></li>
<li><strong>固定长度</strong></li>
<li><strong>同类型元素</strong></li>
</ul>
<p>而 JavaScript 的数组是：</p>
<ul>
<li><strong>基于对象（Object）实现的特殊对象</strong></li>
<li><strong>动态长度</strong></li>
<li><strong>可存储任意类型混合数据</strong></li>
<li><strong>支持稀疏结构（即索引不连续）</strong></li>
</ul>
<blockquote>
<p>🔍 技术细节：<br/>
在 V8 引擎（Chrome/Node.js 使用）中，JavaScript 数组会根据内容自动选择两种内部表示：</p>
<ul>
<li><strong>Fast Elements（快速元素）</strong> ：当数组是密集、类型一致时，使用类似 C 数组的连续内存优化。</li>
<li><strong>Dictionary Elements（字典元素）</strong> ：当数组稀疏或类型混杂时，退化为哈希表存储，性能下降。</li>
</ul>
</blockquote>
<p>因此，虽然 JS 数组“看起来像”传统数组，但其底层更接近“带数字键的对象”。</p>
<hr/>
<h3 data-id="heading-3">二、如何创建数组？四种方式详解</h3>
<h4 data-id="heading-4">1. <strong>数组字面量（推荐 ✅）</strong></h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-string">'hello'</span>, <span class="hljs-literal">true</span>]<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>最简洁、最高效</li>
<li>自动推断长度</li>
<li>支持尾随逗号（利于 Git diff）</li>
</ul>
<h4 data-id="heading-5">2. <strong>Array 构造函数（谨慎使用 ⚠️）</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传入多个参数 → 创建包含这些元素的数组</span>
<span class="hljs-keyword">const</span> a1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>); <span class="hljs-comment">// [1, 2, 3]</span>

<span class="hljs-comment">// 传入单个数字 → 创建指定长度的空数组（⚠️陷阱！）</span>
<span class="hljs-keyword">const</span> a2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// [empty × 5]，不是 [5]！</span>
</code></pre>
<blockquote>
<p>❗ 危险点：<code>new Array(3)</code> 不等于 <code>[3]</code>，前者是长度为 3 的空数组，后者是包含数字 3 的数组。</p>
</blockquote>
<h4 data-id="heading-6">3. <strong>Array.of()（安全替代构造函数）</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Array</span>.<span class="hljs-title function_">of</span>(<span class="hljs-number">5</span>);        <span class="hljs-comment">// [5]</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">of</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);  <span class="hljs-comment">// [1, 2, 3]</span>
</code></pre>
<ul>
<li>无论传几个参数，都作为元素放入数组</li>
<li>解决 <code>new Array(n)</code> 的歧义问题</li>
</ul>
<h4 data-id="heading-7">4. <strong>Array.from()（从类数组或可迭代对象创建）</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 从字符串</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-string">'abc'</span>); <span class="hljs-comment">// ['a', 'b', 'c']</span>

<span class="hljs-comment">// 从 NodeList</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'div'</span>));

<span class="hljs-comment">// 从 Set</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>])); <span class="hljs-comment">// [1, 2]</span>

<span class="hljs-comment">// 带映射函数</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">3</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i * <span class="hljs-number">2</span>); <span class="hljs-comment">// [0, 2, 4]</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">三、数组的核心属性与判断方法</h3>
<h4 data-id="heading-9">1. <code>length</code> 属性</h4>
<ul>
<li>可读可写</li>
<li>表示“最大整数索引 + 1”，不是实际元素个数（稀疏数组时尤其注意）</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">arr</span> = []<span class="hljs-comment">;</span>
arr<span class="hljs-section">[99]</span> = 'last'<span class="hljs-comment">;</span>
console.log(arr.length)<span class="hljs-comment">; // 100</span>
console.log(Object.keys(arr).length)<span class="hljs-comment">; // 1（实际只有1个元素）</span>
</code></pre>
<h4 data-id="heading-10">2. 如何判断一个变量是数组？</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误方式</span>
<span class="hljs-keyword">typeof</span> []; <span class="hljs-comment">// "object"</span>

<span class="hljs-comment">// ✅ 正确方式</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>([]); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 兼容旧浏览器（不推荐）</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>([]) === <span class="hljs-string">'[object Array]'</span>;
</code></pre>
<hr/>
<h3 data-id="heading-11">四、数组操作全景图（按功能分类）</h3>
<h4 data-id="heading-12">A. <strong>增删改查（CRUD）</strong></h4>
<p>表格</p>















































<table><thead><tr><th>操作</th><th>方法</th><th>是否修改原数组</th><th>返回值</th></tr></thead><tbody><tr><td>末尾添加</td><td><code>push()</code></td><td>✅ 是</td><td>新长度</td></tr><tr><td>开头添加</td><td><code>unshift()</code></td><td>✅ 是</td><td>新长度</td></tr><tr><td>末尾删除</td><td><code>pop()</code></td><td>✅ 是</td><td>被删元素</td></tr><tr><td>开头删除</td><td><code>shift()</code></td><td>✅ 是</td><td>被删元素</td></tr><tr><td>任意位置增删</td><td><code>splice(start, deleteCount, ...items)</code></td><td>✅ 是</td><td>被删元素组成的数组</td></tr><tr><td>替换/插入（不修改原数组）</td><td><code>toSpliced()</code>（ES2023）</td><td>❌ 否</td><td>新数组</td></tr></tbody></table>
<blockquote>
<p>💡 示例：</p>
<pre><code class="hljs language-css" lang="css">const arr = <span class="hljs-selector-attr">[1, 2, 3]</span>;
arr<span class="hljs-selector-class">.splice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, '<span class="hljs-selector-tag">a</span>', '<span class="hljs-selector-tag">b</span>'); // 从索引<span class="hljs-number">1</span>删<span class="hljs-number">1</span>个，插入'<span class="hljs-selector-tag">a</span>','<span class="hljs-selector-tag">b</span>'
console<span class="hljs-selector-class">.log</span>(arr); // <span class="hljs-selector-attr">[1, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, 3]</span>
</code></pre>
</blockquote>
<hr/>
<h4 data-id="heading-13">B. <strong>遍历与转换（函数式编程核心）</strong></h4>
<p>表格</p>















































<table><thead><tr><th>方法</th><th>用途</th><th>是否修改原数组</th><th>返回值</th></tr></thead><tbody><tr><td><code>forEach()</code></td><td>遍历执行副作用</td><td>❌</td><td>undefined</td></tr><tr><td><code>map()</code></td><td>映射新值</td><td>❌</td><td>新数组</td></tr><tr><td><code>filter()</code></td><td>过滤符合条件的</td><td>❌</td><td>新数组</td></tr><tr><td><code>reduce()</code></td><td>聚合计算（求和、扁平化等）</td><td>❌</td><td>累积值</td></tr><tr><td><code>find()</code> / <code>findIndex()</code></td><td>查找第一个匹配项</td><td>❌</td><td>元素 / 索引</td></tr><tr><td><code>some()</code> / <code>every()</code></td><td>判断是否存在 / 是否全部满足</td><td>❌</td><td>布尔值</td></tr></tbody></table>
<blockquote>
<p>🧠 关键区别：</p>
<ul>
<li><code>map</code> 必须返回新值，用于<strong>转换</strong></li>
<li><code>forEach</code> 用于<strong>执行操作</strong>（如 DOM 更新、日志），不返回有用值</li>
</ul>
</blockquote>
<hr/>
<h4 data-id="heading-14">C. <strong>搜索与判断</strong></h4>
<pre><code class="hljs language-scss" lang="scss">const nums = <span class="hljs-selector-attr">[10, 20, 30]</span>;

nums<span class="hljs-selector-class">.indexOf</span>(<span class="hljs-number">20</span>);      <span class="hljs-comment">// 1（找不到返回 -1）</span>
nums<span class="hljs-selector-class">.lastIndexOf</span>(<span class="hljs-number">20</span>);  <span class="hljs-comment">// 1（从后往前找）</span>

nums<span class="hljs-selector-class">.includes</span>(<span class="hljs-number">20</span>);     <span class="hljs-comment">// true（ES2016，更语义化）</span>

<span class="hljs-comment">// 支持 NaN</span>
<span class="hljs-selector-attr">[NaN]</span><span class="hljs-selector-class">.includes</span>(NaN);   <span class="hljs-comment">// true</span>
<span class="hljs-selector-attr">[NaN]</span><span class="hljs-selector-class">.indexOf</span>(NaN);    <span class="hljs-comment">// -1（因 NaN !== NaN）</span>
</code></pre>
<hr/>
<h4 data-id="heading-15">D. <strong>连接、切片与复制</strong></h4>
<p>表格</p>

























<table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>concat()</code></td><td>合并多个数组或值，返回新数组</td></tr><tr><td><code>slice(start, end)</code></td><td>截取子数组（end 不包含），返回新数组</td></tr><tr><td><code>[...arr]</code></td><td>展开运算符，浅拷贝数组</td></tr><tr><td><code>Array.from(arr)</code></td><td>浅拷贝（也可用于类数组）</td></tr></tbody></table>
<blockquote>
<p>⚠️ 注意：以上均为<strong>浅拷贝</strong>！嵌套对象仍共享引用。</p>
</blockquote>
<hr/>
<h4 data-id="heading-16">E. <strong>排序与反转</strong></h4>
<pre><code class="hljs language-css" lang="css">const letters = <span class="hljs-selector-attr">[<span class="hljs-string">'c'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>]</span>;

letters<span class="hljs-selector-class">.sort</span>();        // <span class="hljs-selector-attr">[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>]</span>（✅ 修改原数组！）
letters<span class="hljs-selector-class">.reverse</span>();     // <span class="hljs-selector-attr">[<span class="hljs-string">'c'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>]</span>（✅ 修改原数组！）

// 数字排序需传比较函数
<span class="hljs-selector-attr">[10, 2, 30]</span><span class="hljs-selector-class">.sort</span>((<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>) =&gt; <span class="hljs-selector-tag">a</span> - <span class="hljs-selector-tag">b</span>); // <span class="hljs-selector-attr">[2, 10, 30]</span>
</code></pre>
<blockquote>
<p>❗ 重要：<code>sort()</code> 和 <code>reverse()</code> <strong>会直接修改原数组</strong>，若需保留原数据，先复制再操作。</p>
</blockquote>
<hr/>
<h3 data-id="heading-17">五、高级技巧与工程实践</h3>
<h4 data-id="heading-18">1. <strong>不可变性（Immutability）原则</strong></h4>
<p>在 React、Redux 等现代框架中，强调“不直接修改状态”。因此应避免 <code>push</code>、<code>splice</code> 等方法，改用：</p>
<pre><code class="hljs language-ini" lang="ini">// ❌ 不推荐（修改原数组）
state.items.push(newItem)<span class="hljs-comment">;</span>

// ✅ 推荐（返回新数组）
const <span class="hljs-attr">newItems</span> = [...state.items, newItem]<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-19">2. <strong>扁平化嵌套数组</strong></h4>
<pre><code class="hljs language-scss" lang="scss">const nested = <span class="hljs-selector-attr">[1, [2, [3, [4]</span>]]];

nested<span class="hljs-selector-class">.flat</span>();        <span class="hljs-comment">// [1, 2, [3, [4]]]</span>
nested<span class="hljs-selector-class">.flat</span>(<span class="hljs-number">2</span>);       <span class="hljs-comment">// [1, 2, 3, [4]]</span>
nested<span class="hljs-selector-class">.flat</span>(Infinity); <span class="hljs-comment">// [1, 2, 3, 4]（彻底扁平化）</span>

<span class="hljs-comment">// 或用 reduce 递归实现</span>
</code></pre>
<h4 data-id="heading-20">3. <strong>去重（Deduplication）</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基本类型去重</span>
<span class="hljs-keyword">const</span> unique = [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])]; <span class="hljs-comment">// [1, 2, 3]</span>

<span class="hljs-comment">// 对象数组去重（按 id）</span>
<span class="hljs-keyword">const</span> users = [{<span class="hljs-attr">id</span>:<span class="hljs-number">1</span>}, {<span class="hljs-attr">id</span>:<span class="hljs-number">2</span>}, {<span class="hljs-attr">id</span>:<span class="hljs-number">1</span>}];
<span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
<span class="hljs-keyword">const</span> uniqueUsers = users.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (seen.<span class="hljs-title function_">has</span>(user.<span class="hljs-property">id</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  seen.<span class="hljs-title function_">add</span>(user.<span class="hljs-property">id</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
});
</code></pre>
<h4 data-id="heading-21">4. <strong>性能建议</strong></h4>
<ul>
<li>避免频繁在数组开头 <code>unshift</code>/<code>shift</code>（时间复杂度 O(n)）</li>
<li>大量数据处理优先用 <code>for</code> 循环（比 <code>forEach</code> 快），但牺牲可读性</li>
<li>稀疏数组慎用，可能触发引擎降级到字典模式</li>
</ul>
<hr/>
<h3 data-id="heading-22">六、常见误区与陷阱</h3>
<h4 data-id="heading-23">❌ 误区 1：<code>[] == false</code> 所以数组是假值？</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">Boolean</span>([]); <span class="hljs-comment">// true！空数组是真值</span>
if ([]) console<span class="hljs-selector-class">.log</span>('yes'); <span class="hljs-comment">// 会执行</span>
</code></pre>
<blockquote>
<p>原因：所有对象（包括空数组、空对象）在布尔上下文中都是 <code>true</code>。</p>
</blockquote>
<h4 data-id="heading-24">❌ 误区 2：<code>arr.length = 0</code> 会清空数组？</h4>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">a</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<span class="hljs-comment">;</span>
let <span class="hljs-attr">b</span> = a<span class="hljs-comment">;</span>
<span class="hljs-attr">a.length</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
console.log(b)<span class="hljs-comment">; // [] —— 因为 a 和 b 指向同一引用！</span>
</code></pre>
<h4 data-id="heading-25">❌ 误区 3：<code>delete arr[1]</code> 会缩短数组？</h4>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<span class="hljs-comment">;</span>
delete arr<span class="hljs-section">[1]</span><span class="hljs-comment">;</span>
console.log(arr)<span class="hljs-comment">;        // [1, empty, 3]</span>
console.log(arr.length)<span class="hljs-comment">; // 3（长度不变！）</span>
</code></pre>
<blockquote>
<p>正确做法：用 <code>splice(1, 1)</code> 删除并收缩数组。</p>
</blockquote>
<hr/>
<h3 data-id="heading-26">七、总结：数组使用心法</h3>
<p>表格</p>





































<table><thead><tr><th>场景</th><th>推荐方法</th></tr></thead><tbody><tr><td>添加元素</td><td><code>push</code>（末尾）、<code>...</code> + <code>concat</code>（不可变）</td></tr><tr><td>删除元素</td><td><code>filter</code>（不可变）、<code>splice</code>（可变）</td></tr><tr><td>遍历处理</td><td><code>map</code>（转换）、<code>forEach</code>（副作用）</td></tr><tr><td>条件筛选</td><td><code>filter</code>、<code>find</code>、<code>some</code></td></tr><tr><td>聚合计算</td><td><code>reduce</code></td></tr><tr><td>安全复制</td><td><code>[...arr]</code>、<code>Array.from(arr)</code></td></tr><tr><td>判断类型</td><td><code>Array.isArray()</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-27">八、动手练习（巩固理解）</h3>
<ol>
<li>将字符串 <code>'the quick brown fox'</code> 转为每个单词首字母大写：<code>'The Quick Brown Fox'</code></li>
<li>找出数组中重复的元素：<code>[1, 2, 2, 3, 4, 4]</code> → <code>[2, 4]</code></li>
<li>实现一个 <code>chunk</code> 函数，将数组每 3 个分一组：<code>[1,2,3,4,5]</code> → <code>[[1,2,3], [4,5]]</code></li>
</ol>
<blockquote>
<p>💡 提示：多用 <code>map</code>、<code>reduce</code>、<code>Set</code> 组合解决！</p>
</blockquote>
<hr/>
<h3 data-id="heading-28">结语</h3>
<p>JavaScript 数组看似简单，实则博大精深。它既是新手入门的第一道关卡，也是高手优化性能的关键战场。<strong>理解其本质、掌握其方法、避开其陷阱</strong>，你就能在任何 JavaScript 项目中游刃有余。</p>
<blockquote>
<p>📚 建议收藏本文，作为日常开发的“数组速查手册”。</p>
</blockquote>
<p>如果你希望我针对某个方法（比如 <code>reduce</code> 的 10 种用法）做专题详解，欢迎继续提问！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还在申请云服务器来传输数据嘛？试试P2P直连吧]]></title>    <link>https://juejin.cn/post/7595043440519544838</link>    <guid>https://juejin.cn/post/7595043440519544838</guid>    <pubDate>2026-01-14T10:29:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595043440519544838" data-draft-id="7594791357144219690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还在申请云服务器来传输数据嘛？试试P2P直连吧"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2026-01-14T10:29:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐叔在学习"/> <meta itemprop="url" content="https://juejin.cn/user/4009253326568761"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还在申请云服务器来传输数据嘛？试试P2P直连吧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4009253326568761/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐叔在学习
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T10:29:16.000Z" title="Wed Jan 14 2026 10:29:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本篇文章是最近开发「Todo-List」应用的 <code>P2P</code> 数据传输功能的经验分享！</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>一般用户与用户间的数据交互是咋样的呢？</p>
<p>用户A要发送数据给用户B，那么用户A需要先将数据发送给服务器，服务器接收数据并存储后，再中转给用户B。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph A [C/S 模式]
        direction TB
        S[&lt;b&gt;中央服务器&lt;/b&gt;&lt;br&gt;唯一数据源与逻辑中心] &lt;-- &lt;b&gt;数据传输&lt;/b&gt; --&gt; C1[客户端A]
        S &lt;-- &lt;b&gt;数据传输&lt;/b&gt; --&gt; C2[客户端B]
        S &lt;-- &lt;b&gt;数据传输&lt;/b&gt; --&gt; C3[...]
        style S fill:#ffcccc
    end
</code></pre>
<p>也就是经典的「客户端-服务器」模式。</p>
<p>这种方式最常见于各种商业化运作的企业，可以有效管理和掌控用户数据。但相对于个体开发者应用反倒可能是劣势。</p>
<ul>
<li>
<p>有些个体开发者应用并不需要用户间经常性的数据交互，那么要为此配置一台24h在线的服务器做交互，还是有点成本的；</p>
</li>
<li>
<p>另外，如果采用这种模式，数据交互的稳定性很大程度上取决于服务器资源和带宽，服务器挂了，整个交互就瘫痪了。</p>
</li>
</ul>
<p>可能有人会问：可不可以不经过服务器，直接用户和用户之间进行交互呢？这就是今天要介绍的 <code>P2P</code> 模式。</p>
<hr/>
<p><strong>P2P传输（Peer-to-Peer，点对点传输）</strong> 无需依赖中心服务器进行中转或调度，<strong>参与者之间直接共享资源</strong>。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph A [P2P 模式]
        direction TB
        P1[参与者A&lt;br&gt;兼具客户端与服务端功能] &lt;--&gt; P2[参与者B&lt;br&gt;兼具客户端与服务端功能]
        P2 &lt;--&gt; P3[...]
        P3 &lt;--&gt; P1
    end
</code></pre>
<p>通过这种无中心化的方式，不再依赖任何单一节点，从个体开发者来说，开发和维护非单机简单应用，成本可以是0的。</p>
<p>就以我最近开发的「Todo-List」应用为例，数据基本是单机应用数据，唯一需要进行交互的就桌面端应用和手机端应用的数据同步，完全可以采用这种模式进行数据同步的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dec48ced7769495b8580f83addac0968~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ5Y-U5Zyo5a2m5Lmg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991356&amp;x-signature=ZJoc1z%2BkbwoTSPFGecYgfXTILZU%3D" alt="P2P效果封面.png" loading="lazy"/></p>
<p>目前打通了局域网 <code>P2P</code> 数据传输问题，还在考虑端口要不要持续保持开启状态，从而实现两端自动化数据同步；以及实现内网穿透，在公网也能进行数据传输(这个有点上难度，尤其是国内多层NAT的情况下)……</p>
<hr/>
<h2 data-id="heading-1">交互逻辑</h2>
<p>来说说具体实现吧——局域网内的 <code>P2P</code> 大体的交互是这样的：</p>
<p>存在P2P服务器端分享数据，P2P客户端接收数据</p>
<ul>
<li>
<p>P2P服务器在局域网内暴露端口号和 <code>IP</code></p>
</li>
<li>
<p>P2P客户端扫描局域网内暴露指定端口号的设备，并发现P2P服务器</p>
</li>
<li>
<p>P2P客户端和P2P服务器建立连接，并进行数据传输</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e51674539d479d86fe2b6ec8838d3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ5Y-U5Zyo5a2m5Lmg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991356&amp;x-signature=R9cDfRpmzZZEY4cW7okjryLgZNM%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">代码实现</h2>
<p>代码实现的话，在理解思路后其实可以使用 <code>AI</code> 辅助编码的。这里提供「Todo-List」基于 <code>AI</code> 精简后的 <code>python</code> 版本代码实现。</p>
<h3 data-id="heading-3">p2p_server</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
P2P服务器模块 - 负责监听并共享数据
精简版本：移除防火墙管理，专注于核心监听和共享功能
"""</span>
<span class="hljs-keyword">import</span> socket
<span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> struct
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">Tuple</span>, <span class="hljs-type">Callable</span>, <span class="hljs-type">Any</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">P2PServer</span>:
    <span class="hljs-string">"""P2P服务器，用于在局域网内共享数据"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, port: <span class="hljs-built_in">int</span> = <span class="hljs-number">5000</span></span>):
        <span class="hljs-string">"""
        初始化P2P服务器

        Args:
            port: 监听端口，默认5000
        """</span>
        self.port = port
        self.server_socket: <span class="hljs-type">Optional</span>[socket.socket] = <span class="hljs-literal">None</span>
        self.is_running = <span class="hljs-literal">False</span>
        self.on_data_request_callback: <span class="hljs-type">Optional</span>[<span class="hljs-type">Callable</span>] = <span class="hljs-literal">None</span>

        <span class="hljs-comment"># 数据共享函数（默认返回空数据）</span>
        self._shared_data = {}

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>(<span class="hljs-params">self, shared_data: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">dict</span>] = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""
        启动P2P服务器

        Args:
            shared_data: 要共享的数据字典

        Returns:
            (是否成功, 消息) 元组
        """</span>
        <span class="hljs-keyword">if</span> self.is_running:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">"服务器已在运行中"</span>

        <span class="hljs-comment"># 设置共享数据</span>
        <span class="hljs-keyword">if</span> shared_data:
            self._shared_data = shared_data

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 创建TCP服务器socket</span>
            self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            self.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)
            self.server_socket.bind((<span class="hljs-string">'0.0.0.0'</span>, self.port))
            self.server_socket.listen(<span class="hljs-number">5</span>)  <span class="hljs-comment"># 最多5个等待连接</span>
            self.is_running = <span class="hljs-literal">True</span>

            <span class="hljs-comment"># 启动监听线程</span>
            listen_thread = threading.Thread(
                target=self._listen_for_connections,
                daemon=<span class="hljs-literal">True</span>
            )
            listen_thread.start()

            local_ip = self.get_local_ip()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P服务器] ✓ 服务器启动成功"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P服务器]   监听地址: 0.0.0.0:<span class="hljs-subst">{self.port}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P服务器]   本机IP: <span class="hljs-subst">{local_ip}</span>"</span>)

            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-string">f"服务器启动成功，本机IP: <span class="hljs-subst">{local_ip}</span>"</span>

        <span class="hljs-keyword">except</span> OSError <span class="hljs-keyword">as</span> e:
            error_msg = <span class="hljs-string">f"端口 <span class="hljs-subst">{self.port}</span> 被占用: <span class="hljs-subst">{e}</span>"</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P服务器] ✗ <span class="hljs-subst">{error_msg}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, error_msg
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            error_msg = <span class="hljs-string">f"服务器启动失败: <span class="hljs-subst">{e}</span>"</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P服务器] ✗ <span class="hljs-subst">{error_msg}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, error_msg

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">set_data_request_callback</span>(<span class="hljs-params">self, callback: <span class="hljs-type">Callable</span></span>):
        <span class="hljs-string">"""
        设置数据请求回调函数

        Args:
            callback: 当收到数据请求时调用的函数，返回要共享的数据字典
        """</span>
        self.on_data_request_callback = callback

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">set_shared_data</span>(<span class="hljs-params">self, data: <span class="hljs-built_in">dict</span></span>):
        <span class="hljs-string">"""
        设置要共享的数据

        Args:
            data: 要共享的数据字典
        """</span>
        self._shared_data = data
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P服务器] 共享数据已更新: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(data)}</span> 项"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">stop</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""
        停止服务器

        Returns:
            (是否成功, 消息) 元组
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.is_running:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">"服务器未运行"</span>

        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P服务器] 正在停止服务器..."</span>)

        self.is_running = <span class="hljs-literal">False</span>

        <span class="hljs-keyword">if</span> self.server_socket:
            <span class="hljs-keyword">try</span>:
                self.server_socket.close()
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">pass</span>
            self.server_socket = <span class="hljs-literal">None</span>

        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P服务器] ✓ 服务器已停止"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-string">"服务器已停止"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_listen_for_connections</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""
        监听客户端连接（在独立线程中运行）
        """</span>
        <span class="hljs-keyword">while</span> self.is_running:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># 设置超时以便定期检查is_running</span>
                self.server_socket.settimeout(<span class="hljs-number">1.0</span>)
                client_socket, address = self.server_socket.accept()

                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P服务器] 收到来自 <span class="hljs-subst">{address[<span class="hljs-number">0</span>]}</span>:<span class="hljs-subst">{address[<span class="hljs-number">1</span>]}</span> 的连接"</span>)

                <span class="hljs-comment"># 为每个客户端创建处理线程</span>
                client_thread = threading.Thread(
                    target=self._handle_client,
                    args=(client_socket, address),
                    daemon=<span class="hljs-literal">True</span>
                )
                client_thread.start()

            <span class="hljs-keyword">except</span> socket.timeout:
                <span class="hljs-comment"># 超时正常，继续循环</span>
                <span class="hljs-keyword">continue</span>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">if</span> self.is_running:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P服务器] 接受连接错误: <span class="hljs-subst">{e}</span>"</span>)
                <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_handle_client</span>(<span class="hljs-params">self, client_socket: socket.socket, address: <span class="hljs-built_in">tuple</span></span>):
        <span class="hljs-string">"""
        处理客户端连接

        Args:
            client_socket: 客户端socket连接
            address: 客户端地址 (ip, port)
        """</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 接收数据长度头（4字节）</span>
            length_data = self._receive_all(client_socket, <span class="hljs-number">4</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> length_data:
                <span class="hljs-keyword">return</span>

            data_length = struct.unpack(<span class="hljs-string">'!I'</span>, length_data)[<span class="hljs-number">0</span>]

            <span class="hljs-comment"># 接收实际数据</span>
            data_bytes = self._receive_all(client_socket, data_length)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data_bytes:
                <span class="hljs-keyword">return</span>

            <span class="hljs-comment"># 解析JSON数据</span>
            data = json.loads(data_bytes.decode(<span class="hljs-string">'utf-8'</span>))
            data_type = data.get(<span class="hljs-string">'type'</span>, <span class="hljs-string">'unknown'</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P服务器] 收到 <span class="hljs-subst">{address[<span class="hljs-number">0</span>]}</span> 的请求: <span class="hljs-subst">{data_type}</span>"</span>)

            <span class="hljs-comment"># 处理数据请求</span>
            <span class="hljs-keyword">if</span> data_type == <span class="hljs-string">'request_data'</span>:
                <span class="hljs-comment"># 获取要共享的数据</span>
                <span class="hljs-keyword">if</span> self.on_data_request_callback:
                    shared_data = self.on_data_request_callback()
                <span class="hljs-keyword">else</span>:
                    shared_data = self._shared_data

                <span class="hljs-keyword">if</span> shared_data:
                    <span class="hljs-comment"># 发送共享数据</span>
                    self._send_data(client_socket, shared_data)
                    response = {<span class="hljs-string">'status'</span>: <span class="hljs-string">'success'</span>, <span class="hljs-string">'message'</span>: <span class="hljs-string">'数据发送成功'</span>}
                <span class="hljs-keyword">else</span>:
                    response = {<span class="hljs-string">'status'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-string">'message'</span>: <span class="hljs-string">'没有可共享的数据'</span>}

                <span class="hljs-comment"># 发送响应</span>
                self._send_response(client_socket, response)

            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 处理其他类型的数据</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P服务器] 收到 <span class="hljs-subst">{data_type}</span> 类型数据: <span class="hljs-subst">{data}</span>"</span>)
                response = {<span class="hljs-string">'status'</span>: <span class="hljs-string">'success'</span>, <span class="hljs-string">'message'</span>: <span class="hljs-string">'数据接收成功'</span>}
                self._send_response(client_socket, response)

        <span class="hljs-keyword">except</span> json.JSONDecodeError:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P服务器] 数据格式错误"</span>)
            response = {<span class="hljs-string">'status'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-string">'message'</span>: <span class="hljs-string">'数据格式错误'</span>}
            self._send_response(client_socket, response)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P服务器] 处理客户端错误: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">try</span>:
                response = {<span class="hljs-string">'status'</span>: <span class="hljs-string">'error'</span>, <span class="hljs-string">'message'</span>: <span class="hljs-built_in">str</span>(e)}
                self._send_response(client_socket, response)
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">pass</span>
        <span class="hljs-keyword">finally</span>:
            client_socket.close()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_receive_all</span>(<span class="hljs-params">self, sock: socket.socket, length: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">bytes</span>]:
        <span class="hljs-string">"""
        接收指定长度的数据

        Args:
            sock: socket连接
            length: 期望接收的数据长度

        Returns:
            接收到的字节数据，失败返回None
        """</span>
        data = <span class="hljs-built_in">bytearray</span>()
        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(data) &lt; length:
            <span class="hljs-keyword">try</span>:
                chunk = sock.recv(length - <span class="hljs-built_in">len</span>(data))
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chunk:
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
                data.extend(chunk)
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(data)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_send_data</span>(<span class="hljs-params">self, sock: socket.socket, data: <span class="hljs-built_in">dict</span></span>):
        <span class="hljs-string">"""
        发送数据（长度 + 内容）

        Args:
            sock: socket连接
            data: 要发送的数据字典
        """</span>
        data_str = json.dumps(data, ensure_ascii=<span class="hljs-literal">False</span>)
        data_bytes = data_str.encode(<span class="hljs-string">'utf-8'</span>)
        length_data = struct.pack(<span class="hljs-string">'!I'</span>, <span class="hljs-built_in">len</span>(data_bytes))  <span class="hljs-comment"># 4字节长度头</span>
        sock.sendall(length_data + data_bytes)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_send_response</span>(<span class="hljs-params">self, sock: socket.socket, response: <span class="hljs-built_in">dict</span></span>):
        <span class="hljs-string">"""
        发送响应

        Args:
            sock: socket连接
            response: 响应数据字典
        """</span>
        response_str = json.dumps(response, ensure_ascii=<span class="hljs-literal">False</span>)
        response_bytes = response_str.encode(<span class="hljs-string">'utf-8'</span>)
        length_data = struct.pack(<span class="hljs-string">'!I'</span>, <span class="hljs-built_in">len</span>(response_bytes))
        sock.sendall(length_data + response_bytes)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_local_ip</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""
        获取本机IP地址

        Returns:
            本机IP地址字符串
        """</span>
        <span class="hljs-keyword">try</span>:
            s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            s.connect((<span class="hljs-string">"8.8.8.8"</span>, <span class="hljs-number">80</span>))
            local_ip = s.getsockname()[<span class="hljs-number">0</span>]
            s.close()
            <span class="hljs-keyword">return</span> local_ip
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"127.0.0.1"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_status</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">"""
        获取服务器状态

        Returns:
            服务器状态字典
        """</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'is_running'</span>: self.is_running,
            <span class="hljs-string">'port'</span>: self.port,
            <span class="hljs-string">'local_ip'</span>: self.get_local_ip(),
            <span class="hljs-string">'has_callback'</span>: self.on_data_request_callback <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>,
            <span class="hljs-string">'shared_data_size'</span>: <span class="hljs-built_in">len</span>(self._shared_data)
        }
</code></pre>
<h3 data-id="heading-4">p2p_client</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
P2P客户端模块 - 负责发现和接收共享数据
精简版本：移除防火墙管理，专注于核心发现和接收功能
"""</span>
<span class="hljs-keyword">import</span> socket
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> struct
<span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">List</span>, <span class="hljs-type">Tuple</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">P2PClient</span>:
    <span class="hljs-string">"""P2P客户端，用于扫描局域网并接收共享数据"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, port: <span class="hljs-built_in">int</span> = <span class="hljs-number">5000</span></span>):
        <span class="hljs-string">"""
        初始化P2P客户端

        Args:
            port: P2P通信端口，默认5000
        """</span>
        self.port = port

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">scan_devices</span>(<span class="hljs-params">self, timeout: <span class="hljs-built_in">float</span> = <span class="hljs-number">3.0</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""
        扫描局域网内可用的P2P设备

        Args:
            timeout: 扫描超时时间（秒），默认3秒

        Returns:
            设备列表，每个设备为 (ip, hostname) 元组
        """</span>
        devices = []

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 获取本机IP和网段</span>
            local_ip = self.get_local_ip()
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> local_ip <span class="hljs-keyword">or</span> local_ip == <span class="hljs-string">"127.0.0.1"</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"[P2P客户端] 无法获取有效的本机IP地址"</span>)
                <span class="hljs-keyword">return</span> devices

            <span class="hljs-comment"># 解析网段（例如: 192.168.1.0/24）</span>
            ip_parts = local_ip.split(<span class="hljs-string">'.'</span>)
            network_base = <span class="hljs-string">f"<span class="hljs-subst">{ip_parts[<span class="hljs-number">0</span>]}</span>.<span class="hljs-subst">{ip_parts[<span class="hljs-number">1</span>]}</span>.<span class="hljs-subst">{ip_parts[<span class="hljs-number">2</span>]}</span>"</span>

            <span class="hljs-comment"># 扫描网段内的设备</span>
            threads = []
            results = []

            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P客户端] 开始扫描网段: <span class="hljs-subst">{network_base}</span>.0/24, 本机IP: <span class="hljs-subst">{local_ip}</span>"</span>)

            <span class="hljs-comment"># 创建扫描线程</span>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">255</span>):
                target_ip = <span class="hljs-string">f"<span class="hljs-subst">{network_base}</span>.<span class="hljs-subst">{i}</span>"</span>
                thread = threading.Thread(
                    target=self._check_device,
                    args=(target_ip, timeout, results, local_ip)
                )
                thread.start()
                threads.append(thread)

            <span class="hljs-comment"># 等待所有线程完成</span>
            <span class="hljs-keyword">for</span> thread <span class="hljs-keyword">in</span> threads:
                thread.join()

            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P客户端] 扫描完成，发现 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(results)}</span> 个设备"</span>)
            devices = [(ip, <span class="hljs-string">f"设备_<span class="hljs-subst">{ip}</span>"</span>) <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> results]

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P客户端] 扫描设备错误: <span class="hljs-subst">{e}</span>"</span>)

        <span class="hljs-keyword">return</span> devices

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_check_device</span>(<span class="hljs-params">self, ip: <span class="hljs-built_in">str</span>, timeout: <span class="hljs-built_in">float</span>, results: <span class="hljs-built_in">list</span>, local_ip: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""
        检查指定IP是否开放了P2P服务

        Args:
            ip: 目标IP地址
            timeout: 连接超时时间
            results: 存储结果的列表
            local_ip: 本机IP地址（用于跳过自身）
        """</span>
        <span class="hljs-comment"># 跳过本机IP</span>
        <span class="hljs-keyword">if</span> ip == local_ip:
            <span class="hljs-keyword">return</span>

        <span class="hljs-keyword">try</span>:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(timeout)

            <span class="hljs-comment"># 尝试连接目标端口</span>
            result = sock.connect_ex((ip, self.port))
            <span class="hljs-keyword">if</span> result == <span class="hljs-number">0</span>:
                results.append(ip)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P客户端] 发现设备: <span class="hljs-subst">{ip}</span>"</span>)

            sock.close()
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">pass</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">receive_data</span>(<span class="hljs-params">self, ip: <span class="hljs-built_in">str</span>, timeout: <span class="hljs-built_in">int</span> = <span class="hljs-number">30</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">dict</span>]:
        <span class="hljs-string">"""
        从指定设备接收数据

        Args:
            ip: 目标设备IP地址
            timeout: 超时时间（秒），默认30秒

        Returns:
            接收到的数据字典，失败返回None
        """</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P客户端] 正在连接 <span class="hljs-subst">{ip}</span>:<span class="hljs-subst">{self.port}</span>..."</span>)

            <span class="hljs-comment"># 建立TCP连接</span>
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(timeout)
            sock.connect((ip, self.port))

            <span class="hljs-comment"># 发送数据请求</span>
            request = json.dumps({<span class="hljs-string">'type'</span>: <span class="hljs-string">'request_data'</span>})
            self._send_data(sock, request)

            <span class="hljs-comment"># 接收数据长度（4字节）</span>
            length_data = self._receive_all(sock, <span class="hljs-number">4</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> length_data:
                sock.close()
                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

            data_length = struct.unpack(<span class="hljs-string">'!I'</span>, length_data)[<span class="hljs-number">0</span>]
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P客户端] 接收数据长度: <span class="hljs-subst">{data_length}</span> bytes"</span>)

            <span class="hljs-comment"># 接收数据内容</span>
            data_bytes = self._receive_all(sock, data_length)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data_bytes:
                sock.close()
                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

            <span class="hljs-comment"># 解析JSON数据</span>
            data = json.loads(data_bytes.decode(<span class="hljs-string">'utf-8'</span>))

            <span class="hljs-comment"># 接收响应确认</span>
            response_length_data = self._receive_all(sock, <span class="hljs-number">4</span>)
            <span class="hljs-keyword">if</span> response_length_data:
                response_length = struct.unpack(<span class="hljs-string">'!I'</span>, response_length_data)[<span class="hljs-number">0</span>]
                response_data = self._receive_all(sock, response_length)
                <span class="hljs-keyword">if</span> response_data:
                    response = json.loads(response_data.decode(<span class="hljs-string">'utf-8'</span>))
                    <span class="hljs-keyword">if</span> response.get(<span class="hljs-string">'status'</span>) == <span class="hljs-string">'success'</span>:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P客户端] 数据接收成功"</span>)
                    <span class="hljs-keyword">else</span>:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P客户端] 数据接收失败: <span class="hljs-subst">{response.get(<span class="hljs-string">'message'</span>)}</span>"</span>)

            sock.close()
            <span class="hljs-keyword">return</span> data

        <span class="hljs-keyword">except</span> socket.timeout:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P客户端] 连接超时: <span class="hljs-subst">{ip}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">except</span> ConnectionRefusedError:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P客户端] 连接被拒绝: <span class="hljs-subst">{ip}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[P2P客户端] 接收数据错误: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_send_data</span>(<span class="hljs-params">self, sock: socket.socket, data: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""
        发送数据（长度 + 内容）

        Args:
            sock: socket连接
            data: 要发送的字符串数据
        """</span>
        data_bytes = data.encode(<span class="hljs-string">'utf-8'</span>)
        length_data = struct.pack(<span class="hljs-string">'!I'</span>, <span class="hljs-built_in">len</span>(data_bytes))  <span class="hljs-comment"># 4字节长度头</span>
        sock.sendall(length_data + data_bytes)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_receive_all</span>(<span class="hljs-params">self, sock: socket.socket, length: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">bytes</span>]:
        <span class="hljs-string">"""
        接收指定长度的数据

        Args:
            sock: socket连接
            length: 期望接收的数据长度

        Returns:
            接收到的字节数据，失败返回None
        """</span>
        data = <span class="hljs-built_in">bytearray</span>()
        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(data) &lt; length:
            <span class="hljs-keyword">try</span>:
                chunk = sock.recv(length - <span class="hljs-built_in">len</span>(data))
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chunk:
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
                data.extend(chunk)
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(data)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_local_ip</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""
        获取本机IP地址

        Returns:
            本机IP地址字符串
        """</span>
        <span class="hljs-keyword">try</span>:
            s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            s.connect((<span class="hljs-string">"8.8.8.8"</span>, <span class="hljs-number">80</span>))
            local_ip = s.getsockname()[<span class="hljs-number">0</span>]
            s.close()
            <span class="hljs-keyword">return</span> local_ip
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"127.0.0.1"</span>
</code></pre>
<h3 data-id="heading-5">p2p_test_example</h3>
<p>实际测验时，需要开启两个测试类，一个模拟服务端、一个模拟客户端；<strong>另外如果是真实环境使用，需要额外考虑防火墙问题，这里就不做展开了</strong>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
P2P示例代码 - 演示如何使用精简版P2P库
"""</span>
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> p2p_server <span class="hljs-keyword">import</span> P2PServer
<span class="hljs-keyword">from</span> p2p_client <span class="hljs-keyword">import</span> P2PClient


<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_server_example</span>():
    <span class="hljs-string">"""运行服务器示例"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== P2P服务器示例 ==="</span>)

    <span class="hljs-comment"># 创建服务器实例</span>
    server = P2PServer(port=<span class="hljs-number">5000</span>)

    <span class="hljs-comment"># 设置要共享的数据</span>
    shared_data = {
        <span class="hljs-string">'device_name'</span>: <span class="hljs-string">'我的设备'</span>,
        <span class="hljs-string">'device_type'</span>: <span class="hljs-string">'电脑'</span>,
        <span class="hljs-string">'timestamp'</span>: time.time(),
        <span class="hljs-string">'message'</span>: <span class="hljs-string">'你好，这是共享的数据！'</span>,
        <span class="hljs-string">'data'</span>: {
            <span class="hljs-string">'item1'</span>: <span class="hljs-string">'值1'</span>,
            <span class="hljs-string">'item2'</span>: <span class="hljs-string">'值2'</span>,
            <span class="hljs-string">'item3'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]
        }
    }

    <span class="hljs-comment"># 启动服务器</span>
    success, message = server.start(shared_data)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> success:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"服务器启动失败: <span class="hljs-subst">{message}</span>"</span>)
        <span class="hljs-keyword">return</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"服务器状态: <span class="hljs-subst">{server.get_status()}</span>"</span>)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 保持服务器运行</span>
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            time.sleep(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n正在停止服务器..."</span>)
        server.stop()


<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_client_example</span>():
    <span class="hljs-string">"""运行客户端示例"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== P2P客户端示例 ==="</span>)

    <span class="hljs-comment"># 创建客户端实例</span>
    client = P2PClient(port=<span class="hljs-number">5000</span>)

    <span class="hljs-comment"># 扫描局域网设备</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"正在扫描局域网设备..."</span>)
    devices = client.scan_devices(timeout=<span class="hljs-number">2.0</span>)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> devices:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"未发现任何设备"</span>)
        <span class="hljs-keyword">return</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发现 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(devices)}</span> 个设备:"</span>)
    <span class="hljs-keyword">for</span> i, (ip, name) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(devices, <span class="hljs-number">1</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{i}</span>. <span class="hljs-subst">{name}</span> (<span class="hljs-subst">{ip}</span>)"</span>)

    <span class="hljs-comment"># 从第一个设备接收数据</span>
    <span class="hljs-keyword">if</span> devices:
        target_ip = devices[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n正在从 <span class="hljs-subst">{target_ip}</span> 接收数据..."</span>)

        data = client.receive_data(target_ip, timeout=<span class="hljs-number">10</span>)

        <span class="hljs-keyword">if</span> data:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"接收到数据:"</span>)
            <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> data.items():
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(value, <span class="hljs-built_in">dict</span>):
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{key}</span>: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(value)}</span> 项"</span>)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{key}</span>: <span class="hljs-subst">{value}</span>"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"数据接收失败"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_full_example</span>():
    <span class="hljs-string">"""运行完整示例（需要在两个终端分别运行）"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"P2P系统完整示例"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">40</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 启动服务器（共享数据）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. 启动客户端（接收数据）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 退出"</span>)

    choice = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请选择 (1/2/3): "</span>).strip()

    <span class="hljs-keyword">if</span> choice == <span class="hljs-string">'1'</span>:
        run_server_example()
    <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">'2'</span>:
        run_client_example()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"退出"</span>)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    run_full_example()
</code></pre>
<h2 data-id="heading-6">结语</h2>
<p>当然，P2P直连也不是万能的，只适用于特定场景，大多数商业化场景下还是要考虑C/S连接，或者其变体B/S连接。</p>
<p>好啦，以上就是今天分享的内容啦。感谢阅读，如果觉得对你有帮助，记得三连哦！！！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端批量请求的并发控制与工程化实践]]></title>    <link>https://juejin.cn/post/7594813727054217250</link>    <guid>https://juejin.cn/post/7594813727054217250</guid>    <pubDate>2026-01-14T10:18:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594813727054217250" data-draft-id="7594835618120433704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端批量请求的并发控制与工程化实践"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-14T10:18:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="敲代码的阿凡驴"/> <meta itemprop="url" content="https://juejin.cn/user/2447990287511436"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端批量请求的并发控制与工程化实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2447990287511436/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    敲代码的阿凡驴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T10:18:59.000Z" title="Wed Jan 14 2026 10:18:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上一篇文章中，我们已经完成了数据准备工作。本篇将重点介绍一个在真实业务中<strong>几乎绕不开的问题</strong>：</p>
<blockquote>
<p><strong>当需要对一组数据逐个请求接口时，如何优雅、安全地进行批量请求？</strong></p>
</blockquote>
<p>如果处理不当，轻则页面卡顿，重则接口被限流甚至封禁。</p>
<hr/>
<h2 data-id="heading-0">一、为什么不能直接 <code>Promise.all</code>？</h2>
<p>最常见的写法是这样：</p>
<pre><code class="hljs language-ini" lang="ini">Promise.all(
  list.map(<span class="hljs-attr">item</span> =&gt; request(item))
)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-1">这个写法的问题在于：</h3>
<ul>
<li>
<p>并发数量 <strong>不可控</strong></p>
</li>
<li>
<p>列表一长就会：</p>
<ul>
<li>打满浏览器并发</li>
<li>压垮后端服务</li>
</ul>
</li>
<li>
<p>一旦某个请求失败，<strong>整体直接 reject</strong></p>
</li>
</ul>
<p>在区县、设备、用户、文件等<strong>数量不确定的场景</strong>下，这种方式风险极高。</p>
<hr/>
<h2 data-id="heading-2">二、我们真正需要的是什么？</h2>
<p>一个成熟的「批量请求」方案，至少应该满足：</p>
<ol>
<li><strong>限制并发数量</strong></li>
<li><strong>支持批次间隔（节流）</strong></li>
<li><strong>单个失败不影响整体流程</strong></li>
<li><strong>能够感知整体完成状态</strong></li>
<li><strong>结果和错误可以分开统计</strong></li>
</ol>
<hr/>
<h2 data-id="heading-3">三、核心设计思路</h2>
<h3 data-id="heading-4">1️⃣ 把“请求”和“执行”解耦</h3>
<ul>
<li>批量工具只负责 <strong>调度</strong></li>
<li>具体请求由调用方传入</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">(task) =&gt; <span class="hljs-title class_">Promise</span>
</code></pre>
<h3 data-id="heading-5">2️⃣ 固定并发数，分批执行</h3>
<ul>
<li>每一批最多 N 个任务</li>
<li>当前批次完成后，延迟一段时间再执行下一批</li>
</ul>
<h3 data-id="heading-6">3️⃣ 所有任务最终返回一个统一结果</h3>
<pre><code class="hljs language-ini" lang="ini">{
  results: <span class="hljs-section">[]</span>,
  errors: <span class="hljs-section">[]</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-7">四、批量请求使用方式（示例）</h2>
<p>下面是一个典型的使用方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">this</span>.<span class="hljs-title function_">batchRequestWithLimit</span>(
  taskList,
  <span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">apiRequest</span>(task);
  },
  <span class="hljs-function">(<span class="hljs-params">task, data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`任务 <span class="hljs-subst">${task}</span> 成功`</span>, data);
  },
  <span class="hljs-number">5</span>,   <span class="hljs-comment">// 最大并发数</span>
  <span class="hljs-number">200</span>, <span class="hljs-comment">// 批次间隔（ms）</span>
)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">{ results, errors }</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
      <span class="hljs-string">`批量请求完成：成功 <span class="hljs-subst">${results.length}</span> 个，失败 <span class="hljs-subst">${errors.length}</span> 个`</span>
    );
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"批量请求异常："</span>, err);
  });
</code></pre>
<p>从使用者视角看，这个方法具备：</p>
<ul>
<li><strong>调用简单</strong></li>
<li><strong>参数语义清晰</strong></li>
<li><strong>结果可控</strong></li>
</ul>
<hr/>
<h2 data-id="heading-8">五、执行流程拆解（非常关键）</h2>
<p>整个批量请求的生命周期可以拆成 5 步：</p>
<h3 data-id="heading-9">Step 1：任务队列初始化</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">queue</span> = [...taskList]<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-10">Step 2：取出当前批次</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">batch</span> = queue.splice(<span class="hljs-number">0</span>, limit)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-11">Step 3：并发执行当前批次</h3>
<pre><code class="hljs language-ini" lang="ini">await Promise.allSettled(
  batch.map(<span class="hljs-attr">task</span> =&gt; executor(task))
)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-12">Step 4：等待节流时间</h3>
<pre><code class="hljs language-scss" lang="scss">await <span class="hljs-built_in">sleep</span>(interval);
</code></pre>
<h3 data-id="heading-13">Step 5：继续下一批，直到队列清空</h3>
<hr/>
<h2 data-id="heading-14">六、为什么 <code>Promise.allSettled</code> 是关键</h2>
<p>相比 <code>Promise.all</code>：</p>




















<table><thead><tr><th>方法</th><th>任一失败</th><th>结果可控</th></tr></thead><tbody><tr><td>Promise.all</td><td>❌ 整体失败</td><td>❌</td></tr><tr><td>Promise.allSettled</td><td>✅ 单独失败</td><td>✅</td></tr></tbody></table>
<p>在<strong>批量请求场景中</strong>：</p>
<blockquote>
<p><strong>失败是常态，而不是异常</strong></p>
</blockquote>
<p>我们要做的是：</p>
<ul>
<li>接受失败</li>
<li>记录失败</li>
<li>不中断流程</li>
</ul>
<hr/>
<h2 data-id="heading-15">七、这种模式适合哪些场景？</h2>
<p>这种批量请求模型，适用于：</p>
<ul>
<li>区县 / 城市 / 设备 / 用户 批量拉取</li>
<li>文件批量上传 / 下载</li>
<li>批量校验、扫描、统计</li>
<li>任何「数量不确定 + 接口有压力」的业务场景</li>
</ul>
<hr/>
<h2 data-id="heading-16">八、总结一句话</h2>
<blockquote>
<p><strong>批量请求不是“多发请求”，而是“有节制地并发执行任务”。</strong></p>
</blockquote>
<p>通过：</p>
<ul>
<li>限制并发</li>
<li>分批执行</li>
<li>错误隔离</li>
<li>统一收敛结果</li>
</ul>
<p>你可以把一个“危险操作”，变成一个<strong>可控、可扩展、可维护的工程能力</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[到底能不能把HTTP1.0讲明白了]]></title>    <link>https://juejin.cn/post/7595021077665824819</link>    <guid>https://juejin.cn/post/7595021077665824819</guid>    <pubDate>2026-01-14T10:27:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595021077665824819" data-draft-id="7589093895326695433" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="到底能不能把HTTP1.0讲明白了"/> <meta itemprop="keywords" content="HTTP"/> <meta itemprop="datePublished" content="2026-01-14T10:27:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="瓦尔登湖懒羊羊"/> <meta itemprop="url" content="https://juejin.cn/user/2306138621099196"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            到底能不能把HTTP1.0讲明白了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2306138621099196/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    瓦尔登湖懒羊羊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T10:27:47.000Z" title="Wed Jan 14 2026 10:27:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">应用层通信流程</h2>
<p>单单说“应用层之间通信”显然是不严谨的，因为 TCP/IP 网络协议栈中，应用层是最上面的一层，它只负责为用户提供服务，但是真正的通信数据是要向下交给传输层进行处理的。</p>
<p>但是网络协议栈既然是分层的结构，其中一个原因就是为了让不同层之间忽略掉上层以及下层的存在，达到真正意义上的解耦，从而让双方看来就好像是彼此的应用层在直接通信。</p>
<h3 data-id="heading-1">网络通信需要知道对方的位置</h3>
<p>正如在科技不那么发达的年代，两地之间通信需要通过邮寄信件的方式，那邮差小哥就必须要知道这个信件要发到哪里。如今我们可以通过网络通信，但网络中的报文也不是毫无目的地转发，一定是要知道对方的 IP 地址的。</p>
<p>一般的 IP 地址长相大概是 “<strong>36.152.44.95</strong>” 这样的，这样的一串数字毫无规律可言，如果每次都只向同样的 IP 地址发送网络报文倒也可以勉强背下来。但是正如我们手机里有很多人的电话号码一样，我们不可能一生只跟一个 IP 进行网络通信，所以就需要想个办法让这些 IP 地址跟手机的通讯录一样，一一对应地加上一个方便用户记住和分辨的代名词，也就是<strong>域名</strong>。</p>
<p><strong>例如，百度的域名就是：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.baidu.com" target="_blank" title="http://www.baidu.com" ref="nofollow noopener noreferrer">www.baidu.com</a></strong></p>
<p>那如果我要给张三打电话，我可以在通讯录里面找到张三的姓名，也就能找到张三的手机号了。所以，如果要进行网络通信，就必须也存在一个可以根据域名找到对应的 IP 地址的东西，这个东西就是 <strong>DNS</strong>。</p>
<blockquote>
<p>一个域名实际是按“点”被严格切分成<strong>倒序的层级授权链</strong>，从右往左，每一级都是上一级的“子域”，直到最左边真正提供 Web 服务的主机名。</p>
</blockquote>
<p><strong>根域名：.</strong></p>
<ul>
<li>位于域名的最右侧部分，是 DNS 域名空间的最高层级，没有具体的字符标识，在域名书写中以末尾的一个“点”来表示（日常使用可省略）。实际上，<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.baidu.com" target="_blank" title="http://www.baidu.com" ref="nofollow noopener noreferrer">www.baidu.com</a> 后面还有一个“点”，也就是 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.baidu.com" target="_blank" title="http://www.baidu.com" ref="nofollow noopener noreferrer">www.baidu.com</a>.</li>
</ul>
<p><strong>顶级域名：.com</strong></p>
<ul>
<li>位于根域名的左顶级域名（gTLD）。</li>
<li>最初被设计出来是为了标识商业机构，现在已经没有严格使用限制，各种组织和个人都可以注册。</li>
<li>常见的顶级域名还有 .org（非营利组织）、.net（网络服务机构）、.eud（教育机构）等；国家和地区顶级域名如 .cn（中国）、.us（美国）也属于顶级域名范畴。</li>
</ul>
<p><strong>二级域名：baidu</strong></p>
<ul>
<li>位于顶级域名左侧，是域名的核心标识部分，也是用户或机构在域名注册时需要申请的主体。</li>
<li>百度通过注册 .com 下的 baidu 二级域名，就获得了 baidu.com 这个基础域名的使用权，就是该域名的主域名。</li>
</ul>
<p><strong>三级域名：www</strong></p>
<ul>
<li>位于二级域名的左侧，是主域名的子域名，由域名所有者自行定义和配置，无需额外向域名注册机构申请（其实就是域名所有者服务器上的一个目录名称）。</li>
<li>www 是万维网（World Wide Web）的缩写，是互联网中约定俗成的用于标识 Web 服务的子域名，当用户访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.baidu.com" target="_blank" title="http://www.baidu.com" ref="nofollow noopener noreferrer">www.baidu.com</a> 时，实际是请求 baidu.com 域名下的 www 子域名对应的 Web 服务器资源（也就是 www 这个目录下的内容）。</li>
<li>域名所有者可以配置任意的三级域名，比如 map.baidu.com（百度地图）、tieba.baidu.com（百度贴吧）等，均属于 baidu.com 的子域名。</li>
</ul>
<p><strong>既然有了域名，就要有域名服务器负责管理组织这些域名，如此才能根据域名找到对应的 IP 地址。</strong></p>
<blockquote>
<p>和域名的层级结构一样，域名服务器也是分级的，他们之间的关系类似于树状结构。</p>
</blockquote>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3b4796486734253ad5cee0673c5e847~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Om5bCU55m75rmW5oeS576K576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991267&amp;x-signature=L6i5mxoLQXFbb3v7HRmBpPP4f44%3D" alt="image.png" width="70%" loading="lazy"/></p>
<p>除上述三种 DNS 服务器之外，还有一种本地 DNS 服务器。DNS 请求最开始就是发给本地 DNS 服务器的，如果本地 DNS 服务器没有在自己的缓存表里找到对应的域名和 IP 之间的记录，才会进一步去访问根 DNS 服务器。</p>
<p><strong>本地 DNS 服务器的地址是保存在客户端的操作系统中的</strong></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e72e207db1b949048e24a3eb68506fab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Om5bCU55m75rmW5oeS576K576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991267&amp;x-signature=CRxf3Cb%2BHQyLFlHqnulx0%2BX60LM%3D" alt="image.png" width="70%" loading="lazy"/></p>
<p><strong>DNS 解析的具体流程如下：</strong></p>
<ol>
<li>客户端会根据 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.baidu.com" target="_blank" title="http://www.baidu.com" ref="nofollow noopener noreferrer">www.baidu.com</a> 这样的域名生成一个 DNS 请求，发送给本地域名服务器。</li>
<li>本地域名服务器如果在自己的缓存记录里找到了对应的 IP 地址，则直接返回；若没有找到，则向根域名服务器发起请求。</li>
<li>根域名服务器收到请求之后，识别到对应的二级域名是 .com，则将 .com 顶级域名服务器的地址返回给本地域名服务器。</li>
<li>本地域名服务器向 .com 顶级域名服务器发起请求，.com 顶级域名服务器识别到三级域名为 baidu，则将 baidu.com 权威域名服务器的地址反馈给本地域名服务器。</li>
<li>本地域名服务器向 baidu.com 权威域名服务器发起请求，权威域名服务器中一定保存着对应的 IP 地址，所以将 IP 地址返回本地域名服务器。</li>
<li>本地域名服务器将 IP 地址返回给客户端，进而可以发起网络通信。</li>
</ol>
<p>但是实际上并不是每一次 DNS 解析都要经过上述所有流程，因为浏览器本身和操作系统都是存在缓存的，当第一次获取到一个域名对应的 IP 地址之后，会记录在缓存中，避免每次都绕那么一大圈。如果在缓存中没有找到，还可以去本地的 hosts 文件中查找，如果都没有找到才会向本地域名服务器发起 DNS 请求。</p>
<p>Windows 中可以通过在终端中输入“tepad C:\Windows\System32\drivers\etc\hosts”查看 hosts 文件内容，如下：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/506f1a4be795492e8720b049a706af6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Om5bCU55m75rmW5oeS576K576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991267&amp;x-signature=EyqFR0jBVG0CipUU3SXhdjCtbms%3D" alt="image.png" width="70%" loading="lazy"/></p>
<h3 data-id="heading-2">客户端需要知道服务端处理请求的状态</h3>
<p>客户端向服务端发起请求之后，可能会得到不同的响应。常见的就是服务端成功将客户端请求的数据返回，并由客户端浏览器渲染到页面上。当然也存在其他情况，比如用户访问的资源根本就不存在，这时服务端需要让客户端知道，“不是我不想给你返回有效数据，是因为你要的东西我根本就没有”。</p>
<p><strong>服务端告诉客户端本次请求的处理结果（成功、失败、需要进一步操作等）的方式就是设置状态码。</strong></p>
<p>常见的状态码类型如下：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dc30cff04ba454a81bf3a11a89cbcbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Om5bCU55m75rmW5oeS576K576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991267&amp;x-signature=nYk6x3rC87DJILw8BkJSy934LFc%3D" alt="image.png" width="100%" loading="lazy"/></p>
<p>先解释几个简单的</p>
<p>1XX 类状态码用来表示一种中间状态，说明服务端正在处理客户端的请求。</p>
<p>2XX 类状态码用来表示服务端处理请求成功，也是我们最希望看到的一种状态，具体细分如下：</p>
<ul>
<li><strong>200 OK</strong> 是最常见的成功状态码，表示没有异常出现。</li>
<li><strong>204 No Content</strong> 与 200 OK 表达的含义相同，区别在于 204 的报文不携带服务端给客户端返回的正文数据。</li>
<li><strong>206 Partial Content</strong> 表示此次响应给客户端的数据只是一部分，通常出现在分块下载等场景。</li>
</ul>
<p>4XX 类状态码表示客户端发来的请求报文有误，服务端无法处理</p>
<ul>
<li><strong>400 Bad Request</strong> 只是表示是客户端的错误，但是这个错误是泛指，没有具体的原因。</li>
<li><strong>403 Forbidden</strong> 表示客户端的请求本身没什么问题，但是客户端要访问的资源是服务器禁止访问的。</li>
<li><strong>404 Not Found</strong> 是我们最常见的一种 4XX 类状态码，表示客户端想要访问的字眼在服务端根本就找不到。</li>
</ul>
<p>5XX 类状态码表示服务器内部处理请求时出现错误（但实际有的服务端不想被别人知道是自己的错，所以即使出现错误也照样给客户端返回一个其他类别的状态码）</p>
<ul>
<li><strong>500 Internal Server Error</strong> 表示服务端内部错误，但是也是一个泛指的错误，没有具体的原因。</li>
<li><strong>501 Not Implemented</strong> 表示服务端收到并顺利识别到请求，但是服务器本身并没有实现这个请求方法，所以无法处理。</li>
<li><strong>503 Service Unavailable</strong> 表示服务端因为服务器过载、维护升级等原因暂时无法处理请求，通常是暂时的。</li>
</ul>
<p>最后说比较重要的一类</p>
<p>3XX 类状态码表示用户请求资源的位置发生了变动，原来的 URL 找不到对应的资源，所以需要切换 URL 继续发起请求</p>
<ul>
<li><strong>301 Moved Permanently</strong> 永久重定向，表示请求资源的 URL 发生变更并且是永久的，此时客户端浏览器会缓存新的 URL，之后的请求都直接访问新地址。</li>
<li><strong>302 Found</strong> 临时重定向，也是请求资源的 URL 发生变化，但只是暂时的，客户端浏览器并不需要缓存新的地址，只是下一次重新发起请求的时候要使用服务端返回的新的 URL。</li>
<li><strong>304 Not Modified</strong> 客户端请求的资源没有改变，不需要把资源再传给客户端一次，让客户端继续用自己本地的缓存即可。</li>
</ul>
<p><strong>好的，那么问题来了，服务端要不停的收到很多客户端发来的请求，同样的资源可能被多个客户端访问，那服务端怎么知道在某一个客户端两次访问资源之间的这段时间里，资源没有被改变呢？</strong></p>
<blockquote>
<p><strong>强制缓存</strong>：由客户端的浏览器通过上次收到的服务端响应中携带的过期时间判断自己缓存的资源是否过期，如果过期就再次向服务端发起请求，否则直接使用本地缓存的内容，主动权在客户端一方。</p>
</blockquote>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bf4403586054e7c9311e9d29c022cd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Om5bCU55m75rmW5oeS576K576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991267&amp;x-signature=GD1Ww1RHSdjGM%2B0L1ltnTg4FmH4%3D" alt="image.png" width="85%" loading="lazy"/></p>
<p>上述过程中一个很重要的字段就是<strong>过期时间</strong>，实际上服务端设置过期时间有两种方式。</p>
<ol>
<li><strong>Cache-Control</strong>，相对时间。</li>
<li><strong>Expires</strong>，绝对时间。</li>
</ol>
<p>Cache-Control 的设置选项更多，也就更加精密，所以一般建议使用 Cache-Control 实现强制缓存。当服务端返回的过期时间同时出现这两者时，也优先以 Cache-Control 为准。</p>
<blockquote>
<p><strong>协商缓存</strong>是指服务端再次收到客户端发来的请求时，通过判断请求的资源有没有改变，或者请求的时间有没有超过服务端上次设置的时间，来决定是重新返回资源还是告知客户端继续使用本地缓存，主动权在服务端一方。</p>
</blockquote>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ae6d7fb4f5042fe93b75608bcbad13a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Om5bCU55m75rmW5oeS576K576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991267&amp;x-signature=mn7uSmKCzTBlrlh61bxGNWf1aaM%3D" alt="image.png" width="85%" loading="lazy"/></p>
<p><strong>注：服务端第一次返回时，上次修改时间字段为 Last-Modified，客户端再次发起请求时，携带的上次修改时间字段为 If-Modified-Since。</strong> 这种协商缓存也是通过时间字段判断资源是否改变</p>
<p>但是仅凭时间判断是有漏洞的</p>
<ul>
<li>文件包括文件属性和文件内容，如果不修改内容，只修改属性的情况下，文件的最后修改时间也是会变化的。</li>
<li>有的修改操作极快，快到可以在一秒以内完成，而 If-Modified-Since 是以秒为单位的，故而识别不到快速的修改操作。</li>
</ul>
<p><strong>所以与其通过对比时间，不如给每一次修改后的资源都分配一个版本号 Etag，只要资源被修改，Etag 就一定会发生变化。</strong></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90de4b871d16453c9d2452491f0fef96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Om5bCU55m75rmW5oeS576K576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991267&amp;x-signature=6mLwxMdAUymbEnc6IfozaTSzJmY%3D" alt="image.png" width="85%" loading="lazy"/></p>
<p>当服务端返回的字段中同时出现 Last-Modified 和 Etag 字段时，无疑是 Etag 的优先级更高。</p>
<h3 data-id="heading-3">客户端的请求类型不是单一的</h3>
<p>HTTP 根据客户端不同的需求，将请求类型划分成不同的方法字段</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20f8c234b0d441b08f313f0a2d6eedc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Om5bCU55m75rmW5oeS576K576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991267&amp;x-signature=s%2FDryQiQyirmB1BzY2NmsZERmxA%3D" alt="image.png" width="90%" loading="lazy"/></p>
<p>上述方法对应的说明，都是由 RFC 规范来定义的。日常使用中，极大部分请求方法都是 GET 和 POST，两者的区别在于：</p>
<p><strong>GET：</strong></p>
<ul>
<li>RFC 规定从服务器获取指定资源</li>
<li>参数写在 URL 中，且必须是 ASCII 字符，且浏览器对 URL 的长度是有限制的</li>
<li>浏览器可以将 GET 获得的资源进行缓存，也可以保存为书签</li>
</ul>
<p><strong>POST：</strong></p>
<ul>
<li>RFC 规定根据请求正文数据对指定的资源做出处理</li>
<li>请求携带数据一般写在请求正文中，可以是任何类型的数据，浏览器也不会对正文大小作出限制</li>
<li>POST 请求不会被浏览器缓存，也不能保存为书签</li>
</ul>
<p><strong>关于URL传参和正文传参：</strong> 虽然 URL 传参是直接把参数信息写入浏览器地址搜索框中，正文传参并不会直接把参数显示出来。但是不能说正文传参就比 URL 传参要安全，因为说白了 HTTP 中两者都是非加密的明文传输，都是“裸奔”状态，别人抓个包就啥都看到了。</p>
<p>一个常见的问题：<strong>GET 和 POST 方法能保证安全和幂等性吗？</strong></p>
<p>安全指的是一个请求不会破坏服务器上的资源，幂等指的是多次执行同样的操作，所得到的结果也是相同的。如果是完全按照 RFC 规范使用方法的话，GET 请求只是对服务器资源进行只读操作，所以多次请求得到的资源是相同的，也就是幂等的，且服务器上的资源也是安全的；POST 请求会对服务器资源做出修改，所以是不安全的，且多次修改得到的结果可能是不同的，所以也不是幂等的。</p>
<p>但是并不是所有人每时每刻都是完全按照 RFC 规范来使用 HTTP 方法的，比如我在进行本地测试的时候，所有增删查改的业务，我都是用 postman 发送 POST 请求~</p>
<h3 data-id="heading-4">请求应答式通信</h3>
<blockquote>
<p>请求应答式通信（Request-Response Communication）是一种双向、同步或异步的网络通信模式，核心逻辑是：一方（请求方）主动发起服务请求，另一方（应答方）接收请求并处理后，向请求方返回明确的响应结果。</p>
</blockquote>
<p>说人话就是，只有请求方主动发送一个请求，应答方才能在处理之后返回一个应答。下一次再通信也是同样的过程，且每一次通信都是独立的，不和之前的历史通信相关联。</p>
<p><strong>但是 HTTP 通信是要先建立连接的</strong>，这个过程是会有软硬件资源的消耗的，而且如果每次通信都重新建立连接，再把之前发过的内容重新发一遍，无疑是做了无用功。所以 HTTP 其实是可以设置保持长连接的，通信双方可以确定所有的请求都得到了应答之后再把连接断开，但是这是 HTTP1.1 及其之后的版本才支持的。</p>
<h3 data-id="heading-5">通信双方需要顺利获取并解析对方发来的数据</h3>
<p>实际上，HTTP 通信时，双方的接收缓冲区中收到的都是一系列的二进制数据。但是接收缓冲区的大小不可能刚好等于一次通信数据的大小，况且每次通信收到的数据量都是不一样的，也就意味着<strong>缓冲区中可能同时有多次通信的数据</strong>。但是二进制的连续数据，怎么准确把每一次通信的数据精准分割呢？</p>
<p><strong>在 HTTP 报头当中添加一个正文部分的长度字段</strong>，每次读取到一个 HTTP 报头部分时，往后读取正文长度大小的数据，就是一次通信的有效正文数据。</p>
<p>有时服务端把资源响应给客户端时需要进行压缩，但是压缩方法是多种多样的，这时需要客户端先告知服务端自己可以接受哪些压缩方法，服务端再按照相应的方法进行压缩响应。</p>
<p>同样的，响应的数据也会有各种编码格式，也需要客户端在发送请求时，顺道带上自己支持的编码格式，以供服务端可以响应回客户端能看懂的数据格式。</p>
<h3 data-id="heading-6">无状态协议</h3>
<blockquote>
<p>无状态协议（Stateless Protocol）是指通信双方在交互过程中，协议本身不保存任何上下文信息的网络协议。简单来说：服务器不会记住任何与客户端相关的历史请求记录，每一次请求都被视为独立的、全新的请求。</p>
</blockquote>
<p>HTTTP 就是最典型的无状态协议。</p>
<p>但是我们自己电脑上的浏览器并不是“没有记忆的”，因为当我关机再启动的时候，再次访问掘金官网，依然不需要我重新登录账号。HTTP 还是那个 HTTP，不同的是，为了避免用户频繁向服务端证明自己“良民”的身份，服务端可以在第一次身份认证成功之后，返回客户端一个“好人卡”，保存在浏览器端，这样下次“见卡如见人”，也就不需要每次都验证身份。这张卡我们也是可以看到的，它有个可爱的名字叫 Cookie。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58567884b5f24efba89444390fa4f7f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Om5bCU55m75rmW5oeS576K576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991267&amp;x-signature=KxSU8AoRpRYR8Tkw%2BT3sMIB70Mw%3D" alt="QQ_1767581797183.png" width="70%" loading="lazy"/></p>
<p>实际上这个 Cookie 保存的就是用户访问每一个网站时使用的用户信息。大概流程就是：</p>
<ol>
<li>客户端发送给服务端的请求头部中制定要服务端给自己返回一个 Cookie</li>
<li>服务端先验证客户端身份，验证成功后处理业务，并生成 Cookie 和响应数据一起返回客户端</li>
<li>客户端将 Cookie 信息保存在自己的浏览器中</li>
<li>下次再次向同样的服务端发送请求就带上 Cookie</li>
<li>服务端只需要用 Cookie 验证身份即可</li>
</ol>
<p><strong>但是毕竟 Cookie 中保存的直接就是用户的个人信息，如果被有心人通过非法手段盗取 Cookie，就可以以我们的身份访问我们访问过的网站。</strong> 这时服务器就站出来了，它说：“既然你客户端防盗窃的措施没有那么完善，那你的信息还是保存在我这里吧，但是也为了不用每次都验证你的信息，还是需要给你返回一个好人卡，但是这个好人卡不再是你的信息，只是一个与我内部维护起来的客户端信息一一对应的一个标识，方便你也方便我。” 于是就有了 <strong>Session ID</strong>。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ced59c0366f447b85fc317cbe5a8db6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Om5bCU55m75rmW5oeS576K576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991267&amp;x-signature=xSigxAmiO2a8XGcuoqag%2BtWuTnk%3D" alt="QQ_1767583213865.png" width="100%" loading="lazy"/></p>
<p>那我问你，那我问你，Cookie 中保存用户信息的时候可以被盗取，那你换成 Session ID 就没事了吗？我把 Session ID 盗了，不照样可以用你的身份访问你访问的网站吗？</p>
<p>可以是可以的，因为网络的世界里，根本就不存在绝对的安全。只是 Session ID 保存的毕竟不再是用户的个人信息了，也就说明用户信息维护的工作从客户端变成服务端了，也就不至于让用户信息经常在纷繁复杂的网络世界里裸奔。并且有一个约定俗成的衡量是否安全的标准：<strong>如果用某种手段获取某个客户端的私密信息所消耗的成本大于获取私密信息成功后获得的利益，那么就认为是安全的</strong>。毕竟很少有人愿意“吃力不讨好”，但是服务端也是有避免在这种极少数可能性的预防措施的。</p>
<ul>
<li><strong>IP 验证：</strong> 服务端会留意你每次访问时所在的 IP，如果发现你几次访问时 IP 不同，就有理由怀疑你被“盗号”了，就会提醒你注意账号信息是否泄露，并再次要求你输入账号和密码以验证身份。</li>
<li><strong>高权限操作再次验证身份：</strong> 比如你要转移一笔巨款的时候，往往会以人脸识别等方式再次确定你就是你。</li>
<li><strong>Session ID过期时间：</strong> 同一个 Session ID 并不是永久有效的，可能每过一段时间就会要求你再次验证身份以生成新的 Session ID。</li>
</ul>
<h2 data-id="heading-7">HTTP 协议格式</h2>
<p>上面所介绍的所有字段，都是要在 HTTP 协议中体现出来的，而这些内容都是要按照规范组织起来的，不能杂乱无章地直接丢给通信的对端。</p>
<p><strong>HTTP 请求报文格式：</strong></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5821dade17da499abad609669e5dc9ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Om5bCU55m75rmW5oeS576K576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991267&amp;x-signature=vQIO2NxkuCDa2NhIXP0S%2FdPKzys%3D" alt="QQ_1767585041933.png" width="80%" loading="lazy"/></p>
<p><strong>HTTP 响应报文格式：</strong></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/869f18e045fc4b75b85cdeab31960cea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Om5bCU55m75rmW5oeS576K576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991267&amp;x-signature=gw5gKB8haMlbmlIZ0L52tS1fqXg%3D" alt="QQ_1767585773809.png" width="70%" loading="lazy"/></p>
<p>其中，响应报头和请求报头中的键值对，就是上文中说的那些诸如要设置的字段，这里做一个汇总：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ec448dc87ac46e28cd1e12a337da34d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Om5bCU55m75rmW5oeS576K576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991267&amp;x-signature=%2Bw3RdwQn%2BO%2Bku5HE0xawJC0DPf8%3D" alt="QQ_1767586794113.png" width="100%" loading="lazy"/></p>
<p>而空行就是用来分割报头和正文的，当你读取到一个空行时就该意识到后面的就是正文部分的内容了，结合报头当中出现的 Content-Length 字段就可以向后读取固定长度的数据，就是完整的正文。</p>
<h3 data-id="heading-8">再次理解 HTTP 协议</h3>
<blockquote>
<p>HTTP（HyperText Transfer Protocol），即超文本传输协议，是一种基于 TCP/IP 协议的应用层协议，核心作用是规范客户端（如浏览器、APP）和服务端之间超文本数据传输规则，是万维网（WWW）通信的基础。</p>
</blockquote>
<p><strong>核心关键词拆解</strong></p>
<ul>
<li><strong>超文本（HyperText）：</strong> 指超越纯文本的数据格式，不仅包含文字，还可以是图片、音频、视频、超链接、HTML 页面等。</li>
<li><strong>传输（Transfer）：</strong> 定义了客户端与服务端之间的数据请求-响应流程，以及数据的传输格式、编码方式等。</li>
<li><strong>协议（protocol）：</strong> 客户端和服务端必须共同遵守的通信规则，双方按统一格式封装、解析报文，才能完成交互。</li>
</ul>
<p><strong>HTTP 的核心特性</strong></p>
<ol>
<li><strong>无状态：</strong> 协议本身不记录客户端的会话状态，每次请求都是独立的，服务端无法直接识别连续请求是否来自同一客户端（需通过 Cookie、Session 等机制补充状态）。</li>
<li><strong>请求 - 响应模式：</strong> 由客户端主动发起请求，服务端接收请求后处理并返回响应，一问一答是固定交互流程。</li>
<li><strong>灵活的可扩展性：</strong> 支持通过自定义报头（Headers）扩展功能，比如缓存机制、跨域访问、身份认证等。</li>
<li><strong>明文传输：</strong> 明文以纯文本形式传输，安全性较低。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Angular 18 核心特性速查表]]></title>    <link>https://juejin.cn/post/7595028805158682634</link>    <guid>https://juejin.cn/post/7595028805158682634</guid>    <pubDate>2026-01-14T10:31:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595028805158682634" data-draft-id="7595028805158666250" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Angular 18 核心特性速查表"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-14T10:31:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="米诺zuo"/> <meta itemprop="url" content="https://juejin.cn/user/2436173497373399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Angular 18 核心特性速查表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173497373399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    米诺zuo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T10:31:36.000Z" title="Wed Jan 14 2026 10:31:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">📚 Angular 18 核心特性速查表</h3>
<h2 data-id="heading-1">Angular 18 标志着 Angular 彻底告别“旧时代”（v1.x 的残留和复杂的 Module 系统），全面进入 <strong>Signal 响应式</strong> 和 <strong>Standalone 独立组件</strong> 时代。</h2>
<h3 data-id="heading-2">1. 🔄 全新响应式核心：Signal Inputs</h3>
<p>这是 Angular 18 最具革命性的变化，彻底改变了父子组件数据传参的方式。</p>





















<table><thead><tr><th align="left">特性</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><strong>旧语法</strong></td><td align="left"><code>@Input()</code> 和 <code>@Output()</code> 分开定义，配合 <code>(inputChange)</code> 实现双向绑定。</td></tr><tr><td align="left"><strong>新语法</strong></td><td align="left"><strong><code>model()</code></strong> 函数。集输入、输出、变更检测于一体。</td></tr><tr><td align="left"><strong>优势</strong></td><td align="left"><strong>代码量减少 80%</strong>，自动支持响应式更新，不再依赖 <code>ngOnChanges</code> 钩子。</td></tr></tbody></table>
<h4 data-id="heading-3">代码对比</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 旧写法：繁琐</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OldComp</span> {
  <span class="hljs-meta">@Input</span>() count = <span class="hljs-number">0</span>;
  <span class="hljs-meta">@Output</span>() countChange = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventEmitter</span>&lt;<span class="hljs-built_in">number</span>&gt;();
  
  <span class="hljs-comment">// 如果要监听变化，还得写 ngOnChanges</span>
  <span class="hljs-title function_">ngOnChanges</span>(<span class="hljs-params">changes: SimpleChanges</span>) { ... }
}
<span class="hljs-comment">// ✅ Angular 18 写法：极简</span>
<span class="hljs-keyword">import</span> { model } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NewComp</span> {
  <span class="hljs-comment">// count 现在是一个 Signal，既是输入也是输出</span>
  <span class="hljs-comment">// 父组件改了它，它会变；它变了，父组件也会收到通知</span>
  count = <span class="hljs-title function_">model</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-comment">// 在组件内部直接使用 Signal API</span>
  <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v + <span class="hljs-number">1</span>);
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-4">2. 🎨 新一代控制流</h3>
<p>Angular 17 引入，Angular 18 成为标准。废弃了 <code>*ngIf</code>、<code>*ngFor</code> 等指令，改用编译器级的块语法。</p>





























<table><thead><tr><th align="left">指令</th><th align="left">旧写法 (指令式)</th><th align="left">新写法 (块语法)</th><th align="left">关键点</th></tr></thead><tbody><tr><td align="left"><strong>条件判断</strong></td><td align="left"><code>&lt;div *ngIf="user"&gt;...&lt;/div&gt;</code></td><td align="left"><code>@if (user) { ... }</code></td><td align="left">逻辑更清晰，支持 <code>@else if</code>。</td></tr><tr><td align="left"><strong>列表循环</strong></td><td align="left"><code>&lt;div *ngFor="let u of users"&gt;...&lt;/div&gt;</code></td><td align="left"><code>@for (u of users; track u.id) { ... }</code></td><td align="left"><strong>强制要求 <code>track</code></strong>，提升渲染性能。</td></tr><tr><td align="left"><strong>空状态</strong></td><td align="left"><code>&lt;div *ngIf="!users.length"&gt;...&lt;/div&gt;</code></td><td align="left"><code>@for (u of users; track u.id) { ... } @empty { ... }</code></td><td align="left">内置空状态块，无需额外判断。</td></tr></tbody></table>
<h4 data-id="heading-5">代码对比</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 旧写法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> *<span class="hljs-attr">ngIf</span>=<span class="hljs-string">"users.length === 0; else list"</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ng-template</span> #<span class="hljs-attr">list</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> *<span class="hljs-attr">ngFor</span>=<span class="hljs-string">"let user of users; trackBy: trackFn"</span>&gt;</span>{{user.name}}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ng-template</span>&gt;</span>
<span class="hljs-comment">&lt;!-- ✅ Angular 18 写法 --&gt;</span>
@if (users.length === 0) {
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
} @else {
  @for (user of users; track user.id) {
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ user.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-6">3. 🧱 独立组件</h3>
<p>虽然从 v14 开始引入，但在 Angular 18 中，<strong>Standalone 是唯一的默认选项</strong>。</p>





















<table><thead><tr><th align="left">特性</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><strong>旧语法</strong></td><td align="left">必须声明 <code>@NgModule</code>，在 <code>declarations</code> 和 <code>imports</code> 中注册组件。</td></tr><tr><td align="left"><strong>新语法</strong></td><td align="left">组件中加上 <code>standalone: true</code>，直接在 <code>imports</code> 数组导入其他组件/指令。</td></tr><tr><td align="left"><strong>优势</strong></td><td align="left"><strong>模块化</strong>，摇树优化 更友好，降低心智负担。</td></tr></tbody></table>
<h4 data-id="heading-7">代码对比</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 旧写法：Module Hell</span>
<span class="hljs-meta">@NgModule</span>({
  <span class="hljs-attr">declarations</span>: [<span class="hljs-title class_">UserComponent</span>],
  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">CommonModule</span>, <span class="hljs-title class_">FormsModule</span>],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">UserComponent</span>]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserModule</span> { }
<span class="hljs-comment">// ✅ Angular 18 写法：清爽</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CommonModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common'</span>;
<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-user'</span>,
  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,     <span class="hljs-comment">// 声明为独立组件</span>
  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">CommonModule</span>], <span class="hljs-comment">// 直接用啥导啥</span>
  <span class="hljs-attr">template</span>: <span class="hljs-string">`...`</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserComponent</span> { }
</code></pre>
<hr/>
<h3 data-id="heading-8">4. 🚀 性能与开发体验提升</h3>
<p>除了语法变化，Angular 18 还带来了一些底层的优化：</p>
<ol>
<li><strong>Zone.js 可选:</strong>
<ul>
<li>默认情况下，Angular 依然使用 Zone.js 来自动检测变化。</li>
<li>但新版本提供了更完善的 <code>provideExperimentalZonelessChangeDetection()</code>，允许开发者完全移除 Zone.js，利用 Signal 实现极致性能（类似 React/Svelte 的手动更新模式）。</li>
</ul>
</li>
<li><strong>Hydration（水合）优化:</strong>
<ul>
<li>服务端渲染 (SSR) 的体验大幅提升，减少了客户端接管应用时的闪烁。</li>
</ul>
</li>
<li><strong>类型检查增强:</strong>
<ul>
<li>新的控制流 <code>@for</code> 的 <code>track</code> 表达式会在编译时进行严格类型检查，防止 <code>trackBy</code> 写错导致的 Bug。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-9">5. 📋 语法快速迁移指南</h3>
<p>如果您想将旧项目升级到 Angular 18 风格，请参考以下映射表：</p>








































<table><thead><tr><th align="left">场景</th><th align="left">查找旧代码...</th><th align="left">替换为...</th></tr></thead><tbody><tr><td align="left"><strong>Input 装饰器</strong></td><td align="left"><code>@Input() name: string;</code></td><td align="left"><code>name = input&lt;string&gt;('');</code></td></tr><tr><td align="left"><strong>双向绑定</strong></td><td align="left"><code>@Input() val; @Output() valChange</code></td><td align="left"><code>val = model(0);</code></td></tr><tr><td align="left"><strong>If 指令</strong></td><td align="left"><code>*ngIf</code></td><td align="left"><code>@if</code> / <code>@else</code></td></tr><tr><td align="left"><strong>For 指令</strong></td><td align="left"><code>*ngFor</code></td><td align="left"><code>@for (...; track ...)</code></td></tr><tr><td align="left"><strong>Switch 指令</strong></td><td align="left"><code>[ngSwitch]</code> / <code>*ngSwitchCase</code></td><td align="left"><code>@switch</code> / <code>@case</code></td></tr><tr><td align="left"><strong>Module 导入</strong></td><td align="left"><code>AppModule</code></td><td align="left">直接在 <code>main.ts</code> <code>bootstrapApplication</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-10">总结</h3>
<p><strong>Angular 18 的核心哲学是：</strong></p>
<ol>
<li><strong>响应式优先</strong>：用 Signal (<code>input</code>, <code>model</code>, <code>computed</code>) 替代 imperative（命令式）的 Getter/Setter。</li>
<li><strong>模板原生化</strong>：用 <code>@if</code> / <code>@for</code> 替代 HTML 指令，让模板更像代码。</li>
<li><strong>去重化</strong>：用 Standalone 组件替代复杂的 NgModule 树。
这种写法让 Angular 代码量大幅减少，运行时性能显著提升，且更容易被 Vue/React 开发者理解。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IfAI v0.3.0 - 从"文本"到"多模态"的感知升级]]></title>    <link>https://juejin.cn/post/7595030559564333107</link>    <guid>https://juejin.cn/post/7595030559564333107</guid>    <pubDate>2026-01-14T10:14:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595030559564333107" data-draft-id="7595021656428052507" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" IfAI v0.3.0 - 从&quot;文本&quot;到&quot;多模态&quot;的感知升级"/> <meta itemprop="keywords" content="AI编程,Rust"/> <meta itemprop="datePublished" content="2026-01-14T10:14:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="peterfei"/> <meta itemprop="url" content="https://juejin.cn/user/2700056287782663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             IfAI v0.3.0 - 从"文本"到"多模态"的感知升级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700056287782663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    peterfei
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T10:14:29.000Z" title="Wed Jan 14 2026 10:14:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>发布日期</strong>: 2026-01-14
<strong>版本代号</strong>: Multimodal Intelligence
<strong>核心主题</strong>: 从"文本"到"多模态"的感知升级</p>
</blockquote>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d67dbf6703a47219bc628d25ba8b655~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGV0ZXJmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768990469&amp;x-signature=PQvXWBQbY35Mawvb3wG1%2FXsplRg%3D" alt="2026-01-1401_1280.gif" loading="lazy"/></p>
<h2 data-id="heading-0">🎯 版本概述</h2>
<p>v0.3.0 实现了从纯文本交互到多模态感知的重大飞跃。AI 不再只能理解代码，现在可以直接"看到"图片、理解视觉内容，同时具备强大的代码分析和重构能力。</p>
<p><strong>五大核心升级</strong>:</p>
<ol>
<li><strong>文本对话 → 多模态对话</strong>: 支持拖拽图片直接对话，AI 可理解视觉内容</li>
<li><strong>单一调度 → 混合调度</strong>: 本地 LLM + 远程 API 灵活切换</li>
<li><strong>基础补全 → 智能导航</strong>: Go to Definition / Find References 支持 35+ 主流语言</li>
<li><strong>手动重构 → AI 重构</strong>: 自动检测代码异味并生成重构方案</li>
<li><strong>新手友好 → 零门槛</strong>: 新手引导 Tour 系统，5分钟上手</li>
</ol>
<hr/>
<h2 data-id="heading-1">✨ 核心功能</h2>
<h3 data-id="heading-2">1️⃣ 多模态 Vision LLM (Multimodal Understanding)</h3>
<p><strong>突破</strong>: AI 现在可以直接"看"到图片并理解视觉内容。</p>





























<table><thead><tr><th align="left">功能</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><strong>图片拖拽上传</strong></td><td align="left">直接拖拽图片到聊天区域，自动转为 base64</td></tr><tr><td align="left"><strong>截图快捷上传</strong></td><td align="left">系统截图后直接粘贴 (Cmd+V) 到编辑器</td></tr><tr><td align="left"><strong>视觉内容理解</strong></td><td align="left">AI 分析图片中的 UI、代码、架构图</td></tr><tr><td align="left"><strong>多图片附件</strong></td><td align="left">支持一次对话上传多张图片</td></tr><tr><td align="left"><strong>自动清理机制</strong></td><td align="left">发送后自动清除图片附件，保持界面整洁</td></tr></tbody></table>
<p><strong>技术实现</strong>:</p>
<ul>
<li>Base64 编码处理图片数据</li>
<li>自动检测 Vision API 模型 (Claude 3.5 Sonnet / GPT-4V)</li>
<li>Token 计数自适应图片大小</li>
<li>支持 PNG、JPG、JPEG、GIF、WebP 格式</li>
</ul>
<p><strong>测试覆盖</strong>: MM-UI-01 ~ MM-UI-05 (5个测试全通过)</p>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20../imgs/ifai2026-01-1402_1280.gif" alt="多模态演示转存失败，建议直接上传图片文件" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-3">2️⃣ 本地/远程混合调度 (Hybrid LLM Scheduling)</h3>
<p><strong>突破</strong>: 不再依赖单一 API，灵活调度本地和远程模型。</p>





























<table><thead><tr><th align="left">功能</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><strong>本地模型</strong></td><td align="left">支持 llama3、qwen2.5 等本地部署模型</td></tr><tr><td align="left"><strong>远程 API 支持</strong></td><td align="left">Anthropic Claude、OpenAI GPT-4</td></tr><tr><td align="left"><strong>智能路由</strong></td><td align="left">根据任务类型自动选择最适合的模型</td></tr><tr><td align="left"><strong>降级保护</strong></td><td align="left">远程 API 失败时自动降级到本地模型</td></tr><tr><td align="left"><strong>成本优化</strong></td><td align="left">简单任务用本地模型，复杂任务用云端</td></tr></tbody></table>
<p><strong>配置示例</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"llm"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"anthropic"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-3-5-sonnet-20241022"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"fallback"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ollama"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"llama3.1"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>测试覆盖</strong>: MM-UI-01, MM-UI-03 (真实AI验证通过)</p>
<hr/>
<h3 data-id="heading-4">3️⃣ 代码智能导航 (Code Intelligence Navigation)</h3>
<p><strong>突破</strong>: 支持 35+ 主流语言的符号级导航。</p>





























<table><thead><tr><th align="left">功能</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><strong>Go to Definition</strong></td><td align="left">跳转到函数/变量/类的定义位置</td></tr><tr><td align="left"><strong>Find References</strong></td><td align="left">查找符号在项目中的所有引用</td></tr><tr><td align="left"><strong>跨语言支持</strong></td><td align="left">TypeScript、Rust、Python、Go、Java、C++、Ruby、PHP 等</td></tr><tr><td align="left"><strong>LSP 集成</strong></td><td align="left">基于 Language Server Protocol 标准实现</td></tr><tr><td align="left"><strong>项目范围索引</strong></td><td align="left">自动索引当前工作区所有文件</td></tr></tbody></table>
<p><strong>快捷键</strong>:</p>
<ul>
<li><code>F12</code> / <code>Cmd+Click</code>: 跳转到定义</li>
<li><code>Shift+F12</code> / <code>Right-click</code>: 查找所有引用</li>
</ul>
<p><strong>支持的语言</strong> (35+):
JavaScript, TypeScript, Python, Rust, Go, Java, C, C++, C#, PHP, Ruby, Swift, Kotlin, Dart, Lua, Scala, Groovy, PowerShell, Shell, YAML, JSON, Markdown, HTML, CSS, Vue, Svelte, etc.</p>
<p><strong>测试覆盖</strong>: DEF-01 ~ DEF-05 (5个测试全通过), REF-01 ~ REF-04 (4个测试全通过)</p>
<hr/>
<h3 data-id="heading-5">4️⃣ AI 代码重构 (AI-Powered Refactoring)</h3>
<p><strong>突破</strong>: AI 自动检测代码异味并生成重构方案。</p>





























<table><thead><tr><th align="left">功能</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><strong>代码异味检测</strong></td><td align="left">自动识别长函数、重复代码、复杂条件等问题</td></tr><tr><td align="left"><strong>结构化重构</strong></td><td align="left">一键将复杂代码拆分为清晰的函数/类结构</td></tr><tr><td align="left"><strong>智能建议</strong></td><td align="left">AI 分析代码上下文，生成符合最佳实践的重构方案</td></tr><tr><td align="left"><strong>预览模式</strong></td><td align="left">Diff 视图预览重构变更，Accept/Reject 控制</td></tr><tr><td align="left"><strong>Undo 支持</strong></td><td align="left">完整的撤销支持，不满意可随时回退</td></tr></tbody></table>
<p><strong>检测的代码问题</strong>:</p>
<ul>
<li>长函数 (Long Function)</li>
<li>重复代码 (Code Duplication)</li>
<li>复杂条件 (Complex Conditionals)</li>
<li>魔法数字 (Magic Numbers)</li>
<li>不一致的命名 (Inconsistent Naming)</li>
</ul>
<p><strong>测试覆盖</strong>: REF-001, REF-002 (代码分析重构相关测试)</p>
<hr/>
<h3 data-id="heading-6">5️⃣ 新手引导 Tour (Interactive Onboarding)</h3>
<p><strong>突破</strong>: 零门槛上手，5分钟快速掌握核心功能。</p>





























<table><thead><tr><th align="left">功能</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><strong>首次启动引导</strong></td><td align="left">新用户首次启动自动播放 Tour</td></tr><tr><td align="left"><strong>分步教程</strong></td><td align="left">分步骤介绍聊天、多模态、行内编辑等核心功能</td></tr><tr><td align="left"><strong>高亮提示</strong></td><td align="left">自动高亮相关 UI 元素，配合文字说明</td></tr><tr><td align="left"><strong>跳过/重播</strong></td><td align="left">支持跳过 Tour，通过帮助菜单重新播放</td></tr><tr><td align="left"><strong>进度记忆</strong></td><td align="left">记录用户完成状态，避免重复打扰</td></tr></tbody></table>
<p><strong>引导内容</strong>:</p>
<ol>
<li>欢迎页面介绍</li>
<li>聊天功能演示</li>
<li>多模态图片上传</li>
<li>行内编辑 (Cmd+K)</li>
<li>快捷键说明</li>
<li>帮助与文档入口</li>
</ol>
<p><strong>测试覆盖</strong>: TOUR-E2E-01 ~ TOUR-E2E-04 (4个测试全通过)</p>
<hr/>
<h3 data-id="heading-7">6️⃣ UI 加载反馈 (Loading Feedback)</h3>
<p><strong>突破</strong>: 实时加载动画，告别"空白等待"焦虑。</p>





























<table><thead><tr><th align="left">功能</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><strong>聊天加载动画</strong></td><td align="left">"IFAI 正在思考..." + 旋转 Spinner</td></tr><tr><td align="left"><strong>行内编辑加载</strong></td><td align="left">"IFAI 正在处理..." + 输入框禁用保护</td></tr><tr><td align="left"><strong>Pulse 动画</strong></td><td align="left">平滑的脉冲动画，视觉反馈清晰</td></tr><tr><td align="left"><strong>状态管理</strong></td><td align="left">Zustand 全局状态统一管理加载状态</td></tr><tr><td align="left"><strong>自动清理</strong></td><td align="left">AI 响应完成后自动清除加载状态</td></tr></tbody></table>
<p><strong>测试覆盖</strong>: MM-UI-01 ~ MM-UI-05, IE-LOAD-01 ~ IE-LOAD-04 (9个测试全通过)</p>
<hr/>
<h3 data-id="heading-8">7️⃣ 多工作区支持 (Multi-Workspace Support)</h3>
<p><strong>突破</strong>: 同时管理多个项目，无缝切换上下文。</p>

























<table><thead><tr><th align="left">功能</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><strong>多目录索引</strong></td><td align="left">同时索引多个工作区目录</td></tr><tr><td align="left"><strong>智能路径解析</strong></td><td align="left">自动处理跨文件引用路径</td></tr><tr><td align="left"><strong>项目切换</strong></td><td align="left">快速切换不同项目的上下文</td></tr><tr><td align="left"><strong>符号跨项目查找</strong></td><td align="left">在多个项目中查找符号定义和引用</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-9">8️⃣ Tauri 外链支持 (External Links)</h3>
<p><strong>突破</strong>: 桌面应用原生打开外部链接。</p>

























<table><thead><tr><th align="left">功能</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><strong>Shell API 集成</strong></td><td align="left">使用 Tauri Shell API 打开系统浏览器</td></tr><tr><td align="left"><strong>降级保护</strong></td><td align="left">API 失败时降级到 window.open()</td></tr><tr><td align="left"><strong>帮助菜单链接</strong></td><td align="left">文档、GitHub、Issues 等外部链接</td></tr><tr><td align="left"><strong>关于页面链接</strong></td><td align="left">Wiki、Repository、Discussions</td></tr></tbody></table>
<p><strong>测试覆盖</strong>: ABOUT-01 ~ ABOUT-05 (5个测试全通过)</p>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20../imgs/ifai2026-01-1401_1280.gif" alt="AI代码演示转存失败，建议直接上传图片文件" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-10">🛠 技术改进</h2>
<h3 data-id="heading-11">多模态处理</h3>
<ul>
<li><strong>Base64 编码优化</strong>: 高效的图片编码处理，内存占用优化</li>
<li><strong>Token 计数自适应</strong>: 根据图片分辨率自动估算 token 消耗</li>
<li><strong>Vision API 检测</strong>: 自动识别支持视觉的 LLM 模型</li>
</ul>
<h3 data-id="heading-12">编辑器增强</h3>
<ul>
<li><strong>符号索引系统</strong>: 基于 tree-sitter 的多语言符号解析</li>
<li><strong>LSP 客户端集成</strong>: 标准化 Language Server Protocol 支持</li>
<li><strong>跨工作区路径解析</strong>: 智能处理多项目符号引用</li>
</ul>
<h3 data-id="heading-13">UI/UX 优化</h3>
<ul>
<li><strong>Zustand 全局状态管理</strong>: 统一的加载状态管理</li>
<li><strong>Tauri Shell API</strong>: 原生外部链接打开支持</li>
<li><strong>加载反馈动画</strong>: Pulse + Spinner 组合动画</li>
</ul>
<h3 data-id="heading-14">测试覆盖</h3>
<ul>
<li><strong>36/36 E2E 测试全部通过</strong></li>
<li><strong>真实 AI 验证</strong>: 包含真实 API 调用的端到端测试</li>
<li><strong>多模态测试</strong>: 5/5 测试通过</li>
<li><strong>代码分析测试</strong>: 9/9 测试通过</li>
<li><strong>帮助页面测试</strong>: 5/5 测试通过</li>
</ul>
<hr/>
<h2 data-id="heading-15">📊 性能表现</h2>



































<table><thead><tr><th align="left">指标</th><th align="left">v0.2.9</th><th align="left">v0.3.0</th><th align="left">改进</th></tr></thead><tbody><tr><td align="left">E2E 通过率</td><td align="left">100% (23/23)</td><td align="left"><strong>100%</strong> (36/36)</td><td align="left">+56% 测试数</td></tr><tr><td align="left">符号索引速度</td><td align="left">~1s</td><td align="left">~0.5s</td><td align="left">50% 提升</td></tr><tr><td align="left">多模态响应延迟</td><td align="left">N/A</td><td align="left">~2s</td><td align="left">新增功能</td></tr><tr><td align="left">图片上传处理</td><td align="left">N/A</td><td align="left">&lt;100ms</td><td align="left">新增功能</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-16">🐛 Bug 修复</h2>






























<table><thead><tr><th align="left">Issue</th><th align="left">描述</th><th align="left">修复方式</th></tr></thead><tbody><tr><td align="left"><strong>MM-001</strong></td><td align="left">多模态图片 token 计数异常</td><td align="left">修正 Base64 编码后的 token 计算公式</td></tr><tr><td align="left"><strong>MM-002</strong></td><td align="left">多模态图片不能识别</td><td align="left">添加 Vision API 模型检测逻辑</td></tr><tr><td align="left"><strong>EDT-001</strong></td><td align="left">行内编辑后无加载反馈</td><td align="left">添加 isProcessing 状态和动画</td></tr><tr><td align="left"><strong>LNK-001</strong></td><td align="left">Tauri 应用外链点击无反应</td><td align="left">使用 Shell API 替代 window.open()</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-17">🔄 升级指南</h2>
<h3 data-id="heading-18">从 v0.2.9 升级</h3>
<ol>
<li><strong>更新依赖</strong>:</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">npm install
<span class="hljs-built_in">cd</span> src-tauri &amp;&amp; cargo update
</code></pre>
<ol start="2">
<li>
<p><strong>配置文件更新</strong>:
如需使用多模态功能，确保配置支持 Vision API 模型（如 Claude 3.5 Sonnet）</p>
</li>
<li>
<p><strong>重新构建</strong>:</p>
</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">npm run tauri build
</code></pre>
<ol start="4">
<li><strong>首次启动</strong>: v0.3.0 首次启动会自动播放新手引导 Tour</li>
</ol>
<hr/>
<h2 data-id="heading-19">📝 已知问题</h2>
<ul>
<li><strong>图片大小限制</strong>: 单张图片建议不超过 5MB，过大可能导致 token 溢出</li>
<li><strong>本地模型多模态</strong>: Ollama 本地模型暂不支持 Vision，多模态功能需使用远程 API</li>
<li><strong>跨语言符号查找</strong>: 部分语言的 LSP 支持有限，符号查找可能不完整</li>
</ul>
<hr/>
<h2 data-id="heading-20">🚀 下版本预告 (v0.3.1)</h2>
<p>v0.3.1 将继续优化多模态和代码分析体验：</p>
<ul>
<li><strong>视频理解支持</strong>: 支持短视频帧分析</li>
<li><strong>代码补全增强</strong>: 基于多模态的 UI 代码智能补全</li>
<li><strong>符号搜索改进</strong>: 模糊匹配和驼峰拆分搜索</li>
<li><strong>更多 LSP 语言</strong>: 扩展到 50+ 语言支持</li>
</ul>
<hr/>
<h2 data-id="heading-21">🙏 致谢</h2>
<p>感谢所有参与 v0.3.0 测试和反馈的用户，特别是：</p>
<ul>
<li>多模态功能测试的贡献者</li>
<li>代码分析功能的反馈者</li>
<li>Bug 报告和功能建议的用户</li>
<li>社区的持续支持</li>
</ul>
<hr/>
<p><strong>下载</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpeterfei%2Fifai%2Freleases%2Ftag%2Fv0.3.0" target="_blank" title="https://github.com/peterfei/ifai/releases/tag/v0.3.0" ref="nofollow noopener noreferrer">github.com/peterfei/if…</a></p>
<p><strong>完整文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpeterfei%2Fifai%2Ftree%2Fv0.3.0%2Fdocs" target="_blank" title="https://github.com/peterfei/ifai/tree/v0.3.0/docs" ref="nofollow noopener noreferrer">github.com/peterfei/if…</a></p>
<p><strong>讨论区</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpeterfei%2Fifai%2Fdiscussions" target="_blank" title="https://github.com/peterfei/ifai/discussions" ref="nofollow noopener noreferrer">github.com/peterfei/if…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌Antigravity 也支持技能了！]]></title>    <link>https://juejin.cn/post/7595021656428118043</link>    <guid>https://juejin.cn/post/7595021656428118043</guid>    <pubDate>2026-01-14T10:30:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595021656428118043" data-draft-id="7595030559564365875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌Antigravity 也支持技能了！"/> <meta itemprop="keywords" content="Google"/> <meta itemprop="datePublished" content="2026-01-14T10:30:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="甲维斯"/> <meta itemprop="url" content="https://juejin.cn/user/63109670111066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌Antigravity 也支持技能了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/63109670111066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    甲维斯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T10:30:30.000Z" title="Wed Jan 14 2026 10:30:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>SKILL 这几天实在是太火了！！！</p>
<p>这不，谷歌Antigravity 也快速跟进了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cec344bd338444bda342238fbcc4fea3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sy57u05pav:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768991430&amp;x-signature=UiM%2B8yeF%2Fm8RjmLzXZrXllxklfY%3D" alt="" loading="lazy"/></p>
<p>Google Antigravity 官方账号今天发了 一条推特。表示"Antigravity 也支持技能了"</p>
<p>并对 Skills 做了一个简要的介绍：</p>
<blockquote>
<p><strong>Skills</strong> 是一种用于扩展你的智能体能力的开放标准。</p>
<p>无论是项目专属的工作流，还是通用的工具能力，你现在都可以把知识封装成可复用的 <strong>Skills</strong>。</p>
</blockquote>
<p>Google Antigravity 是谷歌的编程 IDE，随着上一次 G3pro 一起发布。因为 IDE 可以免费使用 Gemini3 和 Claude4.5，开通会员之后配额也比较多，所以使用的人数一下子也多了起来。</p>
<p>最近一直没有更新，没想到因为 SKILL 更新了一波。</p>
<p>查看了软件的 changelog 也可以看到，就在昨天更发布了一个更新版本。</p>
<p>更新标题就是"Agent Skills", 主要更新就是引入了技能。</p>
<p>官方也发布了技能相关文档。</p>
<pre><code class="hljs language-arduino" lang="arduino">https:<span class="hljs-comment">//antigravity.google/docs/skills</span>
</code></pre>
<p>来花个十分钟学习一下谷歌版 SKILL 吧！</p>
<hr/>
<h2 data-id="heading-0">概述</h2>
<p><strong>Skills</strong> 是一个用于扩展 AI Agent 能力的<strong>开放标准</strong>。每个 Skill 是一个包含 <code>SKILL.md</code> 文件的文件夹，里面有 Agent 在执行特定任务时可以遵循的指令。</p>
<hr/>
<h2 data-id="heading-1">Skills 是什么？</h2>
<p>Skills 是<strong>可复用的知识包</strong>，用于扩展 Agent 的能力。每个 Skill 包含：</p>





















<table><thead><tr><th>组成部分</th><th>说明</th></tr></thead><tbody><tr><td><strong>Instructions</strong></td><td>如何处理特定类型任务的指令</td></tr><tr><td><strong>Best practices</strong></td><td>应遵循的最佳实践和约定</td></tr><tr><td><strong>Scripts &amp; Resources</strong></td><td>Agent 可使用的可选脚本和资源</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">Skills 存放位置</h2>
<p>支持两种类型的 Skills：</p>

















<table><thead><tr><th>位置</th><th>作用域</th></tr></thead><tbody><tr><td><code>&lt;workspace-root&gt;/.agent/skills/&lt;skill-folder&gt;/</code></td><td>当前项目</td></tr><tr><td><code>~/.gemini/antigravity/skills/&lt;skill-folder&gt;/</code></td><td>所有项目通用</td></tr></tbody></table>
<h3 data-id="heading-3">使用场景</h3>
<ul>
<li><strong>Workspace skills</strong>：适用于项目特定的工作流，如团队部署流程或测试约定</li>
<li><strong>Global skills</strong>：适用于跨项目的个人工具或通用功能</li>
</ul>
<hr/>
<h2 data-id="heading-4">如何创建 Skill</h2>
<h3 data-id="heading-5">步骤</h3>
<ol>
<li>在 skill 目录中创建文件夹</li>
<li>添加 <code>SKILL.md</code> 文件，包含 YAML frontmatter</li>
</ol>
<h3 data-id="heading-6">文件夹结构</h3>
<pre><code class="hljs language-bash" lang="bash">.agent/skills/my-skill/
├── SKILL.md        <span class="hljs-comment"># 主指令文件（必需）</span>
├── scripts/        <span class="hljs-comment"># 辅助脚本（可选）</span>
├── examples/       <span class="hljs-comment"># 参考实现（可选）</span>
└── resources/      <span class="hljs-comment"># 模板和资源（可选）</span>
</code></pre>
<h3 data-id="heading-7">SKILL.md 文件结构</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-string">name:</span> <span class="hljs-string">my-skill</span>
<span class="hljs-string">description:</span> <span class="hljs-string">Helps</span> <span class="hljs-string">with</span> <span class="hljs-string">a</span> <span class="hljs-string">specific</span> <span class="hljs-string">task.</span> <span class="hljs-string">Use</span> <span class="hljs-string">when</span> <span class="hljs-string">you</span> <span class="hljs-string">need</span> <span class="hljs-string">to</span> <span class="hljs-string">do</span> <span class="hljs-string">X</span> <span class="hljs-string">or</span> <span class="hljs-string">Y.</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment"># My Skill</span>

<span class="hljs-string">Detailed</span> <span class="hljs-string">instructions</span> <span class="hljs-string">for</span> <span class="hljs-string">the</span> <span class="hljs-string">agent</span> <span class="hljs-string">go</span> <span class="hljs-string">here.</span>

<span class="hljs-comment">## When to use this skill</span>
<span class="hljs-string">-</span> <span class="hljs-string">Use</span> <span class="hljs-string">this</span> <span class="hljs-string">when...</span>

<span class="hljs-comment">## How to use it</span>
<span class="hljs-string">Step-by-step</span> <span class="hljs-string">guidance...</span>
</code></pre>
<h3 data-id="heading-8">文档元信息</h3>




















<table><thead><tr><th>字段</th><th>必需</th><th>说明</th></tr></thead><tbody><tr><td><code>name</code></td><td>否</td><td>Skill 的唯一标识符（小写，用连字符替代空格）</td></tr><tr><td><code>description</code></td><td><strong>是</strong></td><td>清晰描述 Skill 的用途和使用场景</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">Agent 如何使用 Skills</h2>
<p>Skills 遵循<strong>渐进式披露（Progressive Disclosure）</strong> 模式：</p>
<ol>
<li><strong>Discovery（发现）</strong> 对话开始时，Agent 看到可用 Skills 的名称和描述列表</li>
<li><strong>Activation（激活）</strong> 如果某个 Skill 与任务相关，Agent 读取完整的 <code>SKILL.md</code> 内容</li>
<li><strong>Execution（执行）</strong> Agent 在工作时遵循 Skill 的指令</li>
</ol>
<hr/>
<h2 data-id="heading-10">最佳实践</h2>

























<table><thead><tr><th>原则</th><th>说明</th></tr></thead><tbody><tr><td><strong>Keep skills focused</strong></td><td>每个 Skill 只做一件事，避免"万能"技能</td></tr><tr><td><strong>Write clear descriptions</strong></td><td>描述是 Agent 决定是否使用的关键，要具体明确</td></tr><tr><td><strong>Use scripts as black boxes</strong></td><td>鼓励 Agent 先用 <code>--help</code> 而非阅读源码</td></tr><tr><td><strong>Include decision trees</strong></td><td>复杂 Skills 需包含帮助选择正确方法的决策逻辑</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-11">示例：代码审查 Skill</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-string">name:</span> <span class="hljs-string">code-review</span>
<span class="hljs-string">description:</span> <span class="hljs-string">Reviews</span> <span class="hljs-string">code</span> <span class="hljs-string">changes</span> <span class="hljs-string">for</span> <span class="hljs-string">bugs,</span> <span class="hljs-string">style</span> <span class="hljs-string">issues,</span> <span class="hljs-string">and</span> <span class="hljs-string">best</span> <span class="hljs-string">practices.</span> <span class="hljs-string">Use</span> <span class="hljs-string">when</span> <span class="hljs-string">reviewing</span> <span class="hljs-string">PRs</span> <span class="hljs-string">or</span> <span class="hljs-string">checking</span> <span class="hljs-string">code</span> <span class="hljs-string">quality.</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment"># Code Review Skill</span>

<span class="hljs-string">When</span> <span class="hljs-string">reviewing</span> <span class="hljs-string">code,</span> <span class="hljs-string">follow</span> <span class="hljs-string">these</span> <span class="hljs-attr">steps:</span>

<span class="hljs-comment">## Review checklist</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">**Correctness**:</span> <span class="hljs-string">Does</span> <span class="hljs-string">the</span> <span class="hljs-string">code</span> <span class="hljs-string">do</span> <span class="hljs-string">what</span> <span class="hljs-string">it's</span> <span class="hljs-string">supposed</span> <span class="hljs-string">to?</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">**Edge</span> <span class="hljs-string">cases**:</span> <span class="hljs-string">Are</span> <span class="hljs-string">error</span> <span class="hljs-string">conditions</span> <span class="hljs-string">handled?</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">**Style**:</span> <span class="hljs-string">Does</span> <span class="hljs-string">it</span> <span class="hljs-string">follow</span> <span class="hljs-string">project</span> <span class="hljs-string">conventions?</span>
<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">**Performance**:</span> <span class="hljs-string">Are</span> <span class="hljs-string">there</span> <span class="hljs-string">obvious</span> <span class="hljs-string">inefficiencies?</span>

<span class="hljs-comment">## How to provide feedback</span>
<span class="hljs-string">-</span> <span class="hljs-string">Be</span> <span class="hljs-string">specific</span> <span class="hljs-string">about</span> <span class="hljs-string">what</span> <span class="hljs-string">needs</span> <span class="hljs-string">to</span> <span class="hljs-string">change</span>
<span class="hljs-string">-</span> <span class="hljs-string">Explain</span> <span class="hljs-string">why,</span> <span class="hljs-string">not</span> <span class="hljs-string">just</span> <span class="hljs-string">what</span>
<span class="hljs-string">-</span> <span class="hljs-string">Suggest</span> <span class="hljs-string">alternatives</span> <span class="hljs-string">when</span> <span class="hljs-string">possible</span>
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p>Google Antigravity 的 Skills 系统是一个<strong>灵活、可扩展的框架</strong>，让用户可以通过简单的 Markdown 文件来定制 AI Agent 的行为，使其能够遵循特定的工作流程和最佳实践。</p>
<hr/>
<p>这个标准基本上遵循了 AgentSkills 的标准，和 codex，以及 Claude Code 的大同小异。</p>
<p>主要的差异还是在技能的存放路径上面！</p>
<p>知道了这个规则之后 Claude Code 上的技能就可以快速给 Antigravity 复用了，以后可以一边用 IDE 一边用技能了。</p>
<p>技能这个标准虽然很简单，但是自由度很大，每个人都可以有自己的技能，挺好的！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>