<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[手势操控 Three.js！效果炸裂！]]></title>    <link>https://juejin.cn/post/7577690150092750888</link>    <guid>https://juejin.cn/post/7577690150092750888</guid>    <pubDate>2025-11-29T15:12:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150092750888" data-draft-id="7577647745110654976" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手势操控 Three.js！效果炸裂！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-29T15:12:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="看晴天了"/> <meta itemprop="url" content="https://juejin.cn/user/121387835735579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手势操控 Three.js！效果炸裂！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/121387835735579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    看晴天了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:12:58.000Z" title="Sat Nov 29 2025 15:12:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">太牛了！手势操控 Three.js！效果炸裂！</h2>
<p>部署运行你感兴趣的模型镜像一键部署</p>
<p>作为一名前端开发者，我一直热衷于界面效果展示，尤其喜欢那些<strong>炫酷</strong>的 <strong>3D</strong> 效果。</p>
<p>最近发现了一个很赞的开源项目 <code>“stark-shapes”</code>，它将<strong>手势识别</strong>与 <strong>3D 动画</strong>完美结合，借助 <code>Three.js</code> 和 <code>MediaPipe</code> 手势跟踪技术，实现了通过手势操控 3D 粒子动画的效果，视觉体验非常出色。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a774206e44ea448a9ab968bdbf5c9ebe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55yL5pm05aSp5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765033978&amp;x-signature=FiYuOa%2FpHqD1skyu%2B%2FdD%2FT6cllY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>stark-shapes 亮点</h4>
<h5 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>多样的手势操控</h5>
<p>项目支持丰富<strong>手势操作</strong>。</p>
<p><strong>右手捏合能放大或缩小场景，左手旋转能让摄像机环绕场景，拍手可切换动画模式</strong>，交互方式简单又有趣。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0956b4fd3ae34b4eb75d67fa43ea9d76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55yL5pm05aSp5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765033978&amp;x-signature=X2LDc83v%2FQJsSeMpBpDeG%2BQQKpU%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>精美的 3D 几何图案</h5>
<p>项目包含多种 <strong>3D 几何图案</strong>，如<code>立方体</code>、<code>球体</code>、<code>螺旋</code>、<code>星系</code>等，这些图案由粒子系统生成，具有动态、流动的效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a9f028b703f44f48bf3df4391a2bb44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55yL5pm05aSp5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765033978&amp;x-signature=HwtrUFEeexnGRlya6Inc1rFKe3I%3D" alt="" loading="lazy"/></p>
<p>螺旋图案粒子沿轨迹旋转延伸，星系图案模拟宇宙星系旋转运行，视觉效果极佳。</p>
<h5 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>强大的后处理效果</h5>
<p>项目引入后处理效果，如 <strong>Bloom</strong> 效果。它能让场景中明亮部分添加光晕，使画面更柔和梦幻，增强视觉层次感和氛围感。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ee8da3309674f22aa4ec660ef4a0838~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55yL5pm05aSp5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765033978&amp;x-signature=%2FMVC0xoiVhn3uR1QFW%2B1UtOx4%2F0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>技术实现</h4>
<h6 data-id="heading-6">Three.js 的关键作用</h6>
<p><strong>Three.js</strong> 是基于 <strong>WebGL</strong> 的 3D 绘图库，负责创建、渲染 3D 几何体及动画处理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d183bf38ca5f478dba7655686b7ddff9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55yL5pm05aSp5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765033978&amp;x-signature=C8Fl5Zkh31L7q9IL6pE5fmMZ7zc%3D" alt="" loading="lazy"/></p>
<p><strong>“stark-shapes”</strong> 项目中，它管理场景的摄像机位置、光照设置及动画循环等，呈现流畅且视觉效果出色的 3D 世界。</p>
<h6 data-id="heading-7">MediaPipe Hands 的手势识别功能</h6>
<p><strong>MediaPipe Hands</strong> 是强大的手势识别库，能实时跟踪手部关键点位置和动作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/695f1c1d792846628e642c117ea54182~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55yL5pm05aSp5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765033978&amp;x-signature=3we%2FvDh6vIeJWG2E62cYG1WvTSQ%3D" alt="" loading="lazy"/></p>
<p>在项目中，它与 <strong>Three.js</strong> 紧密结合，实现手势与 3D 场景的无缝交互。</p>
<h4 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>快速本地运行</h4>
<p>项目体验起来很有趣，手势操作简单，并且这个项目是开源的，对前端开发者来说是个很好的学习资源。</p>
<p>特别是想在 <strong>3D</strong> 领域深入学习的开发者，可以通过阅读和研究该项目的代码，了解如何结合 <strong>Three.js</strong> 和 <strong>MediaPipe</strong> 实现复杂的交互效果。</p>
<p>如果你也对这个项目感兴趣，不妨动手下载源码试试。以下是下载和运行项目的教程：</p>
<p>克隆项目仓库：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> git@github.com:collidingScopes/stark-shapes.git
智能体编程go
运行
</code></pre>
<p>安装项目依赖：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> stark-shapes
npm install
智能体编程go
运行
</code></pre>
<p>启动项目：</p>
<pre><code class="hljs language-go" lang="go">npm start
智能体编程<span class="hljs-keyword">go</span>
运行
</code></pre>
<p>在浏览器中打开 <code>http://localhost:8080</code> 即可查看项目效果。</p>
<p>总之， <strong>“stark-shapes”</strong> 项目实现手势操控 <strong>3D 粒子动画</strong>，带来新交互体验，是优质学习平台，拓展应用前景广阔。</p>
<p>感兴趣的朋友可体验在线预览或克隆源码深入研究。</p>
<ul>
<li><strong>stark-shapes Github 地址</strong>：<code>https://github.com/collidingScopes/stark-shapes/tree/main</code></li>
<li><strong>stark-shapes 在线体验地址</strong>：<code>https://collidingscopes.github.io/stark-shapes/</code></li>
</ul>
<p>（首次访问体验地址较慢，耐心等待资源加载。当摄像头里的手势出现识别圆点连线后，就可以体验了。）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3天，1人，从0到付费产品：AI时代个人开发者的生存指南]]></title>    <link>https://juejin.cn/post/7577653509862654002</link>    <guid>https://juejin.cn/post/7577653509862654002</guid>    <pubDate>2025-11-29T08:49:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577653509862654002" data-draft-id="7577663384423645235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3天，1人，从0到付费产品：AI时代个人开发者的生存指南"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-11-29T08:49:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HiStewie"/> <meta itemprop="url" content="https://juejin.cn/user/1591748568038823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3天，1人，从0到付费产品：AI时代个人开发者的生存指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748568038823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HiStewie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T08:49:51.000Z" title="Sat Nov 29 2025 08:49:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>这不是一篇教你用AI写代码的文章。这是一篇关于如何用AI重新定义你的能力边界的实战复盘。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、别焦虑了，先把东西做出来</h2>
<p>最近一周，我的朋友圈和流媒体被两种内容刷屏：</p>
<ul>
<li>一种是 <strong>Gemini 3 Pro要把程序员干死了</strong> ，配文是个悲观预测，写了一大堆分析。</li>
<li>另一种是"<strong>前端凉了</strong>"，配图是某个很牛逼但没什么 x 用的 CSS3 动画Demo；</li>
</ul>
<p>焦虑是真实的。但我想说一句可能会得罪人的话：</p>
<p><strong>大部分人的焦虑，都是"看别人做"带来的，而不是"自己做"带来的。</strong></p>
<p>当你真正动手用AI做一个完整产品的时候，你会发现：AI确实很强，但它还远没有强到能独立完成任何事情。
它需要你告诉它做什么，需要你判断它做得对不对，需要你把零散的能力串成一个可运行的系统。</p>
<p>所以我做了一个实验：<strong>用3天时间，一个人，从0开始，做一个能收钱的AI产品。</strong></p>
<p>不是Demo，不是概念验证，是一个真正上线、真正打通付费流程，完整的商业产品。</p>
<p>具体时间分配：</p>
<ul>
<li><strong>Day 1</strong>：网站架子 + 后端数据库设计</li>
<li><strong>Day 2</strong>：MVP核心功能 + 上线部署</li>
<li><strong>Day 3</strong>：样式打磨 + 用户体验优化 + 国际化 + 人工测试</li>
</ul>
<p>这篇文章是完整的复盘。</p>
<hr/>
<h2 data-id="heading-1">二、不做通用，做内容 - "Content is King",</h2>
<p>先说产品是什么：<strong>「第N个我」—— Prompt 文生图工具。</strong></p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nthme.org%2F" target="_blank" title="https://www.nthme.org/" ref="nofollow noopener noreferrer">www.nthme.org/</a></p>
<p>用户上传一张照片，选择一个"世界线"，AI生成一张那个平行宇宙里的你。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbbd65b2b8a343a39af18cf3b7de1baa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765011334&amp;x-signature=RxuMpSOYcO8XcNxlQ2vE%2F8m6hHU%3D" alt="截屏2025-11-29 15.21.31.png" loading="lazy"/></p>
<p>市面上的AI头像产品，大多走两条路：</p>
<ul>
<li><strong>通用型</strong>：你输入任意Prompt，AI随便生。自由度高，但门槛也高，普通用户根本不知道写什么。</li>
<li><strong>大厂型</strong>：自然语言输入，比如豆包或者元宝，传一张图片然后告诉 AI 怎么改。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95d74147c978463a8cacf72a766129e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765011334&amp;x-signature=%2BrdSJZj3pHIRiNDnSRDyEcfWNI4%3D" alt="截屏2025-11-29 15.28.16.png" loading="lazy"/></p>
<ul>
<li>这些是竞品，想抢他们的流量，卷价格对个人开发者来说永远是下策；</li>
<li>卷功能吗？都是套壳AI文生图，谁也别笑话谁</li>
<li>就只能卷新意了，网站有没有让人眼前一亮，或者自成一套体系的文化(但这也很玄学，我还在摸索中)</li>
</ul>
<hr/>
<h2 data-id="heading-2">三、商业逻辑：为什么这件事能赚钱？</h2>
<p>说完产品出发思路，现在来谈谈钱。</p>
<p>这个产品的商业模式，本质上是一个非常经典的 “<strong>信息差 + 技术降维"（Arbitrage + Wrapper）模型</strong>。”</p>
<p>在中国市场，这被叫做"套壳站"——但我更愿意称之为"<strong>场景化AI工具</strong>"。</p>
<h3 data-id="heading-3">区别在哪？</h3>
<p>套壳站是简单的 API 转发，没有产品设计，没有用户体验，就是把别人的能力包一层皮卖出去。</p>
<p>场景化AI工具是<strong>在套壳的基础上，解决一个具体问题</strong>。</p>
<p>你想想，对于绝大多数中国用户来说：</p>
<ul>
<li><strong>Prompt是玄学</strong>：不知道写什么，写了也不对</li>
<li><strong>翻墙是红线</strong>：不会翻，不敢翻，嫌麻烦</li>
</ul>
<p>这两者加起来，构成了巨大的付费意愿。</p>
<p>我做的事情，就是<strong>吃掉这两层成本</strong>：</p>
<ul>
<li>用户不用学 Prompt → 我帮你精挑细选好 N 套 Prompt（很多Prompt都是垃圾，需要自己不停调试）</li>
<li>用户不用翻墙 → Nanobanana 你国内用不了，我服务器代理帮你调用</li>
</ul>
<p><strong>本质上，我们是中间商（Reseller），不只这个产品，任何AI工具只要你不是研究模型的开发者，你都是中间商</strong></p>
<p>但中间商不是贬义词。</p>
<p>淘宝卖家是中间商，滴滴司机是中间商，你公司的销售也是中间商。中间商的底层价值是『<strong>降低交易摩擦</strong>』。</p>
<p>我的价值就是：<strong>技术降维 + 场景化封装</strong>。</p>
<p>把一个"需要懂技术才能用"的能力，变成"打开网页就能用"的产品。</p>
<p>这件事能赚多少钱？不知道。但我知道，愿意为"发一张不一样的朋友圈"付费的人，远比愿意学Prompt的人多得多。</p>
<hr/>
<h2 data-id="heading-4">四、MVP：砍功能是最难的技术活</h2>
<p>我见过太多独立开发者的项目死在"功能太多"上。</p>
<p>不是没做完，是做了太多。每个功能都是60分，合在一起就是一坨不可用的东西。有代码洁癖、有完美主义情节没错，但是如果你要想做一个商业产品，很显然你需要全面的考量</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92b4a8a0ecf04c15bfcb8538344ed5fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765011334&amp;x-signature=OgyKabGXkBuuHDpphm90IhtSjAs%3D" alt="截屏2025-11-29 15.38.09.png" loading="lazy"/>
所以我给自己定了一个规则：<strong>MVP只保留能完成"付费闭环"的功能。</strong></p>
<p>什么是付费闭环？用户进来 → 产生价值 → 愿意付钱 → 支付成功。</p>
<p>任何不在这条链路上的功能，全部砍掉。</p>
<p><strong>砍掉的：</strong></p>
<ul>
<li>❌ 用户自定义Prompt（增加理解成本）</li>
<li>❌ 社区分享功能（分散注意力）</li>
<li>❌ 批量生成（复杂化定价）</li>
<li>❌ 生成历史管理（非核心痛点，还涉及用户隐私风险）</li>
</ul>
<p><strong>保留的：</strong></p>
<ul>
<li>✅ N 个精选世界线（核心产品力）</li>
<li>✅ 即时生成预览（价值感知）</li>
<li>✅ 简单的积分系统（付费机制）</li>
<li>✅ 一键下载（价值交付）</li>
</ul>
<p>你可能会说：生成历史不重要吗？用户可能想回看啊。</p>
<p>重要，但不是Day 1重要。</p>
<p><strong>如果用户连第一次生成都不愿意付费，那生成历史有什么意义？</strong></p>
<p>MVP的核心是验证一件事：有没有人愿意为这个产品付钱。其他都是验证之后的事。</p>
<hr/>
<h2 data-id="heading-5">五、技术选型：偷懒是一种能力</h2>
<p>独立开发者最稀缺的资源是时间。所以技术选型的核心标准只有一个：<strong>用最少的时间，搭建一个可运行的系统。</strong></p>
<p>这是我的选择：</p>








































<table><thead><tr><th>需求</th><th>选择</th><th>为什么</th></tr></thead><tbody><tr><td>框架</td><td>Next.js 14</td><td>App Router + API Routes，前后端一把梭</td></tr><tr><td>样式</td><td>Tailwind CSS</td><td>不用写CSS文件，不用起类名</td></tr><tr><td>数据库</td><td>PostgreSQL + Prisma</td><td>类型安全，迁移方便，Vercel Postgres免费</td></tr><tr><td>认证</td><td>NextAuth.js</td><td>10分钟搞定登录注册</td></tr><tr><td>部署</td><td>Vercel</td><td>Git push即部署，零运维</td></tr><tr><td>AI</td><td>Nano Banana API</td><td>稳定，便宜，按量付费</td></tr></tbody></table>
<p>你可能注意到，这套技术栈几乎全是"开箱即用"型的。</p>
<p>没有自己写鉴权逻辑，没有自己配CI/CD，没有自己管服务器。</p>
<p><strong>这不是偷懒，这是杠杆。</strong></p>
<p>5202年了，这些轮子已经有人造好了，而且造得比你自己造的好 10 倍。你的时间应该花在"只有你能做"的事情上——产品设计、用户体验、商业逻辑。</p>
<p>基础设施？让别人来。</p>
<hr/>
<h2 data-id="heading-6">六、登录注册：10分钟，真的</h2>
<p>NextAuth.js 是我用过最省心的认证库。</p>
<p>整个登录系统，包括：</p>
<ul>
<li>邮箱密码注册/登录</li>
<li>Google OAuth</li>
<li>Session管理</li>
<li>数据库同步</li>
</ul>
<p>代码量：1个配置文件 + 1个Prisma Schema。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// auth.ts 核心配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">authOptions</span>: <span class="hljs-title class_">NextAuthOptions</span> = {
  <span class="hljs-attr">providers</span>: [
    <span class="hljs-title class_">CredentialsProvider</span>({
      <span class="hljs-attr">name</span>: <span class="hljs-string">'credentials'</span>,
      <span class="hljs-attr">credentials</span>: {
        <span class="hljs-attr">email</span>: { <span class="hljs-attr">label</span>: <span class="hljs-string">'Email'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'email'</span> },
        <span class="hljs-attr">password</span>: { <span class="hljs-attr">label</span>: <span class="hljs-string">'Password'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'password'</span> },
      },
      <span class="hljs-keyword">async</span> <span class="hljs-title function_">authorize</span>(<span class="hljs-params">credentials</span>) {
        <span class="hljs-comment">// 验证逻辑</span>
      },
    }),
    <span class="hljs-title class_">GoogleProvider</span>({
      <span class="hljs-attr">clientId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">GOOGLE_CLIENT_ID</span>!,
      <span class="hljs-attr">clientSecret</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">GOOGLE_CLIENT_SECRET</span>!,
    }),
  ],
  <span class="hljs-comment">// ... 其他配置</span>
};
</code></pre>
<p>一个踩坑点：Credentials Provider 的 session 处理。</p>
<p>NextAuth默认的session只包含很少的用户信息。如果你用数据库存用户，需要在callbacks里手动把userId塞进去：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">callbacks</span>: {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">jwt</span>(<span class="hljs-params">{ token, user }</span>) {
    <span class="hljs-keyword">if</span> (user) token.<span class="hljs-property">id</span> = user.<span class="hljs-property">id</span>;
    <span class="hljs-keyword">return</span> token;
  },
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">session</span>(<span class="hljs-params">{ session, token }</span>) {
    <span class="hljs-keyword">if</span> (session.<span class="hljs-property">user</span>) session.<span class="hljs-property">user</span>.<span class="hljs-property">id</span> = token.<span class="hljs-property">id</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
    <span class="hljs-keyword">return</span> session;
  },
},
</code></pre>
<p>就这么多。10分钟，登录系统搞定。一个Google邮箱登录，一个基础的账号密码登录 + 一个注册；</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea8523f5147c436ca4bdac8c5d42e11c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765011334&amp;x-signature=7jlEHJ0es8SgfDLuVs5iheOCrSU%3D" alt="截屏2025-11-29 16.41.27.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7">七、后端逻辑：积分系统的信任架构</h2>
<p>积分系统听起来简单：用户充钱 → 加积分 → 生成图片 → 扣积分。</p>
<p>但魔鬼在细节里。</p>
<p><strong>问题1：扣积分和生成图片，谁先谁后？</strong></p>
<p>错误做法：先生成图片，成功后再扣积分。</p>
<ul>
<li>风险：生成成功但扣积分失败，用户白嫖。</li>
</ul>
<p>正确做法：先扣积分，失败后再退回。</p>
<ul>
<li>逻辑：先"冻结"积分，生成成功则确认扣除，失败则退回。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 伪代码</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">deductCredits</span>(userId, cost);  <span class="hljs-comment">// 先扣</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateImage</span>(prompt);
  <span class="hljs-keyword">return</span> image;  <span class="hljs-comment">// 成功，积分已扣</span>
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">refundCredits</span>(userId, cost);  <span class="hljs-comment">// 失败，退回</span>
  <span class="hljs-keyword">throw</span> error;
}
</code></pre>
<p><strong>问题2：如何防止订单重复处理？</strong></p>
<p>爱发电的Webhook可能会重复发送。如果不做幂等处理，用户可能被多次加积分。</p>
<p>解决方案：用 <code>afdianOrderId</code> 做唯一键。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 检查订单是否已处理</span>
<span class="hljs-keyword">const</span> existing = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">transaction</span>.<span class="hljs-title function_">findFirst</span>({
  <span class="hljs-attr">where</span>: { <span class="hljs-attr">afdianOrderId</span>: orderId },
});
<span class="hljs-keyword">if</span> (existing) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">ec</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">em</span>: <span class="hljs-string">'Already processed'</span> };
}
</code></pre>
<p><strong>问题3：免费额度怎么设计？</strong></p>
<p>新用户应该能免费试用，否则付费转化无从谈起。</p>
<p>我的设计：注册即送 10 积分（够生成2次），每日签到送 2 积分（不够生成1次，但积累2天可以）。</p>
<blockquote>
<p>PS：签到功能还没实现哈，后续加上，很快</p>
</blockquote>
<p>这个数字是刻意的：</p>
<ul>
<li>10 积分让用户体验核心功能</li>
<li>每日 2 积分制造"再来一次"的动机</li>
<li>但不够随便用，必须付费才能畅玩</li>
</ul>
<p><strong>积分系统的本质是信任系统：用户相信付了钱就能用，你相信用户不会薅走你的服务。</strong></p>
<hr/>
<h2 data-id="heading-8">八、收款：个人开发者的变现困境</h2>
<p>技术问题都好解决，最难的是收钱。</p>
<p>作为个人开发者，你会撞上这些墙：</p>
<ul>
<li>微信/支付宝官方支付：需要企业资质,你要开公司，办营业执照，申请各种东西</li>
<li>Stripe：需要海外公司</li>
<li>国内第三方支付：大多数也要企业资质，或者费率高得离谱</li>
</ul>
<p>我的解决方案：<strong>爱发电</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47a243f7d9b444e48ba9426be8211f5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765011334&amp;x-signature=iK0aUyBfhYa2jCEF6eJgexS1cA8%3D" alt="截屏2025-11-29 16.50.44.png" loading="lazy"/></p>
<p>爱发电是一个创作者赞助平台，个人可以直接使用，费率合理（约6%），支持 Webhook 回调（很重要，充值成功的回调就靠它）。</p>
<p>集成流程：</p>
<ol>
<li>用户在产品内点击"充值"</li>
<li>跳转到爱发电对应档位页面</li>
<li>用户付款，爱发电回调你的 <strong>Webhook</strong></li>
<li>你的服务器处理回调，给用户加积分</li>
</ol>
<p>关键技巧：<strong>用户的邮箱从哪来？</strong></p>
<p>爱发电的订单信息不包含用户邮箱，只有赞助者的爱发电昵称。怎么和你数据库里的用户对应上？</p>
<p>我的做法：让用户在爱发电的"留言"字段填写自己的注册邮箱。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 从留言中提取邮箱</span>
<span class="hljs-keyword">const</span> emailMatch = order.<span class="hljs-property">remark</span>?.<span class="hljs-title function_">match</span>(
  <span class="hljs-regexp">/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/</span>
);
<span class="hljs-keyword">const</span> email = emailMatch?.[<span class="hljs-number">0</span>]?.<span class="hljs-title function_">toLowerCase</span>();
</code></pre>
<p>不够优雅？确实。但 MVP 阶段，能跑通比优雅更重要。</p>
<p>未来可以升级为：</p>
<ul>
<li>用户在产品内绑定爱发电账号</li>
<li>生成唯一的充值链接/兑换码</li>
<li>或者用户量真的起来了，你再去申请公司，办营业执照，接支付宝/微信</li>
</ul>
<p><strong>MVP的哲学：先有再好。</strong> 爱发电只是一个你用来测试用户付费意愿 + 前期市场验证的低成本工具</p>
<p>PS：问题发现，爱发电支付宝链路不同，目前只能用微信</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78fb0bf333f94ca98684851d74313965~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765011334&amp;x-signature=OIalV7WYFM4B2PMRuodYwIY3xwU%3D" alt="截屏2025-11-29 16.12.37.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-9">九、审美：UI/UX 的作用是"显得值钱"</h2>
<ul>
<li>UI（User Interface，用户界面）是「产品的外观与交互载体」
<ul>
<li><strong>看得见、摸得着</strong>：比如界面的色彩搭配、按钮样式、字体大小、图标设计、页面布局，核心是让产品“美观、易用、符合视觉逻辑”。</li>
</ul>
</li>
<li>UX（User Experience，用户体验）是「用户使用产品的完整感受与效率」。
<ul>
<li><strong>用得爽、没阻碍</strong>：比如用户从打开APP到完成目标（如购物、打车）的步骤是否简洁、操作是否流畅、遇到问题能否快速解决，甚至包括品牌印象、售后体验，核心是让产品“满足需求、降低成本、带来愉悦感”。</li>
</ul>
</li>
</ul>
<p>首先，我们需要纠正一个工程师常见的误区。</p>
<p>很多开发者觉得“设计”是玄学，或者是设计师的事，与代码无关。</p>
<p><strong>大谬！设计是产品的一部分，而且是用户最先感知到的部分。</strong></p>
<p>你的架构再优雅，用户不关心；你的算法再先进，用户看不见。用户第一眼看到的就是 UI，而第一印象决定了他们是掏钱还是关闭网页。 在这里，我要抛出一个更露骨的观点：<strong>对于独立产品而言，UI 的作用不是“好看”，而是“显得值钱”。</strong></p>
<p>我们的目标用户是谁？是那些为了发朋友圈、发小红书愿意付费的人。这群人不懂技术，也不关心你用了什么模型。他们只看一件事：<strong>这个产品看起来牛不牛逼？</strong></p>
<p>如果你的 UI 看起来像个 Bootstrap 拼凑的学生作业，用户潜意识会觉得：“这玩意儿生成的图能好吗？5 块钱我都嫌多。” 如果你的 UI 看起来像个<strong>黑科技实验室</strong>，用户会觉得：“哇，这个系统好高级，生成的图肯定不一样。50 块钱？值！”</p>
<h3 data-id="heading-10">UI/UX 是定价权的一部分</h3>
<h4 data-id="heading-11">1. 色彩系统</h4>
<p>所以我给「第 N 个我」定的视觉基调是：<strong>Steins;Gate（命运石之门） × Cyberpunk 2077 × Neo-Brutalist。</strong></p>
<p>有人问：<em>“为什么不选永远不会出错的 Apple Style（极简白/磨砂玻璃）？”</em></p>
<p>这涉及到底层逻辑的选择：<strong>Content is King（内容为王）</strong>。</p>
<ul>
<li><strong>Apple Style</strong> 是中性的、克制的。它像一杯白开水，不承载任何情绪，适合通用工具（如备忘录、日历）。</li>
<li><strong>Cyberpunk Style</strong> 是激进的、有侵略性的。它是一个<strong>情绪容器</strong>。</li>
</ul>
<p>我的产品不是一个“修图工具”，而是一个“科幻引擎”。苹果的设计语言太冷静了，无法承载“穿越平行宇宙”的疯狂感。我需要的是<strong>躁动、电流和不确定性</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a7c3ad03ee44acc99490f39f5b86723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765011334&amp;x-signature=03lHvKJv43WWV6XyKluD8DTC8rk%3D" alt="截屏2025-11-29 15.53.46.png" loading="lazy"/></p>
<p>一开始我试过 Vibe Coding 的蓝紫配色（渐变紫、霓虹蓝那一套）。但做出来发现一个问题：<strong>太像廉价的诈骗页了。</strong> 那种配色现在已经烂大街，用户一看就觉得："又是什么割韭菜的东西。"</p>
<p>于是我换了方向：<strong>电光绿（Acid Green）+ 终端风格</strong>。效果立刻不一样了：</p>
<ul>
<li>黑色背景 + 荧光绿文字 = 终端命令行</li>
<li>等宽字体 + 方块按钮 = 工程师专用工具</li>
<li>二进制雨 + 扫描线效果 = 黑客帝国既视感</li>
</ul>
<p><strong>这种"硬核感"营造出一种"实验室出品"的稀缺感。</strong></p>
<h4 data-id="heading-12">2. 视觉元素</h4>
<p>二进制雨（BinaryRain组件）：</p>
<ul>
<li>首页背景不断下落的 0 和 1，致敬《黑客帝国》。这在暗示用户：你正在接触世界的底层代码。</li>
</ul>
<p>单间距字体（monospace）：</p>
<ul>
<li>全站强制使用等宽字体（代码字体）。</li>
<li>营造出“终端”、“命令行”、“未经修饰”的粗砺感。</li>
</ul>
<p>微动效 (Micro-interaction)：</p>
<ul>
<li>按钮 Hover 时的故障 (Glitch) 效果；</li>
<li>卡片的悬浮阴影；</li>
<li>加载时的脉冲动画。</li>
</ul>
<blockquote>
<p>还有很多小巧思就不赘述了，可以自己点击看看</p>
</blockquote>
<h4 data-id="heading-13">3. 文案调性</h4>
<p>在设计文案时，我制定了一条铁律：严禁出现‘用户’、‘购买’、‘生成’这三个词。</p>
<p><strong>我构建了一套「观测者叙事」体系。</strong></p>
<ul>
<li>身份重构：屏幕前的不是“客户”，而是手握终端的 <strong>“观测员” (Observer)</strong>。</li>
<li>行为重构：他们支付的不是钱💰，而是维持量子态稳定的 <strong>“算力能源” (Energy)</strong>。</li>
</ul>
<p>这不仅仅是为了酷，这是基础的商业心理学。</p>
<p>当“花 39 块钱买个会员”变成了“为超弦引擎注入能量以解锁高维权限”时，用户的心理账户 (Mental Accounting) 就发生了转移：</p>
<ul>
<li>从斤斤计较的 <strong>“实用工具/日常开销”</strong> 账户（对标买菜、买文具）；</li>
<li>转移到了 <strong>“娱乐/游戏体验”</strong> 账户（对标买皮肤、抽卡）。</li>
</ul>
<p>在这个新账户里，用户的付费意愿是极高的，价格敏感度是极低的。</p>
<p>结论：产品即叙事。每一个按钮、每一行文案，都在构建那个平行宇宙。这就是审美的商业价值——它让用户觉得“这个东西值这个价”。</p>
<hr/>
<h2 data-id="heading-14">十、i18n国际化与地理套利：代码世界的“降维打击</h2>
<p><strong>国际化很重要，国际化很重要，国际化很重要，重要的事情说 3 遍</strong></p>
<p>在开发初期，我就坚定地把 <strong>i18n（国际化）</strong> 列为 P0 级需求，而不是“有空再做”的锦上添花。这背后不是为了显得高大上，而是基于一个赤裸裸的商业逻辑：<strong>地理套利 (Geo-Arbitrage)</strong>。</p>
<p>作为独立开发者，我们的肉身或许被禁锢在某个具体的时空坐标，但我们的代码和产品可以在光纤中自由穿梭。</p>
<h3 data-id="heading-15">1. 购买力平价的“汇率魔法”</h3>
<p>这是一个简单的数学题，也是一个残酷的现实：</p>
<p>在国内，让用户掏出 <strong>¥19.9</strong> 可能需要你写 500 字的文案、做 3 张精美的海报，还得应对“能不能便宜点”的客服咨询，甚至面临被举报的风险。</p>
<p>而在北美或欧洲市场，<strong>$9.99 (约 ¥72)</strong> 对用户来说仅仅是“一杯星巴克 + 小费”的价格。</p>
<ul>
<li><strong>心理账户差异</strong>：欧美用户的 SaaS 订阅习惯极其成熟。对于 $10 以下的数字产品，他们的决策成本几乎为零（No-brainer decision）。</li>
<li><strong>杠杆效应</strong>：同样的 GPU 算力消耗，同样的开发时间成本，仅仅因为语言不同，<strong>你的单位时间产出（ROI）直接放大了 7 倍</strong>。这就是代码世界的“汇率魔法”。</li>
</ul>
<h3 data-id="heading-16">2. 逃离“内卷”引力圈</h3>
<p>国内的 C 端工具类产品市场早已是一片红海，同质化竞争导致价格战频发（Race to the bottom）。</p>
<p>而通过 i18n，我们将战场转移到了全球（市场扩大）。虽然全球竞争也激烈，但你的创意总会带你杀出重围！</p>
<h3 data-id="heading-17">3. 收入结构的抗脆弱性 (Antifragility)</h3>
<p>当你的收入来源不仅限于人民币，而是包含了美元、欧元、日元时，你的个人财务系统就具备了极强的<strong>抗脆弱性</strong>。</p>
<p>你不再依赖单一市场的经济周期。哪怕某个区域的支付渠道暂时波动，全球各地的“观测员”依然在源源不断地为你的终端注入能源。</p>
<h3 data-id="heading-18">📊 市场维度对比表</h3>

























<table><thead><tr><th align="left">维度</th><th align="left">国内市场 (CNY)</th><th align="left">全球市场 (USD/EUR)</th></tr></thead><tbody><tr><td align="left"><strong>决策阻力</strong></td><td align="left">高 (习惯免费/破解)</td><td align="left">低 (习惯订阅/付费)</td></tr><tr><td align="left"><strong>收入倍率</strong></td><td align="left">1x (基准)</td><td align="left"><strong>7x ~ 8x (地理套利)</strong></td></tr><tr><td align="left"><strong>竞争态势</strong></td><td align="left">极度内卷 (红海)</td><td align="left">审美差异化 (蓝海)</td></tr></tbody></table>
<p><strong>一句话总结：</strong>
<strong>i18n 不是简单的翻译，它是独立开发者实现“赚美元，花人民币”这一终极梦想的入场券，也是将个人影响力辐射至全球的必经之路。</strong></p>
<p>注意，i18n不只是翻译。它强迫你思考：</p>
<ul>
<li>这段文案的核心意思是什么？</li>
<li>换一种语言，怎么表达同样的意思？</li>
<li>有些概念在另一种文化里存在吗？</li>
</ul>
<p>比如"建立纠缠"这个按钮，直译是"Create Entanglement"。但英文用户会觉得莫名其妙。</p>
<p>最终我用的是"Establish Link"——保留了"建立连接"的意思，丢掉了"量子纠缠"的梗。</p>
<p><strong>翻译不是对照词典，是重新创作。</strong> 技术实现上，我用的是最朴素的方案：文件级i18n。</p>
<pre><code class="hljs language-js" lang="js">lib/i18n/
├── locales/
│   ├── zh-<span class="hljs-variable constant_">CN</span>.<span class="hljs-property">ts</span>  <span class="hljs-comment">// 中文</span>
│   └── en-<span class="hljs-variable constant_">US</span>.<span class="hljs-property">ts</span>  <span class="hljs-comment">// 英文</span>
├── context.<span class="hljs-property">tsx</span>   <span class="hljs-comment">// React Context</span>
└── types.<span class="hljs-property">ts</span>      <span class="hljs-comment">// 类型定义</span>
</code></pre>
<p>没有用 next-intl 或 i18next 这些库，因为项目规模不需要。简单的 Context + TypeScript 类型约束就够了。</p>
<p>未来做SEO的时候，可能需要多语言URL（<code>/en/showcase</code> vs <code>/zh/showcase</code>）。但MVP阶段，浏览器语言检测 + 手动切换就够用了。</p>
<hr/>
<h2 data-id="heading-19">十一、部署：Vercel，在“墙”与“云”之间寻找缝隙</h2>
<h3 data-id="heading-20">理想状态：Git Push 即部署</h3>
<p>以前部署一个网站，通过是：买服务器 -&gt; 装 Nginx -&gt; 配域名 -&gt; 申请 SSL 证书 -&gt; 写 CI/CD 脚本……
现在？</p>
<ol>
<li>代码推到 GitHub</li>
<li>Vercel 里 Import 项目</li>
<li>配置环境变量</li>
<li>点击 Deploy</li>
</ol>
<p><strong>完了。</strong>
自动 CI/CD、自动 HTTPS、自动 CDN、自动预览部署。这就是现代独立开发的“基建红利”。</p>
<p>你的时间和精力，应该100%放在产品本身。</p>
<h3 data-id="heading-21">现实引力：国内访问的“坑”</h3>
<p>然而，当我兴奋地把生成的 <code>xxx.vercel.app</code> 链接发给国内的朋友时，得到的反馈却是：“打不开”、“连接重置”。</p>
<p><strong>原因很简单</strong>：<code>*.vercel.app</code> 这个后缀在国内因为众所周知的原因，DNS 污染严重，基本处于不可用状态。</p>
<h3 data-id="heading-22">🛠️ 避坑指南：Cloudflare + Vercel 组合拳</h3>
<p>要解决这个问题，不能依赖 Vercel 分配的免费域名，必须绑定<strong>自定义域名</strong>。以下是我的实战配置（踩坑）总结：</p>
<ol>
<li><strong>域名购买</strong>：随便哪里买（Namecheap/阿里云/腾讯云），但建议把 DNS 解析托管到 <strong>Cloudflare</strong>。</li>
<li><strong>CNAME 配置</strong>：
<ul>
<li>在 Vercel 后台 -&gt; Settings -&gt; Domains，添加你的域名（如 <code>app.yourdomain.com</code>）。</li>
<li>Vercel 会提示你添加一条 CNAME 记录指向 <code>cname.vercel-dns.com</code>。</li>
</ul>
</li>
<li><strong>Cloudflare 的“小黄云”陷阱</strong>：
<ul>
<li>在 Cloudflare 添加 CNAME 时，<strong>建议先关闭 Proxy（点灰那个小黄云图标，仅使用 DNS only）</strong>。</li>
<li><strong>为什么？</strong> 如果开启 Proxy（小黄云），Cloudflare 会再次代理流量，虽然能提供防护，但有时会和 Vercel 的 SSL 签发冲突，导致“重定向次数过多”或证书错误。</li>
<li><em>进阶方案</em>：如果你一定要开小黄云（为了抗攻击），请务必在 Cloudflare 的 SSL/TLS 设置中选择 <strong>"Full (Strict)"</strong> 模式。</li>
</ul>
</li>
</ol>
<p><strong>结论</strong>：只要配置了自定义域名 + 正确的 CNAME，国内用户就能通过优选线路流畅访问你的“量子观测站”，无需梯子。</p>
<hr/>
<h2 data-id="heading-23">十二、增量思维：上线只是“第一次接触”</h2>
<p>MVP (Minimum Viable Product) 上线了，然后呢？</p>
<p>很多独立开发者容易在这里迷失，陷入两个极端：</p>
<ol>
<li><strong>过度开发的陷阱</strong>：用户还没来，后台管理系统已经写得比淘宝还复杂。这是在制造“代码垃圾”。</li>
<li><strong>射后不理的傲慢</strong>：上线即巅峰，等着流量自然降临。这是在赌博。</li>
</ol>
<p>在我的逻辑里，<strong>上线不是结束，而是“观测”的开始。</strong>
正确的姿势是：<strong>根据真实反馈，对抗熵增，增量迭代。</strong></p>
<h3 data-id="heading-24">🗺️ 时间线演化路线图 (Timeline Roadmap)</h3>
<p>我给自己制定了一个严格的“三步走”战略，<strong>严禁跨阶段开发</strong>：</p>
<p><strong>Phase 1: 奇点点火 (V1.0 Current)</strong></p>
<ul>
<li><strong>目标</strong>：验证核心商业闭环 (PMF)。</li>
<li><strong>状态</strong>：✅ 已上线</li>
<li><strong>内容</strong>：
<ul>
<li>6 个核心平行世界线 (风格模型)</li>
<li>基于积分的能源消耗系统</li>
<li>爱发电 (Aifadian) 支付链路打通</li>
</ul>
</li>
<li><em>潜台词：只要能跑通“生成-&gt;满意-&gt;付费”这一个循环，其他的都不重要。</em></li>
</ul>
<p><strong>Phase 2: 体验补完 (V1.1 Planning)</strong></p>
<ul>
<li><strong>目标</strong>：提升留存率 (Retention)，减少操作摩擦。</li>
<li><strong>内容</strong>：
<ul>
<li><strong>观测日志 (History)</strong>：用户不想每次都重新生成，他们需要找回之前的“感动”。</li>
<li><strong>批量下载 (Batch Export)</strong>：从“玩票”到“生产力”的转变。</li>
<li><strong>多维支付</strong>：接入 Stripe/USDT，为全球化做准备。</li>
</ul>
</li>
</ul>
<p><strong>Phase 3: 维度扩张 (V2.0 Vision)</strong></p>
<ul>
<li><strong>目标</strong>：构建生态 (Ecosystem) 与网络效应。</li>
<li><strong>状态</strong>：🔒 待解锁</li>
<li><strong>内容</strong>：
<ul>
<li><strong>自定义协议 (UGC)</strong>：允许用户上传图片训练自己的 LoRA，并上架到“商店”。</li>
<li><strong>社区共振</strong>：分享你的观测结果，获得积分奖励。</li>
<li><strong>API 开放</strong>：让其他开发者接入我的“量子算力”。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-25">🛑 核心原则：先有付费，再有功能</h3>
<p>请注意这个顺序：<strong>先有付费用户，再加功能。</strong></p>
<p>因为没有用户反馈的功能开发，本质上是一种**“自嗨” (Self-High)**。你坐在屏幕前以为用户需要“暗黑模式”或“社交分享”，但数据可能会告诉你，他们只想要一个“一键高清放大”按钮。</p>
<p><strong>最好的产品经理不是你，是你的用户。</strong>
不要去猜宇宙的形状，去听观测员发回的信号。听他们的，改代码，然后再次发布。</p>
<hr/>
<h2 data-id="heading-26">十三、结语：AI时代，拿回你的生产资料</h2>
<p>写到这里，回头看那个最初萦绕在每个人心头的问题：<strong>AI 时代，开发者会被取代吗？</strong></p>
<p>我的答案是：<strong>不会，但会被重新定义。</strong></p>
<h3 data-id="heading-27">代码的贬值与人的升值</h3>
<p>在过去，开发者的价值锚点是 <strong>"How"</strong> —— 你会不会写代码？你会不会优化算法？</p>
<p>而在今天，开发者的价值锚点转移到了 <strong>"What" &amp; "Why"</strong> —— 你知不知道要做什么？你知不知道为什么而做？</p>
<p>代码只是工具，是连接现实与数字世界的铲子。AI 让这把铲子变成了挖掘机，但挖掘机本身不会决定去哪里挖掘宝藏。</p>
<p><strong>决定做什么、为谁做、赋予产品什么样的灵魂——这是人的特权，也是人的责任。</strong></p>
<h3 data-id="heading-28">一个人，就是一支队伍</h3>
<p>这个项目，我用了 3 天做完。如果没有 AI 辅助编码，可能需要 2 周甚至更久。AI 帮我节省了 80% 的时间。</p>
<p>但那省下的时间，我没有用来刷短视频。
我用它来思考产品定位，去推敲每一个文案的语气，去打磨视觉风格，去构建那个关于“观测者”的世界。</p>
<p><strong>AI 不是来取代你的，它是来放大你的。</strong></p>
<p>它是一面镜子，也是一个放大器：</p>
<ul>
<li>如果你只会写代码，AI 会让你以十倍的速度写出<strong>没人用的代码</strong>。</li>
<li>如果你懂产品、懂用户、懂商业，AI 会让你<strong>一个人变成一支建制完整的特种小队</strong>。</li>
</ul>
<h3 data-id="heading-29">别焦虑，去创造</h3>
<p>所以，别焦虑了。焦虑不会写出代码，也不会带来用户。</p>
<p>在这个算力爆炸的时代，<strong>想象力</strong>才是唯一的稀缺资源。</p>
<p>打开你的编辑器，不要去想“我要练什么技术栈”，去想一个你真正想解决的问题，去想一个你真正想创造的世界。</p>
<p>然后，开始写下第一行代码。</p>
<blockquote>
<p>AI 会帮你的</p>
<p>世界会看到的</p>
</blockquote>
<hr/>
<p><strong>附：项目信息</strong></p>
<ul>
<li>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTrade-Offf%2FThe-Nth-Me" target="_blank" title="https://github.com/Trade-Offf/The-Nth-Me" ref="nofollow noopener noreferrer">The Nth Me</a></li>
<li>在线体验：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nthme.org%2F" target="_blank" title="https://www.nthme.org/" ref="nofollow noopener noreferrer">www.nthme.org/</a></li>
<li>开源协议：CC BY-NC-SA 4.0（非商业使用）</li>
</ul>
<p>如果这篇文章对你有启发，欢迎分享给同样在焦虑的朋友。</p>
<p>欢迎试用项目，欢迎捉虫和开发建议，如被采纳，将会获赠微型奇点（初级用户卡）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[征程 6 | linear 高精度输出配置方式]]></title>    <link>https://juejin.cn/post/7577970969395298345</link>    <guid>https://juejin.cn/post/7577970969395298345</guid>    <pubDate>2025-11-30T09:19:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577970969395298345" data-draft-id="7577797563854061604" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="征程 6 | linear 高精度输出配置方式"/> <meta itemprop="keywords" content="自动驾驶,算法"/> <meta itemprop="datePublished" content="2025-11-30T09:19:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="地平线开发者"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032132567"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            征程 6 | linear 高精度输出配置方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032132567/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    地平线开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:19:43.000Z" title="Sun Nov 30 2025 09:19:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 常规情况</h2>
<p>基础知识：</p>
<ol>
<li>考虑到模型输出位置量化损失对模型精度的影响较大，工具链推荐模型以 linear/conv 结尾，此时支持高精度 int32 输出（在 quantized.onnx 中，转定点为 int32，在前面 calib+qat 阶段都是 float32），这几乎可以做到无损。</li>
<li>征程 6 工具链量化 setter 模板支持自动设置高精度输出，前提是 conv 输出直接 接 dequant，不作为其他 node 的输入。</li>
</ol>
<p>输出位置结构示意图：</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=NDA4MjU5ZTU2ZWU3NzA4YWRiMDFiNzkzY2JjMzgwMjlfaGg5c2RBSGxhRHo2eWpkeUhURElzY0IyRXpJZzRxZ1ZfVG9rZW46UTA1ZmJQZ2l5b1Zhem94N1pubWNjaUpGblB4XzE3NjQ0OTM2ODE6MTc2NDQ5NzI4MV9WNA" alt="" loading="lazy"/></p>
<p>全流程代码如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">import torch
from horizon_plugin_pytorch import set_march, March
set_march(March.NASH_M)
from horizon_plugin_pytorch.quantization import prepare, set_fake_quantize, FakeQuantState
from horizon_plugin_pytorch.quantization import QuantStub
from horizon_plugin_pytorch.quantization.hbdk4 import export
from horizon_plugin_pytorch.quantization.qconfig_template import (
    calibration_8bit_weight_16bit_act_qconfig_setter,
    qat_8bit_weight_16bit_fixed_act_qconfig_setter, 
    default_calibration_qconfig_setter,
    ModuleNameQconfigSetter
) 

from horizon_plugin_pytorch.quantization.qconfig import get_qconfig, MSEObserver, MinMaxObserver
from horizon_plugin_pytorch.dtype import qint8, qint16
from torch.quantization import DeQuantStub
import torch.nn as nn
from horizon_plugin_pytorch.quantization import hbdk4 as hb4
from hbdk4.compiler import convert, save, hbm_perf, visualize, compile

import torch
import torch.nn as nn

# 定义网络结构
class SmallModel(nn.Module):
    def __init__(self):
        super(SmallModel, self).__init__()
        # 第一个 Linear: 输入 [2, 100, 256] -&gt; 输出 [2, 100, 256]
        self.linear1 = nn.Linear(256, 256)
        self.layernorm = nn.LayerNorm(256)  # 对最后一维进行归一化
        self.relu = nn.ReLU()
        # 第二个 Linear: 输入 [2, 100, 256] -&gt; 输出 [2, 100, 60]
        self.linear2 = nn.Linear(256, 60)
        # 第三个 Linear: 输入 [2, 100, 60] -&gt; 输出 [2, 100, 60]
        self.linear3 = nn.Linear(60, 60)
        self.quant = QuantStub()
        self.dequant = DeQuantStub()

    def forward(self, x):
        x = self.quant(x)
        # 第一个 Linear
        x = self.linear1(x)  # [2, 100, 256]
        x = self.layernorm(x)  # [2, 100, 256]
        x = self.relu(x)  # [2, 100, 256]
        # 第二个 Linear
        y = self.linear2(x)  # [2, 100, 60]
        # 第三个 Linear
        z = self.linear3(y)
        z = self.dequant(z)
        return z

# 设置随机种子，保证每次生成的数据相同
torch.manual_seed(42)
example_input = torch.randn(2, 100, 256)
model = SmallModel()

# 前向传播
output_x = model(example_input)
print("输入形状:", example_input.shape)
print("输出形状:", output_x.shape)

# A global march indicating the target hardware version must be setted before prepare qat.
set_march(March.NASH_M)

calib_model = prepare(model.eval(), example_input, 
                      qconfig_setter=(
                          default_calibration_qconfig_setter,
                          ),
                      )

calib_model.eval()
set_fake_quantize(calib_model, FakeQuantState.CALIBRATION)
calib_model(example_input)

calib_model.eval()                            
set_fake_quantize(calib_model, FakeQuantState.VALIDATION)
calib_out_x = calib_model(example_input)
print("calib输出shape:", calib_out_x.shape)

qat_bc = export(calib_model, example_input)
# save(qat_bc, "qat.bc")
# visualize(qat_bc, "qat.onnx")
hb_quantized_model = convert(qat_bc, March.NASH_M)
# save(hb_quantized_model,"quantized.bc")
visualize(hb_quantized_model, "quantized_single.onnx")
</code></pre>
<p>查看 quantized.onnx，可以看到最后一个 conv 确实是 int32 高精度输出</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmM4N2NhYmJkMzJhODEyNDM1OWZmMTE4OGVhMjI4ZDRfS2hWdjJvTkN6VlhGbEVXU1FEODd3Wm9qNHVnT3ZvMmhfVG9rZW46WDFOTWJ1OHFub2picjd4eFBwaWNISFY2bkkyXzE3NjQ0OTM2ODE6MTc2NDQ5NzI4MV9WNA" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2. 输出又输入</h2>
<p>如果 conv1，既作为模型输出，又作为后续 conv2 的输入，此时应该怎么办？</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=YjY4YjFhMWRlOTFhM2EzMTlhZWU5NzdmOTk1YTkzMjZfazhEZGM4RUM5UVVFa3VmckpVcnVJczNjTGNwaEhTMFBfVG9rZW46QXpUcmI0ek45b1dRb3h4UUFQNmNJczJrbjRjXzE3NjQ0OTM2ODE6MTc2NDQ5NzI4MV9WNA" alt="" loading="lazy"/></p>
<p>关键代码如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">def forward(self, x):
        x = self.quant(x)
        # 第一个 Linear
        x = self.linear1(x)  # [2, 100, 256]
        x = self.layernorm(x)  # [2, 100, 256]
        x = self.relu(x)  # [2, 100, 256]
        # 第二个 Linear
        y = self.linear2(x)  # [2, 100, 60]
        y_out = self.dequant(y)
        y = self.quant_out(y_out)
        # y = self.quant_out(y)

        # 第三个 Linear
        z = self.linear3(y)
        z = self.dequant(z)
        return x, y_out
</code></pre>
<p>注意，y_out = self.dequant（y）是必须要添加的，否则无法实现该效果。</p>
<p>全流程代码如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">import torch
from horizon_plugin_pytorch import set_march, March
set_march(March.NASH_M)
from horizon_plugin_pytorch.quantization import prepare, set_fake_quantize, FakeQuantState
from horizon_plugin_pytorch.quantization import QuantStub
from horizon_plugin_pytorch.quantization.hbdk4 import export
from horizon_plugin_pytorch.quantization.qconfig_template import (
    calibration_8bit_weight_16bit_act_qconfig_setter,
    qat_8bit_weight_16bit_fixed_act_qconfig_setter, 
    default_calibration_qconfig_setter,
    ModuleNameQconfigSetter
) 

from horizon_plugin_pytorch.quantization.qconfig import get_qconfig, MSEObserver, MinMaxObserver
from horizon_plugin_pytorch.dtype import qint8, qint16
from torch.quantization import DeQuantStub
import torch.nn as nn
from horizon_plugin_pytorch.quantization import hbdk4 as hb4
from hbdk4.compiler import convert, save, hbm_perf, visualize, compile

import torch
import torch.nn as nn

# 定义网络结构
class SmallModel(nn.Module):
    def __init__(self):
        super(SmallModel, self).__init__()
        # 第一个 Linear: 输入 [2, 100, 256] -&gt; 输出 [2, 100, 256]
        self.linear1 = nn.Linear(256, 256)
        self.layernorm = nn.LayerNorm(256)  # 对最后一维进行归一化
        self.relu = nn.ReLU()
        # 第二个 Linear: 输入 [2, 100, 256] -&gt; 输出 [2, 100, 60]
        self.linear2 = nn.Linear(256, 60)
        # 第三个 Linear: 输入 [2, 100, 60] -&gt; 输出 [2, 100, 60]
        self.linear3 = nn.Linear(60, 60)
        self.quant = QuantStub()
        self.quant_out = QuantStub()
        self.dequant = DeQuantStub()

    def forward(self, x):
        x = self.quant(x)
        # 第一个 Linear
        x = self.linear1(x)  # [2, 100, 256]
        x = self.layernorm(x)  # [2, 100, 256]
        x = self.relu(x)  # [2, 100, 256]
        # 第二个 Linear
        y = self.linear2(x)  # [2, 100, 60]
        y_out = self.dequant(y)
        y = self.quant_out(y_out)

        # 第三个 Linear
        z = self.linear3(y)
        z = self.dequant(z)
        return z, y_out

# 设置随机种子，保证每次生成的数据相同
torch.manual_seed(42)
example_input = torch.randn(2, 100, 256)
model = SmallModel()

# 前向传播
output_x, output_y = model(example_input)
print("输入形状:", example_input.shape)
print("输出形状:", output_x.shape, output_y.shape)

# A global march indicating the target hardware version must be setted before prepare qat.
set_march(March.NASH_M)

calib_model = prepare(model.eval(), example_input, 
                      qconfig_setter=(
                          default_calibration_qconfig_setter,
                          ),
                      )

calib_model.eval()
set_fake_quantize(calib_model, FakeQuantState.CALIBRATION)
calib_model(example_input)

calib_model.eval()                            
set_fake_quantize(calib_model, FakeQuantState.VALIDATION)
calib_out_x, calib_out_y= calib_model(example_input)
print("calib输出shape:", calib_out_x.shape)

qat_bc = export(calib_model, example_input)
# save(qat_bc, "qat.bc")
# visualize(qat_bc, "qat.onnx")
hb_quantized_model = convert(qat_bc, March.NASH_M)
# save(hb_quantized_model,"quantized.bc")
visualize(hb_quantized_model, "quantized.onnx")
</code></pre>
<p>查看 quantized.onnx，linear2 符合预期，确实是 int32 高精度输出。</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=OTBlYTRjMDY3ZmE0NDM2MjU4OGQ4ODkyNzIzNjM2Y2NfUTdVaThLYk9abXp4ZWFlakxYcmZPMXUzQ1JDNE5UdzZfVG9rZW46WEdYa2J0S3pib0dsaW54N2JFcmNHWXVsbnlkXzE3NjQ0OTM2ODE6MTc2NDQ5NzI4MV9WNA" alt="" loading="lazy"/></p>
<p>新加入的 dequant 与 quant 会变成 rescale</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=YTQ3YmJiMDVkMjhjNDBkNTc4OTdkOTk4M2VmNjE4YWNfRHZDd3BnTUVUTUpJMGxYY2xqSFV6aEVWbGVFTEhHRm1fVG9rZW46QVd6RGJKNmZxb3NRb0d4TVdlMWNZTVVUbk1mXzE3NjQ0OTM2ODE6MTc2NDQ5NzI4MV9WNA" alt="" loading="lazy"/></p>
<p>以上是征程 6EM 的默认做法，如果使用的是征程 6PH，conv like 算子输出直接就是 float32，在既作为输出，又作为下一阶段输入时，会存在 vpu 的 quantize（float32-&gt;int16/int8），如下图所示</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=ODlmMjc1NWY5ZWQzMDJlY2M4ODk0ZjRkNWU2ODYyY2NfTk5GR25iSGdxamV5bDBZZWRIdDR0RHNCOU5JUzV3TWxfVG9rZW46WkFiRGJjYVk3bzBCM2V4cGljSWN0NUV6bmVmXzE3NjQ0OTM2ODE6MTc2NDQ5NzI4MV9WNA" alt="" loading="lazy"/></p>
<p>如果想依旧沿用征程 6EM 的方式，可进行如下配置：</p>
<pre><code class="hljs language-Plain" lang="Plain">qat_bc._integer_conv = True
hb_quantized_model = convert(qat_bc, "nash-h")
</code></pre>
<p>具体选择哪种方式可实测 latency（建议考虑将模型 conv like 算子 c++ 反量化的耗时减少也加进去对比）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android实战：构建高可维护的日志系统]]></title>    <link>https://juejin.cn/post/7577647745109983232</link>    <guid>https://juejin.cn/post/7577647745109983232</guid>    <pubDate>2025-11-29T08:57:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577647745109983232" data-draft-id="7577599015425933347" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android实战：构建高可维护的日志系统"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-29T08:57:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨白"/> <meta itemprop="url" content="https://juejin.cn/user/2549135752044601"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android实战：构建高可维护的日志系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2549135752044601/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T08:57:47.000Z" title="Sat Nov 29 2025 08:57:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>一个优秀的日志系统必须满足以下三点：</p>
<ol>
<li><strong>零侵入性和零开销</strong>：开发时，可以随便打日志；发布时，日志能够自动消失，不影响运行时的性能。</li>
<li><strong>高定位能力</strong>：我们通过日志可以快速找出所在的类和线程。</li>
<li><strong>强关联上下文</strong>：能将异常堆栈和<strong>业务数据</strong>完美结合起来。</li>
</ol>
<p>我们将基于 <strong>Timber</strong> 库构建这套系统。</p>
<h2 data-id="heading-0">基础设施搭建</h2>
<h3 data-id="heading-1">开启 BuildConfig</h3>
<p>从 AGP 8.0+ 开始，许多旧的默认配置被关闭了，我们需要手动开启。</p>
<p>例如，<code>BuildConfig</code> 类默认不生成。但我们需要它来判断当前是否为 DEBUG 模式，从而控制是否启用日志开关。</p>
<p>只需在模块级别的 <code>build.gradle.kts</code> 中开启即可：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">android {
    buildFeatures {
        <span class="hljs-comment">// 开启 buildConfig 支持</span>
        buildConfig = <span class="hljs-literal">true</span>
    }
}
</code></pre>
<h3 data-id="heading-2">引入 Timber 依赖</h3>
<p><code>Timber</code> 是一个日志门面，我们只管调用它提供的接口，无需关心具体实现。我们可以种植不同的树，每棵树就是日志的具体处理逻辑。<code>Timber</code> 会遍历所有种下的树，来将日志分发给每一棵树。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dependencies {
    implementation(<span class="hljs-string">"com.jakewharton.timber:timber:5.0.1"</span>)
}
</code></pre>
<h2 data-id="heading-3">初始化与分层策略</h2>
<h3 data-id="heading-4">Application 初始化</h3>
<p>我们在应用启动时，根据是否为 DEBUG 环境，使用不同的日志实现。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> : <span class="hljs-type">Application</span>() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        initLogger()
    }

    <span class="hljs-comment">/**
     * 初始化 Logger
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initLogger</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
            <span class="hljs-comment">// 如果是开发环境，显示所有日志</span>
            Timber.plant(<span class="hljs-keyword">object</span> : Timber.DebugTree() {
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createStackElementTag</span><span class="hljs-params">(element: <span class="hljs-type">StackTraceElement</span>)</span></span>: String? {
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"DevLog-<span class="hljs-subst">${super.createStackElementTag(element)}</span>"</span>
                }
            })
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 如果是生产环境，只上报警告和错误</span>
            Timber.plant(CrashReportingTree())
        }
    }
}
</code></pre>
<blockquote>
<p>别忘了在 <code>AndroidManifest.xml</code> 文件中注册此 <code>Application</code>。</p>
</blockquote>
<p>我们在标签前加上了 “DevLog-”，这样在 Logcat 中过滤日志时，能够通过 <code>tag:DevLog</code> 快速过滤。</p>
<h3 data-id="heading-5">自定义 Release 树</h3>
<p>我们来定义刚刚的 <code>CrashReportingTree</code> 树。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 生产环境日志树
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CrashReportingTree</span> : <span class="hljs-type">Timber.Tree</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">log</span><span class="hljs-params">(priority: <span class="hljs-type">Int</span>, tag: <span class="hljs-type">String</span>?, message: <span class="hljs-type">String</span>, t: <span class="hljs-type">Throwable</span>?)</span></span> {
        <span class="hljs-comment">// 过滤 Verbose 和 Debug 日志</span>
        <span class="hljs-keyword">if</span> (priority == Log.VERBOSE || priority == Log.DEBUG) {
            <span class="hljs-keyword">return</span>
        }

        <span class="hljs-comment">// 记录面包屑 (Breadcrumbs)</span>
        <span class="hljs-comment">// 将 INFO 和 WARN 级别的日志存入 Crashlytics 内存缓冲</span>
        <span class="hljs-comment">// 当后续发生崩溃时，这些日志会作为崩溃线索一起上报。</span>
        <span class="hljs-keyword">val</span> logMessage = <span class="hljs-string">"[<span class="hljs-variable">$tag</span>] <span class="hljs-variable">$message</span>"</span>
        FirebaseCrashlytics.getInstance().log(logMessage)

        <span class="hljs-comment">// 触发上报机制</span>
        <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 有明确的异常堆栈 -&gt; 上报</span>
            FirebaseCrashlytics.getInstance().recordException(t)
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (priority == Log.ERROR) {
            <span class="hljs-comment">// 没有异常堆栈，但业务判定为 Error -&gt; 构造异常强制上报</span>
            FirebaseCrashlytics.getInstance().recordException(Throwable(message))
        }
    }
}
</code></pre>
<h2 data-id="heading-6">惰性求值</h2>
<h3 data-id="heading-7">性能隐患</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">Timber.d(<span class="hljs-string">"User Data: <span class="hljs-subst">${gson.toJson(hugeObject)}</span>"</span>)
Timber.d(<span class="hljs-string">"User Data: %s"</span>, gson.toJson(hugeObject))
</code></pre>
<p>这两行代码即使是在 Release 模式下，<code>gson.toJson(hugeObject)</code> 也会得到执行。这是因为 Kotlin/Java 的及早求值导致的，参数会在函数调用前计算完成。</p>
<h3 data-id="heading-8">解决方法：LogExt.kt</h3>
<p>我们需要解决两个核心性能隐患：</p>
<ol>
<li>字符串拼接的开销：避免在日志关闭时执行耗时操作。</li>
<li>反射开销：Timber 默认会通过反射获取类名作为 Tag。</li>
</ol>
<p>我们可以使用 Kotlin 的 <code>inline</code> 高阶函数和可选的 Tag 参数，来解决这两个问题。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// LogExt.kt</span>

<span class="hljs-comment">/**
 * 日志扩展：惰性求值 (Lazy Evaluation) + 显式 Tag 支持
 * - inline: 消除 Lambda 对象创建开销
 * - crossinline: 防止非局部返回
 */</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logD</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>, t: <span class="hljs-type">Throwable</span>? = <span class="hljs-literal">null</span>, <span class="hljs-keyword">crossinline</span> message: () -&gt; <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 只有 DEBUG 模式下，Lambda 表达式才会执行</span>
    <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
        tag?.let {
            <span class="hljs-comment">// 只有在 DEBUG 模式下，并且 tag 不为空时，才覆盖默认 Tag</span>
            Timber.tag(it)
        }
        Timber.d(t, message())
    }
}

<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logI</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>, t: <span class="hljs-type">Throwable</span>? = <span class="hljs-literal">null</span>, <span class="hljs-keyword">crossinline</span> message: () -&gt; <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
        tag?.let {
            Timber.tag(it)
        }
        Timber.i(t, message())
    }
}

<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logV</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>, t: <span class="hljs-type">Throwable</span>? = <span class="hljs-literal">null</span>, <span class="hljs-keyword">crossinline</span> message: () -&gt; <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
        tag?.let {
            Timber.tag(it)
        }
        Timber.v(t, message())
    }
}

<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logW</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>, t: <span class="hljs-type">Throwable</span>? = <span class="hljs-literal">null</span>, <span class="hljs-keyword">crossinline</span> message: () -&gt; <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// Warn 也透传给 Release Tree 进行上报</span>
    tag?.let {
        Timber.tag(it)
    }
    Timber.w(t, message())
}

<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logE</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>, t: <span class="hljs-type">Throwable</span>? = <span class="hljs-literal">null</span>, <span class="hljs-keyword">crossinline</span> message: () -&gt; <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// ERROR 必须透传给 Release Tree 进行上报</span>
    tag?.let {
        Timber.tag(it)
    }
    Timber.e(t, message())
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 常规用法</span>
logD { <span class="hljs-string">"User profile: <span class="hljs-subst">${gson.toJson(user)}</span>"</span> }

<span class="hljs-comment">// 高性能场景</span>
logV(tag = <span class="hljs-string">"TouchSystem"</span>) { <span class="hljs-string">"x=<span class="hljs-variable">$x</span>, y=<span class="hljs-variable">$y</span>"</span> }

<span class="hljs-comment">// 异常处理</span>
logE(t = exception) { <span class="hljs-string">"Database transaction failed."</span> }
</code></pre>
<h2 data-id="heading-9">日志分级</h2>
<p>我们常常是遇到问题就使用 <code>Log.d</code>，出了异常就调用 <code>printStackTrace</code>。</p>
<p>但这样并不好，清晰的日志层级能够让我们快速从大量的日志打印中查找出有用的信息。</p>
<h3 data-id="heading-10">VERBOSE (啰嗦/原子级)</h3>
<p>定义：噪音。</p>
<p>场景：高频、琐碎的数据流。
比如，在 <code>onTouchEvent</code> 中跟踪每一次手指坐标的变化。又比如在算法循环中，在循环内部打印每一次迭代的变量。</p>
<p>生命周期：很短。通常在功能完成后、提交代码前就会删除。</p>
<p>错误示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在 Release 包中打印，可能会导致 Logcat 缓冲区溢出</span>
Timber.v(<span class="hljs-string">"Touch: x=<span class="hljs-variable">$x</span>, y=<span class="hljs-variable">$y</span>"</span>) 
</code></pre>
<p>正确示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 线上会被剥离，零开销</span>
logV { <span class="hljs-string">"Touch: x=<span class="hljs-variable">$x</span>, y=<span class="hljs-variable">$y</span>"</span> }
</code></pre>
<h3 data-id="heading-11">DEBUG (调试/痕迹)</h3>
<p>定义：过程细节。</p>
<p>场景：用于验证逻辑是否符合预期，用于流程控制、参数确认。比如流程的进入和退出，变量的检查。</p>
<p>错误示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Timber.d(<span class="hljs-string">"Check 1"</span>) <span class="hljs-comment">// 无意义</span>
Timber.d(<span class="hljs-string">"User: <span class="hljs-subst">${user.toJson()}</span>"</span>) <span class="hljs-comment">// 性能较低</span>
</code></pre>
<p>正确示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">logD { <span class="hljs-string">"Login success, token saved. uid=<span class="hljs-subst">${user.id}</span>"</span> } 
</code></pre>
<h3 data-id="heading-12">INFO (信息/里程碑)</h3>
<p>定义：业务流转。</p>
<p>场景：业务的关键节点。</p>
<p>比如，生命周期的变化、业务的开始和结束（如支付成功）、关键的配置信息。</p>
<p>错误示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">logI { <span class="hljs-string">"View clicked"</span> } 
</code></pre>
<p>正确示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">logI { <span class="hljs-string">"Payment finished. orderId=<span class="hljs-variable">$orderId</span>, duration=<span class="hljs-variable">$time</span> ms"</span> }
</code></pre>
<h3 data-id="heading-13">WARN (警告/亚健康)</h3>
<p>定义：亚健康状态。</p>
<p>场景：预期内的错误，通过兜底逻辑（Fallback），使得应用正常运行。</p>
<p>比如，加载图片失败显示默认占位图，解析配置文件失败使用了默认配置。</p>
<p>错误示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">try</span> { ... } <span class="hljs-keyword">catch</span> (e: Exception) {
   <span class="hljs-comment">// 吞掉异常，无法排查根本原因</span>
   logW { <span class="hljs-string">"Image load failed"</span> } 
}
</code></pre>
<p>正确示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 带上异常堆栈，且说明了使用了兜底方案</span>
logW(e) { <span class="hljs-string">"Image load failed, using placeholder."</span> }
</code></pre>
<h3 data-id="heading-14">ERROR (错误/事故现场)</h3>
<p>定义：事故现场</p>
<p>场景：崩溃，或是不可修复的数据损坏。</p>
<p>比如，所有不打算抛出的 <code>catch</code> 块中，不可到达的 <code>else</code> 分支，丢失关键数据时。</p>
<p>错误示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 只有信息没有堆栈</span>
logE { <span class="hljs-string">"JSON parse error: <span class="hljs-subst">${e.message}</span>"</span> } 
</code></pre>
<p>正确示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 堆栈 + 业务数据</span>
logE(e) { <span class="hljs-string">"JSON parse error. rawData=<span class="hljs-variable">$jsonString</span>"</span> }
</code></pre>
<blockquote>
<p>异常处理：永远不要吞掉异常堆栈，这会导致不知道出错的原因。同时，必须要关联业务上下文。</p>
</blockquote>
<h3 data-id="heading-15">实战：一个典型的业务流程</h3>
<p>最好的日志使用策略是“三明治法”：使用 INFO 记录开始与结束，使用 DEBUG 记录过程细节，使用 WARN 记录局部的失败。</p>
<p>以“导入书籍”为例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">importBooks</span><span class="hljs-params">(bookList: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Book</span>&gt;)</span></span> {
    <span class="hljs-comment">// 业务开始 -&gt; INFO</span>
    <span class="hljs-comment">// 确认动作已触发，记录宏观数据量</span>
    logI { <span class="hljs-string">"Start importing books. totalCount=<span class="hljs-subst">${bookList.size}</span>"</span> }

    <span class="hljs-keyword">var</span> successCount = <span class="hljs-number">0</span>

    bookList.forEach { book -&gt;
        <span class="hljs-comment">// 循环细节 -&gt; DEBUG</span>
        <span class="hljs-comment">// 开发时追踪进度，线上自动屏蔽</span>
        logD { <span class="hljs-string">"Processing book: id=<span class="hljs-subst">${book.id}</span>, title=<span class="hljs-subst">${book.title}</span>"</span> }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行具体的导入逻辑...</span>
            saveToDatabase(book)
            successCount++
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-comment">// 局部失败 -&gt; WARN</span>
            <span class="hljs-comment">// 单本书失败不影响整体流程，但需要记录原因以便排查</span>
            logW(e) { <span class="hljs-string">"Failed to import book: <span class="hljs-subst">${book.title}</span>"</span> }
        }
    }

    <span class="hljs-comment">// 业务闭环 -&gt; INFO</span>
    <span class="hljs-comment">// 确认任务结束，统计最终结果</span>
    logI { <span class="hljs-string">"Import finished. success=<span class="hljs-variable">$successCount</span>, failed=<span class="hljs-subst">${bookList.size - successCount}</span>"</span> }
}
</code></pre>
<p>这样记录日志，我们能够清晰地看到每本书的处理过程，并且能一眼看出导入的运行状态（导入是否开始，导入成功和失败的个数）。</p>
<h2 data-id="heading-16">隐私合规</h2>
<p>Google Play 对隐私保护很严格，我们不能打印用户密码、身份证号等信息。</p>
<p>这时，我们可以进行脱敏：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// LogExt.kt</span>

<span class="hljs-comment">/**
 * 隐私脱敏处理
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">mask</span><span class="hljs-params">(prefixLen: <span class="hljs-type">Int</span> = <span class="hljs-number">3</span>, suffixLen: <span class="hljs-type">Int</span> = <span class="hljs-number">4</span>)</span></span>: String {
    <span class="hljs-comment">// 空字符串</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isNullOrBlank()) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"***"</span>
    }

    <span class="hljs-comment">// 长度不足时，全码掩盖</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.length &lt;= prefixLen + suffixLen) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"*"</span>.repeat(<span class="hljs-keyword">this</span>.length)
    }

    <span class="hljs-comment">// 保留前 prefix 位和后 suffix 位</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.substring(<span class="hljs-number">0</span>, prefixLen) +
            <span class="hljs-string">"*"</span>.repeat(<span class="hljs-keyword">this</span>.length - prefixLen - suffixLen) +
            <span class="hljs-keyword">this</span>.substring(<span class="hljs-keyword">this</span>.length - suffixLen)
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> phoneNumber = <span class="hljs-string">"12345678910"</span>
logD { <span class="hljs-string">"SMS sent to <span class="hljs-subst">${phoneNumber.mask()}</span>"</span> } <span class="hljs-comment">// SMS sent to 123****8910</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[餐饮供应链的数仓设计思考 （五） 系统稳定性与SLA保障体系]]></title>    <link>https://juejin.cn/post/7577969462860480575</link>    <guid>https://juejin.cn/post/7577969462860480575</guid>    <pubDate>2025-11-30T09:27:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577969462860480575" data-draft-id="7577958825342255123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="餐饮供应链的数仓设计思考 （五） 系统稳定性与SLA保障体系"/> <meta itemprop="keywords" content="数据分析"/> <meta itemprop="datePublished" content="2025-11-30T09:27:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            餐饮供应链的数仓设计思考 （五） 系统稳定性与SLA保障体系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:27:47.000Z" title="Sun Nov 30 2025 09:27:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目录</h2>
<ol>
<li><a href="#sla%E5%AE%9A%E4%B9%89%E4%B8%8E%E6%89%BF%E8%AF%BA" title="#sla%E5%AE%9A%E4%B9%89%E4%B8%8E%E6%89%BF%E8%AF%BA">SLA定义与承诺</a></li>
<li><a href="#%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6%E4%BD%93%E7%B3%BB" title="#%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6%E4%BD%93%E7%B3%BB">监控与告警体系</a></li>
<li><a href="#%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E6%B5%81%E7%A8%8B" title="#%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E6%B5%81%E7%A8%8B">应急响应流程</a></li>
<li><a href="#%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D%E4%B8%8E%E5%AE%B9%E7%81%BE" title="#%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D%E4%B8%8E%E5%AE%B9%E7%81%BE">故障恢复与容灾</a></li>
<li><a href="#%E6%8C%81%E7%BB%AD%E6%94%B9%E8%BF%9B%E6%9C%BA%E5%88%B6" title="#%E6%8C%81%E7%BB%AD%E6%94%B9%E8%BF%9B%E6%9C%BA%E5%88%B6">持续改进机制</a></li>
</ol>
<hr/>
<h2 data-id="heading-1">核心价值</h2>
<h3 data-id="heading-2">目标</h3>
<p>通过完整的SLA保障体系，确保数据平台的高稳定性和高可靠性，让业务部门放心使用数据进行决策。</p>
<ol>
<li><strong>SLA承诺</strong> - 明确的可用性、延迟、恢复目标</li>
<li><strong>监控体系</strong> - 三层监控指标 (业务/系统/资源)</li>
<li><strong>告警规则</strong> - 具体的告警规则与响应标准</li>
<li><strong>应急流程</strong> - P0级别的完整应急响应流程</li>
<li><strong>故障恢复</strong> - RTO/RPO设计与多层容灾方案</li>
<li><strong>持续改进</strong> - 事后总结与SLA评分卡</li>
</ol>
<h3 data-id="heading-3">关键指标:</h3>
<ul>
<li>系统可用性: ≥99.5% (月故障&lt;3小时)</li>
<li>数据延迟: &lt;5分钟</li>
<li>P0故障RTO: &lt;2小时</li>
<li>P1故障RTO: &lt;1小时</li>
<li>故障恢复点: &lt;1小时数据丢失</li>
</ul>
<h2 data-id="heading-4">SLA定义与承诺</h2>
<h3 data-id="heading-5">1.1 核心系统的SLA承诺</h3>
<pre><code class="hljs language-scss" lang="scss">┌────────────────────────────────────────────────────────────┐
│           核心系统 SLA 承诺表                              │
├────────────────────────────────────────────────────────────┤
│                                                             │
│ 系统              可用性    数据延迟    故障恢复  优先级  │
│                  (Available)  (Latency)  (RTO)           │
│─────────────────────────────────────────────────────────  │
│ Doris集群        <span class="hljs-number">99.5%</span>      &lt;<span class="hljs-number">5</span>分钟     &lt;<span class="hljs-number">2</span>小时    P0      │
│ (数据仓库)       ≥<span class="hljs-number">2.88</span>h/月  (<span class="hljs-number">99%</span>时间)  (RTO)            │
│                   故障允许    (P95&lt;<span class="hljs-number">3</span>m)                    │
│                              (P99&lt;<span class="hljs-number">10</span>m)                    │
│                                                             │
│ Flink ETL        <span class="hljs-number">99.0%</span>      &lt;<span class="hljs-number">5</span>分钟     &lt;<span class="hljs-number">1</span>小时    P0      │
│ (流式处理)       ≥<span class="hljs-number">4.32</span>h/月  实时告警   (自动恢复)       │
│                  故障                                      │
│                                                             │
│ Kafka消息队列    <span class="hljs-number">99.5%</span>      <span class="hljs-number">0</span>延迟      &lt;<span class="hljs-number">30</span>分钟   P0      │
│                  ≥<span class="hljs-number">2.88</span>h/月  (消息持久化)                │
│                  故障                                      │
│                                                             │
│ POS API接口      <span class="hljs-number">99.0%</span>      &lt;<span class="hljs-number">30</span>秒      &lt;<span class="hljs-number">1</span>小时    P0      │
│ (业务系统)       ≥<span class="hljs-number">4.32</span>h/月  (超时告警)  (与POS方协调)   │
│                  故障                                      │
│                                                             │
│ MySQL元数据库    <span class="hljs-number">99.5%</span>      &lt;<span class="hljs-number">1</span>秒       &lt;<span class="hljs-number">30</span>分钟   P1      │
│ (配置库)         ≥<span class="hljs-number">2.88</span>h/月  (本地缓存)  (主从切换)      │
│                  故障                                      │
│                                                             │
│ Prometheus监控   <span class="hljs-number">99.0%</span>      &lt;<span class="hljs-number">1</span>分钟     &lt;<span class="hljs-number">1</span>小时    P1      │
│ (告警系统)       ≥<span class="hljs-number">4.32</span>h/月  (数据保留)  (历史恢复)      │
│                  故障                                      │
│                                                             │
│ Grafana看板      <span class="hljs-number">99.0%</span>      &lt;<span class="hljs-number">5</span>秒       &lt;<span class="hljs-number">1</span>小时    P2      │
│ (可视化)         ≥<span class="hljs-number">4.32</span>h/月  (缓存)      (UI切换)        │
│                  故障                                      │
│                                                             │
└────────────────────────────────────────────────────────────┘

注解:

可用性计算:
├─ <span class="hljs-number">99.5%</span> = 月可用时间 <span class="hljs-number">720</span>小时 × <span class="hljs-number">0.995</span> = <span class="hljs-number">716.4</span>小时
├─ 故障允许时间 = <span class="hljs-number">720</span> - <span class="hljs-number">716.4</span> = <span class="hljs-number">3.6</span>小时 ≈ <span class="hljs-number">2.88</span>小时
└─ 即: 每月允许故障不超过<span class="hljs-number">2</span>小时<span class="hljs-number">58</span>分钟

优先级定义:
├─ P0: 极严重，影响多个门店或财务数据，需立即处理
├─ P1: 严重，影响单个门店或部分功能，<span class="hljs-number">1</span>小时内处理
├─ P2: 中等，影响用户体验但不影响业务，<span class="hljs-number">4</span>小时内处理
└─ P3: 轻微，不影响主业务，无紧急处理要求
</code></pre>
<h3 data-id="heading-6">1.2 服务等级界定</h3>
<pre><code class="hljs language-makefile" lang="makefile">P0 - 紧急事件 (Severity: Critical)

<span class="hljs-section">定义:</span>
├─ Doris无法查询 (整个集群宕机)
├─ POS数据无法采集 (24小时+)
├─ 财务数据错误 (与财务对不上)
├─ 用户数据泄露 (严重安全事件)
└─ 数据一致性破坏 (不可修复)

<span class="hljs-section">响应时间:</span>
├─ 感知时间: 0秒 (自动告警)
├─ 响应时间: 5分钟内 (CDO、Tech Lead到场)
└─ 初步诊断: 15分钟内

<span class="hljs-section">恢复目标:</span>
├─ RTO (Recovery Time Objective): &lt;2小时
├─ RPO (Recovery Point Objective): &lt;1小时
└─ 通知范围: CEO/CFO/CTO + 全体研发 + 业务方

─────────────────────────────────────────────────

P1 - 高优先级 (Severity: High)

<span class="hljs-section">定义:</span>
├─ 单个查询性能下降 (&gt;30秒)
├─ 数据延迟超过5分钟
├─ 部分BI报表不可用
├─ Flink任务故障 (1小时内修复)
└─ 告警不能正常推送

<span class="hljs-section">响应时间:</span>
├─ 感知时间: 5分钟内 (自动告警)
├─ 响应时间: 30分钟内 (主要责任人+支持)
└─ 初步诊断: 1小时内

<span class="hljs-section">恢复目标:</span>
├─ RTO: &lt;1小时
├─ RPO: &lt;30分钟
└─ 通知范围: CDO + 技术团队 + 相关业务方

─────────────────────────────────────────────────

P2 - 中等优先级 (Severity: Medium)

<span class="hljs-section">定义:</span>
├─ 某个BI看板响应慢 (但能访问)
├─ 某个报表有小bug (数据基本正确)
├─ 告警延迟1-2小时
├─ 文档更新有误
└─ 用户体验问题 (但不影响功能)

<span class="hljs-section">响应时间:</span>
├─ 响应时间: 4小时内
├─ 优先安排修复
└─ 可在工作时间内处理

<span class="hljs-section">恢复目标:</span>
├─ RTO: &lt;4小时
└─ 通知范围: 相关技术人员 + 提出者

─────────────────────────────────────────────────

P3 - 低优先级 (Severity: Low)

<span class="hljs-section">定义:</span>
├─ UI布局小问题
├─ 文档笔误
├─ 功能优化建议
├─ 性能微小改进
└─ 用户界面美化

<span class="hljs-section">响应时间:</span>
├─ 响应时间: 1周内
├─ 可统一收集后批量处理
└─ 列入下一个迭代计划

<span class="hljs-section">恢复目标:</span>
├─ 无严格时间要求
└─ 通知范围: 产品/技术团队
</code></pre>
<hr/>
<h2 data-id="heading-7">监控与告警体系</h2>
<h3 data-id="heading-8">2.1 监控指标体系</h3>
<pre><code class="hljs language-erlang" lang="erlang">┌────────────────────────────────────────────────────────────┐
│         监控指标的<span class="hljs-string">"三层金字塔"</span>                             │
├────────────────────────────────────────────────────────────┤
│                                                             │
│ 第一层: 业务指标 (Business Metrics)                        │
│ └─ 最终用户关心的 KPI                                      │
│                                                             │
│    ┌─ 数据新鲜度 (Data Freshness)                          │
│    │  ├─ 最后更新时间 (Last Update Time)                   │
│    │  ├─ 数据延迟 (Data Latency)                           │
│    │  │  └─ 告警: &gt;<span class="hljs-number">5</span>分钟 (P1)                              │
│    │  └─ 实时数据覆盖率                                     │
│    │                                                        │
│    ├─ 数据准确性 (Data Accuracy)                           │
│    │  ├─ DQ规则通过率 (<span class="hljs-comment">%)                                  │</span>
│    │  │  └─ 告警: &lt;<span class="hljs-number">95</span><span class="hljs-comment">% (P1)                                │</span>
│    │  ├─ 与源系统对账差异 (<span class="hljs-comment">%)                              │</span>
│    │  │  └─ 告警: &gt;<span class="hljs-number">0.1</span><span class="hljs-comment">% (P1)                               │</span>
│    │  └─ 缺失数据率 (<span class="hljs-comment">%)                                    │</span>
│    │     └─ 告警: &gt;<span class="hljs-number">1</span><span class="hljs-comment">% (P2)                                 │</span>
│    │                                                        │
│    └─ 查询服务可用性 (Query Availability)                  │
│       ├─ 查询成功率 (<span class="hljs-comment">%)                                    │</span>
│       │  └─ 告警: &lt;<span class="hljs-number">99.5</span><span class="hljs-comment">% (P1)                              │</span>
│       └─ 平均响应时间 (ms)                                 │
│          ├─ P95: 告警 &gt;<span class="hljs-number">5000</span>ms (P2)                         │
│          ├─ P99: 告警 &gt;<span class="hljs-number">10000</span>ms (P2)                        │
│          └─ Max: 告警 &gt;<span class="hljs-number">30000</span>ms (P1)                        │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ 第二层: 系统指标 (System Metrics)                          │
│ └─ 系统层面的性能与健康指标                                │
│                                                             │
│    ┌─ Doris集群健康                                        │
│    │  ├─ FE节点状态: Online/Offline                        │
│    │  │  └─ 告警: FE故障 (P0)                              │
│    │  ├─ BE节点状态: Healthy/Unhealthy                     │
│    │  │  └─ 告警: BE数 &lt;副本数 (P0)                        │
│    │  ├─ 副本不健全表数量                                   │
│    │  │  └─ 告警: &gt;<span class="hljs-number">0</span> (P1)                                  │
│    │  └─ 存储容量使用率                                     │
│    │     ├─ 黄色: &gt;<span class="hljs-number">80</span><span class="hljs-comment">%                                     │</span>
│    │     ├─ 红色: &gt;<span class="hljs-number">90</span><span class="hljs-comment">% (P1)                                │</span>
│    │     └─ 预留: 至少<span class="hljs-number">100</span>GB可用空间                        │
│    │                                                        │
│    ├─ Flink任务健康                                        │
│    │  ├─ 任务状态: RUNNING/FAILED                          │
│    │  │  └─ 告警: FAILED (P0)                              │
│    │  ├─ Checkpoint成功率: (<span class="hljs-comment">%)                             │</span>
│    │  │  └─ 告警: &lt;<span class="hljs-number">95</span><span class="hljs-comment">% (P1)                                │</span>
│    │  ├─ 背压指标 (BackPressure)                           │
│    │  │  └─ 告警: &gt;<span class="hljs-number">0.5</span> 持续<span class="hljs-number">1</span>分钟 (P2)                      │
│    │  └─ 处理延迟 (Processing Latency)                     │
│    │     └─ 告警: &gt;<span class="hljs-number">60</span>秒 (P1)                               │
│    │                                                        │
│    └─ Kafka集群健康                                        │
│       ├─ Broker状态: Leader/Follower                       │
│       │  └─ 告警: Broker故障 (P0)                          │
│       ├─ 副本数不足的分区                                   │
│       │  └─ 告警: &gt;<span class="hljs-number">0</span> (P1)                                  │
│       ├─ 消费延迟 (Consumer Lag)                           │
│       │  └─ 告警: &gt;<span class="hljs-number">1000</span>条消息 (P1)                         │
│       └─ 磁盘容量                                           │
│          └─ 告警: &gt;<span class="hljs-number">85</span><span class="hljs-comment">% (P2)                                │</span>
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ 第三层: 资源指标 (Resource Metrics)                        │
│ └─ 基础设施层面的资源使用                                  │
│                                                             │
│    ┌─ CPU (处理器)                                         │
│    │  ├─ 使用率 (<span class="hljs-comment">%)                                        │</span>
│    │  │  ├─ 黄色: &gt;<span class="hljs-number">70</span><span class="hljs-comment">%                                     │</span>
│    │  │  └─ 红色: &gt;<span class="hljs-number">90</span><span class="hljs-comment">% (P2)                                │</span>
│    │  └─ 上下文切换次数 (context switches)                 │
│    │     └─ 告警: 异常高 (P2)                              │
│    │                                                        │
│    ├─ 内存 (RAM)                                           │
│    │  ├─ 使用率 (<span class="hljs-comment">%)                                        │</span>
│    │  │  ├─ 黄色: &gt;<span class="hljs-number">80</span><span class="hljs-comment">%                                     │</span>
│    │  │  └─ 红色: &gt;<span class="hljs-number">95</span><span class="hljs-comment">% (P1)                                │</span>
│    │  ├─ GC频率                                            │
│    │  │  └─ 告警: Full GC &gt;<span class="hljs-number">3</span>次/分钟 (P1)                   │
│    │  └─ GC暂停时间                                        │
│    │     └─ 告警: &gt;<span class="hljs-number">2</span>秒 (P1)                                │
│    │                                                        │
│    ├─ 磁盘 (Disk)                                          │
│    │  ├─ 使用率 (<span class="hljs-comment">%)                                        │</span>
│    │  │  ├─ 黄色: &gt;<span class="hljs-number">80</span><span class="hljs-comment">%                                     │</span>
│    │  │  └─ 红色: &gt;<span class="hljs-number">95</span><span class="hljs-comment">% (P1)                                │</span>
│    │  ├─ I/O延迟                                           │
│    │  │  └─ 告警: 读/写 &gt;<span class="hljs-number">50</span>ms (P2)                         │
│    │  └─ 剩余可用空间                                       │
│    │     └─ 告警: &lt;<span class="hljs-number">10</span>GB (P1)                               │
│    │                                                        │
│    └─ 网络 (Network)                                       │
│       ├─ 带宽使用率 (<span class="hljs-comment">%)                                    │</span>
│       │  └─ 告警: &gt;<span class="hljs-number">80</span><span class="hljs-comment">% (P2)                                │</span>
│       ├─ 网络延迟 (Latency)                                │
│       │  └─ 告警: &gt;<span class="hljs-number">50</span>ms (P2)                               │
│       ├─ 数据包丢失率 (<span class="hljs-comment">%)                                  │</span>
│       │  └─ 告警: &gt;<span class="hljs-number">0.1</span><span class="hljs-comment">% (P2)                               │</span>
│       └─ 连接数                                             │
│          └─ 告警: 接近限制 (P2)                            │
│                                                             │
└────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-9">2.2 告警规则示例</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">告警规则1: 数据延迟超标</span>

<span class="hljs-section">告警名: data_latency_exceeded</span>
<span class="hljs-section">严重级: P1</span>
<span class="hljs-section">条件:  (now() - max(last_update_time)) &gt; 300秒</span>
<span class="hljs-section">评估周期: 1分钟</span>
<span class="hljs-section">继续期: 持续5分钟后触发</span>

<span class="hljs-section">通知方式:</span>
├─ 钉钉: @数据团队 <span class="hljs-string">"数据延迟超过5分钟"</span>
├─ 短信: 发给Tech Lead
├─ 邮件: 数据团队和CDO
└─ 工单: 自动生成P1级别工单

────────────────────────────────────────────

<span class="hljs-section">告警规则2: 查询响应时间高</span>

<span class="hljs-section">告警名: query_response_time_high</span>
<span class="hljs-section">严重级: P2</span>
<span class="hljs-section">条件:  histogram_quantile(0.95, query_duration) &gt; 5s</span>
<span class="hljs-section">评估周期: 5分钟</span>
<span class="hljs-section">继续期: 持续10分钟后触发</span>

<span class="hljs-section">通知方式:</span>
├─ 钉钉: @数据团队 <span class="hljs-string">"查询响应缓慢"</span>
├─ 邮件: 数据团队和CDO
└─ 工单: 自动生成P2级别工单

<span class="hljs-section">可能原因:</span>
├─ 大查询并发 → 检查: 当前查询队列数
├─ Doris节点故障 → 检查: BE节点状态
├─ 存储压力 → 检查: 磁盘I/O延迟
└─ 网络问题 → 检查: 网络延迟、带宽

────────────────────────────────────────────

<span class="hljs-section">告警规则3: 数据质量检查失败</span>

<span class="hljs-section">告警名: data_quality_check_failed</span>
<span class="hljs-section">严重级: P1</span>
<span class="hljs-section">条件:  dq_rule_pass_rate &lt; 0.95</span>
<span class="hljs-section">评估周期: 1小时</span>
<span class="hljs-section">继续期: 持续2小时后触发</span>

<span class="hljs-section">通知方式:</span>
├─ 钉钉: @数据质量负责人 <span class="hljs-string">"数据质量告警"</span>
├─ 邮件: 数据团队、业务方
└─ 工单: 自动生成P1级别工单，包含:
   ├─ 失败的DQ规则
   ├─ 失败数据量
   ├─ 失败的表
   └─ 建议的处理方案

────────────────────────────────────────────

<span class="hljs-section">告警规则4: 业务异常</span>

<span class="hljs-section">告警名: sales_anomaly_detected</span>
<span class="hljs-section">严重级: P2</span>
<span class="hljs-section">条件:  (current_sales - 7day_avg) / 7day_avg &gt; 50%</span>
       或 (current_sales - 7day_avg) / 7day_avg &lt; -30%
<span class="hljs-section">评估周期: 1小时</span>

<span class="hljs-section">通知方式:</span>
├─ 钉钉: @运营团队 <span class="hljs-string">"销售异常预警"</span>
├─ 邮件: 运营总监、CDO
└─ 自动分析: 提供可能原因
   ├─ 客流变化?
   ├─ 客单价变化?
   ├─ 新活动影响?
   └─ 系统故障?
</code></pre>
<hr/>
<h2 data-id="heading-10">应急响应流程</h2>
<h3 data-id="heading-11">3.1 P0级别应急响应 (极严重故障)</h3>
<pre><code class="hljs language-r" lang="r">┌────────────────────────────────────────────────────────────┐
│  P0 应急响应流程 <span class="hljs-punctuation">(</span>极严重故障处理<span class="hljs-punctuation">)</span>                          │
│  目标<span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-operator">-</span><span class="hljs-number">2</span>小时恢复                                         │
├────────────────────────────────────────────────────────────┤
│                                                             │
│ <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">0</span><span class="hljs-built_in">min</span> ⏰ 触发告警                                          │
│       │                                                    │
│       ├─ 自动触发<span class="hljs-operator">:</span> 告警规则判定                            │
│       ├─ 手动触发<span class="hljs-operator">:</span> 人工发现问题                            │
│       │                                                    │
│       └─ 立即启动<span class="hljs-operator">:</span>                                         │
│          ├─ 钉钉群大消息 <span class="hljs-operator">@</span>所有人 <span class="hljs-operator">+</span> 电话通知               │
│          ├─ 创建应急工单 <span class="hljs-punctuation">(</span>自动<span class="hljs-punctuation">)</span>                            │
│          ├─ 启动应急会议 <span class="hljs-punctuation">(</span>立即开启视频会<span class="hljs-punctuation">)</span>                  │
│          └─ 通知<span class="hljs-operator">:</span> CEO<span class="hljs-operator">/</span>CFO<span class="hljs-operator">/</span>CTO<span class="hljs-operator">/</span>CDO<span class="hljs-operator">/</span>Tech Lead              │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">5</span><span class="hljs-built_in">min</span> ⏱️  故障定位                                        │
│       │                                                    │
│       ├─ 组织<span class="hljs-operator">:</span> 现场指挥 <span class="hljs-punctuation">(</span>CDO<span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> 技术调查员<span class="hljs-number">3</span><span class="hljs-operator">-</span><span class="hljs-number">4</span>人             │
│       │                                                    │
│       ├─ 快速诊断<span class="hljs-operator">:</span>                                         │
│       │  ├─ 收集基础信息                                   │
│       │  │  ├─ 故障开始时间<span class="hljs-operator">?</span>                              │
│       │  │  ├─ 影响范围<span class="hljs-operator">?</span> <span class="hljs-punctuation">(</span>所有店<span class="hljs-operator">/</span>部分店<span class="hljs-operator">/</span>某个模块<span class="hljs-punctuation">)</span>         │
│       │  │  ├─ 现象是什么<span class="hljs-operator">?</span>                                │
│       │  │  └─ 最近有什么变更<span class="hljs-operator">?</span>                            │
│       │  │                                                 │
│       │  ├─ 收集日志数据                                   │
│       │  │  ├─ Doris<span class="hljs-operator">:</span> 查看FE<span class="hljs-operator">/</span>BE日志                       │
│       │  │  ├─ Flink<span class="hljs-operator">:</span> 查看任务日志                        │
│       │  │  ├─ 应用<span class="hljs-operator">:</span> 查看应用日志                         │
│       │  │  └─ 系统<span class="hljs-operator">:</span> 查看系统日志 <span class="hljs-punctuation">(</span>CPU<span class="hljs-operator">/</span>内存<span class="hljs-operator">/</span>磁盘<span class="hljs-punctuation">)</span>         │
│       │  │                                                 │
│       │  └─ 快速假设与验证                                 │
│       │     ├─ 假设<span class="hljs-number">1</span><span class="hljs-operator">:</span> Doris崩溃<span class="hljs-operator">?</span> → 检查集群状态           │
│       │     ├─ 假设<span class="hljs-number">2</span><span class="hljs-operator">:</span> 网络问题<span class="hljs-operator">?</span> → 检查网络连接            │
│       │     ├─ 假设<span class="hljs-number">3</span><span class="hljs-operator">:</span> 磁盘满<span class="hljs-operator">?</span> → 检查磁盘空间              │
│       │     └─ 假设<span class="hljs-number">4</span><span class="hljs-operator">:</span> 内存溢出<span class="hljs-operator">?</span> → 检查内存使用            │
│       │                                                    │
│       └─ 报告<span class="hljs-operator">:</span> <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">5</span><span class="hljs-built_in">min</span>时给出初步诊断                       │
│          <span class="hljs-string">"故障原因: XXX, 正在采取措施"</span>                     │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">15</span><span class="hljs-built_in">min</span> 🔧 应急修复                                        │
│       │                                                    │
│       ├─ 故障类型<span class="hljs-number">1</span><span class="hljs-operator">:</span> 硬件故障                              │
│       │  ├─ 立即<span class="hljs-operator">:</span> 启动故障转移 <span class="hljs-punctuation">(</span>failover<span class="hljs-punctuation">)</span>                │
│       │  ├─ 监控<span class="hljs-operator">:</span> Doris从<span class="hljs-number">3</span>副本→<span class="hljs-number">1</span>副本降级运行             │
│       │  ├─ 修复<span class="hljs-operator">:</span> 更换故障硬件 <span class="hljs-punctuation">(</span>IT部门<span class="hljs-punctuation">)</span>                   │
│       │  └─ 恢复<span class="hljs-operator">:</span> 副本恢复后恢复正常                       │
│       │                                                    │
│       ├─ 故障类型<span class="hljs-number">2</span><span class="hljs-operator">:</span> 软件故障 <span class="hljs-punctuation">(</span>Doris<span class="hljs-operator">/</span>Flink<span class="hljs-punctuation">)</span>                │
│       │  ├─ 立即<span class="hljs-operator">:</span> 尝试重启故障服务                        │
│       │  ├─ 监控<span class="hljs-operator">:</span> 重启后的健康状态                        │
│       │  ├─ 如果还是故障<span class="hljs-operator">:</span> 回滚上次更新                     │
│       │  └─ 检查<span class="hljs-operator">:</span> 更新中引入的bug                         │
│       │                                                    │
│       ├─ 故障类型<span class="hljs-number">3</span><span class="hljs-operator">:</span> 数据问题                              │
│       │  ├─ 立即<span class="hljs-operator">:</span> 隔离坏数据                              │
│       │  ├─ 恢复<span class="hljs-operator">:</span> 从备份点恢复 <span class="hljs-punctuation">(</span>RTO <span class="hljs-operator">&lt;</span><span class="hljs-number">2</span>小时<span class="hljs-punctuation">)</span>              │
│       │  └─ 验证<span class="hljs-operator">:</span> 恢复后数据一致性                        │
│       │                                                    │
│       └─ 故障类型<span class="hljs-number">4</span><span class="hljs-operator">:</span> 应用问题                              │
│          ├─ 立即<span class="hljs-operator">:</span> 发布hotfix或回滚上次发布                │
│          ├─ 验证<span class="hljs-operator">:</span> 测试修复                                │
│          └─ 上线<span class="hljs-operator">:</span> 灰度上线或直接全量                       │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">30</span><span class="hljs-built_in">min</span> ✅ 恢复验证                                        │
│       │                                                    │
│       ├─ 功能验证<span class="hljs-operator">:</span>                                         │
│       │  ├─ 数据查询<span class="hljs-operator">:</span> 随机选几个查询验证                   │
│       │  ├─ 实时采集<span class="hljs-operator">:</span> 检查数据延迟                        │
│       │  ├─ BI看板<span class="hljs-operator">:</span> 检查报表刷新                          │
│       │  └─ 告警<span class="hljs-operator">:</span> 测试告警通知                            │
│       │                                                    │
│       ├─ 性能验证<span class="hljs-operator">:</span>                                         │
│       │  ├─ 查询性能<span class="hljs-operator">:</span> P95<span class="hljs-operator">&lt;</span><span class="hljs-number">5</span>s                              │
│       │  ├─ 系统负载<span class="hljs-operator">:</span> CPU<span class="hljs-operator">&lt;</span><span class="hljs-number">70</span><span class="hljs-operator">%, 内存&lt;80%</span>                   │
│       │  └─ 网络延迟<span class="hljs-operator">:</span> <span class="hljs-operator">&lt;</span><span class="hljs-number">50</span>ms                               │
│       │                                                    │
│       ├─ 数据验证<span class="hljs-operator">:</span>                                         │
│       │  ├─ 数据完整<span class="hljs-operator">:</span> 对账无差异                          │
│       │  ├─ 数据准确<span class="hljs-operator">:</span> DQ规则全部通过                      │
│       │  └─ 时间性<span class="hljs-operator">:</span> 数据延迟<span class="hljs-operator">&lt;</span><span class="hljs-number">5</span>分钟                        │
│       │                                                    │
│       └─ 报告<span class="hljs-operator">:</span> <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">30</span><span class="hljs-built_in">min</span>给出恢复确认                        │
│          <span class="hljs-string">"系统已恢复正常，各项指标已验证"</span>                 │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">1</span>h 📊 故障总结                                           │
│       │                                                    │
│       ├─ 立即通知<span class="hljs-operator">:</span>                                         │
│       │  ├─ 钉钉<span class="hljs-operator">:</span> 故障已解决，影响时间¥xxx分钟            │
│       │  └─ 邮件<span class="hljs-operator">:</span> 详细事后报告将在<span class="hljs-number">24</span>小时内发送             │
│       │                                                    │
│       ├─ 后续工作<span class="hljs-operator">:</span>                                         │
│       │  ├─ 持续监控<span class="hljs-operator">:</span> 接下来<span class="hljs-number">8</span>小时加密监控                 │
│       │  ├─ 应急日志<span class="hljs-operator">:</span> 记录所有操作和时间点                │
│       │  └─ 初步总结<span class="hljs-operator">:</span> 根本原因是什么<span class="hljs-operator">?</span>                     │
│       │                                                    │
│       └─ 安排<span class="hljs-operator">:</span> <span class="hljs-number">24</span>小时内组织事后总结会 <span class="hljs-punctuation">(</span>postmortem<span class="hljs-punctuation">)</span>       │
│          ├─ 参加人<span class="hljs-operator">:</span> 所有参与者 <span class="hljs-operator">+</span> 相关方                   │
│          ├─ 内容<span class="hljs-operator">:</span> Timeline <span class="hljs-operator">+</span> Root Cause <span class="hljs-operator">+</span> Actions         │
│          └─ 输出<span class="hljs-operator">:</span> 改进计划 <span class="hljs-punctuation">(</span>预防同类故障<span class="hljs-punctuation">)</span>                 │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">24</span>h 📋 详细事后报告                                      │
│                                                             │
│       报告内容<span class="hljs-operator">:</span>                                            │
│       ├─ 故障时间<span class="hljs-operator">:</span> 起始时间 <span class="hljs-operator">&amp;</span> 持续时间                     │
│       ├─ 影响范围<span class="hljs-operator">:</span> 几家店<span class="hljs-operator">?</span> 哪些功能<span class="hljs-operator">?</span>                       │
│       ├─ Root Cause<span class="hljs-operator">:</span> 根本原因分析 <span class="hljs-punctuation">(</span><span class="hljs-number">5</span>个Why<span class="hljs-punctuation">)</span>               │
│       ├─ Timeline<span class="hljs-operator">:</span> 关键时间点 <span class="hljs-operator">&amp;</span> 行动                       │
│       ├─ Actions<span class="hljs-operator">:</span> 短期<span class="hljs-operator">/</span>中期<span class="hljs-operator">/</span>长期改进方案                   │
│       ├─ 责任人<span class="hljs-operator">:</span> 每个action的owner和deadline             │
│       ├─ 学到的经验<span class="hljs-operator">:</span> Lessons Learned                      │
│       └─ 附件<span class="hljs-operator">:</span> 日志、监控图表、诊断数据                    │
│                                                             │
│       分发<span class="hljs-operator">:</span> CEO<span class="hljs-operator">/</span>CFO<span class="hljs-operator">/</span>CTO<span class="hljs-operator">/</span>CDO<span class="hljs-operator">/</span>相关业务方                    │
│       归档<span class="hljs-operator">:</span> Wiki知识库，便于查阅                           │
│                                                             │
└────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-12">3.2 应急响应的角色与职责</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">┌────────────────────────────────────────────────────────────┐
│         应急响应中的关键角色                                │
├────────────────────────────────────────────────────────────┤
│                                                             │
│ 现场指挥 (Incident Commander, IC)                          │
│ └─ 由CDO担任 (或CDO授权的Tech Lead)                        │
│    ├─ 职责:                                                │
│    │  ├─ 宣布应急状态开始/结束                             │
│    │  ├─ 组织人员和资源分配                                │
│    │  ├─ 每<span class="hljs-number">15</span>分钟汇报进展                                  │
│    │  ├─ 做出关键决策 (恢复方案选择)                       │
│    │  └─ 与高管和业务方沟通                                │
│    │                                                        │
│    └─ 权力:                                                 │
│       ├─ 可以打断任何人做其他事                             │
│       ├─ 可以要求任何资源                                   │
│       ├─ 可以做<span class="hljs-string">"最高速度修复"</span>的决定                        │
│       └─ 所有人都必须听命令 (军事化管理)                   │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ 技术调查员 (Technical Lead)                                │
│ └─ <span class="hljs-number">3</span>-<span class="hljs-number">4</span>名来自不同岗位的工程师                                │
│    ├─ Doris/Kafka工程师 (集群与存储)                       │
│    ├─ Flink工程师 (流式处理)                               │
│    ├─ 应用工程师 (业务逻辑)                                │
│    ├─ 系统工程师 (基础设施)                                │
│    │                                                        │
│    └─ 职责:                                                 │
│       ├─ 按分工收集诊断信息                                 │
│       ├─ 提出可能的原因和验证方法                           │
│       ├─ 尝试修复方案                                       │
│       └─ 定期向IC汇报进展                                  │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ 沟通官 (Communications Lead)                               │
│ └─ 由PM或CDO的助理担任                                     │
│    ├─ 职责:                                                │
│    │  ├─ 定期更新所有利益相关方                             │
│    │  ├─ 维护应急通讯 (钉钉群、视频会议)                   │
│    │  ├─ 记录所有关键时间点                                │
│    │  ├─ 向高管定时汇报                                    │
│    │  └─ 恢复后对外沟通 (道歉+说明+承诺)                  │
│    │                                                        │
│    └─ 通讯模板:                                             │
│       ├─ 故障确认: <span class="hljs-string">"我们发现了XXX问题，正在处理"</span>           │
│       ├─ 中期更新: <span class="hljs-string">"进展: 已找到原因，正在修复"</span>            │
│       ├─ 恢复通知: <span class="hljs-string">"系统已恢复，持续监控中"</span>                │
│       └─ 事后总结: <span class="hljs-string">"根本原因是XXX，已采取措施防止"</span>         │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ 备选角色 (<span class="hljs-keyword">On</span>-<span class="hljs-keyword">Call</span>)                                         │
│ └─ 关键故障时的值班人员                                     │
│    ├─ 工程师<span class="hljs-keyword">On</span>-<span class="hljs-keyword">Call</span>: 周一值班表                             │
│    │  └─ <span class="hljs-number">24</span>/<span class="hljs-number">7</span>待命，可远程响应                              │
│    │                                                        │
│    ├─ CDO <span class="hljs-keyword">On</span>-<span class="hljs-keyword">Call</span>: 周一值班表                              │
│    │  └─ 可以做关键决策                                    │
│    │                                                        │
│    └─ 激励机制:                                             │
│       ├─ <span class="hljs-keyword">On</span>-<span class="hljs-keyword">Call</span>补贴: ¥<span class="hljs-number">2000</span>/周                             │
│       ├─ 需要出动时额外奖金: ¥<span class="hljs-number">500</span>/次                       │
│       └─ 故障结束可申请compensatory time <span class="hljs-keyword">off</span> (补休)        │
│                                                             │
└────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-13">故障恢复与容灾</h2>
<h3 data-id="heading-14">4.1 RTO/RPO的设计</h3>
<pre><code class="hljs language-makefile" lang="makefile">RTO (Recovery Time Objective) - 恢复时间目标

<span class="hljs-section">定义: 在发生故障时，系统从故障点到恢复到正常可用状态需要的最长时间</span>

<span class="hljs-section">Doris数据仓库:</span>
├─ 目标: RTO &lt; 2小时
├─ 设计: 
│  ├─ 快速故障转移 (3副本 → 2副本 → 可继续运行)
│  ├─ 自动告警 &amp; 人工干预 (30分钟内)
│  ├─ 恢复脚本 &amp; 自动化 (30分钟内完成)
│  └─ 验证 &amp; 回滚 (30分钟内)
└─ 验证: 每月演练一次 (故障转移测试)

<span class="hljs-section">Flink流处理:</span>
├─ 目标: RTO &lt; 1小时
├─ 设计:
│  ├─ Checkpoint持久化 (状态恢复)
│  ├─ 任务自动重启 (YARN/K8s)
│  ├─ 告警通知 + 人工确认 (10分钟)
│  └─ 从checkpoint恢复 (20分钟)
└─ 验证: 每周人工触发任务故障，测试恢复

<span class="hljs-section">POS数据采集:</span>
├─ 目标: RTO &lt; 1小时
├─ 设计:
│  ├─ 本地缓存 (POS服务器本地数据缓冲)
│  ├─ Kafka持久化 (消息队列保留7天)
│  ├─ 快速切换备用采集源 (10分钟)
│  └─ 数据重传 &amp; 对账 (30分钟)
└─ 验证: 模拟POS宕机，测试缓存和重传

───────────────────────────────────────────

RPO (Recovery Point Objective) - 恢复点目标

<span class="hljs-section">定义: 在发生故障时，可以接受的最大数据丢失量</span>

<span class="hljs-section">Doris数据仓库:</span>
├─ 目标: RPO &lt; 1小时
├─ 设计:
│  ├─ 实时副本 (3份副本，任何时刻任意2份一致)
│  ├─ 定期备份 (每天凌晨2点完整备份)
│  ├─ 增量备份 (每小时增量备份)
│  └─ 备份位置: HDFS/NAS (异地存储)
└─ 验证: 每周验证备份可恢复

<span class="hljs-section">Flink流处理:</span>
├─ 目标: RPO &lt; 30分钟
├─ 设计:
│  ├─ Checkpoint间隔: 60秒
│  ├─ 保留最近3个checkpoint
│  ├─ Checkpoint存储: HDFS (高可用)
│  └─ 恢复: 从最新checkpoint恢复 (丢失&lt;1小时数据)
└─ 验证: 定期测试checkpoint恢复

<span class="hljs-section">POS数据采集:</span>
├─ 目标: RPO &lt; 1小时
├─ 设计:
│  ├─ Kafka消息保留: 7天
│  ├─ 采集失败本地缓存: 24小时
│  ├─ 定期对账: 小时级
│  └─ 遗漏数据修复: T+1日
└─ 验证: 模拟消息丢失，测试恢复

───────────────────────────────────────────

<span class="hljs-section">多层容灾设计:</span>

<span class="hljs-section">第1层: 应用层容灾</span>
├─ 多副本存储 (3份副本)
├─ 自动转移 (检测故障自动切换)
└─ 故障隔离 (故障部分不影响整体)

<span class="hljs-section">第2层: 数据层容灾</span>
├─ 每小时全量备份
├─ 增量日志保留 (支持1小时内任意恢复点)
└─ 异地备份 (与主集群不同机房)

<span class="hljs-section">第3层: 网络层容灾</span>
├─ 多条网络链路 (主用+备用)
├─ 自动转移 (主链路故障自动切换备用)
└─ 故障检测 (心跳检测)

<span class="hljs-section">第4层: 基础设施层容灾</span>
├─ 多数据中心部署 (可选, 后期)
├─ 硬件冗余
└─ 电力 &amp; 网络冗余 (UPS, 双网络接入)
</code></pre>
<h3 data-id="heading-15">4.2 备份与恢复流程</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">备份流程:</span>

天级备份 (Daily Full Backup)
├─ 时间: 每天凌晨2:00-4:00
├─ 对象: Doris全量数据 + 元数据
├─ 目的地: /backup/doris_full/yyyymmdd/
├─ 保留策略: 保留最近7天全量备份 + 最近4个月月度备份
├─ 验证: 备份完成后自动校验 (checksum验证)
└─ 通知: 成功/失败通知运维团队

小时级增量 (Hourly Incremental)
├─ 时间: 每小时执行一次
├─ 对象: 上个小时新增/修改的数据
├─ 目的地: /backup/doris_incremental/hhmm/
├─ 保留策略: 保留最近7天的增量
└─ 用途: 支持任意时间点恢复

Checkpoint备份 (Flink &amp; Kafka)
├─ Flink: 每分钟自动checkpoint
│  ├─ 存储: HDFS /flink/checkpoints/
│  ├─ 保留: 最近10个checkpoint
│  └─ 恢复: 任务故障后从最新checkpoint自动恢复
│
└─ Kafka: 消息持久化
   ├─ 保留: 7天消息历史
   ├─ 副本: 3份副本
   └─ 恢复: 消费者可重置offset重新消费

───────────────────────────────────────────

<span class="hljs-section">恢复流程:</span>

<span class="hljs-section">场景1: 单个表数据损坏</span>

<span class="hljs-section">步骤1: 故障诊断 (5分钟)</span>
├─ 识别受影响的表
├─ 确定损坏的时间范围
└─ 确定恢复点 (最近的好数据时刻)

<span class="hljs-section">步骤2: 备份选择 (10分钟)</span>
├─ 如果&lt;1小时: 从增量备份恢复
├─ 如果&lt;1天: 从天备份恢复
└─ 如果&gt;1周: 恢复困难，可能需要重新导入

<span class="hljs-section">步骤3: 恢复执行 (30分钟)</span>
├─ 创建临时表存放恢复数据
├─ 从备份恢复数据到临时表
├─ 验证临时表数据
└─ 与原表切换 (原子操作)

<span class="hljs-section">步骤4: 验证与通知 (15分钟)</span>
├─ 数据对账验证
├─ 查询测试
├─ 通知业务方恢复完成

<span class="hljs-section">总耗时: &lt;1小时</span>

───────────────────────────────────────────

<span class="hljs-section">场景2: Doris整个集群故障</span>

<span class="hljs-section">步骤1: 故障诊断 (15分钟)</span>
├─ 检查所有FE/BE节点状态
├─ 检查网络连接
├─ 查看错误日志
└─ 判断故障类型

<span class="hljs-section">步骤2: 应急恢复 (60分钟)</span>
├─ 选项A: 重启故障节点
│  ├─ 如果节点重启后恢复 → 完成
│  └─ 如果仍然故障 → 选项B
│
├─ 选项B: 降级运行
│  ├─ 停用故障节点
│  ├─ 集群在2副本模式下运行 (降级但可用)
│  ├─ 派遣运维人员现场排查
│  └─ 同时购买或更换硬件
│
└─ 选项C: 从备份完全恢复
   ├─ 准备新的BE节点
   ├─ 从备份导入数据 (可能需要2-4小时)
   ├─ 副本构建 (1-2小时)
   └─ 验证通过后上线

<span class="hljs-section">总耗时: 1-4小时 (取决于选择的方案)</span>

───────────────────────────────────────────

<span class="hljs-section">场景3: 数据中心故障 (机房断网/断电)</span>

<span class="hljs-section">现象: 整个Doris集群无法访问</span>

应急措施 (此情况下RTO可能&gt;2小时):
├─ 立即通知所有用户数据暂时不可用
├─ 启动容灾方案 (如有其他IDC的备份集群)
├─ 从异地备份恢复 (需要4-8小时)
├─ 恢复后的数据会丢失&lt;1小时 (根据备份策略)
└─ 对用户进行赔偿 &amp; 说明

<span class="hljs-section">预防措施:</span>
├─ 多IDC部署 (后期规划, 初期可用NAS备份)
├─ 数据同城多份备份
└─ 异地备份 (至少一份)
</code></pre>
<hr/>
<h2 data-id="heading-16">持续改进机制</h2>
<h3 data-id="heading-17">5.1 事后总结会 (Postmortem)</h3>
<pre><code class="hljs language-makefile" lang="makefile">每次P1及以上故障后，必须在24-48小时内召开事后总结会

<span class="hljs-section">会议组织:</span>

<span class="hljs-section">组织方: CDO (负责组织与主持)</span>
<span class="hljs-section">参加人:</span>
├─ 故障处理的所有参与者 (技术/运维)
├─ 相关业务方负责人
├─ CDO/Tech Lead/PM
└─ 轮流邀请团队其他成员学习 (知识分享)

<span class="hljs-section">时间: 1.5-2小时</span>
<span class="hljs-section">地点: 线上视频会议 (便于录制)</span>

────────────────────────────────────────

<span class="hljs-section">会议议程:</span>

1. Timeline回顾 (15分钟)
   └─ 展示故障发生的完整时间线:
      ├─ 14:30 告警触发
      ├─ 14:35 人员集合
      ├─ 14:50 原因确认
      ├─ 15:20 修复执行
      └─ 15:45 完全恢复

2. 事实陈述 (20分钟)
   └─ 故障发生的客观事实:
      ├─ <span class="hljs-string">"发生了什么"</span> (不是<span class="hljs-string">"为什么"</span>)
      ├─ 影响范围与影响时间
      ├─ 采取的应急措施
      └─ 最终如何解决

3. Root Cause分析 (30分钟)
   └─ 用<span class="hljs-string">"5个Why"</span>分析根本原因:
      ├─ Why1: <span class="hljs-string">"系统故障了"</span> 为什么?
      │      答: <span class="hljs-string">"内存溢出"</span>
      │
      ├─ Why2: <span class="hljs-string">"为什么内存溢出"</span>
      │      答: <span class="hljs-string">"某个查询没有优化"</span>
      │
      ├─ Why3: <span class="hljs-string">"为什么没有优化"</span>
      │      答: <span class="hljs-string">"在code review中没被发现"</span>
      │
      ├─ Why4: <span class="hljs-string">"为什么code review没发现"</span>
      │      答: <span class="hljs-string">"reviewer不了解这个模块的性能影响"</span>
      │
      └─ Why5: <span class="hljs-string">"为什么reviewer不了解"</span>
             答: <span class="hljs-string">"缺少性能测试和文档"</span> ← ROOT CAUSE
      
   └─ 最终认定: 根本原因是<span class="hljs-string">"缺少性能测试"</span>

4. 行动项 (20分钟)
   └─ 制定改进措施:
      ├─ 短期 (立即): 
      │  ├─ 优化该查询
      │  ├─ 清理过期数据
      │  └─ 增加内存
      │
      ├─ 中期 (1周内):
      │  ├─ 建立性能测试流程
      │  ├─ 增加code review checklist
      │  └─ 培训团队性能优化
      │
      └─ 长期 (1个月内):
         ├─ 建立自动化性能测试
         ├─ 建立性能基准
         └─ 定期性能评审
   
   └─ 每个Action必须有:
      ├─ 具体描述 (清晰、可测量)
      ├─ Owner (谁负责)
      ├─ Deadline (什么时间完成)
      └─ Success Criteria (完成标准是什么)

5. 学到的经验 (15分钟)
   └─ 讨论积极的方面:
      ├─ <span class="hljs-string">"响应速度很快，5分钟内集合了所有人"</span> 好!
      ├─ <span class="hljs-string">"自动告警工作很好，及时发现了问题"</span> 好!
      ├─ <span class="hljs-string">"团队协作很紧密，很快找到了原因"</span> 好!
      └─ <span class="hljs-string">"恢复流程清晰，不到1小时恢复"</span> 好!
   
   └─ 目的: 强化好的做法，提升团队信心

────────────────────────────────────────

<span class="hljs-section">输出物:</span>

1. 事后报告 (Postmortem Report)
   ├─ 发给: 所有stakeholders + 归档Wiki
   ├─ 包含:
   │  ├─ Executive Summary (1页概述)
   │  ├─ Timeline &amp; Facts (完整时间线)
   │  ├─ Root Cause Analysis (5个Why + RCA)
   │  ├─ Action Items (改进计划)
   │  ├─ Lessons Learned (学到的经验)
   │  └─ 附件 (日志、监控图表、代码diff等)
   │
   └─ 发送: 邮件通知所有人
      <span class="hljs-string">"本周一14:30故障的事后报告已发送，请查收"</span>

2. Action Items跟踪
   ├─ 记录在项目管理系统 (Jira/Trello)
   ├─ 每周进度跟踪 (在周会上报告)
   ├─ Deadline到期后验证完成情况
   └─ 归档并标记为<span class="hljs-string">"Completed"</span>

────────────────────────────────────────

<span class="hljs-section">注意事项:</span>

✅ 正确的Postmortem:
├─ 不指责任何人 (<span class="hljs-string">"为什么这样做"</span>而不是<span class="hljs-string">"你干了什么蠢事"</span>)
├─ 事实为基础 (而不是猜测和假设)
├─ 有具体的改进行动
├─ 有owner和deadline
├─ 后续会追踪完成情况
└─ 基调是学习而不是惩罚

❌ 错误的Postmortem:
├─ <span class="hljs-string">"是XX工程师的错"</span> (指责个人)
├─ <span class="hljs-string">"应该防止这种故障"</span> (没有具体方案)
├─ 没有行动项 (开会讨论完就没了)
├─ 没有owner (责任不清)
├─ <span class="hljs-string">"这种故障以后不会发生"</span> (不现实)
└─ 只有惩罚，没有改进
</code></pre>
<h3 data-id="heading-18">5.2 SLA监控与评分</h3>
<pre><code class="hljs language-erlang" lang="erlang">月度SLA评分卡 (Monthly SLA Scorecard)

每月<span class="hljs-number">15</span>日发布上个月的SLA评分:

┌──────────────────────────────────────────────────────┐
│ <span class="hljs-number">2025</span>年<span class="hljs-number">11</span>月 数据平台SLA评分                           │
│                                                       │
│ 数据可用性      <span class="hljs-number">99.7</span><span class="hljs-comment">% ✓ 目标: ≥99.5%               │</span>
│ 数据延迟         &lt;<span class="hljs-number">5</span>m  ✓ 目标: &lt;<span class="hljs-number">5</span>分钟                │
│ 查询响应时间    P95&lt;<span class="hljs-number">4</span>s ✓ 目标: P95&lt;<span class="hljs-number">5</span>s              │
│ 数据准确率      <span class="hljs-number">99.95</span><span class="hljs-comment">% ✓ 目标: ≥99%                │</span>
│ 告警准确率       <span class="hljs-number">94</span><span class="hljs-comment">%   ⚠️  目标: ≥95% (需改进)     │</span>
│                                                       │
│ 总体评分: <span class="hljs-number">95.2</span>/<span class="hljs-number">100</span> (A级)                            │
│                                                       │
│ 故障统计:                                            │
│ • P0故障: <span class="hljs-number">0</span>次 (目标: <span class="hljs-number">0</span>次) ✓                         │
│ • P1故障: <span class="hljs-number">2</span>次 (目标: &lt;<span class="hljs-number">3</span>次) ✓                        │
│  └─ <span class="hljs-number">11</span>月<span class="hljs-number">5</span>日 Kafka延迟 (<span class="hljs-number">30</span>分钟内恢复)              │
│  └─ <span class="hljs-number">11</span>月<span class="hljs-number">18</span>日 查询卡顿 (<span class="hljs-number">1</span>小时内恢复)                │
│ • P2故障: <span class="hljs-number">5</span>次 (目标: &lt;<span class="hljs-number">5</span>次) ✓                        │
│ • 平均MTTR: <span class="hljs-number">42</span>分钟 (目标: &lt;<span class="hljs-number">1</span>小时) ✓                │
│ • 平均MTTF: <span class="hljs-number">3.2</span>天 (目标: &gt;<span class="hljs-number">3</span>天) ✓                   │
│                                                       │
│ 改进方向:                                            │
│ <span class="hljs-number">1</span>. 告警准确率需提升 (<span class="hljs-number">1</span>pp差距)                       │
│    - 原因: 某个告警规则参数设置不合理                │
│    - 改进: 本周微调告警规则                          │
│                                                       │
│ <span class="hljs-number">2</span>. 查询性能仍有优化空间                             │
│    - 某些复杂查询还是较慢                            │
│    - 计划: 下月优化<span class="hljs-number">5</span>个关键查询                      │
│                                                       │
│ 目标: <span class="hljs-number">12</span>月冲刺<span class="hljs-number">99</span>分,争取S级评分                      │
│                                                       │
└──────────────────────────────────────────────────────┘

评分等级:

│ 等级 │ 分数   │ 定义          │ 对应奖励                │
├──────┼────────┼──────────────┼─────────────────────────┤
│ S    │ <span class="hljs-number">99</span>-<span class="hljs-number">100</span> │ 优秀          │ 全队¥<span class="hljs-number">5000</span>奖金           │
│ A    │ <span class="hljs-number">95</span>-<span class="hljs-number">98</span>  │ 良好          │ 全队¥<span class="hljs-number">3000</span>奖金           │
│ B    │ <span class="hljs-number">90</span>-<span class="hljs-number">94</span>  │ 及格          │ 无奖金，但无扣分        │
│ C    │ <span class="hljs-number">80</span>-<span class="hljs-number">89</span>  │ 需改进        │ 每人扣¥<span class="hljs-number">500</span>（激励改进）│
│ D    │ &lt;<span class="hljs-number">80</span>    │ 严重不达标    │ 进行部门调查            │
└──────┴────────┴──────────────┴─────────────────────────┘
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ThreadLocal 源码深度解析：JDK 设计者的“妥协”与“智慧”]]></title>    <link>https://juejin.cn/post/7577690150093815848</link>    <guid>https://juejin.cn/post/7577690150093815848</guid>    <pubDate>2025-11-30T09:04:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150093815848" data-draft-id="7577795545440206882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ThreadLocal 源码深度解析：JDK 设计者的“妥协”与“智慧”"/> <meta itemprop="keywords" content="Java,后端"/> <meta itemprop="datePublished" content="2025-11-30T09:04:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户8491371754716"/> <meta itemprop="url" content="https://juejin.cn/user/2744800640504071"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ThreadLocal 源码深度解析：JDK 设计者的“妥协”与“智慧”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2744800640504071/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户8491371754716
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:04:53.000Z" title="Sun Nov 30 2025 09:04:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Java 并发编程中，<code>ThreadLocal</code> 是一个高频使用的“神器”，它能够轻松实现线程间的数据隔离。然而，关于它“内存泄漏”的警告也从未停止，甚至成为了面试中的一道必考题。</p>
<p>很多人会背诵“弱引用导致泄漏”，但往往知其然不知其所以然。<strong>为什么 JDK 必须要用弱引用？这背后究竟隐藏着怎样的设计博弈？</strong></p>
<p>本文将从 JDK 源码深处入手，揭示 <code>ThreadLocal</code> 的底层引用结构，剖析 JDK 设计者在<strong>性能、易用性与内存管理</strong>之间所做的精妙“妥协”与“智慧”。</p>
<h2 data-id="heading-0">一、破题：ThreadLocal 到底把数据存到哪里了？</h2>
<p>一个普遍的误解是：ThreadLocal 内部维护了一个全局的 Map 来存储数据。</p>
<p>事实恰恰相反。</p>
<p>从源码视角看，<code>ThreadLocal</code> 的设计目标并不是充当存储容器，而是一把<strong>访问数据的“钥匙”（Key）</strong>。真正的数据（Value）实际上存储在 <strong>当前线程对象 (<code>Thread.currentThread()</code>)</strong> 内部。</p>
<h3 data-id="heading-1">1.1 内存引用关系</h3>
<p>内存中的引用链如下所示：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[ThreadLocal - Key] --&gt; B[Current Thread]
    B --&gt; C[ThreadLocalMap - 存储 Value]
</code></pre>
<h3 data-id="heading-2">1.2 源码实证</h3>
<p>只要翻看 <code>Thread</code> 类的源码，真相一目了然：每个 <code>Thread</code> 对象都维护着一个私有的 <code>ThreadLocalMap</code> 成员变量。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Thread 类的部分核心源码 (JDK 8)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Thread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
 
    ThreadLocal.<span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">threadLocals</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>当我们调用 <code>threadLocalInstance.set(value)</code> 时，本质上执行了以下操作：</p>
<ol>
<li>获取当前线程对象 <code>Thread.currentThread()</code>。</li>
<li>获取线程内部的 <code>threadLocals</code> (即 <code>ThreadLocalMap</code>)。</li>
<li>以<strong>当前的 ThreadLocal 实例</strong>作为 Key，将 <code>value</code> 作为 Value 存入 Map。</li>
</ol>
<h2 data-id="heading-3">二、核心矛盾：为什么要设计成“弱引用”？</h2>
<p>为了透视内存泄漏的根源，我们必须解剖 <code>ThreadLocalMap</code> 的内部结构。它的核心数据结构 <code>Entry</code> 继承了 <code>WeakReference</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ThreadLocalMap 内部存储的 Entry</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; {
    <span class="hljs-comment">/** The value associated with this ThreadLocal. */</span>
    Object value;

    Entry(ThreadLocal&lt;?&gt; k, Object v) {
        <span class="hljs-built_in">super</span>(k); <span class="hljs-comment">// 重点：Key (ThreadLocal实例) 被包装成了弱引用</span>
        value = v;
    }
}
</code></pre>
<p>关键点：Key 是<strong>弱引用</strong>，而 Value 是<strong>强引用</strong>。</p>
<p>为什么 JDK 设计者不直接使用强引用？这是一次为了解决“Key 泄漏”的防御性设计。</p>
<h3 data-id="heading-4">2.1 假设：如果 Key 是强引用</h3>
<p>试想，如果 Entry 对 <code>ThreadLocal</code> 实例持有的是强引用：</p>
<ol>
<li><strong>外部引用消失</strong>：我们在业务代码中将 <code>ThreadLocal</code> 变量置为 null（<code>tl = null</code>）。</li>
<li><strong>内部引用犹存</strong>：由于当前线程（Thread）依然存活，<code>ThreadLocalMap</code> 依然持有 <code>Entry</code>，而 <code>Entry</code> 强引用着 <code>ThreadLocal</code> 实例。</li>
<li><strong>结果</strong>：虽然外部已经无法访问该对象，但 GC 无法回收它。只要线程不结束（如线程池场景），这个 <code>ThreadLocal</code> 对象就会一直驻留在堆内存中。</li>
</ol>
<p><strong>这就是“Key 泄漏”</strong>。</p>
<h3 data-id="heading-5">2.2 妥协：引入弱引用</h3>
<p>为了解决上述问题，JDK 采用了<strong>弱引用 (WeakReference)</strong> 机制：</p>
<blockquote>
<p><strong>弱引用的特性</strong>：只具有弱引用的对象，在垃圾回收器（GC）线程扫描它所管辖的内存区域过程中，一旦发现了只具有弱引用的对象，不管当前内存空间足够与否，都会回收它的内存。</p>
</blockquote>
<p>这个设计保证了：<strong>一旦外部代码不再引用 ThreadLocal 实例，它就能被 GC 及时回收，避免了 Key 层的内存泄漏。</strong></p>
<h2 data-id="heading-6">三、代价：著名的 Value 泄漏陷阱</h2>
<p>软件工程中没有完美的方案，只有权衡（Trade-off）。JDK 解决了 Key 的泄漏，却不得不面临另一个代价——<strong>Value 的泄漏</strong>。</p>
<h3 data-id="heading-7">3.1 泄漏是如何发生的？</h3>
<p>我们可以通过 Mermaid 图来直观地看清这个过程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    ThreadRef[Stack: Thread Ref] --&gt; ThreadObj[Heap: Current Thread]
    ThreadObj --&gt; Map[ThreadLocalMap]
    Map --&gt; Entry
    
    TLRef[Stack: ThreadLocal Ref] -.-&gt;|引用断开| TLObj[Heap: ThreadLocal Key]
    
    Entry -.-&gt;|Weak Ref| TLObj
    Entry --&gt;|Strong Ref| ValueObj[Heap: Value Object]
    
    style TLObj fill:#ffcccc,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5
    style ValueObj fill:#ff6666,stroke:#333,stroke-width:4px
</code></pre>
<ol>
<li><strong>Key 被回收</strong>：当外部引用断开，GC 发生后，Entry 中的 Key 变成了 <code>null</code>。</li>
<li><strong>Value 悬空</strong>：此时 Map 中存在一个 <code>Key=null, Value=Object</code> 的 Entry。</li>
<li><strong>引用链未断</strong>：<code>Current Thread -&gt; ThreadLocalMap -&gt; Entry -&gt; Value</code>。这条强引用链依然存在。</li>
<li><strong>后果</strong>：如果你使用的是<strong>线程池</strong>，线程会被复用而不会销毁。这意味着这个 <code>Value</code> 对象将永远驻留在内存中，无法被访问也无法被回收。</li>
</ol>
<p><strong>这就是所谓的 ThreadLocal 内存泄漏，本质上是 Value 的泄漏。</strong></p>
<h2 data-id="heading-8">四、JDK 的补救与最佳实践</h2>
<p>JDK 意识到了这个问题，并在 <code>ThreadLocalMap</code> 的 <code>get()</code>、<code>set()</code>、<code>remove()</code> 方法中埋下了“探测式清理”逻辑（<code>expungeStaleEntries</code> 方法）。当我们在操作 Map 时，它会顺带检查并清理 Key 为 <code>null</code> 的 Entry。</p>
<p>但这是一种<strong>被动</strong>的机制。如果线程在归还给线程池后，没有后续的 <code>ThreadLocal</code> 操作，这块内存依然无法释放。</p>
<h3 data-id="heading-9">4.1 终极解决方案：防御性编程</h3>
<p>要彻底解决内存泄漏，不能依赖 JDK 的被动清理，而必须依靠<strong>编码规范</strong>。</p>
<p><strong>请牢记以下标准范式：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 定义 ThreadLocal</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;UserInfo&gt; USER_INFO_HOLDER = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doBusiness</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 2. 设置值</span>
        USER_INFO_HOLDER.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserInfo</span>(<span class="hljs-string">"JuejinUser"</span>));
        
        <span class="hljs-comment">// 3. 执行业务逻辑</span>
        process();
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 4. 核心：必须在 finally 中手动 remove</span>
        <span class="hljs-comment">// 这能切断 Map 中的 Entry 引用，彻底防止泄漏</span>
        USER_INFO_HOLDER.remove();
    }
}
</code></pre>
<h2 data-id="heading-10">五、总结</h2>
<p><code>ThreadLocal</code> 的源码设计是一场关于<strong>生命周期管理</strong>的精彩博弈：</p>
<ol>
<li><strong>如果不作为</strong>（全强引用）：会导致 <code>ThreadLocal</code> 对象本身的泄漏（Key 泄漏）。</li>
<li><strong>引入弱引用</strong>：解决了 Key 泄漏，但导致了 Value 的游离。</li>
<li><strong>最终的智慧</strong>：JDK 选择牺牲 Value 的安全性（可能泄漏）来换取 Key 的自动管理。因为它认为 <strong>Value 的生命周期理应由开发者在业务逻辑中显式控制</strong>。</li>
</ol>
<p>作为开发者，理解了这一层“妥协”，我们才能更安全地驾驭这个并发利器。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch Filter 缓存：Bitset 如何让查询速度飙升]]></title>    <link>https://juejin.cn/post/7577737385955065866</link>    <guid>https://juejin.cn/post/7577737385955065866</guid>    <pubDate>2025-11-30T09:06:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385955065866" data-draft-id="7577971299742875686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch Filter 缓存：Bitset 如何让查询速度飙升"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T09:06:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Penge666"/> <meta itemprop="url" content="https://juejin.cn/user/1549628692501449"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch Filter 缓存：Bitset 如何让查询速度飙升
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549628692501449/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Penge666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:06:31.000Z" title="Sun Nov 30 2025 09:06:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>用过 Elasticsearch 的同学大概率都听过 “把过滤条件放 filter 里更快”，但很少有人说清背后到底快在哪。今天我们就用一个电商订单索引的真实场景，一步步拆解 Filter 的 Bitset 缓存工作原理，让你彻底搞懂这个性能优化的关键！</p>
<h2 data-id="heading-0">一、先搭个场景：电商订单索引</h2>
<p>假设我们有一个<code>orders</code>索引，存了 10 条订单数据（文档 ID 1~10），字段结构很简单：</p>
<ul>
<li><code>user_id</code>：用户 ID（keyword 类型，精准匹配）</li>
<li><code>order_time</code>：下单时间（date 类型，时间戳存储）</li>
<li><code>status</code>：订单状态（keyword 类型：paid/unpaid/refunded）</li>
</ul>
<p>现在要查 “用户 1001 在 2025 年 6 月之后下的订单”，对应的 DSL 是：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"bool"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"filter"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span> <span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1001"</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span> <span class="hljs-attr">"range"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"order_time"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"gte"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1748419000</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>接下来，我们就跟着这个查询，看看 Bitset 缓存是怎么工作的。</p>
<h2 data-id="heading-1">二、第一次查询：从零生成 Bitset</h2>
<p>当这个查询第一次执行时，ES 还没有任何缓存，需要走完整的 “扫描 - 生成 - 缓存” 流程。</p>
<h3 data-id="heading-2">1. 第一步：为<code>user_id=1001</code>生成 Bitset</h3>
<p>Bitset（位图）是个超轻量的二进制结构 ——<strong>每一位对应一个文档 ID，匹配标 1，不匹配标 0</strong>。</p>
<ul>
<li>ES 先扫<code>user_id</code>的倒排索引，发现文档 2、5、7、9 属于用户 1001；</li>
<li>生成 Bitset：<code>0 1 0 0 1 0 1 0 1 0</code>（第 2、5、7、9 位是 1）；</li>
<li>把这个 Bitset 存进内存缓存，贴上标签：<code>user_id:1001</code>。</li>
</ul>
<h3 data-id="heading-3">2. 第二步：为<code>order_time&gt;=1748419000</code>生成 Bitset</h3>
<p>同样的逻辑，处理时间范围条件：</p>
<ul>
<li>扫<code>order_time</code>的倒排索引，找到文档 3、5、7、8、10 符合时间要求；</li>
<li>生成 Bitset：<code>0 0 1 0 1 0 1 1 0 1</code>（第 3、5、7、8、10 位是 1）；</li>
<li>缓存这个 Bitset，标签：<code>order_time:&gt;=1748419000</code>。</li>
</ul>
<h3 data-id="heading-4">3. 第三步：位运算组合出最终结果</h3>
<p>两个 Bitset 都有了，ES 会做<strong>AND 位运算</strong>（只有两位都为 1 才保留）：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">user_id=1001的Bitset：0 1 0 0 1 0 1 0 1 0
order_time&gt;=...的Bitset：0 0 1 0 1 0 1 1 0 1
AND运算结果：0 0 0 0 1 0 1 0 0 0
</code></pre>
<p>一眼就能看出，只有文档 5、7 同时满足两个条件 —— 这比逐行检查文档快了不止一个量级！</p>
<h2 data-id="heading-5">三、第二次查询：直接复用缓存，速度起飞</h2>
<p>如果几分钟后，你又执行了<strong>一模一样的过滤条件</strong>，事情就简单了：</p>
<ol>
<li>ES 直接从内存里拽出之前缓存的两个 Bitset，<strong>不用再扫倒排索引</strong>；</li>
<li>重复 AND 位运算，瞬间得到结果；</li>
<li>返回文档 5、7。</li>
</ol>
<p>整个过程跳过了最耗时的 “扫描索引” 步骤，响应时间可能从几十毫秒降到几毫秒 —— 这就是缓存的威力！</p>
<h2 data-id="heading-6">四、数据变了怎么办？Bitset 的智能更新</h2>
<p>如果这时候新增了一条文档 11（user_id=1001，order_time=1748500000），Bitset 会怎么处理？</p>
<ul>
<li>ES 不会删掉旧缓存，而是<strong>增量更新</strong>：把<code>user_id:1001</code>的 Bitset 第 11 位设为 1，<code>order_time:&gt;=...</code>的 Bitset 第 11 位也设为 1；</li>
<li>下次查询时，结果里就会自动包含文档 11，既保证了准确性，又没浪费缓存。</li>
</ul>
<h2 data-id="heading-7">五、Bitset 为啥这么牛？核心优势拆解</h2>
<ol>
<li><strong>极致轻量化</strong>：1000 万个文档的 Bitset 只占约 1.2MB 内存（10^7 位 = 10^7/8/1024 ≈ 1220KB），亿级文档也才几十 MB；</li>
<li><strong>运算超快</strong>：位运算是 CPU 原生支持的操作，比遍历文档快几个数量级；</li>
<li><strong>缓存复用率高</strong>：缓存的是 “条件规则” 而非 “查询结果”，只要过滤条件相同，不管查什么字段都能复用。</li>
</ol>
<h2 data-id="heading-8">六、缓存的生命周期：何时过期？占用多少内存？</h2>
<h3 data-id="heading-9">1. 缓存的内存占用规则</h3>
<p>Bitset 缓存并非独立存在，而是属于 ES 的<strong>Node Query Cache</strong>（节点级查询缓存），其内存上限由参数<code>indices.queries.cache.size</code>控制：</p>
<ul>
<li>默认值为 JVM 堆内存的 10%（比如 JVM 堆是 31GB，缓存上限约 3.1GB）；</li>
<li>也可手动设置固定值（如<code>512mb</code>），避免占用过多堆内存。</li>
</ul>
<p>以 1000 万文档的 Bitset 为例，单个条件的 Bitset 仅占 1.2MB 左右，3.1GB 的缓存空间足以存储数百万个过滤条件的 Bitset，完全满足常规业务需求。</p>
<h3 data-id="heading-10">2. 缓存何时 “过期”？</h3>
<p>Bitset 缓存<strong>没有固定过期时间</strong>，而是遵循<strong>LRU（最近最少使用）淘汰策略</strong>：</p>
<ul>
<li>高频使用的过滤条件（如<code>user_id=1001</code>）会长期驻留内存，反复复用；</li>
<li>低频使用的条件，当缓存空间不足时，会被优先淘汰；</li>
<li>若索引数据发生变更（新增 / 删除 / 更新文档），ES 会<strong>增量更新</strong>受影响的 Bitset，而非直接淘汰 —— 比如修改了文档 5 的<code>user_id</code>，仅把<code>user_id:1001</code>的 Bitset 第 5 位从 1 改为 0，其余位保持不变。</li>
</ul>
<p>只有当缓存达到内存上限，且该 Bitset 长期未被访问时，才会被 LRU 机制清理。</p>
<h2 data-id="heading-11">七、和 must 比，filter 到底快在哪？</h2>
<p>很多人问 “为啥 must 里的条件不能用 Bitset？”—— 因为<code>must</code>要算相关性评分（<code>_score</code>），必须逐文档计算；而<code>filter</code>只需要 “是 / 否” 的判断，刚好适配 Bitset 的二进制特性。</p>
<p>简单说：</p>
<ul>
<li><code>must</code>：既要匹配，又要评分 → 慢；</li>
<li><code>filter</code>：只匹配，不评分 → 能用 Bitset 缓存 → 快！</li>
</ul>
<h2 data-id="heading-12">八、最后划重点：Filter 缓存的实用建议</h2>
<ol>
<li><strong>过滤条件必放 filter</strong>：尤其是<code>term</code>/<code>range</code>/<code>terms</code>这类不影响评分的条件；</li>
<li><strong>缓存不用手动管</strong>：ES 会用 LRU 策略自动管理内存，默认占 JVM 堆的 10%，无需手动清理；</li>
<li><strong>高频条件收益最大</strong>：比如按用户 ID、时间范围的过滤，缓存命中率极高；低频条件则可能被淘汰，无需纠结；</li>
<li><strong>手动调整缓存大小</strong>：若业务有大量高频过滤条件，可适当调高<code>indices.queries.cache.size</code>（如设为 20%），提升缓存命中率。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# 【Maven避坑】源码去哪了？一文看懂 Maven 工程与打包后的目录映射关系]]></title>    <link>https://juejin.cn/post/7577737385955147786</link>    <guid>https://juejin.cn/post/7577737385955147786</guid>    <pubDate>2025-11-30T09:25:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385955147786" data-draft-id="7577971299742990374" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# 【Maven避坑】源码去哪了？一文看懂 Maven 工程与打包后的目录映射关系"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-30T09:25:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户030480591263"/> <meta itemprop="url" content="https://juejin.cn/user/3793762867478852"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # 【Maven避坑】源码去哪了？一文看懂 Maven 工程与打包后的目录映射关系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3793762867478852/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户030480591263
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:25:15.000Z" title="Sun Nov 30 2025 09:25:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>【Maven避坑】源码去哪了？一文看懂 Maven 工程与打包后的目录映射关系</p>
<blockquote>
<p><strong>摘要</strong>：你是否遇到过 <code>FileNotFoundException</code>？是否遇到过 MyBatis 报错 <code>Invalid bound statement</code>？很多时候，这并非代码写错了，而是你没搞懂 Maven 打包时把你的文件“搬”到了哪里。本文将通过图解，带你揭开 Maven 打包的“乾坤大挪移”之谜。本文由Gemini 3.0 生成</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>作为一个 Java 后端新人，在开发过程中，我常会有这样的困惑：</p>
<ul>
<li>我在 <code>src/main/resources</code> 下写的 <code>application.yml</code>，程序运行起来后到底去哪找它？</li>
<li>为什么我的 Mapper XML 文件明明在工程里，打包后却不见了？</li>
<li>经常听到的 <strong>Classpath（类路径）</strong>，到底指的是哪里？</li>
</ul>
<p>Maven 遵循“约定优于配置”的原则，但如果我们不了解这个“约定”，开发时就会踩坑。今天我们就来拆解一下 Maven 项目从<strong>源码</strong>到<strong>JAR包</strong>的映射关系。</p>
<h2 data-id="heading-1">一、 一张图看懂核心映射</h2>
<p>Maven 在执行 <code>mvn package</code> 打包时，主要做了一件事：把 <code>src/main</code> 下的<strong>Java 代码</strong>和<strong>资源文件</strong>，经过编译和整理，合并到了 JAR 包的<strong>根目录</strong>下。</p>
<p>请看下面的对比图（这是最核心的知识点）：</p>
<pre><code class="hljs language-text" lang="text">【工程源码目录 (Source)】                    【打包后的 JAR 内部目录 (Runtime)】
MyProject
├── src
│   ├── main
│   │   ├── java (Java代码)
│   │   │   └── com
│   │   │       └── demo
│   │   │           └── User.java  ---&gt;  com/demo/User.class (变成了字节码)
│   │   │
│   │   └── resources (资源文件)
│   │       ├── application.yml  -----&gt;  application.yml (直接在根目录下！)
│   │       ├── mybatis-config.xml ---&gt;  mybatis-config.xml
│   │       └── mapper
│   │           └── UserMapper.xml ---&gt;  mapper/UserMapper.xml
│   │
│   └── test (测试代码)
│       └── ...                    ---&gt;  (直接丢弃，不进入最终JAR包)
</code></pre>
<h2 data-id="heading-2">二、 三大映射规则</h2>
<p>理解了上面的图，我们可以总结出 Maven 的三条打包铁律：</p>
<h3 data-id="heading-3">1. Java 目录：编译并保持结构</h3>
<p>Maven 会调用 <code>javac</code> 将 <code>src/main/java</code> 下的 <code>.java</code> 文件编译成 <code>.class</code> 文件。
<strong>重点</strong>：包路径（package）会直接转化为文件夹路径。</p>
<ul>
<li>源码：<code>src/main/java/com/demo/User.java</code></li>
<li>打包后：<code>JAR根/com/demo/User.class</code></li>
</ul>
<h3 data-id="heading-4">2. Resources 目录：复制并“平铺”</h3>
<p><code>src/main/resources</code> 是资源的<strong>根目录</strong>。Maven 会把这个文件夹<strong>内部</strong>的所有东西，直接复制到 JAR 包的<strong>根目录</strong>下。
<strong>重点</strong>：它会和编译后的 class 文件混在一起！</p>
<ul>
<li>这就是为什么我们在代码里读取配置文件时（例如 <code>classpath:application.yml</code>），不需要写 <code>resources/</code> 前缀，因为它就在根目录下。</li>
</ul>
<h3 data-id="heading-5">3. Test 目录：用完即弃</h3>
<p><code>src/test</code> 下的所有代码和资源，仅在 <code>mvn test</code> 阶段生效。它们<strong>绝对不会</strong>出现在最终生成的 JAR 包里。</p>
<ul>
<li><strong>避坑</strong>：千万不要在生产代码里依赖 <code>src/test</code> 下写的工具类。</li>
</ul>
<h2 data-id="heading-6">三、 经典踩坑场景：MyBatis 的 XML 去哪了？</h2>
<p>这是初学者最容易遇到的坑。</p>
<h3 data-id="heading-7">场景 A：XML 放在 resources 下（推荐 ✅）</h3>
<p>如果你把 <code>UserMapper.xml</code> 放在 <code>src/main/resources/mapper/</code> 下。
根据规则 2，打包后它位于 <code>JAR根/mapper/UserMapper.xml</code>。
一切正常，程序能找到。</p>
<h3 data-id="heading-8">场景 B：XML 放在 java 目录下（报错 ❌）</h3>
<p>为了方便管理，很多人喜欢把 <code>UserMapper.xml</code> 和 <code>UserMapper.java</code> 接口放在同一个包下，例如 <code>src/main/java/com/demo/mapper/</code>。</p>
<p><strong>后果</strong>：
Maven 的默认机制是：<strong>在 <code>src/main/java</code> 目录下，只编译 <code>.java</code> 文件，忽略其他所有文件（包括 XML）。</strong>
所以，你的 JAR 包里根本没有那个 XML 文件！MyBatis 启动时自然报错。</p>
<p><strong>解决方案</strong>：
如果你非要这么放，必须在 <code>pom.xml</code> 中配置资源过滤，告诉 Maven：“别忽略我的 XML！”</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<h2 data-id="heading-9">四、 所谓的 Classpath 到底是什么？</h2>
<p>理解了目录映射，Classpath 的概念就迎刃而解了。</p>
<p>在 Spring 或 Java 中，当我们说 <code>classpath:</code> 时，指的就是 <strong>打包后的 JAR 包根目录</strong>（或者在 IDE 开发时，指的是 <code>target/classes</code> 目录）。</p>
<ul>
<li><code>classpath:application.yml</code> -&gt; 去 JAR 包根目录找。</li>
<li><code>classpath:com/demo/User.class</code> -&gt; 去 JAR 包根目录下的 com/demo 找。</li>
</ul>
<h2 data-id="heading-10">五、 动手验证（Show me the code）</h2>
<p>不要只听我说，建议你自己动手验证一下，印象会更深：</p>
<ol>
<li>找一个 Maven 项目，执行命令 <code>mvn package</code>。</li>
<li>进入项目的 <code>target</code> 目录。</li>
<li>找到生成的 <code>.jar</code> 文件。</li>
<li><strong>把后缀名从 <code>.jar</code> 改成 <code>.zip</code>，然后解压它！</strong></li>
</ol>
<p>打开解压后的文件夹，你会发现，所谓的“神秘”目录结构，其实就是你 <code>src/main/java</code> 和 <code>src/main/resources</code> 里的东西合并在一起了而已。</p>
<hr/>
<blockquote>
<p><strong>结语</strong>：
技术没有黑魔法，一切看似复杂的问题，背后往往都是简单的文件操作和路径映射。希望这篇文章能帮你彻底搞懂 Maven 的目录结构，以后的开发之路上少踩几个坑！</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java Stream.filter 全面解析：定义、原理与最常见使用场景]]></title>    <link>https://juejin.cn/post/7577690150093865000</link>    <guid>https://juejin.cn/post/7577690150093865000</guid>    <pubDate>2025-11-30T09:25:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150093865000" data-draft-id="7577795545440239650" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java Stream.filter 全面解析：定义、原理与最常见使用场景"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T09:25:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木木一直在哭泣"/> <meta itemprop="url" content="https://juejin.cn/user/3896324937225085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java Stream.filter 全面解析：定义、原理与最常见使用场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3896324937225085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木木一直在哭泣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:25:13.000Z" title="Sun Nov 30 2025 09:25:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java Stream.filter 全面解析：定义、原理与最常见使用场景</h2>
<p><code>filter</code> 是 Java Stream 最常用、也最容易理解错的操作之一。它看似简单——“过滤元素”——但底层机制、函数式定义、实际使用场景都值得深入理解。</p>
<p>本篇文章将从 <strong>函数定义 → 底层原理 → 使用场景 → 注意事项</strong>，系统地讲透 <code>filter</code>。</p>
<hr/>
<h2 data-id="heading-1">一、filter 的函数定义是什么？</h2>
<p>Java Stream 中的 <code>filter</code> 定义如下：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">Stream</span>&lt;<span class="hljs-type">T</span>&gt; filter(<span class="hljs-type">Predicate</span>&lt;? <span class="hljs-keyword">super</span> <span class="hljs-type">T</span>&gt; predicate)
</code></pre>
<p>把它拆开解释：</p>





















<table><thead><tr><th>部分</th><th>含义</th></tr></thead><tbody><tr><td><code>Stream&lt;T&gt;</code></td><td>输入是 T 类型流，输出仍然是 T 类型流</td></tr><tr><td><code>filter(...)</code></td><td>执行过滤操作</td></tr><tr><td><code>Predicate&lt;? super T&gt;</code></td><td>一个返回 boolean 的判断函数</td></tr></tbody></table>
<h4 data-id="heading-2">✔ filter 的本质：<strong>保留满足条件的元素，丢掉不满足的。</strong></h4>
<p><code>Predicate</code> 是一个函数接口：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">boolean</span> <span class="hljs-title">test</span><span class="hljs-params">(T t)</span></span>;
</code></pre>
<p>你只需要告诉 <code>filter</code>：</p>
<p>✔ <strong>这个元素要不要留下？</strong></p>
<ul>
<li>返回 <code>true</code>：保留</li>
<li>返回 <code>false</code>：丢弃</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、filter 的底层执行原理</h2>
<p>要真正理解 filter 的行为，需要理解 <strong>Stream 的流水线（Pipeline）模型</strong> 和 <strong>惰性求值（Lazy Evaluation）</strong> 。</p>
<p>下面我把整个底层机制按“从源码角度也能看懂”的方式讲清楚。</p>
<hr/>
<h3 data-id="heading-4">1. Stream 是一条流水线（pipeline）</h3>
<p>当你写：</p>
<pre><code class="hljs language-python" lang="python">stream.<span class="hljs-built_in">filter</span>(x -&gt; x &gt; <span class="hljs-number">10</span>).<span class="hljs-built_in">map</span>(x -&gt; x * <span class="hljs-number">2</span>).<span class="hljs-built_in">sorted</span>()
</code></pre>
<p>其实底层不是立刻执行，而是构建出一条“操作链”：</p>
<pre><code class="hljs language-css" lang="css">StreamSource → <span class="hljs-attribute">Filter</span> → Map → Sorted → TerminalOp
</code></pre>
<p>每个操作都只是往链上“挂一个步骤”，<strong>没有真正处理任何数据</strong>。</p>
<hr/>
<h3 data-id="heading-5">2. filter 不会“过滤掉元素”，它只是包装一个 Predicate</h3>
<p>底层并不创建新集合，也不删除原集合元素。</p>
<p>它做的是：</p>
<blockquote>
<p><strong>把你的 Predicate 包装成一个用于判断的处理器（Sink）放入流水线中。</strong></p>
</blockquote>
<p>底层结构可以简化理解为：</p>
<pre><code class="hljs language-scss" lang="scss">if (predicate.test(element))
    <span class="hljs-built_in">pushToNextStep</span>(element)
else
    drop element
</code></pre>
<p>每个元素会沿着流水线向下传递，直到某个步骤决定丢弃它。</p>
<p>filter 就是这样的“拦截器（Interceptor）”。</p>
<hr/>
<h3 data-id="heading-6">3. 真正的执行是在终止操作（Terminal Operation）触发的</h3>
<p>例如：</p>
<pre><code class="hljs language-scss" lang="scss">stream<span class="hljs-selector-class">.filter</span>(...)<span class="hljs-selector-class">.map</span>(...)<span class="hljs-selector-class">.toList</span>();
</code></pre>
<p>当 <code>toList()</code> 被调用时，Stream 才开始：</p>
<ol>
<li>从数据源（List、数组……）逐个取元素</li>
<li>把元素交给 filter 判断</li>
<li>满足条件则传递到 map</li>
<li>再传递给最终的收集操作（collector）</li>
</ol>
<hr/>
<h3 data-id="heading-7">4. 底层执行顺序是“逐个元素完整走链路”，而不是“一个操作处理完再下一个”</h3>
<p>例如：</p>
<pre><code class="hljs language-scss" lang="scss">List<span class="hljs-selector-class">.of</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>)
    <span class="hljs-selector-class">.stream</span>()
    <span class="hljs-selector-class">.filter</span>(x -&gt; x % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)
    <span class="hljs-selector-class">.map</span>(x -&gt; x * <span class="hljs-number">10</span>)
    <span class="hljs-selector-class">.toList</span>();
</code></pre>
<p>执行流程不是：</p>
<pre><code class="hljs language-arduino" lang="arduino">先过滤所有 → 再 map 所有
</code></pre>
<p>而是：</p>
<h4 data-id="heading-8">✔ 实际执行方式（逐个流动）：</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span> → <span class="hljs-attribute">filter</span>(丢弃)
<span class="hljs-number">2</span> → <span class="hljs-attribute">filter</span>(通过) → map → 收集
<span class="hljs-number">3</span> → <span class="hljs-attribute">filter</span>(丢弃)
<span class="hljs-number">4</span> → <span class="hljs-attribute">filter</span>(通过) → map → 收集
</code></pre>
<p><strong>每个元素都是从头到尾完整走一遍流水线</strong>。</p>
<p>这就是为什么 Stream 只需要“一次遍历”，效率高的原因。</p>
<hr/>
<h3 data-id="heading-9">5. filter 在多步骤流水线中的位置非常关键</h3>
<p>它越靠前，性能越高。</p>
<p>例如：</p>
<pre><code class="hljs language-scss" lang="scss">stream<span class="hljs-selector-class">.filter</span>(...)   <span class="hljs-comment">// 过滤掉大量不需要的数据</span>
      <span class="hljs-selector-class">.map</span>(...)      <span class="hljs-comment">// 只对少量数据做 map</span>
      <span class="hljs-selector-class">.sorted</span>();     <span class="hljs-comment">// 排序的数据更少</span>
</code></pre>
<p>如果你把 filter 放在后面：</p>
<pre><code class="hljs language-scss" lang="scss">stream<span class="hljs-selector-class">.map</span>(...)
      <span class="hljs-selector-class">.sorted</span>(...)   <span class="hljs-comment">// 排序所有数据（成本高）</span>
      <span class="hljs-selector-class">.filter</span>(...);
</code></pre>
<p>性能会显著下降，因为 map、sorted 都处理了大量本该被过滤掉的元素。</p>
<hr/>
<h3 data-id="heading-10">6. 底层真正调用的是一个叫 Sink 的组件</h3>
<p>Java 会为每个中间操作创建一个 Sink，比如：</p>
<ul>
<li>FilterSink</li>
<li>MapSink</li>
<li>SortedSink</li>
</ul>
<p>FilterSink 的核心代码类似：</p>
<pre><code class="hljs language-scss" lang="scss">public void <span class="hljs-built_in">accept</span>(T element) {
    if (predicate.test(element)) {
        downstream<span class="hljs-selector-class">.accept</span>(element);
    }
}
</code></pre>
<p>解释：</p>
<ul>
<li>predicate = 你的过滤函数</li>
<li>downstream = 下一个操作（map、sorted、collect…）</li>
</ul>
<p>只要 predicate 为 true，就把元素推给下一个 Sink。否则丢弃。</p>
<hr/>
<p><strong>简单一句话总结底层执行原理：</strong></p>
<blockquote>
<p>filter 并不会修改数据，它是把 predicate 包装成一个“判断关卡”，元素在流水线经过这个关卡时被决定“留下还是丢弃”。真正执行在终止操作触发时逐元素进行。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">三、filter 的典型使用方式</h2>
<p>下面是实际开发中最常见、最有代表性的场景。</p>
<h3 data-id="heading-12">1. 过滤年龄大于 18 岁用户</h3>
<pre><code class="hljs language-ini" lang="ini">List&lt;User&gt; <span class="hljs-attr">adults</span> = users.stream()
        .filter(u -&gt; u.getAge() &gt; 18)
        .toList()<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-13">2. 过滤非空字符串</h3>
<pre><code class="hljs language-ini" lang="ini">List&lt;String&gt; <span class="hljs-attr">list</span> = strs.stream()
        .filter(s -&gt; s != null &amp;&amp; !s.isEmpty())
        .toList()<span class="hljs-comment">;</span>
</code></pre>
<p>常见写法：</p>
<pre><code class="hljs language-vbscript" lang="vbscript">.<span class="hljs-built_in">filter</span>(Objects::nonNull)
.<span class="hljs-built_in">filter</span>(s -&gt; !s.<span class="hljs-built_in">isEmpty</span>())
</code></pre>
<hr/>
<h3 data-id="heading-14">3. 过滤偶数</h3>
<pre><code class="hljs language-ini" lang="ini">List&lt;Integer&gt; <span class="hljs-attr">evens</span> = nums.stream()
        .filter(n -&gt; n % <span class="hljs-attr">2</span> == <span class="hljs-number">0</span>)
        .toList()<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-15">4. 多条件过滤（业务常见）</h3>
<pre><code class="hljs language-scss" lang="scss">List&lt;<span class="hljs-attribute">Order</span>&gt; validOrders = orders<span class="hljs-selector-class">.stream</span>()
        <span class="hljs-selector-class">.filter</span>(o -&gt; o.getStatus()<span class="hljs-selector-class">.equals</span>("PAID"))
        <span class="hljs-selector-class">.filter</span>(o -&gt; o.getAmount()<span class="hljs-selector-class">.compareTo</span>(BigDecimal.ZERO) &gt; <span class="hljs-number">0</span>)
        <span class="hljs-selector-class">.filter</span>(o -&gt; o.getCustomerName() != null)
        <span class="hljs-selector-class">.toList</span>();
</code></pre>
<p>多条件拆成多行，可读性更强。</p>
<hr/>
<h3 data-id="heading-16">5. 过滤 null 字段（实体属性过滤）</h3>
<pre><code class="hljs language-ini" lang="ini">List&lt;User&gt; <span class="hljs-attr">withPhone</span> = users.stream()
        .filter(u -&gt; u.getPhone() != null)
        .toList()<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-17">6. 按关键字过滤字符串</h3>
<pre><code class="hljs language-ini" lang="ini">List&lt;String&gt; <span class="hljs-attr">result</span> = list.stream()
        .filter(s -&gt; s.contains("Java"))
        .toList()<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-18">7. 去空、去重后的过滤</h3>
<pre><code class="hljs language-css" lang="css">List&lt;String&gt; cleaned = list<span class="hljs-selector-class">.stream</span>()
        <span class="hljs-selector-class">.filter</span>(Objects::nonNull)
        .<span class="hljs-built_in">filter</span>(s -&gt; !s.<span class="hljs-built_in">isBlank</span>())
        .<span class="hljs-built_in">distinct</span>()
        .<span class="hljs-built_in">toList</span>();
</code></pre>
<hr/>
<h3 data-id="heading-19">8. 过滤以大写字母开头的字符串</h3>
<pre><code class="hljs language-ini" lang="ini">List&lt;String&gt; <span class="hljs-attr">upper</span> = list.stream()
        .filter(s -&gt; Character.isUpperCase(s.charAt(0)))
        .toList()<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-20">9. 查询参数合法性过滤</h3>
<p>常用于后端搜索条件校验：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.filter</span>(<span class="hljs-selector-tag">p</span> -&gt; <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.getQuery</span>() != null)
<span class="hljs-selector-class">.filter</span>(<span class="hljs-selector-tag">p</span> -&gt; !<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.getQuery</span>()<span class="hljs-selector-class">.isBlank</span>())
<span class="hljs-selector-class">.filter</span>(<span class="hljs-selector-tag">p</span> -&gt; <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.getPageSize</span>() &gt; <span class="hljs-number">0</span>)
</code></pre>
<hr/>
<h2 data-id="heading-21">四、filter 的注意事项（容易踩的坑）</h2>
<h3 data-id="heading-22">❌ 1. filter 内不要写副作用（修改外部状态）</h3>
<pre><code class="hljs language-csharp" lang="csharp">.filter(u -&gt; {
    list.<span class="hljs-keyword">add</span>(u); <span class="hljs-comment">// 副作用，不推荐</span>
    <span class="hljs-keyword">return</span> u.getAge() &gt; <span class="hljs-number">18</span>;
})
</code></pre>
<p>在并行流下会产生线程安全问题，且违背函数式思想。</p>
<hr/>
<h3 data-id="heading-23">❌ 2. filter 的 predicate 不能抛 checked exception</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.filter</span>(u -&gt; <span class="hljs-built_in">doSomething</span>(u)) <span class="hljs-comment">// 如果 doSomething 抛异常，无法编译</span>
</code></pre>
<p>需要自己封装异常处理。</p>
<hr/>
<h3 data-id="heading-24">❌ 3. filter 是惰性的，不会立即过滤</h3>
<p>必须搭配终止操作：</p>
<pre><code class="hljs language-scss" lang="scss">users<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.filter</span>(...); <span class="hljs-comment">// 什么都不会执行</span>
</code></pre>
<pre><code class="hljs language-scss" lang="scss">users<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.filter</span>(...)<span class="hljs-selector-class">.toList</span>(); <span class="hljs-comment">// 真正执行过滤</span>
</code></pre>
<hr/>
<h2 data-id="heading-25">五、三句话总结</h2>
<p>✔ <strong>filter = 用 Predicate 判断哪些元素保留。</strong><br/>
✔ <strong>返回 true → 保留；返回 false → 过滤。</strong><br/>
✔ <strong>底层是遍历 + 判断，执行是惰性的。</strong></p>
<p>掌握了这三点，就彻底吃透了 <code>filter</code>。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[简单了解 with]]></title>    <link>https://juejin.cn/post/7577705544876032038</link>    <guid>https://juejin.cn/post/7577705544876032038</guid>    <pubDate>2025-11-30T09:10:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544876032038" data-draft-id="7577971299742842918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="简单了解 with"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-30T09:10:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="没落英雄"/> <meta itemprop="url" content="https://juejin.cn/user/44420757196632"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            简单了解 with
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/44420757196632/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    没落英雄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:10:56.000Z" title="Sun Nov 30 2025 09:10:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">with 语句详解：使用方法和 this 指向问题</h2>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="#with-%E8%AF%AD%E5%8F%A5%E5%9F%BA%E7%A1%80" title="#with-%E8%AF%AD%E5%8F%A5%E5%9F%BA%E7%A1%80">with 语句基础</a></li>
<li><a href="#%E4%BD%9C%E7%94%A8%E5%9F%9F%E9%93%BE%E6%9F%A5%E6%89%BE%E6%9C%BA%E5%88%B6" title="#%E4%BD%9C%E7%94%A8%E5%9F%9F%E9%93%BE%E6%9F%A5%E6%89%BE%E6%9C%BA%E5%88%B6">作用域链查找机制</a></li>
<li><a href="#this-%E6%8C%87%E5%90%91%E9%97%AE%E9%A2%98%E6%A0%B8%E5%BF%83" title="#this-%E6%8C%87%E5%90%91%E9%97%AE%E9%A2%98%E6%A0%B8%E5%BF%83">this 指向问题（核心）</a></li>
<li><a href="#window-%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%8C%87%E5%90%91" title="#window-%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%8C%87%E5%90%91">window 对象的指向</a></li>
<li><a href="#%E5%9C%A8%E5%BE%AE%E5%89%8D%E7%AB%AF%E6%B2%99%E7%AE%B1%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8" title="#%E5%9C%A8%E5%BE%AE%E5%89%8D%E7%AB%AF%E6%B2%99%E7%AE%B1%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8">在微前端沙箱中的应用</a></li>
<li><a href="#%E5%AE%9E%E9%99%85%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B" title="#%E5%AE%9E%E9%99%85%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B">实际代码示例</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%92%8C%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" title="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%92%8C%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">常见问题和注意事项</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">最佳实践</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">with 语句基础</h3>
<h4 data-id="heading-3">什么是 with 语句？</h4>
<p><code>with</code> 语句是 JavaScript 的一个特性，它可以将一个对象添加到作用域链的最前端，使得在 <code>with</code> 块内可以直接访问该对象的属性，而不需要使用对象名作为前缀。</p>
<h4 data-id="heading-4">基本语法</h4>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">with</span> (object) {
  <span class="hljs-comment">// 在这个块内，可以直接访问 object 的属性</span>
  <span class="hljs-comment">// 不需要写 object.property，直接写 property 即可</span>
}
</code></pre>
<h4 data-id="heading-5">基本示例</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
  <span class="hljs-attr">city</span>: <span class="hljs-string">"Beijing"</span>,
};

<span class="hljs-comment">// 使用 with 语句</span>
<span class="hljs-keyword">with</span> (obj) {
  <span class="hljs-comment">// 可以直接访问 obj 的属性，不需要 obj. 前缀</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name); <span class="hljs-comment">// 输出: Alice</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(age); <span class="hljs-comment">// 输出: 25</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(city); <span class="hljs-comment">// 输出: Beijing</span>

  <span class="hljs-comment">// 也可以修改属性</span>
  age = <span class="hljs-number">26</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(age); <span class="hljs-comment">// 输出: 26</span>
}

<span class="hljs-comment">// with 块外，需要正常访问</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>); <span class="hljs-comment">// 输出: 26</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">作用域链查找机制</h3>
<h4 data-id="heading-7">查找顺序</h4>
<p>在 <code>with</code> 块内，当访问一个变量时，JavaScript 引擎会按照以下顺序查找：</p>
<ol>
<li><strong>局部变量</strong>（<code>let</code>/<code>const</code>/<code>var</code> 声明的）</li>
<li><strong>with 指定的对象</strong>（<code>with(obj)</code> 中的 <code>obj</code>）</li>
<li><strong>外层作用域</strong></li>
<li><strong>全局作用域</strong></li>
</ol>
<h4 data-id="heading-8">示例：作用域链查找</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> globalVar = <span class="hljs-string">"全局变量"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">testScope</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> localVar = <span class="hljs-string">"局部变量"</span>;

  <span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">objVar</span>: <span class="hljs-string">"对象变量"</span>,
    <span class="hljs-attr">localVar</span>: <span class="hljs-string">"对象中的 localVar"</span>,
  };

  <span class="hljs-keyword">with</span> (obj) {
    <span class="hljs-comment">// 1. 查找局部变量 localVar（在函数作用域中）</span>
    <span class="hljs-comment">// 2. 如果没找到，查找 obj 中的属性</span>
    <span class="hljs-comment">// 3. 如果还没找到，查找外层作用域</span>
    <span class="hljs-comment">// 4. 最后查找全局作用域</span>

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(localVar); <span class="hljs-comment">// 输出: "局部变量"（优先使用函数作用域的）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(objVar); <span class="hljs-comment">// 输出: "对象变量"（在 obj 中找到）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar); <span class="hljs-comment">// 输出: "全局变量"（在外层作用域找到）</span>
  }
}

<span class="hljs-title function_">testScope</span>();
</code></pre>
<hr/>
<h3 data-id="heading-9">this 指向问题（核心）</h3>
<h4 data-id="heading-10">关键点：this 不受 with 语句影响</h4>
<p><strong>这是最重要的知识点！</strong> <code>this</code> 的指向完全不受 <code>with</code> 语句的影响。</p>
<h4 data-id="heading-11">this 的指向规则</h4>
<p><code>this</code> 的指向遵循 JavaScript 的标准规则：</p>
<ul>
<li><code>this</code> 指向函数调用时的上下文（caller）</li>
<li>在全局作用域中，<code>this</code> 指向全局对象（浏览器中是 <code>window</code>）</li>
<li>在对象方法中，<code>this</code> 指向调用该方法的对象</li>
<li><code>with</code> 语句<strong>不会改变</strong> <code>this</code> 的指向</li>
</ul>
<h4 data-id="heading-12">示例 1：this 在 with 块内的行为</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Context Object"</span>,
  <span class="hljs-attr">test</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"this.name:"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  },
};

<span class="hljs-keyword">const</span> sandboxContext = {
  <span class="hljs-attr">window</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"Sandbox Window"</span> },
  <span class="hljs-attr">obj</span>: obj,
};

<span class="hljs-comment">// 使用 Function 构造器创建函数（避免严格模式限制）</span>
<span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
  <span class="hljs-string">"sandboxContext"</span>,
  <span class="hljs-string">`
  with(sandboxContext) {
    // window 指向 sandboxContext.window
    console.log("window.name:", window.name); // 输出: Sandbox Window
    
    // 但是 this 仍然指向全局对象，不受 with 影响
    // 注意：这里的 window 是 sandboxContext.window（代理对象），不是全局 window
    console.log("this === window:", this === window); // 输出: false（this 是全局 window，window 是代理对象）
    console.log("this === sandboxContext.window:", this === sandboxContext.window); // 输出: false
    
    // 调用 obj.test()，this 指向 obj，不是 sandboxContext
    const result = obj.test(); // 输出: this.name: Context Object
    console.log("obj.test() 返回的 this === obj:", result === obj); // 输出: true
  }
  `</span>
);

<span class="hljs-title function_">func</span>(sandboxContext);
</code></pre>
<h4 data-id="heading-13">示例 2：对比 window 和 this</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> proxyWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-variable language_">window</span>, {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Proxy] 读取属性: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(prop)}</span>`</span>);
    <span class="hljs-keyword">return</span> target[prop];
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, prop, value</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Proxy] 设置属性: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(prop)}</span> = <span class="hljs-subst">${value}</span>`</span>);
    target[prop] = value;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },
});

<span class="hljs-keyword">const</span> sandboxContext = {
  <span class="hljs-attr">window</span>: proxyWindow,
  <span class="hljs-attr">document</span>: proxyWindow.<span class="hljs-property">document</span>,
  <span class="hljs-attr">console</span>: proxyWindow.<span class="hljs-property">console</span>,
};

<span class="hljs-keyword">const</span> code = <span class="hljs-string">`
  // 在 with 块内，window 指向 sandboxContext.window（即 proxyWindow）
  window.myVar = "hello from sandbox";
  console.log("window.myVar:", window.myVar);
  
  // this 仍然指向全局 window（不受 with 影响）
  // 注意：这里的 window 是 sandboxContext.window（代理对象），不是全局 window
  console.log("this === window:", this === window); // 输出: false（this 是全局 window，window 是代理对象）
  console.log("this === sandboxContext.window:", this === sandboxContext.window); // 输出: false
  
  // 但是代码中的 window 指向 proxyWindow
  console.log("代码中的 window === proxyWindow:", window === sandboxContext.window); // 输出: true
`</span>;

<span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
  <span class="hljs-string">"sandboxContext"</span>,
  <span class="hljs-string">`
  with(sandboxContext) {
    <span class="hljs-subst">${code}</span>
  }
  `</span>
);

<span class="hljs-title function_">func</span>(sandboxContext);
</code></pre>
<h4 data-id="heading-14">为什么 this 不受影响？</h4>
<p><code>this</code> 是 JavaScript 的一个特殊关键字，它的值在函数调用时确定，与作用域链无关。<code>with</code> 语句只影响作用域链的查找，不会影响 <code>this</code> 的绑定。</p>
<h4 data-id="heading-15">重要区别：window 和 this 在 with 块内</h4>
<p>在 <code>with(sandboxContext)</code> 块内，需要理解以下关键区别：</p>
<ol>
<li>
<p><strong><code>window</code> 的指向</strong>：</p>
<ul>
<li><code>window</code> 会指向 <code>sandboxContext.window</code>（代理对象）</li>
<li>这是通过作用域链查找实现的</li>
</ul>
</li>
<li>
<p><strong><code>this</code> 的指向</strong>：</p>
<ul>
<li><code>this</code> 仍然指向全局对象（不受 <code>with</code> 影响）</li>
<li>这是 JavaScript 的 <code>this</code> 绑定机制决定的</li>
</ul>
</li>
<li>
<p><strong>因此</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">with</span> (sandboxContext) {
  <span class="hljs-comment">// window 是 sandboxContext.window（代理对象）</span>
  <span class="hljs-comment">// this 是全局 window</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span> === <span class="hljs-variable language_">window</span>); <span class="hljs-comment">// false（它们不相等！）</span>
}
</code></pre>
</li>
</ol>
<p><strong>关键理解</strong>：</p>
<ul>
<li><code>window</code> 标识符通过作用域链查找，在 <code>sandboxContext</code> 中找到，所以指向代理对象</li>
<li><code>this</code> 关键字不受作用域链影响，仍然指向全局对象</li>
<li>这就是为什么在微前端沙箱中，代码里的 <code>window</code> 可以指向代理对象，但 <code>this</code> 仍然指向全局对象</li>
</ul>
<hr/>
<h3 data-id="heading-16">window 对象的指向</h3>
<h4 data-id="heading-17">关键机制</h4>
<p>在微前端沙箱实现中，<code>with</code> 语句的核心作用是<strong>替换 <code>window</code> 对象的引用</strong>。</p>
<h4 data-id="heading-18">为什么不能直接用 <code>with(proxyWindow)</code>？</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误的方式</span>
<span class="hljs-keyword">const</span> proxyWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-variable language_">window</span>, {
  <span class="hljs-comment">/* ... */</span>
});
<span class="hljs-keyword">with</span> (proxyWindow) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">myVar</span> = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">// window 会去外层作用域查找，找到全局 window</span>
}
</code></pre>
<p><strong>问题</strong>：如果直接使用 <code>with(proxyWindow)</code>，代码中的 <code>window</code> 标识符会去外层作用域查找，找到全局的 <code>window</code> 对象，而不是 <code>proxyWindow</code>。</p>
<h4 data-id="heading-19">正确的做法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确的方式</span>
<span class="hljs-keyword">const</span> proxyWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-variable language_">window</span>, {
  <span class="hljs-comment">/* ... */</span>
});

<span class="hljs-comment">// 创建一个包含 window 属性的上下文对象</span>
<span class="hljs-keyword">const</span> sandboxContext = {
  <span class="hljs-attr">window</span>: proxyWindow, <span class="hljs-comment">// 关键：将 proxyWindow 作为 window 属性</span>
  <span class="hljs-attr">document</span>: proxyWindow.<span class="hljs-property">document</span>,
  <span class="hljs-attr">console</span>: proxyWindow.<span class="hljs-property">console</span>,
};

<span class="hljs-keyword">with</span> (sandboxContext) {
  <span class="hljs-comment">// 现在 window 会在 sandboxContext 中查找</span>
  <span class="hljs-comment">// 找到 sandboxContext.window（即 proxyWindow）</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">myVar</span> = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">// 实际访问的是 proxyWindow.myVar</span>
}
</code></pre>
<h4 data-id="heading-20">执行流程</h4>
<pre><code class="hljs language-ts" lang="ts">子应用代码: <span class="hljs-variable language_">window</span>.<span class="hljs-property">myVar</span> = <span class="hljs-string">'hello'</span>
       ↓
sandboxContext = { <span class="hljs-attr">window</span>: proxyWindow }
<span class="hljs-title function_">with</span>(<span class="hljs-params">sandboxContext</span>) { <span class="hljs-variable language_">window</span>.<span class="hljs-property">myVar</span> = <span class="hljs-string">'hello'</span> }
       ↓
代码中的 <span class="hljs-variable language_">window</span> 在 sandboxContext 中查找
找到 sandboxContext.<span class="hljs-property">window</span>（即代理对象 proxyWindow）
       ↓
访问 proxyWindow.<span class="hljs-property">myVar</span>，触发 <span class="hljs-title class_">Proxy</span> 的 set 拦截器
       ↓
值被写入 fakeWindow.<span class="hljs-property">myVar</span>，而不是真实的 <span class="hljs-variable language_">window</span>
</code></pre>
<hr/>
<h3 data-id="heading-21">在微前端沙箱中的应用</h3>
<h4 data-id="heading-22">完整的沙箱实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowProxySandbox</span> {
  private <span class="hljs-attr">proxy</span>: <span class="hljs-title class_">Window</span>;
  private <span class="hljs-attr">fakeWindow</span>: <span class="hljs-title class_">Record</span>&lt;string, any&gt; = {};
  private updatedValueSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;string&gt;();

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fakeWindow</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-variable language_">window</span>, {
      <span class="hljs-attr">get</span>: <span class="hljs-function">(<span class="hljs-params">_target: Window, prop: string</span>) =&gt;</span> {
        <span class="hljs-comment">// 如果属性在 fakeWindow 中存在，优先返回 fakeWindow 的值</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">updatedValueSet</span>.<span class="hljs-title function_">has</span>(prop)) {
          <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fakeWindow</span>[prop];
        }
        <span class="hljs-comment">// 否则返回原始 window 的值</span>
        <span class="hljs-keyword">return</span> (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any)[prop];
      },

      <span class="hljs-attr">set</span>: <span class="hljs-function">(<span class="hljs-params">_target: Window, prop: string, value: any</span>) =&gt;</span> {
        <span class="hljs-comment">// 所有修改都记录到 fakeWindow 中</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">fakeWindow</span>[prop] = value;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">updatedValueSet</span>.<span class="hljs-title function_">add</span>(prop);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      },

      <span class="hljs-attr">has</span>: <span class="hljs-function">(<span class="hljs-params">_target: Window, prop: string</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> prop <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fakeWindow</span> || prop <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>;
      },

      <span class="hljs-attr">deleteProperty</span>: <span class="hljs-function">(<span class="hljs-params">_target: Window, prop: string</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">updatedValueSet</span>.<span class="hljs-title function_">has</span>(prop)) {
          <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fakeWindow</span>[prop];
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">updatedValueSet</span>.<span class="hljs-title function_">delete</span>(prop);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      },

      <span class="hljs-attr">ownKeys</span>: <span class="hljs-function">(<span class="hljs-params">_target: Window</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> originalKeys = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(<span class="hljs-variable language_">window</span>);
        <span class="hljs-keyword">const</span> fakeKeys = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fakeWindow</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([...originalKeys, ...fakeKeys]));
      },
    });
  }

  <span class="hljs-comment">/**
   * 执行子应用代码（推荐方式）
   */</span>
  <span class="hljs-title function_">execScriptWith</span>(<span class="hljs-attr">script</span>: string): any {
    <span class="hljs-comment">// 创建沙箱上下文，将代理 window 作为属性</span>
    <span class="hljs-keyword">const</span> sandboxContext = {
      <span class="hljs-attr">window</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span>,
      <span class="hljs-attr">document</span>: (<span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">document</span>,
      <span class="hljs-attr">location</span>: (<span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">location</span>,
      <span class="hljs-attr">console</span>: (<span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">console</span>,
    };

    <span class="hljs-comment">// 使用 Function 构造器创建函数</span>
    <span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
      <span class="hljs-string">"sandboxContext"</span>,
      <span class="hljs-string">`
      with(sandboxContext) {
        <span class="hljs-subst">${script}</span>
      }
    `</span>
    );

    <span class="hljs-comment">// 执行函数，传入 sandboxContext</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">func</span>(sandboxContext);
  }

  <span class="hljs-title function_">getProxy</span>(): <span class="hljs-title class_">Window</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span>;
  }
}
</code></pre>
<h4 data-id="heading-23">使用示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> sandbox = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowProxySandbox</span>();

<span class="hljs-comment">// 子应用的代码（模拟从远程加载的代码）</span>
<span class="hljs-keyword">const</span> appCode = <span class="hljs-string">`
  // 子应用代码中直接使用 window，不需要任何修改
  window.myApp = 'sub-app-proxy';
  window.myConfig = { version: '1.0.0', env: 'production' };
  
  // 访问 window 的其他属性也会被代理
  console.log('window.location:', window.location);
  
  // 设置全局变量
  window.globalVar = 'hello from sub app';
`</span>;

<span class="hljs-comment">// 执行子应用代码</span>
sandbox.<span class="hljs-title function_">execScriptWith</span>(appCode);

<span class="hljs-comment">// 验证隔离性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"代理 window.myApp:"</span>, sandbox.<span class="hljs-title function_">getProxy</span>().<span class="hljs-property">myApp</span>); <span class="hljs-comment">// 输出: sub-app-proxy</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"真实 window.myApp:"</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">myApp</span>); <span class="hljs-comment">// 输出: undefined（未被污染）</span>
</code></pre>
<hr/>
<h3 data-id="heading-24">实际代码示例</h3>
<h4 data-id="heading-25">示例 1：基本 with 使用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">example1_BasicWith</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
    <span class="hljs-attr">city</span>: <span class="hljs-string">"Beijing"</span>,
  };

  <span class="hljs-comment">// 使用 Function 构造器（避免严格模式限制）</span>
  <span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
    <span class="hljs-string">"obj"</span>,
    <span class="hljs-string">`
    with(obj) {
      // 在 with 块内，可以直接访问 obj 的属性
      console.log("name:", name);        // 输出: Alice
      console.log("age:", age);          // 输出: 25
      console.log("city:", city);        // 输出: Beijing
      
      // 也可以修改属性
      age = 26;
      console.log("修改后的 age:", age); // 输出: 26
    }
    
    // with 块外，需要正常访问
    console.log("with 块外访问:", obj.age); // 输出: 26
  `</span>
  );

  <span class="hljs-title function_">func</span>(obj);
}
</code></pre>
<h4 data-id="heading-26">示例 2：this 指向演示</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">example2_ThisBinding</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"Context Object"</span>,
    <span class="hljs-attr">test</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"this.name:"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    },
  };

  <span class="hljs-keyword">const</span> sandboxContext = {
    <span class="hljs-attr">window</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"Sandbox Window"</span> },
    <span class="hljs-attr">obj</span>: obj,
  };

  <span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
    <span class="hljs-string">"sandboxContext"</span>,
    <span class="hljs-string">`
    with(sandboxContext) {
      // window 指向 sandboxContext.window
      console.log("window.name:", window.name); // 输出: Sandbox Window
      
      // 但是 this 仍然指向全局对象，不受 with 影响
      // 注意：这里的 window 是 sandboxContext.window（代理对象），不是全局 window
      console.log("this === window:", this === window); // 输出: false（this 是全局 window，window 是代理对象）
      console.log("this === sandboxContext.window:", this === sandboxContext.window); // 输出: false
      
      // 调用 obj.test()，this 指向 obj，不是 sandboxContext
      const result = obj.test(); // 输出: this.name: Context Object
      console.log("obj.test() 返回的 this === obj:", result === obj); // 输出: true
    }
  `</span>
  );

  <span class="hljs-title function_">func</span>(sandboxContext);
}
</code></pre>
<h4 data-id="heading-27">示例 3：微前端沙箱应用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">example3_MicroFrontendSandbox</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 创建代理 window</span>
  <span class="hljs-keyword">const</span> proxyWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-variable language_">window</span>, {
    <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Proxy] 读取属性: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(prop)}</span>`</span>);
      <span class="hljs-keyword">return</span> target[prop];
    },
    <span class="hljs-title function_">set</span>(<span class="hljs-params">target, prop, value</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Proxy] 设置属性: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(prop)}</span> = <span class="hljs-subst">${value}</span>`</span>);
      target[prop] = value;
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    },
  });

  <span class="hljs-keyword">const</span> sandboxContext = {
    <span class="hljs-attr">window</span>: proxyWindow,
    <span class="hljs-attr">document</span>: proxyWindow.<span class="hljs-property">document</span>,
    <span class="hljs-attr">console</span>: proxyWindow.<span class="hljs-property">console</span>,
  };

  <span class="hljs-keyword">const</span> code = <span class="hljs-string">`
    // 在 with 块内，window 指向 sandboxContext.window（即 proxyWindow）
    window.myVar = "hello from sandbox";
    console.log("window.myVar:", window.myVar);
    
    // this 仍然指向全局 window（不受 with 影响）
    // 注意：这里的 window 是 sandboxContext.window（代理对象），不是全局 window
    console.log("this === window:", this === window); // 输出: false（this 是全局 window，window 是代理对象）
    console.log("this === sandboxContext.window:", this === sandboxContext.window); // 输出: false
    
    // 但是代码中的 window 指向 proxyWindow
    console.log("代码中的 window === proxyWindow:", window === sandboxContext.window); // 输出: true
  `</span>;

  <span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
    <span class="hljs-string">"sandboxContext"</span>,
    <span class="hljs-string">`
    with(sandboxContext) {
      <span class="hljs-subst">${code}</span>
    }
  `</span>
  );

  <span class="hljs-title function_">func</span>(sandboxContext);

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n验证结果:"</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"proxyWindow.myVar:"</span>, proxyWindow.<span class="hljs-property">myVar</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"真实 window.myVar:"</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">myVar</span>);
}
</code></pre>
<h4 data-id="heading-28">示例 4：with 内外对比</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">example4_CompareInsideAndOutside</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> sandboxContext = {
    <span class="hljs-attr">window</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"Proxy Window"</span>, <span class="hljs-attr">myVar</span>: <span class="hljs-string">"sandbox value"</span> },
    <span class="hljs-attr">globalVar</span>: <span class="hljs-string">"I'm in sandbox"</span>,
  };

  <span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
    <span class="hljs-string">"sandboxContext"</span>,
    <span class="hljs-string">`
    // with 块外
    console.log("=== with 块外 ===");
    console.log("window:", typeof window); // 输出: object（全局 window）
    console.log("globalVar:", typeof globalVar); // 输出: undefined（未定义）
    
    // with 块内
    with(sandboxContext) {
      console.log("=== with 块内 ===");
      // window 现在指向 sandboxContext.window
      console.log("window.name:", window.name); // 输出: Proxy Window
      console.log("window.myVar:", window.myVar); // 输出: sandbox value
      
      // globalVar 现在指向 sandboxContext.globalVar
      console.log("globalVar:", globalVar); // 输出: I'm in sandbox
      
      // this 仍然指向全局对象（不受 with 影响）
      // 注意：这里的 window 是 sandboxContext.window（代理对象），不是全局 window
      console.log("this === window:", this === window); // 输出: false（this 是全局 window，window 是代理对象）
      console.log("this === sandboxContext.window:", this === sandboxContext.window); // 输出: false
    }
    
    // with 块外，恢复原状
    console.log("=== with 块外（恢复）===");
    console.log("window:", typeof window); // 输出: object（全局 window）
    console.log("globalVar:", typeof globalVar); // 输出: undefined
  `</span>
  );

  <span class="hljs-title function_">func</span>(sandboxContext);
}
</code></pre>
<hr/>
<h3 data-id="heading-29">常见问题和注意事项</h3>
<h4 data-id="heading-30">1. 严格模式限制</h4>
<p><strong>问题</strong>：<code>with</code> 语句在严格模式下不能直接使用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">"use strict"</span>;
<span class="hljs-keyword">with</span> (obj) {
  <span class="hljs-comment">// ❌ SyntaxError: Strict mode code may not include a with statement</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>解决方案</strong>：使用 <code>Function</code> 构造器动态创建函数（不在严格模式下执行）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确的方式</span>
<span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
  <span class="hljs-string">"sandboxContext"</span>,
  <span class="hljs-string">`
  with(sandboxContext) {
    // 代码在这里执行
  }
  `</span>
);
</code></pre>
<h4 data-id="heading-31">2. 性能考虑</h4>
<p><code>with</code> 语句会影响 JavaScript 引擎的优化，因为引擎无法在编译时确定变量的作用域。但在微前端沙箱场景中，这是必要的权衡。</p>
<h4 data-id="heading-32">3. 调试困难</h4>
<p>使用 <code>with</code> 语句会让代码调试变得困难，因为变量的实际来源不明确。建议：</p>
<ul>
<li>添加详细的日志</li>
<li>使用清晰的变量命名</li>
<li>在开发环境中禁用 <code>with</code>，使用其他方式</li>
</ul>
<h4 data-id="heading-33">4. 作用域污染</h4>
<p><code>with</code> 语句会将对象的所有属性添加到作用域链中，可能导致意外的变量覆盖。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">console</span>: <span class="hljs-string">"这不是 console 对象"</span>,
  <span class="hljs-attr">log</span>: <span class="hljs-string">"这也不是 log 方法"</span>,
};

<span class="hljs-keyword">with</span> (obj) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"这可能会出错！"</span>); <span class="hljs-comment">// ❌ 因为 console 被覆盖了</span>
}
</code></pre>
<p><strong>解决方案</strong>：只将必要的属性添加到 <code>sandboxContext</code> 中。</p>
<hr/>
<h3 data-id="heading-34">最佳实践</h3>
<h4 data-id="heading-35">1. 始终使用 sandboxContext 对象</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误：不要直接用 with(proxyWindow)</span>
<span class="hljs-keyword">with</span> (proxyWindow) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">myVar</span> = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">// window 会去外层作用域查找</span>
}

<span class="hljs-comment">// ✅ 正确：使用 sandboxContext 对象</span>
<span class="hljs-keyword">const</span> sandboxContext = {
  <span class="hljs-attr">window</span>: proxyWindow,
  <span class="hljs-attr">document</span>: proxyWindow.<span class="hljs-property">document</span>,
  <span class="hljs-attr">console</span>: proxyWindow.<span class="hljs-property">console</span>,
};

<span class="hljs-keyword">with</span> (sandboxContext) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">myVar</span> = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">// window 指向 sandboxContext.window</span>
}
</code></pre>
<h4 data-id="heading-36">2. 处理全局对象</h4>
<p>除了 <code>window</code>，还要处理其他全局对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> sandboxContext = {
  <span class="hljs-attr">window</span>: proxyWindow,
  <span class="hljs-attr">document</span>: proxyWindow.<span class="hljs-property">document</span>,
  <span class="hljs-attr">location</span>: proxyWindow.<span class="hljs-property">location</span>,
  <span class="hljs-attr">console</span>: proxyWindow.<span class="hljs-property">console</span>,
  <span class="hljs-comment">// 根据需要添加其他全局对象</span>
};
</code></pre>
<h4 data-id="heading-37">3. 错误处理</h4>
<p>子应用代码执行可能出错，需要添加错误处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span> {
  sandbox.<span class="hljs-title function_">execScriptWith</span>(appCode);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"执行子应用代码时出错:"</span>, error);
  <span class="hljs-comment">// 记录错误日志，便于调试</span>
}
</code></pre>
<h4 data-id="heading-38">4. 性能优化</h4>
<ul>
<li>避免频繁创建和销毁沙箱</li>
<li>缓存常用的全局对象引用</li>
<li>只在必要时使用 <code>with</code> 语句</li>
</ul>
<h4 data-id="heading-39">5. 兼容性考虑</h4>
<ul>
<li>检查浏览器是否支持 <code>Proxy</code>（现代浏览器都支持）</li>
<li>不支持时降级到快照沙箱（SnapshotSandbox）</li>
</ul>
<h4 data-id="heading-40">6. 安全性</h4>
<ul>
<li>只加载可信的子应用代码</li>
<li>限制子应用访问某些敏感 API</li>
<li>使用 CSP（Content Security Policy）限制代码执行</li>
</ul>
<hr/>
<h3 data-id="heading-41">总结</h3>
<h4 data-id="heading-42">核心要点</h4>
<ol>
<li>
<p><strong>with 语句的作用</strong>：</p>
<ul>
<li>将对象添加到作用域链的最前端</li>
<li>在 <code>with</code> 块内可以直接访问对象的属性</li>
</ul>
</li>
<li>
<p><strong>this 的指向（最重要）</strong>：</p>
<ul>
<li><code>this</code> <strong>不受</strong> <code>with</code> 语句影响</li>
<li><code>this</code> 始终指向函数调用时的上下文</li>
<li>在 <code>with</code> 块内，<code>this</code> 仍然指向原来的对象（通常是全局对象）</li>
</ul>
</li>
<li>
<p><strong>window 的指向</strong>：</p>
<ul>
<li>不能直接用 <code>with(proxyWindow)</code></li>
<li>应该用 <code>sandboxContext = { window: proxyWindow }</code> 然后 <code>with(sandboxContext)</code></li>
<li>这样代码中的 <code>window</code> 会指向 <code>sandboxContext.window</code>（即代理对象）</li>
</ul>
</li>
<li>
<p><strong>作用域链查找顺序</strong>：</p>
<ul>
<li>局部变量 → <code>with</code> 指定的对象 → 外层作用域 → 全局作用域</li>
</ul>
</li>
<li>
<p><strong>实际应用</strong>：</p>
<ul>
<li>微前端沙箱实现的核心机制</li>
<li>通过 <code>with</code> 语句替换 <code>window</code> 引用</li>
<li>结合 <code>Proxy</code> 实现完全隔离</li>
</ul>
</li>
</ol>
<h4 data-id="heading-43">关键代码模式</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建代理 window</span>
<span class="hljs-keyword">const</span> proxyWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-variable language_">window</span>, {
  <span class="hljs-comment">/* ... */</span>
});

<span class="hljs-comment">// 2. 创建沙箱上下文</span>
<span class="hljs-keyword">const</span> sandboxContext = {
  <span class="hljs-attr">window</span>: proxyWindow,
  <span class="hljs-attr">document</span>: proxyWindow.<span class="hljs-property">document</span>,
  <span class="hljs-comment">// ... 其他全局对象</span>
};

<span class="hljs-comment">// 3. 使用 with 语句执行代码</span>
<span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
  <span class="hljs-string">"sandboxContext"</span>,
  <span class="hljs-string">`
  with(sandboxContext) {
    <span class="hljs-subst">${appCode}</span>
  }
  `</span>
);

<span class="hljs-title function_">func</span>(sandboxContext);
</code></pre>
<hr/>
<h3 data-id="heading-44">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FStatements%2Fwith" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/with" ref="nofollow noopener noreferrer">MDN: with 语句</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FOperators%2Fthis" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/this" ref="nofollow noopener noreferrer">MDN: this 关键字</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FProxy" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy" ref="nofollow noopener noreferrer">MDN: Proxy</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fumijs%2Fqiankun" target="_blank" title="https://github.com/umijs/qiankun" ref="nofollow noopener noreferrer">qiankun 源码</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【收藏级】Java Stream.reduce 全面解析：从零到通透（原理图 + 实战 + 最佳实践）]]></title>    <link>https://juejin.cn/post/7577683422879088674</link>    <guid>https://juejin.cn/post/7577683422879088674</guid>    <pubDate>2025-11-30T09:33:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577683422879088674" data-draft-id="7577713754564116532" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【收藏级】Java Stream.reduce 全面解析：从零到通透（原理图 + 实战 + 最佳实践）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T09:33:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木木一直在哭泣"/> <meta itemprop="url" content="https://juejin.cn/user/3896324937225085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【收藏级】Java Stream.reduce 全面解析：从零到通透（原理图 + 实战 + 最佳实践）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3896324937225085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木木一直在哭泣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:33:39.000Z" title="Sun Nov 30 2025 09:33:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>想真正学懂 Java Stream，绕不过 <code>reduce</code>。</p>
<p>但现实情况是——绝大多数文章只告诉你：</p>
<blockquote>
<p>reduce 就是“求和、求最大最小”的。</p>
</blockquote>
<p>其实它远远不止这些。</p>
<p><code>reduce</code> 是整个 Stream 体系里<strong>最接近函数式编程灵魂的 API</strong>，也是写优雅聚合逻辑的关键。</p>
<p>这篇文章我会带你：</p>
<ul>
<li>从函数定义弄懂为什么 reduce 要三个参数</li>
<li>通过图解理解 reduce 的折叠原理</li>
<li>串行流 &amp; 并行流真实执行路径</li>
<li>各种实战场景（比 "求和" 有用得多）</li>
<li>常见错误写法（你一定踩过）</li>
<li>最佳实践总结（实际开发最推荐的写法）</li>
</ul>
<p>保证你看完以后，彻底掌握 reduce。</p>
<hr/>
<h2 data-id="heading-0">一、reduce 是什么？一句话理解</h2>
<blockquote>
<p><strong>reduce = 把一堆元素，通过某种规则，折叠成一个值。</strong></p>
</blockquote>
<p>这个“值”可以是：</p>
<ul>
<li>数字</li>
<li>字符串</li>
<li>对象</li>
<li>Map</li>
<li>统计结构</li>
<li>甚至你自定义的任意类型</li>
</ul>
<p>它的本质是数学中的 Fold（折叠）。</p>
<hr/>
<h2 data-id="heading-1">二、reduce 的三个函数定义（最关键的一节）</h2>
<p>Java 提供了 3 种 reduce：</p>
<h3 data-id="heading-2"><strong>① <code>T reduce(T identity, BinaryOperator&lt;T&gt; accumulator)</code></strong></h3>
<p>最常见的版本，带初始值：</p>
<pre><code class="hljs language-css" lang="css">int sum = list<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.reduce</span>(<span class="hljs-number">0</span>, (<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>) -&gt; <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>);
</code></pre>
<p>参数含义：</p>
<ul>
<li><code>identity</code>：初始值（种子）</li>
<li><code>accumulator</code>：折叠规则，将“之前的结果 + 当前元素”合并</li>
</ul>
<p>流程类似：</p>
<pre><code class="hljs language-scss" lang="scss">(((identity ⊕ e1) ⊕ e2) ⊕ e3 ...) ⊕ en
</code></pre>
<hr/>
<h3 data-id="heading-3"><strong>② <code>Optional&lt;T&gt; reduce(BinaryOperator&lt;T&gt; accumulator)</code></strong></h3>
<p>没有 identity，因此 Stream 可能为空 → 返回 Optional。</p>
<p>第一次参与折叠的是前两个元素。</p>
<pre><code class="hljs language-ini" lang="ini">Optional&lt;Integer&gt; <span class="hljs-attr">max</span> = list.stream().reduce(Integer::max)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-4"><strong>③ <code>U reduce(U identity, BiFunction&lt;U, T, U&gt; accumulator, BinaryOperator&lt;U&gt; combiner)</code></strong></h3>
<p>最完整的 reduce，专为 <strong>并行流（parallelStream）</strong> 设计。</p>
<p>参数含义：</p>
<ul>
<li>identity：每个线程分片的初始值</li>
<li>accumulator：分片内部如何折叠</li>
<li>combiner：多个分片结果如何合并</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">int</span> totalLen = <span class="hljs-built_in">list</span>.parallelStream().reduce(
    <span class="hljs-number">0</span>,
    (<span class="hljs-built_in">len</span>, s) -&gt; <span class="hljs-built_in">len</span> + s.length(),
    Integer::<span class="hljs-built_in">sum</span>
);
</code></pre>
<p>这是理解 reduce 真正的关键点。</p>
<hr/>
<h2 data-id="heading-5">三、reduce 的底层原理（图解版）</h2>
<p><code>reduce</code> 的底层思想就是 <strong>折叠（Fold）</strong> 。</p>
<hr/>
<h3 data-id="heading-6">1. 串行 reduce 的完整执行图</h3>
<p>假设 Stream：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">3, 5, 2</span>]
</code></pre>
<p>identity：<code>0</code><br/>
accumulator：<code>(a, b) -&gt; a + b</code></p>
<h4 data-id="heading-7">执行流程图：</h4>
<pre><code class="hljs language-scss" lang="scss">   identity
       │
       ▼
   <span class="hljs-built_in">acc</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>) = <span class="hljs-number">3</span>
       │
       ▼
   <span class="hljs-built_in">acc</span>(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>) = <span class="hljs-number">8</span>
       │
       ▼
   <span class="hljs-built_in">acc</span>(<span class="hljs-number">8</span>, <span class="hljs-number">2</span>) = <span class="hljs-number">10</span>
       │
       ▼
     最终结果：<span class="hljs-number">10</span>
</code></pre>
<p>你可以理解为：</p>
<blockquote>
<p>结果不是突然产生的，而是一路“折叠、折叠、再折叠”。</p>
</blockquote>
<p>这也是 reduce 名字的含义：<strong>归约 / 折叠</strong>。</p>
<hr/>
<h3 data-id="heading-8">2. 串行流的“单条流水线”结构</h3>
<p>Stream 底层会为 reduce 构建出一个处理链：</p>
<pre><code class="hljs language-python" lang="python">数据源 → <span class="hljs-built_in">map</span>/<span class="hljs-built_in">filter</span>/... → reduce
</code></pre>
<p>每个元素会沿着流水线依次通过所有中间操作，最后进入 reduce 折叠。</p>
<p>图示：</p>
<pre><code class="hljs language-python" lang="python">元素<span class="hljs-number">1</span> → <span class="hljs-built_in">filter</span> → <span class="hljs-built_in">map</span> → reduce
元素<span class="hljs-number">2</span> → <span class="hljs-built_in">filter</span> → <span class="hljs-built_in">map</span> → reduce
元素<span class="hljs-number">3</span> → <span class="hljs-built_in">filter</span> → <span class="hljs-built_in">map</span> → reduce
...
</code></pre>
<p>reduce 是<strong>整个流水线的最后一步</strong>，负责把所有处理过的元素折叠成一个值。</p>
<hr/>
<h3 data-id="heading-9">3. 并行 reduce 的执行图</h3>
<p>假设输入流：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">1,2,3,4,5,6</span>]
</code></pre>
<p>parallelStream 会把它拆成多个分片（线程并行处理）：</p>
<pre><code class="hljs">分片1：1, 2
分片2：3, 4
分片3：5, 6
</code></pre>
<p>每个分片独立执行 accumulator：</p>
<pre><code class="hljs language-scss" lang="scss">分片<span class="hljs-number">1</span>：<span class="hljs-built_in">acc</span>(acc(identity,<span class="hljs-number">1</span>),<span class="hljs-number">2</span>) → r1
分片<span class="hljs-number">2</span>：<span class="hljs-built_in">acc</span>(acc(identity,<span class="hljs-number">3</span>),<span class="hljs-number">4</span>) → r2
分片<span class="hljs-number">3</span>：<span class="hljs-built_in">acc</span>(acc(identity,<span class="hljs-number">5</span>),<span class="hljs-number">6</span>) → r3
</code></pre>
<p>得到三个局部结果后，使用 combiner 进行最终归并：</p>
<pre><code class="hljs language-scss" lang="scss">         r1
          │
          ▼
 <span class="hljs-built_in">combiner</span>(r1, r2) → r12
          │
          ▼
 <span class="hljs-built_in">combiner</span>(r12, r3) → finalResult
</code></pre>
<p>完整 ASCII 图如下：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">          ┌────────────┐
元素 1,2  →│  分片1线程  │→ r1
          └────────────┘
          ┌────────────┐
元素 3,4  →│  分片2线程  │→ r2
          └────────────┘
          ┌────────────┐
元素 5,6  →│  分片3线程  │→ r3
          └────────────┘
</span>
<span class="hljs-code">      ┌────────── combiner ───────────┐
      ▼                                ▼
    r1,r2 → combiner(r1,r2) → r12  +   r3
      ▼                                ▼
      └──────────→ final ─────────────┘
</span></code></pre>
<p>并行 reduce 的关键是：</p>
<h4 data-id="heading-10">⚠ identity 在每个线程都会用到一次！</h4>
<p>这是很多人踩坑的地方，例如：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">parallelStream</span>()<span class="hljs-selector-class">.reduce</span>(<span class="hljs-number">10</span>, Integer::sum);
</code></pre>
<p>10 会被加 <strong>多次</strong>，导致结果错误。</p>
<hr/>
<h3 data-id="heading-11">4. reduce 的执行本质图（核心记忆版）</h3>
<p>把 reduce 的过程浓缩成一个图：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">identity</span> ──► acc ──► acc ──► acc ──► ... ──► <span class="hljs-keyword">final</span>
                ▲        ▲        ▲
              元素<span class="hljs-number">1</span>    元素<span class="hljs-number">2</span>    元素<span class="hljs-number">3</span>
</code></pre>
<p>只需要记住：</p>
<blockquote>
<p>reduce 从 identity 开始，每遇到一个元素，就调用一次 accumulator，把它“折叠”进去。</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">四、为什么 reduce 可以完成复杂聚合（原理图解释）</h2>
<p>reduce 并不限制返回类型。只要 accumulator 返回同一个类型，你就能折叠：</p>
<ul>
<li>数字</li>
<li>字符串</li>
<li>List</li>
<li>Map</li>
<li>自定义对象（统计对象）</li>
</ul>
<p>构建统计对象的执行图：</p>
<p>假设有：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">users</span> = [u1, u2, u3]
<span class="hljs-attr">identity</span> = 空统计对象
</code></pre>
<p>进行聚合：</p>
<pre><code class="hljs language-scss" lang="scss">stat0  <span class="hljs-attr">--acc</span>(u1)--&gt; stat1
stat1  <span class="hljs-attr">--acc</span>(u2)--&gt; stat2
stat2  <span class="hljs-attr">--acc</span>(u3)--&gt; stat3
</code></pre>
<p>图示：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">stat</span>(identity)
   │
   ▼
<span class="hljs-built_in">acc</span>(stat,u1)
   │
   ▼
<span class="hljs-built_in">acc</span>(stat,u2)
   │
   ▼
<span class="hljs-built_in">acc</span>(stat,u3)
   │
   ▼
最终统计结构
</code></pre>
<p>这就是为什么 reduce 是聚合类操作的核心。</p>
<hr/>
<h2 data-id="heading-13">四、并行流（parallelStream）时 reduce 的真实运行方式</h2>
<p>假设流是：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">1,2,3,4,5,6</span>]
</code></pre>
<p>parallelStream 会切成多个分片（线程 A/B/C…）：</p>
<pre><code class="hljs language-css" lang="css">线程<span class="hljs-selector-tag">A</span>：<span class="hljs-number">1</span>,<span class="hljs-number">2</span>
线程<span class="hljs-selector-tag">B</span>：<span class="hljs-number">3</span>,<span class="hljs-number">4</span>
线程C：<span class="hljs-number">5</span>,<span class="hljs-number">6</span>
</code></pre>
<p>每个线程独立执行 accumulator：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-tag">A</span> → <span class="hljs-built_in">acc</span>(acc(identity,<span class="hljs-number">1</span>),<span class="hljs-number">2</span>)
<span class="hljs-selector-tag">B</span> → <span class="hljs-built_in">acc</span>(acc(identity,<span class="hljs-number">3</span>),<span class="hljs-number">4</span>)
C → <span class="hljs-built_in">acc</span>(acc(identity,<span class="hljs-number">5</span>),<span class="hljs-number">6</span>)
</code></pre>
<p>得到局部结果：</p>
<pre><code class="hljs">ra, rb, rc
</code></pre>
<p>然后 combiner 负责把它们合并：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">final</span> = combiner( combiner(ra, rb), rc )
</code></pre>
<p>因此：</p>
<p>⚠ <strong>identity 会被每个线程使用一次，而不是只用一次！</strong></p>
<p>例如：</p>
<pre><code class="hljs language-css" lang="css">parallelStream()<span class="hljs-selector-class">.reduce</span>(<span class="hljs-number">10</span>, (<span class="hljs-selector-tag">a</span>,<span class="hljs-selector-tag">b</span>)-&gt;<span class="hljs-selector-tag">a</span>+<span class="hljs-selector-tag">b</span>)
</code></pre>
<p>10 会被多次加进去 → 结果错误。</p>
<p>这是 reduce 最常见的坑。</p>
<hr/>
<h2 data-id="heading-14">五、reduce 的最强 8 大实战场景</h2>
<p>下面这些才是实际项目中真正有用的 reduce 用法，不是教科书级别的求和实例。</p>
<h3 data-id="heading-15">1. 求和（教科书但最常用）</h3>
<pre><code class="hljs language-ini" lang="ini">int <span class="hljs-attr">sum</span> = list.stream().reduce(<span class="hljs-number">0</span>, Integer::sum)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-16">2. 求最大值 / 最小值</h3>
<pre><code class="hljs language-ini" lang="ini">Optional&lt;Integer&gt; <span class="hljs-attr">max</span> = list.stream().reduce(Integer::max)<span class="hljs-comment">;</span>
Optional&lt;Integer&gt; <span class="hljs-attr">min</span> = list.stream().reduce(Integer::min)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-17">3. 统计字符串总长度</h3>
<pre><code class="hljs language-ini" lang="ini">int <span class="hljs-attr">len</span> = list.stream().reduce(
    0,
    (acc, s) -&gt; acc + s.length(),
    Integer::sum
)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-18">4. 构建统计对象（超常用）</h3>
<p>比如统计用户年龄总和与数量：</p>
<pre><code class="hljs language-ini" lang="ini">class Stat {
    int totalAge<span class="hljs-comment">;</span>
    int count<span class="hljs-comment">;</span>
}

Stat <span class="hljs-attr">stat</span> = users.stream().reduce(
    new Stat(),
    (s, u) -&gt; {
        s.totalAge += u.getAge()<span class="hljs-comment">;</span>
        s.count++<span class="hljs-comment">;</span>
        return s<span class="hljs-comment">;</span>
    },
    (s1, s2) -&gt; {
        s1.totalAge += s2.totalAge<span class="hljs-comment">;</span>
        s1.count += s2.count<span class="hljs-comment">;</span>
        return s1<span class="hljs-comment">;</span>
    }
)<span class="hljs-comment">;</span>
</code></pre>
<p>这是企业项目里非常常见的写法。</p>
<hr/>
<h3 data-id="heading-19">5. 用 reduce 把 List 扁平化（不推荐但可做）</h3>
<pre><code class="hljs language-scss" lang="scss">List&lt;Integer&gt; merged = lists<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.reduce</span>(
    new ArrayList&lt;&gt;(),
    (acc, list) -&gt; { acc<span class="hljs-selector-class">.addAll</span>(list); return acc; },
    (acc1, acc2) -&gt; { acc1<span class="hljs-selector-class">.addAll</span>(acc2); return acc1; }
);
</code></pre>
<p>虽然可行，但实际推荐：</p>
<pre><code class="hljs language-scss" lang="scss">lists<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.flatMap</span>(Collection::stream)<span class="hljs-selector-class">.toList</span>();
</code></pre>
<hr/>
<h3 data-id="heading-20">6. 统计出现次数（某字段频率）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">int</span> count = <span class="hljs-built_in">list</span>.stream()
    .<span class="hljs-built_in">filter</span>(s -&gt; s.equals(<span class="hljs-string">"apple"</span>))
    .reduce(<span class="hljs-number">0</span>, (acc, s) -&gt; acc + <span class="hljs-number">1</span>, Integer::<span class="hljs-built_in">sum</span>);
</code></pre>
<p>不过更推荐 groupingBy。</p>
<hr/>
<h3 data-id="heading-21">7. 字符串拼接（可以但不优）</h3>
<pre><code class="hljs language-css" lang="css">String str = list<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.reduce</span>("", (<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>) -&gt; <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>);
</code></pre>
<p>更推荐：</p>
<pre><code class="hljs language-scss" lang="scss">Collectors<span class="hljs-selector-class">.joining</span>()
</code></pre>
<hr/>
<h3 data-id="heading-22">8. 多字段组合运算（如金额 × 汇率）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">BigDecimal</span> <span class="hljs-selector-tag">total</span> = <span class="hljs-selector-tag">list</span><span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.reduce</span>(
    BigDecimal.ZERO,
    (acc, o) -&gt; acc.<span class="hljs-built_in">add</span>(o.<span class="hljs-built_in">getAmount</span>().<span class="hljs-built_in">multiply</span>(o.<span class="hljs-built_in">getRate</span>())),
    <span class="hljs-attribute">BigDecimal</span>::add
);
</code></pre>
<p>企业业务非常常见。</p>
<hr/>
<h2 data-id="heading-23">六、reduce 的 4 大误区（你可能全踩过）</h2>
<h3 data-id="heading-24">❌ 1. 把 reduce 用成“万能循环”</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">.reduce(<span class="hljs-number">0</span>, (acc, e) -&gt; {
    System.<span class="hljs-keyword">out</span>.println(e); <span class="hljs-comment">// 副作用，不可取</span>
    <span class="hljs-keyword">return</span> acc + e;
})
</code></pre>
<p>reduce 应该是“纯函数式”，不应做输出、写全局变量等副作用。</p>
<hr/>
<h3 data-id="heading-25">❌ 2. 并行流中 identity 使用不当导致结果错误</h3>
<p>并行流会让 identity <strong>每个分片都执行一次</strong>。</p>
<p>错误示例：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">parallelStream</span>()<span class="hljs-selector-class">.reduce</span>(<span class="hljs-number">10</span>, Integer::sum);
</code></pre>
<hr/>
<h3 data-id="heading-26">❌ 3. 用 reduce 构建 List / Map（低效 + 不安全）</h3>
<p>正确方式是：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.collect</span>(Collectors.<span class="hljs-built_in">toList</span>())
</code></pre>
<hr/>
<h3 data-id="heading-27">❌ 4. 忽略 Optional 版本 reduce 的意义</h3>
<pre><code class="hljs language-arduino" lang="arduino">stream.<span class="hljs-built_in">reduce</span>(Integer::max) <span class="hljs-comment">// 可能为空</span>
</code></pre>
<p>如果你非常确定 stream 非空，可以用有 identity 的重载。</p>
<hr/>
<h2 data-id="heading-28">七、什么时候应该果断用 reduce？（最佳实践）</h2>








































<table><thead><tr><th>场景</th><th>是否适合 reduce</th><th>推荐程度</th></tr></thead><tbody><tr><td>求和/最大/最小</td><td>✔️ 非常适合</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>累加数值</td><td>✔️ 适合</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>聚合多个字段成对象</td><td>✔️ 很适合</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>多字段复杂计算</td><td>✔️ 适合</td><td>⭐⭐⭐⭐</td></tr><tr><td>拼接字符串</td><td>❌ 不推荐</td><td>⭐</td></tr><tr><td>构建 List/Map</td><td>❌ 不推荐</td><td>⭐</td></tr></tbody></table>
<p>结论：</p>
<blockquote>
<p><strong>reduce 最适合 “复杂数值聚合” 与 “构建统计对象”</strong> 。</p>
</blockquote>
<p>这是它的真正价值。</p>
<hr/>
<h2 data-id="heading-29">八、总结：reduce 是 Stream 的灵魂</h2>
<p>reduce 不是简单的“求和函数”，它是：</p>
<p>✔ Stream 中唯一用于“把多个元素归约为一个结果”的 API<br/>
✔ 实现自定义聚合逻辑的最强工具<br/>
✔ 函数式编程在 Java 里的核心体现<br/>
✔ 写优雅、高可读、高抽象代码的关键</p>
<p>如果说 map/filter 是“数据加工工具”，那么：</p>
<blockquote>
<p><strong>reduce 就是“最终组装器”。</strong></p>
</blockquote>
<p>掌握了 reduce，你对 Stream 的理解就上了一个台阶。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 视口单位进化论：从 100vh 的「骗局」到 dvh 的救赎]]></title>    <link>https://juejin.cn/post/7577797563854110756</link>    <guid>https://juejin.cn/post/7577797563854110756</guid>    <pubDate>2025-11-30T09:22:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577797563854110756" data-draft-id="7577797563854094372" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 视口单位进化论：从 100vh 的「骗局」到 dvh 的救赎"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-30T09:22:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="兔子零1024"/> <meta itemprop="url" content="https://juejin.cn/user/3743194047592062"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 视口单位进化论：从 100vh 的「骗局」到 dvh 的救赎
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3743194047592062/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    兔子零1024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:22:01.000Z" title="Sun Nov 30 2025 09:22:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>关键词：CSS / 视口单位 / 移动端适配 / 响应式设计 / dvh / svh / lvh / 100vh bug / 前端工程化 / 用户体验</p>
<hr/>
<h2 data-id="heading-0">引言：一个持续了十年的移动端「谎言」</h2>
<p>如果你做过移动端 H5 开发，或者写过全屏落地的营销页，你一定遇到过那个著名的「100vh 骗局」。</p>
<p>设计师给了你一张完美的设计稿：<strong>首屏全屏，底部按钮固定，不允许有滚动条</strong>。<br/>
你自信满满地写下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.hero-section</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
}
</code></pre>
<p>然后你在 iPhone 的 Safari 里打开，灾难发生了：<strong>底部的按钮被浏览器底部的工具栏遮住了一半，或者页面莫名其妙出现了一截滚动条</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4e588457c8542b1bf827b137d40cc44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWU5a2Q6Zu2MTAyNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765099321&amp;x-signature=KcjcvhleZ2DBmEugdYAqCB3Pjjs%3D" alt="1.jpg" loading="lazy"/></p>
<p><em>(图解：左侧是理想设计，按钮在最底部；右侧是 Safari 现状，浏览器工具栏无情地盖住了你的按钮)</em></p>
<p>为了解决这个问题，前端社区发明了无数「歪门邪道」：</p>
<ul>
<li>用 <code>window.innerHeight</code> 动态计算高度赋给 CSS 变量 <code>--vh</code>。</li>
<li>监听 <code>resize</code> 事件疯狂重绘。</li>
<li>使用 <code>position: fixed; top: 0; bottom: 0;</code> 这种古老的 hack。</li>
</ul>
<p><strong>为什么一个简单的「全屏」需求，在移动端会如此艰难？</strong><br/>
这背后其实是 Web 标准与移动端原生 UI（动态地址栏、底部工具栏）长达十年的博弈。</p>
<p>好消息是，CSS 终于迎来了<strong>真正解决问题</strong>的新一代视口单位：<code>svh</code>、<code>lvh</code>、<code>dvh</code> 以及它们在宽度和逻辑方向上的兄弟们。</p>
<blockquote>
<p><strong>这不是简单的语法升级，这是 Web 终于承认：移动端的屏幕，从来就不是一个静态的矩形。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-1">一、旧时代的妥协：为什么 100vh 不是真的 100% 高度？</h2>
<h3 data-id="heading-2">1.1 完美的初衷与残酷的现实</h3>
<p>在 PC 时代，<code>vh</code> (Viewport Height) 的定义非常完美：<strong>视口高度的 1%</strong>。浏览器窗口多高，100vh 就多高。</p>
<p>但在移动端，情况变了。iOS Safari 和 Chrome Android 为了给用户更多阅读空间，设计了<strong>动态工具栏</strong>：</p>
<ul>
<li><strong>初始状态</strong>：地址栏、底部工具栏展开，可视区域变小。</li>
<li><strong>上滑状态</strong>：地址栏缩小/隐藏，工具栏消失，可视区域变大。</li>
</ul>
<p>这时候，<code>100vh</code> 该等于「展开时的高度」还是「隐藏时的高度」？</p>
<h3 data-id="heading-3">1.2 浏览器的「摆烂」选择</h3>
<p>早期的 Safari 做了一个影响深远的决定：<strong>为了避免滚动时页面元素跳动（Reflow），<code>100vh</code> 永远等于「地址栏隐藏时的最大高度」</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5b6f15fccdb4651a0f420367c3a943e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWU5a2Q6Zu2MTAyNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765099321&amp;x-signature=KqgCJiTJONAmSyLUgASd0gJZUJk%3D" alt="2.jpg" loading="lazy"/></p>
<p><em>(图解：无论你的工具栏是否展开，Safari 始终认为 100vh 是那个「最大值」。这就导致当工具栏展开（实际只有 80% 高度）时，你的 100vh 内容溢出了 20%。)</em></p>
<p>这就解释了为什么你的按钮被遮住了：</p>
<ul>
<li>浏览器告诉你 100vh 是 800px（假设全屏高度）。</li>
<li>但实际上底部的工具栏占了 80px，可视区域只有 720px。</li>
<li>你的按钮画在了第 750px 的位置，正好被工具栏盖得严严实实。</li>
</ul>
<p>这个「特性」被无数开发者吐槽为 Bug，但浏览器厂商坚持这是「Feature」。</p>
<blockquote>
<p>「他们为了滚动的丝滑，牺牲了布局的精确。<br/>
在很长一段时间里，我们只能用 JS 来修补 CSS 的谎言。」</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">二、新秩序的建立：svh、lvh、dvh 的三态哲学</h2>
<p>W3C 终于意识到，移动端的视口不是一个固定的值，而是一个<strong>在「大」与「小」之间薛定谔的波动状态</strong>。</p>
<p>于是，CSS Viewport Units Level 3 引入了一套全新的单位体系，把视口高度拆分为三种状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a6b8f1891314d098b05bdeeee9e9bec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWU5a2Q6Zu2MTAyNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765099321&amp;x-signature=1BBWPffprm5Y9U58g%2BPzdOchGhY%3D" alt="3.jpg" loading="lazy"/></p>
<h3 data-id="heading-5">2.1 svh (Small Viewport Height)：永远不再被遮挡</h3>
<p><strong>定义</strong>：视口高度的<strong>最小值</strong>（即地址栏、工具栏<strong>全部展开</strong>时的可视高度）。</p>
<ul>
<li><strong>应用场景</strong>：<strong>首屏全屏页、底部固定按钮、Modal 弹窗</strong>。</li>
<li><strong>价值</strong>：如果你写 <code>height: 100svh</code>，你的页面底部绝对不会被工具栏遮挡。它是最安全的「一屏」。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 以前的 JS Hack */</span>
<span class="hljs-selector-class">.modal</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--vh, <span class="hljs-number">1vh</span>) * <span class="hljs-number">100</span>);
}

<span class="hljs-comment">/* 现在的原生写法 */</span>
<span class="hljs-selector-class">.modal</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100s</span>vh;
}
</code></pre>
<h3 data-id="heading-6">2.2 lvh (Large Viewport Height)：沉浸式的极致</h3>
<p><strong>定义</strong>：视口高度的<strong>最大值</strong>（即地址栏、工具栏<strong>全部收起</strong>时的可视高度）。</p>
<ul>
<li><strong>应用场景</strong>：<strong>背景图、视差滚动容器</strong>。</li>
<li><strong>价值</strong>：当你希望背景铺满整个「潜在」屏幕，不在乎一部分被遮挡时，用 <code>lvh</code>。它等同于旧时代的 <code>100vh</code>。</li>
</ul>
<h3 data-id="heading-7">2.3 dvh (Dynamic Viewport Height)：动态的完美与代价</h3>
<p><strong>定义</strong>：<strong>动态</strong>视口高度。它会随着地址栏的伸缩，实时在 <code>svh</code> 和 <code>lvh</code> 之间变化。</p>
<ul>
<li><strong>应用场景</strong>：<strong>追求极致体验的流式布局</strong>。</li>
<li><strong>代价</strong>：当用户滚动页面时，<code>100dvh</code> 的值会不断变化。这意味着浏览器可能需要不断重绘（Repaint）甚至重排（Reflow）。</li>
<li><strong>现状</strong>：现代浏览器对 <code>dvh</code> 做了很多优化，性能损耗在大多数场景下已可忽略不计。</li>
</ul>
<blockquote>
<p><strong>三态哲学总结：</strong></p>
<ul>
<li><strong>svh</strong> 是保底的<strong>安全</strong>（Safe）。</li>
<li><strong>lvh</strong> 是理想的<strong>宏大</strong>（Large）。</li>
<li><strong>dvh</strong> 是真实的<strong>动态</strong>（Dynamic）。</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-8">三、维度的扩张：宽度、逻辑方向与极值</h2>
<p>这套逻辑不仅修复了高度问题，还顺带重构了整个视口单位体系。</p>
<h3 data-id="heading-9">3.1 宽度的进化：svw / lvw / dvw</h3>
<p>虽然移动端宽度的变化（主要是滚动条出现/消失）不如高度那么剧烈，但逻辑是一致的。</p>
<ul>
<li><strong>vw</strong>：依然是默认视口宽度（通常包含滚动条）。</li>
<li><strong>svw / lvw / dvw</strong>：处理滚动条存在与否时的细微差异（在桌面端更明显）。</li>
</ul>
<h3 data-id="heading-10">3.2 逻辑方向：vi / vb —— 国际化的必修课</h3>
<p>随着 CSS 逻辑属性（Logical Properties）的普及，我们不再总是谈论 <code>width</code> 和 <code>height</code>，而是谈论 <code>inline</code>（文本流方向）和 <code>block</code>（块堆叠方向）。</p>
<ul>
<li>
<p><strong>vi (Viewport Inline)</strong>：视口在行内方向的大小。</p>
<ul>
<li>横屏/竖屏书写模式下：等于 <code>vw</code>。</li>
<li>竖排书写模式（如古诗词页面）：等于 <code>vh</code>。</li>
<li><strong>svi / lvi / dvi</strong>：对应的三态变体。</li>
</ul>
</li>
<li>
<p><strong>vb (Viewport Block)</strong>：视口在块级方向的大小。</p>
<ul>
<li>横屏/竖屏书写模式下：等于 <code>vh</code>。</li>
<li><strong>svb / lvb / dvb</strong>：对应的三态变体。</li>
</ul>
</li>
</ul>
<p><strong>实战案例：一个适配横竖屏书写的古诗卡片</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.poem-card</span> {
  <span class="hljs-comment">/* 无论横排还是竖排，永远占满视口在「块」方向上的 80% */</span>
  <span class="hljs-attribute">block-size</span>: <span class="hljs-number">80</span>vb; 
  
  <span class="hljs-comment">/* 无论横排还是竖排，永远占满视口在「行」方向上的 90% */</span>
  <span class="hljs-attribute">inline-size</span>: <span class="hljs-number">90</span>vi;
  
  <span class="hljs-comment">/* 自动适配书写模式 */</span>
  <span class="hljs-attribute">writing-mode</span>: vertical-rl; <span class="hljs-comment">/* 切换这个属性，布局依然完美 */</span>
}
</code></pre>
<h3 data-id="heading-11">3.3 极值单位：vmin / vmax 的三态</h3>
<p>老朋友 <code>vmin</code>（vw/vh 中较小者）和 <code>vmax</code>（较大者）也全员升级：</p>
<ul>
<li><strong>svmin / svmax</strong></li>
<li><strong>lvmin / lvmax</strong></li>
<li><strong>dvmin / dvmax</strong></li>
</ul>
<p><strong>场景</strong>：做横竖屏适配的 H5 游戏或画报时，<code>svmin</code> 是保证内容在任何旋转状态下都<strong>完整可见</strong>的神器。</p>
<hr/>
<h2 data-id="heading-12">四、工程实战：如何在 2025 年写好一个全屏页面？</h2>
<h3 data-id="heading-13">4.1 放弃 100vh，拥抱 dvh（但要做降级）</h3>
<p>在 2025 年，如果你的目标浏览器支持率允许（iOS 15.4+, Chrome 108+），<strong><code>dvh</code> 是全屏容器的最佳选择</strong>。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.full-screen-hero</span> {
  <span class="hljs-comment">/* 降级方案：给旧浏览器一个固定的值 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
  
  <span class="hljs-comment">/* 现代方案：使用动态高度，完美贴合 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100</span>dvh;
}
</code></pre>
<h3 data-id="heading-14">4.2 关键交互区域用 svh</h3>
<p>对于底部的操作栏（Action Bar），不要用 <code>dvh</code>，因为你不想让按钮在用户手指滑动时「跳来跳去」。<strong>用 <code>svh</code> 锁定位置</strong>。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.bottom-bar</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-comment">/* 确保它永远在可视区底部，哪怕地址栏展开 */</span>
  <span class="hljs-attribute">bottom</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100vh</span> - <span class="hljs-number">100s</span>vh); <span class="hljs-comment">/* 高级技巧：计算工具栏高度偏移 */</span>
}

<span class="hljs-comment">/* 或者更简单的布局思维： */</span>
<span class="hljs-selector-class">.app-container</span> {
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100s</span>vh;
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-number">1</span>fr auto;
}
</code></pre>
<h3 data-id="heading-15">4.3 慎用 lvh，除非你在做特效</h3>
<p><code>lvh</code> 在实际 UI 布局中用得很少。它更多用于<strong>视觉背景</strong>，或者那种「滑一下就全屏」的沉浸式阅读体验。如果你用 <code>lvh</code> 做布局容器，用户大概率会因为点不到底部的按钮而骂娘。</p>
<blockquote>
<p>「成熟的工程师懂得：<br/>
UI 的稳定性（svh）优先于 UI 的充满感（lvh），<br/>
而 dvh 是两者之间的优雅平衡。」</p>
</blockquote>
<hr/>
<h2 data-id="heading-16">五、总结：从「对抗」到「接纳」</h2>
<p>回顾 CSS 视口单位的进化史，其实是一部 Web 与移动端原生特性的磨合史。</p>
<ul>
<li><strong>vh 时代</strong>：Web 试图假装自己还在 PC 上，无视了移动端复杂的 UI 变化，结果撞得头破血流（100vh bug）。</li>
<li><strong>JS Hack 时代</strong>：开发者用脚本强行修正高度，对抗浏览器的默认行为，性能差且代码丑陋。</li>
<li><strong>svh/dvh 时代</strong>：标准终于接纳了移动端的复杂性。<strong>我们不再强求一个「唯一的 100%」，而是承认「屏幕是会变的」</strong>。</li>
</ul>
<p>这给了我们两个重要的启示：</p>
<ol>
<li><strong>不存在完美的静态适配</strong>。移动端设备极其碎片化，折叠屏、刘海屏、动态栏……<strong>拥抱动态（Dynamic）才是终极解法</strong>。</li>
<li><strong>工具的粒度决定了体验的细腻度</strong>。从粗糙的 <code>vh</code> 到精细的 <code>svh/lvh/dvh</code>，前端工程化的本质，就是不断提升对像素级体验的掌控力。</li>
</ol>
<blockquote>
<p>下一次，当设计师问你「能不能把这个页面铺满全屏，不要滚动条，也不要被遮挡」时，<br/>
你可以自信地合上电脑（或者打开 VS Code），告诉他：<br/>
<strong>「当然可以，因为现在的 CSS，终于懂手机了。」</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[element-plus源码解读3——【scss】颜色系统完整流程]]></title>    <link>https://juejin.cn/post/7577969462860496959</link>    <guid>https://juejin.cn/post/7577969462860496959</guid>    <pubDate>2025-11-30T09:30:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577969462860496959" data-draft-id="7577797563853832228" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="element-plus源码解读3——【scss】颜色系统完整流程"/> <meta itemprop="keywords" content="SCSS,Element"/> <meta itemprop="datePublished" content="2025-11-30T09:30:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Joie"/> <meta itemprop="url" content="https://juejin.cn/user/3265984436383947"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            element-plus源码解读3——【scss】颜色系统完整流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3265984436383947/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Joie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:30:32.000Z" title="Sun Nov 30 2025 09:30:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、基础颜色定义（源头）</h2>
<p><em>位置：packages/theme-chalk/src/common/var.scss</em></p>
<p>scss知识点：$ 表示变量</p>
<ul>
<li>定义所有颜色的基础值</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// types</span>
<span class="hljs-attr">$types</span>: primary, success, warning, danger, error, info;

<span class="hljs-comment">// Color</span>
<span class="hljs-attr">$colors</span>: () !<span class="hljs-keyword">default</span>;
<span class="hljs-attr">$colors</span>: map.<span class="hljs-property">deep</span>-<span class="hljs-title function_">merge</span>(
  (
    <span class="hljs-string">'white'</span>: #ffffff,
    <span class="hljs-string">'black'</span>: #<span class="hljs-number">000000</span>,
    <span class="hljs-string">'primary'</span>: (
      <span class="hljs-string">'base'</span>: #409eff,
    ),
    <span class="hljs-string">'success'</span>: (
      <span class="hljs-string">'base'</span>: #67c23a,
    ),
    <span class="hljs-string">'warning'</span>: (
      <span class="hljs-string">'base'</span>: #e6a23c,
    ),
    <span class="hljs-string">'danger'</span>: (
      <span class="hljs-string">'base'</span>: #f56c6c,
    ),
    <span class="hljs-string">'error'</span>: (
      <span class="hljs-string">'base'</span>: #f56c6c,
    ),
    <span class="hljs-string">'info'</span>: (
      <span class="hljs-string">'base'</span>: #<span class="hljs-number">909399</span>,
    ),
  ),
  $colors
);
</code></pre>
<h2 data-id="heading-1">二、自动生成颜色变体（light/dark）</h2>
<p><em>位置：packages/theme-chalk/src/common/var.scss</em></p>
<p>定义一个mixin: <strong>set-color-mix-level</strong>:</p>
<p>将基础颜色与白色或黑色混合</p>
<p>生成指定级别的浅色或深色变体</p>
<p>将生成的颜色添加到$colors map中</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// mix colors with white/black to generate light/dark level</span>
@mixin set-color-mix-<span class="hljs-title function_">level</span>(<span class="hljs-params">
  $type,
  $number,
  $mode: <span class="hljs-string">'light'</span>,
  $mix-color: $color-white
</span>) {
  <span class="hljs-attr">$colors</span>: map.<span class="hljs-property">deep</span>-<span class="hljs-title function_">merge</span>(
    (
      <span class="hljs-attr">$type</span>: (
        <span class="hljs-comment">/**
        * roundColor：将颜色的 RGB 通道值四舍五入为整数，并返回 rgba() 格式的颜色。
        * color.mix：混合颜色 第一个参数和第二个参数按照第三个参数的百分比混合颜色
        * map.get($colors, $type, 'base')：获取颜色
        * math.percentage(math.div($number, 10))：将数字转换为百分比
        */</span>
          <span class="hljs-string">'#{$mode}-#{$number}'</span>: <span class="hljs-title function_">roundColor</span>(
            color.<span class="hljs-title function_">mix</span>(
              $mix-color,
              map.<span class="hljs-title function_">get</span>($colors, $type, <span class="hljs-string">'base'</span>),
              math.<span class="hljs-title function_">percentage</span>(math.<span class="hljs-title function_">div</span>($number, <span class="hljs-number">10</span>))
            )
          ),
      ),
    ),
    $colors
  ) !<span class="hljs-variable language_">global</span>;
}

</code></pre>
<p>使用</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// $colors.primary.light-i</span>
<span class="hljs-comment">// --el-color-primary-light-i</span>
<span class="hljs-comment">// 10% 53a8ff</span>
<span class="hljs-comment">// 20% 66b1ff</span>
<span class="hljs-comment">// 30% 79bbff</span>
<span class="hljs-comment">// 40% 8cc5ff</span>
<span class="hljs-comment">// 50% a0cfff</span>
<span class="hljs-comment">// 60% b3d8ff</span>
<span class="hljs-comment">// 70% c6e2ff</span>
<span class="hljs-comment">// 80% d9ecff</span>
<span class="hljs-comment">// 90% ecf5ff</span>

<span class="hljs-comment">// 外层循环：遍历颜色类型</span>
@each $type <span class="hljs-keyword">in</span> $types {
  <span class="hljs-comment">// 内层循环：生成 1-9 的变体</span>
  @<span class="hljs-keyword">for</span> $i <span class="hljs-keyword">from</span> <span class="hljs-number">1</span> through <span class="hljs-number">9</span> {
    <span class="hljs-comment">// 调用 mixin 生成不同亮度的颜色</span>
    @include set-color-mix-<span class="hljs-title function_">level</span>($type, $i, <span class="hljs-string">'light'</span>, $color-white);
  }
}


<span class="hljs-comment">// 第 1 轮：$type = primary</span>
@include set-color-mix-<span class="hljs-title function_">level</span>(primary, <span class="hljs-number">1</span>, <span class="hljs-string">'light'</span>, $color-white);  <span class="hljs-comment">// 生成 primary-light-1</span>
@include set-color-mix-<span class="hljs-title function_">level</span>(primary, <span class="hljs-number">2</span>, <span class="hljs-string">'light'</span>, $color-white);  <span class="hljs-comment">// 生成 primary-light-2</span>
@include set-color-mix-<span class="hljs-title function_">level</span>(primary, <span class="hljs-number">3</span>, <span class="hljs-string">'light'</span>, $color-white);  <span class="hljs-comment">// 生成 primary-light-3</span>
<span class="hljs-comment">// ... 继续到 9</span>

<span class="hljs-comment">// 第 2 轮：$type = success</span>
@include set-color-mix-<span class="hljs-title function_">level</span>(success, <span class="hljs-number">1</span>, <span class="hljs-string">'light'</span>, $color-white);   <span class="hljs-comment">// 生成 success-light-1</span>
@include set-color-mix-<span class="hljs-title function_">level</span>(success, <span class="hljs-number">2</span>, <span class="hljs-string">'light'</span>, $color-white);   <span class="hljs-comment">// 生成 success-light-2</span>
<span class="hljs-comment">// ... 继续到 9</span>

<span class="hljs-comment">// 依此类推，直到遍历完所有 6 种类型</span>
</code></pre>
<h2 data-id="heading-2">三、生成 CSS 变量（全局）</h2>
<p><em>位置：packages/theme-chalk/src/var.scss</em></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// join var name</span>
<span class="hljs-comment">// joinVarName(('button', 'text-color')) =&gt; '--el-button-text-color'</span>
<span class="hljs-comment">// 将$list遍历中间用-拼接每一个$item</span>
@<span class="hljs-keyword">function</span> <span class="hljs-title function_">joinVarName</span>(<span class="hljs-params">$list</span>) {
  <span class="hljs-attr">$name</span>: <span class="hljs-string">'--'</span> + config.<span class="hljs-property">$namespace</span>;
  @each $item <span class="hljs-keyword">in</span> $list {
    @<span class="hljs-keyword">if</span> $item != <span class="hljs-string">''</span> {
      <span class="hljs-attr">$name</span>: $name + <span class="hljs-string">'-'</span> + $item;
    }
  }
  @<span class="hljs-keyword">return</span> $name;
}

===============================================================

<span class="hljs-comment">// set css var value, because we need translate value to string</span>
<span class="hljs-comment">// for example:</span>
<span class="hljs-comment">// @include set-css-var-value(('color', 'primary'), red);</span>
<span class="hljs-comment">// --el-color-primary: red;</span>
<span class="hljs-comment">// 返回 变量名：颜色值 的形式</span>
@mixin set-css-<span class="hljs-keyword">var</span>-<span class="hljs-title function_">value</span>(<span class="hljs-params">$name, $value</span>) {
  #{<span class="hljs-title function_">joinVarName</span>($name)}: #{$value};
}

================================================================

@mixin set-css-color-<span class="hljs-title function_">type</span>(<span class="hljs-params">$colors, $type</span>) {
  <span class="hljs-comment">// 生成基础颜色变量</span>
  @include set-css-<span class="hljs-keyword">var</span>-<span class="hljs-title function_">value</span>((<span class="hljs-string">'color'</span>, $type), map.<span class="hljs-title function_">get</span>($colors, $type, <span class="hljs-string">'base'</span>));
  <span class="hljs-comment">// 结果：--el-color-primary: #409eff;</span>

  <span class="hljs-comment">// 生成浅色变量（3, 5, 7, 8, 9）</span>
  @each $i <span class="hljs-keyword">in</span> (<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>) {
    @include set-css-<span class="hljs-keyword">var</span>-<span class="hljs-title function_">value</span>(
      (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'light'</span>, $i),
      map.<span class="hljs-title function_">get</span>($colors, $type, <span class="hljs-string">'light-#{$i}'</span>)
    );
  }
  <span class="hljs-comment">// 结果：</span>
  <span class="hljs-comment">// --el-color-primary-light-3: #79bbff;</span>
  <span class="hljs-comment">// --el-color-primary-light-5: #a0cfff;</span>
  <span class="hljs-comment">// --el-color-primary-light-7: #c6e2ff;</span>
  <span class="hljs-comment">// --el-color-primary-light-8: #d9ecff;</span>
  <span class="hljs-comment">// --el-color-primary-light-9: #ecf5ff;</span>

  <span class="hljs-comment">// 生成深色变量</span>
  @include set-css-<span class="hljs-keyword">var</span>-<span class="hljs-title function_">value</span>(
    (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'dark-2'</span>),
    map.<span class="hljs-title function_">get</span>($colors, $type, <span class="hljs-string">'dark-2'</span>)
  );
  <span class="hljs-comment">// 结果：--el-color-primary-dark-2: ...;</span>
}

=================================================================

:root {
  color-<span class="hljs-attr">scheme</span>: light;

  <span class="hljs-comment">// --el-color-#{$type}</span>
  <span class="hljs-comment">// --el-color-#{$type}-light-{$i}</span>
  @each $type <span class="hljs-keyword">in</span> (primary, success, warning, danger, error, info) {
    @include set-css-color-<span class="hljs-title function_">type</span>($colors, $type);
  }
  
生成的css变量，以primary为例子
:root {
  --el-color-<span class="hljs-attr">primary</span>: #409eff;
  --el-color-primary-light-<span class="hljs-number">3</span>: #79bbff;
  --el-color-primary-light-<span class="hljs-number">5</span>: #a0cfff;
  --el-color-primary-light-<span class="hljs-number">7</span>: #c6e2ff;
  --el-color-primary-light-<span class="hljs-number">8</span>: #d9ecff;
  --el-color-primary-light-<span class="hljs-number">9</span>: #ecf5ff;
  --el-color-primary-dark-<span class="hljs-number">2</span>: #337ecc;
}
</code></pre>
<h2 data-id="heading-3">四、组件级使用——以el-button为例子</h2>
<p><em>位置：packages/theme-chalk/src/button.scss</em></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// generate css var from existing css var</span>
<span class="hljs-comment">// for example:</span>
<span class="hljs-comment">// @include css-var-from-global(('button', 'text-color'), ('color', $type))</span>
<span class="hljs-comment">// --el-button-text-color: var(--el-color-#{$type});</span>
@mixin css-<span class="hljs-keyword">var</span>-<span class="hljs-keyword">from</span>-<span class="hljs-title function_">global</span>(<span class="hljs-params">$var, $gVar</span>) {
  <span class="hljs-attr">$varName</span>: <span class="hljs-title function_">joinVarName</span>($var);
  <span class="hljs-attr">$gVarName</span>: <span class="hljs-title function_">joinVarName</span>($gVar);
  #{$varName}: <span class="hljs-title function_">var</span>(#{$gVarName});
}

==========================================================

$button-color-types 是一个 <span class="hljs-variable constant_">SCSS</span> 变量（map），定义在 button-variant mixin 内部。它是一个嵌套的 map，用于定义按钮在不同状态下的颜色映射关系。

$button-color-<span class="hljs-attr">types</span>: (
    <span class="hljs-string">''</span>: (
      <span class="hljs-string">'text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        <span class="hljs-string">'white'</span>,
      ),
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
      ),
      <span class="hljs-string">'outline-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
      <span class="hljs-string">'active-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'dark-2'</span>,
      ),
    ),
    <span class="hljs-string">'hover'</span>: (
      <span class="hljs-string">'text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        <span class="hljs-string">'white'</span>,
      ),
      <span class="hljs-string">'link-text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-3'</span>,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-3'</span>,
      ),
    ),
    <span class="hljs-string">'active'</span>: (
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'dark-2'</span>,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'dark-2'</span>,
      ),
    ),
    <span class="hljs-string">'disabled'</span>: (
      <span class="hljs-string">'text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        <span class="hljs-string">'white'</span>,
      ),
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
    ),
  );
  
  <span class="hljs-comment">// 结构层次</span>
  $button-color-types (第一层：状态)
  ├─ <span class="hljs-string">''</span> (默认状态)
  │   ├─ <span class="hljs-string">'text-color'</span> → (<span class="hljs-string">'color'</span>, <span class="hljs-string">'white'</span>)
  │   ├─ <span class="hljs-string">'bg-color'</span> → (<span class="hljs-string">'color'</span>, $type)
  │   ├─ <span class="hljs-string">'border-color'</span> → (<span class="hljs-string">'color'</span>, $type)
  │   ├─ <span class="hljs-string">'outline-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'light-5'</span>)
  │   └─ <span class="hljs-string">'active-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'dark-2'</span>)
  │
  ├─ <span class="hljs-string">'hover'</span> (悬停状态)
  │   ├─ <span class="hljs-string">'text-color'</span> → (<span class="hljs-string">'color'</span>, <span class="hljs-string">'white'</span>)
  │   ├─ <span class="hljs-string">'link-text-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'light-5'</span>)
  │   ├─ <span class="hljs-string">'bg-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'light-3'</span>)
  │   └─ <span class="hljs-string">'border-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'light-3'</span>)
  │
  ├─ <span class="hljs-string">'active'</span> (激活状态)
  │   ├─ <span class="hljs-string">'bg-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'dark-2'</span>)
  │   └─ <span class="hljs-string">'border-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'dark-2'</span>)
  │
  └─ <span class="hljs-string">'disabled'</span> (禁用状态)
      ├─ <span class="hljs-string">'text-color'</span> → (<span class="hljs-string">'color'</span>, <span class="hljs-string">'white'</span>)
      ├─ <span class="hljs-string">'bg-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'light-5'</span>)
      └─ <span class="hljs-string">'border-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'light-5'</span>)

================================================================

  @each $type, $typeMap <span class="hljs-keyword">in</span> $button-color-types {
    <span class="hljs-comment">// 内层循环，遍历第二层(属性)：text-color, bg-color, border-color, outline-color, active-color</span>
    <span class="hljs-comment">// $typeColor:属性名，例如：'text-color'</span>
    <span class="hljs-comment">// $list:属性值，例如：('color', 'white')</span>
    @each $typeColor, $list <span class="hljs-keyword">in</span> $typeMap {
      <span class="hljs-comment">// 调用 css-var-from-global 生成 CSS 变量</span>
      <span class="hljs-comment">// 例如：@include css-var-from-global(('button', 'hover', 'text-color'), ('color', 'white'));</span>
      @include css-<span class="hljs-keyword">var</span>-<span class="hljs-keyword">from</span>-<span class="hljs-title function_">global</span>((<span class="hljs-string">'button'</span>, $type, $typeColor), $list);
    }
  }
  
 <span class="hljs-comment">// 当 $type = 'primary' 时，会生成：</span>
 <span class="hljs-comment">/* 默认状态 */</span>
--el-button-text-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-white);
--el-button-bg-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary);
--el-button-border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary);
--el-button-outline-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">5</span>);
--el-button-active-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-dark-<span class="hljs-number">2</span>);

<span class="hljs-comment">/* 悬停状态 */</span>
--el-button-hover-text-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-white);
--el-button-hover-link-text-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">5</span>);
--el-button-hover-bg-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">3</span>);
--el-button-hover-border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">3</span>);

<span class="hljs-comment">/* 激活状态 */</span>
--el-button-active-bg-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-dark-<span class="hljs-number">2</span>);
--el-button-active-border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-dark-<span class="hljs-number">2</span>);

<span class="hljs-comment">/* 禁用状态 */</span>
--el-button-disabled-text-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-white);
--el-button-disabled-bg-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">5</span>);
--el-button-disabled-border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">5</span>);

=====================================================================

完整源码：
@mixin button-<span class="hljs-title function_">variant</span>(<span class="hljs-params">$type</span>) {
  $button-color-<span class="hljs-attr">types</span>: (
    <span class="hljs-string">''</span>: (
      <span class="hljs-string">'text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        <span class="hljs-string">'white'</span>,
      ),
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
      ),
      <span class="hljs-string">'outline-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
      <span class="hljs-string">'active-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'dark-2'</span>,
      ),
    ),
    <span class="hljs-string">'hover'</span>: (
      <span class="hljs-string">'text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        <span class="hljs-string">'white'</span>,
      ),
      <span class="hljs-string">'link-text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-3'</span>,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-3'</span>,
      ),
    ),
    <span class="hljs-string">'active'</span>: (
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'dark-2'</span>,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'dark-2'</span>,
      ),
    ),
    <span class="hljs-string">'disabled'</span>: (
      <span class="hljs-string">'text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        <span class="hljs-string">'white'</span>,
      ),
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
    ),
  );

  <span class="hljs-comment">// 外层循环，遍历第一层(状态)：'', 'hover', 'active', 'disabled'</span>
  <span class="hljs-comment">// $type状态名例如'hover'；</span>
  <span class="hljs-comment">// $typeMap:状态对应的属性值，例如：('text-color': (</span>
  <span class="hljs-comment">//   'color',</span>
  <span class="hljs-comment">//   'white',</span>
  <span class="hljs-comment">// ),)</span>
  @each $type, $typeMap <span class="hljs-keyword">in</span> $button-color-types {
    <span class="hljs-comment">// 内层循环，遍历第二层(属性)：text-color, bg-color, border-color, outline-color, active-color</span>
    <span class="hljs-comment">// $typeColor:属性名，例如：'text-color'</span>
    <span class="hljs-comment">// $list:属性值，例如：('color', 'white')</span>
    @each $typeColor, $list <span class="hljs-keyword">in</span> $typeMap {
      <span class="hljs-comment">// 调用 css-var-from-global 生成 CSS 变量</span>
      <span class="hljs-comment">// 例如：@include css-var-from-global(('button', 'hover', 'text-color'), ('color', 'white'));</span>
      @include css-<span class="hljs-keyword">var</span>-<span class="hljs-keyword">from</span>-<span class="hljs-title function_">global</span>((<span class="hljs-string">'button'</span>, $type, $typeColor), $list);
    }
  }

  &amp;.<span class="hljs-property">is</span>-plain,
  &amp;.<span class="hljs-property">is</span>-text,
  &amp;.<span class="hljs-property">is</span>-link {
    @include button-<span class="hljs-title function_">plain</span>($type);
  }
}

</code></pre>
<h2 data-id="heading-4">五、应用样式（最终渲染）</h2>
<p><em>位置：packages/theme-chalk/src/button.scss</em></p>
<pre><code class="hljs language-js" lang="js">@include <span class="hljs-title function_">b</span>(<span class="hljs-params">button</span>) {
  <span class="hljs-attr">display</span>: inline-flex;
  justify-<span class="hljs-attr">content</span>: center;
  align-<span class="hljs-attr">items</span>: center;

  line-<span class="hljs-attr">height</span>: <span class="hljs-number">1</span>;
  <span class="hljs-comment">// min-height will expand when in flex</span>
  <span class="hljs-attr">height</span>: map.<span class="hljs-title function_">get</span>($input-height, <span class="hljs-string">'default'</span>);
  white-<span class="hljs-attr">space</span>: nowrap;
  <span class="hljs-attr">cursor</span>: pointer;
  <span class="hljs-attr">color</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'button'</span>, <span class="hljs-string">'text-color'</span>);
  text-<span class="hljs-attr">align</span>: center;
  box-<span class="hljs-attr">sizing</span>: border-box;
  <span class="hljs-attr">outline</span>: none;
  <span class="hljs-attr">transition</span>: <span class="hljs-number">0.</span>1s;
  font-<span class="hljs-attr">weight</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'button'</span>, <span class="hljs-string">'font-weight'</span>);
  user-<span class="hljs-attr">select</span>: none;
  vertical-<span class="hljs-attr">align</span>: middle;
  -webkit-<span class="hljs-attr">appearance</span>: none;
  background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'button'</span>, <span class="hljs-string">'bg-color'</span>);
  <span class="hljs-attr">border</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'border'</span>);
  border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'button'</span>, <span class="hljs-string">'border-color'</span>);

  &amp;:hover {
    <span class="hljs-attr">color</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'button'</span>, <span class="hljs-string">'hover'</span>, <span class="hljs-string">'text-color'</span>);
    border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'button'</span>, <span class="hljs-string">'hover'</span>, <span class="hljs-string">'border-color'</span>);
    background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'button'</span>, <span class="hljs-string">'hover'</span>, <span class="hljs-string">'bg-color'</span>);
    <span class="hljs-attr">outline</span>: none;
  }
 
 <span class="hljs-comment">// 这些生成el-button的基础变量</span>
  ======================================================
 
   @each $type <span class="hljs-keyword">in</span> (primary, success, warning, danger, info) {
    @include <span class="hljs-title function_">m</span>(<span class="hljs-params">$type</span>) {
      @include button-<span class="hljs-title function_">variant</span>($type);
    }
  }

  
  <span class="hljs-comment">// $type = 'primary' 时，最终编译后的 CSS（.el-button--primary）：</span>
  .<span class="hljs-property">el</span>-button--primary {
  <span class="hljs-comment">/* 基础样式 */</span>
  <span class="hljs-attr">display</span>: inline-flex;
  justify-<span class="hljs-attr">content</span>: center;
  align-<span class="hljs-attr">items</span>: center;
  
  <span class="hljs-comment">/* 颜色（使用 CSS 变量） */</span>
  <span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-text-color);
  <span class="hljs-comment">/* ↓ 展开为 */</span>
  <span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-white);  <span class="hljs-comment">/* #ffffff */</span>
  
  background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-bg-color);
  <span class="hljs-comment">/* ↓ 展开为 */</span>
  background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary);  <span class="hljs-comment">/* #409eff */</span>
  
  border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-border-color);
  <span class="hljs-comment">/* ↓ 展开为 */</span>
  border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary);  <span class="hljs-comment">/* #409eff */</span>
}

.<span class="hljs-property">el</span>-button--<span class="hljs-attr">primary</span>:hover {
  background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-hover-bg-color);
  <span class="hljs-comment">/* ↓ 展开为 */</span>
  background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">3</span>);  <span class="hljs-comment">/* #79bbff */</span>
  
  border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-hover-border-color);
  <span class="hljs-comment">/* ↓ 展开为 */</span>
  border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">3</span>);  <span class="hljs-comment">/* #79bbff */</span>
}

.<span class="hljs-property">el</span>-button--<span class="hljs-attr">primary</span>:active {
  background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-active-bg-color);
  <span class="hljs-comment">/* ↓ 展开为 */</span>
  background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-dark-<span class="hljs-number">2</span>);  <span class="hljs-comment">/* #337ecc */</span>
  
  border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-active-border-color);
  <span class="hljs-comment">/* ↓ 展开为 */</span>
  border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-dark-<span class="hljs-number">2</span>);  <span class="hljs-comment">/* #337ecc */</span>
}
</code></pre>
<h2 data-id="heading-5">六、完整流程图</h2>
<pre><code class="hljs language-js" lang="js">┌─────────────────────────────────────────────────────────┐
│ 阶段 <span class="hljs-number">1</span>: 基础颜色定义                                     │
│ <span class="hljs-keyword">var</span>.<span class="hljs-property">scss</span>: primary.<span class="hljs-property">base</span> = #409eff                       │
└─────────────────┬───────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────┐
│ 阶段 <span class="hljs-number">2</span>: 自动生成颜色变体                                 │
│ set-color-mix-<span class="hljs-title function_">level</span>()                                   │
│ - primary.<span class="hljs-property">light</span>-<span class="hljs-number">3</span> = #79bbff (<span class="hljs-number">30</span>% 白色混合)             │
│ - primary.<span class="hljs-property">dark</span>-<span class="hljs-number">2</span> = #337ecc (<span class="hljs-number">20</span>% 黑色混合)              │
└─────────────────┬───────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────┐
│ 阶段 <span class="hljs-number">3</span>: 生成全局 <span class="hljs-variable constant_">CSS</span> 变量                                │
│ <span class="hljs-keyword">var</span>.<span class="hljs-property">scss</span>: :root {                                       │
│   --el-color-<span class="hljs-attr">primary</span>: #409eff                          │
│   --el-color-primary-light-<span class="hljs-number">3</span>: #79bbff                  │
│   --el-color-primary-dark-<span class="hljs-number">2</span>: #337ecc                    │
│ }                                                       │
└─────────────────┬───────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────┐
│ 阶段 <span class="hljs-number">4</span>: 按钮组件使用颜色                                  │
│ button-<span class="hljs-title function_">variant</span>(<span class="hljs-string">'primary'</span>)                                │
│ 生成组件级 <span class="hljs-variable constant_">CSS</span> 变量：                                     │
│ --el-button-bg-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary)           │
│ --el-button-hover-bg-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">3</span>)│
│ --el-button-active-bg-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-dark-<span class="hljs-number">2</span>)│
└─────────────────┬───────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────┐
│ 阶段 <span class="hljs-number">5</span>: 最终渲染                                         │
│ .<span class="hljs-property">el</span>-button--primary {                                   │
│   background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-bg-color);          │
│   <span class="hljs-comment">/* 浏览器解析为 #409eff */</span>                            │
│ }                                                       │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h2 data-id="heading-6">七、优势</h2>
<ul>
<li>统一管理：所有颜色在一个地方定义。</li>
</ul>

<ul>
<li>自动计算：light/dark 变体自动生成。</li>
</ul>

<ul>
<li>易于定制：修改基础色即可影响所有变体和组件。</li>
</ul>

<ul>
<li>性能：使用 CSS 变量，支持运行时动态切换主题。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析：基于 Prompt 演进策略的企业级自动化 Agent 架构设计]]></title>    <link>https://juejin.cn/post/7577905525997158441</link>    <guid>https://juejin.cn/post/7577905525997158441</guid>    <pubDate>2025-11-30T03:20:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577905525997158441" data-draft-id="7577704980855980086" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析：基于 Prompt 演进策略的企业级自动化 Agent 架构设计"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-30T03:20:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="念心之所向"/> <meta itemprop="url" content="https://juejin.cn/user/2681042882018763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析：基于 Prompt 演进策略的企业级自动化 Agent 架构设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2681042882018763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    念心之所向
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:20:05.000Z" title="Sun Nov 30 2025 03:20:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引言：从简单问答到复杂工作流的演进</h2>
<p>在人工智能技术快速发展的今天，我们正经历着从简单的问答交互向复杂工作流自动化的重大转变。想象一下，如果 AI 不仅能回答问题，还能像一位经验丰富的工程师那样，自动分析日志、诊断问题、修复配置并生成总结报告——这正是本文要探讨的自主工作流 Agent 所能实现的。</p>
<h3 data-id="heading-1">1.1 为什么需要自主工作流 Agent？</h3>
<p>在日常的运维和开发工作中，我们经常遇到这样的场景：系统出现异常时，工程师需要查看多个日志文件、分析错误模式、修改配置文件，最后记录修复过程。这个过程涉及多个步骤、多种工具，以及基于上下文的持续推理。传统的 AI 系统往往只能完成其中的单个步骤，而缺乏整体工作流的协调能力。</p>
<p><strong>核心挑战在于</strong>：如何让 AI 系统在长时间、多步骤的任务中保持目标的一致性？如何在复杂的工具调用序列中做出正确的决策？更重要的是，如何通过有效的 Prompt 设计来引导 AI 完成整个工作流？</p>
<h2 data-id="heading-2">2. 系统架构设计：MCP 协议的力量</h2>
<p>为了深入理解 Prompt 演进策略的设计原理，我们首先需要了解背后的系统架构。MCP（Model Context Protocol）协议为我们提供了一套标准化的交互框架，让 AI 系统能够有效地使用工具并保持上下文。</p>
<h3 data-id="heading-3">2.1 抽象交互流程：理解系统如何运作</h3>
<p>让我们通过一个生动的比喻来理解这个流程：把 AI Agent 想象成一位在图书馆中研究问题的学者，而 MCP 协议就是图书管理员的工作规范。</p>
<p>text</p>
<pre><code class="hljs language-arduino" lang="arduino">读者（用户）提出研究问题 → 学者（LLM <span class="hljs-built_in">Client</span>）
学者 → 向图书管理员（MCP <span class="hljs-built_in">Server</span>）咨询可用资源
图书管理员 → 提供图书馆目录和检索工具（Prompt 模板）
学者 → 制定研究计划 → 开始研究（调用 LLM）

学者需要某本书 → 向图书管理员请求（tool call）
图书管理员 → 找到书籍并交付（执行工具）
学者 → 阅读书籍内容 → 继续研究（继续推理）

学者遇到疑难 → 请求更多资料（sampling）
图书管理员 → 提供相关文献清单（采样请求）
学者 → 分析新资料 → 调整研究方向
</code></pre>
<p>这个比喻帮助我们理解：学者（AI）在整个过程中保持研究目标，而图书管理员（MCP Server）提供必要的资源支持，两者通过标准化的协议协同工作。</p>
<h3 data-id="heading-4">2.2 具体示例场景：为什么选择这个案例？</h3>
<p>为了具象化地讲解 Prompt 演进策略，我们设计了一个典型的运维场景。这个场景不是随意选择的，而是因为它包含了自主工作流 Agent 需要面对的几个关键挑战：</p>
<ol>
<li><strong>多步骤性</strong>：需要依次执行文件列表、内容搜索、配置读取和修改</li>
<li><strong>上下文依赖性</strong>：后续决策依赖于前序步骤的结果</li>
<li><strong>推理需求</strong>：需要从分散的证据中识别模式并做出诊断</li>
<li><strong>动作执行</strong>：最终要执行具体的修改操作</li>
</ol>
<p><strong>用户需求</strong>："分析 /project/logs 下最近 24 小时的错误，修复 /project/config.yaml 中相关配置，并生成修复总结。"</p>
<blockquote>
<p><strong>技术说明</strong>：为了简化示例和聚焦于核心的 Prompt 演进策略，我们在本文中暂不实现精确的 24 小时时间过滤。在实际生产环境中，可以通过以下方式实现：</p>
<ol>
<li>在 <code>grep</code> 工具中增加时间范围参数</li>
<li>添加专门的 <code>filter_logs_by_time</code> 工具</li>
<li>或者在日志文件名中体现日期信息供 Agent 识别</li>
</ol>
</blockquote>
<p>这个需求看似简单，但深入分析会发现，它隐含着复杂的工作流：首先要了解有哪些日志文件，然后搜索错误信息，接着分析错误模式，读取当前配置，基于证据做出修改决策，最后验证结果并生成报告。</p>
<h3 data-id="heading-5">2.3 工具设计：为任务量身定制</h3>
<p>基于对任务需求的分析，我们设计了专门的工具集。这些工具不是预先存在的，而是为了满足特定任务需求而精心设计的：</p>
<ul>
<li><strong><code>list_files(path)</code></strong> ：为什么需要这个工具？因为 Agent 首先需要了解可用的日志文件，而不是假设文件结构</li>
<li><strong><code>grep(path, keyword)</code></strong> ：为什么不是简单的文件读取？因为日志文件可能很大，需要针对性搜索错误信息</li>
<li><strong><code>read_file(path)</code></strong> ：用于读取配置文件，了解当前设置</li>
<li><strong><code>write_file(path, content)</code></strong> ：执行具体的修复操作</li>
</ul>
<p>每个工具的设计都考虑了任务的特性和 Agent 的决策需求。比如 <code>grep</code> 工具返回结构化的结果（包含时间戳和具体内容），而不是原始文本，这是为了便于后续的模式分析。</p>
<h2 data-id="heading-6">3. Prompt 工程的艺术：从静态到动态演进</h2>
<p>现在，让我们进入本文的核心：Prompt 的演进策略。传统的 Prompt 工程往往关注单次的交互优化，而自主工作流需要的是动态的、基于上下文的 Prompt 演进。</p>
<h3 data-id="heading-7">3.1 恒定基础：System Prompt 的设计哲学</h3>
<p>System Prompt 是 Agent 行为的"宪法"，它在整个工作流中保持不变，确保行为的一致性。让我们深入分析其设计考量：</p>
<p>json</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, 
  <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个自主工作流智能体（Agent），能够规划并执行多步任务，并使用授权工具完成操作。<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>【输出格式】<span class="hljs-subst">\n</span>1) 必须严格输出 JSON，顶层对象必须包含以下字段：<span class="hljs-subst">\n</span>{<span class="hljs-subst">\n</span>  "</span>action<span class="hljs-string">": "</span><span class="hljs-operator">&lt;</span>tool<span class="hljs-operator">|</span>finish<span class="hljs-operator">|</span>ask<span class="hljs-operator">&gt;</span><span class="hljs-string">",<span class="hljs-subst">\n</span>  "</span>next_step<span class="hljs-string">": null | { "</span>tool<span class="hljs-string">": "</span><span class="hljs-operator">&lt;</span>tool_name<span class="hljs-operator">&gt;</span><span class="hljs-string">", "</span>arguments<span class="hljs-string">": { ... } },<span class="hljs-subst">\n</span>  "</span>notes<span class="hljs-string">": "</span><span class="hljs-operator">&lt;</span>给人类的简短说明<span class="hljs-operator">&gt;</span><span class="hljs-string">"<span class="hljs-subst">\n</span>}<span class="hljs-subst">\n</span>- action=tool → 表示下一步要调用工具<span class="hljs-subst">\n</span>- action=finish → 表示任务完成，最终结果写入 notes<span class="hljs-subst">\n</span>- action=ask → 需要用户澄清，notes 写问题说明<span class="hljs-subst">\n</span>- next_step=null → 表示本轮不调用工具<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>【可用工具】<span class="hljs-subst">\n</span>你只能使用已注册的工具，每个工具执行单一操作：<span class="hljs-subst">\n</span>- list_files(path)：列出目录中的文件<span class="hljs-subst">\n</span>- read_file(path)：读取文件内容<span class="hljs-subst">\n</span>- grep(path, keyword)：搜索文件关键字<span class="hljs-subst">\n</span>- write_file(path, content)：写入文件内容，返回 {ok:true}<span class="hljs-subst">\n</span>（注意：运行时将提供工具完整 schema，确保调用时使用正确的工具名和参数）<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>【上下文与规则】<span class="hljs-subst">\n</span>- 始终参考完整历史上下文（系统 Prompt + 用户输入 + 之前的 agent 动作 + 工具结果）<span class="hljs-subst">\n</span>- 工具结果为权威信息<span class="hljs-subst">\n</span>- 保留 session_id，不要修改<span class="hljs-subst">\n</span>- 不得调用未注册工具<span class="hljs-subst">\n</span>- 不输出敏感或私密信息，可摘要或脱敏<span class="hljs-subst">\n</span>- 如果无法生成有效 JSON 或不确定，返回：<span class="hljs-subst">\n</span>  {"</span>action<span class="hljs-string">":"</span>ask<span class="hljs-string">","</span>next_step<span class="hljs-string">":null,"</span>notes<span class="hljs-string">":"</span>需要澄清: <span class="hljs-operator">...</span><span class="hljs-string">"} <span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>【示例】<span class="hljs-subst">\n</span>示例1：<span class="hljs-subst">\n</span>{"</span>action<span class="hljs-string">":"</span>tool<span class="hljs-string">","</span>next_step<span class="hljs-string">":{"</span>tool<span class="hljs-string">":"</span>list_files<span class="hljs-string">","</span>arguments<span class="hljs-string">":{"</span>path<span class="hljs-string">":"</span><span class="hljs-operator">/</span>project<span class="hljs-operator">/</span>logs<span class="hljs-string">"}},"</span>notes<span class="hljs-string">":"</span>列出日志目录文件<span class="hljs-string">"}<span class="hljs-subst">\n</span>示例2：<span class="hljs-subst">\n</span>{"</span>action<span class="hljs-string">":"</span>finish<span class="hljs-string">","</span>next_step<span class="hljs-string">":null,"</span>notes<span class="hljs-string">":"</span>已发现 <span class="hljs-number">3</span> 个错误，修改了配置文件 max_connections 和 timeout_ms<span class="hljs-string">"}"</span>
}
</code></pre>
<p>这个 System Prompt 的每个部分都经过精心设计：</p>
<ul>
<li><strong>中文界面友好</strong>：面向中文用户，提供清晰易懂的指导</li>
<li><strong>严格的 JSON 输出格式</strong>：确保机器可解析性，使系统能够可靠地提取动作指令</li>
<li><strong>明确的动作类型</strong>：<code>tool|finish|ask</code> 覆盖了所有可能的状态转换</li>
<li><strong>错误处理机制</strong>：特别强调当不确定时使用 <code>ask</code> 动作，这是健壮性的关键</li>
</ul>
<h2 data-id="heading-8">3.2 动态演进：Prompt 如何随着证据积累而成长</h2>
<p>Prompt 演进的核心思想是：<strong>每一步的决策都基于前序步骤积累的证据</strong>。让我们通过完整的交互序列来理解这个演进过程。</p>
<h3 data-id="heading-9">阶段一：探索与发现（初始规划 → 工具调用）</h3>
<p><strong>初始 Prompt</strong>：</p>
<p>json</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"&lt;恒定 system prompt&gt;"</span>},  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用户目标：分析 /project/logs 最近 24 小时的错误，修复 /project/config.yaml 中相关配置，并生成修复总结。"</span>},  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"可用资源：/project/logs (目录), /project/config.yaml (文件)。工具：list_files, read_file, grep, write_file。"</span>}]</span>
</code></pre>
<p><strong>LLM 响应</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"next_step"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tool"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"list_files"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/project/logs"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"notes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"首先探索日志目录，了解可用的日志文件"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>工具执行结果</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"/project/logs/app.log"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"/project/logs/db.log"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-10">阶段二：深度调查（逐步分析多个日志文件）</h3>
<p><strong>重要说明</strong>：LLM 不会一次性返回多个工具调用。它会基于前一个工具的结果，逐步决定下一步行动。这就是"grep × 2"的含义——需要两次独立的决策和执行循环。</p>
<h4 data-id="heading-11">第一次 grep 决策循环</h4>
<p><strong>演进后的 Prompt</strong>：</p>
<p>json</p>
<pre><code class="hljs language-bash" lang="bash">[
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"&lt;恒定 system prompt&gt;"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用户目标：分析 /project/logs 最近 24 小时的错误..."</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"可用资源：/project/logs (目录), /project/config.yaml (文件)。工具：list_files, read_file, grep, write_file。"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>action<span class="hljs-string">":"</span>tool<span class="hljs-string">","</span>next_step<span class="hljs-string">":{"</span>tool<span class="hljs-string">":"</span>list_files<span class="hljs-string">","</span>arguments<span class="hljs-string">":{"</span>path<span class="hljs-string">":"</span>/project/logs<span class="hljs-string">"}},"</span>notes<span class="hljs-string">":"</span>首先探索日志目录，了解可用的日志文件<span class="hljs-string">"}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"list_files"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>files<span class="hljs-string">": ["</span>/project/logs/app.log<span class="hljs-string">", "</span>/project/logs/db.log<span class="hljs-string">"]}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool-observation"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"发现两个日志文件：app.log 和 db.log。请决定下一步操作。"</span>}
]
</code></pre>
<p><strong>LLM 响应</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"next_step"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tool"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"grep"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/project/logs/app.log"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"keyword"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ERROR"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"notes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"先检查 app.log 中的错误信息"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>工具执行结果</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/project/logs/app.log"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"ts"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-11-28T10:34:22"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ERROR Failed to connect to DB"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"ts"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-11-28T11:02:10"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ERROR Timeout occurred in module X"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-12">第二次 grep 决策循环</h4>
<p><strong>再次演进的 Prompt</strong>：</p>
<p>json</p>
<pre><code class="hljs language-lua" lang="lua">[
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"&lt;恒定 system prompt&gt;"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用户目标：分析 /project/logs 最近 24 小时的错误..."</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"可用资源：/project/logs (目录), /project/config.yaml (文件)。工具：list_files, read_file, grep, write_file。"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>action<span class="hljs-string">":"</span>tool<span class="hljs-string">","</span>next_step<span class="hljs-string">":{"</span>tool<span class="hljs-string">":"</span>list_files<span class="hljs-string">","</span>arguments<span class="hljs-string">":{"</span><span class="hljs-built_in">path</span><span class="hljs-string">":"</span>/project/logs<span class="hljs-string">"}},"</span>notes<span class="hljs-string">":"</span>首先探索日志目录，了解可用的日志文件<span class="hljs-string">"}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"list_files"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>files<span class="hljs-string">": ["</span>/project/logs/app.<span class="hljs-built_in">log</span><span class="hljs-string">", "</span>/project/logs/db.<span class="hljs-built_in">log</span><span class="hljs-string">"]}"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>action<span class="hljs-string">":"</span>tool<span class="hljs-string">","</span>next_step<span class="hljs-string">":{"</span>tool<span class="hljs-string">":"</span>grep<span class="hljs-string">","</span>arguments<span class="hljs-string">":{"</span><span class="hljs-built_in">path</span><span class="hljs-string">":"</span>/project/logs/app.<span class="hljs-built_in">log</span><span class="hljs-string">","</span>keyword<span class="hljs-string">":"</span>ERROR<span class="hljs-string">"}},"</span>notes<span class="hljs-string">":"</span>先检查 app.<span class="hljs-built_in">log</span> 中的错误信息<span class="hljs-string">"}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"grep"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span><span class="hljs-built_in">path</span><span class="hljs-string">": "</span>/project/logs/app.<span class="hljs-built_in">log</span><span class="hljs-string">", "</span>matches<span class="hljs-string">": [{"</span>ts<span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-28</span>T10:<span class="hljs-number">34</span>:<span class="hljs-number">22</span><span class="hljs-string">", "</span>line<span class="hljs-string">": "</span>ERROR Failed to connect to DB<span class="hljs-string">"}, {"</span>ts<span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-28</span>T11:<span class="hljs-number">02</span>:<span class="hljs-number">10</span><span class="hljs-string">", "</span>line<span class="hljs-string">": "</span>ERROR Timeout occurred <span class="hljs-keyword">in</span> <span class="hljs-built_in">module</span> X<span class="hljs-string">"}]}"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool-observation"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"在 app.log 中发现 2 个错误，包括数据库连接失败和超时错误。请决定是否检查 db.log 以获得完整情况。"</span>}
]
</code></pre>
<p><strong>LLM 响应</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"next_step"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tool"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"grep"</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/project/logs/db.log"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"keyword"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ERROR"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"notes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"继续检查 db.log 以获取完整的错误画面"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>工具执行结果</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/project/logs/db.log"</span><span class="hljs-punctuation">,</span> 
  <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"ts"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-11-28T09:28:01"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ERROR Connection pool exhausted"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-13">阶段三：诊断与决策（分析根本原因）</h3>
<p><strong>完整演进的 Prompt</strong>：</p>
<p>json</p>
<pre><code class="hljs language-python" lang="python">[
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"&lt;恒定 system prompt&gt;"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用户目标：分析 /project/logs 最近 24 小时的错误..."</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"可用资源：/project/logs (目录), /project/config.yaml (文件)。工具：list_files, read_file, grep, write_file。"</span>},
  
  // 历史交互记录
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>action<span class="hljs-string">":"</span>tool<span class="hljs-string">","</span>next_step<span class="hljs-string">":{"</span>tool<span class="hljs-string">":"</span>list_files<span class="hljs-string">","</span>arguments<span class="hljs-string">":{"</span>path<span class="hljs-string">":"</span>/project/logs<span class="hljs-string">"}},"</span>notes<span class="hljs-string">":"</span>首先探索日志目录，了解可用的日志文件<span class="hljs-string">"}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"list_files"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>files<span class="hljs-string">": ["</span>/project/logs/app.log<span class="hljs-string">", "</span>/project/logs/db.log<span class="hljs-string">"]}"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>action<span class="hljs-string">":"</span>tool<span class="hljs-string">","</span>next_step<span class="hljs-string">":{"</span>tool<span class="hljs-string">":"</span>grep<span class="hljs-string">","</span>arguments<span class="hljs-string">":{"</span>path<span class="hljs-string">":"</span>/project/logs/app.log<span class="hljs-string">","</span>keyword<span class="hljs-string">":"</span>ERRO<span class="hljs-string">R"}},"</span>notes<span class="hljs-string">":"</span>先检查 app.log 中的错误信息<span class="hljs-string">"}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"grep"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>path<span class="hljs-string">": "</span>/project/logs/app.log<span class="hljs-string">", "</span>matches<span class="hljs-string">": [{"</span>ts<span class="hljs-string">": "</span><span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-28T10:<span class="hljs-number">34</span>:<span class="hljs-number">22</span><span class="hljs-string">", "</span>line<span class="hljs-string">": "</span>ERROR Failed to connect to D<span class="hljs-string">B"}, {"</span>ts<span class="hljs-string">": "</span><span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-28T11:02:<span class="hljs-number">10</span><span class="hljs-string">", "</span>line<span class="hljs-string">": "</span>ERROR Timeout occurred <span class="hljs-keyword">in</span> module X<span class="hljs-string">"}]}"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>action<span class="hljs-string">":"</span>tool<span class="hljs-string">","</span>next_step<span class="hljs-string">":{"</span>tool<span class="hljs-string">":"</span>grep<span class="hljs-string">","</span>arguments<span class="hljs-string">":{"</span>path<span class="hljs-string">":"</span>/project/logs/db.log<span class="hljs-string">","</span>keyword<span class="hljs-string">":"</span>ERRO<span class="hljs-string">R"}},"</span>notes<span class="hljs-string">":"</span>继续检查 db.log 以获取完整的错误画面<span class="hljs-string">"}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"grep"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>path<span class="hljs-string">": "</span>/project/logs/db.log<span class="hljs-string">", "</span>matches<span class="hljs-string">": [{"</span>ts<span class="hljs-string">": "</span><span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-28T09:<span class="hljs-number">28</span>:01<span class="hljs-string">", "</span>line<span class="hljs-string">": "</span>ERROR Connection pool exhausted<span class="hljs-string">"}]}"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool-observation"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"在多个日志中发现数据库相关错误：app.log 中有数据库连接失败和超时错误，db.log 中有连接池耗尽错误。请分析根本原因。"</span>}
]
</code></pre>
<p><strong>LLM 响应</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"next_step"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tool"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"read_file"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/project/config.yaml"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"notes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"多个日志都指向数据库连接问题，需要检查当前数据库配置以确定根本原因"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>工具执行结果</strong>：</p>
<p>json</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"path"</span>: <span class="hljs-string">"/project/config.yaml"</span>,
  <span class="hljs-string">"content"</span>: <span class="hljs-string">"port: 8080<span class="hljs-subst">\n</span>log: info<span class="hljs-subst">\n</span>max_connections: 50<span class="hljs-subst">\n</span>timeout_ms: 1000"</span>
}
</code></pre>
<h3 data-id="heading-14">阶段四：修复执行（基于证据的配置修改）</h3>
<p><strong>进一步演进的 Prompt</strong>：</p>
<p>json</p>
<pre><code class="hljs language-lua" lang="lua">[
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"&lt;恒定 system prompt&gt;"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用户目标：分析 /project/logs 最近 24 小时的错误..."</span>},
  
  // 简化的历史记录（实际可能进行摘要处理）
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"grep"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span><span class="hljs-built_in">path</span><span class="hljs-string">": "</span>/project/logs/app.<span class="hljs-built_in">log</span><span class="hljs-string">", "</span>matches<span class="hljs-string">": [{"</span>ts<span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-28</span>T10:<span class="hljs-number">34</span>:<span class="hljs-number">22</span><span class="hljs-string">", "</span>line<span class="hljs-string">": "</span>ERROR Failed to connect to DB<span class="hljs-string">"}, ...]}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"grep"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span><span class="hljs-built_in">path</span><span class="hljs-string">": "</span>/project/logs/db.<span class="hljs-built_in">log</span><span class="hljs-string">", "</span>matches<span class="hljs-string">": [{"</span>ts<span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-28</span>T09:<span class="hljs-number">28</span>:<span class="hljs-number">01</span><span class="hljs-string">", "</span>line<span class="hljs-string">": "</span>ERROR Connection pool exhausted<span class="hljs-string">"}]}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"read_file"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span><span class="hljs-built_in">path</span><span class="hljs-string">": "</span>/project/<span class="hljs-built_in">config</span>.yaml<span class="hljs-string">", "</span>content<span class="hljs-string">": "</span>port: <span class="hljs-number">8080</span>\nlog: info\nmax_connections: <span class="hljs-number">50</span>\ntimeout_ms: <span class="hljs-number">1000</span><span class="hljs-string">"}"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool-observation"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"获得完整证据链：日志显示数据库连接问题和连接池耗尽，当前配置为 max_connections: 50, timeout_ms: 1000。请提出修复方案。"</span>}
]
</code></pre>
<p><strong>LLM 响应</strong>：</p>
<p>json</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"action"</span>: <span class="hljs-string">"tool"</span>,
  <span class="hljs-string">"next_step"</span>: {
    <span class="hljs-string">"tool"</span>: <span class="hljs-string">"write_file"</span>,
    <span class="hljs-string">"arguments"</span>: {
      <span class="hljs-string">"path"</span>: <span class="hljs-string">"/project/config.yaml"</span>,
      <span class="hljs-string">"content"</span>: <span class="hljs-string">"port: 8080<span class="hljs-subst">\n</span>log: info<span class="hljs-subst">\n</span>max_connections: 100<span class="hljs-subst">\n</span>timeout_ms: 5000"</span>
    }
  },
  <span class="hljs-string">"notes"</span>: <span class="hljs-string">"基于错误证据，将最大连接数从 50 增加到 100，超时时间从 1000ms 增加到 5000ms 以解决连接池耗尽和超时问题"</span>
}
</code></pre>
<p><strong>工具执行结果</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"success"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/project/config.yaml"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-15">阶段五：总结验证（任务完成）</h3>
<p><strong>最终 Prompt</strong>：</p>
<p>json</p>
<pre><code class="hljs language-arduino" lang="arduino">[
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"&lt;恒定 system prompt&gt;"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用户目标：分析 /project/logs 最近 24 小时的错误..."</span>},
  
  <span class="hljs-comment">// 关键历史记录</span>
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"write_file"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>result<span class="hljs-string">": "</span>success<span class="hljs-string">", "</span>path<span class="hljs-string">": "</span>/project/config.yaml<span class="hljs-string">"}"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool-observation"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"配置文件更新成功。请生成任务总结。"</span>}
]
</code></pre>
<p><strong>LLM 最终响应</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"finish"</span><span class="hljs-punctuation">,</span> 
  <span class="hljs-attr">"next_step"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"notes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"任务完成。分析结果：在 app.log 中发现 2 个错误（数据库连接失败、超时），在 db.log 中发现 1 个错误（连接池耗尽）。修复措施：将 max_connections 从 50 增加到 100，timeout_ms 从 1000 增加到 5000。建议：监控系统 24 小时，如问题持续需进一步调查数据库服务器状态。"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-16">4. 关键技术细节：让系统更加健壮</h2>
<h3 data-id="heading-17">4.1 错误处理：当事情不如预期时</h3>
<p>在真实环境中，工具执行可能会失败，AI 的响应可能不符合预期。我们的 Prompt 演进策略需要包含健壮的错误处理机制。</p>
<p><strong>正确的错误处理流程</strong>：</p>
<p>假设 <code>grep</code> 工具执行时遇到文件不存在的错误，系统会返回：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"File not found: /project/logs/app.log"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"suggestion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Check if the file path is correct"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这时，Prompt 会演进为：</p>
<p>json</p>
<pre><code class="hljs language-python" lang="python">[
  // ... 历史上下文
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"grep"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>erro<span class="hljs-string">r": "</span>File <span class="hljs-keyword">not</span> found: /project/logs/app.log<span class="hljs-string">"}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool-observation"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"grep 执行失败：文件不存在。请基于此错误调整策略"</span>}
]
</code></pre>
<p><strong>正确的 Agent 响应应该是</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ask"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"next_step"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"notes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"尝试读取 /project/logs/app.log 时发现文件不存在。请确认：1) 文件路径是否正确？2) 是否有其他日志文件需要检查？"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这种设计体现了 System Prompt 中强调的原则：当遇到不确定或无法自动解决的问题时，明智地使用 <code>ask</code> 动作寻求用户指导，而不是盲目重试或做出可能错误的假设。</p>
<p><strong>基于错误调整策略</strong>：在某些可自动恢复的错误情况下，Agent 可能会决定先检查文件是否存在，或者尝试其他日志文件。</p>
<p><strong>提供备选方案</strong>：如果多个工具都失败，Agent 应该能够生成备选方案，比如建议手动检查文件权限。</p>
<h3 data-id="heading-18">4.2 上下文管理：在深度与效率间平衡</h3>
<p>随着工作流的进行，Prompt 会变得越来越长。我们需要智能的上下文管理策略：</p>
<ul>
<li><strong>完整历史模式</strong>：在开发阶段保留所有交互，便于理解和调试 Agent 的推理过程</li>
<li><strong>摘要模式</strong>：在生产环境中，对早期步骤生成智能摘要，保留关键决策点和证据，同时控制 token 数量</li>
</ul>
<h2 data-id="heading-19">5. 完整工作流演示：看着思维如何展开</h2>
<h3 data-id="heading-20">5.1 阶段映射：理解每个步骤的意义</h3>
<p>让我们通过一个详细的表格来可视化整个工作流中 Prompt 的演进过程：</p>















































<table><thead><tr><th>阶段</th><th>主要动作</th><th>决策关键点</th><th>Prompt 演进策略</th><th>具体示例说明</th></tr></thead><tbody><tr><td><strong>探索发现</strong></td><td>list_files</td><td>了解任务环境</td><td>提供目标上下文，引导系统探索</td><td>Agent 发现 <code>/project/logs</code> 下有 app.log 和 db.log 两个文件</td></tr><tr><td><strong>深度调查</strong></td><td>grep × 2</td><td>错误模式识别</td><td>注入多源证据，促进关联分析</td><td>先查 app.log 发现 DB 连接错误，再查 db.log 发现连接池耗尽，关联识别数据库问题</td></tr><tr><td><strong>根本原因分析</strong></td><td>read_file</td><td>配置与问题的因果关系</td><td>提供完整证据链，支持诊断决策</td><td>读取 config.yaml 发现 max_connections: 50 和 timeout_ms: 1000 的配置不足</td></tr><tr><td><strong>修复执行</strong></td><td>write_file</td><td>具体修改方案生成</td><td>基于证据生成精确的操作参数</td><td>将配置修改为 max_connections: 100 和 timeout_ms: 5000</td></tr><tr><td><strong>总结验证</strong></td><td>finish</td><td>工作流完成确认</td><td>引导系统性总结和经验提炼</td><td>生成包含错误统计、修改内容和监控建议的完整报告</td></tr></tbody></table>
<h3 data-id="heading-21">5.2 决策节点分析：Prompt 如何引导推理</h3>
<p>在每个决策节点，Prompt 的设计都旨在引导特定的推理模式：</p>
<p><strong>在获得部分证据时</strong>：</p>
<ul>
<li>Prompt 提示："已从 app.log 中发现 X 个错误，是否检查 db.log 以获得完整情况？"</li>
<li>设计意图：引导系统考虑证据的完备性，而不是过早下结论</li>
</ul>
<p><strong>在获得完整证据时</strong>：</p>
<ul>
<li>Prompt 提示："基于所有日志中的错误模式，请分析根本原因"</li>
<li>设计意图：促进系统进行综合分析和模式识别</li>
</ul>
<h2 data-id="heading-22">6. 关键理解点总结</h2>
<ol>
<li><strong>逐步决策</strong>：LLM 每次只决定下一步动作，不会一次性规划所有步骤</li>
<li><strong>证据驱动</strong>：每个决策都基于前一个工具的实际返回结果</li>
<li><strong>上下文累积</strong>：Prompt 随着每个工具调用和返回而不断演进</li>
<li><strong>模式识别</strong>：通过多个 grep 结果的对比，LLM 能够识别跨文件的共同问题模式</li>
<li><strong>错误恢复</strong>：通过恰当的 <code>ask</code> 动作设计，确保系统在遇到困难时能够优雅地寻求帮助</li>
</ol>
<p>这种逐步演进的方式确保了决策的准确性和基于实际证据的可靠性，而不是基于假设或预设路径。</p>
<h2 data-id="heading-23">7. 总结：Prompt 演进的艺术与科学</h2>
<p>通过本文的详细分析，我们可以看到，优秀的自主工作流 Agent 不是通过复杂的算法实现的，而是通过精心设计的 Prompt 演进策略。</p>
<h3 data-id="heading-24">7.1 核心洞察</h3>
<ol>
<li><strong>起步于清晰</strong>：初始 Prompt 提供明确的任务边界和工具集，为整个工作流奠定基础</li>
<li><strong>演进于证据</strong>：每一步都基于前序结果，形成累积的知识建构</li>
<li><strong>决策于模式</strong>：通过多源证据的注入，引导系统识别模式而非处理孤立信息</li>
<li><strong>透明于过程</strong>：每个决策都有明确的理由记录，便于理解和审计</li>
<li><strong>健壮于错误</strong>：通过恰当的 <code>ask</code> 动作设计，确保系统在遇到困难时能够优雅地寻求帮助</li>
</ol>
<h3 data-id="heading-25">7.2 实践指导</h3>
<p>当您设计自己的自主工作流系统时，请考虑：</p>
<ul>
<li><strong>工具设计的针对性</strong>：工具应该为任务而生，而不是让任务适应工具</li>
<li><strong>证据的结构化</strong>：工具输出应该便于机器解析和模式识别</li>
<li><strong>上下文的渐进性</strong>：Prompt 应该像好老师一样，基于学生当前的理解水平提供适当的指导</li>
<li><strong>错误的建设性</strong>：错误处理不是简单的重试，而是基于新信息的策略调整，必要时寻求用户指导</li>
</ul>
<p>自主工作流 Agent 的技术正在快速发展，而良好的 Prompt 演进策略是实现其真正实用化的关键。通过本文阐述的方法，您应该能够设计出更加智能、可靠的 AI 系统，让它们真正成为工作中的得力助手。</p>
<p>记住，最好的 Prompt 设计不是控制 AI 的每一步动作，而是为它提供一个良好的思维环境，让它在正确的约束下展现出令人惊喜的智能行为。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch BKD 树与 PointRangeQuery：为何数值查询会有性能瓶颈]]></title>    <link>https://juejin.cn/post/7577705544876064806</link>    <guid>https://juejin.cn/post/7577705544876064806</guid>    <pubDate>2025-11-30T09:38:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544876064806" data-draft-id="7577971299743023142" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch BKD 树与 PointRangeQuery：为何数值查询会有性能瓶颈"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T09:38:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Penge666"/> <meta itemprop="url" content="https://juejin.cn/user/1549628692501449"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch BKD 树与 PointRangeQuery：为何数值查询会有性能瓶颈
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549628692501449/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Penge666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:38:12.000Z" title="Sun Nov 30 2025 09:38:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Elasticsearch（ES）中，字符串类型（keyword）和数值 / 日期类型的索引结构截然不同 —— 前者用倒排索引，后者则依赖 BKD 树。这种差异源于查询场景的不同：数值 / 日期查询多为范围匹配，而 BKD 树天生适配这类需求。但鲜为人知的是，BKD 树在高效定位数据的同时，也暗藏着 Bitset 构造的性能瓶颈。本文将结合具体场景，拆解 BKD 树、PointRangeQuery 的执行逻辑，以及性能瓶颈的根源。</p>
<h2 data-id="heading-0">一、BKD 树：数值类型的 “专属索引”</h2>
<h3 data-id="heading-1">1. 为何不用倒排索引？</h3>
<p>对于<code>publish_time</code>这类日期字段的范围查询（如<code>&gt;=1748419000</code>），倒排索引会显得力不从心：它需要遍历所有时间戳词条，逐一匹配范围，效率极低。而 BKD 树（Block K-D tree）是一种<strong>空间划分树</strong>，能快速定位数值范围内的数据，成为数值 / 日期类型的最优选择。</p>
<h3 data-id="heading-2">2. BKD 树的核心结构</h3>
<p>BKD 树将数值 / 日期值按范围切分为多个<strong>Block（块）</strong> ，每个 Block 包含：</p>
<ul>
<li>有序的数值（如时间戳递增排列）；</li>
<li>对应数值的文档 ID（docid）列表。</li>
</ul>
<p>树的上层节点记录每个 Block 的数值范围，查询时先通过上层节点定位目标 Block，再扫描 Block 内数据，避免全量遍历。</p>
<h2 data-id="heading-3">二、场景还原：100 万文档的日期范围查询</h2>
<p>假设我们有一个<code>news</code>索引，包含 100 万篇文档，<code>publish_time</code>为 date 类型（存储时间戳），采用 ES 默认的 BKD 树结构。现在执行查询：<code>publish_time &gt;= 1748419000 AND publish_time &lt;= 1748505400</code>（2025 年 6 月 1 日～6 月 2 日）。</p>
<h3 data-id="heading-4">1. BKD 树的 Block 拆分</h3>
<p>ES 会将<code>publish_time</code>的时间戳按范围拆分为多个 Block，示例如下：</p>
<ul>
<li><strong>Block A</strong>：1748400000 ~ 1748450000 → docid 列表：<code>[5, 2, 9, 13, 7, ...]</code>（1.2 万篇）；</li>
<li><strong>Block B</strong>：1748450001 ~ 1748500000 → docid 列表：<code>[31, 18, 45, 22, ...]</code>（1.5 万篇）；</li>
<li><strong>Block C</strong>：1748500001 ~ 1748550000 → docid 列表：<code>[56, 72, 39, 88, ...]</code>（0.8 万篇）。</li>
</ul>
<p>每个 Block 内的<strong>时间戳有序</strong>（如 Block A 从 1748400000 递增到 1748450000），但<strong>docid 无序</strong>（文档写入顺序与时间戳无关）。</p>
<h2 data-id="heading-5">三、PointRangeQuery 的执行流程：高效定位与低效合并</h2>
<p>当执行范围查询时，ES 会将其转为<code>PointRangeQuery</code>，执行过程分为三步：</p>
<h3 data-id="heading-6">1. 定位目标 Block</h3>
<p><code>PointRangeQuery</code>先遍历 BKD 树的上层节点，快速匹配出与查询范围重叠的 Block—— 本例中为 A、B、C 三个 Block。</p>
<h3 data-id="heading-7">2. 提取匹配的 docid</h3>
<p>遍历每个 Block，筛选出时间戳符合条件的 docid：</p>
<ul>
<li>Block A：1748419000 ~ 1748450000 → docid 列表：<code>[5, 9, 13, 7, ...]</code>（0.8 万篇）；</li>
<li>Block B：1748450001 ~ 1748500000 → docid 列表：<code>[31, 45, 22, ...]</code>（1.5 万篇）；</li>
<li>Block C：1748500001 ~ 1748505400 → docid 列表：<code>[56, 39, ...]</code>（0.3 万篇）。</li>
</ul>
<p>这些 docid 列表是<strong>无序的</strong>（如 Block A 的<code>[5,9,13,7...]</code>）。</p>
<h3 data-id="heading-8">3. Bitset 构造：性能瓶颈的根源</h3>
<p>由于 docid 无序，无法用高效的 “跳表合并”（依赖有序性），ES 只能退而求其次 —— 为每个 Block 构造<strong>Bitset（位图）</strong> ，再通过位运算合并结果：</p>
<ul>
<li><strong>Block A 的 Bitset</strong>：初始化长度为 100 万的位图（对应所有文档 ID），将<code>5、9、13、7...</code>位置设为 1 → 占用约 122KB 内存；</li>
<li><strong>Block B/C 的 Bitset</strong>：同理，各占用 122KB 内存；</li>
<li><strong>位运算合并</strong>：对三个 Bitset 执行 OR 运算（范围查询是 “或” 逻辑），得到最终匹配的 docid 集合。</li>
</ul>
<h2 data-id="heading-9">四、性能瓶颈的具体体现</h2>
<h3 data-id="heading-10">1. Bitset 构造的开销</h3>
<ul>
<li><strong>内存分配</strong>：每个 Bitset 需分配与索引最大 docid 匹配的内存空间（本例 100 万 docid 对应 122KB），若查询命中 10 个 Block，内存开销会增至 1.2MB；</li>
<li><strong>docid 置位耗时</strong>：Block A 需循环 0.8 万次置位，三个 Block 总计 2.6 万次操作 —— 百万级文档场景下，这个过程会显著耗时。</li>
</ul>
<h3 data-id="heading-11">2. 无序 docid 的致命影响</h3>
<p>若 Block 内的 docid 是有序的（如<code>[2,5,7,9,13...]</code>），ES 可通过 “跳表合并”（双指针遍历）直接合并多个列表，无需构造 Bitset，速度能提升 3-5 倍。但 BKD 树按数值有序组织 Block，而非 docid 有序，导致这一优化无法实现。</p>
<h3 data-id="heading-12">3. 磁盘 IO 的叠加效应</h3>
<p>若 Block 未被缓存到内存，ES 需先从磁盘加载 Block 数据，再提取 docid 构造 Bitset—— 磁盘 IO 延迟会进一步放大性能瓶颈，使查询耗时翻倍。</p>
<h2 data-id="heading-13">五、如何突破性能瓶颈？</h2>
<ul>
<li>
<ol>
<li>预过滤缩小 docid 范围</li>
</ol>
</li>
<li>
<ol start="2">
<li>减少 Block 命中数量</li>
</ol>
<ul>
<li><strong>调整 BKD 树 Block 大小</strong>：增大 Block 可减少 Block 数量（如将默认 Block 大小从 4KB 调至 16KB）；</li>
<li><strong>时间分片索引</strong>：按月份拆分索引（如<code>news-2025-06</code>），查询时仅访问目标索引，避免全量扫描。</li>
</ul>
</li>
<li>
<ol start="3">
<li>利用缓存优化 IO</li>
</ol>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ARouter 入门指南：从基本跳转到对象传递]]></title>    <link>https://juejin.cn/post/7577970969395331113</link>    <guid>https://juejin.cn/post/7577970969395331113</guid>    <pubDate>2025-11-30T09:40:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577970969395331113" data-draft-id="7577625663257624576" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ARouter 入门指南：从基本跳转到对象传递"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-30T09:40:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨白"/> <meta itemprop="url" content="https://juejin.cn/user/2549135752044601"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ARouter 入门指南：从基本跳转到对象传递
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2549135752044601/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:40:52.000Z" title="Sun Nov 30 2025 09:40:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">配置</h2>
<p>在模块级的 <code>build.gradle.kts</code> 文件中进行配置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">plugins {
    id(<span class="hljs-string">"kotlin-kapt"</span>)
}

android {
    buildFeatures {
        buildConfig = <span class="hljs-literal">true</span>
    }
}

dependencies {
    implementation(<span class="hljs-string">"com.alibaba:arouter-api:1.5.2"</span>)
    kapt(<span class="hljs-string">"com.alibaba:arouter-compiler:1.5.2"</span>)
}

kapt {
    arguments {
        <span class="hljs-comment">// 每个模块必须配置模块名，用于编译期生成 Group 映射文件</span>
        arg(<span class="hljs-string">"AROUTER_MODULE_NAME"</span>, project.name)
    }
}
</code></pre>
<p>如果出现了依赖性冲突，可以在 <code>gradle.properties</code> 文件中添加这两行：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">android.useAndroidX=<span class="hljs-literal">true</span>
android.enableJetifier=<span class="hljs-literal">true</span> <span class="hljs-comment">// 让第三方库迁移到 AndroidX</span>
</code></pre>
<h3 data-id="heading-1">初始化</h3>
<p>配置完成后，在 <code>Application</code> 中初始化 <code>ARouter</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseApplication</span> : <span class="hljs-type">Application</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        initARouter()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initARouter</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 必须在 init 之前配置</span>
        <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
            ARouter.openLog()     <span class="hljs-comment">// 打印日志</span>
            ARouter.openDebug()   <span class="hljs-comment">// 开启调试模式</span>
        }
        ARouter.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)
    }
}
</code></pre>
<p>开启<strong>调试模式</strong>是为了让每次代码修改都能立即生效。因为 ARouter 在应用版本号不变时，会使用本地缓存，这就可能导致了路由路径修改后，运行时出现“找不到路径”的问题。</p>
<p>因此，我们强制它每次启动时都重新加载路由表，不使用缓存，这样每次拿到的都是最新构建的路由表。</p>
<h2 data-id="heading-2">路由与注入</h2>
<h3 data-id="heading-3">页面定义与跳转</h3>
<p>定义页面 (Destination) 的规范为：<code>/组名/页面名</code>。</p>
<blockquote>
<p>ARouter 会根据组名进行内存懒加载。</p>
</blockquote>
<p>创建一个 <code>UserProfileActivity</code>，并定义它的路由。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Route(path = <span class="hljs-string">"/user/profile"</span>)</span> <span class="hljs-comment">// 注意路径不能少于两级</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfileActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_user_profile)
    }
}
</code></pre>
<p>接着在 <code>MainActivity</code> 中实现最简单的跳转：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        findViewById&lt;Button&gt;(R.id.go_btn).setOnClickListener {
            ARouter.getInstance().build(<span class="hljs-string">"/user/profile"</span>).navigation(<span class="hljs-keyword">this</span>)
        }
    }
}
</code></pre>
<p>运行结果：</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c2293aeee4b4d8499c940f6c31e3589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765100452&amp;x-signature=lMOLfwUAfinOlCCA2CAYX153TeQ%3D" alt="Screen_recording_20251130_144451.gif" width="50%" loading="lazy"/>
<h3 data-id="heading-4">参数传递与自动注入</h3>
<p>需要传递参数的话，只需调用 <code>withXxx</code> 方法即可。</p>
<p>例如：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// MainActivity 的 onCreate 方法中</span>
findViewById&lt;Button&gt;(R.id.go_btn).setOnClickListener {
    ARouter.getInstance().build(<span class="hljs-string">"/user/profile"</span>)
        .withString(<span class="hljs-string">"name"</span>, <span class="hljs-string">"Steven"</span>)
        .withLong(<span class="hljs-string">"id"</span>, <span class="hljs-number">10086L</span>)
        .navigation(<span class="hljs-keyword">this</span>)
}
</code></pre>
<p>接收方代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Route(path = <span class="hljs-string">"/user/profile"</span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfileActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-meta">@JvmField</span>
    <span class="hljs-meta">@Autowired(name = <span class="hljs-string">"id"</span>)</span>
    <span class="hljs-keyword">var</span> userId: <span class="hljs-built_in">Long</span> = <span class="hljs-number">0L</span>

    <span class="hljs-meta">@JvmField</span>
    <span class="hljs-meta">@Autowired(name = <span class="hljs-string">"name"</span>)</span>
    <span class="hljs-keyword">var</span> userName: String? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_user_profile)

        <span class="hljs-comment">// 必须进行注入，否则所有字段都是默认值</span>
        ARouter.getInstance().inject(<span class="hljs-keyword">this</span>)
        
        Toast
            .makeText(
                <span class="hljs-keyword">this</span>,
                <span class="hljs-string">"id: <span class="hljs-variable">$userId</span>, name: <span class="hljs-variable">$userName</span>"</span>,
                Toast.LENGTH_SHORT
            )
            .show()
    }
}
</code></pre>
<p>运行结果：</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bb948fcf0284ba8acd77ecd5a4cedbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765100452&amp;x-signature=jgyLNF4C0MZvMEbXo3%2FhdZW%2F0n8%3D" alt="Screen_recording_20251130_150317.gif" width="50%" loading="lazy"/>
<h3 data-id="heading-5">跳转并获取返回结果</h3>
<p>如果要进行带结果的跳转，只需在跳转时，传入 <code>requestCode</code> 参数即可。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// MainActivity</span>
<span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> REQUEST_CODE_PROFILE = <span class="hljs-number">100</span>
}

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
    <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
    setContentView(R.layout.activity_main)

    findViewById&lt;Button&gt;(R.id.go_btn).setOnClickListener {
        ARouter.getInstance().build(<span class="hljs-string">"/user/profile"</span>)
            .withString(<span class="hljs-string">"name"</span>, <span class="hljs-string">"Steven"</span>)
            .withLong(<span class="hljs-string">"id"</span>, <span class="hljs-number">10086L</span>)
            .navigation(<span class="hljs-keyword">this</span>, REQUEST_CODE_PROFILE)
    }
}
</code></pre>
<p>在目标页面使用原生的 <code>setResult</code> 方法返回结果：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// UserProfileActivity</span>
lifecycleScope.launch {
    delay(<span class="hljs-number">2000</span>)
    <span class="hljs-keyword">val</span> intent = Intent().apply {
        putExtra(<span class="hljs-string">"updated_name"</span>, <span class="hljs-string">"Steven_666"</span>)
    }
    setResult(RESULT_OK, intent)
    finish()
}
</code></pre>
<p>在最初的页面重写 <code>onActivityResult</code> 方法来接收返回的数据：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onActivityResult</span><span class="hljs-params">(
    requestCode: <span class="hljs-type">Int</span>,
    resultCode: <span class="hljs-type">Int</span>,
    <span class="hljs-keyword">data</span>: <span class="hljs-type">Intent</span>?
)</span></span> {
    <span class="hljs-keyword">super</span>.onActivityResult(requestCode, resultCode, <span class="hljs-keyword">data</span>)

    <span class="hljs-keyword">if</span> (requestCode == REQUEST_CODE_PROFILE &amp;&amp; resultCode == RESULT_OK) {
        <span class="hljs-keyword">val</span> updatedName = <span class="hljs-keyword">data</span>?.getStringExtra(<span class="hljs-string">"updated_name"</span>)
        Toast.makeText(<span class="hljs-keyword">this</span>, <span class="hljs-string">"用户名已更新为：<span class="hljs-variable">$updatedName</span>"</span>, Toast.LENGTH_SHORT).show()
    }
}
</code></pre>
<h2 data-id="heading-6">拦截器</h2>
<p>我们可以在跳转前进行拦截、修改和重定向。</p>
<p>比如在进到用户个人中心前进行拦截，我们要检查该用户的信息完整性，如果缺少，就拦截该跳转，引导到完善信息页面；如果完整，就放行。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Interceptor(priority = 10, name = <span class="hljs-string">"用户资料完整性检查"</span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfileInterceptor</span> : <span class="hljs-type">IInterceptor</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> mContext: Context? = <span class="hljs-literal">null</span>

    <span class="hljs-comment">/**
     * 注意：该方法运行在子线程
     */</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">process</span><span class="hljs-params">(postcard: <span class="hljs-type">Postcard</span>, callback: <span class="hljs-type">InterceptorCallback</span>)</span></span> {
        <span class="hljs-keyword">if</span> (postcard.path == <span class="hljs-string">"/user/profile"</span>) {
            Log.i(<span class="hljs-string">"ARouter"</span>, <span class="hljs-string">"正在检查进入个人中心的权限..."</span>)

            <span class="hljs-comment">//检查本地是否有昵称</span>
            <span class="hljs-keyword">val</span> hasNickname = fakeCheckUserNicknameFromDb()

            <span class="hljs-keyword">if</span> (hasNickname) {
                <span class="hljs-comment">// 通过，继续跳转</span>
                callback.onContinue(postcard)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 失败，进行拦截</span>
                callback.onInterrupt(RuntimeException(<span class="hljs-string">"用户信息不完整"</span>))

                <span class="hljs-comment">//切换到主线程来显示 Toast 或跳转</span>
                MainLooper.runOnUiThread {
                    Toast.makeText(mContext, <span class="hljs-string">"请先完善用户信息"</span>, Toast.LENGTH_SHORT).show()
                    <span class="hljs-comment">// 重定向到完善信息页</span>
                    ARouter.getInstance().build(<span class="hljs-string">"/user/complete_info"</span>).navigation()
                }

                <span class="hljs-comment">// 流程结束</span>
                callback.onInterrupt(<span class="hljs-literal">null</span>)
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 如果不是我们要拦截的路径，直接放行</span>
            callback.onContinue(postcard)
        }
    }

    <span class="hljs-comment">/**
     * 模拟从数据库查询用户昵称
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fakeCheckUserNicknameFromDb</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">val</span> context = mContext ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

        <span class="hljs-keyword">try</span> {
            Log.d(<span class="hljs-string">"ARouter"</span>, <span class="hljs-string">"正在查询数据库..."</span>)
            Thread.sleep(<span class="hljs-number">300</span>)
        } <span class="hljs-keyword">catch</span> (e: InterruptedException) {
            e.printStackTrace()
        }

        <span class="hljs-keyword">val</span> sp = context.getSharedPreferences(<span class="hljs-string">"user_data"</span>, Context.MODE_PRIVATE)
        <span class="hljs-keyword">val</span> nickname = sp.getString(<span class="hljs-string">"nickname"</span>, <span class="hljs-string">""</span>)

        <span class="hljs-comment">// 如果昵称不为空，则视为信息完整</span>
        <span class="hljs-keyword">return</span> !nickname.isNullOrEmpty()
    }

    <span class="hljs-comment">/**
     * 初始化方法
     * 在 ARouter 初始化时被调用，运行在主线程
     */</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        <span class="hljs-comment">// 这里可以做一些静态资源的加载，或者注册广播等（非耗时操作）</span>
        <span class="hljs-keyword">this</span>.mContext = context.applicationContext
        Log.i(<span class="hljs-string">"ARouter"</span>, <span class="hljs-string">"UserProfileInterceptor 已加载"</span>)
    }
}

<span class="hljs-comment">// 切换主线程的简单封装</span>
<span class="hljs-keyword">object</span> MainLooper {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> handler = Handler(Looper.getMainLooper())
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">runOnUiThread</span><span class="hljs-params">(action: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        <span class="hljs-keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) {
            action()
        } <span class="hljs-keyword">else</span> {
            handler.post(action)
        }
    }
}
</code></pre>
<h2 data-id="heading-7">实战结构参考</h2>
<p>在大型项目中，我们不会硬编码路由字符串，也不允许让跳转逻辑分散。</p>
<p>我们会创建路由常量：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> RoutePath {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> GROUP = <span class="hljs-string">"/user"</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> USER_PROFILE = <span class="hljs-string">"<span class="hljs-variable">$GROUP</span>/profile"</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> COMPLETE_USER_INFO = <span class="hljs-string">"<span class="hljs-variable">$GROUP</span>/complete_info"</span>
}
</code></pre>
<p>然后封装一个导航中心 <code>NavigationHelper</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> NavigationHelper {

    <span class="hljs-comment">/**
     * 通用跳转
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startActivity</span><span class="hljs-params">(path: <span class="hljs-type">String</span>, bundle: <span class="hljs-type">Bundle</span>? = <span class="hljs-literal">null</span>)</span></span> {
        ARouter.getInstance().build(path)
            .with(bundle)
            .navigation()
    }

    <span class="hljs-comment">/**
     * 带结果的跳转
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startForResult</span><span class="hljs-params">(activity: <span class="hljs-type">Activity</span>, path: <span class="hljs-type">String</span>, requestCode: <span class="hljs-type">Int</span>)</span></span> {
        ARouter.getInstance().build(path)
            .navigation(activity, requestCode)
    }
    
    <span class="hljs-comment">/**
     * 导航用户详情页
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toUserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">Long</span>, userName: <span class="hljs-type">String</span>?)</span></span> {
        ARouter.getInstance().build(RoutePath.USER_PROFILE)
            .withLong(UserProfileActivity.USER_ID, userId)
            .withString(UserProfileActivity.USER_NAME, userName ?: <span class="hljs-string">""</span>)
            .navigation()
    }
}
</code></pre>
<p>现在我们无需知道参数 Key 的值，甚至无需知道用户详情页的路由路径。</p>
<p>现在的 <code>MainActivity</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        findViewById&lt;Button&gt;(R.id.go_btn).setOnClickListener {
            NavigationHelper.toUserProfile(<span class="hljs-number">10086L</span>, <span class="hljs-string">"Steven"</span>)
        }
    }
}
</code></pre>
<p>现在的 <code>UserProfileActivity</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Route(path = RoutePath.USER_PROFILE)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfileActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-meta">@JvmField</span>
    <span class="hljs-meta">@Autowired(name = USER_ID)</span>
    <span class="hljs-keyword">var</span> userId: <span class="hljs-built_in">Long</span> = <span class="hljs-number">0L</span>

    <span class="hljs-meta">@JvmField</span>
    <span class="hljs-meta">@Autowired(name = USER_NAME)</span>
    <span class="hljs-keyword">var</span> userName: String? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> USER_ID = <span class="hljs-string">"id"</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> USER_NAME = <span class="hljs-string">"name"</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_user_profile)

        ARouter.getInstance().inject(<span class="hljs-keyword">this</span>)
        Toast
            .makeText(
                <span class="hljs-keyword">this</span>,
                <span class="hljs-string">"id: <span class="hljs-variable">$userId</span>, name: <span class="hljs-variable">$userName</span>"</span>,
                Toast.LENGTH_SHORT
            )
            .show()
    }
}
</code></pre>
<h2 data-id="heading-8">Fragment 与对象传递</h2>
<h3 data-id="heading-9">获取 Fragment 实例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Route(path = <span class="hljs-string">"/home/fragment"</span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HomeFragment</span> : <span class="hljs-type">Fragment</span>() {

}
</code></pre>
<p>加载 Fragment，也可以通过 <code>ARouter</code> 获取其实例。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// MainActivity</span>
<span class="hljs-keyword">val</span> fragment = ARouter.getInstance().build(<span class="hljs-string">"/home/fragment"</span>).navigation() <span class="hljs-keyword">as</span>? Fragment
<span class="hljs-keyword">if</span> (fragment != <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 添加到 FragmentManager</span>
    supportFragmentManager.beginTransaction()
        .add(R.id.xxx, fragment)
        .commit()
}
</code></pre>
<h3 data-id="heading-10">JSON 服务具体实现</h3>
<p>现在，我们使用 <code>.withObject</code> 传递自定义对象时，会报错：<em>java.lang.NullPointerException</em></p>
<p>因为没有进行序列化，接收端拿到的数据是 null。我们可以配置序列化服务来解决。</p>
<blockquote>
<p>添加依赖：<code>implementation("com.google.code.gson:gson:2.13.2")</code> // Gson</p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Route(path = <span class="hljs-string">"/service/json"</span>)</span> <span class="hljs-comment">// Path 可以自定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonServiceImpl</span> : <span class="hljs-type">SerializationService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> gson: Gson? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>?)</span></span> {
        gson = Gson()
    }

    <span class="hljs-meta">@Deprecated(<span class="hljs-string">"Deprecated in Java"</span>)</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any?&gt;</span> <span class="hljs-title">json2Object</span><span class="hljs-params">(
        input: <span class="hljs-type">String</span>?,
        clazz: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>?&gt;?
    )</span></span>: T? {
        <span class="hljs-keyword">return</span> input?.let { gson?.fromJson(it, clazz) }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">object2Json</span><span class="hljs-params">(instance: <span class="hljs-type">Any</span>?)</span></span>: String {
        <span class="hljs-keyword">return</span> gson?.toJson(instance) ?: <span class="hljs-string">""</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any?&gt;</span> <span class="hljs-title">parseObject</span><span class="hljs-params">(
        input: <span class="hljs-type">String</span>?,
        clazz: <span class="hljs-type">Type</span>?
    )</span></span>: T? {
        <span class="hljs-keyword">return</span> input?.let { gson?.fromJson(it, clazz) }
    }

}
</code></pre>
<p>之后，ARouter 会自动调用 <code>JsonServiceImpl</code> 来处理所有的 <code>withObject</code> 请求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端跨页面通讯终极指南②：BroadcastChannel 用法全解析]]></title>    <link>https://juejin.cn/post/7577971299743072294</link>    <guid>https://juejin.cn/post/7577971299743072294</guid>    <pubDate>2025-11-30T09:50:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577971299743072294" data-draft-id="7576378563576004623" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端跨页面通讯终极指南②：BroadcastChannel 用法全解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T09:50:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端跨页面通讯终极指南②：BroadcastChannel 用法全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:50:50.000Z" title="Sun Nov 30 2025 09:50:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上一篇介绍了<strong>PostMessage</strong>跨页面通讯的方式。有没有一种更简洁的方式，兄弟页面也能像父子页面一样通讯。今天就介绍一个更高效、更简洁的方案——<strong>BroadcastChannel API</strong>，它能轻松搞定父子、子父、兄弟页面间的通讯。</p>
<h2 data-id="heading-1">1. BroadcastChannel是什么？</h2>
<p><strong><code>BroadcastChannel</code></strong> 接口表示给定<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FGlossary%2FOrigin" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Glossary/Origin" ref="nofollow noopener noreferrer">源</a>的任何<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FGlossary%2FBrowsing_context" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Glossary/Browsing_context" ref="nofollow noopener noreferrer">浏览上下文</a>都可以订阅的命名频道。它允许<strong>同源</strong>的不同浏览器窗口、标签页、frame 或者 iframe 下的不同文档之间相互通信。消息通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FBroadcastChannel%2Fmessage_event" title="https://developer.mozilla.org/zh-CN/docs/Web/API/BroadcastChannel/message_event" target="_blank" ref="nofollow noopener noreferrer"><code>message</code></a> 事件进行广播，该事件在侦听该频道的所有 <code>BroadcastChannel</code> 对象上触发，发送消息的对象除外。</p>
<p>简单来说，它就像一个“无线电台”，多个页面只要订阅了同一个“频道”（指定相同的频道名称），就能接收该频道发送的所有消息，实现数据的双向流转。</p>
<p>需要注意，BroadcastChannel仅支持同源页面，兼容性略低，需要搭配其他方案作为降级处理。</p>
<h2 data-id="heading-2">2. 如何使用</h2>
<p><strong>BroadcastChannel</strong>的使用流程如下：</p>
<ol>
<li>创建频道</li>
<li>订阅消息</li>
<li>发送消息</li>
<li>关闭订阅</li>
</ol>
<h3 data-id="heading-3">2.1 创建频道（主题）</h3>
<p>通过 <code>new BroadcastChannel('channel-name')</code>创建一个“频道”（相当于发布-订阅中的“主题”）。所有加入同一频道的上下文，共享同一个通信通道。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 创建/订阅指定名称的频道（关键：多页面频道名必须一致）</span>
<span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'my-channel'</span>);
</code></pre>
<h3 data-id="heading-4">2.2 订阅消息（监听）</h3>
<p>通过监听 <code>message</code>事件订阅该频道的消息（相当于订阅者注册回调）：</p>
<pre><code class="hljs language-js" lang="js">channel.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到消息：'</span>, e.<span class="hljs-property">data</span>); <span class="hljs-comment">// e.data 就是发送的消息内容</span>
  <span class="hljs-comment">// 根据消息类型执行对应逻辑</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'refresh'</span>) {
    <span class="hljs-comment">// 执行刷新操作</span>
  }
};

</code></pre>
<h3 data-id="heading-5">2.3 发布消息（发送）</h3>
<p>通过 <code>postMessage()</code>向频道发送消息（相当于发布者触发发布）：</p>
<pre><code class="hljs language-js" lang="js">channel.<span class="hljs-title function_">postMessage</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'refresh'</span>,
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">123</span> }
});
</code></pre>
<h3 data-id="heading-6">2.4 退订（关闭）</h3>
<p>通过 <code>close()</code>方法离开频道（可选，浏览器通常会在上下文销毁时自动清理）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  channel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建/订阅指定名称的频道（关键：多页面频道名必须一致）</span>
<span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'my-channel'</span>);

<span class="hljs-comment">// 2. 接收消息</span>
channel.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到消息：'</span>, e.<span class="hljs-property">data</span>); <span class="hljs-comment">// e.data 就是发送的消息内容</span>
  <span class="hljs-comment">// 根据消息类型执行对应逻辑</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'refresh'</span>) {
    <span class="hljs-comment">// 执行刷新操作</span>
  }
};

<span class="hljs-comment">// 3. 发送消息（支持字符串、对象等多种数据类型）</span>
channel.<span class="hljs-title function_">postMessage</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'refresh'</span>,
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">123</span> }
});

<span class="hljs-comment">// 4. 关闭频道（页面卸载时调用，避免内存泄漏）</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  channel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<h2 data-id="heading-7">3、实践场景</h2>
<p>下面我们针对前端最常见的<strong>父子页面</strong>（父窗口打开子窗口）、<strong>子父页面</strong>（子窗口向父窗口反馈）、<strong>兄弟页面</strong>（同一父页面打开的多个子窗口）三种场景，分别给出具体的实现代码。</p>
<h3 data-id="heading-8">3.1 父子通讯</h3>
<p>父页面点击“刷新子页面”按钮，子页面接收到指令后刷新数据。</p>
<p><strong>父页面代码</strong>（打开子窗口并发送消息）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建频道</span>
<span class="hljs-keyword">const</span> parentChannel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'parent-child-channel'</span>);

<span class="hljs-comment">// 2. 点击按钮向子窗口发送消息</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'refreshChildBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  parentChannel.<span class="hljs-title function_">postMessage</span>({
    <span class="hljs-attr">type</span>: <span class="hljs-string">'refresh-data'</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'父页面指令：请刷新数据'</span>
  });
});

<span class="hljs-comment">// 3. 页面卸载时关闭频道</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  parentChannel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<p><strong>子页面代码</strong>（接收父页面消息并执行操作）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 订阅同一个频道（频道名必须和父页面一致）</span>
<span class="hljs-keyword">const</span> childChannel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'parent-child-channel'</span>);

<span class="hljs-comment">// 2. 接收父页面消息</span>
childChannel.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">type</span>, message } = e.<span class="hljs-property">data</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">'refresh-data'</span>) {
    <span class="hljs-comment">// 显示接收的消息</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'message'</span>).<span class="hljs-property">textContent</span> = message;
    <span class="hljs-comment">// 执行刷新数据的逻辑</span>
    <span class="hljs-title function_">refreshData</span>();
  }
};

<span class="hljs-comment">// 刷新数据的核心函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">refreshData</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 模拟请求接口刷新数据</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子页面正在刷新数据...'</span>);
  <span class="hljs-comment">// 这里写具体的刷新逻辑</span>
}

<span class="hljs-comment">// 3. 页面卸载时关闭频道</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  childChannel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<h3 data-id="heading-9">3.2 子父通讯（子窗口向父窗口反馈结果）</h3>
<p>需求：子页面完成表单提交后，向父页面发送“提交成功”的消息，父页面接收到后关闭子窗口并刷新自身数据。</p>
<p><strong>子页面代码</strong>（提交表单后发送消息）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 订阅频道（和父页面保持一致）</span>
<span class="hljs-keyword">const</span> childChannel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'child-parent-channel'</span>);

<span class="hljs-comment">// 2. 表单提交逻辑</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'submitForm'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'submit'</span>, <span class="hljs-keyword">async</span> (e) =&gt; {
  e.<span class="hljs-title function_">preventDefault</span>();
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 模拟表单提交接口请求</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitFormData</span>();
    <span class="hljs-comment">// 提交成功后向父页面发送消息</span>
    childChannel.<span class="hljs-title function_">postMessage</span>({
      <span class="hljs-attr">type</span>: <span class="hljs-string">'submit-success'</span>,
      <span class="hljs-attr">data</span>: { <span class="hljs-attr">formId</span>: <span class="hljs-number">456</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">'success'</span> }
    });
    <span class="hljs-comment">// 延迟关闭子窗口，确保消息发送完成</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">close</span>();
    }, <span class="hljs-number">300</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'提交失败：'</span>, error);
  }
});

<span class="hljs-comment">// 3. 页面卸载时关闭频道</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  childChannel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<p><strong>父页面代码</strong>（接收子页面消息并执行操作）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 创建频道</span>
<span class="hljs-keyword">const</span> parentChannel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'child-parent-channel'</span>);

<span class="hljs-comment">// 2. 接收子页面消息</span>
parentChannel.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">type</span>, data } = e.<span class="hljs-property">data</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">'submit-success'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子页面表单提交成功：'</span>, data);
    <span class="hljs-comment">// 执行父页面刷新逻辑</span>
    <span class="hljs-title function_">parentRefreshData</span>();
    <span class="hljs-comment">// （可选）关闭子窗口（如果子窗口未自行关闭）</span>
    <span class="hljs-comment">// childWindow.close();</span>
  }
};

<span class="hljs-comment">// 父页面刷新数据函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parentRefreshData</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'父页面正在刷新数据...'</span>);
  <span class="hljs-comment">// 具体刷新逻辑</span>
}

<span class="hljs-comment">// 3. 页面卸载时关闭频道</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  parentChannel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<h3 data-id="heading-10">3.3 兄弟通讯（多个子窗口间同步状态）</h3>
<p>需求：父页面打开两个子窗口A和B，当子窗口A修改数据后，子窗口B实时同步更新数据。</p>
<p><strong>子窗口A代码</strong>（修改数据后发送消息）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 订阅兄弟通讯频道</span>
<span class="hljs-keyword">const</span> brotherChannel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'brother-channel'</span>);

<span class="hljs-comment">// 2. 模拟修改数据操作</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'updateDataBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> newData = {
    <span class="hljs-attr">id</span>: <span class="hljs-number">789</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">'子窗口A修改后的新内容'</span>,
    <span class="hljs-attr">updateTime</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toLocaleString</span>()
  };
  <span class="hljs-comment">// 保存修改后的数据</span>
  <span class="hljs-title function_">saveData</span>(newData);
  <span class="hljs-comment">// 向频道发送消息，通知其他兄弟窗口</span>
  brotherChannel.<span class="hljs-title function_">postMessage</span>({
    <span class="hljs-attr">type</span>: <span class="hljs-string">'data-updated'</span>,
    <span class="hljs-attr">newData</span>: newData
  });
});

<span class="hljs-comment">// 3. 页面卸载时关闭频道</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  brotherChannel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<p><strong>子窗口B代码</strong>（接收消息并同步数据）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 订阅同一个兄弟通讯频道</span>
<span class="hljs-keyword">const</span> brotherChannel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'brother-channel'</span>);

<span class="hljs-comment">// 2. 接收子窗口A发送的消息</span>
brotherChannel.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">type</span>, newData } = e.<span class="hljs-property">data</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">'data-updated'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到子窗口A的更新消息：'</span>, newData);
    <span class="hljs-comment">// 同步更新页面数据展示</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'dataContent'</span>).<span class="hljs-property">textContent</span> = newData.<span class="hljs-property">content</span>;
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'updateTime'</span>).<span class="hljs-property">textContent</span> = newData.<span class="hljs-property">updateTime</span>;
  }
};

<span class="hljs-comment">// 3. 页面卸载时关闭频道</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  brotherChannel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<p>接收输入如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1aa2e1e705144c8a7bf2c14bdc1392b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101050&amp;x-signature=20mMZB0QSh5cO4wGBhkzM2GivrE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">4. 总结</h2>
<p>最后总结一下：对比传统的<code>postMessage</code>跨页面通讯方案，<strong>BroadcastChannel</strong>兄弟页面无需转发，几行代码就能轻松实现通讯。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【卫星图像识别系统】Python+TensorFlow+Vue3+Django+人工智能+深度学习+卷积网络+resnet50算法]]></title>    <link>https://juejin.cn/post/7577718777482297382</link>    <guid>https://juejin.cn/post/7577718777482297382</guid>    <pubDate>2025-11-30T09:51:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577718777482297382" data-draft-id="7577991167200428042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【卫星图像识别系统】Python+TensorFlow+Vue3+Django+人工智能+深度学习+卷积网络+resnet50算法"/> <meta itemprop="keywords" content="TensorFlow,图像识别,人工智能"/> <meta itemprop="datePublished" content="2025-11-30T09:51:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ziwu"/> <meta itemprop="url" content="https://juejin.cn/user/607373397353726"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【卫星图像识别系统】Python+TensorFlow+Vue3+Django+人工智能+深度学习+卷积网络+resnet50算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/607373397353726/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ziwu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:51:27.000Z" title="Sun Nov 30 2025 09:51:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、介绍</h2>
<p>卫星影像识别系统，基于TensorFlow搭建卷积神经网络算法，通过对7种常见的卫星遥感影像图片数据集（'草地（Grass）', '农田（Field）', '工业区（Industry）', '河流湖泊（RiverLake）', '森林（Forest）', '居民区（Resident）', '停车场（Parking）'）进行训练，最后得到一个识别精度较高的模型，然后搭建Web可视化操作平台。</p>
<p><strong>前端</strong>: Vue3、Element Plus</p>
<p><strong>后端</strong>：Django</p>
<p><strong>算法</strong>：TensorFlow、卷积神经网络算法</p>
<p><strong>具体功能</strong>：</p>
<ol>
<li>系统分为管理员和用户两个角色，登录后根据角色显示其可访问的页面模块。</li>
<li>登录系统后可发布、查看、编辑文章，创建文章功能中集成了markdown编辑器，可对文章进行编辑。</li>
<li>在图像识别功能中，用户上传图片后，点击识别，可输出其识别结果和置信度</li>
<li>基于Echart以柱状图形式输出所有种类对应的置信度分布图。</li>
<li>在智能问答功能模块中：用户输入问题，后台通过对接Deepseek接口实现智能问答功能。</li>
<li>管理员可在用户管理模块中，对用户账户进行管理和编辑。</li>
</ol>
<p><strong>选题背景与意义</strong>：
随着遥感技术的快速发展，卫星影像数据呈现爆发式增长，如何高效、精准地识别与利用这些数据，已成为资源监测、环境评估和城乡规划等领域的重要课题。传统人工判读方式效率低、主观性强，难以满足大规模应用需求。为此，本项目基于TensorFlow构建卷积神经网络模型，针对草地、农田、工业区、河流湖泊、森林、居民区及停车场等七类典型地物进行识别训练，旨在开发一个具备较高识别精度的自动化分类系统。为进一步提升系统的实用性与交互体验，项目结合Django与Vue3等主流技术，搭建了集用户管理、图像识别、结果可视化及智能问答于一体的Web操作平台。该系统不仅实现了地物类型的智能识别与置信度分析，还通过集成Markdown编辑与DeepSeek问答接口，拓展了知识管理与交互支持功能，为遥感数据的智能化应用提供了便捷、高效的解决方案。</p>
<h2 data-id="heading-1">二、系统效果图片展示</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97af6426029a4299a39e62b4ed7ed3d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeml3dQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101087&amp;x-signature=0pcJIyIlY%2BSovwHkzF%2Fx6PUd4SE%3D" alt="图片" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1ef67ef291412084dd4e21138e6e81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeml3dQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101087&amp;x-signature=G8er3EQcZRZHV3k%2FMFyQFiV18AQ%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">三、演示视频 and 完整代码 and 安装</h2>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fziwupy.cn%2Fp%2F6eby8p" target="_blank" title="https://ziwupy.cn/p/6eby8p" ref="nofollow noopener noreferrer">ziwupy.cn/p/6eby8p</a></p>
<h2 data-id="heading-3">四、卷积神经网络算法介绍</h2>
<p>ResNet50是由微软研究院提出的深度残差网络（Residual Network）的一个经典模型，其核心创新是“残差学习”思想。在传统的深度卷积神经网络中，简单地堆叠层数会遇到“梯度消失/爆炸”问题，导致网络难以训练，性能甚至下降，这被称为“退化问题”。</p>
<p>ResNet通过引入“快捷连接”或“跳跃连接”巧妙地解决了这一问题。它不再让多个堆叠的层直接学习一个目标映射H(x)，而是让这些层学习其与输入x之间的残差F(x) = H(x) - x。这样，原始的目标映射就变成了 H(x) = F(x) + x。</p>
<p>这种“捷径”将输入x直接传递到更深层的输出，实现了恒等映射。这样做有两个主要好处：</p>
<ol>
<li><strong>缓解梯度消失</strong>：梯度可以直接通过快捷连接反向传播，使得深层网络的训练变得可行。</li>
<li><strong>简化学习目标</strong>：让网络学习残差F(x)通常比学习完整的映射H(x)更容易，尤其是在F(x)趋近于0时，该层就近似做了恒等变换，避免了性能退化。</li>
</ol>
<p>ResNet50因其包含50个权重层而得名，它通过大量使用这种带有快捷连接的“瓶颈结构”模块，在保持高性能的同时，显著减少了参数量，成为图像识别领域一个里程碑式的模型。</p>
<p>以下是一个使用TensorFlow Keras中预训练的ResNet50模型进行图像识别的简单示例。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf
<span class="hljs-keyword">from</span> tensorflow.keras.applications.resnet50 <span class="hljs-keyword">import</span> ResNet50, decode_predictions, preprocess_input
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image

<span class="hljs-comment"># 1. 加载预训练的ResNet50模型（包含在ImageNet上训练得到的权重）</span>
model = ResNet50(weights=<span class="hljs-string">'imagenet'</span>)

<span class="hljs-comment"># 2. 加载并预处理图像</span>
img_path = <span class="hljs-string">'your_image.jpg'</span> <span class="hljs-comment"># 替换为你的图片路径</span>
image = Image.<span class="hljs-built_in">open</span>(img_path).convert(<span class="hljs-string">'RGB'</span>) <span class="hljs-comment"># 确保为RGB格式</span>
image = image.resize((<span class="hljs-number">224</span>, <span class="hljs-number">224</span>)) <span class="hljs-comment"># ResNet50要求输入尺寸为224x224</span>

<span class="hljs-comment"># 将图像转换为数组并扩展维度以匹配模型输入要求 (batch_size, height, width, channels)</span>
image_array = np.array(image)
image_array = np.expand_dims(image_array, axis=<span class="hljs-number">0</span>)

<span class="hljs-comment"># 对图像进行与训练时相同的预处理</span>
image_array = preprocess_input(image_array)

<span class="hljs-comment"># 3. 使用模型进行预测</span>
predictions = model.predict(image_array)

<span class="hljs-comment"># 4. 解码预测结果，得到人类可读的标签和置信度</span>
decoded_predictions = decode_predictions(predictions, top=<span class="hljs-number">3</span>)[<span class="hljs-number">0</span>] <span class="hljs-comment"># 显示最可能的3个结果</span>

<span class="hljs-comment"># 5. 打印结果</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"识别结果："</span>)
<span class="hljs-keyword">for</span> i, (imagenet_id, label, score) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(decoded_predictions):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>: <span class="hljs-subst">{label}</span> (<span class="hljs-subst">{score * <span class="hljs-number">100</span>:<span class="hljs-number">.2</span>f}</span>%)"</span>)
</code></pre>
<p>这段代码演示了利用预训练ResNet50模型进行图像识别的标准流程。首先，我们直接加载了在ImageNet数据集上预训练好的模型，无需从头训练。然后，将输入图像调整为224x224像素，并进行归一化等预处理。接着，模型对图像进行前向传播推理，输出一个包含1000个ImageNet类别概率的向量。最后，通过<code>decode_predictions</code>函数将概率向量解码为易于理解的对象标签和置信度，并打印出最可能的三个预测结果。这种方法让我们能够快速、高效地将强大的ResNet50模型应用于实际的图像识别任务中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【民族服饰识别系统】Python+TensorFlow+Vue3+Django+人工智能+深度学习+卷积网络+resnet50算法]]></title>    <link>https://juejin.cn/post/7577718777482379302</link>    <guid>https://juejin.cn/post/7577718777482379302</guid>    <pubDate>2025-11-30T09:59:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577718777482379302" data-draft-id="7577968429590151194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【民族服饰识别系统】Python+TensorFlow+Vue3+Django+人工智能+深度学习+卷积网络+resnet50算法"/> <meta itemprop="keywords" content="后端,图像识别,人工智能"/> <meta itemprop="datePublished" content="2025-11-30T09:59:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ziwu"/> <meta itemprop="url" content="https://juejin.cn/user/607373397353726"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【民族服饰识别系统】Python+TensorFlow+Vue3+Django+人工智能+深度学习+卷积网络+resnet50算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/607373397353726/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ziwu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:59:10.000Z" title="Sun Nov 30 2025 09:59:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、介绍</h2>
<p>民族服饰识别，民族服饰智能识别与分析系统基于TensorFlow框架，采用卷积神经网络（CNN）算法构建而成。系统在收集了回族、汉族、满族、苗族四类典型民族服饰图像数据集的基础上，通过多轮迭代训练，最终生成高精度识别模型，并配合Web可视化平台实现便捷交互。</p>
<p><strong>前端</strong>: Vue3、Element Plus</p>
<p><strong>后端</strong>：Django</p>
<p><strong>算法</strong>：TensorFlow、卷积神经网络算法</p>
<p><strong>具体功能</strong>：</p>
<ol>
<li>系统分为管理员和用户两个角色，登录后根据角色显示其可访问的页面模块。</li>
<li>登录系统后可发布、查看、编辑文章，创建文章功能中集成了markdown编辑器，可对文章进行编辑。</li>
<li>在图像识别功能中，用户上传图片后，点击识别，可输出其识别结果和置信度</li>
<li>基于Echart以柱状图形式输出所有种类对应的置信度分布图。</li>
<li>在智能问答功能模块中：用户输入问题，后台通过对接Deepseek接口实现智能问答功能。</li>
<li>管理员可在用户管理模块中，对用户账户进行管理和编辑。</li>
</ol>
<p><strong>选题背景与意义</strong>：
随着人工智能技术的快速发展，计算机视觉在文化传承与保护领域的应用日益广泛。民族服饰作为民族文化的重要载体，其识别与分类对于文化研究与数字化保护具有积极意义。传统人工识别方式效率有限，难以适应大规模图像处理需求。基于此背景，本研究旨在开发一套基于深度学习的民族服饰智能识别与分析系统。系统采用TensorFlow框架，基于卷积神经网络（CNN）构建高精度识别模型，实现对回族、汉族、满族、苗族四类典型民族服饰的自动化识别。通过集成Web可视化平台，系统不仅提供图像识别、置信度分析和可视化图表展示等核心功能，还结合内容管理与智能问答模块，构建了集文化识别、知识传播与交互体验于一体的综合平台，为民族文化的数字化保护与推广提供了有效的技术支撑。</p>
<h2 data-id="heading-1">二、系统效果图片展示</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e6321eef3a0410287cc9c9eb65419c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeml3dQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101549&amp;x-signature=ZrFTkjuH6D%2F1L5M8N6IFkt7NUFA%3D" alt="图片" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8d9ecae01ec4a22beb6f99c7ce2567d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeml3dQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101549&amp;x-signature=hgUkA0TvHVCp8eWOZtIgNxmxxQE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">三、演示视频 and 完整代码 and 安装</h2>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fziwupy.cn%2Fp%2FekFQTD" target="_blank" title="https://ziwupy.cn/p/ekFQTD" ref="nofollow noopener noreferrer">ziwupy.cn/p/ekFQTD</a></p>
<h2 data-id="heading-3">四、卷积神经网络算法介绍</h2>
<p>卷积神经网络是一种专为处理网格状数据（如图像）而设计的深度学习算法。其核心思想是通过“卷积”操作，自动地从图像中提取由浅到深的特征。</p>
<p><strong>主要构成层：</strong></p>
<ol>
<li><strong>卷积层：</strong> 是CNN的核心。它使用多个可学习的“滤波器”（或称“卷积核”）在输入图像上滑动，通过计算局部区域的点积来提取特征（如边缘、角点、纹理等）。通过堆叠多个卷积层，网络可以学习到从简单到复杂（如物体部件、整体轮廓）的层次化特征。</li>
<li><strong>池化层：</strong> 通常跟在卷积层之后，用于对特征图进行下采样。它通过取局部区域的最大值或平均值，来减小数据尺寸，降低计算量，同时增强模型对目标位置微小变化的鲁棒性（即“平移不变性”）。</li>
<li><strong>全连接层：</strong> 在网络的末端，将经过多轮卷积和池化后提取出的高级特征图展平，然后进行综合判断，最终输出每个类别的概率。</li>
</ol>
<p>CNN通过这种“局部连接”和“权值共享”（同一个滤波器扫描整张图片）的机制，极大地减少了参数数量，使其能够高效地处理图像，并成为图像识别领域最主流的算法。</p>
<p>以下是一个使用TensorFlow和Keras API构建一个简单的CNN模型，用于对MNIST手写数字数据集进行分类的示例。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf
<span class="hljs-keyword">from</span> tensorflow.keras <span class="hljs-keyword">import</span> datasets, layers, models

<span class="hljs-comment"># 1. 加载并预处理数据</span>
(train_images, train_labels), (test_images, test_labels) = datasets.mnist.load_data()
<span class="hljs-comment"># 将图像数据重塑为 (28, 28, 1) 的形状，并归一化到 [0, 1] 区间</span>
train_images = train_images.reshape((<span class="hljs-number">60000</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>)).astype(<span class="hljs-string">'float32'</span>) / <span class="hljs-number">255</span>
test_images = test_images.reshape((<span class="hljs-number">10000</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>)).astype(<span class="hljs-string">'float32'</span>) / <span class="hljs-number">255</span>

<span class="hljs-comment"># 2. 构建CNN模型</span>
model = models.Sequential([
    <span class="hljs-comment"># 第一个卷积块：卷积 + 池化</span>
    layers.Conv2D(<span class="hljs-number">32</span>, (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), activation=<span class="hljs-string">'relu'</span>, input_shape=(<span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>)),
    layers.MaxPooling2D((<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)),
    
    <span class="hljs-comment"># 第二个卷积块：卷积 + 池化</span>
    layers.Conv2D(<span class="hljs-number">64</span>, (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), activation=<span class="hljs-string">'relu'</span>),
    layers.MaxPooling2D((<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)),
    
    <span class="hljs-comment"># 将特征图展平，输入到全连接层</span>
    layers.Flatten(),
    layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>),
    <span class="hljs-comment"># 输出层，10个神经元对应10个数字类别，使用softmax激活函数输出概率</span>
    layers.Dense(<span class="hljs-number">10</span>, activation=<span class="hljs-string">'softmax'</span>)
])

<span class="hljs-comment"># 3. 编译模型</span>
model.<span class="hljs-built_in">compile</span>(optimizer=<span class="hljs-string">'adam'</span>,
              loss=<span class="hljs-string">'sparse_categorical_crossentropy'</span>,
              metrics=[<span class="hljs-string">'accuracy'</span>])

<span class="hljs-comment"># 4. 训练模型</span>
model.fit(train_images, train_labels, epochs=<span class="hljs-number">5</span>, 
          validation_data=(test_images, test_labels))

<span class="hljs-comment"># 5. 评估模型</span>
test_loss, test_acc = model.evaluate(test_images, test_labels, verbose=<span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f'\n测试准确率：<span class="hljs-subst">{test_acc}</span>'</span>)
</code></pre>
<p>以上代码完整展示了使用CNN进行图像识别的流程。首先，数据被加载并预处理成适合网络的格式。接着，我们构建了一个顺序模型，它包含两个卷积-池化层组合，用于特征提取，之后是展平操作和全连接层进行分类。模型使用<code>adam</code>优化器和交叉熵损失函数进行编译。最后，通过<code>fit</code>方法在训练数据上进行5轮训练，并在测试集上评估最终性能。这个简单的模型能很快地在MNIST数据集上达到很高的准确率，清晰地演示了CNN在图像识别任务中的强大能力和基本工作流程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型开发实战篇1：调用DeepSeek的对话接口,即聊天机器人接口]]></title>    <link>https://juejin.cn/post/7577737385955229706</link>    <guid>https://juejin.cn/post/7577737385955229706</guid>    <pubDate>2025-11-30T10:00:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385955229706" data-draft-id="7577971299743039526" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型开发实战篇1：调用DeepSeek的对话接口,即聊天机器人接口"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-30T10:00:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型开发实战篇1：调用DeepSeek的对话接口,即聊天机器人接口
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T10:00:17.000Z" title="Sun Nov 30 2025 10:00:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>很多AI产品对外的接口都复用了OpenAI公司的接口WebAPI，DeepSeek、智谱等也是如此。因此，只要学会OpenAI的接口，其他AI产品也就学调用了。我们就从OpenAI的接口来作为切入点学习。</p>
<p>对话接口也是聊天机器人， 在网页上与chatgpt类似的效果。</p>
<h2 data-id="heading-0">一、开发环境准备</h2>
<p>OpenAI的接口是WebAPI形式的Rest API接口，并且还提供了各种常用语言的SDK，比如Python,Java,.Net,Javascript。这些SDK也同样完全适用于DeepSeek和智谱。大家可以根据自己熟悉的开发语言选择，sdk下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Flibraries" target="_blank" title="https://platform.openai.com/docs/libraries" ref="nofollow noopener noreferrer">platform.openai.com/docs/librar…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a187dfe8078d4f3a817b2b236abe1c27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101617&amp;x-signature=GDlTwfKApt%2Fq0b59gcOd8HvMFrk%3D" alt="" loading="lazy"/></p>
<p>本教程以Python作为开发语言。</p>
<p><strong>1、安装Python解释器</strong></p>
<p>官方下载安装包：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.python.org%2Fdownloads%2F" target="_blank" title="https://www.python.org/downloads/" ref="nofollow noopener noreferrer">www.python.org/downloads/</a></p>
<p>安装好后看下版本</p>
<pre><code class="hljs language-css" lang="css">命令：python <span class="hljs-attr">--version</span>
</code></pre>
<p>Python 3.13.1</p>
<p><strong>2、安装Jupyter Lab</strong></p>
<p>JupyterLab是人工智能领域常用的web版本的开发工具，非常好用，优点很多就不一一介绍了。也可以在VSCode,Pycharm  这些IDE开发。</p>
<pre><code class="hljs">pip install jupyterlab
</code></pre>
<p>启动Jupyter Lab,可以打开指定的目录，使用以下命令。</p>
<pre><code class="hljs">jupyter lab
</code></pre>
<h2 data-id="heading-1">二、注册账号</h2>
<p>OpenAI的开放平台注册账号有点复杂，需要科学上网。我们可以使用国内的代理平台进行调用。比如我使用的是：aiyi 的，注册地址如下：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.apiyi.com%2Fregister%2F%3Faff" target="_blank" title="https://www.apiyi.com/register/?aff" ref="nofollow noopener noreferrer">www.apiyi.com/register/?a…</a>_code=LxAQ</p>
<p>注册号后设置令牌key，就可以使用了。DeepSeek的官方的公众平台停止充值，无法调用，也可以使用第3方提供的平台调用，甚至是本地搭建的DeepSeek也同样可以调用，这个后期讲。</p>
<h2 data-id="heading-2">三、开发单轮对话接口</h2>
<p><strong>1、Python导入常用的包</strong></p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">!pip install tiktoken openai pandas matplotlib plotly scikit-learn numpy</span>
</code></pre>
<p>我们本次会使用openai包， 若已安装了旧版本，需要更新到最新版本。</p>
<pre><code class="hljs language-css" lang="css">pip install <span class="hljs-attr">--upgrade</span> openai
</code></pre>
<p><strong>2、对话接口的代码Demo</strong></p>
<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI
<span class="hljs-attr">client</span> = OpenAI(api_key=<span class="hljs-string">"填写自己的令牌apikey"</span>, base_url=<span class="hljs-string">"https://vip.apiyi.com/v1"</span>)
<span class="hljs-attr">messages</span>=[
{<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个乐于助人的体育界专家。"</span>},
{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"2008年奥运会是在哪里举行的？"</span>},
]
<span class="hljs-attr">data</span> = client.chat.completions.create(
<span class="hljs-attr">model</span>=<span class="hljs-string">"gpt-4o-mini"</span>,
<span class="hljs-attr">stream</span>=<span class="hljs-literal">False</span>,
<span class="hljs-attr">messages</span>=messages
)
print(data.choices<span class="hljs-section">[0]</span>.message)
</code></pre>
<p> （1）我们使用的是aiyi代码，则使用aiyi的令牌key,base_url填写aiyi的接口地址。</p>
<p>（2）调用的接口是 chat.completions对话补齐接口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9cae10d570a4d60acc6823344a30799~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101617&amp;x-signature=hBSPvYsRRISEHQAuNjBPtaDp93M%3D" alt="" loading="lazy"/></p>
<p>执行会print的结果如上。单轮对话的代码就非常简单。.Net,Java，Javascript语言的开发也是类似的。</p>
<p>也可以print整个返回值data，这里的返回值的格式，在deepseek里稍稍有些不一样，开发的时候注意下。 </p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>(data)
</code></pre>

<pre><code class="hljs language-python" lang="python">ChatCompletion(<span class="hljs-built_in">id</span>=<span class="hljs-string">'chatcmpl-89CkHs99ByfRhSd7oB3bz8Cfj5f79'</span>, choices=[Choice(finish_reason=<span class="hljs-string">'stop'</span>, index=<span class="hljs-number">0</span>, logprobs=<span class="hljs-literal">None</span>, message=ChatCompletionMessage(content=<span class="hljs-string">'2008年奥运会在中国北京举行。这是中国第一次主办夏季奥林匹克运动会。'</span>, refusal=<span class="hljs-literal">None</span>, role=<span class="hljs-string">'assistant'</span>, audio=<span class="hljs-literal">None</span>, function_call=<span class="hljs-literal">None</span>, tool_calls=<span class="hljs-literal">None</span>))], created=<span class="hljs-number">1739239104</span>, model=<span class="hljs-string">'gpt-4o-mini'</span>, <span class="hljs-built_in">object</span>=<span class="hljs-string">'chat.completion'</span>, service_tier=<span class="hljs-literal">None</span>, system_fingerprint=<span class="hljs-string">'fp_5154047bf2'</span>, usage=CompletionUsage(completion_tokens=<span class="hljs-number">25</span>, prompt_tokens=<span class="hljs-number">33</span>, total_tokens=<span class="hljs-number">58</span>, completion_tokens_details=CompletionTokensDetails(accepted_prediction_tokens=<span class="hljs-literal">None</span>, audio_tokens=<span class="hljs-literal">None</span>, reasoning_tokens=<span class="hljs-literal">None</span>, rejected_prediction_tokens=<span class="hljs-literal">None</span>), prompt_tokens_details=PromptTokensDetails(audio_tokens=<span class="hljs-literal">None</span>, cached_tokens=<span class="hljs-literal">None</span>)))
</code></pre>
<p><strong>3、请求的接口说明</strong></p>
<p>使用 Chat Completions API 实现对话任务</p>
<p>聊天补全(Chat Completions API)以消息列表作为输入，并返回模型生成的消息作为输出。尽管聊天格式旨在使多轮对话变得简单，但它同样适用于没有任何对话的单轮任务。</p>
<p>主要请求参数说明：</p>
<p>model （string，必填）</p>
<p>要使用的模型ID。有关哪些模型适用于Chat API的详细信息</p>
<p>messages （array，必填）</p>
<p>迄今为止描述对话的消息列表</p>
<p>role （string，必填）</p>
<p>发送此消息的角色。system 、user 或 assistant 之一（一般用 user 发送用户问题，system 发送给模型提示信息）。system就是大模型在本次对话中扮演什么角色，比如代码里写的，大模型本次扮演的是“体育专家”，一般使用第3人称“你是xxx专家/教授。。”。</p>
<p>content （string，必填）</p>
<p>消息的内容</p>
<p>name （string，选填）</p>
<p>此消息的发送者姓名。可以包含 a-z、A-Z、0-9 和下划线，最大长度为 64 个字符</p>
<p>stream （boolean，选填，是否按流的方式发送内容）</p>
<p>当它设置为 true 时，API 会以 流式SSE（ Server Side Event ）方式返回内容。SSE 本质上是一个长链接，会持续不断地输出内容直到完成响应。如果不是做实时聊天，默认false即可。</p>
<p>max_tokens （integer，选填）</p>
<p>在聊天补全中生成的最大 tokens 数。</p>
<p>输入token和生成的token的总长度受模型上下文长度的限制。</p>
<p>temperature （number，选填，默认是 1）</p>
<p>采样温度，在 0和 2 之间。</p>
<p>较高的值，如0.8会使输出更随机，而较低的值，如0.2会使其更加集中和确定性。</p>
<p>通常建议修改这个（temperature ）或者 top_p ，但两者不能同时存在，二选一。</p>
<h2 data-id="heading-3">四、开发多轮对话接口</h2>
<p>单轮对话与多轮对话是完全一样的，只是在messages里将历史对话信息追加上。因为API 是一个“无状态” API，即服务端不记录用户请求的上下文，用户在每次请求时，需将之前所有对话历史拼接好后，传递给对话 API。</p>
<p>沿用上面的单轮对话，进行第2轮对话。</p>
<p><strong>1、将消息追加到 messages 列表中</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">new_message</span> = data.choices[<span class="hljs-number">0</span>].message
<span class="hljs-attr">new_message_dict</span> = {<span class="hljs-string">"role"</span>: new_message.role, <span class="hljs-string">"content"</span>: new_message.content}
<span class="hljs-comment"># 将消息追加到 messages 列表中</span>
messages.append(new_message_dict)
</code></pre>
<p>可以看到大模型返回的结果中,role是assistant 小助手，我们直接沿用。</p>
<p><strong>2、第2轮对话</strong></p>
<pre><code class="hljs language-go" lang="go">new_chat = {
<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
<span class="hljs-string">"content"</span>: <span class="hljs-string">"1.讲一个程序员才听得懂的冷笑话；2.今天是几号？3.明天星期几？"</span>
}
messages.<span class="hljs-built_in">append</span>(new_chat)
from pprint <span class="hljs-keyword">import</span> pprint
pprint(messages)
打印结果
</code></pre>
<p>[{'content': '你是一个乐于助人的体育界专家。', 'role': 'system'},</p>
<p> {'content': '2008年奥运会是在哪里举行的？', 'role': 'user'},</p>
<p> {'content': '2008年夏季奥运会在中国的北京举行。', 'role': 'assistant'},</p>
<p> {'content': '1.讲一个程序员才听得懂的冷笑话；2.今天是几号？3.明天星期几？', 'role': 'user'}]</p>
<p>调用对话接口</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">data</span> = client.chat.completions.create(
<span class="hljs-attr">model</span>=<span class="hljs-string">"gpt-4o-mini"</span>,
<span class="hljs-attr">stream</span>=<span class="hljs-literal">False</span>,
<span class="hljs-attr">messages</span>=messages
)
</code></pre>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">new_message</span> = data.choices[<span class="hljs-number">0</span>].message
<span class="hljs-comment"># 打印 new_messages</span>
print(new_message)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3aa9aafea4584df7bcd253b00aff6fe7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101617&amp;x-signature=n7qrs8cXDW1vrD3OoXNTV6sLu1w%3D" alt="" loading="lazy"/></p>
<p>若还有第3轮以及更多轮对话，都要将历史对话带上。</p>
<h2 data-id="heading-4">五、调用本地安装的DeepSeek-R1</h2>
<p><strong>1、使用ollama在本地安装deepseek</strong></p>
<p>教程如下</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5MzQ5NTU0Mw%3D%3D%26mid%3D2455052009%26idx%3D1%26sn%3D474108502c072da49587a5ee6ee4f76a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5MzQ5NTU0Mw==&amp;mid=2455052009&amp;idx=1&amp;sn=474108502c072da49587a5ee6ee4f76a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">DeepSeek本地安装太简单了，人人都会操作</a></p>
<p>本地安装了deepsek-r1:7b，模型名也是这个。</p>
<p>run跑起来</p>
<pre><code class="hljs language-arduino" lang="arduino">ollama run deepseek-r1:<span class="hljs-number">7b</span>
</code></pre>
<p><strong>2、调用对话接口</strong></p>
<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI
<span class="hljs-attr">client</span> = OpenAI(api_key=<span class="hljs-string">"sk-33333"</span>, base_url=<span class="hljs-string">"http://localhost:11434/v1/"</span>)
<span class="hljs-attr">messages</span>=[
{<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个乐于助人的体育界专家。"</span>},
{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"2008年奥运会是在哪里举行的？"</span>},
]
<span class="hljs-attr">data</span> = client.chat.completions.create(
<span class="hljs-attr">model</span>=<span class="hljs-string">"deepseek-r1:7b"</span>,
<span class="hljs-attr">stream</span>=<span class="hljs-literal">False</span>,
<span class="hljs-attr">messages</span>=messages
)
print(data.choices<span class="hljs-section">[0]</span>.message)
</code></pre>
<p>（1）api_key随便填写，但必须是英文和数字，不要有中文。</p>
<p>（2）模型model填写deepseek-r1:7b，若你本地安装的参数是别的，就把7b改掉。</p>
<p>（3）base_url是你本地localhost地址。</p>
<p><strong>3、看回答结果</strong></p>
<pre><code class="hljs language-css" lang="css">ChatCompletionMessage(<span class="hljs-attribute">content</span>='&lt;think&gt;\n好，用户问的是<span class="hljs-number">2008</span>年北京奥运会的举办地。\n\n首先，我确定奥运会每四年举办一次，所以从<span class="hljs-number">2000</span>年开始推算，应该是<span class="hljs-number">2008</span>年在北京举行。接着，我会想到北京有丰富的文化遗产和举办过其他国际盛会的经验，比如第<span class="hljs-number">24</span>届冬奥会，这对奥运会的成功很有帮助。\n\n然后，考虑举办地点的选择，北京不仅地理位置优越，基础设施也很齐全，能够支持一个成功的大型活动。我还应该提到这一点，让回答更有说服力。\n\n另外，<span class="hljs-number">2008</span>年对于中国人来说是特殊的一年，奥运会上会有许多来自中国各地的运动员参加，这将展现他们的精神和团结。这也是用户的可能兴趣点吧？\n\n最后，按照用户的提示，避免使用Markdown格式，并且提供一个自然流畅的回答。\n&lt;/think&gt;\n\n2008年北京奥运会在北京成功举办了，这是中国继上海世博会后第二个国际盛会，展现了中国的文化和魅力。', refusal=<span class="hljs-attribute">None</span>, role='assistant', <span class="hljs-selector-tag">audio</span>=<span class="hljs-attribute">None</span>, function_call=<span class="hljs-attribute">None</span>, tool_calls=<span class="hljs-attribute">None</span>)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7f7519301324c408d60bc49ed05b354~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101617&amp;x-signature=CKz8JadvMEtu7m9LD5rjAKgZj7U%3D" alt="" loading="lazy"/></p>
<p><strong>3、调用第3方的deepseek接口</strong></p>
<p>因为deepseek的api接口有很多限制，所以可以使用第3方提供的deepseek接口，比如华为云，腾讯云、硅基流动等，调用方式都一样，仅仅模型名称不一样，接口地址不一样。</p>
<p>我们选择硅基流动： <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.siliconflow.cn%2Fi%2FM6a0xrcX" target="_blank" title="https://cloud.siliconflow.cn/i/M6a0xrcX" ref="nofollow noopener noreferrer">cloud.siliconflow.cn/i/M6a0xrcX</a></p>
<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI
<span class="hljs-attr">client</span> = OpenAI(api_key=<span class="hljs-string">"YOUR_API_KEY"</span>, base_url=<span class="hljs-string">"https://api.siliconflow.cn/v1"</span>)
<span class="hljs-attr">response</span> = client.chat.completions.create(
<span class="hljs-attr">model</span>=<span class="hljs-string">'deepseek-ai/DeepSeek-V2.5'</span>,
<span class="hljs-attr">messages</span>=[
{<span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>,
<span class="hljs-string">'content'</span>: <span class="hljs-string">"中国大模型行业2025年将会迎来哪些机遇和挑战"</span>}
],
<span class="hljs-attr">stream</span>=<span class="hljs-literal">True</span>
)
for chunk in response:
print(chunk.choices<span class="hljs-section">[0]</span>.delta.content, <span class="hljs-attr">end</span>=<span class="hljs-string">''</span>)
</code></pre>
<p>简单的机器人对话接口就讲完了，下一期讲解对话接口的最佳实践。</p>
<h3 data-id="heading-5">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跨域难题终结者：Vue项目中优雅解决跨域问题的完整指南]]></title>    <link>https://juejin.cn/post/7577691061033795630</link>    <guid>https://juejin.cn/post/7577691061033795630</guid>    <pubDate>2025-11-30T02:37:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061033795630" data-draft-id="7577691061033762862" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跨域难题终结者：Vue项目中优雅解决跨域问题的完整指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T02:37:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跨域难题终结者：Vue项目中优雅解决跨域问题的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T02:37:49.000Z" title="Sun Nov 30 2025 02:37:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">跨域难题终结者：Vue项目中优雅解决跨域问题的完整指南</h2>
<blockquote>
<p>作为前端开发者，跨域问题就像一道绕不过去的坎。今天，就让我们彻底攻克这个难题！</p>
</blockquote>
<h3 data-id="heading-1">什么是跨域？为什么会出现跨域问题？</h3>
<h4 data-id="heading-2">同源策略：安全的守护者</h4>
<p>在深入解决方案之前，我们首先要明白<strong>同源策略</strong>这个概念。浏览器出于安全考虑，实施了同源策略，它限制了不同源之间的资源交互。</p>
<p><strong>什么是"同源"？</strong><br/>
简单来说，当两个URL的<strong>协议、域名、端口</strong>完全相同时，我们称它们为同源。</p>
<p>举个例子：</p>



































<table><thead><tr><th>当前页面URL</th><th>请求URL</th><th>是否同源</th><th>原因</th></tr></thead><tbody><tr><td><code>https://www.example.com/index.html</code></td><td><code>https://www.example.com/api/user</code></td><td>✅ 是</td><td>协议、域名、端口完全相同</td></tr><tr><td><code>https://www.example.com/index.html</code></td><td><code>http://www.example.com/api/user</code></td><td>❌ 否</td><td>协议不同(https vs http)</td></tr><tr><td><code>https://www.example.com/index.html</code></td><td><code>https://api.example.com/user</code></td><td>❌ 否</td><td>域名不同(www vs api)</td></tr><tr><td><code>https://www.example.com:8080/index.html</code></td><td><code>https://www.example.com:3000/api/user</code></td><td>❌ 否</td><td>端口不同(8080 vs 3000)</td></tr></tbody></table>
<h4 data-id="heading-3">跨域的限制范围</h4>
<p>当发生跨域时，以下行为会受到限制：</p>
<ul>
<li>• <strong>AJAX请求</strong>被阻止（核心问题）</li>
<li>• <strong>LocalStorage</strong>、<strong>IndexedDB</strong>等存储无法访问</li>
<li>• <strong>DOM</strong>无法通过JavaScript操作</li>
<li>• <strong>Cookie</strong>读写受限</li>
</ul>
<p>但有些资源是允许跨域加载的：</p>
<ul>
<li>• 图片<code>&lt;img&gt;</code></li>
<li>• 样式表<code>&lt;link&gt;</code></li>
<li>• 脚本<code>&lt;script&gt;</code></li>
<li>• 嵌入框架<code>&lt;iframe&gt;</code>（但内容访问受限）</li>
</ul>
<h3 data-id="heading-4">Vue项目中的跨域解决方案</h3>
<p>在实际的Vue项目中，我们主要有以下几种解决方案：</p>
<h4 data-id="heading-5">方案一：开发环境下的代理配置（最常用）</h4>
<p>这是开发阶段最常用的解决方案，通过Vue CLI或Vite的代理功能实现。</p>
<h5 data-id="heading-6">Vue CLI项目配置</h5>
<p><strong>1. 创建vue.config.js文件</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// vue.config.js</span>
<span class="hljs-keyword">const</span> { defineConfig } = <span class="hljs-keyword">require</span>(<span class="hljs-string">'@vue/cli-service'</span>)

module.exports = <span class="hljs-title function_ invoke__">defineConfig</span>({
<span class="hljs-attr">  transpileDependencies</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">  devServer</span>: {
<span class="hljs-attr">    port</span>: <span class="hljs-number">8080</span>,
<span class="hljs-attr">    proxy</span>: {
      // 简单配置：匹配以/api开头的请求
      <span class="hljs-string">'/api'</span>: {
<span class="hljs-attr">        target</span>: <span class="hljs-string">'http://localhost:3000'</span>, // 后端服务器地址
<span class="hljs-attr">        changeOrigin</span>: <span class="hljs-literal">true</span>, // 改变请求源
<span class="hljs-attr">        pathRewrite</span>: {
          <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> // 重写路径，去掉/api前缀
        }
      }
    }
  }
})
</code></pre>
<p><strong>2. 复杂场景的多代理配置</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// vue.config.js</span>
<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  devServer: {
    proxy: {
      <span class="hljs-comment">// 用户服务代理</span>
      <span class="hljs-string">'/user-api'</span>: {
        target: <span class="hljs-string">'http://user-service:3001'</span>,
        changeOrigin: <span class="hljs-literal">true</span>,
        pathRewrite: {
          <span class="hljs-string">'^/user-api'</span>: <span class="hljs-string">'/api'</span>
        },
        logLevel: <span class="hljs-string">'debug'</span> <span class="hljs-comment">// 开启调试日志</span>
      },
      <span class="hljs-comment">// 商品服务代理</span>
      <span class="hljs-string">'/product-api'</span>: {
        target: <span class="hljs-string">'http://product-service:3002'</span>,
        changeOrigin: <span class="hljs-literal">true</span>,
        pathRewrite: {
          <span class="hljs-string">'^/product-api'</span>: <span class="hljs-string">'/api'</span>
        }
      },
      <span class="hljs-comment">// WebSocket代理</span>
      <span class="hljs-string">'/ws-api'</span>: {
        target: <span class="hljs-string">'ws://websocket-service:3003'</span>,
        changeOrigin: <span class="hljs-literal">true</span>,
        ws: <span class="hljs-literal">true</span>
      }
    }
  }
}
</code></pre>
<p><strong>3. 在Vue组件中使用</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/services/api.js</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-comment">// 创建axios实例</span>
<span class="hljs-keyword">const</span> api = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'/api'</span>, <span class="hljs-comment">// 使用代理的前缀</span>
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>
})

<span class="hljs-comment">// 请求拦截器</span>
api.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> {
    <span class="hljs-comment">// 在发送请求之前做些什么</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>)
    <span class="hljs-keyword">if</span> (token) {
      config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>
    }
    <span class="hljs-keyword">return</span> config
  },
  <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
  }
)

<span class="hljs-comment">// 响应拦截器</span>
api.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
  },
  <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 处理响应错误</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {
      <span class="hljs-comment">// 未授权，跳转到登录页</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/login'</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
  }
)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> api

<span class="hljs-comment">// 在Vue组件中使用</span>
<span class="hljs-comment">// src/components/UserList.vue</span>
&lt;script&gt;
<span class="hljs-keyword">import</span> api <span class="hljs-keyword">from</span> <span class="hljs-string">'@/services/api'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'UserList'</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">users</span>: [],
      <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>
    }
  },
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchUsers</span>()
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchUsers</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 实际请求会发送到代理服务器，然后转发到目标服务器</span>
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span> = response.<span class="hljs-property">data</span>
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户列表失败:'</span>, error)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户列表失败'</span>)
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
      }
    },
    
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">userData</span>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/users'</span>, userData)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">'用户创建成功'</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchUsers</span>() <span class="hljs-comment">// 刷新列表</span>
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'创建用户失败:'</span>, error)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'创建用户失败'</span>)
      }
    }
  }
}
&lt;/script&gt;
</code></pre>
<h5 data-id="heading-7">Vite项目配置</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()],
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">5173</span>,
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:3000'</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>),
        <span class="hljs-attr">configure</span>: <span class="hljs-function">(<span class="hljs-params">proxy, options</span>) =&gt;</span> {
          <span class="hljs-comment">// 代理配置回调</span>
          proxy.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err, _req, _res</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'proxy error'</span>, err)
          })
          proxy.<span class="hljs-title function_">on</span>(<span class="hljs-string">'proxyReq'</span>, <span class="hljs-function">(<span class="hljs-params">proxyReq, req, _res</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Sending Request:'</span>, req.<span class="hljs-property">method</span>, req.<span class="hljs-property">url</span>)
          })
        }
      }
    }
  }
})
</code></pre>
<h4 data-id="heading-8">代理工作原理流程图</h4>
<pre><code class="hljs language-bash" lang="bash">浏览器发送请求到 Unsupported markdown: linkVue开发服务器代理中间件检测到/api前缀重写请求路径转发到 Unsupported markdown: <span class="hljs-built_in">link</span>后端服务器返回响应数据
</code></pre>
<h4 data-id="heading-9">方案二：生产环境解决方案</h4>
<p>开发环境的代理配置在生产环境是无效的，我们需要其他方案：</p>
<h5 data-id="heading-10">1. Nginx反向代理</h5>
<p><strong>Nginx配置文件示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># nginx.conf</span>
server {
    listen 80<span class="hljs-comment">;</span>
    server_name your-domain.com<span class="hljs-comment">;</span>
    
    <span class="hljs-comment"># 前端静态文件</span>
    location / {
        root /usr/share/nginx/html<span class="hljs-comment">;</span>
        index index.html<span class="hljs-comment">;</span>
        try_files $uri $uri/ /index.html<span class="hljs-comment">;</span>
    }
    
    <span class="hljs-comment"># API代理配置</span>
    location /api/ {
        proxy_pass http://backend-server:3000/<span class="hljs-comment">;</span>
        proxy_set_header Host $host<span class="hljs-comment">;</span>
        proxy_set_header X-Real-IP $remote_addr<span class="hljs-comment">;</span>
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="hljs-comment">;</span>
        proxy_set_header X-Forwarded-Proto $scheme<span class="hljs-comment">;</span>
        
        <span class="hljs-comment"># CORS头（如果需要）</span>
        add_header Access-Control-Allow-Origin *<span class="hljs-comment">;</span>
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE'<span class="hljs-comment">;</span>
        add_header Access-Control-Allow-Headers '*'<span class="hljs-comment">;</span>
        
        <span class="hljs-comment"># 处理预检请求</span>
        if ($<span class="hljs-attr">request_method</span> = <span class="hljs-string">'OPTIONS'</span>) {
            add_header Access-Control-Allow-Origin *<span class="hljs-comment">;</span>
            add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE'<span class="hljs-comment">;</span>
            add_header Access-Control-Allow-Headers '*'<span class="hljs-comment">;</span>
            add_header Access-Control-Max-Age 86400<span class="hljs-comment">;</span>
            return 204<span class="hljs-comment">;</span>
        }
    }
    
    <span class="hljs-comment"># 静态资源缓存</span>
    location ~* .(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y<span class="hljs-comment">;</span>
        add_header Cache-Control "public, immutable"<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h5 data-id="heading-11">2. 后端配置CORS</h5>
<p><strong>Node.js Express示例：</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// server.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">express </span>= <span class="hljs-keyword">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">cors </span>= <span class="hljs-keyword">require</span>(<span class="hljs-string">'cors'</span>)

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">app </span>= <span class="hljs-title function_ invoke__">express</span>()

<span class="hljs-comment">// 基础CORS配置</span>
app.<span class="hljs-keyword">use</span>(<span class="hljs-title function_ invoke__">cors</span>())

<span class="hljs-comment">// 自定义CORS配置</span>
app.<span class="hljs-keyword">use</span>(<span class="hljs-title function_ invoke__">cors</span>({
<span class="hljs-attr">  origin</span>: [
    <span class="hljs-string">'http://localhost:8080'</span>,
    <span class="hljs-string">'http://localhost:5173'</span>,
    <span class="hljs-string">'https://your-production-domain.com'</span>
  ],
<span class="hljs-attr">  methods</span>: [<span class="hljs-string">'GET'</span>, <span class="hljs-string">'POST'</span>, <span class="hljs-string">'PUT'</span>, <span class="hljs-string">'DELETE'</span>, <span class="hljs-string">'OPTIONS'</span>],
<span class="hljs-attr">  allowedHeaders</span>: [<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'Authorization'</span>, <span class="hljs-string">'X-Requested-With'</span>],
<span class="hljs-attr">  credentials</span>: <span class="hljs-literal">true</span>, // 允许携带cookie
<span class="hljs-attr">  maxAge</span>: <span class="hljs-number">86400</span> // 预检请求缓存时间
}))

<span class="hljs-comment">// 或者针对特定路由配置CORS</span>
app.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/api/data'</span>, <span class="hljs-title function_ invoke__">cors</span>(), (req, res) =&gt; {
  res.<span class="hljs-title function_ invoke__">json</span>({<span class="hljs-attr"> message</span>: <span class="hljs-string">'This route has CORS enabled'</span> })
})

<span class="hljs-comment">// 手动设置CORS头</span>
app.<span class="hljs-keyword">use</span>((req, res, next) =&gt; {
  res.<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'https://your-domain.com'</span>)
  res.<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Access-Control-Allow-Methods'</span>, <span class="hljs-string">'GET, POST, PUT, DELETE, OPTIONS'</span>)
  res.<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Access-Control-Allow-Headers'</span>, <span class="hljs-string">'Content-Type, Authorization'</span>)
  res.<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Access-Control-Allow-Credentials'</span>, <span class="hljs-string">'true'</span>)
  
  <span class="hljs-keyword">if</span><span class="hljs-title function_ invoke__"> </span>(req.method === <span class="hljs-string">'OPTIONS'</span>) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_ invoke__">sendStatus</span>(<span class="hljs-number">200</span>)
  }
  
  <span class="hljs-title function_ invoke__">next</span>()
})

app.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/api/users'</span>, (req, res) =&gt; {
  res.<span class="hljs-title function_ invoke__">json</span>([{<span class="hljs-attr"> id</span>: <span class="hljs-number">1</span>,<span class="hljs-attr"> name</span>: <span class="hljs-string">'John'</span> }, {<span class="hljs-attr"> id</span>: <span class="hljs-number">2</span>,<span class="hljs-attr"> name</span>: <span class="hljs-string">'Jane'</span> }])
})

app.<span class="hljs-title function_ invoke__">listen</span>(<span class="hljs-number">3000</span>, () =&gt; {
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">'Server running on port 3000'</span>)
})
</code></pre>
<h4 data-id="heading-12">方案三：JSONP（适用于老项目）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JSONP工具函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">jsonp</span>(<span class="hljs-params">url, callbackName = <span class="hljs-string">'callback'</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-comment">// 创建script标签</span>
    <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>)
    <span class="hljs-keyword">const</span> callbackFunctionName = <span class="hljs-string">`jsonp_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>)}</span>`</span>
    
    <span class="hljs-comment">// 设置全局回调函数</span>
    <span class="hljs-variable language_">window</span>[callbackFunctionName] = <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-comment">// 清理工作</span>
      <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">window</span>[callbackFunctionName]
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(script)
      <span class="hljs-title function_">resolve</span>(data)
    }
    
    <span class="hljs-comment">// 处理URL，添加回调参数</span>
    <span class="hljs-keyword">const</span> separator = url.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'?'</span>) ? <span class="hljs-string">'&amp;'</span> : <span class="hljs-string">'?'</span>
    script.<span class="hljs-property">src</span> = <span class="hljs-string">`<span class="hljs-subst">${url}</span><span class="hljs-subst">${separator}</span><span class="hljs-subst">${callbackName}</span>=<span class="hljs-subst">${callbackFunctionName}</span>`</span>
    
    <span class="hljs-comment">// 错误处理</span>
    script.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">window</span>[callbackFunctionName]
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(script)
      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'JSONP request failed'</span>))
    }
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(script)
  })
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">jsonp</span>(<span class="hljs-string">'http://api.example.com/data'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Received data:'</span>, data)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error:'</span>, error)
  }
}
</code></pre>
<h3 data-id="heading-13">环境区分的最佳实践</h3>
<p>在实际项目中，我们需要根据环境使用不同的配置：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// src/config/index.js</span>
<span class="hljs-type">const</span> config = {
  <span class="hljs-comment">// 开发环境</span>
  development: {
    baseURL: <span class="hljs-string">'/api'</span> <span class="hljs-comment">// 使用代理</span>
  },
  <span class="hljs-comment">// 测试环境</span>
  test: {
    baseURL: <span class="hljs-string">'https://test-api.yourcompany.com'</span>
  },
  <span class="hljs-comment">// 生产环境</span>
  production: {
    baseURL: <span class="hljs-string">'https://api.yourcompany.com'</span>
  }
}

<span class="hljs-type">const</span> environment = process.env.NODE_ENV || <span class="hljs-string">'development'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> config[environment]
</code></pre>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// src/services/api.js</span>
<span class="hljs-keyword">import</span> config from <span class="hljs-string">'@/config'</span>
<span class="hljs-keyword">import</span> axios from <span class="hljs-string">'axios'</span>

<span class="hljs-type">const</span> api = axios.<span class="hljs-built_in">create</span>({
  baseURL: config.baseURL,
  timeout: <span class="hljs-number">10000</span>
})

<span class="hljs-comment">// 环境判断</span>
<span class="hljs-keyword">if</span> (process.env.NODE_ENV === <span class="hljs-string">'development'</span>) {
  <span class="hljs-comment">// 开发环境特殊处理</span>
  api.interceptors.request.<span class="hljs-built_in">use</span>(request =&gt; {
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'开发环境请求:'</span>, request)
    <span class="hljs-keyword">return</span> request
  })
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> api
</code></pre>
<h3 data-id="heading-14">完整的工作流程图</h3>
<pre><code class="hljs">开发环境

生产环境

Vue应用发起请求判断当前环境使用开发服务器代理使用生产环境API地址Vue开发服务器接收请求代理中间件处理转发到目标服务器直接请求生产APINginx反向代理后端API服务器返回响应数据
</code></pre>
<h3 data-id="heading-15">常见问题与解决方案</h3>
<h4 data-id="heading-16">1. 代理不生效怎么办？</h4>
<p><strong>检查步骤：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 检查vue.config.js配置是否正确</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">devServer</span>: {
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:3000'</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-comment">// 添加日志查看代理是否工作</span>
        <span class="hljs-attr">onProxyReq</span>: <span class="hljs-function">(<span class="hljs-params">proxyReq, req, res</span>) =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Proxying request:'</span>, req.<span class="hljs-property">url</span>, <span class="hljs-string">'-&gt;'</span>, proxyReq.<span class="hljs-property">path</span>)
        }
      }
    }
  }
}

<span class="hljs-comment">// 2. 检查网络面板，确认请求是否发送到正确地址</span>
<span class="hljs-comment">// 3. 确认后端服务是否正常运行</span>
</code></pre>
<h4 data-id="heading-17">2. 预检请求(OPTIONS)处理</h4>
<pre><code class="hljs language-lua" lang="lua">// 后端需要正确处理OPTIONS请求
app.use(<span class="hljs-string">'/api/*'</span>, (req, res, <span class="hljs-built_in">next</span>) =&gt; {
  <span class="hljs-keyword">if</span> (req.method === <span class="hljs-string">'OPTIONS'</span>) {
    res.header(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'*'</span>)
    res.header(<span class="hljs-string">'Access-Control-Allow-Methods'</span>, <span class="hljs-string">'GET, POST, PUT, DELETE, OPTIONS'</span>)
    res.header(<span class="hljs-string">'Access-Control-Allow-Headers'</span>, <span class="hljs-string">'Content-Type, Authorization'</span>)
    res.<span class="hljs-built_in">status</span>(<span class="hljs-number">200</span>).<span class="hljs-keyword">end</span>()
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-built_in">next</span>()
})
</code></pre>
<h3 data-id="heading-18">总结</h3>
<p>跨域问题是前端开发中的常见挑战，但通过合适的解决方案可以轻松应对：</p>
<ul>
<li>• <strong>开发环境</strong>：使用Vue CLI或Vite的代理功能</li>
<li>• <strong>生产环境</strong>：使用Nginx反向代理或后端配置CORS</li>
<li>• <strong>特殊情况</strong>：考虑JSONP或WebSocket代理</li>
</ul>
<p>记住，<strong>安全始终是首要考虑因素</strong>。在配置CORS时，不要简单地使用<code>*</code>作为允许的源，而应该明确指定可信的域名。</p>
<p>希望这篇详细的指南能帮助你彻底解决Vue项目中的跨域问题！如果你有任何疑问或补充，欢迎在评论区留言讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拒绝卡顿！小程序图片本地“极速”旋转与格式转换，离屏 Canvas 性能调优实战]]></title>    <link>https://juejin.cn/post/7577689171223248946</link>    <guid>https://juejin.cn/post/7577689171223248946</guid>    <pubDate>2025-11-30T02:43:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577689171223248946" data-draft-id="7577718777481789478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝卡顿！小程序图片本地“极速”旋转与格式转换，离屏 Canvas 性能调优实战"/> <meta itemprop="keywords" content="前端,JavaScript,微信小程序"/> <meta itemprop="datePublished" content="2025-11-30T02:43:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小皮虾"/> <meta itemprop="url" content="https://juejin.cn/user/1468603263091623"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝卡顿！小程序图片本地“极速”旋转与格式转换，离屏 Canvas 性能调优实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1468603263091623/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小皮虾
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T02:43:04.000Z" title="Sun Nov 30 2025 02:43:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 背景与痛点：高清大图的“崩溃”瞬间</h2>
<p>在开发小程序图片工具时，我们经常面临“两难”境地：</p>
<ol>
<li><strong>用户上传原图</strong>：现代手机拍摄的照片动辄 4000x3000 分辨率，在 iOS 设备上 DPR（设备像素比）通常为 3。</li>
<li><strong>内存爆炸</strong>：如果直接按原图渲染，画布像素高达 <code>(4000*3) * (3000*3) ≈ 1亿像素</code>！这远超小程序的 Canvas 内存限制，导致<strong>微信客户端直接闪退</strong>。</li>
<li><strong>传统方案弊端</strong>：上传服务器处理费流量且慢；普通 Canvas 渲染又卡顿界面。</li>
</ol>
<p>为了解决这个问题，我们打磨出了一套基于 <code>OffscreenCanvas</code> 的高性能本地处理方案，核心在于“<strong>智能计算，动态降级</strong>”。</p>
<h2 data-id="heading-1">2. 核心思路：离屏渲染 + 智能防爆</h2>
<p>我们的方案包含两个关键技术点：</p>
<ol>
<li>
<p><strong>OffscreenCanvas（2D 离屏画布）</strong>：
相比传统 Canvas，它在内存中渲染，不占用 DOM，没有任何 UI 开销，绘图指令执行极快。</p>
</li>
<li>
<p><strong>智能 DPR 限制（核心黑科技）</strong>：
这是防止闪退的关键。我们在绘制前计算“目标画布尺寸”。</p>
<ul>
<li><strong>判断</strong>：如果 <code>逻辑尺寸 * 系统DPR</code> 超过了安全阈值（如 4096px）。</li>
<li><strong>降级</strong>：强制降低使用的 DPR 值，确保最终纹理尺寸在安全范围内。</li>
<li><strong>结果</strong>：牺牲肉眼难以察觉的极微小清晰度，换取 <strong>100% 不闪退</strong> 的稳定性。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-2">3. 硬核代码实现</h2>
<p>以下是<code>帮小忙工具箱</code>小程序封装好的 <code>imageUtils.js</code> 核心源代码，包含<strong>格式转换</strong>和<strong>带防爆逻辑的旋转</strong>功能。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/imageUtils.js</span>

<span class="hljs-comment">// 1. 获取系统基础信息</span>
<span class="hljs-keyword">const</span> wxt = {
  <span class="hljs-attr">dpr</span>: wx.<span class="hljs-title function_">getSystemInfoSync</span>().<span class="hljs-property">pixelRatio</span> || <span class="hljs-number">2</span>
};

<span class="hljs-comment">// 2. 图片对象缓存池（避免重复加载同一张图）</span>
<span class="hljs-keyword">const</span> cacheCanvasImageMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-comment">/**
 * 内部方法：获取/创建 Canvas Image 对象
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCanvasImage</span>(<span class="hljs-params">canvas, imageUrl</span>) {
  <span class="hljs-keyword">if</span> (cacheCanvasImageMap.<span class="hljs-title function_">has</span>(imageUrl)) {
    <span class="hljs-keyword">return</span> cacheCanvasImageMap.<span class="hljs-title function_">get</span>(imageUrl);
  }
  
  <span class="hljs-comment">// 兼容 Promise.withResolvers 或使用 new Promise</span>
  <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
  <span class="hljs-keyword">const</span> image = canvas.<span class="hljs-title function_">createImage</span>();
  image.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
    cacheCanvasImageMap.<span class="hljs-title function_">set</span>(imageUrl, image);
    <span class="hljs-title function_">resolve</span>(image);
  };
  image.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`图片加载失败: <span class="hljs-subst">${e.errMsg}</span>`</span>));
  image.<span class="hljs-property">src</span> = imageUrl;
  <span class="hljs-keyword">await</span> promise;
  <span class="hljs-keyword">return</span> image;
}

<span class="hljs-comment">/**
 * 功能一：离屏 Canvas 转换图片格式 (PNG/HEIC -&gt; JPG)
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} imageUrl 图片路径
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} destFileType 目标类型 'jpg' | 'png'
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} quality 质量 0-1
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">convertImageType</span>(<span class="hljs-params">imageUrl, destFileType = <span class="hljs-string">'jpg'</span>, quality = <span class="hljs-number">1</span></span>) {
  <span class="hljs-keyword">const</span> offscreenCanvas = wx.<span class="hljs-title function_">createOffscreenCanvas</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'2d'</span> });
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getCanvasImage</span>(offscreenCanvas, imageUrl);
  <span class="hljs-keyword">const</span> { width, height } = image;

  <span class="hljs-comment">// 基础转换：直接使用系统 DPR 保证高清</span>
  offscreenCanvas.<span class="hljs-property">width</span> = width * wxt.<span class="hljs-property">dpr</span>;
  offscreenCanvas.<span class="hljs-property">height</span> = height * wxt.<span class="hljs-property">dpr</span>;

  <span class="hljs-keyword">const</span> ctx = offscreenCanvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
  ctx.<span class="hljs-title function_">scale</span>(wxt.<span class="hljs-property">dpr</span>, wxt.<span class="hljs-property">dpr</span>);
  ctx.<span class="hljs-title function_">drawImage</span>(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);

  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> wx.<span class="hljs-title function_">canvasToTempFilePath</span>({
    <span class="hljs-attr">canvas</span>: offscreenCanvas,
    <span class="hljs-attr">fileType</span>: destFileType,
    <span class="hljs-attr">quality</span>: quality,
  });
  <span class="hljs-keyword">return</span> res.<span class="hljs-property">tempFilePath</span>;
}

<span class="hljs-comment">/**
 * 功能二：极速旋转图片 (含内存保护)
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} imageUrl 图片路径
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} degree 旋转角度 (90, 180, 270...)
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">rotateImage</span>(<span class="hljs-params">imageUrl, degree = <span class="hljs-number">90</span>, destFileType = <span class="hljs-string">'jpg'</span>, quality = <span class="hljs-number">1</span></span>) {
  <span class="hljs-keyword">const</span> offscreenCanvas = wx.<span class="hljs-title function_">createOffscreenCanvas</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'2d'</span> });
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getCanvasImage</span>(offscreenCanvas, imageUrl);
  <span class="hljs-keyword">const</span> { width, height } = image;

  <span class="hljs-keyword">const</span> radian = (degree * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>) / <span class="hljs-number">180</span>;
  
  <span class="hljs-comment">// 1. 计算旋转后的逻辑包围盒宽高</span>
  <span class="hljs-keyword">const</span> newWidth = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(width * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(radian)) + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(height * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(radian));
  <span class="hljs-keyword">const</span> newHeight = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(width * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(radian)) + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(height * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(radian));

  <span class="hljs-comment">// --- ⚡️ 性能优化核心 Start ---</span>
  
  <span class="hljs-comment">// 2. 智能计算 DPR：避免画布过大炸内存</span>
  <span class="hljs-comment">// 设定安全纹理阈值，4096px 是大多数移动端 GPU 的安全线</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LIMIT_SIZE</span> = <span class="hljs-number">4096</span>; 
  <span class="hljs-keyword">let</span> useDpr = wxt.<span class="hljs-property">dpr</span>;

  <span class="hljs-comment">// 核心判断：如果 (逻辑边长 * dpr) 超过限制，自动计算最大允许的 dpr</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(newWidth, newHeight) * useDpr &gt; <span class="hljs-variable constant_">LIMIT_SIZE</span>) {
    useDpr = <span class="hljs-variable constant_">LIMIT_SIZE</span> / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(newWidth, newHeight);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[ImageRotate] 图片过大，触发自动降级，DPR调整为: <span class="hljs-subst">${useDpr.toFixed(<span class="hljs-number">2</span>)}</span>`</span>);
  }

  <span class="hljs-comment">// 3. 设置物理画布尺寸 (使用计算后的安全 DPR)</span>
  offscreenCanvas.<span class="hljs-property">width</span> = newWidth * useDpr;
  offscreenCanvas.<span class="hljs-property">height</span> = newHeight * useDpr;

  <span class="hljs-keyword">const</span> ctx = offscreenCanvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
  ctx.<span class="hljs-title function_">scale</span>(useDpr, useDpr); 
  
  <span class="hljs-comment">// --- 性能优化核心 End ---</span>

  <span class="hljs-comment">// 4. 绘图逻辑：平移 -&gt; 旋转 -&gt; 绘制</span>
  ctx.<span class="hljs-title function_">translate</span>(newWidth / <span class="hljs-number">2</span>, newHeight / <span class="hljs-number">2</span>);
  ctx.<span class="hljs-title function_">rotate</span>(radian);
  ctx.<span class="hljs-title function_">drawImage</span>(image, -width / <span class="hljs-number">2</span>, -height / <span class="hljs-number">2</span>, width, height);

  <span class="hljs-comment">// 5. 导出文件 </span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> wx.<span class="hljs-title function_">canvasToTempFilePath</span>({
    <span class="hljs-attr">canvas</span>: offscreenCanvas,
    <span class="hljs-attr">fileType</span>: destFileType,
    <span class="hljs-attr">quality</span>: quality,
  });

  <span class="hljs-keyword">return</span> res.<span class="hljs-property">tempFilePath</span>;
}
</code></pre>
<h2 data-id="heading-3">4. 避坑与实战经验</h2>
<ol>
<li><strong>图片转pdf场景经验</strong>
图片转成pdf，在使用<code>pdf-lib</code>插入图片时，只支持jpg、png在插入前先判断一下是否符合，用户可能上传webp等图片（有些人觉得限制上传类型，但图片后缀有可能被篡改过），就需要先转换；另外如果要保证pdf是纵向的，使用canvas提前确保图片为纵向的，就简单很多，无需在<code>pdf-lib</code>做坐标变换</li>
<li><strong>DPR 的取舍艺术</strong>：
很多开发者喜欢写死 <code>offscreenCanvas.width = width</code>，这样导出的图是模糊的。也有人写死 <code>width * systemDpr</code>，这会导致大图闪退。
<strong>最佳实践</strong>就是代码中的 <code>Math.min</code> 逻辑：<strong>在安全范围内，尽可能高清</strong>。</li>
<li><strong>兼容性提示</strong>：
代码中使用了 <code>Promise.withResolvers()</code>，这是 ES2024 新特性。我全局内置兼容代码。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 创建withResolvers函数
 */</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-property">withResolvers</span> =
	<span class="hljs-title class_">Promise</span>.<span class="hljs-property">withResolvers</span> ||
	<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
		<span class="hljs-keyword">let</span> resolve, reject;
		<span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res, rej</span>) =&gt;</span> {
			resolve = res;
			reject = rej;
		});
		<span class="hljs-keyword">return</span> {
			promise,
			resolve,
			reject,
		};
	};
</code></pre>
<h2 data-id="heading-4">写在最后</h2>
<p>通过这一套组合拳，我们成功在小程序中实现了稳定、高效的本地图片处理。无论用户使用几年前的安卓机还是最新的 iPhone，都能流畅地完成图片旋转与转换，再也不用担心内存溢出带来的闪退噩梦了！</p>
<p>希望这篇实战分享能帮你解决 Canvas 开发中的性能难题！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3 Composable介绍]]></title>    <link>https://juejin.cn/post/7577702891273551907</link>    <guid>https://juejin.cn/post/7577702891273551907</guid>    <pubDate>2025-11-30T03:38:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273551907" data-draft-id="7577702891273535523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3 Composable介绍"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T03:38:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南雨北斗"/> <meta itemprop="url" content="https://juejin.cn/user/4059818590476286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3 Composable介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059818590476286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南雨北斗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:38:54.000Z" title="Sun Nov 30 2025 03:38:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>好的，我们来深入探讨一下 <strong>Vue 3 的 Composable</strong>。</p>
<h3 data-id="heading-0">1. 什么是 Composable？</h3>
<p><code>Composable</code> 是 Vue 3 中一个核心的概念和功能，它是<strong>可复用的、有状态的逻辑块</strong>，用于封装和提取组件中的重复逻辑，让代码更清晰、更易于维护。</p>
<p>你可以把它理解为：<strong>专门用来存放 “可以被多个组件复用的业务逻辑” 的函数</strong>。</p>
<h3 data-id="heading-1">2. 为什么需要 Composable？</h3>
<p>在 Vue 2 中，我们通常使用 <strong>Mixins</strong> 来复用逻辑。但 Mixins 存在一些问题：</p>
<ul>
<li><strong>命名冲突</strong>：多个 Mixin 可能会定义相同名称的数据或方法，导致覆盖。</li>
<li><strong>来源不清晰</strong>：当一个组件使用了多个 Mixin 后，很难追踪某个数据或方法到底来自哪个 Mixin。</li>
<li><strong>逻辑耦合度高</strong>：Mixins 和组件之间是隐式依赖关系，不易于单独测试和维护。</li>
</ul>
<p>而 Composable 则完美解决了这些问题：</p>
<ul>
<li><strong>明确的依赖关系</strong>：通过函数调用和返回值来显式地传入和获取数据，来源清晰。</li>
<li><strong>无命名冲突</strong>：返回的内容通过解构赋值的方式被组件接收，组件可以自己决定命名。</li>
<li><strong>更好的类型推断</strong>：对于 TypeScript 非常友好，能提供完整的类型提示。</li>
<li><strong>更易于测试</strong>：Composable 本身就是一个函数，可以独立进行单元测试。</li>
</ul>
<h3 data-id="heading-2">3. 如何创建一个 Composable？</h3>
<p>创建一个 Composable 非常简单，它就是一个<strong>以 <code>use</code> 开头的函数</strong>（这是一个约定，便于识别），在函数内部可以使用 Vue 的响应式 API（如 <code>ref</code>, <code>reactive</code>, <code>computed</code>, <code>watch</code> 等），并返回需要暴露给组件使用的状态和方法。</p>
<p><strong>示例：创建一个处理计数器逻辑的 Composable</strong></p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/composables/useCounter.js</span>

<span class="hljs-keyword">import</span> { ref, computed, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 定义一个 Composable 函数，通常以 use 开头</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCounter</span>(<span class="hljs-params">initialValue = <span class="hljs-number">0</span></span>) {
  <span class="hljs-comment">// 1. 定义响应式状态</span>
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(initialValue);

  <span class="hljs-comment">// 2. 定义基于状态的计算属性</span>
  <span class="hljs-keyword">const</span> doubleCount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>);

  <span class="hljs-comment">// 3. 定义修改状态的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span>++;
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">decrement</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span>--;
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reset</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span> = initialValue;
  };

  <span class="hljs-comment">// 4. 可以使用生命周期钩子</span>
  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`计数器已初始化，初始值为: <span class="hljs-subst">${count.value}</span>`</span>);
  });

  <span class="hljs-comment">// 5. 返回需要暴露给组件的内容</span>
  <span class="hljs-keyword">return</span> {
    count,
    doubleCount,
    increment,
    decrement,
    reset
  };
}
</code></pre>
<h3 data-id="heading-3">4. 如何在组件中使用 Composable？</h3>
<p>在组件中，你只需要 <strong>导入并调用</strong> 这个 Composable 函数，然后通过<strong>解构赋值</strong>的方式获取其返回的状态和方法即可。</p>
<p><strong>示例：在组件中使用 <code>useCounter</code></strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/components/CounterDisplay.vue --&gt;
&lt;template&gt;
  &lt;div&gt;
    &lt;p&gt;当前计数: {{ count }}&lt;/p&gt;
    &lt;p&gt;计数的两倍: {{ doubleCount }}&lt;/p&gt;
    &lt;button @click="increment"&gt;+1&lt;/button&gt;
    &lt;button @click="decrement"&gt;-1&lt;/button&gt;
    &lt;button @click="reset"&gt;重置&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { useCounter } from '@/composables/useCounter';

// 调用 Composable 函数
// 可以传入初始值，如 useCounter(10)
// 通过解构赋值获取返回的状态和方法
const { count, doubleCount, increment, decrement, reset } = useCounter();
&lt;/script&gt;
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>每次调用 <code>useCounter()</code>，都会创建一个<strong>全新的、独立的</strong>状态实例。这意味着如果两个组件都使用了 <code>useCounter</code>，它们的状态是完全隔离的，互不影响。</li>
<li>组件可以根据需要，只解构自己需要的部分。</li>
</ul>
<h3 data-id="heading-4">5. Composable 的最佳实践</h3>
<ol>
<li>
<p><strong>命名规范</strong>：</p>
<ul>
<li>Composable 函数名<strong>必须以 <code>use</code> 开头</strong>，例如 <code>useCounter</code>, <code>useUser</code>, <code>useCart</code>。</li>
<li>文件名通常与函数名一致，例如 <code>useCounter.js</code>。</li>
</ul>
</li>
<li>
<p><strong>单一职责原则</strong>：</p>
<ul>
<li>一个 Composable 应该只负责一个特定的功能或逻辑。如果一个 Composable 变得过于庞大和复杂，应该考虑将其拆分成多个更小的、职责更单一的 Composable。</li>
</ul>
</li>
<li>
<p><strong>组合与嵌套</strong>：</p>
<ul>
<li>
<p>Composable 可以<strong>相互调用</strong>。这是一个非常强大的特性，允许你构建复杂的逻辑。</p>
</li>
<li>
<p>例如，一个 <code>useCart</code> Composable 内部可以调用 <code>useUser</code> Composable 来获取当前用户信息，以便计算购物车商品的会员价格。</p>
</li>
</ul>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/composables/useCart.js</span>
<span class="hljs-keyword">import</span> { useUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useUser'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCart</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">useUser</span>(); <span class="hljs-comment">// 调用另一个 Composable</span>

  <span class="hljs-comment">// ... 购物车相关逻辑，可以使用 user 的信息</span>
  <span class="hljs-keyword">const</span> cartItems = <span class="hljs-title function_">ref</span>([]);
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">calculateDiscountPrice</span> = (<span class="hljs-params">item</span>) =&gt; {
    <span class="hljs-keyword">if</span> (user.<span class="hljs-property">value</span>?.<span class="hljs-property">isVIP</span>) {
      <span class="hljs-keyword">return</span> item.<span class="hljs-property">price</span> * <span class="hljs-number">0.9</span>; <span class="hljs-comment">// VIP 9 折</span>
    }
    <span class="hljs-keyword">return</span> item.<span class="hljs-property">price</span>;
  };

  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">return</span> { cartItems, calculateDiscountPrice };
}
</code></pre>
</li>
<li>
<p><strong>避免在 Composable 中访问组件实例</strong>：</p>
<ul>
<li>理想情况下，Composable 应该是<strong>纯逻辑</strong>的封装，不应该直接依赖于 Vue 组件实例 (<code>this</code>)。</li>
<li>如果确实需要使用组件实例的属性（如 <code>$route</code>, <code>$store</code>），应该通过参数的形式从组件中传递进来，或者使用 Vue 提供的 <code>getCurrentInstance()</code> 函数（但这会降低 Composable 的通用性，应谨慎使用）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-5">总结</h3>
<p><code>Composable</code> 是 Vue 3 中替代 <code>Mixins</code> 的<strong>更优、更现代</strong>的逻辑复用方案。</p>
<ul>
<li>它通过<strong>函数</strong>的形式封装逻辑，通过<strong>返回值</strong>暴露状态和方法。</li>
<li>它实现了<strong>逻辑的复用和隔离</strong>，让组件代码更简洁、更清晰。</li>
<li>它遵循<strong>明确的依赖关系</strong>和<strong>单一职责原则</strong>，极大地提升了代码的可维护性和可测试性。</li>
<li>在 Vue 3 项目中，<strong>任何可复用的逻辑都应该被提取为 Composable</strong>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript数组去重的多种实现方式]]></title>    <link>https://juejin.cn/post/7577705544875507750</link>    <guid>https://juejin.cn/post/7577705544875507750</guid>    <pubDate>2025-11-30T03:53:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544875507750" data-draft-id="7577737385954557962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript数组去重的多种实现方式"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-30T03:53:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="瓶子in"/> <meta itemprop="url" content="https://juejin.cn/user/3754212287597066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript数组去重的多种实现方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3754212287597066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    瓶子in
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:53:17.000Z" title="Sun Nov 30 2025 03:53:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在前端开发中，数组去重是一个常见的需求。无论是处理用户数据、API响应还是进行数据清洗，我们都需要掌握去重方法。本文将详细介绍JavaScript中数组去重的多种实现方式。</p>
<h3 data-id="heading-1">1. 使用Set数据结构（ES6推荐）</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = [...new Set(arr)]<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5, "a"]</span>
</code></pre>
<p><strong>Set</strong> 是 ES6 引入的一种新的数据结构，它类似于数组，但是成员的值都是唯一的，没有重复的值。</p>
<p>javascript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Set的基本使用</span>
const arr1 = new <span class="hljs-built_in">Set</span>()
arr1<span class="hljs-selector-class">.add</span>(<span class="hljs-number">1</span>)
arr1<span class="hljs-selector-class">.add</span>(<span class="hljs-number">2</span>)
arr1<span class="hljs-selector-class">.add</span>(<span class="hljs-number">3</span>)
arr1<span class="hljs-selector-class">.add</span>(<span class="hljs-number">1</span>)  <span class="hljs-comment">// 重复添加</span>
console<span class="hljs-selector-class">.log</span>(arr1)  <span class="hljs-comment">// {1, 2, 3} - 重复的自动过滤</span>
</code></pre>
<h3 data-id="heading-2">2. 使用filter + indexOf方法</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = arr.filter((item, index) =&gt; arr.indexOf(item) === index)<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5]</span>
</code></pre>
<p>这里利用了<code>filter</code>方法和<code>indexOf</code>方法的特性：</p>
<ul>
<li><code>filter</code>会遍历数组，将符合条件的元素组成新数组返回</li>
<li><code>indexOf</code>返回元素在数组中第一次出现的位置索引</li>
<li>只有当元素第一次出现时的索引与当前索引相等时，才保留该元素</li>
</ul>
<h3 data-id="heading-3">3. 使用reduce方法</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = arr.reduce((acc, current) =&gt; {
  return acc.includes(current) ? acc : <span class="hljs-section">[...acc, current]</span><span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5]</span>
</code></pre>
<p><code>reduce</code>方法通过累积器遍历数组，检查当前元素是否已存在于累积器中，不存在则添加。</p>
<h3 data-id="heading-4">4. 使用forEach + includes方法</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = []<span class="hljs-comment">;</span>
arr.forEach(<span class="hljs-attr">item</span> =&gt; {
  if (!uniqueArr.includes(item)) {
    uniqueArr.push(item)<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5]</span>
</code></pre>
<p>这种方法思路直观：</p>
<ul>
<li>创建空数组存储结果</li>
<li>遍历原数组，检查元素是否已存在</li>
<li>不存在则添加到结果数组</li>
</ul>
<p><strong>方法对比</strong>：</p>
<ul>
<li><code>forEach</code>：遍历数组执行操作，不关心返回值</li>
<li><code>map</code>：将数组转换为新数组（1:1映射）</li>
<li><code>filter</code>：根据条件筛选数组元素</li>
</ul>
<h3 data-id="heading-5">5. 对象数组去重（基于特定属性）</h3>
<p>实际开发中，我们经常需要根据对象属性去重：</p>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">users</span> = [
  {id: <span class="hljs-number">1</span>, name: <span class="hljs-string">'Alice'</span>},
  {id: <span class="hljs-number">2</span>, name: <span class="hljs-string">'Bob'</span>},
  {id: <span class="hljs-number">1</span>, name: <span class="hljs-string">'Alice'</span>},  // 重复
  {id: <span class="hljs-number">3</span>, name: <span class="hljs-string">'Charlie'</span>}
]<span class="hljs-comment">;</span>

// 方法1：使用Map（推荐）
const <span class="hljs-attr">uniqueUsers</span> = [...new Map(users.map(item =&gt; [item.id, item])).values()]<span class="hljs-comment">;</span>

// 方法2：使用reduce
const <span class="hljs-attr">uniqueUsers2</span> = users.reduce((acc, current) =&gt; {
  const <span class="hljs-attr">exists</span> = acc.find(item =&gt; item.id === current.id)<span class="hljs-comment">;</span>
  return exists ? acc : <span class="hljs-section">[...acc, current]</span><span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

console.log(uniqueUsers)<span class="hljs-comment">; // 基于id去重后的数组</span>
</code></pre>
<p>Map方法利用键的唯一性，将对象ID作为键，对象本身作为值，最后通过<code>values()</code>获取去重后的对象。</p>
<h3 data-id="heading-6">6. 复杂数据类型去重</h3>
<p>对于包含对象、数组等复杂数据类型的数组：</p>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">complexArr</span> = [{a:<span class="hljs-number">1</span>}, {a:<span class="hljs-number">1</span>}, [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], <span class="hljs-string">'hello'</span>, <span class="hljs-string">'hello'</span>]<span class="hljs-comment">;</span>

const <span class="hljs-attr">uniqueComplex</span> = complexArr.reduce((acc, current) =&gt; {
  const <span class="hljs-attr">isDuplicate</span> = acc.some(item =&gt;
    JSON.stringify(item) === JSON.stringify(current)
  )<span class="hljs-comment">;</span>
  return isDuplicate ? acc : <span class="hljs-section">[...acc, current]</span><span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

console.log(uniqueComplex)<span class="hljs-comment">; // 每个元素都是唯一的</span>
</code></pre>
<p>这种方法通过<code>JSON.stringify</code>将对象转为字符串进行比较，但要注意对象属性顺序必须一致。</p>
<h3 data-id="heading-7">7. 排序后去重（适用于可排序数据）</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = arr
  .sort((a, b) =&gt; a - b)
  .filter((item, index, array) =&gt;
    <span class="hljs-attr">index</span> === <span class="hljs-number">0</span> || item !== array[index - <span class="hljs-number">1</span>]
  )<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5]</span>
</code></pre>
<p>先排序，然后过滤掉与前一元素相同的元素。注意这会改变原数组的顺序。</p>
<h3 data-id="heading-8">性能对比与使用建议</h3>

























<table><thead><tr><th>方法</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Set</strong></td><td>简单数据类型，现代浏览器</td></tr><tr><td><strong>filter+indexOf</strong></td><td>兼容性要求高</td></tr><tr><td><strong>reduce</strong></td><td>需要自定义逻辑</td></tr><tr><td><strong>Map对象</strong></td><td>对象数组去重</td></tr></tbody></table>
<p><strong>日常开发建议</strong>：</p>
<ul>
<li>简单数组去重：优先使用 <code>[...new Set(arr)]</code></li>
<li>对象数组去重：使用 <code>Map</code> 方法</li>
<li>兼容性要求：使用 <code>filter + indexOf</code></li>
<li>复杂数据：使用 <code>reduce + JSON.stringify</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于微前端框架wujie的一次企业级应用实践demo？]]></title>    <link>https://juejin.cn/post/7577713754563346484</link>    <guid>https://juejin.cn/post/7577713754563346484</guid>    <pubDate>2025-11-30T05:33:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577713754563346484" data-draft-id="7350181789530374195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于微前端框架wujie的一次企业级应用实践demo？"/> <meta itemprop="keywords" content="前端,Vue.js,React.js"/> <meta itemprop="datePublished" content="2025-11-30T05:33:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="寻找光_sxy"/> <meta itemprop="url" content="https://juejin.cn/user/1495754537711661"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于微前端框架wujie的一次企业级应用实践demo？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1495754537711661/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    寻找光_sxy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:33:25.000Z" title="Sun Nov 30 2025 05:33:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin:30px 0 10px;color:#cca152;position:relative;padding-left:50px;border-bottom:2px solid rgba(209,163,78,.6);padding-bottom:0}.markdown-body h1{font-size:30px}.markdown-body h1:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:80%;bottom:-10px;left:-2px}.markdown-body h2{font-size:24px}.markdown-body h2:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:70%;bottom:-15px;left:-1px}.markdown-body h3{font-size:18px}.markdown-body h3:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:60%;bottom:-19px;left:-2px}.markdown-body h4{font-size:16px;padding-left:0;border-bottom:1px solid rgba(209,163,78,.6)}.markdown-body h5{font-size:15px;padding-left:0}.markdown-body em{color:#cca152}.markdown-body del{text-decoration-color:#cca152;text-decoration-thickness:2px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:80%;margin:6px auto;box-shadow:0 6px 15px #8e8e8e;display:block;margin:20px auto!important;object-fit:contain;border-radius:8px}.markdown-body hr{border:none;border-top:2px solid #e0c9a1;margin-top:32px 0}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background:#f6efde;color:#b69454;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Mono,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;background:#fef6e1;border-radius:4px;box-shadow:0 0 8px hsla(0,0%,47%,.45)}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAOCAMAAABaWb9VAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAADsQAAA7EAZUrDhsAAACHUExURUdwTMxCKdc8NvdYT/9hVyLJPABBAGubKNiIOv+/K+ytJBakH9aZG+5QR5VZDOBDPhmtJ8+VGuGjH/CwJR26MR6+NBq0LPW1KBmwKetNRfJUTONHP92fHuSmIeFEPhu3LR29M/BTS+mqIuqsI5qdHyLKPP++Kv9gVf9lW//KLSXXQCTQP//FLMVm5KQAAAAldFJOUwAlPPz7+woBBPu8Mzu+FlRRKmvnweeG+Wqg6mVNXmuc1OCbmjZJWF/9AAABKklEQVQoz3WS6XaCMBCFRzAM++KGsqhtDwES3//5OtmA2uP9A9zwzRoAgBC0QgQrdA68OZsDr229YGHoIEj7Pl0ZOgjKa5lYJ4Rd1vijn3nuD4Qurjmv48o6RFyfbGDnS6DeEXZfk5ZfuBhdPb9I87ECNMh1EFJKIU6agWzaa01NbmLkxznSmmObJBkkUxrERf3i+ftRiZi7ShPCYY64UhTx1AR5CDYoMXkOKEY7GmTcTzeD/FiER68DfSLgSRqEIBoB3P8h3x8RZhBXGJGusJdD6rfCBl0YqvZNkrV9zej2cWlfJWG6fRpyM41qYH+GTPPi2yFLQYC0Qybm5o96lW77kMbcrBKtgeWTsthVamNXFF4I6x0DTPuugsVRFyYpyxzWqNvHJwed8ws7QyP1UwjNjwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fef6e1}.markdown-body a{text-decoration:none;color:#d8ac5a;border-bottom:1px solid #d8ac5a}.markdown-body a:active,.markdown-body a:hover{color:#93753f;border-color:#93753f}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f4e8c7;border-collapse:collapse}.markdown-body thead{background:rgba(255,227,176,.6588235294);text-align:left;display:table-header-group;border-bottom:1px solid rgba(255,227,176,.6588235294)}.markdown-body tbody{background:rgba(255,247,229,.3882352941)}.markdown-body td,.markdown-body th{padding:7px;line-height:24px;min-width:100px}.markdown-body blockquote{color:#bd954f;padding:1px 23px;margin:22px 0;border-left:4px solid #dcb267;background-color:#fff7e5}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol .task-list-item,.markdown-body ul .task-list-item{list-style:none}.markdown-body ol li{padding-left:6px}.markdown-body::marker{color:#dcb267}.markdown-body .contains-task-list{padding-left:0}.markdown-body .contains-task-list .task-list-item{list-style:none;position:relative}.markdown-body .contains-task-list .task-list-item input[type=checkbox]{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:before{content:"";display:inline-block;height:12px;width:12px;position:absolute;left:-2px;top:-2px;border:2px solid #cda152;border-radius:5px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked:before{border:none;content:"";display:inline-block;height:17px;width:17px;position:absolute;left:-2px;top:-2px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/3AAAAAXNSR0IArs4c6QAAAYhJREFUOBFjYACC0/MDGsDEiyvr/zOCeUwMJxn/A8HZRUEMYBFGJsZ6kFoQYALiAyAGCgDpA+sFijKeWRj4H1kWpIWBW1SDQcm+BCzOAiK/vr7BcO/gDbAAI4hE1waWgRBnmWCGIwkyKFjnwow0BhsJk9QLncvw5dV1oPE9MCEGmBWrgCKhcFEowyR+PSNYwemFAZ4M/xjMkRWYJm5oAPFB/joDpI1BHHQANgGPDxj+//vfCA4IdJ3GcevgQnAFhlHLwYIgSVA0wABcwY3tFQzokiBFGIEP0wmigW5wZAK5FFkQib0a6NUDcEmgb7AGFpIGZOZqoMFhIAFQknEAJpn9yLLEssFOBCp2IFaDkl0xg6C8FbJyB3gowUS5RdQYBORQYpVB1iwVHIIMwJh///AYTCmYRklNIBFmNi4GeYt0BhnjeIa3dw8wSBlEgDUhxw2yCRgGfHp2geHiqiSwUwUVrFAiFVkjjA1LrjgTHEwhFvosMCZM4NEIUoAtWWNoBGZ70/gN22HiAD2uhAzsYNBZAAAAAElFTkSuQmCC) 0 0 no-repeat;background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文将介绍我一种<code>wujie</code>的一次具体的应用，包括使用的场景、方式等等，完成一个具体的demo；</p>
<h2 data-id="heading-1">为什么要用微前端</h2>
<p>事情是这样的，我们之前的业务有一个<code>vue3+ts+vite</code>的后台项目，后来公司决定新开发一个新的业务线，但是由于人力有限，如果重新搭建一个新的后台时间和人力成本较大都，尤其是其中的<code>权限</code>、<code>登录</code>功能的设计都比较复杂，所以我们综合考虑，有没有一种可以直接用旧后台的权限和登录功能，然后其它功能完全隔离的，且旧后台和新后台可用两个部门的人来开发，可以独立开发、测试、部署，甚至技术栈也可以不受影响呢？这里我们想到了微前端方案；</p>
<h2 data-id="heading-2">微前端方案选择</h2>
<p>我们经过调研，目光逐步瞄向了两种微前端的方案:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwujie-micro.github.io%2Fdoc%2F" target="_blank" title="https://wujie-micro.github.io/doc/" ref="nofollow noopener noreferrer">无界</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fqiankun.umijs.org%2Fzh" target="_blank" title="https://qiankun.umijs.org/zh" ref="nofollow noopener noreferrer">乾坤</a>；</p>
<p>对比我们的业务，经过调研发现无界相比于乾坤更有优势:</p>
<ul>
<li>1、对旧后台项目影响较小，侵入程度低：只需要在旧有后台的项目上新起page页，以及新增一个路由即可；</li>
<li>2、可单独开发、部署：子应用可以单独开发、部署，也可以使用一个全新的技术栈，即使生产环境无界挂了，出现问题了，也可以直接访问子应用；</li>
</ul>
<p>综上两种原因，我们决定使用无界的方案；</p>
<h2 data-id="heading-3">怎么用无界（demo演示）</h2>
<p>我们的主应用是<code>vue3</code>，这里将子应用通过菜单栏的形式嵌入到父应用中间，点击菜单即可进入到子应用</p>
<p><strong>登录场景</strong>，在子应用请求时，若发现登录失效，通过子组件通信<code>window.$wujie.bus.$emit('notLogin')</code>向父应用传递未登录消息，父应用执行后续逻辑</p>
<p><strong>权限逻辑</strong>，天然就互通，当子应用的<code>菜单权限</code>在某些角色下不可见时，在父应用下直接隐藏掉菜单就行；如果是子应用下<code>按钮权限</code>等功能权限时，可在子应用单独再次调用权限接口，或通过父子应用通信方式获取权限信息
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c1e77b2059e49ed8bf24cc1f3ebb356~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=1XXEN7ik87e2t3t3jRdIUJ%2FK5vM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">具体步骤</h2>
<h3 data-id="heading-5">父应用改造</h3>
<ul>
<li>下载新依赖</li>
<li>wujie相关文件</li>
<li>路由
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbe03c9176f246e799289572f8820601~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=YS5cSbUIJmQ0DNrIrSWwPlI8%2FOQ%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h4 data-id="heading-6">下载相关依赖</h4>
<pre><code class="hljs language-js" lang="js">pnpm install wujie-vue3
</code></pre>
<h4 data-id="heading-7">创建wujie文件</h4>
<p>用于补充<code>wujie</code>的相关逻辑：</p>
<ul>
<li><code>wujie</code>的<code>template</code>及<code>相关属性</code>
<ul>
<li><code>name</code>: 子应用唯一标识</li>
<li><code>url</code>: 子应用运行地址</li>
<li><code>props</code>：向子应用传递的参数</li>
</ul>
</li>
<li>父子应用通信
<ul>
<li>通知子应用路由发生改变</li>
<li>通知子应用其他数据</li>
<li>子应用告知父应用未登录</li>
<li>子应用告知父应用其他信息
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf33bbea958246a6943ccb1638f33669~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=eNUjHxP%2BsNOsC%2BydBtLw4Hha5AE%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Vue3 主应用<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 嵌入 React 子应用 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">WujieVue</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100%"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"600px"</span> <span class="hljs-attr">:url</span>=<span class="hljs-string">"subAppUrl"</span> <span class="hljs-attr">:name</span>=<span class="hljs-string">"subAppName"</span> <span class="hljs-attr">:props</span>=<span class="hljs-string">"subAppProps"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue-router"</span>;
<span class="hljs-keyword">import</span> { watch } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">WujieVue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"wujie-vue3"</span>;

<span class="hljs-keyword">const</span> { bus } = <span class="hljs-title class_">WujieVue</span>;

<span class="hljs-comment">// 子应用配置（React 子应用的运行地址，后续启动子应用后会用到）</span>
<span class="hljs-keyword">const</span> subAppName = <span class="hljs-title function_">ref</span>(<span class="hljs-string">"react-sub-app"</span>); <span class="hljs-comment">// 子应用唯一标识（必须唯一）</span>
<span class="hljs-keyword">const</span> subAppUrl = <span class="hljs-title function_">ref</span>(<span class="hljs-string">"http://localhost:1074/#/wujieDemo1"</span>); <span class="hljs-comment">// 子应用端口（后续配置 React 子应用为 3001）</span>

<span class="hljs-comment">// 主应用向子应用传递的 props（可选）</span>
<span class="hljs-keyword">const</span> subAppProps = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">mainAppName</span>: <span class="hljs-string">"Vue3 主应用"</span>,
  <span class="hljs-attr">token</span>: <span class="hljs-string">"main-app-token-123"</span>,
});

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
<span class="hljs-comment">/** 监听子应用的数据 */</span>
bus.$on(<span class="hljs-string">"subAppData"</span>, <span class="hljs-function">(<span class="hljs-params">data: { type: string, payload?: any }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { type } = data;
  <span class="hljs-keyword">if</span> (type == <span class="hljs-string">"noLogin"</span>) {
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">"未登录"</span>)
  }
});

<span class="hljs-comment">/** 监听子应用的数据 */</span>


<span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> router.<span class="hljs-property">currentRoute</span>.<span class="hljs-property">value</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">subAppPath</span>,
  <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (newVal === <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span>;
    bus.$emit(<span class="hljs-string">"routeChange"</span>, newVal);
  },
  {
    <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>,
  }
);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-8">创建wujie路由</h4>
<p>这里新建了一个路由的文件<code>wujieRouter.ts</code></p>
<p>通过监听<code>subAppPath</code>去判断跳转到子应用对应路由，且这里的<code>subAppPath</code>其实对应的是子应用的路由<code>path</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> routerName = <span class="hljs-string">"wujiePage"</span>;

<span class="hljs-keyword">const</span> wujieRouters = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">`/<span class="hljs-subst">${routerName}</span>`</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${routerName}</span>`</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"@/pages/wujie/index.vue"</span>),
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'新项目-react'</span>, <span class="hljs-comment">// 菜单显示文本</span>
      <span class="hljs-attr">icon</span>: <span class="hljs-string">'CreditCard'</span>, <span class="hljs-comment">// 菜单图标</span>
      <span class="hljs-attr">hidden</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">level</span>: <span class="hljs-number">0</span>,
    },
    <span class="hljs-attr">children</span>: [
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">"wujieDemo1"</span>, <span class="hljs-comment">// 子路由直接使用相对路径，不要包含父路由名称</span>
        <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${routerName}</span>wujieDemo1`</span>, <span class="hljs-comment">// 名称保持唯一，不要使用斜杠</span>
        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"@/pages/wujie/wujie.vue"</span>),
        <span class="hljs-attr">meta</span>: {
          <span class="hljs-attr">title</span>: <span class="hljs-string">'wujieDemo1'</span>, <span class="hljs-comment">// 菜单显示文本</span>
          <span class="hljs-attr">icon</span>: <span class="hljs-string">'Present'</span>, <span class="hljs-comment">// 子菜单图标</span>
          <span class="hljs-attr">hidden</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">level</span>: <span class="hljs-number">1</span>,
          <span class="hljs-attr">subAppPath</span>: <span class="hljs-string">"/wujieDemo1"</span>,
        },
      },
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">"wujieDemo2"</span>, <span class="hljs-comment">// 子路由直接使用相对路径，不要包含父路由名称</span>
        <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${routerName}</span>wujieDemo2`</span>, <span class="hljs-comment">// 名称保持唯一，不要使用斜杠</span>
        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"@/pages/wujie/wujie.vue"</span>),
        <span class="hljs-attr">meta</span>: {
          <span class="hljs-attr">title</span>: <span class="hljs-string">'wujieDemo2'</span>, <span class="hljs-comment">// 菜单显示文本</span>
          <span class="hljs-attr">icon</span>: <span class="hljs-string">'Present'</span>, <span class="hljs-comment">// 子菜单图标</span>
          <span class="hljs-attr">hidden</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">level</span>: <span class="hljs-number">1</span>,
          <span class="hljs-attr">subAppPath</span>: <span class="hljs-string">"/wujieDemo2"</span>,
        },
      },
    ]
  },

]

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> wujieRouters;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/446f3a755514463ab0de858e42137875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=WLK9LYrIhROK6f5uG998Vq9i1lc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">子应用改造</h3>
<ul>
<li>运行环境判断</li>
<li>路由通信</li>
<li>嵌入子页面</li>
<li>路由</li>
<li>接口响应拦截器</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aec99d36bd70487d837dfe398a774ea2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=X8eaaEjF3qPi5IP5dApZtd7bbL4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">运行环境判断</h4>
<p>这里我们在<code>main.tsx</code>文件通过判断<code>window.$wujie</code>属性是否存在，来判断当前的运行环境是独立运行还是微前端环境</p>
<p><strong>原理</strong>：<code>wujie</code>会自动给子应用的<code>window</code>上挂载一个<code>$wujie</code>对象</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">StrictMode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-dom/client"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HashRouter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./style/index.css"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./App"</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Provider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-redux"</span>;
<span class="hljs-keyword">import</span> { store } <span class="hljs-keyword">from</span> <span class="hljs-string">"./model/store"</span>;

<span class="hljs-comment">// Wujie 子应用生命周期：挂载（主应用嵌入时调用）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">mount</span> = (<span class="hljs-params">container: HTMLElement | ShadowRoot, props: any</span>) =&gt; {
  <span class="hljs-comment">// 将主应用 props 存入 React 上下文（方便子应用内部使用）</span>
  <span class="hljs-title function_">createRoot</span>(container).<span class="hljs-title function_">render</span>(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StrictMode</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">{store}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">HashRouter</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">App</span> {<span class="hljs-attr">...props</span>} /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">HashRouter</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">StrictMode</span>&gt;</span></span>
  );
};

<span class="hljs-comment">// 判断是否在 Wujie 微前端环境中</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>) {
  <span class="hljs-title function_">mount</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"root"</span>)!, <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>.<span class="hljs-property">props</span>);
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 独立运行环境（正常启动）</span>
  <span class="hljs-title function_">mount</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"root"</span>)!, {
    <span class="hljs-attr">mainAppName</span>: <span class="hljs-string">"独立运行"</span>,
    <span class="hljs-attr">token</span>: <span class="hljs-string">"local-token"</span>,
  });
}

</code></pre>
<h4 data-id="heading-11">路由通信</h4>
<p>在<code>app.tsx</code>文件中修改</p>
<p>子应用监听到父应用的路由发生了改变，立即进行路由跳转</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { router } <span class="hljs-keyword">from</span> <span class="hljs-string">"./router/createRouteConfig"</span>;
<span class="hljs-keyword">import</span> { useNavigate, useRoutes } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> useLocationChange <span class="hljs-keyword">from</span> <span class="hljs-string">"./router/useLocationChange"</span>;
<span class="hljs-keyword">import</span> routerListener <span class="hljs-keyword">from</span> <span class="hljs-string">"./router/routerListener"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./style/index.css"</span>;
<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">props: any</span>) {
  <span class="hljs-keyword">const</span> elements = <span class="hljs-title function_">useRoutes</span>(router);
  <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> wujieBus = <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">routeChangeHandler</span> = (<span class="hljs-params">path: string</span>) =&gt; {
      <span class="hljs-title function_">navigate</span>(path);
    };
    wujieBus?.$on(<span class="hljs-string">"routeChange"</span>, routeChangeHandler);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      wujieBus?.$off(<span class="hljs-string">"routeChange"</span>, routeChangeHandler);
    };                                                                                                                               
  }, [navigate]);

  <span class="hljs-title function_">useLocationChange</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span></span>) =&gt;</span> {
    <span class="hljs-title function_">routerListener</span>(navigate, to, <span class="hljs-keyword">from</span>);
  });
  <span class="hljs-keyword">return</span> elements;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;

</code></pre>
<h4 data-id="heading-12">嵌入的子页面</h4>
<p>新建立一个文件用于放嵌入的子页面，且在该子页面中还可以向父应用通信</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">wujieDemo1</span> = (<span class="hljs-params"/>) =&gt; {

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>我是子应用(react)的wujieDemo1<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span>  window.$wujie?.bus.$emit("subAppData", "我是子应用数据")}&gt;向主应用提交数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> wujieDemo1;

</code></pre>
<h4 data-id="heading-13">路由</h4>
<p>新建路由用于对应上面的子页面</p>
<p>其中需要注意的是，路由的<code>path</code>需要对应父应用路由上的<code>subAppPath</code></p>
<pre><code class="hljs language-js" lang="js">......
  {
      <span class="hljs-attr">name</span>: <span class="hljs-string">"wujieDemo1"</span>,
      <span class="hljs-attr">path</span>: <span class="hljs-string">"/wujieDemo1"</span>,
      <span class="hljs-attr">component</span>: <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"../page/wujiePage/wujieDemo1/index"</span>)),
      <span class="hljs-attr">isMenu</span>: <span class="hljs-literal">false</span>,
    },
......
</code></pre>
<h4 data-id="heading-14">接口响应拦截器</h4>
<p>在响应拦截器中，主要是针对<strong>未登录</strong>的场景，在未登录时，告知父应用</p>
<p>这里也做了运行环境的判断，用于<strong>判断</strong>是进入子应用的登录页面还是父应用的登录页面</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 将方法封装成一个函数</span>
<span class="hljs-keyword">const</span> http = <span class="hljs-keyword">async</span> (<span class="hljs-attr">config</span>: <span class="hljs-title class_">IAxiosParam</span>): <span class="hljs-title class_">Promise</span>&lt;any&gt; =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>(config)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res: IResponse</span>) =&gt;</span> {
      <span class="hljs-keyword">switch</span> (res.<span class="hljs-property">code</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">ResCode</span>.<span class="hljs-property">notLogin</span>:
          <span class="hljs-comment">// 未登录</span>
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>) {
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>.$emit(<span class="hljs-string">"subAppData"</span>, {
              <span class="hljs-attr">type</span>: <span class="hljs-string">"noLogin"</span>
            })
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">"/login"</span>;
          }
          <span class="hljs-keyword">break</span>;
      }

      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span> &amp;&amp; !config.<span class="hljs-property">noAlert</span>) {
        <span class="hljs-comment">// 异常提示</span>
        <span class="hljs-title function_">alert</span>(res.<span class="hljs-property">msg</span> || <span class="hljs-string">"出现问题啦~"</span>);
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">return</span> config.<span class="hljs-property">needRes</span> ? res : res.<span class="hljs-property">data</span>;
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(res);
    });
};
</code></pre>
<h2 data-id="heading-15">总结</h2>
<p>这里我完成了一个基础的demo，在时间的应用还有一些需要注意或优化的点：</p>
<ul>
<li>子应用的运行地址可配置化</li>
<li>子应用的预加载与保活</li>
<li>多个子应用的配置</li>
</ul>
<p>后续可根据自己的实际场景来配置</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[类属性公共还是私有]]></title>    <link>https://juejin.cn/post/7577737385954689034</link>    <guid>https://juejin.cn/post/7577737385954689034</guid>    <pubDate>2025-11-30T05:37:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954689034" data-draft-id="7577689171223412786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="类属性公共还是私有"/> <meta itemprop="keywords" content="TypeScript,JavaScript"/> <meta itemprop="datePublished" content="2025-11-30T05:37:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Robet"/> <meta itemprop="url" content="https://juejin.cn/user/193141028175320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            类属性公共还是私有
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/193141028175320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Robet
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:37:33.000Z" title="Sun Nov 30 2025 05:37:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>决定一个类的属性（成员变量）是<strong>公共（public）还是私有（private）</strong> ，是面向对象设计中的核心问题之一。这不仅关乎代码封装性，还直接影响系统的<strong>可维护性、可扩展性和健壮性</strong>。</p>
<p>以下是系统化的思考框架和实用原则，帮助你做出合理决策：</p>
<hr/>
<h2 data-id="heading-0">🔑 核心原则：<strong>最小暴露原则（Principle of Least Exposure）</strong></h2>
<blockquote>
<p><strong>“只暴露必须暴露的内容，其余一律隐藏。”</strong></p>
</blockquote>
<p>换句话说：<br/>
✅ <strong>默认私有</strong>，只有当<strong>确实需要外部访问</strong>时，才设为公共。</p>
<hr/>
<h2 data-id="heading-1">一、判断标准：问自己这几个问题</h2>
<h3 data-id="heading-2">1. <strong>外部是否需要直接读取这个值？</strong></h3>
<ul>
<li>✅ 是 → 考虑 <code>public</code> 或提供 <strong>getter</strong></li>
<li>❌ 否 → <code>private</code></li>
</ul>
<blockquote>
<p>📌 示例：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BankAccount</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">balance</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 外部不应直接读余额（需鉴权/日志）</span>
  <span class="hljs-title function_">getBalance</span>(): <span class="hljs-built_in">number</span> { <span class="hljs-comment">/* ... */</span> } <span class="hljs-comment">// 通过方法控制访问</span>
}
</code></pre>
</blockquote>
<h3 data-id="heading-3">2. <strong>外部是否需要直接修改这个值？</strong></h3>
<ul>
<li>✅ 是 → 考虑 <code>public</code> 或提供 <strong>setter</strong>（但要谨慎！）</li>
<li>❌ 否 → <code>private</code></li>
</ul>
<blockquote>
<p>⚠️ 直接暴露可变状态容易导致 bug：</p>
<pre><code class="hljs language-ini" lang="ini">// 危险！
<span class="hljs-attr">user.profile.settings.darkMode</span> = <span class="hljs-literal">true</span><span class="hljs-comment">; // 绕过校验/事件通知</span>
</code></pre>
<p>更好的方式：</p>
<pre><code class="hljs language-perl" lang="perl">user.setTheme(<span class="hljs-string">'dark'</span>); <span class="hljs-regexp">//</span> 内部可触发 re-render / save / <span class="hljs-keyword">log</span>
</code></pre>
</blockquote>
<h3 data-id="heading-4">3. <strong>这个属性是否属于“内部实现细节”？</strong></h3>
<ul>
<li>如果未来可能<strong>重构、重命名或删除</strong>它 → <strong>必须私有</strong></li>
<li>如果它是<strong>稳定契约的一部分</strong>（如 API 返回结构）→ 可 public</li>
</ul>
<blockquote>
<p>💡 例子：</p>
<ul>
<li>缓存字段（<code>private cache: Map&lt;...&gt;</code>）→ 私有</li>
<li>用户 ID（<code>public id: string</code>）→ 公共（业务标识）</li>
</ul>
</blockquote>
<h3 data-id="heading-5">4. <strong>是否需要保持对象的“不变性”（Invariants）？</strong></h3>
<p>如果属性参与维持对象的<strong>内部一致性</strong>，则必须私有，并通过方法控制变更。</p>
<blockquote>
<p>📌 示例：矩形的宽高不能为负数</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">_width</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">_height</span>: <span class="hljs-built_in">number</span>;

  <span class="hljs-title function_">setWidth</span>(<span class="hljs-params">w: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">if</span> (w &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Width must be positive'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_width</span> = w;
  }
}
</code></pre>
</blockquote>
<hr/>
<h2 data-id="heading-6">二、优先使用 <strong>方法（Method）而非公共属性</strong></h2>
<p>即使需要“读取”或“设置”，也<strong>优先提供方法</strong>而非直接暴露属性：</p>





















<table><thead><tr><th>场景</th><th>推荐做法</th></tr></thead><tbody><tr><td>读取计算值</td><td><code>getFullName()</code> 而非 <code>fullName</code>（除非是简单数据）</td></tr><tr><td>设置需校验</td><td><code>setEmail(email)</code> 而非 <code>email = ...</code></td></tr><tr><td>触发副作用</td><td><code>activate()</code> 而非 <code>isActive = true</code></td></tr></tbody></table>
<blockquote>
<p>✅ 好处：</p>
<ul>
<li>未来可加日志、权限、缓存、事件通知等逻辑</li>
<li>避免“属性被意外覆盖”导致状态不一致</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-7">三、特殊情况处理</h2>
<h3 data-id="heading-8">✅ 可以公开的属性类型</h3>

























<table><thead><tr><th>类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>不可变数据</strong></td><td>初始化后永不改变</td><td><code>public readonly id: string</code></td></tr><tr><td><strong>纯数据载体（DTO/POJO）</strong></td><td>仅用于传输，无行为</td><td><code>interface UserDTO { name: string; email: string }</code></td></tr><tr><td><strong>配置对象</strong></td><td>明确设计为可读写的配置</td><td><code>public config: RenderConfig</code>（但建议用 getter/setter 封装）</td></tr></tbody></table>
<h3 data-id="heading-9">❌ 应避免公开的属性</h3>
<ul>
<li>内部状态（如 <code>isLoading</code>, <code>retryCount</code>）</li>
<li>依赖其他属性的派生值（如 <code>fullName = firstName + lastName</code> → 应用 getter）</li>
<li>敏感数据（密码、token、余额）</li>
<li>复杂对象引用（如 <code>private domElement: HTMLElement</code>）</li>
</ul>
<hr/>
<h2 data-id="heading-10">四、TypeScript / JavaScript 中的具体实践</h2>
<h3 data-id="heading-11">方案 1：使用 <strong><code>#</code> 私有字段（推荐，ES2022+）</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Timer</span> {
  #startTime: number;
  #isRunning = <span class="hljs-literal">false</span>;

  start() {
    <span class="hljs-keyword">this</span>.#startTime = Date.now();
    <span class="hljs-keyword">this</span>.#isRunning = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">get</span> elapsed() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#isRunning ? Date.now() - <span class="hljs-keyword">this</span>.#startTime : <span class="hljs-number">0</span>;
  }
}
</code></pre>
<blockquote>
<p>✅ 真正私有，运行时安全</p>
</blockquote>
<h3 data-id="heading-12">方案 2：TypeScript <code>private</code>（仅开发时保护）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Logger</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">logs</span>: <span class="hljs-built_in">string</span>[] = [];
  <span class="hljs-title function_">log</span>(<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">logs</span>.<span class="hljs-title function_">push</span>(msg); }
}
</code></pre>
<blockquote>
<p>⚠️ 注意：编译后仍可被外部访问，仅防“手误”</p>
</blockquote>
<h3 data-id="heading-13">方案 3：<code>readonly</code> + 公共（用于不可变数据）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Point</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> x: <span class="hljs-built_in">number</span>,
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> y: <span class="hljs-built_in">number</span>
  </span>) {}
}
</code></pre>
<blockquote>
<p>✅ 安全暴露，且不可修改</p>
</blockquote>
<hr/>
<h2 data-id="heading-14">五、团队协作建议</h2>
<ol>
<li><strong>约定优于配置</strong>：团队统一规则，如“所有状态属性默认私有”</li>
<li><strong>代码审查重点</strong>：检查是否有不必要的 <code>public</code> 属性</li>
<li><strong>文档说明</strong>：对 public 属性明确其用途和约束</li>
</ol>
<hr/>
<h2 data-id="heading-15">✅ 快速决策流程图</h2>
<pre><code class="hljs language-csharp" lang="csharp">这个属性需要被外部访问吗？
│
├─ 否 → <span class="hljs-keyword">private</span> / <span class="hljs-meta">#</span>
│
└─ 是 → 
     ├─ 是否需要修改？ 
     │   ├─ 是 → 提供 setter 方法（而非直接 <span class="hljs-keyword">public</span>）
     │   └─ 否 → 
     │        ├─ 是否不可变？ → <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span>
     │        └─ 是否计算值？ → 提供 getter 方法
     │
     └─ 是否属于稳定数据契约？ → 可 <span class="hljs-keyword">public</span>（如 DTO）
</code></pre>
<hr/>
<h2 data-id="heading-16">🎯 总结：黄金法则</h2>
<blockquote>
<p><strong>“属性代表状态，状态应受控。<br/>
暴露行为（方法），而非状态（属性）。”</strong></p>
</blockquote>
<ul>
<li>默认 <strong>私有</strong>（<code>private</code> 或 <code>#</code>）</li>
<li>仅在<strong>必要且安全</strong>时暴露为公共</li>
<li>优先通过 <strong>方法</strong> 控制访问，而非直接暴露字段</li>
<li>对于<strong>纯数据对象</strong>（如 API 响应），可适当放宽</li>
</ul>
<p>这样做，你的类将更健壮、更易测试、更易演进。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[性能优化：从“用户想走”到“愿意留下”的1.8秒]]></title>    <link>https://juejin.cn/post/7577737385954705418</link>    <guid>https://juejin.cn/post/7577737385954705418</guid>    <pubDate>2025-11-30T05:37:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954705418" data-draft-id="7576935292427681834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="性能优化：从“用户想走”到“愿意留下”的1.8秒"/> <meta itemprop="keywords" content="前端,面试"/> <meta itemprop="datePublished" content="2025-11-30T05:37:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小时前端"/> <meta itemprop="url" content="https://juejin.cn/user/1197805741808339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            性能优化：从“用户想走”到“愿意留下”的1.8秒
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1197805741808339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小时前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:37:44.000Z" title="Sun Nov 30 2025 05:37:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>"今天，我们来聊聊性能优化。在我们团队看来，性能优化不是简单的'减少加载时间'的技术活，而是<strong>数字世界的'流体力学'工程</strong>。我们试图在有限的带宽的约束下，让用户体验如流水般顺滑自然。"</p>
<p>"因此，当我考察一个候选人对性能优化的理解时，我核心关注的不是他知道多少种优化技巧，而是他是否具备一种 <strong>'性能优化'</strong> 的视角。他是否明白，优化某个指标，不仅是应用某个最佳实践，更是要理解整个<strong>渲染流水线、网络协议栈和运行时环境</strong>。"</p>
<p>"这意味着，你需要去理解每个性能指标背后的运行机制——浏览器是如何构建渲染树的？JavaScript引擎是如何执行代码的？网络请求是如何被调度和处理的？如果对细节不太了解，可以阅读这篇文章<a href="https://juejin.cn/post/7573193563044528182" target="_blank" title="https://juejin.cn/post/7573193563044528182">前端面试经典题：从URL到页面展示，这一次让你彻底搞懂</a>"</p>
<p>"所以，今天的问题不仅仅是关于'如何减少LCP'这些具体技巧，我更想听到的是，你如何<strong>系统性</strong>地思考、诊断和解决性能问题。让我们就从这里开始聊起吧。"</p>
<p>当我问起这个问题时，我不仅仅是想听几个优化技巧。我想考察的是：</p>
<ol>
<li><strong>深度</strong>：你对性能优化的理解是否停留在"用个懒加载"的表面？</li>
<li><strong>广度</strong>：你是否了解从网络到渲染的全链路性能影响因素？</li>
<li><strong>实践</strong>：你是否有过真实的性能优化经验，或者至少深入分析过性能瓶颈？</li>
<li><strong>数据驱动</strong>：你是那个凭感觉优化的人，还是能基于数据做出精准决策的人？</li>
</ol>
<h2 data-id="heading-1">一、核心理念：性能 ≠ 快</h2>
<p>首先要明确，性能优化的核心是在<strong>技术理想</strong>与<strong>用户感知</strong>之间寻找最佳平衡点。</p>
<ul>
<li><strong>技术指标</strong>站在天平的最右端：精确的毫秒数，但可能偏离用户感受</li>
<li><strong>用户感知</strong>站在最左端：主观的"快慢"，但难以量化衡量</li>
<li><strong>现代性能优化</strong>分布在中间的广阔光谱上，每个点代表不同的权衡</li>
</ul>
<p>所以，性能优化的本质是<strong>技术指标与用户体验的匹配游戏</strong>。</p>
<h2 data-id="heading-2">二、性能优化的演进：从"减少字节"到"提升感知"</h2>
<p><strong>性能优化的三次进化</strong></p>
<ul>
<li>
<p><strong>第一代：资源优化时代</strong></p>
<ul>
<li><strong>核心思路</strong>："让文件更小，让请求更少"</li>
<li><strong>关键技术</strong>：Gzip压缩、图片优化、CSS Sprites、减少HTTP请求</li>
<li><strong>突破性</strong>：首次系统性地从资源层面解决性能问题</li>
<li><strong>局限性</strong>：过度聚焦于技术指标，忽略用户感知</li>
</ul>
</li>
<li>
<p><strong>第二代：渲染优化时代</strong></p>
<ul>
<li><strong>核心思路</strong>："让关键内容先出来"</li>
<li><strong>关键技术</strong>：关键CSS内联、异步加载、懒加载、服务端渲染</li>
<li><strong>突破性</strong>：开始关注用户看到内容的时机，而非单纯的技术指标</li>
<li><strong>局限性</strong>：缺乏统一的衡量标准，优化方向分散</li>
</ul>
</li>
<li>
<p><strong>第三代：用户体验量化时代</strong></p>
<ul>
<li><strong>核心思路</strong>："用科学指标衡量用户体验"</li>
<li><strong>关键技术</strong>：Core Web Vitals、Performance API、真实用户监控</li>
<li><strong>突破性</strong>：建立了标准化的用户体验衡量体系</li>
<li><strong>局限性</strong>：指标之间存在权衡，需要业务层面的决策</li>
</ul>
</li>
</ul>
<p><strong>如何回答（展现你的历史观）</strong>
"性能优化的演进本质上是不断重新定义'性能'含义的过程。从早期的关注服务器响应时间，到中期的关注首屏渲染，再到现在的关注用户核心任务完成度，每一次演进都在解决前一代的核心局限。"</p>
<h2 data-id="heading-3">三、现代性能优化深度对比：不只是技术技巧</h2>
<p><strong>核心维度对比</strong></p>
<ul>
<li>
<p><strong>加载性能：用户的第一印象</strong></p>
<ul>
<li><strong>LCP</strong>：衡量主要内容加载，直接影响用户对速度的感知</li>
<li><strong>优化策略</strong>：图片优化、字体优化、服务端渲染、资源预加载</li>
<li><strong>权衡考量</strong>：预加载可能浪费带宽，需要基于用户行为数据决策</li>
</ul>
</li>
<li>
<p><strong>交互响应：使用的流畅度</strong></p>
<ul>
<li><strong>FID/INP</strong>：衡量输入响应，决定用户操作的顺滑程度</li>
<li><strong>优化策略</strong>：代码分割、长任务拆分、Web Worker、优化JavaScript执行</li>
<li><strong>权衡考量</strong>：过度拆分可能增加复杂度，需要平衡可维护性</li>
</ul>
</li>
<li>
<p><strong>视觉稳定性：体验的可靠性</strong></p>
<ul>
<li><strong>CLS</strong>：衡量布局偏移，影响用户的阅读和操作精度</li>
<li><strong>优化策略</strong>：设置尺寸属性、预留空间、避免动态插入内容</li>
<li><strong>权衡考量</strong>：预留空间可能造成空白，需要设计系统配合</li>
</ul>
</li>
</ul>
<p><strong>如何回答（展现你的技术判断力）</strong>
"当我们对比现代性能优化指标时，实际上是在对比不同的用户体验维度。LCP关注的是'什么时候能用'，FID关注的是'用起来卡不卡'，CLS关注的是'用起来准不准'。好的性能优化不是单独优化某个指标，而是找到这些指标在具体业务场景下的最佳平衡点。"</p>
<h2 data-id="heading-4">四、<strong>实战：一个LCP从4.2s到1.8s的优化案例</strong></h2>
<p>"理论总是灰色的，而性能优化的实践之树常青。下面我想分享一个真实的产品详情页优化案例，看看我们如何将一个 <strong>4.2秒的LCP</strong> 优化到 <strong>1.8秒</strong>。"</p>
<h4 data-id="heading-5">问题诊断：拨开迷雾，定位七重瓶颈</h4>
<p>我们发现了完整的"性能问题瀑布链"：</p>
<ol>
<li><strong>LCP元素</strong>：首屏的<strong>主商品图</strong></li>
<li><strong>资源加载</strong>：一张450KB的JPEG图片</li>
<li><strong>渲染阻塞</strong>：800KB的Web字体文件</li>
<li><strong>JavaScript竞争</strong>：分析脚本抢占带宽</li>
<li><strong>服务端延迟</strong>：TTFB达到600ms</li>
<li><strong>缓存失效</strong>：CDN配置不当</li>
<li><strong>布局偏移</strong>：CLS高达0.25</li>
</ol>
<p>"诊断性能问题就像破案，你不能只看到表面的'凶器'（那张大图），而是要还原整个'犯罪现场'（从用户点击到屏幕渲染的完整链条）。"</p>
<h4 data-id="heading-6">优化措施：一套组合拳，拳拳到肉</h4>
<p><strong>第一阶段：资源层面的"瘦身"与"调度"</strong></p>
<p><em>技术说明：这个阶段的核心目标是让关键资源变得更小，并让浏览器优先处理它们</em></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 图片格式优化：为不同浏览器提供最合适的图片格式 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">picture</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 现代浏览器优先使用更小的WebP格式 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"hero-image.webp"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/webp"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 老版本浏览器使用优化后的JPEG作为备选 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"hero-image.jpg"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/jpeg"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 最终回退方案 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"hero-image.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"产品主图"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"800"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"600"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 关键图片预加载：告诉浏览器这个图片最重要，请立即下载 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preload"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"image"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"hero-image.webp"</span> <span class="hljs-attr">imagesrcset</span>=<span class="hljs-string">"hero-image.webp 800w, hero-image-mobile.webp 400w"</span>&gt;</span>
</code></pre>
<blockquote>
<p>"这里有个关键洞察：我们发现主图虽然通过<code>&lt;picture&gt;</code>元素做了格式优化，但浏览器仍然需要经过图片发现、请求队列、DNS查找、TCP连接等一系列步骤才能开始下载。通过<code>preload</code>，我们告诉浏览器：'这个资源极其重要，请跳过常规队列，立即开始下载'。"</p>
</blockquote>
<p><strong>Preload的实战细节：</strong></p>
<ul>
<li><strong>时机把握</strong>：将preload链接放在HTML的<code>&lt;head&gt;</code>中，确保浏览器在解析完基本结构后立即处理</li>
<li><strong>格式适配</strong>：预加载WebP格式，因为它是我们为现代浏览器准备的最优解</li>
<li><strong>响应式考虑</strong>：通过<code>imagesrcset</code>告知浏览器不同视口宽度下应该加载的图片版本</li>
</ul>
<p><strong>第二阶段：渲染层面的"清障"与"加速"</strong></p>
<p><em>技术说明：这个阶段的目标是消除阻止页面渲染的障碍，让内容尽快显示</em></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 字体加载优化：避免文字显示空白期 */</span>
<span class="hljs-keyword">@font-face</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'ProductSans'</span>;
  <span class="hljs-attribute">src</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'product-sans-subset.woff2'</span>) <span class="hljs-built_in">format</span>(<span class="hljs-string">'woff2'</span>);
  <span class="hljs-attribute">font-display</span>: swap; <span class="hljs-comment">/* 关键：先显示系统字体，Web字体加载后再替换 */</span>
}
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 非关键脚本延迟加载：让分析工具等不阻塞页面渲染 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"analytics.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">defer</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"non-critical.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<blockquote>
<p>"字体优化是另一个战场。原本800KB的字体文件不仅下载慢，还会导致文本内容在字体加载完成前完全不可见（FOIT问题）。通过<code>font-display: swap</code>，我们让浏览器先用系统字体显示文字，等Web字体下载完成后再静默替换——用户能立即看到内容，而不是面对一片空白。"</p>
</blockquote>
<p><strong>第三阶段：服务端与基础设施的"深水区"优化</strong></p>
<p><em>技术说明：这个阶段处理网络层面和服务端响应速度的问题</em></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 提前建立CDN连接：减少DNS查询和TCP握手时间 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preconnect"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.our-platform.com"</span>&gt;</span>
</code></pre>
<blockquote>
<p>"你可能想不到，浏览器在真正开始下载图片前，需要先完成'自我介绍'——DNS查询找到CDN服务器的IP地址，然后TCP三次握手建立连接。通过<code>preconnect</code>，我们在浏览器遇到实际图片URL前就提前完成这些步骤，为后续请求节省了宝贵的几百毫秒。"</p>
</blockquote>
<h4 data-id="heading-7">效果评估：数据是最好的证明</h4>
<p>经过上述优化，我们在下一个发布周期后观察到了显著变化：</p>








































<table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th><th>提升幅度</th><th>用户感知</th></tr></thead><tbody><tr><td><strong>LCP</strong></td><td>4.2s</td><td><strong>1.8s</strong></td><td><strong>57%</strong></td><td>从"等待"到"顺畅"</td></tr><tr><td><strong>TTFB</strong></td><td>600ms</td><td>80ms</td><td>87%</td><td>服务器响应更快</td></tr><tr><td><strong>首屏图片体积</strong></td><td>450KB</td><td>120KB</td><td>73%</td><td>流量节省，加载更快</td></tr><tr><td><strong>跳出率</strong></td><td>45%</td><td>32%</td><td><strong>13个百分点</strong></td><td>更多用户留下</td></tr></tbody></table>
<blockquote>
<p>"最让我们兴奋的不是漂亮的性能图表，而是业务数据的正面反馈：<strong>详情页到购物车的转化率提升了 7%</strong>。这实实在在地证明了，性能优化不是技术团队的自我感动，而是真金白银的商业回报。"</p>
</blockquote>
<h4 data-id="heading-8">经验总结：从一次优化到一种能力</h4>
<p>这个案例给我们的启示远不止于技术点：</p>
<ol>
<li><strong>性能优化是系统工程</strong>：它涉及前端、后端、运维多个环节，需要打破团队壁垒协同作战。</li>
<li><strong>度量是优化的起点和终点</strong>：没有精确的测量，优化就是盲人摸象。我们建立了持续的性能监控仪表盘。</li>
<li><strong>优化需要勇气做减法</strong>：敢于对"历来如此"的设计（如全尺寸大图）和"别人都这么用"的技术（如完整Web字体）提出挑战。</li>
<li><strong>用户体验是最终裁判</strong>：优化的目标不是跑分，而是让用户觉得"快"。即使LCP还有提升空间，但1.8秒的加载速度已经让用户感知从"等待"变成了"顺畅"。</li>
</ol>
<p>"这个案例之后，我们形成了一种肌肉记忆：每当启动一个新项目，<strong>LCP 会作为一项核心验收指标，与功能需求并列进入产品清单</strong>。这或许是一次优化带来的最大价值——将性能意识植入了团队的基因。"</p>
<h3 data-id="heading-9">五、超越技术优化：构建性能工程体系</h3>
<p>一个优秀的候选人，还能聊到性能优化的工程化挑战：</p>
<ol>
<li>
<p><strong>度量和监控体系</strong></p>
<ul>
<li><strong>真实用户监控</strong>：收集真实场景下的性能数据</li>
<li><strong>关键业务路径追踪</strong>：从用户进入到最后转化的全链路分析</li>
</ul>
</li>
<li>
<p><strong>性能文化建设</strong></p>
<ul>
<li><strong>性能预算</strong>：为每个关键指标设置明确的数值目标</li>
<li><strong>代码审核集成</strong>：在代码合并前检查性能影响</li>
</ul>
</li>
<li>
<p><strong>渐进式优化策略</strong></p>
<ul>
<li><strong>基准建立</strong>：首先建立当前的性能基线</li>
<li><strong>快速胜利</strong>：优先实施高影响低成本的优化</li>
<li><strong>长期投资</strong>：规划需要架构层面改变的深度优化</li>
</ul>
</li>
</ol>
<h2 data-id="heading-10">面试官总结：我心目中的理想回答</h2>
<p>一个让我眼前一亮的回答，应该是这样的：</p>
<p>"说实话，性能优化这事儿我踩过不少坑。比如上次我们有个页面LCP一直上不去，我开始也以为是图片太大的问题，后来用Performance面板一分析，发现是字体文件阻塞了渲染。"</p>
<p>"我的思路其实挺简单的——<strong>先测量，再动手</strong>。我不会一上来就说要用什么preload或者WebP，而是先搞清楚瓶颈到底在哪。是网络慢？还是渲染被阻塞？或者是JS执行太耗时？"</p>
<p>"具体到LCP优化，我的经验是分三步走：</p>
<ol>
<li><strong>找到元凶</strong>——用Lighthouse和DevTools确定到底是哪个元素拖慢了LCP</li>
<li><strong>资源优先级</strong>——如果是图片，就用preload提前加载；如果是字体，就用font-display:swap避免阻塞</li>
<li><strong>持续监控</strong>——优化完了不是结束，要盯着真实用户的数据看效果"</li>
</ol>
<p>"而且我现在会特别关注<strong>业务价值</strong>。比如上次我们把LCP从4秒优化到1.8秒后，特意去看了转化率数据，发现确实提升了7%。"</p>
<p>"最重要的是，我觉得性能优化不是一次性的活，而是个持续过程。我们现在会把Core Web Vitals写进需求文档里，就像写功能需求一样自然。"</p>
<p>这样的回答为什么让我印象深刻？因为：</p>
<ul>
<li>有<strong>真实经历</strong>，不是空谈理论</li>
<li>有<strong>具体方法</strong>，不是泛泛而谈</li>
<li>有<strong>业务思维</strong>，不只关注技术指标</li>
<li>有<strong>落地经验</strong>，知道怎么在团队里推动这些事情</li>
</ul>
<p>说白了，我想找的不是一个只会背面试题的人，而是一个真正<strong>解决过问题</strong>的工程师。</p>
<p><strong>思考题：</strong> 当Core Web Vitals要求LCP在2.5秒内时，你是否思考过这在不同网络环境、不同设备配置下的实际意义？当你通过代码分割减少初始包体积时，是否评估过这对后续页面加载的潜在影响？这些，才是性能优化思考的真正深度所在。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[element-plus源码解读2——vue3组件的ref访问与defineExpose暴露机制]]></title>    <link>https://juejin.cn/post/7577958825342025747</link>    <guid>https://juejin.cn/post/7577958825342025747</guid>    <pubDate>2025-11-30T05:54:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577958825342025747" data-draft-id="7577970969394921513" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="element-plus源码解读2——vue3组件的ref访问与defineExpose暴露机制"/> <meta itemprop="keywords" content="Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-30T05:54:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Joie"/> <meta itemprop="url" content="https://juejin.cn/user/3265984436383947"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            element-plus源码解读2——vue3组件的ref访问与defineExpose暴露机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3265984436383947/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Joie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:54:27.000Z" title="Sun Nov 30 2025 05:54:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">vue3组件的ref访问与defineExpose暴露机制</h2>
<p>vue官方文档：</p>
<p><strong>ref</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vuejs.org%2Fapi%2Freactivity-core.html%23ref" target="_blank" title="https://cn.vuejs.org/api/reactivity-core.html#ref" ref="nofollow noopener noreferrer">cn.vuejs.org/api/reactiv…</a></p>
<p><strong>defineExpose</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vuejs.org%2Fapi%2Fsfc-script-setup.html%23defineexpose" target="_blank" title="https://cn.vuejs.org/api/sfc-script-setup.html#defineexpose" ref="nofollow noopener noreferrer">cn.vuejs.org/api/sfc-scr…</a></p>
<p>以el-button举例：</p>
<h4 data-id="heading-1">1. 正确的访问方式</h4>
<p>看 Button 组件暴露的内容：</p>
<pre><code class="hljs language-83:94:packages/components/button/src/button.vue" lang="83:94:packages/components/button/src/button.vue">defineExpose({
  /** @description button html element */
  ref: _ref,
  /** @description button size */
  size: _size,
  /** @description button type */
  type: _type,
  /** @description button disabled */
  disabled: _disabled,
  /** @description whether adding space */
  shouldAddSpace,
})
</code></pre>
<h4 data-id="heading-2">2. 实际使用示例</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-button ref="buttonRef" type="primary" size="large"&gt;
    按钮
  &lt;/el-button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

onMounted(() =&gt; {
  // ✅ 正确：访问所有暴露的属性
  console.log('DOM 元素:', buttonRef.value?.ref)        // HTMLButtonElement
  console.log('按钮尺寸:', buttonRef.value?.size)       // ComputedRef&lt;'large'&gt;
  console.log('按钮类型:', buttonRef.value?.type)      // ComputedRef&lt;'primary'&gt;
  console.log('是否禁用:', buttonRef.value?.disabled)   // ComputedRef&lt;boolean&gt;
  console.log('是否加空格:', buttonRef.value?.shouldAddSpace) // ComputedRef&lt;boolean&gt;
  
  // ✅ 打印整个组件实例，可以看到所有暴露的属性
  console.log('组件实例:', buttonRef.value)
})
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-3">3. 打印结果示例</h4>
<p>当你 <code>console.log(buttonRef.value)</code> 时，会看到类似：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-attr">ref</span>: <span class="hljs-title class_">HTMLButtonElement</span>,           <span class="hljs-comment">// DOM 元素</span>
  <span class="hljs-attr">size</span>: <span class="hljs-title class_">ComputedRef</span>&lt;<span class="hljs-string">'large'</span>&gt;,        <span class="hljs-comment">// 尺寸（注意是 ComputedRef）</span>
  <span class="hljs-attr">type</span>: <span class="hljs-title class_">ComputedRef</span>&lt;<span class="hljs-string">'primary'</span>&gt;,      <span class="hljs-comment">// 类型（注意是 ComputedRef）</span>
  <span class="hljs-attr">disabled</span>: <span class="hljs-title class_">ComputedRef</span>&lt;<span class="hljs-literal">false</span>&gt;,      <span class="hljs-comment">// 禁用状态（注意是 ComputedRef）</span>
  <span class="hljs-attr">shouldAddSpace</span>: <span class="hljs-title class_">ComputedRef</span>&lt;<span class="hljs-literal">false</span>&gt; <span class="hljs-comment">// 是否加空格（注意是 ComputedRef）</span>
}
</code></pre>
<h4 data-id="heading-4">4. 重要提示：ComputedRef 的访问</h4>
<p>注意 <code>size</code>、<code>type</code>、<code>disabled</code> 等是 <code>ComputedRef</code>，访问值需要用 <code>.value</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ❌ 错误：这样得到的是 ComputedRef 对象</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buttonRef.<span class="hljs-property">value</span>?.<span class="hljs-property">size</span>)  <span class="hljs-comment">// ComputedRef { ... }</span>

<span class="hljs-comment">// ✅ 正确：需要 .value 才能拿到实际值</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buttonRef.<span class="hljs-property">value</span>?.<span class="hljs-property">size</span>.<span class="hljs-property">value</span>)  <span class="hljs-comment">// 'large'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buttonRef.<span class="hljs-property">value</span>?.<span class="hljs-property">type</span>.<span class="hljs-property">value</span>)  <span class="hljs-comment">// 'primary'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buttonRef.<span class="hljs-property">value</span>?.<span class="hljs-property">disabled</span>.<span class="hljs-property">value</span>)  <span class="hljs-comment">// false</span>
</code></pre>
<p>说明 Vue 3 的生命周期和 ref 访问时机：</p>
<h4 data-id="heading-5">1. Vue 3 没有 <code>onCreated</code> 钩子</h4>
<p>在 Vue 3 的 Composition API 中：</p>
<ul>
<li>没有 <code>onCreated()</code> 钩子</li>
<li><code>setup()</code> 函数本身就相当于 Vue 2 的 <code>created</code> + <code>beforeCreate</code></li>
<li>如果需要访问 DOM 或组件实例，应该用 <code>onMounted()</code></li>
</ul>
<h4 data-id="heading-6">2. 为什么必须在 <code>onMounted()</code> 中？</h4>
<h5 data-id="heading-7">在 <code>setup()</code> 顶层（组件未挂载）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

// ❌ 错误：此时 buttonRef.value 是 undefined
// 因为组件还没有挂载，ref 还没有被赋值
console.log(buttonRef.value)  // undefined
&lt;/script&gt;
</code></pre>
<h5 data-id="heading-8">在 <code>onMounted()</code> 中（组件已挂载）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, onMounted } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

onMounted(() =&gt; {
  // ✅ 正确：此时组件已经挂载，ref 已经被赋值
  console.log(buttonRef.value)  // ButtonInstance 对象
  console.log(buttonRef.value?.ref)  // HTMLButtonElement
})
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-9">3. Vue 3 生命周期对比</h4>


















































<table><thead><tr><th>Vue 2 Options API</th><th>Vue 3 Composition API</th><th>说明</th></tr></thead><tbody><tr><td><code>beforeCreate</code></td><td><code>setup()</code> 开始执行</td><td>组件创建前</td></tr><tr><td><code>created</code></td><td><code>setup()</code> 执行中</td><td>组件创建后（但未挂载）</td></tr><tr><td><code>beforeMount</code></td><td><code>onBeforeMount()</code></td><td>挂载前</td></tr><tr><td><code>mounted</code></td><td><code>onMounted()</code></td><td>挂载后（DOM 已存在）</td></tr><tr><td><code>beforeUpdate</code></td><td><code>onBeforeUpdate()</code></td><td>更新前</td></tr><tr><td><code>updated</code></td><td><code>onUpdated()</code></td><td>更新后</td></tr><tr><td><code>beforeUnmount</code></td><td><code>onBeforeUnmount()</code></td><td>卸载前</td></tr><tr><td><code>unmounted</code></td><td><code>onUnmounted()</code></td><td>卸载后</td></tr></tbody></table>
<h4 data-id="heading-10">4. 完整示例对比</h4>
<h5 data-id="heading-11">错误示例（在 setup 顶层）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-button ref="buttonRef"&gt;按钮&lt;/el-button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

// ❌ 错误：此时 buttonRef.value 是 undefined
console.log('setup 顶层:', buttonRef.value)  // undefined
&lt;/script&gt;
</code></pre>
<h5 data-id="heading-12">正确示例（在 onMounted 中）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-button ref="buttonRef"&gt;按钮&lt;/el-button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted, onBeforeMount } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

// 在 setup 顶层
console.log('setup 顶层:', buttonRef.value)  // undefined

// 在 beforeMount 中
onBeforeMount(() =&gt; {
  console.log('beforeMount:', buttonRef.value)  // 可能还是 undefined
})

// 在 mounted 中
onMounted(() =&gt; {
  // ✅ 正确：此时组件已挂载，ref 已赋值
  console.log('mounted:', buttonRef.value)  // ButtonInstance 对象
  console.log('DOM 元素:', buttonRef.value?.ref)  // HTMLButtonElement
})
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-13">5. 为什么 ref 在 onMounted 中才有值？</h4>
<p>Vue 的 ref 赋值时机：</p>
<ol>
<li>模板编译阶段：Vue 识别 <code>ref="buttonRef"</code></li>
<li>组件挂载阶段：创建组件实例，将实例赋值给 <code>buttonRef.value</code></li>
<li>DOM 渲染完成：<code>onMounted()</code> 执行时，ref 已经有值</li>
</ol>
<h4 data-id="heading-14">6. 如果需要在 setup 中访问怎么办？</h4>
<p>可以使用 <code>watchEffect</code> 或 <code>watch</code>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, watchEffect } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

// 使用 watchEffect，会在 ref 有值后自动执行
watchEffect(() =&gt; {
  if (buttonRef.value) {
    console.log('ref 有值了:', buttonRef.value)
  }
})
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-15">7. 总结</h4>
<ul>
<li>Vue 3 没有 <code>onCreated()</code>，<code>setup()</code> 本身就相当于 <code>created</code></li>
<li>访问 <code>ref.value</code> 必须在 <code>onMounted()</code> 中，因为此时组件已挂载</li>
<li>在 <code>setup()</code> 顶层访问 <code>ref.value</code> 会是 <code>undefined</code></li>
<li>如果需要响应式监听 ref 的变化，可以用 <code>watchEffect</code> 或 <code>watch</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 中没有 v-model，如何优雅地处理表单输入]]></title>    <link>https://juejin.cn/post/7577970969395003433</link>    <guid>https://juejin.cn/post/7577970969395003433</guid>    <pubDate>2025-11-30T06:11:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577970969395003433" data-draft-id="7577797563853783076" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 中没有 v-model，如何优雅地处理表单输入"/> <meta itemprop="keywords" content="前端,Vue.js,React.js"/> <meta itemprop="datePublished" content="2025-11-30T06:11:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="凯心"/> <meta itemprop="url" content="https://juejin.cn/user/75186527548462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 中没有 v-model，如何优雅地处理表单输入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/75186527548462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    凯心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:11:28.000Z" title="Sun Nov 30 2025 06:11:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 中没有 v-model，如何优雅地处理表单输入</h2>
<p>在 Vue 中，我们可以很方便地使用 <code>v-model</code> 实现数据的双向绑定。但在 React 的世界里，并没有这样的语法糖，我们需要通过不同的方式来处理表单数据。</p>
<h3 data-id="heading-1">Vue 的简洁写法</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;input v-model="value" /&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-2">React 的几种实现方案</h3>
<h4 data-id="heading-3">方案一：基础受控组件</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span> 
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setValue(e.target.value)} 
    /&gt;</span>
  );
}
</code></pre>
<p>这是 React 初学者最常用的写法。在简单场景下表现良好，但在复杂表单或大型应用中，每次输入都会触发组件重新渲染，可能导致性能问题。</p>
<h4 data-id="heading-4">方案二：非受控组件 + useRef</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-string">""</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> (inputRef.current = e.target.value)} 
    /&gt;</span>
  );
}
</code></pre>
<p>这种方案避免了频繁的重新渲染，适合性能敏感的场景。</p>
<h4 data-id="heading-5">方案三：防抖优化</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);
  
  <span class="hljs-keyword">const</span> handleChange = <span class="hljs-title function_">useCallback</span>(
    <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">newValue</span>) =&gt;</span> {
      <span class="hljs-title function_">setValue</span>(newValue);
    }, <span class="hljs-number">300</span>),
    []
  );

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> handleChange(e.target.value)} 
    /&gt;</span>
  );
}
</code></pre>
<p>通过防抖函数减少状态更新的频率，在需要实时搜索等场景下特别有用。</p>
<hr/>
<h2 data-id="heading-6">深入理解：受控组件 vs 非受控组件</h2>
<h3 data-id="heading-7">概念解析</h3>
<p>受控组件和非受控组件是<code>数据驱动框架</code>中的重要概念：</p>
<ul>
<li><strong>表面区别</strong>：值是否只能由用户输入改变，还是也可以由程序逻辑<code>直接</code>改变</li>
<li><strong>本质区别</strong>：数据是由 React 状态托管，还是由 DOM 自身管理</li>
</ul>
<h3 data-id="heading-8">受控组件（Controlled Components）</h3>
<p>表单元素的值完全由 React 状态控制，通过 <code>onChange</code> 事件同步更新。</p>
<p><strong>优点：</strong></p>
<ul>
<li>✅ 符合 React 单向数据流理念，状态完全可控</li>
<li>✅ 便于实现实时验证和输入格式化</li>
<li>✅ 可动态控制表单提交状态</li>
<li>✅ 支持多组件间的数据同步</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ 需要为每个字段编写事件处理逻辑</li>
<li>❌ 表单复杂时可能引发性能问题</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>需要实时验证用户输入</li>
<li>需要根据输入动态更新UI</li>
<li>需要强制特定的输入格式</li>
<li>表单数据被多个组件共享</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">LoginForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [formData, setFormData] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">username</span>: <span class="hljs-string">""</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">""</span>
  });

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">field</span>) =&gt; <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-title function_">setFormData</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({
      ...prev,
      [field]: e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>
    }));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">value</span>=<span class="hljs-string">{formData.username}</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange(</span>"<span class="hljs-attr">username</span>")} 
      /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{formData.password}</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange(</span>"<span class="hljs-attr">password</span>")} 
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-9">非受控组件（Uncontrolled Components）</h3>
<p>表单数据由 DOM 自身管理，通过 ref 在需要时获取值。</p>
<p><strong>优点：</strong></p>
<ul>
<li>✅ 代码简洁，减少事件处理逻辑</li>
<li>✅ 性能更优，避免频繁重新渲染</li>
<li>✅ 更接近原生 DOM 操作</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ 不符合 React 数据流最佳实践</li>
<li>❌ 无法实现实时验证和UI反馈</li>
<li>❌ 状态管理不够直观</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>简单表单，无需实时验证</li>
<li>只在提交时需要获取数据</li>
<li>性能敏感的大型表单</li>
<li>集成第三方表单库</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UncontrolledForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> usernameRef = <span class="hljs-title function_">useRef</span>();
  <span class="hljs-keyword">const</span> passwordRef = <span class="hljs-title function_">useRef</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params">e</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-keyword">const</span> data = {
      <span class="hljs-attr">username</span>: usernameRef.<span class="hljs-property">current</span>.<span class="hljs-property">value</span>,
      <span class="hljs-attr">password</span>: passwordRef.<span class="hljs-property">current</span>.<span class="hljs-property">value</span>
    };
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"表单数据:"</span>, data);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{usernameRef}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{passwordRef}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-10">实践建议</h3>
<ol>
<li>当需要做性能优化时，可以考虑使用非受控组件</li>
<li>非受控组件和受控组件可以混用</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rect深入学习]]></title>    <link>https://juejin.cn/post/7577691061034041390</link>    <guid>https://juejin.cn/post/7577691061034041390</guid>    <pubDate>2025-11-30T06:37:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061034041390" data-draft-id="7577691061033320494" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rect深入学习"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T06:37:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="本地跑没问题"/> <meta itemprop="url" content="https://juejin.cn/user/1632138081101102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rect深入学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1632138081101102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    本地跑没问题
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:37:10.000Z" title="Sun Nov 30 2025 06:37:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React核心机制</h2>
<h3 data-id="heading-1">虚拟 DOM 和 Diff 算法</h3>
<h4 data-id="heading-2">什么是虚拟DOM</h4>
<p>虚拟DOM可以理解为模拟了DOM树的JS对象树</p>
<p>比如</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> element = {
    <span class="hljs-attr">element</span>: <span class="hljs-string">'ul'</span>,
    <span class="hljs-attr">props</span>: {
        <span class="hljs-attr">id</span>:<span class="hljs-string">"ulist"</span>
    },
    <span class="hljs-attr">children</span>: [
    { <span class="hljs-attr">element</span>: <span class="hljs-string">'li'</span>, <span class="hljs-attr">props</span>: { <span class="hljs-attr">id</span>:<span class="hljs-string">"first"</span> }, <span class="hljs-attr">children</span>: [<span class="hljs-string">'这是第一个List元素'</span>] },
    { <span class="hljs-attr">element</span>: <span class="hljs-string">'li'</span>, <span class="hljs-attr">props</span>: { <span class="hljs-attr">id</span>:<span class="hljs-string">"second"</span> }, <span class="hljs-attr">children</span>: [<span class="hljs-string">'这是第二个List元素'</span>] }
    ]
}
</code></pre>
<h4 data-id="heading-3">为什么需要虚拟DOM</h4>
<p>传统DOM更新方式的问题：</p>
<ul>
<li>在原生JS中，更新DOM的方式往往是<strong>粗颗粒度的更新，直接替换整颗子树</strong>，容易造成性能的浪费</li>
<li>如果要做到细颗粒度更新，则需要<strong>自己决定修改哪一部分，但这种手动diff很麻烦</strong></li>
</ul>
<p>虚拟DOM更新的优势：</p>
<ul>
<li>框架自动对新旧虚拟DOM树进行diff算法</li>
<li>然后<strong>精准更新DOM树中变化的部分</strong>，大幅度提升性能</li>
</ul>
<p>举例：</p>
<p>比如有一个列表，我对其进行了修改</p>
<pre><code class="hljs language-html" lang="html">//旧UI
<span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"list"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>苹果<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>香蕉<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>

//新UI
<span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"list"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>苹果<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>橘子<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span> <span class="hljs-comment">&lt;!-- 改动 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
</code></pre>
<ul>
<li>
<p>传统DOM更新：</p>
<ul>
<li>
<p><strong>粗暴做法</strong>：<code>list.innerHTML = render(items)</code> → 把整个 <code>&lt;ul&gt;</code> 清空并重建 <code>&lt;li&gt;</code>，即使“苹果”没变也会被销毁重建。</p>
</li>
<li>
<p><strong>精细做法</strong>：你必须写逻辑找到第 2 个 <code>&lt;li&gt;</code> 并替换它的文本</p>
<ul>
<li><code>list.children[1].textContent = '橘子';</code></li>
<li>但这种手动 diff 很麻烦，开发者必须自己维护 UI 和数据的一致性。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>虚拟DOM更新：</p>
<ul>
<li>
<p>框架自动比较新旧虚拟 DOM：</p>
<ul>
<li>第 1 个 <code>&lt;li&gt;</code> 一样 → 复用。</li>
<li>第 2 个 <code>&lt;li&gt;</code> 文本不同 → 只更新文本。</li>
</ul>
</li>
<li>
<p>最终只执行一条 DOM 操作：<code>list.children[1].textContent = '橘子';</code></p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">diff算法</h4>
<p>传统diff算法的时间复杂度是O(n³)</p>
<ul>
<li>我们要把旧树变成新树，找到最小修改路径</li>
</ul>
<p>为什么时间复杂度是O(n³)？</p>
<ol>
<li>
<p>遍历旧树的每个节点（n次）</p>
</li>
<li>
<p>遍历新树的每个节点（n次）</p>
<ul>
<li>对比每个旧树中的节点，找到新树中可能对应的新节点</li>
</ul>
</li>
<li>
<p>比较两个节点的子结构是否完全相同</p>
<ul>
<li>
<p>因为判断“是否同一个节点”不仅要看标签名，还要看它的整个子结构是否相同。 这就需要再深入进去比较它们的子树。</p>
</li>
<li>
<p>每对匹配节点都可能有一整棵子树；</p>
<p>每棵子树的节点数也可能接近 n；</p>
<p>所以在最坏情况下，每一对匹配都要再递归比较一遍整棵子树。</p>
</li>
</ul>
</li>
</ol>
<p>于是复杂度变成：</p>
<blockquote>
<p>O(n)（旧树） × O(n)（新树） × O(n)（子树递归） = <strong>O(n³)</strong></p>
</blockquote>
<p>第 3 层递归比较子树的复杂度，是因为<strong>每一对匹配节点</strong>都还要<strong>递归地比较它们的子树结构</strong>。</p>
<p>前两层只是找出“候选节点对”，第三层才是深入检查“它们真的一样吗”。</p>
<p>所以整体复杂度是： <strong>旧树节点数 × 新树节点数 × 子树递归 = O(n³)</strong> 。</p>
<hr/>
<p>React的diff算法的时间复杂度是O(n)</p>
<p>React 把问题简化成了三条“经验规则”，正是这三条规则让复杂度从 O(n³) → O(n)。</p>
<ol start="0">
<li>
<p>同层比较，不跨层</p>
<ul>
<li>复杂度就从 <strong>O(n³)</strong> → <strong>O(n²)</strong></li>
</ul>
</li>
<li>
<p>不同类型节点，直接替换整棵子树</p>
<ul>
<li>也就是说，<strong>不同类型的节点永远不去比较子树</strong>。 这避免了对子树的递归匹配，进一步从 <strong>O(n²)</strong> → <strong>O(n)</strong> 。</li>
</ul>
</li>
<li>
<p>通过 <code>key</code> 标识子节点的稳定性</p>
<ul>
<li>对于同一层的子节点列表，React 通过 key 来判断哪些节点是“同一个节点”</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-hmtl" lang="hmtl">//旧
&lt;ul&gt;
  &lt;li key="A"&gt;A&lt;/li&gt;
  &lt;li key="B"&gt;B&lt;/li&gt;
  &lt;li key="C"&gt;C&lt;/li&gt;
&lt;/ul&gt;
//新
&lt;ul&gt;
  &lt;li key="B"&gt;B&lt;/li&gt;
  &lt;li key="A"&gt;A&lt;/li&gt;
  &lt;li key="C"&gt;C&lt;/li&gt;
&lt;/ul&gt;
</code></pre>
<p>React 会通过 <code>key</code> 识别出：</p>
<ul>
<li>A、B、C 都还在；</li>
<li>只是顺序变了；</li>
<li>所以只需调整位置，<strong>不需要删除重建</strong>。</li>
</ul>
<p>这就让 <strong>同层的节点比较只需一次线性扫描</strong>。</p>
<p>👉 因此，同层 diff 的复杂度变为 <strong>O(n)</strong> 。</p>
<h4 data-id="heading-5">key 的作用是什么？</h4>
<ul>
<li>
<p>是React对于列表元素的唯一标识</p>
<ul>
<li>如果key相同，那么认为是同一节点，可以复用DOM元素</li>
<li>如果key不同，则会销毁旧的，创建新的节点</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">为什么不能用 index 作为 key？</h4>
<p>因为会导致错误的复用和性能问题</p>
<ul>
<li>因为列表内容如果从中间新增或者删除一项，那么index对应的元素将会错误的被复用</li>
</ul>
<h4 data-id="heading-7">React 中 reconciliation 的过程是怎样的？</h4>
<ul>
<li>当组件的 <code>state</code> 或 <code>props</code> 变化时，React 会比较<strong>新旧虚拟 DOM（Fiber 树）</strong> ，找出需要更新的部分并同步到真实 DOM。这个比较与更新过程叫 <strong>Reconciliation</strong></li>
</ul>
<h3 data-id="heading-8">React 更新是同步还是异步的？</h3>
<h4 data-id="heading-9">同步更新</h4>
<p>同步模式下，React一旦开始渲染，就会<strong>一口气渲染完所有组件</strong>，期间不会中断</p>
<ul>
<li>
<p>页面上的表现</p>
<ul>
<li>当你触发一个大型渲染（比如 setState 导致 1000 个组件更新）时，<strong>页面会卡顿一下</strong></li>
<li>浏览器在 React 渲染完成前，<strong>无法响应用户操作（比如滚动、点击）</strong></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
      <span class="hljs-title function_">setCount</span>(i) <span class="hljs-comment">// 模拟大规模更新</span>
    }
  }

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
}
</code></pre>
<p>在同步更新下，点击按钮后：</p>
<ul>
<li>UI 会“卡死”几百毫秒；</li>
<li>最后一次性更新成最终结果。</li>
</ul>
<h4 data-id="heading-10">异步（Concurrent）更新（React 18 createRoot）</h4>
<p>在并发模式下，React会把渲染拆分为小任务，在<strong>空闲时间片</strong>执行，可以随时暂停、恢复或丢弃</p>
<ul>
<li>
<p>页面上的表现</p>
<ul>
<li>大型渲染不再卡顿；</li>
<li>页面仍能响应滚动、输入、动画；</li>
<li>React 会优先处理用户交互（高优先级），低优先级任务（如列表渲染）可延后执行。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useState, startTransition } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> [list, setList] = <span class="hljs-title function_">useState</span>([])

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-keyword">const</span> val = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>
    <span class="hljs-title function_">setValue</span>(val)
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 模拟高开销任务</span>
      <span class="hljs-keyword">const</span> items = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">5000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${val}</span>-<span class="hljs-subst">${i}</span>`</span>)
      <span class="hljs-title function_">setList</span>(items)
    })
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入点东西"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{list.map((item) =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item}</span>&gt;</span>{item}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<p>在异步（Concurrent）模式下：</p>
<ul>
<li>输入框 <strong>不会卡顿</strong>；</li>
<li>React 会<strong>优先更新输入框的值</strong>；</li>
<li>再利用空闲时间慢慢渲染列表；</li>
<li>如果你输入更快，React 会<strong>丢弃旧的渲染任务</strong>，直接开始最新的。</li>
</ul>
<h4 data-id="heading-11">同步场景</h4>
<h5 data-id="heading-12">React17及以前的全部更新，默认同步</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// React 17 写法（使用 ReactDOM.render）</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'render:'</span>, count)

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;
      Click: {count}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  )
}

<span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>, <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>))
</code></pre>
<p>💬 说明：</p>
<ul>
<li>在 React 17（及更早版本）中，React <strong>没有并发模式（Concurrent Mode）</strong> 。</li>
<li>所有更新（无论大或小）都是同步执行的。</li>
<li>点击按钮时，会立刻执行所有渲染逻辑。</li>
</ul>
<p>📍<strong>页面效果：</strong></p>
<blockquote>
<p>即使组件很复杂、渲染耗时，React 也会“卡着”把它一次性渲染完。</p>
</blockquote>
<h5 data-id="heading-13">React 18 中的旧 Root（非 Concurrent Root）</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// React 18，但仍使用 ReactDOM.render（旧 Root）</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App'</span>

<span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>, <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>))
</code></pre>
<ul>
<li>即使你使用 React 18，只要还用旧的 <code>ReactDOM.render</code>， React 就不会启用并发模式（仍是同步更新）。</li>
<li>所以这种 root 下的渲染依然会一次性执行完，期间不能被打断。</li>
</ul>
<p>📍<strong>页面效果：</strong></p>
<blockquote>
<p>和 React 17 完全一样，仍然是同步阻塞渲染。</p>
</blockquote>
<h5 data-id="heading-14">在 React 事件回调中调用的更新</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Before:'</span>, count)
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'After:'</span>, count)
  }

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>Click: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
}
</code></pre>
<p>即使你在 React 18 并发模式下（使用 <code>createRoot</code>）， <strong>在 React 事件回调中触发的更新仍是同步批量更新</strong>。</p>
<p>React 会立即计算新的 Fiber 树，保证交互即时。</p>
<h4 data-id="heading-15">异步场景</h4>
<h5 data-id="heading-16">使用 createRoot()</h5>
<p>使用 <code>createRoot()</code>（并发 root）—— 开启异步渲染能力</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// React 18 推荐写法（Concurrent Root）</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App'</span>

<span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>))
root.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>)
</code></pre>
<ul>
<li><code>createRoot()</code> 会启用 <strong>Concurrent Mode（并发模式）</strong> ；</li>
<li>在这种 root 下，React 的更新<strong>具备可中断、可延迟</strong>的能力；</li>
<li>不代表所有更新都异步，但具备<strong>异步调度的基础条件</strong>。</li>
</ul>
<p>📍<strong>页面效果：</strong></p>
<blockquote>
<p>如果组件渲染量大，React 可以暂停、分段渲染，不会卡死主线程。 用户输入或动画依然流畅。</p>
</blockquote>
<h5 data-id="heading-17">使用 <code>startTransition()</code>（标记低优先级更新）</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useState, startTransition } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> [list, setList] = <span class="hljs-title function_">useState</span>([])

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-keyword">const</span> val = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>
    <span class="hljs-title function_">setValue</span>(val)
    <span class="hljs-comment">// 👇 告诉 React：这是低优先级任务，可延迟执行</span>
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> items = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">5000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${val}</span>-<span class="hljs-subst">${i}</span>`</span>)
      <span class="hljs-title function_">setList</span>(items)
    })
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入点东西"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{list.map((item) =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item}</span>&gt;</span>{item}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<p>说明：</p>
<ul>
<li><code>startTransition()</code> 将内部更新标记为<strong>可中断任务</strong>；</li>
<li>高优先级任务（输入框更新）会<strong>先执行</strong>；</li>
<li>低优先级任务（列表渲染）会在空闲时执行；</li>
<li>若用户继续输入，React 会<strong>丢弃旧任务</strong>、渲染最新的。</li>
</ul>
<p>📍<strong>页面效果：</strong></p>
<blockquote>
<p>输入非常流畅，列表延迟更新但不卡顿。</p>
</blockquote>
<h5 data-id="heading-18">使用 <code>useDeferredValue()</code>（延迟渲染依赖值）</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useState, useDeferredValue } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> deferredText = <span class="hljs-title function_">useDeferredValue</span>(text) <span class="hljs-comment">// 延迟使用 text 的值</span>

  <span class="hljs-keyword">const</span> list = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">5000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{deferredText}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
  ))

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{text}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setText(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{list}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
</code></pre>
<p>说明：</p>
<ul>
<li><code>useDeferredValue()</code> 会在高优先级更新（输入）后，<strong>延迟执行耗时渲染</strong>；</li>
<li>输入流畅；</li>
<li>列表内容更新稍后完成。</li>
</ul>
<p>📍<strong>页面效果：</strong></p>
<blockquote>
<p>输入框立即响应，列表延迟一点点更新。 类似于“防抖 + 并发更新”的效果</p>
</blockquote>
<p><strong>一句话总结：</strong></p>
<blockquote>
<p>在 React 18 中，只要使用 <code>createRoot()</code> 启动应用， 你就进入了并发世界。 再搭配 <code>startTransition()</code> / <code>useDeferredValue()</code>， 就能让 React 的更新更智能、更流畅。</p>
</blockquote>
<h3 data-id="heading-19">Fiber 是为了解决什么问题？</h3>
<ul>
<li>Fiber 是 React 为了解决「同步更新导致的卡顿问题」而引入的「可中断、可恢复的虚拟 DOM 架构」</li>
<li>Fiber 是 React 的底层重构，用于让虚拟 DOM 更新“可中断、可恢复、可调度”，从而提升大规模渲染的流畅度。</li>
</ul>
<h4 data-id="heading-20">背景问题</h4>
<p>React15的缺陷，在React15之前，更新流程是这样的：</p>
<ol start="0">
<li>状态更新后，React 会从根节点开始，<strong>递归遍历整棵虚拟 DOM 树</strong>；</li>
<li>每次更新都同步执行到底（不能中断）</li>
<li>如果组件层级很深、计算复杂，就会<strong>长时间占用主线程</strong>；</li>
<li>主线程被占用时，浏览器无法响应用户操作（如输入、滚动） → <strong>卡顿、掉帧</strong></li>
</ol>
<h4 data-id="heading-21">fiber的核心目标</h4>
<p>React团队为了解决“更新太重，无法中断”的问题，引入了fiber架构</p>
<ol>
<li>可中断更新：react更新可以被中断，让浏览器先去响应用户操作</li>
<li>可分片执行：大任务被拆分为小任务，（每一帧执行一点）</li>
<li>可恢复与重用：被中断后可以从上次中断的地方继续执行</li>
</ol>
<h4 data-id="heading-22">Fiber的设计思路</h4>
<p>React 把每个虚拟 DOM 节点（VNode）包装成一个 <strong>Fiber 对象</strong>， 这个对象包含：</p>
<ul>
<li>节点类型、props、state</li>
<li>指向父节点、子节点、兄弟节点的指针（形成链表结构）</li>
<li>更新优先级信息（lane）</li>
<li>副作用标记（如需插入/删除/更新）</li>
</ul>
<p>➡️ 这样 React 就可以：</p>
<ul>
<li>用「遍历链表」代替「递归函数调用」（可随时暂停）</li>
<li>在空闲时间片中继续工作（用调度器协调）</li>
<li>动态决定哪部分更新优先（配合 Concurrent Mode）</li>
</ul>
<h3 data-id="heading-23">Fiber 是如何实现可中断渲染的？</h3>
<ul>
<li>Fiber 通过把递归改为循环、把组件树改为链表结构、并利用时间片调度机制，使得 React 的渲染可以“暂停—恢复—继续”，从而实现了可中断渲染。</li>
</ul>
<p>在React15中，更新虚拟DOM时使用的是递归遍历整棵树的方式</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateComponent</span>(<span class="hljs-params">component</span>) {
  component.<span class="hljs-title function_">render</span>()
  component.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(updateComponent)
}
</code></pre>
<p>问题是：</p>
<ul>
<li>JS 是<strong>单线程</strong>的；</li>
<li>一旦进入这段递归逻辑，就无法中途暂停；</li>
<li>如果组件树很大，浏览器主线程会被长期占用；</li>
<li>用户交互、动画、输入都会卡顿。</li>
</ul>
<p>React 16 重写架构为 <strong>Fiber Reconciler</strong>。 目标：让“渲染过程”像执行协程一样 —— <strong>可中断、可恢复、可调度。</strong></p>
<p>Fiber 的关键设计思想是：</p>
<blockquote>
<p>“把每个虚拟 DOM 节点（VNode）变成一个 Fiber 对象，并把组件树改成链表结构。”</p>
</blockquote>
<p>这样 React 就可以：</p>
<ol start="0">
<li>用 <code>while</code> 循环<strong>遍历链表</strong>（而非递归）；</li>
<li>每处理一个 Fiber 节点，都检查当前帧是否超时；</li>
<li>如果时间用完，就<strong>暂停渲染</strong>，把控制权交还浏览器；</li>
<li>下一帧（或空闲时）再从上次中断的 Fiber 继续工作。</li>
</ol>
<h2 data-id="heading-24">React Hooks</h2>
<h3 data-id="heading-25">useState</h3>
<h4 data-id="heading-26">基础概念</h4>
<p><code>useState</code> 是 React 提供的用于在函数组件中声明状态（state）的 Hook。</p>
<p>const [state, setState] = useState(initialValue)</p>
<ul>
<li><code>state</code>：当前状态值。</li>
<li><code>setState</code>：更新状态的函数，会触发组件重新渲染。</li>
<li><code>initialValue</code>：初始状态值，只在组件首次渲染时使用。</li>
</ul>
<h4 data-id="heading-27">运行机制</h4>
<p>当组件执行时（函数重新运行），<code>useState</code> 并不会重新创建新的状态，而是通过 <strong>React 内部的 Hook 链表（Fiber）机制</strong> 取回上一次保存的状态值。</p>
<p>也就是说：</p>
<ul>
<li>虽然函数重新执行了，</li>
<li>但 <code>useState</code> 通过<strong>闭包 + 内部索引</strong>保存并取回之前的状态。</li>
</ul>
<p>👉 因此即使多次调用 <code>useState(0)</code>，<code>state</code> 也不会回到 0。</p>
<p><strong>React 约束：</strong> Hook 调用顺序必须一致，否则状态会错位。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> x = []
<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">myUseState</span> = initial =&gt; {
	<span class="hljs-keyword">let</span> currentIndex = index 
	x[currenIndex] = x[currentIndex] === <span class="hljs-literal">undefined</span> ? initial : x[currentIndex]

	<span class="hljs-keyword">const</span> <span class="hljs-title function_">setInitial</span> = value =&gt; {
		x[currentIndex] = value
		<span class="hljs-title function_">render</span>()
	}
}

<span class="hljs-comment">//模拟render函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">render</span> = (<span class="hljs-params"/>) =&gt; {
	index = <span class="hljs-number">0</span>
	<span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span>/&gt;</span></span>, <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#root"</span>))
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
	<span class="hljs-keyword">const</span> [n, setN] = <span class="hljs-title function_">myUseState</span>(<span class="hljs-number">0</span>)
	<span class="hljs-keyword">const</span> [m, setM] = <span class="hljs-title function_">myUseState</span>(<span class="hljs-number">0</span>)
	<span class="hljs-keyword">return</span> (
		<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
	         <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>n：{n}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
	         <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=&gt;</span>setN(n+1)}&gt;+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
	         <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>m：{m}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
	         <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=&gt;</span>setM(m+1)}&gt;+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
     	<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
	)
}
</code></pre>
<h4 data-id="heading-28">异步批处理（Batch Update）</h4>
<p>React 会将多个状态更新合并执行（在事件回调中）。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>)

<span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>)

<span class="hljs-comment">// 实际只增加一次</span>

在 <span class="hljs-title class_">React</span> <span class="hljs-number">18</span> 中，异步任务（如 <span class="hljs-built_in">setTimeout</span>、<span class="hljs-title class_">Promise</span>）中的 setState 不再强制合并。
</code></pre>
<h4 data-id="heading-29">惰性初始化</h4>
<p>初始值可以是一个函数：</p>
<p>const [data, setData] = useState(() =&gt; heavyCalculation())</p>
<p>✅ <code>heavyCalculation()</code> 只在首次渲染时执行，避免每次渲染重复计算。</p>
<h4 data-id="heading-30">更新函数形式</h4>
<p>当新状态依赖旧状态时，用函数式更新：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>)
</code></pre>
<h3 data-id="heading-31">useEffect</h3>
<h4 data-id="heading-32">一、作用</h4>
<p><code>useEffect</code> 用于处理 <strong>副作用（side effects）</strong> ，比如：</p>
<ul>
<li>网络请求</li>
<li>订阅 / 事件监听</li>
<li>操作 DOM</li>
<li>定时器</li>
</ul>
<p>这些逻辑不能直接放在渲染阶段，否则会阻塞或污染渲染。</p>
<ul>
<li>
<p>函数组件需要是纯函数：</p>
<ul>
<li>相同输入 → 永远相同输出</li>
<li>不修改外部变量</li>
<li>不产生额外行为</li>
</ul>
</li>
</ul>

<ul>
<li>
<p>React 设定函数组件必须满足：</p>
<ul>
<li>相同的 props &amp; state → 必须产生完全相同的 UI</li>
</ul>

<ul>
<li>不依赖外部可变环境</li>
</ul>

<ul>
<li>没有无法预测的行为</li>
</ul>

<ul>
<li>渲染阶段必须同步、快速、纯净</li>
</ul>
</li>
</ul>
<p>换句话说：</p>
<blockquote>
<p><strong>组件函数必须像数学函数一样：输入 → 输出 UI</strong></p>
</blockquote>
<h4 data-id="heading-33">二、执行时机</h4>
<ul>
<li><strong>初次渲染后</strong> 执行（不会阻塞渲染）。</li>
<li><strong>依赖项变化</strong> 时重新执行。</li>
<li><strong>组件卸载前</strong> 执行清理函数。</li>
</ul>
<h4 data-id="heading-34">三、依赖数组 <code>[deps]</code></h4>





















<table><thead><tr><th>写法</th><th>执行时机</th></tr></thead><tbody><tr><td><code>useEffect(fn)</code></td><td>每次渲染都执行</td></tr><tr><td><code>useEffect(fn, [])</code></td><td>仅挂载和卸载时执行一次</td></tr><tr><td><code>useEffect(fn, [a, b])</code></td><td>当依赖项 a 或 b 改变时执行</td></tr></tbody></table>
<p>⚠️ React 比较依赖项是<strong>浅比较</strong>，如果依赖对象或数组的引用变了，即使内容没变也会触发。</p>
<h4 data-id="heading-35">四、清理函数</h4>
<p>返回一个函数，用于卸载或重新执行前清理副作用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'tick'</span>), <span class="hljs-number">1000</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(id)
}, [])
</code></pre>
<p>执行时机：</p>
<ol start="0">
<li>组件卸载时；</li>
<li>副作用重新执行前。</li>
</ol>
<h4 data-id="heading-36">五、面试常问点</h4>
<ol start="0">
<li>
<p><strong>useEffect 为什么在渲染后执行？</strong> 为了让渲染过程纯净，不被副作用打断。</p>
</li>
<li>
<p><strong>为什么要写依赖数组？</strong> 告诉 React 什么时候重新运行副作用，否则可能死循环。</p>
</li>
<li>
<p><strong>依赖项写错或少写会怎样？</strong> 可能导致状态不同步或逻辑失效（React 会在严格模式下警告）。</p>
</li>
<li>
<p><strong>useLayoutEffect 和 useEffect 的区别？</strong></p>
<ul>
<li><code>useEffect</code>：渲染完成后异步执行，不阻塞绘制。</li>
<li><code>useLayoutEffect</code>：DOM 更新后、浏览器绘制前同步执行，可用于测量 DOM。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-37">useRef</h3>
<h4 data-id="heading-38">核心定义</h4>
<ul>
<li><code>useRef</code> 是一个能在组件整个生命周期内 <strong>保持引用不变</strong> 的 Hook。</li>
<li>它返回一个可变对象 <code>{ current: ... }</code>，这个对象在组件的重新渲染中<strong>不会被重置</strong>。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(initialValue)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ref.<span class="hljs-property">current</span>) <span class="hljs-comment">// ref.current 保存的数据在组件多次渲染之间是持久的</span>
</code></pre>
<h4 data-id="heading-39">应用场景</h4>
<h5 data-id="heading-40">获取DOM节点</h5>
<ul>
<li>在React中使用useRef获取DOM比原生方式获取DOM更可靠</li>
<li><code>inputRef.current</code> 会指向对应的 DOM 元素。</li>
<li>通常用于：聚焦、滚动、测量宽高、绑定第三方库。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>)

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>()
  }, [])

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span> /&gt;</span></span>
}
</code></pre>
<h5 data-id="heading-41">保存 任意可变值（不触发重新渲染）</h5>
<p><code>count.current</code> 的值在组件重渲染时仍然保持；</p>
<p>修改 <code>ref.current</code> <strong>不会引起重新渲染</strong>；</p>
<p>所以它非常适合存储：</p>
<ul>
<li>前一次的值（用于比较）</li>
<li>定时器 id</li>
<li>防抖节流计数器</li>
<li>某个状态的缓存值</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Timer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>)

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">current</span> += <span class="hljs-number">1</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count.<span class="hljs-property">current</span>)
  }

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>Click<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
}
</code></pre>
<h3 data-id="heading-42">useMemo</h3>
<ul>
<li>开发中，我们只要修改了父组件的数据，所有的子组件都会重新渲染，这是十分消耗性能的</li>
<li>如果我们希望子组件不要进行这种没有必要的重新渲染，我们可以将子组件继承PureComponent或者使用memo函数包裹</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { memo, useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">A</span> = (<span class="hljs-params">props</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A1'</span>)
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A2'</span>)
  })
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}

<span class="hljs-keyword">const</span> B = <span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">props</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'B1'</span>)
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'B2'</span>)
  })
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Home</span> = (<span class="hljs-params">props</span>) =&gt; {
  <span class="hljs-keyword">const</span> [a, setA] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'start'</span>)
    <span class="hljs-title function_">setA</span>(<span class="hljs-number">1</span>)
  }, [])
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">A</span> <span class="hljs-attr">n</span>=<span class="hljs-string">{a}</span> /&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">B</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<ul>
<li>将子组件B使用memo包裹之后，Home组件中的状态a的变化就不会导致B组件的重新渲染</li>
<li>但是在子组件B使用了父组件的<strong>某个引用类型的变量或者函数</strong>时，那么当父组件状态更新之后，这些变量和函数就会重新赋值，导致子组件B还是会重新渲染</li>
<li>想解决这个问题，就需要使用useMemo和useCallback了</li>
</ul>
<h3 data-id="heading-43">useCallback</h3>
<ul>
<li>当函数组件重新渲染时，其中的函数也会被重复定义多次</li>
<li>如果使用useCallBack对函数进行包裹，那么在依赖（第二个参数）不变的情况下，会返回同一个函数 这样子组件就不会因为函数的重新定义而导致重新渲染了</li>
<li>useMemo和useCallBack相似，缓存的是函数的返回值，一般用来优化变量，但是如果将useMemo的返回值定义为返回一个函数就可以实现useCallBack一样的功能</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//用useMemo实现同useCallback一样的效果</span>
   <span class="hljs-keyword">const</span> increment = <span class="hljs-title function_">useCallback</span>(fn,[])
   <span class="hljs-keyword">const</span> increment2 = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">()=&gt;</span>fn,[])
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { memo, useState, useEffect, useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Home</span> = (<span class="hljs-params">props</span>) =&gt; {
  <span class="hljs-keyword">const</span> [a, setA] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> [b, setB] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setA</span>(<span class="hljs-number">1</span>)
  }, [])

  <span class="hljs-keyword">const</span> add = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'b'</span>, b)
  }, [b])

  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> b + <span class="hljs-string">'xuxi'</span>
  }, [b])
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">A</span> <span class="hljs-attr">n</span>=<span class="hljs-string">{a}</span> /&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">B</span> <span class="hljs-attr">add</span>=<span class="hljs-string">{add}</span> <span class="hljs-attr">name</span>=<span class="hljs-string">{name}</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<h3 data-id="heading-44">useContext</h3>
<h4 data-id="heading-45">useContext 是什么？</h4>
<p><code>useContext</code> 是 React 的一个 Hook，用于：</p>
<ul>
<li>在<strong>函数组件中直接读取</strong>由上层组件 <code>Context.Provider</code> 提供的值。</li>
</ul>
<p>简单理解：</p>
<ul>
<li>不用一层层 props 传递，也能让深层组件拿到共享数据。</li>
</ul>
<h4 data-id="heading-46">语法</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">value</span> = useContext(MyContext)
</code></pre>
<ul>
<li>MyContext 是通过 React.createContext() 创建的上下文对象。</li>
<li>useContext() 返回最近的 &lt;MyContext.Provider&gt; <strong>提供的 value</strong>。</li>
<li>当 Provider 的 value 变化时，所有<strong>使用该 context 的组件都会重新渲染。</strong></li>
</ul>
<h4 data-id="heading-47">使用步骤</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// context.js</span>
<span class="hljs-keyword">import</span> { createContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-string">"light"</span>)

<span class="hljs-comment">// App.jsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemeContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./context"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child"</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"dark"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>
  )
}

<span class="hljs-comment">// Child.jsx</span>
<span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemeContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./context"</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>)
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>当前主题：{theme}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<h4 data-id="heading-48">特性</h4>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>最近优先</strong></td><td>如果组件外层有多个相同类型的 Provider，会取最近一层的 value</td></tr><tr><td><strong>响应式更新</strong></td><td>Provider 的 value 改变，会触发所有消费该 Context 的组件重新渲染</td></tr><tr><td><strong>只能在函数组件或自定义 Hook 中使用</strong></td><td>不能在类组件或普通函数中调用</td></tr><tr><td><strong>不能脱离 Provider 使用</strong></td><td>如果没有 Provider 包裹，会使用 <code>createContext()</code> 时设置的默认值</td></tr></tbody></table>
<h4 data-id="heading-49">应用场景</h4>

























<table><thead><tr><th>场景</th><th>示例</th></tr></thead><tbody><tr><td>✅ 主题切换</td><td>dark / light 模式</td></tr><tr><td>✅ 登录状态</td><td>用户信息、Token</td></tr><tr><td>✅ 多语言切换</td><td>中英文语言包</td></tr><tr><td>✅ 全局配置</td><td>比如分页大小、API地址等</td></tr></tbody></table>
<h4 data-id="heading-50">常见问题</h4>
<p>useContext 和 props 传递的区别？</p>

























<table><thead><tr><th>对比项</th><th>props</th><th>useContext</th></tr></thead><tbody><tr><td>数据传递</td><td>一层层手动传递</td><td>任何层级都可直接拿到</td></tr><tr><td>灵活性</td><td>高（精确控制）</td><td>全局性（可能过度渲染）</td></tr><tr><td>适用场景</td><td>局部数据传递</td><td>全局共享状态</td></tr></tbody></table>
<p>useContext 的缺点是什么？</p>
<ul>
<li>当 <code>Provider</code> 的 value 改变时，<strong>所有消费它的组件都会重新渲染</strong>；</li>
<li>这可能导致<strong>性能问题</strong>（无论组件是否使用了 value 的具体字段）；</li>
<li>因此大型项目中往往结合 <strong><code>useReducer</code> 或 <code>Redux / Zustand</code> 等状态管理库</strong> 一起使用</li>
</ul>
<h3 data-id="heading-51">forwardRef</h3>
<p>在React开发中，有些时候我们需要获取DOM或者组件来进行某些操作</p>
<ul>
<li>
<p>如何使用ref来获取DOM</p>
<ul>
<li>使用createref创建ref对象，并且绑定到DOM元素上</li>
</ul>
</li>
<li>
<p><strong>forwardRef</strong>解决的问题是<strong>ref</strong>不会通<strong>props</strong>传递下去，因为ref和<strong>key</strong>一样被React做了特殊处理</p>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">PureComponent</span> ,createRef} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PureComponent</span> {
    <span class="hljs-comment">//创建ref</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">titleRef</span> = <span class="hljs-title function_">createRef</span>()
  }
  <span class="hljs-title function_">getNativeDOM</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">titleRef</span>.<span class="hljs-property">current</span>)
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.titleRef}</span>&gt;</span>hello world<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{e</span>=&gt;</span>this.getNativeDOM()}&gt;获取DOM<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
  }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>
</code></pre>
<p>ref 的值根据节点的类型有所不同：</p>
<ol start="0">
<li>当<strong>ref</strong>属性作用于HTML属性时，接收底层DOM元素作为其<strong>current</strong>属性</li>
<li>当<strong>ref</strong>属性作用于class组件时，接收组件实例作为其current属性</li>
<li><strong>不能在函数组件上使用ref属性</strong>，因为他们没有实例</li>
</ol>
<p>想将ref挂载到函数组件内部的某个class组件或者HTML元素上时，我们需要使用React.forwardRef将函数组件包裹，从而将ref传递到组件内部</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//获取函数组件的某个DOM</span>
<span class="hljs-comment">//使用forwardRef之后，可以传入两个参数，第二个为ref，我们可以实现ref转发</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Fun</span> = <span class="hljs-title function_">forwardRef</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">props,ref</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span>&gt;</span>hello react<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
  )
})
</code></pre>
<p>使用ref作用于类组件，并调用类组件实例的方法</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">PureComponent</span>, createRef, forwardRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-comment">//类子组件</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PureComponent</span> {
  <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"test---"</span>)
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>hello world<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
    )
  }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PureComponent</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = {}
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hwRef</span> = <span class="hljs-title function_">createRef</span>()
  }
  <span class="hljs-title function_">getComponent</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">//调用类组件实例的方法</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">hwRef</span>.<span class="hljs-property">current</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hwRef</span>.<span class="hljs-property">current</span>.<span class="hljs-title function_">test</span>()
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">HelloWorld</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.hwRef}</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{e</span> =&gt;</span> this.getComponent()}&gt;获取组件实例<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
  }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>
</code></pre>
<h3 data-id="heading-52">useImperativeHandle</h3>
<ul>
<li>
<p>forwardRef使用带来的问题</p>
<ul>
<li>直接暴露给父组件，使得某些情况不可控</li>
<li>父组件拿到子组件之后可以进行任意的操作</li>
</ul>
</li>
<li>
<p>通过useImperativeHandle可以暴露固定的操作</p>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, {
  useRef,
  forwardRef, useImperativeHandle
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">HYInput</span> = <span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">(<span class="hljs-params">props,ref</span>)=&gt;</span> {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>()
  <span class="hljs-title function_">useImperativeHandle</span>(ref,<span class="hljs-function">()=&gt;</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">focus</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">345</span>);
        inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>()
      }
    } 
  })

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>/&gt;</span></span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">UseImperativeHandleHookDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>()
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">HYInput</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}/</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{e</span>=&gt;</span>inputRef.current.focus()}&gt;聚焦<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h3 data-id="heading-53">原理题</h3>
<h4 data-id="heading-54">React Hooks 为什么不能放在条件判断里？</h4>
<ul>
<li>
<p>React Hooks <strong>不能放在条件判断、循环或嵌套函数中</strong>，必须在组件的<strong>顶层</strong>调用。</p>
<ul>
<li>因为——<strong>React 是通过调用顺序来识别每一个 Hook 的。</strong></li>
</ul>
</li>
</ul>
<p>每个组件渲染时，React 会维护一个“Hook 调用链表”或“数组”， 类似这样（简化理解）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 第一次渲染</span>
<span class="hljs-title function_">useState</span>(<span class="hljs-string">'A'</span>)   <span class="hljs-comment">// Hook 1</span>
<span class="hljs-title function_">useEffect</span>(...)  <span class="hljs-comment">// Hook 2</span>
<span class="hljs-title function_">useState</span>(<span class="hljs-string">'B'</span>)   <span class="hljs-comment">// Hook 3</span>
</code></pre>
<p>React 会按顺序记下每一个 Hook 对应的状态（存在 Fiber 节点上）。
下一次渲染时，React 会再次按<strong>相同顺序</strong>调用 Hook 来匹配之前的状态。</p>
<hr/>
<p>如果放在条件语句中会发生什么？</p>
<pre><code class="hljs language-scss" lang="scss">if (flag) {
  <span class="hljs-built_in">useState</span>(<span class="hljs-number">1</span>)
}
<span class="hljs-built_in">useEffect</span>(() =&gt; {})
</code></pre>
<ul>
<li>
<p>第一次渲染：</p>
<ul>
<li>flag = true → 执行 <code>useState</code>（Hook 1）</li>
<li>执行 <code>useEffect</code>（Hook 2）</li>
</ul>
</li>
<li>
<p>第二次渲染：</p>
<ul>
<li>flag = false → 跳过 <code>useState</code></li>
<li><code>useEffect</code> 变成了 Hook 1！</li>
</ul>
</li>
</ul>
<blockquote>
<p>🚨 React 内部匹配错位！ 本该给 <code>useEffect</code> 的 Hook 状态，被错误地分配成了之前的 <code>useState</code> 状态。</p>
</blockquote>
<p>结果可能报错：</p>
<pre><code class="hljs language-r" lang="r">Rendered fewer hooks than expected
Invalid hook <span class="hljs-built_in">call</span>
</code></pre>
<h4 data-id="heading-55">Hooks的执行顺序是如何保证的？</h4>
<ul>
<li>React 通过在每个 Fiber 节点上维护一个 <strong>Hook 链表</strong></li>
<li>并在每次渲染时按顺序遍历执行</li>
<li>从而确保每个 Hook 的状态和顺序一致。</li>
</ul>
<h4 data-id="heading-56">自定义 Hook 怎么避免闭包陷阱？</h4>
<ol start="0">
<li>使用函数式更新（最常用）</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>)
</code></pre>
<ul>
<li><code>prev</code> 永远是最新 state</li>
<li>无需依赖闭包捕获的旧值</li>
<li>适用于事件回调、定时器、异步请求等</li>
</ul>
<ol start="2">
<li>用 <code>useRef</code> 保存最新值</li>
</ol>
<p>如果你需要在闭包里访问最新状态而不触发重新渲染：
const countRef = useRef(count)
useEffect(() =&gt; {
countRef.current = count
}, [count])</p>
<p>const logCount = () =&gt; {
console.log(countRef.current) // 永远是最新值
}</p>
<ul>
<li>异步函数或事件可以使用 <code>countRef.current</code></li>
<li>不影响 React 渲染流程</li>
</ul>
<h2 data-id="heading-57">组件渲染与性能优化</h2>
<h3 data-id="heading-58">React 组件何时重新渲染？</h3>
<ol start="0">
<li>
<p>state发生变化：只要你调用 <code>setState</code> 产生了<strong>新的值</strong>（引用变化），组件就会重新渲染。</p>
</li>
<li>
<p>props变化：只要<strong>父组件重新渲染</strong>，子组件也会跟着渲染（除非使用 <code>React.memo</code>）。</p>
<p>即使 props 内容没变 —— 只要父组件 render，子组件也会 render。</p>
</li>
<li>
<p>context变化：当某个 Context Provider 的 value 改变，所有消费该 context 的子组件都会重渲染。</p>
</li>
<li>
<p>父组件重新渲染导致子组件渲染（哪怕 props 不变）</p>
</li>
</ol>
<p>浅比较会对比：</p>
<ul>
<li><strong>基本类型值（number / string / boolean / null / undefined）</strong> → 直接比较值是否相等。</li>
<li><strong>引用类型（object / array / function）</strong> → <strong>只比较引用地址是否相同</strong>，不会比较内部的内容。</li>
</ul>
<p>React 在性能优化时会用浅比较，比如：</p>
<ul>
<li><strong>React.memo</strong></li>
<li><strong>PureComponent</strong></li>
<li><strong>shouldComponentUpdate</strong></li>
<li><strong>useMemo / useCallback 的依赖项比较</strong></li>
<li><strong>useEffect / useCallback 的依赖数组</strong></li>
</ul>
<p>因为浅比较非常快，不需要深度遍历对象。</p>
<ul>
<li>
<p>浅比较带来的典型问题</p>
<ul>
<li>使用 inline function 导致子组件重新渲染</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">&lt;Child onClick={() =&gt; <span class="hljs-built_in">setCount</span>(count + <span class="hljs-number">1</span>)} /&gt;
</code></pre>
<p>每次父组件 render 时都会创建新的函数引用 → 浅比较结果：不同 → 子组件重新渲染</p>
<ul>
<li>
<p>解决方法</p>
<ul>
<li>用 <strong>useCallback 固定函数引用</strong></li>
<li>用 <strong>useMemo 固定对象 / 数组引用</strong></li>
<li>子组件用 <strong>React.memo</strong></li>
</ul>
</li>
</ul>
<h3 data-id="heading-59">如何优化一个大表格或长列表的渲染性能？（虚拟列表）</h3>
<ul>
<li>
<p>为什么需要虚拟列表？</p>
<ul>
<li>
<p>当列表有 <strong>成百上千甚至上万条数据</strong>时：</p>
<ul>
<li>浏览器会创建大量 DOM（慢）</li>
<li>布局、重排、重绘消耗巨大（卡）</li>
<li>滚动时频繁触发渲染（卡顿）</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>👉 <strong>核心思路</strong>： 只渲染<strong>可视区域内</strong>的那几十个节点，其余内容用占位高度撑开。</p>
<ul>
<li>
<p>什么时候用虚拟列表</p>
<ul>
<li>
<p>满足任一即可使用虚拟列表：</p>
<ul>
<li>单页表格数据量 &gt; 200 行</li>
<li>单页列表 &gt; 300 行</li>
<li>存在大量复杂 DOM（图片、按钮、操作列）</li>
<li>有频繁更新、滚动操作</li>
</ul>
</li>
</ul>
</li>
<li>
<p>核心原理（一句话版本）</p>
<ul>
<li>只有可视区域 + 缓冲区的元素真实渲染</li>
<li>其他区域只用一个大容器撑开高度</li>
<li>视觉上像完整列表，但实际 DOM 数量永远保持几十个</li>
</ul>
</li>
<li>
<p>虚拟列表关键技术</p>
<ul>
<li>
<p>容器高度：列表容器要<strong>固定高度或可计算高度</strong>，否则无法计算可视范围。</p>
</li>
<li>
<p>每行高度：</p>
<ul>
<li>固定高度：最好实现，可用rowheight直接算</li>
<li>不定高度：需要实时记录高度（难度更高）</li>
</ul>
</li>
<li>
<p>计算可视区域的起止 index</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">startIndex</span> = Math.floor(scrollTop / rowHeight)
<span class="hljs-attr">endIndex</span> = startIndex + 可视区域行数 + buffer
</code></pre>
</li>
<li>
<p>渲染可视区域数据</p>
<ul>
<li>只渲染这一小段数据即可。</li>
</ul>
</li>
<li>
<p><strong>使用 translateY 把渲染的内容“挪”到正确位置</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">style</span>=<span class="hljs-string">"transform: translateY(startIndex * rowHeight px)"</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p>前端常用虚拟列表方案</p>
<ul>
<li>
<p>React：<code>react-window</code></p>
<ul>
<li>轻量、简单、性能极佳。</li>
<li><code>&lt;FixedSizeList&gt;</code> 固定行高列表</li>
<li><code>&lt;VariableSizeList&gt;</code> 不定高度列表</li>
<li><code>&lt;FixedSizeGrid&gt;</code> 表格（大表格强烈推荐）</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">import { FixedSizeList as List } from "react-window"<span class="hljs-comment">;</span>
​
&lt;List
  <span class="hljs-attr">height</span>={<span class="hljs-number">600</span>}
  <span class="hljs-attr">width</span>={<span class="hljs-number">800</span>}
  <span class="hljs-attr">itemSize</span>={<span class="hljs-number">40</span>}
  <span class="hljs-attr">itemCount</span>={list.length}
&gt;
  {({ index, style }) =&gt; (
    &lt;div <span class="hljs-attr">style</span>={style}&gt;{list[index].name}&lt;/div&gt;
  )}
&lt;/List&gt;
</code></pre>
<ul>
<li>Ant Design v5</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">&lt;Table
  <span class="hljs-attr">scroll</span>={{ y: <span class="hljs-number">600</span> }}
  virtual
  <span class="hljs-attr">columns</span>={columns}
  <span class="hljs-attr">dataSource</span>={data}
/&gt;
</code></pre>
<ul>
<li>自己实现</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">import React, { useRef, useState, useEffect } from "react"<span class="hljs-comment">;</span>
​
export default function VirtualList({ itemHeight, height, data, renderItem }) {
  const <span class="hljs-attr">containerRef</span> = useRef(null)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[startIndex, setStartIndex]</span> = useState(0)<span class="hljs-comment">;</span>
​
  const <span class="hljs-attr">visibleCount</span> = Math.ceil(height / itemHeight)<span class="hljs-comment">; // 可视区域展示多少条</span>
​
  // 滚动事件
  const <span class="hljs-attr">onScroll</span> = () =&gt; {
    const <span class="hljs-attr">scrollTop</span> = containerRef.current.scrollTop<span class="hljs-comment">;</span>
    const <span class="hljs-attr">newStartIndex</span> = Math.floor(scrollTop / itemHeight)<span class="hljs-comment">;</span>
    setStartIndex(newStartIndex)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
​
  // 当前需要渲染的数据
  const <span class="hljs-attr">endIndex</span> = startIndex + visibleCount<span class="hljs-comment">;</span>
  const <span class="hljs-attr">visibleData</span> = data.slice(startIndex, endIndex)<span class="hljs-comment">;</span>
​
  // 用两个 padding 占位本来应该存在的高度
  const <span class="hljs-attr">paddingTop</span> = startIndex * itemHeight<span class="hljs-comment">;</span>
  const <span class="hljs-attr">paddingBottom</span> = (data.length - endIndex) * itemHeight<span class="hljs-comment">;</span>
​
  return (
    &lt;div
      <span class="hljs-attr">ref</span>={containerRef}
      <span class="hljs-attr">style</span>={{
        height,
        overflowY: "auto",
        border: "1px solid <span class="hljs-comment">#ccc",</span>
      }}
      <span class="hljs-attr">onScroll</span>={<span class="hljs-literal">on</span>Scroll}
    &gt;
      &lt;div <span class="hljs-attr">style</span>={{ paddingTop, paddingBottom }}&gt;
        {visibleData.map((item, i) =&gt;
          renderItem(item, startIndex + i)
        )}
      &lt;/div&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个有趣的CSS题目]]></title>    <link>https://juejin.cn/post/7577702891273977891</link>    <guid>https://juejin.cn/post/7577702891273977891</guid>    <pubDate>2025-11-30T07:01:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273977891" data-draft-id="7577702891273945123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个有趣的CSS题目"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T07:01:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小熊哥722"/> <meta itemprop="url" content="https://juejin.cn/user/758013551998826"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个有趣的CSS题目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/758013551998826/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小熊哥722
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:01:27.000Z" title="Sun Nov 30 2025 07:01:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>前几天无意间看到一个有趣的题，题目很简单，但是最终的结果却出人意料，题目是这样的：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"theme-color"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"blue"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.parent</span>{
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">600px</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
    <span class="hljs-attribute">background-color</span>: aqua;
  }
  <span class="hljs-selector-class">.header</span>{
    <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
    <span class="hljs-attribute">background-color</span>: red;
  }
  <span class="hljs-selector-class">.fotter</span>{
    <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
    <span class="hljs-attribute">background-color</span>: blue;
  }
  <span class="hljs-selector-class">.content</span>{
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fotter"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这段代码中的content的高度是多少，大家可以自己想一下，稍微思考一下。接下来让我们看一下豆包的回答：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1079a08e360f4b7088a1ea8ea5df828e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP54aK5ZOlNzIy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765090886&amp;x-signature=X8vqC5v5pPJp9HsAbLY4CXNYoh8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​
再看一下通义千问的回答：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b63a5c94b0b4a02854b1ba75d5e6eeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP54aK5ZOlNzIy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765090886&amp;x-signature=XjwJ5pkNLCMv8M3r5R5dwSYrUA8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>再看一下deepseek的回答：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6feabc6785084bf7868530bd58ae9a78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP54aK5ZOlNzIy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765090886&amp;x-signature=mIXQk8qkFIKNC1KNOUXXzgFAW9A%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>最后再看看Gemini3的回答：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da4d737e7b56446b9c252ccbcc795171~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP54aK5ZOlNzIy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765090886&amp;x-signature=Q%2BLwi83ac8kvRAnvISj34ifpeU4%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>大家可能以为content的高度不就是200px吗，但是结果真的是这样的吗？</p>
<p>请大家看一下最终的结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/261004008f4e41c8961b0e71dbfedf12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP54aK5ZOlNzIy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765090886&amp;x-signature=rbP%2FoLzZHx4WUjMoRA71SJSsXn8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>       大家会看到content的高度为360px,header和footer的高度为120px，是不是感觉不可思议，为啥会这样嘞，这个问题，想问ai就会发现，这咋问啊，ai全是错的，那我来告诉你们答案（当然我说的也不一定对，但是大差不差，结果肯定是对的）：</p>
<blockquote>
<ul>
<li>percent height 会被解析为父容器的绝对值：content 的 height:100% → 600px（父高度）。</li>
<li>每个子项的 flex base size（假设基准）分别是 header=200, content=600, footer=200，总和 = 1000px。</li>
<li>可用主轴空间 = 600px，差额（需要收缩） = 1000 - 600 = 400px。</li>
<li>默认 flex-shrink = 1，按基准尺寸比例收缩：content 收缩量 = 600/1000 * 400 = 240 → 最终 content 高度 = 600 - 240 = 360px。</li>
</ul>
<p>参考（建议重点看 W3C 规范里的算法）：</p>
<ul>
<li>
<p>W3C Flexbox 规范（详细算法）：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">www.w3.org/TR/css-flex…</a></p>
</li>
<li>
<p>W3C 解析可伸缩长度（resolve flexible lengths）：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">www.w3.org/TR/css-flex…</a></p>
</li>
<li>
<p>MDN（概念与属性）：</p>
<ul>
<li>flex-basis：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>flex-shrink：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>Flexbox 教程（概览）：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
</ul>
</li>
</ul>
</blockquote>
<p>大家可以详细看看理解一下，当然不看也没关系，知道这个计算规则也 可以了，至少比ai强了。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端转战后端：JavaScript 与 Java 对照学习指南 (第一篇 - 深度进阶版)]]></title>    <link>https://juejin.cn/post/7577905525997584425</link>    <guid>https://juejin.cn/post/7577905525997584425</guid>    <pubDate>2025-11-30T07:24:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577905525997584425" data-draft-id="7577969462860169279" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端转战后端：JavaScript 与 Java 对照学习指南 (第一篇 - 深度进阶版)"/> <meta itemprop="keywords" content="JavaScript,Java"/> <meta itemprop="datePublished" content="2025-11-30T07:24:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="汤姆Tom"/> <meta itemprop="url" content="https://juejin.cn/user/4112607842680478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端转战后端：JavaScript 与 Java 对照学习指南 (第一篇 - 深度进阶版)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4112607842680478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    汤姆Tom
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:24:20.000Z" title="Sun Nov 30 2025 07:24:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>对于习惯了 JavaScript (JS) 灵活性的前端开发者来说，Java 看起来可能充满了繁琐的定义和样板代码。但实际上，现代 Java (Java 8/11/17+) 已经吸收了很多函数式编程的特性，写起来越来越顺手。</p>
<p>本篇指南将通过 <strong>JS vs Java</strong> 代码对比的方式，深度解析 <strong>类型系统</strong>、<strong>流式处理 (Stream API)</strong> 、<strong>集合操作</strong> 以及 <strong>常见的内存陷阱</strong>。</p>
<h2 data-id="heading-0">1. 核心思维转变：从“自由”到“约束”</h2>
<p>在开始写代码前，需要建立三个核心认知的转变：</p>
<ol>
<li><strong>入口函数</strong>：JS 代码通常从上到下执行；Java 程序必须从一个 <code>main</code> 方法开始。</li>
<li><strong>类型约束</strong>：JS 是 <code>let a = 1</code> (a 随后可以变成字符串)；Java 是 <code>int a = 1</code> (a 永远只能是整数)。</li>
<li><strong>引用与值</strong>：JS 对对象默认是引用传递，Java 也是引用传递（操作内存地址），但 Java 的<strong>字符串是不可变的</strong>，且比较机制完全不同。</li>
</ol>
<h2 data-id="heading-1">2. 变量声明：<code>var</code> 的真相与基本类型</h2>
<p>Java 10 引入了 <code>var</code>，这让前端感到非常亲切，但它和 JS 的 <code>let/var</code> 有本质区别。</p>
<h3 data-id="heading-2">场景：类型推断与作用域</h3>
<h4 data-id="heading-3">JavaScript</h4>
<pre><code class="hljs language-ini" lang="ini">// JS: 动态类型
let <span class="hljs-attr">id</span> = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
<span class="hljs-attr">id</span> = <span class="hljs-string">"User-10"</span><span class="hljs-comment">; // ✅ 合法，类型变了</span>

// 作用域
if (true) {
    var <span class="hljs-attr">oldVar</span> = <span class="hljs-string">"I leak out"</span><span class="hljs-comment">; // var 会提升 (Hoisting)</span>
    let <span class="hljs-attr">newLet</span> = <span class="hljs-string">"I am safe"</span><span class="hljs-comment">;  // 块级作用域</span>
}
console.log(oldVar)<span class="hljs-comment">; // 能打印</span>
</code></pre>
<h4 data-id="heading-4">Java</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VariableDeepDive</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// --- 1. Java 10+ 的 var (局部变量类型推断) ---</span>
        <span class="hljs-comment">// 看起来像 JS，但实际上编译器在编译时就确定了类型</span>
        <span class="hljs-type">var</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>; <span class="hljs-comment">// 编译器推断 id 是 int 类型</span>
        <span class="hljs-comment">// id = "User-10"; // ❌ 报错！一旦推断为 int，就永远是 int</span>
        
        <span class="hljs-comment">// --- 2. 基本数据类型 vs 包装类型 (深度解析) ---</span>
        <span class="hljs-comment">// int: 存数值，占用内存少，默认值 0</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// Integer: 存对象的地址，默认值 null</span>
        <span class="hljs-comment">// 自动装箱(Autoboxing): Java 自动把 int 5 转为 Integer 对象</span>
        <span class="hljs-type">Integer</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>; 
        
        <span class="hljs-comment">// ⚠️ 坑：空指针异常 (NPE)</span>
        <span class="hljs-type">Integer</span> <span class="hljs-variable">unknownScore</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// int finalScore = unknownScore; // ❌ 运行时崩溃！拆箱 null 会报错</span>
        
        <span class="hljs-comment">// 最佳实践：</span>
        <span class="hljs-comment">// 数据库实体类、泛型列表用 Integer</span>
        <span class="hljs-comment">// 局部变量循环计数用 int</span>
    }
}
</code></pre>
<h2 data-id="heading-5">3. 字符串：不可变性与内存陷阱</h2>
<p>JS 的字符串很简单，Java 的字符串为了性能做了很多底层优化（字符串常量池），导致比较逻辑不同。</p>
<h3 data-id="heading-6">场景：拼接与比较</h3>
<h4 data-id="heading-7">JavaScript</h4>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">a</span> = <span class="hljs-string">"hello"</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">b</span> = <span class="hljs-string">"hello"</span><span class="hljs-comment">;</span>
console.log(<span class="hljs-attr">a</span> === b)<span class="hljs-comment">; // true</span>

// 模板字符串
let <span class="hljs-attr">msg</span> = `Value is <span class="hljs-variable">${a}</span>`<span class="hljs-comment">; </span>
</code></pre>
<h4 data-id="heading-8">Java</h4>
<pre><code class="hljs language-ini" lang="ini">public class StringDeepDive {
    public static void main(String<span class="hljs-section">[]</span> args) {
        // --- 1. 比较陷阱 ---
        String <span class="hljs-attr">s1</span> = <span class="hljs-string">"hello"</span><span class="hljs-comment">; // 存放在常量池</span>
        String <span class="hljs-attr">s2</span> = new String(<span class="hljs-string">"hello"</span>)<span class="hljs-comment">; // 强制在堆内存创建新对象</span>
        
        // ❌ == 比较的是内存地址
        System.out.println(<span class="hljs-attr">s1</span> == s2)<span class="hljs-comment">; // false</span>
        
        // ✅ equals 比较的是字符内容
        System.out.println(s1.equals(s2))<span class="hljs-comment">; // true</span>
        
        // --- 2. 拼接的性能问题 ---
        // 简单的拼接编译器会自动优化
        String <span class="hljs-attr">msg</span> = <span class="hljs-string">"Value is "</span> + s1<span class="hljs-comment">;</span>
        
        // ⚠️ 循环中拼接严禁使用 "+"
        String <span class="hljs-attr">res</span> = <span class="hljs-string">""</span><span class="hljs-comment">;</span>
        // ❌ 性能极差，每次循环都会创建新 String 对象
        // for(int <span class="hljs-attr">i</span>=<span class="hljs-number">0</span><span class="hljs-comment">; i&lt;100; i++) res += i; </span>
        
        // ✅ 正确做法：StringBuilder (类似 JS 数组 join)
        StringBuilder <span class="hljs-attr">sb</span> = new StringBuilder()<span class="hljs-comment">;</span>
        for(int <span class="hljs-attr">i</span>=<span class="hljs-number">0</span><span class="hljs-comment">; i&lt;100; i++) {</span>
            sb.append(i)<span class="hljs-comment">;</span>
        }
        System.out.println(sb.toString())<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h2 data-id="heading-9">4. 数组与列表：Stream API (前端最爱)</h2>
<p>Java 8 引入的 Stream API 简直就是前端 <code>Array.prototype</code> 方法（filter, map, reduce）的亲兄弟。</p>
<h3 data-id="heading-10">场景：筛选大于 10 的数字并翻倍</h3>
<h4 data-id="heading-11">JavaScript</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">numbers</span> = [<span class="hljs-number">5</span>, <span class="hljs-number">12</span>, <span class="hljs-number">8</span>, <span class="hljs-number">20</span>]<span class="hljs-comment">;</span>

// 链式调用：先过滤，再映射
const <span class="hljs-attr">result</span> = numbers
    .filter(<span class="hljs-attr">n</span> =&gt; n &gt; <span class="hljs-number">10</span>)
    .map(<span class="hljs-attr">n</span> =&gt; n * <span class="hljs-number">2</span>)<span class="hljs-comment">;</span>

console.log(result)<span class="hljs-comment">; // [24, 40]</span>
</code></pre>
<h4 data-id="heading-12">Java (使用 Stream)</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 快速初始化 List (Java 9+)</span>
        List&lt;Integer&gt; numbers = List.of(<span class="hljs-number">5</span>, <span class="hljs-number">12</span>, <span class="hljs-number">8</span>, <span class="hljs-number">20</span>); 
        <span class="hljs-comment">// 注意：List.of 创建的是"不可变列表"，不能 add/remove</span>
        
        <span class="hljs-comment">// --- Stream API ---</span>
        List&lt;Integer&gt; result = numbers.stream() <span class="hljs-comment">// 1. 开启流</span>
            .filter(n -&gt; n &gt; <span class="hljs-number">10</span>)                <span class="hljs-comment">// 2. 过滤 (Predicate)</span>
            .map(n -&gt; n * <span class="hljs-number">2</span>)                    <span class="hljs-comment">// 3. 映射 (Function)</span>
            .collect(Collectors.toList());      <span class="hljs-comment">// 4. 收集结果回 List</span>
            
        System.out.println(result); <span class="hljs-comment">// [24, 40]</span>
        
        <span class="hljs-comment">// --- 传统遍历 (Enhanced For-Loop) ---</span>
        <span class="hljs-comment">// 类似 JS 的 for (const n of numbers)</span>
        <span class="hljs-keyword">for</span> (Integer n : numbers) {
            System.out.println(n);
        }
    }
}
</code></pre>
<p><strong>🔍 差异点：</strong></p>
<ul>
<li>JS 的数组方法直接作用于数组。Java 必须先调用 <code>.stream()</code> 转换成流，处理完后再 <code>.collect()</code> 回集合。</li>
<li>Java 的 <code>map</code> 必须返回新值，不能像 JS 某些骚操作里那样不返回值只做副作用（虽然 JS 规范也不建议那样做）。</li>
</ul>
<h2 data-id="heading-13">5. 字典与映射：Map 的花式操作</h2>
<p>Map 在后端开发中无处不在，尤其是在处理 JSON 数据时。</p>
<h3 data-id="heading-14">场景：初始化与遍历</h3>
<h4 data-id="heading-15">JavaScript</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> map = {
    <span class="hljs-string">"key1"</span>: <span class="hljs-string">"value1"</span>,
    <span class="hljs-string">"key2"</span>: <span class="hljs-string">"value2"</span>
};

<span class="hljs-comment">// 遍历</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(map).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[k, v]</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(k, v);
});
</code></pre>
<h4 data-id="heading-16">Java</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">HashMap</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Map</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapDeepDive</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">// --- 1. 快速初始化 (Java 9+) ---</span>
        <span class="hljs-comment">// 创建不可变 Map，最多支持 10 对</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; quickMap = <span class="hljs-title class_">Map</span>.<span class="hljs-title function_">of</span>(
            <span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>,
            <span class="hljs-string">"key2"</span>, <span class="hljs-string">"value2"</span>
        );
        
        <span class="hljs-comment">// 常规可变 Map</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        map.<span class="hljs-title function_">put</span>(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);
        
        <span class="hljs-comment">// --- 2. 遍历 ---</span>
        <span class="hljs-comment">// 方式 A: forEach + Lambda (最像 JS)</span>
        map.<span class="hljs-title function_">forEach</span>((k, v) -&gt; {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"Key: "</span> + k + <span class="hljs-string">", Val: "</span> + v);
        });
        
        <span class="hljs-comment">// 方式 B: entrySet (性能好，传统方式)</span>
        <span class="hljs-comment">// Map.Entry 相当于 JS 的 [key, value] 元组</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">Map</span>.<span class="hljs-property">Entry</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; entry : map.<span class="hljs-title function_">entrySet</span>()) {
            <span class="hljs-title class_">String</span> k = entry.<span class="hljs-title function_">getKey</span>();
            <span class="hljs-title class_">String</span> v = entry.<span class="hljs-title function_">getValue</span>();
        }
    }
}
</code></pre>
<h2 data-id="heading-17">6. 常见痛点对照表 (Cheatsheet)</h2>


















































<table><thead><tr><th>场景</th><th>JavaScript</th><th>Java (最佳实践)</th></tr></thead><tbody><tr><td><strong>定义不可变常量</strong></td><td><code>const API_URL = "..."</code></td><td><code>static final String API_URL = "...";</code></td></tr><tr><td><strong>模板字符串</strong></td><td><code>`Hello ${name}`</code></td><td><code>String.format("Hello %s", name)</code> 或 <code>"Hello " + name</code></td></tr><tr><td><strong>数组包含</strong></td><td><code>arr.includes(x)</code></td><td><code>list.contains(x)</code></td></tr><tr><td><strong>数组判空</strong></td><td><code>arr.length === 0</code></td><td><code>list.isEmpty()</code></td></tr><tr><td><strong>对象取值防崩</strong></td><td><code>obj?.prop</code></td><td><code>Optional.ofNullable(obj).map(...)</code> (较复杂) 或简单判空 <code>if (obj != null)</code></td></tr><tr><td><strong>JSON 解析</strong></td><td><code>JSON.parse(str)</code></td><td>使用库：Jackson (<code>objectMapper.readValue(...)</code>)</td></tr><tr><td><strong>JSON 序列化</strong></td><td><code>JSON.stringify(obj)</code></td><td>使用库：Jackson (<code>objectMapper.writeValueAsString(...)</code>)</td></tr><tr><td><strong>比较对象</strong></td><td><code>a === b</code> (通常不行)</td><td><code>a.equals(b)</code> (必须重写 equals 方法)</td></tr></tbody></table>
<h3 data-id="heading-18">核心建议</h3>
<ol>
<li><strong>善用 IDE</strong>：IntelliJ IDEA 是 Java 开发的神器。当你不知道方法名时，输入 <code>.</code> 然后停顿，它会列出所有可用方法，这比查文档快得多。</li>
<li><strong>拥抱类型</strong>：不要为了省事全部用 <code>Object</code> 或 <code>Map&lt;String, Object&gt;</code> 模拟 JS 对象。定义一个明确的 <code>User</code> 类（Class）虽然前期麻烦，但在后期维护和重构时，它的优势会碾压动态类型。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么 SVG 能在现代前端中胜出？]]></title>    <link>https://juejin.cn/post/7577691061034172462</link>    <guid>https://juejin.cn/post/7577691061034172462</guid>    <pubDate>2025-11-30T08:14:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061034172462" data-draft-id="7577970969395183657" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么 SVG 能在现代前端中胜出？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T08:14:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吹水一流"/> <meta itemprop="url" content="https://juejin.cn/user/993614244613543"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么 SVG 能在现代前端中胜出？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614244613543/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吹水一流
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T08:14:41.000Z" title="Sun Nov 30 2025 08:14:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你关注前端图标的发展，会发现一个现象：</p>
<p>过去前端图标主要有三种方案：</p>
<ul>
<li>
<p>PNG 小图（配合雪碧图）</p>
</li>
<li>
<p>Iconfont</p>
</li>
<li>
<p>SVG</p>
</li>
</ul>
<p>到了今天，大部分中大型项目都把图标系统全面迁移到 SVG。<br/>
无论 React/Vue 项目、新框架（Next/Remix/Nuxt），还是大厂的设计规范（Ant Design、Material、Carbon），基本都默认 SVG。</p>
<p>为什么是 SVG 胜出？<br/>
为什么不是 Iconfont、不是独立 PNG、不是雪碧图？<br/>
答案不是一句“清晰不失真”这么简单。</p>
<p>下面从前端实际开发的角度，把 SVG 胜出的原因讲透。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、SVG 为什么比位图（PNG/JPG）更强？</strong></h2>
<h3 data-id="heading-1">① <strong>矢量图永不失真（核心优势）</strong></h3>
<p>PNG/JPG 是位图，只能按像素存图。<br/>
移动端倍率屏越来越高（2x、3x、4x……），一张 24px 的 PNG 在 iPhone 高分屏里可能看起来糊成一团。</p>
<p>SVG 是矢量图，数学计算绘制：</p>
<ul>
<li>
<p>任意缩放不糊</p>
</li>
<li>
<p>任意清晰度场景都不怕</p>
</li>
<li>
<p>深色模式也不会变形</p>
</li>
</ul>
<p>这点直接解决了前端图标领域长期存在的一个痛点：<strong>适配成本太高</strong>。</p>
<hr/>
<h3 data-id="heading-2">② <strong>体积小、多级复用不浪费</strong></h3>
<p>同样一个图标：</p>
<ul>
<li>
<p>PNG 做 1x/2x/3x 需要三份资源</p>
</li>
<li>
<p>SVG 只要一份</p>
</li>
</ul>
<p>而且：</p>
<ul>
<li>
<p>SVG 本质是文本</p>
</li>
<li>
<p>gzip 压缩非常有效</p>
</li>
</ul>
<p>在 CDN 下，通常能压到个位数 KB，轻松复用。</p>
<hr/>
<h3 data-id="heading-3">③ <strong>图标换色非常容易</strong></h3>
<p>PNG 改颜色很麻烦：</p>
<ul>
<li>
<p>设计师改</p>
</li>
<li>
<p>重新导出</p>
</li>
<li>
<p>重新上传/构建</p>
</li>
</ul>
<p>Iconfont 的颜色只能统一，只能覆盖轮廓颜色，多色很麻烦。</p>
<p>SVG 则非常灵活：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.icon</span> {
  fill: currentColor;
}
</code></pre>
<p>可以跟随字体颜色变化，支持 hover、active、主题色。</p>
<p><strong>深浅模式切换不需要任何额外资源。</strong></p>
<hr/>
<h3 data-id="heading-4">④ <strong>支持 CSS 动画、交互效果</strong></h3>
<p>SVG 不只是图标文件，它是 DOM，可以直接加动画：</p>
<ul>
<li>
<p>stroke 动画</p>
</li>
<li>
<p>路径绘制动画</p>
</li>
<li>
<p>颜色渐变</p>
</li>
<li>
<p>hover 发光</p>
</li>
<li>
<p>多段路径动态控制</p>
</li>
</ul>
<p>PNG 和 Iconfont 都做不到这种级别的交互。</p>
<p>很多现代 UI 的微动效（Loading、赞、收藏），都是基于 SVG 完成。</p>
<hr/>
<h2 data-id="heading-5"><strong>二、SVG 为什么比 iconfont 更强？</strong></h2>
<p>Iconfont 在 2015~2019 年非常火，但明显已经退潮了。<br/>
原因有以下几个：</p>
<hr/>
<h3 data-id="heading-6">① 字体图标本质是“字符”而不是图形</h3>
<p>这带来大量问题：</p>
<h4 data-id="heading-7">● 不能多色</h4>
<p>只能 monochrome，彩色图标很难实现。</p>
<h4 data-id="heading-8">● 渲染脆弱</h4>
<p>在 Windows 某些字体渲染环境下会出现：</p>
<ul>
<li>
<p>发虚</p>
</li>
<li>
<p>锯齿</p>
</li>
<li>
<p>baseline 不一致</p>
</li>
</ul>
<h4 data-id="heading-9">● 字符冲突</h4>
<p>不同项目的字体图标可能互相覆盖。</p>
<p>相比之下，SVG 是独立图形文件，没有这些问题。</p>
<hr/>
<h3 data-id="heading-10">② iconfont 需要加载字体文件，失败会出现“乱码方块”</h3>
<p>如果字体文件没加载成功，你会看到：</p>
<blockquote>
<p>☐ ☐ ☐ ☐</p>
</blockquote>
<p>这在弱网、支付类页面、海外环境都非常常见。</p>
<p>SVG 就没有这个风险。</p>
<hr/>
<h3 data-id="heading-11">③ iconfont 不利于按需加载</h3>
<p>字体文件通常包含几十甚至几百个图标：<br/>
<strong>一次加载很重，不够精细。</strong></p>
<p>SVG 可以做到按需加载：</p>
<ul>
<li>
<p>一个组件一个 SVG</p>
</li>
<li>
<p>一个页面只引入用到的部分</p>
</li>
<li>
<p>可组合、可动态切换</p>
</li>
</ul>
<p>对于现代构建体系非常友好。</p>
<hr/>
<h2 data-id="heading-12"><strong>三、SVG 为什么比“新版雪碧图”更强？</strong></h2>
<p>即便抛开 iconfont，PNG 雪碧图也完全被淘汰。</p>
<p>原因很简单：</p>
<ul>
<li>
<p>雪碧图文件大</p>
</li>
<li>
<p>缓存粒度差</p>
</li>
<li>
<p>不可按需加载</p>
</li>
<li>
<p>维护复杂</p>
</li>
<li>
<p>retina 适配麻烦</p>
</li>
<li>
<p>颜色不可动态变更</p>
</li>
</ul>
<p>而 SVG 天生具备现代开发所需的一切特性：</p>
<ul>
<li>
<p>轻量化</p>
</li>
<li>
<p>组件化</p>
</li>
<li>
<p>可变色</p>
</li>
<li>
<p>可动画</p>
</li>
<li>
<p>可 inline</p>
</li>
<li>
<p>可自动 tree-shaking</p>
</li>
</ul>
<p>雪碧图本质上是为了“减少请求数”而生的产物，<br/>
但在 HTTP/2/3 中已经没有价值。</p>
<p>而 SVG 不是 hack，而是<strong>自然适配现代 Web 的技术方案</strong>。</p>
<hr/>
<h2 data-id="heading-13"><strong>四、SVG 为什么能在工程体系里更好地落地？</strong></h2>
<p>现代构建工具（Vite / Webpack / Rollup）原生支持 SVG：</p>
<ul>
<li>
<p>转组件</p>
</li>
<li>
<p>优化路径</p>
</li>
<li>
<p>压缩</p>
</li>
<li>
<p>自动雪碧（symbol sprite）</p>
</li>
<li>
<p>Tree-shaking</p>
</li>
<li>
<p>资源分包</p>
</li>
</ul>
<p>这让 SVG 完全融入工程体系，而不是外挂方案。</p>
<p>例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Logo</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./logo.svg'</span>
</code></pre>
<p>你可以：</p>
<ul>
<li>
<p>当组件使用</p>
</li>
<li>
<p>当资源下载</p>
</li>
<li>
<p>当背景图</p>
</li>
<li>
<p>动态注入</p>
</li>
</ul>
<p>工程化友好度是它胜出的关键原因之一。</p>
<hr/>
<h2 data-id="heading-14"><strong>五、SVG 胜出的根本原因总结</strong></h2>
<p>不是 SVG “长得好看”，也不是趋势，是整个现代前端生态把它推到了最合适的位置。</p>
<p><strong>1）协议升级：HTTP/2/3 让雪碧图和 Iconfont 的优势全部消失</strong><br/>
<strong>2）设备升级：高分屏让位图模糊问题暴露得更明显</strong><br/>
<strong>3）工程升级：组件化开发需要精细化图标</strong><br/>
<strong>4）体验升级：动画、主题、交互都离不开 SVG</strong></p>
<p>一句话总结：</p>
<blockquote>
<p><strong>SVG 不只是“更清晰”，而是从工程到体验全面适配现代前端的图标方案，因此胜出。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react-native-promise-portal：React Native 弹窗管理的新思路]]></title>    <link>https://juejin.cn/post/7577958825342156819</link>    <guid>https://juejin.cn/post/7577958825342156819</guid>    <pubDate>2025-11-30T08:44:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577958825342156819" data-draft-id="7577797563853996068" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react-native-promise-portal：React Native 弹窗管理的新思路"/> <meta itemprop="keywords" content="React Native"/> <meta itemprop="datePublished" content="2025-11-30T08:44:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="soul96816"/> <meta itemprop="url" content="https://juejin.cn/user/3843548383556791"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react-native-promise-portal：React Native 弹窗管理的新思路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548383556791/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    soul96816
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T08:44:04.000Z" title="Sun Nov 30 2025 08:44:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><div align="center">
     <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1627a19c8844130811ea1f9d3cad995~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc291bDk2ODE2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765097044&amp;x-signature=yRVe9TtVll2KpfNX7PNJ6GbbEsM%3D" width="160" alt="owjymdk6/f1627a1" loading="lazy"/>
  <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fe85d4ec5c743579cabaca9c358bd38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc291bDk2ODE2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765097044&amp;x-signature=fBE1sdPpvNwpuOpHVNIqoT%2BZL%2BU%3D" width="160" alt="owjymdk6/f1627a1" loading="lazy"/>
    <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a6aee26fc4e4710b5bbfb41dad6da7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc291bDk2ODE2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765097044&amp;x-signature=MhZwQpDBl6iYahFvL5qu2LIPz5Y%3D" width="160" alt="owjymdk6/f1627a1" loading="lazy"/>
    <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88776a87956e4e2ba5114496aa36ab2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc291bDk2ODE2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765097044&amp;x-signature=vpuOos1XeSAcsf7dSWgjGpBt3cM%3D" width="160" alt="owjymdk6/f1627a1" loading="lazy"/>
</div>
<hr/>
<p>在 React Native 开发中，我们经常需要弹出对话框、提示框、日期选择器或者其他 overlay 组件。传统方式通常依赖 state + conditional rendering + 回调函数，但在复杂场景下，代码会变得分散、难维护，尤其是当多个弹窗同时存在时。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJinYuSha0%2Freact-native-promise-portal" target="_blank" title="https://github.com/JinYuSha0/react-native-promise-portal" ref="nofollow noopener noreferrer">react-native-promise-portal</a> 提供了一种 <strong>Promise + Portal</strong> 的解决方案，让你可以像调用普通异步函数一样调用弹窗，同时保持逻辑线性、易于管理。</p>
<h2 data-id="heading-0">核心特点</h2>
<ol>
<li>
<p><strong>Promise-first 弹窗调用</strong><br/>
弹窗调用返回 Promise，你可以用 <code>await</code> 直接获取用户操作结果。业务逻辑与 UI 逻辑解耦，写出来的代码更直观。</p>
</li>
<li>
<p><strong>支持多重弹窗 &amp; name 去重</strong></p>
<ul>
<li>可以在同一页面同时显示多个弹窗，每个弹窗独立关闭。</li>
<li>通过 <code>index</code> 控制渲染层级，index 越大，显示在最上层。</li>
<li>通过 <code>name</code> 去重，避免重复弹窗触发业务冲突。</li>
</ul>
</li>
<li>
<p><strong>局部 Portal</strong></p>
<ul>
<li>支持在特定页面或模块内管理弹窗，不影响全局 Portal 状态。</li>
<li>跨组件调用弹窗，保证弹窗只在目标页面显示。</li>
<li>避免不同页面弹窗相互覆盖或冲突，提升模块化管理能力。</li>
</ul>
</li>
<li>
<p><strong>脱离 Hook 调用局部 UI</strong></p>
<ul>
<li>使用 <code>PortalManager</code> 可以在 <strong>非组件上下文</strong> 触发局部弹窗。</li>
<li>适用于后台逻辑、网络请求回调、定时任务等场景。</li>
<li>Promise 接口仍然保持逻辑线性。</li>
</ul>
</li>
<li>
<p><strong>基于 Portal 渲染</strong></p>
<ul>
<li>利用 React Native 的 Portal 技术，将弹窗渲染到顶层，解决 z-index 和 clipping 问题。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-1">基本使用</h2>
<h3 data-id="heading-2">1. 设置 PortalProvider</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PortalProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-promise-portal'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">PortalProvider</span>&gt;</span>{/* Your app content */}<span class="hljs-tag">&lt;/<span class="hljs-name">PortalProvider</span>&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-3">2. 使用 Hook 调用弹窗</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { usePortal } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-promise-portal'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { showWithOverlay } = <span class="hljs-title function_">usePortal</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleShowDialog</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> showWithOverlay&lt;<span class="hljs-built_in">boolean</span>&gt;({
        <span class="hljs-attr">component</span>: <span class="hljs-function">(<span class="hljs-params">{ close }</span>) =&gt;</span> (
          <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Confirm</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"Confirm"</span> <span class="hljs-attr">subTitle</span>=<span class="hljs-string">"Are you sure?"</span> <span class="hljs-attr">close</span>=<span class="hljs-string">{close}</span> /&gt;</span></span>
        ),
      });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Result:'</span>, result);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    }
  };

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handleShowDialog}</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"Show Dialog"</span> /&gt;</span></span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-4">多重弹窗与 name 去重示例</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { showWithOverlay } = <span class="hljs-title function_">usePortal</span>();

<span class="hljs-comment">// 弹出第一个弹窗</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">showWithOverlay</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'confirm-delete'</span>,
  <span class="hljs-attr">component</span>: <span class="hljs-function">(<span class="hljs-params">{ close }</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Confirm</span> <span class="hljs-attr">close</span>=<span class="hljs-string">{close}</span> /&gt;</span></span>,
});

<span class="hljs-comment">// 再次调用同名弹窗会抛出 PortalAlreadyExistsError</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">showWithOverlay</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'confirm-delete'</span>,
  <span class="hljs-attr">component</span>: <span class="hljs-function">(<span class="hljs-params">{ close }</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Confirm</span> <span class="hljs-attr">close</span>=<span class="hljs-string">{close}</span> /&gt;</span></span>,
});
</code></pre>
<p>通过 <code>index</code> 可以控制层级顺序：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> promise1 = <span class="hljs-title function_">showWithOverlay</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'Dialog 1'</span>, <span class="hljs-attr">index</span>: <span class="hljs-number">1</span> });
<span class="hljs-keyword">const</span> promise2 = <span class="hljs-title function_">showWithOverlay</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'Dialog 2'</span>, <span class="hljs-attr">index</span>: <span class="hljs-number">10</span> }); <span class="hljs-comment">// 更高层级</span>
<span class="hljs-keyword">const</span> promise3 = <span class="hljs-title function_">showWithOverlay</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'Dialog 3'</span>, <span class="hljs-attr">index</span>: <span class="hljs-number">5</span> });

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>([promise1, promise2, promise3]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">results</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'All dialogs closed:'</span>, results);
});
</code></pre>
<hr/>
<h2 data-id="heading-5">局部 Portal 解决的业务痛点</h2>
<p>在大型应用中，某些弹窗只在特定页面显示，使用全局 Portal 管理容易导致以下问题：</p>
<ul>
<li>弹窗状态全局混乱</li>
<li>不同页面弹窗可能相互覆盖</li>
<li>逻辑与 UI 耦合，调用分散</li>
</ul>
<p>局部 Portal 通过 <code>PortalManager</code> 提供页面级管理：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PortalRender</span>, <span class="hljs-title class_">PortalManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-promise-portal'</span>;
<span class="hljs-keyword">import</span> { useLocalPortals } <span class="hljs-keyword">from</span> <span class="hljs-string">'./helper/LocalPortal'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">HomePage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> homePortalContent = <span class="hljs-title function_">useLocalPortals</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">homePortalContent</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleShowLocalPortal</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">HomePagePortalManager</span>.<span class="hljs-property">showWithOverlay</span>&lt;<span class="hljs-built_in">boolean</span>&gt;({
      <span class="hljs-attr">component</span>: <span class="hljs-function">(<span class="hljs-params">{ close }</span>) =&gt;</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Confirm</span>
          <span class="hljs-attr">title</span>=<span class="hljs-string">"Local portal"</span>
          <span class="hljs-attr">subTitle</span>=<span class="hljs-string">"Only on home page"</span>
          <span class="hljs-attr">close</span>=<span class="hljs-string">{close}</span>
        /&gt;</span></span>
      ),
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handleShowLocalPortal}</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"Show Local Portal"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">PortalRender</span> <span class="hljs-attr">portals</span>=<span class="hljs-string">{homePortalContent}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p><strong>局部 Portal 优势：</strong></p>
<ol>
<li>弹窗只影响特定页面或模块</li>
<li>跨组件 / 跨 Hook 调用更灵活</li>
<li>避免全局冲突，提高模块化和可维护性</li>
</ol>
<hr/>
<h2 data-id="heading-6">脱离 Hook 调用局部 UI</h2>
<p>有些业务场景中，你可能希望在 <strong>非 React 组件上下文</strong> 或 <strong>Hook 不方便使用的地方</strong> 调用弹窗，例如网络请求回调或定时任务。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HomePagePortalManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./helper/LocalPortal'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAsyncEvent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">HomePagePortalManager</span>.<span class="hljs-property">showWithOverlay</span>&lt;<span class="hljs-built_in">boolean</span>&gt;({
      <span class="hljs-attr">component</span>: <span class="hljs-function">(<span class="hljs-params">{ close }</span>) =&gt;</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Confirm</span>
          <span class="hljs-attr">title</span>=<span class="hljs-string">"Async Event"</span>
          <span class="hljs-attr">subTitle</span>=<span class="hljs-string">"This dialog is triggered outside React component"</span>
          <span class="hljs-attr">close</span>=<span class="hljs-string">{close}</span>
        /&gt;</span></span>
      ),
      <span class="hljs-attr">overlay</span>: { <span class="hljs-attr">orientation</span>: <span class="hljs-string">'centerMiddle'</span> },
    });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'User result:'</span>, result);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Portal closed or error:'</span>, err);
  }
}
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>脱离组件 / Hook，任意业务逻辑可触发</li>
<li>弹窗仅显示在目标页面或模块</li>
<li>Promise 接口保持逻辑线性</li>
</ul>
<hr/>
<h2 data-id="heading-7">更多示例</h2>
<h3 data-id="heading-8">Loading 指示器</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { showWithOverlay } = <span class="hljs-title function_">usePortal</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">showLoading</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> { close } = showWithOverlay&lt;<span class="hljs-built_in">void</span>&gt;({
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ActivityIndicator</span> /&gt;</span></span>,
    <span class="hljs-attr">overlay</span>: { <span class="hljs-attr">closeable</span>: <span class="hljs-literal">false</span> },
  });

  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">close</span>(), <span class="hljs-number">3000</span>);
};
</code></pre>
<h3 data-id="heading-9">日期选择器（底部弹出）</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> date = <span class="hljs-keyword">await</span> showWithOverlay&lt;<span class="hljs-built_in">string</span>&gt;({
  <span class="hljs-attr">component</span>: <span class="hljs-function">(<span class="hljs-params">{ close }</span>) =&gt;</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">DatePicker</span>
      <span class="hljs-attr">onSelect</span>=<span class="hljs-string">{(date)</span> =&gt;</span> close(date)}
      onCancel={() =&gt; close(new Error('Cancelled'))}
    /&gt;</span>
  ),
  <span class="hljs-attr">overlay</span>: { <span class="hljs-attr">orientation</span>: <span class="hljs-string">'centerBottom'</span> },
});
</code></pre>
<hr/>
<h2 data-id="heading-10">错误处理</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PortalError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-promise-portal'</span>;

<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> showWithOverlay&lt;<span class="hljs-built_in">boolean</span>&gt;({
    <span class="hljs-attr">component</span>: <span class="hljs-function">(<span class="hljs-params">{ close }</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Confirm</span> <span class="hljs-attr">close</span>=<span class="hljs-string">{close}</span> /&gt;</span></span>,
  });
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">PortalError</span>) {
    <span class="hljs-keyword">if</span> (error.<span class="hljs-title function_">isCloseByOverlayPressError</span>()) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Closed by overlay'</span>);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-title function_">isCloseByHardwareBackPressError</span>()) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Closed by back button'</span>);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-title function_">isPortalAlreadyExistsError</span>()) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Portal already exists'</span>);
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-11">总结</h2>
<p><code>react-native-promise-portal</code> 将弹窗调用封装为异步函数，支持：</p>
<ul>
<li>多重弹窗</li>
<li>name 去重机制</li>
<li>局部 Portal</li>
<li>脱离 Hook 调用局部 UI</li>
<li>Promise 异步接口</li>
</ul>
<p>它极大简化了 React Native 弹窗管理，保证 UI 与业务逻辑解耦，调用方式直观、可维护，是复杂页面交互场景下的理想选择。</p>
<hr/>
<h2 data-id="heading-12">安装</h2>
<pre><code class="hljs language-arduino" lang="arduino">npm install react-native-promise-portal
</code></pre>
<hr/>
<p>如果你喜欢这个库，欢迎点个 ⭐️ 支持一下！</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJinYuSha0%2Freact-native-promise-portal%2Fstargazers" target="_blank" title="https://github.com/JinYuSha0/react-native-promise-portal/stargazers" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d69498d456a4273919a79c34959e357~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc291bDk2ODE2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765097044&amp;x-signature=5c7c17HyEztTtyBjuTyiOhLowt8%3D" alt="GitHub stars" loading="lazy"/></a></p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ts类型工具]]></title>    <link>https://juejin.cn/post/7577691061034188846</link>    <guid>https://juejin.cn/post/7577691061034188846</guid>    <pubDate>2025-11-30T08:54:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061034188846" data-draft-id="7577705544875917350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ts类型工具"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2025-11-30T08:54:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Robet"/> <meta itemprop="url" content="https://juejin.cn/user/193141028175320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ts类型工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/193141028175320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Robet
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T08:54:47.000Z" title="Sun Nov 30 2025 08:54:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>TypeScript 提供了一套强大的<strong>内置工具类型（Utility Types）</strong>，用于从已有类型中派生出新类型，从而提升代码的健壮性、可维护性和开发效率。这些工具类型就像“类型世界的高阶函数”，能对类型进行组合、裁剪、转换等操作。</p>
<hr/>
<h3 data-id="heading-0">🧰 常用 TypeScript 工具类型速查表</h3>
















































































<table><thead><tr><th>分类</th><th>工具类型</th><th>作用</th></tr></thead><tbody><tr><td><strong>基础修饰</strong></td><td><code>Partial&lt;T&gt;</code></td><td>将 <code>T</code> 的所有属性变为<strong>可选</strong></td></tr><tr><td/><td><code>Required&lt;T&gt;</code></td><td>将 <code>T</code> 的所有属性变为<strong>必填</strong>（移除 <code>?</code>）</td></tr><tr><td/><td><code>Readonly&lt;T&gt;</code></td><td>将 <code>T</code> 的所有属性变为<strong>只读</strong></td></tr><tr><td><strong>结构挑选</strong></td><td><code>Pick&lt;T, K&gt;</code></td><td>从 <code>T</code> 中<strong>选取</strong>指定键 <code>K</code> 的属性</td></tr><tr><td/><td><code>Omit&lt;T, K&gt;</code></td><td>从 <code>T</code> 中<strong>剔除</strong>指定键 <code>K</code> 的属性</td></tr><tr><td/><td><code>Record&lt;K, T&gt;</code></td><td>构造一个键为 <code>K</code>、值为 <code>T</code> 的对象类型</td></tr><tr><td><strong>类型过滤</strong></td><td><code>Exclude&lt;T, U&gt;</code></td><td>从联合类型 <code>T</code> 中<strong>排除</strong>可赋值给 <code>U</code> 的类型</td></tr><tr><td/><td><code>Extract&lt;T, U&gt;</code></td><td>从联合类型 <code>T</code> 中<strong>提取</strong>可赋值给 <code>U</code> 的类型</td></tr><tr><td/><td><code>NonNullable&lt;T&gt;</code></td><td>从 <code>T</code> 中移除 <code>null</code> 和 <code>undefined</code></td></tr><tr><td><strong>函数相关</strong></td><td><code>ReturnType&lt;T&gt;</code></td><td>获取函数 <code>T</code> 的<strong>返回值类型</strong></td></tr><tr><td/><td><code>Parameters&lt;T&gt;</code></td><td>获取函数 <code>T</code> 的<strong>参数类型元组</strong></td></tr><tr><td/><td><code>ConstructorParameters&lt;T&gt;</code></td><td>获取构造函数的<strong>参数类型</strong></td></tr><tr><td/><td><code>InstanceType&lt;T&gt;</code></td><td>获取构造函数的<strong>实例类型</strong></td></tr><tr><td/><td><code>ThisParameterType&lt;T&gt;</code> / <code>OmitThisParameter&lt;T&gt;</code></td><td>处理函数中的 <code>this</code> 参数</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-1">🔍 典型示例与应用场景</h3>
<h4 data-id="heading-2">1. <code>Partial&lt;T&gt;</code>：局部更新</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 所有字段变为可选</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UpdateUser</span> = <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">User</span>&gt;;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateUser</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, changes: UpdateUser</span>) {
  <span class="hljs-comment">// 只需传入要修改的字段</span>
}
<span class="hljs-title function_">updateUser</span>(<span class="hljs-number">1</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> }); <span class="hljs-comment">// ✅</span>
</code></pre>
<h4 data-id="heading-3">2. <code>Pick&lt;T, K&gt;</code> / <code>Omit&lt;T, K&gt;</code>：按需选择或排除字段</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">UserPreview</span> = <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">User</span>, <span class="hljs-string">'id'</span> | <span class="hljs-string">'name'</span>&gt;; <span class="hljs-comment">// { id: number; name: string }</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserWithoutId</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">User</span>, <span class="hljs-string">'id'</span>&gt;;        <span class="hljs-comment">// { name: string; email: string }</span>
</code></pre>
<h4 data-id="heading-4">3. <code>Record&lt;K, T&gt;</code>：构建配置对象</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Theme</span> = <span class="hljs-string">'light'</span> | <span class="hljs-string">'dark'</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ColorMap</span> = <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">Theme</span>, <span class="hljs-built_in">string</span>&gt;; <span class="hljs-comment">// { light: string; dark: string }</span>
</code></pre>
<h4 data-id="heading-5">4. <code>ReturnType&lt;T&gt;</code>：推导函数返回类型</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span> };
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> fetchUser&gt;; <span class="hljs-comment">// { id: number; name: string }</span>
</code></pre>
<h4 data-id="heading-6">5. <code>Exclude&lt;T, U&gt;</code> / <code>Extract&lt;T, U&gt;</code></h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Status</span> = <span class="hljs-string">'loading'</span> | <span class="hljs-string">'success'</span> | <span class="hljs-string">'error'</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ValidStatus</span> = <span class="hljs-title class_">Exclude</span>&lt;<span class="hljs-title class_">Status</span>, <span class="hljs-string">'loading'</span>&gt;; <span class="hljs-comment">// 'success' | 'error'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">LoadingOnly</span> = <span class="hljs-title class_">Extract</span>&lt;<span class="hljs-title class_">Status</span>, <span class="hljs-string">'loading'</span>&gt;; <span class="hljs-comment">// 'loading'</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">💡 小贴士</h3>
<ul>
<li>这些工具类型基于 <strong>映射类型（Mapped Types）</strong>、<strong>条件类型（Conditional Types）</strong> 和 <strong><code>infer</code></strong> 等高级特性实现。</li>
<li>它们是<strong>不可变的</strong>：不会修改原始类型，而是生成一个新类型。</li>
<li>可<strong>组合使用</strong>，例如：
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">SafeUser</span> = <span class="hljs-title class_">Readonly</span>&lt;<span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">User</span>&gt;&gt;;
</code></pre>
</li>
</ul>
<hr/>
<p>如需深入某个工具类型的源码实现或更多实战案例，可以告诉我具体类型（如 <code>Omit</code> 或 <code>ReturnType</code>），我可以进一步详解！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[FileProvider 授权方式不当的风险与防护设计]]></title>    <link>https://juejin.cn/post/7577675494068142106</link>    <guid>https://juejin.cn/post/7577675494068142106</guid>    <pubDate>2025-11-30T00:35:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577675494068142106" data-draft-id="7577693903018573850" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FileProvider 授权方式不当的风险与防护设计"/> <meta itemprop="keywords" content="安全"/> <meta itemprop="datePublished" content="2025-11-30T00:35:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鱼跃新知"/> <meta itemprop="url" content="https://juejin.cn/user/2754692828113043"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FileProvider 授权方式不当的风险与防护设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2754692828113043/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鱼跃新知
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T00:35:35.000Z" title="Sun Nov 30 2025 00:35:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在<a href="https://juejin.cn/post/7575442779038892074" target="_blank" title="https://juejin.cn/post/7575442779038892074">《 Android 文件共享安全指南：为何不能使用 file://》</a>中我们提到：应用间共享文件时，应优先使用 ContentProvider（如 FileProvider）实现受控访问，以提升安全性。但如果在授权过程中处置不当，仍可能引发敏感数据泄露等安全风险。</p>
<p>本文将结合典型业务场景、授权流程、风险模型与最佳实践，系统性解释 FileProvider 授权的安全要点。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、典型业务场景</strong></h2>
<p>应用 A 通过 FileProvider 向应用 B 分享日志文件：</p>
<p><strong>Manifest 配置：</strong> </p>
<pre><code class="hljs language-ini" lang="ini">&lt;meta-data
    android:<span class="hljs-attr">name</span>=<span class="hljs-string">"android.support.FILE_PROVIDER_PATHS"</span>
    android:<span class="hljs-attr">resource</span>=<span class="hljs-string">"@xml/file_paths"</span> /&gt;
</code></pre>

<p><strong>代码授权：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shareLogFile</span><span class="hljs-params">(File logFile)</span> {
    <span class="hljs-type">Uri</span> <span class="hljs-variable">logUri</span> <span class="hljs-operator">=</span> FileProvider.getUriForFile(
            <span class="hljs-built_in">this</span>,
            <span class="hljs-string">"com.example.myapp.fileprovider"</span>,
            logFile
    );

    <span class="hljs-type">Intent</span> <span class="hljs-variable">shareIntent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_SEND);
    shareIntent.setType(<span class="hljs-string">"text/plain"</span>);
    shareIntent.putExtra(Intent.EXTRA_STREAM, logUri);

    <span class="hljs-comment">// 关键：授予对方临时读取权限</span>
    shareIntent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);

    startActivity(Intent.createChooser(shareIntent, <span class="hljs-string">"分享日志文件"</span>));
}
</code></pre>
<p>授权行为主要通过以下两种方式触发。</p>
<h2 data-id="heading-1"><strong>二、两类授予权限方式</strong></h2>
<h3 data-id="heading-2"><strong>1.通过 Intent Flag 授权（常用）</strong></h3>
<ul>
<li>授权对象：<strong>目标组件（单个 Activity/Service）</strong>****</li>
<li>权限生效：<strong>启动目标组件时瞬间授予</strong>****</li>
</ul>
<h3 data-id="heading-3"><strong>2.使用 grantUriPermission() 主动授权</strong></h3>
<ul>
<li>授权对象：<strong>目标包（整个 App）</strong>****</li>
<li>权限生效：调用后立即生效</li>
</ul>
<blockquote>
<p>差异点：Intent 授权仅对单个组件生效，而 grantUriPermission() 会让整个 App 获取权限，风险更高</p>
</blockquote>
<p>以下是对两种授权方式及标志位的具体说明：</p>









































<table><thead><tr><th>标志位 / 方法</th><th>示例代码</th><th>授权含义</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>FLAG_GRANT_READ_URI_PERMISSION</strong></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/135eef53b66745e5b1dc579a28099f60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=pZ5gZF2M1fxM4cVxQinwCB63KnM%3D" alt="image.png" loading="lazy"/></td><td>- 授予目标组件一次性 <strong>读权限</strong><br/>- 权限与对方 Activity 生命周期绑定<br/>- 仅允许读取 <strong>该 URI 指向的单个文件</strong>，不能访问目录或其他文件</td><td>一次性分享图片、文件、日志等「只读」内容</td></tr><tr><td><strong>FLAG_GRANT_WRITE_URI_PERMISSION</strong></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b16d1225fed2434c941497af9cf6b1f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=ltd4%2BatzDGWxmomSb4gk%2BoXsskQ%3D" alt="image.png" loading="lazy"/></td><td>- 授予目标组件一次性 <strong>写权限</strong>（不自动包含读权限）<br/>- 允许修改 / 删除该 URI 指向的内容</td><td>目标 App 需要对该文件进行一次性编辑、修改或生成输出</td></tr><tr><td><strong>FLAG_GRANT_PREFIX_URI_PERMISSION</strong></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f063b68a01d43f6907efe92b12c78c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=XBsO1U77wH4PurO3e12TEw%2BFoqo%3D" alt="image.png" loading="lazy"/></td><td>- 启用 <strong>目录级别授权</strong>（前缀匹配）<br/>- 对方可访问以该前缀开头的所有子 URI<br/>- 权限范围从单文件扩大到“目录树”，如授权的是content://com.example.demo.files/images，那么-   content://com.example.demo.files/images/123及同目录和下级目录所有内容都可以访问</td><td>明确设计用于“目录级共享”的场景，例如文档管理、下载目录共享；必须严格限制前缀避免越权</td></tr><tr><td><strong>FLAG_GRANT_PERSISTABLE_URI_PERMISSION</strong></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f64a1320e7224f608fee40c4644df761~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=7mGXGWlt60f58CEdNYsoWjWAMvA%3D" alt="image.png" loading="lazy"/></td><td>- 本身并不是“权限”，而是允许当次授权被 <strong>持久化</strong> 的“许可证”<br/>- 需搭配读/写权限使用<br/>- 接收端需调用 <code>takePersistableUriPermission()</code> 才会变为长期授权<br/>- 持久化后权限与 Activity 生命周期脱钩，由系统长期记录</td><td>文档访问、相册选取、文件选取器等长期需要访问某个 URI 的场景</td></tr><tr><td><strong>grantUriPermission() 方法</strong></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/101414b9b46f4b0ea3622c8d10f6b7d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=9%2BjcnU6RsTN%2Fyoxmq8yB5%2FqMsEY%3D" alt="image.png" loading="lazy"/></td><td>- 系统立即将对应 URI 权限授予 <strong>整个包</strong>，无需启动组件<br/>- 支持前缀 / 持久化等所有 flag 组合<br/>- 适合“后台授予”，无需用户交互<br/>- 若希望持久化必须由对方主动调用 <code>takePersistableUriPermission()</code></td><td>对方长期需要访问某文件或配置数据，如导入/导出设置、长期持有的文档、文件型配置等</td></tr></tbody></table>
<h2 data-id="heading-4"><strong>三、风险分析</strong></h2>
<p>上述的标志位或方法设置不当，可能导致超范围、能力、时间的权限共享，存在数据泄露风险，以下分析两种授权模式和授权期限各种组合的风险。</p>


















































<table><thead><tr><th>授权方式</th><th>示例代码</th><th>授权对象</th><th>授权生效时机</th><th>生命周期</th><th>风险</th><th>适用场景</th></tr></thead><tbody><tr><td>intent授权+临时授权标志</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/769f892879724329a2e2374f28326c07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=OPwcyEZCftiGkLcqbD4ecWPSbjI%3D" alt="image.png" loading="lazy"/></td><td>单个组件实例（最小化）</td><td>需要在intent启动对方组件时才生效，不启动则无效</td><td>随接收方组件销毁即撤销</td><td>最低</td><td>临时打开一个图片、文档</td></tr><tr><td>Intent 授权 +持久化授权标志</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/168ad4df64314c66bd0abdcc4d1622e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=CZTtuPFp4cfG0PM8c8vvoqABCgM%3D" alt="image.png" loading="lazy"/></td><td>单次启动的组件，可持久化<br/>真正是否持久化取决于接收端takePersistableUriPermission</td><td>需要在intent启动对方组件时才生效，不启动则无效</td><td>可长期使用，与组件生命周期无关</td><td>中等</td><td>ACTION_OPEN_DOCUMENT <br/>相册/文件长期访问（安卓官方 SAF）</td></tr><tr><td>grantUriPermission+临时授权</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5362e952ba14e429812fb033b2ec496~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=T%2BePJHBXp4aiNoawDdNMNG7hN%2FI%3D" alt="image.png" loading="lazy"/></td><td>整个包（package-level）</td><td>授权立刻生效，无需启动activity，无需用户交互</td><td>随应用运行或系统回收</td><td>中等（授权范围比 Intent 大很多）<br/>权限范围明显更大，需严格限制使用。</td><td>特定合作方、固定目标包</td></tr><tr><td>grantUriPermission +持久化授权</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3242b1b9b884a4a9c6d9d849a0e5003~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=wmx9uZF3H1QlMdWOmEpTngQM4ik%3D" alt="image.png" loading="lazy"/></td><td>整个包（package-level）<br/>真正是否持久化取决于接收端takePersistableUriPermission</td><td>授权立刻生效，无需启动activity，无需用户交互</td><td>随应用运行或系统回收</td><td>最高，等同于“长期向一个 App 开放文件”</td><td>非常罕见，仅用于白名单合作方</td></tr></tbody></table>
<h2 data-id="heading-5">四、错误案例</h2>
<ul>
<li>授权类型超限：只应该允许对方读的，同时给了对方不必要的写权限</li>
<li>授权范围超限：只应该授予对方单个组件权限，却给了对方整个包权限；只应该分享具体文件，但是共享了自己的某前缀所代表的目录；</li>
<li>授权时间超限：只应该授予对方临时权限，却给了对方永久权限</li>
</ul>
<h2 data-id="heading-6">五、正确措施</h2>
<p>整体原则就是：最小必要授权。</p>
<ul>
<li>在类型上：只给对方必须得权限类型</li>
<li>在范围上：首选仅给单个组件授权；仅共享必要的具体文件</li>
<li>在期限上：首选临时权限，实在需要持久化授权的，根据应用实际情况，可以调用revokeUriPermission接口撤销授权，如android官方介绍所说</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9eb88330404042f690e2401d50f06734~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=5g5Oy2TKWB9e2qtEahNUgf0AM10%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">撤销授权的案例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 授权并立即撤销 URI 权限的示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">openEditorWithTempPermission</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-comment">// 1. 要共享给对方 App 的受保护内容 URI</span>
    <span class="hljs-type">Uri</span> <span class="hljs-variable">secureUri</span> <span class="hljs-operator">=</span> Uri.parse(<span class="hljs-string">"content://com.demo.secureprovider/private/doc/42"</span>);

    <span class="hljs-comment">// 2. 构造显式 Intent，指定目标应用和页面</span>
    <span class="hljs-type">Intent</span> <span class="hljs-variable">editIntent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();
    editIntent.setComponent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(
            <span class="hljs-string">"com.demo.doceditor"</span>,                      <span class="hljs-comment">// 目标包名（第三方/自家 App）</span>
            <span class="hljs-string">"com.demo.doceditor.ui.EditDocumentActivity"</span> <span class="hljs-comment">// 目标 Activity 全类名</span>
    ));

    <span class="hljs-comment">// 声明要操作的资源类型</span>
    editIntent.setDataAndType(secureUri, <span class="hljs-string">"application/pdf"</span>);

    <span class="hljs-comment">// 3. 通过 Intent 临时授予对方读写权限，并新开任务栈打开页面</span>
    editIntent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION
            | Intent.FLAG_GRANT_WRITE_URI_PERMISSION
            | Intent.FLAG_ACTIVITY_NEW_TASK);

    <span class="hljs-comment">// 启动目标编辑页面</span>
    context.startActivity(editIntent);

    <span class="hljs-comment">// 4. 及时撤销上面授予 com.demo.doceditor 的 URI 读写权限</span>
    <span class="hljs-comment">//    后续该应用再尝试通过这个 URI 访问时会因为缺乏权限而失败</span>
    context.revokeUriPermission(
            <span class="hljs-string">"com.demo.doceditor"</span>,                      <span class="hljs-comment">// 被授予过权限的目标包名</span>
            secureUri,                                 <span class="hljs-comment">// 同一个 URI</span>
            Intent.FLAG_GRANT_READ_URI_PERMISSION
                    | Intent.FLAG_GRANT_WRITE_URI_PERMISSION
    );
}
</code></pre>
<h3 data-id="heading-8">六、风险排查思路</h3>
<p><strong>什么情况下会有这种风险?以下几个条件同时满足:</strong></p>
<ul>
<li>使用ContentProvider(无论fileProvider还是自定义provider)</li>
<li>暴露给外部访问（exported=true或grantUriPermmision=true）</li>
<li>访问路径最终到达了provider内部敏感逻辑（query/openFile/call等），也就是这个授权行为会最终导致敏感数据泄露或敏感操作</li>
</ul>
<p>所以可以先找到provider的定义处，在manifest中查看它的配置，是否设置grantUriPermissions="true"</p>
<pre><code class="hljs language-ini" lang="ini">&lt;provider android:<span class="hljs-attr">name</span>=<span class="hljs-string">"com.example.demoContentProvider"</span> android:exported=<span class="hljs-string">"true"</span> android:process=<span class="hljs-string">":temp"</span> android:authorities=<span class="hljs-string">"com.example.demo.contentProvider"</span> android:grantUriPermissions=<span class="hljs-string">"true"</span>/&gt;
</code></pre>
<p>如果怀疑存在授权行为，可检索 Provider 的 authorities 值。若应用确实进行了 URI 授权，该字段必然在相关代码中被引用。进一步确认授权的调用位置、数据流向以及处理逻辑，重点检查是否将 URI 分享给其他组件或外部应用，并核实权限授予是否遵循最小必要原则，避免过度授权。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[16.Kotlin 类：类的形态（三）：密封类 (Sealed Class)]]></title>    <link>https://juejin.cn/post/7577702891273846819</link>    <guid>https://juejin.cn/post/7577702891273846819</guid>    <pubDate>2025-11-30T06:08:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273846819" data-draft-id="7577713754563379252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="16.Kotlin 类：类的形态（三）：密封类 (Sealed Class)"/> <meta itemprop="keywords" content="Android,后端,Kotlin"/> <meta itemprop="datePublished" content="2025-11-30T06:08:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android_小雨"/> <meta itemprop="url" content="https://juejin.cn/user/220360279590862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            16.Kotlin 类：类的形态（三）：密封类 (Sealed Class)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/220360279590862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android_小雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:08:10.000Z" title="Sun Nov 30 2025 06:08:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>希望帮你在Kotlin进阶路上少走弯路，在技术上稳步提升。当然，由于个人知识储备有限，笔记中难免存在疏漏或表述不当的地方，也非常欢迎大家提出宝贵意见，一起交流进步。 —— Android_小雨</p>
</blockquote>
<p>整体目录：<a href="https://juejin.cn/spost/7573592952242602036" target="_blank" title="https://juejin.cn/spost/7573592952242602036">Kotlin 进阶不迷路：41 个核心知识点，构建完整知识体系</a></p>
<h2 data-id="heading-0">一、前言</h2>
<p>Kotlin 官方对密封类的完整定义（逐句拆解）</p>
<blockquote>
<p>Sealed classes and interfaces represent restricted class hierarchies that provide more control over inheritance.
All direct subclasses of a sealed class are known at compile time.
No other subclasses may appear outside the module and the file where the sealed class is defined.
Sealed classes are, in fact, enumerated classes with super-powers.</p>
</blockquote>
<p>官方强调的 5 个核心点（记住这 5 条就掌握了密封类本质）：</p>
<ol>
<li>密封类 = 受限的类层次结构（restricted hierarchy）</li>
<li>所有直接子类在<strong>编译期</strong>就完全已知</li>
<li>子类必须定义在<strong>同一个文件</strong>中（Kotlin 1.0-1.4）→ Kotlin 1.5+ 放宽到<strong>同一个模块 + 同一个编译单元</strong></li>
<li>不能在密封类外部再添加子类</li>
<li>密封类是“增强版的枚举类”（enum with superpowers）</li>
</ol>
<p>一句话总结：<strong>密封类就是编译器知道所有可能子类型的类</strong>，专为“有限种状态”而生。</p>
<h3 data-id="heading-1">1.1 密封类的核心定位（限制继承范围、规范有限类型集合）</h3>
<p>在面向对象编程中，我们经常面临一个矛盾：<strong>既想要多态的灵活性，又想要枚举的确定性。</strong>
Kotlin 官方对密封类的定义非常精准：“Sealed classes represent restricted class hierarchies”。
翻译成开发者听得懂的话就是：<strong>密封类是专为“有限种状态”而生的受限类层级</strong>。它核心只做一件事——把继承的权利关进笼子里，不让外部随意扩展。</p>
<h3 data-id="heading-2">1.2 Kotlin 密封类的设计价值（兼顾灵活性与安全性，编译时校验类型）</h3>
<p>密封类被称为“增强版的枚举”（Enum with superpowers）。</p>
<ul>
<li><strong>相比枚举</strong>：它更灵活。枚举的每个实例结构都必须一样，而密封类的子类可以是单例（<code>object</code>）、数据类（<code>data class</code>）甚至是普通类，每种状态都能携带自己独有的数据。</li>
<li><strong>相比接口/抽象类</strong>：它更安全。编译器在编译期就知道它所有的子类，这意味着当你用 <code>when</code> 处理它时，编译器能帮你做“穷尽检查”，杜绝逻辑遗漏。</li>
</ul>
<h3 data-id="heading-3">1.3 核心疑问：Kotlin 密封类编译后是什么样？</h3>
<p>很多兄弟好奇：Java 直到 15/17 才引入 <code>sealed</code>，那 Kotlin 早几年是怎么在 JVM 上跑起来的？它是黑科技吗？
<strong>完全不是。</strong> 只要我们扒开字节码（Decompile）看一眼，就会发现它本质上利用了 Java 的访问控制机制。</p>
<h3 data-id="heading-4">1.4 本文核心内容预告</h3>
<p>本文将从底层原理出发，层层递进：</p>
<ol>
<li><strong>Java 映射</strong>：看透它的底层实现。</li>
<li><strong>语法规范</strong>：掌握 2025 年最新的定义方式（如 <code>data object</code>）。</li>
<li><strong>核心特性</strong>：理解为什么它能做编译期检查。</li>
<li><strong>实战场景</strong>：UI 状态、网络请求、导航路由等真实案例。</li>
<li><strong>对比分析</strong>：彻底搞懂它和 Enum 的区别。</li>
</ol>
<h2 data-id="heading-5">二、核心揭秘：Kotlin 密封类 → Java 代码映射</h2>
<p>要真正理解密封类，最直接的方法是看它编译后的字节码对应什么 Java 代码。</p>
<h3 data-id="heading-6">2.1 映射底层原理</h3>
<p>Kotlin 的 <code>sealed class</code> 在编译成 Java 字节码时，主要做了两件事：</p>
<ol>
<li><strong>转变为抽象类</strong>：密封类本身会被编译为一个 <code>abstract class</code>，因此不能直接实例化。</li>
<li><strong>私有化/受限构造函数</strong>：它的构造函数通常是 <code>private</code> 或 <code>protected</code>，并在元数据中标记只允许在特定范围内继承。</li>
</ol>
<h3 data-id="heading-7">2.2 完整示例映射</h3>
<h3 data-id="heading-8">2.2.1 Kotlin 原代码</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>(<span class="hljs-keyword">val</span> msg: String) : Result()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Error : Result() <span class="hljs-comment">// Kotlin 1.9+ 推荐写法</span>
}

</code></pre>
<h3 data-id="heading-9">2.2.2 对应的 Java 反编译结果（核心逻辑）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 本质就是个抽象类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span> {

    <span class="hljs-comment">// 2. 关键点：构造函数是私有的！</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Result</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">// 3. Kotlin 生成的合成构造器，用于允许内部子类调用</span>
    <span class="hljs-comment">// 逻辑上就是锁死了外部继承的可能性</span>
    <span class="hljs-keyword">public</span> <span class="hljs-comment">/* synthetic */</span> Result(DefaultConstructorMarker marker) {
        <span class="hljs-built_in">this</span>();
    }

    <span class="hljs-comment">// 子类 1：静态内部类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Result</span> { ... }

    <span class="hljs-comment">// 子类 2：静态单例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Result</span> { ... }
}

</code></pre>
<h3 data-id="heading-10">2.3 关键细节说明</h3>
<p><strong>结论就一句话</strong>：密封类本质上就是一个“构造函数被私有化”的抽象类。
因为构造函数被锁死了，编译器可以保证除了它允许的“亲儿子”（同文件或同模块内的类），其他任何地方的代码都无法继承它。这就是“有限继承”的底层实现。</p>
<h2 data-id="heading-11">三、密封类基础：定义与语法规范</h2>
<h3 data-id="heading-12">3.1 基本语法</h3>
<p>使用 <code>sealed</code> 关键字修饰类即可。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UiState</span>
</code></pre>
<h3 data-id="heading-13">3.2 子类定义规则</h3>
<p>随着 Kotlin 版本的迭代，规则逐渐放宽：</p>
<ul>
<li><strong>Kotlin 1.0 - 1.4</strong>：子类必须定义在密封类内部，或者同一文件中。</li>
<li><strong>Kotlin 1.5+（当前主流）</strong>：<strong>只要在同一个模块（Module）且同一个包（Package）内</strong>，子类可以写在不同的文件里。
<ul>
<li><em>实战建议</em>：虽然允许分文件写，但为了代码可读性，建议除非类特别大，否则还是写在同一个文件里，一目了然。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-14">3.3 简单示例（包含 2025 年最新语法）</h3>
<p>注意：对于没有数据的状态，Kotlin 1.9+ 强烈推荐使用 <code>data object</code> 替代普通的 <code>object</code>，以便获得更好的 <code>toString</code> 输出。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 文件：UiState.kt</span>
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UiState</span>&lt;<span class="hljs-type">out T</span>&gt; { <span class="hljs-comment">// 支持泛型</span>
    <span class="hljs-comment">// 1. 纯状态：推荐用 data object</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Loading : UiState&lt;<span class="hljs-built_in">Nothing</span>&gt;()

    <span class="hljs-comment">// 2. 带数据：用 data class</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : UiState&lt;T&gt;()

    <span class="hljs-comment">// 3. 带异常：用 data class</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> exception: Throwable) : UiState&lt;<span class="hljs-built_in">Nothing</span>&gt;()
}

</code></pre>
<h3 data-id="heading-15">3.4 关键要求</h3>
<ol>
<li><strong>禁止外部新增子类</strong>：你不能在另一个模块或非同包下定义子类。</li>
<li><strong>子类不可为密封类自身</strong>：这会导致循环继承逻辑错误。</li>
<li><strong>自身抽象</strong>：不能直接 <code>new UiState()</code>。</li>
</ol>
<h2 data-id="heading-16">四、密封类的核心特性</h2>
<h3 data-id="heading-17">4.1 有限继承</h3>
<p>密封类定义了一个<strong>封闭的类型集合</strong>。这不仅仅是代码组织的方式，更是对业务逻辑的强约束。比如“网络请求”只有成功、失败、加载中这三种状态，绝不可能出现第四种未知的状态。</p>
<h3 data-id="heading-18">4.2 不可实例化</h3>
<p>由于编译后是抽象类，你无法创建密封类本身的实例。你只能创建其子类的实例。</p>
<h3 data-id="heading-19">4.3 when 表达式穷尽匹配（官方最强杀器）</h3>
<p>这是密封类存在的最大理由！当你在 <code>when</code> 表达式中使用密封类时：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handle</span><span class="hljs-params">(state: <span class="hljs-type">UiState</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
    <span class="hljs-keyword">when</span> (state) {
        <span class="hljs-keyword">is</span> UiState.Loading -&gt; showLoading()
        <span class="hljs-keyword">is</span> UiState.Success -&gt; showText(state.<span class="hljs-keyword">data</span>)
        <span class="hljs-keyword">is</span> UiState.Error -&gt; showToast(state.exception.message)
    }
    <span class="hljs-comment">// 注意：这里不需要写 else！</span>
}

</code></pre>
<p><strong>编译期安全</strong>：如果你漏写了 <code>Error</code> 分支，编译器会直接报错 <code>'when' expression must be exhaustive</code>。这比运行时崩溃强一万倍。</p>
<h3 data-id="heading-20">4.4 支持带构造函数</h3>
<p>密封类可以拥有构造函数（默认 <code>protected</code> 或 <code>private</code>），允许你在父类中定义通用的属性，由子类传递进来。</p>
<h3 data-id="heading-21">4.5 子类可多实例</h3>
<ul>
<li><code>data object</code> 子类是单例。</li>
<li><code>data class</code> / <code>class</code> 子类可以创建无数个实例，每个实例携带不同的数据（如不同的错误信息、不同的用户数据）。</li>
</ul>
<h2 data-id="heading-22">五、密封类的使用场景与实战</h2>
<h3 data-id="heading-23">5.1 状态管理（UI State）</h3>
<p>这是 Android Jetpack Compose 或 ViewModel 中最标准的写法。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScreenState</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Loading : ScreenState() <span class="hljs-comment">// 页面加载中</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Content</span>(<span class="hljs-keyword">val</span> userList: List&lt;User&gt;) : ScreenState() <span class="hljs-comment">// 显示内容</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : ScreenState() <span class="hljs-comment">// 显示错误页</span>
}

</code></pre>
<h3 data-id="heading-24">5.2 有限类型场景（支付/权限）</h3>
<p>比如处理权限申请结果，这是典型的有限集合：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PermissionResult</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Granted : PermissionResult
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Denied : PermissionResult
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rationale</span>(<span class="hljs-keyword">val</span> shouldShow: <span class="hljs-built_in">Boolean</span>) : PermissionResult
}

</code></pre>
<h3 data-id="heading-25">5.3 when 表达式完美适配</h3>
<p>结合 <code>when</code> 表达式，业务逻辑变得异常清晰，且不用担心遗漏。</p>
<h3 data-id="heading-26">5.4 完整实战示例：页面导航（Navigation）</h3>
<p>在 Compose 或传统路由中，用密封类管理页面参数是最优雅的。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Screen</span>(<span class="hljs-keyword">val</span> route: String) {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Home : Screen(<span class="hljs-string">"home"</span>)
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Login : Screen(<span class="hljs-string">"login"</span>)
    <span class="hljs-comment">// 携带参数的页面</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Detail</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Long</span>) : Screen(<span class="hljs-string">"detail/<span class="hljs-variable">$id</span>"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">navigate</span><span class="hljs-params">(screen: <span class="hljs-type">Screen</span>)</span></span> {
    <span class="hljs-keyword">when</span>(screen) {
        Screen.Home -&gt; navigator.push(<span class="hljs-string">"home"</span>)
        <span class="hljs-keyword">is</span> Screen.Detail -&gt; navigator.push(<span class="hljs-string">"detail/<span class="hljs-subst">${screen.id}</span>"</span>)
        <span class="hljs-comment">// 编译器强制检查所有页面</span>
        <span class="hljs-keyword">else</span> -&gt; {}
    }
}
</code></pre>
<h2 data-id="heading-27">六、密封类与枚举 (Enum) 的核心区别</h2>
<h3 data-id="heading-28">6.1 实例特性</h3>
<ul>
<li><strong>枚举 (Enum)</strong>：<strong>单例的</strong>。<code>Color.RED</code> 全局只有一个。</li>
<li><strong>密封类</strong>：<strong>子类实例独立的</strong>。<code>Success(data1)</code> 和 <code>Success(data2)</code> 是两个不同的对象。</li>
</ul>
<h3 data-id="heading-29">6.2 扩展灵活性</h3>
<ul>
<li><strong>枚举</strong>：所有枚举常量的结构必须完全一致。</li>
<li><strong>密封类</strong>：子类可以各玩各的。一个是单例，一个是复杂的数据类，互不干扰。</li>
</ul>
<h3 data-id="heading-30">6.3 适用场景对比表</h3>






























<table><thead><tr><th>特性</th><th>枚举 (Enum Class)</th><th>密封类 (Sealed Class)</th></tr></thead><tbody><tr><td><strong>状态数量</strong></td><td>固定有限</td><td>类型固定，但实例无限</td></tr><tr><td><strong>数据结构</strong></td><td>所有实例结构必须相同</td><td>每个子类可以有完全不同的属性</td></tr><tr><td><strong>内存开销</strong></td><td>最小</td><td>稍大（因为要创建对象）</td></tr><tr><td><strong>典型场景</strong></td><td>星期、颜色、方向</td><td>UI 状态、网络结果、指令集</td></tr></tbody></table>
<h2 data-id="heading-31">七、密封类的进阶用法</h2>
<h3 data-id="heading-32">7.1 子类携带参数与泛型</h3>
<p>配合协变泛型 <code>out T</code> 和 <code>Nothing</code> 类型，可以写出极其通用的结果类。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : Result&lt;T&gt;()
    <span class="hljs-comment">// Error 不带泛型数据，继承 Result&lt;Nothing&gt; 即可兼容所有泛型</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> e: Throwable) : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
}
</code></pre>
<h3 data-id="heading-33">7.2 密封类与数据类结合</h3>
<p>99% 的情况下，密封类的子类都应该是 <code>data class</code> 或 <code>data object</code>。
这样你会自动获得 <code>equals()</code>、<code>hashCode()</code>、<code>toString()</code> 和 <code>copy()</code>，在调试和对比状态时非常有用。</p>
<h3 data-id="heading-34">7.3 嵌套子类</h3>
<p>处理层级化的错误码时很有用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppError</span> : <span class="hljs-type">Exception</span>() {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Unknown : AppError()

    <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Network</span> : <span class="hljs-type">AppError</span>() {
        <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Timeout : Network()
        <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HostUnreachable</span>(<span class="hljs-keyword">val</span> url: String) : Network()
    }

    <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Database</span> : <span class="hljs-type">AppError</span>() {
        <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> DiskFull : Database()
    }
}
</code></pre>
<h2 data-id="heading-35">八、使用注意事项与避坑点</h2>
<h3 data-id="heading-36">8.1 子类必须在同一文件（或同一模块）</h3>
<p>虽然 Kotlin 1.5+ 允许子类定义在同模块的不同文件中，但<strong>强烈建议</strong>对于简单的状态类，仍然写在同一个文件中。这能让维护者一眼看全所有可能的状态，保持代码的“内聚性”。</p>
<h3 data-id="heading-37">8.2 when 匹配需穷尽所有子类</h3>
<p><strong>避坑指南</strong>：在 <code>when</code> 匹配密封类时，<strong>尽量不要写 <code>else</code> 分支</strong>。
如果你写了 <code>else</code>，当你日后新增了一个子类状态（比如新增了 <code>Loading</code>），编译器就不会报错提醒你。这会导致新状态在运行时被忽略，产生隐蔽的 Bug。</p>
<h3 data-id="heading-38">8.3 避免滥用</h3>
<p>密封类适合**类型可枚举（有限）**的场景。如果你的子类数量成百上千，或者需要支持第三方插件动态扩展子类，请使用普通的 <code>interface</code> 或 <code>abstract class</code>。</p>
<h2 data-id="heading-39">九、总结与最佳实践</h2>
<h3 data-id="heading-40">9.1 核心知识点回顾</h3>
<ul>
<li><strong>定义</strong>：<code>sealed class</code> = 编译期已知的受限类层级。</li>
<li><strong>本质</strong>：私有构造函数的抽象类。</li>
<li><strong>杀手锏</strong>：<code>when</code> 表达式的穷尽性检查。</li>
</ul>
<h3 data-id="heading-41">9.2 最佳实践</h3>
<ol>
<li><strong>UI 状态必用</strong>：在 ViewModel 中定义 State 时，Sealed Class 是标准答案。</li>
<li><strong>单例用 data object</strong>：Kotlin 1.9+ 后，无参数状态请使用 <code>data object</code> 而非 <code>object</code>。</li>
<li><strong>拒绝 else</strong>：让编译器做你的僚机，通过报错来提醒你处理新状态。</li>
</ol>
<h3 data-id="heading-42">9.3 选型建议</h3>
<ul>
<li>如果是一组固定的常量（如星期一到星期日）→ <strong>Enum</strong>。</li>
<li>如果是一组固定的类型，且每种类型需要携带不同的数据（如成功带数据，失败带异常）→ <strong>Sealed Class</strong>。</li>
<li>如果类型需要无限扩展 → <strong>Interface / Abstract Class</strong>。</li>
</ul>
<p>掌握了密封类，你就掌握了 Kotlin 类型安全的精髓，从此告别运行时的一脸懵逼，拥抱编译时的稳如泰山。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[17.Kotlin 类：类的形态（四）：枚举类 (Enum Class)]]></title>    <link>https://juejin.cn/post/7577970969394987049</link>    <guid>https://juejin.cn/post/7577970969394987049</guid>    <pubDate>2025-11-30T06:10:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577970969394987049" data-draft-id="7577970969394970665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="17.Kotlin 类：类的形态（四）：枚举类 (Enum Class)"/> <meta itemprop="keywords" content="后端,Kotlin,Android"/> <meta itemprop="datePublished" content="2025-11-30T06:10:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android_小雨"/> <meta itemprop="url" content="https://juejin.cn/user/220360279590862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            17.Kotlin 类：类的形态（四）：枚举类 (Enum Class)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/220360279590862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android_小雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:10:38.000Z" title="Sun Nov 30 2025 06:10:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>希望帮你在Kotlin进阶路上少走弯路，在技术上稳步提升。当然，由于个人知识储备有限，笔记中难免存在疏漏或表述不当的地方，也非常欢迎大家提出宝贵意见，一起交流进步。 —— Android_小雨</p>
</blockquote>
<p>整体目录：<a href="https://juejin.cn/spost/7573592952242602036" target="_blank" title="https://juejin.cn/spost/7573592952242602036">Kotlin 进阶不迷路：41 个核心知识点，构建完整知识体系</a></p>
<h2 data-id="heading-0">一、前言</h2>
<p>Kotlin 官方对枚举类的完整定义 Widest spread（逐句拆解）</p>
<blockquote>
<p>Enum classes in Kotlin are declared using the enum class keyword. Each enum constant is an object (enum constants are separated by commas). Enum constants can have properties and functions just like normal objects. The compiler automatically generates:</p>
<ul>
<li>values() – returns an array of all enum entries</li>
<li>valueOf(name) – returns the enum constant by name (throws IllegalArgumentException if not found)</li>
<li>entries (Kotlin 1.9+) – type-safe EnumEntries list (preferred over values())</li>
</ul>
<p>Enums in Kotlin are <strong>classes</strong>, so they can implement interfaces, have constructors, and even have different properties per constant.</p>
</blockquote>
<p>官方强调的 5 个核心点（记住这 5 条就彻底掌握枚举类）：</p>
<ol>
<li>每个枚举常量都是一个对象（它们是通过 Java 的 static final 字段来引用的，但它们不是简单的 int/String 基本类型常量）。</li>
<li>可以给每个常量<strong>单独传参、实现不同逻辑</strong></li>
<li>自动生成 values() / valueOf() / entries</li>
<li>支持接口实现、匿名类重写方法</li>
<li>Kotlin 1.9+ 推荐使用 entries（类型安全的集合）</li>
</ol>
<p>在 Kotlin 中，不要把枚举看作一组‘常数’，要把它们看作一组‘预定义好的单例对象集合’。</p>
<h3 data-id="heading-1">1.1 枚举类的核心定位</h3>
<p>在日常开发中，我们总会遇到一些“固定且有限”的集合：一周有七天、方向有东南西北、HTTP 状态码有 200/404/500。 如果用 <code>int</code> 或 <code>String</code> 常量来表示（比如 <code>public static final int NORTH = 1</code>），代码中就会充斥着“魔法数字”，既不直观也不安全。</p>
<p><strong>枚举类 (Enum Class)</strong> 的核心定位就是：<strong>定义固定有限的常量集合，保障类型安全</strong>。它强迫你在编译期就确定好所有的可能性，把运行时可能出现的“无效值”错误扼杀在摇篮里。</p>
<h3 data-id="heading-2">1.2 Kotlin 枚举类的设计优势</h3>
<p>相比于 Java，Kotlin 的枚举虽然底层一致，但语法更加简洁，且自带了现代化的工具方法。 它是**“带超能力的枚举”**：</p>
<ul>
<li><strong>不仅是常量</strong>：每个枚举项本质上都是一个完整的对象。</li>
<li><strong>功能丰富</strong>：支持属性、方法、接口实现，甚至匿名类重写。</li>
<li><strong>工具完善</strong>：Kotlin 1.9+ 引入的 <code>entries</code> 属性，让遍历枚举变得无需对象分配且类型安全。</li>
</ul>
<h3 data-id="heading-3">1.3 核心疑问：Kotlin 枚举类与 Java 枚举有何关联？</h3>
<p>很多从 Java 转过来的同学会问：<code>enum class</code> 到底是个什么新物种？ 答案是：<strong>它不是新物种</strong>。Kotlin 枚举在 JVM 层面上，<strong>完全等同于 Java 的 <code>enum</code></strong>。这意味着它们在字节码层面是一致的，互操作性 100%。</p>
<h3 data-id="heading-4">1.4 本文核心内容预告</h3>
<p>本文将从底层开始，层层递进：</p>
<ol>
<li><strong>Java 映射</strong>：看透它的底层实现（继承自 <code>java.lang.Enum</code>）。</li>
<li><strong>基础语法</strong>：掌握 2025 年最新的定义方式。</li>
<li><strong>核心特性</strong>：理解类型安全与单例本质。</li>
<li><strong>实战场景</strong>：状态机、策略模式等真实案例。</li>
<li><strong>对比分析</strong>：彻底搞懂它和密封类（Sealed Class）的区别。</li>
</ol>
<h2 data-id="heading-5">二、核心揭秘：Kotlin 枚举类 → Java 代码映射</h2>
<p>要理解枚举的本质，必须看它编译后的样子。</p>
<h3 data-id="heading-6">2.1 映射底层原理</h3>
<p>Kotlin 的 <code>enum class</code> 在编译后，会生成一个继承自 <code>java.lang.Enum</code> 的类。</p>
<ul>
<li>每个枚举常量，都会变成该类的一个 <code>public static final</code> 实例。</li>
<li>这意味着枚举常量在 JVM 中是<strong>单例</strong>的。</li>
</ul>
<h3 data-id="heading-7">2.2 完整示例映射</h3>
<h3 data-id="heading-8">2.2.1 基础枚举类</h3>
<p><strong>Kotlin 原代码：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Direction</span> {
    NORTH, SOUTH
}
</code></pre>
<p><strong>Java 反编译结果（简化版）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Direction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;Direction&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Direction NORTH;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Direction SOUTH;

    <span class="hljs-comment">// 静态初始化块，创建单例</span>
    <span class="hljs-keyword">static</span> {
        NORTH = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Direction</span>(<span class="hljs-string">"NORTH"</span>, <span class="hljs-number">0</span>);
        SOUTH = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Direction</span>(<span class="hljs-string">"SOUTH"</span>, <span class="hljs-number">1</span>);
    }
}
</code></pre>
<h3 data-id="heading-9">2.2.2 带属性/方法的枚举类</h3>
<p><strong>Kotlin 原代码：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpStatus</span>(<span class="hljs-keyword">val</span> code: <span class="hljs-built_in">Int</span>) {
    OK(<span class="hljs-number">200</span>);
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isSuccess</span><span class="hljs-params">()</span></span> = code == <span class="hljs-number">200</span>
}
</code></pre>
<p><strong>Java 反编译结果：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">HttpStatus</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;HttpStatus&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> HttpStatus OK;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code; <span class="hljs-comment">// 属性变成了 final 字段</span>

    <span class="hljs-comment">// 构造函数私有化</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">HttpStatus</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> ordinal, <span class="hljs-type">int</span> code)</span> {
        <span class="hljs-built_in">super</span>(name, ordinal);
        <span class="hljs-built_in">this</span>.code = code;
    }

    <span class="hljs-comment">// 方法变成普通成员方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSuccess</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.code == <span class="hljs-number">200</span>;
    }
}
</code></pre>
<h3 data-id="heading-10">2.3 关键细节</h3>
<ol>
<li><strong>构造函数</strong>：JVM 自动处理了 <code>name</code> 和 <code>ordinal</code> 参数，我们定义的参数（如 <code>code</code>）被追加在后面。</li>
<li><strong>values() / valueOf()</strong> ：这些静态方法是由编译器自动合成生成的（Synthesized），用于查找和遍历。</li>
</ol>
<h2 data-id="heading-11">三、枚举类基础：定义与语法规范</h2>
<h3 data-id="heading-12">3.1 基本语法</h3>
<p>使用 <code>enum class</code> 关键字（注意是两个词，中间有空格）。</p>
<h3 data-id="heading-13">3.2 基础枚举定义</h3>
<p>适用于不需要携带额外数据的场景。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Gender</span> {
    MALE, FEMALE, OTHER
}
</code></pre>
<h3 data-id="heading-14">3.3 带属性的枚举类</h3>
<p>这是枚举最常用的形态。通过主构造函数定义属性，每个常量必须传入对应的值。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Color</span>(<span class="hljs-keyword">val</span> hex: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> description: String) {
    RED(<span class="hljs-number">0xFF0000</span>, <span class="hljs-string">"红色"</span>),
    GREEN(<span class="hljs-number">0x00FF00</span>, <span class="hljs-string">"绿色"</span>),
    BLUE(<span class="hljs-number">0x0000FF</span>, <span class="hljs-string">"蓝色"</span>); <span class="hljs-comment">// 注意：如果有额外成员，最后一个常量后必须加分号</span>

    <span class="hljs-keyword">val</span> rgbString: String
        <span class="hljs-keyword">get</span>() = <span class="hljs-string">"#"</span> + Integer.toHexString(hex)
}
</code></pre>
<h3 data-id="heading-15">3.4 带方法的枚举类（匿名类实现）</h3>
<p>每个枚举常量不仅可以有属性，还可以有<strong>不同的行为</strong>。这实际上是<strong>策略模式</strong>的一种微型实现。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Operator</span> {
    PLUS {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(x: <span class="hljs-type">Int</span>, y: <span class="hljs-type">Int</span>)</span></span> = x + y
    },
    MINUS {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(x: <span class="hljs-type">Int</span>, y: <span class="hljs-type">Int</span>)</span></span> = x - y
    }; <span class="hljs-comment">// 分号必须</span>

    <span class="hljs-comment">// 定义抽象方法，强制每个常量实现</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(x: <span class="hljs-type">Int</span>, y: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span>
}
</code></pre>
<h3 data-id="heading-16">3.5 简单示例</h3>
<p>定义一个支付方式枚举：</p>
<pre><code class="hljs language-scss" lang="scss">enum class <span class="hljs-built_in">PayType</span>(val typeId: Int) {
    <span class="hljs-built_in">ALIPAY</span>(<span class="hljs-number">1</span>),
    <span class="hljs-built_in">WECHAT</span>(<span class="hljs-number">2</span>),
    <span class="hljs-built_in">CREDIT_CARD</span>(<span class="hljs-number">3</span>)
}
</code></pre>
<h2 data-id="heading-17">四、枚举类的核心特性</h2>
<h3 data-id="heading-18">4.1 类型安全</h3>
<p>这是枚举存在的最大意义。 <code>fun pay(type: PayType)</code> 当你看到这个函数签名时，你很放心，因为调用者绝对不可能传入一个非法的类型（比如传入 <code>4</code> 或 <code>null</code>）。编译器会帮你看住大门。</p>
<h3 data-id="heading-19">4.2 单例特性</h3>
<p>每个枚举常量（如 <code>PayType.ALIPAY</code>）在整个应用生命周期中<strong>只有一个实例</strong>。你可以直接用 <code>==</code> 或 <code>===</code> 来比较它们，效果完全一样且高效。</p>
<h3 data-id="heading-20">4.3 自带工具方法</h3>
<p>Kotlin 编译器自动生成了以下神器：</p>
<ul>
<li>
<p><strong><code>entries</code> (Kotlin 1.9+ 推荐)</strong> ：返回一个类型安全的、不可变的 <code>List</code>，包含所有常量。</p>
<ul>
<li><em>优势</em>：相比旧的 <code>values()</code>，<code>entries</code> 避免了每次调用都克隆一个新数组，性能更好，且支持集合操作。</li>
</ul>
</li>
<li>
<p><strong><code>values()</code> (旧版，不推荐)</strong> ：返回一个数组 <code>Array</code>。</p>
</li>
<li>
<p><strong><code>valueOf(name: String)</code></strong> ：通过名字查找常量。如果找不到会抛 <code>IllegalArgumentException</code>。</p>
</li>
<li>
<p><strong><code>name</code></strong>: 常量的名称（String）。</p>
</li>
<li>
<p><strong><code>ordinal</code></strong>: 常量的索引（Int，从 0 开始）。</p>
</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 遍历 (推荐写法)</span>
PayType.entries.forEach { <span class="hljs-built_in">println</span>(it.name) }

<span class="hljs-comment">// 查找</span>
val <span class="hljs-keyword">type</span> = PayType.valueOf(<span class="hljs-string">"ALIPAY"</span>)
</code></pre>
<h3 data-id="heading-21">4.4 支持属性与方法</h3>
<p>枚举不是死板的常量，它是类。你可以给它加 <code>fun isRecommended()</code>，或者 <code>val label: String</code>，让枚举自己携带业务逻辑，避免到处写 <code>if (type == ALIPAY) ...</code>。</p>
<h3 data-id="heading-22">4.5 可实现接口</h3>
<p>枚举可以实现接口，这让它能融入更复杂的架构中。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Printable</span> { <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">print</span><span class="hljs-params">()</span></span> }

<span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Level</span> : <span class="hljs-type">Printable</span> {
    LOW { <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">print</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"Low"</span>) },
    HIGH { <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">print</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"High"</span>) }
}
</code></pre>
<h2 data-id="heading-23">五、枚举类的使用场景与实战</h2>
<h3 data-id="heading-24">5.1 固定选项场景</h3>
<p>如下拉框选项、性别、血型。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BloodType</span> { A, B, AB, O }
</code></pre>
<h3 data-id="heading-25">5.2 状态标识场景</h3>
<p>网络请求状态、订单流转状态。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestState</span> {
    IDLE, LOADING, SUCCESS, ERROR
}
</code></pre>
<h3 data-id="heading-26">5.3 与 when 表达式适配（穷尽检查）</h3>
<p>这是枚举最爽的特性。配合 <code>when</code> 表达式，编译器会强制你处理所有情况。</p>
<pre><code class="hljs language-scss" lang="scss">fun <span class="hljs-built_in">handleState</span>(state: RequestState) {
    when (state) {
        RequestState<span class="hljs-selector-class">.IDLE</span> -&gt; <span class="hljs-built_in">init</span>()
        RequestState<span class="hljs-selector-class">.LOADING</span> -&gt; <span class="hljs-built_in">showProgress</span>()
        RequestState<span class="hljs-selector-class">.SUCCESS</span> -&gt; <span class="hljs-built_in">showData</span>()
        RequestState<span class="hljs-selector-class">.ERROR</span> -&gt; <span class="hljs-built_in">showError</span>()
    }
    <span class="hljs-comment">// 不需要 else！如果你漏了一个状态，编译器会报错。</span>
}
</code></pre>
<h3 data-id="heading-27">5.4 完整实战示例</h3>
<p>一个带有逻辑判断的权限枚举：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Permission</span>(<span class="hljs-keyword">val</span> description: String) {
    READ_CONTACTS(<span class="hljs-string">"读取联系人"</span>),
    CAMERA(<span class="hljs-string">"使用相机"</span>),
    LOCATION(<span class="hljs-string">"获取定位"</span>);

    <span class="hljs-comment">// 模拟检查权限的逻辑</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isSensitive</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> == LOCATION || <span class="hljs-keyword">this</span> == READ_CONTACTS
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">request</span><span class="hljs-params">(p: <span class="hljs-type">Permission</span>)</span></span> {
    <span class="hljs-keyword">if</span> (p.isSensitive()) {
        println(<span class="hljs-string">"正在申请敏感权限: <span class="hljs-subst">${p.description}</span>"</span>)
    }
}
</code></pre>
<h2 data-id="heading-28">六、枚举类与密封类 (Sealed Class) 的核心区别</h2>
<p>这是面试和架构选型的高频问题。</p>
<h3 data-id="heading-29">6.1 实例特性</h3>
<ul>
<li><strong>枚举 (Enum)</strong> ：<strong>单例的</strong>。<code>State.ERROR</code> 全局只有一个对象。你不能创建 <code>State.ERROR("Network error")</code> 和 <code>State.ERROR("Timeout")</code> 两个不同的错误对象。</li>
<li><strong>密封类 (Sealed Class)</strong> ：<strong>子类可以多实例</strong>。你可以创建无数个 <code>Error</code> 对象，每个携带不同的异常信息。</li>
</ul>
<h3 data-id="heading-30">6.2 数据灵活性</h3>
<ul>
<li><strong>枚举</strong>：所有常量的结构必须<strong>完全一致</strong>（都由主构造函数决定）。</li>
<li><strong>密封类</strong>：子类可以各玩各的。一个是 <code>object</code>，一个是 <code>data class</code>，结构互不干扰。</li>
</ul>
<h3 data-id="heading-31">6.3 适用场景对比表</h3>






























<table><thead><tr><th>特性</th><th>枚举类 (Enum)</th><th>密封类 (Sealed Class)</th></tr></thead><tbody><tr><td><strong>状态数量</strong></td><td>固定有限</td><td>固定有限（类型有限）</td></tr><tr><td><strong>数据载荷</strong></td><td><strong>必须相同</strong>（如都有 code, msg）</td><td><strong>可以不同</strong>（A 带 String, B 带 Exception）</td></tr><tr><td><strong>实例数量</strong></td><td><strong>单例</strong> (Singleton)</td><td><strong>多实例</strong> (Instance)</td></tr><tr><td><strong>典型场景</strong></td><td>星期、颜色、固定配置</td><td>UI 状态（需带数据）、网络结果</td></tr></tbody></table>
<p><strong>结论</strong>：如果你的状态不需要携带动态数据（或者所有状态携带的数据结构完全一样），优先用 <strong>枚举</strong>。如果不同状态需要携带不同数据（比如 <code>Success</code> 带 data，<code>Error</code> 带 exception），必须用 <strong>密封类</strong>。</p>
<h2 data-id="heading-32">七、枚举类的进阶用法</h2>
<h3 data-id="heading-33">7.1 枚举常量实现抽象方法</h3>
<p>在 3.4 节已展示。这种写法非常适合<strong>策略模式</strong>，比如计算器应用，加减乘除逻辑不同，但都属于 <code>Operation</code> 类型。</p>
<h3 data-id="heading-34">7.2 枚举类结合伴生对象 (Companion Object)</h3>
<p>通常用于编写“反向查找”逻辑，比如根据 <code>code</code> 找枚举。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorCode</span>(<span class="hljs-keyword">val</span> code: <span class="hljs-built_in">Int</span>) {
    NOT_FOUND(<span class="hljs-number">404</span>), SERVER_ERROR(<span class="hljs-number">500</span>);

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fromCode</span><span class="hljs-params">(code: <span class="hljs-type">Int</span>)</span></span>: ErrorCode? {
            <span class="hljs-comment">// entries 是 Kotlin 1.9+ 的高效写法</span>
            <span class="hljs-keyword">return</span> entries.find { it.code == code }
        }
    }
}
</code></pre>
<h3 data-id="heading-35">7.3 枚举类用于序列化</h3>
<p>在 Gson 或 Moshi 等库中，枚举通常会被自动序列化为它的 <code>name</code> 字符串。但如果你想序列化为 <code>code</code> (Int)，通常需要配合 <code>@SerializedName</code> (Gson) 或 <code>@Json</code> (Moshi) 注解。</p>
<h3 data-id="heading-36">7.4 枚举类存储配置信息</h3>
<p>有时候可以用枚举来替代复杂的配置类：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThemeConfig</span>(<span class="hljs-keyword">val</span> colorPrimary: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> isDark: <span class="hljs-built_in">Boolean</span>) {
    LIGHT(<span class="hljs-number">0xFFFFFF</span>, <span class="hljs-literal">false</span>),
    DARK(<span class="hljs-number">0x000000</span>, <span class="hljs-literal">true</span>)
}
</code></pre>
<h2 data-id="heading-37">八、使用注意事项与避坑点</h2>
<h3 data-id="heading-38">8.1 性能提示</h3>
<p>枚举在 Java/Kotlin 中是完整的对象，比 <code>static final int</code> 常量占用更多的内存（每个实例大概多几十字节）。</p>
<ul>
<li><strong>Android 开发注意</strong>：虽然现在设备性能好了，但如果你有成千上万个状态需要保存，考虑使用 <code>@IntDef</code> (Android 注解) 来替代枚举以节省内存。但在 99% 的业务逻辑中，枚举的内存开销可忽略不计，<strong>优先换取代码可读性和安全性</strong>。</li>
</ul>
<h3 data-id="heading-39">8.2 不可动态扩展</h3>
<p>枚举是编译期常量。你不能在运行时从服务器下载一个 JSON，然后动态往枚举类里添加一个新类型。如果你的类型列表是动态变化的（比如后台配置的活动类型），请使用普通的 <code>data class</code> 或数据库表。</p>
<h3 data-id="heading-40">8.3 valueOf() 风险</h3>
<p><code>enumValueOf&lt;T&gt;("NAME")</code> 或 <code>Enum.valueOf("NAME")</code> 是不安全的。 如果传入的字符串不匹配任何枚举名，应用会<strong>崩溃</strong>（抛出异常）。 <strong>避坑</strong>：自己封装一个 <code>safeValueOf</code>，或者利用 <code>entries.find { ... }</code> 来安全查找。</p>
<h3 data-id="heading-41">8.4 永远不要依赖 ordinal</h3>
<p><code>ordinal</code> 表示枚举声明的顺序（0, 1, 2...）。 <strong>千万不要</strong>把 <code>ordinal</code> 存入数据库！因为如果你哪天心情好，在中间插入了一个新枚举，后面所有枚举的 <code>ordinal</code> 都会变，导致数据库数据错乱。<strong>始终使用自定义的 <code>id</code> 或 <code>code</code> 属性。</strong></p>
<h2 data-id="heading-42">九、总结与最佳实践</h2>
<h3 data-id="heading-43">9.1 核心知识点回顾</h3>
<ul>
<li><strong>本质</strong>：<code>class</code>，继承自 <code>java.lang.Enum</code>，单例对象。</li>
<li><strong>语法</strong>：<code>enum class</code>。</li>
<li><strong>工具</strong>：优先使用 <code>entries</code> (1.9+)，慎用 <code>valueOf</code>。</li>
<li><strong>穷尽</strong>：配合 <code>when</code> 表达式，不写 <code>else</code>。</li>
</ul>
<h3 data-id="heading-44">9.2 最佳实践</h3>
<ol>
<li><strong>优先用枚举</strong>：凡是固定的常量集合，不要用 <code>Interface</code> 定义常量，全部上枚举。</li>
<li><strong>自定义属性</strong>：给枚举加上 <code>code</code>、<code>desc</code> 等属性，让它成为“富模型”，而不是单纯的符号。</li>
<li><strong>伴生对象工厂</strong>：提供 <code>fromCode()</code> 等静态方法，方便业务层调用。</li>
<li><strong>去魔法化</strong>：代码中不应出现 <code>type == 1</code>，而应是 <code>type == UserType.VIP</code>。</li>
</ol>
<h3 data-id="heading-45">9.3 选型建议</h3>
<ul>
<li><strong>无动态数据 + 类型有限</strong>（如性别、星期） → <strong>枚举 (Enum)</strong></li>
<li><strong>带动态数据 + 类型有限</strong>（如 Result.Success(data)） → <strong>密封类 (Sealed Class)</strong></li>
<li><strong>类型无限</strong> → <strong>普通类 / 接口</strong></li>
</ul>
<p>掌握枚举类，是告别“面条代码”和“魔法数字”的第一步。用好它，你的 Kotlin 代码将变得既严谨又优雅。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Promise × 定时器全场景手写]]></title>    <link>https://juejin.cn/post/7577914902430629934</link>    <guid>https://juejin.cn/post/7577914902430629934</guid>    <pubDate>2025-11-30T09:01:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577914902430629934" data-draft-id="7577718777482035238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Promise × 定时器全场景手写"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T09:01:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="二二四一"/> <meta itemprop="url" content="https://juejin.cn/user/2975738274777080"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Promise × 定时器全场景手写
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2975738274777080/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    二二四一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:01:27.000Z" title="Sun Nov 30 2025 09:01:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🥇 01. 并发限制调度器（异步霸榜 No.1）</h2>
<blockquote>
<p>场景：你要发 100 个请求，但后端限流，每次只能发 N 个。</p>
</blockquote>
<blockquote>
<p>交互：可以在中途暂停执行，获取已执行的结果。</p>
</blockquote>
<p>🤔考点：工程思维能力</p>
<hr/>
<p>🌈实现：模拟一个迷你版“浏览器资源调度器”，这个调度器的核心本质，是通过「running 计数」「idx 游标」「runNext 自驱动」三者配合，实现一个动态的任务池。它保证任务源源不断执行，但同时不会超过给定的并发上限。</p>
<ol>
<li>调用方法</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyWork</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 生成调度器</span>
  <span class="hljs-keyword">const</span> scheduler = <span class="hljs-title function_">limitRequests</span>(tasks, <span class="hljs-number">3</span>);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleStart</span>(<span class="hljs-params"/>) {
    scheduler.<span class="hljs-title function_">start</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"所有任务完成！"</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"结果:"</span>, res);
    });
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleEnd</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"暂停完成执行～"</span>);
    scheduler.<span class="hljs-title function_">stop</span>();
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleStart}</span>&gt;</span>开始<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleEnd}</span>&gt;</span>暂停<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>2.  自定义调度器</p>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">limitRequests</span>(<span class="hljs-params">tasks, limit</span>) {
  <span class="hljs-keyword">const</span> res = [] <span class="hljs-comment">// 存所有任务返回的 Promise，用来最终 Promise.all</span>
  <span class="hljs-keyword">let</span> idx = <span class="hljs-number">0</span> <span class="hljs-comment">// 当前处理到第几个任务</span>
  <span class="hljs-keyword">let</span> running = <span class="hljs-number">0</span> <span class="hljs-comment">// 当前正在执行的任务数量（关键的并发控制变量）</span>
  <span class="hljs-keyword">let</span> stopped = <span class="hljs-literal">false</span> <span class="hljs-comment">// 用于标识是否已停止</span>

  <span class="hljs-comment">// 暴露的停止执行的方法</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">stop</span>(<span class="hljs-params"/>) {
    stopped = <span class="hljs-literal">true</span>
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">function</span> <span class="hljs-title function_">runNext</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 执行队列处理完毕或者已暂停，返回结果</span>
        <span class="hljs-keyword">if</span> (running === <span class="hljs-number">0</span> &amp;&amp; stopped) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(res))
        }

        <span class="hljs-comment">// 正在执行的任务数量不超过单次限制，存在未执行的任务</span>
        <span class="hljs-keyword">while</span> (running &lt; limit &amp;&amp; idx &lt; tasks.<span class="hljs-property">length</span>) {
          <span class="hljs-comment">// 如果停止标志为 true，阻止新的任务加入</span>
          <span class="hljs-keyword">if</span> (stopped) {
            <span class="hljs-keyword">return</span>
          }
          <span class="hljs-comment">// 获取当前任务并执行</span>
          <span class="hljs-keyword">const</span> cur = tasks[idx++]()
          res.<span class="hljs-title function_">push</span>(cur)
          running++
          cur.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
            running--
            <span class="hljs-title function_">runNext</span>()
          }).<span class="hljs-keyword">catch</span>(reject)
        }
      }

      <span class="hljs-title function_">runNext</span>()
    })
  }

  <span class="hljs-keyword">return</span> { stop, start }
}
</code></pre>
<p>3.  模拟异步方法、准备数据</p>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建100个任务</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> tasks = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">100</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchData</span>(i))

<span class="hljs-comment">// 模拟异步请求方法</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params">id: number</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> time = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">2000</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`开始任务: <span class="hljs-subst">${id}</span>`</span>)

    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`完成任务: <span class="hljs-subst">${id}</span>`</span>)
      <span class="hljs-title function_">resolve</span>(id)
    }, time)
  })
}
</code></pre>
<p>4.  自定义hook</p>

<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">useLimitRequests</span> = (tasks: any[], limit: number)=&gt; {
  const <span class="hljs-attr">resultRef</span> = useRef&lt;number[]&gt;([])<span class="hljs-comment">; // 用 useRef 存储任务结果，避免重新渲染</span>
  const <span class="hljs-attr">isStop</span> = useRef&lt;boolean&gt;(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">idx</span> = useRef&lt;number&gt;(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">reunning</span> = useRef&lt;number&gt;(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">onStop</span> = useCallback(() =&gt; {
    <span class="hljs-attr">isStop.current</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  },<span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">onStart</span> = useCallback(() =&gt; {
    return new Promise((resolve, reject) =&gt; {
      function nextRun(){
        if(<span class="hljs-attr">reunning.current</span> === <span class="hljs-number">0</span> &amp;&amp; isStop.current) {
          return resolve(Promise.all(resultRef.current))<span class="hljs-comment">;</span>
        }

        while(idx.current &lt; tasks.length &amp;&amp; reunning.current &lt; limit){
          if(isStop.current){
            return<span class="hljs-comment">;</span>
          }

          const <span class="hljs-attr">curTaskRes</span> = tasks[idx.current]()<span class="hljs-comment">;</span>
          idx.current += 1<span class="hljs-comment">;</span>
          resultRef.current.push(curTaskRes)
          reunning.current += 1<span class="hljs-comment">;</span>

          curTaskRes.then(() =&gt; {
            reunning.current <span class="hljs-attr">-</span>= <span class="hljs-number">1</span><span class="hljs-comment">;</span>
            nextRun()<span class="hljs-comment">;</span>
          }).catch((error: any) =&gt; reject(error))
        }
      }

      nextRun()<span class="hljs-comment">;</span>
    })
  },<span class="hljs-section">[isStop, limit, tasks]</span>)<span class="hljs-comment">;</span>

  return { onStop, onStart}<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7e38071875e4ff09dcf63777b48fade~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM5LqM5Zub5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765098087&amp;x-signature=F0PSaYzn7hWn59O4bapyrnjrvCE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">🥈 02. 支持指数退避的重试（Backoff Retry）</h2>
<blockquote>
<p>场景：接口偶尔报错，你希望自动重试 3 次，每次等待时间翻倍。</p>
</blockquote>
<p>💡 可靠性思维能力</p>
<hr/>
<ol>
<li>自定义重试方法</li>
</ol>

<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">retry</span>(fn, times = <span class="hljs-number">3</span>, delay = <span class="hljs-number">500</span>) {
  return new <span class="hljs-built_in">Promise</span>((resolve, reject) =&gt; {
    const attempt = (n, d) =&gt; {
      <span class="hljs-built_in">fn</span>()<span class="hljs-selector-class">.then</span>(resolve)<span class="hljs-selector-class">.catch</span>(err =&gt; {
        if (n === <span class="hljs-number">0</span>) return <span class="hljs-built_in">reject</span>(err)
        <span class="hljs-built_in">setTimeout</span>(() =&gt; <span class="hljs-built_in">attempt</span>(n - <span class="hljs-number">1</span>, d * <span class="hljs-number">2</span>), d)
      })
    }
    <span class="hljs-built_in">attempt</span>(times, delay)
  })
}
</code></pre>
<p>2.  调用</p>

<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRetry</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">retry</span>(mockRequest, <span class="hljs-number">3</span>, <span class="hljs-number">500</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)) <span class="hljs-comment">// 如果请求成功，输出结果</span>
      .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)); <span class="hljs-comment">// 如果重试失败，输出错误</span>
  }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a6251a15a9246f884f1cd5100b3cc6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM5LqM5Zub5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765098087&amp;x-signature=Oh0L2qjBBKJyZoBKF%2BmWB0sG38M%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">🥉 03. 带超时控制的 Promise（Timeout Promise）</h2>
<blockquote>
<p>场景：请求超 3 秒自动失败，不等了。</p>
</blockquote>
<p>🕒 超时包装器</p>
<hr/>
<ol>
<li>自定义函数实现</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">withTimeout</span>(<span class="hljs-params">fn, ms</span>){
  <span class="hljs-comment">// 存放定时器</span>
  <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// 超时函数</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">timeOut</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> {
    timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'超时了'</span>)), ms);
  });

  <span class="hljs-comment">// Promise.race 会返回一个结果， fn 目标函数</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([<span class="hljs-title function_">fn</span>(), <span class="hljs-title function_">timeOut</span>()]).<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">clearTimeout</span>(timer);
  })
}
</code></pre>
<p>2.  模拟延迟异步方法</p>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">slowTask</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'Task completed'</span>), <span class="hljs-number">2000</span>); <span class="hljs-comment">// 模拟一个 3 秒的任务</span>
  });
}
</code></pre>
<p>3.  调用</p>

<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleTimeOut</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">withTimeout</span>(slowTask, <span class="hljs-number">1000</span>) <span class="hljs-comment">// 设置 1 秒超时</span>
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)) <span class="hljs-comment">// 如果任务完成，输出结果</span>
      .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)); <span class="hljs-comment">// 如果超时，输出超时错误</span>
  }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1855acce3d2e45f199764f982e644d1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM5LqM5Zub5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765098087&amp;x-signature=uaUFCr%2BXVu6jjAIp80apf%2BdBOhA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">🚢 04. 串行任务：一步一步稳扎稳打</h2>
<blockquote>
<p>每个任务会按顺序一个接一个地执行，<strong>直到上一个任务完成后，才会开始下一个任务</strong></p>
</blockquote>
<p>📌 场景：分片上传、表单分步骤提交</p>
<hr/>
<ol>
<li>自定义方法</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runInSequence</span>(<span class="hljs-params">tasks</span>){
  <span class="hljs-keyword">const</span> result = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> task <span class="hljs-keyword">of</span> tasks) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">task</span>();
    result.<span class="hljs-title function_">push</span>(res);
  }

  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>2.  模拟异步请求</p>

<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = (<span class="hljs-params">task: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Task <span class="hljs-subst">${task}</span> completed`</span>);
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">`Result of <span class="hljs-subst">${task}</span>`</span>);
    }, <span class="hljs-number">1000</span>); <span class="hljs-comment">// 每个任务延迟 1 秒</span>
  });
};

<span class="hljs-comment">// 定义任务列表</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> tasks = [
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">'task1'</span>),
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">'task2'</span>),
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">'task3'</span>)
];
</code></pre>
<p>3.  调用</p>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleEquence</span>(<span class="hljs-params"/>){
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">runInSequence</span>(tasks);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'All tasks completed'</span>, result);
  }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42b31c347ea94793aa1cd6726f22d858~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM5LqM5Zub5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765098087&amp;x-signature=X9Ihy%2B83yMznmbeehOXJCjCm%2Bl4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">⌚️ 05. Promise 版“多方等待 ready”机制</h2>
<blockquote>
<p>这个机制用于让多个任务或组件等待某个条件（如 <code>ready()</code> 方法被调用）满足后再继续执行</p>
</blockquote>
<p><strong>应用场景</strong></p>
<ul>
<li>
<p><strong>多个任务依赖同一个条件</strong>：比如，多个组件在等待某个数据加载完成后再开始执行某个操作</p>
</li>
<li>
<p><strong>等待多个异步任务的准备</strong>：多个异步任务可能依赖某个资源，只有当该资源准备好时，才能继续执行后续操作。</p>
</li>
<li>
<p><strong>协调并发任务的开始</strong>：不同的任务或组件可以等待一个共同的“开始信号”，一旦信号发送，所有等待的任务就可以同时开始。</p>
</li>
</ul>
<hr/>
<ol>
<li>自定义class</li>
</ol>

<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Waiter</span>{
  <span class="hljs-attr">queue</span>: <span class="hljs-built_in">any</span>[];
  <span class="hljs-attr">readyFlag</span>: <span class="hljs-built_in">boolean</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span> = []; <span class="hljs-comment">// 所有等待的任务</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">readyFlag</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 是否已经准备好</span>
  }

  <span class="hljs-title function_">wait</span>(<span class="hljs-params"/>){
    <span class="hljs-comment">// 条件已经准备好了，直接返回一个已解决的 Promise</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">readyFlag</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 将该任务的 Promise 放入 queue 队列中，等待</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">push</span>(r));
    }
  }


  <span class="hljs-title function_">ready</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">readyFlag</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 设置条件已准备好</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-title function_">r</span>()); <span class="hljs-comment">// 遍历队列并触发所有等待的任务</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span> = []; <span class="hljs-comment">// 清空队列</span>
  }
}
</code></pre>
<p>2.  调用</p>

<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">handleReady</span>() {
    const waiter = new <span class="hljs-built_in">Waiter</span>();

    <span class="hljs-comment">// 任务 1：等待条件准备好后执行</span>
    waiter<span class="hljs-selector-class">.wait</span>()<span class="hljs-selector-class">.then</span>(() =&gt; console<span class="hljs-selector-class">.log</span>("Task <span class="hljs-number">1</span> completed"));

    <span class="hljs-comment">// 任务 2：等待条件准备好后执行</span>
    waiter<span class="hljs-selector-class">.wait</span>()<span class="hljs-selector-class">.then</span>(() =&gt; console<span class="hljs-selector-class">.log</span>("Task <span class="hljs-number">2</span> completed"));

    <span class="hljs-comment">// 任务 3：等待条件准备好后执行</span>
    waiter<span class="hljs-selector-class">.wait</span>()<span class="hljs-selector-class">.then</span>(() =&gt; console<span class="hljs-selector-class">.log</span>("Task <span class="hljs-number">3</span> completed"));

    <span class="hljs-comment">// 在 2 秒后，调用 `ready()`，表示条件准备好，所有任务可以执行</span>
    <span class="hljs-built_in">setTimeout</span>(() =&gt; {
      waiter<span class="hljs-selector-class">.ready</span>(); <span class="hljs-comment">// 调用 ready，触发所有等待的任务</span>
    }, <span class="hljs-number">2000</span>);
  }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85e8dc0c19774838afd0065b32db4b17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM5LqM5Zub5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765098087&amp;x-signature=RAAABTMPrGulp5XmjYATqlqtBe8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">06. 可暂停 / 恢复的 setInterval（轮询神器）</h2>
<blockquote>
<p>可以启动、暂停和恢复一个定时任务，而无需重启整个定时器</p>
</blockquote>
<p>🌡️ 场景：页面隐藏暂停轮询，返回恢复</p>
<hr/>
<ol>
<li>自定义class</li>
</ol>

<pre><code class="hljs language-kotlin" lang="kotlin">export <span class="hljs-keyword">class</span> <span class="hljs-title class_">PausableInterval</span>{
  delay: number;
  fn: any;
  timer: any;
  running: boolean;

  <span class="hljs-keyword">constructor</span>(fn: any, delay: number){
    <span class="hljs-keyword">this</span>.fn = fn            <span class="hljs-comment">// 定时任务函数</span>
    <span class="hljs-keyword">this</span>.delay = delay      <span class="hljs-comment">// 定时器的间隔时间（单位：毫秒）</span>
    <span class="hljs-keyword">this</span>.timer = <span class="hljs-literal">null</span>       <span class="hljs-comment">// 存储定时器的标识符</span>
    <span class="hljs-keyword">this</span>.running = <span class="hljs-literal">false</span>    <span class="hljs-comment">// 标记定时器是否正在运行</span>
  }

  start(){
    <span class="hljs-comment">// 如果定时器已经在运行，直接返回，不做重复启动</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.running) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">this</span>.running = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">const</span> tick = () =&gt; {
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.running) <span class="hljs-keyword">return</span> <span class="hljs-comment">// 如果定时器已暂停，则不再继续执行</span>
      <span class="hljs-keyword">this</span>.fn(); <span class="hljs-comment">// 执行定时任务</span>
      <span class="hljs-keyword">this</span>.timer = setTimeout(tick, <span class="hljs-keyword">this</span>.delay) <span class="hljs-comment">// 使用 setTimeout 模拟 setInterval</span>
    }

    tick();
  }

  pause() {
    clearTimeout(<span class="hljs-keyword">this</span>.timer);
    <span class="hljs-keyword">this</span>.running = <span class="hljs-literal">false</span>;
  }

  resume(){
    <span class="hljs-keyword">this</span>.start()
  }
}
</code></pre>
<p>2.  模拟请求</p>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">printMessage</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Task is running..."</span>);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> pausableInterval = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PausableInterval</span>(printMessage, <span class="hljs-number">1000</span>);
</code></pre>
<p>3.  调用</p>

<pre><code class="hljs language-scss" lang="scss">  function <span class="hljs-built_in">handleStartInterval</span>() {
    pausableInterval<span class="hljs-selector-class">.start</span>();

    <span class="hljs-comment">// 停止定时器</span>
    <span class="hljs-built_in">setTimeout</span>(() =&gt; {
      console<span class="hljs-selector-class">.log</span>("Pausing the task...");
      pausableInterval<span class="hljs-selector-class">.pause</span>();
    }, <span class="hljs-number">3000</span>); <span class="hljs-comment">// 3秒后暂停</span>

    <span class="hljs-comment">// 恢复定时器</span>
    <span class="hljs-built_in">setTimeout</span>(() =&gt; {
      console<span class="hljs-selector-class">.log</span>("Resuming the task...");
      pausableInterval<span class="hljs-selector-class">.resume</span>();
    }, <span class="hljs-number">5000</span>); <span class="hljs-comment">// 5秒后恢复</span>
  }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83277d0956db476894307ed2f449d697~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM5LqM5Zub5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765098087&amp;x-signature=KrmmiEK6UKvDhtUqfYUZfa7Zduo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">07. 带最大等待 maxWait 的防抖（搜索框的神）</h2>
<blockquote>
<p>用于优化那些频繁触发的事件，特别是在搜索框、输入框或滚动等高频率操作中，常常用来减少不必要的计算或请求</p>
</blockquote>
<p>💡 场景：搜索请求太多？一招治愈</p>
<hr/>
<ol>
<li>自定义方法</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay, { maxWait = <span class="hljs-number">0</span> } = {}</span>) {
  <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 存放定时器</span>
  <span class="hljs-keyword">let</span> start = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 第一次调用时间</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();  <span class="hljs-comment">// 获取当前时间戳</span>
    <span class="hljs-keyword">if</span> (!start) start = now; <span class="hljs-comment">// 记录第一次调用的时间</span>

    <span class="hljs-built_in">clearTimeout</span>(timer);  <span class="hljs-comment">// 清除之前的定时器，避免多次触发</span>

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">run</span> = (<span class="hljs-params"/>) =&gt; { 
      start = <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 重置 `start`，表示已经执行过操作</span>
      fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);  <span class="hljs-comment">// 执行函数，并传入当前的 `this` 和参数</span>
    };

    <span class="hljs-comment">// 如果到达 `maxWait` 时间，强制执行 `fn`；否则继续延迟执行</span>
    <span class="hljs-keyword">if</span> (maxWait &amp;&amp; now - start &gt;= maxWait) <span class="hljs-title function_">run</span>(); 
    <span class="hljs-keyword">else</span> timer = <span class="hljs-built_in">setTimeout</span>(run, delay);  <span class="hljs-comment">// 在 `delay` 时间后执行</span>
  };
}
</code></pre>
<p>2.  模拟短期内多次触发</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">searchQuery</span>(query) {
  console<span class="hljs-selector-class">.log</span>("Searching for:", query);
}

const debouncedSearch = <span class="hljs-built_in">debounce</span>(searchQuery, <span class="hljs-number">500</span>, { maxWait: <span class="hljs-number">2000</span> });

<span class="hljs-comment">// 模拟用户输入</span>
<span class="hljs-built_in">debouncedSearch</span>("apple");
<span class="hljs-built_in">debouncedSearch</span>("app");
<span class="hljs-built_in">debouncedSearch</span>("appl");
<span class="hljs-built_in">debouncedSearch</span>("apple pie");

</code></pre>
<h2 data-id="heading-7">08. 可取消的异步任务（不要让旧任务留着捣乱）</h2>
<p>场景：页面切换后取消 pending 的 loading。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">cancellable</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> timer
  <span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
    timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">fn</span>()), delay)
  })
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">promise</span>: p, <span class="hljs-attr">cancel</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(timer) }
}
</code></pre>
<h2 data-id="heading-8">9. 时间窗口限流（搜索框请求合并）</h2>
<p>🌈 场景：500ms 内所有输入合并一次请求，节省带宽又快。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createWindowRequester</span>(<span class="hljs-params">fn, ms</span>) {
  <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">let</span> queue = []

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
      queue.<span class="hljs-title function_">push</span>({ args, resolve })

      <span class="hljs-keyword">if</span> (!timer) {
        timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">async</span> () =&gt; {
          <span class="hljs-keyword">const</span> batch = [...queue]
          queue = []
          timer = <span class="hljs-literal">null</span>

          <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>(batch.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> i.<span class="hljs-property">args</span>))
          batch.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, i</span>) =&gt;</span> item.<span class="hljs-title function_">resolve</span>(res[i]))
        }, ms)
      }
    })
  }
}
</code></pre>
<h2 data-id="heading-9">10. 带优先级任务调度（Mini Scheduler）</h2>
<p>场景：动画、后台任务、预加载策略。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Scheduler</span> {
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.queue = []
    <span class="hljs-keyword">this</span>.running = <span class="hljs-literal">false</span>
  }
  add(fn, priority = <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">this</span>.queue.push({ fn, priority })
    <span class="hljs-keyword">this</span>.queue.sort((a, b) =&gt; b.priority - a.priority)
    <span class="hljs-keyword">this</span>.run()
  }
  async run() {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.running) <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">this</span>.running = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.queue.length) {
      <span class="hljs-keyword">const</span> job = <span class="hljs-keyword">this</span>.queue.shift()
      await job.fn()
    }
    <span class="hljs-keyword">this</span>.running = <span class="hljs-literal">false</span>
  }
}
</code></pre>
<h2 data-id="heading-10">12. 并行预加载 + 串行渲染（列表加载体验优化）</h2>
<p>🎨 场景：图片墙“先加载、再有序渲染”。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">preloadAndRender</span>(<span class="hljs-params">urls, render</span>) {
  <span class="hljs-keyword">const</span> preloads = urls.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> <span class="hljs-title function_">fetch</span>(url).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">blob</span>()))
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; preloads.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> preloads[i]
    <span class="hljs-title function_">render</span>(data, i)
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 实现微信读书的仿真翻页]]></title>    <link>https://juejin.cn/post/7577705544875737126</link>    <guid>https://juejin.cn/post/7577705544875737126</guid>    <pubDate>2025-11-30T07:35:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544875737126" data-draft-id="7577705544875720742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 实现微信读书的仿真翻页"/> <meta itemprop="keywords" content="Swift,SwiftUI,iOS"/> <meta itemprop="datePublished" content="2025-11-30T07:35:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="非专业程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1968539883540688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 实现微信读书的仿真翻页
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1968539883540688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    非专业程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:35:28.000Z" title="Sun Nov 30 2025 07:35:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">先看效果</h2>
<p>仿真翻页效果：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8311c30834214fc3b6c2ec2da052571f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092928&amp;x-signature=qh7CDoBP93l1Tb3%2FnlJluYJIvgE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>普通翻页效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4de85ec3e00e4fccb327e7464964d255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092928&amp;x-signature=RrivirgEXFpJJRoYQojgHjuk%2BT8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-1">实现方案</h2>
<p>iOS 中实现翻页效果比较简单，直接使用系统提供的 UIPageViewController 即可做到。</p>
<p>UIPageViewController 是 UIKit 中的分页控制器，它允许用户通过横向或纵向滑动手势在多个页面（ViewController）之间切换，主要配置的两个属性如下：</p>
<p>1）<code>UIPageViewControllerTransitionStyle</code></p>
<ul>
<li><code>.pageCurl</code>：仿真翻页</li>
<li><code>.scroll</code>：类似 UIScrollView 自然滑动</li>
</ul>
<p>2）<code>UIPageViewControllerNavigationOrientation</code></p>
<ul>
<li><code>.horizontal</code>：左右翻页</li>
<li><code>.vertical</code>：上下翻页</li>
</ul>
<p>以仿真翻页配置为例子：</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BookReaderViewController</span>: <span class="hljs-title class_">UIViewController</span> {

    <span class="hljs-comment">// 模拟书籍数据</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> bookPages <span class="hljs-operator">=</span> [
        <span class="hljs-string">"第一章：Swift 的起源<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>Swift 是一种由 Apple 开发的强大且直观的编程语言..."</span>,
        <span class="hljs-string">"第二章：UIKit 基础<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>UIKit 提供了构建 iOS 应用程序所需的关键对象..."</span>,
        <span class="hljs-string">"第三章：动画艺术<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>核心动画 (Core Animation) 是 iOS 界面流畅的关键..."</span>,
        <span class="hljs-string">"第四章：高级翻页<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>UIPageViewController 是实现仿真翻页的神器..."</span>,
        <span class="hljs-string">"终章：未来展望<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>随着 SwiftUI 的普及，声明式 UI 正在改变世界..."</span>
    ]

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> pageViewController: <span class="hljs-type">UIPageViewController</span>!

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        setupPageViewController()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">setupPageViewController</span>() {
        <span class="hljs-comment">// 关键设置：transitionStyle = .pageCurl (仿真翻页效果)</span>
        <span class="hljs-comment">// navigationOrientation = .horizontal (水平翻页)</span>
        pageViewController <span class="hljs-operator">=</span> <span class="hljs-type">UIPageViewController</span>(transitionStyle: .pageCurl,
                                                  navigationOrientation: .horizontal,
                                                  options: <span class="hljs-literal">nil</span>)

        pageViewController.dataSource <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>
        pageViewController.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>

        <span class="hljs-comment">// 设置初始页面</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> firstPage <span class="hljs-operator">=</span> getViewController(at: <span class="hljs-number">0</span>) {
            pageViewController.setViewControllers([firstPage], direction: .forward, animated: <span class="hljs-literal">false</span>, completion: <span class="hljs-literal">nil</span>)
        }

        <span class="hljs-comment">// 将 PageVC 添加到当前 VC</span>
        addChild(pageViewController)
        view.addSubview(pageViewController.view)
        pageViewController.view.frame <span class="hljs-operator">=</span> view.bounds
        pageViewController.didMove(toParent: <span class="hljs-keyword">self</span>)

        <span class="hljs-comment">// 解决仿真翻页背面颜色问题 (让背面也是纸张色，而不是默认的半透明或白色)</span>
        <span class="hljs-comment">// 注意：这是一个比较 Hack 的方法，更完美的做法是自定义背面的 Layer</span>
        pageViewController.view.backgroundColor <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>(red: <span class="hljs-number">248</span><span class="hljs-operator">/</span><span class="hljs-number">255</span>, green: <span class="hljs-number">241</span><span class="hljs-operator">/</span><span class="hljs-number">255</span>, blue: <span class="hljs-number">227</span><span class="hljs-operator">/</span><span class="hljs-number">255</span>, alpha: <span class="hljs-number">1.0</span>)
    }

    <span class="hljs-comment">// 辅助方法：根据索引获取 VC</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">getViewController</span>(<span class="hljs-params">at</span> <span class="hljs-params">index</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">BookPageViewController</span>? {
        <span class="hljs-keyword">guard</span> index <span class="hljs-operator">&gt;=</span> <span class="hljs-number">0</span> <span class="hljs-operator">&amp;&amp;</span> index <span class="hljs-operator">&lt;</span> bookPages.count <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> }
        <span class="hljs-keyword">return</span> <span class="hljs-type">BookPageViewController</span>(index: index, totalPage: bookPages.count, content: bookPages[index])
    }
}

<span class="hljs-comment">// MARK: - 3. DataSource 实现 (核心逻辑)</span>
<span class="hljs-keyword">extension</span> <span class="hljs-title class_">BookReaderViewController</span>: <span class="hljs-title class_">UIPageViewControllerDataSource</span> {

    <span class="hljs-comment">// 获取"上一页"</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">pageViewController</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">pageViewController</span>: <span class="hljs-type">UIPageViewController</span>, <span class="hljs-params">viewControllerBefore</span> <span class="hljs-params">viewController</span>: <span class="hljs-type">UIViewController</span>) -&gt; <span class="hljs-type">UIViewController</span>? {
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> currentVC <span class="hljs-operator">=</span> viewController <span class="hljs-keyword">as?</span> <span class="hljs-type">BookPageViewController</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> }
        <span class="hljs-keyword">let</span> previousIndex <span class="hljs-operator">=</span> currentVC.pageIndex <span class="hljs-operator">-</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> getViewController(at: previousIndex)
    }

    <span class="hljs-comment">// 获取"下一页"</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">pageViewController</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">pageViewController</span>: <span class="hljs-type">UIPageViewController</span>, <span class="hljs-params">viewControllerAfter</span> <span class="hljs-params">viewController</span>: <span class="hljs-type">UIViewController</span>) -&gt; <span class="hljs-type">UIViewController</span>? {
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> currentVC <span class="hljs-operator">=</span> viewController <span class="hljs-keyword">as?</span> <span class="hljs-type">BookPageViewController</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> }
        <span class="hljs-keyword">let</span> nextIndex <span class="hljs-operator">=</span> currentVC.pageIndex <span class="hljs-operator">+</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> getViewController(at: nextIndex)
    }
}

<span class="hljs-comment">// MARK: - 4. Delegate (可选，用于处理翻页后的状态)</span>
<span class="hljs-keyword">extension</span> <span class="hljs-title class_">BookReaderViewController</span>: <span class="hljs-title class_">UIPageViewControllerDelegate</span> {
    <span class="hljs-comment">// 这里可以处理 spineLocation，例如横屏时显示双页</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">pageViewController</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">pageViewController</span>: <span class="hljs-type">UIPageViewController</span>, <span class="hljs-params">spineLocationFor</span> <span class="hljs-params">orientation</span>: <span class="hljs-type">UIInterfaceOrientation</span>) -&gt; <span class="hljs-type">UIPageViewController</span>.<span class="hljs-type">SpineLocation</span> {
        <span class="hljs-comment">// 手机竖屏通常是单页 (.min)</span>
        <span class="hljs-keyword">return</span> .min
    }
}
</code></pre>
<p>如上不到百行的代码即可实现仿真翻页效果，手势在 UIPageViewController 中会自动处理，外部不用感知。</p>
<p>和 UITableView 使用类似，需要通过 UIPageViewControllerDataSource 来提供上一页和下一页的数据源，通过 UIPageViewControllerDelegate 来感知翻页时机。</p>
<p>UIPageViewControllerDelegate 主要提供三个时机：</p>
<p>1）<code>willTransitionTo</code>：当用户开始滑动翻页的时候触发，系统已经准备好目标页，通过该回调来告诉你将要显示哪个页面（pendingViewControllers）</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-comment">/// pendingViewControllers: 将要显示的页面</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">pageViewController</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">pageViewController</span>: <span class="hljs-type">UIPageViewController</span>,
                        <span class="hljs-params">willTransitionTo</span> <span class="hljs-params">pendingViewControllers</span>: [<span class="hljs-type">UIViewController</span>])
</code></pre>
<p>2）<code>didFinishAnimating</code>：当用户的翻页动画结束时回调</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-comment">/// finished: 动画是否完成</span>
<span class="hljs-comment">/// previousViewControllers: 原来显示的ViewController</span>
<span class="hljs-comment">/// completed: 最终是否翻页成功；比如滑一半又拖回去，不会真正翻页</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">pageViewController</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">pageViewController</span>: <span class="hljs-type">UIPageViewController</span>,
                        <span class="hljs-params">didFinishAnimating</span> <span class="hljs-params">finished</span>: <span class="hljs-type">Bool</span>,
                        <span class="hljs-params">previousViewControllers</span>: [<span class="hljs-type">UIViewController</span>],
                        <span class="hljs-params">transitionCompleted</span> <span class="hljs-params">completed</span>: <span class="hljs-type">Bool</span>)
</code></pre>
<p>3）<code>spineLocationFor</code>：控制仿真书本翻页时 “书脊” 的位置，只在 UIPageViewControllerTransitionStyle 为 pageCurl 时有效</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-comment">/// SpineLocation:</span>
<span class="hljs-comment">/// - none: 没书脊</span>
<span class="hljs-comment">/// - min: 书脊在左边（单页模式）</span>
<span class="hljs-comment">/// - mid: 书脊在中间（双页模式）</span>
<span class="hljs-comment">/// - max: 书脊在右边（单页模式）</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">pageViewController</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">pageViewController</span>: <span class="hljs-type">UIPageViewController</span>,
                        <span class="hljs-params">spineLocationFor</span> <span class="hljs-params">orientation</span>: <span class="hljs-type">UIInterfaceOrientation</span>)
-&gt; <span class="hljs-type">UIPageViewController</span>.<span class="hljs-type">SpineLocation</span>
</code></pre>
<p>如果要配置普通翻页效果，只需要修改 UIPageViewController 的配置即可：</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-comment">// Options: 设置页面之间的间距 (微信读书一般有 10-20pt 的间距)</span>
<span class="hljs-keyword">let</span> options: [<span class="hljs-type">UIPageViewController</span>.<span class="hljs-type">OptionsKey</span>: <span class="hljs-keyword">Any</span>] <span class="hljs-operator">=</span> [
    .interPageSpacing: <span class="hljs-number">20</span>
]

<span class="hljs-comment">// 核心修改 1: transitionStyle 改为 .scroll</span>
pageViewController <span class="hljs-operator">=</span> <span class="hljs-type">UIPageViewController</span>(transitionStyle: .scroll,
                                          navigationOrientation: .horizontal,
                                          options: options)
</code></pre>
<p>另外翻页手势通常和系统的侧滑返回手势有冲突，可以手动禁用手势来解决；类似微信读书一样，在导航栏出现时才开启侧滑返回手势，否则禁用侧滑返回：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">private</span> func <span class="hljs-title function_">updateGesture</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> isNaviBarHidden { <span class="hljs-comment">// 导航栏隐藏：禁用侧滑，开启翻页手势</span>
        navigationController?.<span class="hljs-property">interactivePopGestureRecognizer</span>?.<span class="hljs-property">isEnabled</span> = <span class="hljs-literal">false</span>
        <span class="hljs-keyword">for</span> gesture <span class="hljs-keyword">in</span> pageViewController.<span class="hljs-property">gestureRecognizers</span> {
            gesture.<span class="hljs-property">isEnabled</span> = <span class="hljs-literal">true</span>
        }
    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 导航栏显示：开启侧滑，禁用翻页手势</span>
        navigationController?.<span class="hljs-property">interactivePopGestureRecognizer</span>?.<span class="hljs-property">isEnabled</span> = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">for</span> gesture <span class="hljs-keyword">in</span> pageViewController.<span class="hljs-property">gestureRecognizers</span> {
            gesture.<span class="hljs-property">isEnabled</span> = <span class="hljs-literal">false</span>
        }
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[优化App启动时间？startup-coroutine是什么？]]></title>    <link>https://juejin.cn/post/7577702891273994275</link>    <guid>https://juejin.cn/post/7577702891273994275</guid>    <pubDate>2025-11-30T07:13:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273994275" data-draft-id="7577713754563428404" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="优化App启动时间？startup-coroutine是什么？"/> <meta itemprop="keywords" content="Kotlin,架构,性能优化"/> <meta itemprop="datePublished" content="2025-11-30T07:13:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="年小个大"/> <meta itemprop="url" content="https://juejin.cn/user/1855631359213688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            优化App启动时间？startup-coroutine是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631359213688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    年小个大
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:13:35.000Z" title="Sun Nov 30 2025 07:13:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">那个让我头疼的启动问题</h2>
<p>事情要从我们公司的新项目说起。那时候我们的应用集成了好多第三方 SDK：推送、统计、地图、IM、广告...你懂的，现在的 App 不接十几个 SDK 都不好意思上线。</p>
<p>由于SDK初始化时间过长，导致Splash Activity首屏一直卡在白屏界面，还需要编写各种xml背景图进行填充，很是头疼。</p>
<p>最开始我的 Application 是这样的：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApp</span> : <span class="hljs-type">Application</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        
        <span class="hljs-comment">// 一堆初始化代码</span>
        Push.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)      <span class="hljs-comment">// 推送</span>
        Analytics.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>) <span class="hljs-comment">// 统计</span>
        Map.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)       <span class="hljs-comment">// 地图</span>
        IM.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)        <span class="hljs-comment">// 即时通讯</span>
        Ad.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)        <span class="hljs-comment">// 广告</span>
        <span class="hljs-comment">// ... 还有更多</span>
        
        <span class="hljs-comment">// 自己的业务初始化</span>
        initDatabase()
        initConfig()
        initUser()
    }
}
</code></pre>
<p><strong>结果就是：</strong></p>
<ul>
<li>用户点开 App 要等 3-5 秒才能看到界面</li>
<li>所有初始化都在主线程排队执行，一个卡住后面全等着</li>
<li>代码越来越乱，新同事根本不敢动这块代码</li>
<li>测试经常报 ANR（应用无响应）</li>
</ul>
<h2 data-id="heading-1">寻找解决方案的折腾过程</h2>
<h3 data-id="heading-2">第一站：多线程方案</h3>
<p>我首先想到的是用多线程：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> thread1 = thread { Push.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>) } <span class="hljs-comment">//kotlin函数</span>
<span class="hljs-keyword">val</span> thread2 = thread { Analytics.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>) }
<span class="hljs-comment">// 启动所有线程...</span>
</code></pre>
<p><strong>结果发现问题更多：</strong></p>
<ul>
<li>线程创建开销大</li>
<li>依赖关系处理起来特别麻烦</li>
<li>异常处理很头疼</li>
<li>代码变得超级复杂</li>
</ul>
<h3 data-id="heading-3">第二站：Jetpack AppStartup</h3>
<p>然后我发现了 Google 的 AppStartup，心想官方出品应该很靠谱吧！</p>
<p>用了一段时间发现：</p>
<ul>
<li>它只是把初始化代码从 Application 移到了各个 Initializer 里</li>
<li><strong>关键问题：所有初始化还是在主线程执行的！</strong></li>
<li>启动时间根本没减少，只是代码看起来整齐了点</li>
<li>复杂的依赖关系写起来还是很麻烦</li>
</ul>
<p>AppStartup 更像是一个代码组织工具，而不是性能优化工具。</p>
<h3 data-id="heading-4">灵光一现：为什么不用协程？</h3>
<p>就在我快要放弃的时候，突然想到：我们项目已经在用 Kotlin 协程了，为什么不用协程来解决这个问题呢？</p>
<p>协程的轻量级、灵活的线程调度、简洁的异步表达，不正是我们需要的吗？</p>
<p>于是，我开始动手写 <code>startup-coroutine</code>。</p>
<h2 data-id="heading-5">框架设计</h2>
<h3 data-id="heading-6">核心想法：把初始化当成有依赖关系的任务</h3>
<p>借鉴App Startup,但是它是串行初始化,我呢允许并行初始化。</p>
<p>我想象中的理想状态是：</p>
<ul>
<li>每个初始化任务都是独立的</li>
<li>可以声明它依赖哪些其他任务</li>
<li>没有依赖关系的任务可以并行执行</li>
<li>使用拓扑排序自动处理依赖关系，按正确顺序执行</li>
</ul>
<p>于是就有了 <code>Initializer</code> 接口：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Initializer</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(app: <span class="hljs-type">Application</span>, provider: <span class="hljs-type">DependenciesProvider</span>)</span></span>: T
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;KClass&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; = emptyList()
}
</code></pre>
<h3 data-id="heading-7">线程调度的灵活控制</h3>
<p>我提供了几种预设的线程策略：</p>
<ul>
<li><code>AllIO</code>：全在 IO 线程，适合耗时任务</li>
<li><code>ExecuteOnIO</code>：IO 线程执行，主线程创建框架</li>
<li><code>AllMain</code>：全在主线程，只适合轻量任务</li>
<li><code>Default</code>：默认推荐，框架在 IO 线程，任务在主线程</li>
</ul>
<p>这样大家可以根据自己项目的实际情况选择。</p>
<p>由于协程的<code>suspend</code>函数可以灵活的切换调度线程,所以可以全部在Main线程执行,然后具体的处理业务自由使用<code>withContext(Dispatchers.IO){...}</code>来切换.</p>
<h2 data-id="heading-8">BaseActivity 的封装</h2>
<p>这个设计源于我们遇到的一个真实问题：</p>
<p><strong>问题场景：</strong> 用户正在使用 App，突然来了个电话或者切换到其他应用，这时候系统可能因为内存不足把我们的应用进程给杀掉了。当用户再切回来时，系统会重新创建 Application 和用户最后看到的 Activity。</p>
<p><strong>这时候就出问题了：</strong> Application构建完成后,执行Startup的初始化,由于Startup是协程框架,它不阻塞UI,于是还没有等待Startup初始化结束Activity就开始创建了,此时Activity 在 onCreate 时可能会使用那些还没重新初始化的 SDK，结果就是各种空指针异常和崩溃。</p>
<p><strong>我的解决方案：</strong> 在 BaseActivity 里统一监听初始化状态。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        observeStartup() <span class="hljs-comment">// 关键的一行！</span>
    }
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">observeStartup</span><span class="hljs-params">()</span></span> {
        Startup.observe(<span class="hljs-keyword">this</span>) { result -&gt;
            <span class="hljs-keyword">when</span> (result) {
                StartupResult.Idle -&gt; showLoading() <span class="hljs-comment">// 还没初始化，显示加载</span>
                StartupResult.Success -&gt; {
                    hideLoading()
                    onInitFinished() <span class="hljs-comment">// 初始化完成，继续正常流程</span>
                }
                <span class="hljs-keyword">is</span> StartupResult.Failure -&gt; {
                    hideLoading()
                    <span class="hljs-comment">// 处理初始化失败</span>
                }
            }
        }
    }
}
</code></pre>
<p><strong>这样设计的好处：</strong></p>
<ol>
<li><strong>进程重启无忧</strong>：即使进程被杀死重建，也能保证 SDK 先初始化再使用</li>
<li><strong>统一加载状态</strong>：所有页面都有统一的加载体验</li>
<li><strong>错误统一处理</strong>：初始化失败时有统一的错误处理机制</li>
<li><strong>代码复用</strong>：每个 Activity 都不用自己写初始化监听逻辑</li>
</ol>
<p><code>Startup.observe</code>内部是使用LiveData实现的.目的是为了每个页面监听的时候都可以拿到初始化数据信息.</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Startup</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> implementation: IStartup
) : IStartup {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _isInitialized = MutableLiveData&lt;StartupResult&gt;(StartupResult.Idle)

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">observe</span><span class="hljs-params">(owner: <span class="hljs-type">LifecycleOwner</span>, observer: <span class="hljs-type">Observer</span>&lt;<span class="hljs-type">StartupResult</span>&gt;)</span></span> {
            _isInitialized.observe(owner, observer)
        }

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isInitialized</span><span class="hljs-params">()</span></span> = _isInitialized.value != StartupResult.Idle

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initializedResult</span><span class="hljs-params">()</span></span> = _isInitialized.value

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">reset</span><span class="hljs-params">()</span></span> {
            _isInitialized.postValue(StartupResult.Idle)
        }
        <span class="hljs-keyword">internal</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">markInitializedResult</span><span class="hljs-params">(result: <span class="hljs-type">StartupResult</span>)</span></span> {
            _isInitialized.postValue(result)
        }
    }

</code></pre>
<h2 data-id="heading-9">隐私协议处理的巧妙设计</h2>
<p>现在隐私合规要求很严格，很多 SDK 必须在用户同意隐私协议后才能初始化。我的框架也很好的解决了这个问题：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApp</span> : <span class="hljs-type">Application</span>() {

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> startup: Startup

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startInit</span><span class="hljs-params">()</span></span> {
            startup.start()
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        <span class="hljs-comment">//轻量级数据存储推荐直接初始化,用于进行判断逻辑.</span>
        SpUtils.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)

        <span class="hljs-comment">//构建初始化任务列表.</span>
        <span class="hljs-keyword">val</span> initializer = listOf(
            AdMobInit(),
            AppConfigInit(),
            FlutterEngineInit(),
            FistInitializer(),
            IMInit(),
            MapSdkInit(),
            ExceptionInit()
        )
        <span class="hljs-comment">//构建startup</span>
        startup = Startup.Builder(<span class="hljs-keyword">this</span>)
            .setDispatchers(StartupDispatchers.AllIO)
            .setDebug(<span class="hljs-literal">true</span>)
            .add(initializer)
            .build()

        <span class="hljs-comment">//推荐!!!</span>
        <span class="hljs-comment">//如果App跳过了手动初始化,就必须做判断,只要条件允许第二次初始化的时候</span>
        <span class="hljs-comment">//一定在Application中直接执行.</span>
        <span class="hljs-comment">//这里涉及到了一些进程重启逻辑.</span>
        <span class="hljs-keyword">if</span> (SpUtils.getBoolean(<span class="hljs-string">"isAgreePrivacy"</span>,<span class="hljs-literal">false</span>)) {
            startInit()
        }
    }

}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SplashActivity</span> : <span class="hljs-type">BaseActivity</span>() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkPrivacy</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (用户已同意隐私协议) {
            <span class="hljs-comment">// 开始初始化</span>
            MyApp.startInit()
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 显示隐私协议弹窗</span>
            showPrivacyDialog {
                <span class="hljs-comment">// 用户同意后开始初始化</span>
                MyApp.startInit()
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-10">实际效果怎么样？</h2>
<p>用了 <code>startup-coroutine</code> 之后：</p>
<ul>
<li><strong>启动时间</strong>：从 3-5 秒优化到 1-2 秒</li>
<li><strong>代码可维护性</strong>：新同事也能轻松添加新的初始化任务</li>
<li><strong>稳定性</strong>：再也没有因为进程重启导致的崩溃</li>
<li><strong>开发体验</strong>：调试时可以清楚看到每个任务的执行时间和依赖关系</li>
</ul>
<h2 data-id="heading-11">怎么集成使用？</h2>
<p>集成超级简单：</p>
<ol>
<li><strong>添加依赖：</strong></li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin">implementation(<span class="hljs-string">"com.github.Dboy233:startup-coroutine:最新版本"</span>)
</code></pre>
<ol start="2">
<li><strong>定义初始化任务：</strong></li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-comment">//如果没有依赖可不重写此方法</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span> = listOf(OtherInitializer::<span class="hljs-keyword">class</span>)
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(app: <span class="hljs-type">Application</span>, provider: <span class="hljs-type">DependenciesProvider</span>)</span></span> {
        <span class="hljs-comment">// 你的初始化代码</span>
    }
}
</code></pre>
<ol start="3">
<li><strong>在 Application 中配置：</strong></li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> startup = Startup.Builder(<span class="hljs-keyword">this</span>)
    .add(MyInitializer())
    .setDispatchers(StartupDispatchers.ExecuteOnIO)
    .build()
</code></pre>
<ol start="4">
<li><strong>让 Activity 继承 BaseActivity</strong>（或者自己实现初始化监听）</li>
</ol>
<h2 data-id="heading-12">实际应用日志</h2>
<pre><code class="hljs language-text" lang="text">
--- Startup Coroutine Dependency Graph ---
    
    FlutterEngineInit
    FistInitializer
    ExceptionInit
    AppConfigInit
      └─ FistInitializer
    AdMobInit
      └─ AppConfigInit
    IMInit
      └─ AppConfigInit
    MapSdkInit
      └─ AppConfigInit
    
----------------------------------------


--- Startup Coroutine Performance Summary ---

&gt;&gt; Total Time: 2538ms  |  Status: FAILED
&gt;&gt; Dispatchers Mode: All-IO

&gt;&gt; Individual Task Durations:
   - FlutterEngineInit  |  2503ms  |  Thread: DefaultDispatcher-worker-5
   - IMInit             |  2000ms  |  Thread: DefaultDispatcher-worker-5
   - AdMobInit          |  1832ms  |  Thread: DefaultDispatcher-worker-4
   - MapSdkInit         |  601ms   |  Thread: DefaultDispatcher-worker-4
   - AppConfigInit      |  102ms   |  Thread: DefaultDispatcher-worker-5
   - FistInitializer    |  0ms     |  Thread: DefaultDispatcher-worker-4
   - ExceptionInit      |  -1ms    |  Thread: Error
&gt;&gt; Task time is sum  : 7037 ms
</code></pre>
<p>打印初始化结果，可以看到使用协程框架后整体初始化从7秒优化到了1坤秒(2.5秒)。</p>
<p>效果还是立竿见影的，关键是它的初始化不占用UI渲染时间，让UI过度不出现卡顿白屏。</p>
<p>如果你在Log中看到了两次日志输出，不要紧张,它不是执行了两次,而仅仅只是打印两次。</p>
<pre><code class="hljs language-vbscript" lang="vbscript">Log.i(<span class="hljs-string">"StartupCoroutine"</span>, logContent.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>())
println(logContent.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>())
</code></pre>
<p>因为Test阶段的时候Log是不输出内容的，所以使用println再打印了一遍.你只需要过滤<code>StartupCoroutine</code>日志即可。</p>
<h2 data-id="heading-13">写在最后</h2>
<p>开发 <code>startup-coroutine</code> 的过程让我深刻体会到：好的框架不是凭空想象出来的，而是从真实的业务痛点中生长出来的。</p>
<p>我现在把这个框架开源出来，一方面是希望帮助到有同样问题的开发者，另一方面也是想听听大家的想法，看看能不能一起把它做得更好。</p>
<p>如果你也在为应用启动优化而烦恼，不妨试试 <code>startup-coroutine</code>。如果你有任何建议或者发现了什么问题，欢迎来 GitHub 给我提 Issue 或者 PR。</p>
<p><strong>项目地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDboy233%2Fstartup-coroutine" target="_blank" title="https://github.com/Dboy233/startup-coroutine" ref="nofollow noopener noreferrer"><code>https://github.com/Dboy233/startup-coroutine</code></a></p>
<p>希望我的这个小工具能帮到你，也期待听到你的使用反馈！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[批量商品信息采集工具获取商品详情的完整方案]]></title>    <link>https://juejin.cn/post/7577690150093570088</link>    <guid>https://juejin.cn/post/7577690150093570088</guid>    <pubDate>2025-11-30T07:26:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150093570088" data-draft-id="7577683422878810146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="批量商品信息采集工具获取商品详情的完整方案"/> <meta itemprop="keywords" content="数据分析,数据挖掘,爬虫"/> <meta itemprop="datePublished" content="2025-11-30T07:26:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户4142929607239"/> <meta itemprop="url" content="https://juejin.cn/user/2579871227198947"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            批量商品信息采集工具获取商品详情的完整方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2579871227198947/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户4142929607239
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:26:47.000Z" title="Sun Nov 30 2025 07:26:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99510bb6c4104ed794f17fd42f4a541f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDE0MjkyOTYwNzIzOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092407&amp;x-signature=IQYIBZ%2BzFO3WsyMy8ug9R%2F%2BgmB0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、获取前的准备：官方 API 接入流程</h2>
<h3 data-id="heading-1">1. 平台认证与权限申请</h3>
<ul>
<li>
<p><strong>注册淘宝开放平台账号</strong>：访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.taobao.com%2F" title="https://open.taobao.com/" target="_blank" ref="nofollow noopener noreferrer">open.taobao.com</a>，完成个人 / 企业认证（企业需营业执照）</p>
</li>
<li>
<p><strong>创建应用</strong>：控制台→应用管理→创建应用（选择 "网站应用" 或 "服务器应用"），获取<strong>App Key</strong>和<strong>App Secret</strong>（核心凭证）</p>
</li>
<li>
<p><strong>申请接口权限</strong>：</p>
<ul>
<li><strong>基础详情</strong>：<code>taobao.item.get</code>（单个商品详情）</li>
<li><strong>批量获取</strong>：<code>taobao.item_get_batch</code>（一次最多 50 个商品 ID，需单独申请）</li>
<li><strong>搜索获取 ID</strong>：<code>taobao.items.search</code>（按关键词 / 类目搜索商品）</li>
<li><strong>店铺商品</strong>：<code>taobao.items.onsale.get</code>（获取店铺在售商品列表）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">2. 商品 ID 获取策略（批量采集前提）</h3>






























<table><thead><tr><th>获取方式</th><th>适用场景</th><th>实现方法</th></tr></thead><tbody><tr><td><strong>从已有列表获取</strong></td><td>已有商品链接 / ID</td><td>从 URL 提取末尾数字（如<code>https://item.taobao.com/item.htm?id=123456</code>中的<code>123456</code>）</td></tr><tr><td><strong>搜索获取</strong></td><td>按关键词 / 类目采集</td><td>调用<code>taobao.items.search</code>，指定关键词、页码，获取商品 ID 列表</td></tr><tr><td><strong>店铺全量采集</strong></td><td>监控竞品 / 自有店铺</td><td><code>taobao.items.onsale.get</code>获取店铺所有在售商品 ID</td></tr><tr><td><strong>从其他平台同步</strong></td><td>多平台运营商家</td><td>从京东 / 拼多多等平台商品链接提取 ID，再通过 API 获取淘宝详情</td></tr></tbody></table>
<h2 data-id="heading-3">二、核心实现：批量获取商品详情的技术方案</h2>
<h3 data-id="heading-4">1. 接口选择与调用方式</h3>
<p><strong>方案 A：循环调用单商品接口（简单易实现）</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 伪代码示例</span>
<span class="hljs-function">def <span class="hljs-title">batch_get_items</span>(<span class="hljs-params">app_key, app_secret, item_ids</span>):
    results</span> = []
    <span class="hljs-keyword">for</span> item_id <span class="hljs-keyword">in</span> item_ids:
        <span class="hljs-meta"># 构造请求参数</span>
        <span class="hljs-keyword">params</span> = {
            <span class="hljs-string">'method'</span>: <span class="hljs-string">'taobao.item.get'</span>,
            <span class="hljs-string">'app_key'</span>: app_key,
            <span class="hljs-string">'num_iid'</span>: item_id,
            <span class="hljs-string">'fields'</span>: <span class="hljs-string">'num_iid,title,price,pic_url,desc,sales'</span>  <span class="hljs-meta"># 指定返回字段</span>
        }
        <span class="hljs-meta"># 生成签名</span>
        <span class="hljs-keyword">params</span>[<span class="hljs-string">'sign'</span>] = generate_sign(<span class="hljs-keyword">params</span>, app_secret)
        <span class="hljs-meta"># 发送请求</span>
        response = requests.<span class="hljs-keyword">get</span>(<span class="hljs-string">'https://eco.taobao.com/router/rest'</span>, <span class="hljs-keyword">params</span>=<span class="hljs-keyword">params</span>)
        results.append(response.json())
        time.sleep(<span class="hljs-number">0.5</span>)  <span class="hljs-meta"># 控制频率，避免触发风控</span>
    <span class="hljs-keyword">return</span> results
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>方案 B：使用批量接口（效率更高）</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 伪代码示例：taobao.item_get_batch</span>
<span class="hljs-function">def <span class="hljs-title">batch_get_items</span>(<span class="hljs-params">app_key, app_secret, item_ids</span>):
    # 分批处理（每批最多50个）
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-title">range</span>(<span class="hljs-params"><span class="hljs-number">0</span>, len(item_ids</span>), 50):
        batch_ids</span> = item_ids[i:i+<span class="hljs-number">50</span>]
        <span class="hljs-keyword">params</span> = {
            <span class="hljs-string">'method'</span>: <span class="hljs-string">'taobao.item_get_batch'</span>,
            <span class="hljs-string">'app_key'</span>: app_key,
            <span class="hljs-string">'num_iids'</span>: <span class="hljs-string">','</span>.<span class="hljs-keyword">join</span>(batch_ids),  <span class="hljs-meta"># 商品ID用逗号分隔</span>
            <span class="hljs-string">'fields'</span>: <span class="hljs-string">'num_iid,title,price,pic_url,desc,sales'</span>
        }
        <span class="hljs-keyword">params</span>[<span class="hljs-string">'sign'</span>] = generate_sign(<span class="hljs-keyword">params</span>, app_secret)
        response = requests.<span class="hljs-keyword">get</span>(<span class="hljs-string">'https://eco.taobao.com/router/rest'</span>, <span class="hljs-keyword">params</span>=<span class="hljs-keyword">params</span>)
        <span class="hljs-keyword">yield</span> response.json()  <span class="hljs-meta"># 返回分批结果</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-5">2. 性能优化关键技术</h3>
<p><strong>① 异步并发处理</strong>（适合大规模采集）</p>
<ul>
<li>使用<code>aiohttp</code>替代<code>requests</code>，配合<code>asyncio</code>实现异步并发</li>
<li>设置信号量控制并发数（建议 30-50，避免触发平台限流）</li>
<li>随机延迟（0.3-0.8 秒）避免被识别为爬虫</li>
</ul>
<p><strong>② 字段优化</strong></p>
<ul>
<li>只请求必要字段：<code>fields='num_iid,title,price,pic_url,skus'</code>，减少 65% 带宽消耗</li>
<li>排除不需要的字段（如评价详情、物流信息），提升响应速度</li>
</ul>
<p><strong>③ 缓存机制</strong></p>
<ul>
<li>对热门 / 高频访问商品使用 Redis 缓存（设置 1 小时过期），减少重复调用</li>
</ul>
<h2 data-id="heading-6">三、数据解析与结构化处理</h2>
<h3 data-id="heading-7">1. 响应数据解析流程</h3>
<p>plaintext</p>
<pre><code class="hljs language-javascript" lang="javascript">原始<span class="hljs-title class_">JSON</span> → 基础校验 → 字段提取 → 结构化存储
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>核心字段提取示例：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 从返回结果提取核心信息</span>
<span class="hljs-function">def <span class="hljs-title">parse_item_data</span>(<span class="hljs-params">raw_item</span>):
    <span class="hljs-keyword">return</span></span> {
        <span class="hljs-string">"商品ID"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"num_iid"</span>, <span class="hljs-string">""</span>),
        <span class="hljs-string">"标题"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"title"</span>, <span class="hljs-string">""</span>),
        <span class="hljs-string">"价格"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"price"</span>, <span class="hljs-number">0</span>),
        <span class="hljs-string">"促销价"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"promotion_price"</span>, <span class="hljs-number">0</span>),
        <span class="hljs-string">"主图"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"pic_url"</span>, <span class="hljs-string">""</span>),
        <span class="hljs-string">"销量"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"volume"</span>, <span class="hljs-number">0</span>),
        <span class="hljs-string">"SKU信息"</span>: [sku.<span class="hljs-keyword">get</span>(<span class="hljs-string">"price"</span>, <span class="hljs-number">0</span>) <span class="hljs-keyword">for</span> sku <span class="hljs-keyword">in</span> raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"sku"</span>, {}).<span class="hljs-keyword">get</span>(<span class="hljs-string">"sku_list"</span>, [])]
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-8">2. 特殊情况处理</h3>
<ul>
<li>
<p><strong>HTML 描述处理</strong>：商品描述（desc 字段）含 HTML 标签，需用<code>BeautifulSoup</code>解析提取纯文本或图片 URL</p>
</li>
<li>
<p><strong>嵌套数据处理</strong>：</p>
<p>plaintext</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 解析多级嵌套的卖家信息</span>
seller_info = raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"seller"</span>, {})
<span class="hljs-keyword">return</span> {
    <span class="hljs-string">"店铺名称"</span>: seller_info.<span class="hljs-keyword">get</span>(<span class="hljs-string">"shop_name"</span>, <span class="hljs-string">""</span>),
    <span class="hljs-string">"店铺ID"</span>: seller_info.<span class="hljs-keyword">get</span>(<span class="hljs-string">"user_id"</span>, <span class="hljs-string">""</span>)
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</li>
</ul>
<h2 data-id="heading-9">四、批量采集完整工作流（最佳实践）</h2>
<h3 data-id="heading-10">Step 1：准备阶段</h3>
<ul>
<li>完成 API 权限申请和凭证获取</li>
<li>确定目标商品 ID 列表（通过搜索 / 店铺获取或手动导入）</li>
<li>初始化日志 / 监控系统（记录成功 / 失败案例）</li>
</ul>
<h3 data-id="heading-11">Step 2：批量获取详情（核心环节）</h3>
<p>plaintext</p>
<pre><code class="hljs language-scss" lang="scss">商品ID列表 → 分批(<span class="hljs-number">50</span>个/批) → 调用接口 → 数据解析 → 错误处理 → 存储
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-12">Step 3：错误处理与重试机制（关键保障）</h3>
<p><strong>常见错误及解决方案：</strong></p>



































<table><thead><tr><th>错误类型</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>API 限流</strong></td><td>调用频率超过限制</td><td>增加延迟 (0.5-1 秒)、降低并发数、分批处理</td></tr><tr><td><strong>签名错误</strong></td><td>参数 / 签名生成错误</td><td>检查签名算法、确保参数有序、URL 编码正确</td></tr><tr><td><strong>商品不存在</strong></td><td>ID 错误 / 已下架</td><td>过滤无效 ID，记录日志</td></tr><tr><td><strong>网络波动</strong></td><td>临时连接问题</td><td>实现指数退避重试 (1→2→4→8 秒)，最多 3 次</td></tr><tr><td><strong>权限不足</strong></td><td>缺少必要权限</td><td>检查应用权限，重新申请</td></tr></tbody></table>
<h3 data-id="heading-13">Step 4：数据存储与后续应用</h3>
<ul>
<li>
<p><strong>结构化存储</strong>：存入 MySQL/MongoDB 数据库或导出 CSV/Excel</p>
</li>
<li>
<p><strong>增量更新</strong>：记录已采集商品的最后更新时间，下次只采集更新商品</p>
</li>
<li>
<p><strong>业务应用</strong>：</p>
<ul>
<li>商品信息同步至其他平台</li>
<li>竞品监控（价格 / 库存 / 销量变化）</li>
<li>数据分析与选品参考</li>
<li>商品信息管理系统（PIM）更新</li>
</ul>
</li>
</ul>
<h2 data-id="heading-14">五、关键注意事项（避免踩坑）</h2>
<h3 data-id="heading-15">1. <strong>平台规则遵守</strong></h3>
<ul>
<li>禁止<strong>未经授权的数据抓取</strong>（必须使用官方 API，禁用爬虫）</li>
<li>商品价格等信息<strong>仅限自用</strong>，不得直接倒卖数据获利</li>
<li>遵循<strong>频率限制</strong>：基础接口 QPS≤2-5，批量接口≤1，违规会触发风控（IP 封禁 / 接口禁用）</li>
</ul>
<h3 data-id="heading-16">2. <strong>性能与稳定性优化建议</strong></h3>
<p><strong>必做优化：</strong></p>
<ul>
<li>控制并发数在<strong>30 以下</strong>（建议 10-20）</li>
<li>批次大小 <strong>≤40</strong>（为<code>item_get_batch</code>上限 50 预留安全空间）</li>
<li>每请求间添加<strong>随机延迟</strong>（0.3-1 秒）</li>
<li>使用<strong>异步 + 信号量</strong>控制（提升效率 3-5 倍）</li>
</ul>
<p><strong>可选优化：</strong></p>
<ul>
<li>分时段采集（避开 API 高峰，如 11:00-13:00、20:00-22:00）</li>
<li>对热门商品使用缓存（Redis/Memcached）</li>
<li>监控 API 响应时间，动态调整请求策略</li>
</ul>
<h2 data-id="heading-17">六、总结：批量采集的核心实施路径</h2>
<p>批量商品信息采集工具获取淘宝商品详情的完整链路是：<strong>官方 API 授权 → 商品 ID 获取 → 批量接口调用 → 数据解析处理 → 结构化存储</strong>。</p>
<p><strong>最佳实践总结：</strong></p>
<ul>
<li>优先使用官方 API（合规稳定），禁用爬虫</li>
<li>采用批量接口 + 异步并发（提升效率 10 倍 +）</li>
<li>严格控制频率（QPS&lt;5），添加随机延迟</li>
<li>按需请求字段，减少数据传输量</li>
<li>实现完善的错误处理与重试机制</li>
</ul>
<h2 data-id="heading-18">附：淘宝商品详情接口返回核心字段</h2>























































<table><thead><tr><th>字段名</th><th>说明</th><th>用途</th></tr></thead><tbody><tr><td><strong>num_iid</strong></td><td>商品 ID（唯一标识）</td><td>数据关联、更新判断</td></tr><tr><td><strong>title</strong></td><td>商品标题</td><td>展示、关键词分析</td></tr><tr><td><strong>price</strong></td><td>商品价格</td><td>价格监控、比价</td></tr><tr><td><strong>promotion_price</strong></td><td>促销价</td><td>促销活动分析</td></tr><tr><td><strong>pic_url</strong></td><td>主图 URL</td><td>图片下载、展示</td></tr><tr><td><strong>desc</strong></td><td>商品详情描述（HTML）</td><td>详情页展示、内容分析</td></tr><tr><td><strong>sku</strong></td><td>SKU 信息（规格 / 价格）</td><td>库存管理、规格分析</td></tr><tr><td><strong>volume</strong></td><td>销量</td><td>热度评估、选品参考</td></tr><tr><td><strong>seller</strong></td><td>卖家信息（店铺名 / ID）</td><td>店铺分析、供应商管理</td></tr></tbody></table>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 epub 在手机快乐阅读]]></title>    <link>https://juejin.cn/post/7577958825342074899</link>    <guid>https://juejin.cn/post/7577958825342074899</guid>    <pubDate>2025-11-30T07:27:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577958825342074899" data-draft-id="7577970969395068969" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 epub 在手机快乐阅读"/> <meta itemprop="keywords" content="JavaScript,deno,科幻"/> <meta itemprop="datePublished" content="2025-11-30T07:27:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="穷人小水滴"/> <meta itemprop="url" content="https://juejin.cn/user/134615944418777"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 epub 在手机快乐阅读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/134615944418777/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    穷人小水滴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:27:51.000Z" title="Sun Nov 30 2025 07:27:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近沉迷 AI 小说 (不可自拔) 玩物丧志 (大雾).</p>
<p>那么假如, 是说假如, 窝自己写了一本小说, 如何愉快的阅读它呢 ?</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fcd75f986e34ae78af331a3fd4c6d17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=ZPEEVRD73wOu8rbSx7C78Hp%2BAg0%3D" alt="0-n-1.png" loading="lazy"/></p>
<p>这里是 穷人小水滴, 专注于 穷人友好型 低成本技术. (本文为 86 号作品. )</p>
<hr/>
<p>相关文章:</p>
<ul>
<li>《4 大低成本娱乐方式: 小说, 音乐, 视频, 电子游戏》 <a href="https://juejin.cn/post/7414129923634561035" target="_blank" title="https://juejin.cn/post/7414129923634561035">juejin.cn/post/741412…</a></li>
<li>《在 Android 设备上写代码 (Termux, code-server)》 <a href="https://juejin.cn/post/7510181121205256226" target="_blank" title="https://juejin.cn/post/7510181121205256226">juejin.cn/post/751018…</a></li>
<li>《Android 运行 deno 的新方法 (3): Termux 胖喵安初》 <a href="https://juejin.cn/post/7533510113068761098" target="_blank" title="https://juejin.cn/post/7533510113068761098">juejin.cn/post/753351…</a></li>
<li>《小水滴系列文章目录 (整理)》 <a href="https://juejin.cn/post/7522090635908300838" target="_blank" title="https://juejin.cn/post/7522090635908300838">juejin.cn/post/752209…</a></li>
<li>《自制: 7 天手搓一个拼音输入法》 <a href="https://juejin.cn/post/7343902899095060499" target="_blank" title="https://juejin.cn/post/7343902899095060499">juejin.cn/post/734390…</a></li>
<li>《防误删 (实时) 文件备份系统 (btrfs 快照 + rsync)》 <a href="https://juejin.cn/post/7552509614097924131" target="_blank" title="https://juejin.cn/post/7552509614097924131">juejin.cn/post/755250…</a></li>
<li>《静音键盘简单评测》</li>
<li>《科幻小说计划 (顾雪) (AIGC)》 <a href="https://juejin.cn/post/7577718777481297958" target="_blank" title="https://juejin.cn/post/7577718777481297958">juejin.cn/post/757771…</a></li>
</ul>
<p>参考资料:</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeno.com%2F" target="_blank" title="https://deno.com/" ref="nofollow noopener noreferrer">deno.com/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftermux.dev%2Fen%2F" target="_blank" title="https://termux.dev/en/" ref="nofollow noopener noreferrer">termux.dev/en/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.tuna.tsinghua.edu.cn%2Fhelp%2Ffdroid%2F" target="_blank" title="https://mirrors.tuna.tsinghua.edu.cn/help/fdroid/" ref="nofollow noopener noreferrer">mirrors.tuna.tsinghua.edu.cn/help/fdroid…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwiki.lineageos.org%2Fdevices%2Fviolet%2F" target="_blank" title="https://wiki.lineageos.org/devices/violet/" ref="nofollow noopener noreferrer">wiki.lineageos.org/devices/vio…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Farchlinux.org%2F" target="_blank" title="https://archlinux.org/" ref="nofollow noopener noreferrer">archlinux.org/</a></li>
</ul>
<h2 data-id="heading-0">目录</h2>
<ul>
<li>1 制作 epub 文件 (deno)
<ul>
<li>1.1 程序代码</li>
<li>1.2 工作原理</li>
</ul>
</li>
<li>2 手机阅读软件推荐 (Android F-Droid)</li>
<li>3 实际测试</li>
<li>4 总结与展望</li>
<li>附录 1 "全开源" 软件体系</li>
</ul>
<h2 data-id="heading-1">1 制作 epub 文件 (deno)</h2>
<p>如果使用最基础的 <code>txt</code> (纯文本) 文件, 由于不含任何有关内容的格式, 阅读体验并不好.</p>
<p><strong>epub</strong> 是一种开放的电子书格式标准, 基于 HTML+CSS (XML) 技术, 简单, 被广泛支持, 功能丰富.</p>
<p>于是窝就写了一个很简单的 txt 转 epub 格式的程序, 主要功能有分章, 字数计算等, 代码如下.</p>
<h3 data-id="heading-2">1.1 程序代码</h3>
<p>文件 <code>txt2epub.js</code>:</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// txt2epub.js</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// deno run -A txt2epub.js 1.txt out1</span>

<span class="hljs-comment">// 计算中文字数: 非 ASCII 字符都算</span>
<span class="hljs-keyword">function</span> 字数(文本) {
  <span class="hljs-keyword">let</span> 计数 = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> i <span class="hljs-keyword">of</span> 文本) {
    <span class="hljs-keyword">if</span> (i.<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>) &gt; <span class="hljs-number">127</span>) {
      计数 += <span class="hljs-number">1</span>;
    }
  }
  <span class="hljs-keyword">return</span> 计数;
}

<span class="hljs-comment">// 将输入 txt 文件内容转换成内部数据格式, 并进行分章</span>
<span class="hljs-keyword">function</span> 解析<span class="hljs-title function_">txt</span>(<span class="hljs-params">文本</span>) {
  <span class="hljs-comment">// 全文总字数</span>
  <span class="hljs-keyword">const</span> 总字 = 字数(文本);

  <span class="hljs-comment">// 按 ## 切分章节 (markdown)</span>
  <span class="hljs-keyword">const</span> 部分 = 文本.<span class="hljs-title function_">split</span>(<span class="hljs-string">"\n## "</span>);

  <span class="hljs-comment">// 章节的第 1 行是标题</span>
  <span class="hljs-keyword">const</span> 章 = 部分.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> 行 = i.<span class="hljs-title function_">split</span>(<span class="hljs-string">"\n"</span>);

    <span class="hljs-comment">// 章节正文字数</span>
    <span class="hljs-keyword">const</span> 字 = 字数(行.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>));

    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 标题 (字数)</span>
      标题: 行[<span class="hljs-number">0</span>] + <span class="hljs-string">" ("</span> + 字 + <span class="hljs-string">")"</span>,
      段: 行.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>),
    };
  });

  <span class="hljs-comment">// 书名为第 1 行</span>
  <span class="hljs-comment">// 总字数 (k 计数)</span>
  <span class="hljs-keyword">const</span> 总字k = (总字 / <span class="hljs-number">1000</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> {
    标题: 章[<span class="hljs-number">0</span>].标题 + <span class="hljs-string">" ("</span> + 总字k + <span class="hljs-string">"k)"</span>,
    章,
  };
}

<span class="hljs-comment">// 读取 txt 文件并解析</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> 加载<span class="hljs-title function_">txt</span>(<span class="hljs-params">文件</span>) {
  <span class="hljs-keyword">const</span> 文本 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Deno</span>.<span class="hljs-title function_">readTextFile</span>(文件);
  <span class="hljs-keyword">return</span> 解析<span class="hljs-title function_">txt</span>(文本);
}

<span class="hljs-comment">// 生成 uuid</span>
<span class="hljs-keyword">function</span> 造<span class="hljs-title function_">uuid</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">randomUUID</span>();
}

<span class="hljs-comment">// 渲染 epub</span>

<span class="hljs-comment">// out/mimetype</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">mimetype</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`application/epub+zip`</span>;
}

<span class="hljs-comment">// out/META-INF/container.xml</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">container_xml</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;container
  version="1.0"
  xmlns="urn:oasis:names:tc:opendocument:xmlns:container"
&gt;
  &lt;rootfiles&gt;
    &lt;rootfile
      full-path="OEBPS/content.opf"
      media-type="application/oebps-package+xml"
    /&gt;
  &lt;/rootfiles&gt;
&lt;/container&gt;
`</span>;
}

<span class="hljs-comment">// out/OEBPS/content.opf</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">content_opf</span>(<span class="hljs-params">数据</span>) {
  <span class="hljs-keyword">const</span> uuid = 造<span class="hljs-title function_">uuid</span>();

  <span class="hljs-keyword">const</span> item = 数据.章.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, 序号</span>) =&gt;</span>
    <span class="hljs-string">`    &lt;item id="item<span class="hljs-subst">${序号}</span>" href="xhtml/<span class="hljs-subst">${序号}</span>.xhtml" media-type="application/xhtml+xml" /&gt;`</span>
  );
  <span class="hljs-keyword">const</span> itemref = 数据.章.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, 序号</span>) =&gt;</span>
    <span class="hljs-string">`    &lt;itemref idref="item<span class="hljs-subst">${序号}</span>" /&gt;`</span>
  );

  <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;package
  xmlns="http://www.idpf.org/2007/opf"
  version="3.0"
  unique-identifier="pub-id"
&gt;
  &lt;metadata xmlns:dc="http://purl.org/dc/elements/1.1/"&gt;
    &lt;dc:title&gt;<span class="hljs-subst">${数据.标题}</span>&lt;/dc:title&gt;
    &lt;dc:creator&gt;you&lt;/dc:creator&gt;
    &lt;dc:identifier id="pub-id"
    &gt;urn:uuid:<span class="hljs-subst">${uuid}</span>&lt;/dc:identifier&gt;
  &lt;/metadata&gt;

  &lt;manifest&gt;
    &lt;item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml" /&gt;
    &lt;item id="css" href="style.css" media-type="text/css" /&gt;

<span class="hljs-subst">${item.join(<span class="hljs-string">"\n"</span>)}</span>
  &lt;/manifest&gt;

  &lt;spine toc="ncx"&gt;
<span class="hljs-subst">${itemref.join(<span class="hljs-string">"\n"</span>)}</span>
  &lt;/spine&gt;
&lt;/package&gt;
`</span>;
}

<span class="hljs-comment">// out/OEBPS/toc.ncx</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">toc_ncx</span>(<span class="hljs-params">数据</span>) {
  <span class="hljs-keyword">const</span> uuid = 造<span class="hljs-title function_">uuid</span>();

  <span class="hljs-keyword">const</span> navPoint = 数据.章.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">i, 序号</span>) =&gt;</span>
    <span class="hljs-string">`    &lt;navPoint id="navPoint-<span class="hljs-subst">${序号}</span>" playOrder="<span class="hljs-subst">${序号 + <span class="hljs-number">1</span>}</span>"&gt;
      &lt;navLabel&gt;&lt;text&gt;<span class="hljs-subst">${i.标题}</span>&lt;/text&gt;&lt;/navLabel&gt;
      &lt;content src="xhtml/<span class="hljs-subst">${序号}</span>.xhtml" /&gt;
    &lt;/navPoint&gt;
`</span>
  );

  <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;ncx
  xmlns="http://www.daisy.org/z3986/2005/ncx/"
  version="2005-1"
  xml:lang="zh-CN"
&gt;
  &lt;head&gt;
    &lt;meta
      name="dtb:uid"
      content="urn:uuid:<span class="hljs-subst">${uuid}</span>"
    /&gt;
    &lt;meta name="dtb:depth" content="1" /&gt;
    &lt;meta name="dtb:totalPageCount" content="<span class="hljs-subst">${数据.章.length}</span>" /&gt;
  &lt;/head&gt;
  &lt;docTitle&gt;
    &lt;text&gt;<span class="hljs-subst">${数据.标题}</span>&lt;/text&gt;
  &lt;/docTitle&gt;
  &lt;navMap&gt;
<span class="hljs-subst">${navPoint.join(<span class="hljs-string">"\n"</span>)}</span>
  &lt;/navMap&gt;
&lt;/ncx&gt;
`</span>;
}

<span class="hljs-comment">// out/OEBPS/style.css</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">style_css</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`body {

}
`</span>;
}

<span class="hljs-comment">// out/OEBPS/xhtml/0.xhtml</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">xhtml</span>(<span class="hljs-params">章, _序号</span>) {
  <span class="hljs-keyword">const</span> p = 章.段.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> <span class="hljs-string">`    &lt;p&gt;<span class="hljs-subst">${i}</span>&lt;/p&gt;`</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"&gt;
  &lt;head&gt;
    &lt;title&gt;<span class="hljs-subst">${章.标题}</span>&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h2&gt;<span class="hljs-subst">${章.标题}</span>&lt;/h2&gt;

<span class="hljs-subst">${p.join(<span class="hljs-string">"\n"</span>)}</span>

 &lt;/body&gt;
&lt;/html&gt;
`</span>;
}

<span class="hljs-comment">// 递归创建目录: mkdir -p</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> 建目录(路径) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"目录"</span>, 路径);
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Deno</span>.<span class="hljs-title function_">mkdir</span>(路径, {
    <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span>,
  });
}

<span class="hljs-comment">// 写文本文件</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> 写(名, 文本) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" "</span>, 名);
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Deno</span>.<span class="hljs-title function_">writeTextFile</span>(名, 文本);
}

<span class="hljs-comment">// 生成 epub 文件</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// epub 文件结构 (zip.epub):</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// out/</span>
<span class="hljs-comment">// out/mimetype</span>
<span class="hljs-comment">// out/META-INF/</span>
<span class="hljs-comment">// out/META-INF/container.xml</span>
<span class="hljs-comment">// out/OEBPS/</span>
<span class="hljs-comment">// out/OEBPS/content.opf</span>
<span class="hljs-comment">// out/OEBPS/toc.ncx</span>
<span class="hljs-comment">// out/OEBPS/style.css</span>
<span class="hljs-comment">// out/OEBPS/xhtml/</span>
<span class="hljs-comment">// out/OEBPS/xhtml/0.xhtml</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> 造<span class="hljs-title function_">epub</span>(<span class="hljs-params">数据, 输出目录</span>) {
  <span class="hljs-comment">// epub 元数据</span>
  <span class="hljs-keyword">await</span> 建目录(输出目录);
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/mimetype"</span>, 渲染<span class="hljs-title function_">mimetype</span>());

  <span class="hljs-keyword">await</span> 建目录(输出目录 + <span class="hljs-string">"/META-INF"</span>);
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/META-INF/container.xml"</span>, 渲染<span class="hljs-title function_">container_xml</span>());

  <span class="hljs-keyword">await</span> 建目录(输出目录 + <span class="hljs-string">"/OEBPS/xhtml"</span>);
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/OEBPS/content.opf"</span>, 渲染<span class="hljs-title function_">content_opf</span>(数据));
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/OEBPS/toc.ncx"</span>, 渲染<span class="hljs-title function_">toc_ncx</span>(数据));
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/OEBPS/style.css"</span>, 渲染<span class="hljs-title function_">style_css</span>());

  <span class="hljs-comment">// 生成每一章</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> [序号, 章] <span class="hljs-keyword">of</span> 数据.章.<span class="hljs-title function_">entries</span>()) {
    <span class="hljs-keyword">await</span> 写(
      输出目录 + <span class="hljs-string">"/OEBPS/xhtml/"</span> + 序号 + <span class="hljs-string">".xhtml"</span>,
      渲染<span class="hljs-title function_">xhtml</span>(章, 序号),
    );
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"完成"</span>);
}

<span class="hljs-comment">// 开始执行</span>
<span class="hljs-keyword">const</span> [输入文件, 输出目录] = <span class="hljs-title class_">Deno</span>.<span class="hljs-property">args</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"读"</span>, 输入文件);

<span class="hljs-keyword">const</span> 数据 = <span class="hljs-keyword">await</span> 加载<span class="hljs-title function_">txt</span>(输入文件);
<span class="hljs-comment">//console.log("data", 数据);</span>

<span class="hljs-keyword">await</span> 造<span class="hljs-title function_">epub</span>(数据, 输出目录);

<span class="hljs-comment">// txt2epub.js</span>
</code></pre>
<h3 data-id="heading-3">1.2 工作原理</h3>
<p>我们用一个简单的测试文件.</p>
<p>文件 <code>1.txt</code>:</p>
<pre><code class="hljs language-markdown" lang="markdown">(测试) 整本书 的 书名

封面 1

封面 2

<span class="hljs-section">## 第 1 章 标题 1</span>

段落 1
段落 2

<span class="hljs-section">## 第 2 章 标题 2</span>

段落 3

段落 4

TODO end
</code></pre>
<p>内容很简单, 只有 2 章, 格式类似 markdown.</p>
<hr/>
<p>然后运行上面的程序:</p>
<pre><code class="hljs language-sh" lang="sh">&gt; deno run -A txt2epub.js 1.txt out1
读 1.txt
目录 out1
  out1/mimetype
目录 out1/META-INF
  out1/META-INF/container.xml
目录 out1/OEBPS/xhtml
  out1/OEBPS/content.opf
  out1/OEBPS/toc.ncx
  out1/OEBPS/style.css
  out1/OEBPS/xhtml/0.xhtml
  out1/OEBPS/xhtml/1.xhtml
  out1/OEBPS/xhtml/2.xhtml
完成
</code></pre>
<p>运行完毕, 生成了这些文件:</p>
<pre><code class="hljs language-sh" lang="sh">&gt; find out1
out1
out1/mimetype
out1/META-INF
out1/META-INF/container.xml
out1/OEBPS
out1/OEBPS/xhtml
out1/OEBPS/xhtml/0.xhtml
out1/OEBPS/xhtml/1.xhtml
out1/OEBPS/xhtml/2.xhtml
out1/OEBPS/content.opf
out1/OEBPS/toc.ncx
out1/OEBPS/style.css
</code></pre>
<p>文件 <code>out1/mimetype</code>:</p>
<pre><code class="hljs language-txt" lang="txt">application/epub+zip
</code></pre>
<p>文件 <code>out1/META-INF/container.xml</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span>
  <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0"</span>
  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"urn:oasis:names:tc:opendocument:xmlns:container"</span>
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">rootfiles</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rootfile</span>
      <span class="hljs-attr">full-path</span>=<span class="hljs-string">"OEBPS/content.opf"</span>
      <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/oebps-package+xml"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">rootfiles</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/content.opf</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">package</span>
  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.idpf.org/2007/opf"</span>
  <span class="hljs-attr">version</span>=<span class="hljs-string">"3.0"</span>
  <span class="hljs-attr">unique-identifier</span>=<span class="hljs-string">"pub-id"</span>
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">metadata</span> <span class="hljs-attr">xmlns:dc</span>=<span class="hljs-string">"http://purl.org/dc/elements/1.1/"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:title</span>&gt;</span>(测试) 整本书 的 书名 (4) (0k)<span class="hljs-tag">&lt;/<span class="hljs-name">dc:title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:creator</span>&gt;</span>you<span class="hljs-tag">&lt;/<span class="hljs-name">dc:creator</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:identifier</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"pub-id"</span>
    &gt;</span>urn:uuid:b203607a-1ebb-44db-ba21-854dd5dc57b3<span class="hljs-tag">&lt;/<span class="hljs-name">dc:identifier</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">metadata</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"ncx"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"toc.ncx"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/x-dtbncx+xml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"css"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"style.css"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"text/css"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"item0"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"xhtml/0.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"item1"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"xhtml/1.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"item2"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"xhtml/2.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">spine</span> <span class="hljs-attr">toc</span>=<span class="hljs-string">"ncx"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"item0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"item1"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"item2"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">spine</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">package</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/toc.ncx</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ncx</span>
  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.daisy.org/z3986/2005/ncx/"</span>
  <span class="hljs-attr">version</span>=<span class="hljs-string">"2005-1"</span>
  <span class="hljs-attr">xml:lang</span>=<span class="hljs-string">"zh-CN"</span>
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span>
      <span class="hljs-attr">name</span>=<span class="hljs-string">"dtb:uid"</span>
      <span class="hljs-attr">content</span>=<span class="hljs-string">"urn:uuid:34deb94e-ee02-4db6-b96b-31996f4e8900"</span>
    /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dtb:depth"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"1"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dtb:totalPageCount"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"3"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">docTitle</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>(测试) 整本书 的 书名 (4) (0k)<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">docTitle</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">navMap</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">navPoint</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"navPoint-0"</span> <span class="hljs-attr">playOrder</span>=<span class="hljs-string">"1"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">navLabel</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>(测试) 整本书 的 书名 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">navLabel</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">content</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"xhtml/0.xhtml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">navPoint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">navPoint</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"navPoint-1"</span> <span class="hljs-attr">playOrder</span>=<span class="hljs-string">"2"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">navLabel</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>第 1 章 标题 1 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">navLabel</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">content</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"xhtml/1.xhtml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">navPoint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">navPoint</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"navPoint-2"</span> <span class="hljs-attr">playOrder</span>=<span class="hljs-string">"3"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">navLabel</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>第 2 章 标题 2 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">navLabel</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">content</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"xhtml/2.xhtml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">navPoint</span>&gt;</span>

  <span class="hljs-tag">&lt;/<span class="hljs-name">navMap</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ncx</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/style.css</code>:</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {

}
</code></pre>
<p>文件 <code>out1/OEBPS/xhtml/0.xhtml</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/1999/xhtml"</span> <span class="hljs-attr">xmlns:epub</span>=<span class="hljs-string">"http://www.idpf.org/2007/ops"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>(测试) 整本书 的 书名 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>(测试) 整本书 的 书名 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>封面 1<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>封面 2<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

 <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/xhtml/1.xhtml</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/1999/xhtml"</span> <span class="hljs-attr">xmlns:epub</span>=<span class="hljs-string">"http://www.idpf.org/2007/ops"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>第 1 章 标题 1 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>第 1 章 标题 1 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落 1<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落 2<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

 <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/xhtml/2.xhtml</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/1999/xhtml"</span> <span class="hljs-attr">xmlns:epub</span>=<span class="hljs-string">"http://www.idpf.org/2007/ops"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>第 2 章 标题 2 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>第 2 章 标题 2 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落 3<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落 4<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>TODO end<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

 <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<hr/>
<p>上面的大部分文件都是 epub 的元数据, 比如标题, 目录什么的.
<code>xhtml</code> 文件是章节内容, 每章一个.</p>
<p>然后, 把这堆文件手动压缩成 <code>zip</code> 包, 再把文件名后缀改成 <code>.epub</code>, 就完成啦 ~</p>
<p>对, epub 格式就是这么朴实无华.</p>
<h2 data-id="heading-4">2 手机阅读软件推荐 (Android F-Droid)</h2>
<p>如何安装 Termux (F-Droid) 详见文章 《在 Android 设备上写代码 (Termux, code-server)》.</p>
<p>此处推荐的 epub 阅读软件有: LxReader, Librera (F-Droid), Anx Reader</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a3ae19b276b4b468173c804f4365844~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=UolWLKN%2BLEV5v2dxEsSvQGBRwlQ%3D" alt="2-s-1.png" loading="lazy"/></p>
<p>这些软件可以从 F-Droid 下载.</p>
<p>为什么使用 F-Droid 软件呢 ? 因为 F-Droid 的规则要求, 里面的软件必须是 "完全开源" 的, 也就是不能有闭源的依赖组件, 整个软件从源代码从头编译.</p>
<p>这意味着, 最终用户不必受限于任何人, 你可以获取软件的源代码, 自己编译, 或进行修改.</p>
<h2 data-id="heading-5">3 实际测试</h2>
<p>测试手机: 型号 Redmi Note 7 pro (6G+128G) (对, 这只手机来自古老但美好的 MIUI 时代 ~ )</p>
<p>操作系统: LineageOS 23.0</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4653765d930145e2942c918ba7d8ac36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=KoKPfYtxCDhQ%2BScDWPlUGp3qYSc%3D" alt="3-a-1.png" loading="lazy"/></p>
<p>在 Termux 中安装 <code>deno</code>, 命令:</p>
<pre><code class="hljs language-sh" lang="sh">pkg install deno
</code></pre>
<p>然后就可以在手机上运行上面的程序啦 ~</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f68e35e5cba94959aa9b07d6b0f61152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=emQ0nELPNU%2FVf3tSvbaIRq%2BVrO8%3D" alt="3-t-2.png" loading="lazy"/></p>
<p>这是制作好的 epub 文件:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6b05d39e92741498251f1ae25cdf08d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=gzoh%2BPrkgJhyoTEKaqhrlSbGZaE%3D" alt="3-f-3.png" loading="lazy"/></p>
<p>这是窝写的一个中篇小说 (初稿).</p>
<hr/>
<p>LxReader 阅读效果:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ada37202e2aa4a41bc75d6044691cb90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=%2F%2BwnVC5XqgzU%2BRSKuUrod8AywUU%3D" alt="3-x-4.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/087937ff41af4e1981033d80668a9a9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=11Fv2k1wl%2B9PfVGtzw6WJPRo8r0%3D" alt="3-x-5.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8259992dbb394986b8921773bae382a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=T99p1%2FPPZqXcqd7WbA7s4C126bY%3D" alt="3-x-6.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4157b46715a24066be0f59c70be24540~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=s9GQOxutwswgC8Cju0p7yGNS2fs%3D" alt="3-x-7.png" loading="lazy"/></p>
<p>Librera 阅读效果:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7807c0bc0e6247f188b5b0d6a92b916c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=rDU3lLBq5sEiOnkj3DNWNrDeD0w%3D" alt="3-r-8.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1718ea26f05c414cb8bb103d5c88e19b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=rMh2mq6jeDBQApvk9Slq3FdyfFc%3D" alt="3-r-9.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/336f5d103e7b4c9c96170a2006fe7c84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=kENiJX%2FE95vVpBPNw0BYHjNQg3k%3D" alt="3-r-10.png" loading="lazy"/></p>
<h2 data-id="heading-6">4 总结与展望</h2>
<p>随着 AI 语言大模型越来越强, 在 AI 的辅助下写小说就越来越容易啦 ~</p>
<p>相比被动的阅读别人写好的小说, 写出自己的小说, 是一种更快乐的娱乐方式. 加油 !</p>
<p>本文只使用了 epub 最简单的功能 (章节标题), epub 还有很多功能可以继续深入挖掘.</p>
<h2 data-id="heading-7">附录 1 "全开源" 软件体系</h2>
<ul>
<li>
<p>操作系统: Android (LineageOS, 手机), ArchLinux GNOME (PC).</p>
</li>
<li>
<p>中文输入法: 胖喵拼音 (自制)</p>
</li>
<li>
<p>AI (语言大模型): deepseek</p>
</li>
<li>
<p>txt 转 epub: 自制 (deno, Termux)</p>
</li>
<li>
<p>手机阅读软件: LxReader, Librera (F-Droid)</p>
</li>
</ul>
<p>从 操作系统 -&gt; 创作 -&gt; 阅读 的 <strong>全链条</strong> 开源软件.</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d25cfcec4f14cd4af54fea88836b518~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=YnlmYkbJsS%2BRwitC5LVl1yy0abg%3D" alt="a1-p-1.jpg" loading="lazy"/></p>
<p>如图, 使用胖喵拼音 (和 AI) 在手机上写小说 ~</p>
<hr/>
<p>本文使用 CC-BY-SA 4.0 许可发布.</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何正确使用 Redis 分布式锁（完整技术分享文档）]]></title>    <link>https://juejin.cn/post/7577905525997469737</link>    <guid>https://juejin.cn/post/7577905525997469737</guid>    <pubDate>2025-11-30T06:08:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577905525997469737" data-draft-id="7577905525997092905" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何正确使用 Redis 分布式锁（完整技术分享文档）"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2025-11-30T06:08:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="beata"/> <meta itemprop="url" content="https://juejin.cn/user/1839900247461280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何正确使用 Redis 分布式锁（完整技术分享文档）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1839900247461280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    beata
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:08:22.000Z" title="Sun Nov 30 2025 06:08:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">如何正确使用 Redis 分布式锁（完整技术分享文档）</h2>
<hr/>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="#1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5" title="#1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">基础概念</a></li>
<li><a href="#2-%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E4%B8%8E%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" title="#2-%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E4%B8%8E%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">实现方案与代码实现</a>
<ul>
<li><a href="#21-set-%E5%91%BD%E4%BB%A4%E5%AE%9E%E7%8E%B0" title="#21-set-%E5%91%BD%E4%BB%A4%E5%AE%9E%E7%8E%B0">2.1 SET 命令实现</a></li>
<li><a href="#22-stringredistemplate-%E5%AE%9E%E7%8E%B0" title="#22-stringredistemplate-%E5%AE%9E%E7%8E%B0">2.2 StringRedisTemplate 实现</a></li>
<li><a href="#23-redlock-%E7%AE%97%E6%B3%95" title="#23-redlock-%E7%AE%97%E6%B3%95">2.3 Redlock 算法</a></li>
<li><a href="#24-redisson-%E6%A1%86%E6%9E%B6" title="#24-redisson-%E6%A1%86%E6%9E%B6">2.4 Redisson 框架</a></li>
<li><a href="#25-spring-boot-%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0" title="#25-spring-boot-%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0">2.5 Spring Boot 注解方式实现</a></li>
</ul>
</li>
<li><a href="#3-%E4%BC%98%E7%BC%BA%E7%82%B9%E5%AF%B9%E6%AF%94" title="#3-%E4%BC%98%E7%BC%BA%E7%82%B9%E5%AF%B9%E6%AF%94">优缺点对比</a></li>
<li><a href="#4-%E5%A4%B1%E6%95%88%E6%83%85%E5%86%B5%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" title="#4-%E5%A4%B1%E6%95%88%E6%83%85%E5%86%B5%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">失效情况分析与解决方案</a></li>
<li><a href="#5-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%A1%88%E4%BE%8B" title="#5-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%A1%88%E4%BE%8B">最佳实践案例</a></li>
<li><a href="#6-%E6%80%BB%E7%BB%93" title="#6-%E6%80%BB%E7%BB%93">总结</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">1. 基础概念</h3>
<p><strong>分布式锁</strong>用于协调多个节点对共享资源的互斥访问，常用于秒杀、抢红包、库存扣减等场景。Redis 因其高性能、原子性操作（如 <code>SET NX PX</code>）成为分布式锁的常用实现工具。</p>
<p><strong>核心要求</strong>：</p>
<ul>
<li><strong>互斥性</strong>：任意时刻只有一个客户端持有锁。</li>
<li><strong>锁超时释放</strong>：避免死锁。</li>
<li><strong>安全性</strong>：只能被持有者删除。</li>
<li><strong>高性能与高可用</strong>：低开销、支持多节点容错。</li>
</ul>
<hr/>
<h3 data-id="heading-3">2. 实现方案与代码实现</h3>
<h4 data-id="heading-4">2.1 SET 命令实现（基础方案）</h4>
<p><strong>原理</strong>：<br/>
使用 <code>SET key value NX PX milliseconds</code> 原子命令实现加锁，解锁通过 Lua 脚本校验持有者身份。</p>
<p><strong>代码示例（Java + Jedis）</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> java.util.UUID;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisLock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOCK_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"resource_lock"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXPIRE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">30000</span>; <span class="hljs-comment">// 30s</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(Jedis jedis, String lockKey, String uniqueId, <span class="hljs-type">int</span> expireTime)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.set(lockKey, uniqueId, <span class="hljs-string">"NX"</span>, <span class="hljs-string">"PX"</span>, expireTime);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"OK"</span>.equals(result);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(Jedis jedis, String lockKey, String uniqueId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">luaScript</span> <span class="hljs-operator">=</span> <span class="hljs-string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;
        jedis.eval(luaScript, <span class="hljs-number">1</span>, lockKey, uniqueId);
    }

    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">uniqueId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
        <span class="hljs-keyword">if</span> (tryLock(jedis, LOCK_KEY, uniqueId, EXPIRE_TIME)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 业务逻辑</span>
            } <span class="hljs-keyword">finally</span> {
                unlock(jedis, LOCK_KEY, uniqueId);
            }
        }
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-5">2.2 StringRedisTemplate 实现（Spring Boot 推荐）</h4>
<p><strong>原理</strong>：<br/>
使用 Spring Data Redis 提供的 <code>StringRedisTemplate</code> 实现加锁和解锁，结合 Lua 脚本确保安全性。</p>
<p><strong>代码示例（Spring Boot）</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.UUID;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisLockService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate redisTemplate;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisLockService</span><span class="hljs-params">(StringRedisTemplate redisTemplate)</span> {
        <span class="hljs-built_in">this</span>.redisTemplate = redisTemplate;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String lockKey, <span class="hljs-type">long</span> expireTime)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">uniqueId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(
            lockKey, uniqueId, expireTime, TimeUnit.MILLISECONDS);
        <span class="hljs-keyword">return</span> Boolean.TRUE.equals(result);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String lockKey, String uniqueId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;
        DefaultRedisScript&lt;Long&gt; redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class);
        redisTemplate.execute(redisScript, Collections.singletonList(lockKey), uniqueId);
    }

    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processResource</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"resource_lock"</span>;
        <span class="hljs-keyword">if</span> (tryLock(lockKey, <span class="hljs-number">30000</span>)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 业务逻辑</span>
            } <span class="hljs-keyword">finally</span> {
                unlock(lockKey, redisTemplate.opsForValue().get(lockKey));
            }
        }
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-6">2.3 Redlock 算法（多实例方案）</h4>
<p><strong>原理</strong>：<br/>
通过多个独立 Redis 实例实现高可用锁。</p>
<p><strong>代码示例（伪代码）</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">acquire_redlock</span>(<span class="hljs-params">lock_name, expire_time</span>):
    instances = [redis.Redis(host=<span class="hljs-string">f'redis<span class="hljs-subst">{i}</span>'</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)]
    success_count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> instance <span class="hljs-keyword">in</span> instances:
        <span class="hljs-keyword">if</span> instance.<span class="hljs-built_in">set</span>(lock_name, <span class="hljs-string">"locked"</span>, nx=<span class="hljs-literal">True</span>, px=expire_time):
            success_count += <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> success_count &gt;= <span class="hljs-number">3</span>  <span class="hljs-comment"># 多数成功</span>
</code></pre>
<hr/>
<h4 data-id="heading-7">2.4 Redisson 框架（推荐方案）</h4>
<p><strong>步骤</strong>：</p>
<ol>
<li><strong>添加 Maven 依赖</strong>：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.27.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ol start="2">
<li><strong>配置 Redis（application.yml）</strong>：</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-string">2000ms</span>
</code></pre>
<ol start="3">
<li><strong>使用 RLock</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RLock;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(String orderId)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">"order_lock:"</span> + orderId);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLocked</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">30</span>, <span class="hljs-number">30</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (!isLocked) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"获取锁失败"</span>);
            }
            <span class="hljs-comment">// 业务逻辑</span>
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-8">2.5 Spring Boot 注解方式实现</h4>
<h5 data-id="heading-9">2.5.1 实现原理</h5>
<p>通过 <strong>自定义注解 + AOP 切面</strong> 实现分布式锁的自动加锁/解锁，结合 Redisson 的 <code>RLock</code> 提供可重入锁、自动续期等功能。</p>
<hr/>
<h5 data-id="heading-10">2.5.2 实现步骤</h5>
<h6 data-id="heading-11">1. 定义自定义注解</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.lang.annotation.*;

<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> DistributedLock {
    String <span class="hljs-title function_">value</span><span class="hljs-params">()</span>; <span class="hljs-comment">// 锁 key 的 SpEL 表达式（如 #userId）</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">waitTime</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">30</span>; <span class="hljs-comment">// 等待加锁时间（秒）</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">leaseTime</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">30</span>; <span class="hljs-comment">// 锁持有时间（秒）</span>
}
</code></pre>
<hr/>
<h6 data-id="heading-12">2. 实现 AOP 切面</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Around;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hljs-keyword">import</span> org.redisson.api.RLock;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.expression.ExpressionParser;
<span class="hljs-keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;
<span class="hljs-keyword">import</span> org.springframework.expression.spel.support.StandardEvaluationContext;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedLockAspect</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();

    <span class="hljs-meta">@Around("@annotation(distributedLock)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint pjp, DistributedLock distributedLock)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 解析 SpEL 表达式获取锁 key</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> parseSpEL(distributedLock.value(), pjp.getArgs());
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 尝试加锁</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLocked</span> <span class="hljs-operator">=</span> lock.tryLock(distributedLock.waitTime(), distributedLock.leaseTime(), TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (!isLocked) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"获取分布式锁超时"</span>);
            }
            <span class="hljs-keyword">return</span> pjp.proceed(); <span class="hljs-comment">// 执行目标方法</span>
        } <span class="hljs-keyword">finally</span> {
            lock.unlock(); <span class="hljs-comment">// 释放锁</span>
        }
    }

    <span class="hljs-comment">// 解析 SpEL 表达式</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">parseSpEL</span><span class="hljs-params">(String expression, Object[] args)</span> {
        <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) {
            context.setVariable(<span class="hljs-string">"arg"</span> + i, args[i]);
        }
        <span class="hljs-keyword">return</span> parser.parseExpression(expression).getValue(context, String.class);
    }
}
</code></pre>
<hr/>
<h6 data-id="heading-13">3. 配置 Spring Boot 启用 AOP</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAspectJAutoProxy(exposeProxy = true)</span> <span class="hljs-comment">// 必须启用 exposeProxy</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AopConfig</span> {
}
</code></pre>
<hr/>
<h6 data-id="heading-14">4. 使用示例</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@DistributedLock(value = "#userId", waitTime = 10, leaseTime = 30)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-comment">// 业务逻辑（无需手动加锁）</span>
    }
}
</code></pre>
<hr/>
<h5 data-id="heading-15">2.5.3 注解失效的常见场景</h5>



































<table><thead><tr><th>场景</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>1. 同类方法调用</strong></td><td>AOP 代理失效（Spring 无法拦截内部调用）</td><td>使用 <code>((OrderService) AopContext.currentProxy()).createOrder(userId)</code></td></tr><tr><td><strong>2. 未启用 AOP</strong></td><td>未配置 <code>@EnableAspectJAutoProxy</code> 或未扫描切面类</td><td>添加 <code>@EnableAspectJAutoProxy</code> 并确保切面类被 Spring 扫描</td></tr><tr><td><strong>3. 事务传播行为不匹配</strong></td><td><code>@Transactional</code> 方法嵌套调用导致锁提前释放</td><td>为分布式锁方法单独开启新事务（<code>@Transactional(propagation = Propagation.REQUIRES_NEW)</code>）</td></tr><tr><td><strong>4. 异常未捕获</strong></td><td>方法抛出异常后未正确释放锁</td><td>在 <code>finally</code> 块中释放锁（Redisson 已自动处理）</td></tr><tr><td><strong>5. SpEL 表达式错误</strong></td><td><code>value</code> 中的 SpEL 表达式解析失败（如 <code>#userId</code> 不存在）</td><td>检查方法参数名是否匹配，或使用 <code>args[0]</code> 代替 <code>#userId</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-16">3. 优缺点对比</h3>



























































<table><thead><tr><th>方案</th><th>互斥性</th><th>自动续期</th><th>可重入</th><th>高可用</th><th>性能</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>SET 命令</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>⭐⭐⭐⭐⭐</td><td>低并发、简单业务</td></tr><tr><td><strong>StringRedisTemplate</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>⭐⭐⭐⭐</td><td>Spring Boot 项目</td></tr><tr><td><strong>Redlock</strong></td><td>✅</td><td>❌</td><td>❌</td><td>✅</td><td>⭐⭐⭐</td><td>高并发、强一致性要求</td></tr><tr><td><strong>Redisson</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>⭐⭐⭐⭐</td><td>复杂业务、Java 项目</td></tr><tr><td><strong>注解方式</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>⭐⭐⭐⭐</td><td>快速开发、Spring Boot</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">4. 失效情况分析与解决方案</h3>
<h4 data-id="heading-18">4.1 死锁（Lock Not Released）</h4>
<ul>
<li><strong>原因</strong>：客户端异常崩溃未释放锁。</li>
<li><strong>解决方案</strong>：设置合理的 TTL（如 30s），或使用 Redisson 的 Watchdog 自动续期。</li>
</ul>
<h4 data-id="heading-19">4.2 误删他人锁（Wrong Unlock）</h4>
<ul>
<li><strong>原因</strong>：未校验锁持有者身份直接 <code>DEL</code>。</li>
<li><strong>解决方案</strong>：加锁时写入唯一标识，解锁时用 Lua 脚本校验。</li>
</ul>
<h4 data-id="heading-20">4.3 主从切换丢锁</h4>
<ul>
<li><strong>原因</strong>：主节点宕机后从节点未同步锁信息。</li>
<li><strong>解决方案</strong>：使用 Redlock 或改用 CP 系统（如 ZooKeeper）。</li>
</ul>
<h4 data-id="heading-21">4.4 业务执行时间 &gt; TTL</h4>
<ul>
<li><strong>原因</strong>：锁自动释放导致重复执行。</li>
<li><strong>解决方案</strong>：引入 Watchdog 自动续期（Redisson 默认支持）。</li>
</ul>
<h4 data-id="heading-22">4.5 注解失效的典型场景</h4>
<h5 data-id="heading-23">场景 1：同类方法调用导致锁失效</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@DistributedLock(value = "#userId")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-comment">// 业务逻辑</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchCreateOrders</span><span class="hljs-params">(String userId)</span> {
        createOrder(userId); <span class="hljs-comment">// ❌ 同类调用，AOP 代理失效</span>
    }
}
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchCreateOrders</span><span class="hljs-params">(String userId)</span> {
    ((OrderService) AopContext.currentProxy()).createOrder(userId); <span class="hljs-comment">// ✅ 通过代理调用</span>
}
</code></pre>
<h5 data-id="heading-24">场景 2：事务传播行为导致锁提前释放</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@DistributedLock(value = "#userId")</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-comment">// 业务逻辑</span>
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(String userId)</span> {
        createOrder(userId); <span class="hljs-comment">// ❌ 同事务中调用，锁可能提前释放</span>
    }
}
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String userId)</span> {
    <span class="hljs-comment">// 独立事务</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-25">5. 最佳实践案例</h3>
<h4 data-id="heading-26">场景：秒杀系统扣库存（Redisson + Spring Boot）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">seckill</span><span class="hljs-params">(String productId, String userId)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">"seckill_lock:"</span> + productId);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLocked</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">3</span>, <span class="hljs-number">30</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (!isLocked) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"系统繁忙，请稍后"</span>;
            }
            <span class="hljs-comment">// 双重检查库存</span>
            <span class="hljs-type">Integer</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> stockService.getStock(productId);
            <span class="hljs-keyword">if</span> (stock &lt;= <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"库存不足"</span>;
            }
            stockService.deduct(productId);
            createOrder(productId, userId);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"秒杀成功"</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"秒杀失败"</span>;
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-27">6. 总结</h3>
<ul>
<li><strong>优先选择 Redisson</strong>：内置自动续期、可重入、高可用，适合复杂业务。</li>
<li><strong>Spring Boot 项目推荐 StringRedisTemplate</strong>：简化配置，兼容性强。</li>
<li><strong>注解方式实现</strong>：通过 AOP 切面 + Redisson 提供开箱即用的分布式锁能力，简化代码逻辑。</li>
<li><strong>避免手写锁</strong>：非原子操作、未校验持有者等常见误区易导致严重问题。</li>
<li><strong>锁粒度要细</strong>：如按商品 ID、用户 ID 维度加锁，提升并发度。</li>
<li><strong>结合幂等性设计</strong>：即使锁失效，业务逻辑也能通过数据库约束、唯一索引兜底。</li>
</ul>
<blockquote>
<p><strong>一句话原则</strong>：<br/>
<strong>“能不用锁就不用锁，能用数据库约束就不用分布式锁。”</strong></p>
</blockquote>
<hr/>
<blockquote>
<p>作者：Beata - 后端服务架构自由人<br/>
最后更新：2025 年 11 月  30 日
版权声明：本文可自由转载，注明出处即可。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL索引设计原则：明明建了索引为什么还是慢？7条实战原则帮你避坑]]></title>    <link>https://juejin.cn/post/7577691061034008622</link>    <guid>https://juejin.cn/post/7577691061034008622</guid>    <pubDate>2025-11-30T06:21:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061034008622" data-draft-id="7577718777482002470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL索引设计原则：明明建了索引为什么还是慢？7条实战原则帮你避坑"/> <meta itemprop="keywords" content="MySQL"/> <meta itemprop="datePublished" content="2025-11-30T06:21:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是2的10次方啊"/> <meta itemprop="url" content="https://juejin.cn/user/987803531871175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL索引设计原则：明明建了索引为什么还是慢？7条实战原则帮你避坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/987803531871175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是2的10次方啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:21:06.000Z" title="Sun Nov 30 2025 06:21:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MySQL索引设计原则：明明建了索引为什么还是慢？7条实战原则帮你避坑</h2>
<blockquote>
<p><strong>MySQL索引系列文章：</strong></p>
<ul>
<li>📖 <a href="https://juejin.cn/post/7564977973259976730" target="_blank" title="https://juejin.cn/post/7564977973259976730">基础篇：图解MySQL索引：从二叉树到B+树的演进之路</a></li>
<li>📖 <a href="https://juejin.cn/post/7567257202194776091" target="_blank" title="https://juejin.cn/post/7567257202194776091">进阶篇：MySQL索引：SQL性能分析工具详解</a></li>
<li>📖 <a href="https://juejin.cn/post/7570271574348038153" target="_blank" title="https://juejin.cn/post/7570271574348038153">实战篇：MySQL索引优化实战：原则速查与踩坑案例</a></li>
<li>📖 <a href="#" title="#">设计原则篇：MySQL索引设计原则：从理论到实践的完整指南</a> （本文）</li>
</ul>
</blockquote>
<p>掌握了索引的创建和使用技巧后，如何设计出高效、合理的索引？本文将从表级别、字段级别、索引级别三个维度，系统梳理7条核心设计原则，并结合真实业务场景，帮你避免" 索引建了但效果不佳"的常见陷阱。</p>
<p>记得刚工作那会儿，我负责优化一个订单查询接口。明明已经给<code>user_id</code> 建了索引，但查询还是慢得要命。我百思不得其解，直到DBA老哥看了一眼执行计划，淡淡地说："你这索引建得不对，字段顺序有问题。"</p>
<p>那一刻我才明白，<strong>索引不是建了就完事了，设计才是关键</strong>。</p>
<p>你是否也遇到过这样的困惑：</p>
<ul>
<li>明明创建了索引，查询依然很慢？</li>
<li>索引建得太多，写入性能反而下降？</li>
<li>不知道什么时候该建索引，什么时候不该建？</li>
</ul>
<p>索引设计就像盖房子，不是砖头越多越好，而是要<strong>在合适的地方用合适的材料</strong>。本文将从<strong>表→字段→索引</strong> 三个层次，分享7条实战中总结的设计原则，帮你建立完整的索引设计思路。</p>
<hr/>
<h3 data-id="heading-1">一、表级别：何时建立索引？</h3>
<h4 data-id="heading-2">原则1：针对于数据量较大，且查询比较频繁的表建立索引</h4>
<p>索引的收益与表的数据量和查询频率成正比。这个道理很简单：<strong>数据量越大，索引的价值越明显；查询越频繁，索引的回报越高</strong>。</p>
<h5 data-id="heading-3">为什么数据量要"较大"？</h5>
<p>索引不是免费的午餐，它需要占用存储空间，每次写入还要维护索引结构。对于小表（比如只有几条记录的配置表、字典表），全表扫描的成本可能比索引查找还低：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例：用户状态字典表（只有5条记录）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_status_dict (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    status_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)
);

<span class="hljs-comment">-- 这种场景下，建索引反而增加开销</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status_name <span class="hljs-keyword">ON</span> user_status_dict(status_name); <span class="hljs-comment">-- ❌ 不推荐</span>

<span class="hljs-comment">-- 对于小表，直接全表扫描即可</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> user_status_dict <span class="hljs-keyword">WHERE</span> status_name <span class="hljs-operator">=</span> <span class="hljs-string">'ACTIVE'</span>;
</code></pre>
<p><strong>经验值</strong>：一般表数据量超过<strong>1000行</strong>，才考虑建立索引。但这个数字不是绝对的，还要看查询频率和业务特点。比如一个只有500行的表，如果每秒查询100次，那建索引也是值得的。</p>
<h5 data-id="heading-4">查询频率的重要性</h5>
<p>即使是大表，如果某个字段极少被查询，建立索引也不划算。我见过有人给一个千万级大表的<code>internal_remark</code> 字段建索引，结果这个字段一个月才查一次，完全是浪费：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表（1000万条记录）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,
    created_at DATETIME,
    <span class="hljs-comment">-- 某个业务字段，但只在后台统计时偶尔查询</span>
    internal_remark TEXT
);

<span class="hljs-comment">-- ❌ 不推荐：查询频率低，但维护成本高</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_internal_remark <span class="hljs-keyword">ON</span> orders(internal_remark);

<span class="hljs-comment">-- ✅ 推荐：高频查询字段建立索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_created <span class="hljs-keyword">ON</span> orders(user_id, created_at);
</code></pre>
<p><strong>建议</strong>：</p>
<ul>
<li>通过慢查询日志统计SQL执行频次，优先为高频SQL涉及的字段建立索引</li>
<li>对于低频查询场景，可以考虑用<code>LIMIT</code>限制查询范围，或者走异步查询+缓存</li>
</ul>
<hr/>
<h3 data-id="heading-5">二、字段级别：哪些字段适合建索引？</h3>
<h4 data-id="heading-6">原则2：针对于常作为查询条件（WHERE）、排序（ORDER BY）、分组（GROUP BY）操作的字段建立索引</h4>
<p>索引主要有三大应用场景：<strong>过滤（WHERE）、排序（ORDER BY）、分组（GROUP BY）</strong> 。记住这三个场景，基本就能判断哪些字段需要建索引了。</p>
<h5 data-id="heading-7">WHERE 条件字段</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_profile (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    age <span class="hljs-type">INT</span>,
    city <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    created_at DATETIME
);

<span class="hljs-comment">-- ✅ 高频WHERE条件字段建立索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_email <span class="hljs-keyword">ON</span> user_profile(email);
<span class="hljs-keyword">CREATE</span> INDEX idx_phone <span class="hljs-keyword">ON</span> user_profile(phone);

<span class="hljs-comment">-- 查询示例</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> user_profile <span class="hljs-keyword">WHERE</span> email <span class="hljs-operator">=</span> <span class="hljs-string">'user@example.com'</span>; <span class="hljs-comment">-- 命中索引</span>
</code></pre>
<h5 data-id="heading-8">ORDER BY 排序字段</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 商品表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>),
    price <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    sales_count <span class="hljs-type">INT</span>,
    created_at DATETIME
);

<span class="hljs-comment">-- ✅ 为排序字段建立索引，避免filesort</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_price <span class="hljs-keyword">ON</span> products(price);
<span class="hljs-keyword">CREATE</span> INDEX idx_sales_created <span class="hljs-keyword">ON</span> products(sales_count <span class="hljs-keyword">DESC</span>, created_at <span class="hljs-keyword">DESC</span>);

<span class="hljs-comment">-- 查询示例：避免临时排序</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> price <span class="hljs-keyword">ASC</span> LIMIT <span class="hljs-number">20</span>; <span class="hljs-comment">-- 可以利用索引顺序</span>
</code></pre>
<p><strong>注意</strong>：如果<code>ORDER BY</code>和<code>WHERE</code>条件结合，需要设计联合索引：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">-- ✅ 联合索引设计：<span class="hljs-keyword">WHERE</span>在前，<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>在后
CREATE INDEX idx_category_price <span class="hljs-keyword">ON</span> products(category_id, price);

-- 这个查询可以利用索引同时完成过滤和排序
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products 
<span class="hljs-keyword">WHERE</span> category_id = <span class="hljs-number">100</span> 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> price ASC 
LIMIT <span class="hljs-number">20</span>;
</code></pre>
<h5 data-id="heading-9">GROUP BY 分组字段</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    created_at DATETIME
);

<span class="hljs-comment">-- ✅ 为GROUP BY字段建立索引，避免临时表排序</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status_created <span class="hljs-keyword">ON</span> orders(status, created_at);

<span class="hljs-comment">-- 查询示例：按状态分组统计每日订单数</span>
<span class="hljs-keyword">SELECT</span> status, <span class="hljs-type">DATE</span>(created_at) <span class="hljs-keyword">as</span> order_date, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) 
<span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status, <span class="hljs-type">DATE</span>(created_at); 
<span class="hljs-comment">-- 如果设计合理，可以利用索引避免filesort</span>
</code></pre>
<p><strong>踩坑案例</strong>：<code>ORDER BY</code>和<code>GROUP BY</code>混合使用时，需要仔细设计索引顺序：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">-- 订单表索引设计
CREATE INDEX idx_user_status_created <span class="hljs-keyword">ON</span> orders(user_id, status, created_at);

-- ❌ 问题查询：<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>和<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>顺序与索引不完全匹配
<span class="hljs-keyword">SELECT</span> user_id, status, COUNT(*) <span class="hljs-keyword">as</span> order_count
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> user_id = <span class="hljs-number">1001</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at DESC; -- created_at在<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>之后，可能导致filesort

-- ✅ 优化方案<span class="hljs-number">1</span>：调整索引顺序或SQL写法
<span class="hljs-keyword">SELECT</span> user_id, status, COUNT(*) <span class="hljs-keyword">as</span> order_count
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> user_id = <span class="hljs-number">1001</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> status; -- 与<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>一致，可以利用索引

-- ✅ 优化方案<span class="hljs-number">2</span>：使用子查询分离逻辑
<span class="hljs-keyword">SELECT</span> t.* <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> user_id, status, COUNT(*) <span class="hljs-keyword">as</span> order_count
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> user_id = <span class="hljs-number">1001</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status
) t
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_count DESC; -- 在子查询结果上排序
</code></pre>
<hr/>
<h4 data-id="heading-10">原则3：尽量选择区分度高的列建立索引，尽量建立唯一索引，区分度越高，使用索引的效率越高</h4>
<p>索引的选择性（Cardinality）决定了索引的查找效率。简单说，<strong>区分度越高，索引效果越好</strong>。</p>
<h5 data-id="heading-11">什么是区分度？</h5>
<p>区分度 = 不重复的索引值数量 / 表中的总记录数</p>
<ul>
<li><strong>区分度越高</strong>（接近1）：索引效果越好，如主键、唯一字段</li>
<li><strong>区分度越低</strong>（接近0）：索引效果越差，如性别字段、状态字段</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例：用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span>,  <span class="hljs-comment">-- 区分度：100%</span>
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">UNIQUE</span>,    <span class="hljs-comment">-- 区分度：100%</span>
    gender TINYINT,               <span class="hljs-comment">-- 区分度：~2%（只有男/女）</span>
    status TINYINT                <span class="hljs-comment">-- 区分度：~5%（只有几个状态值）</span>
);

<span class="hljs-comment">-- ✅ 高区分度字段：建立唯一索引</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_username <span class="hljs-keyword">ON</span> users(username);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_email <span class="hljs-keyword">ON</span> users(email);

<span class="hljs-comment">-- ❌ 低区分度字段：不建议单独建立索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_gender <span class="hljs-keyword">ON</span> users(gender); <span class="hljs-comment">-- 不推荐</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status <span class="hljs-keyword">ON</span> users(status); <span class="hljs-comment">-- 不推荐</span>

<span class="hljs-comment">-- ✅ 但如果需要与其他字段组合查询，可以建立联合索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status_created <span class="hljs-keyword">ON</span> users(status, created_at);
</code></pre>
<h5 data-id="heading-12">如何计算区分度？</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 计算某个字段的区分度</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> status) <span class="hljs-keyword">as</span> distinct_count,  <span class="hljs-comment">-- 不重复值数量</span>
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> total_count,                    <span class="hljs-comment">-- 总记录数</span>
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> status) <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span> <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> selectivity  <span class="hljs-comment">-- 区分度</span>
<span class="hljs-keyword">FROM</span> orders;

<span class="hljs-comment">-- 输出示例：</span>
<span class="hljs-comment">-- distinct_count: 5</span>
<span class="hljs-comment">-- total_count: 1000000</span>
<span class="hljs-comment">-- selectivity: 0.000005  (区分度极低，不建议单独建索引)</span>
</code></pre>
<p><strong>经验值</strong>（仅供参考）：</p>
<ul>
<li><strong>区分度 &gt; 30%</strong> ：适合建立单列索引</li>
<li><strong>区分度 10% - 30%</strong> ：建议建立联合索引</li>
<li><strong>区分度 &lt; 10%</strong> ：不建议单独建立索引，除非与其他字段组合</li>
</ul>
<h5 data-id="heading-13">唯一索引的优势</h5>
<p>唯一索引不仅能保证数据唯一性，还能带来额外的性能优化：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ✅ 唯一索引：查找时可以立即停止（找到一条即停止）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_order_no <span class="hljs-keyword">ON</span> orders(order_no);
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> order_no <span class="hljs-operator">=</span> <span class="hljs-string">'ORDER20251109001'</span>; <span class="hljs-comment">-- 找到即停止</span>

<span class="hljs-comment">-- 普通索引：需要继续查找是否有重复值（虽然已经找到目标）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_id <span class="hljs-keyword">ON</span> orders(user_id);
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span>; <span class="hljs-comment">-- 需要扫描所有匹配行</span>
</code></pre>
<hr/>
<h4 data-id="heading-14">原则4：如果是字符串类型的字段，字段的长度较长，可以针对于字段的特点，建立前缀索引</h4>
<p>长字符串字段如果建立完整索引，占用空间会很大。比如一个<code>VARCHAR(1000)</code>的URL字段，如果完整索引，每个索引项可能占用1000字节。这时候可以用前缀索引， <strong>只索引前N个字符，在查询性能和存储成本之间找平衡</strong>。</p>
<h5 data-id="heading-15">为什么需要前缀索引？</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例：文章表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> articles (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    title <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">500</span>),      <span class="hljs-comment">-- 标题可能很长</span>
    content TEXT,            <span class="hljs-comment">-- 内容很长，不适合建索引</span>
    url <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">1000</span>)        <span class="hljs-comment">-- URL很长</span>
);

<span class="hljs-comment">-- ❌ 完整索引：占用空间大</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_url <span class="hljs-keyword">ON</span> articles(url); <span class="hljs-comment">-- 每个索引项可能占用1000字节</span>

<span class="hljs-comment">-- ✅ 前缀索引：节省空间</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_url_prefix <span class="hljs-keyword">ON</span> articles(url(<span class="hljs-number">50</span>)); <span class="hljs-comment">-- 只索引前50个字符</span>
</code></pre>
<h5 data-id="heading-16">如何确定前缀长度？</h5>
<p>通过计算不同前缀长度的区分度，选择最合适的长度：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 方法1：逐步测试不同前缀长度的区分度</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">LEFT</span>(url, <span class="hljs-number">10</span>)) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> prefix_10_selectivity,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">LEFT</span>(url, <span class="hljs-number">20</span>)) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> prefix_20_selectivity,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">LEFT</span>(url, <span class="hljs-number">50</span>)) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> prefix_50_selectivity,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">LEFT</span>(url, <span class="hljs-number">100</span>)) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> prefix_100_selectivity
<span class="hljs-keyword">FROM</span> articles;

<span class="hljs-comment">-- 输出示例：</span>
<span class="hljs-comment">-- prefix_10_selectivity: 0.8500  (85%的区分度)</span>
<span class="hljs-comment">-- prefix_20_selectivity: 0.9500  (95%的区分度)</span>
<span class="hljs-comment">-- prefix_50_selectivity: 0.9950  (99.5%的区分度)</span>
<span class="hljs-comment">-- prefix_100_selectivity: 0.9990 (99.9%的区分度，但空间开销大)</span>

<span class="hljs-comment">-- 根据业务需求选择：如果95%的区分度已足够，选择前缀长度20</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_url_prefix <span class="hljs-keyword">ON</span> articles(url(<span class="hljs-number">20</span>));
</code></pre>
<h5 data-id="heading-17">前缀索引的局限性</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 前缀索引无法用于ORDER BY和GROUP BY</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> url; <span class="hljs-comment">-- 无法利用前缀索引完成排序</span>

<span class="hljs-comment">-- ❌ 前缀索引无法用于覆盖索引</span>
<span class="hljs-comment">-- 如果查询需要完整的url值，仍然需要回表</span>
<span class="hljs-keyword">SELECT</span> url <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> url <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'https://example.com%'</span>;
<span class="hljs-comment">-- 即使命中前缀索引，由于索引只存储了前N个字符，仍需回表获取完整url</span>
</code></pre>
<p><strong>建议</strong>：</p>
<ul>
<li>前缀长度选择：区分度达到90%以上即可，不用追求100%</li>
<li>常见场景：邮箱、URL、身份证号等长字符串字段</li>
<li>注意权衡：查询性能 vs 存储空间 vs 索引维护成本，没有标准答案，看业务需求</li>
</ul>
<hr/>
<h3 data-id="heading-18">三、索引级别：如何设计索引结构？</h3>
<h4 data-id="heading-19">原则5：尽量使用联合索引，减少单列索引，查询时，联合索引很多时候可以覆盖索引，节省存储空间，避免回表，提高查询效率</h4>
<p>联合索引可以同时满足多个查询条件，还能实现覆盖索引优化。<strong>一个联合索引往往能顶多个单列索引</strong>，既省空间又提性能。</p>
<h5 data-id="heading-20">联合索引 vs 多个单列索引</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    created_at DATETIME,
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
);

<span class="hljs-comment">-- ❌ 方案1：多个单列索引（不推荐）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_id <span class="hljs-keyword">ON</span> orders(user_id);
<span class="hljs-keyword">CREATE</span> INDEX idx_status <span class="hljs-keyword">ON</span> orders(status);
<span class="hljs-keyword">CREATE</span> INDEX idx_created_at <span class="hljs-keyword">ON</span> orders(created_at);

<span class="hljs-comment">-- 问题1：存储空间大（每个索引都是独立的B+树）</span>
<span class="hljs-comment">-- 问题2：查询多条件时，可能只使用其中一个索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span> <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2025-01-01'</span>;
<span class="hljs-comment">-- 优化器可能只选择其中一个索引，其他条件需要回表过滤</span>

<span class="hljs-comment">-- ✅ 方案2：联合索引（推荐）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_status_created <span class="hljs-keyword">ON</span> orders(user_id, status, created_at);

<span class="hljs-comment">-- 优势1：一次索引查找可以满足多个条件</span>
<span class="hljs-comment">-- 优势2：如果查询字段都在索引中，可以实现覆盖索引</span>
<span class="hljs-keyword">SELECT</span> user_id, status, created_at 
<span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-comment">-- Extra: Using index（覆盖索引，无需回表）</span>
</code></pre>
<h5 data-id="heading-21">联合索引的覆盖索引优势</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 用户行为表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_actions (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,
    action_type <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    created_at DATETIME,
    action_detail TEXT  <span class="hljs-comment">-- 大字段，存储在数据页</span>
);

<span class="hljs-comment">-- 联合索引设计</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_action_created <span class="hljs-keyword">ON</span> user_actions(user_id, action_type, created_at);

<span class="hljs-comment">-- ✅ 覆盖索引查询：无需回表</span>
<span class="hljs-keyword">SELECT</span> user_id, action_type, created_at 
<span class="hljs-keyword">FROM</span> user_actions 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> action_type <span class="hljs-operator">=</span> <span class="hljs-string">'LOGIN'</span>;
<span class="hljs-comment">-- Explain结果：Extra = "Using index"</span>

<span class="hljs-comment">-- ❌ 非覆盖索引查询：需要回表</span>
<span class="hljs-keyword">SELECT</span> user_id, action_type, created_at, action_detail 
<span class="hljs-keyword">FROM</span> user_actions 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> action_type <span class="hljs-operator">=</span> <span class="hljs-string">'LOGIN'</span>;
<span class="hljs-comment">-- Explain结果：Extra = "Using index condition"（需要回表读取action_detail）</span>
</code></pre>
<p><strong>性能对比</strong>：</p>





























<table><thead><tr><th>场景</th><th>单列索引</th><th>联合索引（覆盖）</th><th>性能提升</th></tr></thead><tbody><tr><td>存储空间</td><td>3个独立索引</td><td>1个联合索引</td><td>节省约60%空间</td></tr><tr><td>查询耗时</td><td>回表读取</td><td>无需回表</td><td>减少50-80%IO</td></tr><tr><td>索引维护</td><td>3次维护</td><td>1次维护</td><td>写入性能提升</td></tr></tbody></table>
<h5 data-id="heading-22">联合索引的设计顺序</h5>
<p>联合索引的列顺序非常重要，遵循<strong>最左前缀原则</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 索引：idx_user_status_created (user_id, status, created_at)</span>

<span class="hljs-comment">-- ✅ 可以利用索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span> <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2025-01-01'</span>;

<span class="hljs-comment">-- ❌ 无法利用索引（跳过最左列）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> created_at <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2025-01-01'</span>;

<span class="hljs-comment">-- ⚠️ 部分利用索引（只能用到user_id）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2025-01-01'</span>;
</code></pre>
<p><strong>设计原则</strong>：</p>
<ol>
<li><strong>WHERE条件频率</strong>：将最常作为查询条件的列放在最前面</li>
<li><strong>选择性高低</strong>：将区分度高的列放在前面</li>
<li><strong>等值 vs 范围</strong>：等值查询列在前，范围查询列在后</li>
<li><strong>排序需求</strong>：如果需要<code>ORDER BY</code>，将排序字段放在索引末尾</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 实战案例：设计一个电商订单查询索引</span>

<span class="hljs-comment">-- 查询场景1：根据用户ID查询（90%的查询）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- 查询场景2：根据用户ID和状态查询（8%的查询）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;

<span class="hljs-comment">-- 查询场景3：根据用户ID和日期范围查询（2%的查询）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> created_at <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2025-01-01'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2025-01-31'</span>;

<span class="hljs-comment">-- ✅ 推荐索引设计</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_status_created <span class="hljs-keyword">ON</span> orders(user_id, status, created_at <span class="hljs-keyword">DESC</span>);

<span class="hljs-comment">-- 理由：</span>
<span class="hljs-comment">-- 1. user_id 放在最前面（最高频查询条件）</span>
<span class="hljs-comment">-- 2. status 放在中间（选择性较高，且常与user_id组合查询）</span>
<span class="hljs-comment">-- 3. created_at 放在最后（支持范围查询和排序，DESC匹配业务需求）</span>
</code></pre>
<hr/>
<h4 data-id="heading-23">原则6：要控制索引的数量，索引并不是多多益善，索引越多，维护索引结构的代价也就越大，会影响增删改的效率</h4>
<p>索引是一把双刃剑。<strong>建多了，查询快但写入慢；建少了，写入快但查询慢</strong>。关键是要找到平衡点。</p>
<h5 data-id="heading-24">索引对写入性能的影响</h5>
<p>每次<code>INSERT</code>、<code>UPDATE</code>、<code>DELETE</code>操作，都需要维护相关索引：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">UNIQUE</span>,
    phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    age <span class="hljs-type">INT</span>,
    city <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    status TINYINT,
    created_at DATETIME,
    updated_at DATETIME
);

<span class="hljs-comment">-- ❌ 过度索引：为每个字段都建立索引</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_username <span class="hljs-keyword">ON</span> users(username);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_email <span class="hljs-keyword">ON</span> users(email);
<span class="hljs-keyword">CREATE</span> INDEX idx_phone <span class="hljs-keyword">ON</span> users(phone);
<span class="hljs-keyword">CREATE</span> INDEX idx_age <span class="hljs-keyword">ON</span> users(age);
<span class="hljs-keyword">CREATE</span> INDEX idx_city <span class="hljs-keyword">ON</span> users(city);
<span class="hljs-keyword">CREATE</span> INDEX idx_status <span class="hljs-keyword">ON</span> users(status);
<span class="hljs-keyword">CREATE</span> INDEX idx_created <span class="hljs-keyword">ON</span> users(created_at);
<span class="hljs-keyword">CREATE</span> INDEX idx_updated <span class="hljs-keyword">ON</span> users(updated_at);
<span class="hljs-comment">-- 总共8个索引（包括主键）</span>

<span class="hljs-comment">-- 写入性能测试</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (username, email, phone, age, city, status) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'user1'</span>, <span class="hljs-string">'user1@example.com'</span>, <span class="hljs-string">'13800138000'</span>, <span class="hljs-number">25</span>, <span class="hljs-string">'Beijing'</span>, <span class="hljs-number">1</span>);
<span class="hljs-comment">-- 需要维护：主键索引 + 8个二级索引 = 9次索引更新</span>
<span class="hljs-comment">-- 写入耗时：~15ms</span>
</code></pre>
<p><strong>性能影响分析</strong>：</p>








































<table><thead><tr><th>索引数量</th><th>INSERT耗时</th><th>UPDATE耗时</th><th>DELETE耗时</th><th>索引维护成本</th></tr></thead><tbody><tr><td>1个（主键）</td><td>2ms</td><td>2ms</td><td>2ms</td><td>低</td></tr><tr><td>3个索引</td><td>5ms</td><td>6ms</td><td>5ms</td><td>中</td></tr><tr><td>5个索引</td><td>10ms</td><td>12ms</td><td>10ms</td><td>中高</td></tr><tr><td>8个索引</td><td>15ms</td><td>18ms</td><td>15ms</td><td>高</td></tr></tbody></table>
<h5 data-id="heading-25">如何控制索引数量？</h5>
<p><strong>策略1：合并单列索引为联合索引</strong></p>
<pre><code class="hljs language-scss" lang="scss">-- ❌ 不推荐：多个单列索引
CREATE INDEX idx_user_id ON <span class="hljs-built_in">orders</span>(user_id);
CREATE INDEX idx_status ON <span class="hljs-built_in">orders</span>(status);
CREATE INDEX idx_created_at ON <span class="hljs-built_in">orders</span>(created_at);

-- ✅ 推荐：合并为联合索引（如果经常组合查询）
CREATE INDEX idx_user_status_created ON <span class="hljs-built_in">orders</span>(user_id, status, created_at);
</code></pre>
<p><strong>策略2：删除低频使用的索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询索引使用情况（MySQL 5.7+）</span>
<span class="hljs-keyword">SELECT</span> 
    OBJECT_SCHEMA,
    OBJECT_NAME,
    INDEX_NAME,
    COUNT_FETCH,
    COUNT_INSERT,
    COUNT_UPDATE,
    COUNT_DELETE
<span class="hljs-keyword">FROM</span> performance_schema.table_io_waits_summary_by_index_usage
<span class="hljs-keyword">WHERE</span> OBJECT_SCHEMA <span class="hljs-operator">=</span> <span class="hljs-string">'your_database'</span>
  <span class="hljs-keyword">AND</span> OBJECT_NAME <span class="hljs-operator">=</span> <span class="hljs-string">'orders'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> COUNT_FETCH <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- 如果某个索引的COUNT_FETCH为0或很小，考虑删除</span>
<span class="hljs-comment">-- 注意：需要观察一段时间，避免删除季节性查询使用的索引</span>
</code></pre>
<p><strong>策略3：为不同业务场景设计不同索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表：同时支持C端用户查询和B端运营查询</span>

<span class="hljs-comment">-- C端查询场景（高频）：用户查看自己的订单</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_status_created <span class="hljs-keyword">ON</span> orders(user_id, status, created_at <span class="hljs-keyword">DESC</span>);

<span class="hljs-comment">-- B端查询场景（低频）：运营按状态查询所有订单</span>
<span class="hljs-comment">-- 如果频率不高，可以不建索引，或使用其他优化手段（如分区表、ES等）</span>
<span class="hljs-comment">-- 如果必须建，考虑建立单独的索引，但需要评估写入性能影响</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status_created <span class="hljs-keyword">ON</span> orders(status, created_at <span class="hljs-keyword">DESC</span>);
</code></pre>
<p><strong>经验值</strong>（仅供参考）：</p>
<ul>
<li><strong>单表索引数量控制在5-7个以内</strong>，更容易管理和维护</li>
<li><strong>核心业务表</strong>：可以适当放宽到8-10个，但需要严格监控写入性能</li>
<li><strong>配置表/日志表</strong>：建议不超过3个索引，毕竟写入频率高</li>
</ul>
<h5 data-id="heading-26">索引维护成本的量化</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 监控索引维护成本</span>
<span class="hljs-comment">-- 1. 查看表的总索引大小</span>
<span class="hljs-keyword">SELECT</span> 
    table_name,
    ROUND(<span class="hljs-built_in">SUM</span>(index_length) <span class="hljs-operator">/</span> <span class="hljs-number">1024</span> <span class="hljs-operator">/</span> <span class="hljs-number">1024</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> index_size_mb,
    ROUND(<span class="hljs-built_in">SUM</span>(data_length) <span class="hljs-operator">/</span> <span class="hljs-number">1024</span> <span class="hljs-operator">/</span> <span class="hljs-number">1024</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> data_size_mb,
    ROUND(<span class="hljs-built_in">SUM</span>(index_length) <span class="hljs-operator">/</span> <span class="hljs-built_in">SUM</span>(data_length) <span class="hljs-operator">*</span> <span class="hljs-number">100</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> index_ratio_percent
<span class="hljs-keyword">FROM</span> information_schema.tables
<span class="hljs-keyword">WHERE</span> table_schema <span class="hljs-operator">=</span> <span class="hljs-string">'your_database'</span>
  <span class="hljs-keyword">AND</span> table_name <span class="hljs-operator">=</span> <span class="hljs-string">'orders'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> table_name;

<span class="hljs-comment">-- 如果index_ratio_percent &gt; 50%，说明索引占用空间过大，需要优化</span>

<span class="hljs-comment">-- 2. 监控写入性能</span>
<span class="hljs-comment">-- 通过慢查询日志或performance_schema监控INSERT/UPDATE/DELETE的耗时</span>
</code></pre>
<hr/>
<h4 data-id="heading-27">原则7：如果索引列不能存储NULL值，请在创建表时使用NOT NULL约束它。当优化器知道每列是否包含NULL值时，它可以更好地确定哪个索引最有效地用于查询</h4>
<p><code>NOT NULL</code>约束不仅能保证数据完整性，还能帮助优化器做出更好的索引选择决策。**优化器知道字段不会有NULL值，就能更准确地估算查询成本，选择最优索引 **。</p>
<h5 data-id="heading-28">NULL值对索引的影响</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 允许NULL值的索引</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)  <span class="hljs-comment">-- 允许NULL</span>
);

<span class="hljs-keyword">CREATE</span> INDEX idx_phone <span class="hljs-keyword">ON</span> users(phone);

<span class="hljs-comment">-- 问题1：NULL值在索引中的存储</span>
<span class="hljs-comment">-- B+树索引中，NULL值通常会被特殊处理，可能影响索引的紧凑性</span>

<span class="hljs-comment">-- 问题2：查询时需要额外判断NULL</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">'13800138000'</span>;
<span class="hljs-comment">-- 如果phone字段允许NULL，查询计划可能需要考虑NULL值的情况</span>

<span class="hljs-comment">-- 问题3：统计信息可能不够准确</span>
<span class="hljs-comment">-- NULL值的存在可能影响索引的选择性统计，导致优化器选择错误的索引</span>
</code></pre>
<h5 data-id="heading-29">NOT NULL的优化优势</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ✅ 使用NOT NULL约束</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,  <span class="hljs-comment">-- 明确不允许NULL</span>
    age <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    status TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>
);

<span class="hljs-keyword">CREATE</span> INDEX idx_phone <span class="hljs-keyword">ON</span> users(phone);
<span class="hljs-keyword">CREATE</span> INDEX idx_status_age <span class="hljs-keyword">ON</span> users(status, age);

<span class="hljs-comment">-- 优势1：优化器可以更准确地估算索引选择性</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">'13800138000'</span>;
<span class="hljs-comment">-- 优化器知道phone字段不会有NULL值，可以更准确地计算查询成本</span>

<span class="hljs-comment">-- 优势2：索引结构更紧凑</span>
<span class="hljs-comment">-- 不需要为NULL值预留空间或特殊处理</span>

<span class="hljs-comment">-- 优势3：查询可以更简单</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> phone <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>; <span class="hljs-comment">-- 如果phone是NOT NULL，这个条件永远为真</span>
</code></pre>
<h5 data-id="heading-30">实战案例：优化器选择索引</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表设计对比</span>

<span class="hljs-comment">-- 方案1：允许NULL（不推荐）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_v1 (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,           <span class="hljs-comment">-- 允许NULL</span>
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),       <span class="hljs-comment">-- 允许NULL</span>
    created_at DATETIME,      <span class="hljs-comment">-- 允许NULL</span>
    INDEX idx_user_status (user_id, status)
);

<span class="hljs-comment">-- 查询：优化器需要判断NULL值的影响</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders_v1 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-comment">-- 优化器可能认为：如果user_id或status可能为NULL，索引效果可能不佳</span>

<span class="hljs-comment">-- 方案2：使用NOT NULL（推荐）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_v2 (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,      <span class="hljs-comment">-- 明确NOT NULL</span>
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,  <span class="hljs-comment">-- 明确NOT NULL</span>
    created_at DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- 明确NOT NULL</span>
    INDEX idx_user_status (user_id, status)
);

<span class="hljs-comment">-- 查询：优化器可以更自信地使用索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders_v2 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-comment">-- 优化器知道所有行都有user_id和status值，可以更准确地选择索引</span>
</code></pre>
<h5 data-id="heading-31">如何为现有表添加NOT NULL约束？</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 步骤1：检查现有数据是否包含NULL值</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> total_rows,
    <span class="hljs-built_in">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> phone <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> null_count
<span class="hljs-keyword">FROM</span> users;

<span class="hljs-comment">-- 步骤2：如果存在NULL值，先更新为默认值</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">''</span> <span class="hljs-keyword">WHERE</span> phone <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;

<span class="hljs-comment">-- 步骤3：添加NOT NULL约束</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users MODIFY <span class="hljs-keyword">COLUMN</span> phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span>;

<span class="hljs-comment">-- 步骤4：验证约束生效</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users;
</code></pre>
<p><strong>建议</strong>：</p>
<ol>
<li><strong>建表时就定义NOT NULL</strong>：避免后续修改的麻烦（改表结构可能锁表）</li>
<li><strong>为NOT NULL字段设置合理的默认值</strong>：如<code>DEFAULT ''</code>、<code>DEFAULT 0</code>、<code>DEFAULT CURRENT_TIMESTAMP</code></li>
<li><strong>业务层面保证数据完整性</strong>：应用层校验 + 数据库约束双重保障，更稳妥</li>
</ol>
<hr/>
<h3 data-id="heading-32">四、索引设计实战：完整案例</h3>
<h4 data-id="heading-33">案例：电商订单系统的索引设计</h4>
<p>假设我们需要设计一个电商订单表的索引，以下是业务场景和SQL查询模式：</p>
<p><strong>业务场景</strong>：</p>
<ul>
<li>
<p>表数据量：1000万+订单</p>
</li>
<li>
<p>写入频率：每秒1000+订单</p>
</li>
<li>
<p>查询场景：</p>
<ol>
<li>用户查看自己的订单列表（按创建时间倒序） - 80%查询</li>
<li>用户按状态筛选订单 - 15%查询</li>
<li>运营按状态统计订单 - 5%查询</li>
</ol>
</li>
</ul>
<p><strong>表结构设计</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单号'</span>,
    user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单状态'</span>,
    total_amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单金额'</span>,
    created_at DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'创建时间'</span>,
    updated_at DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'更新时间'</span>,
    INDEX idx_order_no (order_no),
    INDEX idx_user_created (user_id, created_at <span class="hljs-keyword">DESC</span>),
    INDEX idx_user_status_created (user_id, status, created_at <span class="hljs-keyword">DESC</span>)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;
</code></pre>
<p><strong>索引设计分析</strong>：</p>
<ol>
<li><strong>主键索引</strong>：<code>id</code> - 必须的，用于唯一标识和聚簇索引</li>
<li><strong>唯一索引</strong>：<code>idx_order_no</code> - 订单号查询，区分度高（100%）</li>
<li><strong>联合索引1</strong>：<code>idx_user_created</code> - 覆盖场景1（用户查看订单列表）</li>
<li><strong>联合索引2</strong>：<code>idx_user_status_created</code> - 覆盖场景2（用户按状态筛选）</li>
</ol>
<p><strong>查询场景验证</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 场景1：用户查看订单列表（命中idx_user_created）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">DESC</span> 
LIMIT <span class="hljs-number">20</span>;
<span class="hljs-comment">-- type: ref, key: idx_user_created, Extra: Using index condition</span>

<span class="hljs-comment">-- 场景2：用户按状态筛选订单（命中idx_user_status_created）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span> 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">DESC</span>;
<span class="hljs-comment">-- type: ref, key: idx_user_status_created, Extra: Using index condition</span>

<span class="hljs-comment">-- 场景3：运营统计（考虑是否需要单独索引）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> status, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> created_at <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2025-01-01'</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status;
<span class="hljs-comment">-- 如果频率不高，可以不建索引；如果频率高，考虑建立idx_status_created</span>
</code></pre>
<p><strong>优化建议</strong>：</p>
<ol>
<li><strong>索引数量控制</strong>：当前4个索引（含主键），符合"5-7个"原则</li>
<li><strong>索引合并优化</strong>：<code>idx_user_created</code>和<code>idx_user_status_created</code>有重叠，但为了覆盖不同查询场景，保留两个索引是合理的</li>
<li><strong>覆盖索引优化</strong>：如果查询只需要部分字段，可以调整索引包含的列，实现覆盖索引：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 如果查询只需要id、user_id、status、created_at</span>
<span class="hljs-comment">-- 可以设计覆盖索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_status_created_covering 
<span class="hljs-keyword">ON</span> orders(user_id, status, created_at <span class="hljs-keyword">DESC</span>, id);

<span class="hljs-comment">-- 查询时可以实现覆盖索引</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> id, user_id, status, created_at 
<span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-comment">-- Extra: Using index（无需回表）</span>
</code></pre>
<hr/>
<h3 data-id="heading-34">五、索引设计检查清单</h3>
<p>在实际项目中，建议使用以下检查清单来评估索引设计是否合理：</p>
<h4 data-id="heading-35">✅ 表级别检查</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 表数据量是否足够大（&gt;1000行）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 表是否高频查询？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否评估过索引对写入性能的影响？</li>
</ul>
<h4 data-id="heading-36">✅ 字段级别检查</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否为WHERE条件的字段建立了索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否为ORDER BY的字段建立了索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否为GROUP BY的字段建立了索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 字段区分度是否足够高（&gt;30%）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 字符串字段是否考虑使用前缀索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 索引字段是否设置为NOT NULL？</li>
</ul>
<h4 data-id="heading-37">✅ 索引级别检查</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否优先使用联合索引而非多个单列索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 联合索引的列顺序是否遵循最左前缀原则？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否考虑了覆盖索引优化？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 索引数量是否控制在合理范围（5-7个）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否定期清理低频使用的索引？</li>
</ul>
<h4 data-id="heading-38">✅ 性能验证</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用<code>EXPLAIN</code>验证索引使用情况？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否监控索引的查询命中率？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否评估索引对写入性能的影响？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否定期更新表的统计信息（<code>ANALYZE TABLE</code>）？</li>
</ul>
<hr/>
<h3 data-id="heading-39">六、常见误区与避坑指南</h3>
<h4 data-id="heading-40">误区1：为所有字段都建立索引</h4>
<p><strong>错误做法</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">-- ❌ 为每个字段都建立索引
CREATE <span class="hljs-selector-tag">TABLE</span> users (...);
CREATE INDEX idx_field1 ON <span class="hljs-built_in">users</span>(field1);
CREATE INDEX idx_field2 ON <span class="hljs-built_in">users</span>(field2);
CREATE INDEX idx_field3 ON <span class="hljs-built_in">users</span>(field3);
-- ... <span class="hljs-number">10</span>多个索引
</code></pre>
<p><strong>正确做法</strong>：</p>
<ul>
<li>只为核心查询字段建立索引</li>
<li>通过慢查询日志分析真实查询模式</li>
<li>定期审计索引使用情况，删除无用索引</li>
</ul>
<h4 data-id="heading-41">误区2：忽略索引维护成本</h4>
<p><strong>错误做法</strong>：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-- ❌ 只看查询性能，忽略写入性能</span>
<span class="hljs-deletion">-- 某个表有15个索引，查询很快，但写入慢如蜗牛</span>
</code></pre>
<p><strong>正确做法</strong>：</p>
<ul>
<li>建立索引前评估写入频率</li>
<li>对于写多读少的表，严格控制索引数量</li>
<li>监控写入性能指标（TPS、延迟）</li>
</ul>
<h4 data-id="heading-42">误区3：联合索引顺序随意设计</h4>
<p><strong>错误做法</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">-- ❌ 不考虑查询模式，随意设计索引顺序
CREATE INDEX idx_created_user_status ON orders(created_at, user_id, status)<span class="hljs-comment">;</span>
-- 但实际查询是 WHERE <span class="hljs-attr">user_id</span> = ? AND status = ?
</code></pre>
<p><strong>正确做法</strong>：</p>
<ul>
<li>分析所有查询SQL，找出最常用的查询模式</li>
<li>按照查询频率和选择性设计索引顺序</li>
<li>使用<code>EXPLAIN</code>验证索引是否被正确使用</li>
</ul>
<h4 data-id="heading-43">误区4：过度依赖覆盖索引</h4>
<p><strong>错误做法</strong>：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- ❌ 为了覆盖索引，把很多字段都加到索引中</span>
CREATE INDEX idx_user_covering ON orders(user_id, <span class="hljs-built_in">status</span>, created_at, amount, ...);
<span class="hljs-comment">-- 索引变得很大，维护成本高</span>
</code></pre>
<p><strong>正确做法</strong>：</p>
<ul>
<li>覆盖索引只包含高频查询的字段</li>
<li>权衡索引大小和维护成本</li>
<li>对于低频查询，可以接受回表操作</li>
</ul>
<hr/>
<h3 data-id="heading-44">七、总结</h3>
<p>索引设计是一个需要<strong>权衡</strong>的过程，没有银弹，只有最适合的方案。本文从<strong>表→字段→索引</strong>三个层次，系统梳理了7条核心设计原则：</p>
<h4 data-id="heading-45">核心原则回顾</h4>
<ol>
<li><strong>表级别</strong>：数据量大且查询频繁的表才建索引</li>
<li><strong>字段级别</strong>：为WHERE/ORDER BY/GROUP BY字段建索引</li>
<li><strong>区分度优先</strong>：选择区分度高的字段，尽量建唯一索引</li>
<li><strong>前缀索引</strong>：长字符串字段使用前缀索引平衡性能和存储</li>
<li><strong>联合索引</strong>：优先使用联合索引，实现覆盖索引优化</li>
<li><strong>控制数量</strong>：索引数量控制在5-7个，平衡查询和写入性能</li>
<li><strong>NOT NULL约束</strong>：索引字段使用NOT NULL，帮助优化器做出更好决策</li>
</ol>
<h4 data-id="heading-46">设计流程建议</h4>
<ol>
<li><strong>需求分析</strong>：收集所有查询SQL，分析查询模式</li>
<li><strong>优先级排序</strong>：按查询频率和重要性排序</li>
<li><strong>索引设计</strong>：根据7条原则设计索引</li>
<li><strong>性能验证</strong>：使用<code>EXPLAIN</code>和性能测试验证效果</li>
<li><strong>持续优化</strong>：定期审计索引使用情况，优化调整</li>
</ol>
<hr/>
<p><strong>记住</strong>：索引是优化数据库性能的重要手段，但不是唯一手段。在设计索引时，要结合业务场景、数据量、查询模式、写入频率等多个因素综合考虑，才能设计出真正高效的索引方案。</p>
<hr/>
<h3 data-id="heading-47">相关文章</h3>
<p>想要系统学习MySQL索引，可以阅读以下文章：</p>
<ul>
<li><strong>索引基础</strong>：<a href="https://juejin.cn/post/7564977973259976730" target="_blank" title="https://juejin.cn/post/7564977973259976730">图解MySQL索引：从二叉树到B+树的演进之路（基础篇）</a></li>
<li><strong>性能分析</strong>：<a href="https://juejin.cn/post/7567257202194776091" target="_blank" title="https://juejin.cn/post/7567257202194776091">MySQL索引：SQL性能分析工具详解（进阶篇）</a></li>
<li><strong>使用技巧</strong>：<a href="https://juejin.cn/post/7570271574348038153" target="_blank" title="https://juejin.cn/post/7570271574348038153">MySQL索引优化实战：原则速查与踩坑案例（实战篇）</a></li>
<li><strong>设计原则</strong>：<a href="#" title="#">MySQL索引设计原则：从理论到实践的完整指南</a> （本文）</li>
</ul>
<h4 data-id="heading-48">扩展阅读</h4>
<ul>
<li><strong>存储引擎</strong>：<a href="https://juejin.cn/post/7552030609582784522" target="_blank" title="https://juejin.cn/post/7552030609582784522">MySQL存储引擎详解：老王教你如何选择合适的"发动机"</a></li>
</ul>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[goup是一个纯Rust编写的优雅的Go多版本管理工具]]></title>    <link>https://juejin.cn/post/7577713754563461172</link>    <guid>https://juejin.cn/post/7577713754563461172</guid>    <pubDate>2025-11-30T06:32:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577713754563461172" data-draft-id="7577713754563444788" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="goup是一个纯Rust编写的优雅的Go多版本管理工具"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-11-30T06:32:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="5197"/> <meta itemprop="url" content="https://juejin.cn/user/3186802516829016"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            goup是一个纯Rust编写的优雅的Go多版本管理工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3186802516829016/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    5197
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:32:29.000Z" title="Sun Nov 30 2025 06:32:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">goup</h2>
<p><em><strong>注意</strong></em>: <code>goup-rs</code>仍在积极开发中, 因此在达到v1.0.0之前不能保证完全向后兼容</p>
<h3 data-id="heading-1">特性</h3>
<ul>
<li>最小依赖, 依赖于<code>git</code>(仅<code>nightly|tip|gotip</code>版本需要<code>git</code>).</li>
<li>跨平台的能力(Linux, macOS &amp; Windows).</li>
<li>支持使用<code>goup install/remove [TOOLCHAIN]</code> 安装/卸载 Go版本.</li>
<li>支持使用<code>goup install &lt;nightly|tip|gotip&gt;</code> 从源码安装Go, 需要<code>git</code>.</li>
<li>支持列出本地已安装的版本.</li>
<li>支持在多个已安装的版本中切换.</li>
<li>支持搜索可用的Go版本.</li>
<li>✨支持在shell会话中使用特定的Go版本(&gt;= v0.15.x).</li>
<li>✨支持多个下载后端<code>GOUP_GO_REGISTRY_INDEX</code>/<code>GOUP_GO_REGISTRY</code>(&gt;=v0.16.x).</li>
<li>支持管理本地缓存文件(如 <code>*.tar.gz</code>, <code>*.tar.gz.sha256</code>).</li>
<li>支持<code>goup</code>自我更新.</li>
<li>支持自定义<code>GOUP_HOME</code>(默认<code>$HOME/.goup</code>)(&gt;= v0.11.x);</li>
<li>友好的提示.</li>
<li>应该很快.</li>
</ul>
<p><code>goup</code> 是对上述特性的一种尝试, 其灵感主要来自于 <a href="https://link.juejin.cn?target=https%3A%2F%2Frustup.rs%2F" target="_blank" title="https://rustup.rs/" ref="nofollow noopener noreferrer">Rustup</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgolang%2Fdl" target="_blank" title="https://github.com/golang/dl" ref="nofollow noopener noreferrer">golang/dl</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fowenthereal%2Fgoup" target="_blank" title="https://github.com/owenthereal/goup" ref="nofollow noopener noreferrer">goup</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsyndbg%2Fgoenv" target="_blank" title="https://github.com/syndbg/goenv" ref="nofollow noopener noreferrer">goenv</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoovweb%2Fgvm" target="_blank" title="https://github.com/moovweb/gvm" ref="nofollow noopener noreferrer">gvm</a> and <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgolang%2Ftools%2Ftree%2Fmaster%2Fcmd%2Fgetgo" target="_blank" title="https://github.com/golang/tools/tree/master/cmd/getgo" ref="nofollow noopener noreferrer">getgo</a>.</p>
<h3 data-id="heading-2">构建功能标志</h3>
<ul>
<li><code>no-self-update</code> 关闭自我更新.</li>
</ul>
<h3 data-id="heading-3">安装</h3>
<h4 data-id="heading-4">使用Cargo</h4>
<p>或者, 也可以使用<code>cargo</code>安装.</p>
<pre><code class="hljs language-shell" lang="shell">cargo install goup-rs
</code></pre>
<p>或</p>
<pre><code class="hljs language-shell" lang="shell">cargo install goup-rs --git https://github.com/thinkgos/goup-rs
</code></pre>
<ul>
<li>(<em>仅支持 Linux/MacOS</em>) 运行<code>goup init</code>, 获取到shell启动脚本位于<code>$HOME/.goup/env</code>.</li>
<li>(<em>仅支持 Linux/MacOS</em>) 在shell启动脚本中添加Go的bin目录:
<ul>
<li>bash: <code>echo '. "$HOME/.goup/env"' &gt;&gt; ~/.bashrc</code></li>
<li>zsh:  <code>echo '. "$HOME/.goup/env"' &gt;&gt; ~/.zshenv</code></li>
<li>fish: <code>echo 'source ~/.goup/env' &gt;&gt; ~/.config/fish/config.fish</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">手动安装(Linux/MacOS)</h4>
<p>如果您想手动安装, 步骤如下:</p>
<ul>
<li>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Freleases" target="_blank" title="https://github.com/thinkgos/goup-rs/releases" ref="nofollow noopener noreferrer">Release Page</a>下载最新的<code>goup</code>.</li>
<li>将<code>goup</code>可执行文件放到<code>PATH</code>中, 并给予可执行权限: <code>mv GOUP_BIN /usr/local/bin/goup &amp;&amp; chmod +x /usr/local/bin/goup</code></li>
<li>运行<code>goup init</code>, 获取到shell启动脚本位于<code>$HOME/.goup/env</code>.</li>
<li>在shell启动脚本中添加Go的bin目录:
<ul>
<li>bash: <code>echo '. "$HOME/.goup/env"' &gt;&gt; ~/.bashrc</code></li>
<li>zsh:  <code>echo '. "$HOME/.goup/env"' &gt;&gt; ~/.zshenv</code></li>
<li>fish: <code>echo 'source ~/.goup/env' &gt;&gt; ~/.config/fish/config.fish</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">手动安装(Windows)</h4>
<h5 data-id="heading-7">MSI安装</h5>
<p>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Freleases" target="_blank" title="https://github.com/thinkgos/goup-rs/releases" ref="nofollow noopener noreferrer">Release Page</a>下载最新的<code>goup</code>的MSI安装程序并运行.</p>
<h5 data-id="heading-8">二进制安装</h5>
<ul>
<li>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Freleases" target="_blank" title="https://github.com/thinkgos/goup-rs/releases" ref="nofollow noopener noreferrer">Release Page</a>下载最新的<code>goup</code>的二进制程序并解压.</li>
<li>将<code>goup.exe</code>移至<code>$YOUR_PATH</code>.</li>
<li>将<code>$YOUR_PATH</code>加到windows环境变量中.</li>
</ul>
<h3 data-id="heading-9">快速入门</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash">goup install</span>
[2024-01-30T00:38:48Z INFO ] Installing go1.21.10 ...
[2024-01-30T00:38:48Z INFO ] Unpacking /home/thinkgo/.goup/go1.21.10/go1.21.10.linux-amd64.tar.gz ...
[2024-01-30T00:38:48Z INFO ] go1.21.10 installed in /home/thinkgo/.goup/go1.21.10
[2024-01-30T00:38:48Z INFO ] Default Go is set to 'go1.21.10'
<span class="hljs-meta prompt_">$ </span><span class="bash">goup list</span>
1.21.10  (active, default)
<span class="hljs-meta prompt_">$ </span><span class="bash">go <span class="hljs-built_in">env</span> GOROOT</span>
/home/thinkgo/.goup/current
<span class="hljs-meta prompt_">$ </span><span class="bash">go version</span>
go version go1.21.10 linux/amd64
<span class="hljs-meta prompt_">$ </span><span class="bash">GOUP_GO_REGISTRY_INDEX=https://golang.google.cn goup install =1.21.10</span>
</code></pre>
<h3 data-id="heading-10">使用方法</h3>
<h4 data-id="heading-11">列出所有可用的go版本</h4>
<p><code>goup search [FILTER]</code>, <code>[FILTER]</code>支持的值: <strong>'stable'</strong>, <strong>'unstable'</strong>, <strong>'beta'</strong> 或 <strong>any regex string</strong>.</p>
<pre><code class="hljs language-bash" lang="bash">$ goup search
1
...
1.21rc4
1.22rc1
$ goup search stable
1
...
1.21.4
1.21.5
1.21.10
</code></pre>
<h4 data-id="heading-12">列出所有位于<code>$HOME/.goup</code>已安装的Go版本</h4>
<pre><code class="hljs language-bash" lang="bash">$ goup list 
1.21.10
1.22.3  (active, default)
tip
</code></pre>
<h4 data-id="heading-13">安装指定Go版本</h4>
<p><code>goup install/update [TOOLCHAIN]</code>, <code>[TOOLCHAIN]</code> 支持的值: <strong>'stable'(default)</strong>, <strong>'nightly'</strong>(<strong>'tip'</strong>, <strong>'gotip'</strong>), <strong>'unstable'</strong>, <strong>'beta'</strong> 或 <strong>'=1.21.4'</strong>, <code>--dry</code> 表示只安装对应版本, 但并不切换使用.</p>
<p><code>[TOOLCHAIN]</code> 支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fsemver.org%2F" target="_blank" title="https://semver.org/" ref="nofollow noopener noreferrer"><code>semver</code></a>语法匹配对应版本, 详情查看<a href="#faq" title="#faq">FAQ</a></p>
<pre><code class="hljs language-bash" lang="bash">$ goup install 1.21.*
[2024-01-30T00:38:48Z INFO ] Installing go1.21.10 ...
[2024-01-30T00:38:48Z INFO ] Unpacking /home/thinkgo/.goup/go1.21.10/go1.21.10.linux-amd64.tar.gz ...
[2024-01-30T00:38:48Z INFO ] go1.21.10 installed <span class="hljs-keyword">in</span> /home/thinkgo/.goup/go1.21.10
[2024-01-30T00:38:48Z INFO ] Default Go is <span class="hljs-built_in">set</span> to <span class="hljs-string">'go1.21.10'</span>
$ goup install =1.21.4 --dry
[2024-01-30T00:38:48Z INFO ] Installing go1.21.4 ...
[2024-01-30T00:38:48Z INFO ] Unpacking /home/thinkgo/.goup/go1.21.4/go1.21.4.linux-amd64.tar.gz ...
[2024-01-30T00:38:48Z INFO ] go1.21.10 installed <span class="hljs-keyword">in</span> /home/thinkgo/.goup/go1.21.4
</code></pre>
<h4 data-id="heading-14">切换到选定的Go版本</h4>
<p><code>goup default/use/set [VERSION]</code>, 设置默认的Go版本.</p>
<pre><code class="hljs language-bash" lang="bash">$ goup default 
? Select a version ›
  1.21.5
❯ 1.21.10
  tip
[2024-01-30T00:38:48Z INFO ] Default Go is <span class="hljs-built_in">set</span> to <span class="hljs-string">'go1.21.10'</span>
</code></pre>
<h4 data-id="heading-15">删除指定的 Go 版本列表</h4>
<p><code>goup remove/rm [VERSION]...</code> 删除指定的 Go 版本列表. 如果没有提供版本, 将提示选择多个已安装的 Go 版本</p>
<pre><code class="hljs language-bash" lang="bash">$ goup <span class="hljs-built_in">rm</span>
? Select multiple version ›
✔ 1.21.5
⬚ 1.21.10
⬚ tip
✔ Select multiple version · 1.21.5
</code></pre>
<h4 data-id="heading-16">在shell会话中使用特定的Go版本</h4>
<p><code>goup shell [VERSION]</code>, 在shell会话中使用特定的Go版本, 如果没有提供版本, 将自动检测执行路径下的<code>go.work</code>/<code>go.mod</code>的Go版本(可以使用<code>--skip-autodetect</code>跳过), 仍旧没有的话将提示用户选择一个已安装的Go版本.</p>
<pre><code class="hljs language-bash" lang="bash">$ goup shell 1.21.10
? Select a version ›
  1.21.5
❯ 1.21.10
  tip
$ go version
go version go1.21.10 linux/amd64
$ goup list 
1.21.10
1.22.3  (active, default)
tip
</code></pre>
<h4 data-id="heading-17">管理缓存归档文件</h4>
<pre><code class="hljs language-bash" lang="bash">$ goup cache show --contain-sha256
go1.21.10.linux-amd64.tar.gz
go1.21.10.linux-amd64.tar.gz.sha256

$ goup cache clean
✔ Do you want to clean cache file? · <span class="hljs-built_in">yes</span>
</code></pre>
<h4 data-id="heading-18">修改<code>goup</code>安装程序</h4>
<pre><code class="hljs language-bash" lang="bash">$ goup self update
Checking target-arch... x86_64-unknown-linux-gnu
Checking current version... v0.9.0
Checking latest released version... v0.9.0
[2024-01-30T00:38:48Z INFO ] Update status: `v0.9.0`!
</code></pre>
<h4 data-id="heading-19">环境变量值</h4>
<pre><code class="hljs language-bash" lang="bash">$ goup <span class="hljs-built_in">env</span>
+------------------------+--------------------------------+--------------------------------------------------------------+
| Key                    | Value                          | Explain                                                      |
+------------------------+--------------------------------+--------------------------------------------------------------+
| GOUP_HOME              | /home/thinkgo/.goup            | Get goup home directory, default: <span class="hljs-string">'$HOME/.goup'</span>              |
| GOUP_GO_VERSION        | current                        | Shell session target go version, default: <span class="hljs-string">'current'</span>          |
| GOUP_GO_REGISTRY_INDEX | https://golang.google.cn       | Registry index of go version                                 |
| GOUP_GO_REGISTRY       | https://dl.google.com/go       | Registry of go archive file                                  |
| GOUP_GO_SOURCE_GIT_URL | https://github.com/golang/go   | Source git url, use by tip|nightly or index of go version    |
| GOUP_GO_SOURCE_GIT_URL | https://go.googlesource.com/go | Source upstream git url, use by tip|nightly                  |
+------------------------+--------------------------------+--------------------------------------------------------------+
</code></pre>
<h4 data-id="heading-20">Shell补全</h4>
<p><code>goup completion &lt;SHELL&gt;</code>  为指定shell生成补全脚本. <code>&lt;SHELL&gt;</code>支持这些值: <code>bash</code>, <code>elvish</code>, <code>fish</code>, <code>powershell</code>, <code>zsh</code>.</p>
<pre><code class="hljs language-bash" lang="bash">goup completion zsh &gt; _goup
</code></pre>
<h4 data-id="heading-21">更多信息</h4>
<p>执行<code>goup -h</code>获取更多信息</p>
<h3 data-id="heading-22">镜像站</h3>
<h4 data-id="heading-23">索引镜像站</h4>





















































<table><thead><tr><th>索引</th><th>地址</th><th>使用选项<code>--registry-index</code>或环境变量</th><th>备注</th></tr></thead><tbody><tr><td>官方1(默认)</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev" target="_blank" title="https://go.dev" ref="nofollow noopener noreferrer">go.dev</a></td><td><code>official</code> 或 <code>official|https://go.dev</code></td><td/></tr><tr><td>官方2</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgolang.google.cn" target="_blank" title="https://golang.google.cn" ref="nofollow noopener noreferrer">golang.google.cn</a></td><td><code>official|https://golang.google.cn</code></td><td/></tr><tr><td>官方git 1</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgolang%2Fgo" target="_blank" title="https://github.com/golang/go" ref="nofollow noopener noreferrer">github.com/golang/go</a></td><td><code>git</code> 或 <code>git|https://github.com/golang/go</code></td><td>通过git</td></tr><tr><td>官方git 2</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.googlesource.com%2Fgo" target="_blank" title="https://go.googlesource.com/go" ref="nofollow noopener noreferrer">go.googlesource.com/go</a></td><td><code>git|https://go.googlesource.com/go</code></td><td>通过git</td></tr><tr><td>阿里云</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.aliyun.com%2Fgolang" target="_blank" title="https://mirrors.aliyun.com/golang" ref="nofollow noopener noreferrer">mirrors.aliyun.com/golang</a></td><td><code>ngx-fancy-index|https://mirrors.aliyun.com/golang</code></td><td/></tr><tr><td>南京大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.nju.edu.cn%2Fgolang" target="_blank" title="https://mirrors.nju.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.nju.edu.cn/golang</a></td><td><code>ngx-fancy-index|https://mirrors.nju.edu.cn/golang</code></td><td/></tr><tr><td>华中科技大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.hust.edu.cn%2Fgolang" target="_blank" title="https://mirrors.hust.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.hust.edu.cn/golang</a></td><td><code>ngx-fancy-index|https://mirrors.hust.edu.cn/golang</code></td><td/></tr></tbody></table>
<h4 data-id="heading-24">仓库镜像站</h4>





























































<table><thead><tr><th>仓库</th><th>地址</th><th>支持SHA256文件</th><th>支持HTTP获取压缩包长度</th><th>备注</th></tr></thead><tbody><tr><td>官方1(默认)</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdl.google.com%2Fgo" target="_blank" title="https://dl.google.com/go" ref="nofollow noopener noreferrer">dl.google.com/go</a></td><td>✅</td><td>✅</td><td/></tr><tr><td>官方2</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fdl" target="_blank" title="https://go.dev/dl" ref="nofollow noopener noreferrer">go.dev/dl</a></td><td>❌</td><td>✅</td><td/></tr><tr><td>官方3</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgolang.org%2Fdl" target="_blank" title="https://golang.org/dl" ref="nofollow noopener noreferrer">golang.org/dl</a></td><td>❌</td><td>✅</td><td/></tr><tr><td>阿里云</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.aliyun.com%2Fgolang" target="_blank" title="https://mirrors.aliyun.com/golang" ref="nofollow noopener noreferrer">mirrors.aliyun.com/golang</a></td><td>❌</td><td>❌</td><td/></tr><tr><td>南京大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.nju.edu.cn%2Fgolang" target="_blank" title="https://mirrors.nju.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.nju.edu.cn/golang</a></td><td>✅</td><td>✅</td><td/></tr><tr><td>华中科技大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.hust.edu.cn%2Fgolang" target="_blank" title="https://mirrors.hust.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.hust.edu.cn/golang</a></td><td>✅</td><td>✅</td><td/></tr><tr><td>中国科学技术大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.ustc.edu.cn%2Fgolang" target="_blank" title="https://mirrors.ustc.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.ustc.edu.cn/golang</a></td><td>✅</td><td>✅</td><td>❌ 不建议使用</td></tr></tbody></table>
<p><em><strong>NOTE</strong></em>: 有些镜像站不提供<strong>SHA256校验文件</strong>, 在下载时需要使用<code>--skip-verify</code>选项.</p>
<h4 data-id="heading-25">设置镜像站环境变量</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">推存值</span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">export</span> GOUP_GO_REGISTRY_INDEX=<span class="hljs-string">'ngx-fancy-index|https://mirrors.nju.edu.cn/golang'</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">export</span> GOUP_GO_REGISTRY_INDEX=<span class="hljs-string">'git|https://github.com/golang/go'</span></span>
export GOUP_GO_REGISTRY_INDEX=https://go.dev
export GOUP_GO_REGISTRY=https://mirrors.hust.edu.cn/golang
</code></pre>
<h3 data-id="heading-26">工作原理</h3>
<ul>
<li><code>goup completion &lt;SHELL&gt;</code> 为指定shell生成补全脚本.</li>
<li><code>goup [help]</code>  打印此信息或给定子命令的帮助信息.</li>
<li><code>goup install/update/i [TOOLCHAIN]</code> 下载指定的Go版本到<code>$HOME/.goup/go&lt;VERSION|tip&gt;/go</code>并创建一个软链接到<code>$HOME/.goup/current</code>.</li>
<li><code>goup default/use/set [VERSION]</code> 设置默认的Go版本.</li>
<li><code>goup ls/list/show</code> 列出所有位置<code>$HOME/.goup</code>已安装的Go版本.</li>
<li><code>goup remove/rm [VERSION]...</code> 移除指定的Go版本列表.</li>
<li><code>goup search/ls-remote [FILTER]</code> 列出所有可用的Go版本.</li>
<li><code>goup cache [COMMAND]</code> 管理缓存归档文件.</li>
<li><code>goup self &lt;COMMAND&gt;</code> 修改<code>goup</code>安装程序.</li>
<li><code>goup init [SHELL]</code> 将所有必要的环境变量和值写入<code>$HOME/.goup/env</code>.</li>
<li><code>goup env</code>  显示<code>goup</code>的环境变量和值.</li>
<li><code>goup shell [VERSION]</code> 在shell会话中使用特定的Go版本.</li>
</ul>
<h3 data-id="heading-27">How to Debug</h3>
<p>默认日志级别为<code>Info</code>. 你可以使用<code>goup -v &lt;subcommand&gt;</code> 或 <code>goup -vv &lt;subcommand&gt;</code> 来使用 <code>Debug</code> 或 <code>Trace</code> 等级.</p>
<h3 data-id="heading-28">FAQ</h3>
<ul>
<li>
<p>编译和安装源代码失败?<br/>
所需的Go最低版本取决于Go的目标版本, 更多信息请参见<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fdoc%2Finstall%2Fsource" target="_blank" title="https://go.dev/doc/install/source" ref="nofollow noopener noreferrer">source installation instructions</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsemver.org%2F" target="_blank" title="https://semver.org/" ref="nofollow noopener noreferrer"><code>semver</code></a></p>
<ul>
<li>exact(<code>=</code>):  允许更新到与版本完全一致的最新版本, 因此<code>=1.21.4</code>表示与版本<code>1.21.4</code>完全一致.</li>
<li>greater(<code>&gt;</code>): 允许更新到大于该版本的最新版本, 因此<code>&gt;1.21.4</code>表示大于<code>1.21.4</code>.</li>
<li>greater equal(<code>&gt;=</code>): 允许更新到大于或等于该版本的最新版本, 因此 <code>&gt;1.21.4</code> 表示大于或等于<code>1.21.4</code>.</li>
<li>less(<code>&lt;</code>): 允许更新到小于该版本的最新版本, 因此<code>&gt;1.21.4</code>表示大于<code>1.21.4</code>.</li>
<li>less equal(<code>&lt;=</code>): 允许更新到小于或等于该版本的最新版本, 因此 <code>&gt;1.21.4</code> 表示小于或等于<code>1.21.4</code>.</li>
<li>tilde(<code>~</code>): 允许更新到不改变主,次版本的最新版本, 因此<code>~1.21.4</code>表示大于或等于 <code>1.21.4</code>, 但小于 <code>1.22.0</code>.</li>
<li>caret(<code>^</code>): 允许更新到不改变主要版本的最新版本, 因此 <code>^1.21.4</code> 表示版本必须大于或等于 <code>1.21.4</code>, 但小于 <code>2.0.0</code>.</li>
<li>wildcard(<code>*</code>): 此运算符表示任意版本. 它通常用于允许所有版本号匹配.
<ul>
<li><code>1.21.*</code> 匹配所有<code>1.21.x</code>版本.</li>
<li><code>1.*.*</code> 匹配所有<code>1.x.x</code>版本.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Go版本小于等于1.20.x解压失败.<br/>
大于v0.10.3版本已解决.
看多信息查看issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F251" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/251" ref="nofollow noopener noreferrer">#251</a></p>
</li>
<li>
<p>如何自定义 <code>GOUP_HOME</code>? (&gt;= v0.11.x)<br/>
<code>goup</code>使用<code>$HOME/.goup</code>目录作为 <code>GOUP_HOME</code>. 如果需要自定义<code>GOUP_HOME</code>(大多数是Windows用户), 可以设置<code>GOUP_HOME</code>环境变量来使用其他目录, 安装<code>goup</code>之前, 请确保已设置自定义<code>GOUP_HOME</code>环境变量和目标目录权限, 否则可能会导致令人惊讶的结果, 请参阅issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F265" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/265" ref="nofollow noopener noreferrer">#265</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fpull%2F270" target="_blank" title="https://github.com/thinkgos/goup-rs/pull/270" ref="nofollow noopener noreferrer">#270</a></p>
</li>
<li>
<p>有一些版本没有sha256文件, 如何安装这些版本?
<code>goup</code>(&gt;= v0.12.x) 支持 <code>--skip-verify</code> 选项, 如果这些版本没有sha256文件, 你可以尝试添加选项. 请参阅issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F300" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/300" ref="nofollow noopener noreferrer">#300</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fpull%2F301" target="_blank" title="https://github.com/thinkgos/goup-rs/pull/301" ref="nofollow noopener noreferrer">#301</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fpull%2F305" target="_blank" title="https://github.com/thinkgos/goup-rs/pull/305" ref="nofollow noopener noreferrer">#305</a></p>
</li>
<li>
<p>如何安装特定版本? 为什么会出现错误<code>Error: expected comma after minor version number, found 'r'</code>?
有时, 我们知道确切的版本, 可以使用 <code>goup install =1.24.5</code>, 但有些版本不符合<a href="https://link.juejin.cn?target=https%3A%2F%2Fsemver.org%2F" target="_blank" title="https://semver.org/" ref="nofollow noopener noreferrer"><code>semver</code></a>, 如 <code>1.25rc1</code>, 我们可以使用<code>goup install unstable</code>, 但这只能安装最新的不稳定版本. 所以我添加了一个 <code>--use-raw-version</code> 选项(&gt;= v0.12.x), 这样我们就可以安装任何我们确切知道的版本. 请参阅issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F299" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/299" ref="nofollow noopener noreferrer">#299</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fpull%2F307" target="_blank" title="https://github.com/thinkgos/goup-rs/pull/307" ref="nofollow noopener noreferrer">#307</a></p>
</li>
<li>
<p>如何在shell会话中使用特定的Go版本?
<code>goup</code>(&gt;= v0.15.x) 支持在一个<code>shell</code>会话中指定go版本. 如果你使用<code>goup shell</code>, 在<code>*nix</code>系统上需要先运行<code>goup init</code>, 因为之前的<code>env</code>文件较旧且不包含<code>GOUP_GO_VERSION</code>环境变量. 在<code>Windows</code>系统 上, 仅支持<code>powershell</code>, 如果系统的<code>COMSPEC</code>已经指向 powershell, 可能无需做任何操作. 请参阅issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F360" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/360" ref="nofollow noopener noreferrer">#360</a>.</p>
</li>
</ul>
<h3 data-id="heading-29">原文</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs" target="_blank" title="https://github.com/thinkgos/goup-rs" ref="nofollow noopener noreferrer">goup-rs</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 MateChat 构建 AI 编程智能助手的落地实践]]></title>    <link>https://juejin.cn/post/7577691061034025006</link>    <guid>https://juejin.cn/post/7577691061034025006</guid>    <pubDate>2025-11-30T06:31:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061034025006" data-draft-id="7577971299742711846" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 MateChat 构建 AI 编程智能助手的落地实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T06:31:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Se7en2581"/> <meta itemprop="url" content="https://juejin.cn/user/482061108644107"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 MateChat 构建 AI 编程智能助手的落地实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/482061108644107/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Se7en2581
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:31:37.000Z" title="Sun Nov 30 2025 06:31:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文围绕 <strong>华为云 DevUI MateChat</strong>，在在线教育中如何用 DevUI 组件 + MateChat 搭建智能问答界面。</p>
<h2 data-id="heading-0">一、需求背景：为什么我需要一个AI 助教？</h2>
<p>最近我开设了一期《AI 编程实战营》，面向零基础学员。教学过程中，两个痛点让我非常头大：</p>
<ol>
<li><strong>复读机式低效：</strong> 学员问题非常琐碎，比如环境变量怎么设？、Key 哪里找？这些问题在群里被反复问，我被迫变成了复读机，无法专注于深度教学。</li>
<li><strong>时差与响应滞后：</strong> 学员常在深夜学习，但我无法 24 小时在线。一旦他们卡在某个报错，往往要等到第二天我醒来才能解决，极大地打击了学习积极性。</li>
</ol>
<p><strong>我想做一个嵌在课程网页里的智能助手。</strong> 但当我调研技术方案时，发现后端接入大模型很简单，<strong>最让人头秃的是前端交互</strong>：</p>
<ul>
<li>Markdown 怎么渲染？</li>
<li>代码块怎么高亮？</li>
<li>流式输出（打字机效果）怎么写？</li>
</ul>
<p>如果要手写这一套，成本太高。直到我发现了 <strong>华为云 DevUI MateChat</strong>（以下简称 MateChat），它提供了开箱即用的 AI 对话 UI 组件，几乎完美治愈了我“前端恐惧症。</p>
<p>于是我尝试用 华为云 DevUI MateChat（以下简称 MateChat） 做一个嵌在课程里的智能问答助手。</p>
<h2 data-id="heading-1">二、搭建开发环境</h2>
<h3 data-id="heading-2">1、安装并检查 Node.js 环境</h3>
<p>Node.js官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fen%2Fdownload%2F" target="_blank" title="https://nodejs.org/en/download/" ref="nofollow noopener noreferrer">nodejs.org/en/download…</a></p>
<p>安装后，打开命令提示符（Win+R 输入cmd）或打开windows搜索cmd也行。</p>
<p>输入显示版本号，说明安装成功。</p>
<pre><code class="hljs">node -v
pnpm -v
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12902e0c27ca420e9bdf2efe76bd9038~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=8XbwIm7nK8WZ6gZC9J%2B%2BOCtRkCs%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b480f2dc0374b419750a5a2fa3cda12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=4TMEORnqQe0%2FH4XIxAWOkgA3FZc%3D" alt="" loading="lazy"/></p>
<p>注意：Vue 官方建议 Node.js 版本至少 18+ 或 20 LTS，这样用 Vite 起项目比较稳。</p>
<h2 data-id="heading-3">三、搭建MateChat + DevUI 聊天页面</h2>
<h3 data-id="heading-4">1、用 MateChat最新CLI创建项目</h3>
<p>在命令行里，切到你想放项目的文件夹，比如 <code>D:\code</code>，然后用MateChat最新CLI来创建项目，非常方便。</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 这里我用的npm管理</span>
npm create matechat@latest
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/165e922755ac42e4bde02167dcd1f458~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=gNzlPMSYLIDQUocXa2Z93qCVqlQ%3D" alt="" loading="lazy"/></p>
<p>注意：这一指令在安装并执行<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FDevCloudFE%2FMateChat%2Ftree%2Fdev%2Fpackages%2Fcreate-matechat" target="_blank" title="https://gitcode.com/DevCloudFE/MateChat/tree/dev/packages/create-matechat" ref="nofollow noopener noreferrer">create-matechat</a> 过程中，需要我们确认两个信息。</p>
<p>1、输入项目名称（Please input the project name），我的项目名称是：matechat-demo。</p>
<p>2、选择模版（Please select the template: Vue Starter），默认用Vue Starter即可。</p>
<h3 data-id="heading-5">2、安装依赖并启动</h3>
<p>根据MateChat使用指南</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ec54a5cd52046b6b0598c30a3e1f711~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=7QgVlpEn79US1wLuigkWIQkM%2FHM%3D" alt="" loading="lazy"/></p>
<p>先切换到项目的根目录（ cd .\matechat-demo\），然后执行 npm i 安装依赖，最后用npm run dev 启动项目。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d5658c755ff4099b11f3e179ebb3baa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=oNXRe21CWHaNfM2oBktWlB9Sd5U%3D" alt="" loading="lazy"/></p>
<p>打开浏览器，访问local地址：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5173%2Fvue-starter" target="_blank" title="http://localhost:5173/vue-starter" ref="nofollow noopener noreferrer">http://localhost:5173/vue-starter</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd8348ab5fb94f23a856adc11ee40228~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=3WyT1kwOpc8t5ZtDCB90Xc44Dwc%3D" alt="" loading="lazy"/></p>
<p>至此，能看到的默认的应用页面，有历史会话和输入框，就说明基础对话助手已经OK 了。</p>
<h3 data-id="heading-6">3、把模板修改为助手式</h3>
<p>我想收起左侧的对话，在文件src//global-config.ts 把地4行的displayShape，Immersive 改为Assistant</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-comment">// 修改前：</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">displayShape</span>: <span class="hljs-string">"Immersive "</span>,
  <span class="hljs-attr">title</span>: <span class="hljs-string">"MateChat"</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-title class_">IGlobalConfig</span>;

  <span class="hljs-comment">// 修改后：</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">displayShape</span>: <span class="hljs-string">"Assistant"</span>,
  <span class="hljs-attr">title</span>: <span class="hljs-string">"MateChat"</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-title class_">IGlobalConfig</span>;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7a59dcec0674af68904f74f19aab489~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=aToKUSGpubptS76Nkt358jmEw3k%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">4、接入deepseek大模型</h3>
<p>UI 搭好了，现在我们要注入灵魂。我选择用deepseek大模型，这里官方也给了非常详细的对接步骤</p>
<p>（参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2Fuse-guide%2Fmodel%2Fopenai.html%25EF%25BC%2589" target="_blank" title="https://matechat.gitcode.com/use-guide/model/openai.html%EF%BC%89" ref="nofollow noopener noreferrer">matechat.gitcode.com/use-guide/m…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22a66cb115764b62bc59889317ebd04e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=7PaMm8yoO3obDsNDNm1N2jhCgSU%3D" alt="" loading="lazy"/></p>
<p><strong>1、安装 OpenAI SDK</strong> DeepSeek 兼容 OpenAI 协议，我们可以直接用 OpenAI 的 SDK。</p>
<pre><code class="hljs">npm install openai
</code></pre>
<p><strong>2、获取deepseek的key</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55d4ab0bd02d4313addfafe348cd3bf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=RVi8oTMdQ%2BlnNxqdpJk0qUToGBs%3D" alt="" loading="lazy"/></p>
<p><strong>3、基于 MateChat，配置API KEY</strong></p>
<p>MateChat把应用默认接入了<code>DeepSeek</code>，在<code>src/models/config.ts</code>文件的<code>LLM_MODELS</code>配置<code>apiKey</code></p>
<pre><code class="hljs language-vbnet" lang="vbnet">// deepseek
<span class="hljs-symbol">providerKey:</span> LLMProviders.DEEP_SEEK,
<span class="hljs-symbol">apiPath:</span> <span class="hljs-string">"https://api.deepseek.com"</span>,
<span class="hljs-symbol">apiKey:</span> <span class="hljs-string">"这里填写你的KEY"</span>,
<span class="hljs-symbol">models:</span> [
  { name: <span class="hljs-string">"deepseek-chat"</span>, iconPath: DeepSeekIcon },
  { name: <span class="hljs-string">"deepseek-reasoner"</span>, iconPath: DeepSeekIcon },
],
<span class="hljs-symbol">available:</span> <span class="hljs-literal">true</span>,
<span class="hljs-symbol">clientKey:</span> LLMClientKey.openai,
</code></pre>
<p><strong>4、将关闭 Mock 模式，调用 DeepSeek API， 文件： src/models/config.ts</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">  <span class="hljs-comment">// 修改前：</span>
  <span class="hljs-keyword">export</span> <span class="hljs-type">const</span> MODEL_CONFIGS = {
    stream: <span class="hljs-literal">true</span>,
    enableMock: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// ← 原来是 true</span>
  };

  <span class="hljs-comment">// 修改后：</span>
  <span class="hljs-keyword">export</span> <span class="hljs-type">const</span> MODEL_CONFIGS = {
    stream: <span class="hljs-literal">true</span>,
    enableMock: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// ← 改成 false</span>
  };
</code></pre>
<h3 data-id="heading-8">5、最后的运行效果</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1b53fcf3fac45baa45eb37e004988d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=jDqaDogqDfV93VYQ5%2FtMpm%2Bo5BY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9"><strong>四、总结</strong></h2>
<p>如果以前要实现 Markdown 渲染、流式打字机效果、自适应气泡布局，我至少需要写几百行 CSS 和 JS 代码，还要调试各种兼容性。</p>
<p>现在使用 DevUI + MateChat做开发，速度提升了10倍。DevUI 提供了企业级的组件规范，MateChat 封装了复杂的对话交互逻辑，很快就做好了这个在线教育智能助手。</p>
<p>本文完整 Demo 已开源在 GitCode：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2Fgcw_o9lCM1pp%2Fmatechat-demo.git" target="_blank" title="https://gitcode.com/gcw_o9lCM1pp/matechat-demo.git" ref="nofollow noopener noreferrer">gitcode.com/gcw_o9lCM1p…</a> master分支。</p>
<p>本文参考资料：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2Fuse-guide%2Fintroduction.html" target="_blank" title="https://matechat.gitcode.com/use-guide/introduction.html" ref="nofollow noopener noreferrer">matechat.gitcode.com/use-guide/i…</a></p>
<p>本文参考mateChat仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2F%25EF%25BC%258C%25E5%258C%2585%25E5%2590%25ABMateChat" target="_blank" title="https://matechat.gitcode.com/%EF%BC%8C%E5%8C%85%E5%90%ABMateChat" ref="nofollow noopener noreferrer">matechat.gitcode.com/，包含MateChat</a> 接入示例、DevUI 组件示例页面、环境配置说明等。</p>
<p>如果这套实践对你有帮助，点个 ⭐ Star，方便后续查阅，一起解锁更多 MateChat / DevUI 场景案例 。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 王者修炼手册【Mysql篇 - SQL执行存储流程】：拆解 InnoDB 存储结构与 SQL 执行流程，吃透 Buffer Pool 和 Change]]></title>    <link>https://juejin.cn/post/7577737385954754570</link>    <guid>https://juejin.cn/post/7577737385954754570</guid>    <pubDate>2025-11-30T06:42:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954754570" data-draft-id="7577691061034057774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 王者修炼手册【Mysql篇 - SQL执行存储流程】：拆解 InnoDB 存储结构与 SQL 执行流程，吃透 Buffer Pool 和 Change"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-30T06:42:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DonaldCen666"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147440264"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 王者修炼手册【Mysql篇 - SQL执行存储流程】：拆解 InnoDB 存储结构与 SQL 执行流程，吃透 Buffer Pool 和 Change
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147440264/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    DonaldCen666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:42:09.000Z" title="Sun Nov 30 2025 06:42:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员强子。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc77e4877bbd46dfb2ab9bd5205a75ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9uYWxkQ2VuNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089729&amp;x-signature=3gDL3kivLa%2FoAFcOSt2Mn1WTKF8%3D" alt="2001980.jpg" loading="lazy"/></p>
<p>日常开发中，我们很少关注 MySQL 的底层细节：</p>
<ul>
<li>InnoDB 是如何<strong>存储数据</strong>的？</li>
<li><strong>Buffer</strong> <strong>Pool</strong> 和 <strong>Change</strong> <strong>Buffer</strong> 又是如何<strong>优化性能</strong>的？</li>
<li><strong>SQL</strong> <strong>执行</strong>要经过哪些环节？</li>
</ul>
<p>今天，强子就带着大家走进 MySQL 的底层世界 ~</p>
<h2 data-id="heading-0">数据存储机制</h2>
<h3 data-id="heading-1">特点</h3>
<p>InnoDB 的存储结构按 <strong>从大到小</strong> 分为 5 个层级</p>
<p><strong>表空间</strong>（Tablespace）→ <strong>段</strong>（Segment）→ <strong>区</strong>（Extent）→ <strong>页</strong>（Page）→ <strong>行</strong>（Row）</p>
<p>核心就上层负责 <strong>逻辑隔离与资源管理</strong>，下层负责 <strong>物理存储与 IO 交互</strong></p>
<p>比如<strong>表空间</strong>隔离不同表的数据，<strong>页</strong>则作为内存与磁盘的交互单元</p>
<p>最终实现 <strong>按需存储</strong>、<strong>高效读写</strong></p>
<p>接下来，跟着强子的脚步，来拆解每个层次~</p>
<h3 data-id="heading-2">表空间</h3>
<p><strong>表空间</strong>（Tablespace）,是所有数据（<strong>表数据</strong>、<strong>索引</strong>、<strong>元数据</strong>等）的 <strong>总仓库</strong></p>
<p>分为两类核心类型：</p>
<ul>
<li>
<p><strong>系统表空间</strong>（System Tablespace）</p>
<ul>
<li>MySQL 默认的共享表空间，对应磁盘文件<strong>ibdata1</strong>（可多文件）</li>
<li>存储 InnoDB <strong>数据字典</strong>、<strong>回滚日志</strong>（Undo Log）、<strong>临时表</strong>数据等核心元数据；</li>
</ul>
</li>
<li>
<p><strong>独立表空间</strong>（File-per-table Tablespace）</p>
<ul>
<li>MySQL 5.6 及以上默认启用（通过<strong>innodb_file_per_table=ON</strong>控制）</li>
<li>每张表对应一个<strong>独立的ibd文件</strong>（如user.ibd），表数据和索引单独存储</li>
</ul>
</li>
</ul>
<blockquote>
<p>这样设计有什么好处？</p>
</blockquote>
<ul>
<li><strong>数据隔离</strong>：独立表空间下，单表的增删改查、<strong>备份迁移</strong>不影响其他表；</li>
<li><strong>元数据管理</strong>：系统表空间<strong>统一维护</strong> InnoDB 的 “数据字典”（记录表结构、列类型等元信息）</li>
</ul>
<blockquote>
<p>有没有实战案例？</p>
</blockquote>
<p>100G 大表order需要迁移，对比 独立表空间 和 共享表空间：</p>
<ul>
<li>若用<strong>独立表空间</strong>：直接拷贝order.ibd文件，配合ALTER TABLE order DISCARD TABLESPACE/IMPORT TABLESPACE命令，10 分钟内可完成迁移；</li>
<li>若用系统表空间：需备份整个<strong>ibdata1</strong>文件（可能几百 G），迁移效率极低，且恢复时易影响其他表。</li>
</ul>
<p>所以，<strong>生产环境</strong>必须<strong>启用独立表空间</strong></p>
<p>还有，ibdata1文件 有<strong>扩容后无法收缩</strong>的特点！</p>
<ul>
<li>系统表空间的ibdata1文件默认 <strong>自动扩容</strong>，但扩容后无法收缩</li>
<li>即使<strong>删除数据</strong>，空间也不会释放</li>
<li>若ibdata1超过 <strong>50G</strong>，会导致 MySQL 启动变慢、磁盘 IO 负载升高</li>
<li>此时需通过 “导出数据→重建实例→导入数据” 的方式收缩表空间</li>
</ul>
<h3 data-id="heading-3">段</h3>
<p><strong>段</strong>（Segment）用于区分 <strong>数据</strong> 与 <strong>索引</strong> 的存储</p>
<p>段类型有主要有两类，还有一些其他的类型：</p>
<ul>
<li>
<p><strong>数据段</strong>（Data Segment）</p>
<ul>
<li>存储表的<strong>真实业务数据</strong>；</li>
<li>本质是<strong>聚簇索引</strong>的叶子节点段</li>
<li><strong>聚簇索引</strong>的叶子节点直接包含<strong>完整行数据</strong>，数据段就是聚簇索引<strong>叶子节点</strong>的存储空间</li>
</ul>
</li>
<li>
<p><strong>索引段</strong>（Index Segment）</p>
<ul>
<li>存储索引的<strong>非叶子节点</strong>（以及二级索引的叶子节点），用于实现索引的快速查找逻辑</li>
<li>二级索引的叶子节点也存于索引段，这是因为二级索引叶子节点不存实际数据，<strong>只存主键值</strong></li>
</ul>
</li>
</ul>
<p>还有其他类型的段：</p>
<ul>
<li>
<p><strong>回滚段</strong></p>
<ul>
<li>InnoDB 中专门存储<strong>Undo Log</strong>（撤销日志） 的段，默认位于共享表空间（ibdata1）</li>
<li>也可通过配置innodb_undo_tablespaces设置为独立表空间</li>
<li>每个回滚段由多个 <strong>Undo 页</strong>组成</li>
</ul>
</li>
<li>
<p><strong>临时段</strong></p>
<ul>
<li>是 InnoDB 为<strong>临时表</strong>、<strong>临时数据</strong>操作分配的段，</li>
<li>存储于临时表空间（ibtmp1）,独立于普通表空间，仅用于存放临时数据</li>
<li><strong>显式临时表存储:</strong> 用户通过CREATE TEMPORARY TABLE创建的<strong>临时表</strong></li>
<li><strong>隐式临时数据处理: <strong>SQL 执行过程中产生的</strong>临时数据</strong>（如<strong>ORDER BY排序</strong>、<strong>GROUP BY分组</strong>、<strong>DISTINCT去重</strong>、<strong>子查询</strong>等），会先存入临时段，处理完成后销毁</li>
</ul>
</li>
<li>
<p><strong>缓冲段</strong></p>
<ul>
<li><strong>专门存储Change Buffer（插入缓冲） 数据</strong></li>
</ul>
</li>
</ul>
<p>段没有固定大小，会随数据量动态扩展，且扩展的最小单位是 “区”</p>
<p>来来来，详细了解一下 区</p>
<h3 data-id="heading-4">区</h3>
<p>区（Extent）是 InnoDB 中<strong>连续页的集合</strong>，是段扩展的 <strong>最小单位，</strong> 默认配置下：</p>
<ul>
<li>区大小固定为 <strong>1MB</strong>；</li>
<li>因 InnoDB 默认页大小为 <strong>16KB</strong>，故 1 个区包含 1MB / 16KB = 64个连续页</li>
</ul>
<blockquote>
<p>实战案例有哪些？</p>
</blockquote>
<p>电商项目的product表（存储商品信息，高频查询库存字段），当某类商品（如 “<strong>手机</strong>”）成为热点时：</p>
<ul>
<li>为product表的数据段分配多个<strong>连续区</strong>，热点商品的数据集中存储在这些区中；</li>
<li><strong>预读机制</strong>（Read Ahead）会一次性将整个区（1MB）的数据加载到 <strong>Buffer Pool</strong>中；</li>
<li>后续查询该类商品时，直接从内存读取，无需频繁**访问磁盘 **</li>
<li>InnoDB对区分配 有策略： <strong>区翻倍分配</strong></li>
</ul>
<blockquote>
<p>什么是 区翻倍分配 策略？</p>
</blockquote>
<ul>
<li>表刚创建时，数据段仅分配 1 个区；</li>
<li>当数据量达到区容量的 <strong>50</strong>% 时，下次分配 <strong>2</strong> 个区；</li>
<li>再满则分配 4 个区、8 个区…… 以此类推，直到单次分配 64 个区后稳定</li>
</ul>
<p>这种策略能避免 <strong>小数据量时频繁分配区</strong> 的性能开销，同时适配大数据量的扩展需求</p>
<h3 data-id="heading-5">页</h3>
<p>页（Page）InnoDB磁盘操作的<strong>最小单位</strong></p>
<p>无论读还是写，都必须整页操作</p>
<p>默认页大小为 <strong>16</strong>KB,可通过innodb_page_size参数,修改为 4KB、8KB、32KB 等</p>
<p>核心页类型包括：</p>
<ul>
<li><strong>数据页</strong>（Data Page）：存储表数据，是 B + 树的 <strong>叶子节点</strong></li>
<li><strong>索引页</strong>（Index Page）：存储索引条目，是 B + 树的 <strong>非叶子节点</strong></li>
<li><strong>日志页</strong>（Log Page）：存储 redo log、undo log 等日志数据</li>
</ul>
<blockquote>
<p>实战案例是什么？</p>
</blockquote>
<p>我们平常说的<strong>避免全表扫描</strong>，本质就是避免 <strong>加载过多数据页</strong></p>
<ul>
<li>假设user表有 100 万行数据，每行约 1KB，1 个数据页可存 16 行，<strong>全表扫描</strong>需加载 100万 / 16 ≈ 62500个页，需发起数万次磁盘 IO；</li>
<li>若走<strong>主键查询</strong>（select * from user where id=1001）：B + 树索引只需加载 3 个页（根节点→子节点→叶子节点数据页），仅 3 次 IO，效率相差万倍</li>
</ul>
<h3 data-id="heading-6">行</h3>
<p>行是 InnoDB 存储的最小逻辑单位，对应数据表中的<strong>一条记录</strong></p>
<p>InnoDB 支持多种行格式，核心格式有</p>
<ul>
<li><strong>Compact</strong>：MySQL 5.6 默认格式，对短字段紧凑存储，长字段（超过一定长度）会将部分数据存到 “溢出页”；</li>
<li><strong>Dynamic</strong>：MySQL 5.7 及以上默认格式，长字段（如TEXT、BLOB）的所有数据都存到 “溢出页”，数据页仅保留 20 字节的指针</li>
</ul>
<blockquote>
<p>溢出页是什么？</p>
</blockquote>
<p>专门用于存放 <strong>超长字段</strong>（如 TEXT、BLOB、超长 VARCHAR）数据的<strong>独立页面</strong></p>
<p>原数据页里只保留20 字节的指针，这个指针相当于 <strong>地址标签</strong>，记录着溢出页的位置</p>
<blockquote>
<p>有没有可能一条数据太大导致占用超过16k(超过一页)？</p>
</blockquote>
<p>InnoDB有硬性规定：单行数据的实际存储大小不能超过页大小的<strong>一半</strong>（约 8KB）</p>
<p>目的是保证一个数据页至少能容纳<strong>两行数据</strong>，避免存储结构崩溃</p>
<p>如果一行数据包含多个 TEXT/BLOB、超长 VARCHAR，确实会触发 <strong>行溢出</strong></p>
<p><strong>但 InnoDB 通过之前提到的溢出页机制+行拆分逻辑来解决。</strong></p>
<p>在 段中 提到 <strong>Change Buffer</strong> ，和 区中提到 <strong>Buffer Poo</strong>l 到底 是啥来的？来跟强子仔细研究一下~~</p>
<h2 data-id="heading-7">Change Buffer</h2>
<h3 data-id="heading-8">定义</h3>
<p>内存中一块临时存储区域</p>
<p>专门缓存对<strong>非唯一二级索引</strong>的 插入 / 更新 / 删除 操作</p>
<p>不直接刷盘，等<strong>合适时机</strong>一次性合并到磁盘索引页</p>
<h3 data-id="heading-9">作用</h3>
<ul>
<li>把修改非唯一二级索引时的<strong>零散随机</strong> I/O，转化为批量顺序 I/O，大幅提升写入性能</li>
<li>比如<strong>批量插入数据</strong>、<strong>高频更新非唯一索引列</strong>时效果明显</li>
</ul>
<h3 data-id="heading-10">解决的核心问题</h3>
<p>二级索引的索引页在磁盘上<strong>分布零散（非顺序）</strong></p>
<p>若修改时索引页不在内存（<strong>Buffer Pool</strong>），需频繁从磁盘<strong>读取索引页</strong>（随机 I/O 效率极低）</p>
<p>Change Buffer 直接跳过 <strong>频繁读磁盘</strong> 步骤，<strong>先缓存修改操作</strong>，避免了这个痛点</p>
<h3 data-id="heading-11">限制</h3>
<ul>
<li>只适用于<strong>非唯一二级索引</strong>，唯一索引需实时校验唯一性，不能缓冲；</li>
<li><strong>聚簇索引、已在内存</strong>的索引页，不适用（聚簇索引直接操作数据页，内存索引页可直接修改）。</li>
</ul>
<h2 data-id="heading-12">Buffer Pool</h2>
<p>本质是一块从内存中划分出的<strong>缓存空间</strong></p>
<p>专门用来缓存磁盘上的数据页（表数据）和索引页，以及索引变更、行数据等相关信息</p>
<p>核心目标是<strong>减少磁盘 I/O</strong>、<strong>提升读写性能</strong></p>
<h3 data-id="heading-13">作用</h3>
<h4 data-id="heading-14">读缓存</h4>
<p>查询数据时，先从 Buffer Pool 找<strong>数据页</strong> / <strong>索引页</strong>，找到就直接返回（“缓存命中”），不用读磁盘；</p>
<p>没找到才从磁盘加载到 Buffer Pool，后续再查就走内存，速度提升成百上千倍。</p>
<h4 data-id="heading-15">写缓存</h4>
<p>修改数据时，先更新 Buffer Pool 里的<strong>缓存页</strong>（标记为 “脏页”），</p>
<p><strong>不立即</strong>刷到磁盘，而是由后台线程批量异步刷盘</p>
<p>避免频繁磁盘写，提升写入效率</p>
<h3 data-id="heading-16">数据结构</h3>
<p>Buffer Pool 按 <strong>页</strong>（和磁盘数据页大小一致，默认 16KB）划分</p>
<p>每个缓存页对应磁盘上的一个数据页 / 索引页</p>
<p>用 <strong>最近最少使用LRU</strong> 算法管理缓存页</p>
<p>把<strong>常用的页</strong>留在链表前端，<strong>不常用的页</strong>在末端</p>
<p>内存满时淘汰末端页，保证缓存命中率</p>
<h3 data-id="heading-17">机制</h3>
<p>被修改但未刷到磁盘的缓存页叫 <strong>脏页</strong></p>
<p>由后台线程在<strong>空闲时</strong>或<strong>满足阈值时</strong>批量刷到磁盘</p>
<h2 data-id="heading-18">SQL 各子句的执行顺序</h2>
<h3 data-id="heading-19">执行顺序</h3>
<h4 data-id="heading-20">FROM/JOIN</h4>
<ul>
<li>确定<strong>数据来源</strong>：加载 FROM 后的<strong>表</strong>，处理 JOIN（内连接 / 外连接等）<strong>关联的表</strong></li>
<li>生成 <strong>基础数据集</strong>，包含所有关联后的行</li>
</ul>
<h4 data-id="heading-21">WHERE</h4>
<p>对第一步的基础数据集做<strong>行级过滤</strong>：只保留满足 <strong>WHERE</strong> 条件的行</p>
<p>此时还未分组，不能用<strong>聚合函数</strong>如 SUM ()</p>
<h4 data-id="heading-22">GROUP BY</h4>
<p>按指定字段对过滤后的<strong>行分组</strong>：相同字段值的行被合并为一个组</p>
<p>后续<strong>聚合函数</strong>（如 COUNT、AVG）基于组计算</p>
<h4 data-id="heading-23">HAVING</h4>
<p>对分组后的结果做<strong>组级过滤</strong>：只保留满足 HAVING 条件的组</p>
<p>可以用<strong>聚合函数</strong>，比如HAVING AVG(salary) &gt; 5000</p>
<h4 data-id="heading-24">SELECT</h4>
<p>从前面处理后的<strong>结果</strong>中选择<strong>要显示的列</strong></p>
<p>包括字段、聚合函数计算结果、别名等</p>
<h4 data-id="heading-25">DISTINCT</h4>
<p>对 <strong>SELECT</strong> 选出的结果<strong>去重</strong>，<strong>去除重复行</strong></p>
<h4 data-id="heading-26">ORDER BY</h4>
<p>按指定列 / 表达式对<strong>结果集排序</strong></p>
<p>此时可以用 SELECT 里的<strong>别名</strong>，因为 SELECT 已经执行</p>
<h4 data-id="heading-27">LIMIT/OFFSET</h4>
<p>最后限制<strong>结果集</strong>的行数</p>
<ul>
<li>如LIMIT 10取前 10 行</li>
<li>或跳过指定行数（OFFSET 5）</li>
</ul>
<h3 data-id="heading-28">验证</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> dept_id, <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-keyword">AS</span> avg_sal
<span class="hljs-keyword">FROM</span> employee
<span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">&gt;</span> <span class="hljs-number">10</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> dept_id
<span class="hljs-keyword">HAVING</span> avg_sal <span class="hljs-operator">&gt;</span> <span class="hljs-number">5000</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> avg_sal <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">5</span>;
</code></pre>
<p>执行顺序对应：</p>
<ul>
<li>先从<strong>employee</strong>表加载数据（<strong>FROM</strong>）；</li>
<li>过滤出<strong>dept_id</strong> &gt; 10的行（<strong>WHERE</strong>）；</li>
<li>按dept_id<strong>分组</strong>（<strong>GROUP BY</strong>）；</li>
<li>保留平均工资 &gt; 5000 的组（<strong>HAVING</strong>）；</li>
<li>选择dept_id和平均工资（<strong>SELECT</strong>，别名<strong>avg_sa</strong>l生效）；</li>
<li>按<strong>avg_sal</strong>降序排序（<strong>ORDER BY</strong>）；</li>
<li>取前 5 组（<strong>LIMIT</strong>）</li>
</ul>
<h2 data-id="heading-29">总结</h2>
<p>今天我们了解了Mysql是怎么<strong>存储数据</strong>的，也知道了sql<strong>子句执行流程</strong>是怎么样的，顺便还了解了一下Mysql的<strong>缓存机制</strong>~</p>
<ul>
<li>InnoDB 靠表空间 - 段 - 区 - 页架构存储数据，搭配数据段、索引段、溢出页等解决存储难题；</li>
<li>SQL 按 “FROM→WHERE→GROUP BY→SELECT→ORDER BY→LIMIT” 的固定顺序执行。</li>
<li>Buffer Pool 缓存数据和索引减磁盘 I/O，Change Buffer 优化非唯一二级索引写入；</li>
</ul>
<p>带着底层视角开发，解决问题会更精准~</p>
<p>熟练度刷不停，知识点吃透稳，下期接着练～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS应用开发基础案例（一）：鸿蒙页面布局入门]]></title>    <link>https://juejin.cn/post/7577689171222937650</link>    <guid>https://juejin.cn/post/7577689171222937650</guid>    <pubDate>2025-11-30T01:44:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577689171222937650" data-draft-id="7577705544875130918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS应用开发基础案例（一）：鸿蒙页面布局入门"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-30T01:44:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Raink"/> <meta itemprop="url" content="https://juejin.cn/user/3843548383566072"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS应用开发基础案例（一）：鸿蒙页面布局入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548383566072/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Raink
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T01:44:12.000Z" title="Sun Nov 30 2025 01:44:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文以仿猫眼电影M站首页布局为案例，展示ArkUI在实际开发中的应用。内容包括案例效果及相关知识点，深入解析布局框架以及头部、脚部、内容区域的构建思路与代码实现，最后提供完整代码和教程资源，助力你强化实践能力。</p>
<h2 data-id="heading-0">1. 案例效果截图</h2>
<p>如图1-1所示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfc35d42a0754170a4e6d0ff5a538416~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=8jLo7XO%2BBtUctc7TbMNUctZazC8%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a342b873934f4b1cac11c16acfa55de7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=0a9NE1ghSJLQi9jeN5sx%2BIez9Eg%3D" alt="" loading="lazy"/></p>
<p><strong>图1-1</strong> 案例效果截图</p>
<h2 data-id="heading-1">2. 案例运用到的知识点</h2>
<ol>
<li><strong>核心知识点</strong></li>
</ol>
<ul>
<li>UI范式基本语法。</li>
<li>文本显示Text、Span组件。</li>
<li>线性布局Column、Row组件。</li>
<li>层叠布局Stack组件。</li>
<li>按钮Button组件。</li>
<li>显示图片Image组件。</li>
</ul>
<ol start="2">
<li><strong>其他知识点</strong></li>
</ol>
<ul>
<li>DevEco Studio的基本使用。</li>
<li>简单的资源分类访问。</li>
<li>移动端APP布局基本技巧。</li>
</ul>
<h2 data-id="heading-2">3. 布局框架</h2>
<p>可以按照图3-1来思考布局的框架：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0dd2533ada3d46ceacf3a472f8dd8739~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=DchyvIeZrS9n6Ud4HQukp%2BVUISE%3D" alt="" loading="lazy"/></p>
<p><strong>图3-1</strong> 布局框架图</p>
<p>框架的代码如下：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Entry</span>
<span class="hljs-variable">@Component</span>
struct Index {
  <span class="hljs-selector-tag">build</span>() {
    <span class="hljs-selector-tag">Column</span>() {
      <span class="hljs-selector-tag">Stack</span>() {}
        .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-built_in">height</span>(<span class="hljs-number">50</span>).<span class="hljs-built_in">backgroundColor</span>(<span class="hljs-string">'#e54847'</span>)
      
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-selector-tag">Text</span>(<span class="hljs-string">'content'</span>)
      }<span class="hljs-selector-class">.width</span>(<span class="hljs-string">'100%'</span>)<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)
      
      <span class="hljs-selector-tag">Row</span>() {}
        .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-built_in">height</span>(<span class="hljs-number">50</span>).<span class="hljs-built_in">backgroundColor</span>(<span class="hljs-string">'#fff'</span>)
        .<span class="hljs-built_in">border</span>({<span class="hljs-attribute">width</span>: { <span class="hljs-attribute">top</span>: <span class="hljs-number">1</span>}, <span class="hljs-attribute">color</span>: <span class="hljs-string">'#eee'</span>})
    }
  }
}
</code></pre>
<h2 data-id="heading-3">4. 头部区域</h2>
<p>可以按照图4-1思路来构建布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3562829c7a114dc8b181e2ee2e681921~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=zpmYtnsWDON7TLTXp9FNAupWMlU%3D" alt="" loading="lazy"/></p>
<p><strong>图4-1</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 头部区域</span>
<span class="hljs-built_in">Stack</span>({ alignContent: Alignment.End }) {
  Text('猫眼电影')
    <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.textAlign</span>(TextAlign.Center)
    <span class="hljs-selector-class">.fontColor</span>('#fff')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">18</span>)
  <span class="hljs-built_in">Image</span>($rawfile('menu.png'))
    <span class="hljs-selector-class">.width</span>(<span class="hljs-number">17</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">16</span>)<span class="hljs-selector-class">.margin</span>({ right: <span class="hljs-number">10</span> })
}<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">50</span>)<span class="hljs-selector-class">.backgroundColor</span>('#e54847')
</code></pre>
<h2 data-id="heading-4">5. 脚部区域</h2>
<p>可以按照图5-1思路来构建布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/109af3e0cee54de8ae3559e0ec30c1db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=DuwJj6mDG6kvGYE8k2hzJKnFuzo%3D" alt="" loading="lazy"/></p>
<p><strong>图5-1</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 脚部区域</span>
<span class="hljs-built_in">Row</span>() {
  <span class="hljs-built_in">Column</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('movie.svg'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.fillColor</span>('#e54847')
    Text('电影/影院')
      <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">10</span>)<span class="hljs-selector-class">.fontColor</span>('#e54847')
  }<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)

  <span class="hljs-built_in">Column</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('video.png'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.fillColor</span>('#<span class="hljs-number">696969</span>')
    Text('视频')
      <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">10</span>)<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">696969</span>')
  }<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)

  <span class="hljs-built_in">Column</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('perform.svg'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.fillColor</span>('#<span class="hljs-number">696969</span>')
    Text('演出')
      <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">10</span>)<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">696969</span>')
  }<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)

  <span class="hljs-built_in">Column</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('mine.svg'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.fillColor</span>('#<span class="hljs-number">696969</span>')
    Text('我的')
      <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">10</span>)<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">696969</span>')
  }<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)
}
<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">50</span>)<span class="hljs-selector-class">.border</span>({ width: { top: <span class="hljs-number">1</span> }, color: '#eee' })
<span class="hljs-selector-class">.backgroundColor</span>('#fff')
</code></pre>
<h2 data-id="heading-5">6. 内容区域</h2>
<p>可以参照图6-1思考内容区域的整体框架布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e81cb7e910be4a739dc5285ba98dcac9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=X6uthT%2ByeC4P6cmmPhPXoEEgWIY%3D" alt="" loading="lazy"/></p>
<p><strong>图6-1</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 内容区域</span>
<span class="hljs-built_in">Column</span>() {
  <span class="hljs-built_in">Row</span>() {}
    <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">44</span>)<span class="hljs-selector-class">.border</span>({width: {bottom: <span class="hljs-number">1</span>}, color: '#e6e6e6'})

  Scroll() {}
    <span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)
}<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)
</code></pre>
<h3 data-id="heading-6">6.1. 导航区</h3>
<p>内容区域的导航区可以参照图6-2思考布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bec5f9d4f9d04ba8ae2abca42bc14491~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=7075OJDENp224ocqy1UgLmJZMiE%3D" alt="" loading="lazy"/></p>
<p><strong>图6-2</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 导航区</span>
<span class="hljs-built_in">Row</span>() {
  <span class="hljs-built_in">Row</span>() {
    Text('北京')<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">666</span>')
    Text('')
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">0</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">0</span>)
      <span class="hljs-selector-class">.border</span>({
        width: <span class="hljs-number">5</span>,
        color: {
          top: '#b0b0b0',
          left: Color.Transparent,
          right: Color.Transparent,
          bottom: Color.Transparent
        }
      })
      <span class="hljs-selector-class">.margin</span>({top: <span class="hljs-number">6</span>, left: <span class="hljs-number">4</span>})
  }<span class="hljs-selector-class">.offset</span>({x: <span class="hljs-number">15</span>})<span class="hljs-selector-class">.width</span>(<span class="hljs-number">60</span>)

  <span class="hljs-built_in">Row</span>() {
    <span class="hljs-built_in">Stack</span>() {
      Text('热映')
        <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">17</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)
      Text('')
        <span class="hljs-selector-class">.width</span>(<span class="hljs-number">24</span>)<span class="hljs-selector-class">.border</span>({width: {bottom: <span class="hljs-number">3</span>}, color: '#e54847'})<span class="hljs-selector-class">.offset</span>({y: <span class="hljs-number">18</span>})
    }
    Text('影院')
    Text('待映')
    Text('经典电影')
  }<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)

  <span class="hljs-built_in">Row</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('search-red.png'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">20</span>)
  }<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Center)<span class="hljs-selector-class">.width</span>(<span class="hljs-number">50</span>)
}<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">44</span>)<span class="hljs-selector-class">.border</span>({width: {bottom: <span class="hljs-number">1</span>}, color: '#e6e6e6'})
</code></pre>
<h3 data-id="heading-7">6.2. 最受好评区</h3>
<p>可以参照图6-3考虑整体布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/351a4dfe5ba840f0ba72d8177add0cc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=KxjZlO1BrpnkQRBhJeMKkunh3fk%3D" alt="" loading="lazy"/></p>
<p><strong>图6-3</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 好评和列表区内容</span>
<span class="hljs-built_in">Column</span>() {
  <span class="hljs-comment">// 好评区</span>
  <span class="hljs-built_in">Column</span>() {
    Text('最受好评电影')
      <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>)<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">333</span>')
      <span class="hljs-selector-class">.textAlign</span>(TextAlign.Start)<span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">12</span> })
    Scroll() {
      <span class="hljs-built_in">Row</span>() {
        <span class="hljs-built_in">Column</span>() {
          <span class="hljs-built_in">Stack</span>({ alignContent: Alignment.BottomStart }) {
            <span class="hljs-built_in">Image</span>('https://p0.pipi.cn/basicdata/' 
                  + '<span class="hljs-number">54</span>ecdeddf2a92339dd2c95022e99e5fe27091.jpg?' 
                  + 'imageMogr2/thumbnail/<span class="hljs-number">2500</span>x2500%<span class="hljs-number">3</span>E'
            )<span class="hljs-selector-class">.width</span>(<span class="hljs-number">85</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">115</span>)
            Text('')
              <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">35</span>)<span class="hljs-selector-class">.linearGradient</span>({
                direction: GradientDirection.Bottom, 
                colors: [['rgba(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)', <span class="hljs-number">0</span>], <span class="hljs-selector-attr">[0x000000, 1]</span>] 
              })
            Text('观众评分：<span class="hljs-number">9.6</span>')
              <span class="hljs-selector-class">.fontColor</span>('#faaf00')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">11</span>)
              <span class="hljs-selector-class">.fontWeight</span>(<span class="hljs-number">700</span>)<span class="hljs-selector-class">.offset</span>({ x: <span class="hljs-number">4</span>, y: -<span class="hljs-number">4</span> })
          }<span class="hljs-selector-class">.height</span>(<span class="hljs-number">115</span>)<span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">6</span> })
          Text('出走的决心')
            <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)<span class="hljs-selector-class">.width</span>(<span class="hljs-number">85</span>)
            <span class="hljs-selector-class">.textAlign</span>(TextAlign.Start)<span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">3</span> })
        }<span class="hljs-selector-class">.width</span>(<span class="hljs-number">85</span>)<span class="hljs-selector-class">.margin</span>({ right: <span class="hljs-number">10</span> })

        <span class="hljs-comment">// ... 其余7个Column与上述结构相同，因篇幅限制已省略，详见本书配套源码。</span>
      }
    }
    <span class="hljs-selector-class">.scrollable</span>(ScrollDirection.Horizontal)<span class="hljs-selector-class">.scrollBar</span>(BarState.Off)
    <span class="hljs-selector-class">.edgeEffect</span>(EdgeEffect.Spring)
  }<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.padding</span>({ top: <span class="hljs-number">12</span>, bottom: <span class="hljs-number">12</span>, left: <span class="hljs-number">15</span>, right: <span class="hljs-number">15</span> })
}<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
</code></pre>
<h3 data-id="heading-8">6.3. 列表区</h3>
<p>列表区整体布局参照图6-4。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02597159af9f4679bf1d0bbf7572804b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=HD6Q3CwQU1VIrDJobuO4ug3Ct4k%3D" alt="" loading="lazy"/></p>
<p><strong>图6-4</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 列表区</span>
<span class="hljs-built_in">Column</span>() {
  <span class="hljs-built_in">Row</span>() {
    <span class="hljs-built_in">Image</span>('https://p0.pipi.cn/basicdata/' 
          + '<span class="hljs-number">54</span>ecdedd5377e187a9e7aa5ee9ec15a184b18.jpg?' 
          + 'imageMogr2/thumbnail/<span class="hljs-number">2500</span>x2500%<span class="hljs-number">3</span>E?imageView2/<span class="hljs-number">1</span>/w/<span class="hljs-number">128</span>/h/<span class="hljs-number">180</span>'
    )<span class="hljs-selector-class">.width</span>(<span class="hljs-number">64</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">90</span>)
    
    <span class="hljs-built_in">Stack</span>({ alignContent: Alignment.End }) {
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-built_in">Row</span>() {
          Text('志愿军：存亡之战')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">17</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)
          <span class="hljs-built_in">Image</span>($rawfile('v2dimax.png'))<span class="hljs-selector-class">.width</span>(<span class="hljs-number">43</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">14</span>)<span class="hljs-selector-class">.margin</span>({ left: <span class="hljs-number">4</span> })
        }
        Text() {
          <span class="hljs-selector-tag">Span</span>('<span class="hljs-number">274337</span>')<span class="hljs-selector-class">.fontColor</span>('#faaf00')
          <span class="hljs-selector-tag">Span</span>('人想看')<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">666</span>')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)
        }
        Text('主演: 朱一龙,辛柏青,张子枫')<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">666</span>')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)
        Text('<span class="hljs-number">2024</span>-<span class="hljs-number">09</span>-<span class="hljs-number">30</span> 下周一上映')<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">666</span>')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)
      }
        <span class="hljs-selector-class">.alignItems</span>(HorizontalAlign.Start)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
        <span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)<span class="hljs-selector-class">.padding</span>({ right: <span class="hljs-number">53</span> })
      
      <span class="hljs-selector-tag">Button</span>() {
        Text('预售')<span class="hljs-selector-class">.fontColor</span>('#fff')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)<span class="hljs-selector-class">.fontWeight</span>(<span class="hljs-number">500</span>)
      }<span class="hljs-selector-class">.width</span>(<span class="hljs-number">54</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">28</span>)<span class="hljs-selector-class">.backgroundColor</span>('#<span class="hljs-number">3</span>C9FE6')
      
    }
      <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.margin</span>({ left: <span class="hljs-number">12</span> })
      <span class="hljs-selector-class">.padding</span>({ top: <span class="hljs-number">12</span>, right: <span class="hljs-number">14</span>, bottom: <span class="hljs-number">12</span>, left: <span class="hljs-number">0</span> })
      <span class="hljs-selector-class">.border</span>({ width: { bottom: <span class="hljs-number">1</span> }, color: '#eee' })
  }<span class="hljs-selector-class">.height</span>(<span class="hljs-number">144</span>)

  <span class="hljs-comment">// ... 其余7个Row与上述结构相同，因篇幅限制已省略，详见本书配套源码。</span>
}<span class="hljs-selector-class">.backgroundColor</span>('#fff')<span class="hljs-selector-class">.padding</span>({ left: <span class="hljs-number">15</span> })
</code></pre>
<p><strong>--THE END--</strong></p>
<p>本文配套视频教程观看地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669240%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669240?spm=3001.4143" ref="nofollow noopener noreferrer">11-猫眼电影M站布局实战-布局框架</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669241%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669241?spm=3001.4143" ref="nofollow noopener noreferrer">12-猫眼电影M站布局实战-头部区域布局</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669242%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669242?spm=3001.4143" ref="nofollow noopener noreferrer">13-猫眼电影M站布局实战-脚部区域布局</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669243%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669243?spm=3001.4143" ref="nofollow noopener noreferrer">14-猫眼电影M站布局实战-内容导航区布局</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669244%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669244?spm=3001.4143" ref="nofollow noopener noreferrer">15-猫眼电影M站布局实战-最受电影区布局</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669245%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669245?spm=3001.4143" ref="nofollow noopener noreferrer">16-猫眼电影M站布局实战-列表布局</a></p>
<p>✋ 需要参加鸿蒙认证的请点击 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F930c921fb4964857843b5540e7fa5cf3%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/930c921fb4964857843b5540e7fa5cf3?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙认证链接</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>