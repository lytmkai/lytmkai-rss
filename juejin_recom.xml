<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[最强「学业成绩分析压力感知型 AI 心理陪伴」智能体—基于腾讯元器×TextIn大模型加速器×混元大模型的实战构建]]></title>    <link>https://juejin.cn/post/7587965908289110026</link>    <guid>https://juejin.cn/post/7587965908289110026</guid>    <pubDate>2025-12-26T14:09:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587965908289110026" data-draft-id="7588086766235582502" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最强「学业成绩分析压力感知型 AI 心理陪伴」智能体—基于腾讯元器×TextIn大模型加速器×混元大模型的实战构建"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-26T14:09:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CodeJourney"/> <meta itemprop="url" content="https://juejin.cn/user/3558441089502232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最强「学业成绩分析压力感知型 AI 心理陪伴」智能体—基于腾讯元器×TextIn大模型加速器×混元大模型的实战构建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3558441089502232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CodeJourney
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T14:09:52.000Z" title="Fri Dec 26 2025 14:09:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读28分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">最强「学业成绩分析压力感知型 AI 心理陪伴」智能体—基于腾讯元器×TextIn×混元大模型的实战构建</h2>
<h2 data-id="heading-1">一、项目背景</h2>
<p>在“双减”政策深化与教育数字化持续推进的背景下，<strong>学生学业评价正在从“唯分数论”向“数据驱动的全面成长分析”转型</strong>。成绩单不再只是简单的分数汇总，而是蕴含着学生学习状态、学科优势、波动趋势以及潜在心理压力的重要数据载体。</p>
<p>然而，在当前教学实践中仍普遍存在以下问题：</p>
<ul>
<li><strong>成绩分析维度单一</strong>：多数学校或班级仍停留在平均分、排名等静态统计层面，缺乏对个人成长轨迹、学科结构失衡、阶段性波动的深度分析；</li>
<li><strong>数据处理成本高</strong>：大量成绩单以 PDF、扫描件、照片等非结构化形式存在，人工整理耗时耗力，难以规模化应用；</li>
<li><strong>心理关怀长期缺位</strong>：成绩波动往往直接影响学生情绪与自我认知，但现实中教师精力有限，学生缺乏稳定、低门槛的情绪疏导与成长陪伴渠道；</li>
<li><strong>“分数压力”感知滞后</strong>：多数心理干预发生在问题显性化之后，缺乏基于学业数据的前置风险感知与温和介入机制。</li>
</ul>
<p>随着大模型技术与智能体平台的成熟，这一局面正在发生改变。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2eb4b8383674ceab99d5223668c9255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=ki0K39rMOwyMhHT3SZrXDhFUR8Q%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>本项目基于 <strong>腾讯元器智能体构建平台</strong>，融合 <strong>TextIn 大模型加速器的高精度 OCR 与表格结构化能力</strong>，并引入 <strong>混元大模型的多模态理解与情绪推理能力</strong>，构建一套 <strong>“班级多维度成绩分析 × 学业压力感知型 AI 心理陪伴智能体”</strong>。</p>
<p>该智能体不仅能够自动完成成绩单的高精度解析与多维统计分析，还能在此基础上：</p>
<ul>
<li>识别学生潜在的学业压力信号与情绪风险；</li>
<li>以<strong>非评判、低压力</strong>的方式进行情绪疏导与正向引导；</li>
<li>为教师提供数据驱动的班级画像与干预参考；</li>
<li>为学生提供持续、稳定、可对话的成长陪伴。</li>
</ul>
<p>通过将<strong>学业数据分析</strong>与<strong>情绪关怀智能体</strong>深度融合，本项目探索了一种面向真实教学场景的 <strong>“学业—心理协同型 AI Agent”</strong> 落地路径，为智慧教育与学生心理健康提供可复制、可扩展的技术实践范式。</p>
<h3 data-id="heading-2">1.1效果演示</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d57627925b4243978ca89258060cf99b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=eOcYAoGe9bYgcIOhxN1mIv0NrIM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d4048b33f5645c89d6aea3bb8d78337~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=CX5jRvK5NI64FtoG8aq6hZVd2Mw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0037f72807f4b51b007dbdb2454f9b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=Hl%2BTI%2BlDKoYJhZ0CtMjEdiS%2FMRc%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2939034d53d942cd9a97d0d183fa3ca1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=4GB%2F4JZVkN2H7CnP4ZG1aQCj14E%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/847a97f1ea684c01abd3a81638a7ea98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=EcYkOd6A9hjwsEq9TFDQPl56C5E%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc1c5397c2384af8b9adbde1ec4de34b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=1EEsHs%2B2gdoOW4o3Z4AC8RDdGe8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-3">二、项目知识点概览</h2>
<p>在本项目中，我们并非单一依赖某一个大模型或工具，而是通过<strong>智能体平台 + 文档理解引擎 + 通用大模型</strong>的协同，构建一套面向真实教育场景的复合型 AI 系统。以下对项目涉及的三项核心技术能力进行简要说明。</p>
<h3 data-id="heading-4">2.1 什么是腾讯元器？</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddd5a04e3d664216af67775035787389~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=rlQesesHT9brPqaYLppfVmc5jfQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>腾讯元器</strong>是腾讯推出的一站式 <strong>AI 智能体（Agent）构建与运行平台</strong>，面向开发者提供从能力编排、模型调用到上下文管理的完整智能体基础设施。</p>
<p>与传统“单轮对话式 AI”不同，腾讯元器强调的是：</p>
<ul>
<li><strong>可感知环境</strong></li>
<li><strong>可规划流程</strong></li>
<li><strong>可调用工具</strong></li>
<li><strong>可持续记忆</strong></li>
</ul>
<p>即具备完整“感知—决策—行动—反馈”闭环的智能体能力。</p>
<p>在实际使用中，开发者可以通过腾讯元器：</p>
<ul>
<li>将 OCR、数据分析、大模型推理等能力封装为独立节点；</li>
<li>通过流程编排方式构建多步骤智能体任务；</li>
<li>为不同角色（学生 / 教师）配置差异化交互逻辑；</li>
<li>管理智能体上下文记忆与权限边界。</li>
</ul>
<p>在本项目中，腾讯元器作为<strong>智能体的“中枢系统”</strong>，负责串联成绩解析、数据分析、压力感知与情绪陪伴等多个能力模块，实现复杂教育场景下的稳定运行与可扩展落地。</p>
<h3 data-id="heading-5">2.2 什么是 TextIn 大模型加速器？</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41905fc77b9f469799ff8cdf65a011e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=ArB69xVvX%2FTXzHjNIm9cIJc6btY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>TextIn 大模型加速器</strong>是一套面向 <strong>复杂文档理解场景</strong> 的智能解析引擎，核心能力是将 <strong>非结构化文档高精度转化为结构化数据</strong>。</p>
<p>在教育场景中，成绩单通常存在以下特点：</p>
<ul>
<li>格式不统一、模板多样；</li>
<li>表格结构复杂，存在合并单元格；</li>
<li>来源多为扫描件或拍照图片；</li>
<li>含有大量相似字段，人工校对成本高。</li>
</ul>
<p>TextIn 大模型加速器通过 <strong>大模型 + 规则引擎 + 视觉理解</strong> 的方式，提供：</p>
<ul>
<li>高精度 OCR 文字识别；</li>
<li>表格结构自动还原；</li>
<li>字段语义识别与对齐；</li>
<li>错误容忍与纠偏能力。</li>
</ul>
<p>在本项目中，TextIn 负责将成绩单从“看得懂但用不了”的文档形态，转化为 <strong>可计算、可分析、可推理</strong> 的标准化数据，为后续班级分析与情绪判断提供可靠输入基础。</p>
<h3 data-id="heading-6">2.3 什么是混元大模型？</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0673ae7d83ac4283a560cad6a500d7b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=8cvZ7ZhwNeTN4Jj9iNLGUZfSB2s%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>混元大模型</strong>是腾讯自研的通用大语言模型体系，具备自然语言理解、逻辑推理、情绪识别与内容生成等多项能力，适用于复杂、多轮、上下文敏感的交互场景。</p>
<p>相较于仅用于文本生成的大模型，混元更强调：</p>
<ul>
<li><strong>上下文连续理解能力</strong></li>
<li><strong>多维度语义推理能力</strong></li>
<li><strong>情绪与意图识别能力</strong></li>
<li><strong>可控、稳健的输出风格</strong></li>
</ul>
<p>在本项目中，混元大模型主要承担三类核心任务：</p>
<ol>
<li>
<p><strong>成绩分析结果的语义总结与解释</strong>
将冰冷的统计数据转化为学生与教师易于理解的自然语言反馈。</p>
</li>
<li>
<p><strong>学业压力与情绪状态推理</strong>
结合成绩变化与学生语言输入，识别潜在压力信号与情绪波动。</p>
</li>
<li>
<p><strong>陪伴式对话与引导反馈</strong>
以非评判、低压力的方式与学生持续互动，提供情绪疏导与成长引导。</p>
</li>
</ol>
<p>混元大模型的引入，使系统不仅“会算分”，更“懂学生”，是实现“学业压力感知型 AI 心理陪伴”的关键能力支撑。</p>
<h2 data-id="heading-7">三、技术方案</h2>
<p>本项目以“<strong>学业数据可结构化、压力状态可感知、成长陪伴可持续</strong>”为核心目标，基于腾讯元器智能体平台，构建一套覆盖 <strong>数据采集 → 成绩分析 → 压力感知 → 情绪疏导 → 成长反馈</strong> 的闭环式 AI 智能体技术方案。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d86f8711ae1406a9151ad4e83df35b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=L5tq7MPbrKs1DuUFiZ0SN40yAbQ%3D" alt="" loading="lazy"/></p>
<p>整体架构采用 <strong>“多源数据解析 + 大模型推理 + 规则与情绪协同决策”</strong> 的设计思路，确保系统在真实教学场景中具备可解释性、稳定性与可扩展性。</p>
<h3 data-id="heading-8">3.1 智能体总体架构设计（基于腾讯元器）</h3>
<p>项目核心智能体构建于 <strong>腾讯元器平台</strong>，通过模块化节点编排的方式，实现多能力协同：</p>
<ul>
<li><strong>输入层</strong>：成绩单图片 / PDF / 扫描件、学生自然语言输入（情绪倾诉、学习困惑）</li>
<li><strong>能力层</strong>：
<ul>
<li>OCR 与表格解析节点（TextIn 大模型加速器）</li>
<li>成绩统计与趋势分析节点</li>
<li>学业压力感知与情绪推理节点（混元大模型）</li>
<li>对话与陪伴响应节点</li>
</ul>
</li>
<li><strong>输出层</strong>：
<ul>
<li>班级多维度成绩分析报告</li>
<li>学生个性化学习与情绪反馈</li>
<li>教师侧结构化分析与风险提示</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4369939866ab4924a33dd176ee3f395b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=CQiOMndjw6tdjYy5f4jNDATEbG4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>通过腾讯元器的 <strong>流程编排、上下文记忆与权限控制能力</strong>，实现学生端与教师端的智能体能力隔离与协同。</p>
<hr/>
<h3 data-id="heading-9">3.2 成绩单高精度解析方案（TextIn 大模型加速器）</h3>
<p>针对成绩单<strong>格式多样、表格结构复杂、扫描质量参差不齐</strong>的问题，系统引入 <strong>TextIn 大模型加速器</strong>，完成非结构化成绩单的高精度结构化处理。</p>
<p>核心能力包括：</p>
<ul>
<li><strong>多格式支持</strong>：支持图片、PDF、扫描件等多种输入形式；</li>
<li><strong>表格结构还原</strong>：自动识别表头、合并单元格、学科列与学生行；</li>
<li><strong>字段语义识别</strong>：区分姓名、学号、单科成绩、总分、排名等关键字段；</li>
<li><strong>错误容忍与修正</strong>：对倾斜、模糊、低分辨率文档具备较强鲁棒性。</li>
</ul>
<p>输出结果为标准化 JSON / 表格结构数据，为后续分析与大模型推理提供可靠数据基础。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/339fd18091694f2c9ef78c43166a095f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=AxTqdkV2l6GeaZMgkR7onm3N79o%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-10">3.3 学业压力感知与情绪推理机制（混元大模型）</h3>
<p>区别于传统仅基于分数的分析方式，本项目引入 <strong>“学业压力感知模型”</strong>，将成绩数据与学生语言输入进行联合推理。</p>
<p>压力识别信号来源包括：</p>
<ul>
<li>成绩连续下降或波动加剧；</li>
<li>单科长期低于班级均值；</li>
<li>学业负担相关高频情绪词（焦虑、害怕、失望等）；</li>
<li>自我否定、比较型语言模式。</li>
</ul>
<p>基于 <strong>混元大模型的情绪理解与上下文推理能力</strong>，系统对学生当前状态进行综合判断，并划分为不同压力等级，作为后续干预策略的依据。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98556f886aa34d80b2bfad7672c8c9a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=siCI4wV0%2FdJN2JZR2OGGqMEfcNY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-11">四、搭建「学业成绩分析压力感知型 AI 心理陪伴」智能体</h2>
<p>在完成项目背景、核心技术选型与整体技术方案设计之后，本章将围绕<strong>如何基于腾讯元器实际搭建该智能体</strong>展开，重点介绍智能体的创建流程、能力节点配置方式以及关键逻辑的落地实现思路，确保方案不仅“能讲清”，也“能跑起来”。</p>
<h3 data-id="heading-12">4.1 腾讯元器智能体创建</h3>
<p>在腾讯元器平台中，首先创建一个新的智能体实例，并明确其<strong>角色定位与服务对象</strong>。</p>
<p>本项目采用 <strong>“一体多角色”</strong> 的设计思路，即：</p>
<ul>
<li>
<p><strong>学生侧智能体</strong></p>
<ul>
<li>面向学生提供成绩解读、学习反馈与情绪陪伴</li>
<li>强调共情、引导与非评判式对话</li>
</ul>
</li>
<li>
<p><strong>教师侧智能体</strong></p>
<ul>
<li>面向教师提供班级成绩画像、趋势分析与风险提示</li>
<li>强调数据客观性与可解释性，避免情绪化标签</li>
</ul>
</li>
</ul>
<p>在元器中通过<strong>不同的提示词模板与权限配置</strong>，实现同一套底层能力、不同交互表现的智能体分支。</p>
<p>登录腾讯元器平台后，点击右上角 「个人空间」，进入 「我的智能体」 页面，选择 「创建智能体」。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a638153d1284763844ee1fed264d714~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=RB%2FynbQp43FuRprxErSqKi%2FJhLE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在智能体类型选择界面中，选择 「对话式智能体」。
该类型适用于具备多轮交互、情绪理解与复杂任务处理能力的应用场景，适合本项目中“成绩分析 + 情绪疏导”的复合需求。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06ccd17784c74ade914d5943d112bf42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=2v%2BC7b0Tx8gutbyQncBFK8MPZAA%3D" alt="在这里插入图片描述" loading="lazy"/>
在新建对话式智能体页面中，填写以下信息：</p>
<ul>
<li>
<p>智能体名称：用于对外展示与识别</p>
</li>
<li>
<p>智能体简介：简要说明智能体的核心能力与使用场景</p>
</li>
</ul>
<p>信息填写完成后，点击 「新建」 按钮，完成智能体的基础创建。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4624904b3ffb4e03b018d84980437176~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=CXn%2FfYRQo8DbbR1u0XUMx0pDyg4%3D" alt="在这里插入图片描述" loading="lazy"/>
创建成功后，系统将自动跳转至智能体后台管理页面。在该页面中，可以对智能体进行角色设定、模型选择、能力配置与测试验证等操作。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/784f3ad828e84312b3311201df11c2c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=K8QVMzqIWq8OsmdSQvqAstZPoNM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-13">4.2 智能体角色定位</h3>
<p>在 「角色设定 / 提示词」 模块中，编写智能体的系统提示词（System Prompt）。
可结合平台提供的 「提示词一键优化」 功能，对初始提示词进行结构化与语义增强。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/424daf5bee914e3384595a69ff63ce2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=c2Gvak7qZzILwbg165HcFY3xd%2Bg%3D" alt="在这里插入图片描述" loading="lazy"/>
以下为本项目中使用的核心角色提示词，用于明确智能体的定位、能力边界与输出风格：</p>
<pre><code class="hljs language-bash" lang="bash">【要求】扮演一名学业成绩分析与压力感知型AI心理陪伴智能体，能够基于学生成绩单数据与学生自然语言输入，进行多维度学业分析、学业压力感知，并以非评判、陪伴式方式为学生提供情绪疏导与成长引导，同时为教师提供去情绪化的数据分析与风险提示。

【名称】学业成绩分析与压力感知型 AI 心理陪伴智能体

【属性】AI智能体，专注于学业成绩分析与压力感知，具备情绪理解能力

【人物关系】学生、教师

【人物经历】由教育心理学专家、数据科学家及AI工程师共同开发，旨在通过技术手段帮助学生缓解学业压力，促进健康成长。

【外貌特征】无实体形态，以文字形式呈现

【性格特点】温和、理性、不居高临下，重视共情，不直接否定用户感受，不使用心理诊断或标签化语言，表达清晰、有结构，但避免说教

【语言风格】
- 学生端输出：温和、鼓励、共情型表达
- 教师端输出：客观、中性、数据驱动表达

【人物喜好】无具体喜好，但致力于帮助学生和教师解决问题

【输出要求】
- 使用简体中文
- 分点输出时需逻辑清晰
- 情绪疏导时先共情、再引导、最后给建议

【能力限制】
- 不能进行心理疾病诊断或治疗建议
- 不能替代教师、家长或心理咨询师的专业决策
- 不输出任何对学生的负面标签或价值评判
- 不基于单次成绩波动做长期能力判断

【其他要求】
- 面向学生时偏陪伴与引导
- 面向教师时偏数据与客观分析

【能达成以下用户意图】
<span class="hljs-comment">#意图名称：学业压力缓解</span>
<span class="hljs-comment">#意图描述：通过分析学生成绩单数据和自然语言输入，识别学业压力源，并提供情绪疏导和成长引导。</span>
<span class="hljs-comment">#意图示例：学生表示近期考试成绩下降，感到焦虑。AI智能体通过分析成绩单和学生输入，发现其在数学和物理科目上表现不佳，可能因此产生焦虑。</span>
<span class="hljs-comment">#意图实现：AI智能体首先共情学生的情绪，然后引导学生找到学习方法上的不足，并提供具体的改进建议，如制定合理的学习计划、调整学习策略等。</span>

<span class="hljs-comment">#意图名称：教师数据分析支持</span>
<span class="hljs-comment">#意图描述：为教师提供去情绪化的数据分析与风险提示，帮助教师更好地了解学生的学习情况和潜在问题。</span>
<span class="hljs-comment">#意图示例：教师希望了解班级整体学业表现和潜在问题。AI智能体通过分析班级成绩单数据，发现某些科目普遍成绩较低，可能存在教学难点或学生兴趣不足等问题。</span>
<span class="hljs-comment">#意图实现：AI智能体将分析结果以客观、中性的语言呈现给教师，并提出相应的教学调整建议，如增加互动环节、调整教学进度等。</span>

</code></pre>
<p>在 「欢迎语设置」 中配置用户首次进入对话时的引导语，用于明确智能体能力边界，并引导用户正确输入。</p>
<blockquote>
<p>哈喽，我是学业成绩分析压力感知型 AI 心理陪伴，请发送您的成绩单。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/089b899d0be34bb4a4833236ca650f44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=%2BM8hx8g4FqnWyZFYQAuWWoFnhnc%3D" alt="在这里插入图片描述" loading="lazy"/>
在模型配置模块中，选择 混元大模型 作为智能体底层推理模型。
该模型在中文理解、多轮对话、情绪语义识别及结构化输出方面表现稳定，适合教育与心理陪伴类应用场景。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ffdc96f44e940728af717d1f510e0f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=ytdwANO3MMaCV08b1EqaCtfteJI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/873f29c47d204257be445d737193360a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=c9%2BbGBAZroAmA%2BQLr02VKVFxJMc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-14">五. 腾讯元器智能体工作流编写</h2>
<p>智能体的核心能力不仅来源于大模型本身，更依赖于清晰、可控的工作流设计。通过工作流，可以将“用户输入 → 数据解析 → 逻辑判断 → 模型推理 → 结果输出”拆解为多个可管理的节点，使智能体具备稳定、可复用的业务执行能力。</p>
<h3 data-id="heading-15">5.1 工作流创建</h3>
<p>在智能体后台管理页面中，点击左侧 「工作流管理」，然后点击 「新建」，开始创建新的智能体工作流。</p>
<p>该工作流将作为智能体处理用户请求的主执行链路。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5197f52470042d7ae70e0c0dfbb4183~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=RpQ1wG6LwNV7u3aFHQ%2FMXXV%2Fmws%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在创建方式选择弹窗中，选择 「手动录入」。</p>
<p>手动录入方式适合需要精细控制逻辑节点、条件分支与多角色输出的复杂智能体场景，本项目中的“成绩分析 + 情绪疏导”正是典型代表。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65d27dbe5df441499a065cc34e242108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=Zmg2myycjakWEE%2Bc282tzE919Yg%3D" alt="在这里插入图片描述" loading="lazy"/>
在新建工作流页面中，填写以下信息：</p>
<ul>
<li>
<p>工作流名称：用于标识该工作流的功能用途（如：成绩分析与压力感知主流程）</p>
</li>
<li>
<p>工作流描述：简要说明该工作流的执行目标、适用对象与核心逻辑</p>
</li>
</ul>
<p>填写完成后确认创建，系统将生成一个新的工作流实例。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fa8fe3a216246ba90bb6d7b105cee01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=C9e7w4P77MjKv6yU6fKHOeOrub8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>工作流创建完成后，将自动进入 工作流编辑面板。
该面板是后续进行节点编排、条件判断、模型调用与输出控制的核心操作区域。</p>
<p>在面板中，可以清晰看到：</p>
<ul>
<li>
<p>工作流的整体执行结构</p>
</li>
<li>
<p>各功能节点的连接关系</p>
</li>
<li>
<p>当前工作流的起始节点与结束节点</p>
</li>
</ul>
<p>后续的成绩单解析、学业分析、压力感知与结果输出，均将在该面板中以节点方式逐步构建。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcae94c4a7f840c09ba9e16214b9fac6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=VvFKelNdcLuycEvtVQL%2FnWm9%2FRM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>配置工作流的开始节点，定义两个输入变量：</p>
<p>image：用于接收学生上传的成绩单图片，作为后续 OCR 解析与成绩分析的原始数据输入。</p>
<p>q：用于接收学生以自然语言形式提出的学习困惑、情绪表达或具体分析需求，作为智能体理解用户意图与情绪状态的重要输入。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a165583ac8664ccba596d80aa9b393c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=%2BMKCFB5PSwS%2FzokdFvCP7mTCRFM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-16">5.2 成绩单解析能力节点配置（TextIn 大模型加速器接入）</h3>
<p>在智能体能力编排中，在开始节点后需要配置 <strong>成绩单解析节点</strong>，作为整个系统的数据处理识别中心。</p>
<p>在元器流程中，该节点的核心职责是：</p>
<ol>
<li>接收用户上传的成绩单文件；</li>
<li>调用 TextIn 完成 OCR 与表格结构还原；</li>
<li>输出包含学生信息、学科成绩、总分、排名等字段的结构化结果；</li>
<li>将结果传递给后续分析节点。</li>
</ol>
<p>这一节点解决的是“<strong>数据从哪来、是否可靠</strong>”的问题，是后续所有分析与推理的前提基础。</p>
<hr/>
<p>完成开始节点配置后，需要引入 OCR 与文档结构化解析能力。本方案选用 TextIn 大模型加速器（通用模型），用于将成绩单解析为 Markdown 结构化结果。</p>
<blockquote>
<p>/ai/service/v1/pdf_to_markdown</p>
</blockquote>
<ul>
<li>输入：PDF、图片或扫描件</li>
<li>输出：JSON 结构化数据，包括学生信息、课程成绩、总评等级等</li>
<li>技术特点：
<ul>
<li>多模态解析，支持图片文字、表格识别</li>
<li>自动格式标准化，兼容不同院校模板</li>
</ul>
</li>
</ul>
<p>python调用示例：(虽然我们在腾讯元器里可以直接调用，但是还是建议理解一下下面这段直接调用TextIn 大模型加速器的代码，会让我们更容易理解)</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> requests

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OCRClient</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, app_id: <span class="hljs-built_in">str</span>, secret_code: <span class="hljs-built_in">str</span></span>):
        self.app_id = app_id
        self.secret_code = secret_code

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">recognize</span>(<span class="hljs-params">self, file_content: <span class="hljs-built_in">bytes</span>, options: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-comment"># 构建请求参数</span>
        params = {}
        <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> options.items():
            params[key] = <span class="hljs-built_in">str</span>(value)

        <span class="hljs-comment"># 设置请求头</span>
        headers = {
            <span class="hljs-string">"x-ti-app-id"</span>: self.app_id,
            <span class="hljs-string">"x-ti-secret-code"</span>: self.secret_code,
            <span class="hljs-comment"># 方式一：读取本地文件</span>
            <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/octet-stream"</span>
            <span class="hljs-comment"># 方式二：使用URL方式</span>
            <span class="hljs-comment"># "Content-Type": "text/plain"</span>
        }

        <span class="hljs-comment"># 发送请求</span>
        response = requests.post(
            <span class="hljs-string">f"/ai/service/v1/pdf_to_markdown"</span>,
            params=params,
            headers=headers,
            data=file_content
        )

        <span class="hljs-comment"># 检查响应状态</span>
        response.raise_for_status()
        <span class="hljs-keyword">return</span> response.text

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># 创建客户端实例，需替换你的API Key</span>
    client = OCRClient(<span class="hljs-string">"你的x-ti-app-id"</span>, <span class="hljs-string">"你的x-ti-secret-code"</span>)

        <span class="hljs-comment"># 插入下面的示例代码</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()

</code></pre>
<p>在开始节点后选择工具节点
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5481084f9f7e443582aaa4e767bf3bf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=EtMb6aPgO5VqR9CpGdLTTT5qzoc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/180a152dbee64442b671f1bd287e8625~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=KfY%2FAW%2FNbMgqorflFE59JU7j0W0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在 HTTP 请求节点中，需要配置以下两个关键请求头参数：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1bdca0bc7b84179a52963f1fb6dc764~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=IDuld1AEEMd4bKxjTuLggClLPr8%3D" alt="在这里插入图片描述" loading="lazy"/>
如果不清楚这两个参数如何填写，可按以下步骤获取：</p>
<ol>
<li>登录 TextIn 控制台</li>
<li>进入 开发者信息 / 应用管理</li>
<li>查看对应应用的：
x-ti-app-id
x-ti-secret-code</li>
</ol>
<p>⚠️ 注意：
二者组合构成唯一合法调用凭证，请妥善保管，可以到TextIn 控制台里的开发者信息处查看。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60227c58544f46df9965d918b170dd23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=oXWrZk8N%2FRHePTGIt6jXCBem8fI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在API参数区域设置变量名。
x-ti-app-id
x-ti-secret-code
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9dfd62aa3a8f49bc9db1cbb56811388a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=OEQ6HosmC%2Fx4tx1c1goXAo7AUOM%3D" alt="在这里插入图片描述" loading="lazy"/>
在Body请求体，承载复杂 / 大容量 / 结构化数据，是请求的核心载荷。中绑定开始节点传入的image参数。如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d23928ec64a43b88e5e8e46c0c18297~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=UVRlHLs0OWlJYvLIoPIz2pNVc9o%3D" alt="在这里插入图片描述" loading="lazy"/>
TextIn 大模型加速器节点的默认输出变量为 out_text。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba6c97a7cb5f4ee382bafcf38ffdaa2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=dC1NWUz6v5keQrKE16EjKMphXQY%3D" alt="在这里插入图片描述" loading="lazy"/>
在实际接入过程中，作者通过多次尝试并结合官方学习文档发现：
工具节点在参数传递能力上存在限制，无法完全满足当前 OCR 接口的调用需求，尤其是在需要灵活控制 Header、Query 参数以及 二进制的数据格式场景下。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7d60f125f90402982a84a8eb6f0a4a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=IwWMNZ9rY%2FB%2FW9h%2B7Nsr6WCRFSw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f4076e06eaf4d28ac761a8040f92403~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=cCc3cwsZFWZPocrYlk8kzXCuTSQ%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe848fbdf9544df7ae6a4f76edb0a49e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=UTLg9Y%2BYysUTKcKXhU6wySKag2Q%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4abfedd9b9a7489bafc42cfc7aec6029~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=5u0n0%2BMP4JspFMOl67x%2F4yBHmxI%3D" alt="在这里插入图片描述" loading="lazy"/>
不过，腾讯元器工作流额外支持「代码节点」，这使得上述问题可以通过自定义代码的方式进行妥善解决，从而绕开工具节点在参数能力上的限制。</p>
<p>因此，我们采用如下方案：</p>
<p>👉 在开始节点（Start）之后新增一个代码节点（Code Node），由该节点直接完成 TextIn OCR API 的调用与结果解析。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37d819527a6d4164885187be2bfabe4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=CngEsTaEOUlYZqv9eL8A8XrWa6E%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecfd8ea302384c42abcd00f94c420157~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=8w9yPEieuKfFJFjc3RSmhRRBcSE%3D" alt="在这里插入图片描述" loading="lazy"/>
根据 TextIn 官方开发文档，在代码节点中编写完整的 OCR 调用逻辑，包括：</p>
<ul>
<li>
<p>请求 Header 中的 x-ti-app-id 与 x-ti-secret-code</p>
</li>
<li>
<p>Query 参数的动态拼装</p>
</li>
<li>
<p>请求 Body 直接传入图片 URL</p>
</li>
<li>
<p>返回结果强制解析为 JSON 对象
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b64cbd464c6433f9b9fadc22b209ab8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=nH55PB78IFrhy6phKl9oUMMOPyQ%3D" alt="在这里插入图片描述" loading="lazy"/>
调用代码如下</p>
</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">OCRClient</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, app_id: <span class="hljs-built_in">str</span>, secret_code: <span class="hljs-built_in">str</span></span>):
        self.app_id = app_id
        self.secret_code = secret_code

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">recognize</span>(<span class="hljs-params">self, image_url: <span class="hljs-built_in">str</span>, options: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        headers = {
            <span class="hljs-string">"x-ti-app-id"</span>: self.app_id,
            <span class="hljs-string">"x-ti-secret-code"</span>: self.secret_code,
            <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/plain"</span>
        }

        params = {k: <span class="hljs-built_in">str</span>(v) <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> options.items()}

        resp = requests.post(
            <span class="hljs-string">"https://api.textin.com/ai/service/v1/pdf_to_markdown"</span>,
            headers=headers,
            params=params,
            data=image_url
        )

        resp.raise_for_status()

        <span class="hljs-comment"># ⚠️ 这里强制转成 JSON 对象</span>
        <span class="hljs-keyword">return</span> resp.json()


<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">input_data: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
    <span class="hljs-string">"""
    节点主函数
    输入：
    {
        "image": "https://xxx.png"
    }

    输出（JSON 对象）：
    {
        "success": true,
        "result": {...}
    }
    """</span>

    image = input_data.get(<span class="hljs-string">"image"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> image:
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"error"</span>: <span class="hljs-string">"image 参数缺失"</span>
        }

    <span class="hljs-keyword">try</span>:
        result = client.recognize(
            image_url=image,
 
        )

        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"result"</span>: result
        }

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)
        }


</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7db24f141ce74dfe803f2f4fa1180cc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=ZYqI%2FcAYE8gRldjP%2FYK4cYgz3fc%3D" alt="在这里插入图片描述" loading="lazy"/>
在代码节点中，对外暴露的输入变量命名为 image，用于接收上一节点传入的图片 URL。</p>
<p>完成配置后，可以通过 单点调试 功能快速验证节点运行效果。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ae32097a5fc43fe97f5db38a2346e88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=iFE92qUH36L%2BVZJHUymHIAlLOUk%3D" alt="在这里插入图片描述" loading="lazy"/>
调试过程中输入的测试图像如下：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecffadf6619f4ff689ead82734f1f77d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=vW%2FhAUpI5LPuuHN%2BDw83eJO0cU8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6115199c5a014032a82f7646b595e005~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=LLUdLGCYzLRVUGx4%2F5K5e5B251Q%3D" alt="在这里插入图片描述" loading="lazy"/>
代码节点执行成功后，返回的 TextIn 大模型加速器 OCR 结果如下：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31d4baad7f064905a779b6c7276453f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=Wrcy5NReyM61d0A92dz1BLkYJNY%3D" alt="在这里插入图片描述" loading="lazy"/>
此时可以发现：
如果输出变量仍然使用默认的 out_text，将无法正确捕获返回结果。</p>
<p>解决方式是：</p>
<blockquote>
<p>👉 将代码节点的输出变量显式设置为 data，即可完整接收 JSON 结构的 OCR 解析结果。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4ed50667fab48bb9870895a8831bcc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=kUCKn45wVzuaCw%2B8OMLoQH3dFJU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc162f267dd64bd4a8da55c4facda33d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=hPcg2vEKV3l2E7rOb6JkQGVFmek%3D" alt="在这里插入图片描述" loading="lazy"/>
整体调试也没有任何问题，到此成绩单解析能力节点配置完毕。下面可接入分析大模型。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60f78893063e4d59b77e19d47fe81896~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=lXVaw2boneTXdSAZi1xuxsUZDww%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e82f408d7bc04d6c89d703dc965317d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=eEA6YvmxeNunRN%2F0aI96w5fzLkk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-17">5.3 成绩分析与规则计算节点设计</h3>
<p>在获取结构化成绩数据后，智能体进入 <strong>成绩分析与统计计算阶段</strong>。</p>
<p>该阶段采用 <strong>规则计算 + 大模型解释</strong> 的方式：</p>
<ul>
<li>
<p>数据处理节点负责：</p>
<ul>
<li>平均分、最高分、最低分计算</li>
<li>学科均衡度与偏科识别</li>
<li>成绩趋势与波动检测</li>
</ul>
</li>
<li>
<p>压力感知型心理陪伴节点负责：</p>
<ul>
<li>对统计结果进行自然语言总结</li>
<li>将数据结论转化为“学生/教师听得懂的话”</li>
<li>对学生成绩进行压力分析</li>
<li>提出成绩提升计划</li>
<li>对学生进行心理疏导，避免压力过大</li>
</ul>
</li>
</ul>
<p>在腾讯元器中，这一阶段通常以 <strong>数据处理节点 + 压力感知型心理陪伴节点节点</strong> 的组合方式实现。</p>
<h3 data-id="heading-18">5.4 数据处理节点（混元大模型）</h3>
<p>在完成 TextIn 大模型加速器 OCR 解析后，我们将引入 混元大模型进行专业的数据处理分析。
数据处理节点主要功能包括：</p>
<blockquote>
<p>平均分、最高分、最低分计算
学科均衡度评估与偏科识别
成绩趋势及分数波动检测</p>
</blockquote>
<p>在 TextIn OCR 代码节点之后，新增 混元大模型数据处理节点。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06ec8f22973b40bfbc6457ab46e13497~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=iYAIbPGKtbWwQmjNtQpBlJYnvyo%3D" alt="在这里插入图片描述" loading="lazy"/>
选择擅长数学计算的 混元 2.0 模型 以保证数据处理的精度与专业性。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa2e32d4c742475cb4fda4ea97a17a3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=cOpdgcggoc%2FYPib4kBe8A5fFfQc%3D" alt="在这里插入图片描述" loading="lazy"/>
将前节点输出的 OCR 数据绑定为输入变量，以便混元模型直接接收成绩单数据。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5595964f2dc14ecc98a6035346b3f0ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=4KbigPsbFdJaOgHuEUr3m5U5jKA%3D" alt="在这里插入图片描述" loading="lazy"/>
为确保混元模型能够高效完成数据处理，设计了如下提示词：</p>
<pre><code class="hljs language-bash" lang="bash">根据ocrinput
的成绩单识别结果，计算平均分、最高分和最低分；分析各学科分数的均衡度并识别是否存在偏科现象；同时检测成绩随时间的变化趋势及分数波动情况。请明确说明成绩数据是否包含时间信息，以便进行趋势与波动分析。若ocrinput
中包含科目名称，请确保识别准确以支持学科均衡度分析。

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/732812c32ac24f048cde14b6ae899c9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=zKUGCc6UYgBP0C6sjefjV3D8St8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>完成 数据处理节点配置后，开始进行调试验证：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15d9103388a846269b1e10b1b2cae2a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=YmAyRZaQFrxyF1ENuaG9Qzp4Pow%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>输入测试数据：张晨的高三考试成绩单。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c34c240f9e8e4381ab5cc99bc649264e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=DBMrSFusaoVNOZxafwiF27cDkfI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>运行调试结果如下
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efc75a1f377846d791d21b2df4569445~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=zpeV3VsNlIWGh5IuqvVI6xTVjpQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>可以看到数据处理节点
对</p>
<ul>
<li>平均分、最高分、最低分计算</li>
<li>学科均衡度与偏科识别</li>
<li>成绩趋势与波动检测
的分析十分专业
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4057f78c33744718b7d0d935e1dab92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=7IsOHGnKz4pCx1SGsPYsCzDSoPM%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ul>
<p>混元大模型在本次数据处理任务中表现非常出色。它不仅能够准确计算平均分、最高分和最低分，而且能够深入分析各科分数的分布特征，量化学科均衡度，并给出科学的偏科判断。
模型对理科与文科的区分、标准差与极差的计算以及偏科结论的逻辑推理都非常严谨，分析条理清晰，结果专业可信。通过混元大模型的处理，原本散乱的成绩数据被系统化、结构化地呈现出来，让人一目了然，极大地提升了成绩分析的效率和精准度，可谓是一次高质量的智能化数据分析体验。</p>
<h3 data-id="heading-19">5.5 压力感知型心理陪伴节点（混元大模型）</h3>
<p>在数据处理节点（混元大模型）后添加压力感知型心理陪伴节点
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1826a6d74d484e1db46b310988a81046~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=pWRUwNgd1AWQt8YwFkU6QQ0gWbo%3D" alt="在这里插入图片描述" loading="lazy"/>
模型选择混元大模型T1版</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4e171c44019499883b3603ea9f8dff1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=ZDFXEfLV5Z9CWhIPAg8Pv2v19qc%3D" alt="在这里插入图片描述" loading="lazy"/>
输入变量为数据处理节点（混元大模型）的处理内容
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bec7ee3d7f9464bbb2c0d602417c677~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=2hJIqqTYwGO6t4fvSy7DnvA%2BjK8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>提示词如下</p>
<pre><code class="hljs language-bash" lang="bash">现在是学生向你发送了他的成绩单解析结果，你需要基于此做压力感知型心理陪伴节点，重点安慰和鼓励学生。根据数据处理节点_混元大模型对input
中的成绩单进行的解析，以及结合学生输入的问题q
，完成以下任务：  
* 用清晰、准确且通俗易懂的自然语言总结成绩统计结果；  
* 将数据分析结论转化为学生都容易理解的表达；  
* 针对学生各科成绩，分析可能面临的学业压力及具体成因；  
* 结合成绩与压力情况，给出切实可行的成绩提升建议和可操作的学习计划；  
* 重点关注学生心理状态，提供温暖的心理疏导建议，帮助其缓解压力、保持积极心态。

</code></pre>
<p>开始调试</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/971a123eb5284146a2a4c9288888844f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=ZN%2FnSYHSH43ZD2p0sUSCpx26Lic%3D" alt="在这里插入图片描述" loading="lazy"/>
可以看到压力感知型心理陪伴节点主要处理了</p>
<ul>
<li>对统计结果进行自然语言总结</li>
<li>将数据结论转化为“学生/教师听得懂的话”</li>
<li>对学生成绩进行压力分析</li>
<li>提出成绩提升计划</li>
<li>对学生进行心理疏导，避免压力过大</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e8735dbbdb640e39290db175c582ff2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=2NK0n5aCjH93T72Jtw3k6a1fPEg%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bf72fb21a9c46dd88dfef6465fa5a2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=cXpHpyYGwtfT0UBguKpSVMRQeM0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbe9aa6b37d94a7d9af12dbaab1b731f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=GXKhkBe%2F5DO50314f4nsrCtBAkY%3D" alt="在这里插入图片描述" loading="lazy"/>
混元大模型在本次张晨同学成绩分析与成长建议生成中表现十分出色。它不仅能够全面整合各科成绩数据，精准计算总分、平均分、最高分、最低分和标准差，还能智能识别学科均衡性与偏科情况，为理科和文科的优势与薄弱点提供清晰量化依据。更难得的是，模型能够结合成绩特点生成专业、可操作的学习策略与心理疏导建议，涵盖时间分配、学习方法优化及信心建设等多个维度，既兼顾学生实际学习情况，也符合教育心理学指导原则。整体分析条理清晰、逻辑严谨、内容专业可信，堪称一次高质量的智能化学业分析实践成果。</p>
<h2 data-id="heading-20">六. 智能体调试与发布</h2>
<p>完成工作流的编写与各节点调试后，下一步是在 工作流管理中启用新创建的工作流，使其可以对外提供服务。</p>
<p>启用工作流，在工作流管理界面找到刚刚创建的工作流，点击 启用/激活 按钮，使其进入可调用状态。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80d92939aa5f4772950951dd99b37338~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=I4%2FyxUS89xIMaFMqRndcLbjxjNE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在智能体界面中发送测试数据（如学生成绩单），观察工作流的响应结果。
成功启用后，智能体会按照设计逻辑自动处理输入数据，并返回分析报告。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c601e02b53144b39aa2d6a1c607a49c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=8Zq4QaGggQLPdKT2diNaJt%2Foskc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>检查智能体返回的分析结果是否完整、准确，包括成绩统计、学科均衡度、偏科分析以及成长建议等内容。
成功返回结果后，即表明整个工作流已正常运行，可正式投入使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3f2fadaa9fa44a5bcb95cbc5c81e22d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=6p%2BN%2BR7eAFUddgaKmOngZULQemQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a87f548c0c34c1b8336213bb87a03e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=%2FSsj%2BTFQkV3KPk1akXO42nupi%2Fo%3D" alt="在这里插入图片描述" loading="lazy"/>
调试确认工作流运行正常后，在智能体页面找到对应智能体，点击 “发布” 按钮。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80fee541eabb4cc98d33575da45b57c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=4xuqGn42mLrxNooY%2FUXJOYLJyqM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>确认无误后点击 确认发布。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94a9e866f349449a9981afd4c2f642d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=xezFrVCSMo9aL8OYLLIYVFpZfiM%3D" alt="在这里插入图片描述" loading="lazy"/>
系统提示 应用发布成功，表示智能体已正式上线并可对外调用。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/737c3a7969a347fd86ab546b124af839~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=ciUnkO%2FXWIxOWCbm7e96zSGZSIA%3D" alt="在这里插入图片描述" loading="lazy"/>
可通过分享链接或二维码访问智能体，方便学生、教师或其他用户使用。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc1f2f8e6839477bad609ddc0adee451~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=GXlDFEVmJK%2Fz9rc5zcPeNP%2Fgb%2Fk%3D" alt="在这里插入图片描述" loading="lazy"/>
发布成功后，智能体会在 “我的智能体” 页面中显示，可随时管理、更新或查看运行情况。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/163ee76ebb214d009125973cd2fbbe19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=q2t8ZYj%2BEMdvs0iH9izqqBb30zc%3D" alt="在这里插入图片描述" loading="lazy"/>
访问URL即可愉快的使用智能体了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a361fbd29f24dfd9e7052b893bcec26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=pXkBQtOcFzI4ZS7n0CE%2BGXvrMT8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-21">七.心得与总结</h2>
<p>通过本次“学业成绩分析压力感知型 AI 心理陪伴智能体”的构建，我深刻体会到教育数据智能化与心理关怀结合的巨大价值。项目中，腾讯元器提供了完整的智能体能力编排与上下文管理，TextIn 大模型加速器实现了非结构化成绩单的高精度解析，而混元大模型则承担数据处理、趋势分析与压力感知，实现了从数据到自然语言陪伴的闭环。三者协同不仅让系统能“会算分”，更能“懂学生”，真正做到学业分析与情绪疏导双重服务，为智慧教育场景提供了可落地的实践经验。</p>
<p>在工作流设计和节点调试中，我体会到职责拆分与灵活调用的重要性。将流程拆解为 OCR/结构化、数据处理、压力感知与心理陪伴等明确节点，既利于调试，也便于后续迭代优化；通过代码节点灵活调用 TextIn API，避免了工具节点在大容量或复杂参数传递上的限制。此外，多角色输出逻辑的隔离让学生端与教师端呈现差异化信息，提高了系统可用性与安全性。整体实践让我认识到，教育 AI 不仅要精准分析数据，更要考虑心理关怀与可解释性，这也是未来智能教育落地的关键方向。</p>
<p>这次用腾讯元器构建“学业成绩分析压力感知型 AI 心理陪伴”智能体，整体体验非常顺畅，也超出了预期。几个印象深刻的点：</p>
<ul>
<li>上手快：界面化操作为主，节点拖拽和工作流配置直观，即便非技术人员也能快速上手；</li>
<li>调试高效：代码节点、提示词编辑器和工作流调试器支持实时预览，定位问题快，减少了重复发布的麻烦；</li>
<li>多能力集成：OCR、数据分析、心理陪伴等模块协同，数据流与逻辑清晰，节点之间调用顺畅；</li>
<li>发布便利：支持多端输出，学生端和教师端可差异化呈现，无需自行处理对接问题。</li>
</ul>
<p>总体来说，腾讯元器不仅适合教育场景的智能体开发，也为类似企业级应用提供了可落地、易扩展的实践方案。</p>
<p>腾讯元器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuanqi.tencent.com%2F" target="_blank" title="https://yuanqi.tencent.com/" ref="nofollow noopener noreferrer">yuanqi.tencent.com/</a></p>
<p>我的智能体链接：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuanqi.tencent.com%2Fwebim%2F%23%2Fchat%2FTFJDBz%3Fappid%3D2004433656162151424" target="_blank" title="https://yuanqi.tencent.com/webim/#/chat/TFJDBz?appid=2004433656162151424" ref="nofollow noopener noreferrer">yuanqi.tencent.com/webim/#/cha…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Excel瑟瑟发抖？Skywork Sheets 2.0把表格直接变成了智能报告]]></title>    <link>https://juejin.cn/post/7588086766235648038</link>    <guid>https://juejin.cn/post/7588086766235648038</guid>    <pubDate>2025-12-26T14:28:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766235648038" data-draft-id="7587997893987975195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Excel瑟瑟发抖？Skywork Sheets 2.0把表格直接变成了智能报告"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-26T14:28:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Excel瑟瑟发抖？Skywork Sheets 2.0把表格直接变成了智能报告
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T14:28:24.000Z" title="Fri Dec 26 2025 14:28:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>老实说，在办公软件这个圈子里，我们已经很久没有看到真正让人眼前一亮的东西了。大多数时候，所谓的“AI升级”不过是在侧边栏加个聊天框，这就好比给马车装了个收音机，并没有改变跑得慢的事实。</p>
<p>但昆仑万维刚刚端上来的这个Skywork Sheets 2.0，味道有点不一样。</p>
<p>如果不跟你绕弯子，直接说结论：这东西试图干掉的不是Excel，而是“从做表到写汇报”中间那个最折磨人的过程。它于2025年12月25日正式上线，核心就干了一件事——打破了电子表格和分析报告之间的次元壁。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-26_22.19.36-1024x504.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-26_22.19.36-1024x504.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8c598621c1e472b9420d49b1150fa2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364104&amp;x-signature=XaeQgTi3aDsfA2HM0vPjRGuV%2BNI%3D" alt="iShot_2025-12-26_22.19.36" loading="lazy"/></a></p>
<p><strong>从“仓库”到“加工厂”的思维转变</strong></p>
<p>我们以前用表格软件，本质上是在用一个“数据仓库”。你把数据填进去，甚至还得自己写公式去清洗、去计算，最后盯着那一堆数字发呆：这玩意儿到底说明了什么？然后你还得打开Word或PPT，把刚才的结论敲进去。</p>
<p>Skywork Sheets 2.0把这个逻辑倒过来了。官方管这叫“输入即分析，数据即成果”。</p>
<p>简单来说，它的工作流非常“傻瓜”：</p>
<p>你只需要把那一堆乱七八糟的原始数据——不管是本地的CSV、Excel文件，还是直接从网页上复制粘贴的一坨文本——扔进它的对话框。接下来的事情，就有点像把衣服扔进全自动洗衣机了。</p>
<p>它底层的“天工超级智能体”会立刻接管，利用Deep Research（深度研究）技术，自己去理解这堆数据是干嘛的。清洗脏数据、归纳汇总、识别趋势，这些脏活累活它全包了。</p>
<p><strong>不只是画图，是直接给你交作业</strong></p>
<p>市面上能自动画图的AI不少，但Skywork Sheets 2.0最狠的一点在于它的“双模导出”。</p>
<p>当你喝口水的功夫，它不光给你吐出一份清洗干净、排版整齐、甚至可以像Excel一样随意手动修改的表格，同时还会给你一份图文并茂的分析报告。注意，是完整的报告，支持PDF或Word格式，里面有结论、有趋势分析、有建议。</p>
<p>这就很离谱。以前我们要么得到一个冷冰冰的表格，要么得到一段虚无缥缈的AI废话。现在它直接把这两者捏在一起，形成了一个闭环。</p>
<p><strong>懂行的人才懂的细节优化</strong></p>
<p>作为一个长期被各种“人工智障”折磨的用户，我有两个痛点在这个版本里被治愈了。</p>
<p>第一是“改不动”。以前很多AI生成的表格是一张图片或者死数据，想微调个数值比登天还难。Skywork Sheets 2.0保留了传统表格的尊严，支持你像操作Excel一样去修改单元格、排序筛选。你改了数据，AI还能接着你的思路继续优化，这就很尊重人类的控制欲。</p>
<p>第二是“慢与糙的权衡”。有时候我赶时间，不需要那么深度的分析；有时候我又要写深度研报。它搞了个分档，提供“极速模式”和“深度模式”。极速模式把生成时间砍了一半，适合快速看数；深度模式则会进行多轮意图澄清和深度搜索，适合憋大招。</p>
<p><strong>写在最后</strong></p>
<p>在学术界和投资圈，已经有人喊它是“万能AI员工”了。我觉得这个称呼还算中肯。</p>
<p>Skywork Sheets 2.0并不是一个独立的软件孤岛，它是天工超级智能体生态里的一块拼图。它不再让你盯着屏幕上的网格线发愁，而是试图让你直接面对决策结果。</p>
<p>对于我们这些打工人来说，如果工具能把数据整理、分析、画图、写报告这一条龙服务全干了，那我们要做的，可能真的只剩下“做决定”这一件事了。</p>
<p>这或许才是AI办公该有的样子。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文看懂AI大模型的核心模块：基于强化学习的偏好对齐原理及其应用]]></title>    <link>https://juejin.cn/post/7588031908170792969</link>    <guid>https://juejin.cn/post/7588031908170792969</guid>    <pubDate>2025-12-26T14:33:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588031908170792969" data-draft-id="7588028859540439066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文看懂AI大模型的核心模块：基于强化学习的偏好对齐原理及其应用"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-12-26T14:33:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文看懂AI大模型的核心模块：基于强化学习的偏好对齐原理及其应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T14:33:18.000Z" title="Fri Dec 26 2025 14:33:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>无论是语言模型还是推荐大模型，基于强化学习的偏好对齐已成为其训练流程中不可或缺的关键环节。</p>
<p>本文将系统梳理强化学习在大模型中的实践路径：首先阐明其核心机制与主流算法，继而聚焦语言模型与推荐大模型的典型应用场景，深入解析强化学习如何落地于具体模型的优化过程。</p>
<p><strong>一、强化学习核心思路</strong></p>
<p>强化学习的核心任务在于：为智能体训练一个神经网络，该网络接收当前状态作为输入，输出对下一步动作的预测，以最大化整体期望回报。</p>
<p>以AlphaGo为例，其将棋盘的视觉或网格化表征输入神经网络，输出下一步落子位置的决策，从而提升胜率；当智能体为语言模型时，则将当前问题或对话上下文作为输入，生成能最大程度契合人类偏好与意图的响应。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e5b4c3897ef452b817bc415489c3d99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364398&amp;x-signature=4n3v9CJZoRYVQJZJbmaFKmOqm5I%3D" alt="图片" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<p>为什么上述优化问题无法用普通的有监督学习进行优化？主要源于两个根本性限制。</p>
<p>其一是‌<strong>样本收集机制</strong>‌的差异：在游戏等序列决策场景中，智能体的每一步动作都会改变环境状态，进而影响后续行为与奖励信号的生成；</p>
<p>因此，样本的产生必须依赖一个初始智能体与环境的持续交互，而模型的更新又反过来影响后续样本的分布——样本生成与模型训练形成闭环，这与有监督学习中静态、独立采样的数据集有本质区别。</p>
<p>其二是‌<strong>奖励函数的优化特性</strong>‌：奖励设计通常具有多层次性，既包含单步即时奖励，也涵盖长期累积奖励，且这些奖励往往由规则引擎或复杂模型动态计算得出，不具备可微性；</p>
<p>因此，无法像有监督学习那样通过标签与预测值的直接梯度反传进行端到端优化。</p>
<p><strong>二、强化学习基础算法</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7813ab7e5db40c58c464fac3eb00b3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364398&amp;x-signature=NJY%2FvB4uzBySf8wtDHcfPSLHenQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cfd307f6430428aaaedf7d935b2cdcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364398&amp;x-signature=xw49Nzc6DR2oauVyda%2FAKowCmTU%3D" alt="图片" loading="lazy"/></p>
<p>其核心思路是利用重要性采样，根据新老参数的分布差异对老参数智能体收集的样本进行加权使得该样本在新参数上也能训练。</p>
<p>同时考虑到两个分布差异太大会导致重要性采样误差较大，使用KL散度约束新老参数产出的行为分布不能相差太多，也可以使用clip的方法对两个分布的差异进行clip。</p>
<p><strong>三、大模型中的强化学习应用</strong></p>
<p>在阐明强化学习的基本原理之后，接下来我们将聚焦于其在大语言模型中的具体实践。</p>
<p>首个将强化学习引入大模型训练的开创性工作是 Training language models to follow instructions with human feedback（2022），该研究采用 PPO 算法实现模型输出与人类意图的对齐，从而催生了 InstructGPT。</p>
<p>在此框架中，‌智能体‌即为大语言模型自身；‌环境‌由输入的 prompt（如问题或指令）构成，其目标是引导模型生成响应；</p>
<p>而‌动作‌则对应模型在每个时间步所生成的文本片段，每一个文本token的输出均视为序列决策过程中的一个独立行动。</p>
<p>Reward‌ 的评估依赖于一个独立训练的奖励模型：针对同一 prompt，系统会采样多个模型输出，由人工标注者对这些输出进行排序与偏好标注，进而利用这些带顺序的反馈数据训练出一个能量化评估“prompt+回答”组合质量的奖励函数。</p>
<p>该奖励模型输出的分数，即作为强化学习过程中的信号反馈。这一机制实现了将人类主观的表达偏好直接嵌入模型优化目标，而此类非可微的偏好信号，唯有通过强化学习框架才能有效整合。‌</p>
<p>Value function‌ 则采用与主模型完全一致的架构，其作用是预测在生成每个 token 时，后续序列最终所能获得的累积奖励预期。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7339418fb26144d38140cb23391b871f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364398&amp;x-signature=kO6GMDBlOR1xRKCcM%2F0inzhG2UE%3D" alt="图片" loading="lazy"/></p>
<p>整体的损失函数表示如下，其中第一项是PPO损失，文中将PPO的KL散度约束改成了per-token的，即预训练模型和偏好对齐后的模型每个token的分布不能差异太大。同时也引入了前序非强化学习的预训练loss进行混合训练。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e188ac4ce8646e29afc87db5bf58c44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364398&amp;x-signature=EVC7Ks8h%2Bn6yQKpDa2Exu295OPo%3D" alt="图片" loading="lazy"/></p>
<p>DeepSeekMath: Pushing the Limits of Mathematical Reasoning in Open Language Models（2024）引入了一种更高效的GRPO算法，用以替代传统的PPO方法。</p>
<p>在PPO框架中，为评估每个生成token的未来期望回报，需依赖一个value function作为基准（baseline），该函数通常与策略网络（即大模型本身）共享结构，参数规模庞大，显著推高了计算开销。</p>
<p>GRPO的创新之处在于彻底摒弃了这一value function，转而利用同一问题下多条采样输出的奖励信号，通过计算其均值与方差对当前样本的奖励进行归一化处理，从而实现对baseline功能的等效替代。</p>
<p>二者的核心差异在于：PPO依赖模型自身对奖励期望的预测值作为基准，而GRPO则完全基于采样结果经由奖励模型评分后所得的统计量来构建基准。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f985f10a005042f1a7996d66bb313496~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364398&amp;x-signature=OlKx4DE2%2Fv0qcLo5%2FzuYQhFtMsE%3D" alt="图片" loading="lazy"/></p>
<p>DAPO: An Open-Source LLM Reinforcement Learning System at Scale（2025）针对PPO与GRPO在大规模语言模型训练中的瓶颈，提出了四项关键改进：</p>
<p>PPO的Clip约束优化‌：传统PPO通过重要性采样引入的Clip机制，其上限设定与KL散度类似，旨在控制策略更新时行为分布的偏移。</p>
<p>然而，该机制过度抑制了低概率token的探索，同时难以有效约束高概率token的过度扩张。</p>
<p>为此，DAPO放宽了Clip的上限阈值，以增强探索自由度并平衡策略更新的稳定性。</p>
<p>GRPO采样策略调整‌：在训练后期，大量采样样本的奖励值趋于一致且精确，导致梯度信号冗余、训练效率下降。</p>
<p>DAPO通过增加采样总数，并主动剔除奖励完全一致的重复样本，显著提升了有效梯度的多样性与更新效率。</p>
<p>损失计算粒度重构‌：原方法在sample维度对token损失取平均，致使长序列中单个token的优劣表现被整体平滑掩盖。</p>
<p>DAPO改用token级损失计算，使每个生成token的预测误差独立贡献梯度，从而更精准地引导模型优化。</p>
<p>超长样本加权降权‌：由于token级损失对截断样本更敏感，过长序列被截断后引入的训练不稳定性加剧。</p>
<p>DAPO依据样本超出最大长度的比例动态调整其loss权重：超出比例越高，权重越低，从而在保留长文本信息的同时缓解训练震荡。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40ab6dded1a245269cea09320924da42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364398&amp;x-signature=WgKQ56UbaJSkx2VxEF8bfP4gXYA%3D" alt="图片" loading="lazy"/></p>
<p>除了上述标准强化学习方法外，有的模型也利用其他方法模拟强化学习的偏好对齐能力。</p>
<p>例如Direct Preference Optimization: Your Language Model is Secretly a Reward Model（2024）论文中提出的DPO方法。</p>
<p>基于人工标注的最好的样本和最差的样本构建pair-wise样本，让模型预测好样本概率大于差样本，绕过了强化学习，Qwen模型中也使用该方法进行偏好对齐。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe631ab015c54a1baae4318fc4da2e5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364398&amp;x-signature=yIINHVEDHXeROBFYh6kj19S%2BKDg%3D" alt="图片" loading="lazy"/></p>
<p><strong>四、推荐大模型中的强化学习应用</strong></p>
<p>在推荐大模型的框架中，强化学习方法的运用基本继承自语言大模型的主流范式，其关键区别体现在 reward 的定义方式上：在推荐系统中，通常依据用户日志行为（如播放时长、点击率等）来衡量用户对推荐内容的偏好程度。</p>
<p>在 Onerec 的第一版实现中，reward model 的训练方式借鉴了精排模型的结构，将多个核心目标（如有效播放、点击率等）统一建模为 reward 信号。</p>
<p>针对单个用户的一次 session 请求，系统通过 beam search 生成若干候选推荐序列，随后利用精排模型为每个序列计算综合 reward 分数，并从中选取 reward 值最高与最低的两个样本构成正负配对，最终基于 DPO 损失函数完成模型优化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e91319caf3a447db058d7120db480b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364398&amp;x-signature=6jnpxAQwXUY4%2FXgUyKNlTyFuBPs%3D" alt="图片" loading="lazy"/></p>
<p>在 Onerec V2 中，同样引入了强化学习以实现推荐大模型的偏好对齐。其 reward 设计更为简洁，完全依赖人工设定 reward 值：</p>
<p>将用户观看的视频按市场维度分组，若某视频的观看时长位于该分组内该用户历史观看时长的前 25% 区间，则 reward 设为 1；</p>
<p>若用户对视频执行了显式负反馈操作，则 reward 置为 0。这一机制将 PPO 算法中 value function 与 baseline 的比较功能，直接嵌入至人工 reward 的构建环节。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7acb8d05d7714173833db2fbc98ed7da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364398&amp;x-signature=N4leZM%2FMm4ycbre%2FOMw%2Fnm%2BNwm0%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13b0030cd2794450a07617123f54f839~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364398&amp;x-signature=K6eA9N8evyR%2FOe1uVOWzOsCgrE0%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/718bf1a8cc0a4cc2a9e0d09e009c69fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364398&amp;x-signature=jLUMn%2FH0JK08Go8g59%2BoKY6SdwE%3D" alt="图片" loading="lazy"/></p>
<p>在RecGPTV2中，也采用了强化学习的方法对RecGPTV1进行偏好对齐。RecGPTV2采用GRPO进行优化，主要差异是在reward的设计上。</p>
<p>在每个Expert的训练上，reward综合考虑了item tag预测的准确率、基于用户偏好对训练的奖励模型的打分、生成结果的多样性（每个tag映射成表征计算两两cosine距离的均值）等。</p>
<p>可以看到在推荐大模型领域，reward的设计会更加复杂，需要综合考虑用户偏好、多样性、负反馈等各种信息。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d72da7c9afc4dac9b0146e6820b880a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364398&amp;x-signature=UgPgtNQ5JZDKasUXynW3xFPxo74%3D" alt="图片" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[0成本搭建！20分钟用 Workers AI + Vectorize 搞定 RAG（附全套源码）]]></title>    <link>https://juejin.cn/post/7588031908170809353</link>    <guid>https://juejin.cn/post/7588031908170809353</guid>    <pubDate>2025-12-26T14:41:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588031908170809353" data-draft-id="7588086766235664422" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="0成本搭建！20分钟用 Workers AI + Vectorize 搞定 RAG（附全套源码）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T14:41:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="技术更好说"/> <meta itemprop="url" content="https://juejin.cn/user/2735240657517816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            0成本搭建！20分钟用 Workers AI + Vectorize 搞定 RAG（附全套源码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2735240657517816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    技术更好说
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T14:41:00.000Z" title="Fri Dec 26 2025 14:41:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcca2fefd92b480683c9f3e1980e3726~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5pu05aW96K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364860&amp;x-signature=K288NHCQ4XYLlp2vowap6R9WTL0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p>想给公司做个智能客服，查了一圈 RAG 教程，要么讲理论云里雾里，要么让你先租个 GPU、搭环境，看着就头大。说实话，我刚开始研究这块的时候也一样，光是配置 LangChain 和向量数据库就折腾了两天，还没跑起来。
后来发现 Cloudflare 推出了一整套 AI 工具，Workers AI + Vectorize + D1，全托管的,免费额度还挺大方。我试着用它们搭了个笔记问答应用，从零到能用真的不到 20 分钟，代码也就百来行。
这篇文章会手把手带你走一遍完整流程：</p>
<ul>
<li><strong>先讲清楚</strong> RAG 到底是什么（不扔术语，用大白话）</li>
<li><strong>实战搭建</strong>一个能跑的知识库问答应用（有完整代码）</li>
<li><strong>优化技巧</strong>让检索更准确、成本更低</li>
<li><strong>部署上线</strong>真正用起来
你只需要懂点 JavaScript，有个 Cloudflare 账号（免费），跟着操作就能做出来。</li>
</ul>
<h2 data-id="heading-1">RAG 是个啥？5 分钟看懂工作原理</h2>
<h3 data-id="heading-2">用考试来理解 RAG</h3>
<p>先说个直观的比喻。你考试的时候，闭卷考试只能靠脑子里记的东西答题，万一忘了就瞎编。开卷考试就不一样了，不确定的时候翻书查资料，答案准确多了。
RAG（检索增强生成）就是给 AI 开卷考试的权限。
传统 LLM 就像闭卷考试，只能基于训练时见过的数据回答。问题是：</p>
<ul>
<li>训练数据有时效性，不知道最新动态</li>
<li>没见过你公司的内部文档</li>
<li>记不住所有细节，容易瞎编（行话叫"幻觉"）
RAG 的做法是：先从你准备好的知识库里找相关资料，然后把资料给 AI，让它基于这些内容回答。这样答案既靠谱又能结合最新信息。</li>
</ul>
<h3 data-id="heading-3">RAG 的三个核心步骤</h3>
<p>&lt;StatsGrid stats={[
{ value: "第1步", label: "文档转向量存储", description: "将知识转成数字表示" },
{ value: "第2步", label: "检索相似内容", description: "找到语义最相关的片段" },
{ value: "第3步", label: "LLM生成答案", description: "基于检索结果回答" }
]} columns={3} /&gt;</p>
<p>整个流程其实就三步：</p>
<p><strong>第一步：把知识变成向量存起来</strong>
你有一堆文档对吧？RAG 会把每段文字转成一串数字（专业术语叫"向量"或"Embedding"），这串数字代表了文字的语义。
打个比方，"猫很可爱"和"小猫萌萌的"虽然用词不同,但意思接近,转成向量后这两串数字也会很接近。这些向量会存到 Vectorize 这样的向量数据库里。</p>
<p><strong>第二步：用户提问时,找出最相关的知识片段</strong>
用户问"怎么训练猫咪"的时候，系统会先把这个问题也转成向量,然后在数据库里找"距离最近"的那几段内容——也就是语义最相关的知识。
这个过程叫"相似度搜索"，速度很快，几毫秒就能从几万条数据里找出最匹配的 3-5 条。</p>
<p><strong>第三步：把检索到的内容喂给 LLM 生成答案</strong>
找到相关内容后，组装成一个 Prompt 发给 AI：</p>
<pre><code class="hljs language-css" lang="css">以下是相关资料：
<span class="hljs-selector-attr">[检索到的内容1]</span>
<span class="hljs-selector-attr">[检索到的内容2]</span>
...
用户问题：怎么训练猫咪？
请基于上述资料回答。
</code></pre>
<p>AI 看到这些"参考资料"，就能给出准确且有依据的答案了。</p>
<h3 data-id="heading-4">为什么选 Cloudflare 全家桶？</h3>
<p>市面上做 RAG 的方案挺多，LangChain、LlamaIndex 啥的都行,但要自己配环境、挑向量数据库、管 GPU 资源,折腾起来挺累的。</p>
<p>Cloudflare 这套方案的优势是：</p>
<p><strong>Workers AI</strong> - 内置十几个开源模型（Llama 3、Claude 等），调 API 就能用，不用租 GPU。免费层每天有固定的 Neurons 额度（计量单位），个人项目够用了。</p>
<p><strong>Vectorize</strong> - 托管的向量数据库，不用自己搭 Milvus、Pinecone 那些。创建索引、插入向量、相似度搜索，几行代码搞定。</p>
<p><strong>D1</strong> - Cloudflare 的 SQLite 数据库,存原始文本用。向量数据库只存向量,具体文字内容还是要从这里取。</p>
<p><strong>全托管</strong> - 这是最爽的地方。不用操心服务器、扩容、备份这些破事,专心写代码就行。而且 Cloudflare 的边缘网络,全球访问都快。</p>
<p/>
<p>2025 年 Cloudflare 还推出了 AutoRAG，进一步简化了流程——上传文档到 R2，后面的切分、向量化、检索、生成全自动。不过这篇文章咱们还是手动搭一遍，这样能学到底层原理。
说了这么多理论，接下来动手做一个。</p>
<h2 data-id="heading-5">动手实战 - 搭建你的第一个 RAG 应用</h2>
<p>咱们做个笔记问答应用：用户可以添加笔记，然后提问，系统从所有笔记里找相关内容回答。</p>
<h3 data-id="heading-6">项目初始化和环境准备</h3>
<p>先装 Wrangler（Cloudflare 的 CLI 工具）：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g wrangler
wrangler login  <span class="hljs-comment"># 登录你的 Cloudflare 账号</span>
</code></pre>
<p>创建项目：</p>
<pre><code class="hljs language-bash" lang="bash">npm create cloudflare@latest rag-notes-app
<span class="hljs-comment"># 选择 "Hello World" worker</span>
<span class="hljs-comment"># 选择 TypeScript</span>
<span class="hljs-built_in">cd</span> rag-notes-app
</code></pre>
<p>装个路由库 Hono（比原生 Workers API 好用）：</p>
<pre><code class="hljs language-bash" lang="bash">npm install hono
</code></pre>
<p>创建 D1 数据库和 Vectorize 索引：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建 D1 数据库存原始笔记</span>
wrangler d1 create notes-db
<span class="hljs-comment"># 创建 Vectorize 索引（768 维，配合 bge-base-en-v1.5 模型）</span>
wrangler vectorize create notes-index --dimensions=768 --metric=cosine
</code></pre>
<p>然后配置 <code>wrangler.jsonc</code>（或 <code>wrangler.toml</code>）：</p>
<pre><code class="hljs language-jsonc" lang="jsonc">{
  "name": "rag-notes-app",
  "main": "src/index.ts",
  "compatibility_date": "2024-01-01",
  "node_compat": true,
  // AI 绑定
  "ai": {
    "binding": "AI"
  },
  // D1 数据库绑定
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "notes-db",
      "database_id": "你的数据库ID"  // 从上面创建命令的输出复制
    }
  ],
  // Vectorize 索引绑定
  "vectorize": [
    {
      "binding": "VECTORIZE",
      "index_name": "notes-index"
    }
  ],
  // Workflow 绑定（处理异步向量化任务）
  "workflows": [
    {
      "binding": "RAG_WORKFLOW",
      "name": "rag-workflow",
      "class_name": "RAGWorkflow"
    }
  ]
}
</code></pre>
<p>初始化数据库表：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- schema.sql</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> notes (
  id <span class="hljs-type">INTEGER</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTOINCREMENT,
  text TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  created_at DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);
</code></pre>
<p>运行：</p>
<pre><code class="hljs language-bash" lang="bash">wrangler d1 execute notes-db --file=./schema.sql
</code></pre>
<h3 data-id="heading-7">实现知识库录入功能</h3>
<p>这是整个 RAG 的核心——把用户的笔记转成向量存起来。
创建 <code>src/workflow.ts</code>（Workflow 处理异步任务）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WorkflowEntrypoint</span>, <span class="hljs-title class_">WorkflowStep</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'cloudflare:workers'</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Env</span> = {
  <span class="hljs-attr">AI</span>: <span class="hljs-title class_">Ai</span>;
  <span class="hljs-attr">DB</span>: D1Database;
  <span class="hljs-attr">VECTORIZE</span>: <span class="hljs-title class_">VectorizeIndex</span>;
};
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Params</span> = {
  <span class="hljs-attr">noteId</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>;
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RAGWorkflow</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">WorkflowEntrypoint</span>&lt;<span class="hljs-title class_">Env</span>, <span class="hljs-title class_">Params</span>&gt; {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">event: WorkflowEvent&lt;Params&gt;, step: WorkflowStep</span>) {
    <span class="hljs-keyword">const</span> { noteId, text } = event.<span class="hljs-property">payload</span>;
    <span class="hljs-comment">// 步骤1：确认 D1 记录已创建（由主路由完成）</span>
    <span class="hljs-comment">// 步骤2：生成向量</span>
    <span class="hljs-keyword">const</span> embeddings = <span class="hljs-keyword">await</span> step.<span class="hljs-title function_">do</span>(<span class="hljs-string">'generate embeddings'</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">env</span>.<span class="hljs-property">AI</span>.<span class="hljs-title function_">run</span>(
        <span class="hljs-string">'@cf/baai/bge-base-en-v1.5'</span>,  <span class="hljs-comment">// 768维的 Embedding 模型</span>
        { <span class="hljs-attr">text</span>: [text] }
      );
      <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>[<span class="hljs-number">0</span>];  <span class="hljs-comment">// 返回向量数组</span>
    });
    <span class="hljs-comment">// 步骤3：插入 Vectorize</span>
    <span class="hljs-keyword">await</span> step.<span class="hljs-title function_">do</span>(<span class="hljs-string">'insert vector'</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VECTORIZE</span>.<span class="hljs-title function_">insert</span>([
        {
          <span class="hljs-attr">id</span>: noteId.<span class="hljs-title function_">toString</span>(),
          <span class="hljs-attr">values</span>: embeddings,
          <span class="hljs-attr">metadata</span>: { text }  <span class="hljs-comment">// 存一份文本方便调试</span>
        }
      ]);
    });
  }
}
</code></pre>
<p>主路由 <code>src/index.ts</code>（处理添加笔记）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Hono</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'hono'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RAGWorkflow</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./workflow'</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Bindings</span> = {
  <span class="hljs-attr">AI</span>: <span class="hljs-title class_">Ai</span>;
  <span class="hljs-attr">DB</span>: D1Database;
  <span class="hljs-attr">VECTORIZE</span>: <span class="hljs-title class_">VectorizeIndex</span>;
  <span class="hljs-attr">RAG_WORKFLOW</span>: <span class="hljs-title class_">Workflow</span>;
};
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hono</span>&lt;{ <span class="hljs-title class_">Bindings</span>: <span class="hljs-title class_">Bindings</span> }&gt;();
<span class="hljs-comment">// 添加笔记</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/notes'</span>, <span class="hljs-keyword">async</span> (c) =&gt; {
  <span class="hljs-keyword">const</span> { text } = <span class="hljs-keyword">await</span> c.<span class="hljs-property">req</span>.<span class="hljs-property">json</span>&lt;{ <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> }&gt;();
  <span class="hljs-keyword">if</span> (!text?.<span class="hljs-title function_">trim</span>()) {
    <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Text is required'</span> }, <span class="hljs-number">400</span>);
  }
  <span class="hljs-comment">// 插入 D1</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> c.<span class="hljs-property">env</span>.<span class="hljs-property">DB</span>.<span class="hljs-title function_">prepare</span>(
    <span class="hljs-string">'INSERT INTO notes (text) VALUES (?) RETURNING id'</span>
  ).<span class="hljs-title function_">bind</span>(text).<span class="hljs-property">first</span>&lt;{ <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> }&gt;();
  <span class="hljs-keyword">if</span> (!result) {
    <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Failed to create note'</span> }, <span class="hljs-number">500</span>);
  }
  <span class="hljs-comment">// 触发 Workflow 异步生成向量</span>
  <span class="hljs-keyword">await</span> c.<span class="hljs-property">env</span>.<span class="hljs-property">RAG_WORKFLOW</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">params</span>: { <span class="hljs-attr">noteId</span>: result.<span class="hljs-property">id</span>, text }
  });
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({
    <span class="hljs-attr">id</span>: result.<span class="hljs-property">id</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'Note created, vectorization in progress'</span>
  });
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> app;
<span class="hljs-keyword">export</span> { <span class="hljs-title class_">RAGWorkflow</span> };
</code></pre>
<p>这样一来，用户发 POST 请求添加笔记时：</p>
<ol>
<li>文本立即存到 D1</li>
<li>后台 Workflow 慢慢生成向量、插入 Vectorize</li>
<li>就算向量化要几秒钟，也不会阻塞用户请求</li>
</ol>
<h3 data-id="heading-8">实现智能问答功能</h3>
<p>现在可以存笔记了，接下来做查询。
在 <code>src/index.ts</code> 添加：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 查询问答</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-keyword">async</span> (c) =&gt; {
  <span class="hljs-keyword">const</span> query = c.<span class="hljs-property">req</span>.<span class="hljs-title function_">query</span>(<span class="hljs-string">'q'</span>);
  <span class="hljs-keyword">if</span> (!query) {
    <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Query parameter "q" is required'</span> }, <span class="hljs-number">400</span>);
  }
  <span class="hljs-comment">// 第一步：把问题转成向量</span>
  <span class="hljs-keyword">const</span> queryEmbedding = <span class="hljs-keyword">await</span> c.<span class="hljs-property">env</span>.<span class="hljs-property">AI</span>.<span class="hljs-title function_">run</span>(
    <span class="hljs-string">'@cf/baai/bge-base-en-v1.5'</span>,
    { <span class="hljs-attr">text</span>: [query] }
  );
  <span class="hljs-comment">// 第二步：在 Vectorize 里找最相似的 3 条笔记</span>
  <span class="hljs-keyword">const</span> matches = <span class="hljs-keyword">await</span> c.<span class="hljs-property">env</span>.<span class="hljs-property">VECTORIZE</span>.<span class="hljs-title function_">query</span>(
    queryEmbedding.<span class="hljs-property">data</span>[<span class="hljs-number">0</span>],
    { <span class="hljs-attr">topK</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">returnMetadata</span>: <span class="hljs-literal">true</span> }
  );
  <span class="hljs-keyword">if</span> (matches.<span class="hljs-property">count</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">answer</span>: <span class="hljs-string">'没有找到相关笔记'</span> });
  }
  <span class="hljs-comment">// 第三步：从 D1 获取完整文本（如果需要）</span>
  <span class="hljs-keyword">const</span> noteIds = matches.<span class="hljs-property">matches</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">id</span>);
  <span class="hljs-keyword">const</span> notes = <span class="hljs-keyword">await</span> c.<span class="hljs-property">env</span>.<span class="hljs-property">DB</span>.<span class="hljs-title function_">prepare</span>(
    <span class="hljs-string">`SELECT text FROM notes WHERE id IN (<span class="hljs-subst">${noteIds.map(() =&gt; <span class="hljs-string">'?'</span>).join(<span class="hljs-string">','</span>)}</span>)`</span>
  ).<span class="hljs-title function_">bind</span>(...noteIds).<span class="hljs-title function_">all</span>();
  <span class="hljs-comment">// 第四步：构造 Prompt，调用 LLM 生成答案</span>
  <span class="hljs-keyword">const</span> context = notes.<span class="hljs-property">results</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">n: <span class="hljs-built_in">any</span></span>) =&gt;</span> n.<span class="hljs-property">text</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n\n---\n\n'</span>);
  <span class="hljs-keyword">const</span> prompt = <span class="hljs-string">`以下是相关的笔记内容：
<span class="hljs-subst">${context}</span>
用户问题：<span class="hljs-subst">${query}</span>
请基于上述笔记内容回答用户问题。如果笔记中没有相关信息，请说明。`</span>;
  <span class="hljs-keyword">const</span> aiResponse = <span class="hljs-keyword">await</span> c.<span class="hljs-property">env</span>.<span class="hljs-property">AI</span>.<span class="hljs-title function_">run</span>(
    <span class="hljs-string">'@cf/meta/llama-3-8b-instruct'</span>,  <span class="hljs-comment">// 或者用 claude-3-5-sonnet-latest</span>
    {
      <span class="hljs-attr">messages</span>: [
        { <span class="hljs-attr">role</span>: <span class="hljs-string">'system'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'你是一个智能笔记助手'</span> },
        { <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: prompt }
      ]
    }
  );
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({
    <span class="hljs-attr">answer</span>: aiResponse.<span class="hljs-property">response</span>,
    <span class="hljs-attr">sources</span>: matches.<span class="hljs-property">matches</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> ({
      <span class="hljs-attr">id</span>: m.<span class="hljs-property">id</span>,
      <span class="hljs-attr">score</span>: m.<span class="hljs-property">score</span>,
      <span class="hljs-attr">text</span>: m.<span class="hljs-property">metadata</span>?.<span class="hljs-property">text</span>
    }))
  });
});
</code></pre>
<p>测试一下：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 本地运行</span>
wrangler dev
<span class="hljs-comment"># 添加笔记</span>
curl -X POST http://localhost:8787/notes \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"text": "Cloudflare Workers AI 支持 Llama 3 和 Claude 模型"}'</span>
curl -X POST http://localhost:8787/notes \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"text": "Vectorize 使用余弦相似度进行向量检索"}'</span>
<span class="hljs-comment"># 等几秒让 Workflow 完成向量化</span>
<span class="hljs-comment"># 提问</span>
curl <span class="hljs-string">"http://localhost:8787/?q=Workers%20AI%20有哪些模型"</span>
</code></pre>
<p>如果一切正常，你会收到基于笔记内容的回答。</p>
<h3 data-id="heading-9">删除和更新功能</h3>
<p>删除笔记时，记得同时删除 D1 和 Vectorize 的数据：</p>
<pre><code class="hljs language-typescript" lang="typescript">app.<span class="hljs-title function_">delete</span>(<span class="hljs-string">'/notes/:id'</span>, <span class="hljs-keyword">async</span> (c) =&gt; {
  <span class="hljs-keyword">const</span> id = c.<span class="hljs-property">req</span>.<span class="hljs-title function_">param</span>(<span class="hljs-string">'id'</span>);
  <span class="hljs-comment">// 从 D1 删除</span>
  <span class="hljs-keyword">await</span> c.<span class="hljs-property">env</span>.<span class="hljs-property">DB</span>.<span class="hljs-title function_">prepare</span>(<span class="hljs-string">'DELETE FROM notes WHERE id = ?'</span>).<span class="hljs-title function_">bind</span>(id).<span class="hljs-title function_">run</span>();
  <span class="hljs-comment">// 从 Vectorize 删除</span>
  <span class="hljs-keyword">await</span> c.<span class="hljs-property">env</span>.<span class="hljs-property">VECTORIZE</span>.<span class="hljs-title function_">deleteByIds</span>([id]);
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Note deleted'</span> });
});
</code></pre>
<p>更新的话，最简单的方式是先删后加（重新生成向量）。
完整代码可以参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcloudflare%2Fworkers-sdk%2Ftree%2Fmain%2Ftemplates%2Fworker-ai-rag" target="_blank" title="https://github.com/cloudflare/workers-sdk/tree/main/templates/worker-ai-rag" ref="nofollow noopener noreferrer">Cloudflare 官方示例</a>。</p>
<h2 data-id="heading-10">进阶优化 - 让你的 RAG 更聪明</h2>
<p>基础功能跑起来了，但要真正用在实际项目里，还有些细节值得优化。</p>
<h3 data-id="heading-11">文本分块策略</h3>
<p>现在咱们是把整条笔记当一个单元存的。如果笔记很长（比如一篇技术文档），这样做会有问题：</p>
<ol>
<li>检索时整篇文档的相似度可能不高（只有部分段落相关）</li>
<li>Prompt 太长会超出 LLM 的上下文窗口限制
更好的做法是<strong>把长文本切成小块</strong>（chunk），每块单独生成向量。
简单的分块方法：</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">splitText</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span>, chunkSize: <span class="hljs-built_in">number</span> = <span class="hljs-number">500</span>, overlap: <span class="hljs-built_in">number</span> = <span class="hljs-number">50</span></span>): <span class="hljs-built_in">string</span>[] {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">chunks</span>: <span class="hljs-built_in">string</span>[] = [];
  <span class="hljs-keyword">let</span> start = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span> (start &lt; text.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(start + chunkSize, text.<span class="hljs-property">length</span>);
    chunks.<span class="hljs-title function_">push</span>(text.<span class="hljs-title function_">slice</span>(start, end));
    start = end - overlap;  <span class="hljs-comment">// 重叠一点，避免句子被切断</span>
  }
  <span class="hljs-keyword">return</span> chunks;
}
</code></pre>
<p>更智能的方式是按段落或语义分割（可以用 LangChain 的 <code>RecursiveCharacterTextSplitter</code>），不过对大部分场景来说，固定长度+重叠已经够用了。
修改 Workflow，给每个 chunk 分配唯一 ID：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> chunks = <span class="hljs-title function_">splitText</span>(text);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; chunks.<span class="hljs-property">length</span>; i++) {
  <span class="hljs-keyword">const</span> chunkId = <span class="hljs-string">`<span class="hljs-subst">${noteId}</span>-<span class="hljs-subst">${i}</span>`</span>;
  <span class="hljs-keyword">const</span> embeddings = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">env</span>.<span class="hljs-property">AI</span>.<span class="hljs-title function_">run</span>(<span class="hljs-string">'@cf/baai/bge-base-en-v1.5'</span>, {
    <span class="hljs-attr">text</span>: [chunks[i]]
  });
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VECTORIZE</span>.<span class="hljs-title function_">insert</span>([{
    <span class="hljs-attr">id</span>: chunkId,
    <span class="hljs-attr">values</span>: embeddings.<span class="hljs-property">data</span>[<span class="hljs-number">0</span>],
    <span class="hljs-attr">metadata</span>: { noteId, <span class="hljs-attr">chunkIndex</span>: i, <span class="hljs-attr">text</span>: chunks[i] }
  }]);
}
</code></pre>
<h3 data-id="heading-12">提升检索准确度</h3>
<p><strong>调整 topK 和相似度阈值</strong>
默认返回 top 3 可能不够，也可能太多。试试调到 5 条，同时过滤掉相似度太低的：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> matches = <span class="hljs-keyword">await</span> c.<span class="hljs-property">env</span>.<span class="hljs-property">VECTORIZE</span>.<span class="hljs-title function_">query</span>(queryEmbedding.<span class="hljs-property">data</span>[<span class="hljs-number">0</span>], {
  <span class="hljs-attr">topK</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">returnMetadata</span>: <span class="hljs-literal">true</span>
});
<span class="hljs-comment">// 只保留相似度 &gt; 0.7 的结果</span>
<span class="hljs-keyword">const</span> relevantMatches = matches.<span class="hljs-property">matches</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">score</span> &gt; <span class="hljs-number">0.7</span>);
</code></pre>
<p>相似度分数范围是 0-1（余弦相似度），0.7 以上一般算比较相关。
<strong>优化 Prompt</strong>
别光把检索到的内容扔给 AI，告诉它怎么用这些信息：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> prompt = <span class="hljs-string">`你是一个智能笔记助手。以下是从笔记库中检索到的相关内容（按相关性排序）：
<span class="hljs-subst">${context}</span>
请严格基于上述内容回答用户问题。如果内容不足以回答问题，明确说明"笔记中没有找到相关信息"，不要编造答案。
用户问题：<span class="hljs-subst">${query}</span>`</span>;
</code></pre>
<p>关键点：</p>
<ul>
<li>明确告诉 AI 这是检索到的资料</li>
<li>要求它只基于这些内容回答</li>
<li>允许它承认"不知道"
这样能减少 AI 瞎编的情况。</li>
</ul>
<h3 data-id="heading-13">成本控制和限流</h3>
<p>Workers AI 免费层每天有 Neurons 额度限制（具体数值会变，去 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.cloudflare.com%2Fworkers-ai%2Fplatform%2Fpricing%2F" target="_blank" title="https://developers.cloudflare.com/workers-ai/platform/pricing/" ref="nofollow noopener noreferrer">Pricing 页面</a> 查最新的）。</p>
<p><strong>监控用量</strong>：
在 Cloudflare Dashboard → Workers AI 里能看到每日消耗。不同模型消耗不同，Embedding 模型便宜，LLM 生成贵一些。</p>
<p><strong>降级策略</strong>：
如果担心超额，可以：</p>
<ol>
<li>限制每个用户的请求频率（用 KV 或 Durable Objects 计数）</li>
<li>超出额度后改用更小的模型或返回缓存结果</li>
<li>对于非关键请求，直接返回检索到的原文，不调 LLM</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 简单限流示例</span>
<span class="hljs-keyword">const</span> userKey = c.<span class="hljs-property">req</span>.<span class="hljs-title function_">header</span>(<span class="hljs-string">'X-User-ID'</span>) || <span class="hljs-string">'anonymous'</span>;
<span class="hljs-keyword">const</span> requestCount = <span class="hljs-keyword">await</span> c.<span class="hljs-property">env</span>.<span class="hljs-property">KV</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">`rate:<span class="hljs-subst">${userKey}</span>`</span>) || <span class="hljs-number">0</span>;
<span class="hljs-keyword">if</span> (requestCount &gt; <span class="hljs-number">100</span>) {
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Rate limit exceeded'</span> }, <span class="hljs-number">429</span>);
}
<span class="hljs-keyword">await</span> c.<span class="hljs-property">env</span>.<span class="hljs-property">KV</span>.<span class="hljs-title function_">put</span>(<span class="hljs-string">`rate:<span class="hljs-subst">${userKey}</span>`</span>, requestCount + <span class="hljs-number">1</span>, { <span class="hljs-attr">expirationTtl</span>: <span class="hljs-number">86400</span> });
</code></pre>
<h3 data-id="heading-14">切换更强的模型</h3>
<p>Llama 3 8B 已经挺不错了，但如果想要更好的理解能力，可以试试 Claude：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 需要先在 Dashboard 绑定 Anthropic API key</span>
<span class="hljs-keyword">const</span> aiResponse = <span class="hljs-keyword">await</span> c.<span class="hljs-property">env</span>.<span class="hljs-property">AI</span>.<span class="hljs-title function_">run</span>(<span class="hljs-string">'claude-3-5-sonnet-latest'</span>, {
  <span class="hljs-attr">messages</span>: [
    { <span class="hljs-attr">role</span>: <span class="hljs-string">'system'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'你是一个智能笔记助手'</span> },
    { <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: prompt }
  ]
});
</code></pre>
<p>Claude 的理解能力和输出质量确实更好，但消耗的 Neurons 也更多。根据实际需求选吧。
我自己的经验是：</p>
<ul>
<li><strong>简单问答</strong>：Llama 3 够用</li>
<li><strong>需要推理、总结</strong>：Claude 明显好一些</li>
<li><strong>预算有限</strong>：先用 Llama 测试，确定需求后再升级</li>
</ul>
<h2 data-id="heading-15">部署上线和实际应用场景</h2>
<h3 data-id="heading-16">部署流程</h3>
<p>本地测试没问题后，部署超简单：</p>
<pre><code class="hljs language-bash" lang="bash">wrangler deploy
</code></pre>
<p>就这一行，Cloudflare 会自动：</p>
<ul>
<li>打包你的代码</li>
<li>部署到全球边缘节点</li>
<li>生成一个 <code>.workers.dev</code> 域名
你会看到类似这样的输出：</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino">Published rag-notes-app
  https:<span class="hljs-comment">//rag-notes-app.your-account.workers.dev</span>
</code></pre>
<p>这就是你的 API 地址了。</p>
<p><strong>绑定自定义域名</strong>（可选）：
如果你有域名托管在 Cloudflare，可以绑定：</p>
<pre><code class="hljs language-bash" lang="bash">wrangler domains add api.yourdomain.com
</code></pre>
<p>或者在 Dashboard → Workers &amp; Pages → 你的 Worker → Settings → Domains 里添加。</p>
<p><strong>环境变量和 Secrets</strong>：
如果你用了 Anthropic API key 或其他敏感信息：</p>
<pre><code class="hljs language-bash" lang="bash">wrangler secret put ANTHROPIC_API_KEY
<span class="hljs-comment"># 输入你的 key</span>
</code></pre>
<p>代码里这样用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> apiKey = c.<span class="hljs-property">env</span>.<span class="hljs-property">ANTHROPIC_API_KEY</span>;
</code></pre>
<h3 data-id="heading-17">真实应用场景</h3>
<p>这套 RAG 架构能做的事挺多，分享几个实际场景：</p>
<p><strong>1. 企业知识库问答</strong></p>
<p>场景：公司有几百页员工手册、技术文档、FAQ，新员工找资料很麻烦。
做法：</p>
<ul>
<li>把所有文档上传，按章节分块存入 Vectorize</li>
<li>做个简单的 Web 界面或接入企业微信机器人</li>
<li>员工直接问"报销流程是什么"，系统自动检索相关章节回答
好处：24 小时在线，比翻文档快多了。</li>
</ul>
<p><strong>2. 智能客服</strong></p>
<p>场景：电商网站有大量商品信息和售后政策，客服重复回答相同问题。
做法：</p>
<ul>
<li>把常见问题、商品描述、退换货政策存进去</li>
<li>用户咨询时先让 RAG 系统回答</li>
<li>答不上来的再转人工
效果：某个开发者用这套方案，把客服压力减少了 60%+。</li>
</ul>
<p><strong>3. 个人笔记助手</strong></p>
<p>场景：你用 Notion 或 Obsidian 记了几年笔记，想快速找到某个知识点。
做法：</p>
<ul>
<li>定期把笔记导出，通过 API 添加到 RAG 系统</li>
<li>需要时直接问"上次看的那个 TypeScript 技巧是啥来着"</li>
<li>系统检索出相关笔记片段
我自己就在用类似的工具，找资料效率真的提升了不少。</li>
</ul>
<p><strong>4. "Chat with PDF" 工具</strong></p>
<p>场景：用户上传一份 PDF（论文、合同、报告），想快速提取信息。
做法（参考 Rohit Patil 的<a href="https://link.juejin.cn?target=https%3A%2F%2Frohitpatil.com%2Fblog%2Fai-rag-with-vectorize.html" target="_blank" title="https://rohitpatil.com/blog/ai-rag-with-vectorize.html" ref="nofollow noopener noreferrer">案例</a>）：</p>
<ul>
<li>用户上传 PDF 到 R2</li>
<li>Worker 读取 PDF，提取文本，分块向量化</li>
<li>用户可以问"这份合同的付款条款是什么"
这个场景特别实用，很多法律、咨询行业的人需要。</li>
</ul>
<p>&lt;StatsGrid stats={[
{ value: "24小时", label: "企业知识库在线" },
{ value: "60%+", label: "智能客服压力减少" },
{ value: "10倍", label: "个人笔记检索效率提升" }
]} source="实际应用案例数据" /&gt;</p>
<h3 data-id="heading-18">常见问题排查</h3>
<p><strong>问题1：向量维度不匹配</strong></p>
<p>错误：<code>dimension mismatch: expected 768, got 512</code>
原因：Vectorize 索引创建时设的维度（768）和模型输出的维度不一致。
解决：确保索引维度和模型匹配。<code>bge-base-en-v1.5</code> 是 768 维，别用错模型。</p>
<p><strong>问题2：D1 和 Vectorize 数据不一致</strong></p>
<p>现象：查询返回的 note ID 在 D1 里不存在。
原因：可能删除 D1 记录时忘了删 Vectorize，或者 Workflow 失败了。
解决：删除操作要么包在事务里，要么用 Workflow 确保两边都删干净。</p>
<p><strong>问题3：Workflow 超时</strong></p>
<p>错误：workflow execution timeout
原因：向量化大量文本时超过 Workflow 的时间限制。
解决：把大文档拆成多个 Workflow 任务，或者批量处理。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 分批处理</span>
<span class="hljs-keyword">const</span> batchSize = <span class="hljs-number">10</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; chunks.<span class="hljs-property">length</span>; i += batchSize) {
  <span class="hljs-keyword">const</span> batch = chunks.<span class="hljs-title function_">slice</span>(i, i + batchSize);
  <span class="hljs-keyword">await</span> c.<span class="hljs-property">env</span>.<span class="hljs-property">RAG_WORKFLOW</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">params</span>: { noteId, <span class="hljs-attr">chunks</span>: batch, <span class="hljs-attr">offset</span>: i }
  });
}
</code></pre>
<h2 data-id="heading-19">结论</h2>
<p>说了这么多，回顾一下咱们做了啥：</p>
<ul>
<li><strong>弄懂了 RAG 原理</strong>：检索增强生成，就是给 AI 开卷考试的权限，先找资料再回答</li>
<li><strong>搭了个能跑的应用</strong>：笔记问答系统，从环境准备到代码实现，完整走了一遍</li>
<li><strong>学了优化技巧</strong>：文本分块、检索调优、成本控制，这些细节让应用真正可用</li>
<li><strong>看了实际场景</strong>：企业知识库、智能客服、个人助手、PDF 聊天，都是可以落地的方向
Cloudflare 这套方案最大的优势是<strong>门槛低</strong>。不用租 GPU、不用搭数据库、不用操心运维，免费额度对个人项目来说绝对够用。就算是生产环境，付费计划也比自建便宜多了。
接下来你可以：</li>
</ul>
<ol>
<li><strong>立即动手</strong>：克隆 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcloudflare%2Fworkers-sdk%2Ftree%2Fmain%2Ftemplates%2Fworker-ai-rag" target="_blank" title="https://github.com/cloudflare/workers-sdk/tree/main/templates/worker-ai-rag" ref="nofollow noopener noreferrer">官方示例代码</a>，<code>wrangler dev</code> 跑起来，5 分钟就能看到效果</li>
<li><strong>接入真实数据</strong>：把你的笔记、文档、FAQ 导进去，看看检索质量如何</li>
<li><strong>做个前端界面</strong>：用 React/Vue 做个简单的聊天界面，或者直接用 Cloudflare Pages 部署</li>
<li><strong>探索更多可能</strong>：试试多模态 RAG（结合图片、表格）、GraphRAG（知识图谱增强）等高级玩法
RAG 是当前 AI 应用最实用的架构之一，掌握它能让你做出很多有意思的东西。试下来，Cloudflare 全家桶确实能解决不少实际问题。
要是碰到问题，可以去 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.gg%2Fcloudflaredev" target="_blank" title="https://discord.gg/cloudflaredev" ref="nofollow noopener noreferrer">Cloudflare Discord</a> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcommunity.cloudflare.com%2F" target="_blank" title="https://community.cloudflare.com/" ref="nofollow noopener noreferrer">Community 论坛</a> 问，社区挺活跃的。</li>
</ol>
<blockquote>
<p>原文首发<a href="https://link.juejin.cn?target=https%3A%2F%2Feastondev.com%2Fblog%2Fzh%2Fposts%2Fai%2F20251201-rag-workers-ai-vectorize-tutorial%2F" target="_blank" title="https://eastondev.com/blog/zh/posts/ai/20251201-rag-workers-ai-vectorize-tutorial/" ref="nofollow noopener noreferrer">自个人博客</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fdf9e0d57b04fbd888fafd9e8cfa101~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5pu05aW96K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364860&amp;x-signature=gXPIxO9X9vodOSG7tO1Q7Y0ge4s%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/412c68e4376c4c56857a6285a67dad62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5pu05aW96K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364860&amp;x-signature=zwm7sfePfWcoQ4JuvID0ZLnSJms%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你的 AI 为什么总答非所问？缺的不是智商，是“记忆系统”]]></title>    <link>https://juejin.cn/post/7587995707166244883</link>    <guid>https://juejin.cn/post/7587995707166244883</guid>    <pubDate>2025-12-26T14:58:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587995707166244883" data-draft-id="7587995707166228499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你的 AI 为什么总答非所问？缺的不是智商，是“记忆系统”"/> <meta itemprop="keywords" content="LangChain,LLM,前端"/> <meta itemprop="datePublished" content="2025-12-26T14:58:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xhxxx"/> <meta itemprop="url" content="https://juejin.cn/user/3235201610941578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你的 AI 为什么总答非所问？缺的不是智商，是“记忆系统”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3235201610941578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xhxxx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T14:58:27.000Z" title="Fri Dec 26 2025 14:58:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用 LangChain 实现有记忆的多轮对话：给 AI 配一个“数字笔记本”</h2>
<blockquote>
<p><strong>大模型像一位健忘的天才——聪明但记不住事。而 LangChain，就是它的专属笔记本和秘书。</strong></p>
</blockquote>
<p>在构建聊天机器人时，我们常遇到一个尴尬场景：<br/>
你刚告诉 AI “我叫田晨枫”，下一秒问“我叫什么”，它却一脸茫然。</p>
<p>这不是它笨，而是<strong>大模型天生“无状态”</strong> ——每次对话都像第一次见面。<br/>
要让它记住你，我们需要一套机制：<strong>记录、携带、更新</strong>你的对话历史。</p>
<p>LangChain 正是为此而生。下面，我们通过代码 + 比喻，一步步搭建这个“记忆系统”。</p>
<hr/>
<h3 data-id="heading-1">一、问题演示：没有笔记本的“健忘天才”</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
    <span class="hljs-attr">model</span>:<span class="hljs-string">'deepseek-chat'</span>,
    <span class="hljs-attr">temperature</span>:<span class="hljs-number">0</span>,
});

<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">'我叫田晨枫，喜欢吃鸡腿饭'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">content</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'---------------'</span>);

<span class="hljs-keyword">const</span> res2 = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">'我叫什么名字'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res2.<span class="hljs-property">content</span>);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f80e1aa207b34332b1a464ec17176014~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767365906&amp;x-signature=iezKYo2mXpCK3TVCGN53o5QbAJA%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-2">🧠 大模型：<strong>没有笔记本的演讲者</strong></h4>
<p>想象一位演讲者站在台上：</p>
<ul>
<li>第一次上台说：“我是田晨枫。”</li>
<li>下台后，<strong>没人给他发讲稿</strong>。</li>
<li>第二次上台，他只能凭空回忆：“刚才我说啥了？”</li>
</ul>
<p>大模型就是这样——<strong>每次调用都是全新开始</strong>，除非你主动把“讲稿”（历史）塞给它。</p>
<hr/>
<h3 data-id="heading-3">二、手动维护历史：你自己当秘书</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">let</span> chatHistory = [];

chatHistory.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(<span class="hljs-string">'我叫田晨枫...'</span>));
<span class="hljs-keyword">const</span> aiReply = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(chatHistory);
chatHistory.<span class="hljs-title function_">push</span>(aiReply);

<span class="hljs-comment">// 下次再调用时带上整个 chatHistory</span>
</code></pre>
<h4 data-id="heading-4">📝 <strong>你亲自当秘书</strong></h4>
<ul>
<li>你拿个小本本（<code>chatHistory</code> 数组）</li>
<li>每次用户说话，你记下来</li>
<li>每次 AI 回答，你也记下来</li>
<li>下次提问前，把整本笔记递给 AI</li>
</ul>
<p>✅ 能工作，但：</p>
<ul>
<li>多用户？你得准备多个本子，并贴上标签（user_a, user_b…）</li>
<li>聊100轮？本子越来越厚，AI 看得眼花（Token 爆炸）</li>
</ul>
<p><strong>太累了！我们需要一个自动化的秘书。</strong></p>
<hr/>
<h3 data-id="heading-5">三、LangChain 登场：给 AI 配一个智能秘书</h3>
<p>LangChain 的 <code>RunnableWithMessageHistory</code> 就是这位秘书。我们来配置它：</p>
<h4 data-id="heading-6">步骤 1：设计“对话模板”——规定怎么读笔记</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>;
<span class="hljs-keyword">import</span>{<span class="hljs-title class_">ChatPromptTemplate</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/prompts'</span>;
<span class="hljs-comment">// 带上历史记录的可运行对象</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableWithMessageHistory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/runnables'</span>;
<span class="hljs-comment">// 内存中的对话历史记录</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InMemoryChatMessageHistory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/chat_history'</span>;
<span class="hljs-keyword">import</span><span class="hljs-string">'dotenv/config'</span>;

<span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromMessages</span>([
  [<span class="hljs-string">'system'</span>, <span class="hljs-string">'你是一个有记忆的助手'</span>],
  [<span class="hljs-string">'placeholder'</span>, <span class="hljs-string">'{history}'</span>], <span class="hljs-comment">// ← 秘书在这里插入笔记内容</span>
  [<span class="hljs-string">'human'</span>, <span class="hljs-string">'{input}'</span>]
]);
</code></pre>
<blockquote>
<p>📖 <strong>会议议程模板</strong><br/>
就像一场会议的固定流程：</p>
<ol>
<li>主持人开场（system）</li>
<li><strong>回顾上次会议纪要</strong>（{history}）</li>
<li>讨论新议题（{input}）</li>
</ol>
</blockquote>
<p><code>{history}</code> 就是预留的“纪要插入位”。</p>
<hr/>
<h4 data-id="heading-7">步骤 2：组装基础工作流</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> runnable =prompt
.<span class="hljs-title function_">pipe</span>(<span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span>{ <span class="hljs-comment">//debug 节点</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&gt;&gt;&gt; 最终传给模型的信息（Prompt 内存）"</span>);
     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(input);
     <span class="hljs-keyword">return</span> input;
})
.<span class="hljs-title function_">pipe</span>(model);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecc354cefe14449a80eb7eed833fef55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767365906&amp;x-signature=HaJSFhAVnnT%2FLjKRScKDbeLrClw%3D" alt="image.png" loading="lazy"/>
这里我们手动添加了一个用于debug的节点，实际上它只是用来查看我们最终传给大模型的是什么。<br/>
它等价于下面这段代码</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> runnable = prompt.<span class="hljs-title function_">pipe</span>(model);
</code></pre>
<blockquote>
<p>⚙️ <strong>核心工作台</strong><br/>
这是 AI 的“办公桌”：</p>
<ul>
<li>左边放议程模板（prompt）</li>
<li>右边连着大脑（model）<br/>
但<strong>还没配秘书</strong>，所以不会自动填纪要。</li>
</ul>
</blockquote>
<hr/>
<h4 data-id="heading-8">步骤 3：准备“笔记本”——历史存储</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> messageHistory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryChatMessageHistory</span>();
</code></pre>
<blockquote>
<p>📓 <strong>一个空白笔记本</strong><br/>
这是秘书用来记对话的本子。<br/>
目前是“通用本子”——所有用户共用（后面我们会升级为每人一本）。</p>
</blockquote>
<hr/>
<h4 data-id="heading-9">步骤 4：雇佣“智能秘书”——<code>RunnableWithMessageHistory</code></h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnableWithMessageHistory</span>({
  runnable,                  <span class="hljs-comment">// ← 把办公桌交给秘书</span>
  <span class="hljs-attr">getMessageHistory</span>: <span class="hljs-keyword">async</span> () =&gt; messageHistory, <span class="hljs-comment">// ← 告诉秘书去哪拿笔记本</span>
  <span class="hljs-attr">inputMessagesKey</span>: <span class="hljs-string">'input'</span>,     <span class="hljs-comment">// ← 用户当前说的话叫 "input"</span>
  <span class="hljs-attr">historyMessagesKey</span>: <span class="hljs-string">'history'</span>  <span class="hljs-comment">// ← 笔记内容注入到模板的 "history" 位置</span>
});
</code></pre>
<blockquote>
<p>👨‍💼 <strong>正式聘用秘书</strong><br/>
你对秘书说：</p>
<ul>
<li>“这是你的工作台（runnable）”</li>
<li>“笔记本在这儿（messageHistory）”</li>
<li>“用户当前问题叫 <code>input</code>，上次的笔记叫 <code>history</code>，按模板填好就行”</li>
</ul>
</blockquote>
<p>这里就是对runable进行了重新包装:</p>
<ul>
<li><strong>getMessageHistory告诉它应该调用哪个历史对话(每段对话会有对话id，我们这里使用了同一个历史对话)</strong></li>
<li><strong>inputMessagesKey用来记录当前用户说的话</strong></li>
<li><strong>historyMessagesKey 将历史对话插入到对应位置</strong>
对于我们设定的模板你就理解了:</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromMessages</span>([
  [<span class="hljs-string">'system'</span>, <span class="hljs-string">'你是一个有记忆的助手'</span>],
  [<span class="hljs-string">'placeholder'</span>, <span class="hljs-string">'{history}'</span>], <span class="hljs-comment">// ← 插入的历史对话</span>
  [<span class="hljs-string">'human'</span>, <span class="hljs-string">'{input}'</span>]<span class="hljs-comment">//&lt;- 用户输入</span>
]);
</code></pre>
<p>而当我们反复提问时就会变成这样</p>
<pre><code class="hljs language-js" lang="js">[
  <span class="hljs-title class_">SystemMessage</span>(<span class="hljs-string">"你是一个有记忆的助手"</span>),
  <span class="hljs-comment">//对应的历史对话插入</span>
  <span class="hljs-title class_">HumanMessage</span>(<span class="hljs-string">"我叫田晨枫，喜欢吃鸡腿饭"</span>),
  <span class="hljs-title class_">AIMessage</span>(<span class="hljs-string">"好的，田晨枫！..."</span>),
  <span class="hljs-comment">//用户的提问</span>
  <span class="hljs-title class_">HumanMessage</span>(<span class="hljs-string">"我叫什么名字"</span>)
]
</code></pre>
<p>从此，<strong>你只需说“问 AI 一个问题”</strong> ，秘书会自动：</p>
<ol>
<li>打开笔记本，读取历史</li>
<li>按模板整理成完整议程</li>
<li>交给 AI 处理</li>
<li>把新对话记回笔记本</li>
</ol>
<hr/>
<h4 data-id="heading-10">步骤 5：使用——你只需提问题！</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">input</span>: <span class="hljs-string">'我叫田晨枫...'</span> });
<span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">input</span>: <span class="hljs-string">'我叫什么名字？'</span> }); <span class="hljs-comment">// ✅ 正确回答！</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b53778bce3442109ee9dba52b604b42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767365906&amp;x-signature=lq%2FZ4Y2HoYM7DyuWCAy72q0TFS0%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>💬老板只管下指令**<br/>
你作为老板，只需说：“帮我问 AI 我叫什么？”<br/>
秘书默默完成所有幕后工作，你甚至不用知道笔记本的存在。</p>
</blockquote>
<hr/>
<h3 data-id="heading-11">四、升级：给每位用户配专属笔记本（多会话支持）</h3>
<p>之前的笔记本是公用的。现在，我们让秘书管理<strong>多个带标签的笔记本</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> sessionStore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(); <span class="hljs-comment">// ← 一个文件柜，每个抽屉贴了标签</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getMessageHistory</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">sessionId</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!sessionStore.<span class="hljs-title function_">has</span>(sessionId)) {
    <span class="hljs-comment">// 如果没这个用户的笔记本，就新建一本</span>
    sessionStore.<span class="hljs-title function_">set</span>(sessionId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryChatMessageHistory</span>());
  }
  <span class="hljs-keyword">return</span> sessionStore.<span class="hljs-title function_">get</span>(sessionId); <span class="hljs-comment">// ← 返回对应笔记本</span>
};

<span class="hljs-comment">// 调用时指定用户 ID</span>
<span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>(
  { <span class="hljs-attr">input</span>: <span class="hljs-string">'我叫张三'</span> },
  { <span class="hljs-attr">configurable</span>: { <span class="hljs-attr">sessionId</span>: <span class="hljs-string">'user_zhang'</span> } } <span class="hljs-comment">// ← “请用张三的笔记本！”</span>
);
</code></pre>
<blockquote>
<p>🗂️ <strong>带标签的文件柜</strong></p>
<ul>
<li>文件柜（<code>sessionStore</code>）里有很多抽屉</li>
<li>每个抽屉贴着用户 ID 标签（<code>sessionId</code>）</li>
<li>秘书根据你提供的标签，取出对应的笔记本</li>
<li>张三和李四的对话完全隔离，互不干扰</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-12">五、防止笔记本太厚：自动清理旧记录</h3>
<p>聊得越多，笔记本越厚。长期下去：</p>
<ul>
<li>AI 阅读困难（上下文太长）</li>
<li>成本飙升（Token 按字数计费）</li>
</ul>
<p>解决方案：<strong>让秘书定期清理旧页</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_MESSAGES</span> = <span class="hljs-number">6</span>; <span class="hljs-comment">// 只保留最近 3 轮对话（6 条消息）</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getMessageHistory</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">sessionId</span>) =&gt; {
  <span class="hljs-keyword">let</span> history = sessionStore.<span class="hljs-title function_">get</span>(sessionId) || <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryChatMessageHistory</span>();
  
  <span class="hljs-keyword">const</span> messages = <span class="hljs-keyword">await</span> history.<span class="hljs-title function_">getMessages</span>();
  <span class="hljs-keyword">if</span> (messages.<span class="hljs-property">length</span> &gt; <span class="hljs-variable constant_">MAX_MESSAGES</span>) {
    <span class="hljs-comment">// 清空笔记本，只抄写最后几页</span>
    <span class="hljs-keyword">await</span> history.<span class="hljs-title function_">clear</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> msg <span class="hljs-keyword">of</span> messages.<span class="hljs-title function_">slice</span>(-<span class="hljs-variable constant_">MAX_MESSAGES</span>)) {
      <span class="hljs-keyword">await</span> history.<span class="hljs-title function_">addMessage</span>(msg);
    }
  }
  
  sessionStore.<span class="hljs-title function_">set</span>(sessionId, history);
  <span class="hljs-keyword">return</span> history;
};
</code></pre>
<blockquote>
<p>✂️ <strong>秘书的“精简笔记”习惯</strong><br/>
秘书有个规矩：</p>
<ul>
<li>笔记本超过 6 页，就撕掉前面的</li>
<li>只保留最近 3 轮对话（足够理解上下文）</li>
<li>既节省空间，又不影响工作</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-13">六、总结：LangChain 的记忆系统全景图</h3>








































<table><thead><tr><th>组件</th><th>比喻</th><th>作用</th></tr></thead><tbody><tr><td><code>ChatPromptTemplate</code></td><td>会议议程模板</td><td>规定如何组织上下文</td></tr><tr><td><code>{history}</code> 占位符</td><td>“上次会议纪要”位置</td><td>历史消息插入点</td></tr><tr><td><code>InMemoryChatMessageHistory</code></td><td>笔记本</td><td>存储对话记录</td></tr><tr><td><code>getMessageHistory</code></td><td>文件柜管理员</td><td>根据用户 ID 分发笔记本</td></tr><tr><td><code>RunnableWithMessageHistory</code></td><td>智能秘书</td><td>自动读写笔记、组装请求</td></tr><tr><td><code>sessionId</code></td><td>用户标签</td><td>区分不同用户的笔记本</td></tr></tbody></table>
<hr/>
<p>大模型本身没有记忆，就像一位才华横溢却健忘的演讲者——每次登台都像初次见面。<br/>
而 LangChain 并没有改变模型的本质，而是<strong>在它身边搭建了一套完整的记忆支持系统</strong>：</p>
<ul>
<li><strong>用模板定义记忆格式</strong>（Prompt）</li>
<li><strong>用存储承载记忆内容</strong>（MessageHistory）</li>
<li><strong>用会话机制隔离记忆边界</strong>（sessionId）</li>
<li><strong>用自动包装实现记忆流转</strong>（RunnableWithMessageHistory）</li>
</ul>
<p>更重要的是，这套系统是<strong>可插拔、可扩展、可控制的</strong>：<br/>
你可以轻松替换内存存储为 Redis，可以加入自动摘要压缩长对话，也可以设定最大轮数防止 Token 膨胀。</p>
<blockquote>
<p><strong>真正的“AI 记忆”，从来不是模型自己记住什么，而是我们为它构建了一个恰到好处的记忆环境。</strong><br/>
LangChain 提供的，正是这样一套让记忆变得简单、可靠又高效的工程化方案。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Doris Catalog 已上线！性能提升 200x，全面优于 JDBC Catalog，跨集群查询迈入高性能分析时代]]></title>    <link>https://juejin.cn/post/7587995707165982739</link>    <guid>https://juejin.cn/post/7587995707165982739</guid>    <pubDate>2025-12-26T13:05:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587995707165982739" data-draft-id="7588007285546156038" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Doris Catalog 已上线！性能提升 200x，全面优于 JDBC Catalog，跨集群查询迈入高性能分析时代"/> <meta itemprop="keywords" content="数据库,Apache,数据分析"/> <meta itemprop="datePublished" content="2025-12-26T13:05:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Doris Catalog 已上线！性能提升 200x，全面优于 JDBC Catalog，跨集群查询迈入高性能分析时代
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T13:05:43.000Z" title="Fri Dec 26 2025 13:05:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>“统一”是 Apache Doris 长期以来秉持的设计理念之一</strong>。在这一理念指引下，构建完善的 Catalog 生态是实现异构数据源统一查询分析的关键。目前，Doris 已支持 Iceberg、Paimon、Hudi 等数据湖 Catalog，以及 JDBC Catalog，用户无需迁移数据，即可对不同数据湖和传统数据库进行联邦查询分析。</p>
<p><strong>本文聚焦 Doris 多集群间的查询分析</strong>。实现跨 Doris 集群的分析通查需要通过 JDBC Catalog，但该方式存在明显短板，比如协议开销较大、无法复用 Doris 查询优化策略、查询性能受限等等。同时，随着生产环境中多 Doris 集群部署愈加普遍，跨集群的数据联动分析需求也日益增长。在这种情况下，JDBC Catalog 很难满足用户的性能要求。</p>
<p>为此，<strong>Apache Doris 4.0.2 版本推出重磅特性：Doris Catalog。该功能专为跨 Doris 集群联邦分析设计，支持通过 Arrow Flight 和虚拟集群两种模式，进行更高效、更贴合原生优化的跨集群查询</strong>。</p>
<blockquote>
<p>特此说明：Doris Catalog 当前为实验性特，欢迎大家体验并反馈，我们将持续优化</p>
</blockquote>
<h2 data-id="heading-0">Doris Catalog vs. JDBC Catalog</h2>
<p>JDBC Catalog 主要借助 MySQL 兼容的 JDBC 协议访问其他 Doris 集群数据。由前文可知，该方式在跨集群大数据量交互时性能受限，难以满足联邦分析高吞吐与低延迟的性能要求。不同于 JDBC Catalog 的交互方式， Doris Catalog 通过 Arrow Flight 或虚拟集群这两种方式，能够直接、高效的访问其他 Doris 集群，进行多集群联邦分析。</p>
<h3 data-id="heading-1">01 功能对比</h3>
<p>那么，与 JDBC Catalog 相比，Doris Catalog 到底具备哪些能力优势呢？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c18adcc97471440bbf5e541102ba0f64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767359142&amp;x-signature=MUtZPR6%2BDE%2B%2BnROIZzX5ZP5A62U%3D" alt="01 功能对比.png" loading="lazy"/></p>
<h3 data-id="heading-2">02 性能对比</h3>
<p>为了更直观地展示二者在实际查询中的表现，我们基于跨集群的 TPC-DS 查询场景，对比了 Doris Catalog（两种连接模式） 与 JDBC Catalog 的执行性能。以下是测试结果概要：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1972ee200b84c7580940520744884fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767359142&amp;x-signature=d97A7mv6uDWVmW5qkoZSQZkxPZw%3D" alt="02 性能对比.png" loading="lazy"/></p>
<p>结果显示，在涉及聚合、Join 等复杂查询场景下，Doris Catalog 相比 JDBC Catalog 展现出不同程度的性能优势。其中，在单表聚合查询场景下优势尤为突出：<strong>Doris Catalog（虚拟集群）的查询耗时仅为 0.21 秒，相较于 JDBC Catalog，速度提升超过 200 倍</strong>。</p>
<p><strong>具体测试如下</strong>：</p>
<ol>
<li><strong>在单表简单查询（直接查询远端集群）模式下</strong>：Doris Catalog 与 JDBC Catalog 基本持平。</li>
</ol>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span>
    ss_sold_date_sk,
    ss_store_sk,
    ss_item_sk,
    ss_ticket_number,
    ss_quantity,
    ss_sales_price,
    ss_ext_sales_price,
    ss_net_profit
<span class="hljs-keyword">FROM</span> jdbc_mode.tpcds100.store_sales
<span class="hljs-keyword">WHERE</span> ss_sold_date_sk <span class="hljs-operator">=</span> <span class="hljs-number">2450816</span>
  <span class="hljs-keyword">AND</span> ss_store_sk <span class="hljs-operator">=</span> <span class="hljs-number">10</span>
  <span class="hljs-keyword">AND</span> ss_quantity <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">3</span>
LIMIT <span class="hljs-number">100</span>;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b3c9aa2e3774661b9df4ab411b46748~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767359142&amp;x-signature=M3JT4s0hKi4EBzO0VTkhGq8HzHI%3D" alt="02 性能对比-1.png" loading="lazy"/></p>
<ol>
<li><strong>在单表聚合查询（直接查询远端集群）模式下</strong>：Doris Catalog 两种模式均优于 JDBC Catalog，Doris Catalog（虚拟集群）的查询耗时仅为 0.21 秒，相较于 JDBC Catalog，<strong>速度提升超过 200 倍</strong>。</li>
</ol>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span>
    ss_sold_date_sk,
    ss_store_sk,
    <span class="hljs-built_in">SUM</span>(ss_ext_sales_price) <span class="hljs-keyword">AS</span> total_sales,
    <span class="hljs-built_in">SUM</span>(ss_net_profit)      <span class="hljs-keyword">AS</span> total_profit,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)                <span class="hljs-keyword">AS</span> txn_cnt
<span class="hljs-keyword">FROM</span> tpcds100.store_sales
<span class="hljs-keyword">WHERE</span> ss_sold_date_sk <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2450816</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">2451179</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
    ss_sold_date_sk,
    ss_store_sk
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    ss_sold_date_sk,
    ss_store_sk
LIMIT <span class="hljs-number">100</span>;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6205b5f642dc466aae9dfc60356bbf21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767359142&amp;x-signature=zQb2Byi1qyWdAGeWd7jHr6pRGnM%3D" alt="02 性能对比-2.png" loading="lazy"/></p>
<ol>
<li><strong>在多表关联查询（两个大表分别存储在本地和远端集群，进行关联查询）模式下</strong>：Doris Catalog 两种模式均优于 JDBC Catalog，相较于 JDBC Catalog，<strong>速度提升约 42%</strong>。</li>
</ol>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">count</span>(ss_item_sk), <span class="hljs-built_in">count</span>(store_sales_amt), <span class="hljs-built_in">count</span>(catalog_sales_amt) <span class="hljs-keyword">FROM</span>
(
<span class="hljs-keyword">SELECT</span>
    ss.ss_item_sk <span class="hljs-keyword">as</span> ss_item_sk,
    <span class="hljs-built_in">SUM</span>(ss.ss_ext_sales_price) <span class="hljs-keyword">AS</span> store_sales_amt,
    <span class="hljs-built_in">SUM</span>(cs.cs_ext_sales_price) <span class="hljs-keyword">AS</span> catalog_sales_amt
<span class="hljs-keyword">FROM</span> internal.tpcds100.store_sales ss
<span class="hljs-keyword">JOIN</span> external.tpcds100.catalog_sales cs
    <span class="hljs-keyword">ON</span> ss.ss_item_sk <span class="hljs-operator">=</span> cs.cs_item_sk
<span class="hljs-keyword">WHERE</span> ss.ss_sold_date_sk <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2450815</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">2451079</span>
  <span class="hljs-keyword">AND</span> cs.cs_sold_date_sk <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2450815</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">2451079</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> ss.ss_item_sk) x;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35582afa7da54ecfa4f7d0d432e60b0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767359142&amp;x-signature=slX%2FDCDFyLUOiGJw9JnMOFaGTrw%3D" alt="02 性能对比-3.png" loading="lazy"/></p>
<h3 data-id="heading-3">03 方案选择</h3>
<p>由上可知，不同的查询场景中，需要选择适合的的访问模式，以获取最佳的查询性能：</p>
<ul>
<li>对于复杂 Join/Agg 查询或依赖 Doris 内表优化特性时，优先选择 Doris Catalog <strong>虚拟集群模式</strong>。</li>
<li>对于简单单表查询、UNION 查询、远端集群规模大且无需复杂 Join 优化或 Doris 集群版本不一致，优先选择 Doris Catalog  <strong>Arrow Flight 模式</strong>。</li>
</ul>
<h2 data-id="heading-4">Doris Catalog 核心设计</h2>
<p><strong>Doris Catalog 本质是跨集群访问的“中间代理”，核心职责包括</strong>：</p>
<ul>
<li>元数据同步：通过 HTTP 协议从远端 Doris 集群 FE 拉取表结构、分区、副本、 Tablet 位置等元数据；</li>
<li>执行计划生成：根据访问模式，将用户查询转换为适配远端集群的执行计划；</li>
<li>数据路由与传输：协调本地 BE 与远端 BE 进行数据传输，支持并行拉取与分片处理；</li>
<li>结果聚合：将远端返回的数据聚合后，返回给用户或上层应用。</li>
</ul>
<p><strong>Doris Catalog 支持 Arrow Flight 和 虚拟集群两种访问模式。在了解具体实现之前，先了解两种模式的区别</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d8cd0a87f1740cf81bc6ae8e61337b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767359142&amp;x-signature=PK%2FtLLmgPmYUsTnu4ss7LLAS104%3D" alt=" Doris Catalog 核心设计.png" loading="lazy"/></p>
<h3 data-id="heading-5">01 Arrow Flight 模式</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fb7e021c0fb418f994707bf90820aa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767359142&amp;x-signature=NhqrakrTkJRwbZEV7L7Jez2KAEQ%3D" alt="01 Arrow Flight 模式.png" loading="lazy"/></p>
<p>该模式的工作流程如下（假设本地集群为 ClusterA，远端集群为 ClusterB）：</p>
<ul>
<li>查询规划：ClusterA 的 FE 节点先进行完整的查询规划，针对存储在 ClusterB 中的表，生成 <code>RemoteDorisScanNode</code>节点。<code>RemoteDorisScanNode</code> 会生成一条应用谓词下推规则后的单表查询 SQL，通过 HTTP 协议向 ClusterB 的 FE 节点发送并执行这条 Arrow Flight SQL。</li>
<li>查询计划执行：ClusterA 的 FE 节点将物理执行计划发送给 ClusterA 的 BE 节点，并告知 BE 节点 Arrow Flight 的数据流获取位置。</li>
<li>数据查询与传输：ClusterA 的 BE 节点的 Scan Node 通过 Arrow Flight 协议直接从 ClusterB 的 BE 节点获取 Arrow Flight SQL 的执行结果。然后在 ClusterA 中执行 Join、Agg 等其他算子，并返回最终结果。</li>
</ul>
<h3 data-id="heading-6">02 虚拟集群模式</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc8573df4de34f2fa7cb12a2240bc248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767359142&amp;x-signature=%2FynLrnht%2Fh3gGdBt%2FeiW5wQGBss%3D" alt="02 虚拟集群模式.png" loading="lazy"/></p>
<p>该模式的工作流程如下（假设本地集群为 ClusterA，远端集群为 ClusterB）：</p>
<ul>
<li>元数据同步：ClusterA 的 FE 节点通过 HTTP 协议同步 ClusterB 中完整的元数据，包括表结构、分区、副本、Tablet 位置等。</li>
<li>查询规划：ClusterA 的  FE 节点将 ClusterB 的 BE 节点视为“虚拟 BE”，生成全局统一的执行计划（与单集群查询逻辑一致）。</li>
<li>查询计划执行：执行计划会将 ClusterA 与 ClusterB 的 BE 节点视作一个统一 BE 集群，并在其上执行查询计划。因此，各类算子会同时在 ClusterA 和 ClusterB 的 BE 节点中执行。</li>
<li>数据查询与传输：ClusterA 与 ClusterB 的 BE 节点间使用内部通信协议进行数据交互。</li>
</ul>
<h2 data-id="heading-7">实战演示：10 分钟完成跨集群订单履约率分析</h2>
<p>回归到实际使用中，Doris Catalog 可有效支撑以下五大核心业务场景，精准解决跨集群分析痛点：</p>
<ol>
<li><strong>多业务集群联合分析</strong>：如在电商场景中，交易集群存储订单数据、物流集群存储履约数据，通过 Doris Catalog 直接关联计算“订单履约率”“物流时效”等核心指标，无需跨集群数据同步。</li>
<li><strong>地域分布式集群全局统计</strong>：如零售企业在多地域部署 Doris 集群，通过 Doris Catalog 一站式汇总各区域销售数据，实时计算全国总销售额、区域占比、用户活跃度等全局指标。</li>
<li><strong>实时数据跨集群关联查询</strong>：如用户行为分析场景中，通过 Doris Catalog 实时关联用户实时行为集群（点击、浏览等）与长期用户画像集群，支撑个性化推荐、精准营销等实时决策场景。</li>
<li><strong>跨地域超大规划集群分治</strong>：不同地域的分公司采用相同的业务模式部署和使用 Doris 集群。母公司通过 Doris Catalog 完成对全地域多集群的集中访问，实现超大规模业务数据管理。</li>
<li><strong>跨集群数据迁移验证与对比分析</strong>：新旧集群迁移过程中，通过 Doris Catalog 直接对比两端数据一致性，无需导出导入工具，简化迁移验证流程，降低数据丢失风险。</li>
</ol>
<p><strong>接下来，我们以常见场景 1：多业务集群联合分析为例，实战演示如何在 10 分钟完成跨集群订单履约率分析</strong>。</p>
<ol>
<li><strong>背景介绍</strong>
现有两个 Doris 集群，需跨集群关联计算核心业务指标：</li>
</ol>
<ul>
<li>本地集群（Trading-Cluster）：存储订单基础数据，库表为 <code>trading_db.order_info</code>（订单表）；</li>
<li>远端集群（Logistics-Cluster）：存储物流履约数据，库表为 <code>logistics_db.delivery_info</code>（履约表）；</li>
<li>业务需求：计算近 7 天各订单类型的履约率（已履约订单数/总订单数），支撑运营决策。</li>
</ul>
<ol start="2">
<li><strong>表结构定义</strong></li>
</ol>
<ul>
<li>本地订单表 <code>trading_db.order_info</code>：
<ul>
<li>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> trading_db.order_info (
    order_id STRING COMMENT <span class="hljs-string">'订单ID'</span>,
    order_type STRING COMMENT <span class="hljs-string">'订单类型：实物订单/虚拟订单'</span>,
    create_time DATETIME COMMENT <span class="hljs-string">'创建时间'</span>,
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) COMMENT <span class="hljs-string">'订单金额'</span>
) ENGINE<span class="hljs-operator">=</span>OLAP
DUPLICATE KEY(order_id)
<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span>(create_time) (
    <span class="hljs-keyword">PARTITION</span> p202511 <span class="hljs-keyword">VALUES</span> [(<span class="hljs-string">'2025-11-01 00:00:00'</span>), (<span class="hljs-string">'2025-12-01 00:00:00'</span>))
)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(order_id) BUCKETS <span class="hljs-number">10</span>;
</code></pre>
</li>
</ul>
</li>
<li>远端履约表 <code>logistics_db.delivery_info</code>：
<ul>
<li>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> logistics_db.delivery_info (
    order_id STRING COMMENT <span class="hljs-string">'订单ID'</span>,
    delivery_status TINYINT COMMENT <span class="hljs-string">'履约状态：1-已履约，0-未履约'</span>,
    delivery_time DATETIME COMMENT <span class="hljs-string">'履约时间'</span>
) ENGINE<span class="hljs-operator">=</span>OLAP
DUPLICATE KEY(order_id)
<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span>(delivery_time) (
    <span class="hljs-keyword">PARTITION</span> p202511 <span class="hljs-keyword">VALUES</span> [(<span class="hljs-string">'2025-11-01 00:00:00'</span>), (<span class="hljs-string">'2025-12-01 00:00:00'</span>))
)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(order_id) BUCKETS <span class="hljs-number">10</span>;
</code></pre>
</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<p><strong>数据准备</strong>
向两张表分别插入测试数据（本地表 100 万行订单数据，远端表 80 万行履约数据），确保订单 ID 存在关联关系。</p>
</li>
<li>
<p><strong>配置 Doris Catalog</strong>
在本地 Doris 集群执行以下 SQL，创建连接远端物流集群的 Catalog（虚拟集群模式）：</p>
</li>
</ol>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-comment">-- 创建Doris Catalog，启用虚拟集群模式（复用内表优化）</span>
<span class="hljs-keyword">CREATE</span> CATALOG IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> logistics_ctl PROPERTIES (
    <span class="hljs-string">'type'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'doris'</span>, <span class="hljs-comment">-- 固定类型</span>
    <span class="hljs-string">'fe_http_hosts'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'http://logistics-fe1:8030,http://logistics-fe2:8030'</span>, <span class="hljs-comment">-- 远端FE HTTP地址</span>
    <span class="hljs-string">'fe_arrow_hosts'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'logistics-fe1:8040,http://logistics-fe2:8040'</span>, <span class="hljs-comment">-- 远端FE Arrow Flight地址</span>
    <span class="hljs-string">'fe_thrift_hosts'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'logistics-fe1:9020,http://logistics-fe2:9020'</span>, <span class="hljs-comment">-- 远端FE Thrift地址</span>
    <span class="hljs-string">'use_arrow_flight'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'false'</span>, <span class="hljs-comment">-- false=虚拟集群模式，true=Arrow Flight模式</span>
    <span class="hljs-string">'user'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'doris_admin'</span>, <span class="hljs-comment">-- 远端集群登录用户</span>
    <span class="hljs-string">'password'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'Doris@123456'</span>, <span class="hljs-comment">-- 远端集群登录密码</span>
    <span class="hljs-string">'compatible'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'false'</span>, <span class="hljs-comment">-- 集群版本接近（4.0.3 vs 4.0.2），无需兼容</span>
    <span class="hljs-string">'query_timeout_sec'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'30'</span> <span class="hljs-comment">-- 延长查询超时时间（默认15秒）</span>
);
</code></pre>
<ol start="5">
<li><strong>跨集群查询</strong></li>
</ol>
<ul>
<li>切换 Catalog 后查询
<ul>
<li>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-comment">-- 切换到远端物流集群的Catalog</span>
SWITCH logistics_ctl;
<span class="hljs-comment">-- 使用本地订单库</span>
USE trading_db;
<span class="hljs-comment">-- 关联本地订单表与远端履约表，计算履约率</span>
<span class="hljs-keyword">SELECT</span> 
    o.order_type,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) <span class="hljs-keyword">AS</span> total_orders,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> d.delivery_status <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> o.order_id <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> delivered_orders,
    ROUND(<span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> d.delivery_status <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> o.order_id <span class="hljs-keyword">END</span>) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id), <span class="hljs-number">4</span>) <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AS</span> delivery_rate
<span class="hljs-keyword">FROM</span> internal.trading_db.order_info o
<span class="hljs-keyword">JOIN</span> delivery_info d <span class="hljs-keyword">ON</span> o.order_id <span class="hljs-operator">=</span> d.order_id
<span class="hljs-keyword">WHERE</span> o.create_time <span class="hljs-operator">&gt;=</span> DATE_SUB(<span class="hljs-built_in">CURRENT_DATE</span>(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">7</span> <span class="hljs-keyword">DAY</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> o.order_type
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> delivery_rate <span class="hljs-keyword">DESC</span>;
</code></pre>
</li>
</ul>
</li>
<li>全限定名查询
<ul>
<li>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span> 
    o.order_type,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id) <span class="hljs-keyword">AS</span> total_orders,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> d.delivery_status <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> o.order_id <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> delivered_orders,
    ROUND(<span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> d.delivery_status <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> o.order_id <span class="hljs-keyword">END</span>) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> o.order_id), <span class="hljs-number">4</span>) <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AS</span> delivery_rate
<span class="hljs-keyword">FROM</span> internal.trading_db.order_info o
<span class="hljs-keyword">JOIN</span> logistics_ctl.logistics_db.delivery_info d <span class="hljs-keyword">ON</span> o.order_id <span class="hljs-operator">=</span> d.order_id
<span class="hljs-keyword">WHERE</span> o.create_time <span class="hljs-operator">&gt;=</span> DATE_SUB(<span class="hljs-built_in">CURRENT_DATE</span>(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">7</span> <span class="hljs-keyword">DAY</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> o.order_type
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> delivery_rate <span class="hljs-keyword">DESC</span>;
</code></pre>
</li>
</ul>
</li>
</ul>
<ol start="6">
<li><strong>查询结果与优化验证</strong>
<ol>
<li>执行结果示例
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56ba3f53929b4fe5b92cff0f5a22daac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767359142&amp;x-signature=qoiIsQ5sTn9b%2F33Ehr8QUDhOIPU%3D" alt="实战演示.png" loading="lazy"/></li>
<li>优化特性验证
<ul>
<li>执行 <code>EXPLAIN</code> 查看执行计划，可发现：</li>
<li>虚拟集群模式下，执行计划中远端表扫描节点为 <code>VOlapScanNode</code>（与本地表一致），说明复用了 Doris 内表扫描优化；</li>
<li>Join 操作中自动启用 <code>Runtime Filter</code>，减少远端数据传输量。</li>
</ul>
</li>
</ol>
</li>
</ol>
<h2 data-id="heading-8">总结与展望</h2>
<p>Doris Catalog 的推出，补齐了 Doris 跨集群联邦查询的性能短板。在此<strong>特别感谢社区同学的 Chen768959 和 HonestManXin 贡献</strong>，帮助延续了 Doris Catalog 生态“无需迁移、一站式分析”的核心优势，让多 Doris 集群从“数据孤岛”变为“互联一体”。</p>
<p>作为实验性特性，Doris Catalog 后续将持续迭代优化：</p>
<ul>
<li>增强 Arrow Flight 模式，使其能够访问任意支持标准 Arrow Flight 协议的数据源。</li>
<li>降低虚拟集群模式 FE 内存开销，优化元数据存储和同步策略；</li>
<li>支持存算分离部署的 Doris 集群（虚拟集群模式）</li>
<li>新增更多监控指标，方便排查跨集群查询故障。</li>
</ul>
<p>更多信息，请访问 Doris 官网文档：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2F4.x%2Flakehouse%2Fcatalogs%2Fdoris-catalog" target="_blank" title="https://doris.apache.org/zh-CN/docs/4.x/lakehouse/catalogs/doris-catalog" ref="nofollow noopener noreferrer">doris.apache.org/zh-CN/docs/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析Ooder架构：A2UI时代全栈设计的四大核心思考]]></title>    <link>https://juejin.cn/post/7588001624904876051</link>    <guid>https://juejin.cn/post/7588001624904876051</guid>    <pubDate>2025-12-26T13:08:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588001624904876051" data-draft-id="7587995707165999123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析Ooder架构：A2UI时代全栈设计的四大核心思考"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-26T13:08:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析Ooder架构：A2UI时代全栈设计的四大核心思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T13:08:27.000Z" title="Fri Dec 26 2025 13:08:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大模型席卷企业级开发的当下，AI to UI（A2UI）已从概念落地为实际生产力，成为前端开发演进的核心方向之一。而专为大模型流式处理设计的Ooder全栈架构，凭借与React/Vue截然不同的设计思路，在CN环境下的A2UI场景中崭露头角。</p>
<p>围绕Ooder架构的设计核心逻辑、技术选型、可视化实现及组件化差异四大关键问题，结合架构设计的核心思路与实践经验，本文将从技术推理到落地实践进行完整拆解，带大家读懂Ooder架构的设计精髓与取舍之道。</p>
<h2 data-id="heading-0">一、核心之问一：为何要专门设计UI注解库？而非复用React/Vue生态？</h2>
<h3 data-id="heading-1">AICodeing提问逻辑：传统框架的A2UI适配困境</h3>
<p>随着A2UI从概念走向实践，我们发现传统前端框架（React/Vue）在适配这一模式时存在天然局限：其一，这类框架专注于前端UI领域，无法覆盖从后端服务到前端渲染的全栈链路，导致AI生成全栈代码时出现“断层”；其二，动态模板设计的灵活性虽高，但难以被大模型精准解析和生成，增加了A2UI落地的难度；其三，前后端协同需要额外的状态管理、接口适配机制，沟通与开发成本居高不下。</p>
<p>基于传统框架的适配局限，Ooder架构选择跳出固有思维，设计专属UI注解库。这一设计的核心价值究竟是什么？</p>
<h3 data-id="heading-2">设计逻辑：注解驱动是A2UI与全栈流式处理的最优解</h3>
<p>Ooder设计专属UI注解库的核心逻辑，是为了精准适配A2UI模式与大模型流式处理的核心需求，具体可拆解为四点：</p>
<ol>
<li><strong>全栈一体化工作环境</strong>：注解库打通了后端服务、数据模型到前端UI的完整链路，让AI能够直接生成覆盖全栈的代码，无需在不同框架、不同领域间切换适配；</li>
<li><strong>完美适配大模型流式输出</strong>：通过<code>@APIEventAnnotation</code>等注解驱动的事件机制，能够实时接收大模型的流式输出内容，并直接渲染为对应的UI组件，实现“AI生成即渲染”的高效体验；</li>
<li><strong>契合CN环境的实际需求</strong>：当前CN市场对低代码/零代码开发、A2UI自动化生成的需求旺盛，注解驱动的设计降低了开发门槛，让非专业开发者也能借助AI完成企业级应用开发；</li>
<li><strong>契合A2UI的核心理论</strong>：借鉴Google A2UI模式的核心思路，通过结构化的注解定义，实现从AI指令到UI组件的自动化转换，减少人工干预环节。</li>
</ol>
<h3 data-id="heading-3">技术取舍：优势与局限性的客观评价</h3>
<p>任何技术设计都存在取舍，Ooder的UI注解库也不例外：</p>
<p><strong>核心优势</strong>：</p>
<ul>
<li>天然适配A2UI模式，据实测可提升60%-80%的开发效率，尤其适合企业级表单、后台管理系统等标准化场景；</li>
<li>全栈一体化设计消除了前后端协同的“鸿沟”，减少了接口适配、数据校验等重复工作；</li>
<li>结构化的注解定义便于大模型解析，为“图生代码”“文生代码”提供了清晰的技术载体，降低了AI生成代码的错误率。</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>生态相对年轻，相比React/Vue成熟的第三方组件库，Ooder的可选组件资源较少，定制化复杂组件时需要更多开发工作；</li>
<li>学习曲线较陡，开发者需要从“前端组件化思维”切换到“全栈注解思维”，掌握覆盖前后端的注解体系；</li>
<li>在复杂动态交互场景（如可视化大屏、复杂表单联动）中，灵活性不如React/Vue的动态模板设计。</li>
</ul>
<h2 data-id="heading-4">二、核心之问二：为何选择“编译时+运行时”混合架构？纯运行时不更香吗？</h2>
<h3 data-id="heading-5">核心思考：纯运行时架构的全栈适配困境，为何转向混合架构？</h3>
<p>传统前端架构多采用纯运行时设计，依赖浏览器动态解析模板、处理事件和渲染页面。但在A2UI和全栈开发场景中，这种架构的弊端逐渐凸显：一是前后端数据模型难以保证一致性，容易出现“前端渲染与后端数据不匹配”的问题；二是跨层事件联动复杂，需要引入Redux、Vuex等状态管理库和事件总线机制，增加了架构复杂度；三是无法高效处理AI生成的全栈内容，难以实现“生成即运行”的A2UI核心需求。</p>
<p>Ooder架构创新性地采用“编译时+运行时”的混合处理机制，这一架构选择的核心优势是什么？</p>
<h3 data-id="heading-6">架构优势：混合架构实现全栈一致性与高效渲染的平衡</h3>
<p>Ooder的混合架构通过“双阶段处理”机制，既解决了纯运行时的一致性问题，又保留了动态适配的灵活性，具体实现逻辑如下：</p>
<ol>
<li><strong>编译时处理：固化核心模型，保障一致性</strong>：在编译阶段，Ooder会对数据结构接口进行“固化”，通过类型检查确保前后端数据模型一致；同时将前端打包、资源优化等工作融入编译流程，并自动生成前后端通信的中间层代码，避免人工编写适配逻辑的冗余与错误。</li>
<li><strong>运行时处理：动态适配需求，保障灵活性</strong>：在运行阶段，Ooder支持服务的动态绑定和反射式软绑定，能够根据实际业务场景调整服务依赖；通过<code>@APIEventAnnotation</code>实现前后台事件的无缝联动，无需额外的事件总线；同时支持多端输入（如AI指令、用户操作）动态生成UI输出，完美适配A2UI模式的动态需求。</li>
</ol>
<p>这种混合架构的核心优势在于三点：一是中间层统一，自动生成的中间层代码消除了前后端数据不一致的隐患；二是动作事件联动高效，跨层事件无需人工适配，降低了开发复杂度；三是多源数据支持能力强，能够灵活处理AI生成数据、后端接口数据、用户输入数据等多类数据源的UI渲染需求。</p>
<h3 data-id="heading-7">技术取舍：架构复杂度与效率的平衡</h3>
<p><strong>核心优势</strong>：</p>
<ul>
<li>编译时的类型检查减少了运行时错误，提升了代码质量，尤其适合大型企业级应用的长期维护；</li>
<li>前后端模型统一，降低了团队的沟通成本和适配工作量，让开发者更聚焦业务逻辑；</li>
<li>对A2UI模式的适配性远超纯运行时架构，能够高效处理AI生成的全栈代码，实现“生成即部署”的高效落地。</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>架构复杂度高于纯运行时设计，开发和维护过程中需要关注编译配置、中间层生成等额外环节；</li>
<li>编译过程会延长开发周期中的构建时间，尤其在大型项目中，可能影响开发效率；</li>
<li>对开发工具链的要求较高，需要配套支持混合编译的IDE和构建工具，否则会增加开发门槛。</li>
</ul>
<h2 data-id="heading-8">三、核心之问三：注解库与ooder-DSM的集成，如何解决可视化与“图生代码”难题？</h2>
<h3 data-id="heading-9">核心难题：传统框架的可视化协同困境如何破解？</h3>
<p>可视化编辑和“图生代码”是A2UI模式的核心能力，也是提升团队协同效率的关键。但传统前端框架的可视化支持依赖Storybook等第三方工具，存在明显短板：一是前后端模型割裂，产品经理在可视化工具中设计的UI，无法直接对接后端业务逻辑，需要前端二次适配；二是图生代码能力有限，动态模板的灵活性导致AI难以精准解析设计稿，生成的代码可用性低；三是多角色协同困难，产品、前后端、业务人员基于不同的模型开展工作，沟通成本高，容易出现理解偏差。</p>
<p>Ooder通过注解库与ooder-DSM的可视化编辑集成，有效解决了上述问题。这种集成的具体实现机制是什么？</p>
<h3 data-id="heading-10">实现机制：注解与组件1:1映射，打通“设计-代码-业务”全链路</h3>
<p>Ooder的可视化支持核心在于“注解系统与前端组件的1:1映射”，通过这一设计实现了可视化设计、代码生成、业务逻辑的全链路统一，具体技术路径如下：</p>
<ol>
<li><strong>注解系统的精准设计</strong>：Ooder定义了<code>@FormAnnotation</code>（表单组件）、<code>@TreeAnnotation</code>（树形组件）等一系列注解，每个注解的属性（如样式、交互规则、数据绑定）都与对应的前端组件实现1:1对应，确保注解定义能够完全覆盖组件的核心特性。</li>
<li><strong>RAD可视化全流程</strong>：通过Ooder RAD可视化工具，产品经理或业务人员可直接拖拽组件进行UI设计；设计完成后，工具会将组件的属性序列化为JSON格式；Ooder引擎再将JSON翻译为对应的后端注解，并自动生成完整的前后端代码（包括前端渲染逻辑、后端数据接口、数据校验规则）。</li>
<li><strong>强类型约束体系</strong>：注解系统自带强类型约束，确保可视化设计的属性符合后端数据模型的要求，避免出现“设计与业务不匹配”的问题；同时强类型也为AI解析设计稿、生成精准代码提供了保障。</li>
<li><strong>多角色协同机制</strong>：产品、前后端、业务人员基于同一套注解模型开展工作——产品设计UI即定义注解属性，前端无需二次转换，后端直接基于注解开发业务逻辑，实现“一套模型，多角色复用”，大幅降低沟通成本。</li>
</ol>
<h3 data-id="heading-11">技术取舍：可视化效率与设计灵活性的平衡</h3>
<p><strong>核心优势</strong>：</p>
<ul>
<li>多角色协同效率大幅提升，据统计可降低80%以上的沟通成本，避免因理解偏差导致的返工；</li>
<li>图生代码能力强，设计稿可直接转换为可运行的全栈代码，可用性远超传统可视化工具；</li>
<li>强类型约束确保了代码质量和业务一致性，减少了“设计好看但无法落地”的问题。</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>可视化工具的成熟度有待提升，相比Figma、Axure等专业设计工具，在设计细节、交互体验上存在差距；</li>
<li>复杂交互场景的可视化支持有限，对于需要自定义动画、特殊交互逻辑的场景，仍需手动编写注解和代码；</li>
<li>对设计规范要求较高，需要团队严格遵循Ooder的组件设计规范，否则会影响可视化到代码的转换效率。</li>
</ul>
<h2 data-id="heading-12">四、核心之问四：Ooder嵌套组件化与React/Vue的组件化，本质区别在哪？</h2>
<h3 data-id="heading-13">本质差异：传统组件化的跨域协同困境与Ooder的突破方向</h3>
<p>组件化的核心目标是“无限细分”，通过拆分复杂功能提升代码复用性和维护性。但传统前端组件化（React/Vue）存在明显的领域局限：其一，仅局限于前端UI领域，无法跨越前端边界，实现与后端服务、业务逻辑、用户行为的深度协同；其二，跨域协同需要额外的接口、状态管理机制，增加了架构复杂度；其三，单一领域的组件化理论难以处理全栈场景的需求，导致设计过度复杂，反而降低了开发效率。</p>
<p>Ooder提出“跨领域的嵌套组件化”设计，与React/Vue的组件化存在明显差异。二者的本质区别究竟是什么？</p>
<h3 data-id="heading-14">差异解析：核心在于“跨领域协同”与“A2UI适配性”</h3>
<p>Ooder的嵌套组件化与React/Vue的前端组件化存在本质差异，这种差异贯穿设计理念、实现机制、渲染方式等核心层面，具体对比可拆解为四点：</p>
<ol>
<li><strong>设计理念：跨领域协同 vs 前端局限</strong>：Ooder的组件化是“跨领域”的，突破了前端UI的边界，支持将前端组件、后端服务、业务逻辑、用户行为封装为统一的组件单元，实现多领域的协同；而React/Vue的组件化仅局限于前端UI领域，后端服务、业务逻辑需要通过外部接口对接，无法与组件深度融合。</li>
<li><strong>实现机制：接口+注解声明式 vs 模板/JSX声明式</strong>：Ooder采用“接口+注解”的声明式组件设计，通过定义组件接口和注解属性，明确组件的行为、样式、属性、事件（四分离设计）；而React/Vue采用模板或JSX的声明式设计，组件的样式、逻辑、属性往往混合在模板中，后端无法感知组件的完整定义。</li>
<li><strong>渲染方式：静态模板渲染 vs 动态渲染</strong>：Ooder采用“后端输出JSON+前端模板渲染”的静态渲染方式，后端通过注解解析生成标准化的JSON数据，前端仅负责根据JSON渲染组件，逻辑相对简单；而React/Vue采用动态渲染方式，模板中包含大量逻辑判断、状态绑定，后端无法感知前端的渲染逻辑，前后端协同成本高。</li>
<li><strong>A2UI适配性：天然适配 vs 额外适配</strong>：Ooder的结构化组件设计（接口+注解）便于大模型解析和生成，能够直接接收AI的指令生成跨领域组件；而React/Vue的动态模板设计需要额外的转换机制，才能让AI理解组件的逻辑和结构，A2UI适配成本高。</li>
</ol>
<h3 data-id="heading-15">技术取舍：全栈复用与动态灵活性的平衡</h3>
<p><strong>核心优势</strong>：</p>
<ul>
<li>真正实现“无限细分”的组件化目标，跨领域组件可在不同项目、不同场景中复用，大幅提升开发效率；</li>
<li>结构化设计完美适配A2UI模式，为AI生成全栈组件提供了清晰的技术载体，降低了自动化开发的难度；</li>
<li>全栈组件化消除了前后端协同的“壁垒”，让组件同时包含UI、业务、数据逻辑，减少了接口适配、数据校验等重复工作。</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>学习曲线陡峭，开发者需要具备全栈思维，同时掌握接口设计、注解使用、前后端开发等多领域知识；</li>
<li>在动态交互场景的灵活性上不如React/Vue，对于需要频繁修改组件逻辑、动态调整UI的场景，开发效率较低；</li>
<li>组件生态相对薄弱，相比React/Vue丰富的开源组件库，Ooder的可复用组件资源较少，定制化开发成本较高。</li>
</ul>
<h2 data-id="heading-16">总结：Ooder架构的技术定位与适用场景</h2>
<p>深入梳理Ooder架构的设计逻辑不难发现：其所有设计取舍，都围绕着“适配A2UI模式”“降低全栈协同成本”这两个核心目标。它并非要替代React/Vue等传统前端框架，而是为大模型时代的全栈开发提供了一种全新的技术选择。</p>
<p>从技术定位来看，Ooder架构更适合CN环境下的企业级应用开发——尤其是表单密集型系统、后台管理系统、低代码/零代码平台等场景，其A2UI适配性强、全栈协同效率高的优势能够得到充分发挥。而对于需要复杂动态交互、高度定制化UI的场景（如C端应用、可视化大屏），React/Vue仍具备不可替代的优势。</p>
<p>对于开发团队而言，选择Ooder架构需要权衡其核心优势与迁移成本：如果团队聚焦企业级B端开发，且希望借助A2UI提升开发效率、降低全栈协同成本，那么Ooder架构值得尝试；如果团队长期深耕C端场景，或对动态交互灵活性要求极高，则建议继续沿用React/Vue生态。</p>
<p>从技术发展趋势来看，随着大模型技术的不断成熟和A2UI模式的普及，全栈一体化、注解驱动、跨领域组件化将成为企业级开发的重要演进方向。Ooder架构作为这一方向的先行者，虽然仍面临生态建设、工具成熟度等挑战，但未来可期。</p>
<p><strong>技术实践建议</strong>：学习和落地Ooder架构，建议从简单的企业级表单、后台管理项目入手，先掌握核心注解体系和混合架构的基本原理；同时关注Ooder生态的发展，积极参与社区建设，通过实践积累可复用的组件和解决方案。对于团队而言，可采用“渐进式迁移”策略，先将部分标准化模块用Ooder重构，验证其效果后再逐步推广，降低技术迁移风险。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[预先构建的CNCF流水线：从Git到在Kubernetes上运行]]></title>    <link>https://juejin.cn/post/7587997893987893275</link>    <guid>https://juejin.cn/post/7587997893987893275</guid>    <pubDate>2025-12-26T13:58:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587997893987893275" data-draft-id="7587632484427808819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="预先构建的CNCF流水线：从Git到在Kubernetes上运行"/> <meta itemprop="keywords" content="人工智能,云计算"/> <meta itemprop="datePublished" content="2025-12-26T13:58:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AKAMAI"/> <meta itemprop="url" content="https://juejin.cn/user/829502942352628"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            预先构建的CNCF流水线：从Git到在Kubernetes上运行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/829502942352628/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AKAMAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T13:58:21.000Z" title="Fri Dec 26 2025 13:58:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Kubernetes 为大规模运行容器提供了可能，但并未使其变得简单。</p>
<p>交付一个应用远不止执行一句 kubectl apply 那么简单。在代码真正触及集群之前，需要构建镜像、扫描漏洞、串接配置、实施策略、组装CI/CD流水线，并接入日志、监控与追踪体系。每一步都涉及工具的选型、集成，并在技术生态持续演进中维护这些集成的稳定性。</p>
<p>这些事固然能做到，却异常繁琐。它们会不断分散你的精力，让你偏离真正的核心目标：交付可靠软件，而非与底层平台搏斗。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fproducts%2Fapp-platform%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251226_external1_blogarticles239" target="_blank" title="https://www.akamai.com/zh/products/app-platform?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251226_external1_blogarticles239" ref="nofollow noopener noreferrer">LKE的应用平台</a>通过一套预先设计、完全集成的流水线消除了这类负担。该流水线完全基于开源的云原生计算基金会（CNCF）工具构建。从工程师将代码提交至Git仓库开始，到应用在生产环境稳定运行结束——策略管控、安全合规与可观测能力均已内置其中——整个过程自动化贯通，各环节无缝衔接，真正做到开箱即用。</p>
<p>本文将深入解析应用平台的运作机制，并展示它如何大幅简化从代码提交到生产上线的路径。</p>
<h4 data-id="heading-0"><strong><strong>应用平台实现自动化</strong></strong></h4>
<p>LKE的应用平台通过自动构建、保护、部署和监控您的容器化应用与服务，简化了从源代码到生产环境的完整应用生命周期。凭借内置的集成流水线、策略和可观测性，平台和DevOps团队获得了统一标准且合规的工作流程，可以将应用投入生产，而无需管理复杂的工具链。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c42757701b0437285c0b74b66485a0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUtBTUFJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362485&amp;x-signature=IGQUSJbHGEqzuhrsIUJqR%2F7t0js%3D" alt="" loading="lazy"/></p>
<p>为了展示应用平台消除了多少复杂性，让我们通过其内置集成功能，逐步了解它端到端自动化的10个步骤。</p>
<p>这10个步骤分为三大类：</p>
<ol>
<li>代码</li>
<li>从代码到生产</li>
<li>应用发布——暴露与可观测性</li>
</ol>
<h4 data-id="heading-1"><strong><strong>代码</strong></strong></h4>
<p><strong><strong>步骤 1：监听Git事件</strong></strong></p>
<p>应用平台直接连接到您的<strong><strong>Git代码仓库</strong></strong>，并持续监控来自特定分支的提交和拉取请求。当推送代码时，平台会检测到该事件并自动触发流水线，无需配置Webhook或手动设置CI。</p>
<h4 data-id="heading-2"><strong><strong>从代码到生产</strong></strong></h4>
<p>这是预配置工具链发挥最大价值的地方。在一个需要自己动手搭建的平台中，连接这些工具需要数周的集成工作。而在这里，它们开箱即用，协同工作。</p>
<p><strong><strong>步骤 2：使用Grype扫描源代码</strong></strong></p>
<p>Grype是一个针对容器镜像和文件系统的漏洞扫描器，可识别库、包和框架中的已知风险。</p>
<p>Grype已在应用平台中预先配置，用于对照CVE数据库和安全公告进行检查，并在工作流程早期暴露问题。它为开发人员提供了更快的反馈，并在漏洞进入构建阶段之前降低了修复成本。</p>
<p><strong><strong>步骤 3：构建镜像</strong></strong></p>
<p>一旦源代码通过安全验证，平台会自动使用标准Dockerfile或Buildpacks构建您的容器镜像。构建环境经过优化，具有以下特点：</p>
<ul>
<li>分层缓存以加速迭代</li>
<li>支持多阶段构建，以生成更小、更高效的镜像</li>
<li>内置资源限制，防止失控的构建</li>
</ul>
<p>这确保了镜像创建的一致性和可重复性，无需额外的配置或流水线维护。</p>
<p><strong><strong>步骤 4：使用Harbor存储镜像并用Trivy扫描</strong></strong></p>
<p>新构建的镜像将存放在其专属的私有容器注册表中，该注册表由Harbor提供——一个企业级容器注册表，预先配置了基于角色的访问控制、镜像签名和保留策略。镜像到达的瞬间，Trivy就会对完整的容器进行深度安全扫描：基础层、操作系统包、应用依赖项和配置文件。</p>
<p>应用平台将Trivy配置为持续扫描，不仅针对初次上传的镜像，更会在新漏洞披露时，自动对现有镜像重新扫描。这确保能及时发现新威胁，而无需依赖任何手动扫描计划。</p>
<p><strong><strong>步骤 5：通过应用目录——黄金路径模板创建配置</strong></strong></p>
<p>应用平台使用基于Kubernetes最佳实践预先设计的配置模板。从而大幅减少手工编写YAML的复杂度，并支持在需要时仍可对配置进行细化调整。</p>
<p><strong><strong>步骤 6：使用Kyverno检查安全策略</strong></strong></p>
<p>在任何部署到达您的集群之前，预先配置的Kyverno会强制或审计安全策略。强制执行策略将阻止清单被部署。</p>
<p>这些规则可以根据组织需求或添加框架进行自定义，但集成本身已经完成。</p>
<p><strong><strong>步骤 7：使用Argo CD进行部署</strong></strong></p>
<p>Argo CD基于GitOps原则管理到Kubernetes集群的部署。经过验证的Git清单成为唯一事实来源，Argo CD会自动同步集群状态。</p>
<p>应用平台已预先配置Argo CD，具有以下特性：Git变更时自动同步、集群状态变化时自我修复，以及部署失败时自动回滚。</p>
<p><strong><strong>步骤 8：使用Trivy进行运行时扫描</strong></strong></p>
<p>部署后，Trivy会对运行的容器进行运行时扫描，检查部署后出现的漏洞以及引入风险的配置更改。这种运行时扫描在后台持续运行，不影响应用性能。</p>
<h4 data-id="heading-3"><strong><strong>应用发布——暴露与可观测性</strong></strong></h4>
<p><strong><strong>步骤 9：使用NGINX和Istio暴露服务</strong></strong></p>
<p>应用平台使用预先配置的NGINX Ingress Controller和Istio服务网格来处理流量路由和安全连接。NGINX提供外部入口，具备自动TLS证书管理、速率限制和流量路由规则。</p>
<p>Istio处理集群内的服务到服务通信，预先配置了双向TLS用于安全通信、用于金丝雀部署的流量管理以及用于调试微服务的分布式追踪。</p>
<p><strong><strong>步骤 10：使用Prometheus监控服务可用性</strong></strong></p>
<p>Prometheus 提供可观测性，预先配置为从您的应用、Kubernetes基础设施和平台工具中抓取指标。您可以立即获得应用性能、资源利用率、错误率和延迟的可见性。</p>
<p>该集成包括预构建的仪表板、针对关键问题的告警规则以及与 Grafana 的连接以进行可视化。</p>
<h4 data-id="heading-4"><strong><strong>开源，无锁定</strong></strong></h4>
<p>此流水线中的每一个工具—— Grype、 Harbor、 Trivy、 Kyverno、 Argo CD、 NGINX、Istio和 Prometheus——都直接来自CNCF生态系统。这些不是专有的实现或供应商的分支，而是经过配置和集成的实际开源项目。</p>
<p>应用平台完成了所有的集成和自动化工作，以及工具的持续维护，因此用户可以专注于应用程序的开发。</p>
<p>部署制品保持可移植性。Kubernetes清单可以在任何集群上工作。Harbor中的容器镜像可以迁移到任何符合开放容器计划（OCI）标准的注册表。Kyverno策略是标准的YAML文件，在任何运行Kyverno的地方都有效。</p>
<p>应用平台通过预先配置和集成来增加价值，而不是通过创建锁定的专有扩展。</p>
<h4 data-id="heading-5"><strong><strong>为什么预先设计工具链很重要</strong></strong></h4>
<p>使用应用平台与自行组装工具之间的区别，在于前者已将深厚的运维知识沉淀在配置之中。每个工具都包含数十个配置选项。单是正确配置其中一项已非易事，而让它们稳定协同工作则更是难上加难。</p>
<p>应用平台将这些生产级Kubernetes部署中的最佳实践编码固化：Trivy如何与Harbor深度集成、哪些Kyverno策略能精准捕捉关键风险、Argo CD如何智能执行回滚、哪些Prometheus指标真正决定系统健康。这些配置凝聚了数百个运维日夜的实战精华，最终浓缩为一个开箱即用、稳定可靠的基础平台。</p>
<h4 data-id="heading-6"><strong><strong>从数月到分钟</strong></strong></h4>
<p>若要自行构建这条流水线，您将不得不完成工具选型、系统集成、连接调试与版本适配等一系列复杂工作。平台团队通常需投入12至18个月才能达成生产就绪状态，此后还需持续投入资源进行维护与升级。</p>
<p>而应用平台让您一键获得完整能力：安全扫描自动执行，部署流程通过策略验证，服务以规范的流量管理策略对外暴露，监控系统无需配置即可实时采集指标。您无需耗费数月进行平台搭建，在第一天即可直接部署应用程序。</p>
<h4 data-id="heading-7"><strong><strong>生命周期管理</strong></strong></h4>
<p>通过全生命周期管理超过30个Kubernetes项目的复杂更新，应用平台将工程团队从繁重的维护工作中解放出来。它确保您的部署与上游开源版本自动同步，实现了可持续的技术演进。</p>
<p>您的团队无需再为手动升级耗费精力，转而享用一个始终最新、完全受控的平台。这不仅显著降低了技术债务，更从体系上保障了业务的长期稳定运行。</p>
<h4 data-id="heading-8"><strong><strong>开始使用</strong></strong></h4>
<p>LKE的应用平台运行在标准的LKE基础设施上，无需额外的许可费用。您只需为您使用的Kubernetes资源付费。</p>
<p>注册以部署您的第一个应用程序，或者阅读文档以探索平台架构并了解如何根据您的需求自定义平台。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linode.com%2Fzh%2F%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251226_external2_blogarticles239" target="_blank" title="https://www.linode.com/zh/?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251226_external2_blogarticles239" ref="nofollow noopener noreferrer">注册</a>以创建您的第一个集群</li>
<li>阅读文档以探索集成工具和功能</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在亚马逊云科技部署高可用MaxKB知识库应用]]></title>    <link>https://juejin.cn/post/7587776610436513807</link>    <guid>https://juejin.cn/post/7587776610436513807</guid>    <pubDate>2025-12-26T12:49:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587776610436513807" data-draft-id="7587743345197940788" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在亚马逊云科技部署高可用MaxKB知识库应用"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-26T12:49:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在亚马逊云科技部署高可用MaxKB知识库应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T12:49:19.000Z" title="Fri Dec 26 2025 12:49:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>MaxKB是一款基于RAG技术的开源知识库问答系统，支持对接多种大语言模型，广泛应用于智能客服、企业知识库等场景。虽然MaxKB社区版提供了便捷的Docker快速部署方式，但企业在生产环境中需要更高的可靠性、安全性和运维便利性。</p>
<p>本文介绍如何基于亚马逊云科技托管服务构建高可用MaxKB应用架构。方案采用AmazonECS运行容器化应用，配合RDS PostgreSQL（含pgvector扩展）和ElastiCache Valkey提供数据持久化和缓存能力，通过Application Load Balancer实现流量分发和多可用区部署，确保99.9%以上的服务可用性。方案还集成了Secrets Manager进行密钥管理，支持对接Amazon Bedrock模型服务。</p>
<p>本文面向需要在生产环境部署企业级AI知识库的架构师和运维工程师，提供从架构设计、服务配置到部署验证的完整实施指南。</p>
<blockquote>
<p>📢限时插播：无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。</p>
<p>⏩快快点击进入《<a href="https://link.juejin.cn?target=https%3A%2F%2Fevents.amazoncloud.cn%2Flabs%2Fcloudlab-amazon-bedrock-first-experience%3Fvisitfrom%3D3P_Juejinhead_1223%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejinhead_1223" target="_blank" title="https://events.amazoncloud.cn/labs/cloudlab-amazon-bedrock-first-experience?visitfrom=3P_Juejinhead_1223&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejinhead_1223" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》实验构建无限, 探索启程！</p>
</blockquote>
<h2 data-id="heading-1">方案价值</h2>
<h3 data-id="heading-2">MaxKB核心能力¹</h3>
<p>MaxKB是基于RAG（检索增强生成）技术的开源知识库问答系统，自2024年4月发布以来，已获得19,000+ GitHub Stars，发展为企业级智能体平台。其核心能力包括：</p>
<ul>
<li><strong>开箱即用的RAG问答引擎</strong>：支持多格式文档导入（PDF、Word、Markdown等），自动文档解析、文本分块和向量化处理，答案支持富文本展示（图片、表格、图表等）；</li>
<li><strong>多模型灵活对接</strong>：基于开源架构，支持对接Amazon Bedrock托管模型及国内外主流大语言模型和Embedding模型服务，兼容标准API接口，可根据业务需求灵活选择和切换；</li>
<li><strong>工作流编排</strong>：内置工作流引擎和函数库，支持MCP工具调用，可编排复杂的AI Agent处理流程，实现多步骤任务自动化；</li>
<li><strong>快速集成</strong>：提供API接口和零编码嵌入方式，可快速集成到企业现有业务系统或第三方系统，降低企业开发和部署成本。</li>
</ul>
<p><strong>典型应用场景</strong>：智能客服（7×24小时自动问答）、企业知识库（内部知识管理和检索）、智能办公助手等。</p>
<h3 data-id="heading-3">亚马逊云科技托管方案的增强价值</h3>
<p>MaxKB社区版提供基于Docker Compose的快速部署方式，适合开发测试和小规模应用。但在企业生产环境中，面临单点故障风险、手动运维负担重、安全管理复杂等挑战。本方案基于亚马逊云科技托管服务，提供以下企业级增强能力：</p>
<h4 data-id="heading-4">1. 企业级高可用性</h4>
<ul>
<li><strong>多可用区架构、可用性SLA可达99.9%以上</strong>：应用层（ECS）、数据库层（RDS Multi-AZ）、缓存层（ElastiCache）均采用跨多可用区部署，RDS主节点故障时60-120秒内自动切换，ALB自动分发流量并剔除异常容器，保障整体架构可达99.9%以上的服务可用性，满足企业级应用要求；</li>
</ul>
<h4 data-id="heading-5">2. 弹性伸缩能力</h4>
<ul>
<li><strong>应用层自动扩缩容</strong>：面对业务流量波动的场景需求，ECS可根据资源使用率或请求数量规则自动调整任务数量；</li>
<li><strong>向量查询加速</strong>：RDS PostgreSQL + pgvector提供高性能向量检索，db.r8g.16xlarge规格下100并发可达毫秒级响应；</li>
<li><strong>缓存层在线扩展</strong>：ElastiCache支持在线添加节点，无需停机即可提升缓存容量</li>
</ul>
<h4 data-id="heading-6">3. 安全与合规</h4>
<ul>
<li><strong>密钥集中管理</strong>：Secrets Manager安全存储数据库凭证、API密钥等敏感信息，支持自动轮换，避免硬编码风险</li>
<li><strong>网络隔离</strong>：VPC私有子网部署数据库和缓存，仅应用层可访问，公网不可达</li>
<li><strong>细粒度权限控制</strong>：IAM角色和Security Group实现最小权限原则</li>
</ul>
<p><strong>适用场景</strong>：本方案特别适合需要在生产环境部署智能客服、企业知识库等AI应用的中大型企业，以及对可用性、安全性、合规性有较高要求的行业客户（如金融、医疗、政务等）。</p>
<h2 data-id="heading-7">解决方案概述</h2>
<p>本解决方案将MaxKB Docker托管运行在亚马逊云科技容器服务ECS上，并配置Amazon RDS for PostgresSQL和ElastiCache Valkey（兼容Redis），作为MaxKB的外部数据库，实现MaxKB应用的高可用架构。</p>
<h3 data-id="heading-8">架构设计</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F11%2F18%2Fhow-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-1.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/11/18/how-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-1.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33f096e2355240a68d42771d63dc0e54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767358159&amp;x-signature=Z3YiVPR0uH7ySNT%2BnQk7zNA4nV8%3D" alt="" loading="lazy"/></a></p>
<ol>
<li>
<p>用户通过互联网连接到应用程序，所有请求首先通过 <strong>Elastic Load Balancing</strong> 服务，确保流量均匀分布并提高系统可用性和容错能力。</p>
</li>
<li>
<p>负载均衡器将流量智能分配到 <strong>ECS集群</strong> 内的多个 <strong>Service Frontend</strong> 实例，实现请求的高效处理和资源的动态伸缩。ECS集群提供容器化环境，便于部署和管理应用服务。</p>
</li>
<li>
<p>应用程序内可以配置LLM模型和Embedding模型，支持访问Bedrock 的模型服务：</p>
<ul>
<li><strong>Bedrock LLM</strong>：提供大型语言模型服务</li>
<li><strong>Bedrock Embedding</strong>：提供文本嵌入服务</li>
</ul>
</li>
<li>
<p>系统与 <strong>Secrets Management</strong> 模块集成，通过 <strong>Secrets Manager</strong> 安全存储和管理应用所需的密钥、令牌、凭证等敏感信息，确保信息不被硬编码到应用中。</p>
</li>
<li>
<p>应用程序连接到 <strong>RDS PostgreSQL</strong> 数据库服务，PostgreSQL提供了强大的关系型数据库功能；同时在数据库安装了pgvector，使您能够直接在PostgreSQL 数据库中高效地存储、操作和分析向量数据。</p>
</li>
<li>
<p>架构引入了<strong>Amazon ElastiCache for Valkey</strong> 缓存层（兼容Redis 8.0），用于存储频繁访问的数据，减少数据库负载并提高应用响应速度。</p>
</li>
</ol>
<h3 data-id="heading-9">亚马逊云科技托管数据库的产品优势</h3>
<h4 data-id="heading-10">Amazon RDS for PostgresSQL</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Frds%2Fpostgresql%2Fwhat-is-postgresql%2F" target="_blank" title="https://aws.amazon.com/cn/rds/postgresql/what-is-postgresql/" ref="nofollow noopener noreferrer">PostgreSQL</a> 是许多企业开发人员和企业的首选<a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fproducts%2Fdatabases%2Fopen-source-databases%2F" target="_blank" title="https://aws.amazon.com/cn/products/databases/open-source-databases/" ref="nofollow noopener noreferrer">开源</a>关系数据库，为领先的商用和移动应用程序提供助力。Amazon RDS 让用户能够更轻松地在云中设置、操作和扩展 PostgreSQL 部署。借助 Amazon RDS，您可以在几分钟内完成可扩展的 PostgreSQL 部署，不仅经济实惠，而且可以调整硬件容量。Amazon RDS 除了具备托管的优势外，针对知识库应用场景也有明显的优势：<br/>
<strong>1.跨AZ强一致，保证主备数据一致性</strong><br/>
Amazon RDS  Multi-AZ 部署架构在存储层EBS采用物理同步复制机制，主节点写入操作同步到备节点后才返回确认，确保数据零丢失，满足知识库数据完整性要求。</p>
<p><strong>2.自动failover，保证系统可用性</strong><br/>
当Amazon RDS 主节点故障时，Multi-AZ支持自动failover到备节点，故障转移时间通常在 60-120 秒内完成，应用程序自动重连，无需人工干预，提供 99.95% 的可用性 SLA。</p>
<p><strong>3.vector向量查询性能高，读性能横向扩展</strong><br/>
PostgreSQL 支持 pgvector 扩展，在满足OLTP数据库正常的业务需求之外还可以提供向量存储和高并发检索的能力，满足多模态业务需求，另外RDS只读副本可以进行在线扩展，支持最多 15 个只读副本。在10TB以内，并且有高QPS需求的场景下，性价比优于Elasticsearch和Milvus。<br/>
如下是在Amazon RDS for PostgreSQL db.r8g.16xlarge规格下使用VectorDBBench进行100并发线程进行压测，每次压测时长300s，分别在Performance768D1M和Performance768D10M两种数据集下，不同ef_search下的性能表现：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F11%2F18%2Fhow-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-2.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/11/18/how-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-2.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70b5d4f3d4a744a8b4ecbb248ecc166c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767358159&amp;x-signature=B8NvjJmAB2C%2F%2B6QNtW%2Bf%2FnP%2Bk5s%3D" alt="" loading="lazy"/></a></p>
<h4 data-id="heading-11">ElastiCache for Valkey</h4>
<p>Valkey 是由 Linux 基金会支持的开源缓存数据库，保证了vendor的中立性，过去6个月，有50多万次container pull代码，几千个贡献，以及40多家公司的支持。亚马逊云科技作为Valkey的主要贡献之一，ElastiCache for Valkey不仅给客户带来稳定的方案，也能保证Valkey持续的创新。ElastiCache for Valkey的主要优势如下：</p>
<p><strong>性价比提升</strong></p>
<ol>
<li>单点处理能力增强，采用IO线程多路复用技术，吞吐量增加72%和P99 耗时降低71%，可以达到1.2M QPS读取性能，用户可以用更少节点数量或者更小机型来支撑同样规模应用。</li>
<li>托管的ElastiCache for Valkey 8.0优化了内存结构，单节点上可以存储更多的数据（相同数据存储空间占用减少20%）。</li>
</ol>
<p><strong>客户端兼容性高</strong></p>
<ol>
<li>已有客户端访问Valkey，接口和redis 7.2 兼容，jedis、redis-benchmark、rediscluster、K6等。</li>
<li>Valkey-glide作为亚马逊云科技贡献的开源客户端，与python/Java/node.js/golang 多种客户端提供一致能力，支持更好failover以及连接池管理等。</li>
</ol>
<p><strong>其他增强</strong></p>
<ol>
<li>Valkey8.0 主从复制效率大幅提升，RDB和复制backlog的双通路实现，可以加快sync速度，单独进程处理RDB复制可以减少对主节点影响。</li>
<li>resharding 重分片期间抗主节点故障能力增强。</li>
<li>提供slot级别指标，提供更好可观测性。</li>
</ol>
<h2 data-id="heading-12">MaxKB on Amazon解决方案部署指南</h2>
<h3 data-id="heading-13">部署要求</h3>
<p>MaxKB应用部署要求包括：</p>
<ul>
<li>操作系统：Ubuntu 22.04 / CentOS 7（内核版本要求 ≥ 3.10）</li>
<li>CPU/内存：4C/8GB 以上</li>
<li>磁盘空间：100GB</li>
<li>PostgrsSQL：17.6版本</li>
<li>Redis：8.0版本</li>
</ul>
<p>在亚马逊云科技部署之前，您需要有一个可访问的亚马逊云科技账户，部署的主要资源包括：</p>
<ul>
<li>Amazon VPC</li>
<li>Amazon RDS for postgreSQL</li>
<li>Amazon ElastiCache for Valkey</li>
<li>Amazon ECS</li>
<li>Amazon ALB</li>
</ul>
<h3 data-id="heading-14">CDK部署方式</h3>
<p>为了简化高可用架构的部署流程，我们提供了基于Amazon CDK（Cloud Development Kit）的一键部署代码和脚本：通过基础设施即代码（IaC）的方式，能够自动处理资源间的依赖关系，一条命令即可完成VPC、RDS、ElastiCache、ECS、ALB等所有组件的创建和配置，无需手动在控制台操作多个服务，大幅降低部署复杂度和人为错误，显著提高部署成功率和运维效率。</p>
<p>以下部署命令请在Linux环境运行。</p>
<p><strong>1、从github下载MaxKB-on-Amazon部署代码</strong></p>
<p>运行以下命令下载部署代码包：</p>
<pre><code class="hljs language-Bash" lang="Bash">git <span class="hljs-built_in">clone</span> https://github.com/supinyu/sample-maxkb-on-aws.git
</code></pre>
<p><strong>2、安装Docker</strong></p>
<pre><code class="hljs language-bash" lang="bash">sudo yum install docker python3-pip git npm -y

<span class="hljs-comment"># Configure Docker Components</span>
sudo systemctl <span class="hljs-built_in">enable</span> docker

sudo systemctl start docker

sudo usermod -aG docker <span class="hljs-variable">$USER</span>

newgrp docker
</code></pre>
<p><strong>3、安装aws cdk</strong></p>
<pre><code class="hljs">sudo npm install -g aws-cdk
</code></pre>
<p><strong>4、安装相关的npm包</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> 20251020-hex-cdk

npm install aws-cdk-lib
</code></pre>
<p><strong>5、账号信息及部署Region ID导入到环境变量中</strong></p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">AWS_ACCOUNT_ID</span>=XXXXXXXXXXXX
export <span class="hljs-attr">AWS_REGION</span>=us-west-<span class="hljs-number">2</span>
</code></pre>
<p><strong>6、进行CDK部署</strong></p>
<pre><code class="hljs language-perl" lang="perl">cdk bootstrap aws:<span class="hljs-regexp">//</span>$AWS_ACCOUNT_ID/$AWS_REGION

cdk deploy HexRagCdkStack --<span class="hljs-keyword">require</span>-approval never
</code></pre>
<p>以上部署过程通常需要15-20分钟，CDK会自动完成以下操作：</p>
<ul>
<li>创建VPC和子网</li>
<li>配置安全组规则</li>
<li>部署RDS PostgreSQL数据库（含pgvector扩展）</li>
<li>部署ElastiCache Valkey集群</li>
<li>创建ECS集群和任务定义</li>
<li>配置ALB负载均衡器</li>
<li>设置Secrets Manager密钥管理</li>
<li>配置自动扩展策略</li>
</ul>
<p><strong>7、</strong> <strong>验证部署</strong></p>
<p>部署完成后，CDK会输出ALB的DNS地址，通过该地址即可访问MaxKB应用：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 输出示例</span>
<span class="hljs-attr">RagCdkStack.LoadBalancerDNS</span> = RagCdkStack-ALB-XXXXXXXXXX.us-west-<span class="hljs-number">2</span>.elb.amazonaws.com
</code></pre>
<p><strong>8、版本更新</strong></p>
<p>如需更新MaxKB版本（比如从maxkb-v2.1.1升级到maxkb-v2.x.x），只需修改Dockerfile中对应的MaxKB镜像版本号，然后重新执行部署命令：</p>
<pre><code class="hljs language-php" lang="php">cdk deploy HexRagCdkStack —<span class="hljs-keyword">require</span>-approval <span class="hljs-keyword">never</span>
</code></pre>
<p>CDK会自动检测变更并仅更新受影响的资源，实现零停机滚动更新。</p>
<h2 data-id="heading-15">MaxKB应用效果</h2>
<p>这里我们以一个对话问答助手为例，演示MaxKB的使用效果。</p>
<h3 data-id="heading-16">支持Bedrock模型</h3>
<p>首先需要添加LLM模型和Embedding模型，MaxKB 支持Bedrock模型，可以在模型配置页面进行添加，具体的操作如下：</p>
<p><strong>1、添加LLM模型</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F11%2F18%2Fhow-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-3.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/11/18/how-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-3.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78d19796ef844306a84d9ffd31374631~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767358159&amp;x-signature=iGiNXHRAP%2Bgvi%2FsZVQRkkR5Lmsc%3D" alt="" loading="lazy"/></a></p>
<p><strong>2、添加Embedding模型</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F11%2F18%2Fhow-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-4.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/11/18/how-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-4.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dce3e385eecd4734b0c645616f4ac617~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767358159&amp;x-signature=BhXzvuu4teXVcfNd4gYqAkpAsL4%3D" alt="" loading="lazy"/></a></p>
<p><strong>3、知识库创建</strong></p>
<p>接下来，我们创建知识库</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F11%2F18%2Fhow-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-5.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/11/18/how-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-5.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ca4072cfa7b44d98dbccb2cd3c41b17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767358159&amp;x-signature=UmIdHaFVIlUFiiXbFzPRZCSy75g%3D" alt="" loading="lazy"/></a></p>
<p><strong>4、上传需要问答的pdf文档</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F11%2F18%2Fhow-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-6.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/11/18/how-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-6.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cf31472460f4ee9bfcedd1248d0ec47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767358159&amp;x-signature=V9JQwjAvWzFUPuJzMjOjvQchICg%3D" alt="" loading="lazy"/></a></p>
<p><strong>5、创建知识库问答助手</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F11%2F18%2Fhow-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-7.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/11/18/how-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-7.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2478d207fe644690a022c1b80c96f9cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767358159&amp;x-signature=zKklZvXxZjGGuQyHMeY4tiRmXWE%3D" alt="" loading="lazy"/></a></p>
<p>在创建对话助手页面，可以配置对话流程，MaxKB具有灵活的流程配置功能。配置完成，用户可以针对对话流程进行调试和发布。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F11%2F18%2Fhow-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-8.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/11/18/how-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-8.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f470212e4a134e4c90ce4dbec0791e45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767358159&amp;x-signature=AsU7%2FiIPo5siz%2BIZJv9Bf8uCOO0%3D" alt="" loading="lazy"/></a></p>
<p>对话助手发布之后，我们可以进行相关的问答。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F11%2F18%2Fhow-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-9.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/11/18/how-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-9.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/876391d5bfb5430c8a125c10e79faa56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767358159&amp;x-signature=x0DMJMAnoIIYSu%2FEN%2FTcT5VeqjM%3D" alt="" loading="lazy"/></a></p>
<p>在管理界面，我们也可以对相关的数据进行统计监控。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F11%2F18%2Fhow-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-10.png" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/11/18/how-to-deploy-highly-available-maxkb-knowledge-base-application-on-aws-10.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c5aeba0df8b411b894043b537692c4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767358159&amp;x-signature=SMZhqhOWXqVlxIvymwRdYO9BfwE%3D" alt="" loading="lazy"/></a></p>
<h2 data-id="heading-17">总结</h2>
<p>本方案通过将MaxKB社区版迁移部署在亚马逊云科技托管服务上，构建了高可用、可扩展的RAG知识库应用，实现了从单机Docker部署向企业级云原生架构的转型，为企业知识管理和智能问答场景提供了完整的技术解决方案。</p>
<p><strong>参考资料</strong></p>
<p>[1] MaxKB on Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F1Panel-dev%2FMaxKB" target="_blank" title="https://github.com/1Panel-dev/MaxKB" ref="nofollow noopener noreferrer">github.com/1Panel-dev/…</a><br/>
[2] MaxKB社区版下载：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcommunity.fit2cloud.com%2F%23%2Fproducts%2Fmaxkb%2Fdownloads" target="_blank" title="https://community.fit2cloud.com/#/products/maxkb/downloads" ref="nofollow noopener noreferrer">community.fit2cloud.com/#/products/…</a><br/>
[3] MaxKB离线安装文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmaxkb.cn%2Fdocs%2Fv2%2Finstallation%2Foffline_installtion%2F" target="_blank" title="https://maxkb.cn/docs/v2/installation/offline_installtion/" ref="nofollow noopener noreferrer">maxkb.cn/docs/v2/ins…</a></p>
<p>*<em>前述特定亚马逊云科技生成式人工智能相关的服务目前在亚马逊云科技海外区域可用。亚马逊云科技中国区域相关云服务由西云数据和光环新网运营，具体信息以中国区域官网为准。</em></p>
<p><strong>本篇作者</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2571021434b4868a9726df313d6788c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767358159&amp;x-signature=zZok5tiwKuJvpml6n%2B0cn6ObVFY%3D" alt="11.webp" loading="lazy"/></p>
<blockquote>
<p>本期最新实验《<a href="https://link.juejin.cn?target=https%3A%2F%2Fevents.amazoncloud.cn%2Flabs%2Fcloudlab-amazon-bedrock-first-experience%3Fvisitfrom%3D3P_Juejintail_1223%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_1223" target="_blank" title="https://events.amazoncloud.cn/labs/cloudlab-amazon-bedrock-first-experience?visitfrom=3P_Juejintail_1223&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_1223" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>⏩️[<a href="https://link.juejin.cn?target=https%3A%2F%2Fevents.amazoncloud.cn%2Flabs%2Fcloudlab-amazon-bedrock-first-experience%3Fvisitfrom%3D3P_Juejintail_1223%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_1223" target="_blank" title="https://events.amazoncloud.cn/labs/cloudlab-amazon-bedrock-first-experience?visitfrom=3P_Juejintail_1223&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_1223" ref="nofollow noopener noreferrer">点击进入实验</a>] 即刻开启  AI 开发之旅
构建无限, 探索启程！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter组件封装：视频播放组件全局封装]]></title>    <link>https://juejin.cn/post/7588028859540291610</link>    <guid>https://juejin.cn/post/7588028859540291610</guid>    <pubDate>2025-12-26T12:52:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588028859540291610" data-draft-id="7582777037864190002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter组件封装：视频播放组件全局封装"/> <meta itemprop="keywords" content="前端,Flutter"/> <meta itemprop="datePublished" content="2025-12-26T12:52:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SoaringHeart"/> <meta itemprop="url" content="https://juejin.cn/user/3544481219481374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter组件封装：视频播放组件全局封装
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3544481219481374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SoaringHeart
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T12:52:52.000Z" title="Fri Dec 26 2025 12:52:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、需求来源</h2>
<p>最近要开发一个在线视频播放的功能，每次实时获取播放，有些卡顿和初始化慢的问题，就随手优化一下。</p>
<h2 data-id="heading-1">二、使用示例</h2>
<p>1、数据源</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VideoDetailsProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChangeNotifier</span> </span>{

    <span class="hljs-comment">/// 当前播放中的</span>
    <span class="hljs-keyword">final</span> _videoModelController = <span class="hljs-type">StreamController</span>&lt;<span class="hljs-type">VideoDetailModel</span>?&gt;.broadcast();

    <span class="hljs-comment">/// 当前播放中 Stream&lt;VideoDetailModel&gt;</span>
    <span class="hljs-type">Stream</span>&lt;<span class="hljs-type">VideoDetailModel</span>?&gt; get videoModelStream =&gt; _videoModelController.stream;


    <span class="hljs-comment">/// 点击（model不为空时播放，为空时关闭）</span>
    sinkModelForVideoPlayer({required <span class="hljs-type">VideoDetailModel</span>? model}) {
      _videoModelController.add(model);
    }

}
</code></pre>
<p>2、显示播放器组件</p>
<pre><code class="hljs language-php" lang="php">StreamBuilder&lt;VideoDetailModel<span class="hljs-meta">?&gt;</span>(
  stream: provider.videoModelStream,
  builder: (context, snapshot) {
    <span class="hljs-keyword">if</span> (snapshot.data == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SizedBox</span>();
    }
    <span class="hljs-keyword">final</span> model = snapshot.data;
    <span class="hljs-keyword">if</span> (model?.isVideo != <span class="hljs-literal">true</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SizedBox</span>();
    }

    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">SafeArea</span>(
      <span class="hljs-attr">top</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">bottom</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">left</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">right</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">child</span>: <span class="hljs-title function_ invoke__">Container</span>(
        <span class="hljs-attr">decoration</span>: <span class="hljs-title function_ invoke__">BoxDecoration</span>(
          <span class="hljs-attr">color</span>: Colors.black,
        ),
        <span class="hljs-attr">child</span>: <span class="hljs-title function_ invoke__">AppVideoPlayer</span>(
          <span class="hljs-attr">key</span>: <span class="hljs-title function_ invoke__">Key</span>(model?.url ?? <span class="hljs-string">""</span>),
          <span class="hljs-attr">url</span>: model?.url ?? <span class="hljs-string">""</span>,
          <span class="hljs-attr">onFullScreen</span>: (value) async {
            <span class="hljs-keyword">if</span> (!value) {
              await Future.<span class="hljs-title function_ invoke__">delayed</span>(<span class="hljs-keyword">const</span> <span class="hljs-title function_ invoke__">Duration</span>(<span class="hljs-attr">milliseconds</span>: <span class="hljs-number">300</span>));//等待旋转完成
              SystemChromeExt.<span class="hljs-title function_ invoke__">changeDeviceOrientation</span>(<span class="hljs-attr">isPortrait</span>: <span class="hljs-literal">true</span>);
            }
          },
          <span class="hljs-attr">onClose</span>: () {
            DLog.<span class="hljs-title function_ invoke__">d</span>(<span class="hljs-string">"close"</span>);
            provider.<span class="hljs-title function_ invoke__">sinkModelForVideoPlayer</span>(<span class="hljs-attr">model</span>: <span class="hljs-literal">null</span>);
          },
        ),
      ),
    );
  },
)
</code></pre>
<h2 data-id="heading-2">三、源码</h2>
<h4 data-id="heading-3">1、AppVideoPlayer.dart</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">//</span>
<span class="hljs-comment">//  AppVideoPlayer.dart</span>
<span class="hljs-comment">//  flutter_templet_project</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//  Created by shang on 2025/12/12 18:11.</span>
<span class="hljs-comment">//  Copyright © 2025/12/12 shang. All rights reserved.</span>
<span class="hljs-comment">//</span>

<span class="hljs-keyword">import</span> <span class="hljs-string">'package:chewie/chewie.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_templet_project/basicWidget/AppVideoPlayer/AppVideoPlayerService.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_templet_project/extension/extension_local.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:video_player/video_player.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">播放器</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppVideoPlayer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> AppVideoPlayer({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">this</span>.controller,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.url,
    <span class="hljs-keyword">this</span>.autoPlay = <span class="hljs-keyword">true</span>,
    <span class="hljs-keyword">this</span>.looping = <span class="hljs-keyword">false</span>,
    <span class="hljs-keyword">this</span>.aspectRatio = <span class="hljs-number">16</span> / <span class="hljs-number">9</span>,
    <span class="hljs-keyword">this</span>.isPortrait = <span class="hljs-keyword">true</span>,
    <span class="hljs-keyword">this</span>.fullScreenVN,
    <span class="hljs-keyword">this</span>.onFullScreen,
    <span class="hljs-keyword">this</span>.onClose,
  });

  <span class="hljs-keyword">final</span> AppVideoPlayerController? controller;

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> url;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> autoPlay;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> looping;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> aspectRatio;

  <span class="hljs-comment">/// <span class="markdown">设备方向</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isPortrait;

  <span class="hljs-keyword">final</span> ValueNotifier&lt;<span class="hljs-built_in">bool</span>&gt;? fullScreenVN;

  <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">bool</span> isFullScreen)? onFullScreen;

  <span class="hljs-keyword">final</span> VoidCallback? onClose;

  <span class="hljs-meta">@override</span>
  State&lt;AppVideoPlayer&gt; createState() =&gt; _AppVideoPlayerState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_AppVideoPlayerState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">AppVideoPlayer</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">WidgetsBindingObserver</span>, <span class="hljs-title">AutomaticKeepAliveClientMixin</span> </span>{
  VideoPlayerController? _videoController;
  ChewieController? _chewieController;

  <span class="hljs-built_in">Duration</span> position = <span class="hljs-built_in">Duration</span>.zero;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    widget.controller?._detach(<span class="hljs-keyword">this</span>);
    WidgetsBinding.instance.removeObserver(<span class="hljs-keyword">this</span>);
    _onClose();
    <span class="hljs-comment">// 不销毁 VideoPlayerController，让全局复用</span>
    <span class="hljs-comment">// _chewieController?.dispose();</span>
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    widget.controller?._attach(<span class="hljs-keyword">this</span>);
    WidgetsBinding.instance.addObserver(<span class="hljs-keyword">this</span>);
    WidgetsBinding.instance.addPostFrameCallback((_) {
      initPlayer();
    });
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didChangeAppLifecycleState(AppLifecycleState state) {
    <span class="hljs-keyword">switch</span> (state) {
      <span class="hljs-keyword">case</span> AppLifecycleState.inactive:
      <span class="hljs-keyword">case</span> AppLifecycleState.hidden:
      <span class="hljs-keyword">case</span> AppLifecycleState.paused:
        {
          _chewieController?.pause();
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> AppLifecycleState.detached:
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> AppLifecycleState.resumed:
        {
          _chewieController?.play();
        }
        <span class="hljs-keyword">break</span>;
    }
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; initPlayer() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// DLog.d(widget.url.split("/").last);</span>
    <span class="hljs-keyword">assert</span>(widget.url.startsWith(<span class="hljs-string">"http"</span>), <span class="hljs-string">"url 错误"</span>);

    _videoController = <span class="hljs-keyword">await</span> AppVideoPlayerService.instance.getController(widget.url);

    _chewieController?.dispose();
    _chewieController = ChewieController(
      videoPlayerController: _videoController!,
      autoPlay: widget.autoPlay,
      looping: widget.looping,
      aspectRatio: widget.aspectRatio,
      autoInitialize: <span class="hljs-keyword">true</span>,
      allowFullScreen: <span class="hljs-keyword">true</span>,
      allowMuting: <span class="hljs-keyword">false</span>,
      showControlsOnInitialize: <span class="hljs-keyword">false</span>,
      <span class="hljs-comment">// customControls: const AppVideoControls(),</span>
    );

    _chewieController!.addListener(() {
      <span class="hljs-keyword">final</span> isFullScreen = _chewieController!.isFullScreen;
      widget.fullScreenVN?.value = isFullScreen;
      widget.onFullScreen?.call(isFullScreen);
      <span class="hljs-keyword">if</span> (isFullScreen) {
        DLog.d(<span class="hljs-string">"进入全屏"</span>);
      } <span class="hljs-keyword">else</span> {
        DLog.d(<span class="hljs-string">"退出全屏"</span>);
      }
    });
    <span class="hljs-keyword">if</span> (mounted) {
      setState(() {});
    }
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; _onClose() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (_videoController?.value.isPlaying == <span class="hljs-keyword">true</span>) {
      _videoController?.pause();
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didUpdateWidget(<span class="hljs-keyword">covariant</span> AppVideoPlayer oldWidget) {
    <span class="hljs-keyword">super</span>.didUpdateWidget(oldWidget);
    <span class="hljs-keyword">if</span> (oldWidget.url != widget.url) {
      initPlayer();
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didChangeDependencies() {
    <span class="hljs-keyword">super</span>.didChangeDependencies();

    <span class="hljs-comment">/// <span class="markdown">🔥屏幕横竖切换时 rebuild Chewie，但不 rebuild video</span></span>
    DLog.d([MediaQuery.of(context).orientation]);
    <span class="hljs-comment">// setState(() {});</span>
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">super</span>.build(context);
    <span class="hljs-keyword">if</span> (widget.url.startsWith(<span class="hljs-string">"http"</span>) != <span class="hljs-keyword">true</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> SizedBox();
    }

    <span class="hljs-keyword">if</span> (_chewieController == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Center(child: CircularProgressIndicator());
    }
    <span class="hljs-comment">// return Chewie(controller: _chewieController!);</span>
    <span class="hljs-keyword">return</span> Stack(
      children: [
        Positioned.fill(
          child: Chewie(
            controller: _chewieController!,
          ),
        ),
        Positioned(
          right: <span class="hljs-number">20</span>,
          top: <span class="hljs-number">10</span>,
          child: Container(
            <span class="hljs-comment">// decoration: BoxDecoration(</span>
            <span class="hljs-comment">//   color: Colors.red,</span>
            <span class="hljs-comment">//   border: Border.all(color: Colors.blue),</span>
            <span class="hljs-comment">// ),</span>
            child: buildCloseBtn(onTap: widget.onClose),
          ),
        ),
      ],
    );
  }

  Widget buildCloseBtn({VoidCallback? onTap}) {
    <span class="hljs-keyword">return</span> GestureDetector(
      behavior: HitTestBehavior.opaque,
      onTap: () {
        DLog.d(<span class="hljs-string">"buildCloseBtn"</span>);
        _onClose();
        <span class="hljs-keyword">if</span> (onTap != <span class="hljs-keyword">null</span>) {
          onTap();
          <span class="hljs-keyword">return</span>;
        }
        Navigator.pop(context);
      },
      child: Container(
        <span class="hljs-comment">// padding: EdgeInsets.all(6),</span>
        <span class="hljs-comment">// decoration: BoxDecoration(</span>
        <span class="hljs-comment">//   color: Colors.black54,</span>
        <span class="hljs-comment">//   shape: BoxShape.circle,</span>
        <span class="hljs-comment">//   border: Border.all(color: Colors.blue),</span>
        <span class="hljs-comment">// ),</span>
        child: <span class="hljs-keyword">const</span> Icon(Icons.close, color: Colors.white, size: <span class="hljs-number">24</span>),
      ),
    );
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> wantKeepAlive =&gt; <span class="hljs-keyword">true</span>;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppVideoPlayerController</span> </span>{
  _AppVideoPlayerState? _anchor;

  <span class="hljs-keyword">void</span> _attach(_AppVideoPlayerState anchor) {
    _anchor = anchor;
  }

  <span class="hljs-keyword">void</span> _detach(_AppVideoPlayerState anchor) {
    <span class="hljs-keyword">if</span> (_anchor == anchor) {
      _anchor = <span class="hljs-keyword">null</span>;
    }
  }

  VideoPlayerController? <span class="hljs-keyword">get</span> videoController {
    <span class="hljs-keyword">assert</span>(_anchor != <span class="hljs-keyword">null</span>);
    <span class="hljs-keyword">return</span> _anchor!._videoController;
  }

  ChewieController? <span class="hljs-keyword">get</span> chewieController {
    <span class="hljs-keyword">assert</span>(_anchor != <span class="hljs-keyword">null</span>);
    <span class="hljs-keyword">return</span> _anchor!._chewieController;
  }
}
</code></pre>
<h4 data-id="heading-4">2、AppVideoPlayerService.dart</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">//</span>
<span class="hljs-comment">//  AppVideoPlayerService.dart</span>
<span class="hljs-comment">//  flutter_templet_project</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//  Created by shang on 2025/12/12 18:10.</span>
<span class="hljs-comment">//  Copyright © 2025/12/12 shang. All rights reserved.</span>
<span class="hljs-comment">//</span>

<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_templet_project/extension/extension_local.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:quiver/collection.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:video_player/video_player.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">视频播放控制器全局管理</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppVideoPlayerService</span> </span>{
  AppVideoPlayerService._();
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> AppVideoPlayerService _instance = AppVideoPlayerService._();
  <span class="hljs-keyword">factory</span> AppVideoPlayerService() =&gt; _instance;
  <span class="hljs-keyword">static</span> AppVideoPlayerService <span class="hljs-keyword">get</span> instance =&gt; _instance;

  <span class="hljs-comment">/// <span class="markdown">播放器字典</span></span>
  LruMap&lt;<span class="hljs-built_in">String</span>, VideoPlayerController&gt; <span class="hljs-keyword">get</span> controllerMap =&gt; _controllerMap;
  <span class="hljs-comment">// final _controllerMap = &lt;String, VideoPlayerController&gt;{};</span>
  <span class="hljs-keyword">final</span> _controllerMap = LruMap&lt;<span class="hljs-built_in">String</span>, VideoPlayerController&gt;(maximumSize: <span class="hljs-number">10</span>);

  <span class="hljs-comment">/// <span class="markdown">最新使用播放器</span></span>
  VideoPlayerController? current;

  <span class="hljs-comment">/// <span class="markdown">有缓存控制器</span></span>
  <span class="hljs-built_in">bool</span> hasCtrl({<span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> url}) =&gt; _controllerMap[url] != <span class="hljs-keyword">null</span>;

  <span class="hljs-comment">/// <span class="markdown">是网络视频</span></span>
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> isVideo(<span class="hljs-built_in">String?</span> url) {
    <span class="hljs-keyword">if</span> (url?.isNotEmpty != <span class="hljs-keyword">true</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    <span class="hljs-keyword">final</span> videoUri = <span class="hljs-built_in">Uri</span>.tryParse(url!);
    <span class="hljs-keyword">if</span> (videoUri == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    <span class="hljs-keyword">final</span> videoExt = [<span class="hljs-string">'.mp4'</span>, <span class="hljs-string">'.mov'</span>, <span class="hljs-string">'.avi'</span>, <span class="hljs-string">'.wmv'</span>, <span class="hljs-string">'.flv'</span>, <span class="hljs-string">'.mkv'</span>, <span class="hljs-string">'.webm'</span>];
    <span class="hljs-keyword">final</span> ext = url.toLowerCase();
    <span class="hljs-keyword">final</span> result = videoExt.any((e) =&gt; ext.endsWith(e));
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-comment">/// <span class="markdown">获取 VideoPlayerController</span></span>
  Future&lt;VideoPlayerController?&gt; getController(<span class="hljs-built_in">String</span> url, {<span class="hljs-built_in">bool</span> isLog = <span class="hljs-keyword">false</span>}) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">assert</span>(url.startsWith(<span class="hljs-string">"http"</span>), <span class="hljs-string">"必须是视频链接,请检查链接是否合法"</span>);
    <span class="hljs-keyword">final</span> vc = _controllerMap[url];
    <span class="hljs-keyword">if</span> (vc != <span class="hljs-keyword">null</span>) {
      current = vc;
      <span class="hljs-keyword">if</span> (isLog) {
        DLog.d([<span class="hljs-string">"缓存: <span class="hljs-subst">${vc.hashCode}</span>"</span>]);
      }
      <span class="hljs-keyword">return</span> vc;
    }

    <span class="hljs-keyword">final</span> videoUri = <span class="hljs-built_in">Uri</span>.tryParse(url);
    <span class="hljs-keyword">if</span> (videoUri == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-keyword">final</span> ctrl = VideoPlayerController.networkUrl(videoUri);
    <span class="hljs-keyword">await</span> ctrl.initialize();
    _controllerMap[url] = ctrl;
    current = ctrl;
    <span class="hljs-keyword">if</span> (isLog) {
      DLog.d([<span class="hljs-string">"新建: <span class="hljs-subst">${_controllerMap[url].hashCode}</span>"</span>]);
    }
    <span class="hljs-keyword">return</span> ctrl;
  }

  <span class="hljs-comment">/// <span class="markdown">播放</span></span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; play({<span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> url, <span class="hljs-built_in">bool</span> onlyOne = <span class="hljs-keyword">true</span>}) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> getController(url);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> e <span class="hljs-keyword">in</span> _controllerMap.entries) {
      <span class="hljs-keyword">if</span> (e.key == url) {
        <span class="hljs-keyword">if</span> (!e.value.value.isPlaying) {
          e.value.play();
        } <span class="hljs-keyword">else</span> {
          e.value.pause();
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (onlyOne) {
          e.value.pause();
        }
      }
    }
  }

  <span class="hljs-comment">/// <span class="markdown">暂停所有视频</span></span>
  <span class="hljs-keyword">void</span> pauseAll() {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> e <span class="hljs-keyword">in</span> _controllerMap.entries) {
      e.value.pause();
    }
  }

  <span class="hljs-keyword">void</span> dispose(<span class="hljs-built_in">String</span> url) {
    _controllerMap[url]?.dispose();
    _controllerMap.remove(url);
  }

  <span class="hljs-keyword">void</span> disposeAll() {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> c <span class="hljs-keyword">in</span> _controllerMap.values) {
      c.dispose();
    }
    _controllerMap.clear();
  }
}
</code></pre>
<h2 data-id="heading-5">最后、总结</h2>
<p>1、播放视频组件和视频列表是分开的，通过监听 VideoPlayerController 保持状态（播放，暂停）一致性，类似网络视频小窗口播放。</p>
<p>2、通过 AppVideoPlayerService 实现全局 VideoPlayerController 缓存，提高初始化加载速度。</p>
<p>3、通过 quiver 的 LruMap 实现最大缓存数控制，防止内存爆炸。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshang1219178163%2Fflutter_templet_project%2Ftree%2Fv3.27.0%2Flib%2FbasicWidget%2FAppVideoPlayer" target="_blank" title="https://github.com/shang1219178163/flutter_templet_project/tree/v3.27.0/lib/basicWidget/AppVideoPlayer" ref="nofollow noopener noreferrer">github</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跨越进程的对话之从管道到gRPC的通信技术演进]]></title>    <link>https://juejin.cn/post/7588007285546090502</link>    <guid>https://juejin.cn/post/7588007285546090502</guid>    <pubDate>2025-12-26T11:19:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588007285546090502" data-draft-id="7588001624904761363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跨越进程的对话之从管道到gRPC的通信技术演进"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T11:19:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跨越进程的对话之从管道到gRPC的通信技术演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T11:19:27.000Z" title="Fri Dec 26 2025 11:19:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在一台Linux服务器上，一个简单的管道命令 <code>cat README.md | grep rcore</code> 背后，是两个进程通过内核中转的无缝协作，这是进程间通信最原始却有效的体现。当这种协作需求从单机扩展到全球分布式系统时，游戏规则彻底改变了。</p>
</blockquote>
<p>当操作系统的管道将一个命令的输出作为另一个命令的输入时，一个Java编写的订单服务正在通过gRPC调用Go实现的库存服务，检查商品库存。虽然它们同为进程间通信，但实现方式和应用场景已经发生了根本性变化。</p>
<hr/>
<h2 data-id="heading-0">01 进程间通信有哪些方式？</h2>
<p>操作系统中的进程就像独立运行的岛屿，每个进程拥有自己的内存空间和运行环境。当这些岛屿需要交换信息、协调行动时，就需要通过特定的<strong>进程间通信机制</strong>。</p>
<p>进程间通信根据是否需要内核中转，可以分为直接通信和间接通信。</p>
<p>传统IPC机制多种多样，各有其设计初衷和使用场景。下表从通信方式、适用范围和典型场景角度对比了几种主要机制：</p>









































<table><thead><tr><th>IPC机制</th><th>通信方式</th><th>适用范围</th><th>典型应用场景</th></tr></thead><tbody><tr><td>信号</td><td>异步发送信号</td><td>单机进程间</td><td>进程控制、异常处理</td></tr><tr><td>管道/命名管道</td><td>单向字节流</td><td>父子进程/任意进程</td><td>Shell命令组合、简单数据传递</td></tr><tr><td>消息队列</td><td>结构化消息传递</td><td>单机进程间</td><td>有格式消息传递、优先级消息处理</td></tr><tr><td>共享内存</td><td>内存区域共享</td><td>单机进程间</td><td>大量数据快速共享</td></tr><tr><td>套接字</td><td>网络字节流</td><td>跨网络进程间</td><td>网络服务、分布式系统</td></tr></tbody></table>
<p>进程的隔离性既是操作系统的安全保障，也成为进程协作的天然屏障。直接内存共享虽然高效，但<strong>跨网络场景完全失效</strong>。</p>
<h2 data-id="heading-1">02 从单机通信到分布式调用</h2>
<p>分布式系统的发展彻底改变了进程间通信的游戏规则。当进程不再局限于同一台主机，当通信双方可能使用不同编程语言编写，当网络延迟成为不可忽视的因素时，传统IPC机制就显得力不从心了。</p>
<p>这就是远程过程调用（RPC）框架出现的背景。RPC的核心思想是<strong>让远程服务调用看起来像本地函数调用一样简单</strong>，隐藏底层的网络通信细节。</p>
<p>早期的RPC框架如Sun RPC、XML-RPC和JSON-RPC，虽然解决了跨网络调用的问题，但在性能、类型安全和开发体验方面存在明显短板。</p>
<p>特别是随着微服务架构的兴起，服务数量呈指数级增长，服务间的通信频率和复杂度也随之增加。这需要一个<strong>专门为分布式环境设计、高效且可靠的通信方案</strong>。</p>
<h2 data-id="heading-2">03 gRPC的出现</h2>
<p>gRPC正是为了应对分布式系统挑战而生的现代RPC框架。它基于HTTP/2协议和Protocol Buffers序列化机制，提供了一套完整的跨语言服务通信方案。</p>
<p>从<strong>协议设计</strong>角度来看，gRPC充分利用了HTTP/2的先进特性。二进制分帧层将数据分割为更小的帧，通过多路复用实现并行传输，彻底消除了队头阻塞问题。</p>
<p>在微服务间频繁调用的场景中，HPACK头部压缩算法可减少50%以上的头部开销，这在大量小请求的微服务环境中效果尤为显著。</p>
<p><strong>跨语言支持</strong>是gRPC的另一大亮点。通过代码生成机制，gRPC支持12种主流编程语言，从Go、Java到Python、C++，都可以基于相同的接口定义进行开发。</p>
<p>这种语言无关性极大降低了多技术栈团队的协作成本。例如，在一个典型电商系统中，Java编写的订单服务可以无缝调用Go实现的库存服务，而Python开发的数据分析服务又可以调用这两者的接口。</p>
<p>gRPC内置的流式处理能力也值得一提。它提供三种流式RPC模式：客户端流、服务端流和双向流。在实时通信场景中，双向流式RPC传输音视频数据，端到端延迟可以稳定在80毫秒以内。</p>
<h2 data-id="heading-3">04 何时选择gRPC？</h2>
<p>虽然gRPC优势明显，但它并非银弹。技术选型需要根据具体场景和需求进行权衡。</p>
<p>在<strong>内部微服务通信</strong>领域，gRPC几乎是理想选择。特别是当服务部署在同一数据中心内，网络环境可控时，gRPC的高性能特性能够得到充分发挥。</p>
<p>对于<strong>高性能计算和数据密集</strong>型应用，gRPC的低延迟、高吞吐特性非常有价值。例如在金融风控系统中，毫秒级的延迟差异可能决定交易的成败。</p>
<p>在<strong>多语言混合开发</strong>环境中，gRPC提供了一致的通信标准。不同团队使用不同技术栈时，可以通过统一的gRPC接口进行协作，而无需为每种语言组合单独设计通信协议。</p>
<p><strong>实时数据流处理</strong>场景也能从gRPC的流式能力中受益。例如金融行情推送系统，使用服务端流式RPC，单台服务器即可支撑数万并发订阅，消息送达延迟低于50毫秒。</p>
<h2 data-id="heading-4">05 gRPC的局限与挑战</h2>
<p>当然，gRPC并非适用于所有场景。它的技术特性决定了在某些环境中使用会有明显局限。</p>
<p>最突出的问题是<strong>浏览器兼容性限制</strong>。由于浏览器原生不支持HTTP/2的非加密连接，gRPC服务需要通过gRPC-Web转换层暴露API。</p>
<p>这种转换会引入额外处理时间，使响应时间增加15-20毫秒。在超低延迟场景中，这可能影响用户体验。</p>
<p><strong>调试和监控复杂性</strong>也是需要考虑的因素。二进制协议的可读性差，网络抓包分析困难。在实际故障排查时，团队可能需要花费数小时对比Protocol Buffers定义与实际数据。</p>
<p>在资源受限的环境中，如某些IoT设备，Protobuf解析的CPU占用可能比JSON高25%。在智能家居项目中测试发现，处理gRPC请求可能使设备电池续航减少18%。</p>
<h2 data-id="heading-5">06 混合架构的实践智慧</h2>
<p>在实际项目中，纯粹的gRPC架构或纯粹的RESTful架构都可能有局限性。<strong>混合架构</strong>往往能够实现技术价值的最大化。</p>
<p>一种常见的模式是核心服务间使用gRPC进行高效通信，而对外的API接口则通过RESTful暴露。</p>
<p>这样既享受了gRPC在内部通信的性能优势，又保持了外部接口的广泛兼容性。</p>
<p>对于需要浏览器直接调用的场景，可以考虑使用<strong>gRPC-Web作为过渡方案</strong>，或者为关键功能提供RESTful备用接口。</p>
<p>在监控和调试方面，可以配置专门的<strong>调试代理</strong>，将二进制协议转换为可读格式，或使用grpcurl等工具辅助调试。</p>
<hr/>
<p>回到Kubernetes集群中的一个节点上，Kubelet通过gRPC与API Server通信，获取最新的容器调度指令。而在同一节点内部，容器间的进程可能仍在使用共享内存交换数据。</p>
<p>这些不同层级的通信机制在系统中和谐共存，<strong>从操作系统的管道到分布式的gRPC，再到边缘计算中的轻量级消息队列</strong>，每一层都解决着特定场景下的通信问题。技术不是非此即彼的选择，而是根据场景和需求的适配。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[二叉树中序遍历：递归与非递归实现详解]]></title>    <link>https://juejin.cn/post/7588001624904794131</link>    <guid>https://juejin.cn/post/7588001624904794131</guid>    <pubDate>2025-12-26T11:20:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588001624904794131" data-draft-id="7588001624904777747" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="二叉树中序遍历：递归与非递归实现详解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T11:20:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            二叉树中序遍历：递归与非递归实现详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T11:20:56.000Z" title="Fri Dec 26 2025 11:20:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是二叉树的中序遍历？</h2>
<p>中序遍历（Inorder Traversal）是二叉树遍历的一种经典方式，其遍历顺序遵循 <strong>"左子树 → 根节点 → 右子树"</strong> 的原则。</p>
<p>对于下面这个二叉树：</p>
<pre><code class="hljs language-css" lang="css">        <span class="hljs-selector-tag">A</span>
       / \
      <span class="hljs-selector-tag">B</span>   C
     / \   \
    D   E   F
</code></pre>
<p>中序遍历的结果是：<strong>D → B → E → A → C → F</strong></p>
<h2 data-id="heading-1">中序遍历的核心原理</h2>
<h3 data-id="heading-2">递归思想（最直观的理解）</h3>
<ol>
<li>遍历左子树</li>
<li>访问根节点</li>
<li>遍历右子树</li>
</ol>
<p>这种分治思想非常适合用递归实现，因为每个子树都可以看作是一个更小的二叉树。</p>
<h3 data-id="heading-3">非递归思想（手动维护栈）</h3>
<p>模拟递归调用的过程，需要显式地使用栈来保存待访问的节点：</p>
<ol>
<li>从根节点开始，将所有左子节点压入栈</li>
<li>弹出栈顶节点并访问</li>
<li>转向该节点的右子树，重复步骤1</li>
</ol>
<h2 data-id="heading-4">完整C++实现</h2>
<h3 data-id="heading-5">1. 二叉树节点定义</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stack&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-comment">// 二叉树节点结构</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">TreeNode</span> {
    <span class="hljs-type">int</span> val;
    TreeNode* left;
    TreeNode* right;
    <span class="hljs-built_in">TreeNode</span>(<span class="hljs-type">int</span> x) : <span class="hljs-built_in">val</span>(x), <span class="hljs-built_in">left</span>(<span class="hljs-literal">nullptr</span>), <span class="hljs-built_in">right</span>(<span class="hljs-literal">nullptr</span>) {}
};
</code></pre>
<h3 data-id="heading-6">2. 递归实现</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 递归中序遍历</span>
    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">inorderTraversalRecursive</span><span class="hljs-params">(TreeNode* root)</span> </span>{
        vector&lt;<span class="hljs-type">int</span>&gt; result;
        <span class="hljs-built_in">inorderHelper</span>(root, result);
        <span class="hljs-keyword">return</span> result;
    }
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">inorderHelper</span><span class="hljs-params">(TreeNode* node, vector&lt;<span class="hljs-type">int</span>&gt;&amp; result)</span> </span>{
        <span class="hljs-keyword">if</span> (!node) <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 递归终止条件</span>
        
        <span class="hljs-built_in">inorderHelper</span>(node-&gt;left, result);  <span class="hljs-comment">// 遍历左子树</span>
        result.<span class="hljs-built_in">push_back</span>(node-&gt;val);        <span class="hljs-comment">// 访问根节点</span>
        <span class="hljs-built_in">inorderHelper</span>(node-&gt;right, result); <span class="hljs-comment">// 遍历右子树</span>
    }
};
</code></pre>
<p><strong>递归流程分析：</strong></p>
<pre><code class="hljs language-scss" lang="scss">调用 <span class="hljs-built_in">inorder</span>(A)
├── 调用 <span class="hljs-built_in">inorder</span>(B)
│   ├── 调用 <span class="hljs-built_in">inorder</span>(D) → 访问 D
│   ├── 访问 <span class="hljs-selector-tag">B</span>
│   └── 调用 <span class="hljs-built_in">inorder</span>(E) → 访问 E
├── 访问 <span class="hljs-selector-tag">A</span>
└── 调用 <span class="hljs-built_in">inorder</span>(C)
    ├── 访问 C
    └── 调用 <span class="hljs-built_in">inorder</span>(F) → 访问 F
</code></pre>
<h3 data-id="heading-7">3. 非递归实现（使用栈）</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 非递归中序遍历（迭代法）</span>
    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">inorderTraversalIterative</span><span class="hljs-params">(TreeNode* root)</span> </span>{
        vector&lt;<span class="hljs-type">int</span>&gt; result;
        stack&lt;TreeNode*&gt; nodeStack;
        TreeNode* current = root;
        
        <span class="hljs-comment">// 当当前节点不为空或栈不为空时继续</span>
        <span class="hljs-keyword">while</span> (current != <span class="hljs-literal">nullptr</span> || !nodeStack.<span class="hljs-built_in">empty</span>()) {
            <span class="hljs-comment">// 深入左子树，将所有左子节点入栈</span>
            <span class="hljs-keyword">while</span> (current != <span class="hljs-literal">nullptr</span>) {
                nodeStack.<span class="hljs-built_in">push</span>(current);
                current = current-&gt;left;
            }
            
            <span class="hljs-comment">// 弹出栈顶节点并访问</span>
            current = nodeStack.<span class="hljs-built_in">top</span>();
            nodeStack.<span class="hljs-built_in">pop</span>();
            result.<span class="hljs-built_in">push_back</span>(current-&gt;val);
            
            <span class="hljs-comment">// 转向右子树</span>
            current = current-&gt;right;
        }
        
        <span class="hljs-keyword">return</span> result;
    }
};
</code></pre>
<p><strong>非递归流程分析（示例二叉树）：</strong></p>
<pre><code class="hljs language-ini" lang="ini">初始：<span class="hljs-attr">current</span> = A, stack = []
1. 将A、B、D依次入栈 → <span class="hljs-attr">stack</span> = [A, B, D], current = null
2. 弹出D访问 → <span class="hljs-attr">result</span> = [D], current = D.right = null
3. 弹出B访问 → <span class="hljs-attr">result</span> = [D, B], current = B.right = E
4. 将E入栈 → <span class="hljs-attr">stack</span> = [A, E], current = null
5. 弹出E访问 → <span class="hljs-attr">result</span> = [D, B, E], current = E.right = null
6. 弹出A访问 → <span class="hljs-attr">result</span> = [D, B, E, A], current = A.right = C
7. 将C入栈 → <span class="hljs-attr">stack</span> = [C], current = null
8. 弹出C访问 → <span class="hljs-attr">result</span> = [D, B, E, A, C], current = C.right = F
9. 将F入栈 → <span class="hljs-attr">stack</span> = [F], current = null
10. 弹出F访问 → <span class="hljs-attr">result</span> = [D, B, E, A, C, F], current = null
结束
</code></pre>
<h2 data-id="heading-8">对比分析</h2>



































<table><thead><tr><th>特性</th><th>递归实现</th><th>非递归实现</th></tr></thead><tbody><tr><td>代码简洁性</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td></tr><tr><td>理解难度</td><td>容易</td><td>较难</td></tr><tr><td>空间复杂度</td><td>O(h)（递归调用栈）</td><td>O(h)（显式栈）</td></tr><tr><td>栈溢出风险</td><td>树深度大时可能溢出</td><td>更可控</td></tr><tr><td>执行效率</td><td>函数调用开销较大</td><td>直接操作栈，效率较高</td></tr></tbody></table>
<h2 data-id="heading-9">测试示例</h2>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 创建测试二叉树</span>
<span class="hljs-function">TreeNode* <span class="hljs-title">createTestTree</span><span class="hljs-params">()</span> </span>{
    TreeNode* root = <span class="hljs-keyword">new</span> <span class="hljs-built_in">TreeNode</span>(<span class="hljs-number">1</span>);
    root-&gt;left = <span class="hljs-keyword">new</span> <span class="hljs-built_in">TreeNode</span>(<span class="hljs-number">2</span>);
    root-&gt;right = <span class="hljs-keyword">new</span> <span class="hljs-built_in">TreeNode</span>(<span class="hljs-number">3</span>);
    root-&gt;left-&gt;left = <span class="hljs-keyword">new</span> <span class="hljs-built_in">TreeNode</span>(<span class="hljs-number">4</span>);
    root-&gt;left-&gt;right = <span class="hljs-keyword">new</span> <span class="hljs-built_in">TreeNode</span>(<span class="hljs-number">5</span>);
    root-&gt;right-&gt;right = <span class="hljs-keyword">new</span> <span class="hljs-built_in">TreeNode</span>(<span class="hljs-number">6</span>);
    <span class="hljs-keyword">return</span> root;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    TreeNode* root = <span class="hljs-built_in">createTestTree</span>();
    Solution solution;
    
    cout &lt;&lt; <span class="hljs-string">"递归中序遍历结果: "</span>;
    vector&lt;<span class="hljs-type">int</span>&gt; recursiveResult = solution.<span class="hljs-built_in">inorderTraversalRecursive</span>(root);
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> val : recursiveResult) {
        cout &lt;&lt; val &lt;&lt; <span class="hljs-string">" "</span>;
    }
    cout &lt;&lt; endl;
    
    cout &lt;&lt; <span class="hljs-string">"非递归中序遍历结果: "</span>;
    vector&lt;<span class="hljs-type">int</span>&gt; iterativeResult = solution.<span class="hljs-built_in">inorderTraversalIterative</span>(root);
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> val : iterativeResult) {
        cout &lt;&lt; val &lt;&lt; <span class="hljs-string">" "</span>;
    }
    cout &lt;&lt; endl;
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">递归中序遍历结果: 4 2 5 1 3 6 </span>
<span class="hljs-section">非递归中序遍历结果: 4 2 5 1 3 6 </span>
</code></pre>
<h2 data-id="heading-10">应用场景</h2>
<ol>
<li><strong>二叉搜索树（BST）排序</strong>：中序遍历BST会得到有序序列</li>
<li><strong>表达式树求值</strong>：中序遍历可以还原中缀表达式</li>
<li><strong>复制二叉树</strong>：按中序顺序复制节点</li>
<li><strong>调试和分析</strong>：查看树的结构</li>
</ol>
<h2 data-id="heading-11">总结</h2>
<p>中序遍历是二叉树算法的基础，掌握其递归和非递归实现非常重要：</p>
<ul>
<li><strong>递归实现</strong>：直观易懂，适合快速实现和教学</li>
<li><strong>非递归实现</strong>：更高效，避免递归深度限制，是面试常考点</li>
</ul>
<p>理解两种实现方式不仅有助于掌握二叉树遍历，还能加深对递归和栈的理解，为学习更复杂的树形结构算法打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AudioDock：服务器和 NAS 音频播放最棒的软件！🚀🚀🚀]]></title>    <link>https://juejin.cn/post/7587965908288749578</link>    <guid>https://juejin.cn/post/7587965908288749578</guid>    <pubDate>2025-12-26T11:52:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587965908288749578" data-draft-id="7587997893987614747" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AudioDock：服务器和 NAS 音频播放最棒的软件！🚀🚀🚀"/> <meta itemprop="keywords" content="服务器,Docker,Node.js"/> <meta itemprop="datePublished" content="2025-12-26T11:52:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="萌萌哒草头将军"/> <meta itemprop="url" content="https://juejin.cn/user/1116759543260727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AudioDock：服务器和 NAS 音频播放最棒的软件！🚀🚀🚀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759543260727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    萌萌哒草头将军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T11:52:04.000Z" title="Fri Dec 26 2025 11:52:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">前言</h3>
<p>前几天介绍了我开发 AudioDock 项目的一些问题。好多小伙伴很感兴趣这个项目。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmmdctjj%2FAudioDock" target="_blank" title="https://github.com/mmdctjj/AudioDock" ref="nofollow noopener noreferrer">github.com/mmdctjj/Aud…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99c1999ba51b44df9705468e330a1948~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JCM6JCM5ZOS6I2J5aS05bCG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354801&amp;x-signature=M4dhfqBOQREbUpKJHbToSzJzu98%3D" alt="桌面端" loading="lazy"/></p>
<p>今天就简单介绍下这个项目吧！</p>
<h4 data-id="heading-1">往期精彩推荐</h4>
<ul>
<li><a href="https://juejin.cn/post/7541048117497954342" title="https://juejin.cn/post/7541048117497954342" target="_blank">字节也在用的 @tanstack/react-query 到底有多好用！🔥🔥🔥</a></li>
<li><a href="https://juejin.cn/post/7542323000236359689" title="https://juejin.cn/post/7542323000236359689" target="_blank">🚀🚀🚀 告别复制粘贴，这个高效的 Vite 插件让我摸鱼🐟时间更充足了！</a></li>
<li><a href="https://juejin.cn/post/7538393049765314598" title="https://juejin.cn/post/7538393049765314598" target="_blank">🔥🔥🔥 原来在字节写代码就是这么朴实无华！🔥🔥🔥</a></li>
<li>更多精彩文章欢迎关注我的公众号：萌萌哒草头将军</li>
</ul>
<h3 data-id="heading-2">AudioDock</h3>
<p>AudioDock（声仓）是一款免费开源的音频播放器，</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02792476c81444bb83539e3a5c3a34f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JCM6JCM5ZOS6I2J5aS05bCG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354801&amp;x-signature=864i%2FkVSrW4mjLbQoayLlSlRs7Y%3D" alt="image.png" width="30%" loading="lazy"/></p>
<ul>
<li><strong>多端支持 💻</strong>：包含移动端、web端、桌面端、小程序、电视端！</li>
<li><strong>双模式无缝切换 ♻️</strong>：有声书、音乐模式一键无缝切换，记忆不同模式下的播放信息！</li>
<li><strong>支持 docker 部署 📦</strong>：可以通过 docker 部署服务端和 web 端！</li>
<li><strong>多用户支持 👥</strong>：支持多用户交互联动！</li>
<li><strong>设备接力 📱</strong>：支持多设备之间无缝切换！</li>
<li><strong>解析元数据 🖼️</strong>：如果是带元信息的歌曲，可以展示歌词、封面等信息！</li>
</ul>
<p>目前已经完成了移动端、桌面端、web端的开发，正在有节奏的测试中，即将正式发版！</p>
<p>AudioDock 依赖的服务端已经完成了所有功能的支持了。</p>
<p>下面是完整的开发情况：</p>
<p>✅：完成    ❌：未开发/未完成开发     🚫：无设计</p>


























































































<table><thead><tr><th>功能描述</th><th>桌面端</th><th>移动端</th></tr></thead><tbody><tr><td>切换有声书和音乐模式</td><td>✅</td><td>✅</td></tr><tr><td>自动导入数据</td><td>✅</td><td>✅</td></tr><tr><td>播放器功能</td><td>✅</td><td>✅</td></tr><tr><td>歌词展示</td><td>✅</td><td>✅</td></tr><tr><td>专辑、艺术家</td><td>✅</td><td>✅</td></tr><tr><td>聚合搜索</td><td>✅</td><td>✅</td></tr><tr><td>边听边存</td><td>❌</td><td>❌</td></tr><tr><td>多端同步</td><td>✅</td><td>✅</td></tr><tr><td>迷你播放器</td><td>✅</td><td>🚫</td></tr><tr><td>多用户同步播放</td><td>✅</td><td>✅</td></tr><tr><td>播放记录</td><td>✅</td><td>✅</td></tr><tr><td>收藏记录</td><td>✅</td><td>✅</td></tr><tr><td>桌面歌词</td><td>✅</td><td>❌</td></tr><tr><td>和系统交互</td><td>✅</td><td>✅</td></tr><tr><td>TTS 生成有声书</td><td>❌</td><td>❌</td></tr><tr><td>云盘聚合</td><td>❌</td><td>❌</td></tr></tbody></table>
<h4 data-id="heading-3">快速体验</h4>
<h5 data-id="heading-4">NAS 部署</h5>
<pre><code class="hljs language-bash" lang="bash">docker pull ctjj/audiodock-api:latest
docker pull ctjj/audiodock-web:latest
</code></pre>
<p>然后复制 readme 对应的内容到 nas 项目位置启动即可，</p>
<blockquote>
<p>无法拉镜像的小伙伴公众号后台输入：audiodock ，获取链接！</p>
</blockquote>
<h5 data-id="heading-5">本地运行</h5>
<p>准备：</p>
<ul>
<li>复制 services/api、 packages/db 包 根目录下的 .env.example 文件，修改名称为 .env</li>
<li>修改下面文件路径</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">AUDIO_BOOK_DIR</span>=./music/audio
<span class="hljs-attr">MUSIC_BASE_DIR</span>=./music/music
<span class="hljs-attr">CACHE_DIR</span>=./music/cover
</code></pre>
<p>然后运行下面的命令，自动打开桌面端</p>
<pre><code class="hljs language-bash" lang="bash">nvm use 22
pnpm install
npm run dev
</code></pre>
<p>移动端需要进入 /apps/mobile 目录启动：</p>
<pre><code class="hljs language-arduino" lang="arduino">npx expo run:ios --device
</code></pre>
<h5 data-id="heading-6">docker 启动</h5>
<p>修改 docker-compose 的环境变量 和 volumes：</p>
<pre><code class="hljs language-bash" lang="bash">environment:
  - AUDIO_BOOK_DIR=/audio
  - MUSIC_BASE_DIR=/music
  - CACHE_DIR=/covers
  - DATABASE_URL=file:/data/dev.db

<span class="hljs-comment"># 挂载数据文件和缓存，使用 Docker 命名卷更安全</span>
volumes:
  - ./audio:/audio
  - ./music:/music
  - ./covers:/covers
  - api-db:/data
</code></pre>
<p>根目录下运行构建命令：</p>
<pre><code class="hljs language-css" lang="css">docker-compose build <span class="hljs-attr">--no-cache</span>
docker-compose up
</code></pre>
<h4 data-id="heading-7">产品由来</h4>
<p>首先我是一名重度的 NAS 用户，一方面是需要将孩子、家人的海量照片存储起来，另一方面我本人也是数据爱好者。</p>
<p>我遇到的最大的问题是没有一款让 NAS 用户用起来舒服的音频播放器！厂家也是在摆烂中，没办法那就自己开发吧！</p>
<h4 data-id="heading-8">用心的设计</h4>
<p>对于有各种想法的开发者来说，自己开发一款属于自己的产品，无疑是件开心的事情，因为天马行空的想象有天变成了可落地的产品！</p>
<p>所以，AudioDock 无限趋近我心中完美的样子！</p>
<p>歌词滚动展示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/483af0e87b9541969f644336017f4d36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JCM6JCM5ZOS6I2J5aS05bCG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354801&amp;x-signature=tBcl%2FzfKn8SzbVLk%2B3tFSujKETA%3D" alt="歌词滚动展示" loading="lazy"/></p>
<p>桌面歌词：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ab5cc5bfbc148d6b1ada4128cd25577~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JCM6JCM5ZOS6I2J5aS05bCG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354801&amp;x-signature=17gZ9ELRhNDvul96FE9Vq0EBQVw%3D" alt="桌面歌词" loading="lazy"/></p>
<p>mini播放器：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a364e08bef941bba8732a1b12d85633~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JCM6JCM5ZOS6I2J5aS05bCG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354801&amp;x-signature=naXDHoUHv70C6mveAPF1e0lAit0%3D" alt="mini播放器" loading="lazy"/></p>
<p>和系统集成：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8d0d4cb770b415ca644149871d73bf3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JCM6JCM5ZOS6I2J5aS05bCG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354801&amp;x-signature=Pv%2Bo2MFmGWjVHwPJ9WPdBsiAQ%2FE%3D" alt="和系统集成" loading="lazy"/></p>
<p>可以在系统导航栏随意控制！</p>
<p>同步播放：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4c86c3b422e4b71bef4139ff48483e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JCM6JCM5ZOS6I2J5aS05bCG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354801&amp;x-signature=pboqd5YGioqyN%2BmRkRLDCdcHDC8%3D" alt="同步播放请求" loading="lazy"/></p>
<p>不同用户之间可以互相邀请同步播放，同意后播播邀请者当前的音频和列表，给生活多一点分享的乐趣！</p>
<p>设备接力：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/200cbccfafa9476c9fdf539325691bcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JCM6JCM5ZOS6I2J5aS05bCG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354801&amp;x-signature=iQP93G6PbGm6B1EWJxwB9lYxwCA%3D" alt="设备接力" loading="lazy"/></p>
<p>当我在通勤时用手机听歌，回到公司，打开电脑，可以继续听！</p>
<h4 data-id="heading-9">激动人心的功能</h4>
<p>除了上面基础的功能，我目前正在调研准备下个阶段功能的开发。</p>
<h5 data-id="heading-10">TTS 生成有声书</h5>
<p>有的时候很喜欢一本书，但是有不想坐着，只想躺着听，找不到合适的工具来满足我的使用场景。</p>
<p>所以，下个阶段努力实现这个功能。</p>
<p>早期调研使用 edge-tts python 库来实现这个基础功能。</p>
<p>鉴于最近 Index TTS 的强势出圈，也打算跟进克隆音色朗读文本的方案！</p>
<h5 data-id="heading-11">云盘聚合</h5>
<p>我的仓鼠行为很早就出现了，在云盘囤积了各种音乐，为了方便入库，后面也会实现将云盘的音频统一入库。</p>
<p>简单的方案是，通过云盘授权 AList，然后通过 AList 的服务和 AudioDock 服务对接，实现音频自动入库。</p>
<h4 data-id="heading-12">未来展望</h4>
<p>后续，还会考虑做个小程序，让大家的使用更加方便，如果后面我家里买了大电视，会考虑做个电视端的播放器，这样整个生态就全了！</p>
<h3 data-id="heading-13">最后</h3>
<p>希望 AudioDock 的出现，可以给 Docker 党、Nas 党带来更多的便利！</p>
<h4 data-id="heading-14">往期精彩推荐</h4>
<ul>
<li><a href="https://juejin.cn/post/7541048117497954342" title="https://juejin.cn/post/7541048117497954342" target="_blank">字节也在用的 @tanstack/react-query 到底有多好用！🔥🔥🔥</a></li>
<li><a href="https://juejin.cn/post/7542323000236359689" title="https://juejin.cn/post/7542323000236359689" target="_blank">🚀🚀🚀 告别复制粘贴，这个高效的 Vite 插件让我摸鱼🐟时间更充足了！</a></li>
<li><a href="https://juejin.cn/post/7538393049765314598" title="https://juejin.cn/post/7538393049765314598" target="_blank">🔥🔥🔥 原来在字节写代码就是这么朴实无华！🔥🔥🔥</a></li>
<li>更多精彩文章欢迎关注我的公众号：萌萌哒草头将军</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 0 到 1 玩转 N8N——初识 N8N（入门必看）]]></title>    <link>https://juejin.cn/post/7587743345197613108</link>    <guid>https://juejin.cn/post/7587743345197613108</guid>    <pubDate>2025-12-26T10:03:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587743345197613108" data-draft-id="7587738151660175360" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 0 到 1 玩转 N8N——初识 N8N（入门必看）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T10:03:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LucianaiB"/> <meta itemprop="url" content="https://juejin.cn/user/1269294586664749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 0 到 1 玩转 N8N——初识 N8N（入门必看）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1269294586664749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LucianaiB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:03:51.000Z" title="Fri Dec 26 2025 10:03:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6560e85741a44e8a3fc2d7b2a6d66fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=r1L3cV0rKSaFsrp3XviFyCstbaw%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">什么是n8n？</h2>
<p><strong>n8n 是一款开源、灵活且高度可定制的工作流自动化平台，其核心理念是通过可视化拖拽界面将不同的应用、服务、API或数据源连接起来，实现复杂的自动化任务，而无需编写大量代码</strong>。n8n 的名字源于德语 “nur ein Ninja”（意为“只是一个忍者”），寓意其强大、灵活又轻盈。</p>
<h4 data-id="heading-1">核心特性</h4>
<ul>
<li>完全开源免费：n8n 采用 MIT 开源许可，源代码托管于 GitHub)))，用户可自由查看、修改与部署。</li>
<li>可视化工作流编排：通过直观的拖拽式界面构建多步骤自动化流程，降低技术门槛。</li>
<li>丰富的集成生态：官方支持 1700+ 预设模板 和 数百个原生节点（如 Slack、Google Sheets、Notion、Webhook 等），同时支持自定义节点开发。</li>
<li>灵活的触发机制：支持定时任务、事件驱动、手动触发、Webhook、API 调用等多种触发方式。</li>
<li>强大的逻辑控制：支持条件分支（if/else）、循环、错误处理等复杂逻辑，可构建企业级自动化流程。</li>
<li>部署方式灵活：既可本地部署（Docker、本地 Node.js 环境），也可自托管于私有云/公有云，或使用其官方SaaS 云服务（含 14 天试用）。</li>
<li>代码与无代码融合：在可视化流程中可随时插入 JavaScript 或 Python 脚本，实现高度定制化逻辑。</li>
</ul>
<h4 data-id="heading-2">适用场景</h4>
<ul>
<li>个人效率提升：自动备份笔记、定时抓取网页内容、邮件自动化等。</li>
<li>团队协作自动化：将 Slack 消息同步至 Notion、自动创建 Jira 工单、审批流提醒等。</li>
<li>数据集成与处理：聚合多个 API 数据、清洗并写入数据库、生成报表等。</li>
<li>AI 工作流构建：集成 LLM（如 OpenAI、本地模型），构建多步骤 AI Agent，实现“用自然语言操作业务系统”。</li>
</ul>
<h2 data-id="heading-3">怎么用 n8n?</h2>
<p>首先先解决 “怎么用 n8n” 的基础问题，n8n一般有 3 种部署方式：</p>
<ul>
<li><strong>在线使用（[</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fn8n.io%2F" target="_blank" title="https://n8n.io/" ref="nofollow noopener noreferrer"><strong>https://n8n.io/</strong></a><strong>\）注意的是只有14天的试用时间，过期了可以换个邮箱注册新的账号。</strong>](<a href="https://link.juejin.cn?target=https%3A%2F%2Fn8n.io" target="_blank" title="https://n8n.io" ref="nofollow noopener noreferrer">n8n.io</a>)</li>
<li><strong>本地部署适合想先试手的新手，不用额外花钱，电脑上操作几步就能启动（[</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fn8n-io%2Fn8n" target="_blank" title="https://github.com/n8n-io/n8n" ref="nofollow noopener noreferrer"><strong>https://github.com/n8n-io/n8n</strong></a><strong>）。</strong>](<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fn8n-io" target="_blank" title="https://github.com/n8n-io" ref="nofollow noopener noreferrer">github.com/n8n-io</a>)</li>
<li><strong>云服务器**</strong>部署更实用，部署完之后不管电脑关没关，*<strong>*工作流**</strong>都能一直自动运行，适合长期用（本文详细教程）。**</li>
</ul>





























<table><thead><tr><th align="left">部署方式</th><th align="left">适用人群</th><th align="left">优点</th><th align="left">缺点</th></tr></thead><tbody><tr><td align="left">官方 SaaS</td><td align="left">快速体验者</td><td align="left">无需配置，开箱即用</td><td align="left">仅 14 天免费试用</td></tr><tr><td align="left">本地部署</td><td align="left">初学者、开发者</td><td align="left">免费、便于调试</td><td align="left">依赖本地电脑，无法长期运行</td></tr><tr><td align="left">云服务器部署</td><td align="left">企业用户、长期使用者</td><td align="left">7×24 小时运行、高可用</td><td align="left">需支付云服务器费用</td></tr></tbody></table>
<h2 data-id="heading-4"><strong>获取 N8N 服务器</strong></h2>
<h3 data-id="heading-5"><strong>1.获取 N8N 服务器</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fbuy.cloud.tencent.com%2Flighthouse%3FblueprintType%3DAPP_OS%26blueprintOfficialId%3Dlhbp-5utfah5i%252525C2%252525AEionId%3D1%26zone%3Dap-guangzhou-6%26bundleId%3Dbundle_rs_mc_med2_01%26loginSet%3DAUTO%26timeSpan%3D3%26from%3Dlh-console" target="_blank" title="https://buy.cloud.tencent.com/lighthouse?blueprintType=APP_OS&amp;blueprintOfficialId=lhbp-5utfah5i%2525C2%2525AEionId=1&amp;zone=ap-guangzhou-6&amp;bundleId=bundle_rs_mc_med2_01&amp;loginSet=AUTO&amp;timeSpan=3&amp;from=lh-console" ref="nofollow noopener noreferrer">buy.cloud.tencent.com/lighthouse?…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd8b01007da8452daa1d425efb57dd33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=BU4NkmgWIHQBHi5SrOsMXJZ7oI8%3D" alt=" " loading="lazy"/></p>
<p>这里我购买了3个月用来学习。注意：<code>记得取消自动续费</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65c2b88113df4b88845cdceeb0e49589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=5bxPKpvdEWc2Jtuur66CjVGHXmE%3D" alt=" " loading="lazy"/></p>
<h3 data-id="heading-6">2.打开服务器管理</h3>
<p>打开网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.cloud.tencent.com%2Flighthouse%2Finstance%2Findex%3Frid%3D1" target="_blank" title="https://console.cloud.tencent.com/lighthouse/instance/index?rid=1" ref="nofollow noopener noreferrer">console.cloud.tencent.com/lighthouse/…</a>，点击登录。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3072ca9c518f4762ae6ce6e210994127~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=yePaOexV7IPDoJyPK0uUVjcC868%3D" alt=" " loading="lazy"/></p>
<p>下载终端连接。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f74abc5728541c29de7d73b1c467eb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=VybYhzYLmKcmdP5n5NTGL8YCmbI%3D" alt=" " loading="lazy"/></p>
<p>在上图有一个公网地址，我们打开网站：<a href="https://link.juejin.cn?target=http%3A%2F%2Fyour-server-ip%3A5678" target="_blank" title="http://your-server-ip:5678" ref="nofollow noopener noreferrer">http://your-server-ip:5678</a></p>
<p>例如我就是：<a href="https://link.juejin.cn?target=http%3A%2F%2F111.230.109.186%3A5678" target="_blank" title="http://111.230.109.186:5678" ref="nofollow noopener noreferrer">http://111.230.109.186:5678</a></p>
<p>输入我们的信息，点击Next，下一步。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a255d77675445538286bd21003f5769~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=%2B3wAWtKJrTIJYAn4YHmBXfGUB2E%3D" alt=" " loading="lazy"/></p>
<p>成功的打开了我们的n8n工作平台。</p>
<p>登录后的界面，和官网登录那边基本一致，用这种方式就不用担心只有14天试用了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df7b736c08564b3f84380b4509e5ca03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=95lU4gGKeOYXQZU5GViyH1ABhSw%3D" alt=" " loading="lazy"/></p>
<h3 data-id="heading-7">3.实战：搭建“获取今日信息并保存为文件”工作流</h3>
<p>本次案例搭建一个 获取今日日期并下载文件 的简单 工作流。</p>
<h4 data-id="heading-8">步骤 1：创建新工作流</h4>
<p>首先点击Create Workflow创建工作流。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97cf8ab36b9740bda8e04b942a517c82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=k3xMjmZzLoIk3LFwPkvdv3MRmm8%3D" alt=" " loading="lazy"/></p>
<h4 data-id="heading-9">步骤 2：添加手动触发器</h4>
<p>点击左侧<code>+</code>，右侧会弹出抽屉，选择第一个Trigger manually</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/422592700bf8455495f41fcf89fce37f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=LoYTIL3qPHoYuYMxvPBJ1n6mGLA%3D" alt=" " loading="lazy"/></p>
<p>工作台就会出现第一个节点，点击右侧的加号可以继续添加节点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10ae0fa8e0a446328bbd7cc4bddac352~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=XleFdxJvNR%2BM%2F8XzlXpQUENVLwg%3D" alt=" " loading="lazy"/></p>
<p>我们可以通过搜索，或者下面的分类里去找需要的功能节点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7622013538b4fa38a139ddd599ebeeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=llX8lEUR%2BoRfH5gJ4BsmDZWJ%2BEM%3D" alt=" " loading="lazy"/></p>
<h4 data-id="heading-10">步骤 3：添加 Code 节点（生成内容）</h4>
<p>选择code节点为例，点击后会出现这个弹窗，我们在代码框放上自己所需要的功能代码，点击Execute step（执行步骤）按钮，右侧output那边就会出现输出的内容</p>
<p>这里可以选择JavaScript或者Python(测试中)。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c94c1389df194dd6b8b71cee22dd7282~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=SLJPNzT8gbTV3JJWiKIqs4Y4ZZs%3D" alt=" " loading="lazy"/></p>
<p>输入代码：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-comment"># 获取第一个输入项</span>
item = _<span class="hljs-built_in">input</span>.first()

<span class="hljs-comment"># 从 item.json 中提取 randomQuote</span>
random_quote = item.json.get(<span class="hljs-string">"randomQuote"</span>, <span class="hljs-string">"今日 LucianaiB 名言"</span>)

<span class="hljs-comment"># 构造日期</span>
today = datetime.now()
date_str = <span class="hljs-string">f"<span class="hljs-subst">{today.year}</span>年<span class="hljs-subst">{today.month}</span>月<span class="hljs-subst">{today.day}</span>日"</span>

<span class="hljs-comment"># 生成推文内容</span>
tweet_content = <span class="hljs-string">f"📚 我不做 N8N 应用的传播者，而是希望你能真正爱上它、主动尝试，并动手设计属于自己的自动化流程。"</span>

<span class="hljs-comment"># 返回数据</span>
<span class="hljs-keyword">return</span> {
    <span class="hljs-string">"quote"</span>: random_quote,
    <span class="hljs-string">"date"</span>: date_str,
    <span class="hljs-string">"tweetContent"</span>: tweet_content
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a8e6ac391ca4d6ebefa8ed13fa3bc1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=2JwFmY5%2BvKLUIJqJ7mXU6lyU4cQ%3D" alt=" " loading="lazy"/></p>
<p>点击左上角的Back to canvas，可以返回工作台。</p>
<h4 data-id="heading-11">步骤 4：转换为文本文件</h4>
<p>添加下一个节点Convert to File（保存为文件），选择text文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ae4d2d5f51b47c991006ddfde31a0a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=UokyTLxUtIgLZ3gqj%2F%2BNWoCulHw%3D" alt=" " loading="lazy"/></p>
<p>直接拖到左侧的节点到右侧就是输入（如果左侧没有，是因为需要上一个节点运行成功才可以），点击Execute step（执行步骤）按钮，右侧output那边就会出现输出的内容，我这里选择了预览，可以看到成功显示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f67c821a13974f74808887f0238e6ee5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=85GdX3AIMzpKYkPJtHDlbaiCfoU%3D" alt=" " loading="lazy"/></p>
<h4 data-id="heading-12">步骤 5：写入本地磁盘</h4>
<p>再添加一个节点Write Files from Disk。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68a3290c2cc547fc9fa6facc6f0720cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=5HjumOFXO6HD05Pp644LTHqhv10%3D" alt=" " loading="lazy"/></p>
<p>在File Path and Name输入文件名称（例如：lucianaib.text），点击Execute step（执行步骤）按钮，右侧output那边就会出现输出的内容。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a12a061ae1bb4f4a896c628a1037552f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=j3KYflCt%2Ft0%2Fx1i7fXp2WfwyH5o%3D" alt=" " loading="lazy"/></p>
<h4 data-id="heading-13">步骤 6：下载文件 &amp; 保存工作流</h4>
<p>点击右边的Download文件就被下载下来了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d2df39a56b44db79c8776af3276fa04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=UCqnWeKGuz7w0Jf1sCvJkDf1QXU%3D" alt=" " loading="lazy"/></p>
<p>回到主界面我们点击Execute workflow，执行整个工作流，成功的右下角都会出现一个勾的图标</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e72ca935fb9c41f6964361cf4f4c1d32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=l59ElJltjn9drOfRgevNCdgDmhI%3D" alt=" " loading="lazy"/></p>
<p>一切都没问题后就可以点击右上角的<code>save</code>保存了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/392b3afa4e8541bcacd107bba0c7fafe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=02oZOQuPNZMDBUbqTYnF9SN0IoA%3D" alt=" " loading="lazy"/></p>
<p>左上角这边可以更改工作流的名称和添加标签。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8bd5379080c45569b976b82edd2951c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=i4%2BnZ1SaeMom6DjO7Hc0Eagz2oE%3D" alt=" " loading="lazy"/></p>
<p>右侧这边可以复制，下载，导入工作流等操作。可以方便把工作流分享给别人或直接使用别人的工作流。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1d9f6686e4a455eb1f463b6e6c74a8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348231&amp;x-signature=Rdl2DPQLXqAaJ6vJzsAUgyb4Mck%3D" alt=" " loading="lazy"/></p>
<blockquote>
<p>提示：工作流支持一键导出/导入，方便分享或迁移。</p>
</blockquote>
<h2 data-id="heading-14">学习路径</h2>
<p>LucianaiB带你从 0 到 1 玩转 N8N 知识库：<a href="https://link.juejin.cn?target=https%3A%2F%2Flucianaib.feishu.cn%2Fwiki%2FYQMHwn0Bli1LFrkeHbMcdqQ6ndg%3Ffrom%3Dfrom_copylink" target="_blank" title="https://lucianaib.feishu.cn/wiki/YQMHwn0Bli1LFrkeHbMcdqQ6ndg?from=from_copylink" ref="nofollow noopener noreferrer">LucianaiB带你从 0 到 1 玩转 N8N</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再让大模型“胡说八道”了！LangChain 的 JsonOutputParser 教你驯服 AI 输出]]></title>    <link>https://juejin.cn/post/7587776610436038671</link>    <guid>https://juejin.cn/post/7587776610436038671</guid>    <pubDate>2025-12-26T09:45:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587776610436038671" data-draft-id="7587277503947882496" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再让大模型“胡说八道”了！LangChain 的 JsonOutputParser 教你驯服 AI 输出"/> <meta itemprop="keywords" content="LangChain,LLM,AIGC"/> <meta itemprop="datePublished" content="2025-12-26T09:45:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="生椰丝绒拿铁"/> <meta itemprop="url" content="https://juejin.cn/user/4185180725584116"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再让大模型“胡说八道”了！LangChain 的 JsonOutputParser 教你驯服 AI 输出
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4185180725584116/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    生椰丝绒拿铁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:45:17.000Z" title="Fri Dec 26 2025 09:45:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>从“前端模块化”到“AI输出格式”，我们都在和混乱做斗争**</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">🧠 引子：当 AI 开始“自由发挥”</h2>
<p>你有没有遇到过这样的场景？</p>
<p>你辛辛苦苦写了一堆提示词（prompt），满怀期待地调用大模型，结果它回你一段：</p>
<blockquote>
<p>“好的！关于 Promise，这是一个 JavaScript 中用于处理异步操作的对象。它的核心思想是……（省略 300 字小作文）”</p>
</blockquote>
<p>而你真正想要的，只是一个干净、结构化的 JSON！</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Promise"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"core"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用于处理异步操作的代理对象"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"useCase"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"网络请求"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"定时任务"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"并发控制"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"difficulty"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"中等"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>是不是想砸键盘？别急——<strong>LangChain 的 <code>JsonOutputParser</code> 就是来拯救你的！</strong></p>
<hr/>
<h2 data-id="heading-1">📦 背景小剧场：从前端模块化说起</h2>
<p>在讲 LangChain 之前，咱们先穿越回“远古时代”的前端开发。</p>
<h3 data-id="heading-2">🕰️ 没有模块化的年代</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"a.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"b.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-number">18</span>);
  p.<span class="hljs-title function_">sayName</span>(); <span class="hljs-comment">// 希望 a.js 里定义了 Person...</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>那时候，JS 文件之间靠“默契”共享变量，一不小心就全局污染、命名冲突、依赖顺序错乱……简直是“混沌宇宙”。</p>
<p>后来，Node.js 带来了 <strong>CommonJS</strong>，ES6 推出了 <strong>import/export</strong>，前端终于有了清晰的模块边界。</p>
<blockquote>
<p><strong>模块化 = 约定 + 结构 + 可预测性</strong></p>
</blockquote>
<p>而今天，我们在调用大模型时，也面临同样的问题：<strong>输出太“自由”，缺乏结构</strong>。<br/>
于是，LangChain 给我们带来了“AI 世界的模块化工具”——<code>OutputParser</code>。</p>
<hr/>
<h2 data-id="heading-3">🔧 LangChain 的救星：JsonOutputParser</h2>
<p><code>JsonOutputParser</code> 是 LangChain 提供的一个<strong>输出解析器</strong>，专门用来把 LLM 返回的“散文”变成<strong>结构化数据</strong>（比如 JSON）。配合 Zod（一个超好用的 TypeScript 校验库），还能自动校验字段类型、枚举值、数组结构等。</p>
<h3 data-id="heading-4">✨ 它能做什么？</h3>
<ul>
<li>强制模型只输出 JSON（通过提示词约束）</li>
<li>自动解析字符串为 JS 对象</li>
<li>用 Zod Schema 验证数据合法性</li>
<li>报错时告诉你哪里不符合预期（而不是默默返回 undefined）</li>
</ul>
<hr/>
<h2 data-id="heading-5">🛠️ 实战：用 LangChain 解析“前端概念”</h2>
<p>假设我们要让 AI 解释一个前端概念（比如 <code>Promise</code>），并返回标准化 JSON。</p>
<h3 data-id="heading-6">第一步：定义 Schema（用 Zod）</h3>
<pre><code class="hljs language-css" lang="css">import { z } <span class="hljs-selector-tag">from</span> 'zod';

const FrontendConceptSchema = z<span class="hljs-selector-class">.object</span>({
  name: z.<span class="hljs-built_in">string</span>().<span class="hljs-built_in">describe</span>(<span class="hljs-string">"概念名称"</span>),
  core: z.<span class="hljs-built_in">string</span>().<span class="hljs-built_in">describe</span>(<span class="hljs-string">"核心要点"</span>),
  useCase: z.<span class="hljs-built_in">array</span>(z.<span class="hljs-built_in">string</span>()).<span class="hljs-built_in">describe</span>(<span class="hljs-string">"常见使用场景"</span>),
  difficulty: z.<span class="hljs-built_in">enum</span>([<span class="hljs-string">'简单'</span>, <span class="hljs-string">'中等'</span>, <span class="hljs-string">'复杂'</span>]).<span class="hljs-built_in">describe</span>(<span class="hljs-string">"学习难度"</span>)
});
</code></pre>
<blockquote>
<p>这就像给 AI 发了一份“填空试卷”，还规定了每道题只能填什么类型！</p>
</blockquote>
<h3 data-id="heading-7">第二步：创建 Parser 和 Prompt</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JsonOutputParser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/output_parsers'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/prompts'</span>;

<span class="hljs-keyword">const</span> jsonParser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonOutputParser</span>(<span class="hljs-title class_">FrontendConceptSchema</span>);

<span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">PromptTemplate</span>.<span class="hljs-title function_">fromTemplate</span>(<span class="hljs-string">`
你是一个只会输出 JSON 的 API，不允许输出任何解释性文字。

⚠️ 你必须【只返回】符合以下 Schema 的 JSON：
- 不允许增加或减少字段
- 字段名必须完全一致
- 返回结果必须能被 JSON.parse 成功解析

{format_instructions}

前端概念：{topic}
`</span>);
</code></pre>
<p>注意 <code>{format_instructions}</code> ——这是 <code>JsonOutputParser</code> 自动生成的格式说明，会告诉模型具体该怎么写 JSON！</p>
<p>比如它可能生成：</p>
<blockquote>
<p>The output should be a markdown code snippet formatted in the following schema:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"core"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"useCase"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span> ...<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"difficulty"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"简单"</span> | <span class="hljs-string">"中等"</span> | <span class="hljs-string">"复杂"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</blockquote>
<h3 data-id="heading-8">第三步：组装 Chain 并调用</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">chain</span> = prompt.pipe(model).pipe(jsonParser)<span class="hljs-comment">;</span>

const <span class="hljs-attr">response</span> = await chain.invoke({
  topic: 'Promise',
  format_instructions: jsonParser.getFormatInstructions(),
})<span class="hljs-comment">;</span>

console.log(response)<span class="hljs-comment">;</span>
// ✅ 得到干净的 JS 对象！
</code></pre>
<hr/>
<h2 data-id="heading-9">😂 为什么这很重要？——因为 AI 太“人性化”了！</h2>
<p>大模型天生喜欢“聊天”，它总想多说几句：“亲，你还想知道 async/await 吗？”<br/>
但我们的程序需要的是<strong>确定性</strong>，不是“贴心客服”。</p>
<blockquote>
<p><strong>AI 的自由 = 程序员的噩梦</strong><br/>
<strong>结构化的输出 = 自动化的基石</strong></p>
</blockquote>
<p>用 <code>JsonOutputParser</code>，相当于给 AI 戴上“嘴套”，只让它吐 JSON，不许废话！</p>
<hr/>
<h2 data-id="heading-10">🚀 进阶思考：不只是 JSON，更是契约</h2>
<p>其实，<code>JsonOutputParser</code> 背后的思想，和前端模块化、API 设计、TypeScript 类型系统一脉相承：</p>
<blockquote>
<p><strong>明确输入输出，才能构建可靠系统。</strong></p>
</blockquote>
<p>当你用 Zod 定义 Schema 时，你不仅是在约束 AI，更是在<strong>建立人与 AI 之间的契约</strong>。这个契约让后续的数据处理、UI 渲染、数据库存储变得安全可靠。</p>
<hr/>
<h2 data-id="heading-11">✅ 总结：三句话记住 JsonOutputParser</h2>
<ol>
<li><strong>AI 天生爱啰嗦，JsonOutputParser 让它闭嘴只吐 JSON。</strong></li>
<li><strong>Zod Schema 是“法律”，parser 是“警察”，确保输出合法合规。</strong></li>
<li><strong>结构化输出 = 自动化流水线的第一块砖。</strong></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[事件委托（Event Delegation）的原理]]></title>    <link>https://juejin.cn/post/7588007285545910278</link>    <guid>https://juejin.cn/post/7588007285545910278</guid>    <pubDate>2025-12-26T10:01:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588007285545910278" data-draft-id="7587825267877740585" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="事件委托（Event Delegation）的原理"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-26T10:01:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cindershade"/> <meta itemprop="url" content="https://juejin.cn/user/2587590326494763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            事件委托（Event Delegation）的原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2587590326494763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cindershade
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:01:25.000Z" title="Fri Dec 26 2025 10:01:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">优化前的问题</h3>
<p>原来的代码是这样的：</p>
<pre><code class="hljs language-TSX" lang="TSX">{allCategories.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">category</span>) =&gt;</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
    <span class="hljs-attr">key</span>=<span class="hljs-string">{category.id}</span>
    <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.categoryItem}</span>
    <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onCategoryChange(category.slug)}  // ❌ 每个 item 都创建新函数
  &gt;
    {/* ... */}
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
))}
</code></pre>
<p>问题分析：</p>
<ol>
<li>每次渲染都会为每个分类项创建一个新的箭头函数：() =&gt; onCategoryChange(category.slug)</li>
</ol>

<ol start="2">
<li>假设有 20 个分类，就会创建 20 个函数，这些函数会形成闭包，占用内存</li>
</ol>

<ol start="3">
<li>每次组件重新渲染时，React 会认为 onClick 是一个新的函数引用，可能导致不必要的子组件重新渲染</li>
</ol>

<ol start="4">
<li>虽然通常不是性能瓶颈，但在分类数量很多时，这会造成不必要的开销</li>
</ol>
<h3 data-id="heading-1">二、事件委托（Event Delegation）的原理</h3>
<p>事件委托将事件处理函数绑定到父容器上，而不是每个子元素。利用事件冒泡，点击子元素时，事件会冒泡到父容器，父容器的事件处理函数接收事件，并根据目标元素执行相应逻辑。事件冒泡示意图：</p>
<pre><code class="hljs language-TEXT" lang="TEXT">点击子元素 → 事件冒泡 → 父容器捕获事件 → 根据 target 判断处理逻辑
</code></pre>
<h3 data-id="heading-2">三、优化后的实现</h3>
<h4 data-id="heading-3">1. 在父容器上绑定统一的事件处理函数</h4>
<pre><code class="hljs language-TSX" lang="TSX"> <span class="hljs-comment">// 处理分类列表点击 - 使用事件委托</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCategoryListClick</span> = (<span class="hljs-params">e: React.MouseEvent&lt;HTMLDivElement&gt;</span>) =&gt; {
    <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>;
    <span class="hljs-comment">// 向上查找最近的 categoryItem 元素</span>
    <span class="hljs-keyword">const</span> categoryItem = target.<span class="hljs-title function_">closest</span>(<span class="hljs-string">`.<span class="hljs-subst">${styles.categoryItem}</span>`</span>);
    <span class="hljs-keyword">if</span> (categoryItem) {
      <span class="hljs-keyword">const</span> categorySlug = categoryItem.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'data-category-slug'</span>);
      <span class="hljs-keyword">if</span> (categorySlug) {
        <span class="hljs-title function_">onCategoryChange</span>(categorySlug);
      }
    }
  };
</code></pre>
<p>函数执行流程：</p>
<ol>
<li>e.target 获取被点击的具体元素（可能是图标、文字等）</li>
</ol>

<ol start="2">
<li>closest() 向上查找最近的 .categoryItem 元素</li>
</ol>

<ol start="3">
<li>从该元素读取 data-category-slug 属性</li>
</ol>

<ol start="4">
<li>调用 onCategoryChange(categorySlug)</li>
</ol>
<h4 data-id="heading-4">2. 在父容器上绑定事件</h4>
<pre><code class="hljs language-HTML" lang="HTML">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.categoryList}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleCategoryListClick}</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">3. 为每个 item 添加 data 属性</h4>
<pre><code class="hljs language-ini" lang="ini">  <span class="hljs-attr">data-category-slug</span>={category.slug}
</code></pre>
<p>使用 data-* 属性存储分类标识，符合 HTML5 规范。</p>
<h3 data-id="heading-6">四、代码执行流程示例</h3>
<p>假设用户点击了"热门工具"分类项：</p>
<pre><code class="hljs language-TEXT" lang="TEXT">1. 用户点击 "热门工具" 文字
   ↓
2. 事件冒泡到 &lt;div className={styles.categoryList}&gt;
   ↓
3. handleCategoryListClick 函数被触发
   ↓
4. e.target = &lt;span className={styles.categoryName}&gt;热门工具&lt;/span&gt;
   ↓
5. target.closest('.categoryItem') 向上查找
   → 找到 &lt;div className={styles.categoryItem} data-category-slug="hot"&gt;
   ↓
6. categoryItem.getAttribute('data-category-slug') 
   → 返回 "hot"
   ↓
7. 调用 onCategoryChange("hot")
   ↓
8. 完成分类切换
</code></pre>
<h3 data-id="heading-7">五、为什么使用 closest()？</h3>
<p>因为点击可能发生在 item 内部的任意元素上（图标、文字等）。closest() 可以向上查找最近的匹配元素：</p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.categoryItem}</span> <span class="hljs-attr">data-category-slug</span>=<span class="hljs-string">"hot"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.categoryContent}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.categoryIcon}</span>&gt;</span>ICON<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>  // ← 可能点击这里
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>热门工具<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>                          // ← 也可能点击这里
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>无论点击图标还是文字，closest() 都能找到外层的 categoryItem。</p>
<h3 data-id="heading-8">### 六、其他优化方案的对比</h3>
<ol>
<li>创建单独的子组件 + useCallback</li>
</ol>
<ul>
<li>优点：封装性好</li>
</ul>

<ul>
<li>缺点：增加了组件层级和复杂度</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Intersection Observer 的实战方案]]></title>    <link>https://juejin.cn/post/7587995707165491219</link>    <guid>https://juejin.cn/post/7587995707165491219</guid>    <pubDate>2025-12-26T10:05:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587995707165491219" data-draft-id="7587582213060689974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Intersection Observer 的实战方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-26T10:05:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cindershade"/> <meta itemprop="url" content="https://juejin.cn/user/2587590326494763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Intersection Observer 的实战方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2587590326494763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cindershade
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:05:55.000Z" title="Fri Dec 26 2025 10:05:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Intersection Observer 的实战方案</h2>
<ul>
<li><strong>优化目标</strong>：长列表首屏渲染性能优化</li>
</ul>
<h4 data-id="heading-1">1- 用户场景</h4>
<pre><code class="hljs language-markdown" lang="markdown">用户行为路径：
<span class="hljs-bullet">1.</span> 打开 AI 工具箱页面
<span class="hljs-bullet">2.</span> 浏览热门工具（首屏）
<span class="hljs-bullet">3.</span> 滚动或点击分类导航查看特定分类工具
<span class="hljs-bullet">4.</span> 点击工具卡片查看详情
</code></pre>
<p><strong>关键问题</strong>：用户首次进入页面时，大部分工具并不在视口内，但初版实现会一次性渲染所有工具。</p>
<hr/>
<h3 data-id="heading-2">初版实现与性能瓶颈</h3>
<h4 data-id="heading-3">2.1 初版代码结构</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// AIToolboxContent.tsx - 初版实现</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AIToolboxContent</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [allToolsCategories, setAllToolsCategories] = useState&lt;<span class="hljs-title class_">CategoryWithTools</span>[]&gt;([]);
    
    <span class="hljs-comment">// 获取所有工具数据</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchAllTools</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
            <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> toolApi.<span class="hljs-title function_">getAllTools</span>();
            <span class="hljs-keyword">if</span> (response.<span class="hljs-property">code</span> === <span class="hljs-number">200</span> &amp;&amp; response.<span class="hljs-property">data</span>) {
                <span class="hljs-title function_">setAllToolsCategories</span>(response.<span class="hljs-property">data</span>);
            }
        };
        <span class="hljs-title function_">fetchAllTools</span>();
    }, []);

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.content}</span>&gt;</span>
            {/* 侧边栏 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">ToggleButton</span> {<span class="hljs-attr">...props</span>} /&gt;</span>
            
            {/* 主内容区 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{rightContainerRef}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.right}</span>&gt;</span>
                {/* 热门工具 */}
                <span class="hljs-tag">&lt;<span class="hljs-name">ToolList</span>
                    <span class="hljs-attr">title</span>=<span class="hljs-string">"热门工具"</span>
                    <span class="hljs-attr">icon</span>=<span class="hljs-string">{getCategoryIcon(</span>'<span class="hljs-attr">hot</span>')}
                    <span class="hljs-attr">tools</span>=<span class="hljs-string">{featuredTools}</span>
                /&gt;</span>

                {/* ! 一次性渲染所有分类 */}
                {allToolsCategories.map((category) =&gt; {
                    const categoryTools = category.tools.map((tool) =&gt; ({
                        id: tool.id,
                        title: tool.toolName,
                        description: tool.toolDesc,
                        iconUrl: tool.iconUrl,
                    }));

                    return (
                        <span class="hljs-tag">&lt;<span class="hljs-name">ToolList</span>
                            <span class="hljs-attr">key</span>=<span class="hljs-string">{category.categoryId}</span>
                            <span class="hljs-attr">title</span>=<span class="hljs-string">{category.categoryName}</span>
                            <span class="hljs-attr">icon</span>=<span class="hljs-string">{getCategoryIcon(category.categorySlug)}</span>
                            <span class="hljs-attr">tools</span>=<span class="hljs-string">{categoryTools}</span>
                        /&gt;</span>
                    );
                })}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<h4 data-id="heading-4">2.2 组件层级结构</h4>
<pre><code class="hljs language-scss" lang="scss">AIToolboxContent (父组件)
├── ToggleButton (侧边栏)
└── RightContainer (主内容区)
    ├── ToolList (热门工具)
    │   └── ToolCard × <span class="hljs-number">20</span>
    ├── ToolList (AI 写作)
    │   └── ToolCard × <span class="hljs-number">35</span>
    ├── ToolList (图像处理)
    │   └── ToolCard × <span class="hljs-number">42</span>
    ├── ToolList (视频生成)
    │   └── ToolCard × <span class="hljs-number">28</span>
    └── ... (共 <span class="hljs-number">15</span>+ 个 ToolList)
        └── ToolCard × N 
</code></pre>
<h4 data-id="heading-5">2.3 性能瓶颈分析</h4>
<h5 data-id="heading-6">问题 1：首屏渲染时间长</h5>
<pre><code class="hljs language-diff" lang="diff">初版性能指标（1000+ 工具）：
<span class="hljs-deletion">- 首次渲染时间：2.5s - 3.5s</span>
<span class="hljs-deletion">- DOM 节点数：3000+</span>
<span class="hljs-deletion">- 内存占用：~80MB</span>
<span class="hljs-deletion">- FCP (First Contentful Paint)：1.8s</span>
<span class="hljs-deletion">- TTI (Time to Interactive)：3.2s</span>
</code></pre>
<h5 data-id="heading-7">问题 2：无效渲染</h5>
<p><strong>问题描述</strong>：</p>
<ul>
<li>用户首屏只能看到 "热门工具" 和前 1-2 个分类（约 50 个工具）</li>
<li>但浏览器需要渲染全部 1000+ 个工具卡片</li>
<li>剩余 950+ 个不在视口内的组件完全是无效渲染</li>
</ul>
<h5 data-id="heading-8">问题 3：内存浪费</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 每个 ToolCard 组件的内存占用估算</span>
单个 <span class="hljs-title class_">ToolCard</span> 组件：
- <span class="hljs-title class_">React</span> <span class="hljs-title class_">Fiber</span> 节点：~1KB
- <span class="hljs-variable constant_">DOM</span> 节点：~2KB
- 图片资源：~50KB (懒加载前)
- 事件监听：~<span class="hljs-number">0.</span>5KB

<span class="hljs-number">1000</span> 个 <span class="hljs-title class_">ToolCard</span> 总计：
- <span class="hljs-title class_">React</span> 内存：~1MB
- <span class="hljs-variable constant_">DOM</span> 内存：~2MB
- 图片内存：~50MB (未优化)
- 总计：~53MB (仅工具卡片部分)
</code></pre>
<h5 data-id="heading-9">问题 4：滚动性能差</h5>
<ul>
<li>初次渲染后，滚动时会出现轻微卡顿</li>
<li>长列表导致浏览器重排（reflow）计算复杂</li>
</ul>
<h4 data-id="heading-10">3.1 方案设计</h4>
<h5 data-id="heading-11">核心思路</h5>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 初始状态：只渲染首屏内容（热门工具 + 占位符）
<span class="hljs-bullet">2.</span> 监听滚动：使用 Intersection Observer 监听每个分类容器
<span class="hljs-bullet">3.</span> 触发加载：当分类容器即将进入视口时（提前 200px）
<span class="hljs-bullet">4.</span> 渲染内容：替换占位符为实际的 ToolList 组件
<span class="hljs-bullet">5.</span> 保持状态：已加载的分类保持渲染状态
</code></pre>
<h5 data-id="heading-12">数据流设计</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 状态设计</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">State</span> {
  <span class="hljs-comment">// 所有工具数据（一次性获取）</span>
  <span class="hljs-attr">allToolsCategories</span>: <span class="hljs-title class_">CategoryWithTools</span>[];
  
  <span class="hljs-comment">// 记录哪些分类已经可见</span>
  <span class="hljs-attr">visibleCategories</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;; <span class="hljs-comment">// ['hot', 'writing', 'image']</span>
}

<span class="hljs-comment">// 渲染逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  allToolsCategories.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">category</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (visibleCategories.<span class="hljs-title function_">has</span>(category.<span class="hljs-property">slug</span>)) {
      <span class="hljs-comment">// 已可见 =&gt; 渲染完整 ToolList</span>
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ToolList</span> {<span class="hljs-attr">...category</span>} /&gt;</span></span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 未可见 =&gt; 渲染占位符</span>
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Placeholder</span> /&gt;</span></span>;
    }
  });
}
</code></pre>
<h5 data-id="heading-13">架构设计</h5>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────┐
│        AIToolboxContent (Container)      │
│  ┌─────────────────────────────────┐   │
│  │  <span class="hljs-keyword">Intersection</span> Observer Setup     │   │
│  │  <span class="hljs-operator">-</span> rootMargin: <span class="hljs-number">200</span>px            │   │
│  │  <span class="hljs-operator">-</span> threshold: <span class="hljs-number">0.01</span>               │   │
│  └─────────────────────────────────┘   │
│                                          │
│  ┌─────────────────────────────────┐   │
│  │  State Management               │   │
│  │  <span class="hljs-operator">-</span> visibleCategories: <span class="hljs-keyword">Set</span>       │   │
│  │  <span class="hljs-operator">-</span> toolListRefs: Map            │   │
│  └─────────────────────────────────┘   │
│                                          │
│  ┌─────────────────────────────────┐   │
│  │  Render Logic                   │   │
│  │  <span class="hljs-operator">-</span> Conditional Rendering         │   │
│  │  <span class="hljs-operator">-</span> Placeholder <span class="hljs-operator">/</span> ToolList        │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘

        ↓ <span class="hljs-keyword">Scroll</span> Event ↓

┌─────────────────────────────────────────┐
│      IntersectionObserver Callback       │
│  <span class="hljs-operator">-</span> Detect <span class="hljs-keyword">Intersection</span>                   │
│  <span class="hljs-operator">-</span> <span class="hljs-keyword">Update</span> visibleCategories             │
│  <span class="hljs-operator">-</span> <span class="hljs-keyword">Trigger</span> Re<span class="hljs-operator">-</span>render                    │
└─────────────────────────────────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-14">核心实现</h3>
<h4 data-id="heading-15">4.1 状态管理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AIToolboxContent</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 所有工具数据（按分类组织）</span>
    <span class="hljs-keyword">const</span> [allToolsCategories, setAllToolsCategories] = useState&lt;<span class="hljs-title class_">CategoryWithTools</span>[]&gt;([]);
    
    <span class="hljs-comment">// 关键状态：记录哪些分类已经可见（进入过视口）</span>
    <span class="hljs-comment">// 初始值包含 'hot'，确保热门工具立即渲染</span>
    <span class="hljs-keyword">const</span> [visibleCategories, setVisibleCategories] = useState&lt;<span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-string">'hot'</span>])
    );

    <span class="hljs-comment">// 右侧滚动容器的引用（作为 Intersection Observer 的 root）</span>
    <span class="hljs-keyword">const</span> rightContainerRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);
    
    <span class="hljs-comment">// 存储每个 ToolList 的 DOM 引用（用于滚动和观察）</span>
    <span class="hljs-keyword">const</span> toolListRefs = useRef&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">HTMLDivElement</span>&gt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());
    
    <span class="hljs-comment">// Intersection Observer 实例</span>
    <span class="hljs-keyword">const</span> observerRef = useRef&lt;<span class="hljs-title class_">IntersectionObserver</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
}
</code></pre>
<h4 data-id="heading-16">5.2 Ref 管理系统</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 设置 ToolList ref 的辅助函数</span>
<span class="hljs-comment">// 使用 useCallback 避免每次渲染都创建新函数</span>
<span class="hljs-keyword">const</span> setToolListRef = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">slug: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params">element: HTMLDivElement | <span class="hljs-literal">null</span></span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (element) {
        <span class="hljs-comment">// 元素挂载：保存引用并开始观察</span>
        toolListRefs.<span class="hljs-property">current</span>.<span class="hljs-title function_">set</span>(slug, element);
        
        <span class="hljs-comment">//  关键：立即将元素添加到 Observer 监听列表</span>
        <span class="hljs-keyword">if</span> (observerRef.<span class="hljs-property">current</span>) {
            observerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">observe</span>(element);
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 元素卸载：清理引用和监听</span>
        <span class="hljs-keyword">const</span> oldElement = toolListRefs.<span class="hljs-property">current</span>.<span class="hljs-title function_">get</span>(slug);
        <span class="hljs-keyword">if</span> (oldElement &amp;&amp; observerRef.<span class="hljs-property">current</span>) {
            observerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">unobserve</span>(oldElement);
        }
        toolListRefs.<span class="hljs-property">current</span>.<span class="hljs-title function_">delete</span>(slug);
    }
}, []);
</code></pre>
<p><strong>设计要点</strong>：</p>
<ol>
<li><strong>闭包捕获</strong>：使用柯里化（Currying）传递 <code>slug</code> 参数</li>
<li><strong>自动观察</strong>：元素挂载时自动添加到 Observer</li>
<li><strong>清理机制</strong>：元素卸载时自动移</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin Flow 深度探索与实践指南——中部：实战与应用篇]]></title>    <link>https://juejin.cn/post/7587743345197596724</link>    <guid>https://juejin.cn/post/7587743345197596724</guid>    <pubDate>2025-12-26T10:03:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587743345197596724" data-draft-id="7587738151658815488" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin Flow 深度探索与实践指南——中部：实战与应用篇"/> <meta itemprop="keywords" content="前端,Android"/> <meta itemprop="datePublished" content="2025-12-26T10:03:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青莲843"/> <meta itemprop="url" content="https://juejin.cn/user/541408646929991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin Flow 深度探索与实践指南——中部：实战与应用篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/541408646929991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青莲843
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:03:29.000Z" title="Fri Dec 26 2025 10:03:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第三部分：Flow 架构实战</h2>
<h3 data-id="heading-1">第7章：UI 层安全实践：生命周期管理</h3>
<h4 data-id="heading-2">7.1 为何 Flow 收集需要关注生命周期？</h4>
<p>Android UI 组件具有明确的生命周期，错误的 Flow 收集会导致：</p>






























<table><thead><tr><th>问题</th><th>后果</th><th>影响</th></tr></thead><tbody><tr><td><strong>内存泄漏</strong></td><td>Activity/Fragment 销毁后仍持有引用</td><td>OOM、应用崩溃</td></tr><tr><td><strong>资源浪费</strong></td><td>后台不必要的计算和网络请求</td><td>电池耗尽、流量消耗</td></tr><tr><td><strong>UI 异常</strong></td><td>视图销毁后尝试更新</td><td><code>IllegalStateException</code>、UI 闪烁</td></tr><tr><td><strong>数据不一致</strong></td><td>后台更新干扰前台显示</td><td>显示错误数据、状态混乱</td></tr></tbody></table>
<p><strong>错误示例</strong>：</p>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BadFragment</span> : <span class="hljs-type">Fragment</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)
        
        <span class="hljs-comment">// ❌ 危险：生命周期不安全的收集</span>
        lifecycleScope.launch {
            viewModel.dataFlow.collect { <span class="hljs-keyword">data</span> -&gt;
                <span class="hljs-comment">// Fragment 进入后台后，这里仍会执行！</span>
                updateUI(<span class="hljs-keyword">data</span>) <span class="hljs-comment">// 可能引发 IllegalStateException</span>
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-3">7.2 Google 的终极答案：repeatOnLifecycle 与 flowWithLifecycle</h4>
<h5 data-id="heading-4">repeatOnLifecycle（推荐）</h5>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeFragment</span> : <span class="hljs-type">Fragment</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)
        
        <span class="hljs-comment">// ✅ 推荐方式 1：使用 repeatOnLifecycle</span>
        viewLifecycleOwner.lifecycleScope.launch {
            repeatOnLifecycle(Lifecycle.State.STARTED) {
                <span class="hljs-comment">// 只有当 Fragment 至少处于 STARTED 状态时才收集</span>
                viewModel.dataFlow.collect { <span class="hljs-keyword">data</span> -&gt;
                    updateUI(<span class="hljs-keyword">data</span>)
                }
            }
            <span class="hljs-comment">// 当生命周期低于 STARTED 时，协程自动取消</span>
        }
    }
}
</code></pre>
<h5 data-id="heading-5">flowWithLifecycle（更简洁）</h5>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeFragment</span> : <span class="hljs-type">Fragment</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)
        
        <span class="hljs-comment">// ✅ 推荐方式 2：使用 flowWithLifecycle</span>
        viewLifecycleOwner.lifecycleScope.launch {
            viewModel.dataFlow
                .flowWithLifecycle(viewLifecycleOwner.lifecycle, Lifecycle.State.STARTED)
                .collect { <span class="hljs-keyword">data</span> -&gt;
                    updateUI(<span class="hljs-keyword">data</span>)
                }
        }
    }
}
</code></pre>
<p><strong>工作原理</strong>：</p>
<ul>
<li><code>repeatOnLifecycle</code>：当生命周期进入目标状态时启动新协程，离开时取消</li>
<li><code>flowWithLifecycle</code>：内部使用 <code>repeatOnLifecycle</code>，但更简洁的 API</li>
</ul>
<h4 data-id="heading-6">7.3 告别 launchWhenX：新旧写法的风险对比</h4>
<h5 data-id="heading-7">旧写法的问题（launchWhenX）</h5>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OldFragment</span> : <span class="hljs-type">Fragment</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)
        
        <span class="hljs-comment">// ❌ 问题写法：launchWhenX 不会取消 Flow</span>
        viewLifecycleOwner.lifecycleScope.launchWhenStarted {
            <span class="hljs-comment">// 问题 1：只是暂停协程，不取消 Flow 收集</span>
            <span class="hljs-comment">// 问题 2：生产者可能继续生产数据，造成缓冲堆积</span>
            <span class="hljs-comment">// 问题 3：恢复时可能错过中间状态</span>
            viewModel.dataFlow.collect { <span class="hljs-keyword">data</span> -&gt;
                updateUI(<span class="hljs-keyword">data</span>)
            }
        }
    }
}
</code></pre>
<h5 data-id="heading-8">新旧对比表</h5>



































<table><thead><tr><th>特性</th><th>launchWhenX</th><th>repeatOnLifecycle</th></tr></thead><tbody><tr><td><strong>取消机制</strong></td><td>暂停协程执行</td><td>取消整个协程</td></tr><tr><td><strong>生产者状态</strong></td><td>继续运行（可能导致背压）</td><td>停止收集，生产者可能暂停</td></tr><tr><td><strong>内存使用</strong></td><td>可能缓冲积压数据</td><td>无缓冲积压风险</td></tr><tr><td><strong>恢复行为</strong></td><td>从暂停点继续</td><td>重新开始收集</td></tr><tr><td><strong>推荐度</strong></td><td>❌ 不推荐</td><td>✅ 推荐</td></tr></tbody></table>
<h3 data-id="heading-9">7.4 最佳实践总结：不同场景下如何安全收集 Flow</h3>
<h4 data-id="heading-10">📱 <strong>核心原则一句话总结</strong>：</h4>
<p><strong>不同的 Android 组件要用不同的方式收集 Flow，但都要跟随生命周期变化，避免内存泄漏。</strong></p>
<h4 data-id="heading-11">7.4.1 Activity 中的安全收集实践</h4>
<h5 data-id="heading-12">标准写法（最安全）</h5>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        <span class="hljs-comment">// ✅ 标准写法：使用 repeatOnLifecycle</span>
        lifecycleScope.launch {
            <span class="hljs-comment">// STARTED 状态表示 Activity 可见</span>
            repeatOnLifecycle(Lifecycle.State.STARTED) {
                viewModel.userData.collect { user -&gt;
                    <span class="hljs-comment">// 安全更新 UI，不会在后台执行</span>
                    updateUserInfo(user)
                }
            }
        }
    }
}
</code></pre>
<h5 data-id="heading-13">❌ 避免写法</h5>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        <span class="hljs-comment">// ❌ 错误1：使用已弃用的 launchWhenX（不会取消 Flow）</span>
        lifecycleScope.launchWhenStarted {
            viewModel.<span class="hljs-keyword">data</span>.collect { <span class="hljs-keyword">data</span> -&gt;
                <span class="hljs-comment">// 进入后台后仍然执行，可能崩溃！</span>
                updateUI(<span class="hljs-keyword">data</span>)
            }
        }
        
        <span class="hljs-comment">// ❌ 错误2：直接收集（不关注生命周期）</span>
        lifecycleScope.launch {
            viewModel.<span class="hljs-keyword">data</span>.collect { <span class="hljs-keyword">data</span> -&gt;
                <span class="hljs-comment">// 内存泄漏风险！</span>
                updateUI(<span class="hljs-keyword">data</span>)
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-14">7.4.2 Fragment 中的安全收集实践 ⚠️（特别注意！）</h4>
<h5 data-id="heading-15">为什么 Fragment 特殊？</h5>
<p><strong>重要概念</strong>：</p>
<ul>
<li>Fragment 有两个生命周期：Fragment 自身 和 视图</li>
<li>视图可能被销毁重建（屏幕旋转、返回栈）</li>
<li><strong>必须用 <code>viewLifecycleOwner</code>，不能用 <code>lifecycleOwner</code></strong></li>
</ul>
<h5 data-id="heading-16">✅ 正确写法</h5>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HomeFragment</span> : <span class="hljs-type">Fragment</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)
        
        <span class="hljs-comment">// ✅ 正确：必须用 viewLifecycleOwner</span>
        viewLifecycleOwner.lifecycleScope.launch {
            repeatOnLifecycle(Lifecycle.State.STARTED) {
                viewModel.userData.collect { user -&gt;
                    <span class="hljs-comment">// 安全更新 UI</span>
                    binding.textName.text = user.name
                }
            }
        }
    }
}
</code></pre>
<h5 data-id="heading-17">❌ 常见错误写法</h5>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WrongFragment</span> : <span class="hljs-type">Fragment</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)
        
        <span class="hljs-comment">// ❌ 错误1：用 lifecycleOwner（应该用 viewLifecycleOwner）</span>
        lifecycleOwner.lifecycleScope.launch {
            repeatOnLifecycle(Lifecycle.State.STARTED) {
                viewModel.<span class="hljs-keyword">data</span>.collect { 
                    <span class="hljs-comment">// 视图销毁后这里还会执行！</span>
                    binding.textView.text = it  <span class="hljs-comment">// 可能崩溃！</span>
                }
            }
        }
        
        <span class="hljs-comment">// ❌ 错误2：在 onCreate 中收集</span>
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
            <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
            lifecycleScope.launch {  <span class="hljs-comment">// 视图还没创建！</span>
                viewModel.<span class="hljs-keyword">data</span>.collect { <span class="hljs-comment">/* binding 可能为空！ */</span> }
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-18">7.4.3 Compose 中的安全收集实践（最简单！）</h4>
<h5 data-id="heading-19">方法1：推荐写法（一行代码搞定）</h5>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfileScreen</span><span class="hljs-params">(viewModel: <span class="hljs-type">UserViewModel</span> = viewModel()</span></span>) {
    <span class="hljs-comment">// ✅ 最简单：自动跟随生命周期</span>
    <span class="hljs-comment">// 需要添加依赖：androidx.lifecycle:lifecycle-runtime-compose</span>
    <span class="hljs-keyword">val</span> user <span class="hljs-keyword">by</span> viewModel.userData.collectAsStateWithLifecycle()
    
    Column {
        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
            Text(text = user!!.name)
            Text(text = user!!.email)
        }
    }
}
</code></pre>
<h5 data-id="heading-20">方法2：处理一次性事件</h5>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoginScreen</span><span class="hljs-params">(viewModel: <span class="hljs-type">LoginViewModel</span> = viewModel()</span></span>) {
    <span class="hljs-keyword">val</span> state <span class="hljs-keyword">by</span> viewModel.state.collectAsStateWithLifecycle()
    
    <span class="hljs-comment">// 处理一次性事件（导航、Toast等）</span>
    <span class="hljs-keyword">val</span> sideEffects = viewModel.sideEffects
    
    LaunchedEffect(sideEffects) {
        sideEffects.collect { effect -&gt;
            <span class="hljs-keyword">when</span> (effect) {
                <span class="hljs-keyword">is</span> SideEffect.NavigateToHome -&gt; {
                    <span class="hljs-comment">// 执行导航</span>
                    navController.navigate(<span class="hljs-string">"home"</span>)
                }
                <span class="hljs-keyword">is</span> SideEffect.ShowToast -&gt; {
                    <span class="hljs-comment">// 显示 Toast</span>
                }
            }
        }
    }
    
    <span class="hljs-comment">// 渲染 UI...</span>
}
</code></pre>
<h4 data-id="heading-21">7.4.4 快速对比总结</h4>
<h5 data-id="heading-22">各场景最佳实践对比表</h5>





























<table><thead><tr><th>场景</th><th>核心要点</th><th>推荐写法</th><th>避免写法</th></tr></thead><tbody><tr><td><strong>Activity</strong></td><td>使用 <code>lifecycleScope</code> 关注整个 Activity 生命周期</td><td>✅ <code>lifecycleScope.launch { repeatOnLifecycle(STARTED) { flow.collect() } }</code></td><td>❌ <code>launchWhenX</code> ❌ 直接 <code>launch { flow.collect() }</code></td></tr><tr><td><strong>Fragment</strong></td><td><strong>必须</strong>用 <code>viewLifecycleOwner</code> 在 <code>onViewCreated</code> 中收集</td><td>✅ <code>viewLifecycleOwner.lifecycleScope.launch { repeatOnLifecycle(STARTED) { flow.collect() } }</code></td><td>❌ 用 <code>lifecycleOwner</code> ❌ 在 <code>onCreate</code> 中收集</td></tr><tr><td><strong>Compose</strong></td><td>使用专用扩展函数 自动管理生命周期</td><td>✅ <code>val data by flow.collectAsStateWithLifecycle()</code></td><td>❌ 直接 <code>collectAsState()</code> ❌ 手动管理复杂生命周期</td></tr></tbody></table>
<h4 data-id="heading-23">7.4.5 实用工具类（复制即用）</h4>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Activity 扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> ComponentActivity.<span class="hljs-title">collectWithLifecycle</span><span class="hljs-params">(
    flow: <span class="hljs-type">Flow</span>&lt;<span class="hljs-type">T</span>&gt;,
    minState: <span class="hljs-type">Lifecycle</span>.<span class="hljs-type">State</span> = Lifecycle.State.STARTED,
    action: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    lifecycleScope.launch {
        repeatOnLifecycle(minState) {
            flow.collect(action)
        }
    }
}

<span class="hljs-comment">// Fragment 扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Fragment.<span class="hljs-title">collectWithLifecycle</span><span class="hljs-params">(
    flow: <span class="hljs-type">Flow</span>&lt;<span class="hljs-type">T</span>&gt;,
    minState: <span class="hljs-type">Lifecycle</span>.<span class="hljs-type">State</span> = Lifecycle.State.STARTED,
    action: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    viewLifecycleOwner.lifecycleScope.launch {
        repeatOnLifecycle(minState) {
            flow.collect(action)
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyFragment</span> : <span class="hljs-type">Fragment</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)
        
        <span class="hljs-comment">// 一行代码搞定</span>
        collectWithLifecycle(viewModel.<span class="hljs-keyword">data</span>) { <span class="hljs-keyword">data</span> -&gt;
            binding.textView.text = <span class="hljs-keyword">data</span>
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-24">第8章：MVI 架构模式</h2>
<h3 data-id="heading-25">8.1 什么是 MVI？（一句话说清）</h3>
<p><strong>MVI = Model-View-Intent</strong><br/>
就是一个让代码更有条理的 App 架构方法，核心思想：<strong>UI 完全由数据驱动</strong></p>
<h3 data-id="heading-26">8.2 核心三要素（记住这三点就够了）</h3>
<h4 data-id="heading-27">1. State（状态）</h4>
<p><strong>是什么</strong>：当前页面所有的数据<br/>
<strong>特点</strong>：不可变的，唯一的，全部放在一起</p>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 一个页面所有的状态都放在这里</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginState</span>(
    <span class="hljs-keyword">val</span> email: String = <span class="hljs-string">""</span>,      <span class="hljs-comment">// 邮箱输入框</span>
    <span class="hljs-keyword">val</span> password: String = <span class="hljs-string">""</span>,   <span class="hljs-comment">// 密码输入框</span>
    <span class="hljs-keyword">val</span> isLoading: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 加载状态</span>
    <span class="hljs-keyword">val</span> error: String? = <span class="hljs-literal">null</span>,   <span class="hljs-comment">// 错误信息</span>
    <span class="hljs-keyword">val</span> isLoginEnabled: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>  <span class="hljs-comment">// 登录按钮是否可用</span>
)
</code></pre>
<h4 data-id="heading-28">2. Intent（意图）</h4>
<p><strong>是什么</strong>：用户的操作<br/>
<strong>特点</strong>：每个按钮点击、输入变化都是一个 Intent</p>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 用户的所有操作都用这个表示</span>
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginIntent</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailChanged</span>(<span class="hljs-keyword">val</span> email: String) : LoginIntent()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PasswordChanged</span>(<span class="hljs-keyword">val</span> password: String) : LoginIntent()
    <span class="hljs-keyword">object</span> LoginClicked : LoginIntent()
}
</code></pre>
<h4 data-id="heading-29">3. View（视图）</h4>
<p><strong>是什么</strong>：显示界面，监听用户操作<br/>
<strong>特点</strong>：只做两件事：</p>
<ol>
<li>显示 State</li>
<li>发送 Intent</li>
</ol>
<h3 data-id="heading-30">8.3 完整示例：登录页面</h3>
<h4 data-id="heading-31">ViewModel 实现（处理所有逻辑）</h4>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    
    <span class="hljs-comment">// 1. 定义 State（这是唯一的真相）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _state = MutableStateFlow(LoginState())
    <span class="hljs-keyword">val</span> state: StateFlow&lt;LoginState&gt; = _state
    
    <span class="hljs-comment">// 2. 定义一次性事件（Toast、导航等）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _events = MutableSharedFlow&lt;LoginEvent&gt;()
    <span class="hljs-keyword">val</span> events: SharedFlow&lt;LoginEvent&gt; = _events
    
    <span class="hljs-comment">// 3. 处理用户操作</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processIntent</span><span class="hljs-params">(intent: <span class="hljs-type">LoginIntent</span>)</span></span> {
        <span class="hljs-keyword">when</span> (intent) {
            <span class="hljs-keyword">is</span> LoginIntent.EmailChanged -&gt; {
                <span class="hljs-comment">// 更新邮箱</span>
                _state.value = _state.value.copy(
                    email = intent.email,
                    isLoginEnabled = intent.email.isNotEmpty() &amp;&amp; 
                                     _state.value.password.isNotEmpty()
                )
            }
            
            <span class="hljs-keyword">is</span> LoginIntent.PasswordChanged -&gt; {
                <span class="hljs-comment">// 更新密码</span>
                _state.value = _state.value.copy(
                    password = intent.password,
                    isLoginEnabled = _state.value.email.isNotEmpty() &amp;&amp; 
                                     intent.password.isNotEmpty()
                )
            }
            
            LoginIntent.LoginClicked -&gt; {
                <span class="hljs-comment">// 点击登录按钮</span>
                login()
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">login</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            <span class="hljs-comment">// 1. 显示加载</span>
            _state.value = _state.value.copy(isLoading = <span class="hljs-literal">true</span>)
            
            delay(<span class="hljs-number">2000</span>) <span class="hljs-comment">// 模拟网络请求</span>
            
            <span class="hljs-comment">// 2. 登录成功</span>
            _state.value = _state.value.copy(isLoading = <span class="hljs-literal">false</span>)
            
            <span class="hljs-comment">// 3. 发送导航事件（一次性）</span>
            _events.emit(LoginEvent.NavigateToHome)
            
            <span class="hljs-comment">// 4. 发送 Toast 事件</span>
            _events.emit(LoginEvent.ShowToast(<span class="hljs-string">"登录成功！"</span>))
        }
    }
}

<span class="hljs-comment">// 一次性事件（不保存在 State 中）</span>
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginEvent</span> {
    <span class="hljs-keyword">object</span> NavigateToHome : LoginEvent()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShowToast</span>(<span class="hljs-keyword">val</span> message: String) : LoginEvent()
}
</code></pre>
<h4 data-id="heading-32">Activity/Fragment 实现（显示界面）</h4>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> viewModel: LoginViewModel <span class="hljs-keyword">by</span> viewModels()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        <span class="hljs-comment">// 1. 监听 State 变化，更新 UI</span>
        lifecycleScope.launch {
            repeatOnLifecycle(Lifecycle.State.STARTED) {
                viewModel.state.collect { state -&gt;
                    <span class="hljs-comment">// 更新所有 UI</span>
                    updateUI(state)
                }
            }
        }
        
        <span class="hljs-comment">// 2. 监听一次性事件（导航、Toast）</span>
        lifecycleScope.launch {
            repeatOnLifecycle(Lifecycle.State.STARTED) {
                viewModel.events.collect { event -&gt;
                    <span class="hljs-keyword">when</span> (event) {
                        <span class="hljs-keyword">is</span> LoginEvent.NavigateToHome -&gt; {
                            <span class="hljs-comment">// 跳转到首页</span>
                            startActivity(Intent(<span class="hljs-keyword">this</span><span class="hljs-symbol">@LoginActivity</span>, HomeActivity::<span class="hljs-keyword">class</span>.java))
                        }
                        <span class="hljs-keyword">is</span> LoginEvent.ShowToast -&gt; {
                            Toast.makeText(<span class="hljs-keyword">this</span><span class="hljs-symbol">@LoginActivity</span>, event.message, Toast.LENGTH_SHORT).show()
                        }
                    }
                }
            }
        }
        
        <span class="hljs-comment">// 3. 设置点击监听，发送 Intent</span>
        binding.buttonLogin.setOnClickListener {
            viewModel.processIntent(LoginIntent.LoginClicked)
        }
        
        binding.editEmail.addTextChangedListener {
            viewModel.processIntent(LoginIntent.EmailChanged(it.toString()))
        }
        
        binding.editPassword.addTextChangedListener {
            viewModel.processIntent(LoginIntent.PasswordChanged(it.toString()))
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateUI</span><span class="hljs-params">(state: <span class="hljs-type">LoginState</span>)</span></span> {
        <span class="hljs-comment">// 根据 State 更新所有 UI</span>
        binding.editEmail.setText(state.email)
        binding.editPassword.setText(state.password)
        binding.buttonLogin.isEnabled = state.isLoginEnabled
        binding.progressBar.isVisible = state.isLoading
        
        <span class="hljs-keyword">if</span> (state.error != <span class="hljs-literal">null</span>) {
            Toast.makeText(<span class="hljs-keyword">this</span>, state.error, Toast.LENGTH_SHORT).show()
        }
    }
}
</code></pre>
<h3 data-id="heading-33">8.4 MVI 的工作流程（超简单图解）</h3>
<p>text</p>
<pre><code class="hljs language-ini" lang="ini">用户点击按钮
    ↓
发送 LoginClicked Intent
    ↓
ViewModel 处理 Intent
    ↓
更新 State（<span class="hljs-attr">isLoading</span> = <span class="hljs-literal">true</span>）
    ↓
UI 自动更新（显示加载动画）
    ↓
网络请求完成
    ↓
更新 State（<span class="hljs-attr">isLoading</span> = <span class="hljs-literal">false</span>）
    ↓
发送 NavigateToHome Event
    ↓
UI 收到 Event，跳转页面
</code></pre>
<h3 data-id="heading-34">8.5 为什么用 MVI？（三大好处）</h3>
<h4 data-id="heading-35">1. 代码清晰</h4>
<ul>
<li>所有状态在一个地方</li>
<li>所有操作在一个地方处理</li>
<li>UI 只负责显示和发送事件</li>
</ul>
<h4 data-id="heading-36">2. 容易调试</h4>
<ul>
<li>知道当前所有状态</li>
<li>知道每个操作如何改变状态</li>
<li>可以"时间旅行"（记录所有状态变化）</li>
</ul>
<h4 data-id="heading-37">3. 避免 bug</h4>
<ul>
<li>State 不可变，不会意外修改</li>
<li>单向数据流，不会循环更新</li>
<li>事件一次性，不会重复触发</li>
</ul>
<h3 data-id="heading-38">8.6 简单版 BaseViewModel（复制直接用）</h3>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 简单的 BaseViewModel，大部分场景够用了</span>
<span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleViewModel</span>&lt;<span class="hljs-type">State, Event</span>&gt; : <span class="hljs-type">ViewModel</span>() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _state = MutableStateFlow(initialState)
    <span class="hljs-keyword">val</span> state: StateFlow&lt;State&gt; = _state
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _events = MutableSharedFlow&lt;Event&gt;()
    <span class="hljs-keyword">val</span> events: SharedFlow&lt;Event&gt; = _events
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">open</span> <span class="hljs-keyword">val</span> initialState: State
        <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">throw</span> NotImplementedError(<span class="hljs-string">"必须提供初始状态"</span>)
    
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateState</span><span class="hljs-params">(newState: <span class="hljs-type">State</span>)</span></span> {
        _state.value = newState
    }
    
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateState</span><span class="hljs-params">(updater: (<span class="hljs-type">State</span>) -&gt; <span class="hljs-type">State</span>)</span></span> {
        _state.update(updater)
    }
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sendEvent</span><span class="hljs-params">(event: <span class="hljs-type">Event</span>)</span></span> {
        _events.emit(event)
    }
    
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">postEvent</span><span class="hljs-params">(event: <span class="hljs-type">Event</span>)</span></span> {
        viewModelScope.launch {
            _events.emit(event)
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterViewModel</span> : <span class="hljs-type">SimpleViewModel</span>&lt;<span class="hljs-type">CounterState, CounterEvent</span>&gt;() {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> initialState = CounterState()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span></span> {
        updateState { it.copy(count = it.count + <span class="hljs-number">1</span>) }
        
        <span class="hljs-keyword">if</span> (state.value.count == <span class="hljs-number">10</span>) {
            postEvent(CounterEvent.ShowToast(<span class="hljs-string">"达到10了！"</span>))
        }
    }
}

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterState</span>(<span class="hljs-keyword">val</span> count: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>)
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterEvent</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShowToast</span>(<span class="hljs-keyword">val</span> message: String) : CounterEvent()
}
</code></pre>
<h3 data-id="heading-39">8.7 一句话总结 MVI</h3>
<p><strong>把所有状态放在一起，把所有操作放在一起处理，让 UI 只做显示和发送事件。</strong></p>
<h4 data-id="heading-40">记住三句话：</h4>
<ol>
<li><strong>State 决定 UI 长什么样</strong></li>
<li><strong>Intent 是用户做了什么</strong></li>
<li><strong>ViewModel 处理 Intent，更新 State</strong></li>
</ol>
<h4 data-id="heading-41">最简单的 MVI 代码结构：</h4>
<p>text</p>
<pre><code class="hljs language-vbnet" lang="vbnet">页面
├── State（数据类，所有状态）
├── Intent（密封类，所有操作）
├── <span class="hljs-keyword">Event</span>（密封类，一次性事件）
├── ViewModel（处理 Intent，更新 State）
└── UI（显示 State，发送 Intent，监听 <span class="hljs-keyword">Event</span>）
</code></pre>
<hr/>
<h2 data-id="heading-42">第9章：数据层设计：Repository 模式革新</h2>
<h3 data-id="heading-43">9.1 使用 Flow 封装网络请求</h3>
<h4 data-id="heading-44">传统方式 vs Flow 方式</h4>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 传统方式：回调地狱</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OldUserRepository</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>, callback: (<span class="hljs-type">Result</span>&lt;<span class="hljs-type">User</span>&gt;) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        <span class="hljs-comment">// 复杂的嵌套回调...</span>
    }
}

<span class="hljs-comment">// ✅ Flow 方式：声明式、可组合</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> localDataSource: UserLocalDataSource,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> remoteDataSource: UserRemoteDataSource
) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: Flow&lt;User&gt; = flow {
        <span class="hljs-comment">// 1. 先发射本地数据（如果有）</span>
        localDataSource.getUser(userId).collect { cachedUser -&gt;
            <span class="hljs-keyword">if</span> (cachedUser != <span class="hljs-literal">null</span>) {
                emit(cachedUser)
            }
        }
        
        <span class="hljs-comment">// 2. 获取远程数据</span>
        <span class="hljs-keyword">val</span> remoteUser = remoteDataSource.getUser(userId)
        
        <span class="hljs-comment">// 3. 保存到本地</span>
        localDataSource.saveUser(remoteUser)
        
        <span class="hljs-comment">// 4. 发射远程数据</span>
        emit(remoteUser)
    }.<span class="hljs-keyword">catch</span> { error -&gt;
        <span class="hljs-comment">// 错误处理</span>
        <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">is</span> IOException) {
            emit(localDataSource.getLastKnownUser(userId))
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> error
        }
    }
}
</code></pre>
<h3 data-id="heading-45">9.2 实现 "单一数据源" 架构</h3>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NewsRepository</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> newsDao: NewsDao,          <span class="hljs-comment">// 本地数据库 - 唯一可信源</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> newsApi: NewsApi,          <span class="hljs-comment">// 网络数据源</span>
) {
    <span class="hljs-comment">// ✅ 单一可信源：只从数据库暴露数据</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getNews</span><span class="hljs-params">()</span></span>: Flow&lt;List&lt;Article&gt;&gt; = newsDao.getAllArticles()
    
    <span class="hljs-comment">// 刷新数据（网络 -&gt; 数据库）</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">refreshNews</span><span class="hljs-params">()</span></span>: Result&lt;<span class="hljs-built_in">Unit</span>&gt; = withContext(Dispatchers.IO) {
        <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> articles = newsApi.getLatestNews()
            newsDao.clearAndInsertAll(articles)
            Result.success(<span class="hljs-built_in">Unit</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Result.failure(e)
        }
    }
}
</code></pre>
<h3 data-id="heading-46">9.3 Flow 与 Retrofit、Room 的集成</h3>
<h4 data-id="heading-47">Retrofit + Flow</h4>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">NewsApi</span> {
    <span class="hljs-comment">// ✅ 支持 suspend 函数</span>
    <span class="hljs-meta">@GET(<span class="hljs-string">"news/latest"</span>)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getLatestNews</span><span class="hljs-params">()</span></span>: List&lt;ArticleDto&gt;
}

<span class="hljs-comment">// Repository 中使用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NewsRepository</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> newsApi: NewsApi
) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getLatestNews</span><span class="hljs-params">()</span></span>: Flow&lt;List&lt;Article&gt;&gt; = flow {
        <span class="hljs-keyword">val</span> newsDto = newsApi.getLatestNews()
        <span class="hljs-keyword">val</span> news = newsDto.map { it.toDomain() }
        emit(news)
    }
}
</code></pre>
<h4 data-id="heading-48">Room + Flow</h4>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Dao</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ArticleDao</span> {
    <span class="hljs-comment">// ✅ Room 原生支持 Flow</span>
    <span class="hljs-meta">@Query(<span class="hljs-string">"SELECT * FROM articles ORDER BY publish_date DESC"</span>)</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getAllArticles</span><span class="hljs-params">()</span></span>: Flow&lt;List&lt;ArticleEntity&gt;&gt;
}
</code></pre>
<h3 data-id="heading-49">9.4 缓存策略</h3>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartCacheRepository</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> memoryCache: MemoryCache,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> diskCache: DiskCache,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> remoteDataSource: RemoteDataSource
) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getData</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: Flow&lt;Data&gt; = flow {
        <span class="hljs-comment">// 1. 检查内存缓存（最快）</span>
        memoryCache.<span class="hljs-keyword">get</span>(id)?.let { cachedData -&gt;
            emit(cachedData)
            <span class="hljs-keyword">return</span><span class="hljs-symbol">@flow</span>
        }
        
        <span class="hljs-comment">// 2. 检查磁盘缓存</span>
        diskCache.<span class="hljs-keyword">get</span>(id)?.let { cachedData -&gt;
            <span class="hljs-comment">// 存入内存缓存</span>
            memoryCache.put(id, cachedData)
            emit(cachedData)
        }
        
        <span class="hljs-comment">// 3. 从网络获取</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> remoteData = remoteDataSource.getData(id)
            
            <span class="hljs-comment">// 4. 更新两级缓存</span>
            memoryCache.put(id, remoteData)
            diskCache.put(id, remoteData)
            
            emit(remoteData)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-comment">// 网络失败，返回空数据</span>
            emit(Data.EMPTY)
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-50">第10章：Flow 与 Paging 3：无缝处理分页加载</h2>
<h3 data-id="heading-51">10.1 基本使用</h3>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 定义 PagingSource</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExamplePagingSource</span> : <span class="hljs-type">PagingSource</span>&lt;<span class="hljs-type">Int, Item</span>&gt;() {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(params: <span class="hljs-type">LoadParams</span>&lt;<span class="hljs-type">Int</span>&gt;)</span></span>: LoadResult&lt;<span class="hljs-built_in">Int</span>, Item&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> page = params.key ?: <span class="hljs-number">1</span>
            <span class="hljs-keyword">val</span> response = api.getItems(page, params.loadSize)
            
            LoadResult.Page(
                <span class="hljs-keyword">data</span> = response.items,
                prevKey = <span class="hljs-keyword">if</span> (page == <span class="hljs-number">1</span>) <span class="hljs-literal">null</span> <span class="hljs-keyword">else</span> page - <span class="hljs-number">1</span>,
                nextKey = <span class="hljs-keyword">if</span> (response.hasMore) page + <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
            )
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            LoadResult.Error(e)
        }
    }
}

<span class="hljs-comment">// 2. 创建 Pager</span>
<span class="hljs-keyword">val</span> pager = Pager(
    config = PagingConfig(pageSize = <span class="hljs-number">20</span>),
    pagingSourceFactory = { ExamplePagingSource() }
)

<span class="hljs-comment">// 3. 获取 Flow&lt;PagingData&gt;</span>
<span class="hljs-keyword">val</span> pagingDataFlow: Flow&lt;PagingData&lt;Item&gt;&gt; = pager.flow
</code></pre>
<h3 data-id="heading-52">10.2 cachedIn(viewModelScope) 的魔力</h3>
<p>kotlin</p>
<pre><code class="hljs language-scss" lang="scss">class MyViewModel : <span class="hljs-built_in">ViewModel</span>() {
    val items: Flow&lt;PagingData&lt;Item&gt;&gt; = <span class="hljs-built_in">Pager</span>(
        config = <span class="hljs-built_in">PagingConfig</span>(pageSize = <span class="hljs-number">20</span>),
        pagingSourceFactory = { <span class="hljs-built_in">ItemPagingSource</span>(api) }
    )
        <span class="hljs-selector-class">.flow</span>
        <span class="hljs-selector-class">.cachedIn</span>(viewModelScope) <span class="hljs-comment">// 缓存到 ViewModel 的作用域</span>
}
</code></pre>
<p><strong>为什么需要 <code>cachedIn</code>？</strong></p>
<ul>
<li>避免在配置更改时重新加载数据</li>
<li>在多个收集者之间共享同一分页数据流</li>
<li>确保数据在 ViewModel 生命周期内保持一致</li>
</ul>
<h3 data-id="heading-53">10.3 在 UI 中使用</h3>
<h4 data-id="heading-54">RecyclerView 中使用</h4>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> viewModel: MyViewModel <span class="hljs-keyword">by</span> viewModels()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> adapter: ItemAdapter
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        adapter = ItemAdapter()
        recyclerView.adapter = adapter
        
        lifecycleScope.launch {
            repeatOnLifecycle(Lifecycle.State.STARTED) {
                viewModel.items.collectLatest { pagingData -&gt;
                    adapter.submitData(pagingData)
                }
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-55">Compose 中使用</h4>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ItemListScreen</span><span class="hljs-params">(viewModel: <span class="hljs-type">MyViewModel</span> = viewModel()</span></span>) {
    <span class="hljs-keyword">val</span> items = viewModel.items.collectAsLazyPagingItems()
    
    LazyColumn {
        items(items) { item -&gt;
            <span class="hljs-keyword">if</span> (item != <span class="hljs-literal">null</span>) {
                ItemRow(item = item)
            }
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-56">第11章：Flow 与 Jetpack DataStore：告别 SharedPreferences</h2>
<h3 data-id="heading-57">11.1 基本使用</h3>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义数据存储</span>
<span class="hljs-keyword">val</span> Context.settingsDataStore: DataStore&lt;Preferences&gt; <span class="hljs-keyword">by</span> preferencesDataStore(
    name = <span class="hljs-string">"settings"</span>
)

<span class="hljs-comment">// 定义键</span>
<span class="hljs-keyword">object</span> PreferencesKeys {
    <span class="hljs-keyword">val</span> THEME = stringPreferencesKey(<span class="hljs-string">"theme"</span>)
    <span class="hljs-keyword">val</span> NOTIFICATIONS_ENABLED = booleanPreferencesKey(<span class="hljs-string">"notifications_enabled"</span>)
}

<span class="hljs-comment">// 写入数据</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveTheme</span><span class="hljs-params">(theme: <span class="hljs-type">String</span>)</span></span> {
    context.settingsDataStore.edit { preferences -&gt;
        preferences[PreferencesKeys.THEME] = theme
    }
}

<span class="hljs-comment">// 读取数据（返回 Flow）</span>
<span class="hljs-keyword">val</span> themeFlow: Flow&lt;String&gt; = context.settingsDataStore.<span class="hljs-keyword">data</span>
    .map { preferences -&gt;
        preferences[PreferencesKeys.THEME] ?: <span class="hljs-string">"light"</span>
    }
</code></pre>
<h3 data-id="heading-58">11.2 在 ViewModel 中使用</h3>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SettingsViewModel</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> dataStore: DataStore&lt;Preferences&gt;
) : ViewModel() {
    
    <span class="hljs-keyword">val</span> theme: Flow&lt;String&gt; = dataStore.<span class="hljs-keyword">data</span>
        .map { preferences -&gt;
            preferences[PreferencesKeys.THEME] ?: <span class="hljs-string">"light"</span>
        }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateTheme</span><span class="hljs-params">(theme: <span class="hljs-type">String</span>)</span></span> {
        dataStore.edit { preferences -&gt;
            preferences[PreferencesKeys.THEME] = theme
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-59">第12章：Flow 与 WorkManager：监听后台任务状态（简化版）</h2>
<h3 data-id="heading-60">12.1 基本使用</h3>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DownloadViewModel</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> workManager: WorkManager
) : ViewModel() {
    
    <span class="hljs-comment">// 监控特定 WorkRequest 的状态</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">monitorDownload</span><span class="hljs-params">(downloadId: <span class="hljs-type">UUID</span>)</span></span>: Flow&lt;WorkInfo&gt; {
        <span class="hljs-keyword">return</span> workManager.getWorkInfoByIdFlow(downloadId)
    }
}
</code></pre>
<h3 data-id="heading-61">12.2 在 UI 中监控</h3>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DownloadScreen</span><span class="hljs-params">(viewModel: <span class="hljs-type">DownloadViewModel</span>)</span></span> {
    <span class="hljs-keyword">val</span> downloadState <span class="hljs-keyword">by</span> viewModel.downloadState.collectAsState()
    
    <span class="hljs-comment">// 根据状态显示不同的 UI</span>
    <span class="hljs-keyword">when</span> (downloadState) {
        <span class="hljs-keyword">is</span> WorkInfo.State.RUNNING -&gt; {
            Text(<span class="hljs-string">"下载中..."</span>)
        }
        <span class="hljs-keyword">is</span> WorkInfo.State.SUCCEEDED -&gt; {
            Text(<span class="hljs-string">"下载完成"</span>)
        }
        <span class="hljs-keyword">is</span> WorkInfo.State.FAILED -&gt; {
            Text(<span class="hljs-string">"下载失败"</span>)
        }
        <span class="hljs-keyword">else</span> -&gt; {}
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙分布式KVStore冲突解决机制：原理、实现与工程化实践]]></title>    <link>https://juejin.cn/post/7587997893987303451</link>    <guid>https://juejin.cn/post/7587997893987303451</guid>    <pubDate>2025-12-26T10:07:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587997893987303451" data-draft-id="7587776610436136975" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙分布式KVStore冲突解决机制：原理、实现与工程化实践"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-26T10:07:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Nick不懂"/> <meta itemprop="url" content="https://juejin.cn/user/4212984286031133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙分布式KVStore冲突解决机制：原理、实现与工程化实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984286031133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Nick不懂
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:07:28.000Z" title="Fri Dec 26 2025 10:07:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">鸿蒙分布式KVStore冲突解决机制：原理、实现与工程化实践</h2>
<h3 data-id="heading-1">一、核心背景与问题定义</h3>
<p>分布式KVStore是鸿蒙（HarmonyOS/OpenHarmony）实现跨设备数据协同的核心组件，适用于应用配置、用户状态等轻量级数据的跨设备同步场景。其基于最终一致性模型设计，在多设备并发写入同一Key时，必然产生数据冲突。本文聚焦 <strong>SingleKVStore（单版本模式）</strong> 的冲突解决机制，明确核心问题边界：当组网内多个设备对同一Key执行写入操作时，如何保证数据最终一致性，同时避免业务关键数据丢失。</p>
<h3 data-id="heading-2">二、冲突产生的底层逻辑</h3>
<h4 data-id="heading-3">1. 冲突触发条件</h4>
<ul>
<li>
<p>数据维度：同一SingleKVStore实例中，不同设备对同一Key执行写入（覆盖/更新）操作；</p>
</li>
<li>
<p>网络维度：设备间网络中断后恢复连接，或多设备同时在线时并发写入；</p>
</li>
<li>
<p>系统维度：同步过程中数据传输延迟、设备时钟偏差（影响时间戳判断）。</p>
</li>
</ul>
<h4 data-id="heading-4">2. 默认冲突解决策略：LWW（Last Write Wins）</h4>
<p>鸿蒙默认采用“最后写入者获胜”策略，核心判定依据为数据的写入时间戳（系统时间）或版本号：</p>
<ul>
<li>
<p>判定逻辑：同步时对比同一Key的时间戳，保留时间戳更新的写入数据；</p>
</li>
<li>
<p>适用场景：配置类数据（如主题设置、字体大小），这类数据对“最新状态”的需求优先于“全量合并”；</p>
</li>
<li>
<p>局限性：无法处理需要结构化合并的场景（如待办清单数组、多字段对象），且设备时钟偏差可能导致错误的优先级判定。</p>
</li>
</ul>
<h3 data-id="heading-5">三、自定义冲突解决：实战实现（Stage模型+ArkTS）</h3>
<h4 data-id="heading-6">1. 前置准备：权限与依赖</h4>
<p>需在<code>module.json5</code>中声明分布式数据操作权限，确保跨设备数据同步能力正常启用：</p>
<pre><code class="hljs language-typescript" lang="typescript">
{

  <span class="hljs-string">"module"</span>: {

    <span class="hljs-string">"requestPermissions"</span>: [

      {

        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.DISTRIBUTED_DATASYNC"</span>,

        <span class="hljs-string">"reason"</span>: <span class="hljs-string">"跨设备数据同步需要"</span>,

        <span class="hljs-string">"usedScene"</span>: { <span class="hljs-string">"ability"</span>: [<span class="hljs-string">"com.demo.kvstore.DemoAbility"</span>], <span class="hljs-string">"when"</span>: <span class="hljs-string">"always"</span> }

      },

      {

        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.GET_DISTRIBUTED_DEVICE_INFO"</span>,

        <span class="hljs-string">"reason"</span>: <span class="hljs-string">"获取组网设备信息需要"</span>,

        <span class="hljs-string">"usedScene"</span>: { <span class="hljs-string">"ability"</span>: [<span class="hljs-string">"com.demo.kvstore.DemoAbility"</span>], <span class="hljs-string">"when"</span>: <span class="hljs-string">"always"</span> }

      }

    ]

  }

}

</code></pre>
<p>依赖导入（API 10+，需同步升级SDK至对应版本）：</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">import</span> distributedData <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.data.distributedData'</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.base'</span>;

<span class="hljs-keyword">import</span> deviceManager <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.distributedHardware.deviceManager'</span>;

</code></pre>
<h4 data-id="heading-7">2. 核心实现步骤</h4>
<h5 data-id="heading-8">步骤1：初始化分布式KVStore（指定单版本模式）</h5>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedKVManager</span> {

  <span class="hljs-keyword">private</span> <span class="hljs-attr">kvStore</span>: distributedData.<span class="hljs-property">SingleKVStore</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-variable constant_">STORE_NAME</span> = <span class="hljs-string">'demo_business_store'</span>; <span class="hljs-comment">// 跨设备统一存储名称</span>

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-variable constant_">SECURITY_LEVEL</span> = distributedData.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S1</span>; <span class="hljs-comment">// 基础安全等级（非加密）</span>

  


  <span class="hljs-comment">// 初始化KVStore，确保跨设备共享同一存储实例</span>

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">init</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {

    <span class="hljs-keyword">try</span> {

      <span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: distributedData.<span class="hljs-property">Options</span> = {

        <span class="hljs-attr">createIfMissing</span>: <span class="hljs-literal">true</span>,

        <span class="hljs-attr">encrypt</span>: <span class="hljs-literal">false</span>,

        <span class="hljs-attr">securityLevel</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">SECURITY_LEVEL</span>

      };

      <span class="hljs-comment">// 获取SingleKVStore实例（单版本模式，支持跨设备同步）</span>

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">kvStore</span> = <span class="hljs-keyword">await</span> distributedData.<span class="hljs-title function_">getSingleKVStore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">STORE_NAME</span>, options);

      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'DistributedKVStore初始化成功'</span>);

      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">registerConflictListener</span>(); <span class="hljs-comment">// 注册冲突监听</span>

      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

    } <span class="hljs-keyword">catch</span> (error) {

      <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;

      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`KVStore初始化失败：code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);

      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    }

  }

}

</code></pre>
<h5 data-id="heading-9">步骤2：自定义冲突解决逻辑（以待办清单合并为例）</h5>
<p>针对结构化数据（如待办清单数组），实现“数组去重合并”的自定义策略，替代默认LWW策略：</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">registerConflictListener</span>(<span class="hljs-params"/>) {

  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">kvStore</span>) <span class="hljs-keyword">return</span>;

  


  <span class="hljs-comment">// 监听所有数据变更（本地+远端），通过业务逻辑识别冲突</span>

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">kvStore</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'dataChange'</span>, distributedData.<span class="hljs-property">SubscribeType</span>.<span class="hljs-property">SUBSCRIBE_TYPE_ALL</span>, <span class="hljs-keyword">async</span> (data) =&gt; {

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> data.<span class="hljs-property">updateEntries</span>) {

      <span class="hljs-keyword">const</span> key = entry.<span class="hljs-property">key</span>;

      <span class="hljs-keyword">const</span> remoteValue = entry.<span class="hljs-property">value</span>; <span class="hljs-comment">// 远端同步过来的新数据</span>

      <span class="hljs-keyword">const</span> localValue = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">kvStore</span>!.<span class="hljs-title function_">get</span>(key); <span class="hljs-comment">// 本地当前数据</span>

  


      <span class="hljs-comment">// 1. 数据格式校验（约定value为{ ver: number, payload: any }结构）</span>

      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateDataFormat</span>(localValue) || !<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateDataFormat</span>(remoteValue)) {

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`数据格式非法，采用LWW策略：key=<span class="hljs-subst">${key}</span>`</span>);

        <span class="hljs-keyword">return</span>;

      }

  


      <span class="hljs-comment">// 2. 判定冲突：本地与远端版本号不同时视为冲突</span>

      <span class="hljs-keyword">if</span> (localValue.<span class="hljs-property">ver</span> !== remoteValue.<span class="hljs-property">ver</span>) {

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`检测到冲突：key=<span class="hljs-subst">${key}</span>，本地版本=<span class="hljs-subst">${localValue.ver}</span>，远端版本=<span class="hljs-subst">${remoteValue.ver}</span>`</span>);

        <span class="hljs-keyword">const</span> mergedValue = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">mergeTodoList</span>(localValue.<span class="hljs-property">payload</span>, remoteValue.<span class="hljs-property">payload</span>);

        <span class="hljs-keyword">const</span> newVer = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(localValue.<span class="hljs-property">ver</span>, remoteValue.<span class="hljs-property">ver</span>) + <span class="hljs-number">1</span>; <span class="hljs-comment">// 生成新版本号</span>

  


        <span class="hljs-comment">// 3. 写入合并后的数据（避免循环同步，需原子操作）</span>

        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">kvStore</span>!.<span class="hljs-title function_">put</span>(key, { <span class="hljs-attr">ver</span>: newVer, <span class="hljs-attr">payload</span>: mergedValue });

        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">kvStore</span>!.<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">// 强制刷盘，确保同步可靠性</span>

      }

    }

  });

}

  


<span class="hljs-comment">// 校验数据格式（业务自定义）</span>

<span class="hljs-keyword">private</span> <span class="hljs-title function_">validateDataFormat</span>(<span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">boolean</span> {

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> data === <span class="hljs-string">'object'</span> &amp;&amp; data !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-string">'ver'</span> <span class="hljs-keyword">in</span> data &amp;&amp; <span class="hljs-string">'payload'</span> <span class="hljs-keyword">in</span> data;

}

  


<span class="hljs-comment">// 待办清单合并逻辑：去重并保留所有有效条目</span>

<span class="hljs-keyword">private</span> <span class="hljs-title function_">mergeTodoList</span>(<span class="hljs-attr">localTodo</span>: <span class="hljs-title class_">Array</span>&lt;{ <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span> }&gt;, 

                      <span class="hljs-attr">remoteTodo</span>: <span class="hljs-title class_">Array</span>&lt;{ <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span> }&gt;): <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">any</span>&gt; {

  <span class="hljs-keyword">const</span> todoMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;();

  <span class="hljs-comment">// 先加入本地条目</span>

  localTodo.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todoMap.<span class="hljs-title function_">set</span>(todo.<span class="hljs-property">id</span>, todo));

  <span class="hljs-comment">// 加入远端条目（远端已完成状态优先，避免本地未同步的完成状态丢失）</span>

  remoteTodo.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> {

    <span class="hljs-keyword">const</span> existTodo = todoMap.<span class="hljs-title function_">get</span>(todo.<span class="hljs-property">id</span>);

    <span class="hljs-keyword">if</span> (existTodo) {

      todoMap.<span class="hljs-title function_">set</span>(todo.<span class="hljs-property">id</span>, { ...existTodo, <span class="hljs-attr">completed</span>: todo.<span class="hljs-property">completed</span> });

    } <span class="hljs-keyword">else</span> {

      todoMap.<span class="hljs-title function_">set</span>(todo.<span class="hljs-property">id</span>, todo);

    }

  });

  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(todoMap.<span class="hljs-title function_">values</span>());

}

</code></pre>
<h5 data-id="heading-10">步骤3：主动同步触发（控制同步时机）</h5>
<p>通过<code>sync</code>方法主动触发跨设备数据同步，支持指定同步模式和目标设备：</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-comment">// 触发同步：向组网内所有设备推送本地数据并拉取远端数据</span>

<span class="hljs-keyword">async</span> <span class="hljs-title function_">syncData</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {

  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">kvStore</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">try</span> {

    <span class="hljs-keyword">const</span> <span class="hljs-attr">syncOptions</span>: distributedData.<span class="hljs-property">SyncOptions</span> = {

      <span class="hljs-attr">syncMode</span>: distributedData.<span class="hljs-property">SyncMode</span>.<span class="hljs-property">PUSH_PULL</span>, <span class="hljs-comment">// 推拉模式（双向同步）</span>

      <span class="hljs-attr">deviceIds</span>: [], <span class="hljs-comment">// 空数组表示同步至所有组网设备</span>

      <span class="hljs-attr">delayMs</span>: <span class="hljs-number">100</span> <span class="hljs-comment">// 延迟100ms同步，避免频繁写入导致的抖动</span>

    };

    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">kvStore</span>.<span class="hljs-title function_">sync</span>(syncOptions);

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'数据同步触发成功'</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

  } <span class="hljs-keyword">catch</span> (error) {

    <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`同步失败：code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

  }

}

</code></pre>
<h3 data-id="heading-11">四、工程化最佳实践</h3>
<h4 data-id="heading-12">1. 冲突规避：存储结构设计原则</h4>
<ul>
<li>
<p>拆分Key粒度：将复杂对象拆分为多个独立Key（如<code>todo_list_202506</code>、<code>todo_config</code>），减少同一Key的并发写入；</p>
</li>
<li>
<p>设备维度隔离：非共享数据使用<code>DeviceKVStore</code>（按设备分片存储），天然避免跨设备冲突；</p>
</li>
<li>
<p>版本号强制递增：约定所有写入操作必须生成新的版本号（如基于时间戳+设备ID），确保冲突判定准确性。</p>
</li>
</ul>
<h4 data-id="heading-13">2. 性能优化：减少无效同步</h4>
<ul>
<li>
<p>批量同步聚合同步请求：短时间内多次写入后，延迟100-300ms触发同步（通过<code>delayMs</code>配置），减少同步次数；</p>
</li>
<li>
<p>过滤无效变更：在<code>dataChange</code>监听中，对比数据内容是否真的变化，避免因版本号误判导致的重复合并；</p>
</li>
<li>
<p>控制数据规模：SingleKVStore建议单Key数据不超过10KB，总条目数不超过1000条，超出场景切换至分布式数据库。</p>
</li>
</ul>
<h4 data-id="heading-14">3. 可靠性保障：异常处理与校验</h4>
<ul>
<li>
<p>幂等性设计：合并逻辑确保多次执行结果一致，避免同步重试导致的数据重复；</p>
</li>
<li>
<p>数据备份：关键业务数据定期备份至本地文件，避免KVStore同步异常导致的数据丢失；</p>
</li>
<li>
<p>冲突日志：记录冲突发生时间、Key、本地/远端数据内容，便于问题排查。</p>
</li>
</ul>
<h3 data-id="heading-15">五、常见问题与解决方案</h3>
<h4 data-id="heading-16">1. 冲突监听不触发</h4>
<ul>
<li>
<p>排查方向1：权限未授予（需动态申请<code>DISTRIBUTED_DATASYNC</code>权限，尤其是API 11+版本）；</p>
</li>
<li>
<p>排查方向2：订阅类型错误（需使用<code>SUBSCRIBE_TYPE_ALL</code>监听本地和远端变更）；</p>
</li>
<li>
<p>排查方向3：KVStore实例未正确初始化（确保<code>getSingleKVStore</code>调用成功后再注册监听）。</p>
</li>
</ul>
<h4 data-id="heading-17">2. 合并后数据再次冲突</h4>
<ul>
<li>
<p>解决方案：写入合并数据时生成全局唯一版本号（如<code>Date.now() + 设备ID后缀</code>），避免不同设备生成相同版本号；</p>
</li>
<li>
<p>补充措施：同步后触发<code>flush</code>强制刷盘，确保数据持久化后再参与下一轮同步。</p>
</li>
</ul>
<h4 data-id="heading-18">3. 设备时钟偏差导致LWW策略失效</h4>
<ul>
<li>
<p>解决方案：替换时间戳为“版本号+设备优先级”的判定逻辑（如手机优先级高于手表，相同版本号时保留手机数据）；</p>
</li>
<li>
<p>实现方式：在数据结构中增加<code>devicePriority</code>字段，冲突时优先保留优先级高的设备数据。</p>
</li>
</ul>
<h3 data-id="heading-19">六、核心总结</h3>
<p>分布式KVStore的冲突解决核心在于“先规避、后解决”：通过合理的Key粒度设计和存储模式选择，减少冲突发生概率；针对无法规避的冲突，基于业务场景实现自定义合并逻辑（如数组合并、字段优先级合并），替代默认LWW策略。开发过程中需重点关注版本号管理、同步时机控制和异常日志记录，确保跨设备数据一致性的同时，保障业务数据可靠性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让大语言模型拥有“记忆”：多轮对话与 LangChain 实践指南]]></title>    <link>https://juejin.cn/post/7587998744294555654</link>    <guid>https://juejin.cn/post/7587998744294555654</guid>    <pubDate>2025-12-26T10:09:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587998744294555654" data-draft-id="7588002126258208774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让大语言模型拥有“记忆”：多轮对话与 LangChain 实践指南"/> <meta itemprop="keywords" content="前端,LangChain,LLM"/> <meta itemprop="datePublished" content="2025-12-26T10:09:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wwwwW"/> <meta itemprop="url" content="https://juejin.cn/user/631558156323657"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让大语言模型拥有“记忆”：多轮对话与 LangChain 实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/631558156323657/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wwwwW
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:09:37.000Z" title="Fri Dec 26 2025 10:09:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">让大语言模型拥有“记忆”：多轮对话与 LangChain 实践指南</h2>
<p>在当前人工智能应用开发中，大语言模型（LLM）因其强大的自然语言理解与生成能力，被广泛应用于聊天机器人、智能客服、个人助理等场景。然而，一个常见的问题是：<strong>LLM 本身是无状态的</strong>——每一次 API 调用都独立于前一次，就像每次 HTTP 请求一样，模型无法“记住”你之前说过什么。</p>
<p>那么，如何让 LLM 拥有“记忆”，实现真正的多轮对话体验？本文将从原理出发，结合 LangChain 框架的实践代码，深入浅出地讲解这一关键技术。</p>
<hr/>
<h3 data-id="heading-1">一、为什么 LLM 默认没有记忆？</h3>
<p>大语言模型（如 DeepSeek、GPT、Claude 等）在设计上遵循“输入-输出”模式。当你调用其 API 时，仅传递当前的问题或指令，模型不会自动保留之前的交互内容。例如：</p>
<pre><code class="hljs language-ini" lang="ini">ts
编辑
const <span class="hljs-attr">res1</span> = await model.invoke(<span class="hljs-string">'我叫王源，喜欢喝白兰地'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">res2</span> = await model.invoke(<span class="hljs-string">'我叫什么名字？'</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>第二次调用时，模型完全不知道“王源”是谁，因此很可能回答：“我不知道你的名字。”<br/>
这是因为两次调用之间没有任何上下文传递。</p>
<hr/>
<h3 data-id="heading-2">二、实现“记忆”的核心思路：维护对话历史</h3>
<p>要让 LLM 表现出“有记忆”的行为，最直接的方法是：<strong>在每次请求中显式传入完整的对话历史</strong>。通常以 <code>messages</code> 数组的形式组织：</p>
<pre><code class="hljs language-css" lang="css">json
编辑
<span class="hljs-selector-attr">[  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我叫王源，喜欢喝白兰地"</span>},  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"很高兴认识你，王源！白兰地是很优雅的选择。"</span>},  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你知道我是谁吗？"</span>}]</span>
</code></pre>
<p>模型通过分析整个对话上下文，就能准确回答：“你是王源，喜欢喝白兰地。”</p>
<p>但这种方法存在明显问题：<strong>随着对话轮次增加，输入 token 数量不断膨胀</strong>，不仅增加计算成本，还可能超出模型的最大上下文长度限制（如 32768 tokens）。这就像滚雪球，越滚越大。</p>
<hr/>
<h3 data-id="heading-3">三、LangChain 提供的解决方案：模块化记忆管理</h3>
<p>为了解决上述问题，LangChain 等 AI 应用框架提供了专门的 <strong>Memory 模块</strong>，帮助开发者高效管理对话历史，并支持多种存储策略（内存、数据库、向量化摘要等）。</p>
<p>以下是一个使用 <code>@langchain/deepseek</code> 和 <code>RunnableWithMessageHistory</code> 的完整示例：</p>
<h4 data-id="heading-4">1. 初始化模型与提示模板</h4>
<pre><code class="hljs language-javascript" lang="javascript">ts
编辑
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatPromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/prompts'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableWithMessageHistory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/runnables'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InMemoryChatMessageHistory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/chat_history'</span>;

<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>,
});

<span class="hljs-comment">// 定义包含历史记录占位符的提示模板</span>
<span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromMessages</span>([
  [<span class="hljs-string">'system'</span>, <span class="hljs-string">'你是一个有记忆的助手'</span>],
  [<span class="hljs-string">'placeholder'</span>, <span class="hljs-string">'{history}'</span>], <span class="hljs-comment">// 历史消息将插入此处</span>
  [<span class="hljs-string">'human'</span>, <span class="hljs-string">'{input}'</span>]
]);
</code></pre>
<h4 data-id="heading-5">2. 构建带记忆的可运行链</h4>
<pre><code class="hljs language-dart" lang="dart">ts
编辑
<span class="hljs-keyword">const</span> runnable = prompt.pipe(model);

<span class="hljs-comment">// 创建内存中的对话历史存储</span>
<span class="hljs-keyword">const</span> messageHistory = <span class="hljs-keyword">new</span> InMemoryChatMessageHistory();

<span class="hljs-comment">// 封装成支持会话记忆的链</span>
<span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">new</span> RunnableWithMessageHistory({
  runnable,
  getMessageHistory: <span class="hljs-keyword">async</span> () =&gt; messageHistory,
  inputMessagesKey: <span class="hljs-string">'input'</span>,
  historyMessagesKey: <span class="hljs-string">'history'</span>,
});
</code></pre>
<h4 data-id="heading-6">3. 执行多轮对话</h4>
<pre><code class="hljs language-php" lang="php">ts
编辑
<span class="hljs-comment">// 第一轮：用户自我介绍</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">res1</span> = await chain.<span class="hljs-title function_ invoke__">invoke</span>(
  { <span class="hljs-attr">input</span>: <span class="hljs-string">'我叫王源，喜欢喝白兰地'</span> },
  { <span class="hljs-attr">configurable</span>: { <span class="hljs-attr">sessionId</span>: <span class="hljs-string">'makefriend'</span> } }
);
console.<span class="hljs-title function_ invoke__">log</span>(res1.content); <span class="hljs-comment">// “你好，王源！白兰地确实很经典。”</span>

<span class="hljs-comment">// 第二轮：提问名字</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">res2</span> = await chain.<span class="hljs-title function_ invoke__">invoke</span>(
  { <span class="hljs-attr">input</span>: <span class="hljs-string">'我叫什么名字？'</span> },
  { <span class="hljs-attr">configurable</span>: { <span class="hljs-attr">sessionId</span>: <span class="hljs-string">'makefriend'</span> } }
);
console.<span class="hljs-title function_ invoke__">log</span>(res2.content); <span class="hljs-comment">// “你叫王源。”</span>
</code></pre>
<blockquote>
<p>✅ 关键点：<code>sessionId</code> 用于区分不同用户的会话。同一个 <code>sessionId</code> 下的所有交互共享同一段历史。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">四、进阶思考：如何优化长对话的记忆效率？</h3>
<p>虽然内存存储简单易用，但在生产环境中，面对海量用户和长期对话，我们需要更高效的策略：</p>
<ol>
<li><strong>滑动窗口记忆</strong>：只保留最近 N 轮对话。</li>
<li><strong>摘要压缩</strong>：定期将历史对话总结成一段摘要，替代原始记录。</li>
<li><strong>向量数据库 + 语义检索</strong>：将关键信息存入向量库，按需检索相关上下文（适用于知识密集型对话）。</li>
<li><strong>混合记忆</strong>：结合短期（最近几轮）+ 长期（摘要/数据库）记忆。</li>
</ol>
<p>LangChain 已支持多种 Memory 类型，如 <code>BufferWindowMemory</code>、<code>SummaryMemory</code>、<code>VectorStoreRetrieverMemory</code> 等，可根据场景灵活选择。</p>
<hr/>
<h3 data-id="heading-8">五、结语</h3>
<p>让 LLM 拥有“记忆”，本质上是<strong>将无状态的模型调用转化为有状态的会话系统</strong>。通过维护对话历史并合理控制上下文长度，我们可以在成本与体验之间取得平衡。</p>
<p>LangChain 等框架极大简化了这一过程，使开发者能专注于业务逻辑，而非底层状态管理。未来，随着上下文窗口的扩大和记忆机制的智能化（如自动遗忘、重点记忆），AI 助手将越来越像一个真正“记得你”的朋友。</p>
<blockquote>
<p>正如我们在代码中看到的那样——当模型说出“你叫王源”时，那一刻，它仿佛真的记住了你。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据中心虚拟化之KVM虚拟化基本部署视频课程]]></title>    <link>https://juejin.cn/post/7588002126258241542</link>    <guid>https://juejin.cn/post/7588002126258241542</guid>    <pubDate>2025-12-26T10:11:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588002126258241542" data-draft-id="7587998744294572038" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据中心虚拟化之KVM虚拟化基本部署视频课程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T10:11:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户72942943223"/> <meta itemprop="url" content="https://juejin.cn/user/1998245912903995"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据中心虚拟化之KVM虚拟化基本部署视频课程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1998245912903995/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户72942943223
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:11:37.000Z" title="Fri Dec 26 2025 10:11:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在当今云计算与虚拟化技术深度融合的数据中心环境中，KVM（Kernel-based Virtual Machine）凭借其高性能、低开销以及开源生态的优势，成为了构建企业级私有云和虚拟化平台的基石。本文将详细介绍基于 Linux 环境的 KVM 核心组件安装流程，并重点阐述数据中心级网络配置的关键步骤，包含实战代码与配置示例。<strong>学习地址：pan.baidu.com/s/1WwerIZ_elz_FyPKqXAiZCA?pwd=waug</strong></p>
<h2 data-id="heading-0">一、 环境准备与核心组件安装</h2>
<p>KVM 是作为 Linux 内核的一个模块存在的，因此首先需要确保硬件支持虚拟化（Intel VT-x 或 AMD-V）。在 CentOS/RHEL 或 Ubuntu 等 Linux 发行版上，我们需要安装 KVM 内核模块、QEMU（硬件模拟器）以及 Libvirt（虚拟化管理 API）和 Virt-Manager（管理工具）。</p>
<h3 data-id="heading-1">1. 硬件检测</h3>
<p>在安装前，务必检查 CPU 是否开启了虚拟化支持：</p>
<p>bash</p>
<p>复制</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查 CPU 是否支持虚拟化</span>
<span class="hljs-comment"># 输出中包含 vmx (Intel) 或 svm (AMD) 即表示支持</span>
lscpu | grep Virtualization

<span class="hljs-comment"># 或者使用</span>
egrep -c <span class="hljs-string">'(vmx|svm)'</span> /proc/cpuinfo
</code></pre>
<h3 data-id="heading-2">2. 安装核心组件</h3>
<p>以 CentOS 8/Stream 或 RHEL 系列为例，执行以下命令安装虚拟化栈：</p>
<p>bash</p>
<p>复制</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 KVM、QEMU、Libvirt 及管理工具</span>
yum install -y qemu-kvm libvirt virt-install virt-manager libvirt-python python3-virtinst bridge-utils virt-viewer

<span class="hljs-comment"># 启动并设置 Libvirtd 开机自启</span>
systemctl <span class="hljs-built_in">enable</span> --now libvirtd

<span class="hljs-comment"># 检查 KVM 模块是否加载成功</span>
lsmod | grep kvm
<span class="hljs-comment"># 预期输出：</span>
<span class="hljs-comment"># kvm_intel             188688  0 </span>
<span class="hljs-comment"># kvm                   636965  1 kvm_intel</span>
</code></pre>
<h2 data-id="heading-3">二、 网络配置指南：Linux Bridge vs OVS</h2>
<p>在数据中心部署中，网络配置直接决定了虚拟机的 I/O 性能和可用性。默认情况下，Libvirt 会创建一个名为 <code>virbr0</code> 的 NAT 网络用于测试，但在生产环境中，我们通常需要配置<strong>桥接网络</strong> 或 <strong>Open vSwitch (OVS)</strong> ，以使虚拟机像物理机一样直接接入数据中心网络。</p>
<p>本文以最通用的 <strong>Linux Bridge (网桥)</strong>  模式为例，演示如何将物理网卡绑定到网桥，供虚拟机使用。</p>
<h3 data-id="heading-4">1. 配置网桥模式</h3>
<p>假设宿主机的物理网卡名称为 <code>eth0</code>，IP 地址为 <code>192.168.1.10</code>。我们需要创建一个网桥 <code>br0</code>，将 <code>eth0</code> 的 IP 转移到 <code>br0</code> 上，并将物理网卡桥接进来。</p>
<p><strong>通过 NetworkManager (nmcli) 配置（推荐）：</strong></p>
<p>bash</p>
<p>复制</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 查看当前连接</span>
nmcli con show

<span class="hljs-comment"># 2. 创建一个新的网桥连接 "br0"</span>
nmcli con add <span class="hljs-built_in">type</span> bridge ifname br0 con-name br0

<span class="hljs-comment"># 3. 设置网桥的 IP 地址、网关和 DNS</span>
nmcli con modify br0 ipv4.addresses <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span>/<span class="hljs-number">24</span> ipv4.gateway <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span> ipv4.dns <span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span> ipv4.method manual

<span class="hljs-comment"># 4. 将物理网卡（如 eth0）添加为网桥的从属设备</span>
<span class="hljs-comment"># 注意：这里的 "System eth0" 是你通过 nmcli con show 查看到的物理网卡连接名称</span>
nmcli con add <span class="hljs-built_in">type</span> ethernet slave-<span class="hljs-built_in">type</span> bridge con-name br0-port ifname eth0 master br0

<span class="hljs-comment"># 5. 重启网络服务使配置生效</span>
nmcli con up br0
</code></pre>
<h3 data-id="heading-5">2. 定义 Libvirt 虚拟网络</h3>
<p>虽然我们配置了宿主机网桥，但为了让 Libvirt 能够管理它，建议定义一个对应的网络配置 XML（可选，亦可在创建虚拟机时直接指定 <code>--network bridge=br0</code>）。</p>
<p>创建一个名为 <code>br0-net.xml</code> 的文件</p>
<p>通过 virsh 定义并启动该网络：</p>
<p>bash</p>
<p>复制</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 定义网络</span>
virsh net-define br0-net.xml

<span class="hljs-comment"># 启动网络并设置开机自启</span>
virsh net-start host-bridge
virsh net-autostart host-bridge
</code></pre>
<h2 data-id="heading-6">三、 虚拟机部署实战</h2>
<p>完成环境与网络配置后，我们可以使用 <code>virt-install</code> 命令行工具创建一台虚拟机。这是数据中心自动化运维的核心步骤。</p>
<p>以下是一个部署 CentOS 7 虚拟机的命令示例：</p>
<p>bash</p>
<p>复制</p>
<pre><code class="hljs language-css" lang="css">virt-install \
  <span class="hljs-attr">--name</span> centos7-srv-<span class="hljs-number">01</span> \
  <span class="hljs-attr">--memory</span> <span class="hljs-number">4096</span> \
  <span class="hljs-attr">--vcpus</span> <span class="hljs-number">2</span> \
  <span class="hljs-attr">--disk</span> path=/<span class="hljs-selector-tag">var</span>/lib/libvirt/images/centos7<span class="hljs-selector-class">.qcow2</span>,size=<span class="hljs-number">20</span>,format=qcow2,bus=virtio \
  <span class="hljs-attr">--network</span> bridge=br0,model=virtio \
  <span class="hljs-attr">--graphics</span> vnc,listen=<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> \
  <span class="hljs-attr">--noautoconsole</span> \
  <span class="hljs-attr">--os-variant</span> centos7.<span class="hljs-number">0</span> \
  <span class="hljs-attr">--location</span> /tmp/CentOS-<span class="hljs-number">7</span>-x86_64-Minimal-<span class="hljs-number">2009</span><span class="hljs-selector-class">.iso</span> \
  <span class="hljs-attr">--extra-args</span> 'console=ttyS0,<span class="hljs-number">115200</span>n8 serial'
</code></pre>
<p><strong>参数解析：</strong></p>
<ul>
<li><code>--disk</code>: 指定磁盘镜像路径、大小（20G）、格式及总线类型。<code>virtio</code> 总线能显著提升磁盘 I/O 性能。</li>
<li><code>--network bridge=br0</code>: 指定使用我们刚才配置的 <code>br0</code> 网桥，<code>model=virtio</code> 启用半虚拟化网卡驱动，大幅降低网络延迟。</li>
<li><code>--graphics vnc</code>: 允许通过 VNC 客户端远程连接安装界面。</li>
</ul>
<h2 data-id="heading-7">四、 性能调优与验证</h2>
<p>部署完成后，我们需要验证虚拟机的网络状态并进行简单的性能调优。</p>
<ol>
<li><strong>检查虚拟机状态：</strong></li>
</ol>
<p>bash</p>
<p>复制</p>
<pre><code class="hljs language-css" lang="css">    virsh list <span class="hljs-attr">--all</span>
</code></pre>
<ol start="2">
<li><strong>验证虚拟机内部网络：</strong><br/>
登录虚拟机后，使用 <code>ip addr</code> 应当能看到从 DHCP 获取到的与宿主机同网段的 IP 地址，且能 Ping 通网关。</li>
<li><strong>开启嵌套虚拟化（如需要）：</strong><br/>
如果在虚拟机内还需要运行 KVM，需在宿主机开启嵌套虚拟化支持：</li>
</ol>
<p>bash</p>
<p>复制</p>
<pre><code class="hljs language-bash" lang="bash">    <span class="hljs-comment"># 临时开启</span>
    modprobe kvm_intel nested=1
    
    <span class="hljs-comment"># 永久开启：创建配置文件</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"options kvm-intel nested=1"</span> &gt; /etc/modprobe.d/kvm-intel.conf
</code></pre>
<h2 data-id="heading-8">总结</h2>
<p>数据中心的 KVM 虚拟化部署不仅仅是简单的软件安装，更是对底层 I/O 和网络通路的精细规划。通过正确配置 Linux Bridge 网桥和使用 Virtio 驱动，可以最大程度地减少虚拟化损耗，使虚拟机性能无限逼近物理机。掌握上述核心组件安装与网络配置代码，将为你构建稳定、高效的私有云平台打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app实战在线教育类app开发]]></title>    <link>https://juejin.cn/post/7588002126258274310</link>    <guid>https://juejin.cn/post/7588002126258274310</guid>    <pubDate>2025-12-26T10:12:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588002126258274310" data-draft-id="7588001624904499219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app实战在线教育类app开发"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T10:12:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户72942943223"/> <meta itemprop="url" content="https://juejin.cn/user/1998245912903995"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app实战在线教育类app开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1998245912903995/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户72942943223
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:12:49.000Z" title="Fri Dec 26 2025 10:12:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着移动互联网的深入发展，在线教育 APP 的需求日益旺盛。uni-app 凭借其“一套代码，多端发布”的优势，成为许多教育科技公司快速迭代产品的首选框架。然而，在开发涉及视频流、互动白板、即时通讯（IM）等复杂功能的在线教育应用时，开发者往往会遇到各种棘手问题。<strong>学习地址：pan.baidu.com/s/1WwerIZ_elz_FyPKqXAiZCA?pwd=waug</strong></p>
<p>本文将结合实战经验，针对 uni-app 开发在线教育 APP 过程中常见的几个痛点，提供具体的排查思路与解决方案，并附带关键代码示例。</p>
<h2 data-id="heading-0">一、 自定义导航栏与刘海屏适配问题</h2>
<p>在线教育 APP 的首页通常设计感很强，经常会使用自定义导航栏来放置搜索框或课程分类入口。但在不同机型（尤其是 iPhone X 系列及安卓异形屏）上，极易出现内容被状态栏遮挡的问题。</p>
<p><strong>问题排查：</strong><br/>
首先检查是否在 <code>pages.json</code> 中将对应页面的 <code>navigationStyle</code> 设置为 <code>custom</code>，同时确认是否正确获取了系统胶囊按钮的位置信息。</p>
<p><strong>解决方案：</strong><br/>
利用 uni-app 的 <code>uni.getSystemInfoSync()</code> 获取状态栏高度，动态计算导航栏的高度。</p>
<p>javascript</p>
<p>复制</p>
<pre><code class="hljs language-ini" lang="ini">// 在 App.vue 或全局 mixin 中封装获取导航栏高度的方法
export default {
  onLaunch() {
    this.setGlobalNavBar()<span class="hljs-comment">;</span>
  },
  methods: {
    setGlobalNavBar() {
      const <span class="hljs-attr">systemInfo</span> = uni.getSystemInfoSync()<span class="hljs-comment">;</span>
      // 获取状态栏高度
      const <span class="hljs-attr">statusBarHeight</span> = systemInfo.statusBarHeight<span class="hljs-comment">;</span>
      // 获取胶囊按钮位置信息 (注意：仅在微信小程序等平台有效，App端需差异化处理)
      let <span class="hljs-attr">menuButtonInfo</span> = {}<span class="hljs-comment">;</span>
      // <span class="hljs-comment">#ifdef MP-WEIXIN</span>
      <span class="hljs-attr">menuButtonInfo</span> = uni.getMenuButtonBoundingClientRect()<span class="hljs-comment">;</span>
      // <span class="hljs-comment">#endif</span>
      
      // 计算导航栏总高度 = (胶囊底部位置 - 状态栏高度) + (状态栏高度 * 2)
      // 这里简化处理，通常设置为 状态栏高度 + 44px (标准导航栏高度)
      const <span class="hljs-attr">navBarHeight</span> = statusBarHeight + <span class="hljs-number">44</span><span class="hljs-comment">;</span>
      
      // 存入 globalData 或 Vuex 供全局使用
      getApp().<span class="hljs-attr">globalData.navBarHeight</span> = navBarHeight<span class="hljs-comment">;</span>
      getApp().<span class="hljs-attr">globalData.statusBarHeight</span> = statusBarHeight<span class="hljs-comment">;</span>
    }
  }
}
</code></pre>
<p><strong>CSS 样式处理：</strong></p>
<p>css</p>
<p>复制</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 动态绑定样式 */</span>
<span class="hljs-selector-class">.custom-navbar</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">var</span>(--nav-bar-height); <span class="hljs-comment">/* JS 动态赋值 */</span>
  <span class="hljs-attribute">padding-top</span>: <span class="hljs-built_in">var</span>(--status-bar-height);
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
}
</code></pre>
<h2 data-id="heading-1">二、 视频播放器内存泄漏与全屏控制</h2>
<p>在线教育 APP 的核心是视频课程。开发者常反馈在长时间观看或频繁进出视频播放页时，APP 出现卡顿甚至闪退。</p>
<p><strong>问题排查：</strong><br/>
这通常是因为视频组件没有在页面销毁时及时释放资源，导致内存泄漏。此外，H5 端和 App 端视频层级问题也会导致全屏控制失效。</p>
<p><strong>解决方案：</strong></p>
<ol>
<li>在 <code>onUnload</code> 生命周期中停止播放并销毁实例。</li>
<li>使用 <code>cover-view</code> 组件覆盖在视频之上，实现自定义的弹幕或控制栏。</li>
</ol>
<p>javascript</p>
<p>复制</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">view</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">video</span> 
      <span class="hljs-attr">id</span>=<span class="hljs-string">"myVideo"</span> 
      <span class="hljs-attr">:src</span>=<span class="hljs-string">"videoUrl"</span> 
      @<span class="hljs-attr">error</span>=<span class="hljs-string">"videoErrorCallback"</span>
      <span class="hljs-attr">controls</span>
    &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">videoUrl</span>: <span class="hljs-string">'https://example.com/course.mp4'</span> ,
      <span class="hljs-attr">videoContext</span>: <span class="hljs-literal">null</span>
    };
  },
  <span class="hljs-title function_">onReady</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建 video 上下文</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">videoContext</span> = uni.<span class="hljs-title function_">createVideoContext</span>(<span class="hljs-string">'myVideo'</span>, <span class="hljs-variable language_">this</span>);
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">videoErrorCallback</span>(<span class="hljs-params">e</span>) {
      uni.<span class="hljs-title function_">showModal</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">'提示'</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">'视频加载失败，请检查网络'</span>,
        <span class="hljs-attr">showCancel</span>: <span class="hljs-literal">false</span>
      });
    }
  },
  <span class="hljs-title function_">onUnload</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 关键步骤：页面卸载时暂停播放，释放资源</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">videoContext</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">videoContext</span>.<span class="hljs-title function_">pause</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">videoContext</span>.<span class="hljs-title function_">stop</span>(); <span class="hljs-comment">// 某些端建议调用 stop</span>
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">三、 大文件上传中断与断点续传</h2>
<p>在教育 APP 中，老师或学生经常需要上传几百兆的教学视频或作业文档。弱网环境下，上传极易中断。</p>
<p><strong>问题排查：</strong><br/>
普通的上传接口一旦网络波动，整个请求就会失败，用户需要重新点击上传，体验极差。</p>
<p><strong>解决方案：</strong><br/>
采用分片上传策略。将大文件切分成多个小块，分别上传，服务端接收后合并。uni-app 中可以使用 <code>uni.uploadFile</code> 配合循环逻辑实现。</p>
<p>javascript</p>
<p>复制</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简易分片上传逻辑示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">uploadLargeFile</span>(<span class="hljs-params">filePath</span>) {
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CHUNK_SIZE</span> = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">2</span>; <span class="hljs-comment">// 每片 2MB</span>
  <span class="hljs-keyword">const</span> fileSize = (<span class="hljs-keyword">await</span> uni.<span class="hljs-title function_">getFileInfo</span>({ filePath })).<span class="hljs-property">size</span>;
  <span class="hljs-keyword">const</span> chunks = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(fileSize / <span class="hljs-variable constant_">CHUNK_SIZE</span>);
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; chunks; i++) {
    <span class="hljs-keyword">const</span> start = i * <span class="hljs-variable constant_">CHUNK_SIZE</span>;
    <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(start + <span class="hljs-variable constant_">CHUNK_SIZE</span>, fileSize);
    
    <span class="hljs-comment">// 注意：uni.uploadFile 本身不直接支持 Range 参数，</span>
    <span class="hljs-comment">// 实际开发中通常借助 plus.io (App端) 或切片文件逻辑。</span>
    <span class="hljs-comment">// 这里演示调用上传接口的封装逻辑</span>
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        uni.<span class="hljs-title function_">uploadFile</span>({
          <span class="hljs-attr">url</span>: <span class="hljs-string">'https://api.example.com/upload'</span> ,
          <span class="hljs-attr">filePath</span>: filePath, <span class="hljs-comment">// 实际需处理切片文件路径</span>
          <span class="hljs-attr">name</span>: <span class="hljs-string">'file'</span>,
          <span class="hljs-attr">formData</span>: {
            <span class="hljs-string">'chunkIndex'</span>: i,
            <span class="hljs-string">'totalChunks'</span>: chunks,
            <span class="hljs-string">'fileId'</span>: <span class="hljs-string">'unique_file_id'</span> <span class="hljs-comment">// 用于服务端识别合并</span>
          },
          <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (res.<span class="hljs-property">statusCode</span> === <span class="hljs-number">200</span>) {
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`第 <span class="hljs-subst">${i}</span> 片上传成功`</span>);
              <span class="hljs-title function_">resolve</span>();
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`第 <span class="hljs-subst">${i}</span> 片上传失败`</span>));
            }
          },
          <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-title function_">reject</span>(err);
          }
        });
      });
    } <span class="hljs-keyword">catch</span> (e) {
      uni.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">`上传中断: <span class="hljs-subst">${e.message}</span>`</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> });
      <span class="hljs-comment">// 记录当前断点 i，下次从此处继续</span>
      <span class="hljs-keyword">break</span>; 
    }
  }
}
</code></pre>
<h2 data-id="heading-3">四、 跨端条件编译处理平台差异</h2>
<p>在开发作业本功能时，安卓端和 iOS 端的文件路径处理方式不同，或者某些插件仅在 APP 端可用，导致编译报错。</p>
<p><strong>解决方案：</strong><br/>
充分使用 uni-app 的条件编译语法（<code>#ifdef</code>、<code>#ifndef</code>）来隔离平台特有代码。</p>
<p>javascript</p>
<p>复制</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">methods</span>: {
  <span class="hljs-title function_">openHomeworkFile</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// #ifdef APP-PLUS</span>
    <span class="hljs-comment">// APP 端调用原生模块打开本地文档</span>
    plus.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">openFile</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">filePath</span>);
    <span class="hljs-comment">// #endif</span>
    
    <span class="hljs-comment">// #ifdef H5</span>
    <span class="hljs-comment">// H5 端通常使用 window.open 或下载</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">filePath</span>, <span class="hljs-string">'_blank'</span>);
    <span class="hljs-comment">// #endif</span>
    
    <span class="hljs-comment">// #ifdef MP-WEIXIN</span>
    <span class="hljs-comment">// 微信小程序需使用 wx.downloadFile 或 wx.openDocument</span>
    uni.<span class="hljs-title function_">downloadFile</span>({
      <span class="hljs-attr">url</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">filePath</span>,
      <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
        uni.<span class="hljs-title function_">openDocument</span>({
          <span class="hljs-attr">filePath</span>: res.<span class="hljs-property">tempFilePath</span>,
          <span class="hljs-attr">showMenu</span>: <span class="hljs-literal">true</span>
        });
      }
    });
    <span class="hljs-comment">// #endif</span>
  }
}
</code></pre>
<h2 data-id="heading-4">总结</h2>
<p>uni-app 极大地降低了多端开发的门槛，但在在线教育这类高交互、高负载的场景下，开发者仍需对性能优化、内存管理以及平台差异有深刻的理解。通过上述的自定义导航栏适配、视频资源回收、大文件分片上传及条件编译策略，可以有效规避大部分“坑”，打造一款流畅、稳定的教育产品。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Compose原理简易实现]]></title>    <link>https://juejin.cn/post/7587965800272822298</link>    <guid>https://juejin.cn/post/7587965800272822298</guid>    <pubDate>2025-12-26T10:11:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587965800272822298" data-draft-id="7588022226739822642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Compose原理简易实现"/> <meta itemprop="keywords" content="Composer,Android"/> <meta itemprop="datePublished" content="2025-12-26T10:11:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zjw_swun"/> <meta itemprop="url" content="https://juejin.cn/user/3614849960524279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Compose原理简易实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3614849960524279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zjw_swun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:11:31.000Z" title="Fri Dec 26 2025 10:11:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文仅探究Google Compose原理 不包含ui绘制实现</p>
</blockquote>
<h2 data-id="heading-0">Compose原理</h2>
<p>先看as compose项目模板生成的基础demo</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContent {
            MyApplicationTheme {
                Scaffold(modifier = Modifier.fillMaxSize()) { innerPadding -&gt;
                    Greeting(
                        name = <span class="hljs-string">"Android"</span>,
                        modifier = Modifier.padding(innerPadding)
                    )
                }
            }
        }
        
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Greeting</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    <span class="hljs-keyword">var</span> currentTime <span class="hljs-keyword">by</span> remember { mutableStateOf(System.currentTimeMillis()) }
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            currentTime = System.currentTimeMillis()
            delay(<span class="hljs-number">1000</span>)
            Log.e(<span class="hljs-string">"zjw"</span>, currentTime.hashCode().toString())
        }
    }
    <span class="hljs-keyword">val</span> timeFormat = remember { SimpleDateFormat(<span class="hljs-string">"HH:mm:ss"</span>, Locale.getDefault()) }
    <span class="hljs-keyword">val</span> timeStr = timeFormat.format(Date(currentTime))

    Text(
        text = <span class="hljs-string">"Hello <span class="hljs-variable">$name</span>! Current Time: <span class="hljs-variable">$timeStr</span>"</span>,
        modifier = modifier
    )
}
</code></pre>
<p>很简单的代码不做细究，要探究Compose重组UI逻辑，先上反编译手段看看@Composable Greeting会变成什么
jadx工具反编译MainActivity</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0ca7b435c8244e18435e0f769583a60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemp3X3N3dW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348691&amp;x-signature=%2FqiP5RsIiB6%2BAakWMF6Mj0AxugA%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb0fcbeff5104224aad8f31d21a7fbc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemp3X3N3dW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348691&amp;x-signature=WoCuxf%2BbwqRoyfJ5mfR3cU9%2FXZo%3D" alt="image.png" loading="lazy"/></p>
<p>setContentView设置了一个ComposeView 这就是Compose接入到android View系统的桥梁了，同时Compose接入</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6582898dbe6b430ba59ed0dcba63cba3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemp3X3N3dW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348691&amp;x-signature=0iU0pVrwrfIQQYxIkCQMAKABLac%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/020160e2e44443d9b46cc1503c1ad8bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemp3X3N3dW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348691&amp;x-signature=g1rXFNyCjeMlp5ufJ7wAiriyj8c%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bbdf8a6010e4b8b8d631c0565ef3361~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemp3X3N3dW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348691&amp;x-signature=FOyUuseHSvO9lI8qUVS4TeIP9WI%3D" alt="image.png" loading="lazy"/></p>
<p>这里省略部分调用细节，简单来说就是ComponentActivity setContent不光给android.R.id.content添加了子ComposeView还添加一个Choreographer.FrameCallback和recompose机制绑定</p>
<p>注意到有一个lambda<code> ComponentActivityKt.setContent$default(this, null, ComposableSingletons$MainActivityKt.INSTANCE.m8049getLambda3$app_debug</code></p>
<p>jadx双击跳转到这个lambda方法所在源码继续看<code>ComposableSingletons$MainActivityKt</code></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ComposableSingletons</span>$<span class="hljs-title">MainActivityKt</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-keyword">final</span> ComposableSingletons<span class="hljs-variable">$MainActivityKt</span> INSTANCE = <span class="hljs-keyword">new</span> ComposableSingletons<span class="hljs-variable">$MainActivityKt</span>();

    <span class="hljs-comment">/* renamed from: lambda-1  reason: not valid java name */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> Function3&lt;PaddingValues, Composer, Integer, Unit&gt; f79lambda1 = ComposableLambdaKt.<span class="hljs-title function_ invoke__">composableLambdaInstance</span>(<span class="hljs-number">1855199361</span>, <span class="hljs-literal">false</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function3</span>&lt;PaddingValues, Composer, Integer, Unit&gt;() { <span class="hljs-comment">// from class: com.zjw.compose.myapplication.ComposableSingletons$MainActivityKt$lambda-1$1</span>
        @Override <span class="hljs-comment">// kotlin.jvm.functions.Function3</span>
        <span class="hljs-keyword">public</span> <span class="hljs-comment">/* bridge */</span> <span class="hljs-comment">/* synthetic */</span> Unit <span class="hljs-title function_ invoke__">invoke</span>(PaddingValues paddingValues, Composer composer, Integer num) {
            <span class="hljs-title function_ invoke__">invoke</span>(paddingValues, composer, num.<span class="hljs-title function_ invoke__">intValue</span>());
            <span class="hljs-keyword">return</span> Unit.INSTANCE;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_ invoke__">invoke</span>(PaddingValues innerPadding, Composer <span class="hljs-variable">$composer</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$changed</span>) {
            Intrinsics.<span class="hljs-title function_ invoke__">checkNotNullParameter</span>(innerPadding, <span class="hljs-string">"innerPadding"</span>);
            ComposerKt.<span class="hljs-title function_ invoke__">sourceInformation</span>(<span class="hljs-variable">$composer</span>, <span class="hljs-string">"C42@1665L139:MainActivity.kt#72esb0"</span>);
            <span class="hljs-keyword">int</span> <span class="hljs-variable">$dirty</span> = <span class="hljs-variable">$changed</span>;
            <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$changed</span> &amp; <span class="hljs-number">6</span>) == <span class="hljs-number">0</span>) {
                <span class="hljs-variable">$dirty</span> |= <span class="hljs-variable">$composer</span>.<span class="hljs-title function_ invoke__">changed</span>(innerPadding) ? <span class="hljs-number">4</span> : <span class="hljs-number">2</span>;
            }
            <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$dirty</span> &amp; <span class="hljs-number">19</span>) != <span class="hljs-number">18</span> || !<span class="hljs-variable">$composer</span>.<span class="hljs-title function_ invoke__">getSkipping</span>()) {
                <span class="hljs-keyword">if</span> (ComposerKt.<span class="hljs-title function_ invoke__">isTraceInProgress</span>()) {
                    ComposerKt.<span class="hljs-title function_ invoke__">traceEventStart</span>(<span class="hljs-number">1855199361</span>, <span class="hljs-variable">$dirty</span>, -<span class="hljs-number">1</span>, <span class="hljs-string">"com.zjw.compose.myapplication.ComposableSingletons<span class="hljs-subst">$MainActivityKt</span>.lambda-1.&lt;anonymous&gt; (MainActivity.kt:42)"</span>);
                }
                MainActivityKt.<span class="hljs-title function_ invoke__">Greeting</span>(<span class="hljs-string">"Android"</span>, PaddingKt.<span class="hljs-title function_ invoke__">padding</span>(Modifier.INSTANCE, innerPadding), <span class="hljs-variable">$composer</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>);
                <span class="hljs-keyword">if</span> (ComposerKt.<span class="hljs-title function_ invoke__">isTraceInProgress</span>()) {
                    ComposerKt.<span class="hljs-title function_ invoke__">traceEventEnd</span>();
                    <span class="hljs-keyword">return</span>;
                }
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-variable">$composer</span>.<span class="hljs-title function_ invoke__">skipToGroupEnd</span>();
        }
    });

    <span class="hljs-comment">/* renamed from: lambda-2  reason: not valid java name */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> Function2&lt;Composer, Integer, Unit&gt; f80lambda2 = ComposableLambdaKt.<span class="hljs-title function_ invoke__">composableLambdaInstance</span>(<span class="hljs-number">184410672</span>, <span class="hljs-literal">false</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function2</span>&lt;Composer, Integer, Unit&gt;() { <span class="hljs-comment">// from class: com.zjw.compose.myapplication.ComposableSingletons$MainActivityKt$lambda-2$1</span>
        @Override <span class="hljs-comment">// kotlin.jvm.functions.Function2</span>
        <span class="hljs-keyword">public</span> <span class="hljs-comment">/* bridge */</span> <span class="hljs-comment">/* synthetic */</span> Unit <span class="hljs-title function_ invoke__">invoke</span>(Composer composer, Integer num) {
            <span class="hljs-title function_ invoke__">invoke</span>(composer, num.<span class="hljs-title function_ invoke__">intValue</span>());
            <span class="hljs-keyword">return</span> Unit.INSTANCE;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_ invoke__">invoke</span>(Composer <span class="hljs-variable">$composer</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$changed</span>) {
            ComposerKt.<span class="hljs-title function_ invoke__">sourceInformation</span>(<span class="hljs-variable">$composer</span>, <span class="hljs-string">"C41@1583L239:MainActivity.kt#72esb0"</span>);
            <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$changed</span> &amp; <span class="hljs-number">3</span>) != <span class="hljs-number">2</span> || !<span class="hljs-variable">$composer</span>.<span class="hljs-title function_ invoke__">getSkipping</span>()) {
                <span class="hljs-keyword">if</span> (ComposerKt.<span class="hljs-title function_ invoke__">isTraceInProgress</span>()) {
                    ComposerKt.<span class="hljs-title function_ invoke__">traceEventStart</span>(<span class="hljs-number">184410672</span>, <span class="hljs-variable">$changed</span>, -<span class="hljs-number">1</span>, <span class="hljs-string">"com.zjw.compose.myapplication.ComposableSingletons<span class="hljs-subst">$MainActivityKt</span>.lambda-2.&lt;anonymous&gt; (MainActivity.kt:41)"</span>);
                }
                ScaffoldKt.<span class="hljs-title function_ invoke__">m2866ScaffoldTvnljyQ</span>(SizeKt.fillMaxSize<span class="hljs-variable">$default</span>(Modifier.INSTANCE, <span class="hljs-number">0.0</span>f, <span class="hljs-number">1</span>, <span class="hljs-literal">null</span>), <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>L, <span class="hljs-number">0</span>L, <span class="hljs-literal">null</span>, ComposableSingletons<span class="hljs-variable">$MainActivityKt</span>.INSTANCE.m8047getLambda1<span class="hljs-variable">$app_debug</span>(), <span class="hljs-variable">$composer</span>, <span class="hljs-number">805306374</span>, <span class="hljs-number">510</span>);
                <span class="hljs-keyword">if</span> (ComposerKt.<span class="hljs-title function_ invoke__">isTraceInProgress</span>()) {
                    ComposerKt.<span class="hljs-title function_ invoke__">traceEventEnd</span>();
                    <span class="hljs-keyword">return</span>;
                }
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-variable">$composer</span>.<span class="hljs-title function_ invoke__">skipToGroupEnd</span>();
        }
    });

    <span class="hljs-comment">/* renamed from: lambda-3  reason: not valid java name */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> Function2&lt;Composer, Integer, Unit&gt; f81lambda3 = ComposableLambdaKt.<span class="hljs-title function_ invoke__">composableLambdaInstance</span>(<span class="hljs-number">749891428</span>, <span class="hljs-literal">false</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function2</span>&lt;Composer, Integer, Unit&gt;() { <span class="hljs-comment">// from class: com.zjw.compose.myapplication.ComposableSingletons$MainActivityKt$lambda-3$1</span>
        @Override <span class="hljs-comment">// kotlin.jvm.functions.Function2</span>
        <span class="hljs-keyword">public</span> <span class="hljs-comment">/* bridge */</span> <span class="hljs-comment">/* synthetic */</span> Unit <span class="hljs-title function_ invoke__">invoke</span>(Composer composer, Integer num) {
            <span class="hljs-title function_ invoke__">invoke</span>(composer, num.<span class="hljs-title function_ invoke__">intValue</span>());
            <span class="hljs-keyword">return</span> Unit.INSTANCE;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_ invoke__">invoke</span>(Composer <span class="hljs-variable">$composer</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$changed</span>) {
            ComposerKt.<span class="hljs-title function_ invoke__">sourceInformation</span>(<span class="hljs-variable">$composer</span>, <span class="hljs-string">"C40@1546L290:MainActivity.kt#72esb0"</span>);
            <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$changed</span> &amp; <span class="hljs-number">3</span>) != <span class="hljs-number">2</span> || !<span class="hljs-variable">$composer</span>.<span class="hljs-title function_ invoke__">getSkipping</span>()) {
                <span class="hljs-keyword">if</span> (ComposerKt.<span class="hljs-title function_ invoke__">isTraceInProgress</span>()) {
                    ComposerKt.<span class="hljs-title function_ invoke__">traceEventStart</span>(<span class="hljs-number">749891428</span>, <span class="hljs-variable">$changed</span>, -<span class="hljs-number">1</span>, <span class="hljs-string">"com.zjw.compose.myapplication.ComposableSingletons<span class="hljs-subst">$MainActivityKt</span>.lambda-3.&lt;anonymous&gt; (MainActivity.kt:40)"</span>);
                }
                ThemeKt.<span class="hljs-title function_ invoke__">MyApplicationTheme</span>(<span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, ComposableSingletons<span class="hljs-variable">$MainActivityKt</span>.INSTANCE.m8048getLambda2<span class="hljs-variable">$app_debug</span>(), <span class="hljs-variable">$composer</span>, <span class="hljs-number">384</span>, <span class="hljs-number">3</span>);
                <span class="hljs-keyword">if</span> (ComposerKt.<span class="hljs-title function_ invoke__">isTraceInProgress</span>()) {
                    ComposerKt.<span class="hljs-title function_ invoke__">traceEventEnd</span>();
                    <span class="hljs-keyword">return</span>;
                }
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-variable">$composer</span>.<span class="hljs-title function_ invoke__">skipToGroupEnd</span>();
        }
    });

    <span class="hljs-comment">/* renamed from: lambda-4  reason: not valid java name */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> Function2&lt;Composer, Integer, Unit&gt; f82lambda4 = ComposableLambdaKt.<span class="hljs-title function_ invoke__">composableLambdaInstance</span>(<span class="hljs-number">1718125071</span>, <span class="hljs-literal">false</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function2</span>&lt;Composer, Integer, Unit&gt;() { <span class="hljs-comment">// from class: com.zjw.compose.myapplication.ComposableSingletons$MainActivityKt$lambda-4$1</span>
        @Override <span class="hljs-comment">// kotlin.jvm.functions.Function2</span>
        <span class="hljs-keyword">public</span> <span class="hljs-comment">/* bridge */</span> <span class="hljs-comment">/* synthetic */</span> Unit <span class="hljs-title function_ invoke__">invoke</span>(Composer composer, Integer num) {
            <span class="hljs-title function_ invoke__">invoke</span>(composer, num.<span class="hljs-title function_ invoke__">intValue</span>());
            <span class="hljs-keyword">return</span> Unit.INSTANCE;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_ invoke__">invoke</span>(Composer <span class="hljs-variable">$composer</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$changed</span>) {
            ComposerKt.<span class="hljs-title function_ invoke__">sourceInformation</span>(<span class="hljs-variable">$composer</span>, <span class="hljs-string">"C132@3832L19:MainActivity.kt#72esb0"</span>);
            <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$changed</span> &amp; <span class="hljs-number">3</span>) == <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-variable">$composer</span>.<span class="hljs-title function_ invoke__">getSkipping</span>()) {
                <span class="hljs-variable">$composer</span>.<span class="hljs-title function_ invoke__">skipToGroupEnd</span>();
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">if</span> (ComposerKt.<span class="hljs-title function_ invoke__">isTraceInProgress</span>()) {
                ComposerKt.<span class="hljs-title function_ invoke__">traceEventStart</span>(<span class="hljs-number">1718125071</span>, <span class="hljs-variable">$changed</span>, -<span class="hljs-number">1</span>, <span class="hljs-string">"com.zjw.compose.myapplication.ComposableSingletons<span class="hljs-subst">$MainActivityKt</span>.lambda-4.&lt;anonymous&gt; (MainActivity.kt:132)"</span>);
            }
            MainActivityKt.<span class="hljs-title function_ invoke__">Greeting</span>(<span class="hljs-string">"Android"</span>, <span class="hljs-literal">null</span>, <span class="hljs-variable">$composer</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>);
            <span class="hljs-keyword">if</span> (ComposerKt.<span class="hljs-title function_ invoke__">isTraceInProgress</span>()) {
                ComposerKt.<span class="hljs-title function_ invoke__">traceEventEnd</span>();
            }
        }
    });

    <span class="hljs-comment">/* renamed from: getLambda-1$app_debug  reason: not valid java name */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Function3&lt;PaddingValues, Composer, Integer, Unit&gt; m8047getLambda1<span class="hljs-variable">$app_debug</span>() {
        <span class="hljs-keyword">return</span> f79lambda1;
    }

    <span class="hljs-comment">/* renamed from: getLambda-2$app_debug  reason: not valid java name */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Function2&lt;Composer, Integer, Unit&gt; m8048getLambda2<span class="hljs-variable">$app_debug</span>() {
        <span class="hljs-keyword">return</span> f80lambda2;
    }

    <span class="hljs-comment">/* renamed from: getLambda-3$app_debug  reason: not valid java name */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Function2&lt;Composer, Integer, Unit&gt; m8049getLambda3<span class="hljs-variable">$app_debug</span>() {
        <span class="hljs-keyword">return</span> f81lambda3;
    }
}
</code></pre>
<p>其实也就是ComposableSingletons$MainActivityKt这个类下面几个Function2 xxxlambda调用，先说结论每个@Composeable方法编译后对应一个Function2&lt;Composer, Integer, Unit&gt;类型xxxlambda,</p>
<p>MainActivity 调用setContent的lambda函数 反编译ComposableSingletons<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi>A</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>i</mi><mi>t</mi><mi>y</mi><mi>K</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>I</mi><mi>N</mi><mi>S</mi><mi>T</mi><mi>A</mi><mi>N</mi><mi>C</mi><mi>E</mi><mi mathvariant="normal">.</mi><mi>m</mi><mn>8049</mn><mi>g</mi><mi>e</mi><mi>t</mi><mi>L</mi><mi>a</mi><mi>m</mi><mi>b</mi><mi>d</mi><mi>a</mi><mn>3</mn></mrow><annotation encoding="application/x-tex">MainActivityKt.INSTANCE.m8049getLambda3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">ain</span><span class="mord mathnormal">A</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.07153em;">yK</span><span class="mord mathnormal">t</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.13889em;">NST</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.05764em;">NCE</span><span class="mord">.</span><span class="mord mathnormal">m</span><span class="mord">8049</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord mathnormal">L</span><span class="mord mathnormal">amb</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord">3</span></span></span></span></span>app_debug 对应ComposableSingletons<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi>A</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>i</mi><mi>t</mi><mi>y</mi><mi>K</mi><mi>t</mi><mtext>类</mtext><mn>81</mn><mi>l</mi><mi>a</mi><mi>m</mi><mi>b</mi><mi>d</mi><mi>a</mi><mn>3</mn><mo>−</mo><mo>&gt;</mo><mtext>调用</mtext><mi>i</mi><mi>n</mi><mi>v</mi><mi>o</mi><mi>k</mi><mi>e</mi><mtext>方法中的</mtext><mi>C</mi><mi>o</mi><mi>m</mi><mi>p</mi><mi>o</mi><mi>s</mi><mi>a</mi><mi>b</mi><mi>l</mi><mi>e</mi><mi>S</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>l</mi><mi>e</mi><mi>t</mi><mi>o</mi><mi>n</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">MainActivityKt类 81lambda3 -&gt; 调用invoke方法中的
ComposableSingletons</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">ain</span><span class="mord mathnormal">A</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.07153em;">yK</span><span class="mord mathnormal">t</span><span class="mord cjk_fallback">类</span><span class="mord">81</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">amb</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord">3</span><span class="mord">−</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord cjk_fallback">调用</span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">方法中的</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">m</span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span><span class="mord mathnormal">ab</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span></span></span></span></span>MainActivityKt.INSTANCE.m8048getLambda2$app_debug()对应 f80lambda2调用invoke 不再继续</p>
<p>其实对应就是compose的嵌套调用过程</p>
<pre><code class="hljs language-ini" lang="ini">setContent {  //f81lambda3
    MyApplicationTheme { //f80lambda2
        Scaffold(<span class="hljs-attr">modifier</span> = Modifier.fillMaxSize()) {//f79lambda1   innerPadding -&gt;
            Greeting(
                <span class="hljs-attr">name</span> = <span class="hljs-string">"Android"</span>,
                <span class="hljs-attr">modifier</span> = Modifier.padding(innerPadding)
            )
        }
    }
}
</code></pre>
<p>接下来来看一下Greeting方法会变成什么样</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivityKt</span> {
    <span class="hljs-comment">/* JADX INFO: Access modifiers changed from: private */</span>
    <span class="hljs-keyword">public</span> static <span class="hljs-keyword">final</span> <span class="hljs-built_in">Unit</span> Greeting$lambda$<span class="hljs-number">5</span>(String str, Modifier modifier, int i, int i2, Composer composer, int i3) {
        Greeting(str, modifier, composer, RecomposeScopeImplKt.updateChangedFlags(i | <span class="hljs-number">1</span>), i2);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Unit</span>.INSTANCE;
    }

    <span class="hljs-comment">/* JADX INFO: Access modifiers changed from: private */</span>
    <span class="hljs-keyword">public</span> static <span class="hljs-keyword">final</span> <span class="hljs-built_in">Unit</span> GreetingPreview$lambda$<span class="hljs-number">6</span>(int i, Composer composer, int i2) {
        GreetingPreview(composer, RecomposeScopeImplKt.updateChangedFlags(i | <span class="hljs-number">1</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Unit</span>.INSTANCE;
    }


    <span class="hljs-keyword">public</span> static <span class="hljs-keyword">final</span> void Greeting(<span class="hljs-keyword">final</span> String name, Modifier modifier, Composer $composer, <span class="hljs-keyword">final</span> int $changed, <span class="hljs-keyword">final</span> int i) {
        Object obj;
        int i2;
        int $dirty;
        <span class="hljs-keyword">final</span> Modifier modifier2;
        Intrinsics.checkNotNullParameter(name, <span class="hljs-string">"name"</span>);
        Composer $composer2 = $composer.startRestartGroup(-<span class="hljs-number">1745234003</span>);
        ComposerKt.sourceInformation($composer2, <span class="hljs-string">"C(Greeting)P(1)103@3008L55,104@3089L117,104@3068L138,110@3228L62,113@3351L93,119@3475L50,124@3688L11,118@3450L277:MainActivity.kt#72esb0"</span>);
        int $dirty2 = $changed;
        <span class="hljs-keyword">if</span> ((i &amp; <span class="hljs-number">1</span>) != <span class="hljs-number">0</span>) {
            $dirty2 |= <span class="hljs-number">6</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (($changed &amp; <span class="hljs-number">6</span>) == <span class="hljs-number">0</span>) {
            $dirty2 |= $composer2.changed(name) ? <span class="hljs-number">4</span> : <span class="hljs-number">2</span>;
        }
        int i3 = i &amp; <span class="hljs-number">2</span>;
        <span class="hljs-keyword">if</span> (i3 != <span class="hljs-number">0</span>) {
            $dirty2 |= <span class="hljs-number">48</span>;
            obj = modifier;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (($changed &amp; <span class="hljs-number">48</span>) == <span class="hljs-number">0</span>) {
            obj = modifier;
            $dirty2 |= $composer2.changed(obj) ? <span class="hljs-number">32</span> : <span class="hljs-number">16</span>;
        } <span class="hljs-keyword">else</span> {
            obj = modifier;
        }
        <span class="hljs-keyword">if</span> (($dirty2 &amp; <span class="hljs-number">19</span>) != <span class="hljs-number">18</span> || !$composer2.getSkipping()) {
            Modifier.Companion modifier3 = i3 != <span class="hljs-number">0</span> ? Modifier.INSTANCE : obj;
            <span class="hljs-keyword">if</span> (ComposerKt.isTraceInProgress()) {
                ComposerKt.traceEventStart(-<span class="hljs-number">1745234003</span>, $dirty2, -<span class="hljs-number">1</span>, <span class="hljs-string">"com.zjw.compose.myapplication.Greeting (MainActivity.kt:102)"</span>);
            }
            $composer2.startReplaceGroup(<span class="hljs-number">293979466</span>);
            ComposerKt.sourceInformation($composer2, <span class="hljs-string">"CC(remember):MainActivity.kt#9igjgp"</span>);
            Object rememberedValue = $composer2.rememberedValue();
            <span class="hljs-keyword">if</span> (rememberedValue == Composer.INSTANCE.getEmpty()) {
                i2 = <span class="hljs-number">0</span>;
                Object mutableStateOf$default = SnapshotStateKt.mutableStateOf$default(<span class="hljs-built_in">Long</span>.valueOf(System.currentTimeMillis()), <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>, <span class="hljs-literal">null</span>);
                $composer2.updateRememberedValue(mutableStateOf$default);
                rememberedValue = mutableStateOf$default;
            } <span class="hljs-keyword">else</span> {
                i2 = <span class="hljs-number">0</span>;
            }
            MutableState currentTime$delegate = (MutableState) rememberedValue;
            $composer2.endReplaceGroup();
            <span class="hljs-built_in">Unit</span> unit = <span class="hljs-built_in">Unit</span>.INSTANCE;
            $composer2.startReplaceGroup(<span class="hljs-number">293982120</span>);
            ComposerKt.sourceInformation($composer2, <span class="hljs-string">"CC(remember):MainActivity.kt#9igjgp"</span>);
            Object rememberedValue2 = $composer2.rememberedValue();
            <span class="hljs-keyword">if</span> (rememberedValue2 == Composer.INSTANCE.getEmpty()) {
                $dirty = $dirty2;
                Object obj2 = (Function2) new MainActivityKt$Greeting$<span class="hljs-number">1</span>$<span class="hljs-number">1</span>(currentTime$delegate, <span class="hljs-literal">null</span>);
                $composer2.updateRememberedValue(obj2);
                rememberedValue2 = obj2;
            } <span class="hljs-keyword">else</span> {
                $dirty = $dirty2;
            }
            $composer2.endReplaceGroup();
            EffectsKt.LaunchedEffect(unit, (Function2) rememberedValue2, $composer2, <span class="hljs-number">6</span>);
            $composer2.startReplaceGroup(<span class="hljs-number">293986513</span>);
            ComposerKt.sourceInformation($composer2, <span class="hljs-string">"CC(remember):MainActivity.kt#9igjgp"</span>);
            Object rememberedValue3 = $composer2.rememberedValue();
            <span class="hljs-keyword">if</span> (rememberedValue3 == Composer.INSTANCE.getEmpty()) {
                Object simpleDateFormat = new SimpleDateFormat(<span class="hljs-string">"HH:mm:ss"</span>, Locale.getDefault());
                $composer2.updateRememberedValue(simpleDateFormat);
                rememberedValue3 = simpleDateFormat;
            }
            SimpleDateFormat timeFormat = (SimpleDateFormat) rememberedValue3;
            $composer2.endReplaceGroup();
            String timeStr = timeFormat.format(new Date(Greeting$lambda$<span class="hljs-number">1</span>(currentTime$delegate)));
            TextKt.m3151Text4IGK_g(<span class="hljs-string">"Hello "</span> + name + <span class="hljs-string">"! Current Time: "</span> + timeStr, modifier3, <span class="hljs-number">0L</span>, <span class="hljs-number">0L</span>, (FontStyle) <span class="hljs-literal">null</span>, (FontWeight) <span class="hljs-literal">null</span>, (FontFamily) <span class="hljs-literal">null</span>, <span class="hljs-number">0L</span>, (TextDecoration) <span class="hljs-literal">null</span>, (TextAlign) <span class="hljs-literal">null</span>, <span class="hljs-number">0L</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, (Function1&lt;? <span class="hljs-keyword">super</span> TextLayoutResult, <span class="hljs-built_in">Unit</span>&gt;) <span class="hljs-literal">null</span>, (TextStyle) <span class="hljs-literal">null</span>, $composer2, $dirty &amp; <span class="hljs-number">112</span>, <span class="hljs-number">0</span>, <span class="hljs-number">131068</span>);
            modifier2 = modifier3;
            $composer2 = $composer2;
           
        ScopeUpdateScope endRestartGroup = $composer2.endRestartGroup();
        <span class="hljs-keyword">if</span> (endRestartGroup != <span class="hljs-literal">null</span>) {
            endRestartGroup.updateScope(new Function2() { <span class="hljs-comment">// from class: com.zjw.compose.myapplication.MainActivityKt$$ExternalSyntheticLambda1</span>
                <span class="hljs-meta">@Override</span> <span class="hljs-comment">// kotlin.jvm.functions.Function2</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Object invoke(Object obj3, Object obj4) {
                    <span class="hljs-built_in">Unit</span> Greeting$lambda$<span class="hljs-number">5</span>;
                    Greeting$lambda$<span class="hljs-number">5</span> = MainActivityKt.Greeting$lambda$<span class="hljs-number">5</span>(name, modifier2, $changed, i, (Composer) obj3, ((Integer) obj4).intValue());
                    <span class="hljs-keyword">return</span> Greeting$lambda$<span class="hljs-number">5</span>;
                }
            });
        }
    }
</code></pre>
<p><code>public static final void Greeting(final String name, Modifier modifier, Composer $composer, final int $changed, final int i) {</code></p>
<p>其实大概意思就是 通过入参<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>h</mi><mi>a</mi><mi>n</mi><mi>g</mi><mi>e</mi><mi>d</mi><mtext>与位运算结合</mtext></mrow><annotation encoding="application/x-tex">changed与位运算 结合 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">han</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord cjk_fallback">与位运算结合</span></span></span></span></span>composer2.changed(obj)判断是否dirty ,然后</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-keyword">if</span>(dirty){
     <span class="hljs-regexp">//</span>调用该composable <span class="hljs-built_in">lambda</span>中invoke 逻辑
     <span class="hljs-title class_">TextKt</span>.m3151Text4IGK_g(<span class="hljs-string">"Hello "</span> + name + <span class="hljs-string">"! Current Time: "</span> ...
}<span class="hljs-keyword">else</span>{
     <span class="hljs-variable">$composer2</span>.skipToGroupEnd()
}
</code></pre>
<p>这里 $composer2就是 Composer类型，它有个changed方法负责判断composeable方法入参是否发生变化，如果发生变化就走composeable invoke逻辑发生重组或者说重绘，否则就skipToGroupEnd 不发生重组，这也是compose保证高效的原理之一 参数不发生变化不进行重组</p>
<p>以demo中 text文本发生变化来具体探究compose提供的基础组件 Text是怎么重组的</p>
<pre><code class="hljs language-ini" lang="ini"> Text(
        <span class="hljs-attr">text</span> = <span class="hljs-string">"Hello $name! Current Time: $timeStr"</span>,
        <span class="hljs-attr">modifier</span> = modifier
    )
</code></pre>
<p>//Text 这里被翻译成  TextKt.m3151Text4IGK_g("Hello " + name + "! Current Time: " ...</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/* compiled from: Text.kt */</span>

<span class="hljs-keyword">package</span> androidx.compose.material3;

    <span class="hljs-comment">/* renamed from: Text--4IGK_g  reason: not valid java name */</span>
    <span class="hljs-keyword">public</span> static <span class="hljs-keyword">final</span> void m3151Text4IGK_g(<span class="hljs-keyword">final</span> String text, Modifier modifier, long color, long fontSize, FontStyle fontStyle, FontWeight fontWeight, FontFamily fontFamily, long letterSpacing, TextDecoration textDecoration, TextAlign textAlign, long lineHeight, int overflow, boolean softWrap, int maxLines, int minLines, Function1&lt;? <span class="hljs-keyword">super</span> TextLayoutResult, <span class="hljs-built_in">Unit</span>&gt; function1, TextStyle style, Composer $composer, <span class="hljs-keyword">final</span> int $changed, <span class="hljs-keyword">final</span> int $changed1, <span class="hljs-keyword">final</span> int i) {
        Object obj;
        Modifier modifier2;
        int i2;
        long color2;
        long fontSize2;
        Object fontStyle2;
        Object fontWeight2;
        int $dirty;
        int $dirty1;
        int i3;
        int i4;
        int $dirty12;
        int i5;
        boolean softWrap2;
        int $dirty13;
        TextAlign textAlign2;
        int overflow2;
        int maxLines2;
        int minLines2;
        Function1 onTextLayout;
        FontFamily fontFamily2;
        TextDecoration textDecoration2;
        TextStyle style2;
        FontStyle fontStyle3;
        long fontSize3;
        FontWeight fontWeight3;
        long letterSpacing2;
        long lineHeight2;
        int $dirty2;
        long textColor;
        Composer $composer2;
        <span class="hljs-keyword">final</span> boolean softWrap3;
        <span class="hljs-keyword">final</span> long color3;
        <span class="hljs-keyword">final</span> Modifier modifier3;
        <span class="hljs-keyword">final</span> TextAlign textAlign3;
        <span class="hljs-keyword">final</span> int maxLines3;
        <span class="hljs-keyword">final</span> Function1 onTextLayout2;
        <span class="hljs-keyword">final</span> int maxLines4;
        <span class="hljs-keyword">final</span> TextStyle style3;
        <span class="hljs-keyword">final</span> FontWeight fontWeight4;
        <span class="hljs-keyword">final</span> FontStyle fontStyle4;
        <span class="hljs-keyword">final</span> FontFamily fontFamily3;
        <span class="hljs-keyword">final</span> long letterSpacing3;
        <span class="hljs-keyword">final</span> TextDecoration textDecoration3;
        <span class="hljs-keyword">final</span> long lineHeight3;
        <span class="hljs-keyword">final</span> int minLines3;
        <span class="hljs-keyword">final</span> long fontSize4;
        int i6;
        Composer $composer3 = $composer.startRestartGroup(-<span class="hljs-number">2055108902</span>);
        ComposerKt.sourceInformation($composer3, <span class="hljs-string">"C(Text)P(14,9,0:c#ui.graphics.Color,2:c#ui.unit.TextUnit,3:c#ui.text.font.FontStyle,4!1,5:c#ui.unit.TextUnit,16,15:c#ui.text.style.TextAlign,6:c#ui.unit.TextUnit,11:c#ui.text.style.TextOverflow,12)108@5620L7,113@5732L530:Text.kt#uh7d8r"</span>);
        int $dirty3 = $changed;
        <span class="hljs-keyword">if</span> ((i &amp; <span class="hljs-number">1</span>) != <span class="hljs-number">0</span>) {
            $dirty3 |= <span class="hljs-number">6</span>;
            obj = text;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (($changed &amp; <span class="hljs-number">6</span>) == <span class="hljs-number">0</span>) {
            obj = text;
            $dirty3 |= $composer3.changed(obj) ? <span class="hljs-number">4</span> : <span class="hljs-number">2</span>;
        } <span class="hljs-keyword">else</span> {
            obj = text;
        }
        <span class="hljs-comment">//省略后续代码</span>

</code></pre>
<p>翻译一下就是 把入参text传入 $composer3.changed判断是否与上次记录的值发生变化
Composer源码如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54bfdf9f8aae48d191680875696900f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemp3X3N3dW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348691&amp;x-signature=YLUuOe9yDr9LktFqkW6tZSPWnXc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd7119bd782a42e1a31b0da24e099e49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemp3X3N3dW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348691&amp;x-signature=ckDfXDyl1H73gYfjb5IF%2Fa5E30U%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2a8479bc9d04a6ca4402449bc085e0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemp3X3N3dW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348691&amp;x-signature=Jc7bHsgtevE0ckYTZnWKzKFx96c%3D" alt="image.png" loading="lazy"/></p>
<p>上次text的值就存在Composer里成员变量slotTable对象的slots变量中，值怎么存的可以在SlotTable set方法打断点</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80fc78a2d6ec4ec8bd7b8937f4f8019a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemp3X3N3dW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767348691&amp;x-signature=kuMa9VSkQ01Vv9TR7saxVzyBk5A%3D" alt="b473ce9c4fce8d88fc4e73a2fb2657c5.png" loading="lazy"/></p>
<p>可以看到slots中存储了整个ComposeView中所有入参值是以Array数组的形式，这里就涉及到Composer changed方法为什么要调用nextSlot()和Composerable方法反编译后为什么都有如下3个方法调用</p>
<pre><code class="hljs language-ini" lang="ini"> Composer $<span class="hljs-attr">composer2</span> = <span class="hljs-variable">$composer</span>.startRestartGroup(-<span class="hljs-number">1745234003</span>)
 //省略代码
 $composer.skipToGroupEnd()
//省略代码
 ScopeUpdateScope <span class="hljs-attr">endRestartGroup</span> = <span class="hljs-variable">$composer2</span>.endRestartGroup()<span class="hljs-comment">;</span>
</code></pre>
<p>因为SlotTable存储的是整个ComposeView组成composeable函数UI树的所有入参Array，扁平化存储，所以需要以Composeable要是使用Group分组，使用“指针”来锚定当前执行到的composeable函数当前入参，指针寻址这里不做展开说明有兴趣可以自行去看，Composer::changed方法判断本次value和slots存储的对应text是否变化，变化就发生重组逻辑。</p>
<p>至此我们就已经基本探究完Compose机制了，总结一下就是Compose是使用开发者写的@Composeable函数关系来描述这个UI树的，不同于Android View系统使用的ViewGroup/View对象Tree来描述UI树；而UI的更新 Compose使用的入参判断变化来更新，而Android View系统使用的是命令式比如显示调用View.requstLayout</p>
<h2 data-id="heading-1">Compose实现</h2>
<p>原理搞懂了，接下来就来实现一个Compose,其实就5个核心类，让AI直接给出Compose简易实现,这里就不贴代码了，结尾有Github Compose简易实现源码链接，以下是核心类功能介绍</p>
<h3 data-id="heading-2">一、SlotTable</h3>
<h4 data-id="heading-3">功能：</h4>
<ul>
<li>核心“记忆仓库”，线性存储所有 Composable 的状态（remember 值、参数值、lambda 等）</li>
<li>管理 index 指针，支持顺序访问</li>
<li>管理 Group：startGroup / endGroup / skipGroup</li>
<li>startGroup：记录 group 起始 index</li>
<li>endGroup：计算 group 占用 slot 数量</li>
<li>skipGroup：重组时快速跳过整个 group</li>
</ul>
<h4 data-id="heading-4">原理：</h4>
<ul>
<li>每次调用 next() → 返回当前 slot 并 index++</li>
<li>每次调用 update() → 修改 index-1 对应的 slot</li>
</ul>
<hr/>
<h3 data-id="heading-5">二、Composer</h3>
<h4 data-id="heading-6">功能：</h4>
<ul>
<li>SlotTable 封装器：提供更高层的接口</li>
<li>changed(value) → 判断当前 slot 是否和传入值不同，返回 Boolean</li>
<li>remember(factory) → 读取 slot，如果为空执行 lambda 并写入 slot</li>
<li>Group 管理：startGroup() / endGroup() / skipGroup()</li>
</ul>
<h4 data-id="heading-7">原理：</h4>
<ul>
<li>将 Composable 函数的运行与 SlotTable 状态绑定</li>
<li>控制 skip / 重组逻辑</li>
</ul>
<hr/>
<h3 data-id="heading-8">三、State</h3>
<h4 data-id="heading-9">功能：</h4>
<ul>
<li>可变状态持有者</li>
<li>value 变化时触发回调 → 触发重组</li>
</ul>
<h4 data-id="heading-10">原理：</h4>
<ul>
<li>内部存储当前值 _value</li>
<li>set(value) → 值改变 → 调用 onChange()</li>
<li>mutableStateOf 是创建 State 的工厂函数</li>
</ul>
<hr/>
<h3 data-id="heading-11">四、Composition</h3>
<h4 data-id="heading-12">功能：</h4>
<ul>
<li>管理整个 Composable 树的入口</li>
<li>setContent() → 设置顶层 Composable</li>
<li>recompose() → 重组整个树</li>
<li>内部持有 SlotTable + Composer</li>
</ul>
<h4 data-id="heading-13">原理：</h4>
<ul>
<li>每次 recompose() → reset SlotTable → 执行顶层 Composable → 根据 changed/skip 更新 slot</li>
<li>可由 State 改变触发</li>
</ul>
<hr/>
<h3 data-id="heading-14">五、Composable 函数</h3>
<h4 data-id="heading-15">功能：</h4>
<ul>
<li>业务逻辑 + UI 表达</li>
<li>使用 composer.changed() 判断参数是否变化</li>
</ul>
<hr/>
<h3 data-id="heading-16">Android View系统 对比 Compose</h3>






























<table><thead><tr><th>特性</th><th>View 系统</th><th>Compose</th></tr></thead><tbody><tr><td>UI架构</td><td>View对象组成的UI Tree</td><td>Composable 函数描述UI Tree</td></tr><tr><td>渲染对象</td><td>每个 View 占用对象内存</td><td>SlotTable 记录状态、重组时决定是否绘制</td></tr><tr><td>Draw / Canvas</td><td>每个 View 负责绘制自己</td><td>Applier（类似 Canvas）统一提交 UI 树变更</td></tr><tr><td>重绘策略</td><td>requestLayout/invalidate() → 递归绘制</td><td>State 改变 → Recomposer → 重组 → 重绘</td></tr></tbody></table>
<h2 data-id="heading-17">源码</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzjw-swun%2FComposeDemo" target="_blank" title="https://github.com/zjw-swun/ComposeDemo" ref="nofollow noopener noreferrer">github.com/zjw-swun/Co…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Shiro框架工作原理与实践精讲]]></title>    <link>https://juejin.cn/post/7587995707165605907</link>    <guid>https://juejin.cn/post/7587995707165605907</guid>    <pubDate>2025-12-26T10:19:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587995707165605907" data-draft-id="7587995707165589523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Shiro框架工作原理与实践精讲"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T10:19:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户72942943223"/> <meta itemprop="url" content="https://juejin.cn/user/1998245912903995"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Shiro框架工作原理与实践精讲
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1998245912903995/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户72942943223
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:19:00.000Z" title="Fri Dec 26 2025 10:19:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Java 企业级开发中，Apache Shiro 凭借其轻量级、灵活且易于理解的特点，依然是众多开发者进行权限管理的首选框架。然而，在实战中，很多开发者往往止步于简单的 INI 配置或硬编码的权限拦截，导致系统在面对复杂的业务需求时缺乏弹性。本文将结合个人实战经验，深入探讨 Shiro 的注解式权限控制以及如何结合数据库实现动态权限配置，帮助你打造一个安全、灵活的权限系统。<strong>学习地址：pan.baidu.com/s/1WwerIZ_elz_FyPKqXAiZCA?pwd=waug</strong></p>
<h2 data-id="heading-0">一、 注解式权限控制：优雅的代码防护</h2>
<p>Shiro 提供了五个核心注解，分别是 <code>@RequiresAuthentication</code>、<code>@RequiresUser</code>、<code>@RequiresGuest</code>、<code>@RequiresRoles</code> 和 <code>@RequiresPermissions</code>。通过在 Controller 或 Service 层方法上直接添加注解，我们可以将权限校验逻辑从业务代码中剥离出来。</p>
<h3 data-id="heading-1">1. 开启注解支持</h3>
<p>首先，必须在 Spring 的配置类中启用 Shiro 注解支持，否则注解将不会生效。</p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShiroConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="hljs-title function_">defaultAdvisorAutoProxyCreator</span><span class="hljs-params">()</span> {
        <span class="hljs-type">DefaultAdvisorAutoProxyCreator</span> <span class="hljs-variable">creator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAdvisorAutoProxyCreator</span>();
        creator.setProxyTargetClass(<span class="hljs-literal">true</span>);
        <span class="hljs-keyword">return</span> creator;
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="hljs-title function_">authorizationAttributeSourceAdvisor</span><span class="hljs-params">(SecurityManager securityManager)</span> {
        <span class="hljs-type">AuthorizationAttributeSourceAdvisor</span> <span class="hljs-variable">advisor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationAttributeSourceAdvisor</span>();
        advisor.setSecurityManager(securityManager);
        <span class="hljs-keyword">return</span> advisor;
    }
}
</code></pre>
<h3 data-id="heading-2">2. 使用注解实战</h3>
<p>在实际开发中，建议使用  <strong>“角色”</strong>  粗粒度控制用户类型，使用  <strong>“权限”</strong>  精细控制操作行为。</p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/order"</span>)
public class OrderController {

    <span class="hljs-comment">// 只有登录用户才能访问</span>
    <span class="hljs-variable">@RequiresUser</span>
    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/list"</span>)
    public String <span class="hljs-built_in">list</span>() {
        <span class="hljs-selector-tag">return</span> "订单列表";
    }

    <span class="hljs-comment">// 需要具备 'admin' 角色</span>
    @<span class="hljs-selector-tag">RequiresRoles</span>(<span class="hljs-string">"admin"</span>)
    @<span class="hljs-selector-tag">DeleteMapping</span>(<span class="hljs-string">"/delete/{id}"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">delete</span>(<span class="hljs-variable">@PathVariable</span> Long id) {
        <span class="hljs-selector-tag">return</span> "删除订单 <span class="hljs-selector-tag">ID</span>: " + <span class="hljs-selector-tag">id</span>;
    }

    <span class="hljs-comment">// 需要同时具备 'order:create' 和 'order:audit' 权限</span>
    <span class="hljs-comment">// logical = Logical.AND 表示必须同时拥有，OR 表示满足其一</span>
    @<span class="hljs-selector-tag">RequiresPermissions</span>(value = {"<span class="hljs-attribute">order</span>:create<span class="hljs-string">", "</span><span class="hljs-attribute">order</span>:audit"}, <span class="hljs-selector-tag">logical</span> = <span class="hljs-selector-tag">Logical</span><span class="hljs-selector-class">.AND</span>)
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"/create"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">create</span>() {
        <span class="hljs-selector-tag">return</span> "创建订单";
    }
}
</code></pre>
<p><strong>实战心得：</strong>  尽量不要将过于复杂的逻辑组合放在注解中，保持注解的简洁性。复杂的权限判断建议在自定义 Filter 中处理。</p>
<h2 data-id="heading-3">二、 动态权限配置：摆脱硬编码的枷锁</h2>
<p>真实世界的业务需求是瞬息万变的。如果每次新增一个菜单或权限都需要修改代码重启服务，那显然是不可接受的。我们需要实现<strong>动态权限加载</strong>，即权限配置存储在数据库中，用户登录后实时加载。</p>
<h3 data-id="heading-4">1. 自定义 Realm 实现动态授权</h3>
<p>Shiro 的核心在于 <code>Realm</code>。我们需要重写 <code>doGetAuthorizationInfo</code> 方法，从数据库查询当前用户的角色和权限。</p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-meta">@Component</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRealm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizingRealm</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">UserService</span> userService;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">PermissionService</span> permissionService;

    <span class="hljs-comment">// 认证</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">AuthenticationInfo</span> doGetAuthenticationInfo(<span class="hljs-type">AuthenticationToken</span> token) {
        <span class="hljs-comment">// ... 省略用户名密码校验逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">SimpleAuthenticationInfo</span>(user, user.getPassword(), getName());
    }

    <span class="hljs-comment">// 授权 (核心逻辑)</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">AuthorizationInfo</span> doGetAuthorizationInfo(<span class="hljs-type">PrincipalCollection</span> principals) {
        <span class="hljs-comment">// 1. 获取当前登录用户</span>
        <span class="hljs-type">User</span> user = (<span class="hljs-type">User</span>) principals.getPrimaryPrincipal();
        
        <span class="hljs-type">SimpleAuthorizationInfo</span> info = <span class="hljs-keyword">new</span> <span class="hljs-type">SimpleAuthorizationInfo</span>();

        <span class="hljs-comment">// 2. 动态查询数据库中的角色</span>
        <span class="hljs-type">Set</span>&lt;<span class="hljs-type">String</span>&gt; roleCodes = userService.findRolesByUserId(user.getId());
        info.setRoles(roleCodes);

        <span class="hljs-comment">// 3. 动态查询数据库中的权限</span>
        <span class="hljs-type">Set</span>&lt;<span class="hljs-type">String</span>&gt; permCodes = permissionService.findPermsByUserId(user.getId());
        info.setStringPermissions(permCodes);

        <span class="hljs-keyword">return</span> info;
    }
}
</code></pre>
<h3 data-id="heading-5">2. 实现热加载：清除缓存</h3>
<p>默认情况下，Shiro 会将授权信息缓存起来。如果管理员在后台修改了用户的权限并同步到数据库，但用户 Session 未过期，用户依然拥有旧权限。此时需要<strong>动态刷新缓存</strong>。</p>
<p>我们可以编写一个工具类，当权限变更时主动调用。</p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShiroCacheUtil</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Realm</span> realm;

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">clearCachedAuthorizationInfo</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> principal</span>) {
        <span class="hljs-comment">// 获取当前 Realm 的缓存管理器</span>
        <span class="hljs-title class_">CacheManager</span> cacheManager = realm.<span class="hljs-title function_">getCacheManager</span>();
        <span class="hljs-keyword">if</span> (cacheManager != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 获取缓存对象</span>
            <span class="hljs-title class_">Cache</span>&lt;<span class="hljs-title class_">Object</span>, <span class="hljs-title class_">AuthorizationInfo</span>&gt; cache = cacheManager.<span class="hljs-title function_">getCache</span>(realm.<span class="hljs-title function_">getName</span>());
            <span class="hljs-keyword">if</span> (cache != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 移除指定用户的授权缓存</span>
                <span class="hljs-comment">// 这里的 key 通常是 principal (如用户名或用户对象)</span>
                cache.<span class="hljs-title function_">remove</span>(principal);
            }
        }
    }
}

<span class="hljs-comment">// 调用示例：管理员修改权限后</span>
<span class="hljs-comment">// shiroCacheUtil.clearCachedAuthorizationInfo("zhangsan");</span>
</code></pre>
<h2 data-id="heading-6">三、 进阶技巧：自定义 Filter 处理特殊场景</h2>
<p>有时候注解无法满足所有需求，比如：只有 “创建人本人” 才能修改订单。这涉及到业务数据的校验，Shiro 提供的注解做不到。此时我们需要自定义 Filter。</p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OwnerOrAdminFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PermissionsAuthorizationFilter</span> </span>{

    <span class="hljs-meta">@Override</span>
    public boolean isAccessAllowed(<span class="hljs-type">ServletRequest</span> request, <span class="hljs-type">ServletResponse</span> response, <span class="hljs-type">Object</span> mappedValue) {
        <span class="hljs-type">Subject</span> subject = getSubject(request, response);
        
        <span class="hljs-comment">// 1. 如果是 admin，直接放行</span>
        <span class="hljs-keyword">if</span> (subject.hasRole(<span class="hljs-string">"admin"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-comment">// 2. 检查是否是资源拥有者（模拟逻辑）</span>
        <span class="hljs-type">String</span> orderId = request.getParameter(<span class="hljs-string">"orderId"</span>);
        <span class="hljs-type">User</span> currentUser = (<span class="hljs-type">User</span>) subject.getPrincipal();
        
        <span class="hljs-comment">// 假设调用 Service 检查该订单是否属于当前用户</span>
        boolean isOwner = checkOrderOwner(orderId, currentUser.getId());
        
        <span class="hljs-keyword">return</span> isOwner;
    }
}
</code></pre>
<p>然后在 <code>ShiroConfig</code> 中注册这个 Filter，并将其应用到特定的 URL 上：</p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">ShiroFilterFactoryBean</span> <span class="hljs-title function_">shiroFilter</span>(<span class="hljs-params">SecurityManager securityManager</span>) {
    <span class="hljs-title class_">ShiroFilterFactoryBean</span> shiroFilter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShiroFilterFactoryBean</span>();
    shiroFilter.<span class="hljs-title function_">setSecurityManager</span>(securityManager);
    
    <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Filter</span>&gt; filters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    filters.<span class="hljs-title function_">put</span>(<span class="hljs-string">"ownerOrAdmin"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">OwnerOrAdminFilter</span>());
    shiroFilter.<span class="hljs-title function_">setFilters</span>(filters);

    <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; filterChainDefinitionMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();
    filterChainDefinitionMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"/order/update/**"</span>, <span class="hljs-string">"ownerOrAdmin"</span>);
    <span class="hljs-comment">// ...</span>
    shiroFilter.<span class="hljs-title function_">setFilterChainDefinitionMap</span>(filterChainDefinitionMap);
    <span class="hljs-keyword">return</span> shiroFilter;
}
</code></pre>
<h2 data-id="heading-7">总结</h2>
<p>通过 Shiro 的注解，我们可以让代码逻辑更加清晰；通过结合数据库与自定义 Realm，我们实现了权限的动态配置与热加载；而通过自定义 Filter，我们填补了通用安全框架与具体业务逻辑之间的鸿沟。掌握这三板斧，足以应对大多数企业级应用开发中的权限管理挑战。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Dubbo的分布式系统架构+事务解决方案]]></title>    <link>https://juejin.cn/post/7588002126258307078</link>    <guid>https://juejin.cn/post/7588002126258307078</guid>    <pubDate>2025-12-26T10:17:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588002126258307078" data-draft-id="7587995707165556755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Dubbo的分布式系统架构+事务解决方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T10:17:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户72942943223"/> <meta itemprop="url" content="https://juejin.cn/user/1998245912903995"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Dubbo的分布式系统架构+事务解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1998245912903995/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户72942943223
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:17:56.000Z" title="Fri Dec 26 2025 10:17:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在微服务架构日益普及的今天，Apache Dubbo 凭借其高性能的 RPC 调用能力，成为了众多企业构建分布式系统的首选框架。然而，随着业务体量的膨胀，服务拆分越来越细，跨服务的业务操作（如“下单扣库存+扣余额”）变得极为普遍。在高并发场景下，如何保证这些跨服务操作的数据一致性，同时维持系统的高吞吐量和低延迟，成为了架构师必须面对的挑战。本文将深入探讨 Dubbo 分布式事务的进阶策略，重点解析如何优化传统方案以适应高并发环境。<strong>学习地址：pan.baidu.com/s/1WwerIZ_elz_FyPKqXAiZCA?pwd=waug</strong></p>
<h2 data-id="heading-0">一、 传统方案的瓶颈：TCC 与 Seata AT 模式的困境</h2>
<p>在谈及优化之前，我们必须先明确痛点。传统的 <strong>2PC（两阶段提交）</strong>  性能较差，阻塞严重，不适合高并发。而目前主流的 <strong>TCC (Try-Confirm-Cancel)</strong>  和 <strong>Seata AT 模式</strong> 虽然解决了最终一致性，但在高并发下仍有瓶颈：</p>
<ol>
<li><strong>TCC 的侵入性成本</strong>：需要为每个业务接口编写三个方法，开发成本高，且存在“空回滚”和“悬挂”等复杂边缘情况处理。</li>
<li><strong>Seata AT 的锁竞争</strong>：AT 模式通过解析 SQL 记录前镜像和后镜像，利用全局锁来保证写隔离。在高并发竞争严重的情况下（如秒杀场景），全局锁的互斥等待会导致大量线程阻塞，数据库连接池迅速耗尽，RT（响应时间）飙升。</li>
</ol>
<h2 data-id="heading-1">二、 优化策略一：基于可靠消息的最终一致性（异步化）</h2>
<p>对于<strong>高并发且非强实时一致性</strong>要求的场景（如下单成功后发送积分、发放优惠券），最有效的优化策略是<strong>将同步调用改为异步调用</strong>，彻底解耦核心链路。</p>
<p>Dubbo 提供了强大的异步调用特性，我们可以结合消息队列（如 RocketMQ）实现事务的异步化处理。</p>
<p><strong>代码示例：</strong></p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@DubboReference</span>(<span class="hljs-keyword">async</span> = <span class="hljs-literal">true</span>) <span class="hljs-comment">// 开启 Dubbo 异步调用</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">PointsService</span> pointsService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">OrderMapper</span> orderMapper;

    <span class="hljs-meta">@GlobalTransactional</span>(name = <span class="hljs-string">"create-order"</span>, rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createOrder</span>(<span class="hljs-params">OrderDTO order</span>) {
        <span class="hljs-comment">// 1. 扣减库存、创建订单（核心链路同步执行）</span>
        orderMapper.<span class="hljs-title function_">insert</span>(order);
        
        <span class="hljs-comment">// 2. 调用积分服务（Dubbo 异步调用）</span>
        <span class="hljs-comment">// 这里的 RPC 调用会立即返回，不阻塞当前线程</span>
        pointsService.<span class="hljs-title function_">addPoints</span>(order.<span class="hljs-title function_">getUserId</span>(), order.<span class="hljs-title function_">getAmount</span>());
        
        <span class="hljs-comment">// 注意：为保证可靠性，生产环境通常推荐使用 MQ 事务消息</span>
        <span class="hljs-comment">// 这里展示的是利用 Dubbo 特性的轻量级异步化思路</span>
    }
}
</code></pre>
<p><strong>核心优化点：</strong>  通过 <code>async=true</code>，订单服务的 TCC 分支或本地事务提交后，无需等待积分服务执行完毕即可返回，大幅提升 QPS。</p>
<h2 data-id="heading-2">三、 优化策略二：本地消息表 + 定时任务（无锁竞争）</h2>
<p>针对强一致性要求较高的场景，为了避免 Seata AT 模式的全局锁竞争，可以采用<strong>本地消息表</strong>模式。该模式利用了“业务操作”与“消息发送”在同一个本地数据库事务中的特性，保证了原子性，下游服务通过轮询消费消息。</p>
<p><strong>代码示例：</strong></p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentServiceImpl</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">PaymentMapper</span> paymentMapper;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">LocalMessageMapper</span> messageMapper;
    <span class="hljs-meta">@DubboReference</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">WalletService</span> walletService;

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processPayment</span>(<span class="hljs-params">PaymentRequest req</span>) {
        <span class="hljs-comment">// 1. 执行本地业务：更新支付流水</span>
        paymentMapper.<span class="hljs-title function_">updateStatus</span>(req.<span class="hljs-title function_">getId</span>(), <span class="hljs-string">"SUCCESS"</span>);

        <span class="hljs-comment">// 2. 在同一个本地事务中，插入一条待发送的“下游任务消息”</span>
        <span class="hljs-title class_">LocalMessage</span> msg = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalMessage</span>();
        msg.<span class="hljs-title function_">setPayload</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">toJSONString</span>(req));
        msg.<span class="hljs-title function_">setStatus</span>(<span class="hljs-string">"SENDING"</span>);
        msg.<span class="hljs-title function_">setTargetService</span>(<span class="hljs-string">"WalletService"</span>); <span class="hljs-comment">// 标记目标服务</span>
        messageMapper.<span class="hljs-title function_">insert</span>(msg);
        
        <span class="hljs-comment">// 事务提交后，消息已持久化。此时无需立即调用 Dubbo。</span>
    }
}

<span class="hljs-comment">// 独立的定时任务线程（或 MQ 消费者）</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageJob</span> {
    <span class="hljs-meta">@Scheduled</span>(fixedDelay = <span class="hljs-number">5000</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">sendPendingMessages</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 查询状态为 SENDING 的消息</span>
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">LocalMessage</span>&gt; messages = messageMapper.<span class="hljs-title function_">selectSendingMessages</span>(<span class="hljs-number">100</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">LocalMessage</span> msg : messages) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 通过反射或动态路由调用下游 Dubbo 服务</span>
                walletService.<span class="hljs-title function_">deduction</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parseObject</span>(msg.<span class="hljs-title function_">getPayload</span>(), <span class="hljs-title class_">WalletReq</span>.<span class="hljs-property">class</span>));
                
                <span class="hljs-comment">// 调用成功，更新消息状态为 SENT</span>
                messageMapper.<span class="hljs-title function_">updateStatus</span>(msg.<span class="hljs-title function_">getId</span>(), <span class="hljs-string">"SENT"</span>);
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
                <span class="hljs-comment">// 记录日志，等待下次重试</span>
                log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Message retry failed"</span>, e);
            }
        }
    }
}
</code></pre>
<p><strong>核心优化点：</strong>  该方案完全不依赖分布式锁，消除了数据库层面的行锁竞争瓶颈，非常适合高并发的资金流转场景。</p>
<h2 data-id="heading-3">四、 优化策略三：Dubbo Filter 实现幂等性保障</h2>
<p>在高并发优化中，异步化往往伴随着重复调用的风险（网络抖动导致重试）。因此，<strong>幂等性</strong>是分布式事务优化的基石。我们可以通过自定义 Dubbo Filter 来优雅地实现幂等检查。</p>
<p><strong>代码示例：</strong></p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Activate</span>(group = {<span class="hljs-title class_">Constants</span>.<span class="hljs-property">PROVIDER</span>})
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdempotentFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">RedisTemplate</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; redisTemplate;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Result</span> <span class="hljs-title function_">invoke</span>(<span class="hljs-params">Invoker&lt;?&gt; invoker, Invocation invocation</span>) {
        <span class="hljs-title class_">String</span> requestId = invocation.<span class="hljs-title function_">getAttachment</span>(<span class="hljs-string">"requestId"</span>);
        
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">StringUtils</span>.<span class="hljs-title function_">isBlank</span>(requestId)) {
            <span class="hljs-keyword">return</span> invoker.<span class="hljs-title function_">invoke</span>(invocation); <span class="hljs-comment">// 没有 ID 则放行</span>
        }

        <span class="hljs-title class_">String</span> key = <span class="hljs-string">"dubbo:idempotent:"</span> + invocation.<span class="hljs-title function_">getMethodName</span>() + <span class="hljs-string">":"</span> + requestId;
        
        <span class="hljs-comment">// SETNX 保证原子性</span>
        <span class="hljs-title class_">Boolean</span> success = redisTemplate.<span class="hljs-title function_">opsForValue</span>().<span class="hljs-title function_">setIfAbsent</span>(key, <span class="hljs-string">"1"</span>, <span class="hljs-number">10</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>);
        
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Boolean</span>.<span class="hljs-property">FALSE</span>.<span class="hljs-title function_">equals</span>(success)) {
            <span class="hljs-comment">// 请求已处理过，直接返回，不执行业务逻辑</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppResponse</span>(<span class="hljs-string">"Duplicate Request"</span>, <span class="hljs-literal">null</span>);
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> invoker.<span class="hljs-title function_">invoke</span>(invocation);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            <span class="hljs-comment">// 业务失败，删除 Key 允许重试（视业务策略而定）</span>
            redisTemplate.<span class="hljs-title function_">delete</span>(key);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<h2 data-id="heading-4">五、 总结</h2>
<p>在高并发场景下进行 Dubbo 分布式事务优化，核心在于<strong>降低锁持有时间</strong>和<strong>减少同步阻塞</strong>。</p>
<ol>
<li>对于非核心强一致流程，首选<strong>异步化（MQ 或 Dubbo Async）</strong> ，最大限度提升吞吐。</li>
<li>对于核心强一致流程，采用<strong>本地消息表</strong>规避全局锁竞争。</li>
<li>无论采用哪种方案，必须构建完善的<strong>幂等性机制</strong>（如 Redis + Filter）以应对重试风暴。</li>
</ol>
<p>没有银弹，只有最适合业务架构的权衡取舍。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kubernetes/k8s全栈技术讲解+企业级实战项目课程]]></title>    <link>https://juejin.cn/post/7588001624904531987</link>    <guid>https://juejin.cn/post/7588001624904531987</guid>    <pubDate>2025-12-26T10:20:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588001624904531987" data-draft-id="7587998744294653958" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kubernetes/k8s全栈技术讲解+企业级实战项目课程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T10:20:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户72942943223"/> <meta itemprop="url" content="https://juejin.cn/user/1998245912903995"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kubernetes/k8s全栈技术讲解+企业级实战项目课程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1998245912903995/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户72942943223
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:20:05.000Z" title="Fri Dec 26 2025 10:20:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着云原生技术的成熟，Kubernetes (K8s) 已成为事实上的基础设施操作系统。然而，原生的 K8s 资源（如 Deployment、Service）主要关注通用型负载的编排。在处理复杂的业务逻辑（如数据库高可用切换、分布式任务调度、自定义中间件管理）时，直接使用 YAML 配置往往力不从心。此时，<strong>Kubernetes Operator 模式</strong>应运而生。<strong>学习地址：pan.baidu.com/s/1WwerIZ_elz_FyPKqXAiZCA?pwd=waug</strong></p>
<p>本文将带你深入 Operator 开发的核心战场，从定义自定义资源（CRD）到编写控制循环，手把手构建一个企业级的 Operator。</p>
<h2 data-id="heading-0">一、 架构设计理念：为何需要 Operator？</h2>
<p>Operator 基于 <strong>Kubernetes 控制器模式</strong>。它通过“监控实际状态 -&gt; 调整偏差 -&gt; 使实际状态趋向期望状态”的无限循环来管理工作负载。</p>
<ul>
<li><strong>CRD (Custom Resource Definition)</strong> ：扩展 K8s API，声明一种新的资源类型（如 <code>MySQLCluster</code>）。</li>
<li><strong>Controller</strong>：业务逻辑的大脑，监听 CRD 的变化并执行操作。</li>
</ul>
<h2 data-id="heading-1">二、 实战第一步：定义 CRD</h2>
<p>假设我们要开发一个简单的 <code>WebApp</code> 资源，它能自动管理 Deployment 并根据副本数配置 HPA。首先，我们需要定义 CRD。</p>
<p><strong><code>crd/webapp.yaml</code></strong></p>
<p>yaml</p>
<p>复制</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apiextensions.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">CustomResourceDefinition</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">webapps.example.com</span> <span class="hljs-comment"># 资源名称，复数形式</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">group:</span> <span class="hljs-string">example.com</span> <span class="hljs-comment"># API 组名</span>
  <span class="hljs-attr">versions:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">v1</span>
      <span class="hljs-attr">served:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">storage:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">schema:</span>
        <span class="hljs-attr">openAPIV3Schema:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
          <span class="hljs-attr">properties:</span>
            <span class="hljs-attr">spec:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
              <span class="hljs-attr">properties:</span>
                <span class="hljs-attr">replicas:</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">integer</span>
                <span class="hljs-attr">image:</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                <span class="hljs-attr">port:</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">integer</span>
            <span class="hljs-attr">status:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
              <span class="hljs-attr">properties:</span>
                <span class="hljs-attr">availableReplicas:</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">integer</span>
  <span class="hljs-attr">scope:</span> <span class="hljs-string">Namespaced</span>
  <span class="hljs-attr">names:</span>
    <span class="hljs-attr">plural:</span> <span class="hljs-string">webapps</span>
    <span class="hljs-attr">singular:</span> <span class="hljs-string">webapp</span>
    <span class="hljs-attr">kind:</span> <span class="hljs-string">WebApp</span>
    <span class="hljs-attr">shortNames:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">wa</span>
</code></pre>
<p>应用该 YAML 后，K8s 集群便识别了 <code>WebApp</code> 这种新资源。</p>
<h2 data-id="heading-2">三、 实战核心：使用 Kubebuilder 开发 Controller</h2>
<p>虽然手写 <code>client-go</code> 也是可行的，但在企业级开发中，我们强烈推荐使用 <strong>Kubebuilder</strong> 或 <strong>Operator SDK</strong>，它们提供了脚手架和代码生成工具，极大地提升了效率。</p>
<h3 data-id="heading-3">1. 初始化项目</h3>
<p>bash</p>
<p>复制</p>
<pre><code class="hljs language-css" lang="css"># 安装 kubebuilder 后
kubebuilder init <span class="hljs-attr">--domain</span> example<span class="hljs-selector-class">.com</span> <span class="hljs-attr">--repo</span> myapp/operator
kubebuilder create api <span class="hljs-attr">--group</span> webapp <span class="hljs-attr">--version</span> v1 <span class="hljs-attr">--kind</span> WebApp
</code></pre>
<h3 data-id="heading-4">2. 编写 Reconcile 逻辑</h3>
<p>这是 Operator 的灵魂。我们需要在 <code>controllers/webapp_controller.go</code> 中实现 <code>Reconcile</code> 方法。该方法的任务是：获取 WebApp 实例，查看是否有对应的 Deployment，没有则创建，有则更新。</p>
<p>go</p>
<p>复制</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> controllers

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"fmt"</span>

	appsv1 <span class="hljs-string">"k8s.io/api/apps/v1"</span>
	corev1 <span class="hljs-string">"k8s.io/api/core/v1"</span>
	<span class="hljs-string">"k8s.io/apimachinery/pkg/api/errors"</span>
	<span class="hljs-string">"k8s.io/apimachinery/pkg/runtime"</span>
	ctrl <span class="hljs-string">"sigs.k8s.io/controller-runtime"</span>
	<span class="hljs-string">"sigs.k8s.io/controller-runtime/pkg/client"</span>

	myappv1 <span class="hljs-string">"myapp/operator/api/v1"</span>
)

<span class="hljs-comment">// 定义注解，用于 OwnerReference</span>
<span class="hljs-keyword">const</span> finalizerName = <span class="hljs-string">"webapp.finalizer"</span>

<span class="hljs-comment">// WebAppReconciler 结构体</span>
<span class="hljs-keyword">type</span> WebAppReconciler <span class="hljs-keyword">struct</span> {
	client.Client
	Scheme *runtime.Scheme
}

<span class="hljs-comment">// +kubebuilder:rbac:groups=webapp.example.com,resources=webapps,verbs=get;list;watch;create;update;patch;delete</span>
<span class="hljs-comment">// +kubebuilder:rbac:groups=webapp.example.com,resources=webapps/status,verbs=get;update;patch</span>
<span class="hljs-comment">// +kubebuilder:rbac:groups=apps,resources=deployments,verbs=get;list;watch;create;update;patch;delete</span>

<span class="hljs-comment">// Reconcile 核心调协逻辑</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *WebAppReconciler)</span></span> Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, <span class="hljs-type">error</span>) {
	log := log.FromContext(ctx)

	<span class="hljs-comment">// 1. 获取 WebApp 实例</span>
	<span class="hljs-keyword">var</span> webApp myappv1.WebApp
	<span class="hljs-keyword">if</span> err := r.Get(ctx, req.NamespacedName, &amp;webApp); err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">if</span> errors.IsNotFound(err) {
			log.Info(<span class="hljs-string">"WebApp resource not found. Ignoring since object must be deleted"</span>)
			<span class="hljs-keyword">return</span> ctrl.Result{}, <span class="hljs-literal">nil</span>
		}
		<span class="hljs-keyword">return</span> ctrl.Result{}, err
	}

	<span class="hljs-comment">// 2. 查找关联的 Deployment</span>
	foundDeploy := &amp;appsv1.Deployment{}
	err := r.Get(ctx, client.ObjectKey{Name: webApp.Name, Namespace: webApp.Namespace}, foundDeploy)

	<span class="hljs-comment">// 3. 如果 Deployment 不存在，则创建它</span>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &amp;&amp; errors.IsNotFound(err) {
		deploy := r.newDeployment(&amp;webApp)
		log.Info(<span class="hljs-string">"Creating a new Deployment"</span>, <span class="hljs-string">"Deployment.Namespace"</span>, deploy.Namespace, <span class="hljs-string">"Deployment.Name"</span>, deploy.Name)
		<span class="hljs-keyword">if</span> err := r.Create(ctx, deploy); err != <span class="hljs-literal">nil</span> {
			log.Error(err, <span class="hljs-string">"Failed to create new Deployment"</span>, <span class="hljs-string">"Deployment.Namespace"</span>, deploy.Namespace, <span class="hljs-string">"Deployment.Name"</span>, deploy.Name)
			<span class="hljs-keyword">return</span> ctrl.Result{}, err
		}
		<span class="hljs-comment">// 创建成功，重新入队等待状态更新</span>
		<span class="hljs-keyword">return</span> ctrl.Result{Requeue: <span class="hljs-literal">true</span>}, <span class="hljs-literal">nil</span>
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Error(err, <span class="hljs-string">"Failed to get Deployment"</span>)
		<span class="hljs-keyword">return</span> ctrl.Result{}, err
	}

	<span class="hljs-comment">// 4. 更新状态 (示例：简单地将副本数同步到 Status)</span>
	webApp.Status.AvailableReplicas = foundDeploy.Status.AvailableReplicas
	<span class="hljs-keyword">if</span> err := r.Status().Update(ctx, &amp;webApp); err != <span class="hljs-literal">nil</span> {
		log.Error(err, <span class="hljs-string">"Failed to update WebApp status"</span>)
		<span class="hljs-keyword">return</span> ctrl.Result{}, err
	}

	<span class="hljs-keyword">return</span> ctrl.Result{}, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// newDeployment 生成 Deployment 对象的辅助函数</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *WebAppReconciler)</span></span> newDeployment(cr *myappv1.WebApp) *appsv1.Deployment {
	labels := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>{<span class="hljs-string">"app"</span>: cr.Name}
	<span class="hljs-keyword">return</span> &amp;appsv1.Deployment{
		ObjectMeta: ctrl.ObjectMeta{
			Name:      cr.Name,
			Namespace: cr.Namespace,
		},
		Spec: appsv1.DeploymentSpec{
			Replicas: &amp;cr.Spec.Replicas,
			Selector: &amp;metav1.LabelSelector{
				MatchLabels: labels,
			},
			Template: corev1.PodTemplateSpec{
				ObjectMeta: metav1.ObjectMeta{Labels: labels},
				Spec: corev1.PodSpec{
					Containers: []corev1.Container{
						{
							Name:  <span class="hljs-string">"nginx"</span>,
							Image: cr.Spec.Image,
							Ports: []corev1.ContainerPort{
								{ContainerPort: cr.Spec.Port},
							},
						},
					},
				},
			},
		},
	}
}

<span class="hljs-comment">// SetupWithManager 注册控制器到 Manager</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *WebAppReconciler)</span></span> SetupWithManager(mgr ctrl.Manager) <span class="hljs-type">error</span> {
	<span class="hljs-keyword">return</span> ctrl.NewControllerManagedBy(mgr).
		For(&amp;myappv1.WebApp{}).
		Owns(&amp;appsv1.Deployment{}). <span class="hljs-comment">// 监控 Owned 资源</span>
		Complete(r)
}
</code></pre>
<h2 data-id="heading-5">四、 本地调试与部署</h2>
<p>开发完成后，不要急着部署到集群，利用 <code>make run</code> 可以在本地直接运行控制器，它会连接到你的 <code>~/.kube/config</code> 指定的集群。</p>
<p>bash</p>
<p>复制</p>
<pre><code class="hljs language-bash" lang="bash">make install <span class="hljs-comment"># 安装 CRD</span>
make run     <span class="hljs-comment"># 运行控制器</span>
</code></pre>
<p>此时，在另一个终端创建一个 <code>WebApp</code> 实例：</p>
<p>yaml</p>
<p>复制</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">webapp.example.com/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">WebApp</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">my-demo-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.19</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
</code></pre>
<p>应用 YAML 后，观察控制器日志，你会发现它自动创建了对应的 Deployment，并维持了 3 个副本。</p>
<h2 data-id="heading-6">五、 总结</h2>
<p>Kubernetes Operator 开发不仅仅是为了自动化部署，更是为了将领域知识（Domain Knowledge）编码进 K8s。通过 CRD 定义业务模型，通过 Controller 实现运维逻辑，我们成功地将 K8s 变成了一个可编程的操作系统。掌握 Kubebuilder 和控制循环模式，是迈向云原生高阶开发者的必经之路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[什么是 RESTful API？凭什么能流行 20 多年？]]></title>    <link>https://juejin.cn/post/7587811143110574131</link>    <guid>https://juejin.cn/post/7587811143110574131</guid>    <pubDate>2025-12-26T10:22:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587811143110574131" data-draft-id="7587811143110295603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="什么是 RESTful API？凭什么能流行 20 多年？"/> <meta itemprop="keywords" content="程序员,前端,后端"/> <meta itemprop="datePublished" content="2025-12-26T10:22:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            什么是 RESTful API？凭什么能流行 20 多年？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:22:38.000Z" title="Fri Dec 26 2025 10:22:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是小阿巴，刚入职的后端程序员，负责给前端的阿花提供 API 接口。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6ce377e58e24f1299afd86db859a28c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=DZcbHBkizPpTpQcN8a3%2BF1VBoYM%3D" alt="" loading="lazy"/></p>
<p>结果一周后，你被阿花揍得鼻青脸肿。</p>
<p>阿花：你是我这辈子见过接口写的最烂的程序员！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb1d6fa9fa09442194c61c7393691e03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=3TGdSmA15WiX10q0FVFr%2FFugccM%3D" alt="" loading="lazy"/></p>
<p>你一脸委屈找到号称 “开发之狗” 的鱼皮诉苦：接口不是能跑就行吗？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ffa8f2bc6da4a63b226aa28528a3ee1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=Sfolq0QPtNCUysgU%2FrtIJWe%2FOWI%3D" alt="" loading="lazy"/></p>
<p>鱼皮嘲笑道：小阿巴，你必须得学学 <strong>RESTful API</strong> 了。</p>
<p>你挠挠头：阿巴阿巴，什么玩意，没听说过！</p>
<p>⭐️ 推荐观看视频版，动画更生动：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbilibili.com%2Fvideo%2FBV1WFBXBmExs" target="_blank" title="https://bilibili.com/video/BV1WFBXBmExs" ref="nofollow noopener noreferrer">bilibili.com/video/BV1WF…</a></p>
<h2 data-id="heading-0">什么是 RESTful API？</h2>
<p>鱼皮：首先，REST 的全称是 <strong>REpresentational State Transfer</strong>，翻译过来叫 “表现层状态转移”。</p>
<p>你一脸懵：鱼皮 gie gie，能说人话吗？我是傻子，听不太懂。</p>
<p>鱼皮：别急，我给你拆开来讲，保证你理解。</p>
<p><strong>RE（Representational）</strong> 表现层，是指 <strong>资源（Resource）</strong> 的表现形式。</p>
<p>你好奇了：什么是资源？</p>
<p>鱼皮：资源就是 <strong>你想要操作的数据对象</strong>。</p>
<p>比如用户、商品、文章，这些都是资源。用户列表是一个资源，某个具体的用户也是一个资源。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbdc3fe90bbe4a36a132182799c0be42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=brTVgNyWuBPwuJ7nXYdxoKTVbj0%3D" alt="" loading="lazy"/></p>
<p>表现层是指资源呈现出来的具体格式，比如同一个用户资源，可以用 JSON 格式返回给客户端，也可以用 XML 格式返回，这就是不同的 “表现形式”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6756cefbbf3f401685a580d5d98bc33f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=hNM9HOby2kf9gP1wlC%2Fm7LMgs4E%3D" alt="" loading="lazy"/></p>
<p><strong>S（State）</strong> 是指 “状态”。</p>
<p>你：啥是状态？</p>
<p>鱼皮：比如你登录网站后，服务器会在内存中记住 “你是谁”，之后在网站上操作就不用再次登录了，这就是 <strong>有状态</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff47ab4eb0ed4fc097e373898454c797~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=TWl3tJuy1P5BRTGFITSIAP0ao5Y%3D" alt="" loading="lazy"/></p>
<p>而 <strong>无状态（Stateless）</strong> 呢，就是服务器不记录客户端的任何信息，每次请求都是独立的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3d4460b3fb04a66ad52364eebc6bc11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=VAev4hLttPp0XlbVjyjiRcL2N24%3D" alt="" loading="lazy"/></p>
<p>你：哦哦哦，就像一个人去餐厅吃饭，服务员不记得他上次点了什么，每次都要重新点单，这就是无状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cc7cbc382934d2ba94d3205ae248ae7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=YFnwYowmsDmlSRJuu1d1x4CnQqc%3D" alt="" loading="lazy"/></p>
<p>反过来，服务员记得他爱吃鱼皮，这就是有状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a9fb4316b2342b7b3c4421faf6d3fa1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=tN3yFPneL7lZWoKD0430hSU%2BSR8%3D" alt="" loading="lazy"/></p>
<p>鱼皮：没错，接下来是 <strong>T（Transfer）</strong> 转移。</p>
<p>要注意，转移是 <strong>双向</strong> 的：</p>
<p>1）当你用 GET 请求时，服务器把资源的状态（比如用户信息的 JSON 数据）转移给客户端。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88c548241c874437aa54d411c4ab73cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=AhJgh8OCxAKyeOsEvxvRGxv%2B97w%3D" alt="" loading="lazy"/></p>
<p>2）当你用 POST/PUT 请求时，客户端把资源的新状态（比如新用户的信息）转移给服务器，从而改变服务器上资源的状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3eb14fb11841f4a239bb45158ab5f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=bMv7EqBWc6H6LCn%2Bj9B%2BCf7piqo%3D" alt="" loading="lazy"/></p>
<p>组合起来，<strong>REST（Representational State Transfer）</strong> 是一种 <strong>软件架构风格</strong>，让客户端和服务器通过统一的接口，以无状态的方式，互相传递资源的表现层数据（比如 JSON），来查询或者变更资源状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8c54a74a16341cd9b12d80a9b3facdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=83QAcf%2BybRIl99Hlmoqr3nltIgc%3D" alt="" loading="lazy"/></p>
<p>而 <strong>ful</strong> 是个后缀，就像 powerful（充满力量的）一样，表示 “充满...特性的”。</p>
<p>因此，<strong>RESTful API 是指符合 REST 架构风格的 API</strong>，也就是遵循 REST 原则设计出来的接口。</p>
<p>注意，它 <strong>不是协议、不是标准、不是强制规范</strong>，只是一种建议的设计风格。你可以遵循，也可以不遵循。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/447533a686004ee2a403269b8ba899a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=4CfCRX3G3WEIfiRj7tMw7d1NoXA%3D" alt="" loading="lazy"/></p>
<p>你挠了挠头：说了一大堆，RESTful API 到底长啥样啊？</p>
<p>鱼皮：举个例子，比如你要做个用户管理系统，对用户信息进行增删改查，用 RESTful 风格的 API 就长这样：</p>
<pre><code class="hljs language-bash" lang="bash">GET /users/123       获取 ID 为 123 的用户
POST /users         创建新用户
PUT /users/123       更新用户 123
DELETE /users/123   删除用户 123
</code></pre>
<p>你眼前一亮：哇，比我写的整齐多了！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4eb52b50142d4144b4eaf86ed7360ea8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=6CGLcb254qbUEjQs%2BuK%2F7mHUcsI%3D" alt="" loading="lazy"/></p>
<p>快带我学一下 RESTful 的写法吧，我要让前端阿花刮目相看！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e69125aee82c4f38b1d898032c66bf59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=%2F0c95sxHOwgcOPLoov%2F3B6c6dDk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">RESTful API 写法</h2>
<p>鱼皮：好，很有志气！接下来我会带你一步步构造一个完整的 RESTful API。分为两部分，<strong>客户端发送请求</strong> 和 <strong>服务端给出响应</strong>。</p>
<h3 data-id="heading-2">客户端请求</h3>
<h4 data-id="heading-3">第一步：确定资源</h4>
<p>资源用 URI（统一资源标识符）来表示。核心原则是：<strong>用名词来表示资源，不用动词</strong>。</p>
<p>具体来说，<strong>推荐用名词复数表示资源集合</strong>，比如 <code>/users</code> 表示用户列表、<code>/products</code> 表示商品列表。</p>
<p>如果要操作 <strong>具体某个资源，就加上 ID</strong>，比如 <code>/users/123</code> 表示 ID 为 123 的用户。</p>
<p>资源还 <strong>支持嵌套</strong>，比如 <code>/users/123/orders</code> 表示用户 123 的所有订单。</p>
<p>你想了想：那还可以更深层级么？比如 <code>/users/123/orders/456</code> 表示用户 123 的订单 456。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70c24953ec124d5e81aa9db5dd356e06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=2qoqLUQfwEa5mYNJBRz9RNR7%2FMA%3D" alt="" loading="lazy"/></p>
<p>鱼皮点点头：你的理解完全正确，但不建议嵌套层级太深。</p>
<h4 data-id="heading-4">第二步：选择动作</h4>
<p>确定了资源后，接下来要选择 <strong>动作</strong>，也就是你想怎么处理这个资源。</p>
<p>RESTful API 主要通过不同的 HTTP 方法来表示增删改查操作：</p>
<p>1）GET：查询资源</p>
<ul>
<li><code>GET /users</code> 查询所有用户</li>
<li><code>GET /users/123</code> 查询 ID 为 123 的用户</li>
</ul>
<p>2）POST：创建资源</p>
<ul>
<li><code>POST /users</code> 创建新用户</li>
</ul>
<p>3）PUT：完整更新资源，需要提供资源的所有字段，多次执行结果相同（幂等性）</p>
<ul>
<li><code>PUT /users/123</code> 完整更新用户 123</li>
</ul>
<p>4）PATCH：部分更新资源，通常用于更精细的操作</p>
<ul>
<li><code>PATCH /users/123</code> 只更新用户 123 的某些字段</li>
</ul>
<p>5）DELETE：删除资源</p>
<ul>
<li><code>DELETE /users/123</code> 删除用户 123</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d03da46f6074f6ba6ed008dff783469~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=SbT3xb3SdUq6BCL9uZRcK0LUy0o%3D" alt="" loading="lazy"/></p>
<p>鱼皮：到这里，一个基本的 RESTful API 请求就构造完成了。</p>
<p>你：就这么简单？我不满足，还有更高级的写法吗？</p>
<p>鱼皮：当然~</p>
<h4 data-id="heading-5">第三步：添加查询条件（可选）</h4>
<p>有时候我们需要更精确地筛选数据，这时候可以加查询参数，比如：</p>
<ul>
<li>分页：<code>/users?page=2&amp;limit=10</code> 查询第 2 页，每页 10 条用户数据</li>
<li>过滤：<code>/users?gender=male&amp;age=25</code> 查询性别为男、年龄 25 的用户</li>
<li>排序：<code>/users?sort=created_at&amp;order=desc</code> 按创建时间倒序排列用户</li>
</ul>
<p>你：等等，这查询参数跟 RESTful 有啥关系？正常的请求不都是这么写吗？</p>
<p>鱼皮：确实，查询参数本身不是 RESTful 特有的。但 RESTful 风格强调 <strong>把筛选、排序、分页这些操作，都通过 URL 参数来表达</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b381b9911e454a5ebe13d67a17592e71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=uXLsFpekVblSVwf%2F%2Fez41w519GM%3D" alt="" loading="lazy"/></p>
<p>而不是在请求体里传一堆复杂的 JSON 对象：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dabaf9c8a1c44c2cb12043c20eb9b1f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=3%2FnrEslW1ZHhF9MjFG%2FP8h1pnQw%3D" alt="" loading="lazy"/></p>
<p>这样一来，URL 更清晰，而且浏览器、CDN、代理服务器都能直接根据 URL 来缓存响应结果。比如 <code>/users?page=1</code> 和 <code>/users?page=2</code> 是两个不同的 URL，可以分别缓存。但如果把参数放在请求体里，URL 都是 <code>/users</code>，缓存就没法区分了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4a352ab720b4999b2f37c03ebf3625a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=C8l3HJh%2FPpKwcQ01ot1ctoCGy0c%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6">第四步：版本控制（可选）</h4>
<p>随着业务发展，接口可能需要升级。为了不影响老用户，可以在 URI 中标明版本：</p>
<ul>
<li><code>/v1/users</code> 第一版用户接口</li>
<li><code>/v2/users</code> 第二版用户接口</li>
</ul>
<p>这样，老用户继续用 v1，新用户用 v2，互不影响。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43c5bfc8807046ceacad19c58eac1478~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=XLwsm9hZEZO8DOa8q6YvcA4c%2BbU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">第五步：保持无状态</h4>
<p>此外，还记得我们前面讲 REST 里的 <strong>ST（State Transfer）</strong> 吗？</p>
<p>RESTful 的核心原则之一是 <strong>无状态（Stateless）</strong> ，客户端每次请求必须包含所有必要信息，服务器不记录客户端状态。</p>
<p>比如用户登录后，不是让服务器记住 “你已经登录了”，而是每次请求都要带上身份凭证（Token），像这样：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>orders
Header: <span class="hljs-keyword">Authorization</span>: Bearer xxx
</code></pre>
<p>这么做的好处是，服务器不用记录谁登录了、谁没登录，每个请求都是独立的。这样一来，你想加多少台服务器都行，任何一台都能处理请求，轻松实现负载均衡和横向扩展。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e20a52135d24453810ec8f0da1cca58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=5bh%2BRECfPn3udvDwVYS5cZFksZQ%3D" alt="" loading="lazy"/></p>
<p>你点头如捣蒜：怪不得我调用 AI 大模型 API 的时候，就要传这个 Token！</p>
<h3 data-id="heading-8">服务端响应</h3>
<p>鱼皮：讲完客户端请求，再来看服务器收到请求后，该怎么响应？</p>
<p>主要注意 2 点：</p>
<h4 data-id="heading-9">1、统一响应格式</h4>
<p>目前大多数 RESTful API 基本都用 <strong>JSON</strong> 格式，因为轻量、容易解析。</p>
<pre><code class="hljs language-perl" lang="perl">{
 <span class="hljs-string">"id"</span>: <span class="hljs-number">123</span>,
 <span class="hljs-string">"name"</span>: <span class="hljs-string">"小阿巴"</span>,
 <span class="hljs-string">"email"</span>: <span class="hljs-string">"aba@codefather.cn"</span>
}
</code></pre>
<p>但这并不是强制的，也可以用 XML、HTML 等格式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b7e50d2622c4ceca17bed65dda46b61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=PLFKo6L7XOjYXOTBFQzqwoCAPwk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">2、返回合适的 HTTP 状态码</h4>
<p>响应要带上合适的状态码，让客户端一眼看懂发生了什么。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6a61128e00042abb9dae4164934cd5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=Untwgg2ZxZy5kIGEaxSA0VJtiQQ%3D" alt="" loading="lazy"/></p>
<p>HTTP 状态码有很多，大体可以分为 5 类：</p>
<ul>
<li>
<p><strong>1xx 系列</strong>：信息提示（用得少，了解即可）</p>
</li>
<li>
<p><strong>2xx 系列</strong>：成功</p>
<ul>
<li>200 OK：请求成功，正常返回数据（用于 GET、PUT、PATCH）</li>
</ul>
</li>
<li>
<p><strong>3xx 系列</strong>：重定向</p>
<ul>
<li>301 Moved Permanently：资源永久移动到新位置</li>
<li>302 Found：资源临时移动</li>
</ul>
</li>
<li>
<p><strong>4xx 系列</strong>：客户端错误</p>
<ul>
<li>400 Bad Request：请求参数格式错误</li>
<li>401 Unauthorized：未验证身份，需要登录</li>
<li>403 Forbidden：已认证但没有权限访问</li>
<li>404 Not Found：资源不存在</li>
<li>405 Method Not Allowed：请求方法不被允许</li>
</ul>
</li>
<li>
<p><strong>5xx 系列</strong>：服务器错误</p>
<ul>
<li>500 Internal Server Error：服务器内部错误</li>
<li>502 Bad Gateway：网关错误</li>
<li>503 Service Unavailable：服务暂时不可用</li>
<li>504 Gateway Timeout：网关超时</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdd68d611a8c4829bd4582d9c5a06557~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=73QTt5%2BidsdF7w70AJhvWK2A2pY%3D" alt="" loading="lazy"/></p>
<p>你恍然大悟：懂了，以后前端看到 500，就知道是我后端的锅；看到 400，就知道是她自己传参传错了。谁也别想甩锅！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0f28ee490644aab9cdd5fa77973b6ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=FpXsGaU40IzFrSc8trw8fzed05A%3D" alt="" loading="lazy"/></p>
<p>鱼皮点点头：不错，以上这些，就是 RESTful API 的基本写法。你学会了吗？</p>
<p>你：学废了，学废了！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67e47a5b22f146edb6a7617619d32e2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=jmtC%2FuOuMqWH3LntbAeR2epi4OU%3D" alt="" loading="lazy"/></p>
<p>鱼皮：那我来考考你，下面哪个是标准的 RESTful API？</p>
<ul>
<li>A. <code>GET /getUsers</code></li>
<li>B. <code>GET /user/list</code></li>
<li>C. <code>POST /users/query</code></li>
<li>D. <code>GET /users/delete/123</code></li>
</ul>
<p>你开心地怪叫起来：阿巴，肯定是 C 啊！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f252eb1b88e548268d725309c3b120d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=GXv6Mb1u1BzYCtX%2FMvAdu5vZcbw%3D" alt="" loading="lazy"/></p>
<p>鱼皮：错，<strong>4 个全都不标准</strong>！</p>
<ul>
<li>A 用了动词 <code>getUsers</code></li>
<li>B 用了单数 <code>user</code> 和动词 <code>list</code></li>
<li>C 用 POST 查询，还带了动词 <code>query</code></li>
<li>D 用 GET 删除，还带了动词 <code>delete</code></li>
</ul>
<p>你掉了根头发：原来这么严格！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f51311e22d204492a5713d7c430ffe89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=e9aG0BS39oHtwovSD64QsC8SC2g%3D" alt="" loading="lazy"/></p>
<p>等等，你说 RESTful 不能用动词，但有些操作不是标准的增删改查啊，比如用户要支付订单，该怎么设计接口呢？是要用 <code>POST /orders/123/pay</code>？</p>
<p>鱼皮摇头：你已经很努力了，但 pay 是动词。更标准的设计是把 “支付” 行为看作 <strong>创建</strong> 一个支付记录，用名词而不是动词。</p>
<pre><code class="hljs language-bash" lang="bash">POST /orders/123/payments
</code></pre>
<p>比如这个请求，表示为订单 123 创建一笔支付记录。</p>
<p>你又掉了根头发：妙啊，怪不得说英语对学编程有帮助呢，我悟了，我悟了！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d58cd58e4bda4ad0ab69706d4bf734d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=Bp%2BdIjDF3u8RnJz7sliYzS6DwLI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">RESTful 的六大约束</h2>
<p>鱼皮：不错，学到这里你已经掌握了 RESTful 的 80%，能够实际应用了。接下来的知识，你只需简单了解一下，就能拿去和面试官吹牛皮了。</p>
<p>比如很多同学都不知道，RESTful 其实有 6 个约束条件：</p>
<ol start="0">
<li>Client-Server（客户端-服务器分离）：前后端各干各的活，前端负责展示，后端负责数据处理，互不干扰。</li>
<li>Stateless（无状态）：每次请求都是独立的，服务器不保存客户端的会话信息，所有必要信息都在请求中携带。</li>
<li>Cacheable（可缓存）：服务器的响应可以被标记为可缓存或不可缓存，客户端可以重用缓存数据，减少服务器压力，提升性能。</li>
<li>Layered System（分层系统）：客户端不需要知道直接连的是服务器还是中间层，系统可以灵活地加代理、网关、负载均衡器等。</li>
<li>Uniform Interface（统一接口）：所有资源都通过统一的接口访问，降低理解成本，提高可维护性。</li>
<li>Code-On-Demand（按需代码）：可选项，服务器可以返回可执行代码（比如 JavaScript）给客户端执行，但实际工作中很少用。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69d17ee3c17241eebfbf2b2c52103485~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=RuKSoV%2F7Aa17kUki146WWSTaF4Y%3D" alt="" loading="lazy"/></p>
<p>你直接听懵了：阿巴阿巴，这么多约束，我必须全遵守吗？</p>
<p>鱼皮：可以不用，RESTful 只是一种 API 的 <strong>建议风格</strong>。在实际工作中，很少有 API 能完美符合所有约束，大家可以灵活调整，甚至什么接口都用 <strong>POST + 动词</strong> 一把梭。只要团队达成一致、用得舒服就行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e09ad09b904480b9a6cc1423e79f4de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=jLDlr66CHUBBy4s9On81e9G1KrQ%3D" alt="" loading="lazy"/></p>
<p>就像刚才那个支付订单的例子，<code>POST /orders/123/payments</code> 虽然符合 RESTful 规范，但有同学会觉得 <code>POST /orders/123/pay</code> 更直观易懂，也没问题。</p>
<p>不过现阶段，我建议你先养成遵循 RESTful 的好习惯，等积累了经验，再根据实际情况灵活调整。</p>
<h3 data-id="heading-12">怎么快速实现 RESTful API？</h3>
<p>你：呜呜，但我只是个小阿巴，背不下来这些写法，我怕自己写着写着就不规范了，怎么办啊？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6abe0edc9364bf498f9dac4a8fc42b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=3xTfIIbNV8HIt%2B3tuD2QUU%2B9tDI%3D" alt="" loading="lazy"/></p>
<p>鱼皮：别担心，有很多方法可以帮你快速实现和检查 RESTful API。</p>
<h4 data-id="heading-13">1、使用开发框架</h4>
<p>几乎所有主流开发框架都支持 RESTful API 的开发，它们能帮你自动处理很多细节，比如：</p>
<ul>
<li>Java 的 Spring Boot：通过 <code>@GetMapping("/users")</code>、<code>@PostMapping("/users")</code> 等注解，你只需要写一行代码就能定义符合 RESTful 风格的路由。框架会自动把对象转成 JSON、设置正确的 HTTP 状态码，你都不用操心。</li>
<li>Python 的 Django REST Framework：你只需要定义一个数据模型（比如 User 类），框架就能自动生成 <code>GET /users</code>、<code>POST /users</code>、<code>PUT /users/123</code>、<code>DELETE /users/123</code> 这一整套 RESTful 接口，大幅减少代码量。</li>
<li>Go 的 Gin ：专门为 RESTful API 设计，语法非常简洁。比如 <code>router.GET("/users/:id", getUser)</code> 就能绑定一个 GET 请求，自动从 URL 中提取 ID 参数，还能通过路由分组把 <code>/api/v1/users</code> 和 <code>/api/v2/users</code> 轻松分开管理。</li>
</ul>
<p>这些框架虽然不强制你遵循 RESTful，但用它们的特性，开发起来既轻松又规范，帮你省掉大量重复代码。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b62a3ce438784a67b18fe8d97413dab0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=v3TiB5AG%2FSj1CgZf5F92OrI1Efg%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-14">2、使用 IDE 插件</h4>
<p>比如 IDEA 的 RESTful Toolkit 插件，可以快速查看和测试接口。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1af51a5408f64f9e921ddec822f78de8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=RrgHfDC9HDwX1yoJDrr6dhFdzkk%3D" alt="" loading="lazy"/></p>
<p>还有 VSCode 的 REST Client 插件，可以直接在编辑器里测试接口。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de577624a76f45449002cfddc64fbd24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=OT%2BxMw3SFF%2BKtQyQfsm8Epj0VK4%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-15">3、利用 AI 生成</h4>
<p>RESTful 有明确的设计规范，而 AI 最擅长处理这种有章可循的东西！</p>
<p>比如直接让 Cursor 帮你用 Spring Boot 写一个用户管理的 RESTful API：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c426af5486c34c85b289f81e47756007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=R9CzvMFv%2FBdtsTe4N8J78Y7eQLM%3D" alt="" loading="lazy"/></p>
<p>你只需要阿巴阿巴几下，它就能生成规范的代码。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76ba0909bc5449279575f60a42487cdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=%2FfMrU7xZnsBzfyoSY7QgEHoJXQo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-16">4、生成接口文档</h4>
<p>写完接口后，还可以用 Swagger 这类工具自动生成漂亮的接口文档，直接甩给前端，对方一看就懂，还能在线测试接口，省去大量沟通成本。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71352e1ea3ba46cc9b52bf7721d89dc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=vEJg3mLmhv0mQhj7ARhKlAklcls%3D" alt="" loading="lazy"/></p>
<p>你笑得像个孩子：这么一看，RESTful API 不仅让接口规范统一，还能提高开发效率，降低团队沟通成本，前后端都舒服！爽爽爽！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a98fe27c415147d4b8bcad3262a8070e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=gT9EtZkx3bJFWtZK%2FCkye9jtIMY%3D" alt="" loading="lazy"/></p>
<p>鱼皮点点头：没错，这也是为什么 RESTful 能成为业界主流的原因。</p>
<p>你：学会了学会了，我这就去重构所有接口，让前端阿花刮目相看！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/959b8802be244df5b7eb2eb6c27122be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=MdlCm%2B0Ij1TIBniqSwBkSoC5Y24%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-17">结尾</h3>
<p>一周后，你把所有接口重构成了 RESTful 风格。</p>
<p>前端阿花打开新的接口文档，眼睛亮了：小阿巴，你居然开窍了？！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34be819a81ae44989f8ed4d8c1d60f9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=77JVnw8rOKUVDvnkVONdRNQNFjk%3D" alt="" loading="lazy"/></p>
<p>你得意地笑了：那是，我可是学过 RESTful 的男人~ 阿花，晚上要不要一起？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef1780246f2d4adda2c117786232a45f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=xqPvKNdd%2Fwg3ukOOyml35wBUsW4%3D" alt="" loading="lazy"/></p>
<p>阿花朝你吐了口唾沫：呸，你只不过学了一种 API 风格就得意洋洋。阿坤哥哥不仅精通 RESTful，还能手撕 GraphQL 和 gRPC 呢，你行么？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03852fb77ac24100a107529b7e97034c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=1F6AzFKEVI%2FKRHSBp%2Fe5q1EY4lk%3D" alt="" loading="lazy"/></p>
<p>你难受得不行：啥啥啥，这都是啥啊…… 鱼皮 gie gie 快来救我！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b928eda1c715495a956988b42c919b30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349358&amp;x-signature=Le9Au012AhPofzRoL6rKnJ3JSmA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-18">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别传统低效！AgentRun 如何用 Serverless + Agent 打造现代化的舆情分析系统？]]></title>    <link>https://juejin.cn/post/7587998744294719494</link>    <guid>https://juejin.cn/post/7587998744294719494</guid>    <pubDate>2025-12-26T10:25:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587998744294719494" data-draft-id="7587998744294424582" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别传统低效！AgentRun 如何用 Serverless + Agent 打造现代化的舆情分析系统？"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-26T10:25:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别传统低效！AgentRun 如何用 Serverless + Agent 打造现代化的舆情分析系统？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:25:17.000Z" title="Fri Dec 26 2025 10:25:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：江昱</p>
<p>舆情分析是企业感知市场脉搏、预警公关危机的“听诊器”，然而传统的舆情分析系统更像是一个个“手工作坊”，面临数据收集效率低、分析深度不够、实时性差等问题，经常反馈之后，等企业拿到报告时，舆论热点早已转移，错过最佳时间。这些挑战，正是所有舆情系统开发者共同的痛点。</p>
<p>本方案将基于真实的代码实现，向您介绍如何使用函数计算 AgentRun 平台，构建一个现代化的“舆情分析专家”，<strong>该系统不仅实现了从数据采集到报告生成的可视化、全流程自动化，更通过流式架构，让洞察实时呈现。</strong></p>
<h2 data-id="heading-0">系统架构设计</h2>
<p>整个舆情分析系统采用分层架构设计，核心思想是通过代码严格控制流程执行顺序，而非依赖 LLM 的自主决策。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2b33e0db21440e8a5e7692c9e80eee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=e17egUD1fN2nxegUH1NiMJ9QW9o%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">快速体验和效果预览</h2>
<p>在深入技术细节前，我们先直观感受一下这套系统的效果。通过 AgentRun 平台，只需简单几步即可完成部署。</p>
<h3 data-id="heading-2">快速部署</h3>
<p>打开阿里云函数计算 AgentRun 探索页面：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8251150fb8fe44c3b0ce7b9bcca453af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=XigYs%2B%2FF2WIkqzNq7XkuS6etzWU%3D" alt="图片" loading="lazy"/></p>
<p>可以找到舆情分析专家案例，并点击卡片右下角进行部署，填写完整对应的参数信息即可点击右下角确定创建按钮：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e08339566414b16ae6d04f225f5403a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=h2f8rKDyFb4nUbxzwjurgt%2Ff8W4%3D" alt="图片" loading="lazy"/></p>
<p>此处需要稍等片刻，创建完之后可以看到体验地址，也可以跳转到运行时与沙箱看到部署完的 Agent：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37b6f6d2b3394d4d902053ffa8c127be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=qaaZpWZiU82BqewpWU8nd9M5rRw%3D" alt="图片" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f94cdee53e543a49247c8e2bf19ba3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=hKzteXD4wlEFD%2F1wXxPuCxp4i5E%3D" alt="图片" loading="lazy"/></p>
<p>首页地址即右侧 <code>main_web</code> 地址，直接查看线上效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04adff44127141059fa20f50a065734b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=xBW%2BaqF3Ff%2FS2qrqm%2BPughaIq64%3D" alt="图片" loading="lazy"/></p>
<p>也可以查看该应用案例代码，并进行在线二次开发：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aff65e6b0fbf472383cfea7e62dc41f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=Gjct%2BWU%2BX0GtLt0iKi38vEHqzrA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">效果体验</h3>
<p>打开体验地址，可以看到舆情分析专家页面，此时可以输入一个词进行舆情分析：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e85d5f4bb89e4cc49bc5fb2d8bd6c99b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=VqRXCcfCOQMNs6tRSPeG8ypMvZQ%3D" alt="图片" loading="lazy"/></p>
<p>分析过程中，系统会调用函数计算 AgentRun 的 Sandbox 沙箱（确切说是创建的时候，选择的浏览器沙箱），可以看到 AI 控制云上的浏览器进行数据检索：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da85bf3d6e474aeb83af3090b2cbb8e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=AtItZdsToxHhYgp9iLLbZ3I%2B8NA%3D" alt="图片" loading="lazy"/></p>
<p>完成之后，系统会整理所有采集到的数据和信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d657c650fbd4964b94801ac83e67c9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=nBd6IoDZ5%2Bm1yr1Vj8iViXjDiYQ%3D" alt="图片" loading="lazy"/></p>
<p>最终生成文字+图表的“可视化报告”：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41ee44786a594c39a7d3d9a1e6c0ae14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=4ud8UbB2u6GmL0VNgdL3oi%2FlHW8%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eb00b156cc44b8693697aa9034b5a81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=mgJR4KqfHaD9Hzd6NWL0K0Zm0ug%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">AgentRun 相比传统方案的核心优势</h2>
<h3 data-id="heading-5">安全隔离的执行环境</h3>
<p>传统舆情系统通常直接在服务器上运行爬虫程序，面临着安全风险和环境污染问题。当某个网站的反爬机制触发时，可能影响整个服务器的稳定性。而 AgentRun Sandbox 提供了完全隔离的浏览器环境，即使单个采集任务出现问题，也不会影响系统的整体运行。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_browser_sandbox</span>() -&gt; <span class="hljs-type">Optional</span>[BrowserSandbox]:
    <span class="hljs-string">"""创建隔离的浏览器环境，避免环境污染"""</span>
    <span class="hljs-keyword">try</span>:
        sandbox = <span class="hljs-keyword">await</span> Sandbox.create_async(
            template_type=TemplateType.BROWSER,
            template_name=agentrun_browser_sandbox_name,
        )
        _sandboxes[sandbox.sandbox_id] = sandbox
        <span class="hljs-keyword">return</span> sandbox
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># 单个Sandbox失败不影响其他实例</span>
        <span class="hljs-keyword">raise</span> SandboxCreationError(<span class="hljs-string">f"创建 Sandbox 失败: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h3 data-id="heading-6">真实浏览器环境模拟</h3>
<p>传统爬虫方案通常使用简单的 HTTP 请求库，容易被现代网站的反爬机制识别和拦截。AgentRun Sandbox 提供的是真实的 Chrome 浏览器环境，能够完整执行 JavaScript、处理复杂的页面交互，大大提高了数据采集的成功率。从代码中可以看到，系统通过 Playwright 连接到真实的 Chrome 实例：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> <span class="hljs-title">async_playwright</span>() <span class="hljs-keyword">as</span> playwright:
    browser</span> = <span class="hljs-keyword">await</span> playwright.chromium.connect_over_cdp(sandbox.get_cdp_url())
    context = browser.contexts[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> browser.contexts <span class="hljs-keyword">else</span> <span class="hljs-keyword">await</span> browser.new_context()
    page = context.pages[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> context.pages <span class="hljs-keyword">else</span> <span class="hljs-keyword">await</span> context.new_page()
</code></pre>
<h3 data-id="heading-7">可视化调试能力</h3>
<p>函数计算 AgentRun 最独特的优势是提供了实时的 VNC 预览功能，开发者和用户可以实时观察浏览器的操作过程。这种透明性在传统方案中是无法实现的，它不仅有助于调试和优化采集逻辑，还能让用户直观地了解系统的工作状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6f57bcd347d48788a3d988d39013957~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=vOQWwMQljnWyZPeKCmaGs0cfHUs%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-8">弹性扩展和故障恢复</h3>
<p>传统系统在面临大规模采集任务时，往往需要复杂的分布式架构设计。而函数计算 AgentRun 天然支持多 Sandbox 并行处理，系统可以根据需要动态创建和销毁浏览器实例。更重要的是，当某个实例出现故障时，系统能够自动检测并重建：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">recreate_sandbox_if_closed</span>(<span class="hljs-params">sandbox_id: <span class="hljs-built_in">str</span>, error_message: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""智能故障检测和自动重建机制"""</span>
    closed_error_patterns = [
        <span class="hljs-string">"Target page, context or browser has been closed"</span>,
        <span class="hljs-string">"Browser has been closed"</span>,
        <span class="hljs-string">"Connection closed"</span>,
    ]
    is_closed_error = <span class="hljs-built_in">any</span>(pattern.lower() <span class="hljs-keyword">in</span> error_message.lower() 
                         <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> closed_error_patterns)
    <span class="hljs-keyword">if</span> is_closed_error:
        <span class="hljs-keyword">await</span> remove_sandbox(sandbox_id)
        new_sandbox = <span class="hljs-keyword">await</span> create_browser_sandbox()
        <span class="hljs-keyword">return</span> new_sandbox
</code></pre>
<p>AgentRun Sandbox 采用阿里云函数计算实现，支持百万沙箱模板（函数级别）并发运行，Serverless 弹性伸缩，支持 3.5w+ 沙箱/分钟，支持缩容到 0，按请求感知调度。</p>
<h2 data-id="heading-9">后端核心实现</h2>
<h3 data-id="heading-10">Agent 工具链设计</h3>
<p>系统的核心是一个基于 PydanticAI 的智能体，该智能体包含四个关键工具，每个工具负责舆情分析的不同阶段。Agent 的设计遵循严格的执行顺序，确保数据收集的完整性和分析的准确性。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">opinion_agent</span> = Agent(
    agentrun_model,
    <span class="hljs-attr">deps_type</span>=StateDeps,
    <span class="hljs-attr">system_prompt</span>=<span class="hljs-string">"""你是舆情分析系统的执行者。
你的任务是按照以下严格流程执行舆情分析：
【流程】
1. 收到关键词后，调用 collect_data 工具收集数据
2. 数据收集完成后，调用 analyze_data 工具分析数据
3. 分析完成后，调用 write_report 工具撰写报告
4. 报告完成后，调用 render_html 工具生成 HTML
【重要规则】
- 必须按顺序调用工具
- 每个工具只调用一次
- 不要跳过任何步骤
- 不要编造数据
"""</span>,
    <span class="hljs-attr">retries</span>=<span class="hljs-number">3</span>,
)
</code></pre>
<h3 data-id="heading-11">流式输出与实时反馈</h3>
<p>传统舆情系统通常采用批处理模式，用户需要等待很长时间才能看到结果。而基于函数计算 AgentRun 的系统实现了真正的流式输出，用户可以实时观察每个处理步骤的进展。这种实时性不仅提升了用户体验，也便于及时发现和解决问题。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">push_state_event</span>(<span class="hljs-params">run_id: <span class="hljs-built_in">str</span>, state: OpinionState</span>):
    <span class="hljs-string">"""实时推送状态更新，用户无需等待"""</span>
    event = StateSnapshotEvent(
        <span class="hljs-built_in">type</span>=EventType.STATE_SNAPSHOT,
        snapshot=state.model_dump(),
        timestamp=<span class="hljs-built_in">int</span>(time.time() * <span class="hljs-number">1000</span>)
    )
    <span class="hljs-keyword">await</span> event_manager.push_event(run_id, event)
</code></pre>
<h3 data-id="heading-12">智能数据质量控制</h3>
<p>系统实现了严格的数据质量控制机制，通过多维度评估确保收集到的数据具有较高的相关性和价值。这种质量控制在传统系统中往往是缺失的，导致大量噪音数据影响分析结果。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_relevance</span>(<span class="hljs-params">keyword: <span class="hljs-built_in">str</span>, title: <span class="hljs-built_in">str</span>, snippet: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""多维度相关性评估，确保数据质量"""</span>
    text = <span class="hljs-string">f"<span class="hljs-subst">{title}</span> <span class="hljs-subst">{snippet}</span>"</span>
    text_lower = text.lower()
    <span class="hljs-comment"># 检测关键词匹配度</span>
    has_chinese_keyword = <span class="hljs-built_in">any</span>(<span class="hljs-string">'\u4e00'</span> &lt;= char &lt;= <span class="hljs-string">'鿿'</span> <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> keyword)
    result_has_chinese = <span class="hljs-built_in">any</span>(<span class="hljs-string">'\u4e00'</span> &lt;= char &lt;= <span class="hljs-string">'鿿'</span> <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> text)
    <span class="hljs-comment"># 中文关键词必须在结果中有中文内容</span>
    <span class="hljs-keyword">if</span> has_chinese_keyword <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> result_has_chinese:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
    <span class="hljs-comment"># 排除明显的无关网站</span>
    irrelevant_patterns = [
        <span class="hljs-string">"calculator"</span>, <span class="hljs-string">"deepseek"</span>, <span class="hljs-string">"chegg"</span>, <span class="hljs-string">"stackoverflow"</span>, 
        <span class="hljs-string">"翻译"</span>, <span class="hljs-string">"dictionary"</span>, <span class="hljs-string">"词典"</span>
    ]
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(pattern <span class="hljs-keyword">in</span> text_lower <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> irrelevant_patterns):
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
    <span class="hljs-comment"># 计算相关性得分</span>
    score = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">if</span> keyword <span class="hljs-keyword">in</span> text:
        score += <span class="hljs-number">0.6</span>  <span class="hljs-comment"># 基础分</span>
    <span class="hljs-comment"># 时效性加分</span>
    time_keywords = [<span class="hljs-string">"最新"</span>, <span class="hljs-string">"今日"</span>, <span class="hljs-string">"近日"</span>, <span class="hljs-string">"2024"</span>, <span class="hljs-string">"2025"</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(tk <span class="hljs-keyword">in</span> text <span class="hljs-keyword">for</span> tk <span class="hljs-keyword">in</span> time_keywords):
        score += <span class="hljs-number">0.1</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(<span class="hljs-number">0.0</span>, <span class="hljs-built_in">min</span>(<span class="hljs-number">1.0</span>, score))
</code></pre>
<h2 data-id="heading-13">深度内容抓取技术</h2>
<h3 data-id="heading-14">平台适配策略</h3>
<p>不同的社交媒体平台具有不同的页面结构和内容组织方式，传统系统往往采用统一的抓取策略，导致数据质量参差不齐。AgentRun 系统针对不同平台实现了定制化的抓取逻辑：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">explore_page_with_llm</span>(<span class="hljs-params">page, keyword: <span class="hljs-built_in">str</span>, url: <span class="hljs-built_in">str</span>, source: <span class="hljs-built_in">str</span>, initial_content: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""基于平台特性的智能内容抓取"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"weibo.com"</span> <span class="hljs-keyword">in</span> url:
        <span class="hljs-comment"># 微博特定的评论和转发抓取</span>
        available_actions = [
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_comments"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".WB_feed_expand, [class*='comment']"</span>},
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_retweets"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".WB_feed_expand, [class*='repost']"</span>},
        ]
    <span class="hljs-keyword">elif</span> <span class="hljs-string">"zhihu.com"</span> <span class="hljs-keyword">in</span> url:
        <span class="hljs-comment"># 知乎回答和评论抓取</span>
        available_actions = [
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_more_answers"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".AnswerItem, .List-item"</span>},
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_comments"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".Comments-container, .CommentItem"</span>},
        ]
    <span class="hljs-keyword">elif</span> <span class="hljs-string">"bilibili.com"</span> <span class="hljs-keyword">in</span> url:
        <span class="hljs-comment"># B站视频评论抓取</span>
        available_actions = [
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_comments"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".reply-item, .root-reply"</span>},
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_related"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".video-page-card, .recommend-list"</span>},
        ]
</code></pre>
<h3 data-id="heading-15">LLM 驱动的智能探索</h3>
<p>系统创新性地引入了 LLM 驱动的智能探索机制，让 AI 决定是否需要深入抓取某个页面的额外内容，如评论区、相关推荐等。这种智能决策大大提高了数据采集的效率和针对性。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">llm_decide_exploration</span>(<span class="hljs-params">keyword: <span class="hljs-built_in">str</span>, page_url: <span class="hljs-built_in">str</span>, page_content: <span class="hljs-built_in">str</span>, source: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""LLM 智能决策是否进行深度探索"""</span>
    prompt = <span class="hljs-string">f"""请根据以下信息决定是否需要进一步探索页面获取更多舆情数据。
【搜索关键词】<span class="hljs-subst">{keyword}</span>
【当前页面】<span class="hljs-subst">{page_url}</span>
【已获取内容预览】<span class="hljs-subst">{page_content[:<span class="hljs-number">500</span>]}</span>
【决策标准】
1. 如果当前内容已经足够丰富，可能不需要进一步探索
2. 如果是微博/B站等平台，评论区通常包含重要的舆情信息
3. 权衡时间成本，每个页面最多探索1-2个操作
请返回 JSON 格式的决策结果。
"""</span>
    result = <span class="hljs-keyword">await</span> explorer.run(prompt)
    <span class="hljs-keyword">return</span> json.loads(result.output)
</code></pre>
<h2 data-id="heading-16">前端 VNC 集成实现</h2>
<h3 data-id="heading-17">动态库加载机制</h3>
<p>前端 VNC 客户端需要动态加载 noVNC 库，系统实现了智能的加载机制，支持本地资源和 CDN 回退：</p>
<pre><code class="hljs language-ini" lang="ini">function loadScript(url) {
    return new Promise(function(resolve, reject) {
        var <span class="hljs-attr">script</span> = document.createElement(<span class="hljs-string">'script'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">script.src</span> = baseUrl + url<span class="hljs-comment">;</span>
        <span class="hljs-attr">script.onload</span> = resolve<span class="hljs-comment">;</span>
        <span class="hljs-attr">script.onerror</span> = function() {
            // 本地加载失败，尝试 CDN
            var <span class="hljs-attr">fallbackUrl</span> = url.includes(<span class="hljs-string">'wordcloud'</span>) 
                ? 'https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js'
                : 'https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js'<span class="hljs-comment">;</span>
            var <span class="hljs-attr">fallbackScript</span> = document.createElement(<span class="hljs-string">'script'</span>)<span class="hljs-comment">;</span>
            <span class="hljs-attr">fallbackScript.src</span> = fallbackUrl<span class="hljs-comment">;</span>
            <span class="hljs-attr">fallbackScript.onload</span> = resolve<span class="hljs-comment">;</span>
            <span class="hljs-attr">fallbackScript.onerror</span> = reject<span class="hljs-comment">;</span>
            document.head.appendChild(fallbackScript)<span class="hljs-comment">;</span>
        }<span class="hljs-comment">;</span>
        document.head.appendChild(script)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-18">多协议适配</h3>
<p>考虑到部署环境的复杂性，VNC 组件实现了 HTTP/HTTPS 环境下的 WebSocket 协议自适应：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">const</span> adjustWebSocketUrl = useCallback((url: string): string =&gt; {
    <span class="hljs-keyword">const</span> isHttps = window.location.protocol === <span class="hljs-string">'https:'</span>;
    <span class="hljs-keyword">if</span> (!isHttps &amp;&amp; url.startsWith(<span class="hljs-string">'wss://'</span>)) {
        <span class="hljs-keyword">return</span> url.replace(<span class="hljs-string">'wss://'</span>, <span class="hljs-string">'ws://'</span>);
    }
    <span class="hljs-keyword">if</span> (isHttps &amp;&amp; url.startsWith(<span class="hljs-string">'ws://'</span>)) {
        <span class="hljs-keyword">return</span> url.replace(<span class="hljs-string">'ws://'</span>, <span class="hljs-string">'wss://'</span>);
    }
    <span class="hljs-keyword">return</span> url;
}, []);
</code></pre>
<h2 data-id="heading-19">智能分析与报告生成</h2>
<h3 data-id="heading-20">标准化情感分析</h3>
<p>系统实现了基于关键词词典的情感分析算法，相比传统的机器学习模型，这种方法更加透明和可控：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SentimentStandards</span>:
    <span class="hljs-string">"""情感倾向标准化计算"""</span>
    POSITIVE_KEYWORDS = [
        <span class="hljs-string">"优秀"</span>, <span class="hljs-string">"卓越"</span>, <span class="hljs-string">"创新"</span>, <span class="hljs-string">"领先"</span>, <span class="hljs-string">"突破"</span>, <span class="hljs-string">"成功"</span>, <span class="hljs-string">"赞"</span>, <span class="hljs-string">"好评"</span>, <span class="hljs-string">"支持"</span>,
        <span class="hljs-string">"认可"</span>, <span class="hljs-string">"满意"</span>, <span class="hljs-string">"信赖"</span>, <span class="hljs-string">"期待"</span>, <span class="hljs-string">"看好"</span>, <span class="hljs-string">"值得"</span>, <span class="hljs-string">"推荐"</span>, <span class="hljs-string">"喜欢"</span>
    ]
    NEGATIVE_KEYWORDS = [
        <span class="hljs-string">"差"</span>, <span class="hljs-string">"糟糕"</span>, <span class="hljs-string">"失败"</span>, <span class="hljs-string">"落后"</span>, <span class="hljs-string">"问题"</span>, <span class="hljs-string">"缺陷"</span>, <span class="hljs-string">"批评"</span>, <span class="hljs-string">"质疑"</span>, <span class="hljs-string">"担忧"</span>,
        <span class="hljs-string">"失望"</span>, <span class="hljs-string">"不满"</span>, <span class="hljs-string">"抱怨"</span>, <span class="hljs-string">"投诉"</span>, <span class="hljs-string">"差评"</span>, <span class="hljs-string">"垃圾"</span>, <span class="hljs-string">"骗局"</span>
    ]
    @<span class="hljs-built_in">staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_sentiment_score</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">"""计算情感得分 (-1.0 到 1.0)"""</span>
        positive_count = <span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> SentimentStandards.POSITIVE_KEYWORDS <span class="hljs-keyword">if</span> word <span class="hljs-keyword">in</span> text)
        negative_count = <span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> SentimentStandards.NEGATIVE_KEYWORDS <span class="hljs-keyword">if</span> word <span class="hljs-keyword">in</span> text)
        total_count = positive_count + negative_count
        <span class="hljs-keyword">if</span> total_count == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
        <span class="hljs-keyword">return</span> (positive_count - negative_count) / total_count
</code></pre>
<h3 data-id="heading-21">流式报告生成</h3>
<p>报告生成过程采用流式输出，用户可以实时观察报告的撰写过程，这种体验是传统系统无法提供的：</p>
<pre><code class="hljs language-ini" lang="ini">async with writer.run_stream(report_prompt) as result:
    async for text in result.stream_text():
        <span class="hljs-attr">report_content</span> = text
        <span class="hljs-attr">state.report_text</span> = report_content
        <span class="hljs-attr">current_time</span> = asyncio.get_event_loop().time()
        <span class="hljs-attr">content_delta</span> = len(report_content) - last_event_length
        <span class="hljs-attr">time_delta</span> = current_time - last_event_time
        <span class="hljs-comment"># 每 100 字符或每 0.3 秒发送一次更新</span>
        if content_delta &gt;= 100 or time_delta &gt;= 0.3:
            await push_state_event(run_id, state)
</code></pre>
<h2 data-id="heading-22">部署与运维优势</h2>
<h3 data-id="heading-23">简化的部署流程</h3>
<p>相比传统舆情系统需要复杂的分布式爬虫集群部署，AgentRun 系统的部署相对简单。只需要配置好环境变量和 AgentRun Sandbox 模板，系统就能自动管理浏览器实例的创建和销毁：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 核心配置</span>
<span class="hljs-attr">AGENTRUN_MODEL_NAME</span>=your_model_name
<span class="hljs-attr">MODEL_NAME</span>=qwen3-max
<span class="hljs-attr">AGENTRUN_BROWSER_SANDBOX_NAME</span>=your_browser_template
<span class="hljs-attr">TIMEOUT</span>=<span class="hljs-number">180</span>
</code></pre>
<h3 data-id="heading-24">自动化运维能力</h3>
<p>系统内置了完善的监控和自恢复机制，大大降低了运维复杂度。当检测到异常时，系统能够自动重建资源，保证服务的连续性：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 连接失败时自动重连（每 10 秒尝试一次）</span>
useEffect(() =&gt; {
    if (<span class="hljs-attr">status</span> === <span class="hljs-string">'error'</span> &amp;&amp; active &amp;&amp; rfbLoaded) {
        <span class="hljs-attr">reconnectTimerRef.current</span> = setTimeout(() =&gt; {
            cleanupRfb()<span class="hljs-comment">;</span>
            <span class="hljs-attr">lastUrlRef.current</span> = null<span class="hljs-comment">;</span>
            fetchVncUrl(true)<span class="hljs-comment">;</span>
        }, RECONNECT_INTERVAL)<span class="hljs-comment">;</span>
    }
}, <span class="hljs-section">[status, active, rfbLoaded]</span>)<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-25">性能与扩展性分析</h2>
<h3 data-id="heading-26">并发处理能力</h3>
<p>传统系统的并发能力往往受限于单机资源，而函数计算 AgentRun 系统可以根据需要动态创建多个 Sandbox 实例，实现真正的水平扩展。系统通过异步编程模型和连接池管理，能够高效处理大量并发请求：</p>
<pre><code class="hljs language-ini" lang="ini">uvicorn.run(
    "main:app",
    <span class="hljs-attr">host</span>=<span class="hljs-string">"0.0.0.0"</span>,
    <span class="hljs-attr">port</span>=<span class="hljs-number">8000</span>,
    <span class="hljs-attr">log_level</span>=<span class="hljs-string">"info"</span>,
    <span class="hljs-attr">timeout_keep_alive</span>=<span class="hljs-number">120</span>,
    <span class="hljs-attr">limit_concurrency</span>=<span class="hljs-number">100</span>,  <span class="hljs-comment"># 支持高并发</span>
)
</code></pre>
<h3 data-id="heading-27">资源弹性管理</h3>
<p>系统实现了智能的资源管理策略，能够根据任务负载动态调整 Sandbox 实例数量。这种弹性扩展能力是传统固定架构难以实现的：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_all_sandboxes</span>() -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
    <span class="hljs-string">"""动态获取所有可用的Sandbox实例"""</span>
    result = []
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> _sandbox_lock:
        <span class="hljs-keyword">for</span> sandbox_id, sandbox <span class="hljs-keyword">in</span> _sandboxes.items():
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># 检查实例健康状态</span>
                vnc_url = sandbox.get_vnc_url()
                result.append({
                    <span class="hljs-string">"sandbox_id"</span>: sandbox_id,
                    <span class="hljs-string">"vnc_url"</span>: vnc_url,
                    <span class="hljs-string">"active"</span>: <span class="hljs-literal">True</span>,
                })
            <span class="hljs-keyword">except</span> Exception:
                <span class="hljs-comment"># 自动清理失效实例</span>
                result.append({
                    <span class="hljs-string">"sandbox_id"</span>: sandbox_id,
                    <span class="hljs-string">"active"</span>: <span class="hljs-literal">False</span>,
                })
    <span class="hljs-keyword">return</span> result
</code></pre>
<h2 data-id="heading-28">总结</h2>
<p>基于函数计算 AgentRun 构建的舆情分析系统展现了现代 AI 技术在实际业务场景中的强大应用潜力。相比传统方案，函数计算 AgentRun 系统在安全性、可靠性、可观测性和扩展性方面都具有显著优势。</p>
<p>通过隔离的浏览器环境，系统解决了传统爬虫面临的安全风险和环境污染问题。实时的 VNC 预览功能提供了前所未有的透明度，让开发者和用户能够直观地观察系统工作状态。智能的故障检测和自恢复机制大大降低了运维复杂度，而流式输出设计则显著提升了用户体验。</p>
<p>更重要的是，函数计算 AgentRun 系统将复杂的舆情分析任务完全自动化，从多平台数据采集、深度内容抓取、智能情感分析到专业报告生成，整个流程无需人工干预。这种端到端的自动化能力，结合 AI 技术的持续进步，将为企业和机构的舆情分析工作带来革命性的改变。</p>
<p>欢迎加入“函数计算 AgentRun 客户群”与我们交流，钉钉群号：134570017218。</p>
<p><strong>快速了解函数计算 AgentRun：</strong></p>
<p><strong>一句话介绍：</strong> 函数计算 AgentRun 是一个以高代码为核心的一站式 Agentic AI 基础设施平台。秉持生态开放和灵活组装的理念，为企业级 Agent 应用提供从开发、部署到运维的全生命周期管理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7333e7a6ace849a3a84cd2cef2836b4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=PGzjK9qak75XL0U0Ax7gSsa1tBw%3D" alt="图片" loading="lazy"/></p>
<p><em>函数计算 AgentRun 架构图</em></p>
<p>AgentRun 运行时基于阿里云函数计算 FC 构建，继承了 Serverless 计算极致弹性、按量付费、零运维的核心优势。通过深度集成 AgentScope、Langchain、RAGFlow、Mem0 等主流开源生态。AgentRun 将 Serverless 的极致弹性、零运维和按量付费的特性与 AI 原生应用场景深度融合，助力企业实现成本与效率的极致优化，平均 TCO 降低 60%。 </p>
<p>让开发者只需专注于 Agent 的业务逻辑创新，无需关心底层基础设施，让 Agentic AI 真正进入企业生产环境。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么"数据压缩"能减小文件大小？——从冗余数据到高效编码]]></title>    <link>https://juejin.cn/post/7587776610436300815</link>    <guid>https://juejin.cn/post/7587776610436300815</guid>    <pubDate>2025-12-26T10:26:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587776610436300815" data-draft-id="7587740546955083816" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么&quot;数据压缩&quot;能减小文件大小？——从冗余数据到高效编码"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T10:26:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么"数据压缩"能减小文件大小？——从冗余数据到高效编码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:26:56.000Z" title="Fri Dec 26 2025 10:26:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📦 为什么"数据压缩"能减小文件大小？——从冗余数据到高效编码 🔍</h2>
<blockquote>
<p>大家好，我是无限大，欢迎收看十万个为什么系列文章</p>
<p>希望今天的内容能对大家有所帮助</p>
</blockquote>
<p>今天咱们来聊聊数据压缩这个"数据世界的瘦身术"！想象一下，你下载一部电影需要100GB；你发一张照片需要5分钟；你的手机存储空间总是不够用——这些糟心的体验，都是因为数据没有被压缩！而数据压缩，就是要解决这些问题！</p>
<h3 data-id="heading-1">🤔 核心问题：数据压缩的原理是什么？无损压缩和有损压缩有什么区别？</h3>
<p>很多人觉得数据压缩是"神奇的魔法"，其实数据压缩的原理很简单！数据压缩就像"给数据减肥"，通过去除冗余信息，让数据变得更苗条，同时尽可能保留有用信息。</p>
<h4 data-id="heading-2">数据压缩的本质</h4>
<p>数据压缩是一种<strong>数据编码技术</strong>，通过减少数据中的冗余信息，用更少的比特数表示相同的数据。它就像"把厚厚的字典浓缩成成语词典"，用更简洁的方式表达相同的意思。</p>
<h4 data-id="heading-3">为什么需要数据压缩？</h4>
<ul>
<li>⚡ <strong>节省传输时间</strong>：压缩后的数据传输更快，下载电影不用等半天</li>
<li>💾 <strong>节省存储空间</strong>：压缩后的数据占用更少空间，手机能存更多照片和视频</li>
<li>💰 <strong>降低成本</strong>：减少存储和带宽开销，企业能节省大量成本</li>
<li>📱 <strong>提高设备性能</strong>：小文件加载更快，设备运行更流畅</li>
</ul>
<h3 data-id="heading-4">📜 数据压缩的"进化史"：从Huffman编码到现代压缩格式</h3>
<h4 data-id="heading-5">1. 🔤 Huffman编码："压缩的先驱"（1952年）</h4>
<p>1952年，大卫·霍夫曼（David Huffman）发明了Huffman编码，这是一种基于字符频率的无损压缩算法。它给出现频率高的字符分配短编码，出现频率低的字符分配长编码，从而减少总比特数。</p>
<p>这就像"用短单词表示常用词"，比如用"OK"代替"Okay"，用"BTW"代替"By the way"，既简洁又不丢失信息。</p>
<h4 data-id="heading-6">2. 📊 LZW编码："GIF的秘密武器"（1977年）</h4>
<p>1977年，Lempel-Ziv-Welch（LZW）编码诞生。它是一种字典编码算法，通过建立动态字典来压缩重复出现的字符串。</p>
<p>这就像"用编号代替重复的句子"，比如把"我爱编程，编程使我快乐，快乐学习编程"压缩成"我爱[1]，[1]使我[2]，[2]学习[1]"，其中[1]=编程，[2]=快乐。</p>
<h4 data-id="heading-7">3. 🖼️ JPEG："照片压缩之王"（1992年）</h4>
<p>1992年，JPEG（Joint Photographic Experts Group）标准发布，这是一种有损压缩格式，专门用于压缩照片。它利用人眼的视觉特性，去除人眼不敏感的信息。</p>
<p>这就像"给照片做美颜"，去掉一些细节，但人眼几乎看不出来，却能把照片大小缩小到原来的10-20%。</p>
<h4 data-id="heading-8">4. 🎵 MP3："音乐压缩革命"（1993年）</h4>
<p>1993年，MP3（MPEG-1 Audio Layer 3）标准发布，这是一种有损压缩格式，专门用于压缩音乐。它利用人耳的听觉特性，去除人耳听不到的频率。</p>
<p>这就像"给音乐做减法"，去掉一些人耳听不到的声音，却能把音乐文件大小缩小到原来的10%左右。</p>
<h4 data-id="heading-9">5. 📦 ZIP："万能压缩工具"（1989年）</h4>
<p>1989年，ZIP格式诞生，它是一种容器格式，可以使用多种压缩算法（如Deflate）。ZIP支持无损压缩和分卷压缩，是最常用的文件压缩格式之一。</p>
<p>这就像"万能收纳箱"，可以装各种类型的文件，不管是文档、照片还是视频，都能压缩成一个ZIP文件。</p>
<h3 data-id="heading-10">🔧 技术原理：数据压缩的核心技术</h3>
<h4 data-id="heading-11">1. 🔍 冗余数据识别："找到可以减肥的地方"</h4>
<p>数据中存在大量冗余信息，主要有以下几种类型：</p>
<ul>
<li>📝 <strong>重复冗余</strong>：相同的字符或字符串重复出现，比如"aaaaa"可以压缩成"5a"</li>
<li>🎨 <strong>空间冗余</strong>：图像中相邻像素的颜色相似，比如蓝色的天空</li>
<li>🔊 <strong>时间冗余</strong>：视频中相邻帧的内容相似，比如静态背景</li>
<li>👁️ <strong>视觉冗余</strong>：人眼对某些颜色和细节不敏感</li>
<li>👂 <strong>听觉冗余</strong>：人耳对某些频率不敏感</li>
</ul>
<h4 data-id="heading-12">2. 📐 无损压缩："减肥不减质"</h4>
<p>无损压缩是指<strong>压缩后可以完全恢复原始数据</strong>，没有任何信息丢失。它主要用于文本、程序、重要文档等不能容忍信息丢失的场景。</p>
<p><strong>常见的无损压缩算法和格式</strong>：</p>
<ul>
<li>Huffman编码：用于ZIP、GZIP等</li>
<li>LZW编码：用于GIF、TIFF等</li>
<li>Deflate：用于ZIP、PNG、PDF等</li>
<li>RLE（行程长度编码）：用于BMP、PCX等</li>
</ul>
<h4 data-id="heading-13">3. 🎨 有损压缩："减肥可以减点质"</h4>
<p>有损压缩是指<strong>压缩后无法完全恢复原始数据</strong>，会丢失一些信息。它主要用于照片、音乐、视频等可以容忍少量信息丢失的场景。</p>
<p><strong>常见的有损压缩算法和格式</strong>：</p>
<ul>
<li>JPEG：用于照片</li>
<li>MP3、AAC：用于音乐</li>
<li>MPEG-4、H.264、H.265：用于视频</li>
<li>WebP、AVIF：新一代图像压缩格式</li>
</ul>
<p><strong>代码实例</strong>：用Python实现简单的Huffman编码（无损压缩）</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> heapq
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HuffmanNode</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, char, freq</span>):
        self.char = char
        self.freq = freq
        self.left = <span class="hljs-literal">None</span>
        self.right = <span class="hljs-literal">None</span>
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__lt__</span>(<span class="hljs-params">self, other</span>):
        <span class="hljs-keyword">return</span> self.freq &lt; other.freq

<span class="hljs-keyword">def</span> <span class="hljs-title function_">build_frequency_dict</span>(<span class="hljs-params">text</span>):
    <span class="hljs-string">"""构建字符频率字典"""</span>
    freq = defaultdict(<span class="hljs-built_in">int</span>)
    <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> text:
        freq[char] += <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> freq

<span class="hljs-keyword">def</span> <span class="hljs-title function_">build_huffman_tree</span>(<span class="hljs-params">freq_dict</span>):
    <span class="hljs-string">"""构建Huffman树"""</span>
    priority_queue = []
    <span class="hljs-keyword">for</span> char, freq <span class="hljs-keyword">in</span> freq_dict.items():
        heapq.heappush(priority_queue, HuffmanNode(char, freq))
  
    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(priority_queue) &gt; <span class="hljs-number">1</span>:
        left = heapq.heappop(priority_queue)
        right = heapq.heappop(priority_queue)
      
        merged = HuffmanNode(<span class="hljs-literal">None</span>, left.freq + right.freq)
        merged.left = left
        merged.right = right
      
        heapq.heappush(priority_queue, merged)
  
    <span class="hljs-keyword">return</span> priority_queue[<span class="hljs-number">0</span>]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">build_huffman_codes</span>(<span class="hljs-params">root</span>):
    <span class="hljs-string">"""构建Huffman编码表"""</span>
    codes = {}
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_build_codes</span>(<span class="hljs-params">node, current_code</span>):
        <span class="hljs-keyword">if</span> node <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span>
      
        <span class="hljs-keyword">if</span> node.char <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            codes[node.char] = current_code
            <span class="hljs-keyword">return</span>
      
        _build_codes(node.left, current_code + <span class="hljs-string">"0"</span>)
        _build_codes(node.right, current_code + <span class="hljs-string">"1"</span>)
  
    _build_codes(root, <span class="hljs-string">""</span>)
    <span class="hljs-keyword">return</span> codes

<span class="hljs-keyword">def</span> <span class="hljs-title function_">compress_text</span>(<span class="hljs-params">text, codes</span>):
    <span class="hljs-string">"""压缩文本"""</span>
    compressed = <span class="hljs-string">""</span>
    <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> text:
        compressed += codes[char]
    <span class="hljs-keyword">return</span> compressed

<span class="hljs-keyword">def</span> <span class="hljs-title function_">decompress_text</span>(<span class="hljs-params">compressed, root</span>):
    <span class="hljs-string">"""解压文本"""</span>
    decompressed = <span class="hljs-string">""</span>
    current_node = root
  
    <span class="hljs-keyword">for</span> bit <span class="hljs-keyword">in</span> compressed:
        <span class="hljs-keyword">if</span> bit == <span class="hljs-string">"0"</span>:
            current_node = current_node.left
        <span class="hljs-keyword">else</span>:
            current_node = current_node.right
      
        <span class="hljs-keyword">if</span> current_node.char <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            decompressed += current_node.char
            current_node = root
  
    <span class="hljs-keyword">return</span> decompressed

<span class="hljs-comment"># 测试代码</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    text = <span class="hljs-string">"hello world! hello huffman coding!"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"原始文本：<span class="hljs-subst">{text}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"原始长度：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(text) * <span class="hljs-number">8</span>}</span> 比特"</span>)
  
    <span class="hljs-comment"># 构建频率字典</span>
    freq_dict = build_frequency_dict(text)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"字符频率：<span class="hljs-subst">{<span class="hljs-built_in">dict</span>(freq_dict)}</span>"</span>)
  
    <span class="hljs-comment"># 构建Huffman树</span>
    root = build_huffman_tree(freq_dict)
  
    <span class="hljs-comment"># 构建编码表</span>
    codes = build_huffman_codes(root)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Huffman编码：<span class="hljs-subst">{codes}</span>"</span>)
  
    <span class="hljs-comment"># 压缩文本</span>
    compressed = compress_text(text, codes)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"压缩后：<span class="hljs-subst">{compressed}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"压缩后长度：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(compressed)}</span> 比特"</span>)
  
    <span class="hljs-comment"># 计算压缩比</span>
    compression_ratio = (<span class="hljs-built_in">len</span>(text) * <span class="hljs-number">8</span>) / <span class="hljs-built_in">len</span>(compressed)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"压缩比：<span class="hljs-subst">{compression_ratio:<span class="hljs-number">.2</span>f}</span>:1"</span>)
  
    <span class="hljs-comment"># 解压文本</span>
    decompressed = decompress_text(compressed, root)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"解压后：<span class="hljs-subst">{decompressed}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"解压是否成功：<span class="hljs-subst">{text == decompressed}</span>"</span>)
</code></pre>
<p><strong>运行结果</strong>：</p>
<pre><code class="hljs language-python" lang="python">原始文本：hello world! hello huffman coding!
原始长度：<span class="hljs-number">272</span> 比特
字符频率：{<span class="hljs-string">'h'</span>: <span class="hljs-number">3</span>, <span class="hljs-string">'e'</span>: <span class="hljs-number">2</span>, <span class="hljs-string">'l'</span>: <span class="hljs-number">5</span>, <span class="hljs-string">'o'</span>: <span class="hljs-number">3</span>, <span class="hljs-string">' '</span>: <span class="hljs-number">4</span>, <span class="hljs-string">'w'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'r'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'d'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'!'</span>: <span class="hljs-number">2</span>, <span class="hljs-string">'u'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'f'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'m'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'a'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'n'</span>: <span class="hljs-number">2</span>, <span class="hljs-string">'c'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'i'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'g'</span>: <span class="hljs-number">1</span>}
Huffman编码：{<span class="hljs-string">'l'</span>: <span class="hljs-string">'00'</span>, <span class="hljs-string">' '</span>: <span class="hljs-string">'01'</span>, <span class="hljs-string">'h'</span>: <span class="hljs-string">'100'</span>, <span class="hljs-string">'o'</span>: <span class="hljs-string">'101'</span>, <span class="hljs-string">'e'</span>: <span class="hljs-string">'1100'</span>, <span class="hljs-string">'!'</span>: <span class="hljs-string">'1101'</span>, <span class="hljs-string">'n'</span>: <span class="hljs-string">'1110'</span>, <span class="hljs-string">'w'</span>: <span class="hljs-string">'1111000'</span>, <span class="hljs-string">'r'</span>: <span class="hljs-string">'1111001'</span>, <span class="hljs-string">'d'</span>: <span class="hljs-string">'1111010'</span>, <span class="hljs-string">'u'</span>: <span class="hljs-string">'1111011'</span>, <span class="hljs-string">'f'</span>: <span class="hljs-string">'1111100'</span>, <span class="hljs-string">'m'</span>: <span class="hljs-string">'1111101'</span>, <span class="hljs-string">'a'</span>: <span class="hljs-string">'1111110'</span>, <span class="hljs-string">'c'</span>: <span class="hljs-string">'11111110'</span>, <span class="hljs-string">'i'</span>: <span class="hljs-string">'111111110'</span>, <span class="hljs-string">'g'</span>: <span class="hljs-string">'111111111'</span>}
压缩后：<span class="hljs-number">1001100000010111110001111001001111010110101100000010110011110111111001111101111000110111111101111111101011111111111110</span>
压缩后长度：<span class="hljs-number">138</span> 比特
压缩比：<span class="hljs-number">1.97</span>:<span class="hljs-number">1</span>
解压后：hello world! hello huffman coding!
解压是否成功：<span class="hljs-literal">True</span>
</code></pre>
<h3 data-id="heading-14">📊 趣味对比：无损压缩 vs 有损压缩</h3>













































<table><thead><tr><th>对比项</th><th>无损压缩</th><th>有损压缩</th></tr></thead><tbody><tr><td><strong>信息丢失</strong></td><td>无</td><td>有</td></tr><tr><td><strong>压缩比</strong></td><td>低（2-10:1）</td><td>高（10-1000:1）</td></tr><tr><td><strong>恢复质量</strong></td><td>完全恢复</td><td>部分恢复</td></tr><tr><td><strong>适用场景</strong></td><td>文本、程序、重要文档</td><td>照片、音乐、视频</td></tr><tr><td><strong>常见格式</strong></td><td>ZIP、PNG、FLAC</td><td>JPEG、MP3、H.264</td></tr><tr><td><strong>处理速度</strong></td><td>较快</td><td>较慢（需要复杂算法）</td></tr><tr><td><strong>文件大小</strong></td><td>较大</td><td>较小</td></tr></tbody></table>
<h3 data-id="heading-15">🖼️ 常见压缩格式的压缩比</h3>



























































<table><thead><tr><th>压缩格式</th><th>类型</th><th>适用场景</th><th>典型压缩比</th></tr></thead><tbody><tr><td>📦 ZIP</td><td>无损</td><td>通用压缩</td><td>2-5:1</td></tr><tr><td>🖼️ PNG</td><td>无损</td><td>图片（透明背景）</td><td>2-10:1</td></tr><tr><td>🎵 FLAC</td><td>无损</td><td>音乐</td><td>2-4:1</td></tr><tr><td>🖼️ JPEG</td><td>有损</td><td>照片</td><td>10-20:1</td></tr><tr><td>🎵 MP3</td><td>有损</td><td>音乐</td><td>10-12:1</td></tr><tr><td>📹 H.264</td><td>有损</td><td>视频</td><td>50-100:1</td></tr><tr><td>📹 H.265</td><td>有损</td><td>视频（4K）</td><td>100-200:1</td></tr><tr><td>🖼️ WebP</td><td>有损/无损</td><td>网页图片</td><td>20-30:1</td></tr></tbody></table>
<h3 data-id="heading-16">🔍 数据压缩的"魔法"：为什么能压缩这么多？</h3>
<h4 data-id="heading-17">1. 🔤 文本压缩："去掉重复的字"</h4>
<p>文本中存在大量重复的字符和字符串，比如英语中"the"、"and"等单词出现频率很高，中文中"的"、"了"等字出现频率很高。压缩算法可以用更短的编码来表示这些高频字符，从而减少总长度。</p>
<h4 data-id="heading-18">2. 🖼️ 图片压缩："去掉人眼看不到的细节"</h4>
<p>图片中存在大量人眼不敏感的信息，比如相邻像素的颜色差异、高频细节等。JPEG压缩算法会把图片分成8x8的小块，然后用离散余弦变换（DCT）把空间域转换为频率域，去除高频成分，再进行量化和编码。</p>
<h4 data-id="heading-19">3. 🎵 音频压缩："去掉人耳听不到的声音"</h4>
<p>音频中存在大量人耳听不到的频率，比如高于20kHz的超声波、非常微弱的声音等。MP3压缩算法会用心理声学模型分析音频，去除人耳听不到的部分，然后用子带编码和霍夫曼编码进行压缩。</p>
<h4 data-id="heading-20">4. 📹 视频压缩："去掉时间上的冗余"</h4>
<p>视频中相邻帧的内容非常相似，比如静态背景几乎不变。视频压缩算法会只保存第一帧的完整信息，然后保存后续帧与前一帧的差异（运动矢量和残差），从而大幅减少数据量。</p>
<h3 data-id="heading-21">⚠️ 常见误区纠正</h3>
<h4 data-id="heading-22">1. "压缩比越高越好？"</h4>
<p>不！压缩比高意味着信息丢失越多（有损压缩），或者压缩时间越长（无损压缩）。选择压缩比时，需要在压缩效果和质量之间找到平衡。</p>
<h4 data-id="heading-23">2. "无损压缩不会丢失信息，所以比有损压缩好？"</h4>
<p>不一定！无损压缩的压缩比低，文件较大，而有损压缩的压缩比高，文件较小。对于照片、音乐、视频等，有损压缩的质量损失人眼/人耳几乎察觉不到，却能节省大量空间。</p>
<h4 data-id="heading-24">3. "所有文件都能被压缩？"</h4>
<p>不！已经压缩过的文件（比如JPEG、MP3）很难再被压缩，因为它们已经去除了大部分冗余信息。而随机数据（比如加密文件）几乎无法被压缩，因为它们没有冗余信息。</p>
<h4 data-id="heading-25">4. "压缩会损坏文件？"</h4>
<p>不！正规的压缩软件和算法不会损坏文件。只有在压缩或解压过程中出现错误（比如磁盘故障、断电），才可能导致文件损坏。</p>
<h4 data-id="heading-26">5. "压缩和解压会影响电脑性能？"</h4>
<p>会！压缩和解压需要大量的CPU和内存资源，特别是压缩大文件时，可能会导致电脑变慢。但现在的电脑性能都很强，一般不会有明显影响。</p>
<h3 data-id="heading-27">🔮 未来展望：数据压缩的发展趋势</h3>
<h4 data-id="heading-28">1. 🤖 AI驱动的压缩："更智能的压缩"</h4>
<p>AI技术正在改变数据压缩领域，通过深度学习模型，AI可以更准确地识别冗余信息，预测人眼/人耳的感知，从而实现更高的压缩比和更好的质量。</p>
<h4 data-id="heading-29">2. 📱 移动端优化："更适合手机的压缩"</h4>
<p>随着移动互联网的发展，适合移动端的压缩格式会越来越重要，比如WebP、AVIF等，它们在保持高质量的同时，能大幅减少文件大小，提高手机的加载速度和续航。</p>
<h4 data-id="heading-30">3. 📊 实时压缩："边产生边压缩"</h4>
<p>实时压缩技术会越来越成熟，比如在拍摄视频时实时压缩，在直播时实时压缩传输，从而减少存储和带宽开销。</p>
<h4 data-id="heading-31">4. 🌐 跨模态压缩："同时压缩多种数据"</h4>
<p>未来的压缩技术会支持同时压缩多种类型的数据，比如视频、音频、文本等，从而实现更高的压缩效率。</p>
<h4 data-id="heading-32">5. 🎮 游戏资产压缩："更大的游戏，更小的安装包"</h4>
<p>随着游戏越来越大，游戏资产压缩会变得越来越重要，通过更高效的压缩算法，可以让玩家下载更小的安装包，同时保持游戏的高质量。</p>
<h3 data-id="heading-33">🎓 互动小测验：你答对了吗？</h3>



































<table><thead><tr><th>问题</th><th>答案</th><th>你答对了吗？</th></tr></thead><tbody><tr><td>数据压缩的核心原理是什么？</td><td>去除冗余信息</td><td>✅/❌</td></tr><tr><td>无损压缩和有损压缩的区别是什么？</td><td>无损不丢失信息，有损丢失信息</td><td>✅/❌</td></tr><tr><td>JPEG的典型压缩比是多少？</td><td>10-20:1</td><td>✅/❌</td></tr><tr><td>视频压缩的主要原理是什么？</td><td>去除时间冗余</td><td>✅/❌</td></tr><tr><td>已经压缩过的文件还能再压缩吗？</td><td>很难，因为已经去除了大部分冗余信息</td><td>✅/❌</td></tr></tbody></table>
<h3 data-id="heading-34">🎯 结语：数据压缩的"瘦身魔法"</h3>
<p>数据压缩就像"给数据做瘦身手术"，去掉多余的脂肪（冗余信息），保留有用的肌肉（有效信息）。它让我们能更快地传输数据，更有效地利用存储空间，降低成本，提高效率。</p>
<p>下次下载电影、发送照片、存储文件时，不妨想想背后的数据压缩技术。正是这些"瘦身魔法"，让我们的数字生活变得更加便捷和高效！</p>
<hr/>
<h3 data-id="heading-35">💬 互动话题</h3>
<ol>
<li>你平时经常使用哪些压缩格式？为什么？</li>
<li>你觉得数据压缩技术还能有哪些突破？</li>
<li>你遇到过哪些关于数据压缩的趣事？</li>
</ol>
<p>快来评论区聊聊你的想法！💬 点赞收藏不迷路，咱们下期继续探索计算机的"十万个为什么"！🎉</p>
<p><strong>关注我</strong>，下期带你解锁更多计算机的"奇葩冷知识"！🤓</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回收团队基于Cursor集成MCP的智能代码修复提示词生成实践]]></title>    <link>https://juejin.cn/post/7587998744294752262</link>    <guid>https://juejin.cn/post/7587998744294752262</guid>    <pubDate>2025-12-26T10:29:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587998744294752262" data-draft-id="7588002126258356230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="回收团队基于Cursor集成MCP的智能代码修复提示词生成实践"/> <meta itemprop="keywords" content="程序员,人工智能,Python"/> <meta itemprop="datePublished" content="2025-12-26T10:29:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            回收团队基于Cursor集成MCP的智能代码修复提示词生成实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:29:56.000Z" title="Fri Dec 26 2025 10:29:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、痛点</h2>
<h3 data-id="heading-1">痛点一：为什么我的Token消耗的这么快</h3>
<p>Token的消耗量通常受到下面两个因素的影响</p>
<ul>
<li>输入和输出的Token数量：输入的Token越多，输出的Token也会相应增加，因为模型会基于输入的上下文进行内容生成。</li>
<li>任务复杂性：更复杂的任务通常需要消耗更多的Token，而多模态的Agent往往消耗的Token会更高。</li>
</ul>
<p>为什么模糊的提示词会增加Token的消耗量？</p>
<ul>
<li>模糊的提示词可能包含大量与输出不相关的内容，增加输入的Token量。</li>
<li>模糊的提示词通常缺乏具体细节或明确约束，导致模型无法直接理解用户意图。为了覆盖可能的解释，模型倾向于生成更长、更全面的响应，以避免遗漏关键信息，从而增加输出token数量。</li>
<li>模糊的提示词往往无法精准的生成用户想要的内容。用户可能因输出不符合预期而多次修改提示，形成无效交互循环，无形中浪费Token。</li>
</ul>
<h3 data-id="heading-2">痛点二：AI修复代码为什么总是"差点意思"？</h3>
<p>一般都是拿到Sonar 扫描结果复制粘贴, 让AI修复后，一个一个改, 又太慢, 太多问题要么修复不准确，要么把好的代码也改坏了，还有就是问题
太多, 上下文超限修改失败</p>
<p><strong>举个真实的例子：</strong>
Sonar报告：<code>ActivityServiceImpl.java</code> 第120行存在空指针风险</p>
<p>我的提示词（第一版）：</p>
<pre><code class="hljs language-css" lang="css">请修复以下问题：第<span class="hljs-number">120</span>行存在空指针风险
代码：
<span class="hljs-selector-attr">[粘贴整个ActivityServiceImpl.java文件，可能是几千行]</span>
</code></pre>
<p>AI的回复：</p>
<ul>
<li>情况1："这个文件太长了，请提供更具体的代码片段"</li>
<li>情况2：修复了空指针，但把旁边的业务逻辑也改了</li>
<li>情况3："Token超出限制，无法处理"</li>
</ul>
<h3 data-id="heading-3">问题根源在哪？</h3>
<ol>
<li><strong>上下文冗余</strong>：超大文件代码中，真正相关的可能只有20行</li>
<li><strong>缺乏规范引导</strong>：没告诉AI要遵循什么编码规范</li>
<li><strong>信息不准确</strong>：没有精确指出问题在哪个方法、什么结构中</li>
<li><strong>没有示例</strong>：AI缺乏类似问题的修复参考</li>
</ol>
<h2 data-id="heading-4">二、转机：Cursor结合MCP打造自动化修复流程</h2>
<p>关键问题在于：<strong>如何将Sonar扫描结果转换为AI能高效理解的结构化提示词</strong>。</p>
<p>于是，我利用MCP（Model Context Protocol）协议为Cursor开发了一套智能提示词生成系统。</p>
<h3 data-id="heading-5">什么是MCP？</h3>
<p>MCP（Model Context Protocol）是一个开放协议，Cursor支持这个协议，允许我们通过Python等语言编写自定义工具，直接集成到Cursor的AI助手中。简单说就是：<strong>让AI拥有调用你自己编写的工具的能力</strong>。</p>
<h3 data-id="heading-6">我的方案架构</h3>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdb0e7f30b144b9db7dde7e0415c66d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349796&amp;x-signature=muUTZJGKL%2FsAHZewB9m0evKbyqU%3D" width="500" loading="lazy"/>
<h2 data-id="heading-7">三、核心方案：六步智能提示词生成法</h2>
<p>这套方案的核心思想是：<strong>让AI精确理解问题，而不是让AI去猜测问题</strong>。</p>
<p>整个系统基于以下6个步骤构建：</p>
<h4 data-id="heading-8">第一步：问题类型识别</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">IssueTypeClassifier</span>:
    <span class="hljs-string">"""将Sonar规则映射到问题类型"""</span>
    
    RULE_MAPPING = {
        <span class="hljs-comment"># 空指针问题</span>
        <span class="hljs-string">"java:S2259"</span>: <span class="hljs-string">"NullPointer"</span>,
        <span class="hljs-string">"java:S2637"</span>: <span class="hljs-string">"NullPointer"</span>,
        
        <span class="hljs-comment"># 资源泄露</span>
        <span class="hljs-string">"java:S2095"</span>: <span class="hljs-string">"ResourceLeak"</span>,
        <span class="hljs-string">"java:S2093"</span>: <span class="hljs-string">"ResourceLeak"</span>,
        
        <span class="hljs-comment"># 安全漏洞</span>
        <span class="hljs-string">"java:S3649"</span>: <span class="hljs-string">"SQLInjection"</span>,
        <span class="hljs-string">"java:S2076"</span>: <span class="hljs-string">"CommandInjection"</span>,
        
        <span class="hljs-comment"># 代码规范</span>
        <span class="hljs-string">"java:S117"</span>: <span class="hljs-string">"NamingConvention"</span>,
        <span class="hljs-string">"java:S1192"</span>: <span class="hljs-string">"DuplicateString"</span>,
    }
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">classify</span>(<span class="hljs-params">rule_key: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""根据规则ID分类问题类型"""</span>
        <span class="hljs-keyword">return</span> IssueTypeClassifier.RULE_MAPPING.get(
            rule_key, 
            <span class="hljs-string">"General"</span>
        )
</code></pre>
<h4 data-id="heading-9">第二步：AST代码结构解析</h4>
<p><strong>什么是AST？</strong></p>
<p>AST（Abstract Syntax Tree，抽象语法树）是将代码理解成树形结构的技术。</p>
<p>当Sonar告诉你"第120行有空指针问题"，我们需要知道：</p>
<ul>
<li>第120行在哪个<strong>方法</strong>里？</li>
<li>这个方法从哪行<strong>开始</strong>，到哪行<strong>结束</strong>？</li>
<li>方法的完整信息（方法名、参数、返回值）</li>
</ul>
<p><strong>AST解析 = 像编译器一样理解代码结构</strong></p>
<p>想象代码是一个家族，AST就是家谱树：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">ClassDeclaration:</span> <span class="hljs-string">ActivityServiceImpl（类）</span>
 <span class="hljs-string">│</span>
 <span class="hljs-string">├─</span> <span class="hljs-attr">FieldDeclaration:</span> <span class="hljs-string">activityFacadeHelper（成员变量）</span>
 <span class="hljs-string">│</span>
 <span class="hljs-string">├─</span> <span class="hljs-attr">MethodDeclaration:</span> <span class="hljs-string">queryActivityListWithNewImei（方法）</span>
 <span class="hljs-string">│</span>   <span class="hljs-string">├─</span> <span class="hljs-attr">position:</span> <span class="hljs-string">line</span> <span class="hljs-number">106</span>
 <span class="hljs-string">│</span>   <span class="hljs-string">├─</span> <span class="hljs-attr">parameters:</span> [<span class="hljs-string">Long</span> <span class="hljs-string">orderId</span>, <span class="hljs-string">String</span> <span class="hljs-string">newMachineUuid</span>]
 <span class="hljs-string">│</span>   <span class="hljs-string">├─</span> <span class="hljs-attr">return_type:</span> <span class="hljs-string">OrderAllowActivityMiVO</span>
 <span class="hljs-string">│</span>   <span class="hljs-string">└─</span> <span class="hljs-attr">body:</span> {<span class="hljs-string">...</span>}  <span class="hljs-string">←</span> <span class="hljs-string">第120行在这里</span>
 <span class="hljs-string">│</span>
 <span class="hljs-string">└─</span> <span class="hljs-attr">MethodDeclaration:</span> <span class="hljs-string">editActivityListWithNewImei（另一个方法）</span>
</code></pre>
<p><strong>使用javalang进行AST解析</strong></p>
<p>javalang是一个纯Python库，用Python重新实现了Java语法解析器，<strong>不需要安装Java环境</strong>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> javalang

<span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaCodeParser</span>:
    <span class="hljs-string">"""Java代码结构解析器 - 使用AST精确解析"""</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_method_context</span>(<span class="hljs-params">file_path: <span class="hljs-built_in">str</span>, line_number: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>]:
        <span class="hljs-string">"""使用javalang进行AST解析，精确定位方法"""</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
            code = f.read()
        
        <span class="hljs-comment"># 1. 解析Java代码，生成AST（语法树）</span>
        tree = javalang.parse.parse(code)
        
        <span class="hljs-comment"># 2. 遍历AST，查找包含目标行的方法节点</span>
        <span class="hljs-keyword">for</span> path, node <span class="hljs-keyword">in</span> tree.<span class="hljs-built_in">filter</span>(javalang.tree.MethodDeclaration):
            method_start = node.position.line
            method_end = calculate_method_end(node)  <span class="hljs-comment"># 计算方法结束位置</span>
            
            <span class="hljs-comment"># 3. 检查目标行是否在此方法范围内</span>
            <span class="hljs-keyword">if</span> method_start &lt;= line_number &lt;= method_end:
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-string">'class_name'</span>: extract_class_name(path),
                    <span class="hljs-string">'method_name'</span>: node.name,              <span class="hljs-comment"># 方法名</span>
                    <span class="hljs-string">'start_line'</span>: method_start,            <span class="hljs-comment"># 方法开始行</span>
                    <span class="hljs-string">'end_line'</span>: method_end,                <span class="hljs-comment"># 方法结束行</span>
                    <span class="hljs-string">'modifiers'</span>: node.modifiers,           <span class="hljs-comment"># ['public', 'static']</span>
                    <span class="hljs-string">'return_type'</span>: node.return_type.name,  <span class="hljs-comment"># 返回值类型</span>
                    <span class="hljs-string">'parameters'</span>: [p.name <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> node.parameters],  <span class="hljs-comment"># 参数列表</span>
                }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<p><strong>AST解析的价值</strong>：</p>
<ol>
<li><strong>精确定位</strong>：直接知道第120行在<code>queryActivityListWithNewImei</code>方法内，而不是<code>editActivityListWithNewIme</code>方法</li>
<li><strong>完整信息</strong>：获取方法名、参数类型、返回值等元信息</li>
<li><strong>语法理解</strong>：像编译器一样理解Java语法，不会被注释、字符串、Lambda表达式干扰</li>
<li><strong>高准确率</strong>：准确率可达99%+</li>
</ol>
<p><strong>javalang的特点</strong>：</p>
<ul>
<li>纯Python库，只需<code>pip install javalang</code></li>
<li>不需要安装JDK或Java环境</li>
<li>提供完整的Java语法树节点</li>
<li>支持Java 8+的语法特性</li>
</ul>
<h4 data-id="heading-10">第三步：智能上下文提取</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextExtractor</span>:
    <span class="hljs-string">"""根据问题类型智能提取代码上下文"""</span>
    
    <span class="hljs-comment"># 不同问题类型的提取策略配置</span>
    EXTRACTION_RULES = {
        <span class="hljs-string">"NullPointer"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"full_method"</span>,           <span class="hljs-comment"># 提取完整方法</span>
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">150</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">True</span>,           <span class="hljs-comment"># 包含import语句</span>
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">True</span>, <span class="hljs-comment"># 包含类声明</span>
        },
        <span class="hljs-string">"ResourceLeak"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"full_method"</span>,
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">100</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">True</span>,
        },
        <span class="hljs-string">"SQLInjection"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"full_method"</span>,
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">120</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">True</span>,
        },
        <span class="hljs-string">"NamingConvention"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"surrounding"</span>,            <span class="hljs-comment"># 只提取周围代码</span>
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">30</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">False</span>,
        },
        <span class="hljs-string">"General"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"surrounding"</span>,
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">50</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">False</span>,
        },
    }
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extract</span>(<span class="hljs-params">file_path: <span class="hljs-built_in">str</span>, line_number: <span class="hljs-built_in">int</span>, issue_type: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""智能提取代码上下文"""</span>
        rules = ContextExtractor.EXTRACTION_RULES.get(
            issue_type,
            ContextExtractor.EXTRACTION_RULES[<span class="hljs-string">"General"</span>]
        )
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
                lines = f.readlines()
            
            context_lines = []
            
            <span class="hljs-comment"># 1. 提取package和imports（如果需要）</span>
            <span class="hljs-keyword">if</span> rules.get(<span class="hljs-string">"include_imports"</span>):
                <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines[:<span class="hljs-number">50</span>]:
                    <span class="hljs-keyword">if</span> line.strip().startswith((<span class="hljs-string">'package '</span>, <span class="hljs-string">'import '</span>)):
                        context_lines.append(line)
                    <span class="hljs-keyword">elif</span> line.strip() <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> line.strip().startswith(<span class="hljs-string">'//'</span>):
                        <span class="hljs-keyword">break</span>
                <span class="hljs-keyword">if</span> context_lines:
                    context_lines.append(<span class="hljs-string">'\n'</span>)
            
            <span class="hljs-comment"># 2. 提取方法或周围代码</span>
            <span class="hljs-keyword">if</span> rules[<span class="hljs-string">"range"</span>] == <span class="hljs-string">"full_method"</span>:
                method_info = JavaCodeParser.extract_method_context(file_path, line_number)
                <span class="hljs-keyword">if</span> method_info:
                    start = method_info[<span class="hljs-string">'start_line'</span>] - <span class="hljs-number">1</span>
                    end = method_info[<span class="hljs-string">'end_line'</span>]
                    
                    <span class="hljs-comment"># 如果需要类声明，向上查找</span>
                    <span class="hljs-keyword">if</span> rules.get(<span class="hljs-string">"include_class_declaration"</span>):
                        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(start, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>):
                            <span class="hljs-keyword">if</span> <span class="hljs-string">'class '</span> <span class="hljs-keyword">in</span> lines[i]:
                                context_lines.append(lines[i])
                                context_lines.append(<span class="hljs-string">'    // ... 其他成员 ...\n\n'</span>)
                                <span class="hljs-keyword">break</span>
                    
                    context_lines.extend(lines[start:end])
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># 回退到周围代码</span>
                    start = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, line_number - <span class="hljs-number">25</span>)
                    end = <span class="hljs-built_in">min</span>(<span class="hljs-built_in">len</span>(lines), line_number + <span class="hljs-number">25</span>)
                    context_lines.extend(lines[start:end])
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 提取周围代码</span>
                max_lines = rules[<span class="hljs-string">"max_lines"</span>]
                start = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, line_number - max_lines // <span class="hljs-number">2</span>)
                end = <span class="hljs-built_in">min</span>(<span class="hljs-built_in">len</span>(lines), line_number + max_lines // <span class="hljs-number">2</span>)
                context_lines.extend(lines[start:end])
            
            <span class="hljs-comment"># 3. 限制总行数</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(context_lines) &gt; rules[<span class="hljs-string">"max_lines"</span>]:
                context_lines = context_lines[:rules[<span class="hljs-string">"max_lines"</span>]]
                context_lines.append(<span class="hljs-string">'\n// ... 后续代码省略 ...\n'</span>)
            
            <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>.join(context_lines)
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"提取失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"// 无法读取文件: <span class="hljs-subst">{file_path}</span>"</span>
</code></pre>
<p><strong>核心策略</strong>：</p>
<ul>
<li><strong>差异化提取</strong>：空指针问题提取150行含imports，命名规范只提取30行</li>
<li><strong>智能回退</strong>：AST解析失败时自动回退到简单提取</li>
<li><strong>Token控制</strong>：通过max_lines限制，避免上下文过长</li>
</ul>
<h4 data-id="heading-11">第四步：分层模板体系</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PromptTemplateEngine</span>:
    <span class="hljs-string">"""分层的提示词模板引擎"""</span>
    
    <span class="hljs-comment"># Java语言规范</span>
    JAVA_STANDARDS = <span class="hljs-string">"""
请遵循以下Java开发规范：
1. 遵循阿里巴巴Java开发手册的编码规范
2. 所有可能为null的参数必须进行防御性检查
3. 资源（文件流、数据库连接等）必须使用try-with-resources自动管理
4. 异常必须妥善处理，不得吞掉异常
5. 方法复杂度不得过高，保持代码可读性
6. 变量和方法命名要清晰、符合驼峰命名规范
"""</span>
    
    <span class="hljs-comment"># 问题类型特定模板</span>
    ISSUE_TEMPLATES = {
        <span class="hljs-string">"NullPointer"</span>: {
            <span class="hljs-string">"task"</span>: <span class="hljs-string">"修复以下代码中的空指针风险问题"</span>,
            <span class="hljs-string">"requirements"</span>: <span class="hljs-string">"""
修复要求：
1. 在方法开始处对可能为null的参数进行检查
2. 如果参数为null，抛出IllegalArgumentException异常，并提供清晰的错误信息
3. 保持原有业务逻辑不变
4. 不要修改方法签名
5. 确保修复后不影响其他正常调用
"""</span>
        },
        <span class="hljs-string">"ResourceLeak"</span>: {
            <span class="hljs-string">"task"</span>: <span class="hljs-string">"修复以下代码中的资源泄露问题"</span>,
            <span class="hljs-string">"requirements"</span>: <span class="hljs-string">"""
修复要求：
1. 使用try-with-resources语句包裹需要关闭的资源
2. 确保在任何情况下（正常或异常）资源都能正确释放
3. 保持原有异常处理方式
4. 保持方法签名不变
"""</span>
        },
        <span class="hljs-string">"SQLInjection"</span>: {
            <span class="hljs-string">"task"</span>: <span class="hljs-string">"修复以下代码中的SQL注入安全漏洞"</span>,
            <span class="hljs-string">"requirements"</span>: <span class="hljs-string">"""
修复要求：
1. 必须使用参数化查询（PreparedStatement）替代字符串拼接
2. 使用占位符（?）和参数绑定传递用户输入
3. 不得使用字符串拼接或格式化方式构建SQL语句
4. 保持查询逻辑不变
"""</span>
        },
    }
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">issue_type: <span class="hljs-built_in">str</span>, issue_data: <span class="hljs-built_in">dict</span>, code_context: <span class="hljs-built_in">str</span>, examples: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""生成最终提示词"""</span>
        
        template = PromptTemplateEngine.ISSUE_TEMPLATES.get(
            issue_type,
            {<span class="hljs-string">"task"</span>: <span class="hljs-string">"修复以下代码问题"</span>, <span class="hljs-string">"requirements"</span>: <span class="hljs-string">"保持代码风格与项目一致"</span>}
        )
        
        <span class="hljs-comment"># 组装提示词</span>
        prompt = <span class="hljs-string">f"""你是一位精通Java开发的资深工程师。

任务：<span class="hljs-subst">{template[<span class="hljs-string">'task'</span>]}</span>

编码规范：<span class="hljs-subst">{PromptTemplateEngine.JAVA_STANDARDS.strip()}</span>
"""</span>
        
        <span class="hljs-comment"># 添加示例（如果有）</span>
        <span class="hljs-keyword">if</span> examples:
            prompt += <span class="hljs-string">f"\n<span class="hljs-subst">{examples}</span>\n"</span>
        
        <span class="hljs-comment"># 添加问题详情</span>
        prompt += <span class="hljs-string">f"""
问题详情：
- 规则ID: <span class="hljs-subst">{issue_data.get(<span class="hljs-string">'rule'</span>, <span class="hljs-string">'Unknown'</span>)}</span>
- 问题类型: <span class="hljs-subst">{issue_type}</span>
- 严重级别: <span class="hljs-subst">{issue_data.get(<span class="hljs-string">'severity'</span>, <span class="hljs-string">'MAJOR'</span>)}</span>
- 问题描述: <span class="hljs-subst">{issue_data.get(<span class="hljs-string">'message'</span>, <span class="hljs-string">''</span>)}</span>
- 问题位置: 第<span class="hljs-subst">{issue_data.get(<span class="hljs-string">'line'</span>, <span class="hljs-number">0</span>)}</span>行

待修复代码：
```java
<span class="hljs-subst">{code_context}</span>
``` <span class="hljs-subst">{data-source-line=<span class="hljs-string">"360"</span>}</span>

<span class="hljs-subst">{template[<span class="hljs-string">'requirements'</span>].strip()}</span>

输出格式：
- 仅输出修复后的完整方法代码
- 使用```java```格式包裹代码
- 不要输出多余的解释文字
- 确保代码可以直接替换原有方法
"""</span>
        
        <span class="hljs-keyword">return</span> prompt
</code></pre>
<p><strong>模板设计</strong>：</p>
<ul>
<li><strong>三层结构</strong>：角色设定 + 编码规范 + 问题类型特定要求</li>
<li><strong>灵活扩展</strong>：新增问题类型只需添加模板配置</li>
<li><strong>规范注入</strong>：自动注入阿里巴巴Java开发手册规范</li>
</ul>
<h4 data-id="heading-12">第五步：Few-shot示例库</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleRepository</span>:
    <span class="hljs-string">"""问题修复示例库 - 提供修复前后的对比案例"""</span>
    
    EXAMPLES = {
        <span class="hljs-string">"NullPointer"</span>: <span class="hljs-string">"""
参考示例：

示例1 - 空指针防御性检查：
修复前：
```java
public String getUserEmail(User user) {
    return user.getEmail();
}
``` {data-source-line="395"}
修复后：
```java
public String getUserEmail(User user) {
    if (user == null) {
        throw new IllegalArgumentException("用户对象不能为空");
    }
    return user.getEmail();
}
``` {data-source-line="404"}

示例2 - 多参数空值检查：
修复前：
```java
public void processOrder(Order order, User user) {
    order.setUser(user);
    order.setStatus("processed");
}
``` {data-source-line="413"}
修复后：
```java
public void processOrder(Order order, User user) {
    if (order == null) {
        throw new IllegalArgumentException("订单对象不能为空");
    }
    if (user == null) {
        throw new IllegalArgumentException("用户对象不能为空");
    }
    order.setUser(user);
    order.setStatus("processed");
}
``` {data-source-line="426"}
"""</span>,
        <span class="hljs-string">"ResourceLeak"</span>: <span class="hljs-string">"""
参考示例：

示例 - 使用try-with-resources：
修复前：
```java
public String readFile(String path) throws IOException {
    FileInputStream fis = new FileInputStream(path);
    byte[] buffer = new byte[1024];
    int length = fis.read(buffer);
    return new String(buffer, 0, length);
}
``` {data-source-line="440"}
修复后：
```java
public String readFile(String path) throws IOException {
    try (FileInputStream fis = new FileInputStream(path)) {
        byte[] buffer = new byte[1024];
        int length = fis.read(buffer);
        return new String(buffer, 0, length);
    }
}
``` {data-source-line="450"}
"""</span>,
        <span class="hljs-string">"SQLInjection"</span>: <span class="hljs-string">"""
参考示例：

示例 - 使用PreparedStatement：
修复前：
```java
public User findUserByName(String name) {
    String sql = "SELECT * FROM users WHERE name = '" + name + "'";
    return jdbcTemplate.queryForObject(sql, User.class);
}
``` {data-source-line="462"}
修复后：
```java
public User findUserByName(String name) {
    String sql = "SELECT * FROM users WHERE name = ?";
    return jdbcTemplate.queryForObject(sql, User.class, name);
}
``` {data-source-line="469"}
"""</span>,
    }
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_examples</span>(<span class="hljs-params">issue_type: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""获取相关示例"""</span>
        <span class="hljs-keyword">return</span> ExampleRepository.EXAMPLES.get(issue_type, <span class="hljs-string">""</span>)
</code></pre>
<p><strong>示例库价值</strong>：</p>
<ul>
<li><strong>Few-shot学习</strong>：让AI通过案例学习修复模式</li>
<li><strong>格式统一</strong>：修复前/后对比，清晰明了</li>
<li><strong>易于扩展</strong>：新增示例只需添加字符串配置</li>
</ul>
<h4 data-id="heading-13">第六步：整合到MCP服务</h4>
<p>现在，将所有组件整合到MCP服务中：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp.server <span class="hljs-keyword">import</span> FastMCP
<span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> os

mcp = FastMCP(<span class="hljs-string">"intelligent-code-fix"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">IntelligentPromptGenerator</span>:
    <span class="hljs-string">"""智能提示词生成器 - 整合6步生成法的核心类"""</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_for_issue</span>(<span class="hljs-params">issue: <span class="hljs-built_in">dict</span>, base_dir: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">"""为单个issue生成智能提示词"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 1. 提取issue信息</span>
            rule_key = issue.get(<span class="hljs-string">'rule'</span>, <span class="hljs-string">''</span>)
            component = issue.get(<span class="hljs-string">'component'</span>, <span class="hljs-string">''</span>)
            file_path = component.split(<span class="hljs-string">':'</span>, <span class="hljs-number">1</span>)[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> <span class="hljs-string">':'</span> <span class="hljs-keyword">in</span> component <span class="hljs-keyword">else</span> component
            full_path = os.path.join(base_dir, file_path)
            line_number = issue.get(<span class="hljs-string">'line'</span>, <span class="hljs-number">0</span>)
            message = issue.get(<span class="hljs-string">'message'</span>, <span class="hljs-string">''</span>)
            severity = issue.get(<span class="hljs-string">'severity'</span>, <span class="hljs-string">'MAJOR'</span>)
            
            <span class="hljs-comment"># 2. 问题类型识别</span>
            issue_type = IssueTypeClassifier.classify(rule_key)
            
            logging.info(<span class="hljs-string">f"处理问题: <span class="hljs-subst">{file_path}</span>:<span class="hljs-subst">{line_number}</span> - <span class="hljs-subst">{issue_type}</span>"</span>)
            
            <span class="hljs-comment"># 3. 提取代码上下文</span>
            code_context = ContextExtractor.extract(full_path, line_number, issue_type)
            
            <span class="hljs-comment"># 4. 获取示例</span>
            examples = ExampleRepository.get_examples(issue_type)
            
            <span class="hljs-comment"># 5. 生成提示词</span>
            issue_data = {
                <span class="hljs-string">'rule'</span>: rule_key,
                <span class="hljs-string">'severity'</span>: severity,
                <span class="hljs-string">'message'</span>: message,
                <span class="hljs-string">'line'</span>: line_number,
            }
            
            prompt = PromptTemplateEngine.generate(
                issue_type=issue_type,
                issue_data=issue_data,
                code_context=code_context,
                examples=examples
            )
            
            <span class="hljs-comment"># 6. 计算元数据</span>
            token_estimate = <span class="hljs-built_in">len</span>(prompt) // <span class="hljs-number">4</span>  <span class="hljs-comment"># 粗略估算</span>
            
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'success'</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">'prompt'</span>: prompt,
                <span class="hljs-string">'metadata'</span>: {
                    <span class="hljs-string">'file'</span>: file_path,
                    <span class="hljs-string">'line'</span>: line_number,
                    <span class="hljs-string">'issue_type'</span>: issue_type,
                    <span class="hljs-string">'rule'</span>: rule_key,
                    <span class="hljs-string">'severity'</span>: severity,
                    <span class="hljs-string">'token_estimate'</span>: token_estimate,
                }
            }
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"生成提示词失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'success'</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">'error'</span>: <span class="hljs-built_in">str</span>(e),
                <span class="hljs-string">'file'</span>: file_path,
                <span class="hljs-string">'line'</span>: line_number,
            }

<span class="hljs-meta">@mcp.tool(<span class="hljs-params"><span class="hljs-string">"auto-fix-sonar-issues"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">auto_fix_sonar_issues</span>(<span class="hljs-params">
    project_name: <span class="hljs-built_in">str</span>,
    cookie: <span class="hljs-built_in">str</span>,
    base_dir: <span class="hljs-built_in">str</span>,
    branch: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span>,
    page_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>,
    page_num: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span>,
    is_new_code_period: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""智能修复Sonar扫描问题 - 核心MCP工具"""</span>
    
    <span class="hljs-comment"># 获取Sonar问题列表</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient() <span class="hljs-keyword">as</span> client:
        params = {
            <span class="hljs-string">"components"</span>: project_name,
            <span class="hljs-string">"ps"</span>: page_size,
            <span class="hljs-string">"p"</span>: page_num,
        }
        <span class="hljs-keyword">if</span> branch:
            params[<span class="hljs-string">"branch"</span>] = branch
        <span class="hljs-keyword">if</span> is_new_code_period:
            params[<span class="hljs-string">"inNewCodePeriod"</span>] = <span class="hljs-string">"true"</span>
        
        response = <span class="hljs-keyword">await</span> client.get(
            <span class="hljs-string">"https://sonar.zhuanspirit.com/api/issues/search"</span>,
            params=params,
            headers={<span class="hljs-string">"Cookie"</span>: cookie},
            timeout=<span class="hljs-number">10.0</span>
        )
        
        data = response.json()
        issues = data.get(<span class="hljs-string">'issues'</span>, [])
        total = data.get(<span class="hljs-string">'total'</span>, <span class="hljs-number">0</span>)
    
    <span class="hljs-comment"># 为每个issue生成智能提示词</span>
    results = []
    success_count = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">for</span> idx, issue <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(issues, <span class="hljs-number">1</span>):
        result = IntelligentPromptGenerator.generate_for_issue(issue, base_dir)
        
        <span class="hljs-keyword">if</span> result[<span class="hljs-string">'success'</span>]:
            success_count += <span class="hljs-number">1</span>
            metadata = result[<span class="hljs-string">'metadata'</span>]
            results.append(<span class="hljs-string">f"""
<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">80</span>}</span>
## Issue <span class="hljs-subst">{idx}</span>: <span class="hljs-subst">{metadata[<span class="hljs-string">'file'</span>]}</span> (第<span class="hljs-subst">{metadata[<span class="hljs-string">'line'</span>]}</span>行)

**问题类型**: <span class="hljs-subst">{metadata[<span class="hljs-string">'issue_type'</span>]}</span>  
**严重级别**: <span class="hljs-subst">{metadata[<span class="hljs-string">'severity'</span>]}</span>  
**预估Token**: <span class="hljs-subst">{metadata[<span class="hljs-string">'token_estimate'</span>]}</span>

### 生成的智能提示词：

<span class="hljs-subst">{result[<span class="hljs-string">'prompt'</span>]}</span>
<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">80</span>}</span>
"""</span>)
    
    <span class="hljs-comment"># 组装最终输出</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"""
# 智能代码修复提示词生成完成

## 统计信息
- **项目**: <span class="hljs-subst">{project_name}</span>
- **总问题数**: <span class="hljs-subst">{total}</span>
- **本批次**: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(issues)}</span> 个
- **成功生成**: <span class="hljs-subst">{success_count}</span> 个

## 智能提示词列表
<span class="hljs-subst">{<span class="hljs-string">""</span>.join(results)}</span>

---
由智能提示词生成引擎提供支持
"""</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    mcp.run(<span class="hljs-string">"stdio"</span>)
</code></pre>
<p><strong>整合要点</strong>：</p>
<ul>
<li><strong>错误处理</strong>：每个issue独立处理，单个失败不影响其他</li>
<li><strong>元数据追踪</strong>：记录文件、行号、问题类型、Token估算</li>
<li><strong>结构化输出</strong>：Markdown格式，便于Cursor展示</li>
</ul>
<h3 data-id="heading-14">安装依赖包</h3>
<p>在使用MCP服务之前，需要先安装必要的Python依赖包。创建<code>requirements.txt</code>文件：</p>
<pre><code class="hljs language-txt" lang="txt"># 智能代码修复MCP服务依赖包

# MCP框架 - 用于构建MCP服务
mcp&gt;=0.9.0

# HTTP客户端 - 用于调用Sonar API
httpx&gt;=0.27.0

# Java AST解析器 - 精确解析Java代码结构（强烈推荐）
# 优势：准确率99%+，不受注释、字符串、Lambda影响
# 注意：这是纯Python库，不需要Java环境
javalang&gt;=0.13.0
</code></pre>
<p>安装命令：</p>
<pre><code class="hljs language-bash" lang="bash">pip install -r requirements.txt
</code></pre>
<p><strong>依赖说明</strong>：</p>
<ul>
<li><strong>mcp</strong>：MCP协议框架，让Python脚本能够被Cursor识别和调用</li>
<li><strong>httpx</strong>：现代化HTTP客户端，用于调用Sonar API获取扫描结果</li>
<li><strong>javalang</strong>：纯Python的Java AST解析器，用于精准定位代码结构，无需安装Java环境</li>
</ul>
<h3 data-id="heading-15">配置MCP（让Cursor识别你的服务）</h3>
<p>%这里改成你本地的路径%
在 <code>~/.cursor/mcp.json</code> 中添加：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"intelligent-code-fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"/Users/Desktop/cursor/intelligent-code-fix.py"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>配置说明</strong>：</p>
<ul>
<li><code>intelligent-code-fix</code>：MCP服务名称，在Cursor中通过<code>@intelligent-code-fix</code>调用</li>
<li><code>command</code>: Python解释器命令</li>
<li><code>args</code>: Python脚本的绝对路径（请修改为你的实际路径）</li>
<li>修改配置后需要重启Cursor生效</li>
</ul>
<h2 data-id="heading-16">四、使用体验：在Cursor中一键修复</h2>
<h3 data-id="heading-17">配置好MCP后，在Cursor中的使用非常简单</h3>
<h4 data-id="heading-18">步骤1：在Cursor聊天窗口调用MCP工具</h4>
<pre><code class="hljs language-diff" lang="diff">使用 auto-fix-sonar-issues 工具修复Sonar问题

参数：

<span class="hljs-deletion">- project_name: hunter_partner_recycle_core</span>
<span class="hljs-deletion">- cookie: sso_uid=xxx; ticket=xxx; aid=xxx</span>
<span class="hljs-deletion">- base_dir: /Users/xxx/projects/hunter/src/main/java</span>
<span class="hljs-deletion">- branch: feature-3278-163 (可选)</span>
<span class="hljs-deletion">- page_size: 10</span>




</code></pre>
<h4 data-id="heading-19">步骤2：MCP服务自动处理</h4>
<p>系统自动完成：</p>
<ol>
<li>调用Sonar API获取问题列表</li>
<li>为每个问题智能生成提示词</li>
<li>返回结构化的修复建议</li>
</ol>
<h4 data-id="heading-20">步骤3：AI生成修复后的代码</h4>
<pre><code class="hljs language-ini" lang="ini">已生成10个问题的修复建议：

Issue 1: ActivityServiceImpl.java 空指针修复
修复后代码：
<span class="hljs-section">[完整的修复代码]</span>

Issue 2: FileUtil.java 资源泄露修复
修复后代码：
<span class="hljs-section">[完整的修复代码]</span>

</code></pre>
<h4 data-id="heading-21">步骤4：一键应用修复</h4>
<p>直接在Cursor中review并应用修复</p>
<h3 data-id="heading-22">改进效果：</h3>
<ol>
<li>成本降低70% ：精准提取上下文，token使用量大幅减少</li>
<li>准确率提升30%：结构化提示词+示例引导，AI理解更准确</li>
<li>效率提升3倍：自动化流程，无需人工干预</li>
<li>质量可控：分层模板确保代码符合团队规范</li>
<li>易于扩展：新增问题类型只需添加配置</li>
</ol>
<h2 data-id="heading-23">五、写在最后</h2>
<p>真正有效的AI辅助开发，不是简单地把代码扔给AI，而是要做好：</p>
<ul>
<li><strong>问题的精准识别</strong>：知道是什么类型的问题</li>
<li><strong>上下文的智能提取</strong>：给AI最相关的代码，而不是全部代码</li>
<li><strong>规范的有效注入</strong>：让AI知道要遵循什么标准</li>
<li><strong>经验的系统沉淀</strong>：用示例库让AI学习最佳实践</li>
</ul>
<p>这套方案不仅适用于Sonar，也可以推广到其他代码扫描工具（ESLint、Checkstyle等）。核心思想都是：<strong>将非结构化的扫描结果转换为结构化的AI提示词</strong>。</p>
<p>希望这篇文章能给大家带来启发。如果大家也在探索AI辅助开发，欢迎交流！</p>
<blockquote>
<p>关于作者，刘雅斌，侠客汇Java开发工程师。
想了解更多转转公司的业务实践，欢迎点击关注下方公众号</p>
</blockquote>
<blockquote>
<p>转转研发中心及业界小伙伴们的技术学习交流平台，定期分享一线的实战经验及业界前沿的技术话题。
关注公众号「转转技术」（综合性）、「大转转FE」（专注于FE）、「转转QA」（专注于QA），更多干货实践，欢迎交流分享~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我接入了微信小说小程序官方阅读器]]></title>    <link>https://juejin.cn/post/7587995707165704211</link>    <guid>https://juejin.cn/post/7587995707165704211</guid>    <pubDate>2025-12-26T10:31:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587995707165704211" data-draft-id="7588001624904581139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我接入了微信小说小程序官方阅读器"/> <meta itemprop="keywords" content="前端,微信小程序"/> <meta itemprop="datePublished" content="2025-12-26T10:31:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jack_po"/> <meta itemprop="url" content="https://juejin.cn/user/207159605068189"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我接入了微信小说小程序官方阅读器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/207159605068189/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jack_po
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:31:41.000Z" title="Fri Dec 26 2025 10:31:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">概述</h2>
<p>微信官方为小说类小程序提供了专用的阅读器插件，所有小说类目的小程序都必须使用该组件。</p>
<h2 data-id="heading-1">快速开始</h2>
<h3 data-id="heading-2">1. 添加插件配置</h3>
<p>在小程序的 <code>app.json</code> 文件中添加插件配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"novel-plugin"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"latest"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"wx293c4b6097a8a4d0"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-3">2. 初始化插件</h3>
<p>在 <code>app.js</code> 中初始化插件并监听页面加载事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// app.js</span>
<span class="hljs-keyword">const</span> novelPlugin = requirePlugin(<span class="hljs-string">'novel-plugin'</span>)

<span class="hljs-title class_">App</span>({
  <span class="hljs-title function_">onLaunch</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 监听阅读器页面加载事件</span>
    novelPlugin.<span class="hljs-title function_">onPageLoad</span>(onNovelPluginLoad)
  },
})

<span class="hljs-keyword">function</span> <span class="hljs-title function_">onNovelPluginLoad</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-comment">// data.id - 阅读器实例ID</span>
  <span class="hljs-keyword">const</span> novelManager = novelPlugin.<span class="hljs-title function_">getNovelManager</span>(data.<span class="hljs-property">id</span>)
  
  <span class="hljs-comment">// 设置目录状态</span>
  novelManager.<span class="hljs-title function_">setContents</span>({
    <span class="hljs-attr">contents</span>: [
      { <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">0</span> }, <span class="hljs-comment">// 第一章：免费</span>
      { <span class="hljs-attr">index</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">2</span> }, <span class="hljs-comment">// 第二章：未解锁</span>
      { <span class="hljs-attr">index</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">1</span> }, <span class="hljs-comment">// 第三章：已解锁</span>
    ]
  })

  <span class="hljs-comment">// 监听用户行为</span>
  novelManager.<span class="hljs-title function_">onUserTriggerEvent</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用户操作：'</span>, res.<span class="hljs-property">event_id</span>, res)
  })
}
</code></pre>
<h3 data-id="heading-4">3. 跳转到阅读页面</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 跳转到阅读器页面</span>
wx.<span class="hljs-title function_">navigateTo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'plugin-private://wx293c4b6097a8a4d0/pages/novel/index?bookId=书籍ID'</span>
})
</code></pre>
<h2 data-id="heading-5">核心功能详解</h2>
<h3 data-id="heading-6">页面跳转参数</h3>
<p>跳转到阅读页面时可以传入以下参数：</p>













































<table><thead><tr><th>参数</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td>bookId</td><td>是</td><td>书籍ID</td></tr><tr><td>chapterIndex</td><td>否</td><td>跳转章节下标（从0开始）</td></tr><tr><td>fontSize</td><td>否</td><td>字体大小（0-9）</td></tr><tr><td>turnPageWay</td><td>否</td><td>翻页方式：SWIPE/MOVE/SCROLL</td></tr><tr><td>backgroundConfigIndex</td><td>否</td><td>背景色序号（1-5）</td></tr><tr><td>isNightMode</td><td>否</td><td>是否夜间模式</td></tr><tr><td>showListenButton</td><td>否</td><td>是否显示听书按钮</td></tr></tbody></table>
<h3 data-id="heading-7">章节解锁功能</h3>
<h4 data-id="heading-8">1. 创建解锁组件</h4>
<p>首先创建一个自定义组件 <code>charge-dialog</code>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- charge-dialog.wxml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"charge-dialog"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>解锁第 {{ chapterIndex + 1 }} 章<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">bindtap</span>=<span class="hljs-string">"unlock"</span>&gt;</span>立即解锁<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// charge-dialog.js</span>
<span class="hljs-keyword">const</span> novelPlugin = requirePlugin(<span class="hljs-string">'novel-plugin'</span>)

<span class="hljs-title class_">Component</span>({
  <span class="hljs-attr">properties</span>: {
    <span class="hljs-attr">novelManagerId</span>: <span class="hljs-title class_">Number</span>,
    <span class="hljs-attr">bookId</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">chapterIndex</span>: <span class="hljs-title class_">Number</span>,
    <span class="hljs-attr">chapterId</span>: <span class="hljs-title class_">String</span>
  },

  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">unlock</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> novelManager = novelPlugin.<span class="hljs-title function_">getNovelManager</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">properties</span>.<span class="hljs-property">novelManagerId</span>)
      
      <span class="hljs-comment">// 执行解锁逻辑...</span>
      
      <span class="hljs-comment">// 解锁完成后通知阅读器</span>
      novelManager.<span class="hljs-title function_">paymentCompleted</span>()
    }
  }
})
</code></pre>
<h4 data-id="heading-9">2. 注册组件</h4>
<p>在 <code>app.json</code> 中注册组件：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"novel-plugin"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"latest"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"wx293c4b6097a8a4d0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"genericsImplementation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"novel"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"charge-dialog"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"components/charge-dialog/charge-dialog"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-10">消息推送配置</h3>
<p>阅读器通过消息推送验证章节解锁状态，需要在服务器端配置消息接收：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 服务器接收消息示例</span>
{
  <span class="hljs-string">"ToUserName"</span>: <span class="hljs-string">"小程序原始ID"</span>,
  <span class="hljs-string">"FromUserName"</span>: <span class="hljs-string">"用户openid"</span>,
  <span class="hljs-string">"CreateTime"</span>: 时间戳,
  <span class="hljs-string">"MsgType"</span>: <span class="hljs-string">"event"</span>,
  <span class="hljs-string">"Event"</span>: <span class="hljs-string">"wxa_novel_chapter_permission"</span>,
  <span class="hljs-string">"BookId"</span>: <span class="hljs-string">"书籍ID"</span>,
  <span class="hljs-string">"ChapterIndex"</span>: 章节下标,
  <span class="hljs-string">"ChapterId"</span>: <span class="hljs-string">"章节ID"</span>,
  <span class="hljs-string">"Source"</span>: <span class="hljs-number">1</span> <span class="hljs-comment">// 1表示用户实际阅读</span>
}

<span class="hljs-comment">// 响应格式</span>
{
  <span class="hljs-string">"ErrCode"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"ErrMsg"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"ChapterPerms"</span>: [{
    <span class="hljs-string">"StartChapterIndex"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"EndChapterIndex"</span>: <span class="hljs-number">2</span>,
    <span class="hljs-string">"Perm"</span>: <span class="hljs-number">1</span> <span class="hljs-comment">// 0-免费 1-已解锁 2-未解锁</span>
  }]
}
</code></pre>
<h2 data-id="heading-11">高级功能</h2>
<h3 data-id="heading-12">1. 自定义解锁方式</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 设置不同的解锁方式</span>
novelManager.<span class="hljs-title function_">setChargeWay</span>({
  <span class="hljs-attr">globalConfig</span>: {
    <span class="hljs-attr">mode</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// 1:默认 2:广告解锁 3:自定义解锁</span>
    <span class="hljs-attr">buttonText</span>: <span class="hljs-string">"解锁"</span>
  },
  <span class="hljs-attr">chapterConfigs</span>: [
    {
      <span class="hljs-attr">chapterIndex</span>: <span class="hljs-number">10</span>,
      <span class="hljs-attr">mode</span>: <span class="hljs-number">3</span>,
      <span class="hljs-attr">buttonText</span>: <span class="hljs-string">"VIP解锁"</span>
    }
  ]
})

<span class="hljs-comment">// 监听自定义解锁事件</span>
novelManager.<span class="hljs-title function_">onUserClickCustomUnlock</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'自定义解锁章节：'</span>, res.<span class="hljs-property">chapterIndex</span>)
})
</code></pre>
<h3 data-id="heading-13">2. 插入自定义段落</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在正文中插入自定义内容</span>
novelManager.<span class="hljs-title function_">setParagraphBlock</span>({
  <span class="hljs-attr">chapterConfigs</span>: [{
    <span class="hljs-attr">chapterIndex</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">blocks</span>: [{
      <span class="hljs-attr">height</span>: <span class="hljs-number">100</span>,    <span class="hljs-comment">// 高度</span>
      <span class="hljs-attr">position</span>: <span class="hljs-number">1</span>,    <span class="hljs-comment">// 位置（0:标题前，1:第一段前）</span>
      <span class="hljs-attr">ext</span>: <span class="hljs-string">"自定义数据"</span>,
      <span class="hljs-attr">key</span>: <span class="hljs-string">"unique-id"</span>
    }]
  }]
})
</code></pre>
<h3 data-id="heading-14">3. 广告插入</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 插入广告</span>
novelManager.<span class="hljs-title function_">setAdBlock</span>({
  <span class="hljs-attr">chapterConfigs</span>: [{
    <span class="hljs-attr">chapterIndex</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">blocks</span>: [{
      <span class="hljs-attr">type</span>: <span class="hljs-number">1</span>,        <span class="hljs-comment">// 1:强制观看 2:banner广告 3:书签广告</span>
      <span class="hljs-attr">position</span>: <span class="hljs-number">10</span>,   <span class="hljs-comment">// 广告位置</span>
      <span class="hljs-attr">duration</span>: <span class="hljs-number">6</span>,    <span class="hljs-comment">// 强制观看时长（秒）</span>
      <span class="hljs-attr">unitId</span>: <span class="hljs-string">"广告单元ID"</span>
    }]
  }]
})
</code></pre>
<h2 data-id="heading-15">实用API参考</h2>
<h3 data-id="heading-16">获取阅读器信息</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取当前阅读器实例</span>
<span class="hljs-keyword">const</span> novelManager = novelPlugin.<span class="hljs-title function_">getCurrentNovelManager</span>()

<span class="hljs-comment">// 获取书籍ID</span>
<span class="hljs-keyword">const</span> bookId = novelManager.<span class="hljs-title function_">getBookId</span>()

<span class="hljs-comment">// 获取插件信息</span>
<span class="hljs-keyword">const</span> pluginInfo = novelManager.<span class="hljs-title function_">getPluginInfo</span>()
</code></pre>
<h3 data-id="heading-17">导航控制</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 设置关闭行为</span>
novelManager.<span class="hljs-title function_">setClosePluginInfo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/index'</span>,
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'redirectTo'</span>
})

<span class="hljs-comment">// 设置返回行为</span>
novelManager.<span class="hljs-title function_">setLeaveReaderInfo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/bookshelf/index'</span>,
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'switchTab'</span>
})
</code></pre>
<h3 data-id="heading-18">分享配置</h3>
<pre><code class="hljs language-javascript" lang="javascript">novelManager.<span class="hljs-title function_">setShareParams</span>({
  <span class="hljs-attr">title</span>: <span class="hljs-string">'书籍标题'</span>,
  <span class="hljs-attr">imageUrl</span>: <span class="hljs-string">'封面图片'</span>,
  <span class="hljs-attr">args</span>: {
    <span class="hljs-attr">from</span>: <span class="hljs-string">'share'</span>,
    <span class="hljs-attr">time</span>: <span class="hljs-string">'2024'</span>
  }
})
</code></pre>
<h3 data-id="heading-19">书架功能</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 设置书架状态</span>
novelManager.<span class="hljs-title function_">setBookshelfStatus</span>({
  <span class="hljs-attr">bookshelfStatus</span>: <span class="hljs-number">1</span> <span class="hljs-comment">// 0:未添加 1:已添加</span>
})

<span class="hljs-comment">// 监听书架点击</span>
novelManager.<span class="hljs-title function_">onClickBookshelf</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
  <span class="hljs-comment">// 处理书架逻辑</span>
  novelManager.<span class="hljs-title function_">setBookshelfStatus</span>({
    <span class="hljs-attr">bookshelfStatus</span>: res.<span class="hljs-property">bookshelfStatus</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>
  })
})
</code></pre>
<h2 data-id="heading-20">事件监听</h2>
<p>阅读器提供丰富的事件监听：</p>
<pre><code class="hljs language-javascript" lang="javascript">novelManager.<span class="hljs-title function_">onUserTriggerEvent</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
  <span class="hljs-keyword">switch</span>(res.<span class="hljs-property">event_id</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'start_read'</span>:          <span class="hljs-comment">// 开始阅读</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'change_chapter'</span>:      <span class="hljs-comment">// 切换章节</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'change_fontsize'</span>:     <span class="hljs-comment">// 调整字号</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'click_listen'</span>:        <span class="hljs-comment">// 点击听书</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'audio_start'</span>:         <span class="hljs-comment">// 音频开始</span>
    <span class="hljs-comment">// ... 更多事件</span>
  }
})
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[华为云 LTS 日志上报到观测云最佳实践]]></title>    <link>https://juejin.cn/post/7587738151660322816</link>    <guid>https://juejin.cn/post/7587738151660322816</guid>    <pubDate>2025-12-26T10:29:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587738151660322816" data-draft-id="7587808953076006912" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="华为云 LTS 日志上报到观测云最佳实践"/> <meta itemprop="keywords" content="数据分析"/> <meta itemprop="datePublished" content="2025-12-26T10:29:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            华为云 LTS 日志上报到观测云最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:29:58.000Z" title="Fri Dec 26 2025 10:29:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景与挑战</h2>
<p>在实际运维场景中，客户的业务系统部署在华为云，并使用了 ELB、GaussDB 等多种华为云产品。这些云产品的日志集中管理主要依赖华为云 LTS，但仅仅把日志存放在 LTS 中，难以实现：</p>
<ul>
<li>全链路观测（日志、指标、链路数据统一）</li>
<li>智能检索与告警（跨集群、跨应用的日志分析）</li>
<li>和业务指标结合的可视化与追踪</li>
</ul>
<p>观测云可以实现统一的全链路可观测，因此可以将 LTS 中的日志实时上报到观测云，实现日志与应用、基础设施、用户体验等一体化观测。</p>
<h2 data-id="heading-1">二、整体架构设计</h2>
<p>日志采集链路推荐架构如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5aee46189dbf416fae67062175f65e54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349798&amp;x-signature=TeYOGK76ROmRwCf9QI8wGEHg5tA%3D" alt="" loading="lazy"/></p>
<ul>
<li>LTS：负责日志收集与集中管理。</li>
<li>DMS Kafka：作为高可靠消息通道，实现日志实时转储与解耦。</li>
<li>DataKit Kafka Input：部署在客户侧（如弹性云服务器），负责消费 Kafka 中日志并发送到观测云。</li>
<li>观测云：统一日志检索、查询分析、仪表盘展示、智能告警。</li>
</ul>
<h2 data-id="heading-2">三、前置条件</h2>
<ul>
<li>在华为云上创建 DMS 和 LTS 服务</li>
<li>开通观测云账号</li>
<li>DataKit 机器一台</li>
</ul>
<h2 data-id="heading-3">四、配置步骤</h2>
<h3 data-id="heading-4">步骤 1：在 LTS 中开启日志转储</h3>
<p>我们可以通过很多种方式把日志输出至 LTS 服务，本文以 华为云ELB日志为例，配置 ELB日志存储至 LTS ，配置完成之后我们可以查看在 LTS 日志组中是否有日志产生。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f23a139a34a427ba6f254970aff9eb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349798&amp;x-signature=Rh%2BzMC%2FGlvCltq1FXpYPa33hlgM%3D" alt="" loading="lazy"/></p>
<p>1、登录华为云控制台 → LTS控制台。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2766a8891d842bc93226c087c47c3e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349798&amp;x-signature=%2BSsuUwYbGUouLHkIgOSyvbfO2MA%3D" alt="" loading="lazy"/></p>
<p>2、点击 “日志转储”。</p>
<p>3、配置转储目标：选择 DMS 作为转储对象，并设置实施转储，设置要转储的日志组和日志流名称，以及 DMS 实例和 topic。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cece2cdf2b2a417780b7247d903223e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349798&amp;x-signature=ZwysYYKIKHkwoD91oyT75v936ko%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">步骤 2：部署 DataKit</h3>
<p>在需要采集的环境中（如 ECS），安装 DataKit。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 需要把token 改成观测云空间的实际token值（可在观测云控制台--&gt;集成--&gt;Datakit 上面获取）</span>
<span class="hljs-attr">DK_DATAWAY</span>=<span class="hljs-string">"https://openway.guance.com?token=tkn_xxxxxx"</span> bash -c <span class="hljs-string">"$(curl -L https://static.guance.com/datakit/install.sh)"</span> 
</code></pre>
<h3 data-id="heading-6">步骤 3：开启 KafkaMQ 采集器</h3>
<p>进入 DataKit 安装目录下（默认是 <code>/usr/local/datakit/conf.d/</code> ）的 <code>conf.d/kafkamq</code> 目录，复制 <code>kafkamq.conf.sample</code> 并命名为 <code>kafkamq.conf</code>。类似如下：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-rwxr-xr-x 1 root root 2574 Apr 30 23:52 kafkamq.conf</span>
<span class="hljs-deletion">-rwxr-xr-x 1 root root 2579 May  1 00:40 kafkamq.conf.sample</span>
</code></pre>
<p>调整 kafkamq 采集器配置如下：</p>
<ul>
<li>
<p>addrs = ["192.168.0.106:9092"]。</p>
</li>
<li>
<p>kafka_version = "3.0.0"，该文使用 Kafka 的版本。</p>
</li>
<li>
<p>[inputs.kafkamq.custom]，删除注释符号“#”。</p>
</li>
<li>
<p>[inputs.kafkamq.custom.log_topic_map]，删除注释符号“#”。</p>
</li>
<li>
<p>"topic-30039942"="topicSLB.p"，topic-30039942 为 Topic 的名字，topicSLB.p为观测云 Pipeline 可编程数据处理器的日志字段提取规则配置。涉及的业务日志和 topicSLB.p 的内容详细见下面的《使用 Pipeline》。</p>
</li>
<li>
<p>其他一些配置说明：</p>
<ul>
<li>group_id = "datakit-group"：消费者组名称，相同组内消费者共享分区消费进度。不同消费者组可独立消费同一主题</li>
<li>assignor = "roundrobin"：分区轮询分配给消费者，​适合组内消费者订阅相同主题列表​，实现负载均衡</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># {"version": "1.81.1", "desc": "do NOT edit this line"}</span>

<span class="hljs-section">[[inputs.kafkamq]]</span>
  <span class="hljs-attr">addrs</span> = [<span class="hljs-string">"192.168.0.106:9092"</span>]
  <span class="hljs-comment"># your kafka version:0.8.2 ~ 3.2.0</span>
  <span class="hljs-attr">kafka_version</span> = <span class="hljs-string">"3.0.0"</span>
  <span class="hljs-attr">group_id</span> = <span class="hljs-string">"datakit-group"</span>
  <span class="hljs-comment"># consumer group partition assignment strategy (range, roundrobin, sticky)</span>
  <span class="hljs-attr">assignor</span> = <span class="hljs-string">"roundrobin"</span>

  <span class="hljs-comment">## rate limit.</span>
  <span class="hljs-comment">#limit_sec = 100</span>
  <span class="hljs-comment">## sample</span>
  <span class="hljs-comment"># sampling_rate = 1.0</span>

  <span class="hljs-comment">## kafka tls config</span>
  <span class="hljs-comment"># tls_enable = true</span>
  <span class="hljs-comment">## PLAINTEXT/SASL_SSL/SASL_PLAINTEXT</span>
  <span class="hljs-comment"># tls_security_protocol = "SASL_PLAINTEXT"</span>
  <span class="hljs-comment">## PLAIN/SCRAM-SHA-256/SCRAM-SHA-512/OAUTHBEARER,default is PLAIN.</span>
  <span class="hljs-comment"># tls_sasl_mechanism = "PLAIN"</span>
  <span class="hljs-comment"># tls_sasl_plain_username = "user"</span>
  <span class="hljs-comment"># tls_sasl_plain_password = "pw"</span>
  <span class="hljs-comment">## If tls_security_protocol is SASL_SSL, then ssl_cert must be configured.</span>
  <span class="hljs-comment"># ssl_cert = "/path/to/host.cert"</span>

  <span class="hljs-comment">## -1:Offset Newest, -2:Offset Oldest</span>
  <span class="hljs-attr">offsets</span>=-<span class="hljs-number">1</span>

  <span class="hljs-comment">## skywalking custom</span>
  <span class="hljs-comment">#[inputs.kafkamq.skywalking]</span>
  <span class="hljs-comment">## Required: send to datakit skywalking input.</span>
  <span class="hljs-comment">#  dk_endpoint="http://localhost:9529"</span>
  <span class="hljs-comment">#  thread = 8 </span>
  <span class="hljs-comment">#  topics = [</span>
  <span class="hljs-comment">#    "skywalking-metrics",</span>
  <span class="hljs-comment">#    "skywalking-profilings",</span>
  <span class="hljs-comment">#    "skywalking-segments",</span>
  <span class="hljs-comment">#    "skywalking-managements",</span>
  <span class="hljs-comment">#    "skywalking-meters",</span>
  <span class="hljs-comment">#    "skywalking-logging",</span>
  <span class="hljs-comment">#  ]</span>
  <span class="hljs-comment">#  namespace = ""</span>

  <span class="hljs-comment">## Jaeger from kafka. Please make sure your Datakit Jaeger collector is open!</span>
  <span class="hljs-comment">#[inputs.kafkamq.jaeger]</span>
  <span class="hljs-comment">## Required: ipv6 is "[::1]:9529"</span>
  <span class="hljs-comment">#  dk_endpoint="http://localhost:9529"</span>
  <span class="hljs-comment">#  thread = 8 </span>
  <span class="hljs-comment">#  source: agent,otel,others...</span>
  <span class="hljs-comment">#  source = "agent"</span>
  <span class="hljs-comment">#  # Required: topics</span>
  <span class="hljs-comment">#  topics=["jaeger-spans","jaeger-my-spans"]</span>

  <span class="hljs-comment">## user custom message with PL script.</span>
  <span class="hljs-section">[inputs.kafkamq.custom]</span>
    <span class="hljs-comment">#spilt_json_body = true</span>
    <span class="hljs-comment">#thread = 8</span>
    <span class="hljs-comment">#storage_index = "" # <span class="hljs-doctag">NOTE:</span> only working on logging collection</span>

    <span class="hljs-comment">## spilt_topic_map determines whether to enable log splitting for specific topic based on the values in the spilt_topic_map[topic].</span>
    <span class="hljs-comment">#[inputs.kafkamq.custom.spilt_topic_map]</span>
    <span class="hljs-comment">#  "log_topic"=true</span>
    <span class="hljs-comment">#  "log01"=false</span>
    <span class="hljs-section">[inputs.kafkamq.custom.log_topic_map]</span>
      <span class="hljs-attr">"topic-30039942"</span>=<span class="hljs-string">"topicSLB.p"</span>
    <span class="hljs-comment">#  "log01"="log_01.p"</span>
    <span class="hljs-comment">#[inputs.kafkamq.custom.metric_topic_map]</span>
    <span class="hljs-comment">#  "metric_topic"="metric.p"</span>
    <span class="hljs-comment">#  "metric01"="rum_apm.p"</span>
    <span class="hljs-comment">#[inputs.kafkamq.custom.rum_topic_map]</span>
    <span class="hljs-comment">#  "rum_topic"="rum_01.p"</span>
    <span class="hljs-comment">#  "rum_02"="rum_02.p"</span>

  <span class="hljs-comment">#[inputs.kafkamq.remote_handle]</span>
    <span class="hljs-comment">## Required</span>
    <span class="hljs-comment">#endpoint="http://localhost:8080"</span>
    <span class="hljs-comment">## Required topics</span>
    <span class="hljs-comment">#topics=["spans","my-spans"]</span>
    <span class="hljs-comment"># send_message_count = 100</span>
    <span class="hljs-comment"># debug = false</span>
    <span class="hljs-comment"># is_response_point = true</span>
    <span class="hljs-comment"># header_check = false</span>
  
  <span class="hljs-comment">## Receive and consume OTEL data from kafka.</span>
  <span class="hljs-comment">#[inputs.kafkamq.otel]</span>
    <span class="hljs-comment">#dk_endpoint="http://localhost:9529"</span>
    <span class="hljs-comment">#trace_api="/otel/v1/traces"</span>
    <span class="hljs-comment">#metric_api="/otel/v1/metrics"</span>
    <span class="hljs-comment">#trace_topics=["trace1","trace2"]</span>
    <span class="hljs-comment">#metric_topics=["otel-metric","otel-metric1"]</span>
    <span class="hljs-comment">#thread = 8 </span>

  <span class="hljs-comment">## <span class="hljs-doctag">todo:</span> add other input-mq</span>
</code></pre>
<h3 data-id="heading-7">步骤 4：重启 DataKit 生效</h3>
<pre><code class="hljs">datakit service -R
</code></pre>
<h3 data-id="heading-8">步骤 5：在观测云验证日志接入</h3>
<p>1、登录观测云控制台 → 日志查看器 ，可以看到相关日志已经被采集到了观测云。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d914f9acc07434aaef96d3c6bcd21c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349798&amp;x-signature=nhajOZA6B%2FjTXai%2BaNJqQzY4MOY%3D" alt="" loading="lazy"/></p>
<p>2、日志文本的字段已经被提取。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad6c9fa96b1e4b909949b7d0a479f2ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349798&amp;x-signature=KiHQNF1P6RRd%2BfMb4361BhtYYoI%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[程序员约会指南：从代码到爱情的完美编译]]></title>    <link>https://juejin.cn/post/7587740546955132968</link>    <guid>https://juejin.cn/post/7587740546955132968</guid>    <pubDate>2025-12-26T11:02:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587740546955132968" data-draft-id="7587743345197826100" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="程序员约会指南：从代码到爱情的完美编译"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-26T11:02:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="土豆1250"/> <meta itemprop="url" content="https://juejin.cn/user/3280598428302727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            程序员约会指南：从代码到爱情的完美编译
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598428302727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    土豆1250
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T11:02:32.000Z" title="Fri Dec 26 2025 11:02:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：为什么你需要这份指南</h2>
<p>「哎呀，我今天又写了2000行代码，但还是不知道怎么跟喜欢的女孩子说话。」</p>
<p>如果你是一个程序员，如果你曾在深夜加班后对着屏幕发呆，如果你曾在电梯里偶遇心仪的女孩子却只憋出一句「今天的天气不错」，那么这篇文章就是为你准备的。</p>
<p>我们程序员群体有着独特的优势：我们逻辑清晰、解决问题能力强、收入稳定、对待感情专一。但我们也有明显的短板：社交圈有限、表达方式过于直接、缺乏浪漫细胞、在喜欢的人面前容易紧张。</p>
<p>这篇指南将帮助你从一个「代码诗人」转变为「爱情工程师」，掌握在特殊节日将心仪女生约出来的艺术，并给予她完美的约会体验。让我们开始这场爱情的编译之旅吧！</p>
<hr/>
<h2 data-id="heading-1">第一章：为什么程序员在爱情市场上其实是被低估的潜力股</h2>
<h3 data-id="heading-2">1.1 程序员的隐藏优势</h3>
<p>在当今这个「代码改变世界」的时代，程序员其实拥有许多其他职业无法比拟的择偶优势，只是我们大多数人没有意识到而已。</p>
<p><strong>专注力是最强的魅力武器。</strong> 当你沉浸在解决一个复杂的算法问题时那种专注的眼神，在喜欢你的人眼中简直魅力四射。想象一下，当你认真调试代码时那种「世界与我无关」的专注状态，这种专注力一旦转移到女孩子身上，会让她感受到被重视、被认真对待的感觉。</p>
<p><strong>解决问题的能力是情感关系的核心竞争力。</strong> 恋爱中会遇到各种问题：如何理解女生的潜台词、如何安排好一次约会、如何处理矛盾和分歧。这些问题对你来说太简单了，因为你每天都在解决远比这复杂得多的技术难题。你需要做的只是把「debug的心态」应用到「debug感情」上。</p>
<p><strong>稳定的收入和职业发展让你有足够的底气。</strong> 在这个物质与精神并重的时代，经济基础决定上层建筑这句老话依然适用。程序员通常拥有稳定且可观的收入，这意味着你可以给喜欢的女孩子提供一个安稳的未来预期，这本身就是一种巨大的吸引力。</p>
<h3 data-id="heading-3">1.2 为什么你至今还是单身</h3>
<p>让我们诚实地面对这个问题。程序员群体脱单困难，往往不是因为缺乏魅力，而是以下几个原因：</p>
<p><strong>社交圈极度封闭。</strong> 你的日常可能是：家 → 公司 → 家。偶尔去趟便利店已经算是「社交活动」了。你的社交圈里可能只有产品经理、UI设计师和测试工程师，而这些人中单身的异性少之又少。</p>
<p><strong>过于习惯用逻辑思考问题。</strong> 当女孩子说「我今天心情不好」，你可能会直接问「为什么？是什么bug导致的？」而她期待的只是一个拥抱或者一句「怎么了宝贝」。感情不是代码，不能总是追求「最优解」。</p>
<p><strong>缺乏浪漫细胞。</strong> 你可能会用写代码的方式写情书：「我爱你，就像for循环一样永无止境。」这在技术上是正确的，但在情感上是灾难性的。</p>
<hr/>
<h2 data-id="heading-4">第二章：什么是完美的节日约会</h2>
<h3 data-id="heading-5">2.1 理解「完美约会」的本质</h3>
<p>在开始策划约会之前，我们必须先搞清楚一个问题：什么才是「完美的约会」？</p>
<p><strong>完美约会不是米其林餐厅的烛光晚餐，也不是马尔代夫的海岛度假。</strong> 完美约会是一种「被理解」和「被重视」的感觉。它取决于你对她有多少了解，你为这次约会投入了多少心思，以及你们在一起时是否感到舒适和开心。</p>
<p>一个简单的例子：如果你喜欢的女孩子告诉你她小时候每次路过一家蛋糕店都会驻足观看，那么在她生日那天，你排队两小时买下那家店的蛋糕带给她，这远比你在五星级酒店预订法餐更能打动她的心。</p>
<h3 data-id="heading-6">2.2 节日约会的特殊意义</h3>
<p>为什么我们如此强调「特殊的节日」？因为节日为你的追求提供了一个天然的契机和合理的借口。</p>
<p><strong>节日降低了邀约的心理门槛。</strong> 平时约她出来，你需要一个正式的理由：「我想请你吃个饭」「我想请你去看个电影」。但在情人节、七夕、圣诞节这些节日，你的邀约可以变得非常自然：「圣诞节约会吗？」「七夕有人一起过吗？」这让她更容易接受，因为你在「应节」而非「单独约她」。</p>
<p><strong>节日创造了独特的记忆锚点。</strong> 人类的大脑对特殊日期有着天然的敏感度。「我们第一次约会就是在七夕」这个记忆会伴随她很久，每次到七夕这个节日，她都会想起你。</p>
<p><strong>节日放大了情绪体验。</strong> 节日本身就带有愉悦、温馨、浪漫的氛围，在这个背景下，约会的体验会被放大。同样的晚餐，在普通日子吃可能只是「不错」，在情人节吃就变成了「浪漫」。</p>
<hr/>
<h2 data-id="heading-7">第三章：如何一步步将理论编译为实践</h2>
<h3 data-id="heading-8">3.1 第一阶段：前期准备（约会前30天）</h3>
<p><strong>建立足够的信息基础。</strong> 在你考虑约她出来之前，你需要对她有足够的了解。这些信息包括但不限于：</p>
<p>她的口味偏好（甜咸辣？中餐还是西餐？有没有什么过敏或者忌口？）、她的娱乐偏好（喜欢看电影还是看展？喜欢户外还是室内？）、她的社交风格（喜欢热闹的约会还是安静的二人世界？）、她的消费观念（注重性价比还是更看重体验？）。</p>
<p>获取这些信息的渠道包括：朋友圈（但不要表现得像在窥探）、日常聊天（自然而然地聊到）、共同朋友的透露，以及你的细致观察。</p>
<p><strong>建立稳定的沟通频率。</strong> 在正式邀约之前，你需要确保你们之间已经建立了一定的熟悉度。建议的节奏是：每隔两到三天聊一次天，每次聊天时长在20分钟左右。聊天的内容应该是轻松的、有趣的、互相了解的，而不是查户口式的提问。</p>
<p><strong>选择合适的节日。</strong> 不是所有的节日都适合第一次约会。优先选择那些带有浪漫属性但又不会让人感到过度压力的节日。</p>
<p>第一梯队：情人节、七夕、圣诞（浪漫属性强，适合表白或确定关系后的约会）</p>
<p>第二梯队：520、白色情人节、跨年夜（有一定的浪漫属性，可以作为普通约会的契机）</p>
<p>第三梯队：女生生日、认识100天纪念日（属于你们专属的特殊日子，意义重大）</p>
<h3 data-id="heading-9">3.2 第二阶段：邀约的艺术（约会前7天）</h3>
<p><strong>时机选择。</strong> 邀约的时机非常重要。太早提出会让她有太长的准备时间，期间可能变卦；太晚提出会显得你没有诚意。一般建议在约会前3-7天提出邀约。</p>
<p><strong>话术设计。</strong> 邀约的话术需要自然、不带压力、给她留有拒绝的余地。以下是几个参考模板：</p>
<p>直接型：「七夕那天有空吗？要不一起吃个饭？」</p>
<p>悬念型：「我最近发现一家很不错的餐厅，想找个懂吃的朋友一起去，你七夕有空吗？」</p>
<p>趣味型：「七夕又要到了，单身狗们准备互相取暖了，你要不要跟我凑个伴？」</p>
<p><strong>Plan B的重要性。</strong> 你的邀约应该有Plan B。如果她说那天已经有安排了，你可以说：「没关系，那周末可以吗？我知道有一家店很想试一下。」如果她连续两次拒绝，那可能是对你没兴趣，这时候你应该知难而退，而不是穷追猛打。</p>
<h3 data-id="heading-10">3.3 第三阶段：完美约会的执行（约会当天）</h3>
<p><strong>时间安排的原则。</strong></p>
<p>建议的约会时长是3-5小时，太短不够深入了解，太长双方都会疲惫。</p>
<p>流程建议：下午或傍晚开始 → 一起吃晚餐 → 餐后活动（散步、咖啡厅、看电影等） → 送她回家。</p>
<p>每个环节之间要预留足够的缓冲时间，不要把行程安排得太紧凑。计划赶不上变化是约会永恒的真理。</p>
<p><strong>第一餐的选址逻辑。</strong></p>
<p>第一次约会的餐厅选择至关重要，它基本上决定了这次约会的基调。以下是几条铁律：</p>
<p>选择中等偏上价位的餐厅。太便宜显得你小气，太贵给她压力。最好的人均消费区间是：她月收入的0.5%-1%。</p>
<p>选择环境安静、适合交谈的餐厅。音乐震天响的夜店、完全拼桌的网红餐厅，这些地方都不适合第一次约会。</p>
<p>选择你有一定了解、不会踩雷的餐厅。第一次约会不要当小白鼠去尝试新店，去你验证过的、安全的餐厅。</p>
<p><strong>餐桌上如何聊天。</strong></p>
<p>聊天是约会的核心环节。很多程序员在这里会陷入两个极端：要么全程沉默不知道说什么，要么一直说技术术语让对方昏昏欲睡。</p>
<p>正确的聊天方式应该是：30%聊她，30%聊你，40%聊有趣的话题。</p>
<p>具体操作：多问开放式问题（「你平时周末都干嘛？」比「你喜欢看电影吗？」好）、认真倾听并给予反馈（记住她说的细节，后面可以提起）、适度展示自己（分享你的有趣经历、你的爱好）、不要打断她、不要过早评价她的观点。</p>
<p><strong>约会中的加分细节。</strong></p>
<p>准时到达，甚至提前10分钟到达。准时是最基本的尊重。</p>
<p>主动帮她拉椅子、倒水、拿包（如果她愿意让你拿的话）。</p>
<p>点菜时先问她的意见，然后你来决定。如果她让你点，你可以点几个招牌菜，再让她点一道她想吃的。</p>
<p>吃饭时不要一直看手机。如果有必要处理的事情，道歉并快速处理。</p>
<p>适时夸赞她，但要具体。「你今天真好看」不如「你今天的耳环很适合你，很显气质」。</p>
<p><strong>餐后活动的选择。</strong></p>
<p>晚餐之后的时间怎么安排？以下几个选项比较稳妥：</p>
<p>散步聊天：成本最低，但需要你有足够的聊天能力。在夜色中散步聊天是很浪漫的选择。</p>
<p>咖啡厅：找一个有氛围的咖啡厅，继续聊天或者一起玩点小游戏。</p>
<p>看电影：选择一部口碑好的电影，看完电影后可以讨论剧情。但电影院没法聊天，所以这部电影最好是她感兴趣的类型。</p>
<p>密室逃脱/剧本杀：如果她喜欢这类游戏，这是很好的选择，因为过程中有很多互动和交流。</p>
<h3 data-id="heading-11">3.4 第四阶段：约会后的收尾</h3>
<p><strong>送她回家。</strong> 约会结束后，主动提出送她回家。如果她说不用，你可以说「没事，我顺路」或者「太晚了不安全，我还是送你吧」。如果她坚持不用，那就尊重她的选择。</p>
<p><strong>到家后发消息。</strong> 她到家后，你可以发一条消息：「今天很开心，早点休息哦。」简短、得体、不纠缠。</p>
<p><strong>后续联系。</strong> 约会后的一到两天内，继续找她聊天，延续约会的好气氛。可以提一下约会中发生的趣事，或者问她那天拍的照片好不好看。</p>
<hr/>
<h2 data-id="heading-12">第四章：常见问题与应对策略</h2>
<h3 data-id="heading-13">4.1 紧张怎么办</h3>
<p>紧张是正常的，即使是情场老手面对喜欢的人也会紧张。几个缓解紧张的方法：</p>
<p>深呼吸，进入约会场所前深呼吸三次。</p>
<p>把约会当成一次技术交流，你只是在「面试」一个潜在的「合作伙伴」。</p>
<p>适当的紧张是好事，它会让你更专注、表现更好。</p>
<h3 data-id="heading-14">4.2 冷场怎么办</h3>
<p>冷场是约会中常见的情况，处理方式包括：</p>
<p>「我突然想到一个事」（转移话题）</p>
<p>「你看过那个电影吗？我最近在纠结要不要看」（抛出一个她可能有兴趣的话题）</p>
<p>「这家餐厅你觉得怎么样？」（回归当下）</p>
<p>承认冷场：「哎，我好像有点紧张，你呢？」真诚往往比硬撑更打动人。</p>
<h3 data-id="heading-15">4.3 她拒绝了怎么办</h3>
<p>被拒绝是正常的，也是约会的一部分。几种情况：</p>
<p>「那天没空」：说明她可能对你有兴趣，只是时间不合适。你可以提议其他时间。</p>
<p>「我不太方便」：礼貌但坚定的拒绝。这时候你应该退出，不要继续纠缠。</p>
<p>「我们还是当朋友吧」：明确的拒绝。接受这个结果，保持尊重，但减少联系频率。</p>
<p>记住：被拒绝不代表你不够好，只代表你们不合适。世界上有那么多女孩子，总有一个会欣赏你。</p>
<hr/>
<h2 data-id="heading-16">第五章：程序员的独特约会优势</h2>
<h3 data-id="heading-17">5.1 用技术思维优化约会体验</h3>
<p>我们程序员最擅长的就是优化。试着把约会当作一个「系统」来优化：</p>
<p>建立约会SOP（标准作业程序）：把成功的约会经验固化为可复用的流程。</p>
<p>进行A/B测试：这次约饭选择日料，下次约饭选择法餐，看哪个反馈更好。</p>
<p>收集数据：每次约会后记录哪些环节她表现得很开心，哪些环节她兴趣不高。</p>
<h3 data-id="heading-18">5.2 创造属于程序员的独特浪漫</h3>
<p>不要试图成为别人，发挥你作为程序员独特的浪漫：</p>
<p>写一个专属的小程序给她，在她生日那天展示。</p>
<p>用GitHub贡献图的方式记录你们的「感情进度」。</p>
<p>教她编程入门知识，让她在学习中对你产生崇拜。</p>
<p>在跨年夜给她展示你写的一个小动画或者小游戏。</p>
<hr/>
<h2 data-id="heading-19">结语：爱情也是一门需要不断迭代的技术</h2>
<p>恋爱就像编程：你不可能一次写出完美的代码，你需要不断测试、不断debug、不断优化。</p>
<p>第一次约会紧张说错话？没关系，这是你收集到的「异常数据」，下次避免类似的错误。</p>
<p>约会被拒绝了？没关系，这是你排除了一种「不兼容的情况」。</p>
<p>成功了？恭喜你，这是你代码通过测试可以上线了。</p>
<p>无论结果如何，这个过程本身就是一种成长和收获。技术能力可以通过学习提升，情场能力同样可以。</p>
<p>最后，记住一点：真诚是最强的代码。所有的技巧都只是工具，真正能打动一个人的，永远是你对她的真心实意。</p>
<p>祝你编译成功，运行顺畅，爱情永无bug。</p>
<hr/>
<p><em>「世界上只有两种编程语言：一种是被人吐槽的，一种是没人用的。同样，世界上只有两种人：一种是被拒绝的，一种是还没去表白的。所以，别犹豫了，勇敢地敲下那行'约会申请'的代码吧！」</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[刨根问底栏目组 - 学习 Zustand 的广播哲学]]></title>    <link>https://juejin.cn/post/7587965908287946762</link>    <guid>https://juejin.cn/post/7587965908287946762</guid>    <pubDate>2025-12-26T08:58:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587965908287946762" data-draft-id="7587965800272396314" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="刨根问底栏目组 - 学习 Zustand 的广播哲学"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-26T08:58:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="清风乐鸣"/> <meta itemprop="url" content="https://juejin.cn/user/4300945220723917"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            刨根问底栏目组 - 学习 Zustand 的广播哲学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4300945220723917/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    清风乐鸣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T08:58:44.000Z" title="Fri Dec 26 2025 08:58:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>在前端状态管理的学习中，我们经常听到“发布订阅模式”、“观察者模式”等术语。本文将从一次意外的“无限循环”报错开始，通过对比 EventBus 和 Zustand 的底层差异，深入剖析 Zustand 那个简单却精妙的广播机制。</p>
<h2 data-id="heading-0">一、 引子：一次意想不到的死循环</h2>
<p>故事始于一行看似无害的代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 😱 导致报错的代码</span>
<span class="hljs-keyword">const</span> obj = <span class="hljs-title function_">useMyStore</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: s.<span class="hljs-property">count</span>, <span class="hljs-attr">text</span>: s.<span class="hljs-property">text</span> }), shallowEqual);
</code></pre>
<p><strong>现象</strong>：页面报错 <code>Maximum update depth exceeded</code>。</p>
<p><strong>原因</strong>：</p>
<p>React 的 <code>useSyncExternalStore</code> 依赖 <strong>引用稳定性</strong> 来判断是否停止更新。</p>
<p>当 Selector 返回一个新对象 <code>{ ... }</code> 时，即使内容没变，引用的内存地址也变了。React 认为状态变了 - 重新渲染 - 再次调用 selector 生成新对象 - 再次认为变了 - <strong>死循环</strong>。</p>
<p>这引出了我们的第一个思考：<strong>Zustand 的通知机制到底有多“傻”？它为什么不帮我过滤掉这些没用的更新？</strong></p>
<hr/>
<h2 data-id="heading-1">二、 广播的两种流派：EventBus vs Zustand</h2>
<p>为了理解 Zustand 的行为，我们需要把它和我们熟悉的 EventBus（事件总线）做一个对比。</p>
<h3 data-id="heading-2">1. EventBus：精准投递的“广播站”</h3>
<p>EventBus 的核心数据结构通常是 <strong>Map</strong>。</p>
<ul>
<li>
<p><strong>结构</strong>：<code>Map&lt;EventName, Array&lt;Callback&gt;&gt;</code></p>
</li>
<li>
<p><strong>哲学</strong>：<strong>分频道</strong>。</p>
</li>
<li>
<p><strong>场景</strong>：动作驱动（Action-driven）。比如“点击保存”、“请求失败”。</p>
</li>
<li>
<p><strong>流程</strong>：</p>
</li>
</ul>
<ol>
<li>
<p><strong>订阅</strong>：<code>key = 'login_success'</code>，把我加到这个 key 的列表里。</p>
</li>
<li>
<p><strong>查找</strong>：触发时，先通过 key 去 Map 里查表。</p>
</li>
<li>
<p><strong>执行</strong>：只通知关注这个 key 的人。</p>
</li>
</ol>
<h3 data-id="heading-3">2. Zustand：全员广播的“班级黑板”</h3>
<p>Zustand 的核心数据结构是 <strong>Set</strong>。</p>
<ul>
<li>
<p><strong>结构</strong>：<code>Set&lt;Callback&gt;</code></p>
</li>
<li>
<p><strong>哲学</strong>：<strong>单一信源（Single Source of Truth）</strong>。</p>
</li>
<li>
<p><strong>场景</strong>：数据驱动（Data-driven）。比如“用户信息更新”、“计数器变化”。</p>
</li>
<li>
<p><strong>流程</strong>：</p>
</li>
</ul>
<ol>
<li>
<p><strong>订阅</strong>：不管你关心啥，先把你的名字加到名单里。</p>
</li>
<li>
<p><strong>查找</strong>：<strong>不需要查找</strong>。</p>
</li>
<li>
<p><strong>执行</strong>：数据一变，直接遍历 Set，通知<strong>所有人</strong>。</p>
</li>
</ol>
<p><strong>关键区别</strong>：</p>
<blockquote>
<p><strong>Map 天然贴合“频道”区分（KV结构），而 Set 天然贴合 forEach 循环（集合结构）。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-4">三、 深入虎穴：Zustand 是如何“追加监听”的？</h2>
<p>我们可以剥离 React，用纯 JS 还原 Zustand 在 <code>subscribe</code> 时做的事情。它就像一个负责的邮局。</p>
<h3 data-id="heading-5">模拟实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 这是一个极其迷你的 Store</span>
<span class="hljs-keyword">const</span> store = {
  <span class="hljs-comment">// 这是那个名单本子 (Set)</span>
  <span class="hljs-attr">listeners</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),

  <span class="hljs-comment">// ✨重点在这里：订阅函数✨</span>
  <span class="hljs-attr">subscribe</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) {
    <span class="hljs-comment">// 动作：把你传进来的函数（联系方式），加到本子上</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">add</span>(callback);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ 成功追加一个监听！现在名单里有 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.listeners.size}</span> 个人。`</span>);
    
    <span class="hljs-comment">// 返回一个函数，用来取消订阅（以后再说）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">delete</span>(callback);
  },

  <span class="hljs-comment">// 假装数据变了，通知大家</span>
  <span class="hljs-attr">setState</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"📢 只有一件事：数据变了！开始挨个通知..."</span>);
    <span class="hljs-comment">// 遍历 Set，执行每个函数</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">run</span> =&gt;</span> <span class="hljs-title function_">run</span>());
  }
};

<span class="hljs-comment">// ==========================================</span>
<span class="hljs-comment">// 场景开始：两个“组件”来订阅了</span>
<span class="hljs-comment">// ==========================================</span>

<span class="hljs-comment">// 模拟组件 A（比如是页面顶部的 Header）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">componentA_Update</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"   -&gt; 组件A收到通知：我要检查下用户名变没变"</span>);

<span class="hljs-comment">// 模拟组件 B（比如是页面底部的 Footer）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">componentB_Update</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"   -&gt; 组件B收到通知：我要检查下版权年份变没变"</span>);

<span class="hljs-comment">// 动作 1：组件 A 出生了，请求订阅</span>
store.<span class="hljs-title function_">subscribe</span>(componentA_Update);
<span class="hljs-comment">// 👉 结果：Set 内部现在是 { componentA_Update }</span>

<span class="hljs-comment">// 动作 2：组件 B 出生了，请求订阅</span>
store.<span class="hljs-title function_">subscribe</span>(componentB_Update);
<span class="hljs-comment">// 👉 结果：Set 内部现在是 { componentA_Update, componentB_Update }</span>

<span class="hljs-comment">// ==========================================</span>
<span class="hljs-comment">// 动作 3：数据变了！</span>
<span class="hljs-comment">// ==========================================</span>
store.<span class="hljs-title function_">setState</span>();
</code></pre>
<p>当你调用 <code>store.subscribe(fn)</code> 时，Zustand 真的只是简单地把 <code>fn</code> 扔进了那个 <code>Set</code> 里。如果有 100 个组件订阅，<code>Set</code> 里就有 100 个函数。</p>
<hr/>
<h2 data-id="heading-6">四、 React 是何时介入的？</h2>
<p>你可能会问：“我写组件时只用了 hooks，没写 subscribe 啊？”</p>
<p>答案是：<strong>Hooks 帮你做了脏活累活。</strong></p>
<p>当你在组件中使用 <code>useStore</code> 时，幕后发生的过程如下：</p>
<ol>
<li>
<p><strong>组件挂载 (Mount)</strong>：组件初始化。</p>
</li>
<li>
<p><strong>自动连线</strong>：React 的 <code>useSyncExternalStore</code> 内部会自动创建一个 <code>forceUpdate</code> 函数，并调用 <code>store.subscribe(forceUpdate)</code>。</p>
</li>
<li>
<p><strong>登记在册</strong>：此时，Store 的 <code>Set</code> 里多了一个属于该组件的监听器。</p>
</li>
</ol>
<h3 data-id="heading-7"><code>useSyncExternalStore</code>内部到底干了啥</h3>
<p><strong>作用</strong>：安全地将React组件链接到外部状态管理库（如Redux、Zustand、浏览器storage），解决并发渲染下的撕裂问题</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useSyncExternalStore</span>(<span class="hljs-params">subscribe, getSnapshot</span>) {
  <span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(<span class="hljs-title function_">getSnapshot</span>());
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleStoreChange</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-title function_">setState</span>(<span class="hljs-title function_">getSnapshot</span>());
    };
    
    <span class="hljs-comment">// 1. 订阅状态变化（返回清理函数）</span>
    <span class="hljs-keyword">const</span> unsubscribe = <span class="hljs-title function_">subscribe</span>(handleStoreChange);
    
    <span class="hljs-comment">// 2. 返回清理函数（组件卸载时执行）</span>
    <span class="hljs-keyword">return</span> unsubscribe;
  }, [subscribe, getSnapshot]);

  <span class="hljs-keyword">return</span> state;
}
</code></pre>
<p>可见，当我们在组件内部调用useStore时，其内部的useSyncExternalStore方法已经自动为我们完成了注册和订阅的过程。</p>
<h3 data-id="heading-8">通知的过程（为什么死循环发生在这里）</h3>
<p>当 <code>store.setState</code> 发生时：</p>
<ol>
<li>
<p><strong>Zustand</strong>：遍历 <code>Set</code>，触发所有组件的检查函数。</p>
</li>
<li>
<p><strong>React (检查函数)</strong>：运行你的 Selector <code>s =&gt; ({ ... })</code>。</p>
</li>
<li>
<p><strong>比对</strong>：</p>
</li>
</ol>
<ul>
<li>
<p><strong>旧值</strong>：上一次渲染时的对象。</p>
</li>
<li>
<p><strong>新值</strong>：Selector 刚刚生成的<strong>新对象</strong>。</p>
</li>
</ul>
<ol start="4">
<li><strong>悲剧发生</strong>：如果是引用比较，<code>新对象 !== 旧对象</code>，React 判定必须更新。组件重新渲染 -&gt; 再次生成新对象 -&gt; 再次更新 -&gt; <strong>Loop</strong>。</li>
</ol>
<hr/>
<h2 data-id="heading-9">五、 总结：大智若愚的广播哲学</h2>
<p>Zustand 的设计哲学可以总结为：<strong>“大喇叭通知 + 此时无声胜有声”</strong>。</p>
<ul>
<li>
<p><strong>Store (发布者)</strong>：我很懒，我不知道你们谁关心 <code>count</code>，谁关心 <code>name</code>。反正数据变了，我就喊一声“变天啦！”。</p>
</li>
<li>
<p><strong>Component (订阅者)</strong>：我很勤快。听到“变天啦”之后，我先拿 Selector 看看“我看的那块云彩”变没变。如果没变，我就接着睡；如果变了，我才起床干活。</p>
</li>
</ul>
<p>这种机制看似“粗暴”，实则<strong>解耦</strong>。Store 不再维护复杂的事件映射关系，而是把“过滤”的权力下放给了每个组件（Selector）。这就是为什么 Selector 的稳定性（如使用 <code>shallowEqual</code> 或缓存）如此重要的原因。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当 Web Worker 遇上异步，如何突破单线程限制？]]></title>    <link>https://juejin.cn/post/7587998744294064134</link>    <guid>https://juejin.cn/post/7587998744294064134</guid>    <pubDate>2025-12-26T08:46:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587998744294064134" data-draft-id="7587785079739219974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当 Web Worker 遇上异步，如何突破单线程限制？"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-26T08:46:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="敲代码的独角兽"/> <meta itemprop="url" content="https://juejin.cn/user/729731452897246"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当 Web Worker 遇上异步，如何突破单线程限制？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731452897246/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    敲代码的独角兽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T08:46:30.000Z" title="Fri Dec 26 2025 08:46:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当你的前端应用需要处理100MB的CSV数据时，页面突然卡死，控制台弹出"长时间运行的脚本"警告；当实时视频分析导致动画帧率骤降至5FPS，用户开始疯狂点击无响应的按钮——这些场景都在尖叫同一个问题：<strong>JavaScript的单线程模型正在成为现代应用的性能瓶颈</strong>。本文将深入探讨如何通过Web Worker与异步编程的深度结合，构建真正流畅的前端体验。</p>
<hr/>
<h3 data-id="heading-0">一、单线程的困境：前端性能瓶颈的根源</h3>
<p>JavaScript的事件循环在处理I/O密集型任务时表现出色，但在CPU密集型场景下面临根本性限制：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 阻塞主线程的典型场景：大型数据处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processHugeData</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'主线程处理'</span>);
  <span class="hljs-keyword">const</span> result = [];
  
  <span class="hljs-comment">// 模拟100万条数据的复杂计算</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
    result.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">id</span>: i,
      <span class="hljs-attr">value</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(data[i] * <span class="hljs-number">1.5</span>) + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(i * <span class="hljs-number">0.01</span>),
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    });
  }
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'主线程处理'</span>);
  <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 在主线程执行导致UI冻结</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'process-btn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> fakeData = <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">42</span>);
  <span class="hljs-keyword">const</span> output = <span class="hljs-title function_">processHugeData</span>(fakeData); <span class="hljs-comment">// 页面完全卡死约2.3秒</span>
  <span class="hljs-title function_">renderResults</span>(output);
});
</code></pre>
<p><strong>性能火焰图分析</strong>（Chrome DevTools Performance面板）：</p>
<ul>
<li>主线程被长时间占用，UI渲染完全停滞</li>
<li>60FPS动画帧率暴跌至3-5FPS</li>
<li>用户交互事件（点击、滚动）被延迟处理</li>
</ul>
<blockquote>
<p><strong>关键洞察</strong>：传统异步模式（setTimeout/Promise）只能解决I/O等待问题，无法释放CPU密集型任务对主线程的占用。突破点在于<strong>真正的并行计算</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">二、Web Worker 基础：多线程架构的核心机制</h3>
<p>Web Worker通过创建独立线程实现真正的并行处理，其核心在于严格的线程隔离：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js - 主线程</span>
<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'worker.js'</span>, { 
  <span class="hljs-attr">type</span>: <span class="hljs-string">'module'</span>, <span class="hljs-comment">// 支持ES模块</span>
  <span class="hljs-attr">credentials</span>: <span class="hljs-string">'same-origin'</span> <span class="hljs-comment">// 同源策略限制</span>
});

worker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到来自Worker的数据:'</span>, event.<span class="hljs-property">data</span>);
  <span class="hljs-title function_">updateUI</span>(event.<span class="hljs-property">data</span>);
};

worker.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Worker错误 [行:<span class="hljs-subst">${error.lineno}</span>]`</span>, error.<span class="hljs-property">message</span>);
  <span class="hljs-title function_">showWorkerCrashModal</span>();
};

<span class="hljs-comment">// 传递数据（自动序列化）</span>
worker.<span class="hljs-title function_">postMessage</span>({
  <span class="hljs-attr">action</span>: <span class="hljs-string">'processData'</span>,
  <span class="hljs-attr">payload</span>: hugeDataset
});

<span class="hljs-comment">// 显式终止Worker</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'stop-btn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  worker.<span class="hljs-title function_">terminate</span>(); <span class="hljs-comment">// 立即终止线程</span>
});
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// worker.js - 独立线程</span>
self.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">async</span> (event) =&gt; {
  <span class="hljs-keyword">const</span> { action, payload } = event.<span class="hljs-property">data</span>;
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">switch</span>(action) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'processData'</span>:
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">processDataInWorker</span>(payload);
        self.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">'success'</span>, <span class="hljs-attr">data</span>: result });
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'abort'</span>:
        <span class="hljs-comment">// 实现可取消的计算</span>
        abortController.<span class="hljs-title function_">abort</span>();
        <span class="hljs-keyword">break</span>;
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// Worker内错误不会影响主线程</span>
    self.<span class="hljs-title function_">postMessage</span>({ 
      <span class="hljs-attr">status</span>: <span class="hljs-string">'error'</span>, 
      <span class="hljs-attr">message</span>: error.<span class="hljs-property">message</span> 
    });
  }
};

<span class="hljs-comment">// 独立于DOM的计算函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processDataInWorker</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-comment">// 这里无法访问window/document等全局对象</span>
  <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-comment">/* 复杂计算 */</span>);
}
</code></pre>
<p><strong>核心隔离规则</strong>：</p>
<ul>
<li>❌ 无法访问DOM、<code>window</code>、<code>document</code>、<code>localStorage</code></li>
<li>❌ 无法使用<code>alert()</code>/<code>confirm()</code>等UI方法</li>
<li>✅ 可访问<code>navigator</code>、<code>setTimeout</code>、<code>fetch</code>、<code>WebAssembly</code></li>
<li>✅ 通过<code>importScripts()</code>或ES模块加载外部代码</li>
</ul>
<blockquote>
<p><strong>安全设计原理</strong>：Worker运行在独立的V8实例中，通过结构化克隆算法（Structured Clone Algorithm）进行数据交换，从根本上避免竞态条件。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">三、异步通信进阶：高效数据传输策略</h3>
<p>主线程与Worker间的数据传输是性能关键，错误的使用方式会使并行优势荡然无存：</p>
<h4 data-id="heading-3">1. Transferable Objects：零拷贝传输</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程</span>
<span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">100_000_000</span>); <span class="hljs-comment">// 100MB数据</span>
<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'data-processor.js'</span>);

<span class="hljs-comment">// 传输后主线程失去buffer所有权！</span>
worker.<span class="hljs-title function_">postMessage</span>({ buffer }, [buffer]);

<span class="hljs-comment">// Worker中</span>
self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { buffer } = e.<span class="hljs-property">data</span>;
  <span class="hljs-comment">// 直接操作原始内存，无复制开销</span>
  <span class="hljs-keyword">const</span> view = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(buffer);
  <span class="hljs-comment">// ...处理数据</span>
  self.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">resultBuffer</span>: processedBuffer }, [processedBuffer]);
};
</code></pre>
<p><strong>性能对比</strong>（100MB ArrayBuffer）：</p>




















<table><thead><tr><th>传输方式</th><th>耗时 (Chrome 124)</th><th>内存峰值</th></tr></thead><tbody><tr><td>默认结构化克隆</td><td>320ms</td><td>200MB</td></tr><tr><td>Transferable</td><td>&lt;1ms</td><td>100MB</td></tr></tbody></table>
<h4 data-id="heading-4">2. MessageChannel：多Worker复杂通信</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建通道</span>
<span class="hljs-keyword">const</span> { port1, port2 } = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();

<span class="hljs-comment">// Worker A 与 Worker B 通过port通信</span>
<span class="hljs-keyword">const</span> workerA = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'workerA.js'</span>);
<span class="hljs-keyword">const</span> workerB = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'workerB.js'</span>);

workerA.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'init'</span> }, [port1]);
workerB.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'init'</span> }, [port2]);

<span class="hljs-comment">// 在workerA.js中</span>
self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'init'</span>) {
    <span class="hljs-keyword">const</span> port = e.<span class="hljs-property">ports</span>[<span class="hljs-number">0</span>];
    port.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">data</span>.<span class="hljs-property">action</span> === <span class="hljs-string">'request'</span>) {
        port.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">action</span>: <span class="hljs-string">'response'</span>, <span class="hljs-attr">data</span>: <span class="hljs-title function_">computeHeavyTask</span>() });
      }
    };
  }
};
</code></pre>
<blockquote>
<p><strong>关键实践</strong>：对于超过1MB的数据传输，始终优先使用Transferable Objects。注意：传输后原对象在发送方变为不可用（内存所有权转移）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">四、现代开发实践：框架与工具链整合</h3>
<h4 data-id="heading-6">1. Comlink：消除通信样板代码</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// worker.js</span>
<span class="hljs-keyword">import</span> { expose } <span class="hljs-keyword">from</span> <span class="hljs-string">'comlink'</span>;

<span class="hljs-keyword">const</span> api = {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">processImage</span>(<span class="hljs-params">imageData</span>) {
    <span class="hljs-comment">// 复杂图像处理</span>
    <span class="hljs-keyword">return</span> processedData;
  },
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">trainModel</span>(<span class="hljs-params">dataset</span>) {
    <span class="hljs-comment">// TensorFlow.js 模型训练</span>
  }
};

<span class="hljs-title function_">expose</span>(api); <span class="hljs-comment">// 暴露API</span>

<span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { wrap } <span class="hljs-keyword">from</span> <span class="hljs-string">'comlink'</span>;

<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'worker.js'</span>, { <span class="hljs-attr">type</span>: <span class="hljs-string">'module'</span> });
<span class="hljs-keyword">const</span> workerAPI = <span class="hljs-title function_">wrap</span>(worker);

<span class="hljs-comment">// 像调用本地方法一样使用</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> workerAPI.<span class="hljs-title function_">processImage</span>(imageData);
</code></pre>
<p><strong>Comlink 优势</strong>：</p>
<ul>
<li>自动处理Promise/async函数</li>
<li>支持类实例传输</li>
<li>透明化错误处理</li>
<li>类型推断（配合TypeScript）</li>
</ul>
<h4 data-id="heading-7">2. 框架集成（Vite示例）</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">worker</span>: {
    <span class="hljs-attr">format</span>: <span class="hljs-string">'es'</span>,
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-comment">// 为Worker单独配置插件</span>
      <span class="hljs-title function_">wasm</span>(),
      <span class="hljs-title function_">legacy</span>({
        <span class="hljs-attr">targets</span>: [<span class="hljs-string">'defaults'</span>, <span class="hljs-string">'not IE 11'</span>]
      })
    ]
  }
})
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React组件中动态加载Worker</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">useImageProcessor</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [worker, setWorker] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> imageWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(
      <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./image-processor.worker.js'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>),
      { <span class="hljs-attr">type</span>: <span class="hljs-string">'module'</span> }
    );
    
    <span class="hljs-title function_">setWorker</span>(imageWorker);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> imageWorker.<span class="hljs-title function_">terminate</span>();
  }, []);
  
  <span class="hljs-keyword">const</span> processImage = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> (file) =&gt; {
    <span class="hljs-keyword">if</span> (!worker) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
      worker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">resolve</span>(e.<span class="hljs-property">data</span>);
      worker.<span class="hljs-title function_">postMessage</span>(file);
    });
  }, [worker]);
};
</code></pre>
<blockquote>
<p><strong>工程化提示</strong>：在构建配置中为Worker设置单独的entrypoint，避免将整个应用打包到Worker中。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">五、性能优化与陷阱规避</h3>
<h4 data-id="heading-9">1. Worker池模式（避免频繁创建开销）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkerPool</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">workerPath, size = <span class="hljs-number">4</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">workers</span> = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: size }, <span class="hljs-function">() =&gt;</span> 
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(workerPath)
    );
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nextWorkerIndex</span> = <span class="hljs-number">0</span>;
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">exec</span>(<span class="hljs-params">task</span>) {
    <span class="hljs-comment">// 轮询分配任务</span>
    <span class="hljs-keyword">const</span> worker = <span class="hljs-variable language_">this</span>.<span class="hljs-property">workers</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">nextWorkerIndex</span>++ % <span class="hljs-variable language_">this</span>.<span class="hljs-property">workers</span>.<span class="hljs-property">length</span>];
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMessage</span> = (<span class="hljs-params">e</span>) =&gt; {
        worker.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'message'</span>, handleMessage);
        <span class="hljs-title function_">resolve</span>(e.<span class="hljs-property">data</span>);
      };
      
      worker.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, handleMessage);
      worker.<span class="hljs-title function_">postMessage</span>(task);
    });
  }
  
  <span class="hljs-title function_">terminate</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">workers</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">w</span> =&gt;</span> w.<span class="hljs-title function_">terminate</span>());
  }
}

<span class="hljs-comment">// 使用：复用4个Worker处理100个任务</span>
<span class="hljs-keyword">const</span> pool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WorkerPool</span>(<span class="hljs-string">'/tasks.worker.js'</span>, <span class="hljs-number">4</span>);
<span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
  <span class="hljs-title class_">Array</span>(<span class="hljs-number">100</span>).<span class="hljs-title function_">fill</span>().<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> pool.<span class="hljs-title function_">exec</span>({ <span class="hljs-attr">taskId</span>: i }))
);
</code></pre>
<h4 data-id="heading-10">2. 内存泄漏防护</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Worker内部</span>
<span class="hljs-keyword">let</span> abortController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();

self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">action</span> === <span class="hljs-string">'start'</span>) {
    <span class="hljs-comment">// 每次新任务重置控制器</span>
    abortController.<span class="hljs-title function_">abort</span>(); 
    abortController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
    
    <span class="hljs-title function_">processData</span>(e.<span class="hljs-property">data</span>.<span class="hljs-property">payload</span>, abortController.<span class="hljs-property">signal</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> self.<span class="hljs-title function_">postMessage</span>(result));
  }
};

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">data, signal</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-comment">// 检查取消信号</span>
    <span class="hljs-keyword">if</span> (signal.<span class="hljs-property">aborted</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMException</span>(<span class="hljs-string">'Aborted'</span>, <span class="hljs-string">'AbortError'</span>);
    
    <span class="hljs-comment">// 分块处理防止长时间占用</span>
    <span class="hljs-keyword">if</span> (i % <span class="hljs-number">1000</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">0</span>));
    
    <span class="hljs-comment">// ...处理逻辑</span>
  }
}
</code></pre>
<p><strong>关键防护措施</strong>：</p>
<ul>
<li>始终在Worker中使用<code>AbortController</code>支持取消</li>
<li>处理大数据集时分块执行（chunk processing）</li>
<li>使用<code>setTimeout(0)</code>释放事件循环</li>
<li>显式清理事件监听器（避免闭包内存泄漏）</li>
</ul>
<hr/>
<h3 data-id="heading-11">六、实战场景剖析</h3>
<h4 data-id="heading-12">场景：实时视频帧处理（60FPS）</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"output-canvas"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"1280"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"720"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'output-canvas'</span>);
<span class="hljs-keyword">const</span> offscreen = canvas.<span class="hljs-title function_">transferControlToOffscreen</span>(); <span class="hljs-comment">// OffscreenCanvas</span>

<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'video-processor.js'</span>);
worker.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">canvas</span>: offscreen }, [offscreen]);

<span class="hljs-comment">// 通过MessageChannel接收帧数据</span>
<span class="hljs-keyword">const</span> { port1, port2 } = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
worker.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">videoPort</span>: port2 }, [port2]);

port1.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-comment">// 实时显示处理状态</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fps-counter'</span>).<span class="hljs-property">textContent</span> = e.<span class="hljs-property">data</span>.<span class="hljs-property">fps</span>;
};

<span class="hljs-comment">// video-processor.js (Worker)</span>
<span class="hljs-keyword">let</span> fpsCounter = <span class="hljs-number">0</span>;
<span class="hljs-keyword">let</span> lastFrameTime = <span class="hljs-number">0</span>;

self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">canvas</span>) {
    <span class="hljs-keyword">const</span> canvas = e.<span class="hljs-property">data</span>.<span class="hljs-property">canvas</span>;
    <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
    <span class="hljs-keyword">const</span> videoPort = e.<span class="hljs-property">ports</span>[<span class="hljs-number">0</span>];
    
    <span class="hljs-comment">// 模拟视频流</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">drawFrame</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> now = performance.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">const</span> elapsed = now - lastFrameTime;
      
      <span class="hljs-keyword">if</span> (elapsed &gt;= <span class="hljs-number">16</span>) { <span class="hljs-comment">// ~60FPS</span>
        <span class="hljs-comment">// 复杂图像处理（边缘检测）</span>
        <span class="hljs-title function_">applyEdgeDetection</span>(ctx);
        
        <span class="hljs-comment">// 通过OffscreenCanvas直接渲染</span>
        canvas.<span class="hljs-title function_">commit</span>();
        
        <span class="hljs-comment">// 计算FPS</span>
        fpsCounter++;
        <span class="hljs-keyword">if</span> (now - lastFrameTime &gt; <span class="hljs-number">1000</span>) {
          videoPort.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">fps</span>: fpsCounter });
          fpsCounter = <span class="hljs-number">0</span>;
          lastFrameTime = now;
        }
      }
      
      <span class="hljs-comment">// 非阻塞递归</span>
      <span class="hljs-built_in">setTimeout</span>(drawFrame, <span class="hljs-number">0</span>);
    };
    
    <span class="hljs-title function_">drawFrame</span>();
  }
};
</code></pre>
<p><strong>性能对比</strong>（1080p视频实时处理）：</p>























<table><thead><tr><th>方案</th><th>主线程占用</th><th>稳定FPS</th><th>内存增长/分钟</th></tr></thead><tbody><tr><td>主线程处理</td><td>92%</td><td>8-12</td><td>120MB</td></tr><tr><td>Web Worker + OffscreenCanvas</td><td>18%</td><td>58-60</td><td>25MB</td></tr></tbody></table>
<blockquote>
<p><strong>OffscreenCanvas革命</strong>：在Worker中直接操作Canvas，避免每帧数据传输开销，这是实现高性能图形应用的关键。</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">七、未来演进与替代方案</h3>
<h4 data-id="heading-14">1. WebAssembly + Worker 协同</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// worker.js</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initWasm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> wasmModule = <span class="hljs-keyword">await</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title function_">instantiateStreaming</span>(
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'image-processing.wasm'</span>),
    { 
      <span class="hljs-attr">env</span>: { 
        <span class="hljs-attr">memory</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Memory</span>({ <span class="hljs-attr">initial</span>: <span class="hljs-number">256</span> })
      }
    }
  );
  
  <span class="hljs-keyword">return</span> wasmModule.<span class="hljs-property">instance</span>.<span class="hljs-property">exports</span>;
}

<span class="hljs-keyword">let</span> wasmExports;
<span class="hljs-title function_">initWasm</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">exports</span> =&gt;</span> wasmExports = <span class="hljs-built_in">exports</span>);

self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-comment">// 调用Wasm函数（比JS快5-10倍）</span>
  <span class="hljs-keyword">const</span> result = wasmExports.<span class="hljs-title function_">processImage</span>(e.<span class="hljs-property">data</span>.<span class="hljs-property">buffer</span>);
  self.<span class="hljs-title function_">postMessage</span>(result, [result]);
};
</code></pre>
<h4 data-id="heading-15">2. 技术选型决策树</h4>
<p><strong>替代方案对比</strong>：</p>






























<table><thead><tr><th>技术</th><th>适用场景</th><th>局限性</th></tr></thead><tbody><tr><td>Web Worker</td><td>通用CPU密集型任务</td><td>通信开销，无DOM访问</td></tr><tr><td>WebAssembly</td><td>超高性能计算（C++/Rust）</td><td>开发复杂度高</td></tr><tr><td>Worklets</td><td>CSS动画/音频处理</td><td>功能受限，API实验性</td></tr><tr><td>Service Workers</td><td>网络代理/离线缓存</td><td>无法处理CPU密集型任务</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-16">八、结语：重构前端性能认知</h3>
<p>Web Worker不是银弹，而是现代前端架构的关键拼图。在构建实时协作应用时，我们将图像差异计算移至Worker，使主线程交互延迟从300ms降至15ms；在金融数据平台中，通过Worker池处理10GB级时序数据，用户滚动流畅度提升400%。这些实践验证了：<strong>真正的流畅体验，始于对单线程边界的突破</strong>。</p>
<p><strong>行动建议</strong>：</p>
<ol>
<li>在Lighthouse性能审计中，将"避免长时间主线程任务"作为硬性指标</li>
<li>对任何超过50ms的同步操作进行Worker化改造</li>
<li>使用<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">worker-timers</a>等库替换阻塞式定时器</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🐦‍🔥 解锁移动端H5调试：Eruda & VConsole 实战指南]]></title>    <link>https://juejin.cn/post/7587965908287963146</link>    <guid>https://juejin.cn/post/7587965908287963146</guid>    <pubDate>2025-12-26T09:00:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587965908287963146" data-draft-id="7587965800272379930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🐦‍🔥 解锁移动端H5调试：Eruda &amp; VConsole 实战指南"/> <meta itemprop="keywords" content="Debug,WebView,前端"/> <meta itemprop="datePublished" content="2025-12-26T09:00:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CRAB"/> <meta itemprop="url" content="https://juejin.cn/user/2154698522760557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🐦‍🔥 解锁移动端H5调试：Eruda &amp; VConsole 实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2154698522760557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CRAB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:00:31.000Z" title="Fri Dec 26 2025 09:00:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    28
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在PC端，我们有Chrome DevTools。但在微信小程序或App的WebView中开发H5时，F12瞬间失灵，调试如同“盲人摸象”。本文将为你深度剖析两大神器——<strong>VConsole</strong>​ 和 <strong>Eruda</strong>，助你轻松攻克移动端H5调试难题。</p>
</blockquote>
<h2 data-id="heading-0">🐦‍ 前言：为何我们需要它们？</h2>
<ol>
<li><strong>环境封闭</strong>：小程序的 <code>web-view</code>和 App 的 WebView 通常不开放完整的DevTools权限。</li>
<li><strong>真机差异</strong>：PC模拟环境与真实手机在渲染、性能、API支持上存在鸿沟。</li>
<li><strong>网络与设备</strong>：需要查看在特定网络（4G/5G）和设备下的表现。</li>
<li><strong>快速定位</strong>：<code>console.log</code>和网络请求详情是定位问题的生命线。</li>
</ol>
<h2 data-id="heading-1">🪶 两大神器简介与核心对比</h2>








































<table><thead><tr><th>特性</th><th>Eruda 🛠️</th><th>VConsole 📱</th></tr></thead><tbody><tr><td><strong>定位</strong>​</td><td>专业、全功能“仪表盘”</td><td>轻量、便捷“口袋工具”</td></tr><tr><td><strong>出品方</strong>​</td><td>Liriliri (独立开发者)</td><td><strong>微信团队</strong>​</td></tr><tr><td><strong>功能丰富度</strong>​</td><td>★★★★★ (Console, Elements, Network, Resources, Snippets...)</td><td>★★★★☆ (Console, Network, Element, Storage)</td></tr><tr><td><strong>易用性</strong>​</td><td>★★★☆☆ (需简单学习，模块化)</td><td>★★★★★ (开箱即用，零成本)</td></tr><tr><td><strong>性能/体积</strong>​</td><td>相对较重 (~180KB gzipped)</td><td>非常轻量 (~45KB gzipped)</td></tr><tr><td><strong>推荐场景</strong>​</td><td>复杂应用、深度调试、专业开发者</td><td>快速迭代、微信生态、新手、轻量需求</td></tr></tbody></table>
<p><strong>一句话总结：追求深度和全面，选 Eruda；追求简单和快捷，尤其在微信环境，选 VConsole。</strong></p>
<hr/>
<h2 data-id="heading-2">🪾 实战篇：手把手教你集成</h2>
<h3 data-id="heading-3">🚩 1. Eruda 集成与使用</h3>
<p><strong>第1步：引入脚本 (务必按需加载！)</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 推荐：通过URL参数 ?eruda=true 或开发环境判断来加载 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/localhost|127.0.0.1|dev/i</span>.<span class="hljs-title function_">test</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">hostname</span>) || <span class="hljs-regexp">/eruda=true/</span>.<span class="hljs-title function_">test</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>)) {
    <span class="hljs-keyword">var</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
    script.<span class="hljs-property">src</span> = <span class="hljs-string">'//cdn.jsdelivr.net/npm/eruda'</span>;
    script.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) { eruda.<span class="hljs-title function_">init</span>(); };
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(script);
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>第2步：初始化与配置 (可选)</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">eruda.<span class="hljs-keyword">init</span>({
  tool: [<span class="hljs-string">'console'</span>, <span class="hljs-string">'elements'</span>, <span class="hljs-string">'network'</span>], <span class="hljs-comment">// 只启用需要的工具</span>
  autoScale: <span class="hljs-literal">true</span>,
});
</code></pre>
<p><strong>第3步：效果一览</strong></p>
<p>点击右下角 Logo 即可唤出功能强大的控制台。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53a6d0f2195847ec94c2e3203116fcfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1JBQg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767347810&amp;x-signature=quRZeGoz%2Fs3Km2uh8ytZi3iKSNU%3D" alt="929F667A-F134-4B5D-9C5A-387209BADB96_1_201_a.jpeg" loading="lazy"/></p>
<h3 data-id="heading-4">🚩 2. VConsole 集成与使用</h3>
<p><strong>第1步：引入脚本 (同样按需加载！)</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 推荐：通过环境变量或域名判断来加载 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/localhost|127.0.0.1|dev/i</span>.<span class="hljs-title function_">test</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">hostname</span>)) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;script src="https://unpkg.com/vconsole/dist/vconsole.min.js"&gt;</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>');
    document.write('<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">VConsole</span>();</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>');
  }
<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>第2步：初始化与配置 (可选)</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> vConsole = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VConsole</span>({
  <span class="hljs-attr">defaultPlugins</span>: [<span class="hljs-string">'system'</span>, <span class="hljs-string">'network'</span>, <span class="hljs-string">'element'</span>],
  <span class="hljs-attr">onReady</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'VConsole 已就绪！'</span>); }
});
</code></pre>
<p><strong>第3步：效果一览</strong></p>
<p>点击右下角绿色 “V” 图标即可打开简洁的调试面板。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98891db9f4c5485eae5702bc07af8ea6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1JBQg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767347810&amp;x-signature=JMC9wECUmrP%2BaltLTq%2FzWEkf8ds%3D" alt="BDDE4554-869F-49A3-AE5C-E78FF43B6E1D_1_201_a.jpeg" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-5">🛹 最佳实践与避坑指南</h2>
<ol>
<li>
<p><strong>安全第一：切勿发布到生产环境！</strong> 使用环境变量或域名/IP白名单严格控制加载，是每位前端工程师的基本素养。</p>
</li>
<li>
<p><strong>动态开启：给测试和产品同学开个“后门”</strong> 使用 URL 参数（如 <code>?debug=true</code>）控制，无需重新发版即可开启调试。</p>
</li>
<li>
<p><strong>VConsole 进阶</strong></p>
<ul>
<li><code>vConsole.showSwitch()</code>可以显示一个手动切换面板的开关。</li>
<li>可以自定义插件，扩展其功能。</li>
</ul>
</li>
<li>
<p><strong>Eruda 进阶</strong></p>
<ul>
<li>使用 <code>eruda.add(erudaPerformance)</code>动态添加性能监控插件。</li>
<li>通过 <code>eruda.settings.set()</code>动态调整设置。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-6">🎬 总结</h2>
<p>工欲善其事，必先利其器。对于移动端H5开发者而言，<strong>VConsole</strong>​ 和 <strong>Eruda</strong>​ 就是那把最锋利的“器”。</p>
<ul>
<li><strong>日常快速调试、微信H5开发</strong>，VConsole 是你的不二之选。</li>
<li><strong>面对复杂Bug、需要进行深度性能分析</strong>，Eruda 的强大功能会让你事半功倍。</li>
</ul>
<p>希望这篇指南能帮助你彻底摆脱调试困境，在移动端H5的世界里游刃有余！欢迎在评论区分享你的使用心得和遇到的问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 iframe 到 Shadow DOM：一次关于「隔离」的前端边界思考]]></title>    <link>https://juejin.cn/post/7587808953075695616</link>    <guid>https://juejin.cn/post/7587808953075695616</guid>    <pubDate>2025-12-26T09:02:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587808953075695616" data-draft-id="7587743345197006900" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 iframe 到 Shadow DOM：一次关于「隔离」的前端边界思考"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-26T09:02:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="shanLion"/> <meta itemprop="url" content="https://juejin.cn/user/2788017217477048"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 iframe 到 Shadow DOM：一次关于「隔离」的前端边界思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017217477048/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    shanLion
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:02:38.000Z" title="Fri Dec 26 2025 09:02:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、问题背景：我到底想解决什么？</h2>
<p>在复杂前端系统中，我们经常会遇到这样的需求：</p>
<ul>
<li>
<p>页面需要嵌入<strong>第三方内容 / 子系统</strong></p>
</li>
<li>
<p>希望 <strong>样式、脚本互不影响</strong></p>
</li>
<li>
<p>同时又要保证：</p>
<ul>
<li>正常渲染</li>
<li>合理交互</li>
<li>可控的安全边界</li>
</ul>
</li>
</ul>
<p>常见方案是 <code>iframe</code>，但一旦深入使用，就会立刻遇到一系列问题：</p>
<ul>
<li>Cookie 是否会被注入？</li>
<li>JS 能否互相访问？</li>
<li>样式是否会污染？</li>
<li>sandbox 一加，页面怎么直接不显示了？</li>
<li>不加 <code>allow-same-origin</code> 又为什么什么都“坏了”？</li>
</ul>
<p>这篇文章，就是围绕这些真实问题展开。</p>
<hr/>
<h2 data-id="heading-1">二、iframe 的本质：浏览器级别的“硬隔离”</h2>
<h3 data-id="heading-2">1️⃣ iframe 是什么？</h3>
<p>从浏览器角度看，<code>iframe</code> 并不是一个普通 DOM，而是：</p>
<blockquote>
<p><strong>一个完整的、独立的浏览上下文（Browsing Context）</strong></p>
</blockquote>
<p>它拥有自己的：</p>
<ul>
<li>DOM 树</li>
<li>JS 执行环境</li>
<li>CSS 作用域</li>
<li>Cookie / Storage（是否共享取决于策略）</li>
</ul>
<p>这也是它“隔离性强”的根本原因。</p>
<hr/>
<h3 data-id="heading-3">2️⃣ iframe 天生适合做什么？</h3>
<ul>
<li>微前端子应用</li>
<li>第三方内容嵌入</li>
<li>不可信页面展示</li>
<li>强安全边界场景</li>
</ul>
<p><strong>它解决的是“不信任”的问题，而不是“优雅”的问题。</strong></p>
<hr/>
<h2 data-id="heading-4">三、sandbox：安全从这里开始，也从这里失控</h2>
<h3 data-id="heading-5">1️⃣ sandbox 到底干了什么？</h3>
<p>当你给 iframe 加上：</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">iframe</span> sandbox&gt;&lt;/<span class="hljs-selector-tag">iframe</span>&gt;
</code></pre>
<p>你相当于对它说：</p>
<blockquote>
<p>“你什么都不能干。”</p>
</blockquote>
<p>包括但不限于：</p>
<ul>
<li>❌ JS 不执行</li>
<li>❌ 表单提交被禁</li>
<li>❌ 同源身份被剥夺</li>
<li>❌ Cookie / localStorage 全部隔离</li>
</ul>
<hr/>
<h3 data-id="heading-6">2️⃣ 为什么加了 sandbox，页面直接空白？</h3>
<p>因为很多页面：</p>
<ul>
<li>依赖 JS 渲染</li>
<li>依赖同源读取资源</li>
<li>依赖 Cookie 维持状态</li>
</ul>
<p>一旦 sandbox 默认限制生效，页面<strong>逻辑上还能加载，但功能全废</strong>。</p>
<hr/>
<h3 data-id="heading-7">3️⃣ allow-scripts + allow-same-origin 为什么危险？</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">sandbox</span>=<span class="hljs-string">"allow-scripts allow-same-origin"</span>
</code></pre>
<p>这是一个<strong>经典陷阱组合</strong>。</p>
<p>原因是：</p>
<ul>
<li><code>allow-scripts</code>：允许 JS 执行</li>
<li><code>allow-same-origin</code>：恢复同源身份</li>
</ul>
<p>⚠️ 一旦两者同时存在：</p>
<blockquote>
<p>iframe 内的 JS <strong>可以认为自己是“正常页面”</strong></p>
</blockquote>
<p>从规范角度，它已经具备了<strong>逃逸 sandbox 的能力</strong>。</p>
<p>这也是 MDN 明确标注的安全风险。</p>
<hr/>
<h2 data-id="heading-8">四、那我只是不想 Cookie 被注入，怎么办？</h2>
<h3 data-id="heading-9">❌ 错误直觉</h3>
<blockquote>
<p>“去掉 allow-same-origin 就好了”</p>
</blockquote>
<p>结果是：</p>
<ul>
<li>JS 取不到任何资源</li>
<li>页面渲染失败</li>
<li>iframe 内容直接消失</li>
</ul>
<hr/>
<h3 data-id="heading-10">✅ 正确理解</h3>
<p>Cookie 注入的本质是：</p>
<ul>
<li><strong>同源 + 凭证传递</strong></li>
</ul>
<p>控制 Cookie 的正确方式是：</p>
<ul>
<li><code>SameSite</code></li>
<li><code>HttpOnly</code></li>
<li><code>Secure</code></li>
<li>服务端鉴权策略</li>
</ul>
<p>而不是指望 iframe sandbox 去“顺便解决”。</p>
<hr/>
<h2 data-id="heading-11">五、Shadow DOM：另一种完全不同的“隔离”</h2>
<h3 data-id="heading-12">1️⃣ Shadow DOM 隔离的是什么？</h3>
<p>Shadow DOM 隔离的是：</p>
<ul>
<li><strong>样式作用域</strong></li>
<li><strong>DOM 结构可见性</strong></li>
</ul>
<p>但它：</p>
<ul>
<li>❌ 不隔离 JS</li>
<li>❌ 不隔离 Cookie</li>
<li>❌ 不隔离安全上下文</li>
</ul>
<p>它解决的是：</p>
<blockquote>
<p><strong>组件级的可维护性问题</strong></p>
</blockquote>
<p>而不是安全问题。</p>
<hr/>
<h3 data-id="heading-13">2️⃣ iframe vs Shadow DOM 对比</h3>








































<table><thead><tr><th>维度</th><th>iframe</th><th>Shadow DOM</th></tr></thead><tbody><tr><td>样式隔离</td><td>✅ 强</td><td>✅ 中</td></tr><tr><td>JS 隔离</td><td>✅ 强</td><td>❌</td></tr><tr><td>安全边界</td><td>✅</td><td>❌</td></tr><tr><td>通信成本</td><td>高</td><td>低</td></tr><tr><td>性能</td><td>较重</td><td>轻</td></tr><tr><td>使用复杂度</td><td>高</td><td>中</td></tr></tbody></table>
<p>一句话总结：</p>
<blockquote>
<p>iframe 是<strong>安全隔离工具</strong><br/>
Shadow DOM 是<strong>工程隔离工具</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于React Native 0.83.1 新架构下的拆包方案]]></title>    <link>https://juejin.cn/post/7587825268201209862</link>    <guid>https://juejin.cn/post/7587825268201209862</guid>    <pubDate>2025-12-26T08:23:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587825268201209862" data-draft-id="7587785079739121670" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于React Native 0.83.1 新架构下的拆包方案"/> <meta itemprop="keywords" content="React Native"/> <meta itemprop="datePublished" content="2025-12-26T08:23:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘成"/> <meta itemprop="url" content="https://juejin.cn/user/3773179634918343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于React Native 0.83.1 新架构下的拆包方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3773179634918343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘成
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T08:23:22.000Z" title="Fri Dec 26 2025 08:23:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>React Native 0.83.1 新架构（New Architecture） 下的拆包方案</p>
<hr/>
<h2 data-id="heading-0">React Native 0.83.1 新架构拆包实战：基于 ReactHost 与单 Runtime 的动态加载方案</h2>
<p>随着 React Native 进入 0.80+ 时代，新架构（Fabric &amp; TurboModules）已成为主流。传统的基于 <code>ReactInstanceManager</code> 和 Bridge 的拆包方式已逐步过时。本文将介绍在 <strong>RN 0.83.1</strong> 版本下，如何利用 <code>ReactHost</code>、<code>JSI</code> 和 <code>Hermes Runtime</code> 实现高性能的模块化拆包与动态加载。</p>
<hr/>
<h3 data-id="heading-1">一、 为什么旧的拆包方案失效了？</h3>
<p>在新架构中，底层通信机制从传统的 JSON Bridge 转向了基于 C++ 的 <strong>JSI (JavaScript Interface)</strong>。</p>



































<table><thead><tr><th align="left">特性</th><th align="left">Legacy 架构 (旧)</th><th align="left">新架构 (Fabric + TurboModules)</th></tr></thead><tbody><tr><td align="left"><strong>JS 执行环境</strong></td><td align="left">Bridge + CatalystInstance</td><td align="left"><strong>JSI + Hermes Runtime</strong></td></tr><tr><td align="left"><strong>Bundle 入口</strong></td><td align="left">ReactInstanceManager</td><td align="left"><strong>ReactHost / JSExecutorFactory</strong></td></tr><tr><td align="left"><strong>Native 管理器</strong></td><td align="left">ReactActivity / ReactRootView</td><td align="left"><strong>ReactHost / ReactInstance</strong></td></tr><tr><td align="left"><strong>JS 模块 API</strong></td><td align="left">全局注入模块 (Global Bridge)</td><td align="left"><strong>TurboModule + Codegen</strong></td></tr><tr><td align="left"><strong>支持情况</strong></td><td align="left">已过时 (Deprecated)</td><td align="left"><strong>官方推荐</strong></td></tr></tbody></table>
<blockquote>
<p>[!WARNING]<br/>
从 RN 0.72 起 Fabric 默认启用，RN 0.80 之后已完全移除传统 Bridge 的 Fallback 机制。<code>JSBundleLoader</code> 等旧类在高性能新架构下已无法直接使用。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、 方案选择：多 Runtime vs 单 Runtime</h3>
<p>在 0.83.1 版本下，实现多模块化主要有两种思路：</p>
<ol>
<li><strong>多 ReactHost 实例化（隔离方案）：</strong> 每个业务模块独立打包，包含独立的基础库。优点是隔离性强，缺点是内存占用极高，无法共享基础库。</li>
<li><strong>单 Hermes Runtime 动态加载（推荐方案）：</strong>
<ul>
<li><strong>基础包 (Base Bundle)：</strong> 包含 RN 框架、NativeModules、公共库及导航容器。</li>
<li><strong>业务包 (Business Bundle)：</strong> 仅包含业务代码，共用基础包的运行时。</li>
<li><strong>优势：</strong> 内存占用低、共用上下文、符合 Fabric 渲染链路。</li>
</ul>
</li>
</ol>
<p><strong>本文采用方案 2 进行深度实践。</strong></p>
<hr/>
<h3 data-id="heading-3">三、 核心原理</h3>
<ol>
<li><strong>按需加载：</strong> 启动阶段只加载 <code>index.base.bundle</code>。</li>
<li><strong>动态注册：</strong> 业务 Bundle 被加载时，通过 JSI 调用底层 C++ Runtime 的 <code>evaluateJavaScript</code> 执行 JS 代码，将业务页面注册到基础包的导航器（如 React Navigation）中。</li>
<li><strong>路由占位：</strong> 基础包预留“壳页面”（BizShell），当导航跳转至业务模块时，若 Bundle 未加载则触发 Native 动态加载流程。</li>
</ol>
<hr/>
<h3 data-id="heading-4">四、 具体实现步骤</h3>
<h4 data-id="heading-5">1. React Native 层实现</h4>
<h5 data-id="heading-6">1.1 入口文件拆分</h5>
<ul>
<li>
<p><strong>index.base.js (基础包)：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppRegistry</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./src/App'</span>;
<span class="hljs-keyword">import</span> { name <span class="hljs-keyword">as</span> appName } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.json'</span>;

<span class="hljs-title class_">AppRegistry</span>.<span class="hljs-title function_">registerComponent</span>(appName, <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">App</span>);
</code></pre>
</li>
<li>
<p><strong>index.buz1.js (业务包)：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { registerBiz } <span class="hljs-keyword">from</span> <span class="hljs-string">'./src/navigation/DynamicRegistry'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Buz1Navigator</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./src/biz1/Navigator'</span>;

<span class="hljs-comment">// 动态注册业务路由</span>
<span class="hljs-title function_">registerBiz</span>(<span class="hljs-string">'buz1'</span>, <span class="hljs-title class_">Buz1Navigator</span>);
</code></pre>
</li>
</ul>
<h5 data-id="heading-7">1.2 路由占位逻辑</h5>
<p>在 <code>src/navigation/DynamicNavigator.tsx</code> 中，使用 <code>BizShell</code> 作为业务占位符：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Stack</span>.<span class="hljs-property">Navigator</span> initialRouteName={props.<span class="hljs-property">biz</span> || <span class="hljs-string">'NotFound'</span>}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Stack.Screen</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"NotFound"</span> <span class="hljs-attr">component</span>=<span class="hljs-string">{NotFound}</span> /&gt;</span></span>
  
  {<span class="hljs-comment">/* 业务占位：有多少个拆分包，就配置多少个 Screen */</span>}
  &lt;<span class="hljs-title class_">Stack</span>.<span class="hljs-property">Screen</span> 
    key={<span class="hljs-string">'buz1'</span>} 
    name={<span class="hljs-string">'buz1'</span>} 
    component={<span class="hljs-title class_">BizShell</span>} 
    options={{ <span class="hljs-attr">headerShown</span>: <span class="hljs-literal">false</span> }} 
  /&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Stack.Screen</span> 
    <span class="hljs-attr">key</span>=<span class="hljs-string">{</span>'<span class="hljs-attr">buz2</span>'} 
    <span class="hljs-attr">name</span>=<span class="hljs-string">{</span>'<span class="hljs-attr">buz2</span>'} 
    <span class="hljs-attr">component</span>=<span class="hljs-string">{BizShell}</span> 
    <span class="hljs-attr">options</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">headerShown:</span> <span class="hljs-attr">false</span> }} 
  /&gt;</span></span>
&lt;/<span class="hljs-title class_">Stack</span>.<span class="hljs-property">Navigator</span>&gt;
</code></pre>
<blockquote>
<p><strong>提示：</strong> 核心路由跳转与 Bundle 加载状态维护均在 <code>BizShell.tsx</code> 中处理。</p>
</blockquote>
<hr/>
<h4 data-id="heading-8">2. Android 端核心代码</h4>
<h5 data-id="heading-9">2.1 初始化 ReactHost</h5>
<p>在 <code>MainApplication</code> 中手动启动 <code>ReactHost</code> 并监听初始化状态。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initializeReactHost</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> host = reactHost
    host.start() <span class="hljs-comment">// 启动新架构 Host</span>

    host.addReactInstanceEventListener(<span class="hljs-keyword">object</span> : ReactInstanceEventListener {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onReactContextInitialized</span><span class="hljs-params">(reactContext: <span class="hljs-type">ReactContext</span>)</span></span> {
            <span class="hljs-comment">// 将 Context 传给动态加载器</span>
            DynamicLoader.setContext(reactContext)
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 执行 JSI 绑定或其他初始化</span>
                DynamicLoader.install()
                SplashActivity.instance?.hideLoading()
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                Log.e(<span class="hljs-string">"MainApplication"</span>, <span class="hljs-string">"DynamicLoader 失败：<span class="hljs-subst">${e.message}</span>"</span>)
            }
            host.removeReactInstanceEventListener(<span class="hljs-keyword">this</span>)
        }
    })
}
</code></pre>
<h5 data-id="heading-10">2.2 动态加载 Bundle (NativeDynamicLoader.kt)</h5>
<p>通过 JNI 获取 C++ Runtime 句柄并执行 JavaScript。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadBundle</span><span class="hljs-params">(bundlePath: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">val</span> jsiPtr = context.javaScriptContextHolder.<span class="hljs-keyword">get</span>()
    <span class="hljs-comment">// 通过 JNI 调用 C++ 层的 evaluateJavaScript</span>
    <span class="hljs-comment">// 逻辑：判断 bundlePath 是否已加载 -&gt; 未加载则读取文件并执行</span>
    nativeEvaluateJavaScript(jsiPtr, bundlePath)
}
</code></pre>
<hr/>
<h4 data-id="heading-11">3. iOS 端核心代码</h4>
<h5 data-id="heading-12">3.1 抽象 RNRuntimeManager</h5>
<p>在 Swift 中管理 <code>reactNativeFactory</code> 和 <code>reactNativeDelegate</code>，通过 <code>rootViewFactory</code> 创建视图。</p>
<h5 data-id="heading-13">3.2 动态加载 (RTNDynamicLoader)</h5>
<p>在新架构下，不再使用过时的 <code>bridge.executeSourceCode</code>。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// JSBundleLoader.swift 核心逻辑</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> runtimeExecutor <span class="hljs-operator">=</span> rootViewFactory.reactHost.surfacePresenter<span class="hljs-operator">?</span>.runtimeExecutor {
    <span class="hljs-comment">// 拿到 RuntimeExecutor 后，在 JS 线程执行业务代码</span>
    runtimeExecutor.execute { runtime <span class="hljs-keyword">in</span>
        <span class="hljs-comment">// 使用 C++ JSI 或内部 API 执行业务 Bundle 代码</span>
        loadBusinessBundle(path: bundlePath, in: runtime)
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-14">五、 总结与优势</h3>
<p>基于 RN 0.83.1 的这套拆包方案，完全摆脱了对 Legacy Bridge 的依赖：</p>
<ol>
<li><strong>极速加载：</strong> 利用 Hermes 字节码预编译，业务包加载近乎无感。</li>
<li><strong>灵活分发：</strong> 业务 Bundle 可独立更新，无需重新安装 App。</li>
<li><strong>架构对齐：</strong> 深度集成 <code>ReactHost</code> 和 <code>RuntimeExecutor</code>，完美兼容 Fabric 渲染引擎，是目前新架构下的最优实践。</li>
</ol>
<hr/>
<p><strong>发布建议：</strong></p>
<ul>
<li><strong>标签：</strong> React Native, Android, iOS, 拆包, 新架构, Hermes.</li>
<li><strong>摘要：</strong> 针对 React Native 0.83.1 最新版本，详细讲解如何在 Fabric 架构下实现单 Runtime 的业务拆包与动态加载。</li>
</ul>
<p>项目git地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fliu_520%2Fmulti-bundle-programs" target="_blank" title="https://gitee.com/liu_520/multi-bundle-programs" ref="nofollow noopener noreferrer">gitee.com/liu_520/mul…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24a4e69136164d47b348141a3ef51a6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YiY5oiQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767342202&amp;x-signature=L666HMQh1V%2FpMEy0ImdMUxqpack%3D" alt="SVID_20251226_160340_1.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别数据库“膨胀”：Dify x SLS 构建高可用生产级 AI 架构]]></title>    <link>https://juejin.cn/post/7587961565477060662</link>    <guid>https://juejin.cn/post/7587961565477060662</guid>    <pubDate>2025-12-26T09:04:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587961565477060662" data-draft-id="7587825268200112134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别数据库“膨胀”：Dify x SLS 构建高可用生产级 AI 架构"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-12-26T09:04:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别数据库“膨胀”：Dify x SLS 构建高可用生产级 AI 架构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:04:57.000Z" title="Fri Dec 26 2025 09:04:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：无哲、言合</p>
<h2 data-id="heading-0">一、前言：Dify 的规模化挑战</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e4b96578c324f8eb575aa3e339537b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=7esT50KRWjTd1U1Li%2FrZwedPkkw%3D" alt="image.png" loading="lazy"/></p>
<p>Dify 是当前最受欢迎的低代码 LLM 应用开发平台之一，在 Github 上已斩获 120k+ 的星标数。国内外有众多企业基于 Dify 构建自己的智能体应用。阿里云可观测团队既是 Dify 的深度用户，也是社区的活跃贡献者。</p>
<p>在大规模生产实践中，我们发现 Dify 在高负载场景下面临显著的数据库性能瓶颈：其执行引擎高度依赖 PostgreSQL，单次 Chat 请求可能触发数百甚至上千次数据库访问；与此同时，Worker 进程在知识库索引构建、Trace 追踪等任务中也会持续写入大量数据。这频繁导致 <strong>DB 连接池打满、慢查询频发</strong> 等问题，已成为制约 Dify 集群横向扩展与并发能力的关键瓶颈。</p>
<h2 data-id="heading-1">二、现状与挑战：Dify 存储机制痛点分析</h2>
<h3 data-id="heading-2">数据分布现状</h3>
<p>Dify 的数据主要分为三类：</p>
<ul>
<li>Meta类 数据：租户、应用、工作流、工具等配置信息；</li>
<li>运行时日志：工作流执行明细、会话历史、消息记录等；</li>
<li>文件类数据：用户上传文件、知识库文档、多模态输出等（通常存于对象存储）。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb0cebf88890443fb5ef43fed477af9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=mu7eRrlsWT0j5mRMUmkGPBTi5rA%3D" alt="图片" loading="lazy"/></p>
<p>其中Meta 与运行日志均存储在 PostgreSQL 中，运行时日志占据了数据库的绝大部分资源。以我们的生产环境为例，运行日志占 DB 存储空间的 95%以上。在访问频率最高和慢查询最多的 SQL 模式中，绝大多数都与运行日志的读写相关。</p>
<p>Dify 的运行日志包含工作流的执行明细记录和会话消息数据，执行记录中有工具输出、模型上下文等大量长文本信息，并且运行日志数量也会随着用户请求快速增长。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b166d94d3d384e4c9c9080eb2c5a9c2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=jBNWY8hOhvSbzd04lV8HEOsR%2BSY%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">核心痛点</h3>
<p>将这类海量、高吞吐的日志数据全量存储在 PostgreSQL 中，带来了多重挑战：</p>
<ul>
<li><strong>负载压力大：</strong> Workflow 节点的每次执行都会产生明细日志（节点执行明细数据，记录节点的输入输出和运行状态等数据），高并发下 <code>workflow_node_executions</code> 表的读写极易成为热点。</li>
<li><strong>连接占用：</strong> 尽管 Dify 1.x 的几个版本对数据库长连接问题做了很多优化（如 issue #22307[1]），但日志密集访问仍加剧连接池压力，影响核心业务的连接获取。</li>
<li><strong>扩展性不足：</strong> 运行日志随着业务量呈爆发式增长，而 PG 扩容依赖垂直升配，升级规格往往伴随主备切换导致的连接闪断或维护窗口，难以实现完全的无感扩容。社区已有多个反馈（如  issue #18800 [2]因会话数据堆积导致首 Token 延迟增加 3 秒； issue #22796 [3]呼吁将日志迁出 PG）</li>
<li><strong>分析加工能力缺失：</strong> 控制台仅支持有限关键词检索，难以满足业务对历史会话进行多维分析、二次加工及精细化运营的需求。</li>
</ul>
<h3 data-id="heading-4">社区的积极探索与演进</h3>
<p>运行日志存储一直是影响 Dify 系统性能与稳定性的痛点。针对这一问题，社区一直在积极寻求解决方案，并已落地了多项优化措施：</p>
<ul>
<li><strong>内存数据库</strong>（issue #20147[4]）：适用于无需持久化的轻量场景，同时新版执行引擎已完成日志存储抽象，为后续异构存储改造奠定了基础。</li>
<li><strong>后台异步执行</strong>（ issue #20050[5]）：通过 Celery Worker 异步写入日志，有效降低了核心链路的延迟，减轻了 API 引擎对 DB 的同步依赖。</li>
<li><strong>周期性清理</strong>（ issue #23399[6]）：引入自动清理机制，定期移除陈旧的会话与执行记录，有效缓解了数据库存储膨胀问题。</li>
<li><strong>大字段分离存储：</strong> 针对 LLM 长上下文导致的大字段问题，支持将超长字段截断并转存至对象存储，减轻了 DB 的 I/O 压力。</li>
</ul>
<h3 data-id="heading-5">根因分析：数据特征与存储引擎的错配</h3>
<p>上述优化在特定阶段非常有效，缓解了 Dify 的燃眉之急，但在大规模生产场景下，应用层的逻辑优化（异步、清理等）已触及天花板。要彻底解决扩展性问题，必须消除数据特征与存储引擎的错配——即我们一直在试图用“关系型数据库”去承载本该由“日志系统”处理的数据。</p>
<p>Dify 工作流记录虽然并非完全是Append-Only写，但具有鲜明的日志特征，与典型的业务数据（如用户信息、应用配置）截然不同：</p>
<ul>
<li><strong>终态不可变：</strong> 记录仅在执行期短暂流转，结束后即成为“只读”档案。在 PG 中长期留存海量只读数据，不仅挤占昂贵的 SSD 资源，庞大的表数据更会显著降低索引效率与查询性能。</li>
<li><strong>泛结构化与 Schema 易变：</strong> 核心负载为巨大的 JSON 对象（每个工作流节点的Inputs/Outputs），且结构随版本迭代。PG 难以高效处理深层 JSON 检索，且亿级大表的 DDL 变更会引发长时间锁表风险。</li>
<li><strong>高吞吐时序写入：</strong> 日志随时间源源不断地产生，持续消耗 IOPS 与数据库连接。请求高峰期极易导致连接池耗尽，导致创建应用等核心业务因资源争抢而失败。</li>
</ul>
<p>因此，我们需要一种支持<strong>存算分离、弹性伸缩、低成本且具备原生 OLAP 能力</strong>的存储架构。阿里云日志服务（SLS） 凭借其云原生特性，成为解决这一瓶颈的最佳选择。</p>
<h2 data-id="heading-6">三、方案选型：为什么 SLS 更适合 Dify 日志场景</h2>
<p>SLS 并不是“另一个数据库替代”，它是为日志场景量身定制的基础设施。在Dify工作流日志场景下，相比于 PG，SLS 在以下四个维度实现了架构上的优化升级：</p>
<h3 data-id="heading-7">极致弹性，应对流量波动</h3>
<p>Dify 业务常有突发流量（如 AI 推理高峰）。PostgreSQL 需按峰值预置硬件资源，低谷期的资源浪费，一旦流量突增超过预设上限，数据库稳定性会有问题。</p>
<p>而SLS 作为 SaaS 化云服务，天然支持秒级弹性伸缩，无须关心分片或容量上限，且默认支持 3AZ 同城冗余。</p>
<h3 data-id="heading-8">高写入吞吐 + 架构解耦，保障核心稳定</h3>
<ul>
<li><strong>高并发写入：</strong> SLS 针对日志场景优化，数据以追加方式顺序写入，避免了数据库中常见的随机 I/O 和锁竞争，能以极低成本支撑数万 TPS 的写入吞吐，轻松应对 AI 业务的写入洪峰。</li>
<li><strong>资源隔离：</strong> 将日志负载剥离至 SLS 云端，实现日志数据流与 Dify 核心业务事务的物理隔离，有效保障主业务系统的稳定性与性能。</li>
</ul>
<h3 data-id="heading-9">海量日志，低成本长期留存</h3>
<p>SLS 数据采用高压缩比技术，支持自动化分层存储，可将历史数据自动沉降至低频和归档存储，无需维护清理脚本，成本远低于数据库 SSD。这使得 Dify 能以极低的成本满足长周期的分析和审计需求。</p>
<h3 data-id="heading-10">开箱即用的数据价值释放能力</h3>
<ul>
<li><strong>Schema-on-Read：</strong> SLS 写入时不强制校验 Schema，完美适配 Dify 快速迭代带来的字段变更，无需对历史数据重新变更。</li>
<li><strong>秒级分析：</strong> SLS 内置了针对日志优化的分析引擎（倒排索引+列存）。开发者可以使用关键词从海量日志中检索，也可以利用 SQL 对亿级日志进行实时聚合分析，将日志数据转化为业务洞察。</li>
<li><strong>丰富数据生态：</strong> 日志在SLS中，可以进一步进行更完善的处理和分析，比如数据加工清洗、联合分析、可视化、告警、消费和投递等等。</li>
</ul>
<h2 data-id="heading-11">四、技术实现：核心架构改造与插件化</h2>
<p>为了将 SLS 引入 Dify，整个工程实施分为两个部分：一是对 Dify 核心的插件化改造，二是基于 SLS 读写日志的插件实现。</p>
<h3 data-id="heading-12">1.Dify 核心插件化改造</h3>
<p>Dify 早期架构中，工作流记录的读写逻辑深度耦合了 SQLAlchemy（PG ORM），扩展性受限。从 v1.4.1 以后社区引入了 WorkflowExecution 的领域模型（#20067[7]）并开始逐步对工作流执行核心流程进行重构，定义了一套标准的 Repository 接口，涵盖日志的写入、更新、读取以及统计等标准行为。在 v1.8.0 社区引入了 Repository 的异步实现，通过推迟日志记录保存提升了工作流执行速度。</p>
<p>虽然 Repository 接口为多存储驱动提供了可能，但早期的抽象并不彻底：它主要解决了“写”的抽象，但大量“读”操作仍绕过 Repository 直接依赖 SQLAlchemy，且复杂的跨表 Join 查询使得存储层难以真正剥离。</p>
<p>为此，我们和 Dify 研发团队多次交流，确定了 Repository 抽象层的完整实现方案。我们通过剥离跨表关联查询、标准化读取与统计接口，真正实现了存储层的完全解耦与插件化加载。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9134545808d64137babd480eb1803ce1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=F0EI47Kaaq%2BkVtx888Z%2ByO4qAZA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-13">2.SLS 日志插件实现</h3>
<p>在插件实现过程中，核心挑战在于抹平关系型数据库（PG）与日志系统（SLS）在数据模型上的差异。为此，我们采用了以下技术策略：</p>
<h4 data-id="heading-14">基于多版本的状态管理</h4>
<p>SLS 的 LogStore 是 Append-Only 追加写入，而Dify 的工作流执行过程存在状态流转，从 <code>RUNNING</code> 变为 <code>SUCCEEDED/FAIL</code>。因此我们采用了多版本控制的思路：</p>
<ul>
<li>写入策略：每次状态更新，不覆盖旧日志，而是新写入一条包含完整状态的日志记录。我们在日志模型中引入了一个纳秒级的时间戳字段 <code>log_version</code>来区分版本。</li>
<li>读取策略：在查询或统计时，插件内部会生成聚合 SQL，对于同一个 <code>workflow_run_id</code>，始终选取 <code>log_version</code> 最大的那条记录作为最终状态。</li>
</ul>
<h4 data-id="heading-15">Schema 自动同步</h4>
<p>Dify 的迭代速度非常快，数据库模型经常发生变更。如果每次升级 Dify 都需要用户手动维护索引配置，将极大地增加运维负担。SLS 插件启动时会自动扫描 SQLAlchemy 模型定义，并与 SLS 索引配置进行 Diff。一旦发现新字段，自动调用 API 更新索引。用户无需手动维护索引，开发者也无须为 SLS 单独编写升级脚本。</p>
<h4 data-id="heading-16">原生 PG 协议兼容</h4>
<p>值得一提的是，SLS 新增原生支持 PostgreSQL 协议。绝大部分原有的统计与分析 SQL，均可通过 PG 兼容模式直接发送到 SLS 上执行，极大地降低了插件的开发适配成本。</p>
<h2 data-id="heading-17">五、实践指南：配置与平滑迁移</h2>
<p>该功能已正式合并至 Dify 社区主分支。基于Dify最新代码，只需进行简单配置，就可以将工作流执行记录切换到SLS存储。</p>
<h3 data-id="heading-18">第一步：准备工作</h3>
<p>（1）创建 Project：在阿里云日志服务控制台创建 Project（建议与业务同地域）</p>
<blockquote>
<p>无需手动创建 Logstore 和索引，Dify 启动后插件会自动检测并创建。</p>
</blockquote>
<p>（2）获取访问凭证：获取具备 SLS 读写权限的 AccessKey ID 和 Secret。</p>
<blockquote>
<p>可以授予 <code>AliyunLogFullAccess</code>，或按需配置最小权限（创建/查看Project、创建/查看logstore、创建/更新/查看索引、写日志、查日志等）</p>
</blockquote>
<h3 data-id="heading-19">第二步：配置Dify</h3>
<p>在 <code>.env</code> 或 <code>docker-compose.yaml</code> 中修改以下配置项，将工作流存储驱动指向 SLS 插件，并补充连接信息：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 1. 修改 Repository 驱动指向 SLS 插件</span>
<span class="hljs-attr">CORE_WORKFLOW_EXECUTION_REPOSITORY</span>=extensions.logstore.repositories.logstore_workflow_execution_repository.LogstoreWorkflowExecutionRepository
<span class="hljs-attr">CORE_WORKFLOW_NODE_EXECUTION_REPOSITORY</span>=extensions.logstore.repositories.logstore_workflow_node_execution_repository.LogstoreWorkflowNodeExecutionRepository
<span class="hljs-attr">API_WORKFLOW_NODE_EXECUTION_REPOSITORY</span>=extensions.logstore.repositories.logstore_api_workflow_node_execution_repository.LogstoreAPIWorkflowNodeExecutionRepository
<span class="hljs-attr">API_WORKFLOW_RUN_REPOSITORY</span>=extensions.logstore.repositories.logstore_api_workflow_run_repository.LogstoreAPIWorkflowRunRepository

<span class="hljs-comment"># 2. 新增 SLS 连接配置</span>
<span class="hljs-attr">ALIYUN_SLS_ACCESS_KEY_ID</span>=your_access_key_id
<span class="hljs-attr">ALIYUN_SLS_ACCESS_KEY_SECRET</span>=your_access_key_secret
<span class="hljs-attr">ALIYUN_SLS_ENDPOINT</span>=cn-hangzhou.log.aliyuncs.com
<span class="hljs-attr">ALIYUN_SLS_REGION</span>=cn-hangzhou
<span class="hljs-attr">ALIYUN_SLS_PROJECT_NAME</span>=your_project_name
<span class="hljs-attr">ALIYUN_SLS_LOGSTORE_TTL</span>=<span class="hljs-number">365</span>  <span class="hljs-comment"># 日志存储天数</span>

<span class="hljs-comment"># 3. 迁移开关配置</span>
<span class="hljs-attr">LOGSTORE_DUAL_WRITE_ENABLED</span>=<span class="hljs-literal">false</span>
<span class="hljs-attr">LOGSTORE_DUAL_READ_ENABLED</span>=<span class="hljs-literal">true</span>
</code></pre>
<p>为了保证存量 PG 用户能平滑升级到 SLS 版本，我们在插件中提供了两个开关：</p>
<p>（1）双写机制：通过配置 <code>LOGSTORE_DUAL_WRITE_ENABLED=True</code>（默认关闭），系统会将日志同时写入 PG 和 SLS。这适用于存量用户迁移初期的灰度验证，确保在不改变原有数据流的情况下，验证 SLS 的配置正确性和 Dify 版本升级本身的兼容性。</p>
<p>（2）双读降级机制：通过配置 <code>LOGSTORE_DUAL_READ_ENABLED=True</code>（默认开启），系统优先从 SLS 读取日志。如果 SLS 中未找到该记录（例如迁移前的老历史数据），插件会自动降级回 PG 再次尝试读取。</p>
<h2 data-id="heading-20">六、成效对比：迁移到SLS的三大收益</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aea0cb21a5e24771aeffdf497955ece5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=DxndBXmlkeKxm1hQInl7Nas1ZQw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-21">收益一：DB压力显著下降</h3>
<p>切换到SLS，相当于把现有PG中数据量最大的两张表的数据迁移走了。根据我们线上业务的数据，DB减少了95%以上的存储空间（运行时间越长，这个比例越高），并且读写过程中的DB的连接数、CPU等压力也有显著降低。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4d2c9bfc0a7413c80c84ef6e342f40f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=onbuHtEOBnkJxbvllkTrlJuoNL8%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-22">收益二：存储成本大幅降低</h3>
<p>为了直观量化迁移后的成本收益，我们以一个典型的生产级场景进行估算：假设 Dify 应用日增日志 10GB，为了满足模型评估与回溯需求，需留存最近 300 天（约 3TB）的数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d62106f5d70411191263f4516ecbb77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=t0jTFhJJVBs9wMNLEBH0291WpA8%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>注：这里估算SLS成本的时候，已经将存多条状态记录会占用存储空间的因素考虑进去。 此外对于PG实际生产中还需额外考虑高可用多副本、预留存储空间、连接池扩容等隐性成本。</p>
</blockquote>
<p>这里造成近 10 倍成本差距 的根本原因在于存储机制的不同。</p>
<p>Dify的工作流记录包含了用户提问、知识召回、工具调用和模型响应等数据，是评估和回归等任务需要的数据资产，长期留存价值高。</p>
<ul>
<li><strong>对于 PG：</strong> 存储时间越长，数据量越大，对昂贵的 SSD 存储空间占用就越多，成本会大幅增长。pg实例需要提前预估存储空间，存储空间不可能完全利用起来，必然闲置一部分空间。</li>
<li><strong>对于 SLS：</strong> 专为日志设计的高压缩比与分层存储技术，使得存储数据量越大、时间越长，其边际成本优势越明显。</li>
</ul>
<h3 data-id="heading-23">收益三：数据价值释放，从“运维监控”到“业务洞察”</h3>
<p>这里我们以一个真实的 Dify 应用场景——“电商智能客服助手”为例，展示日志数据接入 SLS 后，如何挖掘其背后更大的业务价值。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34f07812069f4240a95ced39194b1c01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=GTVZOmUKBO82gcTS9uB7GtqXa1U%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-24">（1）无缝集成，原生体验</h4>
<p>接入 SLS 后，Dify 界面上的日志查询与回溯体验保持不变，但底层存储已完全切换。</p>
<ul>
<li>日志回溯：Dify 控制台的日志详情页直接从 SLS 读取数据，响应更迅速。</li>
<li>监控图表：Dify 内置的监控统计图表，也是通过执行 SLS SQL 实时生成的。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/488198cf9d744b73a6749e36e5a881d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=ZAz2mNYyhoeYHFd6dlOW0V8BZCY%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-25">（2）超越基础，SLS 进阶分析</h4>
<p>虽然 Dify 内置了基础查询和统计功能，但面对复杂的业务分析需求，我们可以直接转至 SLS 控制台，解锁更强大的能力。</p>
<ul>
<li><strong>任意字段的高速检索</strong></li>
</ul>
<p>SLS 支持全文索引和任意键值对条件的组合查询，快速精准检索出符合某种特定特征的日志。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0192c2f638134b7ebc8daf0d20ef34e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=yBjE%2BqKPuZ2yni%2B8A%2B9eteLnOr0%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>业务趋势分析（可视化）场景</strong></li>
</ul>
<p>比如这里我们分析“用户意图识别”这个工作流节点里，按识别出的用户意图的分类统计随时间变化的PV情，便于通过观察不同分类的趋势变化，做出相应的运营决策。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">*</span> <span class="hljs-keyword">and</span> title: 用户意图识别 <span class="hljs-keyword">and</span> intent <span class="hljs-operator">|</span> <span class="hljs-keyword">select</span> json_extract(outputs, <span class="hljs-string">'$.intent'</span>) <span class="hljs-keyword">as</span> "用户意图", date_trunc(<span class="hljs-string">'minute'</span>, __time__) t, <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> pv <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> "用户意图",t <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> t limit <span class="hljs-keyword">all</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/692159a7f5104fa69597b423df8b19bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=svJH61m4JahxuSeXK6brd3so%2By4%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>异常诊断（漏斗分析）场景</strong></li>
</ul>
<p>可以通过漏斗图，分析观察工作流哪些中间节点出现异常失败的比率较高。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">status:</span>succeeded | <span class="hljs-keyword">select</span> title, count(<span class="hljs-keyword">distinct</span> workflow_run_id) cnt <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> title <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> cnt desc
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9889e516acc4f90b5fad6938d3eec7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=w%2BQdP13JYArRO6PK%2FvGRitBiRy8%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>成本与风险风控（实时告警）场景</strong></li>
</ul>
<p>配置告警规则，统计 LLM 节点的 Token 消耗，一旦超过预设阈值，立即触发钉钉/电话告警。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e94041094dcf439f97c7315fcee0124a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=RJLTS3%2FglNn7YziG0zJyXZPygC8%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>数据闭环（ETL 与加工）场景</strong></li>
</ul>
<p>利用数据加工和定时 SQL，对工作流的输入输出进行清洗、脱敏与标准化，构建持续更新的评估与训练数据集。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e5a8e291fa24253b68e6ba96b991445~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344697&amp;x-signature=nw7RMdGNFYrnaJHMgSc5Hr4gXm0%3D" alt="图片" loading="lazy"/></p>
<p>总之，将 Dify 工作流日志接入 SLS，不仅能高效查询日志，更能通过分析、可视化、告警和数据加工，将日志转化为业务洞察，真正实现从“看日志”到“懂业务”的跃升。</p>
<h2 data-id="heading-26">七、总结：迈向生产级 AI 架构</h2>
<p>将 Dify 运行日志迁移至阿里云 SLS，并非一次简单的“存储替换”，而是 Dify 向生产级高可用架构演进的关键一跃。</p>
<p>我们通过业务数据与日志数据解耦的架构改造，成功将高吞吐、泛结构化的日志流从事务型数据库中剥离。让 PostgreSQL 专注核心业务事务处理，让 SLS 充分发挥其在海量数据存储与分析上的原生优势。</p>
<p>这一特性带来的价值是全方位的：</p>
<ul>
<li><strong>解决DB性能瓶颈：</strong> 将日志与核心事务解耦，从根本上解决数据库瓶颈，保证核心业务稳定性。</li>
<li><strong>大幅降低日志成本：</strong> 利用SLS的弹性伸缩、高压缩比、分层存储，低成本存储海量日志。</li>
<li><strong>充分释放数据价值：</strong> 从简单的日志查看升级为强大的实时分析、监控告警、加工处理，将运维数据转换为业务洞察。</li>
</ul>
<p>如果您正在构建大规模的 AI 应用，或者正被 Dify 数据库的性能瓶颈所困扰，现在就是升级的最佳时机。拥抱云原生日志架构，让您的 Dify 跑得更快、更稳、更智能。</p>
<p><strong>参考链接：</strong></p>
<p>[1]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Fissues%2F22307" target="_blank" title="https://github.com/langgenius/dify/issues/22307" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p>
<p>[2]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Fissues%2F18800%23event-17534118862" target="_blank" title="https://github.com/langgenius/dify/issues/18800#event-17534118862" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p>
<p>[3]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Fissues%2F22796" target="_blank" title="https://github.com/langgenius/dify/issues/22796" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p>
<p>[4]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Fissues%2F20147" target="_blank" title="https://github.com/langgenius/dify/issues/20147" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p>
<p>[5]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Fpull%2F20050" target="_blank" title="https://github.com/langgenius/dify/pull/20050" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p>
<p>[6]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Fissues%2F23399" target="_blank" title="https://github.com/langgenius/dify/issues/23399" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p>
<p>[7]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Fpull%2F20067" target="_blank" title="https://github.com/langgenius/dify/pull/20067" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack ViewModel内幕：内部机制与跨平台设计]]></title>    <link>https://juejin.cn/post/7587634022575472703</link>    <guid>https://juejin.cn/post/7587634022575472703</guid>    <pubDate>2025-12-25T12:29:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587634022575472703" data-draft-id="7587631760253566995" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack ViewModel内幕：内部机制与跨平台设计"/> <meta itemprop="keywords" content="Android,Android Jetpack,Kotlin"/> <meta itemprop="datePublished" content="2025-12-25T12:29:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="稀有猿诉"/> <meta itemprop="url" content="https://juejin.cn/user/2788017216685784"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack ViewModel内幕：内部机制与跨平台设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017216685784/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    稀有猿诉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T12:29:27.000Z" title="Thu Dec 25 2025 12:29:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文译自「Inside Jetpack ViewModel: Internal Mechanisms and Multiplatform Design」，原文链接<a href="https://link.juejin.cn?target=https%3A%2F%2Fproandroiddev.com%2Finside-jetpack-viewmodel-internal-mechanisms-and-multiplatform-design-2625671eaef8" target="_blank" title="https://proandroiddev.com/inside-jetpack-viewmodel-internal-mechanisms-and-multiplatform-design-2625671eaef8" ref="nofollow noopener noreferrer">proandroiddev.com/inside-jetp…</a>，由Jaewoong Eum发布于2025年12月7日。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e851a5c89cf84d56883d19e87a66312f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767270566&amp;x-signature=HWDRdZzKfSIhfBj5JrghD3QEsaY%3D" alt="Unsplash@davidvig" loading="lazy"/></p>
<p>Jetpack 的 ViewModel 已成为现代 Android 开发中不可或缺的组件，它为 UI 相关数据提供了一个生命周期感知容器，即使配置发生更改，数据也能保持不变。虽然其 API 表面上看起来很简单，但其内部机制却展现了围绕生命周期管理、跨平台抽象、资源清理和线程安全缓存等方面的设计决策。了解 ViewModel 的底层工作原理有助于你做出更优的架构决策，并避免一些不易察觉的错误。</p>
<p>本文将深入探讨 Jetpack ViewModel 的内部工作原理，包括 <code>ViewModelStore</code> 如何在配置更改后保留实例、<code>ViewModelProvider</code> 如何协调创建和缓存、工厂模式如何实现灵活的实例化、<code>CreationExtras</code> 如何实现无状态工厂、如何通过 Closeable 模式管理资源清理，以及 <code>viewModelScope</code> 如何将协程与 ViewModel 生命周期集成。</p>
<h2 data-id="heading-0">根本问题：配置更改后的保留</h2>
<p>配置更改是 Android 开发面临的一项根本性挑战。当用户旋转设备、更改语言设置或触发任何配置更改时，系统会销毁并重新创建 Activity。Activity 中存储的所有数据都会丢失：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> userData: User? = <span class="hljs-literal">null</span>  <span class="hljs-comment">// Lost on rotation!</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        <span class="hljs-comment">// Must reload data after every rotation</span>
        loadUserData()
    }
}
</code></pre>
<p>一种简单的方法是使用 <code>onSaveInstanceState()</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSaveInstanceState</span><span class="hljs-params">(outState: <span class="hljs-type">Bundle</span>)</span></span> {
    <span class="hljs-keyword">super</span>.onSaveInstanceState(outState)
    outState.putParcelable(<span class="hljs-string">"user"</span>, userData)
}

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
    <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
    userData = savedInstanceState?.getParcelable(<span class="hljs-string">"user"</span>)
}
</code></pre>
<p>这种方法适用于小型、可序列化的数据。但是，对于大型数据集、网络连接或无法序列化的对象呢？对于持续进行的网络请求等操作呢？Bundle 方法在这些情况下会失效，原因既有大小限制，也有序列化/反序列化的高昂开销。</p>
<p>ViewModel 通过提供一个生命周期感知容器来解决这个问题，该容器通过保留对象模式（而非序列化）来应对配置更改。</p>
<h2 data-id="heading-1">ViewModelStore：保留机制</h2>
<p>ViewModel 配置变更后仍能保留的核心是 <code>ViewModelStore</code>，它是一个简单的键值存储，用于保存 ViewModel 实例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModelStore</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> map = mutableMapOf&lt;String, ViewModel&gt;()

    <span class="hljs-meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">put</span><span class="hljs-params">(key: <span class="hljs-type">String</span>, viewModel: <span class="hljs-type">ViewModel</span>)</span></span> {
        <span class="hljs-keyword">val</span> oldViewModel = map.put(key, viewModel)
        oldViewModel?.clear()
    }

    <span class="hljs-meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">get</span><span class="hljs-params">(key: <span class="hljs-type">String</span>)</span></span>: ViewModel? {
        <span class="hljs-keyword">return</span> map[key]
    }

    <span class="hljs-meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">keys</span><span class="hljs-params">()</span></span>: Set&lt;String&gt; {
        <span class="hljs-keyword">return</span> HashSet(map.keys)
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">for</span> (vm <span class="hljs-keyword">in</span> map.values) {
            vm.clear()
        }
        map.clear()
    }
}
</code></pre>
<p>实现非常简单，就是一个 <code>MutableMap&lt;String, ViewModel&gt;</code>。关键不在于存储本身，而在于存储的保留方式。</p>
<h3 data-id="heading-2">键替换行为</h3>
<p>请注意 <code>put</code> 方法的行为：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">put</span><span class="hljs-params">(key: <span class="hljs-type">String</span>, viewModel: <span class="hljs-type">ViewModel</span>)</span></span> {
    <span class="hljs-keyword">val</span> oldViewModel = map.put(key, viewModel)
    oldViewModel?.clear()
}
</code></pre>
<p>如果已存在具有相同键的 ViewModel，则旧的 ViewModel 会被立即清除。这确保了在替换 ViewModel 时能够正确清理。你可能想知道这种情况何时发生，它发生在你请求具有相同键但类型不同的 ViewModel 时：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// First request creates TestViewModel1 with key "my_key"</span>
<span class="hljs-keyword">val</span> vm1: TestViewModel1 = viewModelProvider[<span class="hljs-string">"my_key"</span>, TestViewModel1::<span class="hljs-keyword">class</span>]

<span class="hljs-comment">// Second request with same key but different type</span>
<span class="hljs-keyword">val</span> vm2: TestViewModel2 = viewModelProvider[<span class="hljs-string">"my_key"</span>, TestViewModel2::<span class="hljs-keyword">class</span>]

<span class="hljs-comment">// vm1.onCleared() has been called, vm1 is no longer valid</span>
</code></pre>
<p>此行为已在测试套件中验证：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">twoViewModelsWithSameKey</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> key = <span class="hljs-string">"the_key"</span>
    <span class="hljs-keyword">val</span> vm1 = viewModelProvider[key, TestViewModel1::<span class="hljs-keyword">class</span>]
    assertThat(vm1.cleared).isFalse()
    <span class="hljs-keyword">val</span> vw2 = viewModelProvider[key, TestViewModel2::<span class="hljs-keyword">class</span>]
    assertThat(vw2).isNotNull()
    assertThat(vm1.cleared).isTrue()
}
</code></pre>
<h3 data-id="heading-3">ViewModelStoreOwner 契约</h3>
<p><code>ViewModelStoreOwner</code> 接口定义了谁拥有该存储：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ViewModelStoreOwner</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> viewModelStore: ViewModelStore
}
</code></pre>
<p><code>ComponentActivity</code>、<code>Fragment</code> 和 <code>NavBackStackEntry</code> 都实现了这个简单的接口。所有者的职责有两方面：</p>
<ol>
<li><strong>在配置更改后保留存储</strong>：存储必须在 Activity 重建后仍然存在。</li>
<li><strong>在真正完成后清除存储</strong>：当所有者被销毁而未重建时，调用 <code>ViewModelStore.clear()</code>。</li>
</ol>
<p>对于 Activity 而言，这通常使用 <code>NonConfigurationInstances</code> 来实现，这是一种特殊的机制，允许对象在配置更改后仍然存在。Activity 框架在 <code>onRetainNonConfigurationInstance()</code> 期间保留这些对象，并在 <code>getLastNonConfigurationInstance()</code> 中恢复它们。</p>
<h3 data-id="heading-4">为什么简单的映射有效</h3>
<p>你可能期望使用复杂的缓存机制，但简单的 <code>MutableMap</code> 就足够了，原因如下：</p>
<ol>
<li><strong>大小有限</strong>：每个屏幕上的 ViewModel 数量很少（通常为 1-5 个）。</li>
<li><strong>字符串键</strong>：键由类名生成，使得查找复杂度为 O(1)，并且哈希分布良好。</li>
<li><strong>无需驱逐</strong>：ViewModel 仅在显式请求或所有者被销毁时才会被清除。</li>
<li><strong>线程安全</strong>：访问在 ViewModelProvider 级别同步。</li>
</ol>
<h2 data-id="heading-5">ViewModelProvider：编排层</h2>
<p><code>ViewModelProvider</code> 是获取 ViewModel 实例的主要 API。它负责编排 store、factory 和创建 extras 之间的交互：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModelProvider</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> impl: ViewModelProviderImpl) {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">constructor</span>(
        store: ViewModelStore,
        factory: Factory,
        defaultCreationExtras: CreationExtras = CreationExtras.Empty,
    ) : <span class="hljs-keyword">this</span>(ViewModelProviderImpl(store, factory, defaultCreationExtras))

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">constructor</span>(
        owner: ViewModelStoreOwner
    ) : <span class="hljs-keyword">this</span>(
        store = owner.viewModelStore,
        factory = ViewModelProviders.getDefaultFactory(owner),
        defaultCreationExtras = ViewModelProviders.getDefaultCreationExtras(owner),
    )

    <span class="hljs-meta">@MainThread</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">get</span><span class="hljs-params">(modelClass: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T =
        impl.getViewModel(modelClass)

    <span class="hljs-meta">@MainThread</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">get</span><span class="hljs-params">(key: <span class="hljs-type">String</span>, modelClass: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T =
        impl.getViewModel(modelClass, key)
}
</code></pre>
<h3 data-id="heading-6">多平台抽象</h3>
<p>请注意 <code>ViewModelProviderImpl</code> 委托。ViewModel 库是一个 Kotlin 多平台库，支持 JVM、Android、iOS 和其他平台。Kotlin 多平台目前还不支持带有默认实现的 expect 类，因此通用逻辑被提取到内部实现类中：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModelProviderImpl</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> store: ViewModelStore,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> factory: ViewModelProvider.Factory,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> defaultExtras: CreationExtras,
) {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> lock = SynchronizedObject()

    <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
    <span class="hljs-keyword">internal</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">getViewModel</span><span class="hljs-params">(
        modelClass: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;,
        key: <span class="hljs-type">String</span> = ViewModelProviders.getDefaultKey(modelClass)</span></span>,
    ): T {
        <span class="hljs-keyword">return</span> synchronized(lock) {
            <span class="hljs-keyword">val</span> viewModel = store[key]
            <span class="hljs-keyword">if</span> (modelClass.isInstance(viewModel)) {
                <span class="hljs-keyword">if</span> (factory <span class="hljs-keyword">is</span> ViewModelProvider.OnRequeryFactory) {
                    factory.onRequery(viewModel!!)
                }
                <span class="hljs-keyword">return</span><span class="hljs-symbol">@synchronized</span> viewModel <span class="hljs-keyword">as</span> T
            }

            <span class="hljs-keyword">val</span> modelExtras = MutableCreationExtras(defaultExtras)
            modelExtras[ViewModelProvider.VIEW_MODEL_KEY] = key

            <span class="hljs-keyword">return</span><span class="hljs-symbol">@synchronized</span> createViewModel(factory, modelClass, modelExtras).also { vm -&gt;
                store.put(key, vm)
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-7">获取或创建模式</h3>
<p><code>getViewModel</code> 方法实现了经典的获取或创建模式：</p>
<ol>
<li><strong>生成键</strong>：默认键基于类的规范名称。</li>
<li><strong>检查缓存</strong>：通过键查找已存在的 ViewModel。</li>
<li><strong>类型检查</strong>：验证缓存实例的类型是否正确。</li>
<li><strong>返回缓存</strong>：如果有效，则返回缓存的实例。</li>
<li><strong>创建新实例</strong>：如果未找到或类型错误，则通过工厂模式创建新实例。</li>
<li><strong>存储</strong>：将新实例放入存储中。</li>
</ol>
<h3 data-id="heading-8">使用同步访问确保线程安全</h3>
<p><code>synchronized(lock)</code> 代码块确保线程安全访问。虽然 ViewModel 的访问通常来自主线程（如 <code>@MainThread</code> 所示），但同步机制可以防止后台线程访问 ViewModel 等极端情况，尤其是在测试场景或使用 <code>viewModelScope</code> 时。</p>
<h3 data-id="heading-9">OnRequeryFactory 回调</h3>
<p><code>OnRequeryFactory</code> 是一种特殊的机制，用于在检索缓存的 ViewModel 时执行操作的工厂：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OnRequeryFactory</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onRequery</span><span class="hljs-params">(viewModel: <span class="hljs-type">ViewModel</span>)</span></span> {}
}
</code></pre>
<p><code>SavedStateHandle</code> 内部使用此机制在配置更改后将 ViewModel 与当前的 SavedStateRegistry 重新连接。当从缓存中检索 ViewModel 时，会调用工厂的 <code>onRequery</code> 方法，从而更新可能已更改的引用。</p>
<h3 data-id="heading-10">从类名生成键</h3>
<p>默认的键生成机制可防止意外冲突：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">getDefaultKey</span><span class="hljs-params">(modelClass: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: String {
    <span class="hljs-keyword">val</span> canonicalName =
        requireNotNull(modelClass.canonicalName) {
            <span class="hljs-string">"Local and anonymous classes can not be ViewModels"</span>
        }
    <span class="hljs-keyword">return</span> <span class="hljs-string">"<span class="hljs-variable">$VIEW_MODEL_PROVIDER_DEFAULT_KEY</span>:<span class="hljs-variable">$canonicalName</span>"</span>
}
</code></pre>
<p>前缀 <code>"androidx.lifecycle.ViewModelProvider.DefaultKey:"</code> 可确保键不会与用户提供的自定义键冲突。规范名称要求也解释了为什么本地类和匿名类不能是 ViewModel，因为它们没有规范名称：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">localViewModel</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalViewModel</span> : <span class="hljs-type">ViewModel</span>()
    <span class="hljs-keyword">try</span> {
        viewModelProvider[LocalViewModel::<span class="hljs-keyword">class</span>]
        fail(<span class="hljs-string">"Expected `IllegalArgumentException`"</span>)
    } <span class="hljs-keyword">catch</span> (e: IllegalArgumentException) {
        assertThat(e)
            .hasMessageThat()
            .contains(<span class="hljs-string">"Local and anonymous classes can not be ViewModels"</span>)
    }
}
</code></pre>
<h2 data-id="heading-11">工厂模式：灵活实例化</h2>
<p><code>ViewModelProvider.Factory</code> 是创建 ViewModel 实例的机制：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Factory</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">create</span><span class="hljs-params">(modelClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T =
        ViewModelProviders.unsupportedCreateViewModel()

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">create</span><span class="hljs-params">(modelClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;, extras: <span class="hljs-type">CreationExtras</span>)</span></span>: T =
        create(modelClass)

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">create</span><span class="hljs-params">(modelClass: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;, extras: <span class="hljs-type">CreationExtras</span>)</span></span>: T =
        create(modelClass.java, extras)
}
</code></pre>
<h3 data-id="heading-12">方法重载链</h3>
<p>工厂接口有三个 <code>create</code> 方法变体，形成一个链：</p>
<ol>
<li><code>create(KClass&lt;T&gt;, CreationExtras)</code>：Kotlin 优先 API，委托给 Java 变体</li>
<li><code>create(Class&lt;T&gt;, CreationExtras)</code>：主要实现点，默认为无附加组件的变体</li>
<li><code>create(Class&lt;T&gt;)</code>：传统 API，默认抛出异常</li>
</ol>
<p>此链在保持向后兼容性的同时，也鼓励使用基于 <code>CreationExtras</code> 的现代方法。</p>
<h3 data-id="heading-13">NewInstanceFactory：基于反射的创建</h3>
<p>最简单的工厂使用反射来创建带有无参构造函数的 ViewModel：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NewInstanceFactory</span> : <span class="hljs-type">Factory</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">create</span><span class="hljs-params">(modelClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T =
        JvmViewModelProviders.createViewModel(modelClass)
}
</code></pre>
<p>JVM 实现使用反射并进行了细致的错误处理：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">object</span> JvmViewModelProviders {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">createViewModel</span><span class="hljs-params">(modelClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T {
        <span class="hljs-keyword">val</span> <span class="hljs-keyword">constructor</span> =
            <span class="hljs-keyword">try</span> {
                modelClass.getDeclaredConstructor()
            } <span class="hljs-keyword">catch</span> (e: NoSuchMethodException) {
                <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Cannot create an instance of <span class="hljs-variable">$modelClass</span>"</span>, e)
            }

        <span class="hljs-comment">// Enforce public constructor for consistent behavior</span>
        <span class="hljs-keyword">if</span> (!Modifier.isPublic(<span class="hljs-keyword">constructor</span>.modifiers)) {
            <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Cannot create an instance of <span class="hljs-variable">$modelClass</span>"</span>)
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">constructor</span>.newInstance()
        } <span class="hljs-keyword">catch</span> (e: InstantiationException) {
            <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Cannot create an instance of <span class="hljs-variable">$modelClass</span>"</span>, e)
        } <span class="hljs-keyword">catch</span> (e: IllegalAccessException) {
            <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Cannot create an instance of <span class="hljs-variable">$modelClass</span>"</span>, e)
        }
    }
}
</code></pre>
<p>公共修饰符检查对于测试一致性至关重要。在插桩测试中，R8 可能会移除访问修饰符，使私有构造函数可访问。JVM 测试严格执行访问限制。此显式检查可确保跨测试环境的行为一致性。</p>
<h3 data-id="heading-14">AndroidViewModelFactory：应用感知创建</h3>
<p><code>AndroidViewModelFactory</code> 继承自 <code>NewInstanceFactory</code> 以支持 <code>AndroidViewModel</code>，后者需要一个 <code>Application</code> 参数。该工厂在保持向后兼容性的同时，也采用了现代的 <code>CreationExtras</code> 方法：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AndroidViewModelFactory</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> application: Application?,
    <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNUSED_PARAMETER"</span>)</span> unused: <span class="hljs-built_in">Int</span>,
) : NewInstanceFactory() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">create</span><span class="hljs-params">(modelClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;, extras: <span class="hljs-type">CreationExtras</span>)</span></span>: T {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (application != <span class="hljs-literal">null</span>) {
            create(modelClass)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">val</span> application = extras[APPLICATION_KEY]
            <span class="hljs-keyword">if</span> (application != <span class="hljs-literal">null</span>) {
                create(modelClass, application)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (AndroidViewModel::<span class="hljs-keyword">class</span>.java.isAssignableFrom(modelClass)) {
                    <span class="hljs-keyword">throw</span> IllegalArgumentException(
                        <span class="hljs-string">"CreationExtras must have an application by `APPLICATION_KEY`"</span>
                    )
                }
                <span class="hljs-keyword">super</span>.create(modelClass)
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">create</span><span class="hljs-params">(modelClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;, app: <span class="hljs-type">Application</span>)</span></span>: T {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (AndroidViewModel::<span class="hljs-keyword">class</span>.java.isAssignableFrom(modelClass)) {
            <span class="hljs-keyword">try</span> {
                modelClass.getConstructor(Application::<span class="hljs-keyword">class</span>.java).newInstance(app)
            } <span class="hljs-keyword">catch</span> (e: NoSuchMethodException) {
                <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Cannot create an instance of <span class="hljs-variable">$modelClass</span>"</span>, e)
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">super</span>.create(modelClass)
    }
}
</code></pre>
<p>该工厂实现了级联解析策略：首先检查是否将 <code>Application</code> 传递给了构造函数（传统方法），然后通过 <code>APPLICATION_KEY</code> 在 <code>CreationExtras</code> 中查找（现代无状态方法），最后对于常规 ViewModel 回退到 <code>NewInstanceFactory</code>，或者如果 <code>AndroidViewModel</code> 没有可用的 <code>Application</code>，则抛出异常。</p>
<p>私有构造函数中的 <code>unused: Int</code> 参数是一个巧妙的技巧，用于区分重载构造函数，因为如果使用 <code>null</code> 调用 <code>constructor()</code>，编译器将无法区分 <code>constructor(application: Application?)</code>。</p>
<p>实例化使用了反射（<code>modelClass.getConstructor(Application::class.java).newInstance(app)</code>），这意味着你的 <code>AndroidViewModel</code> 子类必须有一个接受且仅接受一个 <code>Application</code> 参数的构造函数。对于其他依赖项，你需要自定义工厂或依赖注入框架，例如 Hilt。</p>
<h3 data-id="heading-15">InitializerViewModelFactory：基于 Lambda 的创建</h3>
<p>对于具有自定义依赖项的 ViewModel，<code>InitializerViewModelFactory</code> 提供了一种基于 DSL 的方法，可以减少样板代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> factory = viewModelFactory {
    initializer { MyViewModel(<span class="hljs-keyword">get</span>(MY_KEY)) }
    initializer { AnotherViewModel(<span class="hljs-keyword">get</span>(ANOTHER_KEY)) }
}
</code></pre>
<p>该 DSL 由一个构建器类驱动，该构建器类收集初始化 Lambda 表达式，其中每个初始化器将一个 <code>KClass</code> 与其创建 Lambda 表达式配对：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@ViewModelFactoryDsl</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InitializerViewModelFactoryBuilder</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">constructor</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> initializers = mutableMapOf&lt;KClass&lt;*&gt;, ViewModelInitializer&lt;*&gt;&gt;()

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">addInitializer</span><span class="hljs-params">(
        clazz: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;,
        initializer: <span class="hljs-type">CreationExtras</span>.() -&gt; <span class="hljs-type">T</span>,
    )</span></span> {
        require(clazz !<span class="hljs-keyword">in</span> initializers) {
            <span class="hljs-string">"A `initializer` with the same `clazz` has already been added: <span class="hljs-subst">${clazz.canonicalName}</span>."</span>
        }
        initializers[clazz] = ViewModelInitializer(clazz, initializer)
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>: ViewModelProvider.Factory =
        ViewModelProviders.createInitializerFactory(initializers.values)
}
</code></pre>
<p><code>@ViewModelFactoryDsl</code> 注解是一个 DSL 标记，可防止嵌套的构建器作用域意外访问外部作用域的方法。初始化 Lambda 表达式接收 <code>CreationExtras</code> 作为其接收器，允许通过 <code>get()</code> 直接访问额外内容。</p>
<p>在创建时，工厂会通过初始化器进行线性搜索，以找到匹配的类：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;VM : ViewModel&gt;</span> <span class="hljs-title">createViewModelFromInitializers</span><span class="hljs-params">(
    modelClass: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">VM</span>&gt;,
    extras: <span class="hljs-type">CreationExtras</span>,
    <span class="hljs-keyword">vararg</span> initializers: <span class="hljs-type">ViewModelInitializer</span>&lt;*&gt;,
)</span></span>: VM {
    <span class="hljs-keyword">val</span> viewModel =
        initializers.firstOrNull { it.clazz == modelClass }?.initializer?.invoke(extras) <span class="hljs-keyword">as</span> VM?
    <span class="hljs-keyword">return</span> requireNotNull(viewModel) {
        <span class="hljs-string">"No initializer set for given class <span class="hljs-subst">${modelClass.canonicalName}</span>"</span>
    }
}
</code></pre>
<p>线性搜索是可以接受的，因为每个工厂创建的 ViewModel 数量通常很少（1-5 个），而且 ViewModel 的创建频率很低（每个生命周期一次）。</p>
<h2 data-id="heading-16">CreationExtras：无状态工厂配置</h2>
<p><code>CreationExtras</code> 是一个类型安全的键值容器，用于在不使工厂成为有状态的情况下向其传递配置。工厂不再通过构造函数注入来持有依赖项，而是在创建时传递依赖项：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreationExtras</span> <span class="hljs-keyword">internal</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">val</span> extras: MutableMap&lt;Key&lt;*&gt;, Any?&gt; = mutableMapOf()

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Key</span>&lt;<span class="hljs-type">T</span>&gt;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">get</span><span class="hljs-params">(key: <span class="hljs-type">Key</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T?

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">object</span> Empty : CreationExtras() {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">get</span><span class="hljs-params">(key: <span class="hljs-type">Key</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T? = <span class="hljs-literal">null</span>
    }
}
</code></pre>
<h3 data-id="heading-17">类型安全的键</h3>
<p>每个键都由其关联的值类型参数化，从而提供编译时类型安全。当你使用 <code>extras[APPLICATION_KEY]</code> 获取值时，返回类型会自动为 <code>Application?</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> APPLICATION_KEY: Key&lt;Application&gt; = CreationExtras.Companion.Key()
<span class="hljs-keyword">val</span> VIEW_MODEL_KEY: Key&lt;String&gt; = CreationExtras.Companion.Key()
</code></pre>
<p>键的创建使用了一个内联函数，该函数创建一个实现 <code>Key</code> 接口的新匿名对象。由于每个键都是一个唯一的对象实例，因此键之间通过标识（<code>===</code>）进行比较，即使两个键具有相同的类型参数，也不会发生意外冲突：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@JvmStatic</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T&gt;</span> <span class="hljs-title">Key</span><span class="hljs-params">()</span></span>: Key&lt;T&gt; = <span class="hljs-keyword">object</span> : Key&lt;T&gt; {}
</code></pre>
<h3 data-id="heading-18">用于修改的 MutableCreationExtras</h3>
<p>基类 <code>CreationExtras</code> 是只读的，而 <code>MutableCreationExtras</code> 允许添加条目。这种分离遵循 Kotlin 的集合设计理念（例如 <code>List</code> 与 <code>MutableList</code>），防止工厂意外修改共享的 extras：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MutableCreationExtras</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">constructor</span>(initialExtras: CreationExtras = Empty) : CreationExtras() {

    <span class="hljs-keyword">init</span> {
        extras += initialExtras.extras
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">set</span><span class="hljs-params">(key: <span class="hljs-type">Key</span>&lt;<span class="hljs-type">T</span>&gt;, t: <span class="hljs-type">T</span>)</span></span> {
        extras[key] = t
    }

    <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">get</span><span class="hljs-params">(key: <span class="hljs-type">Key</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T? = extras[key] <span class="hljs-keyword">as</span> T?
}
</code></pre>
<h3 data-id="heading-19">与 ViewModelProvider 集成</h3>
<p><code>ViewModelProvider</code> 会在调用工厂之前自动将 ViewModel 的键添加到 extras 中，这对于像 <code>SavedStateHandle</code> 这样需要键来正确限定持久化范围的功能至关重要：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> modelExtras = MutableCreationExtras(defaultExtras)
modelExtras[ViewModelProvider.VIEW_MODEL_KEY] = key

<span class="hljs-keyword">return</span><span class="hljs-symbol">@synchronized</span> createViewModel(factory, modelClass, modelExtras)
</code></pre>
<h3 data-id="heading-20">HasDefaultViewModelProviderFactory</h3>
<p><code>ViewModelStoreOwner</code> 的实现可以通过 <code>HasDefaultViewModelProviderFactory</code> 接口提供默认的工厂和 extras。 <code>ComponentActivity</code> 和 <code>Fragment</code> 都实现了此接口，并提供了支持 <code>SavedStateHandle</code> 且预先填充了 <code>APPLICATION_KEY</code> 的工厂：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HasDefaultViewModelProviderFactory</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> defaultViewModelProviderFactory: ViewModelProvider.Factory

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> defaultViewModelCreationExtras: CreationExtras
        <span class="hljs-keyword">get</span>() = CreationExtras.Empty
}
</code></pre>
<p><code>ComponentActivity</code> 和 <code>Fragment</code> 都实现了此接口，并提供了支持 <code>SavedStateHandle</code> 和正确的 <code>CreationExtras</code> 且预先填充了 <code>APPLICATION_KEY</code> 的工厂。</p>
<p>从 <code>ViewModelStoreOwner</code> 创建 <code>ViewModelProvider</code> 时，会自动使用以下默认值：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getDefaultFactory</span><span class="hljs-params">(owner: <span class="hljs-type">ViewModelStoreOwner</span>)</span></span>: ViewModelProvider.Factory =
    <span class="hljs-keyword">if</span> (owner <span class="hljs-keyword">is</span> HasDefaultViewModelProviderFactory) {
        owner.defaultViewModelProviderFactory
    } <span class="hljs-keyword">else</span> {
        DefaultViewModelProviderFactory
    }

<span class="hljs-keyword">internal</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getDefaultCreationExtras</span><span class="hljs-params">(owner: <span class="hljs-type">ViewModelStoreOwner</span>)</span></span>: CreationExtras =
    <span class="hljs-keyword">if</span> (owner <span class="hljs-keyword">is</span> HasDefaultViewModelProviderFactory) {
        owner.defaultViewModelCreationExtras
    } <span class="hljs-keyword">else</span> {
        CreationExtras.Empty
    }
</code></pre>
<p>这种模式支持渐进增强：简单的 ViewModel 使用默认工厂，而复杂的 ViewModel 可以通过 extras 获取丰富的配置，而无需更改获取 ViewModelProvider 的方式。</p>
<h2 data-id="heading-21">ViewModel 类：资源管理</h2>
<p><code>ViewModel</code> 类通过 <code>AutoCloseable</code> 模式管理资源生命周期。<code>expect</code> 关键字表明这是一个 Kotlin 多平台声明，每个平台都提供自己的 <code>actual</code> 实现：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">expect</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModel</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">constructor</span>()
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">constructor</span>(viewModelScope: CoroutineScope)
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">constructor</span>(<span class="hljs-keyword">vararg</span> closeables: AutoCloseable)
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">constructor</span>(viewModelScope: CoroutineScope, <span class="hljs-keyword">vararg</span> closeables: AutoCloseable)

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCleared</span><span class="hljs-params">()</span></span>

    <span class="hljs-meta">@MainThread</span> <span class="hljs-keyword">internal</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span>

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addCloseable</span><span class="hljs-params">(key: <span class="hljs-type">String</span>, closeable: <span class="hljs-type">AutoCloseable</span>)</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addCloseable</span><span class="hljs-params">(closeable: <span class="hljs-type">AutoCloseable</span>)</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : AutoCloseable&gt;</span> <span class="hljs-title">getCloseable</span><span class="hljs-params">(key: <span class="hljs-type">String</span>)</span></span>: T?
}
</code></pre>
<h3 data-id="heading-22">ViewModelImpl 内部实现</h3>
<p>实际实现委托给 <code>ViewModelImpl</code>，遵循多平台模式，将通用逻辑提取到内部类中。<code>isCleared</code> 上的 <code>@Volatile</code> 注解确保跨线程可见，这对于清除后的保护机制至关重要：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModelImpl</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> lock = SynchronizedObject()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> keyToCloseables = mutableMapOf&lt;String, AutoCloseable&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> closeables = mutableSetOf&lt;AutoCloseable&gt;()

    <span class="hljs-meta">@Volatile</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isCleared = <span class="hljs-literal">false</span>

    <span class="hljs-keyword">constructor</span>()

    <span class="hljs-keyword">constructor</span>(viewModelScope: CoroutineScope) {
        addCloseable(VIEW_MODEL_SCOPE_KEY, viewModelScope.asCloseable())
    }

    <span class="hljs-keyword">constructor</span>(<span class="hljs-keyword">vararg</span> closeables: AutoCloseable) {
        <span class="hljs-keyword">this</span>.closeables += closeables
    }

    <span class="hljs-keyword">constructor</span>(viewModelScope: CoroutineScope, <span class="hljs-keyword">vararg</span> closeables: AutoCloseable) {
        addCloseable(VIEW_MODEL_SCOPE_KEY, viewModelScope.asCloseable())
        <span class="hljs-keyword">this</span>.closeables += closeables
    }
}
</code></pre>
<h3 data-id="heading-23">两层可关闭存储</h3>
<p>该实现维护两个集合：<code>keyToCloseables</code> 用于注册后需要检索的资源（例如 <code>viewModelScope</code>），以及 <code>closeables</code> 用于即用即弃的清理。使用 <code>Set</code> 来管理匿名可关闭资源可以防止重复注册导致双重关闭。</p>
<h3 data-id="heading-24">清除顺序</h3>
<p>当 ViewModel 被清除时，资源会按照特定的顺序进行清理。<code>isCleared = true</code> 标志会在同步代码块之前设置，以防止并发的 <code>addCloseable</code> 调用添加会被遗漏的资源：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@MainThread</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">if</span> (isCleared) <span class="hljs-keyword">return</span>

    isCleared = <span class="hljs-literal">true</span>
    synchronized(lock) {
        <span class="hljs-keyword">for</span> (closeable <span class="hljs-keyword">in</span> keyToCloseables.values) {
            closeWithRuntimeException(closeable)
        }
        <span class="hljs-keyword">for</span> (closeable <span class="hljs-keyword">in</span> closeables) {
            closeWithRuntimeException(closeable)
        }
        <span class="hljs-comment">// Clear only resources without keys to prevent accidental recreation</span>
        closeables.clear()
    }
}
</code></pre>
<p>匿名 <code>closeables</code> 集合会被清除，但 <code>keyToCloseables</code> 会被有意保留。这可以防止在清除后代码访问 <code>viewModelScope</code> 等资源时意外地重新创建它们。</p>
<h3 data-id="heading-25">清除后保护</h3>
<p>在清除 ViewModel 后添加可关闭对象会立即将其关闭，从而防止在协程仍在运行时 ViewModel 被清除时出现资源泄漏：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addCloseable</span><span class="hljs-params">(key: <span class="hljs-type">String</span>, closeable: <span class="hljs-type">AutoCloseable</span>)</span></span> {
    <span class="hljs-keyword">if</span> (isCleared) {
        closeWithRuntimeException(closeable)
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">val</span> oldCloseable = synchronized(lock) { keyToCloseables.put(key, closeable) }
    closeWithRuntimeException(oldCloseable)
}
</code></pre>
<p>此外，请注意，添加键值可关闭对象时，任何具有相同键值的现有可关闭对象都会自动关闭，从而支持替换模式。</p>
<h3 data-id="heading-26">用于模拟的可空实现</h3>
<p>JVM 实现提供了一个可空的 <code>impl</code> 对象，以支持模拟框架。当你模拟 ViewModel 时，模拟对象不会调用真正的构造函数，因此 <code>impl</code> 对象永远不会被初始化。如果没有可空类型和安全调用（<code>impl?.clear()</code>），测试会因 <code>NullPointerException</code> 而崩溃：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModel</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> impl: ViewModelImpl?

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">constructor</span>() {
        impl = ViewModelImpl()
    }

    <span class="hljs-meta">@MainThread</span>
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">actual</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span> {
        impl?.clear()
        onCleared()
    }
}
</code></pre>
<h2 data-id="heading-27">viewModelScope：协程集成</h2>
<p><code>viewModelScope</code> 扩展属性提供了一个生命周期感知的 <code>CoroutineScope</code>，当 ViewModel 被清除时，该作用域会自动取消：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> ViewModel.viewModelScope: CoroutineScope
    <span class="hljs-keyword">get</span>() =
        synchronized(VIEW_MODEL_SCOPE_LOCK) {
            getCloseable(VIEW_MODEL_SCOPE_KEY)
                ?: createViewModelScope().also { scope -&gt;
                    addCloseable(VIEW_MODEL_SCOPE_KEY, scope)
                }
        }
</code></pre>
<h3 data-id="heading-28">使用键控存储的延迟创建</h3>
<p>作用域在首次访问时延迟创建，并使用键控可关闭机制进行存储。键名故意设置得非常详细，以避免与用户自定义的键发生冲突：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> VIEW_MODEL_SCOPE_KEY =
    <span class="hljs-string">"androidx.lifecycle.viewmodel.internal.ViewModelCoroutineScope.JOB_KEY"</span>
</code></pre>
<h3 data-id="heading-29">CloseableCoroutineScope</h3>
<p>协程和可关闭系统之间的桥梁是 <code>CloseableCoroutineScope</code>，它同时实现了 <code>CoroutineScope</code> 和 <code>AutoCloseable</code> 接口。在 ViewModel 清空期间调用 <code>close()</code> 时，所有正在运行的协程都会被取消：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CloseableCoroutineScope</span>(<span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> coroutineContext: CoroutineContext) :
    AutoCloseable, CoroutineScope {

    <span class="hljs-keyword">constructor</span>(coroutineScope: CoroutineScope) : <span class="hljs-keyword">this</span>(coroutineScope.coroutineContext)

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">close</span><span class="hljs-params">()</span></span> = coroutineContext.cancel()
}
</code></pre>
<h3 data-id="heading-30">平台感知调度器选择</h3>
<p>作为 Kotlin 多平台库，ViewModel 在没有主线程概念的平台上也能工作，因为它会回退到 <code>EmptyCoroutineContext</code>。请注意，这里使用的是 <code>Dispatchers.Main.immediate</code> 而不是 <code>Dispatchers.Main</code>，这样可以避免在已经在主线程上运行时进行不必要的重新调度：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createViewModelScope</span><span class="hljs-params">()</span></span>: CloseableCoroutineScope {
    <span class="hljs-keyword">val</span> dispatcher =
        <span class="hljs-keyword">try</span> {
            Dispatchers.Main.immediate
        } <span class="hljs-keyword">catch</span> (_: NotImplementedError) {
            <span class="hljs-comment">// In Native environments where `Dispatchers.Main` might not exist (e.g., Linux)</span>
            EmptyCoroutineContext
        } <span class="hljs-keyword">catch</span> (_: IllegalStateException) {
            <span class="hljs-comment">// In JVM Desktop environments where `Dispatchers.Main` might not exist (e.g., Swing)</span>
            EmptyCoroutineContext
        }
    <span class="hljs-keyword">return</span> CloseableCoroutineScope(coroutineContext = dispatcher + SupervisorJob())
}
</code></pre>
<h3 data-id="heading-31">SupervisorJob 实现子协程独立失败</h3>
<p>该作用域使用 <code>SupervisorJob()</code>，允许子协程独立失败。而使用普通的 <code>Job</code> 时，如果一个子协程失败，它会取消所有同级协程。这种设计符合 UI 应用程序的预期，即失败的网络请求不应该取消正在进行的数据库操作。</p>
<h2 data-id="heading-32">ViewModelLazy：Kotlin 属性委托</h2>
<p><code>viewModels()</code> 委托使用了 <code>ViewModelLazy</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModelLazy</span>&lt;<span class="hljs-type">VM : ViewModel</span>&gt;
<span class="hljs-meta">@JvmOverloads</span>
<span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> viewModelClass: KClass&lt;VM&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> storeProducer: () -&gt; ViewModelStore,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> factoryProducer: () -&gt; ViewModelProvider.Factory,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> extrasProducer: () -&gt; CreationExtras = { CreationExtras.Empty },
) : Lazy&lt;VM&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cached: VM? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> value: VM
        <span class="hljs-keyword">get</span>() {
            <span class="hljs-keyword">val</span> viewModel = cached
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (viewModel == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">val</span> store = storeProducer()
                <span class="hljs-keyword">val</span> factory = factoryProducer()
                <span class="hljs-keyword">val</span> extras = extrasProducer()
                ViewModelProvider.create(store, factory, extras).<span class="hljs-keyword">get</span>(viewModelClass).also {
                    cached = it
                }
            } <span class="hljs-keyword">else</span> {
                viewModel
            }
        }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isInitialized</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> = cached != <span class="hljs-literal">null</span>
}
</code></pre>
<h3 data-id="heading-33">双重缓存架构</h3>
<p>惰性委托会在首次访问后将 ViewModel 引用缓存到本地。这是一种双重缓存模式：</p>
<ol>
<li><strong>ViewModelStore 缓存</strong>：规范缓存，不受配置更改的影响。</li>
<li><strong>ViewModelLazy 缓存</strong>：本地缓存，用于避免重复创建 ViewModelProvider。</li>
</ol>
<p>本地缓存是一种优化，创建 <code>ViewModelProvider</code> 并查找 ViewModel 的开销很小，但缓存可以避免后续访问中哪怕是这种微小的开销。</p>
<h3 data-id="heading-34">用于延迟访问的 Lambda 生产者</h3>
<p>所有三个生产者（store、factory、extras）都是 Lambda 表达式，允许延迟求值：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> viewModel <span class="hljs-keyword">by</span> viewModels { MyViewModelFactory() }
<span class="hljs-comment">// Factory is only created when viewModel is first accessed</span>
</code></pre>
<p>这对于 Fragment 尤其重要，因为在属性初始化期间 Activity 可能不可用。</p>
<h2 data-id="heading-35">Android 特有：AGP 代码脱糖兼容性</h2>
<p>Android 有一个特殊的兼容层，用于处理混合使用针对不同 ViewModel 版本编译的库时出现的 AGP（Android Gradle 插件）代码脱糖问题：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">actual</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;VM : ViewModel&gt;</span> <span class="hljs-title">createViewModel</span><span class="hljs-params">(
    factory: <span class="hljs-type">ViewModelProvider</span>.<span class="hljs-type">Factory</span>,
    modelClass: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">VM</span>&gt;,
    extras: <span class="hljs-type">CreationExtras</span>,
)</span></span>: VM {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
        factory.create(modelClass, extras)
    } <span class="hljs-keyword">catch</span> (e: AbstractMethodError) {
        <span class="hljs-keyword">try</span> {
            factory.create(modelClass.java, extras)
        } <span class="hljs-keyword">catch</span> (e: AbstractMethodError) {
            factory.create(modelClass.java)
        }
    }
}
</code></pre>
<p>这一系列 try-catch 代码块用于处理使用旧版本 ViewModel 编译的工厂缺少较新版本的 <code>create</code> 方法的情况。当运行时调用编译后的字节码中不存在的方法时，就会出现 <code>AbstractMethodError</code> 错误，这种情况通常发生在旧工厂只有 <code>create(Class&lt;T&gt;)</code> 方法，而运行时需要 <code>create(Class&lt;T&gt;, CreationExtras)</code> 方法时。这种防御性级联机制能够优雅地降级到方法变体，确保 ViewModel 创建功能不受库版本不匹配的影响。</p>
<h2 data-id="heading-36">性能特性和设计权衡</h2>
<p>ViewModel 系统在设计上做出了一些权衡，以平衡正确性、灵活性和性能。</p>
<h3 data-id="heading-37">同步开销</h3>
<p><code>ViewModelProviderImpl</code> 和 <code>ViewModelImpl</code> 都使用同步块来实现线程安全访问：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">synchronized(lock) {
    <span class="hljs-keyword">val</span> viewModel = store[key]
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>由于 ViewModel 访问通常发生在主线程上，临界区很短（简单的 map 操作），并且锁争用很少发生，因此这种同步开销非常小。该设计优先考虑正确性而非微优化，因为罕见的竞态条件代价远高于几乎察觉不到的同步开销。</p>
<h3 data-id="heading-38">反射开销</h3>
<p><code>NewInstanceFactory</code> 使用 Java 反射来动态实例化 ViewModel 类：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">modelClass.getDeclaredConstructor().newInstance()
</code></pre>
<p>由于运行时类型检查和动态方法解析，反射比直接构造函数调用要慢。但是，这种开销可以忽略不计，因为 ViewModel 的创建频率很低（每个生命周期一次），而且无需编译时信息即可实例化任何 ViewModel 子类的灵活性远远超过了这点微小的开销。</p>
<h3 data-id="heading-39">基于映射的存储</h3>
<p>使用 <code>MutableMap</code> 作为 ViewModelStore 可以提供 O(1) 的查找时间，但清除操作的时间复杂度为 O(n)，因为每个 ViewModel 都必须单独清除：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">for</span> (vm <span class="hljs-keyword">in</span> map.values) {
        vm.clear()
    }
    map.clear()
}
</code></pre>
<p>由于 ViewModelStore 通常只包含 1-5 个 ViewModel，因此线性时间的清除操作实际上并无影响。使用标准 HashMap 的简洁性使得代码更易于理解和维护，对于这种有限的用例而言，其价值远大于理论上的优化。</p>
<h3 data-id="heading-40">用于模拟的可空实现</h3>
<p>JVM ViewModel 中的可空 <code>impl</code> 会在每个操作中添加空值检查：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">impl?.clear()
</code></pre>
<p>这种微小的开销可以实现正确的模拟行为。当模拟框架创建 ViewModel 模拟对象时，它们会绕过真正的构造函数，导致 <code>impl</code> 未初始化。可空类型可以防止测试中出现 <code>NullPointerException</code>，这是一个值得的权衡。</p>
<h2 data-id="heading-41">实际应用模式：理解 ViewModel 的使用</h2>
<p>理解其内部机制有助于你在实际应用中识别模式和反模式。</p>
<h3 data-id="heading-42">模式 1：作用域 ViewModel 共享</h3>
<p>可以使用 Activity 的 ViewModelStore 而不是每个 Fragment 自己的存储来在 Fragment 之间共享 ViewModel：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FragmentA</span> : <span class="hljs-type">Fragment</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> sharedViewModel: SharedViewModel <span class="hljs-keyword">by</span> activityViewModels()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FragmentB</span> : <span class="hljs-type">Fragment</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> sharedViewModel: SharedViewModel <span class="hljs-keyword">by</span> activityViewModels()
}
</code></pre>
<p>两个 Fragment 会获得相同的 ViewModel 实例，因为它们使用相同的 ViewModelStore（Activity 的）。这使得兄弟 Fragment 可以通过共享状态进行通信。内部机制：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// activityViewModels() uses:</span>
ViewModelProvider(
    store = requireActivity().viewModelStore,  <span class="hljs-comment">// Same store for both fragments</span>
    factory = ...,
)
</code></pre>
<h3 data-id="heading-43">模式 2：自定义键用于多个实例</h3>
<p>你可以通过提供自定义键来拥有同一个 ViewModel 类的多个实例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> viewModel1: MyViewModel = viewModelProvider[<span class="hljs-string">"user_1"</span>, MyViewModel::<span class="hljs-keyword">class</span>]
<span class="hljs-keyword">val</span> viewModel2: MyViewModel = viewModelProvider[<span class="hljs-string">"user_2"</span>, MyViewModel::<span class="hljs-keyword">class</span>]
</code></pre>
<p>该键包含自定义字符串，从而在 ViewModelStore 中创建单独的缓存条目。这对于同时管理多个用户配置文件或聊天对话等场景非常有用。</p>
<h3 data-id="heading-44">模式 3：使用 CreationExtras 进行工厂注入</h3>
<p>现代工厂是无状态的，在创建时通过 CreationExtras 接收所有依赖项：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModelFactory</span> : <span class="hljs-type">ViewModelProvider.Factory</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">create</span><span class="hljs-params">(modelClass: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;, extras: <span class="hljs-type">CreationExtras</span>)</span></span>: T {
        <span class="hljs-keyword">val</span> repository = extras[REPOSITORY_KEY]!!
        <span class="hljs-keyword">val</span> userId = extras[USER_ID_KEY]!!
        <span class="hljs-keyword">return</span> MyViewModel(repository, userId) <span class="hljs-keyword">as</span> T
    }
}
</code></pre>
<p>这使得工厂可以作为单例，同时每次调用配置都不同，从而避免为每个具有不同依赖项的 ViewModel 创建新的工厂实例。</p>
<h3 data-id="heading-45">反模式：在 ViewModel 中访问 Context</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Bad: Leaks Activity context</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) : ViewModel()

<span class="hljs-comment">// Good: Use Application context via AndroidViewModel</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span>(application: Application) : AndroidViewModel(application)

<span class="hljs-comment">// Better: Don't hold Context at all, pass it to methods</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadData</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> { ... }
}
</code></pre>
<p>第一种方法可能会导致 Activity 泄漏，因为 ViewModel 在持有已销毁 Activity 的引用时，配置更改仍然存在。请使用 <code>AndroidViewModel</code> 来获取 Application 上下文，或者在需要时将 Context 传递给各个方法。</p>
<h3 data-id="heading-46">反模式：在 onCleared 中阻塞</h3>
<p>你知道 <code>onCleared()</code> 是在主线程上调用的吗？诸如网络关闭或数据库清理之类的阻塞操作应该使用协程的 <code>addCloseable</code> 方法卸载到后台线程：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Bad: Blocking call in onCleared</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCleared</span><span class="hljs-params">()</span></span> {
    networkClient.shutdown()  <span class="hljs-comment">// May block the main thread until completing the shutdown process!</span>
}

<span class="hljs-comment">// Good: Use addCloseable for managed cleanup</span>
<span class="hljs-keyword">init</span> {
    addCloseable {
        scope.launch { networkClient.shutdown() }
    }
}
</code></pre>
<h2 data-id="heading-47">结论</h2>
<p>Jetpack ViewModel 的内部机制展现了一个精心设计的生命周期感知状态管理系统。ViewModelStore 通过保留映射提供简单而有效的缓存，而 ViewModelProvider 则通过线程安全的访问和灵活的工厂支持来协调创建过程。CreationExtras 通过外部化配置来实现无状态工厂，而 AutoCloseable 集成则确保了资源的正确清理。</p>
<p>多平台架构将通用逻辑提取到内部实现类中，使该库能够支持 JVM、Android、iOS 和其他平台。viewModelScope 集成通过 closeable 机制提供自动协程取消功能，并为没有主线程的环境提供平台感知的调度器选择。</p>
<p>如果你想掌握最新的技能、新闻、技术文章、面试题和实用代码技巧，请查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdoveletter%2F" target="_blank" title="https://github.com/doveletter/" ref="nofollow noopener noreferrer">Dove Letter</a>。想要更深入地了解面试准备，千万不要错过终极 Android 面试指南：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.android.skydoves.me%2F" target="_blank" title="https://www.android.skydoves.me/" ref="nofollow noopener noreferrer">Manifest Android Interview</a>。</p>
<blockquote>
<p>欢迎搜索并关注 <em>公众号<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fqrcode%3Fscene%3D10000004%26size%3D512%26__biz%3DMzU1MDg0NDczNA%3D%3D%26mid%3D2247484417%26idx%3D1%26sn%3D60c15f0d3c4be75e37748c2472a74102" target="_blank" title="https://mp.weixin.qq.com/mp/qrcode?scene=10000004&amp;size=512&amp;__biz=MzU1MDg0NDczNA==&amp;mid=2247484417&amp;idx=1&amp;sn=60c15f0d3c4be75e37748c2472a74102" ref="nofollow noopener noreferrer">「稀有猿诉」</a></em> 获取更多的优质文章！</p>
<p>保护原创，请勿转载！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025：从“代码搬运”到“意图编织”，我在 AI 浪潮中找回了开发的“爽感”]]></title>    <link>https://juejin.cn/post/7587811143110246451</link>    <guid>https://juejin.cn/post/7587811143110246451</guid>    <pubDate>2025-12-26T09:09:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587811143110246451" data-draft-id="7587965908288012298" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025：从“代码搬运”到“意图编织”，我在 AI 浪潮中找回了开发的“爽感”"/> <meta itemprop="keywords" content="后端,程序员,产品"/> <meta itemprop="datePublished" content="2025-12-26T09:09:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="舒一笑不秃头"/> <meta itemprop="url" content="https://juejin.cn/user/4257747754552599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025：从“代码搬运”到“意图编织”，我在 AI 浪潮中找回了开发的“爽感”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4257747754552599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    舒一笑不秃头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:09:56.000Z" title="Fri Dec 26 2025 09:09:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>岁末将至，掘金的这次“围炉夜话”让我停下了敲击键盘的手。回望 2025 年，如果用一个词来勾勒我的年度轮廓，那一定不是“效率”，而是 <strong>“Vibe（氛围/共鸣）”</strong> 。</p>
<p>作为“舒一笑不秃头”，我这一年的技术生活，其实是一场关于“如何不被代码异化”的突围。</p>
<h2 data-id="heading-0">一、 Qoder 里的“心流”：当 AI 成了我的外骨骼</h2>
<p>年初时，我也曾陷入对大模型的焦虑：Agent 横空出世，程序员的边界在哪里？但经过这一年与 Qoder 等工具的深度磨合，我总结出了一套“高效使用法则”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ee7baa70f354888962aeff27fb30f1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344996&amp;x-signature=KdRNxpEbx0EgAFKvDTXtUpoaV5g%3D" alt="image.png" loading="lazy"/></p>
<p><strong>2025 年，我的 Vibe Coding 时刻，往往发生在深夜。</strong></p>
<p>以前的深夜，我可能在为某个正则匹配焦头烂额，或者在冗长的增删改查中消耗体力。而现在，我更像是一个<strong>意图的编织者</strong>。我不再纠结于语法细节，而是将重心转向了系统设计和逻辑拓扑。在 Qoder 的辅助下，代码不再是沉重的负担，而成了随心所欲的表达。那种“我想，它即现”的即时反馈，让我重新找回了初学编程时那种纯粹的、多巴胺分泌的快乐。</p>
<p>这正是 Vibe Coding 的核心：<strong>让技术退居幕后，让创造者的直觉走向台前。</strong></p>
<h2 data-id="heading-1">二、 StrLoom 的坚持：在“快”时代做一点“慢”工具</h2>
<p>2025 年，也是 <strong>StrLoom</strong> 逐渐成型的一年。</p>
<p>在 AI 催生了无数“一键生成”的浮躁产品时，我选择去做一个干净、私密、高效的开发者工具集。为什么要自己做？因为我厌倦了那些充满广告、侵犯隐私、甚至需要我为了一个小功能去关注公众号的工具。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58e7d37a26df4b029e7d740842c81c65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344996&amp;x-signature=1doVMLMw%2Br6BPH06jHu2yI0F2oM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>价值源自需求，因为被需求，所以才有价值。</strong></p>
<p>在开发 StrLoom 的过程中，我思考得最多的是：<strong>如何让工具回归工具本身？</strong> AI 给了我极大的开发助力，但我并没有让 AI 喧宾夺主。我利用 AI 处理繁琐的兼容性测试，而把关于“简洁”与“用户尊重”的灵魂留给自己。StrLoom 就像我在数字荒原里种下的一棵树，不为变现而臃肿，只为解决那一点点真切的痛点。这种纯粹的开发心态，构成了我 2025 年最稳固的“心理 Vibe”。</p>
<h2 data-id="heading-2">三、 拒绝异化：技术不该是“秃头”的理由</h2>
<p>作为一个对马克思异化理论有深度共鸣的人，我一直在警惕 AI 对人的反向支配。如果 AI 只是让我们产出了更多的“垃圾代码”，那它本质上是在加速人的异化。</p>
<p>但 2025 年给我的答案是乐观的。通过智能体工具，我从繁重的实施性工作中解脱出来，有了更多时间去思考“为什么而做”。</p>
<ul>
<li><strong>共识来自于分歧的超越：</strong> 我与 AI 的对话，本质上是在不断对齐人类意图与机器执行之间的分歧。</li>
<li><strong>模式是生存与发展的路径：</strong> 这一年，我学会了利用 AI 建立自己的个人生产力闭环，而不是在无限的加班中透支健康。</li>
</ul>
<p>“舒一笑不秃头”这个名字，其实是我对这个行业的一点小小反抗。2025 年，因为 AI 的介入，我发现那种“优雅地编程，体面地生活”的理想状态，正在变得越来越清晰。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87939f37f7af4d70bb1d145fe9a33ce0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767344996&amp;x-signature=O1RHOpc4lJf%2BtGZK2HFd%2F8a4Zbw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">结语：属于我的数字年轮</h2>
<p>2025 年的钟声即将敲响，我的数字年轮里，有一半刻着 AI 辅助下的高效，另一半刻着独立开发者的清醒。</p>
<p>技术流淌进生活，不应该是某种冷冰冰的替代，而应该是对个人意志的放大。在未来的 2026，我希望继续保持这种 Vibe：<strong>手中有最快的刀（AI），心中有最清澈的流（初衷）。</strong></p>
<p>愿每一位掘友，在算法的洪流中，都能找到属于自己的那份“不秃头”的从容。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI让我变强了还是变弱了？一个后端开发的年终自省]]></title>    <link>https://juejin.cn/post/7587998744294178822</link>    <guid>https://juejin.cn/post/7587998744294178822</guid>    <pubDate>2025-12-26T09:10:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587998744294178822" data-draft-id="7587965908288028682" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI让我变强了还是变弱了？一个后端开发的年终自省"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T09:10:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="嘻哈baby"/> <meta itemprop="url" content="https://juejin.cn/user/485305583405066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI让我变强了还是变弱了？一个后端开发的年终自省
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/485305583405066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    嘻哈baby
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:10:24.000Z" title="Fri Dec 26 2025 09:10:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、那个让我开始怀疑自己的瞬间</h2>
<p>前几天团队来了个实习生，让我帮忙review一段代码。</p>
<p>我扫了一眼，随口说："这个Redis分布式锁的实现有问题，没有考虑锁续期，业务执行时间超过过期时间就会出问题。"</p>
<p>实习生一脸崇拜地问我："哥你怎么一眼就能看出来的？"</p>
<p>我张了张嘴，突然愣住了。</p>
<p>因为我想起来，这个知识点是三个月前我问Cursor的时候它告诉我的。当时我也写了类似的代码，是AI帮我指出的问题。</p>
<p>那一刻我突然意识到一件事：<strong>我引以为傲的"经验"，有多少是AI教我的？如果没有AI，我真的能发现这个问题吗？</strong></p>
<h2 data-id="heading-1">二、2025，我和AI的蜜月期</h2>
<p>坦白说，这一年AI确实让我"变强"了。</p>
<p>年初用Cursor写的代码，到现在已经上线跑了快一年，稳定得很。有个定时任务的逻辑特别复杂，涉及到多个数据源的对账，以前我可能要写一周，用AI两天就搞定了。</p>
<p>我的输出明显变多了：</p>
<ul>
<li>GitHub提交数比去年翻了一倍</li>
<li>独立负责的项目从2个变成了5个</li>
<li>甚至开始写技术博客，今年发了30多篇</li>
</ul>
<p>如果只看这些数据，我应该很开心才对。</p>
<p>但我开心不起来。</p>
<p>因为我越来越分不清，这些"产出"里有多少是我的能力，有多少是AI的能力。</p>
<h2 data-id="heading-2">三、Anthropic的那句话戳中了我</h2>
<p>前阵子看到 Anthropic 的一篇文章《How AI Is Transforming Work at Anthropic》，里面有一句话让我沉默了很久：</p>
<blockquote>
<p><strong>"我以为我喜欢写代码，其实我只是喜欢代码跑通的结果。"</strong></p>
</blockquote>
<p>说的不就是我吗？</p>
<p>回想这一年，我用AI实现了很多东西：</p>
<ul>
<li>一个自动化运维脚本，能批量管理几十台服务器</li>
<li>一个数据分析看板，老板很满意</li>
<li>一个内部工具平台，同事都说好用</li>
</ul>
<p>但问题是：<strong>这些东西的核心逻辑，我真的理解吗？</strong></p>
<p>那个运维脚本里有段并发控制的代码，我至今不太明白为什么要用信号量而不是线程池。当时AI给了方案，我测了几遍没问题就上线了。</p>
<p>如果现在让我脱离AI，重新写一遍，我写得出来吗？</p>
<p>我不确定。</p>
<h2 data-id="heading-3">四、一个危险的趋势：我在退化</h2>
<p>最近我发现了一个危险的信号。</p>
<p>以前遇到问题，我的第一反应是：想一想，画个图，理理思路。</p>
<p>现在我的第一反应是：问AI。</p>
<p>这看起来是效率提升，但仔细想想很可怕——<strong>我正在失去独立思考的习惯。</strong></p>
<p>更可怕的是，这种退化是无感知的。</p>
<p>因为有AI兜底，我遇到的问题都能解决，所以我感觉不到自己在变弱。直到有一天网络不好，AI加载不出来，我对着一个NPE愣了五分钟才想起来可以用debug。</p>
<p>那一刻我才意识到：<strong>我不是变强了，我是变依赖了。</strong></p>
<h2 data-id="heading-4">五、OpenAI给出的答案：核心能力在变化</h2>
<p>但话说回来，完全不用AI也不现实。就像OpenAI在《使用Codex在28天内构建Android版Sora》里展示的：</p>
<blockquote>
<p>AI可以24小时无间断编写代码和自我修复，28天通过50亿token完成了正常需要几个月的产品上线。</p>
</blockquote>
<p>你想跟AI拼写代码的速度？拼不过的。</p>
<p>所以问题不是"要不要用AI"，而是"用AI的同时，我的核心竞争力是什么"。</p>
<p>OpenAI的结论是：</p>
<blockquote>
<p><strong>未来的开发工程师的能力不再是打字速度或语法API记忆，而是对系统的深刻洞察力。</strong></p>
</blockquote>
<p>换句话说：</p>
<ul>
<li>❌ 熟练使用某个框架 → AI比你更熟</li>
<li>❌ 记住各种API → AI比你记得清楚</li>
<li>✅ 理解系统为什么这样设计 → 这是你的</li>
<li>✅ 在复杂场景下做权衡决策 → 这是你的</li>
<li>✅ 把模糊的需求翻译成清晰的问题 → 这是你的</li>
</ul>
<h2 data-id="heading-5">六、我的应对：从"用AI写代码"到"管理AI写代码"</h2>
<p>想明白这个问题后，我调整了自己使用AI的方式。</p>
<h3 data-id="heading-6">以前：让AI写，我来验</h3>
<pre><code class="hljs language-css" lang="css">我：帮我写一个分布式锁的实现
AI：<span class="hljs-selector-attr">[一大段代码]</span>
我：跑一下，没问题，上线
</code></pre>
<h3 data-id="heading-7">现在：我来规划，AI来执行</h3>
<pre><code class="hljs language-css" lang="css">我：我需要实现一个分布式锁，场景是订单扣库存，
    要求：<span class="hljs-number">1</span>. 支持锁续期 <span class="hljs-number">2</span>. 要有获取锁的超时机制 <span class="hljs-number">3</span>. 释放锁要保证原子性
    先别写代码，帮我分析一下技术方案的选择

AI：<span class="hljs-selector-attr">[分析Redis vs Zookeeper vs etcd的优劣]</span>

我：用Redis，但我担心主从切换时的锁丢失问题，怎么处理？

AI：<span class="hljs-selector-attr">[分析RedLock的原理和争议]</span>

我：好，先写个设计文档，我review一下再开始写代码
</code></pre>
<p>区别在哪？</p>
<p><strong>以前我是"代码的验收者"，现在我是"方案的决策者"。</strong></p>
<p>AI负责执行，我负责：</p>
<ol>
<li>定义问题的边界</li>
<li>选择技术方案</li>
<li>把控架构设计</li>
<li>做最终决策</li>
</ol>
<p>这样写出来的代码，我是真的理解的。</p>
<h3 data-id="heading-8">实践：给AI建立规范</h3>
<p>最近在试 Claude Code，有个功能很有意思：你可以给AI写一个CLAUDE.md，告诉它项目的上下文和规范。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目上下文</span>

<span class="hljs-section">## 技术栈</span>
<span class="hljs-bullet">-</span> Java 17 + Spring Boot 3.2
<span class="hljs-bullet">-</span> MyBatis-Plus（禁止使用JPA）
<span class="hljs-bullet">-</span> Redis 7.0（已封装在 common-redis 模块）

<span class="hljs-section">## 规范</span>
<span class="hljs-bullet">-</span> 所有金额字段使用BigDecimal，禁止double
<span class="hljs-bullet">-</span> 分布式锁统一使用 LockUtil，不要自己实现
<span class="hljs-bullet">-</span> 异常处理使用全局异常处理器，Controller不要try-catch
</code></pre>
<p>有了这个，AI就不会乱写代码。它知道项目里有什么，该用什么，不该用什么。</p>
<p><strong>本质上，这是在"驯服"AI。</strong></p>
<p>把它当成一个"能力很强但不了解项目背景的新人"，你需要做的是给它足够的上下文，制定清晰的规范，然后让它在你划定的范围内发挥。</p>
<h2 data-id="heading-9">七、重新定义"强"</h2>
<p>写到这里，我想回答开头的问题：<strong>AI让我变强了还是变弱了？</strong></p>
<p>答案是：<strong>看你怎么定义"强"。</strong></p>
<p>如果"强"是指产出多、交付快，那我确实变强了。</p>
<p>但如果"强"是指离开工具也能解决问题，那我可能在变弱。</p>
<p>我现在的理解是：</p>
<ol>
<li><strong>短期</strong>：学会用AI，提高生产力，这是生存需要</li>
<li><strong>长期</strong>：保持独立思考能力，理解系统本质，这是核心竞争力</li>
<li><strong>平衡</strong>：用AI加速执行，但关键决策自己做</li>
</ol>
<p>就像开车有了导航，你可以更快到达目的地，但你不能完全依赖它——至少你要知道大概往哪个方向开，否则导航一断你就傻眼了。</p>
<h2 data-id="heading-10">八、写在2025年末</h2>
<p>这一年，AI从"工具"变成了"伙伴"，甚至在某些时刻，我分不清它是伙伴还是拐杖。</p>
<p>我不知道2026年AI会进化成什么样。也许它会更强，强到让"写代码"这件事本身变得不再重要。</p>
<p>但我想，无论技术怎么变，有些东西是不变的：</p>
<ul>
<li>对问题本质的好奇心</li>
<li>把复杂系统想清楚的能力</li>
<li>面对不确定性做决策的勇气</li>
</ul>
<p>这些，AI暂时还替代不了。</p>
<p><strong>愿你我都能在AI的浪潮里，找到属于自己的锚点。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain Memory 实战指南：让大模型记住你每一句话，轻松打造“有记忆”的AI助手]]></title>    <link>https://juejin.cn/post/7587965908288094218</link>    <guid>https://juejin.cn/post/7587965908288094218</guid>    <pubDate>2025-12-26T09:15:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587965908288094218" data-draft-id="7587997893986910235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" LangChain Memory 实战指南：让大模型记住你每一句话，轻松打造“有记忆”的AI助手"/> <meta itemprop="keywords" content="LangChain,LLM,JavaScript"/> <meta itemprop="datePublished" content="2025-12-26T09:15:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="栀秋666"/> <meta itemprop="url" content="https://juejin.cn/user/2566698322650307"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             LangChain Memory 实战指南：让大模型记住你每一句话，轻松打造“有记忆”的AI助手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2566698322650307/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    栀秋666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:15:38.000Z" title="Fri Dec 26 2025 09:15:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">引言</h2>
<blockquote>
<p>你有没有遇到过这样的尴尬？<br/>
向 AI 提问：“我叫张三”，下一秒再问“我叫什么名字？”——它居然说：“抱歉，我不记得了。” 😅</p>
<p>别怪模型笨，这是所有 LLM 的“先天缺陷”：<strong>无状态调用</strong>。</p>
<p>但今天，我们用 <strong>LangChain Memory</strong> 给它装上“大脑”，实现真正意义上的多轮对话记忆！</p>
<p>本文将带你从零构建一个会“记事”的智能助手，并深入剖析底层原理、性能瓶颈与生产级优化方案。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">🧠 一、为什么你的 AI 总是“金鱼脑”？</h3>
<h4 data-id="heading-2">1.1 大模型的“失忆症”真相</h4>
<p>我们知道，大语言模型（LLM）本质上是一个“黑箱函数”：</p>
<pre><code class="hljs language-ts" lang="ts">response = <span class="hljs-title function_">model</span>(prompt)
</code></pre>
<p>每次调用都是独立的 HTTP 请求，<strong>没有任何上下文保留机制</strong> —— 就像每次见面都重新认识一遍。</p>
<p>举个例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 第一次对话</span>
<span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"我叫陈昊，喜欢喝白兰地"</span>);
<span class="hljs-comment">// 输出：很高兴认识你，陈昊！看来你喜欢喝白兰地呢～</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'------ 分割线 ------'</span>);

<span class="hljs-comment">// 第二次对话</span>
<span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"我叫什么名字？"</span>);
<span class="hljs-comment">// 输出：呃……不太清楚，能告诉我吗？</span>
</code></pre>
<p>👉 结果令人崩溃：前脚刚自我介绍，后脚就忘了！</p>
<p>这在实际项目中是不可接受的。无论是客服机器人、教育助手还是个性化推荐系统，<strong>都需要记住用户的历史行为和偏好</strong>。</p>
<hr/>
<h4 data-id="heading-3">1.2 解决思路：把“记忆”塞进 Prompt</h4>
<p>既然模型不会自己记，那就<strong>我们来帮它记</strong>！</p>
<p>核心思想非常简单：</p>
<blockquote>
<p>✅ 每次请求前，把之前的对话历史拼接到当前 prompt 中<br/>
✅ 让模型“看到”完整的聊天记录，从而做出连贯回应</p>
</blockquote>
<p>这就像是给模型戴上了一副“记忆眼镜”。</p>
<p>而 LangChain 的 <code>Memory</code> 模块，正是对这一过程的高度封装与自动化。</p>
<hr/>
<h3 data-id="heading-4">⚙️ 二、LangChain Memory 核心原理拆解</h3>
<p>LangChain 提供了一套优雅的 API，让我们可以用几行代码实现“有记忆”的对话系统。</p>
<p>先看最终效果：</p>
<pre><code class="hljs language-bash" lang="bash">User: 我叫陈昊，喜欢喝白兰地
AI: 你好，陈昊！白兰地可是很有品味的选择哦～

User: 我喜欢喝什么酒？
AI: 你说你喜欢喝白兰地呀～是不是准备开一瓶庆祝一下？😉
</code></pre>
<p>✅ 成功记住用户名字和饮酒偏好！</p>
<p>下面我们就一步步实现这个功能。</p>
<hr/>
<h4 data-id="heading-5">2.1 核心组件一览</h4>

























<table><thead><tr><th>组件</th><th>作用</th></tr></thead><tbody><tr><td><code>ChatMessageHistory</code></td><td>存储对话历史（内存/文件/数据库）</td></tr><tr><td><code>ChatPromptTemplate</code></td><td>定义提示词模板，预留 <code>{history}</code> 占位符</td></tr><tr><td><code>RunnableWithMessageHistory</code></td><td>自动注入历史 + 管理会话生命周期</td></tr><tr><td><code>sessionId</code></td><td>区分不同用户的会话，避免串台</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-6">2.2 完整代码实战</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 文件名：memory-demo.js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'dotenv/config'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatPromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/prompts'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableWithMessageHistory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InMemoryChatMessageHistory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/chat_history'</span>;

<span class="hljs-comment">// 1. 初始化模型</span>
<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-reasoner'</span>,
    <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.3</span>,
});

<span class="hljs-comment">// 2. 构建带历史的 Prompt 模板</span>
<span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromMessages</span>([
    [<span class="hljs-string">'system'</span>, <span class="hljs-string">'你是一个温暖且有记忆的助手，请根据对话历史回答问题'</span>],
    [<span class="hljs-string">'placeholder'</span>, <span class="hljs-string">'{history}'</span>],   <span class="hljs-comment">// ← 历史消息自动插入这里</span>
    [<span class="hljs-string">'human'</span>, <span class="hljs-string">'{input}'</span>]            <span class="hljs-comment">// ← 当前输入</span>
]);

<span class="hljs-comment">// 3. 创建可运行链（含调试输出）</span>
<span class="hljs-keyword">const</span> runnable = prompt
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-function"><span class="hljs-params">input</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n🔍 最终发送给模型的完整上下文：'</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(input, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
        <span class="hljs-keyword">return</span> input;
    })
    .<span class="hljs-title function_">pipe</span>(model);

<span class="hljs-comment">// 4. 初始化内存历史存储</span>
<span class="hljs-keyword">const</span> messageHistory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryChatMessageHistory</span>();

<span class="hljs-comment">// 5. 创建带记忆的链</span>
<span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnableWithMessageHistory</span>({
    runnable,
    <span class="hljs-attr">getMessageHistory</span>: <span class="hljs-function">() =&gt;</span> messageHistory,
    <span class="hljs-attr">inputMessagesKey</span>: <span class="hljs-string">'input'</span>,
    <span class="hljs-attr">historyMessagesKey</span>: <span class="hljs-string">'history'</span>
});

<span class="hljs-comment">// 6. 开始对话测试</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testConversation</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 第一轮：告知信息</span>
    <span class="hljs-keyword">const</span> res1 = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>(
        { <span class="hljs-attr">input</span>: <span class="hljs-string">"我叫陈昊，喜欢喝白兰地"</span> },
        { <span class="hljs-attr">configurable</span>: { <span class="hljs-attr">sessionId</span>: <span class="hljs-string">"user_001"</span> } }
    );
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🤖 回应1："</span>, res1.<span class="hljs-property">content</span>);

    <span class="hljs-comment">// 第二轮：提问历史</span>
    <span class="hljs-keyword">const</span> res2 = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>(
        { <span class="hljs-attr">input</span>: <span class="hljs-string">"我叫什么名字？我喜欢喝什么酒？"</span> },
        { <span class="hljs-attr">configurable</span>: { <span class="hljs-attr">sessionId</span>: <span class="hljs-string">"user_001"</span> } }
    );
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🤖 回应2："</span>, res2.<span class="hljs-property">content</span>);
}

<span class="hljs-title function_">testConversation</span>();
</code></pre>
<p>📌 <strong>运行结果示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">🤖 回应1： 你好，陈昊！听说你喜欢喝白兰地，真是个有品位的人呢～

🤖 回应2： 你叫陈昊，而且你说你喜欢喝白兰地哦～要不要来点搭配小吃？
</code></pre>
<p>🎉 成功！模型不仅记住了名字，还能综合多个信息进行推理回答！</p>
<hr/>
<h4 data-id="heading-7">2.3 关键机制图解</h4>
<pre><code class="hljs language-text" lang="text">              +---------------------+
              |   用户新输入         |
              +----------+----------+
                         |
       +-----------------v------------------+
       |   ChatPromptTemplate              |
       |                                     |
       |   System: 你是有记忆的助手         |
       |   History: [之前的所有对话] ←───────+←─ 从 messageHistory 读取
       |   Human: 我叫什么名字？             |
       +-----------------+------------------+
                         |
                调用模型 → LLM
                         |
           返回响应 ←────+
                         |
       +-----------------v------------------+
       |  自动保存本次交互                  |
       |  user: 我叫什么名字？               |
       |  assistant: 你叫陈昊...            |
       |  写入 InMemoryChatMessageHistory   |
       +------------------------------------+
</code></pre>
<p>整个流程全自动闭环，开发者只需关注业务逻辑。</p>
<hr/>
<h3 data-id="heading-8">⚠️ 三、真实场景下的三大挑战与破解之道</h3>
<p>虽然上面的例子很美好，但在生产环境中你会立刻面临三个“灵魂拷问”：</p>
<hr/>
<h4 data-id="heading-9">❌ 挑战1：Token “滚雪球”爆炸增长！</h4>
<p>随着对话轮数增加，历史消息越积越多，导致：</p>
<ul>
<li>单次请求 Token 数飙升</li>
<li>成本翻倍 💸</li>
<li>响应变慢 ⏳</li>
<li>可能超出模型最大长度限制（如 8192）</li>
</ul>
<h5 data-id="heading-10">✅ 解法：选择合适的 Memory 类型</h5>

























<table><thead><tr><th>Memory 类型</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><code>BufferWindowMemory</code></td><td>只保留最近 N 轮</td><td>通用对话、短程记忆</td></tr><tr><td><code>ConversationSummaryMemory</code></td><td>自动生成一句话总结</td><td>长周期对话、节省 Token</td></tr><tr><td><code>EntityMemory</code></td><td>提取关键实体（人名/偏好）</td><td>推荐系统、CRM 助手</td></tr></tbody></table>
<h6 data-id="heading-11">示例：使用窗口记忆（保留最近3轮）</h6>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BufferWindowMemory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/memory"</span>;

<span class="hljs-keyword">const</span> memory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferWindowMemory</span>({
    <span class="hljs-attr">k</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">memoryKey</span>: <span class="hljs-string">"history"</span>
});
</code></pre>
<blockquote>
<p>📌 推荐组合：<strong>短期细节靠窗口 + 长期特征靠总结</strong></p>
</blockquote>
<hr/>
<h4 data-id="heading-12">❌ 挑战2：重启服务后历史全丢？！</h4>
<p><code>InMemoryChatMessageHistory</code> 是临时存储，服务一重启，记忆清零。</p>
<h5 data-id="heading-13">✅ 解法：持久化到数据库或文件</h5>
<h6 data-id="heading-14">方案一：本地文件存储（轻量级）</h6>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">FileChatMessageHistory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/chat_history"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getMessageHistory</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">sessionId</span>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileChatMessageHistory</span>({
        <span class="hljs-attr">filePath</span>: <span class="hljs-string">`./history/<span class="hljs-subst">${sessionId}</span>.json`</span>
    });
};
</code></pre>
<h6 data-id="heading-15">方案二：Redis / MongoDB（高并发推荐）</h6>
<pre><code class="hljs language-bash" lang="bash">npm install @langchain/redis
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RedisChatMessageHistory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/redis"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getMessageHistory</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">sessionId</span>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisChatMessageHistory</span>({
        sessionId,
        <span class="hljs-attr">client</span>: redisClient <span class="hljs-comment">// 已连接的 Redis 客户端</span>
    });
};
</code></pre>
<blockquote>
<p>💡 生产环境强烈建议使用 Redis：高性能、支持过期策略、分布式部署无忧。</p>
</blockquote>
<hr/>
<h4 data-id="heading-16">❌ 挑战3：多人同时聊天会不会串消息？</h4>
<p>当然会！如果所有用户共用同一个 <code>messageHistory</code>，就会出现 A 用户看到 B 用户的对话。</p>
<h5 data-id="heading-17">✅ 解法：用 <code>sessionId</code> 隔离会话</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>(
    { <span class="hljs-attr">input</span>: <span class="hljs-string">"我饿了"</span> },
    { <span class="hljs-attr">configurable</span>: { <span class="hljs-attr">sessionId</span>: <span class="hljs-string">"user_123"</span> } }  <span class="hljs-comment">// 每个用户唯一 ID</span>
)

<span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>(
    { <span class="hljs-attr">input</span>: <span class="hljs-string">"我饿了"</span> },
    { <span class="hljs-attr">configurable</span>: { <span class="hljs-attr">sessionId</span>: <span class="hljs-string">"user_456"</span> } }  <span class="hljs-comment">// 不同用户，不同历史</span>
)
</code></pre>
<blockquote>
<p>✅ 安全隔离，互不干扰！</p>
</blockquote>
<hr/>
<h3 data-id="heading-18">🛠️ 四、Memory 的典型应用场景（附案例灵感）</h3>





























<table><thead><tr><th>场景</th><th>如何使用 Memory</th></tr></thead><tbody><tr><td>客服机器人</td><td>记住订单号、投诉进度、用户情绪变化</td></tr><tr><td>教育辅导</td><td>追踪学习章节、错题记录、掌握程度</td></tr><tr><td>电商导购</td><td>记住预算、品牌偏好、尺码需求</td></tr><tr><td>编程助手</td><td>保持代码上下文、函数定义、项目结构</td></tr><tr><td>心理咨询</td><td>理解用户情绪演变、关键事件回顾</td></tr></tbody></table>
<p>💡 <strong>创新玩法</strong>：结合 SummaryMemory + VectorDB，实现“长期人格记忆”——让 AI 记住你是内向还是外向、喜欢幽默还是严谨。</p>
<hr/>
<h3 data-id="heading-19">📘 五、<strong>高频面试题（LangChain 方向）</strong>：</h3>
<ol>
<li>LLM 为什么需要 Memory？它的本质是什么？</li>
<li>Buffer vs Summary Memory 的区别？什么时候用哪种？</li>
<li>如何设计一个支持百万用户在线的记忆系统架构？</li>
<li>如何防止敏感信息被 Memory 记录？（安全考量）</li>
</ol>
<hr/>
<h3 data-id="heading-20">📝 结语：让 AI 真正“懂你”，从一次对话记忆开始</h3>
<blockquote>
<p>“智能不是回答问题的能力，而是理解上下文的艺术。”</p>
</blockquote>
<p>LangChain Memory 虽然只是整个 LLM 应用中的一个小模块，但它却是通往<strong>拟人化交互</strong>的关键一步。</p>
<p>从“无状态”到“有记忆”，我们不只是在写代码，更是在塑造一种新的沟通方式。</p>
<p>未来属于那些能让 AI <strong>记住你、理解你、陪伴你</strong>的产品。</p>
<p>而现在，你已经有了打造它的钥匙。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再让单体 Agent 烧 Token 了：LangGraph 多智能体实战指南]]></title>    <link>https://juejin.cn/post/7587903505135697970</link>    <guid>https://juejin.cn/post/7587903505135697970</guid>    <pubDate>2025-12-26T09:06:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587903505135697970" data-draft-id="7587965800272183322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再让单体 Agent 烧 Token 了：LangGraph 多智能体实战指南"/> <meta itemprop="keywords" content="LangChain,Agent"/> <meta itemprop="datePublished" content="2025-12-26T09:06:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小白点point"/> <meta itemprop="url" content="https://juejin.cn/user/4353721774639118"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再让单体 Agent 烧 Token 了：LangGraph 多智能体实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721774639118/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小白点point
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:06:06.000Z" title="Fri Dec 26 2025 09:06:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>简介</strong>: 针对单体 Agent 在复杂任务中易迷失、易死循环的痛点，本文深入探讨了基于 LangGraph 的多 Agent 协作架构。通过 Supervisor 模式的实战演练，详细解析了状态管理、路由决策及避坑经验，助你构建真正可落地的工业级 AI 应用。</p>
</blockquote>
<hr/>
<p>如果你曾尝试让一个单体 Agent（如标准的 <code>ChatOpenAI</code> 配合 <code>AgentExecutor</code>）同时完成“调研新技术、编写 Demo 代码、进行单元测试并输出文档”这一系列任务，你大概率会遇到以下惨状：Agent 在执行到第三步时忘记了第一步的约束，或者在代码报错时陷入了无意义的自我修正死循环，最终烧光了你的 Token，却只吐出一堆逻辑混乱的废话。</p>
<p>在生产环境中，单体 Agent 的上下文窗口（Context Window）和推理链条是有极限的。当任务复杂度超过某个阈值，模型就会开始“胡言乱语”。解决办法不是换一个更强的模型，而是改变架构——从单兵作战转向多 Agent 协作（Multi-Agent Systems）。</p>
<p>本文将基于 <strong>LangGraph</strong>（LangChain 官方推出的有状态多 Agent 编排库）分享如何构建一个可落地的多 Agent 应用。</p>
<h3 data-id="heading-0">1. 为什么是 LangGraph 而不是传统的 AgentExecutor？</h3>
<p>传统的 LangChain Agent 是一个黑盒，你很难控制它的内部循环逻辑。而在多 Agent 场景下，我们需要的是一个<strong>状态机</strong>。</p>
<ul>
<li><strong>State（状态）</strong>：所有 Agent 共享的“账本”，记录当前任务进度。</li>
<li><strong>Nodes（节点）</strong>：每个 Agent 或工具就是一个节点，负责处理状态并返回更新。</li>
<li><strong>Edges（边）</strong>：定义了从一个节点到另一个节点的流转逻辑（条件路由）。</li>
</ul>
<p>这种架构允许我们像设计工业流水线一样，精确控制每个 Agent 的职责边界。</p>
<hr/>
<h3 data-id="heading-1">2. 核心架构：Supervisor（导师）模式</h3>
<p>在多 Agent 协作中，最稳定的模式是 <strong>Supervisor 模式</strong>。它由一个主控 Agent 负责分发任务，多个专家 Agent 负责执行，最后由主控汇总。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    Start((开始)) --&gt; Supervisor{主控 Agent}
    Supervisor --&gt;|指派任务| Researcher[调研专家]
    Supervisor --&gt;|指派任务| Coder[代码专家]
    Researcher --&gt;|返回结果| Supervisor
    Coder --&gt;|返回结果| Supervisor
    Supervisor --&gt;|任务完成| End((结束))
</code></pre>
<hr/>
<h3 data-id="heading-2">3. 实战演练：构建一个技术文档生成系统</h3>
<p>我们将构建一个包含“搜索专家”和“代码专家”的协作系统。</p>
<p><strong>环境要求：</strong></p>
<ul>
<li><code>langchain &gt;= 0.2.0</code></li>
<li><code>langgraph &gt;= 0.1.0</code></li>
<li><code>langchain-openai</code></li>
</ul>
<h4 data-id="heading-3">第一步：定义共享状态</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Annotated, <span class="hljs-type">List</span>, TypedDict
<span class="hljs-keyword">import</span> operator

<span class="hljs-comment"># 定义 Agent 之间共享的状态</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-comment"># 所有的消息都会被追加到这个列表里</span>
    messages: Annotated[<span class="hljs-type">List</span>, operator.add]
    <span class="hljs-comment"># 下一个要执行的节点</span>
    <span class="hljs-built_in">next</span>: <span class="hljs-built_in">str</span>
</code></pre>
<h4 data-id="heading-4">第二步：创建专家 Agent</h4>
<p>不要直接给 Agent 塞入所有工具。<strong>职责分离</strong>是降低幻觉的关键。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage
<span class="hljs-keyword">from</span> langgraph.prebuilt <span class="hljs-keyword">import</span> create_react_agent

llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4o"</span>, temperature=<span class="hljs-number">0</span>)

<span class="hljs-comment"># 1. 调研专家：仅赋予搜索工具</span>
research_agent = create_react_agent(
    llm, tools=[tavily_tool], state_modifier=<span class="hljs-string">"你是一名资深技术调研员，负责搜集最新的技术文档和 API 用法。"</span>
)

<span class="hljs-comment"># 2. 代码专家：仅负责编写和运行 Python 代码</span>
code_agent = create_react_agent(
    llm, tools=[python_repl_tool], state_modifier=<span class="hljs-string">"你是一名高级工程师，负责根据调研结果编写高质量的 Python 代码示例。"</span>
)
</code></pre>
<h4 data-id="heading-5">第三步：构建主控路由（Supervisor）</h4>
<p>这是系统的“大脑”，它不干活，只负责看进度并决定谁是下一个执行者。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers.openai_functions <span class="hljs-keyword">import</span> JsonOutputFunctionsParser

members = [<span class="hljs-string">"Researcher"</span>, <span class="hljs-string">"Coder"</span>]
system_prompt = (
    <span class="hljs-string">"你是一名团队负责人，负责管理以下人员：{members}。"</span>
    <span class="hljs-string">"根据用户的问题，决定谁应该执行下一步。每个人员执行完后都会向你汇报。"</span>
    <span class="hljs-string">"当任务完全结束时，回复 FINISH。"</span>
)

options = [<span class="hljs-string">"FINISH"</span>] + members
function_def = {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"route"</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"选择下一个执行者"</span>,
    <span class="hljs-string">"parameters"</span>: {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
        <span class="hljs-string">"properties"</span>: {
            <span class="hljs-string">"next"</span>: {<span class="hljs-string">"anyOf"</span>: [{<span class="hljs-string">"enum"</span>: options}]}
        },
        <span class="hljs-string">"required"</span>: [<span class="hljs-string">"next"</span>],
    },
}

prompt = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, system_prompt),
    (<span class="hljs-string">"placeholder"</span>, <span class="hljs-string">"{messages}"</span>),
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"根据以上对话，谁应该是下一个执行者？或者是结束任务？"</span>)
]).partial(members=<span class="hljs-string">", "</span>.join(members))

<span class="hljs-comment"># 使用 OpenAI 的 Function Calling 来保证输出的稳定性</span>
supervisor_chain = (
    prompt 
    | llm.bind_functions(functions=[function_def], function_call=<span class="hljs-string">"route"</span>) 
    | JsonOutputFunctionsParser()
)
</code></pre>
<h4 data-id="heading-6">第四步：编排工作流</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, END

workflow = StateGraph(AgentState)

<span class="hljs-comment"># 添加节点</span>
workflow.add_node(<span class="hljs-string">"Researcher"</span>, <span class="hljs-keyword">lambda</span> state: research_agent.invoke(state))
workflow.add_node(<span class="hljs-string">"Coder"</span>, <span class="hljs-keyword">lambda</span> state: code_agent.invoke(state))
workflow.add_node(<span class="hljs-string">"supervisor"</span>, <span class="hljs-keyword">lambda</span> state: supervisor_chain.invoke(state))

<span class="hljs-comment"># 所有的专家节点执行完后，都要回到 supervisor</span>
<span class="hljs-keyword">for</span> member <span class="hljs-keyword">in</span> members:
    workflow.add_edge(member, <span class="hljs-string">"supervisor"</span>)

<span class="hljs-comment"># 根据 supervisor 的判断进行条件路由</span>
conditional_map = {k: k <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> members}
conditional_map[<span class="hljs-string">"FINISH"</span>] = END
workflow.add_conditional_edges(<span class="hljs-string">"supervisor"</span>, <span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">"next"</span>], conditional_map)

workflow.set_entry_point(<span class="hljs-string">"supervisor"</span>)
graph = workflow.<span class="hljs-built_in">compile</span>()
</code></pre>
<hr/>
<h3 data-id="heading-7">4. 避坑指南：老司机的私房建议</h3>
<h4 data-id="heading-8">1. 警惕“幻觉传递”</h4>
<p>Agent A 可能会生成一个错误的 API 调用方法，Agent B 拿到后会基于这个错误继续编写代码。</p>
<ul>
<li><strong>对策</strong>：在 <code>Researcher</code> 和 <code>Coder</code> 之间增加一个 <code>Validator</code>（校验节点）。不要让 Agent 自己检查自己，让另一个 Prompt 专门负责“找茬”。</li>
</ul>
<h4 data-id="heading-9">2. 解决死循环与 Token 爆炸</h4>
<p>当 Agent 无法完成任务时，它可能会在两个节点之间反复横跳。</p>
<ul>
<li><strong>对策</strong>：在 <code>compile()</code> 时设置 <code>recursion_limit</code>。
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 限制最大步数为 20 步，超过则强制停止</span>
graph.invoke({<span class="hljs-string">"messages"</span>: [HumanMessage(content=<span class="hljs-string">"..."</span>) ]}, {<span class="hljs-string">"recursion_limit"</span>: <span class="hljs-number">20</span>})
</code></pre>
</li>
</ul>
<h4 data-id="heading-10">3. 状态清理</h4>
<p>随着对话增加，<code>messages</code> 列表会越来越长，导致 Context Window 溢出。</p>
<ul>
<li><strong>对策</strong>：在 Supervisor 节点中加入“摘要逻辑”。每当消息超过 10 条，就触发一次总结，将历史信息压缩，只保留关键结论。</li>
</ul>
<h4 data-id="heading-11">4. 人类干预（Human-in-the-loop）</h4>
<p>有些关键决策（比如删除数据库、发送邮件）不能全自动化。</p>
<ul>
<li><strong>对策</strong>：利用 LangGraph 的 <code>interrupt_before</code> 功能。在执行 <code>Coder</code> 节点前暂停，等待人工在控制台输入 <code>Approve</code> 后再继续。</li>
</ul>
<hr/>
<h3 data-id="heading-12">5. 深度总结：单体 vs 多 Agent</h3>






























<table><thead><tr><th align="left">特性</th><th align="left">单体 Agent (Single Agent)</th><th align="left">多 Agent 协作 (Multi-Agent)</th></tr></thead><tbody><tr><td align="left"><strong>复杂度上限</strong></td><td align="left">低，容易在长链条任务中迷失</td><td align="left">高，通过模块化拆解复杂逻辑</td></tr><tr><td align="left"><strong>调试难度</strong></td><td align="left">极难，Prompt 牵一发而动全身</td><td align="left">较易，可针对特定节点优化 Prompt</td></tr><tr><td align="left"><strong>Token 效率</strong></td><td align="left">早期省，后期因重复尝试而浪费</td><td align="left">初始开销大，但任务成功率更高</td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">简单的问答、单一工具调用</td><td align="left">软件开发、深度市场调研、复杂流转业务</td></tr></tbody></table>
<p><strong>最后的一点经验：</strong> 不要为了用多 Agent 而用多 Agent。如果一个任务通过优化 System Prompt 就能让单体 Agent 搞定，那就不要引入 LangGraph。多 Agent 系统的本质是<strong>用架构的确定性来弥补模型推理的不确定性</strong>。当你发现你的 Prompt 已经长到连你自己都读不下去时，就是该拆分 Agent 的时候了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 React 里优雅地 “隐藏 iframe 滚动条”]]></title>    <link>https://juejin.cn/post/7587961565477224502</link>    <guid>https://juejin.cn/post/7587961565477224502</guid>    <pubDate>2025-12-26T09:27:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587961565477224502" data-draft-id="7587998744294146054" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 React 里优雅地 “隐藏 iframe 滚动条”"/> <meta itemprop="keywords" content="前端,React.js,CSS"/> <meta itemprop="datePublished" content="2025-12-26T09:27:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨夜寻晴天"/> <meta itemprop="url" content="https://juejin.cn/user/1943592288391496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 React 里优雅地 “隐藏 iframe 滚动条”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592288391496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨夜寻晴天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:27:30.000Z" title="Fri Dec 26 2025 09:27:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前端有一个经典问题：</p>
<blockquote>
<p>你在宿主页面怎么写 CSS，都<strong>管不到 iframe 内部</strong>的滚动条。</p>
</blockquote>
<p>所以正确的前端方案不是 “给外层容器加 overflow”，而是：<strong>尽量在 iframe 自己层面兜底 + 同源时向 iframe 内注入 CSS</strong>。</p>
<p>本文只聚焦前端实现，不展开前后端传参链路。</p>
<hr/>
<h2 data-id="heading-0">1. 为什么你明明设置了，滚动条还是在？</h2>
<p>因为滚动条来自 <strong>iframe 内部 document</strong>：</p>
<ul>
<li>外层 <code>div</code> 的 <code>overflow-hidden</code> 只能裁剪 “iframe 这个盒子” 是否溢出</li>
<li>iframe 里面的页面是否出现滚动条，取决于 iframe 内部的 <code>html/body</code> 或某个容器的 <code>overflow</code></li>
<li>宿主页面的 CSS 不会跨 document 生效（iframe 天生隔离）</li>
</ul>
<hr/>
<h2 data-id="heading-1">2. 我们最终用了 “两层方案”，解决现实世界的不确定性</h2>
<p>实现集中在 <code>src/components/Search/ViewExtensionIframe.tsx:1-88</code>。</p>
<h3 data-id="heading-2">2.1 第一层：<code>scrolling="no"</code> 作为低成本兜底</h3>
<pre><code class="hljs language-tsx" lang="tsx">&lt;iframe scrolling={hideScrollbar ? <span class="hljs-string">"no"</span> : <span class="hljs-string">"auto"</span>} /&gt;
</code></pre>
<p>它不是现代标准，但在某些 WebView/嵌入环境里仍能减少滚动条出现的概率。</p>
<p>它的价值在于：<strong>不依赖同源</strong>，哪怕你进不去 iframe，也能 “碰一碰运气”。</p>
<h3 data-id="heading-3">2.2 第二层（主力）：同源时注入一段隐藏滚动条的 CSS</h3>
<p>核心是这段逻辑（同文件 <code>applyHideScrollbarToIframe</code>）：</p>
<ul>
<li><code>src/components/Search/ViewExtensionIframe.tsx:5-39</code></li>
</ul>
<p>做法很直接：</p>
<ol>
<li>拿到 <code>iframe.contentDocument</code></li>
<li>往里面塞一个带固定 <code>id</code> 的 <code>&lt;style&gt;</code></li>
<li>开关关闭时把这个 <code>&lt;style&gt;</code> 删掉</li>
</ol>
<p>注入的 CSS 同时覆盖主流引擎：</p>
<pre><code class="hljs language-css" lang="css">* {
  <span class="hljs-attribute">scrollbar-width</span>: none;      <span class="hljs-comment">/* Firefox */</span>
  -ms-<span class="hljs-attribute">overflow</span>-style: none;   <span class="hljs-comment">/* 老 IE/Edge 风格 */</span>
}
*::-webkit-scrollbar {        <span class="hljs-comment">/* Chrome/Safari */</span>
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0px</span>;
}
</code></pre>
<p>为什么用 <code>*</code>？</p>
<ul>
<li>扩展页面的滚动容器不一定是 <code>body</code>，可能是任意 <code>div overflow-auto</code></li>
<li>用 <code>*</code> 能最大概率“全场隐藏”，更通用</li>
</ul>
<p>为什么要固定 <code>id</code>？</p>
<ul>
<li>防止重复注入（多次 onLoad / 状态变化）</li>
<li>关闭时能精确移除，保证可逆</li>
</ul>
<hr/>
<h2 data-id="heading-4">3. 为什么要 “onLoad + useEffect” 双触发？</h2>
<p>这是最容易漏、也最影响体验的一点。</p>
<ul>
<li><code>useEffect</code>：响应 <code>hideScrollbar</code> 变化（开关切换时立刻生效）</li>
<li><code>onLoad</code>：保证“首次加载完成后一定注入成功”</li>
</ul>
<p>原因：iframe 的加载时序不可控。你在 React 渲染完时，iframe 可能还没 ready，<code>contentDocument</code> 为空；等到 onLoad 才能 100% 确认 document 存在。</p>
<p>对应代码：</p>
<ul>
<li><code>src/components/Search/ViewExtensionIframe.tsx:52-55</code></li>
<li><code>src/components/Search/ViewExtensionIframe.tsx:78-84</code></li>
</ul>
<hr/>
<h2 data-id="heading-5">4. 这个方案的边界与坑（提前写清楚，后面少掉头发）</h2>
<h3 data-id="heading-6">4.1 “隐藏滚动条” 不等于 “不能滚”</h3>
<p>我们只隐藏 scrollbar 的视觉表现，滚动行为仍存在（滚轮/触摸板/键盘都能滚）。<br/>
这在沉浸式页面很舒服，但在长页面里也可能让用户不知道 “还能滚”。</p>
<h3 data-id="heading-7">4.2 跨域 iframe：注入会失败，但不会炸</h3>
<p>如果 iframe 加载跨域页面，访问 <code>contentDocument</code> 会触发同源限制。当前实现用 <code>try/catch</code> 静默吞掉异常，结果是：</p>
<ul>
<li>CSS 注入失败</li>
<li>只剩 <code>scrolling="no"</code> 兜底，效果不保证</li>
</ul>
<p>这不是 bug，是浏览器安全模型决定的。</p>
<h3 data-id="heading-8">4.3 全局 <code>*</code> 的副作用</h3>
<p>它会把 iframe 内所有滚动条都干掉，包括某些组件内部滚动区域、代码块滚动等。<br/>
目前我们选择“通用性优先”，但如果未来某些扩展需要保留局部滚动条，就要改为更精确的选择器策略。</p>
<hr/>
<h2 data-id="heading-9">5. 一句话总结</h2>
<p>在前端想稳定控制 iframe 滚动条，最靠谱的思路是：</p>
<ul>
<li><strong>先用 iframe 自身属性做兜底</strong></li>
<li><strong>再在同源条件下对 iframe 内部 document 注入 CSS</strong></li>
<li><strong>用固定 style id 保证幂等与可逆</strong></li>
<li><strong>用 onLoad + effect 解决时序问题</strong></li>
</ul>
<p>这就是 <code>hideScrollbar</code> 在前端真正解决的问题：不是写没写 CSS，而是有没有把 CSS 写到“对的世界里”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VueCropper加载OBS图片跨域问题]]></title>    <link>https://juejin.cn/post/7587743345197465652</link>    <guid>https://juejin.cn/post/7587743345197465652</guid>    <pubDate>2025-12-26T09:30:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587743345197465652" data-draft-id="7587743345197449268" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VueCropper加载OBS图片跨域问题"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-26T09:30:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VueCropper加载OBS图片跨域问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:30:22.000Z" title="Fri Dec 26 2025 09:30:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题场景</h2>
<p>在集成 <code>VueCropper</code> 图片裁剪组件时，遇到一个典型的跨域问题：加载存储在 OBS 上的图片时，浏览器会对同一张图片发起两次请求，最终第二次请求触发跨域错误。以下是问题的完整排查过程与现象梳理：</p>
<ol>
<li>请求行为异常：同一张 OBS 图片被浏览器发起两次请求，第一次请求正常响应，第二次请求直接抛出跨域相关错误（如 <code>CORS policy: No 'Access-Control-Allow-Origin' header</code>）；</li>
<li>初步排查方向：初期优先怀疑 OBS 服务器跨域配置缺失，反馈运维核查后，确认 OBS 已正确配置跨域允许规则（含允许当前前端域名、支持 GET 方法等）；</li>
<li>关键测试突破：通过浏览器开发者工具测试发现，开启「停用缓存」功能后，跨域错误消失。据此锁定问题根源与浏览器缓存机制相关；</li>
<li>核心差异定位：对比两次请求的详细信息，发现跨域标识配置不一致——第一次加载图片未设置 <code>crossOrigin</code> 标识，第二次加载时则添加了该标识；</li>
<li>问题逻辑闭环：第一次请求因无 <code>crossOrigin</code> 标识，OBS 服务器识别为非跨域请求，未返回跨域响应头；第二次请求虽开启 <code>crossOrigin</code>，但因图片 URL 未变，浏览器直接复用缓存的无跨域响应头资源，导致跨域校验失败。</li>
</ol>
<h2 data-id="heading-1">问题根源</h2>
<p>为验证上述排查结论，通过原生 JavaScript 代码复现了问题场景，最终确认问题根源为 <strong>跨域策略与浏览器缓存冲突</strong>。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
    <span class="hljs-comment">// 第一次加载：未设置 crossOrigin 标识</span>
    image.<span class="hljs-property">src</span> = <span class="hljs-string">'https://xxx.png'</span>; 
    image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片加载完成'</span>);
        <span class="hljs-keyword">const</span> image2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
        <span class="hljs-comment">// 第二次加载：设置跨域标识（与第一次不一致）</span>
        image2.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">"anonymous"</span>;
        <span class="hljs-comment">// 加载同一张图片，触发跨域错误</span>
        image2.<span class="hljs-property">src</span> = image.<span class="hljs-property">src</span>; 
        image2.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片2加载完成'</span>);
        });
    });
});
</code></pre>
<p>该问题的核心矛盾是「同一张图片的两次请求采用不一致的跨域策略」，结合浏览器缓存机制与 OBS 服务器的跨域响应规则，具体错误逻辑可拆解为两步：</p>
<ol>
<li>非跨域模式缓存：第一次加载未设置 <code>crossOrigin</code>，浏览器以「非跨域模式」发起请求（请求头 <code>Sec-Fetch-Mode = no-cors</code>）；OBS 服务器识别该模式后，不返回 <code>Access-Control-Allow-Origin</code> 等跨域响应头，浏览器则将这份「无跨域响应头的图片资源」缓存至本地；</li>
<li>跨域模式缓存冲突：第二次加载设置 <code>crossOrigin: "anonymous"</code>，浏览器需以「跨域模式」请求；但因图片 URL 未变，浏览器直接复用本地缓存的无跨域响应头资源，跨域校验无法通过，最终触发错误。</li>
</ol>
<p>关键结论：同一张图片的所有请求，跨域标识必须完全统一（要么所有请求都设 <code>crossOrigin</code>，要么都不设），否则会因缓存机制导致跨域策略冲突。</p>
<h2 data-id="heading-2">解决办法</h2>
<h3 data-id="heading-3">1. 核心通用方案：统一跨域标识（推荐首选）</h3>
<p>思路：统一所有加载该图片的 <code>Image</code> 实例的跨域配置（均设置或均不设置 <code>crossOrigin</code>），确保两次请求的跨域策略一致，从根源避免缓存与跨域规则的冲突。</p>
<p>核心注意点：<code>crossOrigin</code> 必须在 <code>src</code> 赋值 <strong>之前</strong> 设置。若先赋值 <code>src</code>，浏览器会提前以默认模式发起请求，仍会触发跨域冲突。</p>
<p>正确代码示例：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 第一次加载：提前设置 crossOrigin，统一跨域策略</span>
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
  image.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">"anonymous"</span>; 
  image.<span class="hljs-property">src</span> = <span class="hljs-string">'https://xxx.png'</span>;

  image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片加载完成'</span>);
      <span class="hljs-comment">// 第二次加载：保持 crossOrigin 配置一致</span>
      <span class="hljs-keyword">const</span> image2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
      image2.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">"anonymous"</span>; 
      image2.<span class="hljs-property">src</span> = image.<span class="hljs-property">src</span>;

      image2.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片2加载完成'</span>);
      });
  });

  <span class="hljs-comment">// 添加错误监听，便于问题排查</span>
  image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'图片1加载失败:'</span>, e));
  image2.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'图片2加载失败:'</span>, e));
});
</code></pre>
<p>适用场景：绝大多数前端场景（包括 <code>VueCropper </code> 等依赖 canvas 的裁剪组件场景），且图片存储端<code>（OBS/CDN）</code>已配置跨域允许规则。</p>
<h3 data-id="heading-4">2. 绕过缓存方案：让第二次请求视为「新资源」</h3>
<p>思路：若历史代码无法批量修改 <code>crossOrigin</code> 配置，可通过让第二次请求「避开缓存」，迫使浏览器重新向 OBS 服务器发起请求（而非复用旧缓存），从而避免跨域策略冲突。</p>
<p>推荐方案：给图片 URL 添加随机参数（如时间戳），使浏览器识别为「新资源」，触发全新请求：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> image2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
  image2.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">"anonymous"</span>;
  <span class="hljs-comment">// 追加时间戳参数，避开浏览器缓存</span>
  image2.<span class="hljs-property">src</span> = <span class="hljs-string">`<span class="hljs-subst">${image.src}</span>&amp;t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>; 
  image2.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片2加载完成'</span>));
});
</code></pre>
<p>适用场景：历史代码架构复杂，无法批量统一 <code>crossOrigin</code> 配置，需快速临时修复跨域问题。</p>
<p>缺点：完全失去缓存优势，每次请求均需重新下载图片，会增加带宽消耗并延长页面加载时间，仅建议临时使用。</p>
<h3 data-id="heading-5">3. 后端/存储端方案：从根源消除跨域</h3>
<p>思路：通过后端代理或域名绑定，将「跨域图片请求」转为「同源请求」，从根源上消除跨域问题，无需前端额外配置 <code>crossOrigin</code>。</p>
<p>具体做法：</p>
<ol>
<li>同源代理（推荐）：前端请求自身后端的代理接口，由后端代为拉取 OBS 图片并返回给前端。此时前端接收的图片为同源资源，无需任何跨域配置。</li>
</ol>
<p>示例（<code>Node.js/Express</code> 代理）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 后端代理代码（Node.js/Express）</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

<span class="hljs-comment">// 图片代理接口：接收前端传递的 OBS 图片 URL</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/proxy-image'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> imgUrl = req.<span class="hljs-property">query</span>.<span class="hljs-property">url</span>;
  <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 后端请求 OBS 图片，以流形式返回给前端</span>
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(imgUrl, { <span class="hljs-attr">responseType</span>: <span class="hljs-string">'stream'</span> });
      response.<span class="hljs-property">data</span>.<span class="hljs-title function_">pipe</span>(res);
  } <span class="hljs-keyword">catch</span> (err) {
      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'图片加载失败'</span>);
  }
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'代理服务启动在 3000 端口'</span>));
</code></pre>
<p>前端代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端代码：请求后端代理接口，无跨域问题</span>
<span class="hljs-keyword">const</span> image = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
image.<span class="hljs-property">src</span> = <span class="hljs-string">`http://localhost:3000/proxy-image?url=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-string">'https://xxx.png'</span>)}</span>`</span>;
image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片加载完成'</span>));
</code></pre>
<p>适用场景：前端需大量处理跨域图片（如批量裁剪、像素操作）；追求稳定可靠的跨域解决方案，不希望依赖前端代码配置。</p>
<p>优点：彻底解决跨域问题，前端无需任何跨域相关配置；缓存机制可正常生效，不影响加载性能；安全性更高（避免设置 <code>*</code> 允许所有域名跨域）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[trea solo,让我从牛马外包翻身当“甲方”]]></title>    <link>https://juejin.cn/post/7588086766234779686</link>    <guid>https://juejin.cn/post/7588086766234779686</guid>    <pubDate>2025-12-26T09:31:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766234779686" data-draft-id="7587965908288159754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="trea solo,让我从牛马外包翻身当“甲方”"/> <meta itemprop="keywords" content="Trae,Python"/> <meta itemprop="datePublished" content="2025-12-26T09:31:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冷月半明"/> <meta itemprop="url" content="https://juejin.cn/user/2520515442391102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            trea solo,让我从牛马外包翻身当“甲方”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2520515442391102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冷月半明
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:31:21.000Z" title="Fri Dec 26 2025 09:31:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：牛马的坦白</h2>
<p>马上就要2026了，我得承认一件事：AI工具已经把我"惯坏"了。</p>
<p>在电力负荷预测这个领域摸爬滚打这么久，习惯了搜论文、手撸代码、调参调到怀疑人生。直到最近开始用Trea AI的Solo模式，才发现原来可以这么玩——它不只是个聊天工具，更像一个能独立思考的技术合伙人：你扔需求，它给方案；你出问题，它自动debug；你懒得写文档，它一气呵成。</p>
<p>这篇文章不吹不黑，就聊聊我是怎么在真实项目里把Trea AI用成"自己人"的。</p>
<hr/>
<h2 data-id="heading-1">Trea AI在我项目里的"打工实录"</h2>
<h3 data-id="heading-2">1. 需求分析：从"啃论文"到"聊明白"</h3>
<p>以前做方案设计，流程是这样的：Google Scholar → 下载20篇论文 → 看完摘要放弃10篇 → 精读5篇 → 最后发现还是不知道选哪个。</p>
<p>现在？</p>
<pre><code class="hljs language-arduino" lang="arduino">我：<span class="hljs-string">"Trea，Direct和递归预测策略，实际项目里怎么选？说点论文里不写的东西。"</span>
Trea chat：<span class="hljs-string">"Direct就像给每个时间点请个专家，精准但贵；递归相当于一个专家连轴转，省预算但会累趴。你数据量多大？预算多少？"</span>
我：<span class="hljs-string">"几百万条数据，预算...能用开源就不花钱。"</span>
Trea chat：<span class="hljs-string">"那还是递归吧，先跑通再优化。我直接给你生成一个完整的项目框架..."</span>
</code></pre>
<p>十分钟搞定技术选型，还附赠代码框架。省下的时间，够我喝杯咖啡摸鱼...咳，是做深度思考。</p>
<h3 data-id="heading-3">2. 代码生成：从"手敲"到"对话"</h3>
<h4 data-id="heading-4">特征工程：终于不用当CV工程师了</h4>
<p>做温度特征那天，我脑子已经转不动了：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 我："Trea，帮我写个函数，判断温度是不是到了开空调的临界点"</span>
<span class="hljs-comment"># Trea：直接甩过来完整代码，还附带单元测试</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">add_temperature_threshold_features</span>(<span class="hljs-params">df</span>):
    <span class="hljs-string">"""
    根据温度判断空调负荷特征的函数
    """</span>
    df = df.copy()
    
    <span class="hljs-comment"># 夏季制冷阈值26°C：每超1度，负荷明显增加</span>
    df[<span class="hljs-string">'temp_above_cooling'</span>] = df[<span class="hljs-string">'temp_max'</span>].apply(<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, x - <span class="hljs-number">26</span>))
    df[<span class="hljs-string">'ac_cooling_usage'</span>] = (df[<span class="hljs-string">'temp_above_cooling'</span>] &gt; <span class="hljs-number">0</span>).astype(<span class="hljs-built_in">int</span>)
    
    <span class="hljs-comment"># 冬季制热阈值12°C：低于这个，取暖负荷上来</span>
    df[<span class="hljs-string">'temp_below_heating'</span>] = df[<span class="hljs-string">'temp_min'</span>].apply(<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, <span class="hljs-number">12</span> - x))
    df[<span class="hljs-string">'ac_heating_usage'</span>] = (df[<span class="hljs-string">'temp_below_heating'</span>] &gt; <span class="hljs-number">0</span>).astype(<span class="hljs-built_in">int</span>)
    
    <span class="hljs-comment"># 温度变化率：反映天气突变带来的负荷波动</span>
    df[<span class="hljs-string">'temp_change_rate'</span>] = df[<span class="hljs-string">'temp_avg'</span>].diff().fillna(<span class="hljs-number">0</span>)
    
    <span class="hljs-keyword">return</span> df

<span class="hljs-comment"># Trea还自动生成了测试用例：</span>
<span class="hljs-comment"># test_add_temperature_threshold_features()</span>
</code></pre>
<p>代码规范、注释清晰，比我写的强多了。我直接git commit，然后告诉自己：这是团队协作的成果（手动狗头）。</p>
<h4 data-id="heading-5">Debug：从"抓瞎"到"老中医问诊"</h4>
<p>那次XGBoost预测值系统性偏低，我盯了很久没头绪：</p>
<pre><code class="hljs language-arduino" lang="arduino">我：<span class="hljs-string">"模型预测值整体偏低30%左右，可能是什么原因？我检查了数据分布，没啥异常。"</span>
Trea：<span class="hljs-string">"看过目标变量吗？电力负荷数据长尾分布严重，你不做变换，模型会被大数值带偏，导致整体低估。要我帮你写一个完整的数据预处理pipeline吗？"</span>
我：<span class="hljs-string">"帮我列出计划并实现。"</span>
</code></pre>
<p>对数变换后，问题解决了。整个过程就像找个老中医把脉，三句话点到要害，还直接给你开好药方。</p>
<hr/>
<h3 data-id="heading-6">3. 文档编写：从"拖延症"到"秒交差"</h3>
<p>写文档的痛苦，谁写谁知道。现在我都直接"口述"：
代码扔过去，让它按公司模板生成接口定义复制给它，五分钟出文档给它大纲，它帮我写逐字稿，还提示哪里加图表</p>
<hr/>
<h2 data-id="heading-7">工作模式的"被动升级"</h2>
<h3 data-id="heading-8">1. 角色变了：从"全栈"到"架构师"</h3>
<p>以前：需求、编码、测试、文档一条龙。
现在：我负责想，Trea负责干。听起来像资本家，但确实效率翻倍。</p>
<h3 data-id="heading-9">2. 决策变了：从"拍脑袋"到"先问Trea"</h3>
<p>技术选型前先问Trea："这个方案有啥坑？" 它总能说出几个我没想到的corner case。相当于带了个经验丰富的顾问。</p>
<h3 data-id="heading-10">3. 速度变了：从"马拉松"到"冲刺"</h3>
<p>特征工程这块，原计划三周，实际五天。项目经理问我是不是偷偷加班了，我说：不，是我找了个不收费的帮手。</p>
<h3 data-id="heading-11">4. 关注点变了：从"细节"到"全局"</h3>
<p>不用纠结于某个函数怎么写，更多时间花在系统设计和业务理解上。这种转变，反而让我的工作更有价值。</p>
<hr/>
<h2 data-id="heading-12">一些"血泪总结"的最佳实践</h2>
<h3 data-id="heading-13">1. Prompt要"具体"</h3>
<p>模糊指令 = 垃圾输出。我的模板：</p>
<pre><code class="hljs">背景 + 具体任务 + 输出格式 + 质量要求
</code></pre>
<p>比如："我需要一个Python函数，计算时间序列的滞后特征。输入是DataFrame，输出是加了特征的DataFrame。代码要有类型提示和docstring，风格参考scikit-learn。"</p>
<h3 data-id="heading-14">2. 别懒：AI的代码也得review</h3>
<p>信任但要验证。我坚持：</p>
<ul>
<li>所有Trea生成的核心逻辑必须跑通单元测试</li>
<li>性能关键部分要profile</li>
<li>代码风格不符合团队规范的，让它重写</li>
</ul>
<h3 data-id="heading-15">3. 持续对话：像带新人一样</h3>
<p>一次给大任务，不如分步来。先让它出框架，再逐步细化。这样返工最少。</p>
<hr/>
<h2 data-id="heading-16">那些不得不说的"副作用"</h2>
<h3 data-id="heading-17">1. 技能树确实变了</h3>
<p>现在更看重：</p>
<ul>
<li><strong>提问能力</strong>：问对问题，比知道答案重要</li>
<li><strong>批判思维</strong>：AI也会一本正经胡说八道</li>
<li><strong>系统设计</strong>：怎么把AI集成到workflow里</li>
</ul>
<h3 data-id="heading-18">2. 版权问题：别当甩手掌柜</h3>
<p>我的底线：</p>
<ul>
<li>核心算法自己写</li>
<li>Trea代码必须理解后使用</li>
<li>商用项目保留修改记录</li>
</ul>
<h3 data-id="heading-19">3. 警惕"AI依赖症"</h3>
<p>有时候还是得自己动手。AI是拐杖，不是轮椅。脑子不能停。</p>
<hr/>
<h2 data-id="heading-20">给还在观望的同学几句实话</h2>
<p>Trea AI这玩意，用好了是真香，但别神话它。它不会取代你，但会让会用的人效率翻倍。</p>
<p>在电力预测这个领域，它帮我解决了至少40%的重复劳动，让我有更多时间做真正有价值的事——比如理解业务、优化模型、跟调度中心的老登们扯皮。</p>
<p>说到底，它就是个超级工具。工具的价值，取决于用它的人。</p>
<p>对了，最近我在尝试让它帮我写周报。效果不错，就是得手动删掉一些过于夸张的"自我表扬"。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[加入我们，一起定义「Data x AI」的未来]]></title>    <link>https://juejin.cn/post/7587845752682856511</link>    <guid>https://juejin.cn/post/7587845752682856511</guid>    <pubDate>2025-12-26T09:40:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587845752682856511" data-draft-id="7588002126258012166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="加入我们，一起定义「Data x AI」的未来"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-12-26T09:40:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            加入我们，一起定义「Data x AI」的未来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:40:15.000Z" title="Fri Dec 26 2025 09:40:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在阿里云，我们正站在一个技术转折点上。</p>
<p>今天的大模型不再只是“聊天”——它开始查故障、做决策、自动修复系统。而这一切的前提是：AI 必须真正“看见”这个世界。不是通过摄像头，而是通过千万服务器、百万容器、亿级请求中持续涌出的日志、指标、追踪、eBPF 事件和 Agent 行为数据。这些数据，是系统最真实的脉搏，也是智能演进的原始燃料。</p>
<p>我们正在构建一条从数据到智能的闭环通路：把海量、异构、高速的数据汇聚成一条实时、高质量、可计算的“数据飞轮”，喂给 AI，训练 Agent，驱动自动化决策。这就是“Data + AI”的新范式。我们不再被动告警，而是让系统自己“诊断 + 治疗”；不再靠人翻日志，而是由 AI 实时推理根因；不再手工调参，而是让 Agent 在持续反馈中越用越聪明。而支撑这一切的，是一个日增百 PB 级数据的实时处理平台。它必须扛住流量洪峰，支撑千亿级数据的秒级查询，为 AI 提供干净、结构化、低延迟的数据燃料，成为云原生时代的“感知神经”。这不是简单的数据管道，而是 AI 时代的操作系统级数据基座。</p>
<p>阿里云日志服务 SLS 团队每天处理超百 PB 数据，覆盖阿里集团全系业务与数百万云上客户。我们研发的 LoongCollector（原 iLogtail）作为国内广泛使用的开源云原生可观测采集器，已在千万级实例上稳定运行。我们深度服务于大模型训练、RAG、Agent 反馈、智能运维等前沿场景。我们不只做旁路监控与观测，我们做的是基础设施本身。现在，我们正在寻找三位真正的系统建筑师，加入这场超大规模系统的极限挑战。如果你曾在 Linux 内核层优化内存与网络，曾让 SQL 在千亿数据上毫秒响应，曾用向量检索与倒排索引支撑 AI 的语义理解，或亲手构建过一个会自我进化的 Agent 数据闭环——那么这里就是你的战场。</p>
<h2 data-id="heading-0">岗位一：云原生应用平台 - AI Infra 研发工程师（P6~P8）- 杭州</h2>
<h3 data-id="heading-1">职责概述</h3>
<p>负责阿里集团、阿里云可观测数据处理基础设施建设，打造日增百 PB 级数据的实时数据分析平台。通过实时采集、索引、存储、压缩等技术，实时处理来自千万设备的海量日志数据，并针对 AI 应用场景进行特定优化，提供智能、自动化数据分析服务。</p>
<p>加入该岗位，您将有机会在国内超大规模的实时日志平台上，构建各种面向各类 AI 应用场景的数据存储和处理平台，打造新一代的 AI 基础设施。</p>
<h3 data-id="heading-2">主要职责</h3>
<ol>
<li>
<p>参与阿里云战略级产品 SLS 研发，参与面向 AI 应用场景的数据采集、处理、查询分析等功能开发与设计；</p>
</li>
<li>
<p>数据索引和查询分析引擎优化，通过数据编码、压缩、向量、倒排索引、SQL 执行优化、CodeGen 等各类技术，实现百~千亿数据实时查询秒级延时，提供极致查询体验；</p>
</li>
<li>
<p>参与 Agent 数据飞轮的建设，研发稳定可靠的 Agent 运行时数据基础设施；</p>
</li>
</ol>
<h3 data-id="heading-3">职位要求</h3>
<ol>
<li>
<p>熟悉 AI 领域，对于 AI 应用数据特征，数据存储和查询需求有深入理解；</p>
</li>
<li>
<p>深入理解 LLM 原理，了解上下文工程、KV Cache 机制及 Prompt 优化策略，熟悉 Agent Memory、RAG 相关技术，有实战经验更佳；</p>
</li>
<li>
<p>在高性能数据结构、数据编码压缩、向量（Vector Search）、倒排索引（Inverted Index）、混合检索（Hybrid Search）算法上深入研究，熟悉分布式 SQL 优先；</p>
</li>
<li>
<p>高性能网络服务器编程经验，熟悉异步 IO、内存管理、多线程同步等技术，有 Linux 内核研究经验更佳；</p>
</li>
<li>
<p>对技术有强烈的进取心，有较强的学习能力，保持对前沿技术的关注和学习；</p>
</li>
<li>
<p>具有良好的沟通能力和团队合作精神、优秀的问题分析和解决能力；</p>
</li>
<li>
<p>优先：对 Lucene、LevelDB、Influxdb、TokuDB、kudu、LanceDB 源代码深入研究者；</p>
</li>
<li>
<p>优先：有 TB~PB 级数据 OLTP/OLAP 经验者；大型系统自动化运维管理开发经验。</p>
</li>
</ol>
<p>投递链接 A：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcareers.aliyun.com%2Foff-campus%2Fposition-detail%3Flang%3Dzh%26positionId%3D100002183001%26trace%3Dqrcode_share" target="_blank" title="https://careers.aliyun.com/off-campus/position-detail?lang=zh&amp;positionId=100002183001&amp;trace=qrcode_share" ref="nofollow noopener noreferrer">careers.aliyun.com/off-campus/…</a></p>
<p>投递链接 B：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcareers.aliyun.com%2Foff-campus%2Fposition-detail%3Flang%3Dzh%26positionId%3D2009283001%26trace%3Dqrcode_share" target="_blank" title="https://careers.aliyun.com/off-campus/position-detail?lang=zh&amp;positionId=2009283001&amp;trace=qrcode_share" ref="nofollow noopener noreferrer">careers.aliyun.com/off-campus/…</a></p>
<h2 data-id="heading-4">岗位二：云原生应用平台 - 可观测基础平台高级研发工程师 - 上海</h2>
<h3 data-id="heading-5">职责概述</h3>
<p>负责阿里集团、阿里云可观测数据处理基础设施建设，打造日增百 PB 级数据的实时数据分析平台。通过实时采集、索引、存储、压缩等技术，实时处理来自千万设备的海量日志数据，并针对 AI 应用场景进行特定优化，提供智能、自动化数据分析服务。</p>
<p>加入该岗位，您将有机会在国内超大规模的实时日志平台上，构建面向各类 AI 应用场景的数据存储和处理平台，打造新一代的 AI 基础设施。</p>
<h3 data-id="heading-6">主要职责</h3>
<ol>
<li>
<p>参与阿里云战略级产品 SLS 研发，参与面向 AI 应用场景的数据采集、处理、查询分析等功能开发与设计。</p>
</li>
<li>
<p>参与千万级实例、数百 PB 流量的云原生可观测采集器 LoongCollector/iLogtail 及管控系统开发，打造云上统一的 OneAgent 能力，服务于日志、指标、eBPF、主机监控、安全等多种场景；主导 LoongCollector 开源技术路线，推动采集行业标准建立。</p>
</li>
<li>
<p>深度参与并打造高性能、高可靠的数据采集与管控系统，深入底层优化，提升网络、内存和 CPU 等关键资源的利用效率。</p>
</li>
<li>
<p>面向 AI 应用构建高性能、安全的多模态数据处理与数据集管理平台，参与上下游 AI 生态建设。</p>
</li>
</ol>
<h3 data-id="heading-7">职位要求</h3>
<ol>
<li>
<p>扎实的算法基础和良好的编码习惯，精通 C++、Java、Go、Python 中任何一门语言。</p>
</li>
<li>
<p>在高性能数据结构、数据编码压缩、向量构建等有深入研究；熟悉异步 IO、内存管理、多线程同步等技术，有 Linux 内核研究经验更佳。</p>
</li>
<li>
<p>理解分布式系统，包括调度、分布式锁、负载均衡等。</p>
</li>
<li>
<p>对技术有强烈的进取心，有较强的学习能力，保持对前沿技术的关注和学习。</p>
</li>
<li>
<p>具有良好的沟通能力和团队合作精神、优秀的问题分析和解决能力。</p>
</li>
<li>
<p>熟悉 LLM、Prompt 设计、Agent 框架（如 LangGraph、Dify、AutoGen、Google ADK、工具链集成等）者优先。</p>
</li>
<li>
<p>对 LoongCollector、OpenTelemetry、Fluentbit、Vector、Tetragon、Falco 源代码有深入研究者优先。</p>
</li>
</ol>
<p>投递链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcareers.aliyun.com%2Foff-campus%2Fposition-detail%3Flang%3Dzh%26positionId%3D100002203001%26trace%3Dqrcode_share" target="_blank" title="https://careers.aliyun.com/off-campus/position-detail?lang=zh&amp;positionId=100002203001&amp;trace=qrcode_share" ref="nofollow noopener noreferrer">careers.aliyun.com/off-campus/…</a></p>
<p>这不只是一份普通的技术工作。你写的每一行代码，都将运行在最复杂的真实场景中，影响整个阿里云的稳定性，并通过云计算辐射千行百业。你参与定义的技术路径，可能成为下一代云原生标准；你打磨的数据基座，将成为中国 AI 自动化能力的起点。我们在杭州、上海开放岗位。如果你准备好了，请加入我们，一起建造 AI 时代最重要的数据基础设施。</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fcareers.aliyun.com%2Foff-campus%2Fposition-detail%3Flang%3Dzh%26positionId%3D100002203001%26trace%3Dqrcode_share" target="_blank" title="https://careers.aliyun.com/off-campus/position-detail?lang=zh&amp;positionId=100002203001&amp;trace=qrcode_share" ref="nofollow noopener noreferrer">此处</a>立即投递~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[containerd的CPU过高的问题排查]]></title>    <link>https://juejin.cn/post/7587740546954854440</link>    <guid>https://juejin.cn/post/7587740546954854440</guid>    <pubDate>2025-12-26T09:48:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587740546954854440" data-draft-id="7587776610436055055" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="containerd的CPU过高的问题排查"/> <meta itemprop="keywords" content="容器,Kubernetes,性能优化"/> <meta itemprop="datePublished" content="2025-12-26T09:48:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="liuxuzxx"/> <meta itemprop="url" content="https://juejin.cn/user/465848660687336"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            containerd的CPU过高的问题排查
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848660687336/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    liuxuzxx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:48:51.000Z" title="Fri Dec 26 2025 09:48:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>发现线下一台k8s的node的containerd的CPU基本在95%-130%之间来回浮动，看到别的node的containerd的CPU占用率基本都在20%以下，或者是基本上是:1%-5%的样子.</p>
<h2 data-id="heading-1">排查过程</h2>
<h3 data-id="heading-2">定位CPU过高的进程</h3>
<ol>
<li>使用top命令查看发现containerd的CPU居高不下，基本上在100%---120%之间浮动</li>
<li>使用pidstat命令仔细查看</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">linux &gt; pidstat -p 1163 1 <span class="hljs-comment">#抓取1163进程，按照1s的间隔打印CPU消耗</span>

33分27秒   UID       PID    %usr %system  %guest   %<span class="hljs-built_in">wait</span>    %CPU   CPU  Command
33分28秒     0      1163   68.00   56.00    0.00    0.00  124.00     2  containerd
33分29秒     0      1163   46.00   49.00    0.00    0.00   95.00     2  containerd
33分30秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
33分31秒     0      1163    4.00    1.00    0.00    0.00    5.00     2  containerd
33分32秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
33分33秒     0      1163    4.00    3.00    0.00    0.00    7.00     2  containerd
33分34秒     0      1163   58.00   60.00    0.00    0.00  118.00     2  containerd
33分35秒     0      1163   56.00   58.00    0.00    0.00  114.00     2  containerd
33分36秒     0      1163   59.00   57.00    0.00    0.00  116.00     2  containerd
33分37秒     0      1163   59.00   60.00    0.00    0.00  119.00     2  containerd
33分38秒     0      1163   69.00   57.00    0.00    0.00  126.00     2  containerd
33分39秒     0      1163   50.00   49.00    0.00    0.00   99.00     2  containerd
33分40秒     0      1163    2.00    1.00    0.00    0.00    3.00     2  containerd
33分41秒     0      1163    3.00    1.00    0.00    0.00    4.00     2  containerd
33分42秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
33分43秒     0      1163    3.00    2.00    0.00    0.00    5.00     2  containerd
33分44秒     0      1163   56.00   61.00    0.00    0.00  117.00     2  containerd
33分45秒     0      1163   60.00   58.00    0.00    0.00  118.00     2  containerd
33分46秒     0      1163   57.00   60.00    0.00    0.00  117.00     2  containerd
33分47秒     0      1163   55.00   63.00    0.00    0.00  118.00     2  containerd
33分48秒     0      1163   71.00   59.00    0.00    0.00  130.00     2  containerd
33分49秒     0      1163   51.00   50.00    0.00    0.00  101.00     2  containerd
33分50秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
33分51秒     0      1163    4.00    2.00    0.00    0.00    6.00     2  containerd
33分52秒     0      1163    2.00    1.00    0.00    0.00    3.00     2  containerd
33分53秒     0      1163    3.00    3.00    0.00    0.00    6.00     2  containerd
33分54秒     0      1163   58.00   60.00    0.00    0.00  118.00     2  containerd


<span class="hljs-comment">#1.其实输出的是:14时33分xx秒格式，为了不换行，去掉了:14时</span>
<span class="hljs-comment">#2.从输出来看，基本上隔4-5s的时间，就会出现大概:6s的CPU运行在: 100%-120%之间</span>
</code></pre>
<h3 data-id="heading-3">使用perf抓取对应进程的CPU采样信息</h3>
<ol>
<li>在目标node上执行perf命令抓取对应pid的CPU的采样信息</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">linux &gt; sudo perf record -F 99 -p 1179 -g -- <span class="hljs-built_in">sleep</span> 60

linux &gt; sudo perf script -i perf.data &gt; out.perf
</code></pre>
<ol start="2">
<li>安装FlameGraph</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">linux &gt; git <span class="hljs-built_in">clone</span> https://github.com/brendangregg/FlameGraph.git
</code></pre>
<ol start="3">
<li>生成火焰图</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">linux &gt; <span class="hljs-built_in">cd</span> FlameGraph //[上一个步骤git <span class="hljs-built_in">clone</span>的FlameGraph的仓库]
linux &gt; ./stackcollapse-perf.pl out.perf | ./flamegraph.pl &gt; flamegraph.svg
</code></pre>
<ol start="4">
<li>生成的CPU的火焰图如下</li>
</ol>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67ea0bf278a64d45b55a99580f1ba324~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGl1eHV6eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767347331&amp;x-signature=mwAsSAMVB2A5cu%2BfIAzlIc5n7WE%3D" alt="" loading="lazy"/></p>
<ol start="5">
<li>分析这个火焰图能够得到耗费CPU最多的地方是</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">os.Lstat这个系统调用
</code></pre>
<h3 data-id="heading-4">查找containerd的源码对应的操作</h3>
<ol>
<li>查找containerd对应的源码的部分</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// DiskUsage counts the number of inodes and disk usage for the resources under</span>
<span class="hljs-comment">// path.</span>
<span class="hljs-comment">//看代码的意思是获取磁盘的使用量</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DiskUsage</span><span class="hljs-params">(ctx context.Context, roots ...<span class="hljs-type">string</span>)</span></span> (Usage, <span class="hljs-type">error</span>) {
	<span class="hljs-keyword">return</span> diskUsage(ctx, roots...)
}
</code></pre>
<ol start="2">
<li>持续追踪系统的调用代码</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">diskUsage</span><span class="hljs-params">(ctx context.Context, roots ...<span class="hljs-type">string</span>)</span></span> (Usage, <span class="hljs-type">error</span>) {
	...省略
	<span class="hljs-keyword">for</span> _, root := <span class="hljs-keyword">range</span> roots {
        <span class="hljs-comment">//重点是下面这块:filepath.Walk这个方法的调用</span>
		<span class="hljs-keyword">if</span> err := filepath.Walk(root, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(path <span class="hljs-type">string</span>, fi os.FileInfo, err <span class="hljs-type">error</span>)</span></span> <span class="hljs-type">error</span> {
			...省略
		}); 
	}

	...省略
}

<span class="hljs-comment">//继续展开代码</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Walk</span><span class="hljs-params">(root <span class="hljs-type">string</span>, fn WalkFunc)</span></span> <span class="hljs-type">error</span> {
	...省略
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		...省略
	} <span class="hljs-keyword">else</span> {
		err = walk(root, info, fn)
	}
    ...省略
}


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">walk</span><span class="hljs-params">(path <span class="hljs-type">string</span>, info fs.FileInfo, walkFn WalkFunc)</span></span> <span class="hljs-type">error</span> {
	...省略
	<span class="hljs-keyword">for</span> _, name := <span class="hljs-keyword">range</span> names {
		...省略:下面这个
		fileInfo, err := lstat(filename)
		...省略
	}
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Lstat</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> (FileInfo, <span class="hljs-type">error</span>) {
	testlog.Stat(name)
	<span class="hljs-keyword">return</span> lstatNolog(name)
}

...省略中间多个追踪，最终结果是:

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fstatat</span><span class="hljs-params">(fd <span class="hljs-type">int</span>, path <span class="hljs-type">string</span>, stat *Stat_t, flags <span class="hljs-type">int</span>)</span></span> (err <span class="hljs-type">error</span>) {
	<span class="hljs-keyword">var</span> _p0 *<span class="hljs-type">byte</span>
	_p0, err = BytePtrFromString(path)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span>
	}
	_, _, e1 := Syscall6(SYS_NEWFSTATAT, <span class="hljs-type">uintptr</span>(fd), <span class="hljs-type">uintptr</span>(unsafe.Pointer(_p0)), <span class="hljs-type">uintptr</span>(unsafe.Pointer(stat)), <span class="hljs-type">uintptr</span>(flags), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
	<span class="hljs-keyword">if</span> e1 != <span class="hljs-number">0</span> {
		err = errnoErr(e1)
	}
	<span class="hljs-keyword">return</span>
}

#可以看到系统调用的方法是:sys_newfstatat这个
</code></pre>
<h3 data-id="heading-5">使用bpftrace抓取调用细节</h3>
<ol>
<li>安装bpftrace(自行安装)</li>
<li>提供bpftrace的脚本</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#1179是node的containerd的进程的id</span>
tracepoint:syscalls:sys_enter_newfstatat {
    <span class="hljs-keyword">if</span> (pid == 1179) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"1179 filename: %s, flag: %d\n"</span>, str(args-&gt;filename,100), args-&gt;flag);
    }
}

<span class="hljs-comment">#上面文件保存为:trace_lstat.bt</span>
</code></pre>
<ol start="3">
<li>提供bash脚本</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-built_in">export</span> BPFTRACE_MAX_STRLEN=200
bpftrace trace_lstat.bt

<span class="hljs-comment">#原因是，需要引入一个BPFTRACE_MAX_STRLEN的环境变量，因为bpftrace的str方法默认只会打印100的长度好像，但是需要通过这个来设置才行</span>
</code></pre>
<ol start="4">
<li>看下输出的数据信息</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">...省略
1179 filename: /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/43491/fs/home/cpaas/xxl-job/202, flag: 256
1179 filename: /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/43491/fs/home/cpaas/xxl-job/202, flag: 256
1179 filename: /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/43491/fs/home/cpaas/xxl-job/202, flag: 256
1179 filename: /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/43491/fs/home/cpaas/xxl-job/202, flag: 256
1179 filename: /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/43491/fs/home/cpaas/xxl-job/202, flag: 256
1179 filename: /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/43491/fs/home/cpaas/xxl-job/202, flag: 256
1179 filename: /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapsho
...省略

分析下就是如下的结果:
1. 这个文件总共380562行
linux &gt; <span class="hljs-comment"># find /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs -type f|wc -l</span>

<span class="hljs-comment">#输出的文件个数</span>
1104159


那么基本能够确定问题出在这个地方了
</code></pre>
<ol start="5">
<li>进入目录查找对应的文件个数</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#使用AI提供的如下的bash脚本进行统计文件个数</span>

<span class="hljs-comment">#!/bin/bash</span>

<span class="hljs-comment"># 指定根目录</span>
root_dir=<span class="hljs-string">"/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots"</span>

<span class="hljs-comment"># 遍历根目录下的所有子文件夹</span>
<span class="hljs-keyword">for</span> <span class="hljs-built_in">dir</span> <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">$root_dir</span>"</span>/*/; <span class="hljs-keyword">do</span>
    <span class="hljs-comment"># 去除路径末尾的斜杠</span>
    <span class="hljs-built_in">dir</span>=<span class="hljs-variable">${dir%/}</span>
    <span class="hljs-comment"># 提取子文件夹名称</span>
    folder_name=$(<span class="hljs-built_in">basename</span> <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span>)
    <span class="hljs-comment"># 使用 find 命令统计文件夹中的文件数量</span>
    file_count=$(find <span class="hljs-string">"<span class="hljs-variable">$dir</span>"</span> -<span class="hljs-built_in">type</span> f | <span class="hljs-built_in">wc</span> -l)
    <span class="hljs-comment"># 检查文件数量是否大于 10000</span>
    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$file_count</span> -gt 10000 ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$folder_name</span>: <span class="hljs-variable">$file_count</span> 个文件"</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>


<span class="hljs-comment">#1.输出结果如下:统计文件个数 &gt; 10000的(1w)</span>
83674: 21389 个文件
85266: 16118 个文件
85333: 22828 个文件
85932: 11998 个文件
86634: 430300 个文件
86635: 430193 个文件

</code></pre>
<ol start="6">
<li>找到如下的文件夹的个数很多</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">linux &gt; find /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/86634/fs/home/export-import-server/xxl-job -<span class="hljs-built_in">type</span> f|<span class="hljs-built_in">wc</span> -l
430842

</code></pre>
<ol start="7">
<li>分析下这个下面的文件个数统计</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#还是上面 6 步骤的bash统计脚本，只是换下root_url即可，得到的结果为</span>
2025-03-22: 55409 个文件
2025-03-23: 103679 个文件
2025-03-24: 103680 个文件
2025-03-25: 103330 个文件
2025-03-26: 64412 个文件
</code></pre>
<ol start="8">
<li>随便进入一个文件夹查看下,看到都是xxl-job的日志。因为xxl-job每次执行都会产生一个很小的日志文件，如果任务多，并且任务频繁(例如5个任务，然后每个任务5s执行一次，那么每天就是:86400).看上面竟然10w多的日志文件个数，估计任务更多更频繁.</li>
<li>手动执行下清理前面几天的日志即可，不过应用程序也要作出改动，显示日志产生的个数以及保留的时间</li>
<li>清理xxl-job的过期无用的日志文件之后，查看containerd进程消耗的CPU</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">[root@h-172-16-15-144-DEV-k8s-node fs]<span class="hljs-comment"># pidstat -p 1163 1</span>
Linux 5.14.0-479.el9.x86_64 (h-172-16-15-144-DEV-k8s-node) 	2025年03月26日 	_x86_64_	(16 CPU)

13分21秒   UID       PID    %usr %system  %guest   %<span class="hljs-built_in">wait</span>    %CPU   CPU  Command
13分22秒     0      1163    9.00    1.00    0.00    0.00   10.00     2  containerd
13分23秒     0      1163    0.00    1.00    0.00    0.00    1.00     2  containerd
13分24秒     0      1163    8.00    9.00    0.00    0.00   17.00     2  containerd
13分25秒     0      1163    3.00    1.00    0.00    0.00    4.00     2  containerd
13分26秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
13分27秒     0      1163    2.00    1.00    0.00    0.00    3.00     2  containerd
13分28秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
13分29秒     0      1163    1.00    0.00    0.00    0.00    1.00     2  containerd
13分30秒     0      1163    0.00    1.00    0.00    0.00    1.00     2  containerd
13分31秒     0      1163   10.00    0.00    0.00    0.00   10.00     2  containerd
13分32秒     0      1163    2.00    1.00    0.00    0.00    3.00     2  containerd
13分33秒     0      1163    0.00    0.00    0.00    0.00    0.00     2  containerd
13分34秒     0      1163    9.00    9.00    0.00    0.00   18.00     2  containerd
13分35秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
13分36秒     0      1163    0.00    0.00    0.00    0.00    0.00     2  containerd
13分37秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
13分38秒     0      1163    1.00    0.00    0.00    0.00    1.00     2  containerd
13分39秒     0      1163    3.00    1.00    0.00    0.00    4.00     2  containerd
13分40秒     0      1163    0.00    1.00    0.00    0.00    1.00     2  containerd
13分41秒     0      1163   11.00    1.00    0.00    0.00   12.00     2  containerd
13分42秒     0      1163    1.00    0.00    0.00    0.00    1.00     2  containerd
13分43秒     0      1163    0.00    0.00    0.00    0.00    0.00     2  containerd
13分44秒     0      1163    8.00   10.00    0.00    0.00   18.00     2  containerd
13分45秒     0      1163    0.00    0.00    0.00    0.00    0.00     2  containerd
13分46秒     0      1163    1.00    0.00    0.00    0.00    1.00     2  containerd
13分47秒     0      1163   11.00    2.00    0.00    0.00   13.00     2  containerd
13分48秒     0      1163    0.00    0.00    0.00    0.00    0.00     2  containerd
13分49秒     0      1163    3.00    2.00    0.00    0.00    5.00     2  containerd
13分50秒     0      1163    1.00    0.00    0.00    0.00    1.00     2  containerd
13分51秒     0      1163    1.00    0.00    0.00    0.00    1.00     2  containerd
13分52秒     0      1163    2.00    1.00    0.00    0.00    3.00     2  containerd
13分53秒     0      1163    0.00    1.00    0.00    0.00    1.00     2  containerd
13分54秒     0      1163   18.00    9.00    0.00    0.00   27.00     2  containerd
13分55秒     0      1163    2.00    1.00    0.00    0.00    3.00     2  containerd
13分56秒     0      1163    2.00    2.00    0.00    0.00    4.00     2  containerd
13分57秒     0      1163    1.00    1.00    0.00    0.00    2.00     2  containerd
13分58秒     0      1163    0.00    0.00    0.00    0.00    0.00     2  containerd
13分59秒     0      1163    2.00    1.00    0.00    0.00    3.00     2  containerd
14分00秒     0      1163    1.00    0.00    0.00    0.00    1.00     2  containerd

<span class="hljs-comment">#可以看到CPU降下来了，最高才27%</span>
</code></pre>
<h3 data-id="heading-6">原因分析</h3>
<ol>
<li>由于containerd开启了一个定时任务去获取自己管辖的磁盘的使用大小:就是DiskUsage方法</li>
<li>然后需要调用系统调用的newfstatat进行统计</li>
<li>然后由于文件个数太多了，导致非常耗费CPU</li>
<li>这个文件很多的snapshots下面有很多pod的container写的日志，xxl-job的日志，产生了几百万个，文件很小，但是文件个数很多，没有及时的清理，导致containerd每次扫描都非常耗费CPU</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>