<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[ollmam+langchain.js实现本地大模型简单记忆对话-PostgreSQL版]]></title>    <link>https://juejin.cn/post/7586597780641415178</link>    <guid>https://juejin.cn/post/7586597780641415178</guid>    <pubDate>2025-12-23T06:24:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586597780641415178" data-draft-id="7586657335880957979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ollmam+langchain.js实现本地大模型简单记忆对话-PostgreSQL版"/> <meta itemprop="keywords" content="前端,AIGC,LangChain"/> <meta itemprop="datePublished" content="2025-12-23T06:24:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="樊小肆"/> <meta itemprop="url" content="https://juejin.cn/user/1257497033719320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ollmam+langchain.js实现本地大模型简单记忆对话-PostgreSQL版
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497033719320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    樊小肆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:24:22.000Z" title="Tue Dec 23 2025 06:24:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文基于之前的本地大模型对话Demo进行优化，重点介绍如何将内存存储升级为PostgreSQL持久化存储，并增强对话安全性与检索准确性。仍需在Node.js 18+环境下运行，核心依赖工具（Ollama、PostgreSQL）的安装请参考官方文档。</p>
<h3 data-id="heading-1">为何升级为PostgreSQL存储？</h3>
<p>内存存储虽适合快速原型验证，但存在重启后数据丢失的问题，无法满足实际应用场景。PostgreSQL作为成熟的关系型数据库，不仅能持久化存储对话记录，配合pgvector插件还能高效管理向量数据，为生产环境提供可靠支撑。</p>
<h2 data-id="heading-2">代码实现：从内存存储到PostgreSQL持久化</h2>
<h3 data-id="heading-3">1. 数据库配置与实例初始化</h3>
<p>修改内容：新增PostgreSQL配置，替代原内存存储的sessionStores设计</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 替代原内存存储的全局配置</span>
<span class="hljs-type">const</span> pgConfig = {
    host: <span class="hljs-string">"127.0.0.1"</span>,
    port: <span class="hljs-number">5432</span>,
    user: <span class="hljs-string">"fanxiaosi"</span>,
    password: <span class="hljs-string">"f15130026310."</span>,
    database: <span class="hljs-string">"One-AI-DB"</span>,
};
</code></pre>
<p>修改原因：内存存储无法持久化数据，服务重启后对话历史会丢失。</p>
<p>改进好处：使用PostgreSQL实现对话记录的永久存储，支持多实例共享数据，为分布式部署奠定基础。</p>
<h3 data-id="heading-4">2. 语言模型配置优化</h3>
<p>修改内容：在原有基础上增加防复读配置</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ChatOllama</span>({
    model: <span class="hljs-string">'deepseek-r1:1.5b'</span>,
    baseUrl: <span class="hljs-string">"http://127.0.0.1:11434"</span>,
    topP: <span class="hljs-number">0.9</span>,  <span class="hljs-comment">// 从1.0调整为0.9</span>
    topK: <span class="hljs-number">40</span>,   <span class="hljs-comment">// 从20调整为40</span>
    streaming: <span class="hljs-literal">true</span>,
    temperature: <span class="hljs-number">0</span>,  <span class="hljs-comment">// 新增：固定输出温度，保证结果稳定性</span>
    repeatPenalty: <span class="hljs-number">1.2</span>,  <span class="hljs-comment">// 新增：防止多轮对话后复读系统指令</span>
})
</code></pre>
<p>修改原因：原配置可能导致输出多样性不足或出现重复内容。</p>
<p>改进好处：通过repeatPenalty减少复读现象，调整topP/topK平衡输出多样性与相关性，固定temperature确保回复稳定性。</p>
<h3 data-id="heading-5">3. 提示词模板增强</h3>
<p>修改内容：优化提示词模板结构，增加背景信息注入点</p>
<pre><code class="hljs language-css" lang="css">const textPrompt = ChatPromptTemplate<span class="hljs-selector-class">.fromMessages</span>(<span class="hljs-selector-attr">[    [<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个专业的知识助手。只需回答用户问题，不要重复系统指令。如果无法从背景信息中找到答案，请基于已知对话回复。"</span>]</span>,
    <span class="hljs-selector-attr">[<span class="hljs-string">"placeholder"</span>, <span class="hljs-string">"{chat_history}"</span>]</span>,
    <span class="hljs-selector-attr">[<span class="hljs-string">"human"</span>, <span class="hljs-string">"背景信息：{relevant_history}\n\n当前问题：{user_input}"</span>]</span>  // 新增背景信息字段
]);
</code></pre>
<p>修改原因：原模板仅依赖完整历史对话，长对话场景下可能超出模型上下文窗口。</p>
<p>改进好处：通过{relevant_history}注入检索到的相关片段，既保证上下文相关性，又避免全量历史导致的窗口溢出问题。</p>
<h3 data-id="heading-6">4. 敏感词检查机制强化</h3>
<p>修改内容：完善敏感词检查的错误处理流程</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">profanityChecker</span> = (input: { user_input: string }) =&gt; {
    const <span class="hljs-attr">sensitiveWords</span> = [<span class="hljs-string">"傻瓜"</span>, <span class="hljs-string">"白痴"</span>, <span class="hljs-string">"不良内容"</span>]<span class="hljs-comment">;</span>
    const <span class="hljs-attr">userInput</span> = input.user_input<span class="hljs-comment">;</span>

    if (sensitiveWords.some(<span class="hljs-attr">word</span> =&gt; userInput.includes(word))) {
        throw new Error("检测到敏感内容。请使用文明用语。")<span class="hljs-comment">;  // 明确的错误提示</span>
    }

    return input<span class="hljs-comment">;  // 检查通过则透传输入</span>
}<span class="hljs-comment">;</span>
const <span class="hljs-attr">customCheckStep</span> = RunnableLambda.from(profanityChecker)<span class="hljs-comment">;</span>
</code></pre>
<p>修改原因：原实现未明确错误处理机制，可能导致异常传播不规范。</p>
<p>改进好处：通过抛出结构化错误，使前端能清晰捕获敏感词提示，同时中断后续处理流程，提升系统安全性。</p>
<h3 data-id="heading-7">5. 向量存储重构：单例模式+PGVector</h3>
<p>修改内容：用单例模式管理PGVectorStore，替代原内存向量库</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 替代原MemoryVectorStore的实现</span>
let globalVectorStore: PGVectorStore | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

export <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">getVectorStore</span> = <span class="hljs-title function_ invoke__">async</span> (): Promise&lt;PGVectorStore&gt; =&gt; {
    <span class="hljs-keyword">if</span> (!globalVectorStore) {
        globalVectorStore = await PGVectorStore.<span class="hljs-title function_ invoke__">initialize</span>(embeddingModel, {
            <span class="hljs-attr">postgresConnectionOptions</span>: pgConfig,
            <span class="hljs-attr">tableName</span>: <span class="hljs-string">"test_langchain_embeddings"</span>,
            <span class="hljs-attr">columns</span>: {
                <span class="hljs-attr">idColumnName</span>: <span class="hljs-string">"id"</span>,
                <span class="hljs-attr">vectorColumnName</span>: <span class="hljs-string">"embedding"</span>,
                <span class="hljs-attr">contentColumnName</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-attr">metadataColumnName</span>: <span class="hljs-string">"metadata"</span>,
            },
        });
    }
    <span class="hljs-keyword">return</span> globalVectorStore;
};
</code></pre>
<p>修改原因：原内存向量库存在数据易失性和多实例同步问题。</p>
<p>改进好处：</p>
<ol>
<li>单例模式避免重复创建数据库连接池，减少资源消耗</li>
<li>PGVectorStore支持向量数据的持久化存储和高效检索</li>
<li>结构化的表设计便于后期数据维护和分析</li>
</ol>
<h3 data-id="heading-8">6. 对话历史存储优化</h3>
<p>修改内容：新增对话内容清洗逻辑，增强检索准确性</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">addMessageToVectorStore</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
    sessionId: <span class="hljs-built_in">string</span>,
    humanInput: <span class="hljs-built_in">string</span>,
    aiResponse?: <span class="hljs-built_in">string</span>
</span>) =&gt; {
    <span class="hljs-comment">// 新增：清洗AI回复中的特殊标签</span>
    <span class="hljs-keyword">const</span> cleanAIResponse = aiResponse?.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[\s\S]*?&lt;/</span>think&gt;/g, <span class="hljs-string">""</span>).<span class="hljs-title function_">trim</span>();

    <span class="hljs-keyword">const</span> vectorStore = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getVectorStore</span>();

    <span class="hljs-keyword">const</span> messageText = cleanAIResponse
        ? <span class="hljs-string">`用户：<span class="hljs-subst">${humanInput}</span>\n助手：<span class="hljs-subst">${cleanAIResponse}</span>`</span>
        : <span class="hljs-string">`用户：<span class="hljs-subst">${humanInput}</span>`</span>;

    <span class="hljs-keyword">await</span> vectorStore.<span class="hljs-title function_">addDocuments</span>([{
        <span class="hljs-attr">pageContent</span>: messageText,
        <span class="hljs-attr">metadata</span>: {
            sessionId,
            <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
            <span class="hljs-attr">type</span>: aiResponse ? <span class="hljs-string">"qa_pair"</span> : <span class="hljs-string">"user_query"</span>  <span class="hljs-comment">// 新增类型标识</span>
        }
    }]);
};
</code></pre>
<p>修改原因：原实现可能存储未经处理的模型输出（含思考过程标签），影响检索精度。</p>
<p>改进好处：</p>
<ol>
<li>移除特殊标签确保存储内容纯净度</li>
<li>增加type字段区分消息类型，便于后续检索过滤</li>
<li>标准化存储格式提升语义匹配准确性</li>
</ol>
<h3 data-id="heading-9">7. 检索逻辑优化</h3>
<p>修改内容：增强检索器的会话隔离和结果去重能力</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">retrieveRelevantHistory</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
    userInput: <span class="hljs-built_in">string</span>,
    sessionId: <span class="hljs-built_in">string</span>
</span>) =&gt; {
    <span class="hljs-keyword">const</span> vectorStore = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getVectorStore</span>();

    <span class="hljs-keyword">const</span> retriever = vectorStore.<span class="hljs-title function_">asRetriever</span>({
        <span class="hljs-attr">searchType</span>: <span class="hljs-string">"mmr"</span>,
        <span class="hljs-attr">searchKwargs</span>: {
            <span class="hljs-attr">fetchK</span>: <span class="hljs-number">20</span>,  <span class="hljs-comment">// 扩大候选集</span>
            <span class="hljs-attr">lambda</span>: <span class="hljs-number">0.7</span>,  <span class="hljs-comment">// 平衡相关性和多样性</span>
        },
        <span class="hljs-attr">k</span>: <span class="hljs-number">3</span>,  <span class="hljs-comment">// 小模型适配的最优返回数量</span>
        <span class="hljs-attr">filter</span>: { sessionId },  <span class="hljs-comment">// 严格的会话隔离</span>
    });

    <span class="hljs-keyword">const</span> relevantDocs = <span class="hljs-keyword">await</span> retriever.<span class="hljs-title function_">invoke</span>(userInput);
    <span class="hljs-keyword">return</span> relevantDocs.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>
        ? relevantDocs.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">doc</span> =&gt;</span> doc.<span class="hljs-property">pageContent</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n\n"</span>)
        : <span class="hljs-string">""</span>;  <span class="hljs-comment">// 空字符串替代原"无相关背景知识"</span>
};
</code></pre>
<p>修改原因：原检索逻辑未严格隔离会话，且返回无关提示可能干扰模型。</p>
<p>改进好处：</p>
<ol>
<li>通过filter确保只检索当前会话历史，避免跨会话信息泄露</li>
<li>调整k值适配1.5B小模型的上下文处理能力</li>
<li>返回空字符串替代提示文本，防止干扰模型判断</li>
</ol>
<h3 data-id="heading-10">8. 链式调用流程重构</h3>
<p>修改内容：优化调用链的参数传递逻辑</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> ragChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
    customCheckStep,  <span class="hljs-comment">// 优先执行敏感词检查</span>
    {
        <span class="hljs-attr">user_input</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> input.<span class="hljs-property">user_input</span>,
        <span class="hljs-attr">sessionId</span>: <span class="hljs-function">(<span class="hljs-params">_input, config</span>) =&gt;</span> config.<span class="hljs-property">configurable</span>?.<span class="hljs-property">sessionId</span>,
        <span class="hljs-attr">chat_history</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> input.<span class="hljs-property">chat_history</span>,
    },
    <span class="hljs-title class_">RunnablePassthrough</span>.<span class="hljs-title function_">assign</span>({
        <span class="hljs-attr">relevant_history</span>: retrieveStep,  <span class="hljs-comment">// 注入检索结果</span>
    }),
    textPrompt,
    llm,
]);
</code></pre>
<p>修改原因：原链式调用参数传递不够清晰，可能导致上下文丢失。</p>
<p>改进好处：</p>
<ol>
<li>明确参数映射关系，提升代码可读性</li>
<li>将敏感词检查置于流程最前端，提前拦截不良内容</li>
<li>分离参数提取与检索逻辑，便于单独调试</li>
</ol>
<h3 data-id="heading-11">9. 会话历史管理升级</h3>
<p>修改内容：使用PostgresChatMessageHistory替代内存存储</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> textChainWithHistory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnableWithMessageHistory</span>&lt;<span class="hljs-built_in">any</span>, <span class="hljs-built_in">any</span>&gt;({
    <span class="hljs-attr">runnable</span>: ragChain,
    <span class="hljs-attr">getMessageHistory</span>: <span class="hljs-function">(<span class="hljs-params">sessionId: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PostgresChatMessageHistory</span>({
            <span class="hljs-attr">tableName</span>: <span class="hljs-string">"chat_messages"</span>,
            sessionId,
            <span class="hljs-attr">poolConfig</span>: pgConfig,
        });
    },
    <span class="hljs-attr">inputMessagesKey</span>: <span class="hljs-string">"user_input"</span>,
    <span class="hljs-attr">historyMessagesKey</span>: <span class="hljs-string">"chat_history"</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>);
</code></pre>
<p>修改原因：原InMemoryChatMessageHistory无法持久化存储对话记录。</p>
<p>改进好处：</p>
<ol>
<li>实现对话历史的持久化存储，服务重启后不丢失</li>
<li>与PostgreSQL向量库形成数据联动，便于数据备份与迁移</li>
<li>支持跨进程共享会话历史，为集群部署提供可能</li>
</ol>
<h3 data-id="heading-12">10. 服务器与请求处理增强</h3>
<p>修改内容：完善HTTP服务器的错误处理和跨域支持</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> app = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-comment">// 新增：过滤浏览器图标请求</span>
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span> === <span class="hljs-string">"/favicon.ico"</span>) {
        res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">404</span>);
        res.<span class="hljs-title function_">end</span>();
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 增强跨域处理</span>
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">"OPTIONS"</span>) {
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>);
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Access-Control-Allow-Methods"</span>, <span class="hljs-string">"GET, POST, OPTIONS"</span>);
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Access-Control-Allow-Headers"</span>, <span class="hljs-string">"Content-Type"</span>);
        res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">204</span>);
        res.<span class="hljs-title function_">end</span>();
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 统一参数解析逻辑</span>
        <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">await</span> <span class="hljs-title function_">parseRequestParams</span>(req);
        <span class="hljs-keyword">const</span> sessionId = params.<span class="hljs-property">sessionId</span> || <span class="hljs-string">"default-session-id"</span>;
        <span class="hljs-keyword">const</span> user_input = params.<span class="hljs-property">user_input</span>;
        
        <span class="hljs-comment">// 输入验证</span>
        <span class="hljs-keyword">if</span> (!user_input) {
            res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">end</span>(<span class="hljs-string">"Missing user_input"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 流式响应处理</span>
        res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, {
            <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/event-stream; charset=utf-8"</span>,
            <span class="hljs-string">"Cache-Control"</span>: <span class="hljs-string">"no-cache"</span>,
            <span class="hljs-string">"Connection"</span>: <span class="hljs-string">"keep-alive"</span>,
        });

        <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> textChainWithHistory.<span class="hljs-title function_">stream</span>(
            { user_input },
            { <span class="hljs-attr">configurable</span>: { sessionId } }
        );
        
        <span class="hljs-keyword">let</span> fullSummary = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
            <span class="hljs-keyword">const</span> content = chunk.<span class="hljs-property">content</span> || <span class="hljs-string">""</span>;
            fullSummary += content;
            res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ content })}</span>\n\n`</span>);
        }

        <span class="hljs-comment">// 新增：回复完成后存入向量库</span>
        <span class="hljs-keyword">if</span> (fullSummary) {
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">addMessageToVectorStore</span>(sessionId, user_input, fullSummary);
        }
        
        res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ done: <span class="hljs-literal">true</span> })}</span>\n\n`</span>);
        res.<span class="hljs-title function_">end</span>();
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
        <span class="hljs-comment">// 错误信息通过SSE传递</span>
        res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ error: error.message })}</span>\n\n`</span>);
    }
})
</code></pre>
<p>修改原因：原服务器实现缺乏完整的错误处理和请求过滤机制。</p>
<p>改进好处：</p>
<ol>
<li>增加图标请求过滤，减少无效处理</li>
<li>完善的错误捕获与前端通知机制</li>
<li>标准化SSE响应格式，便于前端处理</li>
<li>确保AI回复在生成完成后才存入向量库，避免部分内容存储</li>
</ol>
<h2 data-id="heading-13">结语</h2>
<p>本次优化通过PostgreSQL实现了对话数据的持久化存储，增强了系统的稳定性和安全性，同时优化了检索精度和模型输出质量。相比内存存储方案，新版Demo更接近生产环境需求，可作为企业级本地大模型应用的基础框架。建议结合实际业务场景进一步扩展用户认证、权限控制等功能。</p>
<h3 data-id="heading-14">总结</h3>
<ol>
<li>核心升级方向：内存存储→PostgreSQL持久化，解决数据易失问题，适配生产场景；</li>
<li>关键优化点：敏感词前置检查、检索会话隔离、模型防复读配置，提升安全性与回复质量；</li>
<li>体验增强：标准化SSE流式响应、完善的错误处理，降低前端对接成本。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI大模型爆火的SSE技术到底是什么？万字长文，一篇读懂SSE！]]></title>    <link>https://juejin.cn/post/7586587644824731682</link>    <guid>https://juejin.cn/post/7586587644824731682</guid>    <pubDate>2025-12-23T07:34:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586587644824731682" data-draft-id="7586587644823650338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI大模型爆火的SSE技术到底是什么？万字长文，一篇读懂SSE！"/> <meta itemprop="keywords" content="WebSocket,前端"/> <meta itemprop="datePublished" content="2025-12-23T07:34:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JackJiang"/> <meta itemprop="url" content="https://juejin.cn/user/3104676566799399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI大模型爆火的SSE技术到底是什么？万字长文，一篇读懂SSE！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3104676566799399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JackJiang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:34:36.000Z" title="Tue Dec 23 2025 07:34:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文由45岁老架构师尼恩分享，感谢作者，有修订和重新排版。</p>
<h2 data-id="heading-0">1、引言</h2>
<p>你有没有想过，为什么 ChatGPT 的回答能逐字逐句地“流”出来？这一切的背后，都离不开一项关键技术——SSE（Server-Sent Events）！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6602a3fb6337470aa07567207adea124~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=D4o5FoRb7feZp%2BVChjet5Y0yd8c%3D" alt="" loading="lazy"/></p>
<p><strong>本文从SSE（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource" ref="nofollow noopener noreferrer">Server-Sent Events</a>）技术的原理到示例代码，为你通俗易懂的讲解SSE技术的方方面面。</strong></p>
<h2 data-id="heading-1">2、AI大模型实时通信技术专题</h2>
<p>技术专题系列文章目录如下，本文是第 <strong><em>4</em></strong> 篇：</p>
<ol>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4797-1-1.html" target="_blank" title="http://www.52im.net/thread-4797-1-1.html" ref="nofollow noopener noreferrer">全民AI时代，大模型客户端和服务端的实时通信到底用什么协议？</a>》</li>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4831-1-1.html" target="_blank" title="http://www.52im.net/thread-4831-1-1.html" ref="nofollow noopener noreferrer">大模型时代多模型AI网关的架构设计与实现</a>》</li>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4856-1-1.html" target="_blank" title="http://www.52im.net/thread-4856-1-1.html" ref="nofollow noopener noreferrer">通俗易懂：AI大模型基于SSE的实时流式响应技术原理和实践示例</a>》</li>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4872-1-1.html" target="_blank" title="http://www.52im.net/thread-4872-1-1.html" ref="nofollow noopener noreferrer">ChatGPT如何实现聊天一样的实时交互？快速读懂SSE实时“推”技术</a> 》</li>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4885-1-1.html" target="_blank" title="http://www.52im.net/thread-4885-1-1.html" ref="nofollow noopener noreferrer">AI大模型爆火的SSE技术到底是什么？万字长文，一篇读懂SSE！</a> 》（☜ 本文）</li>
</ol>
<h2 data-id="heading-2">3、初识SSE</h2>
<p>SSE（Server-Sent Events）是一种基于 HTTP 协议的服务器推送技术，允许服务端主动向客户端发送数据流。</p>
<p>SSE 可以被理解为 HTTP 的一个扩展或一种特定用法。它不是一个全新的、独立的协议，而是构建在标准 HTTP/1.1 协议之上的技术。</p>
<p>SSE 就像是服务器打开了一个“单向数据管道”，服务器通过HTTP 扩展 可以持续不断地流向浏览器，无需客户端反复发起请求。其实很简单的： SSE = HTTP 扩展字段 + Keepalive 长连接。</p>
<p>SSE 提供了一种简单、可靠的方式来实现服务器向客户端的实时数据推送。它非常适合通知、实时数据更新、日志流和类似 ChatGPT 的逐字输出场景。如果你只需要单向通信，SSE 往往是比 WebSocket 更简单、更轻量的选择。</p>
<p>SSE 适用于服务器主动向客户端推送数据的场景，如实时通知、动态更新等。</p>
<p>所以，目前 几乎所有主流浏览器都原生支持SSE。</p>
<p><strong>PS：</strong> <strong>更详细的SSE技术资料，可以进一步阅读以下几篇：</strong></p>
<ol>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-336-1-1.html" target="_blank" title="http://www.52im.net/thread-336-1-1.html" ref="nofollow noopener noreferrer">Web端即时通讯技术盘点：短轮询、Comet、Websocket、SSE</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-335-1-1.html" target="_blank" title="http://www.52im.net/thread-335-1-1.html" ref="nofollow noopener noreferrer">SSE技术详解：一种全新的HTML5服务器推送事件技术</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-1038-1-1.html" target="_blank" title="http://www.52im.net/thread-1038-1-1.html" ref="nofollow noopener noreferrer">详解Web端通信方式的演进：从Ajax、JSONP 到 SSE、Websocket</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2719-1-1.html" target="_blank" title="http://www.52im.net/thread-2719-1-1.html" ref="nofollow noopener noreferrer">一文读懂前端技术演进：盘点Web前端20年的技术变迁史</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3555-1-1.html" target="_blank" title="http://www.52im.net/thread-3555-1-1.html" ref="nofollow noopener noreferrer">网页端IM通信技术快速入门：短轮询、长轮询、SSE、WebSocket</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3695-1-1.html" target="_blank" title="http://www.52im.net/thread-3695-1-1.html" ref="nofollow noopener noreferrer">搞懂现代Web端即时通讯技术一文就够：WebSocket、socket.io、SSE</a></li>
</ol>
<h2 data-id="heading-3">4、SSE的诞生背景</h2>
<h5 data-id="heading-4">4.1  短轮询、长轮询、Flash 、 WebSocket</h5>
<p>在 SSE 技术出现之前，Web 应用要实现服务器向客户端的实时数据推送，主要依赖以下几种技术，但它们都存在明显的缺陷。</p>
<p><strong>4.1.1） 短轮询 (Polling)：</strong></p>
<p><strong>原理：</strong> 用短连接请求数据。客户端以固定的时间间隔（例如每秒一次）频繁地向服务器发送请求，询问是否有新数据。</p>
<p><strong>缺点：</strong> 大量请求可能是无效的（无新数据），浪费服务器和带宽资源，实时性差。</p>
<p><strong>短轮询的技术流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/670174c6dd834ca6b6a129a9ccefd55a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=2Rd2zgu8rXItrJHcZRQ6Who0KYE%3D" alt="" loading="lazy"/></p>
<p>**</p>
<p>4.1.2）长轮询 (Long Polling)：</p>
<p>**</p>
<p>原理：使用长连接请求数据。 客户端发送一个请求，服务器会保持这个连接打开（长连接），直到有新数据可用或超时。一旦客户端收到响应，会立即发起下一个请求。</p>
<p>缺点：虽然减少了无效请求，但每个连接仍然需要客户端发起，服务器需要维护大量挂起的连接，实现复杂。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f50b7a9f1d54fd5b418542b385e53eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=xvgrnctIubinLBqL5RYJotnGe7Q%3D" alt="" loading="lazy"/></p>
<p>长轮询 (Long Polling) 的技术突破：减少无效请求，但服务器需维护挂起连接</p>
<p><strong>4.1.3）基于 Flash 的解决方案：</strong></p>
<p>原理：利用 Adobe Flash 插件提供的 Socket 功能实现全双工通信。</p>
<p>缺点：依赖浏览器插件，在移动端（如 iPhone）不受支持，且随着技术的发展（Flash 被淘汰）已走向消亡。基于 Flash 方法都非原生支持，效率低下或依赖外部插件。</p>
<p><strong>4.1.4）基于 WebSocket的解决方案：</strong></p>
<p>原理：在客户端与服务器之间建立一条全双工的 TCP 长连接，双方可随时互相推送数据。</p>
<p><strong>缺点：</strong></p>
<ul>
<li>
<p>1）需要一次额外的协议升级握手（Upgrade: websocket），对 CDN、防火墙、代理服务器的兼容性不如普通 HTTP；</p>
</li>
<li>
<p>2）双向通信能力在“服务器→客户端单向推送”场景下显得过度设计，增加心跳、重连、帧解析等复杂度；</p>
</li>
<li>
<p>3）早期浏览器支持不一（IE ≤ 9 无原生实现），需要 Polyfill 或 Flash 降级方案。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e6bdfb928c14ca1a3ac98f3e09b81d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=Wc83W4XnhtsQ1pZC5sEvbu9QdGU%3D" alt="" loading="lazy"/></p>
<p>WebSocket全双工通道的革命性：摆脱HTTP束缚，实现真正的实时交互（</p>
<p>PS:</p>
<p>WebSocket 并不仅是 Web 领域的通讯协议，它属于复杂度较高的二进制通讯协议）。</p>
<h5 data-id="heading-5">4.2 SSE 诞生的核心背景</h5>
<p>因此，Web 领域迫切需要一种标准化的、高效的、由浏览器原生支持的服务器到客户端的单向通信机制。这就是 SSE 诞生的核心背景。</p>
<p><strong>核心需求：</strong></p>
<ul>
<li>
<p>1）简单：易于服务器和客户端实现；</p>
</li>
<li>
<p>2）高效：基于 HTTP/HTTPS，避免不必要的请求开销；</p>
</li>
<li>
<p>3）标准：成为 W3C 标准，得到浏览器原生支持；</p>
</li>
<li>
<p>4）自动重连：内置连接失败后自动重试的机制。</p>
</li>
</ul>
<p><strong>SSE——真正的服务器推送：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da9a8683493645939461312a1829115b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=Qc0Y%2B9TifBuvTkuPvUnMQw5vLJg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">5、SSE的前世今生</h2>
<p>SSE 的发展是 Web 标准化进程和实时通信需求共同推动的结果。</p>
<p><strong>下图概述了其关键发展节点：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e09f28733fb480e9f316b9cb8b1e1d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=3wNcFZ4vMyKwc%2BCvGjxO1a44lqk%3D" alt="" loading="lazy"/></p>
<p>让我们对图中的关键阶段进行详细解读。</p>
<p><strong>1）诞生背景（2006 年以前）：</strong></p>
<p>Web 早期只有“请求-响应”范式，实时需求（股票、IM、行情）只能靠轮询或长轮询，延迟高、浪费资源。Comet（长连接 iframe、jsonp、xhr-streaming 等 Hack 方案）出现，但实现复杂、浏览器兼容性差、占用连接数高。</p>
<p>业界急需一种“浏览器原生、基于 HTTP、单向服务器推送”的轻量机制。</p>
<p><strong>2）概念提出与标准化 (约 2006-2009年)：</strong></p>
<p>SSE 的概念最初作为 HTML5 标准的一部分被提出，由 WHATWG (Web Hypertext Application Technology Working Group) 和 W3C (World Wide Web Consortium) 共同推动。</p>
<p>其设计思想是定义一个简单的、基于 HTTP 的协议，允许服务器通过一个长连接持续地向客户端发送文本流。</p>
<p>2006 年，Opera 9 在浏览器里率先实现名为 Server-Sent Events 的实验 API，用 DOM 事件把服务器推送的文本块喂给页面。</p>
<p>同期 WHATWG HTML5 草案开始收录相关章节，定义了 text/event-stream MIME 类型及“event: / data:”行协议。</p>
<p>后来，它从庞大的 HTML5 规范中分离出来，成为了一个独立的 W3C 标准文档。</p>
<p>2008 年，SSE 被正式写入 HTML5 草案，随后进入 W3C 标准流程。</p>
<p><strong>3）浏览器支持与推广 (约 2010-2015年)：</strong></p>
<p>2011年左右，主流浏览器（如 Firefox、Chrome、Safari、Opera）开始陆续支持 SSE API。 Firefox 6、Chrome 6、Safari 5、Opera 11.5 陆续完成原生实现；IE 系列缺席（直到 Edge 79 才补票）。</p>
<p>关键的障碍：Internet Explorer (包括 IE 11) 始终没有支持 SSE API。这在一定程度上限制了其早期的广泛应用，开发者通常需要为此准备降级方案（如回落到长轮询）。</p>
<p>随着 Chrome、Firefox 等现代浏览器的市场份额不断上升，以及移动端浏览器对 SSE 的良好支持，SSE 逐渐成为开发实时 Web 应用的可信选择。</p>
<p>2014 年 10 月：HTML5 成为 W3C Recommendation，SSE 作为官方子模块锁定最终语法，浏览器阵营格局定型。</p>
<p><strong>4）正式推荐与成熟 (2015年至2022 )：</strong></p>
<p>2015-2020 年，WebSocket 与 WebRTC 占据实时通信话题中心，SSE 主要在企业内部仪表盘、日志 tail 等低频场景默默使用。</p>
<p>SSE 由于有 “单向文本流 + 自动重连 + 轻量” 特性，所以没有被WebSocket 与 WebRTC 踩死， 使其在 IoT 设备、移动端 WebView 中仍保有一席之地。</p>
<p>2015年，W3C 发布了 Server-Sent Events 的正式推荐标准，标志着该技术的成熟和稳定。在此期间，前端生态框架（如 React、Vue.js）和后端语言（如 Node.js、Python、Java）都提供了对 SSE 的良好支持，出现了大量易用的库和示例。</p>
<p><strong>5） 大模型时代的爆发（2022 至今）：</strong></p>
<p>虽然 WebSocket 提供了全双工通信能力，但 SSE 因其简单的 API、基于 HTTP 带来的良好兼容性（如无需担心代理或防火墙问题）、以及自动重连等特性，在只需要服务器向客户端推送数据的场景中（如新闻推送、实时行情、状态更新、AI 处理进度流式输出等）成为了更简单、更合适的选择。</p>
<p><strong>ChatGPT、Claude 等生成式 AI 需要“打字机”式逐 token 输出，SSE 天然契合：</strong></p>
<ul>
<li>
<p>1）基于 HTTP/1.1 无需升级协议，CDN 缓存友好；</p>
</li>
<li>
<p>2）浏览器 EventSource API 一行代码即可接入；</p>
</li>
<li>
<p>3）文本流可直接承载 JSON Lines 或 markdown 片段。</p>
</li>
</ul>
<p>2022 年底起：OpenAI、Anthropic、Google Bard 均把 text/event-stream 作为官方流式回答协议，社区库（FastAPI SSE-Star、Spring WebFlux、Node sse.js、Go gin-sse）迎来二次繁荣。</p>
<h2 data-id="heading-7">6、SSE的技术特征</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08a184670c054aacb1e067dea5b0d309~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=P8Q7qlKyYsAdYWkdACiAiwrhRFY%3D" alt="" loading="lazy"/></p>
<p><strong>SSE和WebSocket 都能建立浏览器与服务器的长期通信，但区别很明显：</strong></p>
<ul>
<li>
<p>1）</p>
<p>SSE 是单向推送 不是双向推送， 而且是http协议的一个扩展协议， 使用简单、自动重连，适合文本类实时推送；</p>
</li>
<li>
<p>2）</p>
<p>WebSocket 是双向通信，不是 http协议的一个扩展协议，WebSocket 更灵活，但实现相对复杂。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/322662fc82644c5296c9cd8f43def280~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=%2FccAZKNAK%2BcpdgQfshOhf795bik%3D" alt="" loading="lazy"/></p>
<p><strong>流程解读：</strong></p>
<ul>
<li>
<p>1）连接初始化：客户端使用特定的 Content-Type: text/event-stream 向服务器发起一个普通的 HTTP GET 请求。服务器确认并保持连接开放。</p>
</li>
<li>
<p>2）数据推送：服务器通过保持打开的连接，以纯文本格式（遵循 data: ...、event: ... 等规范）持续发送数据块。每个消息以两个换行符 \n\n 结束。</p>
</li>
<li>
<p>3）连接容错：如果连接因网络问题中断，SSE 客户端内置的机制会自动尝试重新建立连接，极大地提高了应用的鲁棒性。</p>
</li>
<li>
<p>4）客户端处理：浏览器端的 EventSource API 会解析收到的数据流，触发相应的事件（如 onmessage 或自定义事件），让开发者能够处理推送来的数据。</p>
</li>
</ul>
<p>SSE 的诞生是 Web 开发对简单、高效、标准化的服务器推送技术需求的直接结果。它有效地替代了笨拙的轮询技术，在与 WebSocket 的竞争中，找到了自身在单向数据流场景下的独特定位。</p>
<p>其发展历程经历了从概念提出、浏览器支持到成为正式标准的完整路径。尽管曾受限于 IE，但在现代浏览器中已成为一项稳定、可靠且被广泛采用的技术。如今，在实时通知、金融仪表盘、实时日志跟踪和大型语言模型（LLM）的流式响应输出等场景中，SSE 都是首选的解决方案。</p>
<h2 data-id="heading-8">7、默默无闻的SSE为何在AI大模型时代一夜爆火？</h2>
<p>SSE 最近站到聚光灯下，几乎可以说最大的推手就是当前 AI 应用（尤其是 ChatGPT 等大型语言模型）的爆发式增长。SSE 之所以成为 AI 应用的“标配”，是因为 SSE 与 AI 所需的“打字机” 输出模式 是 天作之合。</p>
<h5 data-id="heading-9">7.1 什么是AI大模型“打字机” 式的逐token输出？</h5>
<p>“打字机”式 逐 token 输出是一种流式传输方式，它模拟了人类打字或思考的过程。</p>
<p>服务器不是等待 LLM 生成整个答案 后一次性发送给 用户，而是 流式输出， 每生成一个“词元”（token，可以粗略理解为一个词或一个字），就立刻发送这个“词元”。</p>
<p>下面举一个例子，对比 一下 传统方式（非流式）和 “打字机” （流式）式 的过程。</p>
<p><strong>传统方式（非流式）过程如下：</strong></p>
<ul>
<li>
<p>1）你提问：“请写一首关于春天的诗”。</p>
</li>
<li>
<p>2）服务器端的 AI 开始思考、生成，整个过程你需要等待（可能好几秒甚至更久）。</p>
</li>
<li>
<p>3）AI 生成完整的诗歌：“春风拂面绿意浓，百花争艳映晴空...”。</p>
</li>
<li>
<p>4）服务器将整首诗作为一个完整的 JSON 对象 { "content": "春风拂面绿意浓，百花争艳映晴空..." } 发送给客户端。</p>
</li>
<li>
<p>5）客户端一次性收到全部内容并渲染出来。</p>
</li>
</ul>
<p><strong>“打字机”（流式）过程如下：</strong></p>
<ul>
<li>
<p>1）你提问：“请写一首关于春天的诗”。</p>
</li>
<li>
<p>2）服务器端的 AI 生成第一个 token “春”，立刻通过 SSE 发送 data: “春”。</p>
</li>
<li>
<p>3）客户端收到“春”并显示出来。</p>
</li>
<li>
<p>4）AI 生成第二个 token “风”，立刻发送 data: “风”。</p>
</li>
<li>
<p>5）客户端在“春”后面追加“风”，形成“春风”。</p>
</li>
<li>
<p>6）后续 token “拂”、“面”、“绿”、“意”、“浓”... 依次迅速发送和追加。</p>
</li>
<li>
<p>7）你看到的效果就是文字一个接一个地“打”在屏幕上，就像有人在远端为你实时打字一样。</p>
</li>
</ul>
<p><strong>“打字机”（流式） 模式的巨大优势：</strong></p>
<ul>
<li>
<p>1）极低的感知延迟：用户几乎在提问后瞬间就能看到第一个字开始输出，无需经历漫长的等待白屏期，体验流畅自然。</p>
</li>
<li>
<p>2）提供了“正在进行”的反馈：看着文字逐个出现，给人一种模型正在为你“思考”和“创作”的生动感，而不是在“沉默中宕机”。</p>
</li>
<li>
<p>3）更高效地利用时间：用户可以在前半句还在输出时，就开始阅读和理解，节省了总体的认知时间。</p>
</li>
</ul>
<h5 data-id="heading-10">7.2 为什么SSE跟AI大模型是“天作之合”？</h5>
<p>这正是 SSE 的设计初衷和核心优势所在，它与 AI 流式输出的需求完美匹配。</p>
<p><strong>1）单向通信的完美匹配：</strong></p>
<p>AI 的文本生成过程本质上是服务器到客户端的单向数据推送。客户端只需要接收，不需要在生成过程中频繁地发送请求。SSE 的“服务器推送”模型正是为此而生，而 WebSocket 的双向能力在这里是多余的。</p>
<p><strong>2）基于 HTTP/HTTPS，简单且兼容：</strong></p>
<p>SSE 使用标准的 HTTP 协议，这意味着 SSE 易于实现和调试：任何后端框架和前端语言都能轻松处理。在浏览器中调试时，你可以在“网络”选项卡中直接看到以文本流形式传输的事件，非常直观。</p>
<p>SSE 使用标准的 HTTP 协议，这还意味着 容易绕过网络障碍：公司防火墙和代理通常对 HTTP/HTTPS 放行，而可能会阻拦陌生的 WebSocket 协议。这使得 SSE 的部署兼容性极好。</p>
<p><strong>3）内置的自动重连机制：</strong></p>
<p>网络连接并不完全可靠。如果用户在接收很长的回答时网络波动，连接中断，SSE 客户端会自动尝试重新连接。这对于长时间流的应用至关重要，提供了天然的鲁棒性。</p>
<p><strong>4）轻量级的文本协议：</strong></p>
<p>AI 流式输出传输的就是文本（UTF-8编码）。SSE 的协议 data: ...\n\n 就是为传输文本片段而设计的，极其高效和简单。WebSocket 虽然也能传文本，但其协议设计还考虑了二进制帧、掩码等更复杂的情况，对于纯文本流来说显得有些“重”。</p>
<p><strong>5）原生浏览器 API：</strong></p>
<p>现代浏览器都原生支持 EventSource API，开发者无需引入额外的第三方库，即可轻松实现接收流式数据，减少了依赖和打包体积。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9fb4c3478254ea2918a4a690e978521~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=gF4JHFrlJCQuzzQdmSUk6G0gq70%3D" alt="" loading="lazy"/></p>
<p><strong>所以，SSE 站到聚光灯下的原因正是：</strong></p>
<blockquote>
<p>AI 应用需要“打字机”式的逐 token 输出体验，而 SSE 作为一种基于 HTTP 的、简单的、单向的服务器推送技术，是实现这种体验最自然、最高效、最可靠的技术选择。</p>
</blockquote>
<p>它就像是为这个场景量身定做的工具，没有多余的功能，只有恰到好处的设计。因此，当 ChatGPT 等应用席卷全球时，其背后默默无闻的 SSE 技术也终于从幕后走到了台前，被广大开发者所重新认识和重视。</p>
<h2 data-id="heading-11">8、SSE的技术原理详解</h2>
<h5 data-id="heading-12">8.1 工作机制的流程图</h5>
<p>SSE 通过一个持久的 HTTP 连接实现服务器到客户端的单向数据流。</p>
<p><strong>以下是其工作机制的流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0633f5bf47f4d70b9abc82a91d177b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=S1k%2BMGRg2MmJpBSPfwDDrj%2BtMaQ%3D" alt="" loading="lazy"/></p>
<p>以下是关键步骤解析。</p>
<p>**1）**<strong>浏览器发起一个 HTTP 请求，Header 中包含：</strong></p>
<p>1Accept: text/event-stream</p>
<p>**2）**<strong>服务器响应类型必须为：</strong></p>
<blockquote>
<p>Content-Type: text/event-stream</p>
<p>Cache-Control: no-cache</p>
<p>Connection: keep-alive</p>
</blockquote>
<p>**3）**<strong>服务器发送事件格式（每个事件以两个换行符结束）：</strong></p>
<blockquote>
<p>event: message</p>
<p>data: {"time": "2023-10-05T12:00:00", "value": "New update!"}</p>
<p>id: 12345</p>
<p>retry: 5000</p>
<p>\n\n</p>
</blockquote>
<p><strong>4）</strong> 浏览器通过 EventSourceAPI 接收并处理事件。</p>
<p><strong>5）</strong> 服务器发送 一个特殊“结束”事件，可以结束传输。比如，服务器发送一个如 event: end 的消息，可以结束传输。客户端预先监听这个自定义的 end 事件，一旦收到，就知道传输结束，并可以选择主动关闭 EventSource 连接。</p>
<p><strong>6）</strong> 若连接中断，浏览器会根据 retry字段自动重连。如果没有收到 特殊“结束”事件， 浏览器 可以自动重连。</p>
<h5 data-id="heading-13">8.2 SSE与其他通信方式对比</h5>
<p><strong>不同通信技术各有适用场景，我们用表格清晰对比：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c4d51ceadd64d1f8cd4814b6cb1ad4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=QbjwNfoOX7zGjEpfYMELfIoRPgk%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-14">8.3 SSE的适用场景</h5>
<p><strong>1）</strong> <strong>ChatGPT 式逐字输出( “打字机” 式逐 词元 token输出)：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2e80541e715465cb9280c98fad41ab1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=y6Q7vikSKWsvBFkqleScGU0Y89Y%3D" alt="" loading="lazy"/></p>
<p><strong>2）</strong> <strong>实时通知系统：</strong></p>
<ul>
<li>a. 新订单提醒；</li>
<li>b. 用户消息推送；</li>
<li>c. 审核状态更新。</li>
</ul>
<p><strong>3）</strong> <strong>实时数据看板：</strong></p>
<ul>
<li>a. 股票行情；</li>
<li>b. 设备监控数据；</li>
<li>c. 实时日志流。</li>
</ul>
<h2 data-id="heading-15">9、SSE客户端API详解</h2>
<p>SSE的客户端实现非常简单，浏览器原生提供了<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource" ref="nofollow noopener noreferrer">EventSource</a>对象来处理与服务器的SSE连接。下面我们详细介绍它的使用方法和核心特性。</p>
<h5 data-id="heading-16">9.1 认识浏览器端EventSource对象</h5>
<p><strong>浏览器兼容性检测：</strong></p>
<p>在使用SSE前，首先需要确认当前浏览器是否支持EventSource（除IE/Edge外，几乎所有现代浏览器都支持）。</p>
<p><strong>检测方法如下：</strong></p>
<blockquote>
<p>// 检查浏览器是否支持SSE</p>
<p>if ('EventSource' in window) {</p>
<p>// 支持SSE，可正常使用</p>
<p>console.log('浏览器支持SSE');</p>
<p>} else {</p>
<p>// 不支持SSE，需降级处理</p>
<p>console.log('浏览器不支持SSE');</p>
<p>}</p>
</blockquote>
<p><strong>创建连接：</strong></p>
<p>使用EventSource创建与服务器的连接非常简单，只需传入服务器的SSE接口地址：</p>
<blockquote>
<p>// 建立与服务器的SSE连接</p>
<p>// url为服务器提供的SSE接口地址（可同域或跨域）</p>
<p>var source = new EventSource(url);</p>
</blockquote>
<p>如果需要跨域请求并携带Cookie，可通过第二个参数配置：</p>
<blockquote>
<p>// 跨域请求时，允许携带Cookie</p>
<p>var source = new EventSource(url, {</p>
<p>withCredentials: true // 默认为false，设为true表示跨域请求携带Cookie</p>
<p>});</p>
</blockquote>
<p><strong>连接状态（readyState）：</strong></p>
<p>EventSource实例的readyState属性用于表示当前连接状态，只读且有三个可能值：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0665e4e35db44802a6bdab42b88fdb92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=GGVUTCrxORXgwSn4HaiSLxX8KNo%3D" alt="" loading="lazy"/></p>
<p>可以通过该属性判断当前连接状态，例如：</p>
<blockquote>
<p>if (source.readyState === EventSource.OPEN) {</p>
<p>console.log('SSE连接已正常建立');</p>
<p>}</p>
</blockquote>
<h5 data-id="heading-17">9.2 基本使用方法</h5>
<p>EventSource通过事件机制处理连接过程中的各种状态和接收的数据，核心事件包括<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource%2Fopen_event" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource/open_event" ref="nofollow noopener noreferrer">open</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource%2Fmessage_event" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource/message_event" ref="nofollow noopener noreferrer">message</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource%2Ferror_event" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource/error_event" ref="nofollow noopener noreferrer">error</a>。</p>
<p><strong>下面用流程图展示SSE客户端的完整使用流程：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a8616ce2940454ba932eb546b438900~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=rGqyyt87%2FHisMPT2FfmadEt8zIs%3D" alt="" loading="lazy"/></p>
<p><strong>连接建立：open事件</strong></p>
<p>当客户端与服务器成功建立SSE连接时，会触发open事件：</p>
<blockquote>
<p>// 方式1：使用onopen属性</p>
<p>source.onopen = function (event) {</p>
<p>console.log('SSE连接已建立');</p>
<p>// 可在此处做连接成功后的初始化操作，如更新UI状态</p>
<p>};</p>
<p>// 方式2：使用addEventListener（推荐，可添加多个回调）</p>
<p>source.addEventListener('open', function (event) {</p>
<p>console.log('SSE连接已建立（监听方式）');</p>
<p>}, false);</p>
</blockquote>
<p><strong>接收数据：message事件</strong></p>
<p>当客户端收到服务器推送的数据时，会触发message事件（默认事件，处理未指定类型的消息）：</p>
<blockquote>
<p>// 方式1：使用onmessage属性</p>
<p>source.onmessage = function (event) {</p>
<p>// event.data为服务器推送的文本数据</p>
<p>var data = event.data;</p>
<p>console.log('收到数据：', data);</p>
<p>// 可在此处处理数据，如更新页面内容</p>
<p>};</p>
<p>// 方式2：使用addEventListener</p>
<p>source.addEventListener('message', function (event) {</p>
<p>var data = event.data;</p>
<p>console.log('收到数据（监听方式）：', data);</p>
<p>}, false);</p>
</blockquote>
<p>注意：event.data始终是字符串类型，如果服务器发送的是JSON数据，需要用JSON.parse(data)转换。</p>
<p><strong>连接错误：error事件</strong></p>
<p>当连接发生错误（如网络中断、服务器出错）时，会触发error事件：</p>
<blockquote>
<p>// 方式1：使用onerror属性</p>
<p>source.onerror = function (event) {</p>
<p>// 可根据readyState判断错误类型</p>
<p>if (source.readyState === EventSource.CONNECTING) {</p>
<p>console.log('连接出错，正在尝试重连...');</p>
<p>} else {</p>
<p>console.log('连接已关闭，无法重连');</p>
<p>}</p>
<p>};</p>
<p>// 方式2：使用addEventListener</p>
<p>source.addEventListener('error', function (event) {</p>
<p>// 错误处理逻辑</p>
<p>}, false);</p>
</blockquote>
<p><strong>关闭连接：close()方法</strong></p>
<p>如果需要主动关闭SSE连接（关闭后不会自动重连），可调用close()方法：</p>
<blockquote>
<p>// 主动关闭SSE连接</p>
<p>source.close();</p>
<p>console.log('SSE连接已手动关闭');</p>
</blockquote>
<h5 data-id="heading-18">9.3 自定义事件</h5>
<p>默认情况下，服务器推送的消息会触发message事件。但实际开发中，我们可能需要区分不同类型的消息（如"新订单通知"和"系统公告"），这时就可以使用自定义事件。</p>
<p>客户端通过addEventListener监听自定义事件名，例如监听order事件：</p>
<blockquote>
<p>// 监听名为"order"的自定义事件</p>
<p>source.addEventListener('order', function (event) {</p>
<p>var orderData = event.data;</p>
<p>console.log('收到新订单：', orderData);</p>
<p>// 处理订单相关逻辑</p>
<p>}, false);</p>
<p>// 再监听一个名为"notice"的自定义事件</p>
<p>source.addEventListener('notice', function (event) {</p>
<p>var noticeData = event.data;</p>
<p>console.log('收到系统公告：', noticeData);</p>
<p>// 处理公告相关逻辑</p>
<p>}, false);</p>
</blockquote>
<p>注意：自定义事件不会触发message事件，只会被对应的addEventListener捕获。</p>
<p>上面代码中，浏览器对 SSE 的foo``notice事件进行监听。如何实现服务器发送foo``notice事件，请看下文。</p>
<h2 data-id="heading-19">10、SSE服务器端技术详解</h2>
<p>服务器要实现SSE，核心是按照特定格式向客户端发送数据。下面详细介绍服务器端的实现规范。</p>
<h5 data-id="heading-20">10.1 HTTP 头信息要求</h5>
<p>服务器向客户端发送SSE数据时，必须设置以下HTTP响应头，否则客户端无法正确识别为事件流：</p>
<blockquote>
<p>Content-Type: text/event-stream // 必须，指定为事件流类型</p>
<p>Cache-Control: no-cache // 必须，禁止缓存，确保数据实时性</p>
<p>Connection: keep-alive // 必须，保持长连接</p>
</blockquote>
<p>这三个头信息是SSE的基础，缺少任何一个都可能导致连接失败或数据异常。</p>
<h5 data-id="heading-21">10.2 数据传输格式</h5>
<p>服务器发送的每条消息（message）由多行组成，每行格式为[字段]: 值\n（字段名后必须跟冒号和空格，结尾用换行符\n）。多条消息之间用\n\n（两个换行符）分隔。</p>
<p>此外，以 : 开头的行是注释（服务器可定期发送注释保持连接）。</p>
<p>基本格式示例：</p>
<blockquote>
<p>: 这是一条注释（客户端会忽略）\n</p>
<p>data: 这是第一条消息\n\n</p>
<p>data: 这是第二条消息的第一行\n</p>
<p>data: 这是第二条消息的第二行\n\n</p>
</blockquote>
<p>注意：换行符必须是\n（Unix格式），\r\n可能导致客户端解析错误。</p>
<h5 data-id="heading-22">10.3 核心字段说明</h5>
<p>SSE消息支持四个核心字段，分别用于不同场景。</p>
<p><strong>1）data字段：消息内容：</strong></p>
<p>data字段用于携带实际的消息内容，是最常用的字段。</p>
<p>单行数据：</p>
<blockquote>
<p>data: Hello, SSE!\n\n // 单行数据，以\n\n结束</p>
</blockquote>
<p><strong>多行数据（适合JSON等复杂结构）：</strong></p>
<blockquote>
<p>data: {\n // 第一行以\n结束</p>
<p>data: "name": "张三",\n // 第二行以\n结束</p>
<p>data: "age": 20\n // 第三行以\n结束</p>
<p>data: }\n\n // 最后一行以\n\n结束</p>
</blockquote>
<p>客户端接收后，event.data会自动拼接为完整字符串：{"name": "张三","age": 20}</p>
<p><strong>2）event字段：指定事件类型：</strong></p>
<p>event字段用于指定消息的事件类型，客户端可通过对应事件名监听（即<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4885-1-1.html%2319" target="_blank" title="http://www.52im.net/thread-4885-1-1.html#19" ref="nofollow noopener noreferrer">9.3节的自定义事件</a>）。</p>
<p>服务器发送：</p>
<blockquote>
<p>event: order\n // 指定事件类型为order</p>
<p>data: 新订单ID：12345\n // 消息内容</p>
<p>\n // 消息结束（\n\n简化为单独一行）</p>
</blockquote>
<p><strong>客户端监听：</strong></p>
<blockquote>
<p>source.addEventListener('order', function(event) {</p>
<p>console.log(event.data); // 输出：新订单ID：12345</p>
<p>});</p>
</blockquote>
<p><strong>3）id字段：消息标识：</strong></p>
<p>id字段用于给消息设置唯一标识，客户端会自动记录最后一条消息的id（存于source.lastEventId）。</p>
<p>核心作用：当连接断线重连时，客户端会在请求头中携带Last-Event-ID: [最后收到的id]，服务器可根据该ID恢复数据传输（避免重复或丢失）。</p>
<p>服务器发送：</p>
<blockquote>
<p>id: msg1001\n // 消息标识</p>
<p>data: 这是第1001条消息\n</p>
<p>\n</p>
</blockquote>
<p>客户端重连时的请求头：</p>
<blockquote>
<p>Last-Event-ID: msg1001 // 自动携带最后收到的id</p>
</blockquote>
<p><strong>4）retry字段：重连间隔：</strong></p>
<p>retry字段用于指定客户端断线后的重连间隔（单位：毫秒），默认重连间隔约为3秒。</p>
<p>服务器发送：</p>
<blockquote>
<p>retry: 5000\n // 告诉客户端，断线后5秒再重连</p>
<p>data: 重连间隔已设置为5秒\n</p>
<p>\n</p>
</blockquote>
<p><strong>5）服务器保持连接示例：</strong></p>
<p>服务器可以定期发送注释行，保持连接活跃：</p>
<blockquote>
<p>: 这是保持连接活动的注释行\n</p>
<p>: 服务器时间 2023-10-05T12:00:00\n</p>
</blockquote>
<h5 data-id="heading-23">10.4 服务器发送流程</h5>
<p><strong>服务器发送SSE数据的完整流程如下：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4e2666d0d2d4be39601aabcb3d769cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=s0CuuwUqRPeakIwtpoXHeGx83ak%3D" alt="" loading="lazy"/></p>
<p><strong>下面是一个包含多种字段的服务器发送示例，模拟一个实时通知系统：</strong></p>
<blockquote>
<p>: 服务器开始发送消息（注释）\n</p>
<p>id: 1001\n</p>
<p>event: notice\n</p>
<p>data: 系统将在10分钟后维护\n\n</p>
<p>id: 1002\n</p>
<p>event: order\n</p>
<p>data: {"orderId": "20230501", "status": "paid"}\n\n</p>
<p>retry: 10000\n</p>
<p>id: 1003\n</p>
<p>data: 重连间隔已调整为10秒\n\n</p>
<p>: 这是保持连接活动的注释行\n</p>
<p>: 服务器时间 2023-10-05T12:00:00\n</p>
</blockquote>
<p><strong>客户端接收后：</strong></p>
<ul>
<li>
<p>1）notice事件会捕获到"系统将在10分钟后维护"</p>
</li>
<li>
<p>2）order事件会捕获到订单JSON数据</p>
</li>
<li>
<p>3）重连间隔被设置为10秒</p>
</li>
<li>
<p>4）最后收到的消息ID是1003（断线重连时会携带）</p>
</li>
</ul>
<p>通过以上规范，服务器就能轻松实现SSE功能，向客户端实时推送数据。相比WebSocket，SSE的服务器实现更简单，无需处理复杂的协议握手，只需按格式发送文本数据即可。</p>
<h2 data-id="heading-24">11、SSE实战代码示例（基于Spring Boot的实时通信）</h2>
<p>接下来， 通过一个完整案例 手把手教你用Spring Boot实现SSE功能。这个案例包含服务端（后端）和客户端（前端）代码， 可以直接运行体验服务器主动推送数据的效果。</p>
<h5 data-id="heading-25">11.1 案例整体架构</h5>
<p><strong>我们要实现的系统包含三个核心部分：</strong></p>
<ul>
<li>
<p>1）后端服务：基于Spring Boot，提供SSE连接接口、消息广播接口和任务进度推送接口；</p>
</li>
<li>
<p>2）前端页面：一个简单的HTML页面，通过EventSource与后端建立SSE连接；</p>
</li>
<li>
<p>3）交互流程：客户端连接后，可接收服务器主动推送的连接状态、广播消息和任务进度。</p>
</li>
</ul>
<p><strong>整体架构流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15a1251ea50746e7b078d4efa0436ff8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=cQlKKS8y6JJ1CH5hd8wq1zvtSkA%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-26">11.2 服务端实现</h5>
<p><strong>11.2.1）准备依赖：</strong></p>
<p>首先创建Spring Boot项目，在pom.xml中添加以下依赖（用于web开发和页面渲染）：</p>
<blockquote>



<p>org.springframework.boot</p>
<p>spring-boot-starter-web</p>



<p>org.springframework.boot</p>
<p>spring-boot-starter-thymeleaf</p>


</blockquote>
<p>这些依赖是基础：spring-boot-starter-web提供了SSE核心类SseEmitter，spring-boot-starter-thymeleaf用于将HTML页面返回给浏览器。</p>
<p><strong>11.2.2）编写SSE核心控制器：</strong></p>
<p>创建SseController，这是服务端处理SSE连接和消息推送的核心类：</p>
<blockquote>
<p>package com.example.sse.controller;</p>
<p>import org.springframework.http.MediaType;</p>
<p>import org.springframework.web.bind.annotation.GetMapping;</p>
<p>import org.springframework.web.bind.annotation.RequestParam;</p>
<p>import org.springframework.web.bind.annotation.RestController;</p>
<p>import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</p>
<p>import java.io.IOException;</p>
<p>import java.util.concurrent.CopyOnWriteArrayList;</p>
<p>import java.util.concurrent.ExecutorService;</p>
<p>import java.util.concurrent.Executors;</p>
<p>@RestController</p>
<p>public class SseController {</p>
<p>// 存储所有活跃的SSE连接（线程安全的列表）</p>
<p>// CopyOnWriteArrayList适合读多写少场景，避免并发问题</p>
<p>private final CopyOnWriteArrayList emitters = new CopyOnWriteArrayList&lt;&gt;();</p>
<p>// 线程池：用于异步发送事件，避免阻塞主线程</p>
<p>private final ExecutorService executor = Executors.newCachedThreadPool();</p>
<p>/</p>
<p>* 客户端订阅SSE的接口</p>
<p>* 客户端通过访问该接口建立长连接，接收服务器推送的事件</p>
<p>*/</p>
<p>@GetMapping(value = "/sse/subscribe", produces = MediaType.TEXT_EVENT_STREAM_VALUE)</p>
<p>public SseEmitter subscribe() {</p>
<p>// 创建SseEmitter实例，设置超时时间为无限（默认30秒会超时，这里设为Long.MAX_VALUE避免自动断开）</p>
<p>SseEmitter emitter = new SseEmitter(Long.MAX_VALUE);</p>
<p>// 将新连接加入活跃列表（后续推送消息时会遍历这个列表）</p>
<p>emitters.add(emitter);</p>
<p>// 设置连接完成/超时的回调：从活跃列表中移除该连接，释放资源</p>
<p>emitter.onCompletion(() -&gt; emitters.remove(emitter)); // 连接正常关闭时</p>
<p>emitter.onTimeout(() -&gt; emitters.remove(emitter)); // 连接超时关闭时</p>
<p>// 发送初始连接成功消息（给客户端的"欢迎消息"）</p>
<p>try {</p>
<p>emitter.send(SseEmitter.event()</p>
<p>.name("CONNECTED") // 事件名称：客户端可通过"CONNECTED"事件监听</p>
<p>.data("You are successfully connected to SSE server!") // 消息内容</p>
<p>.reconnectTime(5000)); // 告诉客户端：如果断开连接，5秒后重连</p>
<p>} catch (IOException e) {</p>
<p>// 发送失败时，标记连接异常结束</p>
<p>emitter.completeWithError(e);</p>
<p>}</p>
<p>return emitter; // 将emitter返回给客户端，保持连接</p>
<p>}</p>
<p>/</p>
<p>* 广播消息接口：向所有已连接的客户端推送消息</p>
<p>* 可通过浏览器访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fsse%2Fbroadcast%3Fmessage%3Dxxx" target="_blank" title="http://localhost:8080/sse/broadcast?message=xxx" ref="nofollow noopener noreferrer">http://localhost:8080/sse/broadcast?message=xxx</a> 触发</p>
<p>/</p>
<p>@GetMapping("/sse/broadcast")</p>
<p>public String broadcastMessage(@RequestParam String message) {</p>
<p>// 用线程池异步执行广播，避免阻塞当前请求</p>
<p>executor.execute(() -&gt; {</p>
<p>// 遍历所有活跃连接，逐个发送消息</p>
<p>for (SseEmitter emitter : emitters) {</p>
<p>try {</p>
<p>emitter.send(SseEmitter.event()</p>
<p>.name("BROADCAST") // 事件名称：客户端监听"BROADCAST"事件</p>
<p>.data(message) // 广播的消息内容</p>
<p>.id(String.valueOf(System.currentTimeMillis()))); // 消息ID（用于重连时定位）</p>
<p>} catch (IOException e) {</p>
<p>// 发送失败（可能客户端已断开），从列表中移除并标记连接结束</p>
<p>emitters.remove(emitter);</p>
<p>emitter.completeWithError(e);</p>
<p>}</p>
<p>}</p>
<p>});</p>
<p>return "Broadcast message: " + message; // 给调用者的响应</p>
<p>}</p>
<p>/</p>
<p>* 模拟长时间任务：向客户端推送实时进度</p>
<p>* 适合文件上传、数据处理等需要实时反馈进度的场景</p>
<p>/</p>
<p>@GetMapping("/sse/start-task")</p>
<p>public String startTask() {</p>
<p>// 异步执行任务，避免阻塞当前请求</p>
<p>executor.execute(() -&gt; {</p>
<p>try {</p>
<p>// 模拟任务进度：从0%到100%，每次增加10%</p>
<p>for (int i = 0; i &lt;= 100; i += 10) {</p>
<p>Thread.sleep(1000); // 休眠1秒，模拟处理耗时</p>
<p>// 向所有客户端推送当前进度</p>
<p>for (SseEmitter emitter : emitters) {</p>
<p>try {</p>
<p>emitter.send(SseEmitter.event()</p>
<p>.name("PROGRESS") // 事件名称：客户端监听"PROGRESS"事件</p>
<p>.data(i + "% completed") // 进度数据</p>
<p>.id("task-progress")); // 固定ID，标识这是任务进度消息</p>
<p>} catch (IOException e) {</p>
<p>// 发送失败，移除连接</p>
<p>emitters.remove(emitter);</p>
<p>}</p>
<p>}</p>
<p>// 任务完成时，发送结束消息</p>
<p>if (i == 100) {</p>
<p>for (SseEmitter emitter : emitters) {</p>
<p>try {</p>
<p>emitter.send(SseEmitter.event()</p>
<p>.name("COMPLETE") // 事件名称：客户端监听"COMPLETE"事件</p>
<p>.data("Task completed successfully!"));</p>
<p>} catch (IOException e) {</p>
<p>emitters.remove(emitter);</p>
<p>}</p>
<p>}</p>
<p>}</p>
<p>}</p>
<p>} catch (InterruptedException e) {</p>
<p>// 任务被中断时，恢复线程中断状态并退出</p>
<p>Thread.currentThread().interrupt();</p>
<p>break;</p>
<p>}</p>
<p>});</p>
<p>return "Task started!"; // 告诉调用者任务已启动</p>
<p>}</p>
<p>}</p>
</blockquote>
<p>核心代码说明：</p>
<ul>
<li>
<p>1）SseEmitter：Spring提供的SSE核心类，每个实例对应一个客户端连接；</p>
</li>
<li>
<p>2）emitters列表：管理所有活跃连接，方便广播消息（类似"客户端注册表"）；</p>
</li>
<li>
<p>3）executor线程池：异步处理消息发送，避免阻塞主线程（如果同步发送，一个客户端卡住会影响所有用户）。</p>
</li>
</ul>
<p>事件发送：通过</p>
<p>emitter.send(SseEmitter.event())</p>
<p>构建消息，可指定事件名、数据、ID和重连时间。</p>
<p><strong>11.2.3）编写页面控制器：</strong></p>
<p>创建PageController，用于将前端页面返回给浏览器：</p>
<blockquote>
<p>package com.example.sse.controller;</p>
<p>import org.springframework.stereotype.Controller;</p>
<p>import org.springframework.web.bind.annotation.GetMapping;</p>
<p>@Controller // 注意这里用@Controller而非@RestController，用于返回页面</p>
<p>public class PageController {</p>
<p>/*</p>
<p>* 访问根路径时，返回SSE客户端页面</p>
<p>/</p>
<p>@GetMapping("/")</p>
<p>public String index() {</p>
<p>// 返回src/main/resources/templates目录下的sse-client.html</p>
<p>return "sse-client";</p>
<p>}</p>
<p>}</p>
</blockquote>
<h5 data-id="heading-27">11.3 客户端实现（HTML页面）</h5>
<p>在</p>
<p>src/main/resources/templates</p>
<p>目录下创建</p>
<p>sse-client.html</p>
<p>，这是用户交互的前端页面：</p>
<blockquote>
<p>Server-Sent Events (SSE) Client Connect to SSE Disconnect Send Broadcast Start Task Messages:</p>
</blockquote>
<p>客户端核心逻辑：</p>
<ul>
<li>
<p>1）eventSource：EventSource实例，是客户端与服务端SSE连接的"桥梁"；</p>
</li>
<li>
<p>2）事件监听：通过addEventListener监听服务端定义的事件（CONNECTED/BROADCAST等）；</p>
</li>
<li>
<p>3）自动重连：当连接断开时，EventSource会自动重试（无需手动写重连逻辑）；</p>
</li>
<li>
<p>4）交互函数：connectSSE/disconnectSSE等函数对应页面按钮，实现用户操作。</p>
</li>
</ul>
<h5 data-id="heading-28">11.4 运行与测试</h5>
<p>启动步骤：</p>
<ul>
<li>
<p>1）确保Spring Boot项目配置正确（默认端口8080，无需额外配置）；</p>
</li>
<li>
<p>2）启动Spring Boot应用（运行带有main方法的启动类）；</p>
</li>
<li>
<p>3）打开浏览器，访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2F%25EF%25BC%258C%25E7%259C%258B%25E5%2588%25B0%25E5%25AE%25A2%25E6%2588%25B7%25E7%25AB%25AF%25E9%25A1%25B5%25E9%259D%25A2%25E3%2580%2582" target="_blank" title="http://localhost:8080/%EF%BC%8C%E7%9C%8B%E5%88%B0%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%A1%B5%E9%9D%A2%E3%80%82" ref="nofollow noopener noreferrer">http://localhost:8080/，看到客户端页面。</a></p>
</li>
</ul>
<p>功能测试：</p>
<ul>
<li>
<p>1）建立连接：点击"Connect to SSE"按钮，页面会显示"连接成功"的消息（服务端通过CONNECTED事件推送）</p>
</li>
<li>
<p>2）发送广播：点击"Send Broadcast"按钮，输入任意消息（如"Hello SSE"），页面会显示广播消息（服务端向所有连接的客户端推送）</p>
</li>
<li>
<p>3）启动任务：点击"Start Task"按钮，页面会每秒收到一条进度消息（从0%到100%），最后显示"任务完成"</p>
</li>
<li>
<p>4）断开连接：点击"Disconnect"按钮，连接关闭，不再接收消息。</p>
</li>
</ul>
<p>测试流程图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb6bb445b3ea4f69b8b9f8fe29820d79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=ZoLX8oLsfdVda7NTuAMb3DGdzgY%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-29">11.5 服务端的关键技术点</h5>
<p>1）SseEmitter的作用：Spring封装的SSE工具类，简化了"保持连接+发送事件"的实现，无需手动处理HTTP流格式。</p>
<p>2）连接管理：用CopyOnWriteArrayList存储活跃连接，确保线程安全；通过onCompletion/onTimeout回调清理无效连接，避免内存泄漏。</p>
<p>3）异步处理：必须用线程池（ExecutorService）异步发送消息，否则会阻塞主线程，导致新请求无法处理。</p>
<p>4）事件设计：通过name区分不同类型的事件（如PROGRESS/BROADCAST），客户端按需监听，逻辑更清晰。</p>
<p>5）自动重连：SSE客户端（EventSource）内置重连机制，网络恢复后会自动重新连接，无需额外代码。</p>
<p>通过这个案例，你可以清晰看到SSE的优势：实现简单（几行代码就能建立实时连接）、无需额外协议（基于HTTP）、自带重连机制。如果你的场景只需要服务器单向推送数据（如实时通知、进度更新），SSE会是比WebSocket更轻量的选择。</p>
<h2 data-id="heading-30">12、选SSE还是选WebSocket？</h2>
<h5 data-id="heading-31">12.1 SSE与WebSocket全面对比</h5>
<p>来对 Server-Sent Events (SSE) 和 WebSocket 进行一场全面、深入的对比。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6aaebc4c98a043faa9175d85e4e5b65a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=DMePC%2BYwZs%2BruJ4QjQTwsX3O7a0%3D" alt="" loading="lazy"/></p>
<p>为了更直观地理解两者的工作模式差异，请看下面的序列图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/438907c5f6d244a0ab1a0aa47fa198a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=qHrXbnWmuFp7VgX4bdHMB89jwb0%3D" alt="" loading="lazy"/></p>
<p><strong>1）协议与连接建立：</strong></p>
<p>SSE 协议与连接建立：</p>
<ul>
<li>a. 基于纯粹的 HTTP。客户端发起一个普通的 HTTP GET 请求，并携带特殊的头 Accept: text/event-stream。</li>
<li>b. 服务器响应后，保持这个 TCP 连接打开，并开始发送数据流 ，直到遇到结束标记。</li>
<li>c. 这是一种长连接的 HTTP 用法。</li>
</ul>
<p>WebSocket 协议与连接建立：</p>
<ul>
<li>a. 基于独立的 WebSocket 协议。连接始于一个特殊的 HTTP 请求，即 “协议升级”请求（Connection: Upgrade, Upgrade: websocket）。</li>
<li>b. 服务器响应 HTTP 101 Switching Protocols 后，最初的 HTTP 连接被替换为 WebSocket 连接，此后通信不再遵循 HTTP 协议，而是在其之上建立一个全双工的通道。</li>
</ul>
<p><strong>2）数据流与通信模式：</strong></p>
<p>SSE：单向通信。设计初衷就是让服务器能够主动、高效地向客户端推送数据。•数据是文本流，格式简单且可读性强。每条消息可以附带一个事件类型（event:）和一个ID（id:）。•客户端使用 EventSource API 监听来自服务器的事件。</p>
<p>WebSocket：全双工通信。在连接建立后，客户端和服务器处于完全平等的地位，可以随时、任意地相互发送消息。 另外，WS协议 支持文本和二进制数据，灵活性极高，非常适合需要频繁双向交互的场景（如游戏、协作编辑）。</p>
<p><strong>3）能力与特性：</strong></p>
<p>SSE：内置自动重连机制。如果连接断开，EventSource 对象会自动尝试重新连接，并在重连后自动发送上一个收到的事件ID，服务器据此可判断错过了哪些消息，实现数据恢复。SSE有出色的浏览器支持。所有现代浏览器（Chrome, Firefox, Safari, Edge）都原生支持，Internet Explorer （古代浏览器）完全不支持（通常需要 polyfill 或降级方案）。</p>
<p>WebSocket：无自动重连。连接断开后，需要开发者手动编写重连逻辑和状态恢复逻辑。WS协议比SSE协议有更广泛的浏览器支持，包括 Internet Explorer 10+。</p>
<p><strong>4）开发与集成：</strong></p>
<p>SSE：开发与集成 非常简单。服务器端几乎不需要特殊的库，任何能输出 HTTP 流的后端语言都可以实现。客户端 API 也非常直观。与现有 HTTP 认证、CORS 机制完全兼容，处理方式与普通 HTTP 请求一致。</p>
<p>WebSocket：开发与集成 相对复杂。服务器端需要支持 WebSocket 协议的库（如 ws for Node.js, Socket.IO 等）。客户端需要处理连接状态、心跳包等。 虽然升级握手是 HTTP，但后续通信是独立协议，因此一些复杂的网络环境（如某些代理服务器）可能会带来问题。</p>
<h5 data-id="heading-32">12.2 SSE与WebSocket到底该如何选择？</h5>
<p>选择的关键在于应用场景和核心需求。</p>
<p><strong>* 选择 SSE 的场景：</strong></p>
<p>选择 SSE 的场景包括：</p>
<ul>
<li>
<p>1）服务器到客户端的单向数据流。</p>
</li>
<li>
<p>2）简单和快速实现是关键因素。</p>
</li>
<li>
<p>3）需要自动错误恢复（重连）。</p>
</li>
<li>
<p>4）数据传输格式是文本（如 JSON），且不需要二进制。</p>
</li>
</ul>
<p>SSE 典型的应用场景包括：</p>
<ul>
<li>
<p>1）实时新闻推送、体育比分更新。</p>
</li>
<li>
<p>2）金融报价行情（如股票价格变动）。</p>
</li>
<li>
<p>3）社交媒体动态更新（如 Twitter 时间线）。</p>
</li>
<li>
<p>4）服务器日志流监控。</p>
</li>
<li>
<p>5）AI 处理进度或结果的流式输出。</p>
</li>
</ul>
<p><strong>* 选择 WebSocket 场景：</strong></p>
<p>选择 WebSocket 的场景包括：</p>
<ul>
<li>
<p>1）真正的实时双向通信，客户端和服务器都需要频繁地发送消息。</p>
</li>
<li>
<p>2）需要传输二进制数据（如视频、音频、图像碎片）。</p>
</li>
<li>
<p>3）构建交互性极强的应用，其中低延迟至关重要。</p>
</li>
</ul>
<p>WebSocket 典型的应用场景包括：</p>
<ul>
<li>
<p>1）实时在线聊天应用（如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fslack.com%2F" target="_blank" title="https://slack.com/" ref="nofollow noopener noreferrer">Slack</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fmusclegrowth.net%2Fdiscord%2F" target="_blank" title="https://musclegrowth.net/discord/" ref="nofollow noopener noreferrer">Discord</a>、<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2470-1-1.html" target="_blank" title="http://www.52im.net/thread-2470-1-1.html" ref="nofollow noopener noreferrer">RainbowChat-Web</a>）。</p>
</li>
<li>
<p>2）多人在线游戏。</p>
</li>
<li>
<p>3）协同编辑工具（如 Google Docs）。</p>
</li>
<li>
<p>4）实时仪表盘和控制面板（需要双向控制）。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccbb02df35914642b1af8b1ae92e580f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=d33l0IdL4Gmaepr82YE11B4vdV0%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-33">12.3 WebSocket+SSE 混合架构</h5>
<p>一般来说大型应用场景，强网用 WebSocket、弱网适合使用SSE ，这就是WebSocket+SSE 混合架构。强网用 WebSocket、弱网自动降级到 SSE 的混合架构， 核心在于网络质量动态评估和双通道无缝切换。</p>
<p><strong>WebSocket+SSE 混合架构 具体实现方案如下：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c069ed9bfa5444b8bcb36247cb488dfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=Y3ueSABULQ%2FNO8kUKux683cJn4U%3D" alt="" loading="lazy"/></p>
<p>核心模块：网络质量探针（客户端） 实现</p>
<blockquote>
<p>class NetworkProbe {</p>
<p>// 关键指标</p>
<p>static RTT_THRESHOLD = 300 // RTT超过300ms视为弱网</p>
<p>static PACKET_LOSS_THRESHOLD = 0.2 // 丢包率&gt;20%触发降级</p>
<p>// 网络状态检测</p>
<p>async check() {</p>
<p>const { rtt, packetLoss } = await this._measure()</p>
<p>return {</p>
<p>isWeak: rtt &gt; NetworkProbe.RTT_THRESHOLD ||</p>
<p>packetLoss &gt; NetworkProbe.PACKET_LOSS_THRESHOLD</p>
<p>}</p>
<p>}</p>
<p>// 实际测量方法</p>
<p>_measure() {</p>
<p>return new Promise(resolve =&gt; {</p>
<p>const start = Date.now()</p>
<p>fetch('/ping', { cache: 'no-store' })</p>
<p>.then(() =&gt; {</p>
<p>const rtt = Date.now() - start</p>
<p>resolve({ rtt, packetLoss: 0 })</p>
<p>})</p>
<p>.catch(() =&gt; resolve({ rtt: Infinity, packetLoss: 1 }))</p>
<p>})</p>
<p>}</p>
<p>}</p>
</blockquote>
<p>核心模块：双协议连接管理器（客户端）</p>
<blockquote>
<p>class HybridConnection {</p>
<p>constructor() {</p>
<p>this.currentProtocol = null</p>
<p>this.ws = null</p>
<p>this.sse = null</p>
<p>this.messageQueue = [] // 消息缓冲队列</p>
<p>}</p>
<p>// 智能连接初始化</p>
<p>async connect() {</p>
<p>const { isWeak } = await new NetworkProbe().check()</p>
<p>this.currentProtocol = isWeak ? 'sse' : 'ws'</p>
<p>if (this.currentProtocol === 'ws') {</p>
<p>this._initWebSocket()</p>
<p>} else {</p>
<p>this._initSSE()</p>
<p>}</p>
<p>}</p>
<p>// WebSocket初始化</p>
<p>_initWebSocket() {</p>
<p>this.ws = new WebSocket('wss://api.example.com')</p>
<p>this.ws.onmessage = this._handleMessage</p>
<p>// 发送缓冲队列消息</p>
<p>this.messageQueue.forEach(msg =&gt; this.ws.send(msg))</p>
<p>this.messageQueue = []</p>
<p>}</p>
<p>// SSE初始化</p>
<p>_initSSE() {</p>
<p>this.sse = new EventSource('<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.example.com%2Fsse" target="_blank" title="https://api.example.com/sse" ref="nofollow noopener noreferrer">api.example.com/sse</a>')</p>
<p>this.sse.onmessage = this._handleMessage</p>
<p>}</p>
<p>// 统一消息处理</p>
<p>_handleMessage = (event) =&gt; {</p>
<p>const data = event.data || event</p>
<p>// 业务逻辑处理...</p>
<p>}</p>
<p>// 发送消息（自动选择协议）</p>
<p>send(data) {</p>
<p>if (this.currentProtocol === 'ws' &amp;&amp; this.ws?.readyState === 1) {</p>
<p>this.ws.send(JSON.stringify(data))</p>
<p>} else if (this.currentProtocol === 'sse') {</p>
<p>// SSE需通过独立HTTP请求发送</p>
<p>fetch('/send', { method: 'POST', body: JSON.stringify(data) })</p>
<p>} else {</p>
<p>// 协议切换中暂存消息</p>
<p>this.messageQueue.push(JSON.stringify(data))</p>
<p>}</p>
<p>}</p>
<p>// 协议切换（核心！）</p>
<p>async switchProtocol() {</p>
<p>const { isWeak } = await new NetworkProbe().check()</p>
<p>// 无需切换</p>
<p>if (isWeak &amp;&amp; this.currentProtocol === 'sse') return</p>
<p>if (!isWeak &amp;&amp; this.currentProtocol === 'ws') return</p>
<p>// 执行切换</p>
<p>if (isWeak) {</p>
<p>this.ws?.close()</p>
<p>this._initSSE()</p>
<p>this.currentProtocol = 'sse'</p>
<p>} else {</p>
<p>this.sse?.close()</p>
<p>this._initWebSocket()</p>
<p>this.currentProtocol = 'ws'</p>
<p>}</p>
<p>}</p>
<p>}</p>
</blockquote>
<h5 data-id="heading-34">12.4 AI大模型中该选择SSE协议还是WebSocket？</h5>
<p>直接答案：对于绝大多数 chat2ai 应用 优先选择 SSE (Server-Sent Events)。复杂的 chat2ai 应用 优先选择WebSocket。</p>
<p>但这并非绝对，我们需要根据具体的功能需求来决定。下面我将为你进行详细的分析和推理。</p>
<p><strong>12.4.1）核心决策分析：</strong></p>
<p>AI聊天应用的核心交互是：</p>
<ul>
<li>
<p>1）</p>
<p>客户端发送一条消息（一个问题）。</p>
</li>
<li>
<p>2）</p>
<p>服务器接收后，调用大语言模型（LLM）API。</p>
</li>
<li>
<p>3）</p>
<p>服务器将模型流式返回的答案（逐词或逐句）实时推送给客户端。</p>
</li>
<li>
<p>4）</p>
<p>客户端实时渲染这个流式的答案，营造出“打字机”效果。</p>
</li>
</ul>
<p>这个过程的关键在于第3步，即服务器向客户端的单向数据推送。这正是 SSE 的绝对主场。</p>
<p><strong>12.4.2）为什么 SSE 是更优的选择？</strong></p>
<p>以下流程图清晰地展示了基于不同技术方案的聊天交互过程，其中突出了SSE方案的巨大优势：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf8e057bbe924ce19a235f05af351f54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=KPobLykKPNjUCWRdG0lcrdAsONY%3D" alt="" loading="lazy"/></p>
<p>正如上图所示：SSE 方案在实现上更加直接和高效，因为它基于 HTTP，并且专门为服务器到客户端的单向数据流设计。</p>
<p>此外，SSE 还带来了以下巨大优势：</p>
<p><strong>1）</strong> <strong>开发复杂度极低：</strong></p>
<ul>
<li>a. 后端：你不需要引入任何复杂的 WebSocket 库（如 ws, Socket.IO）。你只需要建立一个普通的 HTTP 路由（如 POST /chat 用于发送消息，GET /chat/stream 用于接收流），并在控制器中输出 text/event-stream 格式的响应流。</li>
<li>b. 前端：使用浏览器原生的 EventSource API 即可轻松监听数据流，几行代码就能实现。无需实例化和管理 WebSocket 连接对象。</li>
</ul>
<p><strong>2）</strong> <strong>出色的兼容性与可维护性：</strong></p>
<ul>
<li>a. SSE 基于 HTTP，这意味着它更容易通过公司防火墙、代理，与现有的认证系统（如 Cookie、JWT）、CORS 策略协同工作，几乎不会遇到奇怪的网络问题。</li>
<li>b. 在浏览器“网络”选项卡中，SSE 的流清晰可见，易于调试。每个消息都是可读的文本，调试体验非常好。</li>
</ul>
<p><strong>3）</strong> <strong>内置的自动重连与断点续传机制：</strong></p>
<ul>
<li>a. 这是 SSE 的“杀手级特性”。网络连接不稳定是移动端的常见问题。如果用户在接收一个很长答案的过程中网络中断，SSE 会在网络恢复后自动重新连接。</li>
<li>b. 更强大的是，SSE 协议支持发送最后一个消息的 ID。服务器可以识别出这个 ID，并判断客户端错过了哪些数据，从而从断点处继续发送，而不是重新开始生成整个回答。这既节省了昂贵的 API 调用费用，也提升了用户体验。这在 WebSocket 中需要手动实现所有逻辑，非常复杂。</li>
</ul>
<p><strong>12.4.3）WebSocket 的适用场景：</strong></p>
<p>虽然 SSE 是主流选择，但在 chat2ai 应用变得非常复杂时，WebSocket 可能会成为更好的选择。</p>
<p>在以下情况下， 应该考虑使用 WebSocket：</p>
<p><strong>1）</strong> 需要极高频的双向通信：不仅仅是用户提问-&gt;AI回答。例如：</p>
<ul>
<li>a. 实时协作编辑：多个用户同时编辑一份由 AI 生成的文档，每个人的输入都需要实时同步给其他所有人。</li>
<li>b. AI多人游戏：基于 AI 生成剧情和环境的实时互动游戏，玩家的每一个动作都需要实时影响虚拟世界。</li>
</ul>
<p><strong>2）</strong> 当需要传输二进制数据的时候：有的聊天应用不仅支持文本，还支持实时语音对话（客户端录音发送二进制音频流，服务器返回 AI 语音二进制流）。WebSocket 对二进制数据的支持是天生的。</p>
<p><strong>3）</strong> 你需要非常精确的控制心跳和连接状态： - WebSocket 允许 手动发送 Ping/Pong 帧来检测连接活性，虽然复杂，但给了开发人员最大的控制权。</p>
<h5 data-id="heading-35">12.4.4）传输协议选型 结论与建议：</h5>
<p>1）起步和绝大多数情况：从 SSE 开始。这是最直接、最高效、最能给你带来稳定体验的选择。使用sse 遇到的技术挑战会更少，开发速度更快。ChatGPT、Claude 等绝大多数顶级应用都使用 SSE 不是没有道理的。</p>
<p>2）未来如果需要扩展：采用混合架构。如果应用未来需要加入上述 WebSocket 的适用功能（如实时语音），完全可以同时使用两种协议：使用 SSE 专门处理 AI 文本答案的流式推送。使用 WebSocket 专门处理 实时语音、实时协作等真正的双向通信功能。或者 强弱结合，自动切换。</p>
<p>因此，对于 chat2ai 的传输协议选型答案是：优先选择 SSE。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/484ea894f46647a2a980d06fe567a49d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=kFA89ymF3MXJCMN9K%2FR9e6%2FjFvY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-36">13、参考资料</h2>
<p>[0] <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource" ref="nofollow noopener noreferrer">EventSource API Docs</a></p>
<p>[1] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-336-1-1.html" target="_blank" title="http://www.52im.net/thread-336-1-1.html" ref="nofollow noopener noreferrer">Web端即时通讯技术盘点：短轮询、Comet、Websocket、SSE</a></p>
<p>[2] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-335-1-1.html" target="_blank" title="http://www.52im.net/thread-335-1-1.html" ref="nofollow noopener noreferrer">SSE技术详解：一种全新的HTML5服务器推送事件技术</a></p>
<p>[3] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-907-1-1.html" target="_blank" title="http://www.52im.net/thread-907-1-1.html" ref="nofollow noopener noreferrer">使用WebSocket和SSE技术实现Web端消息推送</a></p>
<p>[4] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-1038-1-1.html" target="_blank" title="http://www.52im.net/thread-1038-1-1.html" ref="nofollow noopener noreferrer">详解Web端通信方式的演进：从Ajax、JSONP 到 SSE、Websocket</a></p>
<p>[5] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-907-1-1.html" target="_blank" title="http://www.52im.net/thread-907-1-1.html" ref="nofollow noopener noreferrer">使用WebSocket和SSE技术实现Web端消息推送</a></p>
<p>[6] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2719-1-1.html" target="_blank" title="http://www.52im.net/thread-2719-1-1.html" ref="nofollow noopener noreferrer">一文读懂前端技术演进：盘点Web前端20年的技术变迁史</a></p>
<p>[7] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3134-1-1.html" target="_blank" title="http://www.52im.net/thread-3134-1-1.html" ref="nofollow noopener noreferrer">WebSocket从入门到精通，半小时就够！</a></p>
<p>[8] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3555-1-1.html" target="_blank" title="http://www.52im.net/thread-3555-1-1.html" ref="nofollow noopener noreferrer">网页端IM通信技术快速入门：短轮询、长轮询、SSE、WebSocket</a></p>
<p>[9] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3695-1-1.html" target="_blank" title="http://www.52im.net/thread-3695-1-1.html" ref="nofollow noopener noreferrer">搞懂现代Web端即时通讯技术一文就够：WebSocket、socket.io、SSE</a></p>
<p>[10] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4831-1-1.html" target="_blank" title="http://www.52im.net/thread-4831-1-1.html" ref="nofollow noopener noreferrer">大模型时代多模型AI网关的架构设计与实现</a></p>
<p>[11] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4797-1-1.html" target="_blank" title="http://www.52im.net/thread-4797-1-1.html" ref="nofollow noopener noreferrer">全民AI时代，大模型客户端和服务端的实时通信到底用什么协议？</a></p>
<p>[12] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4856-1-1.html" target="_blank" title="http://www.52im.net/thread-4856-1-1.html" ref="nofollow noopener noreferrer">通俗易懂：AI大模型基于SSE的实时流式响应技术原理和实践示例</a></p>
<p>[13] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4832-1-1.html" target="_blank" title="http://www.52im.net/thread-4832-1-1.html" ref="nofollow noopener noreferrer">Web端实时通信技术SSE在携程机票业务中的实践应用</a></p>
<p>[14] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4872-1-1.html" target="_blank" title="http://www.52im.net/thread-4872-1-1.html" ref="nofollow noopener noreferrer">ChatGPT如何实现聊天一样的实时交互？快速读懂SSE实时“推”技术</a></p>
<p>（本文已同步发布于：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4885-1-1.html" target="_blank" title="http://www.52im.net/thread-4885-1-1.html" ref="nofollow noopener noreferrer">www.52im.net/thread-4885…</a>）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java线程协作工具：CountDownLatch 、CyclicBarrier、Phaser、Semaphore 、Exchanger]]></title>    <link>https://juejin.cn/post/7586687526866714639</link>    <guid>https://juejin.cn/post/7586687526866714639</guid>    <pubDate>2025-12-23T07:48:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586687526866714639" data-draft-id="7586687526866698255" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java线程协作工具：CountDownLatch 、CyclicBarrier、Phaser、Semaphore 、Exchanger"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T07:48:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="马卡巴卡"/> <meta itemprop="url" content="https://juejin.cn/user/1892677617451163"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java线程协作工具：CountDownLatch 、CyclicBarrier、Phaser、Semaphore 、Exchanger
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1892677617451163/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    马卡巴卡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:48:27.000Z" title="Tue Dec 23 2025 07:48:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在高并发系统中，多个线程之间的协作是不可避免的。Java 从 JDK 1.5 开始引入了 <code>java.util.concurrent</code>（JUC）包，其中包含了一系列强大的线程协作工具类，极大简化了并发编程的复杂性。</p>
<h2 data-id="heading-0">CountDownLatch（JDK 5+）：倒计时门闩</h2>
<h3 data-id="heading-1">使用场景</h3>
<p><code>CountDownLatch</code> 常用于“一个或多个线程等待其他线程完成任务后再继续执行”的场景，例如：</p>
<ul>
<li>主线程等待所有子线程初始化完毕再启动服务。</li>
<li>并发测试中模拟 N 个请求同时发出后统计总耗时。</li>
<li>资源加载完成后统一触发后续逻辑。</li>
</ul>
<h3 data-id="heading-2">核心 API</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CountDownLatch</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> count</span>)</span>;        <span class="hljs-comment">// 初始化计数器</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">await</span>() throws InterruptedException</span>;          <span class="hljs-comment">// 阻塞等待计数归零</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> boolean <span class="hljs-title">await</span>(<span class="hljs-params"><span class="hljs-built_in">long</span> timeout, TimeUnit unit</span>)</span>;       <span class="hljs-comment">// 带超时的等待</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">countDown</span>()</span>;                                 <span class="hljs-comment">// 计数减一</span>
</code></pre>
<h3 data-id="heading-3">使用示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CountDownLatchExample</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>) throws InterruptedException</span> {
        <span class="hljs-built_in">int</span> threadCount = <span class="hljs-number">5</span>;
        CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(threadCount);

        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; threadCount; i++) {
            <span class="hljs-keyword">new</span> Thread(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    System.<span class="hljs-keyword">out</span>.println(Thread.currentThread().getName() + <span class="hljs-string">" 正在执行任务..."</span>);
                    Thread.sleep(<span class="hljs-number">1000</span>);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                } <span class="hljs-keyword">finally</span> {
                    latch.countDown(); <span class="hljs-comment">// 任务完成，计数减一</span>
                }
            }).start();
        }

        latch.<span class="hljs-keyword">await</span>(); <span class="hljs-comment">// 主线程等待所有任务完成</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"所有任务已完成，主线程继续执行！"</span>);
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-erlang" lang="erlang">Thread-<span class="hljs-number">0</span> 正在执行任务...
Thread-<span class="hljs-number">1</span> 正在执行任务...
Thread-<span class="hljs-number">3</span> 正在执行任务...
Thread-<span class="hljs-number">2</span> 正在执行任务...
Thread-<span class="hljs-number">4</span> 正在执行任务...
所有任务已完成，主线程继续执行！
</code></pre>
<h3 data-id="heading-4">应用场景示例</h3>
<p><strong>服务启动检查：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 等待数据库、缓存、消息队列初始化完成</span>
CountDownLatch startupLatch = new <span class="hljs-built_in">CountDownLatch</span>(<span class="hljs-number">3</span>);
<span class="hljs-built_in">initDB</span>(startupLatch);
<span class="hljs-built_in">initCache</span>(startupLatch);
<span class="hljs-built_in">initMQ</span>(startupLatch);
startupLatch<span class="hljs-selector-class">.await</span>();
<span class="hljs-built_in">startHttpServer</span>();
</code></pre>
<h3 data-id="heading-5">使用注意点</h3>
<ul>
<li><strong>不可重用</strong>：一旦计数归零，无法再次使用（除非新建实例）。需要重复使用的场景应考虑 <code>CyclicBarrier</code>，</li>
<li>若某个线程未调用 <code>countDown()</code>，会导致主线程永久阻塞， 导致死锁，所以务必在 finally 块中调用。</li>
<li><code>await()</code> 可被中断，需处理 <code>InterruptedException</code>。</li>
</ul>
<h3 data-id="heading-6">底层原理</h3>
<p><code>CountDownLatch</code> 基于 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D267767541%26content_type%3DArticle%26match_order%3D1%26q%3DAQS%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=267767541&amp;content_type=Article&amp;match_order=1&amp;q=AQS&amp;zhida_source=entity" ref="nofollow noopener noreferrer">AQS</a>（AbstractQueuedSynchronizer）</strong>  实现：（AQS 原理详见<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fmp.weixin.qq.com%2Fs%2FYl1jxnE562TuUqq48rag4g" target="_blank" title="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/Yl1jxnE562TuUqq48rag4g" ref="nofollow noopener noreferrer">Java并发编程：Lock原理详解</a>）</p>
<ul>
<li>内部状态 <code>state</code> 表示剩余计数值。</li>
<li><code>await()</code> 对应 AQS 的 <code>acquireSharedInterruptibly(1)</code>，尝试获取共享锁，若 <code>state != 0</code> 则入队阻塞。</li>
<li><code>countDown()</code> 调用 <code>releaseShared(1)</code>，将 <code>state</code> 减 1，当 <code>state == 0</code> 时唤醒所有等待线程。</li>
</ul>
<h2 data-id="heading-7">CyclicBarrier（JDK 5+）：循环屏障</h2>
<h3 data-id="heading-8">使用场景</h3>
<p><code>CyclicBarrier</code> 适用于“多个线程互相等待，全部到达某一点后才能继续”的场景，例如：</p>
<ul>
<li>多线程分阶段计算（每阶段结束后汇总结果）。</li>
<li>游戏开发中等待所有玩家准备就绪。</li>
<li>并行算法中的同步点。</li>
</ul>
<h3 data-id="heading-9">核心 API</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CyclicBarrier</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> parties</span>)</span>; 
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CyclicBarrier</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> parties, Runnable barrierAction</span>)</span>; <span class="hljs-comment">// 所有线程到达后执行的动作</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">await</span>() throws InterruptedException, BrokenBarrierException</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">await</span>(<span class="hljs-params"><span class="hljs-built_in">long</span> timeout, TimeUnit unit</span>) throws ...</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reset</span>()</span>; <span class="hljs-comment">// 重置屏障（可能中断当前等待）</span>
</code></pre>
<h3 data-id="heading-10">使用示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CyclicBarrierExample</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        CyclicBarrier barrier = <span class="hljs-keyword">new</span> CyclicBarrier(<span class="hljs-number">3</span>, () -&gt; {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"所有线程已到达屏障，执行汇总操作！"</span>);
        });

        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
            <span class="hljs-keyword">new</span> Thread(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    System.<span class="hljs-keyword">out</span>.println(Thread.currentThread().getName() + <span class="hljs-string">" 第一阶段完成"</span>);
                    barrier.<span class="hljs-keyword">await</span>(); <span class="hljs-comment">// 等待其他线程</span>

                    System.<span class="hljs-keyword">out</span>.println(Thread.currentThread().getName() + <span class="hljs-string">" 第二阶段开始"</span>);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    e.printStackTrace();
                }
            }).start();
        }
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs">Thread-1 第一阶段完成
Thread-2 第一阶段完成
Thread-0 第一阶段完成
所有线程已到达屏障，执行汇总操作！
Thread-0 第二阶段开始
Thread-1 第二阶段开始
Thread-2 第二阶段开始
</code></pre>
<h3 data-id="heading-11">应用场景示例</h3>
<p><strong>多轮并行计算：</strong></p>
<pre><code class="hljs language-ini" lang="ini">CyclicBarrier <span class="hljs-attr">barrier</span> = new CyclicBarrier(<span class="hljs-number">4</span>, this::aggregateResults)<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 4; i++) {</span>
    executor.submit(() -&gt; {
        while (round &lt; MAX_ROUNDS) {
            computePartialResult()<span class="hljs-comment">;</span>
            barrier.await()<span class="hljs-comment">; // 同步进入下一轮</span>
            round++<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-12">底层原理</h3>
<p><code>CyclicBarrier</code> 不基于 AQS，而是使用 <code>ReentrantLock</code> + <code>Condition</code> 实现：（Condition 原理详见<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fmp.weixin.qq.com%2Fs%2FYl1jxnE562TuUqq48rag4g" target="_blank" title="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/Yl1jxnE562TuUqq48rag4g" ref="nofollow noopener noreferrer">Java并发编程：Lock原理详解</a>）</p>
<ul>
<li>每次调用 <code>await()</code>，线程进入条件队列等待。</li>
<li>当最后一个线程到达时，唤醒所有等待线程，并执行 <code>barrierAction</code>（如有）。</li>
<li>完成后自动重置计数器，<strong>支持重复使用</strong>。</li>
</ul>
<p>若某个线程在等待期间被中断或超时，屏障将进入“损坏”（broken）状态，后续调用会抛出 <code>BrokenBarrierException</code>。</p>
<h3 data-id="heading-13">CyclicBarrier 与 CountDownLatch 的区别</h3>






























<table><thead><tr><th>特性</th><th>CountDownLatch</th><th>CyclicBarrier</th></tr></thead><tbody><tr><td>控制方向</td><td>一方等待多方</td><td>所有线程互相等待</td></tr><tr><td>是否可重用</td><td>❌</td><td>✅</td></tr><tr><td>是否支持回调</td><td>❌</td><td>✅（barrierAction）</td></tr><tr><td>底层实现</td><td>AQS</td><td>ReentrantLock + Condition</td></tr></tbody></table>
<h2 data-id="heading-14">Phaser（JDK 7+）：灵活的阶段同步器</h2>
<p><code>Phaser</code> 新增于 JDK 7，是对 <code>CyclicBarrier</code> 和 <code>CountDownLatch</code> 的强大扩展，支持动态注册参与者、多阶段同步和分层结构，适用于更复杂的并发协调场景。</p>
<h3 data-id="heading-15">使用场景</h3>
<ul>
<li>多阶段并行任务（如 Map-Reduce 的 map → shuffle → reduce）。</li>
<li>动态增减工作线程（例如任务中途加入新 worker）。</li>
<li>大规模并行计算中需要分组同步（通过分层 Phaser 实现）。</li>
<li>替代多个 <code>CyclicBarrier</code> 或 <code>CountDownLatch</code> 的组合逻辑。</li>
</ul>
<h3 data-id="heading-16">核心 API</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 构造方法</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Phaser</span>()</span>;                     <span class="hljs-comment">// 无初始参与者</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Phaser</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> parties</span>)</span>;          <span class="hljs-comment">// 指定初始参与者数量</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Phaser</span>(<span class="hljs-params">Phaser parent</span>)</span>;        <span class="hljs-comment">// 构建父子分层结构</span>

<span class="hljs-comment">// 核心方法</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">register</span>()</span>;               <span class="hljs-comment">// 注册一个新参与者，返回当前阶段号</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">arrive</span>()</span>;                 <span class="hljs-comment">// 到达屏障，不等待</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">arriveAndAwaitAdvance</span>()</span>;  <span class="hljs-comment">// 到达并等待其他参与者</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">arriveAndDeregister</span>()</span>;    <span class="hljs-comment">// 到达并注销自己（退出后续阶段）</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> boolean <span class="hljs-title">isTerminated</span>()</span>;       <span class="hljs-comment">// 是否已终止（当参与者数为0时终止）</span>
</code></pre>
<h3 data-id="heading-17">使用示例</h3>
<p><strong>动态多阶段任务：</strong></p>
<pre><code class="hljs language-scss" lang="scss">public class PhaserExample {
    public static void <span class="hljs-selector-tag">main</span>(String[] args) {
        Phaser phaser = new <span class="hljs-built_in">Phaser</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 初始无参与者</span>

        <span class="hljs-comment">// 启动3个任务线程</span>
        for (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
            phaser<span class="hljs-selector-class">.register</span>(); <span class="hljs-comment">// 注册参与者</span>
            new <span class="hljs-built_in">Thread</span>(() -&gt; {
                try {
                    for (int phase = <span class="hljs-number">0</span>; phase &lt; <span class="hljs-number">3</span>; phase++) {
                        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(Thread.currentThread()<span class="hljs-selector-class">.getName</span>() 
                            + " 完成阶段 " + phase);
                        <span class="hljs-comment">// 到达屏障并等待其他线程</span>
                        phaser<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>();
                    }
                    <span class="hljs-comment">// 任务结束，注销自己</span>
                    phaser<span class="hljs-selector-class">.arriveAndDeregister</span>();
                } catch (Exception e) {
                    e<span class="hljs-selector-class">.printStackTrace</span>();
                }
            })<span class="hljs-selector-class">.start</span>();
        }

        <span class="hljs-comment">// 主线程等待所有阶段完成</span>
        while (!phaser.isTerminated()) {
            Thread<span class="hljs-selector-class">.yield</span>();
        }
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("所有阶段已完成！");
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs">Thread-1 完成阶段 0
Thread-2 完成阶段 0
Thread-0 完成阶段 0
Thread-0 完成阶段 1
Thread-2 完成阶段 1
Thread-1 完成阶段 1
Thread-2 完成阶段 2
Thread-1 完成阶段 2
Thread-0 完成阶段 2
所有阶段已完成！
</code></pre>
<h3 data-id="heading-18">高级特性：分层 Phaser</h3>
<p>当参与者数量极大（如数千线程）时，单一 <code>Phaser</code> 的同步开销会很高。此时可构建<strong>树状分层结构</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">Phaser root = new <span class="hljs-built_in">Phaser</span>();
Phaser group1 = new <span class="hljs-built_in">Phaser</span>(root); <span class="hljs-comment">// 子 Phaser，父为 root</span>
Phaser group2 = new <span class="hljs-built_in">Phaser</span>(root);

<span class="hljs-comment">// group1 内部线程只与同组同步，最终由 root 汇总</span>
group1<span class="hljs-selector-class">.register</span>();
new <span class="hljs-built_in">Thread</span>(() -&gt; {
    group1<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>(); <span class="hljs-comment">// 仅与 group1 同步</span>
})<span class="hljs-selector-class">.start</span>();
</code></pre>
<p>这种结构能显著减少锁竞争，提升大规模并发性能。、</p>
<h3 data-id="heading-19">应用场景示例</h3>
<p><strong>分阶段并行处理：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 模拟三阶段数据处理：加载 → 转换 → 输出</span>
Phaser phaser = new <span class="hljs-built_in">Phaser</span>(<span class="hljs-number">0</span>);

List&lt;Thread&gt; workers = IntStream<span class="hljs-selector-class">.range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>)
    <span class="hljs-selector-class">.mapToObj</span>(i -&gt; {
        phaser.register();
        return new <span class="hljs-built_in">Thread</span>(() -&gt; {
            <span class="hljs-built_in">load</span>();   phaser<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>();
            <span class="hljs-attribute">transform</span>(); phaser<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>();
            <span class="hljs-built_in">output</span>(); phaser<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>();
            phaser<span class="hljs-selector-class">.arriveAndDeregister</span>();
        });
    })
    <span class="hljs-selector-class">.peek</span>(Thread::start)
    <span class="hljs-selector-class">.collect</span>(Collectors.toList());

<span class="hljs-comment">// 等待全部完成</span>
while (!phaser.isTerminated()) {
    Thread<span class="hljs-selector-class">.yield</span>();
}
</code></pre>
<h3 data-id="heading-20">底层原理</h3>
<p>不同于 <code>CountDownLatch</code> 和 <code>Semaphore</code>，<code>Phaser</code> <strong>未基于 AQS</strong>，而是自行实现同步机制，它的实现融合了 <strong>自旋锁 + 队列管理</strong>：</p>
<ul>
<li><strong>状态字段</strong>：使用一个 <code>long</code> 类型的 <code>state</code> 字段，高位存阶段号（phase），低位存参与者数量（parties）。</li>
<li><strong>自适应等待策略</strong>：</li>
<li>
<ul>
<li>参与者少时使用 <strong>自旋等待</strong>（低延迟）。</li>
<li>参与者多或等待时间长时，自动切换到 <strong>阻塞队列</strong>（节省 CPU）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-21">Phaser 与 CyclicBarrier 的对比</h3>













































<table><thead><tr><th>特性</th><th>CyclicBarrier</th><th>Phaser</th></tr></thead><tbody><tr><td>引入版本</td><td>JDK 1.5</td><td>JDK 1.7</td></tr><tr><td>是否可重用</td><td>✅（自动重置）</td><td>✅（阶段递增）</td></tr><tr><td>动态增减参与者</td><td>❌</td><td>✅（register() / arriveAndDeregister()）</td></tr><tr><td>分层支持</td><td>❌</td><td>✅（父子结构）</td></tr><tr><td>阶段号追踪</td><td>❌</td><td>✅（getPhase()）</td></tr><tr><td>终止机制</td><td>损坏即不可用</td><td>参与者归零后优雅终止</td></tr><tr><td>性能（大规模）</td><td>较差（全局锁）</td><td>更优（分层 + 自适应等待）</td></tr></tbody></table>
<p><strong>使用建议：</strong></p>
<ul>
<li>若参与者数量固定且较少，用 <code>CyclicBarrier</code> 即可。</li>
<li>若需动态调整、多阶段、大规模，则优先选择 <code>Phaser</code>。</li>
</ul>
<h2 data-id="heading-22">Semaphore（JDK 5+）：信号量</h2>
<h3 data-id="heading-23">使用场景</h3>
<p><code>Semaphore</code> 用于控制<strong>同时访问特定资源的线程数量</strong>，比如：</p>
<ul>
<li>数据库连接池（最多 N 个连接）。</li>
<li>接口限流（如每秒最多处理 100 个请求）。</li>
<li>模拟有限资源的分配（如停车场车位）。</li>
<li><code>new Semaphore(1)</code> 实际上等价于 <code>synchronized</code> 或 <code>ReentrantLock</code>。</li>
</ul>
<h3 data-id="heading-24">核心 API</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Semaphore</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>)</span>;
<span class="hljs-keyword">public</span> <span class="hljs-title function_">Semaphore</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>, <span class="hljs-type">boolean</span> fair)</span>; <span class="hljs-comment">// 公平/非公平模式</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">()</span>;
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span>; <span class="hljs-comment">// 非阻塞尝试获取</span>
</code></pre>
<h3 data-id="heading-25">使用示例</h3>
<pre><code class="hljs language-scss" lang="scss">public class SemaphoreExample {
    private static final Semaphore semaphore = new <span class="hljs-built_in">Semaphore</span>(<span class="hljs-number">2</span>); <span class="hljs-comment">// 最多2个线程并发</span>

    public static void <span class="hljs-selector-tag">main</span>(String[] args) {
        for (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
            new <span class="hljs-built_in">Thread</span>(() -&gt; {
                try {
                    semaphore<span class="hljs-selector-class">.acquire</span>();
                    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(Thread.currentThread()<span class="hljs-selector-class">.getName</span>() + " 获取许可，正在执行...");
                    Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">2000</span>);
                } catch (InterruptedException e) {
                    Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.interrupt</span>();
                } finally {
                    semaphore<span class="hljs-selector-class">.release</span>();
                    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(Thread.currentThread()<span class="hljs-selector-class">.getName</span>() + " 释放许可");
                }
            })<span class="hljs-selector-class">.start</span>();
        }
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-erlang" lang="erlang">Thread-<span class="hljs-number">0</span> 获取许可，正在执行...
Thread-<span class="hljs-number">1</span> 获取许可，正在执行...
Thread-<span class="hljs-number">0</span> 释放许可
Thread-<span class="hljs-number">2</span> 获取许可，正在执行...
Thread-<span class="hljs-number">1</span> 释放许可
Thread-<span class="hljs-number">3</span> 获取许可，正在执行...
Thread-<span class="hljs-number">2</span> 释放许可
Thread-<span class="hljs-number">3</span> 释放许可
Thread-<span class="hljs-number">4</span> 获取许可，正在执行...
Thread-<span class="hljs-number">4</span> 释放许可
</code></pre>
<h3 data-id="heading-26">应用场景示例</h3>
<p><strong>API 限流：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Semaphore</span> <span class="hljs-variable">rateLimiter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">100</span>); <span class="hljs-comment">// 每秒最多100请求</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (rateLimiter.tryAcquire()) {
        <span class="hljs-keyword">try</span> {
            process();
        } <span class="hljs-keyword">finally</span> {
            rateLimiter.release();
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"请求过于频繁"</span>);
    }
}
</code></pre>
<h3 data-id="heading-27">底层原理</h3>
<p>同样基于 <strong>AQS</strong>：（AQS 原理详见<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fmp.weixin.qq.com%2Fs%2FYl1jxnE562TuUqq48rag4g" target="_blank" title="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/Yl1jxnE562TuUqq48rag4g" ref="nofollow noopener noreferrer">Java并发编程：Lock原理详解</a>）</p>
<ul>
<li><code>state</code> 表示可用许可数量。</li>
<li><code>acquire()</code> 尝试减少 <code>state</code>，若不足则入队等待。</li>
<li><code>release()</code> 增加 <code>state</code> 并唤醒等待线程。</li>
<li>支持公平模式（按请求顺序分配许可）。</li>
</ul>
<h2 data-id="heading-28">Exchanger（JDK 5+）：数据交换器</h2>
<h3 data-id="heading-29">使用场景</h3>
<p><code>Exchanger</code> 专为<strong>两个线程之间交换数据</strong>而设计，典型场景如：</p>
<ul>
<li>双缓冲机制（一个线程写入缓冲区 A，另一个写入 B，满后交换）。</li>
<li>生产者与消费者高效传递中间结果。</li>
<li>日志收集器中交换日志缓冲区。</li>
</ul>
<h3 data-id="heading-30">核心 API</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">exchange</span><span class="hljs-params">(V x)</span> <span class="hljs-keyword">throws</span> InterruptedException;
<span class="hljs-keyword">public</span> V <span class="hljs-title function_">exchange</span><span class="hljs-params">(V x, <span class="hljs-type">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> ...;
</code></pre>
<h3 data-id="heading-31">示例代码</h3>
<pre><code class="hljs language-ini" lang="ini">public class ExchangerExample {
    public static void main(String<span class="hljs-section">[]</span> args) {
        Exchanger&lt;String&gt; <span class="hljs-attr">exchanger</span> = new Exchanger&lt;&gt;()<span class="hljs-comment">;</span>

        new Thread(() -&gt; {
            try {
                String <span class="hljs-attr">data</span> = <span class="hljs-string">"Thread-A 的数据"</span><span class="hljs-comment">;</span>
                System.out.println("A 准备交换: " + data)<span class="hljs-comment">;</span>
                String <span class="hljs-attr">received</span> = exchanger.exchange(data)<span class="hljs-comment">;</span>
                System.out.println("A 收到: " + received)<span class="hljs-comment">;</span>
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt()<span class="hljs-comment">;</span>
            }
        }).start()<span class="hljs-comment">;</span>

        new Thread(() -&gt; {
            try {
                Thread.sleep(1000)<span class="hljs-comment">; // 模拟延迟</span>
                String <span class="hljs-attr">data</span> = <span class="hljs-string">"Thread-B 的数据"</span><span class="hljs-comment">;</span>
                System.out.println("B 准备交换: " + data)<span class="hljs-comment">;</span>
                String <span class="hljs-attr">received</span> = exchanger.exchange(data)<span class="hljs-comment">;</span>
                System.out.println("B 收到: " + received)<span class="hljs-comment">;</span>
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt()<span class="hljs-comment">;</span>
            }
        }).start()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">A</span> 准备交换: <span class="hljs-selector-tag">Thread-A</span> 的数据
<span class="hljs-selector-tag">B</span> 准备交换: <span class="hljs-selector-tag">Thread-B</span> 的数据
<span class="hljs-selector-tag">B</span> 收到: <span class="hljs-selector-tag">Thread-A</span> 的数据
<span class="hljs-selector-tag">A</span> 收到: <span class="hljs-selector-tag">Thread-B</span> 的数据
</code></pre>
<h3 data-id="heading-32">应用场景示例</h3>
<p><strong>双缓冲日志：</strong></p>
<pre><code class="hljs language-ini" lang="ini">Exchanger&lt;List&lt;LogEntry&gt;&gt; <span class="hljs-attr">exchanger</span> = new Exchanger&lt;&gt;()<span class="hljs-comment">;</span>
List&lt;LogEntry&gt; <span class="hljs-attr">bufferA</span> = new ArrayList&lt;&gt;(<span class="hljs-number">1000</span>)<span class="hljs-comment">;</span>
List&lt;LogEntry&gt; <span class="hljs-attr">bufferB</span> = new ArrayList&lt;&gt;(<span class="hljs-number">1000</span>)<span class="hljs-comment">;</span>

// 写线程不断填充 bufferA
// 写满后与读线程交换，读线程异步刷盘
</code></pre>
<h3 data-id="heading-33">底层原理</h3>
<p><code>Exchanger</code> 内部使用 <strong>Slot 或 Node 结构</strong>暂存数据，通过 <strong>CAS + 自旋</strong> 实现高效交换：</p>
<ul>
<li>第一个调用 <code>exchange()</code> 的线程将数据放入槽位并等待。</li>
<li>第二个线程到来后，取出对方数据，放入自己的数据，完成交换。</li>
<li>若超时或中断，会清理槽位并抛出异常。</li>
</ul>
<p><strong>注意</strong>：仅支持<strong>两个线程配对交换</strong>，第三个线程调用 <code>exchange()</code> 会一直阻塞直到有新的配对。</p>
<h2 data-id="heading-34">工具类对比总结</h2>





































































<table><thead><tr><th>特性</th><th>CountDownLatch</th><th>CyclicBarrier</th><th>Phaser</th><th>Semaphore</th><th>Exchanger</th></tr></thead><tbody><tr><td>引入版本</td><td>1.5</td><td>1.5</td><td>1.7</td><td>1.5</td><td>1.5</td></tr><tr><td>是否可重用</td><td>❌</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>协作模式</td><td>一方等多方</td><td>所有互相等</td><td>多阶段动态同步</td><td>控制并发数</td><td>两线程交换</td></tr><tr><td>动态参与者</td><td>❌</td><td>❌</td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td>分层支持</td><td>❌</td><td>❌</td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td>底层机制</td><td>AQS</td><td>ReentrantLock+Condition</td><td>自定义同步（CAS+自旋+队列）</td><td>AQS</td><td>CAS+自旋</td></tr><tr><td>典型用途</td><td>初始化等待</td><td>分阶段计算</td><td>复杂并行任务协调</td><td>限流</td><td>数据交换</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端崩溃监控：给网页戴上“生命体征监测仪”]]></title>    <link>https://juejin.cn/post/7586684925106389035</link>    <guid>https://juejin.cn/post/7586684925106389035</guid>    <pubDate>2025-12-23T06:28:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586684925106389035" data-draft-id="7586684925106372651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端崩溃监控：给网页戴上“生命体征监测仪”"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T06:28:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JS_Likers"/> <meta itemprop="url" content="https://juejin.cn/user/1377017277975032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端崩溃监控：给网页戴上“生命体征监测仪”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1377017277975032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JS_Likers
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:28:30.000Z" title="Tue Dec 23 2025 06:28:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>欢迎使用我的小程序👇👇👇👇</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d25c4001b1b4e6e902dc1f8863bcef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSlNfTGlrZXJz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767076110&amp;x-signature=2tlmxVM2u5XfV2g2%2BioDUySoe%2BI%3D" alt="small.png" loading="lazy"/></p>
<hr/>
<blockquote>
<p>想象一下：你开发的网页突然“晕倒”了，而你还蒙在鼓里——直到用户流失报表像病危通知书一样摆在你面前。别怕！今天我们来给每个网页安装一套“ICU监护系统”。</p>
</blockquote>
<h2 data-id="heading-0">一、开场白：当网页突然“不省人事”</h2>
<p>上周，我朋友小张的公司遇到了一个诡异问题：他们的电商平台在iPhone上总会在用户下单时“卡死”。用户抱怨，客服崩溃，而开发团队却一脸茫然——<strong>监控系统什么都没抓到</strong>。</p>
<p>“就像病人突然休克，但心电图却显示一切正常。”小张苦笑着说。</p>
<p>这就是大多数前端开发者的困境：<strong>JavaScript错误能监控，但页面崩溃却像幽灵一样无影无踪</strong>。今天，我就来揭秘如何给网页安装一套全方位的“生命体征监测系统”。</p>
<h2 data-id="heading-1">二、崩溃的“临床表现”与诊断难点</h2>
<h3 data-id="heading-2">2.1 页面崩溃的四种“病症”</h3>
<p>先来看几个典型病例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 病例1：内存泄漏型“慢性病”</span>
<span class="hljs-keyword">let</span> memoryLeak = [];
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  memoryLeak.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'*'</span>)); <span class="hljs-comment">// 每秒吃掉10MB内存</span>
}, <span class="hljs-number">1000</span>);
<span class="hljs-comment">// 症状：页面越来越慢，最后彻底卡死</span>

<span class="hljs-comment">// 病例2：死循环型“急性心梗”</span>
<span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
  <span class="hljs-comment">// 无限循环，主线程完全阻塞</span>
}
<span class="hljs-comment">// 症状：页面瞬间冻结，点击无反应</span>

<span class="hljs-comment">// 病例3：渲染层“脑梗”</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>; <span class="hljs-comment">// 清空DOM</span>
<span class="hljs-title function_">complex3DAnimation</span>(); <span class="hljs-comment">// 但GPU还在拼命渲染不存在的元素</span>
<span class="hljs-comment">// 症状：页面白屏，但控制台没报错</span>

<span class="hljs-comment">// 病例4：网络层“呼吸衰竭”</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 永远等不到响应...</span>
});
<span class="hljs-comment">// 症状：loading转圈到天荒地老</span>
</code></pre>
<h3 data-id="heading-3">2.2 传统监控的“诊断盲区”</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[页面崩溃发生] --&gt; B{传统错误监控}
    B --&gt;|能捕获| C[JavaScript执行错误]
    B --&gt;|能捕获| D[资源加载失败]
    B --&gt;|无法捕获| E[内存泄漏崩溃]
    B --&gt;|无法捕获| F[死循环卡死]
    B --&gt;|无法捕获| G[渲染层崩溃]
    
    style E fill:#f96
    style F fill:#f96
    style G fill:#f96
</code></pre>
<p>传统错误监控就像是<strong>只查血常规，不做心电图</strong>——很多致命问题根本检测不到。</p>
<h2 data-id="heading-4">三、我们的“ICU监控系统”架构</h2>
<p>经过多年“临床实践”，我设计了一套<strong>四层监控体系</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph “监控体系架构”
        A[第一层: 实时心跳监测] --&gt; B[第二层: 多维度异常捕捉]
        B --&gt; C[第三层: 崩溃现场快照]
        C --&gt; D[第四层: 智能上报分析]
    end
    
    subgraph “技术实现”
        E[Service Worker&lt;br/&gt;独立心跳] --&gt; F[LocalStorage&lt;br/&gt;心跳备份]
        F --&gt; G[Performance API&lt;br/&gt;性能监控]
        G --&gt; H[Error Boundaries&lt;br/&gt;错误边界]
    end
    
    A -.-&gt; E
    B -.-&gt; G
    B -.-&gt; H
    C -.-&gt; F
</code></pre>
<h3 data-id="heading-5">3.1 第一层：Service Worker心跳监测（独立“起搏器”）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 想象一下：即使病人（主页面）昏迷了，</span>
<span class="hljs-comment">// 他的智能手表（Service Worker）还能继续发送生命信号</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HeartbeatMonitor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">heartbeatInterval</span> = <span class="hljs-number">5000</span>; <span class="hljs-comment">// 5秒一次心跳</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">crashThreshold</span> = <span class="hljs-number">15000</span>;   <span class="hljs-comment">// 15秒无心跳算“休克”</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateSessionId</span>();
  }
  
  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 注册Service Worker“护士”</span>
    navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/nurse.js'</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🏥 私人护士已上岗，开始监测心跳'</span>);
        
        <span class="hljs-comment">// 定期发送“我还活着”信号</span>
        <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendHeartbeat</span>();
        }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">heartbeatInterval</span>);
      });
  }
  
  <span class="hljs-title function_">sendHeartbeat</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 发送当前生命体征</span>
    <span class="hljs-keyword">const</span> vitalSigns = {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'HEARTBEAT'</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">patientId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>,
      <span class="hljs-attr">bloodPressure</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getMemoryPressure</span>(), <span class="hljs-comment">// 内存“血压”</span>
      <span class="hljs-attr">heartRate</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getEventLoopHealth</span>()     <span class="hljs-comment">// 事件循环“心率”</span>
    };
    
    <span class="hljs-comment">// 告诉护士当前状态</span>
    navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">controller</span>?.<span class="hljs-title function_">postMessage</span>(vitalSigns);
  }
}
</code></pre>
<p><strong>工作原理</strong>：</p>
<ul>
<li>Service Worker独立于主线程运行</li>
<li>即使主页面崩溃，Service Worker仍存活</li>
<li>15秒收不到心跳 → 判断页面“可能已崩溃”</li>
</ul>
<h3 data-id="heading-6">3.2 第二层：LocalStorage备份心跳（“病历本”方案）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这是给没有Service Worker的“低配版病人”准备的</span>
<span class="hljs-comment">// 原理：让页面定期在“病历本”上签字</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BackupMonitor</span> {
  <span class="hljs-title function_">checkPreviousSession</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 就诊时先看上次的“病历记录”</span>
    <span class="hljs-keyword">const</span> lastCheckup = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'last_heartbeat'</span>);
    
    <span class="hljs-keyword">if</span> (lastCheckup) {
      <span class="hljs-keyword">const</span> { timestamp, sessionId } = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(lastCheckup);
      <span class="hljs-keyword">const</span> timeSinceLastBeat = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - timestamp;
      
      <span class="hljs-keyword">if</span> (timeSinceLastBeat &gt; <span class="hljs-number">10000</span>) {
        <span class="hljs-comment">// 发现异常：上次就诊后没按时复查</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportSuspectedCrash</span>({
          <span class="hljs-attr">patientId</span>: sessionId,
          <span class="hljs-attr">missingDuration</span>: timeSinceLastBeat,
          <span class="hljs-attr">symptoms</span>: <span class="hljs-string">'未按时复查心跳'</span>
        });
      }
    }
    
    <span class="hljs-comment">// 开始新的诊疗记录</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startNewSession</span>();
  }
  
  <span class="hljs-title function_">startNewSession</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 每3秒在病历本上签一次到</span>
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'last_heartbeat'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">sessionId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>,
        <span class="hljs-attr">url</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>
      }));
    }, <span class="hljs-number">3000</span>);
  }
}
</code></pre>
<h2 data-id="heading-7">四、实战：多维度“体检项目”</h2>
<p>光有心跳还不够，我们还需要全面的体检：</p>
<h3 data-id="heading-8">4.1 内存“血常规”检查</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BloodTest</span> {
  <span class="hljs-title function_">checkBloodRoutine</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!performance.<span class="hljs-property">memory</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> bloodReport = {
        <span class="hljs-comment">// 红细胞（已用内存）</span>
        <span class="hljs-attr">RBC</span>: performance.<span class="hljs-property">memory</span>.<span class="hljs-property">usedJSHeapSize</span>,
        <span class="hljs-comment">// 白细胞（总内存）</span>
        <span class="hljs-attr">WBC</span>: performance.<span class="hljs-property">memory</span>.<span class="hljs-property">totalJSHeapSize</span>,
        <span class="hljs-comment">// 血小板（内存限制）</span>
        <span class="hljs-attr">PLT</span>: performance.<span class="hljs-property">memory</span>.<span class="hljs-property">jsHeapSizeLimit</span>,
        <span class="hljs-comment">// 血红蛋白（使用率）</span>
        <span class="hljs-attr">HGB</span>: (performance.<span class="hljs-property">memory</span>.<span class="hljs-property">usedJSHeapSize</span> / 
              performance.<span class="hljs-property">memory</span>.<span class="hljs-property">totalJSHeapSize</span>) * <span class="hljs-number">100</span>
      };
      
      <span class="hljs-comment">// 诊断标准</span>
      <span class="hljs-keyword">if</span> (bloodReport.<span class="hljs-property">HGB</span> &gt; <span class="hljs-number">90</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'⚠️ 危！病人严重贫血（内存不足）！'</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emergencyTransfusion</span>(); <span class="hljs-comment">// 紧急输血（清理内存）</span>
      }
    }, <span class="hljs-number">10000</span>);
  }
  
  <span class="hljs-title function_">emergencyTransfusion</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 尝试触发垃圾回收</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">gc</span>) {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">gc</span>(); <span class="hljs-comment">// Chrome DevTools才有的“特效药”</span>
    }
    
    <span class="hljs-comment">// 清理缓存</span>
    caches.<span class="hljs-title function_">delete</span>(<span class="hljs-string">'my-cache'</span>);
    
    <span class="hljs-comment">// 卸载不必要组件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unloadUnusedComponents</span>();
  }
}
</code></pre>
<h3 data-id="heading-9">4.2 事件循环“心电图”监测</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ECGMonitor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastBeatTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxInterval</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// 正常“心跳”间隔应小于100ms</span>
  }
  
  <span class="hljs-title function_">startMonitoring</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 用requestAnimationFrame检测“心律”</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkHeartRhythm</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">const</span> interval = now - <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastBeatTime</span>;
      
      <span class="hljs-keyword">if</span> (interval &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxInterval</span> * <span class="hljs-number">2</span>) {
        <span class="hljs-comment">// 检测到“心律不齐”</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportArrhythmia</span>({
          <span class="hljs-attr">interval</span>: interval,
          <span class="hljs-attr">timestamp</span>: now,
          <span class="hljs-attr">severity</span>: interval &gt; <span class="hljs-number">1000</span> ? <span class="hljs-string">'CRITICAL'</span> : <span class="hljs-string">'WARNING'</span>
        });
      }
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastBeatTime</span> = now;
      <span class="hljs-title function_">requestAnimationFrame</span>(checkHeartRhythm);
    };
    
    <span class="hljs-title function_">checkHeartRhythm</span>();
  }
}
</code></pre>
<h3 data-id="heading-10">4.3 渲染性能“CT扫描”</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CTScanner</span> {
  <span class="hljs-title function_">setupRenderMonitoring</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 监控布局偏移（突然的“头晕目眩”）</span>
    <span class="hljs-keyword">const</span> layoutShiftObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
      list.<span class="hljs-title function_">getEntries</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">value</span> &gt; <span class="hljs-number">0.1</span>) { <span class="hljs-comment">// 偏移超过10%</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportVertigo</span>({
            <span class="hljs-attr">shiftValue</span>: entry.<span class="hljs-property">value</span>,
            <span class="hljs-attr">hadRecentInput</span>: entry.<span class="hljs-property">hadRecentInput</span>,
            <span class="hljs-attr">cause</span>: <span class="hljs-string">'布局突然变化'</span>
          });
        }
      });
    });
    
    layoutShiftObserver.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'layout-shift'</span>] });
    
    <span class="hljs-comment">// 监控长任务（“大脑宕机”时刻）</span>
    <span class="hljs-keyword">const</span> longTaskObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
      list.<span class="hljs-title function_">getEntries</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">duration</span> &gt; <span class="hljs-number">50</span>) { <span class="hljs-comment">// 超过50ms的任务</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportBrainFreeze</span>({
            <span class="hljs-attr">duration</span>: entry.<span class="hljs-property">duration</span>,
            <span class="hljs-attr">culprit</span>: entry.<span class="hljs-property">attribution</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">name</span> || <span class="hljs-string">'未知'</span>,
            <span class="hljs-attr">timestamp</span>: entry.<span class="hljs-property">startTime</span>
          });
        }
      });
    });
    
    longTaskObserver.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'longtask'</span>] });
  }
}
</code></pre>
<h2 data-id="heading-11">五、崩溃“尸检报告”：收集现场证据</h2>
<p>当崩溃发生时，我们需要一份详细的“尸检报告”：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AutopsyReport</span> {
  <span class="hljs-title function_">collectEvidence</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 基础身份信息</span>
      <span class="hljs-attr">patientInfo</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span>,
        <span class="hljs-attr">id</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
        <span class="hljs-attr">age</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - performance.<span class="hljs-property">timing</span>.<span class="hljs-property">navigationStart</span>
      },
      
      <span class="hljs-comment">// 最后的活动记录</span>
      <span class="hljs-attr">lastMovements</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUserActions</span>(),
      
      <span class="hljs-comment">// 生命体征最后读数</span>
      <span class="hljs-attr">lastVitals</span>: {
        <span class="hljs-attr">memory</span>: performance.<span class="hljs-property">memory</span>?.<span class="hljs-property">usedJSHeapSize</span> || <span class="hljs-string">'N/A'</span>,
        <span class="hljs-attr">fps</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateFPS</span>(),
        <span class="hljs-attr">network</span>: navigator.<span class="hljs-property">connection</span>?.<span class="hljs-property">effectiveType</span> || <span class="hljs-string">'unknown'</span>
      },
      
      <span class="hljs-comment">// 现场照片（屏幕截图替代方案）</span>
      <span class="hljs-attr">crimeScene</span>: {
        <span class="hljs-attr">viewport</span>: <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.innerWidth}</span>x<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.innerHeight}</span>`</span>,
        <span class="hljs-attr">scrollPosition</span>: {
          <span class="hljs-attr">x</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollX</span>,
          <span class="hljs-attr">y</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>
        },
        <span class="hljs-attr">visibleElements</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getVisibleElements</span>()
      },
      
      <span class="hljs-comment">// 时间线重建</span>
      <span class="hljs-attr">timeline</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reconstructTimeline</span>(),
      
      <span class="hljs-comment">// 可能的死因分析</span>
      <span class="hljs-attr">probableCause</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">analyzeProbableCause</span>()
    };
  }
  
  <span class="hljs-title function_">getUserActions</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 收集用户最后10次操作</span>
    <span class="hljs-keyword">return</span> userActionLog.<span class="hljs-title function_">slice</span>(-<span class="hljs-number">10</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> ({
      <span class="hljs-attr">type</span>: action.<span class="hljs-property">type</span>,
      <span class="hljs-attr">target</span>: action.<span class="hljs-property">target</span>,
      <span class="hljs-attr">timestamp</span>: action.<span class="hljs-property">timestamp</span>,
      <span class="hljs-attr">pageX</span>: action.<span class="hljs-property">pageX</span>,
      <span class="hljs-attr">pageY</span>: action.<span class="hljs-property">pageY</span>
    }));
  }
  
  <span class="hljs-title function_">analyzeProbableCause</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 基于收集的证据分析可能死因</span>
    <span class="hljs-keyword">const</span> evidence = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collectEvidence</span>();
    
    <span class="hljs-keyword">if</span> (evidence.<span class="hljs-property">lastVitals</span>.<span class="hljs-property">memory</span> &gt; <span class="hljs-number">500000000</span>) { <span class="hljs-comment">// 500MB</span>
      <span class="hljs-keyword">return</span> <span class="hljs-string">'MEMORY_OVERLOAD'</span>;
    }
    
    <span class="hljs-keyword">if</span> (evidence.<span class="hljs-property">timeline</span>.<span class="hljs-property">longTasks</span> &gt; <span class="hljs-number">5</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'MAIN_THREAD_BLOCKED'</span>;
    }
    
    <span class="hljs-keyword">if</span> (evidence.<span class="hljs-property">lastMovements</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.<span class="hljs-property">type</span> === <span class="hljs-string">'fetch'</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'NETWORK_REQUEST_HANG'</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">'UNKNOWN'</span>;
  }
}
</code></pre>
<h2 data-id="heading-12">六、智能上报：不打扰的“远程监护”</h2>
<p>监控数据上报要像<strong>智能手表的健康同步</strong>——安静、及时、省电：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartReporter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reportQueue</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reportStrategies</span> = {
      <span class="hljs-comment">// 急诊级：立即上报</span>
      <span class="hljs-attr">EMERGENCY</span>: {
        <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">methods</span>: [<span class="hljs-string">'beacon'</span>, <span class="hljs-string">'fetch'</span>],
        <span class="hljs-attr">retry</span>: <span class="hljs-number">3</span>
      },
      
      <span class="hljs-comment">// 门诊级：批量上报</span>
      <span class="hljs-attr">OUTPATIENT</span>: {
        <span class="hljs-attr">immediate</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">batchSize</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">interval</span>: <span class="hljs-number">30000</span>
      },
      
      <span class="hljs-comment">// 体检级：抽样上报</span>
      <span class="hljs-attr">CHECKUP</span>: {
        <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">0.1</span>, <span class="hljs-comment">// 10%抽样</span>
        <span class="hljs-attr">interval</span>: <span class="hljs-number">60000</span>
      }
    };
  }
  
  <span class="hljs-comment">// 智能判断上报策略</span>
  <span class="hljs-title function_">smartReport</span>(<span class="hljs-params">data, severity</span>) {
    <span class="hljs-keyword">const</span> strategy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">reportStrategies</span>[severity];
    
    <span class="hljs-keyword">if</span> (strategy.<span class="hljs-property">immediate</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emergencyReport</span>(data);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">queueReport</span>(data, strategy);
    }
  }
  
  <span class="hljs-comment">// 急诊上报：用sendBeacon确保送达</span>
  <span class="hljs-title function_">emergencyReport</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> url = <span class="hljs-string">'/api/emergency'</span>;
    <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)], {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'application/json'</span>
    });
    
    <span class="hljs-comment">// sendBeacon：即使页面关闭也保证发送</span>
    <span class="hljs-keyword">if</span> (navigator.<span class="hljs-title function_">sendBeacon</span>(url, blob)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🚑 急诊报告已送出'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 备用方案</span>
      <span class="hljs-title function_">fetch</span>(url, {
        <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
        <span class="hljs-attr">body</span>: blob,
        <span class="hljs-attr">keepalive</span>: <span class="hljs-literal">true</span>
      });
    }
  }
  
  <span class="hljs-comment">// 智能节流：避免频繁上报</span>
  <span class="hljs-title function_">queueReport</span>(<span class="hljs-params">data, strategy</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reportQueue</span>.<span class="hljs-title function_">push</span>({
      data,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      strategy
    });
    
    <span class="hljs-comment">// 达到批量大小或时间间隔时上报</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reportQueue</span>.<span class="hljs-property">length</span> &gt;= strategy.<span class="hljs-property">batchSize</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flushQueue</span>();
    }
  }
}
</code></pre>
<h2 data-id="heading-13">七、真实病例：电商网站崩溃之谜</h2>
<p>让我分享一个真实案例，看看这套系统如何“破案”：</p>
<h3 data-id="heading-14">7.1 案件背景</h3>
<p>某电商大促期间，iPhone用户频繁反馈“加入购物车后页面卡死”。</p>
<h3 data-id="heading-15">7.2 监控发现</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[用户点击加入购物车] --&gt; B{监控系统记录}
    B --&gt; C[内存从150MB飙升至850MB]
    B --&gt; D[主线程阻塞3.2秒]
    B --&gt; E[Service Worker心跳中断]
    C --&gt; F[诊断: 内存泄漏]
    D --&gt; G[诊断: 同步DOM操作]
    E --&gt; H[诊断: 页面崩溃]
    
    style F fill:#f96
    style G fill:#f96
    style H fill:#f96
</code></pre>
<h3 data-id="heading-16">7.3 根本原因</h3>
<p>通过“尸检报告”发现罪魁祸首：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 问题代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addToCart</span>(<span class="hljs-params">product</span>) {
  <span class="hljs-comment">// 每次点击都创建新的观察者，从未清理！</span>
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 监控商品可见性</span>
  }).<span class="hljs-title function_">observe</span>(productElement);
  
  <span class="hljs-comment">// 同步更新大量DOM</span>
  <span class="hljs-title function_">updateCartUI</span>(); <span class="hljs-comment">// 重绘整个购物车</span>
  <span class="hljs-title function_">updateRecommendations</span>(); <span class="hljs-comment">// 更新推荐列表</span>
  <span class="hljs-title function_">updateStockCount</span>(); <span class="hljs-comment">// 更新库存显示</span>
  
  <span class="hljs-comment">// 保存到LocalStorage（阻塞主线程）</span>
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'cart'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(cartData)); <span class="hljs-comment">// 数据越来越大！</span>
}
</code></pre>
<h3 data-id="heading-17">7.4 解决方案</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 修复后</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CartManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 单例观察者</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateQueue</span> = []; <span class="hljs-comment">// 更新队列</span>
  }
  
  <span class="hljs-title function_">addToCart</span>(<span class="hljs-params">product</span>) {
    <span class="hljs-comment">// 1. 防抖更新</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">debouncedUpdate</span>();
    
    <span class="hljs-comment">// 2. 使用IndexedDB代替LocalStorage</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveToIndexedDB</span>(cartData);
    
    <span class="hljs-comment">// 3. 虚拟化DOM更新</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">virtualUpdate</span>();
    
    <span class="hljs-comment">// 4. 内存监控</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getMemoryUsage</span>() &gt; <span class="hljs-number">70</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanupOldObservers</span>();
    }
  }
}
</code></pre>
<h3 data-id="heading-18">7.5 治疗效果</h3>
<ul>
<li><strong>崩溃率</strong>：从15.3%降至0.2%</li>
<li><strong>内存使用</strong>：峰值从850MB降至280MB</li>
<li><strong>用户满意度</strong>：提升42%</li>
</ul>
<h2 data-id="heading-19">八、监控面板：医生的“仪表盘”</h2>
<p>一个优秀的监控系统需要直观的展示：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实时健康仪表盘</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HealthDashboard</span> {
  <span class="hljs-title function_">renderDashboard</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`
      &lt;div class="health-monitor"&gt;
        &lt;div class="patient-card"&gt;
          &lt;h3&gt;🏥 页面健康状态&lt;/h3&gt;
          
          &lt;!-- 心跳指示器 --&gt;
          &lt;div class="heartbeat-indicator <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getHeartbeatStatus()}</span>"&gt;
            心跳: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getHeartbeatRate()}</span> BPM
          &lt;/div&gt;
          
          &lt;!-- 内存仪表 --&gt;
          &lt;div class="memory-gauge"&gt;
            内存使用: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getMemoryPercentage()}</span>%
            &lt;div class="gauge-bar"&gt;
              &lt;div class="gauge-fill" style="width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getMemoryPercentage()}</span>%"&gt;&lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
          
          &lt;!-- 事件循环健康度 --&gt;
          &lt;div class="event-loop-health"&gt;
            主线程响应: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getEventLoopHealth()}</span>ms
          &lt;/div&gt;
          
          &lt;!-- 今日诊断 --&gt;
          &lt;div class="diagnosis"&gt;
            &lt;h4&gt;📋 今日诊断报告&lt;/h4&gt;
            &lt;ul&gt;
              <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getDailyDiagnosis().map(d =&gt; 
                <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${d.time}</span> - <span class="hljs-subst">${d.type}</span>: <span class="hljs-subst">${d.message}</span>&lt;/li&gt;`</span>
              ).join(<span class="hljs-string">''</span>)}</span>
            &lt;/ul&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    `</span>;
  }
}
</code></pre>
<h2 data-id="heading-20">九、最佳实践清单</h2>
<h3 data-id="heading-21">9.1 必须做的 ✅</h3>
<ol>
<li><strong>多层监控</strong>：不要单点依赖</li>
<li><strong>用户无感</strong>：监控本身消耗 &lt; 1% CPU</li>
<li><strong>智能采样</strong>：高频数据按需采样</li>
<li><strong>隐私保护</strong>：匿名化用户数据</li>
</ol>
<h3 data-id="heading-22">9.2 避免做的 ❌</h3>
<ol>
<li><strong>不要</strong>在监控中抛出新错误</li>
<li><strong>不要</strong>收集敏感信息（密码、支付信息）</li>
<li><strong>不要</strong>影响正常业务逻辑</li>
<li><strong>不要</strong>忽略低端设备性能</li>
</ol>
<h3 data-id="heading-23">9.3 进阶技巧 🚀</h3>
<ol>
<li><strong>预测性监控</strong>：在崩溃前预警</li>
<li><strong>A/B测试监控</strong>：对比不同版本的稳定性</li>
<li><strong>地理监控</strong>：不同地区的表现差异</li>
<li><strong>设备指纹</strong>：特定设备的兼容性问题</li>
</ol>
<h2 data-id="heading-24">十、总结：从“救火”到“防火”</h2>
<p>实施完整的崩溃监控后，你的开发工作流将发生质变：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">timeline
    title 监控前后的变化
    section 监控前
        用户抱怨崩溃 : 开发团队茫然
        紧急修复bug : 不知如何重现
        用户持续流失 : 业务指标下降
    section 监控后
        实时警报 : 自动收集证据
        精准定位 : 快速修复问题
        预防预警 : 崩溃率下降90%
</code></pre>
<h3 data-id="heading-25">最后的思考</h3>
<p>网页崩溃监控不是奢侈品，而是<strong>必需品</strong>。它就像：</p>
<ul>
<li><strong>行车记录仪</strong>：事故发生时知道原因</li>
<li><strong>智能手环</strong>：实时监测健康状况</li>
<li><strong>飞机黑匣子</strong>：即使坠毁也能找到原因</li>
</ul>
<p>最重要的是，<strong>好的监控系统让你从被动的“救火队员”变成主动的“预防专家”</strong>。</p>
<h3 data-id="heading-26">行动起来！</h3>
<p>明天就开始为你的网站实施崩溃监控吧！从最简单的LocalStorage心跳开始，逐步完善。记住：</p>
<blockquote>
<p>每一个你今天监控到的崩溃，都是一个明天不会流失的用户。</p>
</blockquote>
<hr/>
<p><strong>彩蛋</strong>：想立即尝试？这里有一个<strong>五分钟快速上手</strong>方案：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建monitor.js文件</span>
<span class="hljs-comment">// 2. 复制下面的代码</span>
<span class="hljs-comment">// 3. 在页面中引入</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">QuickMonitor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'last_alive'</span>, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());
    }, <span class="hljs-number">5000</span>);
    
    <span class="hljs-keyword">const</span> lastAlive = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'last_alive'</span>);
    <span class="hljs-keyword">if</span> (lastAlive &amp;&amp; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - lastAlive &gt; <span class="hljs-number">10000</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'检测到上次可能崩溃了！'</span>);
    }
  }
}

<span class="hljs-keyword">new</span> <span class="hljs-title class_">QuickMonitor</span>();
</code></pre>
<p><strong>讨论时间</strong>：你的项目中遇到过最诡异的崩溃是什么？欢迎在评论区分享你的“破案”经历！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 全栈--reactjs 基础总结]]></title>    <link>https://juejin.cn/post/7586686861390479411</link>    <guid>https://juejin.cn/post/7586686861390479411</guid>    <pubDate>2025-12-23T07:08:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586686861390479411" data-draft-id="7586597780641366026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 全栈--reactjs 基础总结"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:08:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心在飞扬AI"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194366823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 全栈--reactjs 基础总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194366823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心在飞扬AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:08:26.000Z" title="Tue Dec 23 2025 07:08:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目前使用AI开发，生成代码比较成熟的全栈组合前端是reactjs，所以这里整理一些reactjs 基础知识，方便生成reactjs 的时候，可以快速修改里面的代码。</h2>
<blockquote>
<p>本文档结合 React 官方文档编写，覆盖你日常开发中 80% 会用到的 React 概念。</p>
</blockquote>
<h2 data-id="heading-1">你将学会</h2>
<ul>
<li>如何创建和嵌套组件</li>
<li>如何添加标记和样式</li>
<li>如何显示数据</li>
<li>如何渲染条件判断和列表</li>
<li>如何响应事件和更新界面</li>
<li>如何在组件间共享数据</li>
<li>React 核心原理与最佳实践</li>
</ul>
<hr/>
<h2 data-id="heading-2">一、React 渲染原理</h2>
<h3 data-id="heading-3">虚拟 DOM 的创建</h3>
<p>React 使用 <code>React.createElement</code> 创建虚拟 DOM，返回值是 React 元素（虚拟 DOM）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> element = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(
  <span class="hljs-string">'div'</span>,           <span class="hljs-comment">// DOM 类型</span>
  {               <span class="hljs-comment">// DOM 属性</span>
    <span class="hljs-attr">style</span>: {<span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span>},
    <span class="hljs-attr">className</span>: <span class="hljs-string">'container'</span>
  },
  <span class="hljs-string">'hello'</span>,        <span class="hljs-comment">// 子节点</span>
  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"span"</span>, {<span class="hljs-attr">style</span>: {<span class="hljs-attr">color</span>: <span class="hljs-string">'blue'</span>}}, <span class="hljs-string">'world'</span>)
);
</code></pre>
<h3 data-id="heading-4">JSX 语法</h3>
<p>JSX 是 JavaScript 的语法扩展，最终会被 Babel 编译成 <code>React.createElement</code> 调用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> jsxElement = (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{color:</span>'<span class="hljs-attr">red</span>'}} <span class="hljs-attr">className</span>=<span class="hljs-string">'container'</span>&gt;</span>
    hello
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{color:</span>'<span class="hljs-attr">blue</span>'}}&gt;</span>world<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
)
</code></pre>
<h3 data-id="heading-5">渲染方式</h3>
<p>React 18 使用 <code>createRoot</code> API：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>));
root.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);
</code></pre>
<hr/>
<h2 data-id="heading-6">二、创建和嵌套组件</h2>
<p>React 应用由<strong>组件</strong>构成。组件是 UI 的一部分，拥有自己的逻辑和外观。React 组件是返回标记的 JavaScript 函数。</p>
<h3 data-id="heading-7">函数组件（推荐）</h3>
<p>函数组件是一个返回虚拟 DOM 的函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>我是一个按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 在其他组件中使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到我的应用<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：React 组件名必须以大写字母开头，HTML 标签必须小写。</p>
</blockquote>
<h3 data-id="heading-8">类组件（了解即可）</h3>
<p>类组件继承自 <code>React.Component</code>，必须实现 <code>render</code> 方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-variable language_">super</span>(props);  <span class="hljs-comment">// 调用父类构造函数，this.props = props</span>
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>hello {this.props.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
}
</code></pre>
<blockquote>
<p>现代 React 开推荐使用函数组件 + Hooks，类组件主要用于维护老项目。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">三、JSX 语法</h2>
<p>JSX 是 JavaScript 的扩展语法，让在 JS 中写 HTML 变得更容易。</p>
<h3 data-id="heading-10">JSX 规则</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 必须关闭所有标签</span>
&lt;br /&gt;

<span class="hljs-comment">// 2. 必须有一个父元素包裹</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">AboutPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello there.<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>How do you do?<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}

<span class="hljs-comment">// 3. 使用 className 而不是 class</span>
&lt;img className=<span class="hljs-string">"avatar"</span> /&gt;
</code></pre>
<h3 data-id="heading-11">在 JSX 中使用 JavaScript</h3>
<p>使用花括号 <code>{}</code> 可以在 JSX 中嵌入 JavaScript 表达式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Hedy Lamarr'</span>, <span class="hljs-attr">imageUrl</span>: <span class="hljs-string">'https://i.imgur.com/yXOvdOSs.jpg'</span>, <span class="hljs-attr">imageSize</span>: <span class="hljs-number">90</span> };

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"avatar"</span>
        <span class="hljs-attr">src</span>=<span class="hljs-string">{user.imageUrl}</span>
        <span class="hljs-attr">alt</span>=<span class="hljs-string">{</span>'<span class="hljs-attr">Photo</span> <span class="hljs-attr">of</span> ' + <span class="hljs-attr">user.name</span>}
        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">width:</span> <span class="hljs-attr">user.imageSize</span>,
          <span class="hljs-attr">height:</span> <span class="hljs-attr">user.imageSize</span>
        }}
      /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<blockquote>
<p><strong>提示</strong>：<code>style={{}}</code> 不是特殊语法，而是 JSX 花括号内的一个普通对象。</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">四、添加样式</h2>
<h3 data-id="heading-13">使用 className</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;img className=<span class="hljs-string">"avatar"</span> /&gt;
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* CSS 文件 */</span>
<span class="hljs-selector-class">.avatar</span> {
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
}
</code></pre>
<h3 data-id="heading-14">使用内联样式</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;div style={{ <span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span>, <span class="hljs-attr">fontSize</span>: <span class="hljs-string">'16px'</span> }}&gt;
  红色文字
&lt;/div&gt;
</code></pre>
<hr/>
<h2 data-id="heading-15">五、条件渲染</h2>
<p>React 没有特殊的条件语法，使用普通的 JavaScript 条件语句。</p>
<h3 data-id="heading-16">方式一：if 语句</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> content;
<span class="hljs-keyword">if</span> (isLoggedIn) {
  content = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminPanel</span> /&gt;</span></span>;
} <span class="hljs-keyword">else</span> {
  content = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LoginForm</span> /&gt;</span></span>;
}

<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{content}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
</code></pre>
<h3 data-id="heading-17">方式二：三元运算符（推荐）</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;div&gt;
  {isLoggedIn ? <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminPanel</span> /&gt;</span></span> : <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LoginForm</span> /&gt;</span></span>}
&lt;/div&gt;
</code></pre>
<h3 data-id="heading-18">方式三：逻辑与 &amp;&amp;（无 else 分支时）</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;div&gt;
  {isLoggedIn &amp;&amp; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminPanel</span> /&gt;</span></span>}
&lt;/div&gt;
</code></pre>
<hr/>
<h2 data-id="heading-19">六、列表渲染</h2>
<p>使用 JavaScript 的 <code>map()</code> 函数渲染列表：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> products = [
  { <span class="hljs-attr">title</span>: <span class="hljs-string">'卷心菜'</span>, <span class="hljs-attr">isFruit</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> },
  { <span class="hljs-attr">title</span>: <span class="hljs-string">'大蒜'</span>, <span class="hljs-attr">isFruit</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">2</span> },
  { <span class="hljs-attr">title</span>: <span class="hljs-string">'苹果'</span>, <span class="hljs-attr">isFruit</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">3</span> },
];

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ShoppingList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> listItems = products.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>
      <span class="hljs-attr">key</span>=<span class="hljs-string">{product.id}</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">color:</span> <span class="hljs-attr">product.isFruit</span> ? '<span class="hljs-attr">magenta</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">darkgreen</span>'
      }}
    &gt;</span>
      {product.title}
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
  );

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{listItems}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>;
}
</code></pre>
<blockquote>
<p><strong>重要</strong>：每个列表项都需要唯一的 <code>key</code> 属性，帮助 React 识别哪些项目发生了变化。</p>
</blockquote>
<hr/>
<h2 data-id="heading-20">七、响应事件</h2>
<p>在组件内部声明<strong>事件处理函数</strong>来响应事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'你点击了我！'</span>);
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>
      点击我
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：<code>onClick={handleClick}</code> 末尾没有括号！只传递函数引用，而不是调用它。React 会在用户点击时调用你的事件处理函数。</p>
</blockquote>
<h3 data-id="heading-21">事件绑定方式</h3>
<ul>
<li><strong>冒泡阶段</strong>：<code>onClick</code></li>
<li><strong>捕获阶段</strong>：<code>onClickCapture</code></li>
</ul>
<h3 data-id="heading-22">事件方法</h3>
<ul>
<li><code>event.stopPropagation()</code> - 阻止事件传播</li>
<li><code>event.preventDefault()</code> - 阻止默认行为（如 a 标签跳转）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EventDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">childBubble</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子节点冒泡'</span>);
    event.<span class="hljs-title function_">stopPropagation</span>();
  }

  clickLink = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    event.<span class="hljs-title function_">preventDefault</span>();
  }
}
</code></pre>
<h3 data-id="heading-23">事件执行顺序</h3>
<p>React 事件系统和原生事件系统是独立的，执行顺序：</p>
<ol>
<li>React 捕获阶段</li>
<li>React 冒泡阶段</li>
<li>原生捕获阶段</li>
<li>原生冒泡阶段</li>
</ol>
<hr/>
<h2 data-id="heading-24">八、状态管理</h2>
<p>组件使用**状态（State）**来"记忆"信息并显示它。</p>
<h3 data-id="heading-25">类组件状态</h3>
<h4 data-id="heading-26">初始化状态</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方式1：在构造函数中</span>
<span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-variable language_">super</span>(props);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { <span class="hljs-attr">number</span>: <span class="hljs-number">0</span> };
}

<span class="hljs-comment">// 方式2：类属性（推荐）</span>
state = { <span class="hljs-attr">number</span>: <span class="hljs-number">0</span> };
</code></pre>
<h4 data-id="heading-27">setState 更新状态</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 对象方式</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">number</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> });

<span class="hljs-comment">// 函数方式（推荐，可基于旧状态计算新状态）</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(<span class="hljs-function">(<span class="hljs-params">prevState</span>) =&gt;</span> ({ <span class="hljs-attr">number</span>: prevState.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> }));

<span class="hljs-comment">// 带回调的 setState</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(
  <span class="hljs-function">(<span class="hljs-params">prevState</span>) =&gt;</span> ({ <span class="hljs-attr">number</span>: prevState.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> }),
  <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"State updated!"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span>);
  }
);
</code></pre>
<h3 data-id="heading-28">useState Hook</h3>
<p>在函数组件中添加状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>
      点击了 {count} 次
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li><code>count</code>：当前状态值</li>
<li><code>setCount</code>：更新状态的函数</li>
<li><code>useState(0)</code>：初始值为 0</li>
</ul>
<h3 data-id="heading-29">函数式更新（推荐）</h3>
<p>当新状态依赖于旧状态时，使用函数式更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-30">setState 的异步与批量更新</h3>
<h4 data-id="heading-31">React 17</h4>
<ul>
<li><strong>异步批量更新</strong>：在事件处理器、生命周期函数中，多个 <code>setState</code> 会被合并</li>
<li><strong>同步更新</strong>：在 setTimeout、Promise 等无法管理的场景中是同步的</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">handleClick = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">number</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> });  <span class="hljs-comment">// 批量合并</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);  <span class="hljs-comment">// 未更新</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">number</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> });  <span class="hljs-comment">// 批量合并</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);  <span class="hljs-comment">// 未更新</span>

  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">number</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> });  <span class="hljs-comment">// 同步更新</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);  <span class="hljs-comment">// 已更新</span>
  });
}
</code></pre>
<h4 data-id="heading-32">React 18</h4>
<p>无论在什么场景，<code>setState</code> 都是批量的</p>
<hr/>
<h2 data-id="heading-33">九、Hooks 规则</h2>
<ul>
<li><strong>只在顶层调用</strong>：不要在循环、条件或嵌套函数中调用 Hooks</li>
<li><strong>只在 React 函数中调用</strong>：在 React 函数组件或自定义 Hook 中调用</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// ❌ 错误</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (condition) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 不要这样做</span>
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-34">十、组件间共享数据</h2>
<h3 data-id="heading-35">问题：各自独立的状态</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 每个按钮有自己独立的 count</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-36">解决：提升状态</h3>
<p>将状态提升到最近的共同父组件，通过 props 传递：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>计数器一起更新<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{count}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{count}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params">{ count, onClick }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span>&gt;</span>
      点击了 {count} 次
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<p>这就是"提升状态（Lifting State Up）"的概念。</p>
<hr/>
<h2 data-id="heading-37">十一、常用 Hooks 详解</h2>
<h3 data-id="heading-38">useState - 状态管理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

<span class="hljs-comment">// 函数式更新</span>
<span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>);
</code></pre>
<h3 data-id="heading-39">useReducer - 复杂状态管理</h3>
<p>复杂状态管理，类似 Redux：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> initialState = { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> };

<span class="hljs-keyword">function</span> <span class="hljs-title function_">reducer</span>(<span class="hljs-params">state, action</span>) {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'ADD'</span>:
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> };
    <span class="hljs-keyword">case</span> <span class="hljs-string">'MINUS'</span>:
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - <span class="hljs-number">1</span> };
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
}

<span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, initialState);
<span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'ADD'</span> });
</code></pre>
<h3 data-id="heading-40">useEffect - 副作用处理</h3>
<p>处理副作用，替代类组件的生命周期：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 相当于 componentDidMount</span>
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> count + <span class="hljs-number">1</span>);
  }, <span class="hljs-number">1000</span>);

  <span class="hljs-comment">// 返回清理函数，相当于 componentWillUnmount</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">clearInterval</span>(timer);
  };
}, []); <span class="hljs-comment">// 空依赖数组 = 只执行一次</span>

<span class="hljs-comment">// 带依赖的 effect</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 当 count 变化时执行</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Count changed:'</span>, count);
}, [count]);
</code></pre>
<h3 data-id="heading-41">useContext - 跨组件共享数据</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-string">'defaultValue'</span>);

<span class="hljs-comment">// 提供数据</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">MyContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"hello"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">MyContext.Provider</span>&gt;</span></span>

<span class="hljs-comment">// 消费数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">MyContext</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-42">useMemo - 缓存计算结果</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> displayData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({ count }), [count]);
</code></pre>
<h3 data-id="heading-43">useCallback - 缓存回调函数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> incrementCount = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> count + <span class="hljs-number">1</span>);
}, [count]);
</code></pre>
<h3 data-id="heading-44">useRef - 引用 DOM</h3>
<p>在函数组件中创建 ref：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);  <span class="hljs-comment">// {current: null}</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">focusInput</span>(<span class="hljs-params"/>) {
  inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();
}

&lt;input ref={inputRef} /&gt;
</code></pre>
<h3 data-id="heading-45">useImperativeHandle - 自定义 ref 暴露</h3>
<p>自定义 ref 暴露给父组件的实例值：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FancyInput</span>(<span class="hljs-params">props, ref</span>) {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>();

  <span class="hljs-title function_">useImperativeHandle</span>(ref, <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-title function_">focus</span>(<span class="hljs-params"/>) {
      inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();
    }
  }));

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span> /&gt;</span></span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ForwardFancyInput</span> = <span class="hljs-title function_">forwardRef</span>(<span class="hljs-title class_">FancyInput</span>);
</code></pre>
<h3 data-id="heading-46">useLayoutEffect - 同步副作用</h3>
<p>同步执行副作用，在 DOM 变更后同步调用（阻塞浏览器绘制）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 在浏览器绘制之前执行</span>
  ref.<span class="hljs-property">current</span>.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translate(500px)`</span>;
}, []);
</code></pre>
<hr/>
<h2 data-id="heading-47">十二、Ref 引用</h2>
<h3 data-id="heading-48">createRef（类组件）</h3>
<p>用于访问 DOM 元素或类组件实例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RefComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  inputRef = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createRef</span>(); <span class="hljs-comment">// {current: null}</span>

  handleButtonClick = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputRef</span>.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();  <span class="hljs-comment">// 访问真实 DOM</span>
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.inputRef}</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.handleButtonClick}</span>&gt;</span>获得焦点<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
  }
}
</code></pre>
<h3 data-id="heading-49">访问类组件实例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ParentComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  childRef = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createRef</span>();

  handleClick = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">childRef</span>.<span class="hljs-property">current</span>.<span class="hljs-title function_">alertMessage</span>();  <span class="hljs-comment">// 调用子组件方法</span>
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.childRef}/</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
  }
}
</code></pre>
<h3 data-id="heading-50">forwardRef（转发 ref）</h3>
<p>函数组件默认不能接收 ref，需要使用 <code>forwardRef</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChildComponent</span>(<span class="hljs-params">props, forwardRef</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{forwardRef}/</span>&gt;</span></span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ForwardChildComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">forwardRef</span>(<span class="hljs-title class_">ChildComponent</span>);
</code></pre>
<hr/>
<h2 data-id="heading-51">十三、Context 上下文</h2>
<p>用于跨组件层级共享数据，避免层层传递 props</p>
<h3 data-id="heading-52">创建 Context</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-string">'defaultValue'</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Provider</span>, <span class="hljs-title class_">Consumer</span> } = <span class="hljs-title class_">MyContext</span>;
</code></pre>
<h3 data-id="heading-53">使用 Context</h3>
<h4 data-id="heading-54">Provider 提供数据</h4>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Provider</span> value={contextValue}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span>/&gt;</span></span>
&lt;/<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Provider</span>&gt;
</code></pre>
<h4 data-id="heading-55">Consumer 消费数据（函数组件）</h4>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Consumer</span>&gt;
  {<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>}
&lt;/<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Consumer</span>&gt;
</code></pre>
<h4 data-id="heading-56">类组件使用 contextType</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClassComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-keyword">static</span> contextType = <span class="hljs-title class_">MyContext</span>;
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{this.context}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
}
</code></pre>
<h3 data-id="heading-57">多个 Context</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">BorderProvider</span> value={borderValue}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ColorProvider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{colorValue}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ColorProvider</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">BorderProvider</span>&gt;
</code></pre>
<h3 data-id="heading-58">Context 嵌套规则</h3>
<p>Consumer 会读取最近的 Provider 的值</p>
<hr/>
<h2 data-id="heading-59">十四、性能优化</h2>
<h3 data-id="heading-60">shouldComponentUpdate</h3>
<p>通过返回布尔值控制组件是否更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">shouldComponentUpdate</span>(<span class="hljs-params">nextProps, nextState</span>) {
  <span class="hljs-keyword">return</span> nextState.<span class="hljs-property">number</span> % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>; <span class="hljs-comment">// 偶数才更新</span>
}
</code></pre>
<h3 data-id="heading-61">PureComponent</h3>
<p>自动进行浅比较，避免不必要的渲染：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PureComp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.PureComponent</span> {
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{this.props.value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
}
</code></pre>
<h3 data-id="heading-62">React.memo</h3>
<p>用于函数组件的记忆化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MemoCounter</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-title class_">Counter</span>);

<span class="hljs-comment">// 自定义比较函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MemoComp</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-title class_">Comp</span>, <span class="hljs-function">(<span class="hljs-params">prevProps, nextProps</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> prevProps.<span class="hljs-property">value</span> === nextProps.<span class="hljs-property">value</span>;
});
</code></pre>
<h3 data-id="heading-63">性能优化最佳实践</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [username, setUsername] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'zhufeng'</span>);
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 缓存对象</span>
  <span class="hljs-keyword">const</span> displayData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({ count }), [count]);

  <span class="hljs-comment">// 缓存回调函数</span>
  <span class="hljs-keyword">const</span> incrementCount = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> count + <span class="hljs-number">1</span>);
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{username}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setUsername(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">MemoChildButton</span> <span class="hljs-attr">displayData</span>=<span class="hljs-string">{displayData}</span> <span class="hljs-attr">incrementCount</span>=<span class="hljs-string">{incrementCount}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<hr/>
<h2 data-id="heading-64">十五、生命周期（类组件）</h2>
<h3 data-id="heading-65">挂载阶段 (Mounting)</h3>
<ol>
<li><strong>constructor</strong> - 初始化状态</li>
<li><strong>componentWillMount</strong> (已废弃) - 组件将要挂载</li>
<li><strong>render</strong> - 计算虚拟 DOM（纯函数，不能有副作用）</li>
<li><strong>componentDidMount</strong> - 挂载完成，可发起网络请求</li>
</ol>
<h3 data-id="heading-66">更新阶段 (Updating)</h3>
<ol>
<li><strong>componentWillReceiveProps</strong> - 收到新属性（已废弃）</li>
<li><strong>getDerivedStateFromProps</strong> - 从属性派生状态（静态方法）</li>
<li><strong>shouldComponentUpdate</strong> - 决定是否更新（性能优化关键点）</li>
<li><strong>getSnapshotBeforeUpdate</strong> - 获取 DOM 更新前的快照</li>
<li><strong>componentWillUpdate</strong> - 将要更新（已废弃）</li>
<li><strong>render</strong> - 重新计算虚拟 DOM</li>
<li><strong>componentDidUpdate</strong> - 更新完成</li>
</ol>
<h3 data-id="heading-67">卸载阶段 (Unmounting)</h3>
<ul>
<li><strong>componentWillUnmount</strong> - 清理操作（清除定时器、取消网络请求）</li>
</ul>
<h3 data-id="heading-68">新生命周期方法示例</h3>
<h4 data-id="heading-69">getDerivedStateFromProps</h4>
<p>从 props 派生 state：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromProps</span>(<span class="hljs-params">nextProps, prevState</span>) {
  <span class="hljs-keyword">if</span> (nextProps.<span class="hljs-property">itemCount</span> !== prevState.<span class="hljs-property">itemCount</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">itemCount</span>: nextProps.<span class="hljs-property">itemCount</span> };
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 不更新状态</span>
}
</code></pre>
<h4 data-id="heading-70">getSnapshotBeforeUpdate</h4>
<p>获取 DOM 更新前的快照：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">getSnapshotBeforeUpdate</span>(<span class="hljs-params">prevProps, prevState</span>) {
  <span class="hljs-keyword">const</span> list = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listRef</span>.<span class="hljs-property">current</span>;
  <span class="hljs-keyword">return</span> list.<span class="hljs-property">scrollHeight</span>;  <span class="hljs-comment">// 返回更新前的高度</span>
}

<span class="hljs-title function_">componentDidUpdate</span>(<span class="hljs-params">prevProps, prevState, snapshot</span>) {
  <span class="hljs-keyword">const</span> list = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listRef</span>.<span class="hljs-property">current</span>;
  <span class="hljs-comment">// 使用快照计算新的滚动位置</span>
  list.<span class="hljs-property">scrollTop</span> = list.<span class="hljs-property">scrollTop</span> + (list.<span class="hljs-property">scrollHeight</span> - snapshot);
}
</code></pre>
<hr/>
<h2 data-id="heading-71">十六、重要概念</h2>
<h3 data-id="heading-72">合成事件 (SyntheticEvent)</h3>
<p>React 实现的事件系统，与原生事件隔离，跨浏览器兼容。</p>
<h3 data-id="heading-73">批量更新 (Batching)</h3>
<p>React 会将多个状态更新合并为一次渲染，提高性能。</p>
<h3 data-id="heading-74">受控组件与非受控组件</h3>
<ul>
<li><strong>受控组件</strong>：表单元素的值由 React state 控制</li>
<li><strong>非受控组件</strong>：表单元素的值由 DOM 自身控制</li>
</ul>
<h3 data-id="heading-75">组件通信方式</h3>
<ol>
<li><strong>Props</strong> - 父子组件通信</li>
<li><strong>Callback</strong> - 子父组件通信</li>
<li><strong>Context</strong> - 跨层级通信</li>
<li><strong>Redux/Zustand</strong> - 全局状态管理</li>
<li><strong>Event Bus</strong> - 兄弟组件通信</li>
<li><strong>Ref</strong> - 直接访问子组件实例</li>
</ol>
<hr/>
<h2 data-id="heading-76">学习路径建议</h2>
<h3 data-id="heading-77">第一步：掌握基础</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 组件与 JSX</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> Props 传递</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 事件处理</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> useState Hook</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 条件渲染和列表</li>
</ul>
<h3 data-id="heading-78">第二步：深入理解</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> useEffect 副作用处理</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 组件间通信</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> Context 使用</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> useRef 引用</li>
</ul>
<h3 data-id="heading-79">第三步：进阶技能</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 性能优化</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 自定义 Hooks</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 状态管理（useReducer）</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 表单处理</li>
</ul>
<h3 data-id="heading-80">第四步：实战项目</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> React Router 路由</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Redux Toolkit / Zustand</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> React Query 数据请求</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> UI 组件库（Ant Design / Material-UI）</li>
</ul>
<h2 data-id="heading-81">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn" target="_blank" title="https://react.dev/learn" ref="nofollow noopener noreferrer">React 官方文档 - Quick Start</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Fcreating-a-react-app" target="_blank" title="https://react.dev/learn/creating-a-react-app" ref="nofollow noopener noreferrer">React 官方文档 - 创建应用</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Fdescribing-the-ui" target="_blank" title="https://react.dev/learn/describing-the-ui" ref="nofollow noopener noreferrer">React 官方文档 - 描述 UI</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Fadding-interactivity" target="_blank" title="https://react.dev/learn/adding-interactivity" ref="nofollow noopener noreferrer">React 官方文档 - 添加交互</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FLearn_web_development%2FCore%2FFrameworks_libraries%2FReact_getting_started" target="_blank" title="https://developer.mozilla.org/en-US/docs/Learn_web_development/Core/Frameworks_libraries/React_getting_started" ref="nofollow noopener noreferrer">MDN - React 入门</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从怀疑到离不开：我第一个由 AI 深度参与完成的真实项目复盘]]></title>    <link>https://juejin.cn/post/7586622708998996008</link>    <guid>https://juejin.cn/post/7586622708998996008</guid>    <pubDate>2025-12-23T06:44:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586622708998996008" data-draft-id="7586622708998897704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从怀疑到离不开：我第一个由 AI 深度参与完成的真实项目复盘"/> <meta itemprop="keywords" content="OpenAI,前端"/> <meta itemprop="datePublished" content="2025-12-23T06:44:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="命中水"/> <meta itemprop="url" content="https://juejin.cn/user/3614849961851966"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从怀疑到离不开：我第一个由 AI 深度参与完成的真实项目复盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3614849961851966/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    命中水
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:44:26.000Z" title="Tue Dec 23 2025 06:44:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>首先说明，我不是专业的前端工程师。</p>
<p>但这次，我一个人完成了一个包含<strong>聊天窗口、WebSocket 实时推送、多语言翻译、复杂 UI 状态管理</strong>的前端项目。</p>
<p>说实话，如果没有 AI，这个项目我大概率会延期，甚至放弃一些体验上的细节。</p>
<p>这是我第一次，在一个<strong>真实、长期维护、并且已经上线使用的项目</strong>中，深度引入 AI 参与开发。 不是 Demo，不是练手，而是一个我必须为稳定性、性能和可维护性负责的系统。</p>
</blockquote>
<h2 data-id="heading-0">一、前言</h2>
<p>前端时间接了一个前端聊天+后端管理后台的项目，两个项目都是我自己一个人完成。</p>
<p>说起来后端还好，但是前端html+css那套我最开始入行的时候学了一点，但是后面正式工作后主要还是围绕后端语言来展开，前端的那套样式语法就渐渐地放下了；</p>
<p>但这次是一个全新的机会，也是一个新的挑战，需要自己写前端。那如何快速写前端项目，并快速交付呢？于是我想到了AI这个帮手，之前总拿它来排查问题，但是写一个项目行不行呢？ 我抱着怀疑的态度开始了这项“挑战”，并最终“有惊无险”的落地完成，顺利完成交付；</p>
<p>本篇文章，我想详细的复盘下这次经历：如何与AI沟通？ 如何合理利用AI完成代码的实现？以及举例一些聊天系统中实现的业务关键点！</p>
<p>在使用前，先想一下：</p>
<p><strong>AI 到底能帮我们做到什么？我们又该如何与 AI 协作，才能真的提高生产力，而不是制造技术债？</strong></p>
<h2 data-id="heading-1">二、与AI对话</h2>
<h3 data-id="heading-2">2.1 为什么我会把 AI 真正引入一个“正经项目”？</h3>
<p>先说结论： <strong>不是因为“新技术”，而是因为“现实问题”。</strong></p>
<p>我的真实情况</p>
<p>这个项目是一个 <strong>客服聊天系统</strong>，核心特点包括：</p>
<ul>
<li>Laravel 后端处理接口数据</li>
<li>jQuery + Bootstrap 前端（我比较熟悉的是这套组合拳）</li>
<li>多账号、多好友</li>
<li>WebSocket 实时推送</li>
<li>消息类型复杂（文本 / 图片 / 视频 / 语音）</li>
<li>SaaS 场景（多租户）</li>
</ul>
<p>我面临的真实问题是：</p>
<ul>
<li>后端我非常熟</li>
<li>但前端交互复杂、状态多、样式细</li>
<li>每一个“小交互”都很耗时间</li>
<li>而项目又在持续迭代，<strong>不能停下来重构</strong></li>
</ul>
<p>👉 这时，AI 不再是“锦上添花”，而是<strong>降低边际成本的工具</strong>。</p>
<hr/>
<h3 data-id="heading-3">2.2 AI 开发入门：不要幻想“全自动”，要追求“人机协作”</h3>
<h4 data-id="heading-4">2.2.1 AI 最适合做什么？</h4>
<p>在这次项目中，我给 AI 的定位非常清晰：</p>
<blockquote>
<p><strong>AI = 前端协作工程师</strong></p>
</blockquote>
<p>基于我当时的情况，我给它的定时是，辅助帮我写前端代码，包括但不限于以下：</p>
<ul>
<li>UI 结构拆解</li>
<li>JS 事件逻辑补全</li>
<li>CSS 微调与重构</li>
<li>复杂 DOM 操作的示例实现</li>
<li>重复性、模式化代码生成</li>
</ul>
<p>结合我使用之后的感觉，我认为他可能<strong>不太适合</strong>：</p>
<ul>
<li>定业务边界</li>
<li>定核心数据结构</li>
<li>决定架构选型</li>
<li>性能极限设计</li>
</ul>
<p><strong>这些必须由人来做。</strong></p>
<h4 data-id="heading-5">2.2.2 心态非常重要：你不是“用 AI”，而是在“带 AI”</h4>
<p>如果你把 AI 当成：</p>
<ul>
<li>“自动写代码工具”</li>
<li>“一句话生成系统”</li>
</ul>
<p>那你一定会失望。</p>
<p>但如果你把 AI 当成：</p>
<ul>
<li>一个不抱怨的工程师</li>
<li>一个愿意反复改的搭子</li>
<li>一个可以随时请教的助手</li>
</ul>
<p>你会发现它<strong>非常好用</strong>。</p>
<hr/>
<h3 data-id="heading-6">2.3 如何与 AI 沟通，才能真的把前端项目做出来？</h3>
<p>这一节，是我整篇文章里最想聊的部分。</p>
<h4 data-id="heading-7">2.3.1 关键原则一：给 AI “现有代码”，而不是“空需求”</h4>
<p>❌ 错误方式：</p>
<blockquote>
<p>帮我写一个聊天窗口</p>
</blockquote>
<p>✅ 正确方式：</p>
<blockquote>
<p>这是我现有的 HTML 结构 这是我的 JS 方法 这是我的业务规则 请在不破坏现有结构的前提下，实现功能 X</p>
</blockquote>
<p>AI 的代码质量，<strong>严重依赖上下文完整度</strong>。</p>
<p><strong>PS：如果你是从0开始让AI帮你完成项目，那最好在同一个人聊天窗口下，如果切换了聊天窗口，那可能会导致以前的消息可能无法产生关联；如果要优化，最好贴上之前的代码！</strong></p>
<hr/>
<h4 data-id="heading-8">2.3.2 关键原则二：需求要“具象”，不要“抽象”</h4>
<p>比如我会这样描述 UI：</p>
<blockquote>
<p>聊天窗口顶部： 左侧是头像 + 昵称 右侧是三个点按钮 点击后，从“聊天窗口右侧”滑出信息面板 而不是整个页面</p>
</blockquote>
<p>你会发现：<strong>我描述的是“画面”，不是“功能名词”。</strong></p>
<h4 data-id="heading-9">2.3.3 关键原则三：有问题就“精准反馈”，不要一句否定</h4>
<p>我在项目中经常这样和 AI 互动：</p>
<ul>
<li>“三个点按钮没有靠右”</li>
<li>“事件绑定不到，因为是动态元素”</li>
<li>“滑出层相对于 body 了，不是 chat-panel”</li>
</ul>
<p>这种反馈，会让 AI <strong>快速修正，而不是推倒重来</strong>。</p>
<h4 data-id="heading-10">2.3.4 一个我踩过的坑：AI 会“自信地写错”</h4>
<p>AI不是万能的，它也有可能出错，你的描述词不清晰，代码未提供完整，就可能导致：</p>
<ul>
<li>CSS 看起来对，但层级错了</li>
<li>JS 逻辑跑得通，但状态没覆盖</li>
<li>WebSocket 示例是 Demo 级，不是生产级</li>
</ul>
<p>所以我后来形成了一个习惯：<strong>AI负责“给方案”，我负责“兜底校验”！</strong></p>
<h2 data-id="heading-11">三、项目功能关键点拆解示例</h2>
<h3 data-id="heading-12">3.1 关键功能点一：前后端聊天消息推送</h3>
<h4 data-id="heading-13">3.1.1 后端整体设计思路</h4>
<p>我采用的是：</p>
<ul>
<li><strong>Workerman / GatewayWorker</strong></li>
<li>后端消息统一入库</li>
<li>再推送 WebSocket 给前端</li>
</ul>
<p>核心原则是：</p>
<blockquote>
<p><strong>消息以“后端为准”，前端只是展示层</strong></p>
</blockquote>
<hr/>
<p>我设计的流程是，后端采用脚本监听第三方消息服务，监听到有消息之后推送到job，job中处理消息，代码如下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
​
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Jobs</span>;
​
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">YkAccountFriendChatRecordRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">YkAccountFriendRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">YkAccountRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">GatewayService</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">InstagramMessageService</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">TranslateService</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Bus</span>\<span class="hljs-title">Queueable</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Queue</span>\<span class="hljs-title">ShouldQueue</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Bus</span>\<span class="hljs-title">Dispatchable</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Queue</span>\<span class="hljs-title">InteractsWithQueue</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Queue</span>\<span class="hljs-title">SerializesModels</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">DB</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Log</span>;
​
<span class="hljs-comment">/**
 * 处理mqtt消息
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessIncomingMqttMessage</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span>
</span>{
    <span class="hljs-keyword">use</span> <span class="hljs-title">Dispatchable</span>, <span class="hljs-title">InteractsWithQueue</span>, <span class="hljs-title">Queueable</span>, <span class="hljs-title">SerializesModels</span>;
​
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$payload</span>;
​
    <span class="hljs-comment">/**
     * Create a new job instance.
     *
     * <span class="hljs-doctag">@return</span> void
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$payload</span></span>)
    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;payload = <span class="hljs-variable">$payload</span>;
    }
​
    <span class="hljs-comment">/**
     * Execute the job.
     *
     * <span class="hljs-doctag">@return</span> void
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"/>)
    </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;payload[<span class="hljs-string">'PK'</span>]) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">'缺少PK！'</span>);
            }
            <span class="hljs-variable">$accountKey</span> = <span class="hljs-variable language_">$this</span>-&gt;payload[<span class="hljs-string">'PK'</span>];
            <span class="hljs-variable">$account</span> = <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">firstWhere</span>([<span class="hljs-string">'account_key'</span> =&gt; <span class="hljs-variable">$accountKey</span>, <span class="hljs-string">'status'</span> =&gt; <span class="hljs-title class_">YkAccountRepository</span>::<span class="hljs-variable constant_">STATUS_ENABLE</span>]);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$account</span>)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">"account_key：<span class="hljs-subst">{$accountKey}</span>对应的account数据不存在"</span>);
            }
​
            <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$this</span>-&gt;payload[<span class="hljs-string">'Payload'</span>]) || !<span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$this</span>-&gt;payload[<span class="hljs-string">'Payload'</span>])) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">'payload数据异常！'</span>);
            }
            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;payload[<span class="hljs-string">'Payload'</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) {
                <span class="hljs-comment">/**
                 * UserId 发送方id
                 * RealTimeOp 类型
                 * Text 文本类型是内容字段
                 * Media 媒体类型时字段
                 */</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$value</span>[<span class="hljs-string">'UserId'</span>])) {
                    <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'payload中没有UserId：'</span>  . <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$value</span>));
                    <span class="hljs-keyword">continue</span>;
                }
​
                <span class="hljs-variable">$friend</span> = <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">firstWhere</span>([<span class="hljs-string">'pks'</span> =&gt; <span class="hljs-variable">$value</span>[<span class="hljs-string">'UserId'</span>], <span class="hljs-string">'account_id'</span> =&gt; <span class="hljs-variable">$account</span>[<span class="hljs-string">'id'</span>]]);
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$friend</span>)) {
                    <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">"pks：<span class="hljs-subst">{$value['UserId']}</span>在好友表中不存在！"</span>);
                    <span class="hljs-keyword">continue</span>;
                }
​
                <span class="hljs-variable">$contentType</span> = <span class="hljs-title class_">InstagramMessageService</span>::<span class="hljs-title function_ invoke__">transContentType</span>(<span class="hljs-variable">$value</span>);
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$contentType</span>)) {
                    <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">warning</span>(<span class="hljs-string">'ProcessIncomingMqttMessage - handle 未知的消息类型'</span> . <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$value</span>));
                    <span class="hljs-keyword">continue</span>;
                }
​
                <span class="hljs-variable">$sendTime</span> = <span class="hljs-title function_ invoke__">transMicrosecondTimestamp</span>(<span class="hljs-variable">$value</span>[<span class="hljs-string">'TimeStampUnix'</span>]);
​
                <span class="hljs-variable">$data</span> = [
                    <span class="hljs-string">'customer_id'</span>       =&gt; <span class="hljs-variable">$account</span>[<span class="hljs-string">'belong_customer_id'</span>],
                    <span class="hljs-string">'account_id'</span>        =&gt; <span class="hljs-variable">$account</span>[<span class="hljs-string">'id'</span>],
                    <span class="hljs-string">'friend_id'</span>         =&gt; <span class="hljs-variable">$friend</span>[<span class="hljs-string">'id'</span>],
                    <span class="hljs-string">'content'</span>           =&gt; <span class="hljs-variable">$value</span>[<span class="hljs-string">'Text'</span>] ?? <span class="hljs-literal">null</span>,
                    <span class="hljs-string">'content_type'</span>      =&gt; <span class="hljs-variable">$contentType</span>,
                    <span class="hljs-string">'attachment'</span>        =&gt; <span class="hljs-title class_">InstagramMessageService</span>::<span class="hljs-title function_ invoke__">getAttachment</span>(<span class="hljs-variable">$contentType</span>, <span class="hljs-variable">$value</span>),
                    <span class="hljs-string">'item_id'</span>           =&gt; <span class="hljs-variable">$value</span>[<span class="hljs-string">'ItemId'</span>],
                    <span class="hljs-string">'send_time'</span>         =&gt; <span class="hljs-title function_ invoke__">transMicrosecondTimestamp</span>(<span class="hljs-variable">$value</span>[<span class="hljs-string">'TimeStampUnix'</span>]),
                    <span class="hljs-string">'send_status'</span>       =&gt; <span class="hljs-title class_">YkAccountFriendChatRecordRepository</span>::<span class="hljs-variable constant_">STATUS_SUCCESS</span>
                ];
                
                <span class="hljs-comment">// 如果是文本类型 获取翻译之后的数据</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$contentType</span> == <span class="hljs-title class_">YkAccountFriendChatRecordRepository</span>::<span class="hljs-variable constant_">CONTENT_TYPE_TEXT</span>) {
                    <span class="hljs-variable">$transContent</span> = <span class="hljs-title class_">TranslateService</span>::<span class="hljs-title function_ invoke__">getChatMessageTranslate</span>(<span class="hljs-variable">$account</span>[<span class="hljs-string">'belong_customer_id'</span>], <span class="hljs-variable">$value</span>[<span class="hljs-string">'Text'</span>]);
                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$transContent</span> &amp;&amp; (<span class="hljs-variable">$transContent</span> != <span class="hljs-variable">$value</span>[<span class="hljs-string">'Text'</span>])) {
                        <span class="hljs-variable">$data</span>[<span class="hljs-string">'is_translate'</span>] = <span class="hljs-title class_">YkAccountFriendChatRecordRepository</span>::<span class="hljs-variable constant_">CONTENT_TRANSLATE</span>;
                        <span class="hljs-variable">$data</span>[<span class="hljs-string">'content_translate'</span>] = <span class="hljs-variable">$transContent</span>;
                    }
                }
​
                DB::<span class="hljs-title function_ invoke__">beginTransaction</span>();
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-variable">$record</span> = <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountFriendChatRecordRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">updateOrCreate</span>([<span class="hljs-string">'item_id'</span> =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'item_id'</span>]], <span class="hljs-variable">$data</span>);
                    <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">updateLastChatTime</span>(<span class="hljs-variable">$friend</span>[<span class="hljs-string">'id'</span>], <span class="hljs-variable">$sendTime</span>);
                    <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">updateLastChatTime</span>(<span class="hljs-variable">$account</span>[<span class="hljs-string">'id'</span>], <span class="hljs-variable">$sendTime</span>);
                    DB::<span class="hljs-title function_ invoke__">commit</span>();
                } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) {
                    DB::<span class="hljs-title function_ invoke__">rollBack</span>();
                    <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'ProcessIncomingMqttMessage handle 落库失败，异常原因：'</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>());
                    <span class="hljs-keyword">continue</span>;
                }
                <span class="hljs-variable">$data</span>[<span class="hljs-string">'message_id'</span>] = <span class="hljs-variable">$record</span>-&gt;id;
​
                <span class="hljs-title class_">GatewayService</span>::<span class="hljs-title function_ invoke__">pushMessageToClient</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$friend</span>);
                <span class="hljs-comment">// 自动回复消息</span>
                <span class="hljs-title function_ invoke__">dispatch</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SendAutoReplyMessageJob</span>(<span class="hljs-variable">$record</span>-&gt;id))-&gt;<span class="hljs-title function_ invoke__">onConnection</span>(<span class="hljs-string">'redis'</span>)-&gt;<span class="hljs-title function_ invoke__">onQueue</span>(<span class="hljs-string">'SendAutoReplyMessageSqs'</span>);
            }
        } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) {
            <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-string">'ProcessIncomingMqttMessage fail line:'</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getLine</span>() . <span class="hljs-string">' 报错信息：'</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>(), [<span class="hljs-string">'payload'</span> =&gt; <span class="hljs-variable">$this</span>-&gt;payload]);
        }
    }
}
</code></pre>
<p><code>GatewayService</code>类的<code>pushMessageToClient</code>方法代码如下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pushMessageToClient</span>(<span class="hljs-params"><span class="hljs-variable">$data</span>, <span class="hljs-variable">$friend</span></span>)
</span>{
    <span class="hljs-variable">$gatewayHost</span> = <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'services.gateway.host'</span>, <span class="hljs-string">'127.0.0.1'</span>);
    <span class="hljs-variable">$gatewayPort</span> = <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'services.gateway.port'</span>, <span class="hljs-string">'1238'</span>);
​
    <span class="hljs-title class_">Gateway</span>::<span class="hljs-variable">$registerAddress</span> = <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-string">'%s:%s'</span>, <span class="hljs-variable">$gatewayHost</span>, <span class="hljs-variable">$gatewayPort</span>);
​
    <span class="hljs-variable">$sendData</span> = [
        <span class="hljs-string">'account_id'</span>    =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'account_id'</span>],
        <span class="hljs-string">'friend_id'</span>     =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'friend_id'</span>],
        <span class="hljs-string">'friend_name'</span>   =&gt; <span class="hljs-variable">$friend</span>[<span class="hljs-string">'username'</span>],
        <span class="hljs-string">'friend_avatar'</span> =&gt; <span class="hljs-variable">$friend</span>[<span class="hljs-string">'avatar'</span>],
        <span class="hljs-string">'send_time'</span>     =&gt; <span class="hljs-title function_ invoke__">format_time</span>(<span class="hljs-variable">$data</span>[<span class="hljs-string">'send_time'</span>]),
        <span class="hljs-string">'timestamp'</span>     =&gt; <span class="hljs-title function_ invoke__">format_time</span>(<span class="hljs-literal">null</span>),
        <span class="hljs-string">'content'</span>       =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'content'</span>],
        <span class="hljs-string">'attachment'</span>    =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'attachment'</span>],
        <span class="hljs-string">'content_type'</span>  =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'content_type'</span>],
        <span class="hljs-string">'message_id'</span>    =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'message_id'</span>],
        <span class="hljs-string">'is_me'</span>         =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'is_me'</span>] ?? <span class="hljs-literal">false</span>,
        <span class="hljs-string">'is_auto_reply'</span> =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'is_auto_reply'</span>] ?? <span class="hljs-literal">false</span>,
    ];
​
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$sendData</span>[<span class="hljs-string">'is_me'</span>]) {
        <span class="hljs-comment">// 不管客服有没有在线 先标记账号和好友 有未读数据（从前端去处理已读）</span>
        <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">update</span>([<span class="hljs-string">'is_have_un_read_msg'</span> =&gt; <span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable constant_">HAVE_UN_READ_MSG</span>], <span class="hljs-variable">$friend</span>[<span class="hljs-string">'id'</span>]);
        <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">update</span>([<span class="hljs-string">'is_have_un_read_msg'</span> =&gt; <span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable constant_">HAVE_UN_READ_MSG</span>], <span class="hljs-variable">$data</span>[<span class="hljs-string">'account_id'</span>]);
    }
​
    <span class="hljs-comment">// 判断当前客服是否在线</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Gateway</span>::<span class="hljs-title function_ invoke__">isUidOnline</span>(<span class="hljs-variable">$data</span>[<span class="hljs-string">'customer_id'</span>])) {
        <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'推送到客户端信息'</span>, [<span class="hljs-string">'customer_id'</span> =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'customer_id'</span>], <span class="hljs-string">'data'</span> =&gt; <span class="hljs-title function_ invoke__">json_encode</span>([
            <span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'new_message'</span>,
            <span class="hljs-string">'data'</span> =&gt; <span class="hljs-variable">$sendData</span>
        ])]);
        <span class="hljs-comment">// 发送消息给客服</span>
        <span class="hljs-title class_">Gateway</span>::<span class="hljs-title function_ invoke__">sendToUid</span>(<span class="hljs-variable">$data</span>[<span class="hljs-string">'customer_id'</span>], <span class="hljs-title function_ invoke__">json_encode</span>([
            <span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'new_message'</span>,
            <span class="hljs-string">'data'</span> =&gt; <span class="hljs-variable">$sendData</span>
        ]));
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">"客服id：<span class="hljs-subst">{$data['customer_id']}</span>，未在线~"</span>, [<span class="hljs-string">'send_data'</span> =&gt; <span class="hljs-variable">$sendData</span>]);
    }
}
</code></pre>
<p>这个方法多个地方都可以调用，比如：</p>
<ul>
<li>接收到消息推送到前端</li>
<li>前端发送消息，后端推送到第三方成功，发送到前端回显</li>
<li>自动回复消息成功，发送到前端回显</li>
<li>...</li>
</ul>
<h4 data-id="heading-14">3.1.2 后端推送的数据结构</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"account_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">123456</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"friend_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">789012</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"friend_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"张三"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"friend_avatar"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://example.com/avatar.jpg"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"send_time"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2023-10-15 14:30:25"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2023-10-15 16:45:10"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你好，最近怎么样？"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"attachment"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image_001.jpg"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"content_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"message_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"msg_20231015143025_123456"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"is_me"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"is_auto_reply"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-15">3.1.3 前端接收消息</h4>
<p>绑定并监听websocket</p>
<pre><code class="hljs language-ini" lang="ini">// 绑定 WebSocket
function connectWebSocket() {
    if (!CUSTOMER_ID) {
        console.error('未设置客服ID，无法连接WebSocket')<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
    }
    // 清除之前的重连定时器
    if (reconnectTimer) {
        clearTimeout(reconnectTimer)<span class="hljs-comment">;</span>
        <span class="hljs-attr">reconnectTimer</span> = null<span class="hljs-comment">;</span>
    }
​
    <span class="hljs-attr">ws</span> = new WebSocket(window.WEBSECKET_HOST)<span class="hljs-comment">; // 改成你的服务地址</span>
​
    <span class="hljs-attr">ws.onopen</span> = function () {
        console.log('WebSocket 已连接')<span class="hljs-comment">;</span>
        <span class="hljs-attr">lastPongTime</span> = Date.now()<span class="hljs-comment">; // 连接建立时重置时间</span>
        <span class="hljs-attr">reconnectAttempts</span> = <span class="hljs-number">0</span><span class="hljs-comment">; // 重置计数器</span>
​
        // 绑定客服登录用户ID
        ws.send(JSON.stringify({
            type: 'bind',
            uid: CUSTOMER_ID
        }))<span class="hljs-comment">;</span>
        // 启动心跳检测
        startHeartbeatCheck()<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
​
    <span class="hljs-attr">ws.onmessage</span> = function (event) {
        console.log('收到消息：', event.data)<span class="hljs-comment">;</span>
        let <span class="hljs-attr">msg</span> = {}<span class="hljs-comment">;</span>
        try {
            <span class="hljs-attr">msg</span> = JSON.parse(event.data)<span class="hljs-comment">;</span>
        } catch (e) {
            console.warn('收到非法消息', event.data)<span class="hljs-comment">;</span>
            return<span class="hljs-comment">;</span>
        }
​
        if (<span class="hljs-attr">msg.type</span> === <span class="hljs-string">'ping'</span>) {
            // 服务器心跳包，更新最后活跃时间并回复pong
            <span class="hljs-attr">lastPongTime</span> = Date.now()<span class="hljs-comment">;</span>
            // 服务器心跳包，回复pong
            ws.send(JSON.stringify({type: 'pong'}))<span class="hljs-comment">;</span>
            return<span class="hljs-comment">;</span>
        }
​
        if (<span class="hljs-attr">msg.type</span> === <span class="hljs-string">'new_message'</span>) {
            console.log('收到new_message消息：', msg.data)<span class="hljs-comment">;</span>
            handleIncomingMessage(msg.data)<span class="hljs-comment">;</span>
        }
​
        if (<span class="hljs-attr">msg.type</span> === <span class="hljs-string">'account_online_status'</span>) {
            const <span class="hljs-attr">data</span> = msg.data<span class="hljs-comment">;</span>
            console.log('收到account_online_status消息：', msg.data)<span class="hljs-comment">;</span>
            updateAccountOnlineStatus(data)<span class="hljs-comment">;</span>
        }
​
        if (<span class="hljs-attr">msg.type</span> === <span class="hljs-string">'send_message_status'</span>) {
            console.log('收到send_message_status消息：', msg.data)<span class="hljs-comment">;</span>
            const <span class="hljs-attr">data</span> = msg.data<span class="hljs-comment">;</span>
            // updateFriendOnlineStatus(data)<span class="hljs-comment">;</span>
​
            updateMessageSendStatus(data)
        }
    }<span class="hljs-comment">;</span>
​
    <span class="hljs-attr">ws.onclose</span> = function () {
        reconnectAttempts++<span class="hljs-comment">;</span>
​
        // 渐进式重连：前3次快速重连，后续采用退避策略
        const <span class="hljs-attr">delay</span> = reconnectAttempts &lt;= <span class="hljs-number">3</span> ?
            BASE_DELAY :
            Math.min(BASE_DELAY * Math.pow(1.5, reconnectAttempts - 3), MAX_DELAY)<span class="hljs-comment">;</span>
​
        console.warn(`<span class="hljs-section">[第${reconnectAttempts}次重连]</span> ${delay}ms后尝试...`)<span class="hljs-comment">;</span>
        setTimeout(connectWebSocket, delay)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
​
    <span class="hljs-attr">ws.onerror</span> = function (e) {
        console.error('WebSocket 发生错误')<span class="hljs-comment">;</span>
        console.error('WS错误代码:', e.code)<span class="hljs-comment">;</span>
        console.error('WS错误原因:', e.reason)<span class="hljs-comment">;</span>
        ws.close()<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
}
​
/**
 * 新消息处理
 * @param msg
 */
function handleIncomingMessage(msg) {
    console.log('handleIncomingMessage', msg)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">currentAccountId</span> = state.currentAccountId<span class="hljs-comment">;</span>
    const <span class="hljs-attr">currentFriendId</span> = state.currentFriendId<span class="hljs-comment">;</span>
​
    if (<span class="hljs-attr">msg.account_id</span> === currentAccountId) {
        if (<span class="hljs-attr">msg.friend_id</span> === currentFriendId) {
            // 当前聊天窗口好友，追加消息
            appendMessage({
                me: msg.is_me || false,
                auto_reply: msg.is_auto_reply || false,
                name: msg.friend_name,
                avatar: msg.friend_avatar,
                timestamp: msg.timestamp,
                send_time: msg.send_time,
                content: msg.content,
                attachment: msg.attachment,
                id: msg.message_id,
                type: getContentType(msg.content_type)
            })<span class="hljs-comment">;</span>
            // 如果当前消息是当前聊天好友的，标记好友状态为已读
            setFriendUnReadStatus(msg.friend_id, 0)<span class="hljs-comment">;</span>
            translateVisibleMessages($('select<span class="hljs-section">[name="input_target_lang"]</span>').val(), 'left')<span class="hljs-comment">;</span>
        } else {
            // 当前账号的其他好友，标红点
            markFriendUnreadDot(msg.friend_id, msg.account_id)<span class="hljs-comment">;</span>
        }
    } else {
        // 非当前账号，账号头像标红点
        markAccountUnreadDot(msg.account_id)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>这个这段逻辑主要包括：</p>
<ul>
<li>当前聊天窗口实时追加消息</li>
<li>非当前好友 → 好友红点</li>
<li>非当前账号 → 账号红点</li>
</ul>
<p>这里之所以要在前端判断account_id /friend_id，而不是后端分多钟类型推是因为：</p>
<ul>
<li>降低后端推送负责度，而且我觉得在前端判断会更好</li>
<li>保证前端状态一致性</li>
<li>方便后续扩展更多UI状态</li>
</ul>
<hr/>
<h3 data-id="heading-16">3.2 关键功能点二：中英文切换与“批量翻译”的实现思路</h3>
<p>这是一个让我非常满意、也非常适合 AI 协作的功能。</p>
<h4 data-id="heading-17">3.2.1 我的需求不是“翻译一条消息”</h4>
<p>而是：</p>
<ul>
<li>聊天窗口已有历史消息</li>
<li>切换语言后</li>
<li><strong>原文不变</strong></li>
<li>原文下方显示译文</li>
<li>支持再次切换目标语言</li>
</ul>
<hr/>
<h4 data-id="heading-18">3.2.2 前端结构设计（AI 协助）</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"chat-message-bubble"</span>&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"original-text"</span>&gt;Hello&lt;/div&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"translated-text text-muted small"</span>&gt;你好&lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>AI 在这里给了我一个很重要的建议：</p>
<blockquote>
<p>翻译内容不要覆盖原文，而是“附加”</p>
</blockquote>
<p>如果一开始就让 AI 覆盖原文，后期做多语言切换、撤销翻译、重新翻译，都会非常痛苦。这让体验和可维护性都好很多。</p>
<h4 data-id="heading-19">3.2.3 切换语言时的 JS 逻辑</h4>
<pre><code class="hljs language-ini" lang="ini">// Tab 切换事件
$("<span class="hljs-comment">#collapseTranslate").on('change', '.translate-select', function () {</span>
    let <span class="hljs-attr">name</span> = $(this).attr(<span class="hljs-string">'name'</span>)<span class="hljs-comment">;</span>
    let value<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">name</span> === <span class="hljs-string">'chat_message_auto_translate'</span> || name === <span class="hljs-string">'input_auto_translate'</span>) {
        const <span class="hljs-attr">isChecked</span> = $(this).is(<span class="hljs-string">':checked'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">value</span> = isChecked ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    } else {
        <span class="hljs-attr">value</span> = $(this).val()<span class="hljs-comment">;</span>
    }
​
    if (<span class="hljs-attr">name</span> === <span class="hljs-string">'input_target_lang'</span>) {
        translateVisibleMessages(value)<span class="hljs-comment">;</span>
    }
​
    if (<span class="hljs-attr">name</span> === <span class="hljs-string">'chat_message_target_lang'</span>) {
        translateVisibleMessages(value, 'left')<span class="hljs-comment">;</span>
    }
​
    $.post('/chat/change_translate_config', {
        name: name,
        value: value
    }, function (res) {
        if (res.code !== 0) {
            layer.msg(res.msg)
        }
    })<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
​
/**
 * 聊天框内容翻译
 * @param targetLang
 * @param trans_message_type
 */
function translateVisibleMessages(<span class="hljs-attr">targetLang</span> = <span class="hljs-string">'en'</span>, trans_message_type = <span class="hljs-string">'right'</span>) {
    const <span class="hljs-attr">messagesToTranslate</span> = []<span class="hljs-comment">;</span>
    const <span class="hljs-attr">selector</span> = <span class="hljs-string">'.chat-message-wrapper.chat-message-'</span> + trans_message_type<span class="hljs-comment">;</span>
    console.log('selector', selector)<span class="hljs-comment">; // 输出拼接的选择器</span>
    console.log('匹配到元素数量:', $(selector).length)<span class="hljs-comment">;</span>
    $(selector).each(function () {
        const $<span class="hljs-attr">wrapper</span> = $(this)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">messageId</span> = <span class="hljs-variable">$wrapper</span>.data(<span class="hljs-string">'id'</span>)<span class="hljs-comment">;</span>
​
        const $<span class="hljs-attr">bubble</span> = <span class="hljs-variable">$wrapper</span>.find(<span class="hljs-string">'.chat-message-bubble'</span>)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">content</span> = <span class="hljs-variable">$wrapper</span>.find(<span class="hljs-string">'.chat-message-bubble .original-text'</span>).text().trim()<span class="hljs-comment">;</span>
        const <span class="hljs-attr">cacheKey</span> = `<span class="hljs-variable">${messageId}</span>_<span class="hljs-variable">${targetLang}</span>`<span class="hljs-comment">;</span>
​
        if (!messageId || !content) return<span class="hljs-comment">;</span>
​
        // 若已缓存则直接渲染
        if (translationCache<span class="hljs-section">[cacheKey]</span>) {
            applyTranslatedMessage(messageId, translationCache<span class="hljs-section">[cacheKey]</span>)<span class="hljs-comment">;</span>
        } else {
            // 显示 loading 占位
            insertLoadingPlaceholder($bubble)<span class="hljs-comment">;</span>
​
            // 准备发送的内容
            messagesToTranslate.push({ message_id: messageId, content })<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
​
    console.log('messagesToTranslate', messagesToTranslate)<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">messagesToTranslate.length</span> === <span class="hljs-number">0</span>) return<span class="hljs-comment">;</span>
​
    $.ajax({
        url: '/chat/translate/batch',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            messages: messagesToTranslate,
            target_lang: targetLang
        }),
        success: function (res) {
            if (<span class="hljs-attr">res.code</span> === <span class="hljs-number">0</span> &amp;&amp; Array.isArray(res.data)) {
                res.data.forEach(<span class="hljs-attr">item</span> =&gt; {
                    const <span class="hljs-attr">cacheKey</span> = `<span class="hljs-variable">${item.message_id}</span>_<span class="hljs-variable">${targetLang}</span>`<span class="hljs-comment">;</span>
                    translationCache<span class="hljs-section">[cacheKey]</span> = item.translate<span class="hljs-comment">;</span>
                    applyTranslatedMessage(item.message_id, item.translate)<span class="hljs-comment">;</span>
                })<span class="hljs-comment">;</span>
            }
        }
    })<span class="hljs-comment">;</span>
}
​
/**
 * 翻译内容显示
 * @param messageId
 * @param translation
 */
function applyTranslatedMessage(messageId, translation) {
    const $<span class="hljs-attr">wrapper</span> = $(`.chat-message-wrapper[data-id=<span class="hljs-string">"${messageId}"</span>]`)<span class="hljs-comment">;</span>
    const $<span class="hljs-attr">bubble</span> = <span class="hljs-variable">$wrapper</span>.find(<span class="hljs-string">'.chat-message-bubble'</span>)<span class="hljs-comment">;</span>
​
    const $<span class="hljs-attr">translated</span> = <span class="hljs-variable">$bubble</span>.find(<span class="hljs-string">'.translated-text'</span>)<span class="hljs-comment">;</span>
    if ($translated.length) {
        $translated.text(translation)<span class="hljs-comment">;</span>
    } else {
        $bubble.append(`
            &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"divider"</span>&gt;&lt;/div&gt;
            &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"translated-text text-muted small"</span>&gt;<span class="hljs-variable">${translation}</span>&lt;/div&gt;
        `)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>这段代码是 AI 在我给出 DOM 结构后帮我补全的。</p>
<hr/>
<h3 data-id="heading-20">3.3 关键功能点三：复杂 UI 交互（微信式体验）如何落地？</h3>
<p>比如：</p>
<ul>
<li>消息气泡宽度</li>
<li>时间显示位置</li>
<li>自己 / 对方对齐方式</li>
<li>动态按钮事件绑定</li>
</ul>
<h4 data-id="heading-21">3.3.1 动态元素事件绑定问题</h4>
<p>我一开始写的是：</p>
<pre><code class="hljs language-csharp" lang="csharp">$(<span class="hljs-string">'#toggle-friend-info'</span>).<span class="hljs-keyword">on</span>(<span class="hljs-string">'click'</span>, ...)
</code></pre>
<p>AI 很快指出问题：</p>
<blockquote>
<p><strong>这是动态生成的 DOM，需要事件委托</strong></p>
</blockquote>
<p>修正后：</p>
<pre><code class="hljs language-javascript" lang="javascript">$(<span class="hljs-variable language_">document</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">'click'</span>, <span class="hljs-string">'#toggle-friend-info'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    $(<span class="hljs-string">'#friend-info-panel'</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">'show'</span>);
});
</code></pre>
<p>这是一个<strong>非常典型的“AI 帮你查漏补缺”场景</strong>。</p>
<hr/>
<h4 data-id="heading-22">3.3.2 滑出面板相对聊天窗口，而不是页面</h4>
<p>AI 在我反馈问题后，帮我调整为：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.chat-panel</span> {
    <span class="hljs-attribute">position</span>: relative;
    <span class="hljs-attribute">overflow</span>: hidden;
}
<span class="hljs-selector-class">.friend-info-panel</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">right</span>: -<span class="hljs-number">260px</span>;
    <span class="hljs-attribute">transition</span>: right .<span class="hljs-number">3s</span>;
}
<span class="hljs-selector-class">.friend-info-panel</span><span class="hljs-selector-class">.show</span> {
    <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-23">3.3.3 发送消息、接收消息左右分隔</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.chat-message-wrapper</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: flex-start;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
}
​
<span class="hljs-selector-class">.chat-message-left</span> {
    <span class="hljs-attribute">flex-direction</span>: row;
}
​
<span class="hljs-selector-class">.chat-message-right</span> {
    <span class="hljs-attribute">flex-direction</span>: row-reverse;
}
​
<span class="hljs-selector-class">.message-block</span> {
    <span class="hljs-attribute">display</span>: inline-flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">max-width</span>: <span class="hljs-number">75%</span>;   <span class="hljs-comment">/* 让消息区最大占75%宽 */</span>
    <span class="hljs-attribute">word-wrap</span>: break-word;
}
​
<span class="hljs-comment">/* 自己发的消息（右侧） */</span>
<span class="hljs-selector-class">.chat-message-right</span> <span class="hljs-selector-class">.message-block</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">align-items</span>: flex-end; <span class="hljs-comment">/* 时间右对齐 */</span>
}
​
<span class="hljs-comment">/* 对方的消息（左侧） */</span>
<span class="hljs-selector-class">.chat-message-left</span> <span class="hljs-selector-class">.message-block</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">align-items</span>: flex-start; <span class="hljs-comment">/* 时间左对齐 */</span>
}
​
<span class="hljs-selector-class">.chat-message-bubble</span> {
    <span class="hljs-attribute">max-width</span>: <span class="hljs-number">95%</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">14px</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">word-wrap</span>: break-word;
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-number">2px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.05</span>);
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.5</span>;
}
</code></pre>
<p>以上这些，基本上都是AI帮我完成调优的。</p>
<hr/>
<p><strong>除了以上几个功能点之外，我还实现了</strong></p>
<ol>
<li>退出登录聊天窗记忆功能：退出登录，记录上次聊天的对象，再次登录后自动打开最后一次聊天对象所在的分组、tab、聊天窗口、聊天记录</li>
<li>多语言切换：通过配置切换当前要展示的语言</li>
<li>快捷回复：添加（文本、图片、视频、语音）、删除、快捷发送</li>
<li>自动回复：接收到消息自动回复</li>
<li>翻译配置：支持发送出去的消息和接收到的消息，可以分别配置源语言、翻译为目标语言。比如发出去的是中文，实际对方接收到的是英文；接收到的是英文、韩文，聊天窗显示中文</li>
<li>未读分组、tab、好友红点标记等</li>
</ol>
<p>太多了，具体细节就不一一介绍了，光聊天一个窗口交互就复杂的一批（感觉要钱要少了，orz...</p>
<h2 data-id="heading-24">四、效果展示</h2>
<p>登录</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98418a379ea34304a86f864f628e9739~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZG95Lit5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077843&amp;x-signature=xmIuK%2FZS4Te%2Ba2GMEZ99sV68eow%3D" alt="image-20251223114030780.png" loading="lazy"/></p>
<p>聊天首页</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/557540fcbd98499db712129df3782e78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZG95Lit5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077843&amp;x-signature=tpq652ajSRqbLN8JccuhVSLtdeA%3D" alt="image-20251223114119055.png" loading="lazy"/></p>
<p>翻译配置</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80c818f0b1b6401da88207840bac5598~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZG95Lit5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077843&amp;x-signature=zol8YF6s9n95wY3SNw9QOexykc4%3D" alt="image-20251223114155843.png" loading="lazy"/></p>
<p>自动回复配置</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4016d60d51fe486584110a58d79f9bf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZG95Lit5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077843&amp;x-signature=b2VJDFXtuabFfHiT7ZXmH5lTUcg%3D" alt="image-20251223114232951.png" loading="lazy"/></p>
<h2 data-id="heading-25">五、总结</h2>
<h3 data-id="heading-26">5.1 AI写代码的优缺点</h3>
<p>基于我这次和AI对话的实战来看，优点是非常明显的</p>
<ul>
<li>前端效率提升巨大</li>
<li>UI 微调不再痛苦</li>
<li>可以快速试错</li>
<li>非前端工程师也能做出“像样界面”</li>
</ul>
<p>但是<strong>缺点也很明显</strong>：</p>
<ul>
<li>不会主动考虑性能极限</li>
<li>容易“写得能用，但不够优雅”</li>
<li>架构必须你来定</li>
<li>需要你具备基本判断能力</li>
</ul>
<h3 data-id="heading-27">5.2 其他</h3>
<p>AI的使用远不限于此，如果你愿意学习如何使用：</p>
<ul>
<li>描述需求</li>
<li>提供上下文</li>
<li>精准反馈</li>
<li>与 AI 协作</li>
</ul>
<p>你会发现：<strong>一个人，可以完成过去一个小团队才能完成的事情。</strong></p>
<h2 data-id="heading-28">六、写到最后</h2>
<p>对我来说，AI 并不是让我“变成前端工程师”，而是让我在有限时间内，把一个本来可能妥协的项目，<strong>做到自己满意为止</strong>。</p>
<p>从某些方面来说，AI让我变的更高效，从之前排查问题靠百度、靠在社区提问，到现在有问题问AI，AI的准确率还不错；从之前靠自己经验写出一段逻辑代码，到现在请AI帮我优化，大大提高了我代码的质量；AI是个好东西，咱们程序员还是要擅于利用它，这样才有更多的时间“摸鱼"（提高自己）啊</p>
<blockquote>
<p>你有没有用 AI 真正写过项目呢？欢迎评论聊聊。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个基于 Vue 的 GitHub 用户搜索案例]]></title>    <link>https://juejin.cn/post/7586663700900839433</link>    <guid>https://juejin.cn/post/7586663700900839433</guid>    <pubDate>2025-12-23T07:45:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586663700900839433" data-draft-id="7586663700900790281" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个基于 Vue 的 GitHub 用户搜索案例"/> <meta itemprop="keywords" content="前端,Vue.js,前端框架"/> <meta itemprop="datePublished" content="2025-12-23T07:45:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="进击的野人"/> <meta itemprop="url" content="https://juejin.cn/user/1458425238667008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个基于 Vue 的 GitHub 用户搜索案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1458425238667008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    进击的野人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:45:55.000Z" title="Tue Dec 23 2025 07:45:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在学习 Vue 组件化开发的过程中，我通过一个 GitHub 用户搜索的小案例，将<strong>组件拆分、事件通信、条件渲染以及异步请求</strong>等核心知识点串联了起来。虽然功能不复杂，但非常适合作为理解 Vue 应用结构的练习。</p>
<p>整个项目由三个组件组成：<code>App.vue</code>、<code>MySearch.vue</code> 和 <code>MyList.vue</code>，采用了典型的“父容器 + 功能组件”的结构设计。</p>
<hr/>
<h2 data-id="heading-0">一、根组件 App.vue：只负责组合，不写业务</h2>
<p>先看根组件 <code>App.vue</code>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">MySearch</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">MyList</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MySearch</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/MySearch.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/MyList.vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'App'</span>,
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">MySearch</span>,
    <span class="hljs-title class_">MyList</span>
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>可以看到，<code>App.vue</code> <strong>没有任何业务逻辑</strong>，只做了三件事：</p>
<ol>
<li>引入子组件</li>
<li>注册子组件</li>
<li>在模板中组合页面结构</li>
</ol>
<p>这种写法非常符合 Vue 的设计思想：</p>
<blockquote>
<p>根组件只负责“搭架子”，具体功能全部下沉到子组件中。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、MySearch.vue：搜索逻辑与请求发起者</h2>
<h3 data-id="heading-2">1. 模板结构：输入 + 触发搜索</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;input
  <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
  <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"enter the name you search"</span>
  <span class="hljs-attr">v-model.trim</span>=<span class="hljs-string">"keyWord"</span>
  @<span class="hljs-attr">keyup.enter</span>=<span class="hljs-string">"searchUsers"</span>
/&gt;
&lt;button @<span class="hljs-attr">click</span>=<span class="hljs-string">"searchUsers"</span>&gt;Search&lt;/button&gt;
</code></pre>
<p>这里用到了几个非常关键的点：</p>
<ul>
<li><code>v-model.trim</code>：<br/>
自动去掉用户输入的首尾空格，避免无效请求</li>
<li><code>@keyup.enter</code>：<br/>
支持回车搜索，提升用户体验</li>
<li>按钮点击和回车复用同一个方法</li>
</ul>
<hr/>
<h3 data-id="heading-3">2. data 定义：只存搜索关键词</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">keyWord</span>: <span class="hljs-string">''</span>
  }
}
</code></pre>
<p>搜索组件的职责非常单一：<br/>
👉 <strong>只关心“搜什么”与“怎么搜”</strong></p>
<hr/>
<h3 data-id="heading-4">3. 核心方法：searchUsers</h3>
<pre><code class="hljs language-bash" lang="bash">methods: {
  <span class="hljs-function"><span class="hljs-title">searchUsers</span></span>() {
    // 搜索前，通知列表进入 loading 状态
    this.<span class="hljs-variable">$bus</span>.<span class="hljs-variable">$emit</span>(<span class="hljs-string">'getSearchData'</span>, {
      isFirst: <span class="hljs-literal">false</span>,
      isLoading: <span class="hljs-literal">true</span>,
      errMsg: <span class="hljs-string">''</span>,
      <span class="hljs-built_in">users</span>: []
    })

    axios.get(`https://api.github.com/search/users?q=<span class="hljs-variable">${this.keyWord}</span>`).<span class="hljs-keyword">then</span>(
      response =&gt; {
        this.<span class="hljs-variable">$bus</span>.<span class="hljs-variable">$emit</span>(<span class="hljs-string">'getSearchData'</span>, {
          isLoading: <span class="hljs-literal">false</span>,
          <span class="hljs-built_in">users</span>: response.data.items
        })
      },
      error =&gt; {
        this.<span class="hljs-variable">$bus</span>.<span class="hljs-variable">$emit</span>(<span class="hljs-string">'getSearchData'</span>, {
          isLoading: <span class="hljs-literal">false</span>,
          errMsg: error.message,
          <span class="hljs-built_in">users</span>: []
        })
      }
    )
  }
}
</code></pre>
<p>这一段代码是整个项目的<strong>逻辑核心</strong>，可以总结为三步：</p>
<ol>
<li>
<p><strong>请求开始前</strong></p>
<ul>
<li>
<p>通知列表组件：</p>
<ul>
<li>不再是首次进入</li>
<li>正在加载中</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>请求成功</strong></p>
<ul>
<li>将 GitHub 返回的用户数据发送给列表组件</li>
</ul>
</li>
<li>
<p><strong>请求失败</strong></p>
<ul>
<li>将错误信息传递给列表组件展示</li>
</ul>
</li>
</ol>
<blockquote>
<p>注意：<br/>
搜索组件<strong>不直接修改列表组件的数据</strong>，而是通过事件总线“通知结果”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">三、MyList.vue：统一管理页面展示状态</h2>
<h3 data-id="heading-6">1. 状态集中管理</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">data()</span> {
  <span class="hljs-string">return</span> {
    <span class="hljs-attr">info:</span> {
      <span class="hljs-attr">isFirst:</span> <span class="hljs-literal">true</span>,
      <span class="hljs-attr">isLoading:</span> <span class="hljs-literal">false</span>,
      <span class="hljs-attr">errMsg:</span> <span class="hljs-string">''</span>,
      <span class="hljs-attr">users:</span> []
    }
  }
}
</code></pre>
<p>这里用一个 <code>info</code> 对象统一管理所有 UI 状态，非常关键：</p>
<ul>
<li>是否首次进入</li>
<li>是否正在加载</li>
<li>是否有错误</li>
<li>是否有数据</li>
</ul>
<p>👉 <strong>状态集中，模板判断才会清晰</strong></p>
<hr/>
<h3 data-id="heading-7">2. 模板中的条件渲染</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 用户列表 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>
  <span class="hljs-attr">v-show</span>=<span class="hljs-string">"info.users.length"</span>
  <span class="hljs-attr">v-for</span>=<span class="hljs-string">"user in info.users"</span>
  <span class="hljs-attr">:key</span>=<span class="hljs-string">"user.login"</span>
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">:href</span>=<span class="hljs-string">"user.html_url"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"user.avatar_url"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 100px;"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-text"</span>&gt;</span>{{ user.login }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">"info.isFirst"</span>&gt;</span>欢迎！！！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">"info.isLoading"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">"info.errMsg"</span>&gt;</span>{{ info.errMsg }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
</code></pre>
<p>通过 <code>v-show</code> 控制不同状态下的界面展示：</p>
<ul>
<li>初始 → 欢迎提示</li>
<li>搜索中 → 加载中</li>
<li>成功 → 用户列表</li>
<li>失败 → 错误信息</li>
</ul>
<p>这正是<strong>真实业务中最常见的 UI 状态切换场景</strong>。</p>
<hr/>
<h3 data-id="heading-8">3. 接收搜索组件的数据（事件总线）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">$bus</span>.$on(<span class="hljs-string">'getSearchData'</span>, <span class="hljs-function"><span class="hljs-params">datas</span> =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">info</span> = { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">info</span>, ...datas }
  })
}
</code></pre>
<p>这里的写法非常值得学习：</p>
<ul>
<li>使用展开运算符合并状态</li>
<li>只更新传过来的字段</li>
<li>保留原有未修改状态</li>
</ul>
<p>👉 这是一个<strong>低耦合、可维护性很强</strong>的写法。</p>
<hr/>
<h2 data-id="heading-9">四、为什么要用事件总线？</h2>
<p>在这个项目中：</p>
<ul>
<li><code>MySearch</code> 和 <code>MyList</code> 是<strong>兄弟组件</strong></li>
<li>它们之间没有直接的父子 props 关系</li>
</ul>
<p>使用事件总线的好处是：</p>
<ul>
<li>不需要层层传 props</li>
<li>组件之间完全解耦</li>
<li>非常适合小型项目和学习阶段</li>
</ul>
<p>虽然在大型项目中会使用 Vuex / Pinia，但在这里，<strong>事件总线是一个非常合适的选择</strong>。</p>
<hr/>
<h2 data-id="heading-10">五、总结</h2>
<p>通过这个 GitHub 用户搜索案例，我对 Vue 的理解不再停留在指令和语法层面，而是开始关注：</p>
<ul>
<li>组件应该如何拆分</li>
<li>数据应该由谁维护</li>
<li>不同状态下页面如何变化</li>
<li>组件之间如何通信才合理</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我是怎么把模型回复用tts播放的更自然的]]></title>    <link>https://juejin.cn/post/7586663700900921353</link>    <guid>https://juejin.cn/post/7586663700900921353</guid>    <pubDate>2025-12-23T07:50:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586663700900921353" data-draft-id="7586657335881596955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我是怎么把模型回复用tts播放的更自然的"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:50:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我是怎么把模型回复用tts播放的更自然的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:50:30.000Z" title="Tue Dec 23 2025 07:50:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">场景与痛点</h2>
<p>接 TTS（语音合成）服务的时候，经常碰到一个硬性限制：<strong>单次请求最多处理 50 个字符</strong>（或者是其他的长度限制）。</p>
<p>但现在的 AI 回复动不动就几百上千字，肯定得拆。</p>
<p>最开始的做法很简单粗暴：<strong>每 50 个字符切一刀，分批调接口。</strong></p>
<p>结果合成出来的语音听着像结巴：</p>
<blockquote>
<p>"今天我们去商场买了衣..." （停顿 1 秒）"...服，之后去吃了晚餐。"</p>
</blockquote>
<p>这就很难受了，"衣服"这个词被硬生生劈开，用户体验极差。</p>
<p>怎么解决？核心思路其实就一句话：<strong>让机器模拟人的自然换气。</strong></p>
<h2 data-id="heading-1">核心矛盾</h2>
<p>这其实是一个"规则冲突"问题：</p>
<ul>
<li><strong>TTS 的规则</strong>：长度必须 &lt; 50。</li>
<li><strong>语言的规则</strong>：停顿必须在"语义边界"（标点、词组空隙）。</li>
</ul>
<p>我们的目标是：<strong>在满足 TTS 硬性限制的前提下，尽量贴合语言的自然停顿。</strong></p>
<h2 data-id="heading-2">优化策略</h2>
<p>我们验证下来，这三个策略组合使用效果最好：</p>
<h3 data-id="heading-3">1. 标点边界优先（Priority Split）</h3>
<p>思路：<strong>宁可少切，不能乱切。</strong></p>
<p>只要没超长，就一直往后找，直到遇到句号、逗号、问号这些<strong>天然停顿点</strong>再切。</p>
<p>比如这段话：</p>
<blockquote>
<p>"今天天气很好，我们决定去公园散步，顺便买点水果回来。"</p>
</blockquote>
<ul>
<li><strong>硬切模式</strong>：切在"水果"中间。</li>
<li><strong>标点优先模式</strong>：
<pre><code class="hljs language-text" lang="text">片段1: "今天天气很好，我们决定去公园散步，" (20字符)
片段2: "顺便买点水果回来。" (10字符)
</code></pre>
</li>
</ul>
<p>虽然每个片段都远没到 50 字符，但保证了语义完整。</p>
<h3 data-id="heading-4">2. 缓冲回退（Buffer Backtrack）</h3>
<p>如果一句话特别长，中间完全没有标点，或者标点在 50 字符之外，怎么办？</p>
<p><strong>不要在第 50 个字符硬切，而是往回退。</strong></p>
<p>比如累积到 50 字了，发现卡在单词中间。这时候往回退 5-10 个字符，看看有没有空格、逗号或者其他稍微适合停顿的地方。</p>
<p>流程如下：</p>
<pre><code class="hljs language-text" lang="text">累积到上限 → 能切吗？(是标点/空格)
                  ↓
       不能 → 往回倒车 10 步 → 找到标点了吗？
                  ↓                  ↓
              没找到 (认命硬切)     找到了 (切分)
</code></pre>
<h3 data-id="heading-5">3. 短片段合并（Merge Short）</h3>
<p>切分过细会带来另一个问题：<strong>请求太碎，网络开销大，且声音断断续续。</strong></p>
<p>比如切成了：<code>"好的。"</code>、<code>"没问题。"</code>。
这两个完全可以合并成 <code>"好的。没问题。"</code> 一起发过去，只要合并后不超过 50 字符。</p>
<h2 data-id="heading-6">方案实现</h2>
<h3 data-id="heading-7">处理流程图</h3>
<p>这个逻辑用状态图描述最清晰：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[输入长文本] --&gt; B[逐字符累积]
    B --&gt; C{快到限制了?}
    C --&gt;|否| B
    C --&gt;|是| D[回退搜索标点]
    D --&gt; E{缓冲区内找到标点?}
    E --&gt;|是| F[在标点处切分]
    E --&gt;|否| G[没办法，强制切分]
    F --&gt; H[保存片段]
    G --&gt; H
    H --&gt; I{还有剩余文本?}
    I --&gt;|是| B
    I --&gt;|否| J[合并过短片段]
    J --&gt; K[输出最终列表]

    classDef process fill:#cce5ff,stroke:#0d6efd,color:#004085
    classDef decision fill:#fff3cd,stroke:#ffc107,color:#856404
    classDef endpoint fill:#d4edda,stroke:#28a745,color:#155724

    class A,K endpoint
    class C,E,I decision
    class B,D,F,G,H,J process
</code></pre>
<h3 data-id="heading-8">关键代码 (Python)</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">split_for_tts</span>(<span class="hljs-params">text, max_len=<span class="hljs-number">50</span>, buffer_size=<span class="hljs-number">10</span></span>):
    <span class="hljs-string">"""
    智能切分文本，优先保持语义完整
    """</span>
    <span class="hljs-comment"># 定义标点优先级：句子结束符 &gt; 短句分隔符</span>
    <span class="hljs-comment"># 实际场景中可以配置权重</span>
    stops = <span class="hljs-built_in">set</span>(<span class="hljs-string">'。，！？；：、.!?,;:'</span>)
    
    segments = []
    current_idx = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">while</span> current_idx &lt; <span class="hljs-built_in">len</span>(text):
        <span class="hljs-comment"># 剩余部分直接打包</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(text) - current_idx &lt;= max_len:
            segments.append(text[current_idx:])
            <span class="hljs-keyword">break</span>
            
        <span class="hljs-comment"># 预设切分点为最大长度处</span>
        cut_pos = current_idx + max_len
        found_stop = <span class="hljs-literal">False</span>
        
        <span class="hljs-comment"># 1. 策略：缓冲回退</span>
        <span class="hljs-comment"># 从 max_len 处往回找 buffer_size 个字符</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(cut_pos, cut_pos - buffer_size, -<span class="hljs-number">1</span>):
            <span class="hljs-keyword">if</span> i &lt; <span class="hljs-built_in">len</span>(text) <span class="hljs-keyword">and</span> text[i] <span class="hljs-keyword">in</span> stops:
                cut_pos = i + <span class="hljs-number">1</span> <span class="hljs-comment"># 包含标点</span>
                found_stop = <span class="hljs-literal">True</span>
                <span class="hljs-keyword">break</span>
        
        <span class="hljs-comment"># 2. 策略：兜底</span>
        <span class="hljs-comment"># 如果缓冲区没找到标点，就只能硬切了</span>
        <span class="hljs-comment"># (实际生产中这里可以再优化，比如尝试找空格)</span>
        
        segments.append(text[current_idx:cut_pos])
        current_idx = cut_pos

    <span class="hljs-keyword">return</span> merge_short_segments(segments, max_len)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">merge_short_segments</span>(<span class="hljs-params">segments, max_len, min_len=<span class="hljs-number">10</span></span>):
    <span class="hljs-string">"""
    合并碎片段，减少请求次数
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> segments: <span class="hljs-keyword">return</span> []
    
    merged = [segments[<span class="hljs-number">0</span>]]
    <span class="hljs-keyword">for</span> seg <span class="hljs-keyword">in</span> segments[<span class="hljs-number">1</span>:]:
        last = merged[-<span class="hljs-number">1</span>]
        <span class="hljs-comment"># 如果合并后不超长，且前一个太短，就合并</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(last) + <span class="hljs-built_in">len</span>(seg) &lt;= max_len <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(last) &lt; min_len:
            merged[-<span class="hljs-number">1</span>] += seg
        <span class="hljs-keyword">else</span>:
            merged.append(seg)
            
    <span class="hljs-keyword">return</span> merged
</code></pre>
<h2 data-id="heading-9">避坑指南</h2>
<p>在实际上线过程中，还踩过几个坑，提个醒：</p>
<ol>
<li><strong>保护语义实体</strong>：虽然发给 TTS 的通常是清洗后的纯文本，但文本里常有<strong>金额</strong>（<code>1,000</code>）、<strong>书名号</strong>（<code>《...》</code>）或<strong>特定短语</strong>。如果你在逗号处把 <code>1,000</code> 切开了，TTS 可能会把 <code>1,</code> 读成"一，"，剩下的 <code>000</code> 读成"零零零"。建议对这类实体做正则识别，确保它们完整地留在同一个片段里。</li>
<li><strong>英文单词边界</strong>：中文按字算，英文按词算。切分的时候一定要判断 <code>text[cut_pos]</code> 是不是字母，如果是，千万别切，继续往回退找空格。</li>
<li><strong>表情包过滤</strong>：很多 TTS 模型不支持 emoji，直接把 <code>😂</code> 这种符号喂进去可能会报错或者读出乱码，建议预处理直接干掉。</li>
</ol>
<h2 data-id="heading-10">总结</h2>
<p>TTS 优化的本质不是算法问题，而是<strong>体验问题</strong>。</p>
<p>不需要多高深的 NLP 模型，只需要几行简单的规则代码：<strong>多找标点，少硬切，适度合并</strong>。就能把"机器味"去掉一大半。</p>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《2025 AI 自动化新高度：一套代码搞定 iOS、Android 双端，全平台 AutoGLM 部署实战》]]></title>    <link>https://juejin.cn/post/7586861592710004772</link>    <guid>https://juejin.cn/post/7586861592710004772</guid>    <pubDate>2025-12-23T07:27:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586861592710004772" data-draft-id="7586684925106044971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《2025 AI 自动化新高度：一套代码搞定 iOS、Android 双端，全平台 AutoGLM 部署实战》"/> <meta itemprop="keywords" content="前端,全栈,人工智能"/> <meta itemprop="datePublished" content="2025-12-23T07:27:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ZsTs119"/> <meta itemprop="url" content="https://juejin.cn/user/3725615485435022"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《2025 AI 自动化新高度：一套代码搞定 iOS、Android 双端，全平台 AutoGLM 部署实战》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3725615485435022/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ZsTs119
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:27:12.000Z" title="Tue Dec 23 2025 07:27:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>还在为了在电脑上操控手机去翻遍碎片的教程？Android 连不上、iOS 搞不定、命令行太枯燥？</p>
<p>刷短视频、发微信、甚至抢票，能不能让 AI 替我操作手机？AutoGLM 虽然强大，但环境搭建总是卡在 “ADB 连不上” 或 “WDA 签名失败”？</p>
<p>本文是目前市面上最全的 <strong>AutoGLM 终极全能手册</strong>。我们不谈虚的理论，直接深度集成 <strong>iOS/Android 双端适配</strong>、<strong>Windows/macOS/Linux 三系统支持</strong>以及 <strong>GUI 可视化操作界面</strong>。不仅提供完整的下载链接，更包含从底层驱动到高层 AI 逻辑的保姆级实战拆解。</p>
</blockquote>
<h2 data-id="heading-1">开始</h2>
<p>本手册围绕以下 7 个核心模块展开，带你一站式打通 AI 手机自动化：</p>





















































<table><thead><tr><th><strong>序号</strong></th><th><strong>模块名称</strong></th><th><strong>模块核心内容</strong></th><th><strong>你能获得的核心价值</strong></th></tr></thead><tbody><tr><td>1</td><td><strong>全平台环境地基</strong></td><td>Python、Git 环境配置与三端路径挂载</td><td>确保所有工具在各系统下运行逻辑一致</td></tr><tr><td>2</td><td><strong>Android 驱动：ADB 深度配置</strong></td><td>SDK 下载、Path 配置、<strong>Linux 权限一键通</strong></td><td>打通 Android 端的指令传输链路</td></tr><tr><td>3</td><td><strong>iOS 驱动：WDA 与 Tidevice</strong></td><td><strong>Windows 签名 WDA</strong>、Tidevice 部署、跨端连接</td><td>突破苹果生态限制，实现 iOS 自动化</td></tr><tr><td>4</td><td><strong>AutoGLM 核心安装</strong></td><td>源码部署、依赖库安装、<strong>输入法优化</strong></td><td>部署 AI 智能体的核心算法与逻辑</td></tr><tr><td>5</td><td><strong>GUI 可视化界面部署</strong></td><td>GUI 安装、<strong>内核路径关联</strong>、Web 控制台配置</td><td>告别黑窗口，实现直观的图形化操控</td></tr><tr><td>6</td><td><strong>API 服务接入与测试</strong></td><td>智谱 AI 密钥配置、模型访问权限获取</td><td>为系统接入大模型“大脑”</td></tr><tr><td>7</td><td><strong>全场景实战与避坑</strong></td><td>双端微信实测、<strong>404/连接错误终极排查</strong></td><td>验证完整链路，提供企业级排查手册</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">（一）全平台环境地基</h2>
<blockquote>
<p><strong>顶层结论</strong>：统一开发环境是跨平台操作的前提。建议务必统一 Python 版本到 <strong>3.8 - 3.12</strong>，并确保环境变量配置正确，否则后续 GUI 关联内核时会频繁报错。</p>
</blockquote>
<h3 data-id="heading-3">1. 软件下载与验证</h3>
<ul>
<li>
<p><strong>Python (3.8 - 3.12)</strong> :</p>
<ul>
<li><strong>下载</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.python.org%2Fdownloads%2F" target="_blank" title="https://www.python.org/downloads/" ref="nofollow noopener noreferrer">python.org/downloads</a></li>
<li><strong>Windows</strong>: 安装时必须勾选 <code>Add Python to PATH</code>。</li>
<li><strong>macOS/Linux</strong>: <code>brew install python</code> 或 <code>sudo apt install python3</code>。</li>
</ul>
</li>
<li>
<p><strong>Git</strong>:</p>
<ul>
<li><strong>下载</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3Dhttps%3A%2F%2Fgit-scm.com%2Fdownloads" target="_blank" title="https://www.google.com/search?q=https://git-scm.com/downloads" ref="nofollow noopener noreferrer">git-scm.com</a></li>
<li><strong>验证</strong>: 终端输入 <code>git --version</code> 确认。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-4">（二）Android 驱动：ADB 深度配置</h2>
<blockquote>
<p><strong>顶层结论</strong>：ADB (Android Debug Bridge) 是 Android 端的命脉。不仅要配好 Path 路径，针对 Linux 用户和小米手机用户，还有特定的“权限门槛”需要跨越。</p>
</blockquote>
<h3 data-id="heading-5">1. 下载与环境变量</h3>
<ul>
<li>
<p><strong>官方 SDK Platform-Tools 下载</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Freleases%2Fplatform-tools" target="_blank" title="https://developer.android.com/studio/releases/platform-tools" ref="nofollow noopener noreferrer">Android 官方开发者工具</a></p>
</li>
<li>
<p><strong>Windows 配置</strong>:</p>
<ol>
<li>解压至 <code>C:\platform-tools</code>。</li>
<li>环境变量 -&gt; 系统变量 <code>Path</code> -&gt; 新建 <code>C:\platform-tools</code>。</li>
</ol>
</li>
<li>
<p><strong>macOS / Linux 安装</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">brew install --cask android-platform-tools  <span class="hljs-comment"># Mac</span>
sudo apt install android-tools-adb           <span class="hljs-comment"># Linux (Ubuntu)</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-6">2. Linux 权限一键通</h3>
<p>如果你是 Linux 用户，遇到 <code>adb devices</code> 显示 <code>no permissions</code>，请执行：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 自动生成 udev 规则</span>
echo '<span class="hljs-attr">SUBSYSTEM</span>==<span class="hljs-string">"usb"</span>, ATTR{idVendor}==<span class="hljs-string">"2836"</span>, MODE=<span class="hljs-string">"0666"</span>, GROUP=<span class="hljs-string">"plugdev"</span><span class="hljs-string">' | sudo tee /etc/udev/rules.d/51-android.rules
sudo udevadm control --reload-rules
sudo service udev restart
</span></code></pre>
<h3 data-id="heading-7">3. 小米设备（Android）调试必开项</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2b8e66fddd14db29276363c64d2062f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=rAeZDqh2khnYu14biLi3H1Jd2WM%3D" alt="screenshot-20251209-181423.png" loading="lazy"/></p>
<p>在“开发者选项”中，这三项<strong>缺一不可</strong>：</p>
<ul>
<li>✅ <strong>USB 调试</strong></li>
<li>✅ <strong>USB 调试（安全设置）</strong> ：不开启此项 AI 无法模拟点击！</li>
<li>✅ <strong>允许通过 USB 安装应用</strong>
这是手册的第二部分，重点攻克 <strong>iOS 的驱动签名难题</strong> 以及 <strong>AutoGLM 核心引擎的安装</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-8">（三）iOS 驱动：WDA 与 Tidevice 深度配置</h2>
<blockquote>
<p><strong>顶层结论</strong>：iOS 自动化的核心在于 WebDriverAgent (WDA)。虽然苹果生态闭源，但通过 PR 156 引入的 <code>tidevice</code>，我们可以在 Windows/Linux 上绕过 Xcode 操控 iPhone，关键在于 <strong>“如何正确给 WDA 签名”</strong> 。</p>
</blockquote>
<h3 data-id="heading-9">1. 核心工具下载</h3>
<ul>
<li>
<p><strong>Tidevice (PC端驱动)</strong> : 用于跨平台启动 iOS 自动化。</p>
<pre><code class="hljs">pip install tidevice
</code></pre>
</li>
<li>
<p><strong>Sideloadly (Windows 签名工具)</strong> : <a href="https://link.juejin.cn?target=https%3A%2F%2Fsideloadly.io%2F" target="_blank" title="https://sideloadly.io/" ref="nofollow noopener noreferrer">下载地址</a></p>
</li>
<li>
<p><strong>WebDriverAgent.ipa</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3Dhttps%3A%2F%2Fgithub.com%2Fappium%2FWebDriverAgent%2Freleases" target="_blank" title="https://www.google.com/search?q=https://github.com/appium/WebDriverAgent/releases" ref="nofollow noopener noreferrer">官方编译包下载</a></p>
</li>
</ul>
<h3 data-id="heading-10">2. Windows 用户无 Mac 签名攻略</h3>
<ol>
<li>
<p><strong>准备 IPA</strong>: 下载上述 <code>WebDriverAgent.ipa</code>。</p>
</li>
<li>
<p><strong>连接设备</strong>: 用数据线连接 iPhone，打开 Sideloadly。</p>
</li>
<li>
<p><strong>配置签名</strong>:</p>
<ul>
<li>在 <code>iDevice</code> 处确认识别到你的 iPhone。</li>
<li>在 <code>Apple account</code> 处输入你的 Apple ID。</li>
<li>将下载好的 <code>IPA</code> 文件拖入 Sideloadly 左侧框。</li>
</ul>
</li>
<li>
<p><strong>开始安装</strong>: 点击 <code>Start</code>。安装成功后，iPhone 桌面会出现 <code>WebDriverAgent</code> 图标。</p>
</li>
<li>
<p><strong>手机授权</strong>:</p>
<ul>
<li>进入：<code>设置 -&gt; 通用 -&gt; 描述文件与设备管理</code>。</li>
<li>找到你的 Apple ID 证书，点击 <strong>“信任”</strong> 。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-11">3. 映射与启动</h3>
<p>在终端执行以下命令，启动 iOS 端的服务映射：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 1. 启动 WDA 服务</span>
<span class="hljs-string">tidevice</span> <span class="hljs-string">xctest</span> <span class="hljs-string">-B</span> <span class="hljs-string">com.facebook.WebDriverAgentRunner.xctrunner</span>

<span class="hljs-comment"># 2. 另开一个窗口进行端口转发 (默认端口 8100)</span>
<span class="hljs-string">tidevice</span> <span class="hljs-string">relay</span> <span class="hljs-number">8100 </span><span class="hljs-number">8100</span>
</code></pre>
<p><strong>验证</strong>: 访问 <code>http://localhost:8100/status</code>，若看到 JSON 格式的返回信息，说明 iOS 驱动已完全打通。</p>
<hr/>
<h2 data-id="heading-12">（四）AutoGLM 核心引擎安装</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee9358b92acb4a1889cddecacdd11399~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=HAS7VxXWMR5jLrXLfD5GdyxR3D0%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p><strong>顶层结论</strong>：核心引擎（Open-AutoGLM）是处理 AI 逻辑的“大脑”。安装时除了基础依赖，最容易被忽视的是 <strong>“输入法插件”</strong> ，不安装它，AI 无法在搜索框正确键入中文。</p>
</blockquote>
<h3 data-id="heading-13">1. 源码部署与依赖</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 克隆主仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/zai-org/Open-AutoGLM.git
<span class="hljs-built_in">cd</span> Open-AutoGLM

<span class="hljs-comment"># 2. 安装依赖库</span>
pip install -r requirements.txt

<span class="hljs-comment"># 3. 以可编辑模式安装当前包</span>
pip install -e .
</code></pre>
<h3 data-id="heading-14">2. ADB Keyboard 安装（仅 Android）</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d0ee535012342ef905be344e39d18da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=YARTkBks%2BZzAkJmdYF6aADaVm30%3D" alt="image.png" loading="lazy"/></p>
<p>AI 操作时，手机原生输入法经常会弹出“候选词”遮挡屏幕。安装 ADB Keyboard 可以实现后台静默输入。</p>
<ul>
<li>
<p><strong>APK 下载</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsenzhk%2FADBKeyBoard%2Fraw%2Fmaster%2FADBKeyboard.apk" target="_blank" title="https://github.com/senzhk/ADBKeyBoard/raw/master/ADBKeyboard.apk" ref="nofollow noopener noreferrer">ADBKeyboard 下载链接</a></p>
</li>
<li>
<p><strong>安装命令</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 确保手机已连上电脑</span>
adb install ADBKeyboard.apk
</code></pre>
</li>
<li>
<p><strong>激活设置</strong>:</p>
<ul>
<li>手机设置 -&gt; 语言和输入法 -&gt; 管理键盘。</li>
<li>开启 <strong>ADB Keyboard</strong>，并将其设为当前默认输入法。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-15">3. 环境变量预设</h3>
<p>为了让 GUI 能顺利调用核心代码，建议将项目路径写入系统环境变量。</p>
<ul>
<li>
<p><strong>Windows (PowerShell)</strong> :</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[Environment]</span>::<span class="hljs-built_in">SetEnvironmentVariable</span>(<span class="hljs-string">"AUTOGLM_CORE_PATH"</span>, <span class="hljs-string">"C:\AutoGLM\Open-AutoGLM"</span>, <span class="hljs-string">"User"</span>)
</code></pre>
</li>
<li>
<p><strong>Mac/Linux (bash/zsh)</strong> :</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">'export AUTOGLM_CORE_PATH="/your/path/Open-AutoGLM"'</span> &gt;&gt; ~/.zshrc
<span class="hljs-built_in">source</span> ~/.zshrc
</code></pre>
</li>
</ul>
<p>这是手册的最后一部分，我们将打通 <strong>GUI 可视化操作界面</strong>，接入 <strong>AI 核心服务</strong>，并提供全平台的<strong>避坑排查手册</strong>。</p>
<hr/>
<h2 data-id="heading-16">（五）GUI 可视化界面部署</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77a62e17169545fd9196e91b08f55243~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=iCdcbRrECFMILgRzY7e8AO8OyQg%3D" alt="524711939-b8cb6fbc-ca5b-452c-bcf4-7d5863d4577a.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5929a82165064585ab8b679db2373720~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=UxmskvJ9Vrah99GF7NgyclfTsQo%3D" alt="524712065-b32f2e46-5340-42f5-a0db-0033729e1605.png" loading="lazy"/></p>
<blockquote>
<p><strong>顶层结论</strong>：<code>AutoGLM-GUI</code> 提供了基于 Web 的直观控制台，不仅能实时投屏预览，还能记录 AI 的思考逻辑。关键点在于将 GUI 程序与前文安装的 <code>Open-AutoGLM</code> 内核进行路径关联。</p>
</blockquote>
<h3 data-id="heading-17">1. GUI 安装与路径关联</h3>
<p>建议从源码安装以方便后续调整配置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 克隆 GUI 仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/suyiiyii/AutoGLM-GUI.git
<span class="hljs-built_in">cd</span> AutoGLM-GUI

<span class="hljs-comment"># 2. 安装界面依赖</span>
pip install -r requirements.txt
pip install -e .
</code></pre>
<h3 data-id="heading-18">2.内核路径配置文件</h3>
<p>如果 GUI 启动后提示“找不到内核”，请在 <code>AutoGLM-GUI</code> 根目录下手动创建或修改 <code>config.json</code>（或 <code>.env</code>）文件：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"api"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"base_url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://open.bigmodel.cn/api/paas/v4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"autoglm-phone"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"core"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"C:/AutoGLM/Open-AutoGLM"</span>  <span class="hljs-comment">// 此处指向你模块（四）的安装路径</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"server"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8080</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-19">3. 启动控制台</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 执行启动命令</span>
<span class="hljs-string">autoglm-gui</span> <span class="hljs-string">--port</span> <span class="hljs-number">8080</span>
</code></pre>
<p>启动成功后，浏览器会自动打开 <code>http://localhost:8080</code>。你将看到集成的设备画面预览、实时日志输出以及任务输入框。</p>
<hr/>
<h2 data-id="heading-20">（六）API 服务接入：注入 AI 大脑</h2>
<blockquote>
<p><strong>顶层结论</strong>：AutoGLM 的操作逻辑由云端大模型驱动。目前最成熟的方案是使用智谱 AI 的 <code>autoglm-phone</code> 模型。</p>
</blockquote>
<h3 data-id="heading-21">1. 密钥申请步骤</h3>
<ol>
<li><strong>注册账号</strong>：访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.bigmodel.cn%2F" target="_blank" title="https://open.bigmodel.cn/" ref="nofollow noopener noreferrer">智谱 AI 开放平台</a>。</li>
<li><strong>获取 API Key</strong>：在控制台左侧“API Keys”页面点击创建。</li>
<li><strong>模型权限</strong>：确保账户余额充足（新手通常有免费额度）并拥有 <code>autoglm-phone</code> 访问权限。</li>
</ol>
<h3 data-id="heading-22">2. 环境变量一键配置</h3>
<p>为了避免每次运行都输入长字符串，建议配置全局环境变量：</p>
<ul>
<li><strong>Windows (PowerShell)</strong> : <code>$env:AUTOGLM_API_KEY="你的密钥"</code></li>
<li><strong>Mac/Linux (Terminal)</strong> : <code>export AUTOGLM_API_KEY="你的密钥"</code></li>
</ul>
<hr/>
<h2 data-id="heading-23">（七）全场景实战与终极避坑</h2>
<blockquote>
<p><strong>顶层结论</strong>：实战是检验配置的唯一标准。本模块提供双端测试命令及针对“三合一”集成后最常见问题的解决方案。</p>
</blockquote>
<h3 data-id="heading-24">1. 命令行测试（全平台命令对比）</h3>





















<table><thead><tr><th><strong>系统</strong></th><th><strong>运行命令示例</strong></th></tr></thead><tbody><tr><td><strong>Windows (PS)</strong></td><td><code>python main.py --model "autoglm-phone" --apikey "xxx" "打开微信发测试消息"</code></td></tr><tr><td><strong>macOS (Zsh)</strong></td><td><code>python3 main.py --model "autoglm-phone" --apikey "xxx" "打开微信发测试消息"</code></td></tr><tr><td><strong>Linux (Bash)</strong></td><td><code>python3 main.py --model "autoglm-phone" --apikey "xxx" "打开微信发测试消息"</code></td></tr></tbody></table>
<h3 data-id="heading-25">2. 终极报错排查手册</h3>



































<table><thead><tr><th><strong>错误代码 / 现象</strong></th><th><strong>可能原因</strong></th><th><strong>终极解决方案</strong></th></tr></thead><tbody><tr><td><strong>404 Not Found</strong></td><td>API URL 错误或模型名拼错</td><td>检查 base-url 结尾是否包含 <code>/v4</code>，确保 model 准确为 <code>autoglm-phone</code>。</td></tr><tr><td><strong>ADB Offline / Unauthorized</strong></td><td>手机端授权过期</td><td>拔插数据线，点击手机弹窗中的“始终允许此电脑调试”。</td></tr><tr><td><strong>GUI 启动提示端口占用</strong></td><td>8080 端口被其他服务占用</td><td>使用 <code>autoglm-gui --port 8081</code> 切换到空闲端口。</td></tr><tr><td><strong>iOS WDA 无法连接</strong></td><td>签名证书过期或端口未转发</td><td>重新运行 <code>tidevice relay 8100 8100</code> 确保通道畅通。</td></tr><tr><td><strong>Android 无法模拟点击</strong></td><td>小米手机“安全设置”未开</td><td>检查开发者选项，必须开启“USB 调试（安全设置）”。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-26">最后</h2>
<blockquote>
<p>恭喜你！通过这篇“三合一”全能手册，你已经打通了从底层硬件驱动（ADB/WDA）到高层 AI 可视化操控（GUI）的完整链路。AutoGLM 已经可以在你的指令下，在 Windows、Mac、Linux 三大系统上自如操控 iOS 与 Android 设备。</p>
</blockquote>
<blockquote>
<p><strong>如果你在安装过程中遇到任何奇怪的报错，欢迎在评论区贴出你的 Traceback 日志，我会第一时间为你诊断！</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-27">更多</h2>
<p>💻 Vue3 多端统一开发框架：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FZsTs119%2Fvue3-multi-platform" target="_blank" title="https://github.com/ZsTs119/vue3-multi-platform" ref="nofollow noopener noreferrer">vue3-multi-platform</a></p>
<p>📊 HuggingFaceAI 论文智能分析系统：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FZsTs119%2Fai-paper-analyzer" target="_blank" title="https://github.com/ZsTs119/ai-paper-analyzer" ref="nofollow noopener noreferrer">ai-paper-analyzer</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据可视化大屏模板：前端开发的效率革命与架构艺术]]></title>    <link>https://juejin.cn/post/7586889698241445951</link>    <guid>https://juejin.cn/post/7586889698241445951</guid>    <pubDate>2025-12-23T07:47:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586889698241445951" data-draft-id="7586902693856542762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据可视化大屏模板：前端开发的效率革命与架构艺术"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:47:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_chiu"/> <meta itemprop="url" content="https://juejin.cn/user/1644525124592974"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据可视化大屏模板：前端开发的效率革命与架构艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1644525124592974/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_chiu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:47:31.000Z" title="Tue Dec 23 2025 07:47:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>深夜，资深前端工程师李峰面对第7个类似的可视化大屏需求陷入了沉思——同样的ECharts配置，同样的布局调整，同样繁琐的数据对接。而隔壁组的新人王明却已经通过一套模板系统，在3小时内交付了一个省级智慧城市的数据大屏。</p>
</blockquote>
<p>在2024年Stack Overflow开发者调查中，<strong>76%的前端开发者</strong>表示曾参与过数据可视化项目，而其中<strong>超过60%</strong> 抱怨“重复开发类似界面”是最大的痛点。与此同时，GitHub上标有“dashboard-template”的仓库星标数在过去一年增长了217%，揭示了模板化开发正在成为前端可视化领域的新趋势。</p>
<h2 data-id="heading-0">01 为何需要大屏模板：从重复劳动到高效开发</h2>
<p>每个前端开发者都经历过这样的场景：接到一个新的数据可视化需求，打开上次项目的代码，开始“借鉴”图表配置、布局CSS和数据处理逻辑。这种模式存在几个根本问题：</p>
<p><strong>技术债务累积</strong>：每次“复制-修改”都会带入特定业务的耦合代码，随着时间推移，项目变得难以维护。</p>
<p><strong>设计不一致</strong>：不同开发者甚至同一开发者在不同时间创建的可视化组件，在交互逻辑、颜色主题和响应方式上存在差异。</p>
<p><strong>开发效率低下</strong>：据统计，一个中等复杂度的数据大屏（包含10-15个图表组件）从零开发平均需要80-120小时，而基于高质量模板可将时间缩短至20-30小时。</p>
<p>模板化开发的本质是将通用解决方案产品化。一个好的大屏模板不仅是UI组件的集合，更是一套包含<strong>数据流管理、主题配置、响应式规则和性能优化</strong>的完整架构。</p>
<h2 data-id="heading-1">02 主流大屏模板架构解析</h2>
<p>现代数据可视化大屏模板通常采用分层架构设计，以下是一个典型的技术栈构成：</p>
<p><strong>可视化层</strong>：基于ECharts、AntV或D3.js的图表组件库，提供柱状图、折线图、饼图、地图等基础可视化元素。</p>
<p><strong>布局层</strong>：采用网格布局系统（如Grid Layout）或自由布局引擎，支持拖拽调整和响应式适配。</p>
<p><strong>数据层</strong>：统一的数据获取、转换和状态管理机制，常基于Redux、Mobx或Vuex实现。</p>
<p><strong>主题层</strong>：可配置的颜色、字体、间距系统，支持亮色/暗色模式切换。</p>
<p><strong>工具层</strong>：包含开发调试工具、性能监控和构建配置。</p>
<p>以阿里DataV为例，其模板系统采用了基于JSON Schema的配置驱动架构：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简化的模板配置示例</span>
{
  <span class="hljs-string">"templateMeta"</span>: {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"智慧城市监控模板"</span>,
    <span class="hljs-string">"version"</span>: <span class="hljs-string">"2.1.0"</span>,
    <span class="hljs-string">"author"</span>: <span class="hljs-string">"DataV Team"</span>
  },
  <span class="hljs-string">"layout"</span>: {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"responsive-grid"</span>,
    <span class="hljs-string">"breakpoints"</span>: [<span class="hljs-number">1920</span>, <span class="hljs-number">1440</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">768</span>],
    <span class="hljs-string">"columns"</span>: <span class="hljs-number">24</span>
  },
  <span class="hljs-string">"widgets"</span>: [
    {
      <span class="hljs-string">"id"</span>: <span class="hljs-string">"real-time-flow"</span>,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"echarts-line"</span>,
      <span class="hljs-string">"position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"w"</span>: <span class="hljs-number">8</span>, <span class="hljs-string">"h"</span>: <span class="hljs-number">6</span> },
      <span class="hljs-string">"dataConfig"</span>: {
        <span class="hljs-string">"source"</span>: <span class="hljs-string">"api://realtime/flow"</span>,
        <span class="hljs-string">"refreshInterval"</span>: <span class="hljs-number">5000</span>
      },
      <span class="hljs-string">"styleConfig"</span>: {
        <span class="hljs-string">"theme"</span>: <span class="hljs-string">"auto"</span>,
        <span class="hljs-string">"colors"</span>: [<span class="hljs-string">"#5470c6"</span>, <span class="hljs-string">"#91cc75"</span>]
      }
    }
  ],
  <span class="hljs-string">"dataSources"</span>: {
    <span class="hljs-string">"defaultAdapter"</span>: <span class="hljs-string">"axios"</span>,
    <span class="hljs-string">"interceptors"</span>: [<span class="hljs-string">"auth"</span>, <span class="hljs-string">"error-handler"</span>]
  }
}
</code></pre>
<p>这种配置驱动的设计使得非技术人员也能通过修改JSON配置来调整大屏布局和内容，大幅降低了使用门槛。</p>
<h2 data-id="heading-2">03 实战：基于Vue3+ECharts的模块化大屏模板</h2>
<p>下面我们以Vue3技术栈为例，构建一个企业级大屏模板的核心部分：</p>
<h3 data-id="heading-3">可复用的图表组件设计</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- BaseChart.vue - 基础图表组件 --&gt;
&lt;template&gt;
  &lt;div class="chart-container" :style="containerStyle"&gt;
    &lt;div v-if="loading" class="chart-loading"&gt;
      &lt;LoadingSpinner /&gt;
    &lt;/div&gt;
    &lt;div v-else-if="error" class="chart-error"&gt;
      &lt;ErrorDisplay :message="error.message" /&gt;
    &lt;/div&gt;
    &lt;div v-else ref="chartEl" class="chart-canvas"&gt;&lt;/div&gt;
    
    &lt;!-- 工具栏 --&gt;
    &lt;ChartToolbar 
      v-if="showToolbar"
      @download="handleDownload"
      @fullscreen="handleFullscreen"
      @refresh="handleRefresh"
    /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted, onUnmounted, watch } from 'vue'
import * as echarts from 'echarts'
import { useResizeObserver } from '@vueuse/core'
import { debounce } from 'lodash-es'

const props = defineProps({
  options: { type: Object, required: true },
  autoResize: { type: Boolean, default: true },
  theme: { type: String, default: 'light' },
  loading: { type: Boolean, default: false },
  error: { type: Object, default: null }
})

const chartEl = ref(null)
let chartInstance = null

// 初始化图表
const initChart = () =&gt; {
  if (!chartEl.value) return
  
  chartInstance = echarts.init(chartEl.value, props.theme)
  chartInstance.setOption(props.options)
  
  // 添加响应式支持
  if (props.autoResize) {
    const { stop } = useResizeObserver(chartEl, debounce(() =&gt; {
      chartInstance?.resize()
    }, 300))
    
    onUnmounted(stop)
  }
}

// 监听选项变化
watch(() =&gt; props.options, (newOptions) =&gt; {
  if (chartInstance) {
    chartInstance.setOption(newOptions, true)
  }
}, { deep: true })

onMounted(initChart)
onUnmounted(() =&gt; {
  chartInstance?.dispose()
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-4">数据源抽象层</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// datasource/adapters/index.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAdapter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = config
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subscribers</span> = []
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">dataConfig</span>) {
    <span class="hljs-keyword">const</span> cacheKey = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateCacheKey</span>(dataConfig)
    
    <span class="hljs-comment">// 检查缓存</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">has</span>(cacheKey) &amp;&amp; !dataConfig.<span class="hljs-property">forceUpdate</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">get</span>(cacheKey)
    }
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeFetch</span>(dataConfig)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">set</span>(cacheKey, data)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifySubscribers</span>(dataConfig, data)
      <span class="hljs-keyword">return</span> data
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleError</span>(error, dataConfig)
      <span class="hljs-keyword">throw</span> error
    }
  }
  
  <span class="hljs-comment">// 抽象方法，由具体适配器实现</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">executeFetch</span>(<span class="hljs-params">dataConfig</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'executeFetch must be implemented'</span>)
  }
}

<span class="hljs-comment">// API数据源适配器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">DataSourceAdapter</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">executeFetch</span>(<span class="hljs-params">dataConfig</span>) {
    <span class="hljs-keyword">const</span> { url, method = <span class="hljs-string">'GET'</span>, params, headers } = dataConfig
    
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, {
      method,
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
        ...headers
      },
      <span class="hljs-attr">body</span>: method !== <span class="hljs-string">'GET'</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params) : <span class="hljs-literal">undefined</span>
    })
    
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP <span class="hljs-subst">${response.status}</span>: <span class="hljs-subst">${response.statusText}</span>`</span>)
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
  }
}

<span class="hljs-comment">// WebSocket实时数据适配器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">DataSourceAdapter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-variable language_">super</span>(config)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> = <span class="hljs-literal">null</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectAttempts</span> = <span class="hljs-number">0</span>
  }
  
  <span class="hljs-title function_">connect</span>(<span class="hljs-params">dataConfig</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>) <span class="hljs-keyword">return</span>
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(dataConfig.<span class="hljs-property">url</span>)
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifySubscribers</span>(dataConfig, data)
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleReconnection</span>(dataConfig)
    }
  }
}
</code></pre>
<h3 data-id="heading-5">布局管理系统</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// layout/LayoutEngine.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LayoutEngine</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">container, config</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = container
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = config
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">widgets</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoints</span> = [<span class="hljs-number">1920</span>, <span class="hljs-number">1440</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">768</span>, <span class="hljs-number">480</span>]
  }
  
  <span class="hljs-comment">// 响应式布局计算</span>
  <span class="hljs-title function_">calculateLayout</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> width = <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">clientWidth</span>
    <span class="hljs-keyword">const</span> currentBreakpoint = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getCurrentBreakpoint</span>(width)
    
    <span class="hljs-comment">// 基于断点的布局规则</span>
    <span class="hljs-keyword">const</span> layoutRules = {
      <span class="hljs-number">1920</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">24</span> },
      <span class="hljs-number">1440</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">20</span> },
      <span class="hljs-number">1024</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">16</span> },
      <span class="hljs-number">768</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">12</span> },
      <span class="hljs-number">480</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">8</span> }
    }
    
    <span class="hljs-keyword">return</span> layoutRules[currentBreakpoint]
  }
  
  <span class="hljs-comment">// 网格位置计算</span>
  <span class="hljs-title function_">computeWidgetPosition</span>(<span class="hljs-params">widgetConfig</span>) {
    <span class="hljs-keyword">const</span> layout = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateLayout</span>()
    <span class="hljs-keyword">const</span> { x, y, w, h } = widgetConfig.<span class="hljs-property">position</span>
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">left</span>: (x / layout.<span class="hljs-property">columns</span>) * <span class="hljs-number">100</span> + <span class="hljs-string">'%'</span>,
      <span class="hljs-attr">top</span>: (y * (layout.<span class="hljs-property">rowHeight</span> || <span class="hljs-number">50</span>)) + <span class="hljs-string">'px'</span>,
      <span class="hljs-attr">width</span>: <span class="hljs-string">`calc(<span class="hljs-subst">${(w / layout.columns) * <span class="hljs-number">100</span>}</span>% - <span class="hljs-subst">${layout.gutter}</span>px)`</span>,
      <span class="hljs-attr">height</span>: (h * (layout.<span class="hljs-property">rowHeight</span> || <span class="hljs-number">50</span>)) + <span class="hljs-string">'px'</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-6">04 模板性能优化策略</h2>
<p>大屏模板需要处理大量数据和高频率更新，性能优化至关重要：</p>
<p><strong>图表实例池管理</strong>：避免频繁创建销毁ECharts实例</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChartPool</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">maxSize = <span class="hljs-number">10</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span> = maxSize
  }
  
  <span class="hljs-title function_">getInstance</span>(<span class="hljs-params">key, initFn</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">has</span>(key)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">get</span>(key)
    }
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-property">size</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">evictOldest</span>()
    }
    
    <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">initFn</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">set</span>(key, instance)
    <span class="hljs-keyword">return</span> instance
  }
  
  <span class="hljs-title function_">evictOldest</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> oldestKey = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>
    <span class="hljs-keyword">const</span> instance = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">get</span>(oldestKey)
    instance.<span class="hljs-title function_">dispose</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">delete</span>(oldestKey)
  }
}
</code></pre>
<p><strong>数据更新批处理</strong>：避免频繁重绘</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createBatchUpdater</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> updateQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
  <span class="hljs-keyword">let</span> isUpdating = <span class="hljs-literal">false</span>
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">scheduleUpdate</span>(<span class="hljs-params">widgetId, updateFn</span>) {
      updateQueue.<span class="hljs-title function_">set</span>(widgetId, updateFn)
      
      <span class="hljs-keyword">if</span> (!isUpdating) {
        isUpdating = <span class="hljs-literal">true</span>
        <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flushUpdates</span>()
        })
      }
    },
    
    <span class="hljs-title function_">flushUpdates</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> updates = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(updateQueue.<span class="hljs-title function_">entries</span>())
      updateQueue.<span class="hljs-title function_">clear</span>()
      
      <span class="hljs-comment">// 批量执行更新</span>
      updates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[id, updateFn]</span>) =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-title function_">updateFn</span>()
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Update failed for widget <span class="hljs-subst">${id}</span>:`</span>, error)
        }
      })
      
      isUpdating = <span class="hljs-literal">false</span>
    }
  }
}
</code></pre>
<p><strong>虚拟滚动长列表</strong>：处理大数据集展示</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- VirtualScrollChart.vue --&gt;
&lt;template&gt;
  &lt;div class="virtual-scroll-container" @scroll="handleScroll"&gt;
    &lt;div class="scroll-content" :style="{ height: totalHeight + 'px' }"&gt;
      &lt;div 
        v-for="item in visibleItems" 
        :key="item.id"
        class="scroll-item"
        :style="{ transform: `translateY(${item.offset}px)` }"
      &gt;
        &lt;slot name="item" :item="item.data"&gt;&lt;/slot&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-7">05 模板定制与扩展机制</h2>
<p>优秀的大屏模板需要提供灵活的定制能力：</p>
<p><strong>主题系统</strong>：支持动态主题切换</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// themes/_variables.scss</span>
<span class="hljs-variable">$themes</span>: (
  light: (
    primary-bg: <span class="hljs-number">#ffffff</span>,
    chart-grid: <span class="hljs-number">#f0f0f0</span>,
    text-primary: <span class="hljs-number">#333333</span>,
  ),
  dark: (
    primary-bg: <span class="hljs-number">#1a1a1a</span>,
    chart-grid: <span class="hljs-number">#2a2a2a</span>,
    text-primary: <span class="hljs-number">#e0e0e0</span>,
  ),
  blue: (
    primary-bg: <span class="hljs-number">#f0f8ff</span>,
    chart-grid: <span class="hljs-number">#d9e7ff</span>,
    text-primary: <span class="hljs-number">#003366</span>,
  )
);

<span class="hljs-comment">// 混合器应用主题</span>
<span class="hljs-keyword">@mixin</span> theme(<span class="hljs-variable">$property</span>, <span class="hljs-variable">$key</span>, <span class="hljs-variable">$theme</span>: <span class="hljs-string">'light'</span>) {
  #{<span class="hljs-variable">$property</span>}: <span class="hljs-built_in">map-get</span>(<span class="hljs-built_in">map-get</span>(<span class="hljs-variable">$themes</span>, <span class="hljs-variable">$theme</span>), <span class="hljs-variable">$key</span>);
}
</code></pre>
<p><strong>插件系统</strong>：允许功能扩展</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplatePluginSystem</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">plugins</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span> = {
      <span class="hljs-string">'before-data-fetch'</span>: [],
      <span class="hljs-string">'after-chart-init'</span>: [],
      <span class="hljs-string">'layout-calculated'</span>: []
    }
  }
  
  <span class="hljs-title function_">registerPlugin</span>(<span class="hljs-params">name, plugin</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">plugins</span>.<span class="hljs-title function_">set</span>(name, plugin)
    
    <span class="hljs-comment">// 注册插件钩子</span>
    <span class="hljs-keyword">if</span> (plugin.<span class="hljs-property">hooks</span>) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(plugin.<span class="hljs-property">hooks</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">hookName</span> =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">registerHook</span>(hookName, plugin.<span class="hljs-property">hooks</span>[hookName])
      })
    }
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">triggerHook</span>(<span class="hljs-params">hookName, context</span>) {
    <span class="hljs-keyword">const</span> hooks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>[hookName] || []
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> hook <span class="hljs-keyword">of</span> hooks) {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">hook</span>(context)
    }
  }
}
</code></pre>
<h2 data-id="heading-8">06 开源大屏模板资源评测</h2>















































<table><thead><tr><th>模板名称</th><th>技术栈</th><th>特色功能</th><th>学习曲线</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>VueDataV</strong></td><td>Vue3 + ECharts</td><td>3D地球、飞线图、拖拽布局</td><td>中等</td><td>政府/企业大屏</td></tr><tr><td><strong>Ant Design Charts</strong></td><td>React + AntV</td><td>企业级设计系统、丰富图表</td><td>较低</td><td>中后台系统</td></tr><tr><td><strong>D3.js Dashboard</strong></td><td>D3.js + React</td><td>高度自定义、复杂可视化</td><td>高</td><td>数据密集型分析</td></tr><tr><td><strong>Apache Superset</strong></td><td>React + 多种引擎</td><td>完整BI解决方案、SQL编辑</td><td>中等</td><td>商业智能平台</td></tr><tr><td><strong>Grafana</strong></td><td>React + Flot</td><td>监控专用、警报系统</td><td>中等</td><td>运维监控大屏</td></tr></tbody></table>
<h2 data-id="heading-9">07 从使用模板到贡献模板</h2>
<p>作为前端开发者，使用模板只是起点，真正的成长在于理解模板背后的设计思想并做出贡献：</p>
<ol>
<li><strong>源码学习</strong>：选择1-2个高质量开源模板，深入研究其架构设计</li>
<li><strong>定制开发</strong>：基于业务需求对模板进行二次开发</li>
<li><strong>抽象封装</strong>：将通用功能提取为可复用组件或插件</li>
<li><strong>开源贡献</strong>：修复bug、添加功能或完善文档</li>
</ol>
<p>大屏模板的真正价值不在于减少编码量，而在于<strong>标准化开发流程、提升代码质量、统一设计语言</strong>。当你的团队拥有自己的模板库时，新项目启动时间可以从数周缩短到数小时，而且能保持所有项目的一致性和可维护性。</p>
<hr/>
<p>深圳某智慧城市项目指挥中心，三块4K大屏实时展示着城市运行的800多项指标。年轻的开发者张涛在屏幕前调试着新的交通流量预测模块——基于团队自研的大屏模板，他仅用两天就集成了这个原本需要两周的功能。</p>
<p>在他身后，模板配置平台显示着<strong>187个</strong>正在运行的定制化大屏实例，而核心模板库的更新记录显示，最新一次优化将大屏的首屏加载时间从<strong>3.2秒降低到1.4秒</strong>。这不仅是技术的进步，更是前端开发范式的转变——从手工作坊到标准化生产的进化之路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【TS】虚拟列表无渲染逻辑内核]]></title>    <link>https://juejin.cn/post/7586890269698621494</link>    <guid>https://juejin.cn/post/7586890269698621494</guid>    <pubDate>2025-12-23T07:51:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586890269698621494" data-draft-id="7586879894206939199" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【TS】虚拟列表无渲染逻辑内核"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:51:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="七月十二"/> <meta itemprop="url" content="https://juejin.cn/user/145549432455998"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【TS】虚拟列表无渲染逻辑内核
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/145549432455998/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    七月十二
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:51:17.000Z" title="Tue Dec 23 2025 07:51:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">VirtualCore</h2>
<p>虚拟列表无渲染逻辑内核，专注于位置计算与状态管理，不绑定任何 UI 框架。</p>
<h3 data-id="heading-1">特性</h3>
<ul>
<li><strong>框架无关</strong>：纯 TypeScript 实现，可配合 Vue、React、原生 JS 等任意框架使用</li>
<li><strong>动态高度</strong>：支持每行不同高度，实测后自动更新位置信息</li>
<li><strong>滚动锚定</strong>：高度变化时自动计算滚动补偿，避免内容跳动</li>
<li><strong>精确跳转</strong>：迭代收敛式跳转算法，确保准确定位到目标行</li>
<li><strong>动态数据</strong>：支持运行时增减列表总数</li>
</ul>
<h3 data-id="heading-2">快速开始</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">VirtualCore</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./VirtualCore'</span>

<span class="hljs-comment">// 1. 创建实例</span>
<span class="hljs-keyword">const</span> core = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VirtualCore</span>({
  <span class="hljs-attr">total</span>: <span class="hljs-number">1000</span>,           <span class="hljs-comment">// 列表总数</span>
  <span class="hljs-attr">defaultHeight</span>: <span class="hljs-number">50</span>,     <span class="hljs-comment">// 预估行高</span>
  <span class="hljs-attr">buffer</span>: <span class="hljs-number">5</span>,             <span class="hljs-comment">// 上下缓冲行数（可选，默认 5）</span>
  <span class="hljs-attr">onTotalHeightChange</span>: <span class="hljs-function">(<span class="hljs-params">height</span>) =&gt;</span> {
    <span class="hljs-comment">// 更新容器总高度</span>
    container.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${height}</span>px`</span>
  }
})

<span class="hljs-comment">// 2. 滚动时获取渲染范围</span>
container.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> { startIndex, endIndex, offset } = core.<span class="hljs-title function_">getRenderRange</span>(
    container.<span class="hljs-property">scrollTop</span>,
    container.<span class="hljs-property">clientHeight</span>
  )
  
  <span class="hljs-comment">// 渲染 startIndex ~ endIndex 范围的数据</span>
  <span class="hljs-comment">// offset 是列表容器的 translateY 偏移量</span>
})

<span class="hljs-comment">// 3. 元素渲染后更新真实高度</span>
<span class="hljs-keyword">const</span> updates = renderedItems.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
  <span class="hljs-attr">index</span>: item.<span class="hljs-property">index</span>,
  <span class="hljs-attr">height</span>: item.<span class="hljs-property">element</span>.<span class="hljs-property">offsetHeight</span>
}))

<span class="hljs-keyword">const</span> { scrollCorrection } = core.<span class="hljs-title function_">updateHeights</span>(updates, container.<span class="hljs-property">scrollTop</span>)

<span class="hljs-comment">// 应用滚动补偿，防止内容跳动</span>
<span class="hljs-keyword">if</span> (scrollCorrection !== <span class="hljs-number">0</span>) {
  container.<span class="hljs-property">scrollTop</span> += scrollCorrection
}
</code></pre>
<h3 data-id="heading-3">API</h3>
<h4 data-id="heading-4">构造函数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">VirtualCore</span>(<span class="hljs-attr">config</span>: <span class="hljs-title class_">VirtualCoreConfig</span>)
</code></pre>








































<table><thead><tr><th>参数</th><th>类型</th><th>必填</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>total</code></td><td><code>number</code></td><td>是</td><td>-</td><td>列表总行数</td></tr><tr><td><code>defaultHeight</code></td><td><code>number</code></td><td>是</td><td>-</td><td>预估默认行高</td></tr><tr><td><code>buffer</code></td><td><code>number</code></td><td>否</td><td><code>5</code></td><td>可视区域外的缓冲行数</td></tr><tr><td><code>onTotalHeightChange</code></td><td><code>(height: number) =&gt; void</code></td><td>否</td><td>-</td><td>总高度变化回调</td></tr></tbody></table>
<h4 data-id="heading-5">核心方法</h4>
<h5 data-id="heading-6"><code>getRenderRange(scrollTop, viewHeight): RenderRange</code></h5>
<p>根据滚动位置计算需要渲染的行范围。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> range = core.<span class="hljs-title function_">getRenderRange</span>(scrollTop, viewHeight)

<span class="hljs-comment">// 返回值</span>
{
  <span class="hljs-attr">startIndex</span>: <span class="hljs-built_in">number</span>   <span class="hljs-comment">// 渲染起始索引</span>
  <span class="hljs-attr">endIndex</span>: <span class="hljs-built_in">number</span>     <span class="hljs-comment">// 渲染结束索引</span>
  <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span>       <span class="hljs-comment">// 列表容器的 Y 轴偏移量</span>
  <span class="hljs-attr">anchorIndex</span>: <span class="hljs-built_in">number</span>  <span class="hljs-comment">// 锚点索引（可视区域第一行）</span>
}
</code></pre>
<h5 data-id="heading-7"><code>updateHeights(updates, currentScrollTop): UpdateCorrection</code></h5>
<p>批量更新行高，返回滚动补偿值。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> { scrollCorrection } = core.<span class="hljs-title function_">updateHeights</span>([
  { <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">80</span> },
  { <span class="hljs-attr">index</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">60</span> }
], container.<span class="hljs-property">scrollTop</span>)

<span class="hljs-comment">// 应用补偿</span>
container.<span class="hljs-property">scrollTop</span> += scrollCorrection
</code></pre>
<h5 data-id="heading-8"><code>scrollToIndex(index, callbacks, options?)</code></h5>
<p>迭代收敛式精确跳转到指定行。</p>
<pre><code class="hljs language-typescript" lang="typescript">core.<span class="hljs-title function_">scrollToIndex</span>(<span class="hljs-number">100</span>, {
  <span class="hljs-attr">onScroll</span>: <span class="hljs-function">(<span class="hljs-params">targetTop</span>) =&gt;</span> {
    <span class="hljs-comment">// 执行滚动，可返回 Promise</span>
    container.<span class="hljs-title function_">scrollTo</span>({ <span class="hljs-attr">top</span>: targetTop, <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> })
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
      <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">300</span>) <span class="hljs-comment">// 等待动画完成</span>
    })
  },
  <span class="hljs-attr">onComplete</span>: <span class="hljs-function">(<span class="hljs-params">finalTop, iterations</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`跳转完成，经过 <span class="hljs-subst">${iterations}</span> 次迭代`</span>)
  },
  <span class="hljs-attr">onAbort</span>: <span class="hljs-function">(<span class="hljs-params">reason</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`跳转中断: <span class="hljs-subst">${reason}</span>`</span>)
  }
}, {
  <span class="hljs-attr">threshold</span>: <span class="hljs-number">10</span>,      <span class="hljs-comment">// 收敛阈值（可选）</span>
  <span class="hljs-attr">maxIterations</span>: <span class="hljs-number">10</span>   <span class="hljs-comment">// 最大迭代次数（可选）</span>
})
</code></pre>
<h4 data-id="heading-9">辅助方法</h4>









































<table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>getTotalHeight()</code></td><td>获取列表总高度</td></tr><tr><td><code>getTopByIndex(index)</code></td><td>获取指定行的 top 值</td></tr><tr><td><code>getItemPosition(index)</code></td><td>获取指定行的完整位置信息</td></tr><tr><td><code>setTotal(newTotal)</code></td><td>动态设置列表总数</td></tr><tr><td><code>getTotal()</code></td><td>获取当前列表总数</td></tr><tr><td><code>reset(newTotal?)</code></td><td>重置所有位置信息</td></tr><tr><td><code>abortScrollTo()</code></td><td>手动中断跳转</td></tr><tr><td><code>isScrolling()</code></td><td>检查是否正在跳转中</td></tr></tbody></table>
<h3 data-id="heading-10">使用示例</h3>
<h4 data-id="heading-11">Vue 3 组合式 API</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { ref, onMounted, computed } from 'vue'
import VirtualCore from './VirtualCore'

const props = defineProps&lt;{ items: any[] }&gt;()

const containerRef = ref&lt;HTMLElement&gt;()
const scrollTop = ref(0)
const totalHeight = ref(0)

const core = new VirtualCore({
  total: props.items.length,
  defaultHeight: 50,
  onTotalHeightChange: (h) =&gt; { totalHeight.value = h }
})

const renderRange = computed(() =&gt; 
  core.getRenderRange(scrollTop.value, containerRef.value?.clientHeight || 0)
)

const visibleItems = computed(() =&gt; {
  const { startIndex, endIndex } = renderRange.value
  return props.items.slice(startIndex, endIndex + 1).map((item, i) =&gt; ({
    ...item,
    _index: startIndex + i
  }))
})

function onScroll(e: Event) {
  scrollTop.value = (e.target as HTMLElement).scrollTop
}

// 渲染后更新高度
function updateItemHeights(elements: HTMLElement[]) {
  const updates = elements.map((el, i) =&gt; ({
    index: renderRange.value.startIndex + i,
    height: el.offsetHeight
  }))
  
  const { scrollCorrection } = core.updateHeights(updates, scrollTop.value)
  if (scrollCorrection &amp;&amp; containerRef.value) {
    containerRef.value.scrollTop += scrollCorrection
  }
}
&lt;/script&gt;

&lt;template&gt;
  &lt;div ref="containerRef" class="virtual-container" @scroll="onScroll"&gt;
    &lt;div :style="{ height: totalHeight + 'px' }"&gt;
      &lt;div :style="{ transform: `translateY(${renderRange.offset}px)` }"&gt;
        &lt;div v-for="item in visibleItems" :key="item._index"&gt;
          &lt;!-- 渲染内容 --&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-12">跳转到指定行</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">scrollToRow</span>(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>) {
  core.<span class="hljs-title function_">scrollToIndex</span>(index, {
    <span class="hljs-attr">onScroll</span>: <span class="hljs-function">(<span class="hljs-params">top</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
        containerRef.<span class="hljs-property">value</span>?.<span class="hljs-title function_">scrollTo</span>({ top, <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> })
        <span class="hljs-comment">// 等待滚动动画</span>
        <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">300</span>)
      })
    },
    <span class="hljs-attr">onComplete</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'跳转完成'</span>)
    }
  })
}
</code></pre>
<h3 data-id="heading-13">注意事项</h3>
<h4 data-id="heading-14">性能相关</h4>
<ul>
<li><strong>超大列表</strong>：超过 10 万行时，频繁的高度更新可能有性能影响</li>
<li><strong>批量更新</strong>：尽量合并多次 <code>updateHeights</code> 调用为一次批量更新</li>
<li><strong>预估高度</strong>：<code>defaultHeight</code> 越接近真实高度，初次渲染的跳动越小</li>
</ul>
<h4 data-id="heading-15">回调限制</h4>
<ul>
<li><code>onTotalHeightChange</code> 回调中<strong>不要</strong>调用 VirtualCore 的任何修改方法，避免重入问题</li>
</ul>
<h4 data-id="heading-16">跳转行为</h4>
<ul>
<li>跳转采用迭代收敛算法，目标行之前的元素高度确定后才能精确定位</li>
<li>如果目标行很远且中间元素高度差异大，可能需要多次迭代</li>
<li>可通过 <code>maxIterations</code> 限制最大迭代次数，避免极端情况</li>
</ul>
<h4 data-id="heading-17">滚动锚定</h4>
<ul>
<li>只有<strong>完全在视口上方</strong>的元素高度变化才会触发滚动补偿</li>
<li>跨越视口边界或在视口内的元素高度变化不补偿，避免干扰用户操作</li>
</ul>
<h3 data-id="heading-18">类型定义</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ItemPosition</span> {
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">top</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">bottom</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HeightUpdate</span> {
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">RenderRange</span> {
  <span class="hljs-attr">startIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">endIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">anchorIndex</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UpdateCorrection</span> {
  <span class="hljs-attr">scrollCorrection</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToCallbacks</span> {
  <span class="hljs-attr">onScroll</span>: <span class="hljs-function">(<span class="hljs-params">targetTop: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;
  onComplete?: <span class="hljs-function">(<span class="hljs-params">finalTop: <span class="hljs-built_in">number</span>, iterations: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
  onAbort?: <span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToOptions</span> {
  threshold?: <span class="hljs-built_in">number</span>
  maxIterations?: <span class="hljs-built_in">number</span>
}
</code></pre>
<h2 data-id="heading-19">源码</h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 每一行位置信息的接口定义
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ItemPosition</span> {
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">top</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">bottom</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 更新行高请求的接口定义
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HeightUpdate</span> {
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 渲染范围的接口定义
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">RenderRange</span> {
  <span class="hljs-attr">startIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">endIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">anchorIndex</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 高度更新返回的修正值接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UpdateCorrection</span> {
  <span class="hljs-attr">scrollCorrection</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 初始化配置接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">VirtualCoreConfig</span> {
  <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">defaultHeight</span>: <span class="hljs-built_in">number</span>
  buffer?: <span class="hljs-built_in">number</span>
  onTotalHeightChange?: <span class="hljs-function">(<span class="hljs-params">totalHeight: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-comment">/**
 * 跳转回调接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToCallbacks</span> {
  <span class="hljs-comment">/** 需要滚动到新位置时调用，返回 Promise 表示滚动动画完成 */</span>
  <span class="hljs-attr">onScroll</span>: <span class="hljs-function">(<span class="hljs-params">targetTop: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;
  <span class="hljs-comment">/** 跳转完成时调用 */</span>
  onComplete?: <span class="hljs-function">(<span class="hljs-params">finalTop: <span class="hljs-built_in">number</span>, iterations: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
  <span class="hljs-comment">/** 跳转被中断或失败时调用 */</span>
  onAbort?: <span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-comment">/**
 * 跳转配置
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToOptions</span> {
  <span class="hljs-comment">/** 收敛阈值，位置差小于此值认为完成（默认为 defaultHeight） */</span>
  threshold?: <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 最大迭代次数（默认 10） */</span>
  maxIterations?: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 跳转状态
 * - idle: 空闲
 * - scrolling: 正在执行滚动动画
 * - waiting: 滚动完成，等待高度更新
 */</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ScrollToStatus</span> = <span class="hljs-string">'idle'</span> | <span class="hljs-string">'scrolling'</span> | <span class="hljs-string">'waiting'</span>

<span class="hljs-comment">/**
 * 跳转上下文（内部使用）
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToContext</span> {
  <span class="hljs-attr">targetIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 上一次迭代时目标索引的 top 值 */</span>
  <span class="hljs-attr">lastTop</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 当前迭代次数 */</span>
  <span class="hljs-attr">iterations</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">maxIterations</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">threshold</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">callbacks</span>: <span class="hljs-title class_">ScrollToCallbacks</span>
  <span class="hljs-attr">status</span>: <span class="hljs-title class_">ScrollToStatus</span>
  <span class="hljs-comment">/** 在 scrolling 状态期间是否收到了高度更新 */</span>
  <span class="hljs-attr">pendingHeightUpdate</span>: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-comment">/**
 * VirtualCore: 虚拟列表无渲染逻辑内核 (TypeScript 版)
 *
 * 功能：
 * 1. 维护每一行的位置信息 (top, bottom, height)
 * 2. 根据滚动位置计算需要渲染的行范围
 * 3. 支持动态高度更新，并提供滚动锚定
 * 4. 支持动态调整列表总数
 * 5. 迭代收敛式精确跳转
 *
 * 注意事项：
 * - onTotalHeightChange 回调中不应该调用 VirtualCore 的任何修改方法，避免重入问题
 * - 对于超大列表（&gt; 10万行），频繁的高度更新可能会有性能影响
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualCore</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">defaultHeight</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">buffer</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-keyword">private</span> onTotalHeightChange?: <span class="hljs-function">(<span class="hljs-params">totalHeight: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>

  <span class="hljs-keyword">private</span> <span class="hljs-attr">positions</span>: <span class="hljs-title class_">ItemPosition</span>[] = []

  <span class="hljs-comment">/** 跳转上下文 */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">scrollToCtx</span>: <span class="hljs-title class_">ScrollToContext</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config: VirtualCoreConfig</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> = config.<span class="hljs-property">total</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span> = config.<span class="hljs-property">defaultHeight</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span> = config.<span class="hljs-property">buffer</span> ?? <span class="hljs-number">5</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onTotalHeightChange</span> = config.<span class="hljs-property">onTotalHeightChange</span>

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_initPositions</span>()
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 基础方法</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 初始化位置表，预估初始高度
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_initPositions</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span> = []
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i] = {
        <span class="hljs-attr">index</span>: i,
        <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>,
        <span class="hljs-attr">top</span>: i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>,
        <span class="hljs-attr">bottom</span>: (i + <span class="hljs-number">1</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>
      }
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_notifyHeightChange</span>()
  }

  <span class="hljs-comment">/**
   * 获取当前总高度
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getTotalHeight</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> === <span class="hljs-number">0</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    }
    <span class="hljs-keyword">const</span> lastIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> - <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> (lastIndex &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[lastIndex].<span class="hljs-property">bottom</span>
  }

  <span class="hljs-comment">/**
   * 获取渲染区间及偏移量 (核心用于 UI 渲染)
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getRenderRange</span>(<span class="hljs-attr">scrollTop</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">viewHeight</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">RenderRange</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">startIndex</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">endIndex</span>: -<span class="hljs-number">1</span>,
        <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">anchorIndex</span>: <span class="hljs-number">0</span>
      }
    }

    <span class="hljs-keyword">const</span> anchorIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_findStartIndex</span>(scrollTop), <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> - <span class="hljs-number">1</span>)
    <span class="hljs-keyword">const</span> startIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, anchorIndex - <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>)

    <span class="hljs-keyword">const</span> endAnchor = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_findStartIndex</span>(scrollTop + viewHeight)
    <span class="hljs-keyword">const</span> endIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> - <span class="hljs-number">1</span>, endAnchor + <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>)

    <span class="hljs-keyword">const</span> offset = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[startIndex].<span class="hljs-property">top</span>

    <span class="hljs-keyword">return</span> {
      startIndex,
      endIndex,
      offset,
      anchorIndex
    }
  }

  <span class="hljs-comment">/**
   * 获取指定索引的 top 值（仅查询，不触发跳转）
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getTopByIndex</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTotalHeight</span>()
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[index].<span class="hljs-property">top</span>
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 高度更新</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 更新行高并返回修正值
   *
   * <span class="hljs-doctag">@param</span> updates 实测到的真实高度数据集合
   * <span class="hljs-doctag">@param</span> currentScrollTop 容器当前的滚动位置
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">updateHeights</span>(<span class="hljs-attr">updates</span>: <span class="hljs-title class_">HeightUpdate</span>[], <span class="hljs-attr">currentScrollTop</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">UpdateCorrection</span> {
    <span class="hljs-keyword">if</span> (updates.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">scrollCorrection</span>: <span class="hljs-number">0</span> }
    }

    <span class="hljs-keyword">const</span> validUpdates = updates.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">{ index }</span>) =&gt;</span> index &gt;= <span class="hljs-number">0</span> &amp;&amp; index &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>)

    <span class="hljs-keyword">if</span> (validUpdates.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">scrollCorrection</span>: <span class="hljs-number">0</span> }
    }

    validUpdates.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">index</span> - b.<span class="hljs-property">index</span>)

    <span class="hljs-keyword">let</span> scrollCorrection = <span class="hljs-number">0</span>
    <span class="hljs-keyword">let</span> hasHeightChanged = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">let</span> firstChangedIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>

    validUpdates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">{ index, height }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[index]
      <span class="hljs-keyword">const</span> oldHeight = item.<span class="hljs-property">height</span>
      <span class="hljs-keyword">const</span> diff = height - oldHeight

      <span class="hljs-keyword">if</span> (diff !== <span class="hljs-number">0</span>) {
        hasHeightChanged = <span class="hljs-literal">true</span>

        <span class="hljs-keyword">if</span> (index &lt; firstChangedIndex) {
          firstChangedIndex = index
        }

        <span class="hljs-comment">// 改进的滚动锚定逻辑</span>
        <span class="hljs-comment">// 只有当元素完全在视口上方时才进行补偿</span>
        <span class="hljs-keyword">const</span> itemTop = item.<span class="hljs-property">top</span>
        <span class="hljs-keyword">if</span> (itemTop + oldHeight &lt;= currentScrollTop) {
          <span class="hljs-comment">// 元素完全在视口上方</span>
          scrollCorrection += diff
        }
        <span class="hljs-comment">// 元素跨越视口边界或在视口内/下方，不补偿</span>

        item.<span class="hljs-property">height</span> = height
      }
    })

    <span class="hljs-keyword">if</span> (hasHeightChanged) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_recalculatePositions</span>(firstChangedIndex)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_notifyHeightChange</span>()

      <span class="hljs-comment">// 标记有高度更新待处理</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'scrolling'</span>) {
          <span class="hljs-comment">// 滚动进行中收到高度更新，标记待处理</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">pendingHeightUpdate</span> = <span class="hljs-literal">true</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'waiting'</span>) {
          <span class="hljs-comment">// 已经在等待状态，直接检查收敛</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_checkScrollToConvergence</span>()
        }
      }
    }

    <span class="hljs-keyword">return</span> { scrollCorrection }
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 迭代收敛式跳转</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 开始跳转到指定索引（迭代收敛式）
   *
   * <span class="hljs-doctag">@param</span> index 目标行索引
   * <span class="hljs-doctag">@param</span> callbacks 回调函数
   * <span class="hljs-doctag">@param</span> options 配置选项
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">scrollToIndex</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">callbacks</span>: <span class="hljs-title class_">ScrollToCallbacks</span>, options?: <span class="hljs-title class_">ScrollToOptions</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 边界处理</span>
    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) index = <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) index = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> - <span class="hljs-number">1</span>)

    <span class="hljs-comment">// 如果列表为空，直接完成</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> === <span class="hljs-number">0</span>) {
      callbacks.<span class="hljs-property">onComplete</span>?.(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 如果已有跳转进行中，先中断</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'new scroll requested'</span>)
    }

    <span class="hljs-keyword">const</span> threshold = options?.<span class="hljs-property">threshold</span> ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>
    <span class="hljs-keyword">const</span> maxIterations = options?.<span class="hljs-property">maxIterations</span> ?? <span class="hljs-number">10</span>
    <span class="hljs-keyword">const</span> targetTop = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[index].<span class="hljs-property">top</span>

    <span class="hljs-comment">// 初始化跳转上下文</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> = {
      <span class="hljs-attr">targetIndex</span>: index,
      <span class="hljs-attr">lastTop</span>: targetTop, <span class="hljs-comment">// 记录初始目标位置</span>
      <span class="hljs-attr">iterations</span>: <span class="hljs-number">0</span>,
      maxIterations,
      threshold,
      callbacks,
      <span class="hljs-attr">status</span>: <span class="hljs-string">'idle'</span>,
      <span class="hljs-attr">pendingHeightUpdate</span>: <span class="hljs-literal">false</span>
    }

    <span class="hljs-comment">// 触发第一次滚动</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_doScroll</span>(targetTop)
  }

  <span class="hljs-comment">/**
   * 手动中断当前跳转
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">abortScrollTo</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'manually aborted'</span>)
  }

  <span class="hljs-comment">/**
   * 检查是否正在跳转中
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">isScrolling</span>(): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> !== <span class="hljs-literal">null</span>
  }

  <span class="hljs-comment">/**
   * 通知滚动动画完成（外部调用）
   *
   * 当外部滚动动画完成后，应调用此方法通知 VirtualCore
   * 这样可以在下一次 updateHeights 时检查收敛
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">notifyScrollComplete</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'scrolling'</span>) {
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 处理竞态：检查是否有待处理的高度更新</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">pendingHeightUpdate</span> = <span class="hljs-literal">false</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'waiting'</span>

    <span class="hljs-comment">// [修复1] 每次滚动完成后都检查收敛</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_checkScrollToConvergence</span>()
  }

  <span class="hljs-comment">/**
   * 执行滚动
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_doScroll</span>(<span class="hljs-attr">targetTop</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'scrolling'</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">iterations</span>++
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">pendingHeightUpdate</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 重置待处理标记</span>

    <span class="hljs-comment">// 保存当前上下文引用，用于在回调中判断上下文是否已变化</span>
    <span class="hljs-keyword">const</span> currentCtx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>

    <span class="hljs-keyword">const</span> result = currentCtx.<span class="hljs-property">callbacks</span>.<span class="hljs-title function_">onScroll</span>(targetTop)

    <span class="hljs-comment">// 统一处理同步和异步情况</span>
    <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) {
      <span class="hljs-comment">// 异步情况：等待 Promise 完成后通知</span>
      result
        .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-comment">// 只有上下文未变化时才处理，防止误操作新的跳转</span>
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> === currentCtx) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyScrollComplete</span>()
          }
        })
        .<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-comment">// 同样检查上下文</span>
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> === currentCtx) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'scroll failed'</span>)
          }
        })
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 同步情况：使用 microtask 延迟通知</span>
      <span class="hljs-title function_">queueMicrotask</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 检查上下文是否仍然是同一个，且状态仍为 scrolling</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> === currentCtx &amp;&amp; currentCtx.<span class="hljs-property">status</span> === <span class="hljs-string">'scrolling'</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyScrollComplete</span>()
        }
      })
    }
  }

  <span class="hljs-comment">/**
   * 检查跳转是否收敛
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_checkScrollToConvergence</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> ctx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>
    <span class="hljs-keyword">if</span> (!ctx || ctx.<span class="hljs-property">status</span> !== <span class="hljs-string">'waiting'</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">const</span> currentTop = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[ctx.<span class="hljs-property">targetIndex</span>].<span class="hljs-property">top</span>
    <span class="hljs-keyword">const</span> diff = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(currentTop - ctx.<span class="hljs-property">lastTop</span>)

    <span class="hljs-comment">// 检查是否收敛：位置变化小于阈值</span>
    <span class="hljs-keyword">if</span> (diff &lt;= ctx.<span class="hljs-property">threshold</span>) {
      <span class="hljs-comment">// 收敛完成</span>
      <span class="hljs-keyword">const</span> finalTop = currentTop
      <span class="hljs-keyword">const</span> iterations = ctx.<span class="hljs-property">iterations</span>
      <span class="hljs-keyword">const</span> callbacks = ctx.<span class="hljs-property">callbacks</span>

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> = <span class="hljs-literal">null</span>
      callbacks.<span class="hljs-property">onComplete</span>?.(finalTop, iterations)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 检查是否超过最大迭代次数</span>
    <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">iterations</span> &gt;= ctx.<span class="hljs-property">maxIterations</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">`max iterations (<span class="hljs-subst">${ctx.maxIterations}</span>) reached`</span>)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 继续迭代：更新 lastTop 并再次滚动</span>
    ctx.<span class="hljs-property">lastTop</span> = currentTop
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_doScroll</span>(currentTop)
  }

  <span class="hljs-comment">/**
   * 中断跳转
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-attr">reason</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">const</span> callbacks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">callbacks</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> = <span class="hljs-literal">null</span>
    callbacks.<span class="hljs-property">onAbort</span>?.(reason)
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 列表管理</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 动态设置列表总数
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setTotal</span>(<span class="hljs-attr">newTotal</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (newTotal &lt; <span class="hljs-number">0</span>) {
      newTotal = <span class="hljs-number">0</span>
    }

    <span class="hljs-keyword">if</span> (newTotal === <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-comment">// 如果正在跳转，检查目标是否还有效</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">targetIndex</span> &gt;= newTotal) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'target index out of range after setTotal'</span>)
    }

    <span class="hljs-keyword">if</span> (newTotal &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) {
      <span class="hljs-keyword">const</span> oldTotal = <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>
      <span class="hljs-keyword">const</span> lastBottom = oldTotal &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[oldTotal - <span class="hljs-number">1</span>].<span class="hljs-property">bottom</span> : <span class="hljs-number">0</span>

      <span class="hljs-comment">// 预先扩展数组长度</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> = newTotal

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = oldTotal; i &lt; newTotal; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i] = {
          <span class="hljs-attr">index</span>: i,
          <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>,
          <span class="hljs-attr">top</span>: lastBottom + (i - oldTotal) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>,
          <span class="hljs-attr">bottom</span>: lastBottom + (i - oldTotal + <span class="hljs-number">1</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>
        }
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> = newTotal
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> = newTotal
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_notifyHeightChange</span>()
  }

  <span class="hljs-comment">/**
   * 获取当前列表总数
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getTotal</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>
  }

  <span class="hljs-comment">/**
   * 获取指定索引的位置信息
   * 返回深拷贝，防止外部修改内部状态
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getItemPosition</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">ItemPosition</span> | <span class="hljs-literal">null</span> {
    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-keyword">return</span> { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[index] }
  }

  <span class="hljs-comment">/**
   * 重置所有位置信息
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">reset</span>(newTotal?: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 中断进行中的跳转</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'reset called'</span>)
    }

    <span class="hljs-keyword">if</span> (newTotal !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> = newTotal &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : newTotal
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_initPositions</span>()
  }

  <span class="hljs-comment">/**
   * 获取当前默认行高
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getDefaultHeight</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 私有工具方法</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 从指定索引开始，重新计算所有后续行的 top 和 bottom
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_recalculatePositions</span>(<span class="hljs-attr">fromIndex</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = fromIndex; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>; i++) {
      <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">top</span> = <span class="hljs-number">0</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">top</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i - <span class="hljs-number">1</span>].<span class="hljs-property">bottom</span>
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">bottom</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">top</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">height</span>
    }
  }

  <span class="hljs-comment">/**
   * 二分查找：找到第一个 bottom &gt; scrollTop 的索引
   * 当 scrollTop 超出范围时返回 this.total
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_findStartIndex</span>(<span class="hljs-attr">scrollTop</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

    <span class="hljs-keyword">const</span> lastIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>

    <span class="hljs-keyword">if</span> (scrollTop &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

    <span class="hljs-keyword">if</span> (scrollTop &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[lastIndex].<span class="hljs-property">bottom</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>
    }

    <span class="hljs-keyword">let</span> low = <span class="hljs-number">0</span>
    <span class="hljs-keyword">let</span> high = lastIndex

    <span class="hljs-keyword">while</span> (low &lt;= high) {
      <span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((low + high) / <span class="hljs-number">2</span>)
      <span class="hljs-keyword">const</span> midBottom = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[mid].<span class="hljs-property">bottom</span>

      <span class="hljs-keyword">if</span> (midBottom &gt; scrollTop) {
        <span class="hljs-keyword">if</span> (mid === <span class="hljs-number">0</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[mid - <span class="hljs-number">1</span>].<span class="hljs-property">bottom</span> &lt;= scrollTop) {
          <span class="hljs-keyword">return</span> mid
        }
        high = mid - <span class="hljs-number">1</span>
      } <span class="hljs-keyword">else</span> {
        low = mid + <span class="hljs-number">1</span>
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
  }

  <span class="hljs-comment">/**
   * 通知外部总高度发生变化
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_notifyHeightChange</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onTotalHeightChange</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onTotalHeightChange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTotalHeight</span>())
    }
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">VirtualCore</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ItemPosition</span>, <span class="hljs-title class_">HeightUpdate</span>, <span class="hljs-title class_">RenderRange</span>, <span class="hljs-title class_">UpdateCorrection</span>, <span class="hljs-title class_">VirtualCoreConfig</span>, <span class="hljs-title class_">ScrollToCallbacks</span>, <span class="hljs-title class_">ScrollToOptions</span> }
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android system_server进程介绍]]></title>    <link>https://juejin.cn/post/7586680977855742015</link>    <guid>https://juejin.cn/post/7586680977855742015</guid>    <pubDate>2025-12-23T06:59:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586680977855742015" data-draft-id="7586861592709529636" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android system_server进程介绍"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T06:59:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarShip"/> <meta itemprop="url" content="https://juejin.cn/user/3790771820172391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android system_server进程介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771820172391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarShip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:59:16.000Z" title="Tue Dec 23 2025 06:59:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题：</h2>
<p>请详细介绍 Android 中 <code>system_server</code> 进程的作用、启动流程和核心功能，包括：</p>
<ol>
<li><strong>进程概述</strong>：说明该进程的定位、在系统中的角色以及启动时机。</li>
<li><strong>启动流程</strong>：从 Zygote 启动到 <code>system_server</code> 运行的步骤。</li>
<li><strong>主要服务</strong>：列出并简述该进程中运行的关键系统服务（如 ActivityManagerService、PackageManagerService 等）。</li>
<li><strong>与其他进程的关系</strong>：说明它与 framework、应用进程、底层 native 进程的通信方式。</li>
<li><strong>稳定性与安全性</strong>：分析 system_server 崩溃或卡死对系统的影响，以及常见的保护机制。</li>
<li><strong>调试与分析方法</strong>：介绍查看日志、trace 文件及源码的方法。</li>
</ol>
<hr/>
<h2 data-id="heading-1">1. <strong>进程概述：定位、角色与启动时机</strong></h2>
<h3 data-id="heading-2"><strong>1.1 定位与角色</strong></h3>
<p><code>system_server</code> 是 Android 中 <strong>最关键的 Java 进程之一</strong>，主要特征：</p>
<ul>
<li>
<p><strong>承载绝大部分 Java Framework 系统服务</strong> 如：<strong>ActivityManagerService (AMS)</strong> 、<strong>PackageManagerService (PMS)</strong> 、<strong>WindowManagerService (WMS)</strong> 、<strong>PowerManagerService (PMS)</strong> 等，几乎所有应用能感知到的系统能力，都要通过这些服务转一圈。</p>
</li>
<li>
<p><strong>系统“中枢调度中心”</strong> 负责：</p>
<ul>
<li>进程和四大组件生命周期控制</li>
<li>任务栈与界面管理</li>
<li>包和权限管理</li>
<li>电源、输入、传感器、网络等的大量策略层逻辑</li>
</ul>
</li>
<li>
<p><strong>单点故障（Single Point of Failure）</strong> 一旦 <code>system_server</code> 崩溃，<strong>Android 整个 Framework 失效</strong>，通常会触发 <strong>framework 重启</strong>（看起来像“桌面重启”或“手机黑一下再亮”）。</p>
</li>
</ul>
<h3 data-id="heading-3"><strong>1.2 启动时机</strong></h3>
<p>整体时序（高层）：</p>
<ol>
<li><strong>内核启动完成</strong> → 启动 <code>init</code> 进程。</li>
<li><code>init</code> 解析 <code>init.rc</code> 等配置，启动 <strong>Zygote 进程</strong>。</li>
<li><strong>Zygote 启动后立刻 fork 出</strong> <strong><code>system_server</code></strong>。</li>
<li><code>system_server</code> 内部启动各种系统服务，framework 才真正“活起来”。</li>
</ol>
<p>所以：<strong><code>system_server</code></strong> <strong>在整个系统引导阶段非常靠前</strong>，比所有应用进程要早得多，是后续所有应用的“上帝视角”调度者。</p>
<h2 data-id="heading-4">2. <strong>启动流程：从 Zygote 到 system_server</strong></h2>
<p>以典型 AOSP 启动链为例，简化步骤如下：</p>
<h3 data-id="heading-5"><strong>2.1 内核与 init 阶段</strong></h3>
<ol>
<li><strong>Linux 内核启动</strong> 加载驱动、挂载文件系统，最终启动第一个用户空间进程：<code>/init</code>。</li>
<li><strong>init 解析 rc 脚本</strong> 如 <code>init.rc</code>、<code>init.&lt;hardware&gt;.rc</code>，定义各种 service。 其中一项是启动 Zygote，例如（简化示意）：</li>
</ol>
<pre><code class="hljs language-perl" lang="perl">service zygote /<span class="hljs-keyword">system</span>/bin/app_process -Xzygote ...
    class main
    <span class="hljs-keyword">socket</span> zygote stream <span class="hljs-number">660</span> root <span class="hljs-keyword">system</span>
    onrestart <span class="hljs-keyword">write</span> /sys/android_power/request_state wake
</code></pre>
<h3 data-id="heading-6"><strong>2.2 Zygote 进程启动</strong></h3>
<p><code>app_process</code> 最终进入 <code>com.android.internal.os.ZygoteInit.main()</code>，主要做：</p>
<ol>
<li>
<p><strong>预加载类和资源</strong>（<code>preload()</code>）</p>
<ol>
<li>预加载 framework 常用的 Java 类、资源等，提高后续 fork 子进程的速度（写时复制）。</li>
</ol>
</li>
<li>
<p><strong>创建 zygote socket</strong></p>
<ol>
<li>用于接收 AMS 发来的“fork 新应用进程”的请求。</li>
</ol>
</li>
<li>
<p><strong>调用</strong> <strong><code>startSystemServer()</code></strong> <strong>启动 system_server</strong>。</p>
</li>
</ol>
<h3 data-id="heading-7"><strong>2.3 Zygote 中的 startSystemServer</strong></h3>
<p>在 <code>ZygoteInit</code> 中，核心逻辑大致是：</p>
<pre><code class="hljs language-scss" lang="scss">private static boolean <span class="hljs-built_in">startSystemServer</span>(...) {
    <span class="hljs-comment">// 1. 组装 system_server 的启动参数：uid/gid、进程名、classPath 等</span>
    String args<span class="hljs-selector-attr">[]</span> = {
        "<span class="hljs-attr">--setuid</span>=<span class="hljs-number">1000</span>",              <span class="hljs-comment">// system UID</span>
        "<span class="hljs-attr">--setgid</span>=<span class="hljs-number">1000</span>",
        "<span class="hljs-attr">--runtime-args</span>",
        "<span class="hljs-attr">--nice-name</span>=system_server",
        "com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.server</span><span class="hljs-selector-class">.SystemServer</span>"
    };
    
    <span class="hljs-comment">// 2. 调用 forkSystemServer，使用 Zygote fork 出子进程</span>
    ZygoteProcess<span class="hljs-selector-class">.ProcessResult</span> result = Zygote<span class="hljs-selector-class">.forkSystemServer</span>(..., args, ...);

    <span class="hljs-comment">// 3. 在子进程中，执行 handleSystemServerProcess，进入 Java 世界</span>
    if (result.pid == <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">handleSystemServerProcess</span>(...); <span class="hljs-comment">// 子进程路径</span>
    }
}
</code></pre>
<p>关键点：</p>
<ul>
<li><code>system_server</code> <strong>是 Zygote fork 出的第一个重要子进程</strong>；</li>
<li>使用固定的 UID/GID（一般为 <strong>system 用户</strong>），权限极高；</li>
<li>指定入口类为 <strong><code>com.android.server.SystemServer</code></strong>。</li>
</ul>
<h3 data-id="heading-8"><strong>2.4 system_server 进程内部：SystemServer.main()</strong></h3>
<p><code>SystemServer</code> 类的主入口（简化）：</p>
<pre><code class="hljs language-scss" lang="scss">public static void <span class="hljs-selector-tag">main</span>(String[] args) {
    new <span class="hljs-built_in">SystemServer</span>()<span class="hljs-selector-class">.run</span>();
}

private void <span class="hljs-built_in">run</span>() {
    <span class="hljs-comment">// 1. 设置优先级 / 线程策略 / 权限检查</span>

    <span class="hljs-comment">// 2. 启动各类系统服务</span>
    <span class="hljs-built_in">startBootstrapServices</span>();  <span class="hljs-comment">// 启动最基础的服务</span>
    <span class="hljs-built_in">startCoreServices</span>();       <span class="hljs-comment">// 启动框架核心服务</span>
    <span class="hljs-built_in">startOtherServices</span>();      <span class="hljs-comment">// 启动其他大量服务</span>

    <span class="hljs-comment">// 3. 进入 Looper.loop()，进入消息循环</span>
}
</code></pre>
<p><code>startBootstrapServices()</code> 中一般会启动：</p>
<ul>
<li>Installer、ActivityManagerService、PowerManagerService、PackageManagerService 等；</li>
<li>这些服务准备好后，framework 才具备基本的调度能力。</li>
</ul>
<p>至此，<strong><code>system_server</code></strong> <strong>正式进入主循环，Android Framework 启动完成</strong>，可以接收应用启动请求，去 fork app 进程。</p>
<h2 data-id="heading-9">3. <strong>主要服务：system_server 内的关键系统服务</strong></h2>
<p><code>system_server</code> 是一个“<strong>服务容器进程</strong>”，里面运行着大量 Java 系统服务（有的还桥接 native）。下面列一些典型且对应用最核心的服务及职责（非完整列表）：</p>









































































<table><thead><tr><th>服务名（Java 类）</th><th>主要职责</th></tr></thead><tbody><tr><td>ActivityManagerService (AMS)</td><td>进程/Activity/Service/Broadcast 的生命周期、任务栈管理、ANR 监控、进程优先级管理等。几乎所有应用组件的启动/停止都要经过它。</td></tr><tr><td>PackageManagerService (PMS)</td><td>APK 安装/卸载、包信息（version、签名、组件）、权限授予与校验、隐式Intent解析、Dex 优化等。</td></tr><tr><td>WindowManagerService (WMS)</td><td>窗口管理、窗口层级/动画、显示内容布局，与 SurfaceFlinger 协同完成渲染；管理状态栏、导航栏等系统窗口。</td></tr><tr><td>DisplayManagerService (DMS)</td><td>显示设备（屏幕、外接显示器）、分辨率、刷新率、显示切换等管理。</td></tr><tr><td>PowerManagerService (PMS)</td><td>电源策略、休眠/唤醒（wake lock）、亮灭屏逻辑、电池相关策略等。</td></tr><tr><td>InputManagerService (IMS)</td><td>输入事件（触摸、按键）的分发与调度，和 native inputflinger 协作，将 input 分发给 WMS/应用。</td></tr><tr><td>SensorManagerService</td><td>传感器（加速度、陀螺仪、距离等）管理及事件分发。</td></tr><tr><td>LocationManagerService</td><td>定位相关服务管理（GPS、网络定位、融合算法等）。</td></tr><tr><td>AudioService</td><td>音量控制、音频路由、音频焦点（audio focus）等。</td></tr><tr><td>NotificationManagerService</td><td>通知栏消息管理、通知渠道、优先级、do-not-disturb 策略。</td></tr><tr><td>VibratorService</td><td>马达震动控制。</td></tr><tr><td>AlarmManagerService</td><td>定时任务/闹钟管理（RTC/ELAPSED_REALTIME 等），唤醒策略。</td></tr><tr><td>ConnectivityService</td><td>网络连接状态、流量管理、代理、VPN 等。</td></tr><tr><td>UserManagerService</td><td>多用户/工作资料（Work Profile）等用户管理。</td></tr><tr><td>ContentService</td><td>ContentProvider 的注册与调度。</td></tr><tr><td>ActivityTaskManagerService (ATMS)</td><td>新版本拆分出的任务/栈管理服务，与 AMS 协作。</td></tr></tbody></table>
<p>这些服务通常在 <code>SystemServer.startBootstrapServices()</code> / <code>startCoreServices()</code> / <code>startOtherServices()</code> 中依次创建并通过 <strong>ServiceManager</strong> 注册为 Binder 服务。应用通过 Binder 调用这些服务的接口，从而实现各种系统功能。</p>
<h2 data-id="heading-10">4. <strong>与其他进程的关系与通信方式</strong></h2>
<h3 data-id="heading-11"><strong>4.1 与 Framework（Java 层）的关系</strong></h3>
<ul>
<li><code>system_server</code> 本身就是 <strong>Framework Java 层服务端实现</strong>所在的进程。</li>
<li>应用侧通过 <code>Context.getSystemService()</code> 获取的是<strong>代理对象（Proxy/Stub）</strong> ，其底层通过 <strong>Binder</strong> 与 <code>system_server</code> 中的真实服务通信。</li>
<li>例如：<code>ActivityManager</code> → <code>IActivityManager</code> Binder stub/proxy → <code>ActivityManagerService</code>（system_server 内）</li>
</ul>
<h3 data-id="heading-12"><strong>4.2 与应用进程的关系</strong></h3>
<ol>
<li>
<p><strong>进程创建关系</strong></p>
<ol>
<li>应用进程（app）是由 <strong>Zygote</strong> fork 出的；</li>
<li>AMS 通过 Zygote socket 请求 fork app，app 启动后再与 AMS 建立 Binder 通道；</li>
<li><code>system_server</code> 负责维护所有 app 进程的生命周期和优先级。</li>
</ol>
</li>
<li>
<p><strong>通信方式</strong></p>
<ol>
<li>
<p><strong>主方式：Binder IPC</strong></p>
<ul>
<li>app 调用系统 API → 通过 Binder 调到 system_server 对应服务；</li>
<li>system_server 反过来通过 Binder 回调应用（如 scheduleLaunchActivity、scheduleReceiver 等）。</li>
</ul>
</li>
<li>
<p><strong>少量共有内存 / 文件描述符传递</strong></p>
<ul>
<li>如图形缓冲区（GraphicBuffer）、匿名共享内存（ashmem）等，通常由 native 组件协同（SurfaceFlinger、HWComposer 等）。</li>
</ul>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-13"><strong>4.3 与底层 native 进程的关系</strong></h3>
<p>system_server 与一些关键 native 进程（如 <strong>SurfaceFlinger、MediaServer、InputFlinger</strong> 等）之间关系：</p>
<ul>
<li>
<p><strong>通信方式</strong>：</p>
<ul>
<li>Binder（很多 native 服务也注册为 Binder 服务）；</li>
<li>socket（如 media 相关）、shared memory 等。</li>
</ul>
</li>
<li>
<p><strong>职责分工</strong>：</p>
<ul>
<li><code>system_server</code>：<strong>策略 &amp; 管理层</strong>（何时显示、谁在前台、谁有音频焦点）；</li>
<li>native 进程：<strong>高性能数据处理</strong>（渲染、音视频编解码、硬件驱动交互）。</li>
</ul>
</li>
</ul>
<p>示例：</p>
<ul>
<li>WMS（system_server 内） → 控制窗口层级、可见性；</li>
<li>SurfaceFlinger（native） → 根据 WMS 提供的 layer 信息合成最终帧并送到显示设备。</li>
</ul>
<h2 data-id="heading-14">5. <strong>稳定性与安全性</strong></h2>
<h3 data-id="heading-15"><strong>5.1 system_server 崩溃或卡死的影响</strong></h3>
<p><strong>1）崩溃（Crash）</strong></p>
<ul>
<li>
<p>一旦 <code>system_server</code> 发生未捕获异常（如 NPE、RuntimeException），会导致进程立即退出；</p>
</li>
<li>
<p>Android 通常会：</p>
<ul>
<li>记录 tombstone（/data/tombstones/…）；</li>
<li>触发 <strong>framework 重启</strong>（重启 system_server、某些 native 服务，重新拉起桌面等）；</li>
</ul>
</li>
<li>
<p>对用户表现：</p>
<ul>
<li>短暂黑屏/卡顿；</li>
<li>桌面重新加载，当前前台应用大概率被杀重启。</li>
</ul>
</li>
</ul>
<p><strong>2）卡死（ANR / 死锁 / Watchdog）</strong></p>
<ul>
<li>
<p><code>system_server</code> 有一个 <strong>Watchdog 机制</strong>： 定时检测关键线程（尤其是主线程）的响应，如果超过一定时间没有响应，会认为 system_server 卡死。</p>
</li>
<li>
<p>Watchdog 会：</p>
<ul>
<li>打印详细日志和线程堆栈；</li>
<li>通常最终也会选择 <strong>杀死 system_server 以恢复系统</strong>（宁可重启框架，也不能长期卡死）。</li>
</ul>
</li>
</ul>
<p><strong>3）对应用的具体影响</strong></p>
<ul>
<li>
<p>任何依赖 system_server 的 Binder 调用会失败，可能抛：</p>
<ul>
<li><strong><code>DeadSystemException</code></strong> <strong>/</strong> <strong><code>DeadSystemRuntimeException</code></strong>（你前一个 crash 日志中看到的那个）；</li>
</ul>
</li>
<li>
<p>大量应用被动“闪退”或被系统重启。</p>
</li>
</ul>
<h3 data-id="heading-16"><strong>5.2 稳定性保护机制（核心）</strong></h3>
<ol>
<li>
<p><strong>Watchdog -- 独立的监控机制</strong></p>
<ol>
<li>定期检测 AMS、PMS、WMS 等关键服务的响应；</li>
<li>防止 system_server 因死锁或耗时操作“挂住”。</li>
</ol>
</li>
<li>
<p><strong>严格线程/耗时策略</strong></p>
<ol>
<li>对主线程和关键 Binder 线程在代码层面有大量 <code>StrictMode</code>、超时检测；</li>
<li>大部分耗时操作必须放入后台线程。</li>
</ol>
</li>
<li>
<p><strong>OOM / 内存回收策略</strong></p>
<ol>
<li>为 system_server 预留较高的内存优先级；</li>
<li>通过 LMK / lmkd、优先级回收尽量腾出内存给 system_server 和前台 app。</li>
</ol>
</li>
</ol>
<h3 data-id="heading-17"><strong>5.3 安全性</strong></h3>
<p><code>system_server</code> 权限极高，因此安全策略非常严格：</p>
<ol>
<li>
<p><strong>system UID + SELinux 策略</strong></p>
<ol>
<li>运行在 system UID；</li>
<li>SELinux 策略限制其访问范围，避免“全能无管控”。</li>
</ol>
</li>
<li>
<p><strong>权限校验中心</strong></p>
<ol>
<li>大多数权限检查在 system_server 内进行： 例如 <code>Context.checkPermission</code> 最终调用到 AMS/PMS 等服务进行判断。</li>
</ol>
</li>
<li>
<p><strong>签名/包完整性校验</strong></p>
<ol>
<li>应用安装、更新、卸载的签名校验、版本验证、权限变更审核都由 PMS 等服务执行。</li>
</ol>
</li>
<li>
<p><strong>跨进程安全边界</strong></p>
<ol>
<li>通过 Binder 的 caller UID/包名、权限，严格限制 app 能调用的系统操作。</li>
</ol>
</li>
</ol>

<h2 data-id="heading-18">6. <strong>调试与分析 system_server 的方法</strong></h2>
<h3 data-id="heading-19"><strong>6.1 日志与 trace /</strong> <strong>tombstone</strong></h3>
<ol>
<li><strong>logcat 日志</strong></li>
</ol>
<p>常用 tag：</p>
<ul>
<li><strong>ActivityManager</strong>：AMS、进程/Activity 启停、ANR 相关；</li>
<li><strong>SystemServer</strong>：系统服务启动阶段、异常；</li>
<li><strong>Watchdog</strong>：监控到卡死时输出；</li>
<li>各具体服务的 log（WindowManager、PackageManager 等）。</li>
</ul>
<p>常用命令示例：</p>
<pre><code class="hljs language-ruby" lang="ruby">adb logcat -b system -b main -v threadtime <span class="hljs-title class_">ActivityManager</span><span class="hljs-symbol">:System</span> <span class="hljs-title class_">SystemServer</span><span class="hljs-symbol">:System</span> <span class="hljs-title class_">Watchdog</span><span class="hljs-symbol">:System</span> *<span class="hljs-symbol">:S</span>
</code></pre>
<ol start="2">
<li><strong>system_server</strong> <strong>tombstone</strong></li>
</ol>
<ul>
<li>位置：<code>/data/tombstones/tombstone_XX</code></li>
<li>当 <code>system_server</code> 发生 native crash 或被 Watchdog 触发 kill，会在此处留下一份 dump。</li>
<li>可通过：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">adb root
adb pull /data/tombstones/tombstone_XX
</code></pre>
<p>进行分析。里面包含：</p>
<ul>
<li>各线程栈信息；</li>
<li>寄存器、内存快照；</li>
<li>出错信号、地址等。</li>
</ul>
<ol start="3">
<li><strong>ANR traces</strong></li>
</ol>
<ul>
<li>位置：<code>/data/anr/traces.txt</code>（以及可能的分片文件）；</li>
<li>当 system_server 或某应用进程 ANR 时，会在此文件中写入对应时刻所有线程的 stack。</li>
</ul>
<p>常用命令：</p>
<pre><code class="hljs language-bash" lang="bash">adb shell <span class="hljs-built_in">cat</span> /data/anr/traces.txt | grep -n <span class="hljs-string">"system_server"</span> -n
</code></pre>
<h3 data-id="heading-20"><strong>6.2 源码定位与阅读路径</strong></h3>
<p>主要 Java 源码路径（以 AOSP 为例）：</p>
<ul>
<li>
<p><code>frameworks/base/services/java/com/android/server/SystemServer.java</code> → system_server 进程入口、服务启动逻辑（<code>startBootstrapServices/startCoreServices</code>）。</p>
</li>
<li>
<p><code>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</code> → Zygote 主入口，<code>startSystemServer()</code> 逻辑。</p>
</li>
<li>
<p>各服务源码举例：</p>
<ul>
<li>AMS：<code>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code></li>
<li>PMS：<code>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</code></li>
<li>WMS：<code>frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java</code></li>
<li>PowerManagerService：<code>frameworks/base/services/core/java/com/android/server/power/PowerManagerService.java</code></li>
</ul>
</li>
</ul>
<p>阅读顺序建议：</p>
<ol>
<li>从 <code>ZygoteInit.main()</code> → <code>startSystemServer()</code>；</li>
<li>看 <code>SystemServer.run()</code> → <code>startBootstrapServices()</code>；</li>
<li>根据需要深入具体 service（如 AMS / PMS）。</li>
</ol>
<h3 data-id="heading-21"><strong>6.3 性能与</strong> <strong>行为分析工具</strong></h3>
<ul>
<li><strong>systrace / Perfetto / System Tracing</strong> 用于查看 system_server 在一段时间内的调度、CPU 使用、Binder 调用等。</li>
<li><strong>binder 调用统计</strong>（部分厂商增强） 可以看到哪些进程在频繁调用 system_server、binder 队列堆积情况（你 crash 日志中的 binder buffer info 就是类似信息）。</li>
<li><strong>Debug / StrictMode</strong> 在开发版系统中开启更多调试开关，检测 system_server 内线程的耗时行为。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文读懂 Chrome CRX📦：你需要了解的核心知识点]]></title>    <link>https://juejin.cn/post/7586686861390839859</link>    <guid>https://juejin.cn/post/7586686861390839859</guid>    <pubDate>2025-12-23T07:51:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586686861390839859" data-draft-id="7586584105742090290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文读懂 Chrome CRX📦：你需要了解的核心知识点"/> <meta itemprop="keywords" content="前端,前端工程化"/> <meta itemprop="datePublished" content="2025-12-23T07:51:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Maxkim"/> <meta itemprop="url" content="https://juejin.cn/user/2768993424260451"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文读懂 Chrome CRX📦：你需要了解的核心知识点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2768993424260451/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Maxkim
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:51:47.000Z" title="Tue Dec 23 2025 07:51:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><blockquote>
<p>大家好!欢迎来到<strong>Maxkim</strong>的技术博客，插件显而易见,像"篡改猴",“Vue Devtools”无处不在，那么如何进行<strong>插件编写</strong>到编写的插件怎么<strong>分发打包</strong>就成了工程化的必学之课，关于插件可以看JustHappy的开源项目，<strong>源码简单，上手难度小</strong> (<a href="https://juejin.cn/post/7585406229167865906" target="_blank" title="https://juejin.cn/post/7585406229167865906">「chrome extensions🛠️」超级简单的浏览器插件Vue开发模板用Vue + JS去开发</a>) ,这里为大家讲解<strong>Crx打包</strong>内容。总结一句话打包就是 <strong>输入-&gt;输出--依靠脚本</strong></p>
</blockquote>
<h2 data-id="heading-0">什么是Chrome下的Crx</h2>
<p>CRX（Chrome Extension）是<strong>Chrome 浏览器扩展程序的官方打包格式</strong>，本质上是一个经过<strong>数字签名</strong>的 ZIP 压缩包，文件后缀为<code>.crx</code>。它包含了实现扩展功能的所有资源：<code>manifest.json</code>配置文件、JavaScript 脚本、CSS 样式、HTML 页面、图片图标等。</p>
<p>基于 Chromium 内核的浏览器均兼容 CRX 格式，这让 CRX 成为跨 Chromium 浏览器扩展开发的主流选择。其核心价值在于<strong>突破网页沙箱限制</strong>，让开发者能调用浏览器底层 API（如标签页管理、网络请求拦截、本地存储操作等），实现普通网页无法完成的功能，比如广告拦截、网页翻译、开发者调试工具等。</p>
<p>目前 CRX 的主流版本是<strong>V3</strong>（Manifest V3），相比 V2 版本，它采用 Service Worker 替代持久化背景脚本、使用声明式网络请求拦截、强化内容安全策略（CSP），在安全性和性能上有显著提升，也是我们开发和打包的重点。</p>
<h2 data-id="heading-1">为什么要Crx打包，直接用不行吗</h2>
<p>直接用，对普通用户门槛高，需要手动开启 <strong>开发者模式</strong>进行导入，其次 <strong>不安全</strong>  ，然后就是 <strong>版本管理难</strong>等问题 于是将开发的插件打包成Crx，就显得<strong>必须且必要</strong>了！</p>
<h2 data-id="heading-2">打包三步骤</h2>
<h3 data-id="heading-3">输入</h3>
<p>首先它是<strong>符合 Chrome 扩展规范的源码目录</strong>（通常命名为<code>src</code>），其核心是围绕<code>manifest.json</code>构建清晰的模块结构，避免直接使用解压目录时的 “文件堆砌” 问题。如下图例子所示</p>
<pre><code class="hljs language-bash" lang="bash">├── assets/           <span class="hljs-comment"># 静态资源输入</span>
│   └── icons/        <span class="hljs-comment"># 扩展图标（严格匹配manifest声明的尺寸）</span>
├── background/       <span class="hljs-comment"># 背景脚本输入（Service Worker）</span>
│   └── index.js      <span class="hljs-comment"># 单一入口，避免多脚本零散分布</span>
├── content/          <span class="hljs-comment"># 内容脚本输入（按功能拆分模块）</span>
│   ├── inject.js     <span class="hljs-comment"># 注入网页的核心逻辑</span>
...
├── popup/            <span class="hljs-comment"># 弹窗页面输入（前端页面资源）</span>
...
└── manifest.json     <span class="hljs-comment"># 核心配置（V3版本，声明所有资源路径）</span>
</code></pre>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/147ad6d69f6b4d3caa09488c5ada7bc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081106&amp;x-signature=RABW2pwAo0agALlFIFtjOvj3zFY%3D" alt="image.png" loading="lazy"/></p>
--------------------------------------------------------------
<h3 data-id="heading-4">输出</h3>
<p>CRX 的输出<strong>并非单一的.crx文件</strong>，而是通过工程化流程生成<strong>分层的产物</strong>，解决直接用解压目录时 “一份文件既调试又分发” 的矛盾。</p>





























<table><thead><tr><th>输出产物</th><th>生成方式</th><th>用途</th><th>对比直接用解压目录的优势</th></tr></thead><tbody><tr><td><code>dist/unpacked/</code></td><td>复制 / 编译源码后的解压目录</td><td>开发调试</td><td>自动清理冗余文件，保留纯净的可运行代码</td></tr><tr><td><code>dist/crx/</code></td><td>签名后的<code>.crx</code>文件</td><td>生产分发</td><td>标准化压缩包，带数字签名，支持安全分发</td></tr><tr><td><code>dist/zip/</code></td><td>应用店上传的 ZIP 包</td><td>官方发布</td><td>符合 Chrome 应用店规范，无需手动整理文件</td></tr></tbody></table>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90ba4adeb7064ab6a591af070f8ecb7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081106&amp;x-signature=ilT9z8GSWzAdXuMBLx9NZLD6xwE%3D" alt="image.png" loading="lazy"/></p>
<p>三大优势:
1.<strong>环境隔离</strong>
2.<strong>资源优化</strong>
3.<strong>版本可控</strong></p>
<hr/>
<h3 data-id="heading-5">NPM自定义脚本: 纯原生 CRX 的自动化打包</h3>
<p>纯原生 CRX 指不使用 Webpack、Vite 等构建工具，仅用原生 HTML/CSS/JS 开发的扩展。这类 CRX 的 NPM 脚本核心是实现<strong>资源复制、清理、密钥生成、签名打包</strong>的自动化，其中<strong>密钥</strong>是<code>.crx</code>文件的安全核心，也是替代直接用解压目录的关键。</p>
<h4 data-id="heading-6">1. 先搞懂：CRX 打包中的密钥（<code>key.pem</code>）是什么？</h4>
<p>在 CRX 打包中，<code>key.pem</code>是<strong>RSA 私钥文件</strong>，是 Chrome 扩展签名的核心凭证，其作用和特性如下：</p>
<ul>
<li><strong>数字签名的核心</strong>：<code>crx3</code>工具会通过<code>key.pem</code>对 CRX 包进行加密签名，Chrome 浏览器安装时会验证签名的合法性，若签名失效（如代码被篡改）则拒绝安装。</li>
<li><strong>开发者身份标识</strong>：<code>key.pem</code>是开发者 / 团队的唯一标识，发布到 Chrome 应用店的扩展，后续更新必须使用同一私钥，否则会被视为 “新扩展”。</li>
<li><strong>自动生成与手动管理</strong>：首次执行<code>build:crx</code>脚本时，若项目根目录无<code>key.pem</code>，<code>crx3</code>会自动生成；若已存在，则复用该密钥进行签名。</li>
<li><strong>安全重要性</strong>：丢失<code>key.pem</code>将无法更新已发布的扩展，且无法证明扩展的原始开发者身份，需妥善备份。</li>
</ul>
<h4 data-id="heading-7">2. 纯原生 CRX 的依赖安装</h4>
<p>首先初始化项目并安装打包所需的轻量工具，无需复杂的构建工具：</p>
<pre><code class="hljs language-js" lang="js"># 初始化package.<span class="hljs-property">json</span>（若未初始化）
npm init -y

# 安装核心依赖
# crx3：生成<span class="hljs-variable constant_">V3</span>版本签名的.<span class="hljs-property">crx</span>文件（含密钥生成逻辑）
# copyfiles：自动化复制静态资源
# rimraf：跨平台清理文件/目录（替代rm -rf，兼容<span class="hljs-title class_">Windows</span>）
npm install crx3 copyfiles rimraf --save-dev
</code></pre>
<h4 data-id="heading-8">3. 纯原生 CRX 的 NPM 脚本配置（完善密钥相关逻辑）</h4>
<p>在<code>package.json</code>中定义脚本，新增<strong>密钥备份提示</strong>和<strong>无密钥强制生成</strong>的逻辑，同时保留自动化打包流程：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pure-native-crx"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rimraf dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 跨平台清理dist目录，替代手动删除</span>
    <span class="hljs-attr">"copy:static"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copyfiles -u 1 src/**/* dist/unpacked"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 复制src资源到调试目录</span>
    <span class="hljs-attr">"build:unpacked"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run clean &amp;&amp; npm run copy:static"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 生成调试用解压目录</span>
    <span class="hljs-attr">"build:crx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/crx/pure-native-crx-v$npm_package_version.crx -p key.pem &amp;&amp; echo '密钥文件为key.pem，请注意备份！'"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 生成签名.crx并提示备份密钥</span>
    <span class="hljs-attr">"build:crx:newkey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/crx/pure-native-crx-v$npm_package_version.crx -p new-key.pem"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 生成新密钥的.crx（用于测试）</span>
    <span class="hljs-attr">"build:zip"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/zip/pure-native-crx-v$npm_package_version.zip --zip"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 生成应用店ZIP包</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build:unpacked &amp;&amp; npm run build:crx &amp;&amp; npm run build:zip"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 一键生成所有产物</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copyfiles -u 1 src/**/* dist/unpacked --watch"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 开发热更：监听src变化自动同步到调试目录</span>
    <span class="hljs-attr">"backup:key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copy key.pem backups/key-v$npm_package_version.pem &amp;&amp; echo '密钥已备份到backups/目录！'"</span> <span class="hljs-comment">// 密钥备份脚本</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-9">4. 纯原生脚本的使用说明（含密钥操作）</h4>


















































<table><thead><tr><th>脚本命令</th><th>功能说明</th><th>密钥相关细节</th></tr></thead><tbody><tr><td><code>npm run clean</code></td><td>清空 dist 目录，避免旧产物干扰</td><td>不涉及密钥</td></tr><tr><td><code>npm run build:unpacked</code></td><td>生成纯净的调试用解压目录<code>dist/unpacked/</code>，可直接导入 Chrome 开发者模式</td><td>不涉及密钥</td></tr><tr><td><code>npm run build:crx</code></td><td>基于调试目录生成带数字签名的<code>.crx</code>文件，存放在<code>dist/crx/</code></td><td>首次执行自动生成<code>key.pem</code>；后续执行复用该密钥，保证签名一致性</td></tr><tr><td><code>npm run build:crx:newkey</code></td><td>生成使用新密钥<code>new-key.pem</code>的<code>.crx</code>文件（仅用于测试）</td><td>生成新的<code>new-key.pem</code>，与原<code>key.pem</code>无关联，不可用于正式扩展更新</td></tr><tr><td><code>npm run build:zip</code></td><td>生成符合 Chrome 应用店要求的 ZIP 包，存放在<code>dist/zip/</code></td><td>基于<code>key.pem</code>的签名逻辑生成，但 ZIP 包本身无签名（应用店会重新签名）</td></tr><tr><td><code>npm run build</code></td><td>一键执行 “清理→复制资源→生成调试目录→签名打包.crx→生成应用店 ZIP” 全流程</td><td>核心流程中自动处理密钥生成 / 复用，同时提示备份</td></tr><tr><td><code>npm run dev</code></td><td>监听 src 目录文件变化，自动同步到调试目录，修改代码后无需手动重新导入扩展</td><td>不涉及密钥</td></tr><tr><td><code>npm run backup:key</code></td><td>将<code>key.pem</code>备份到<code>backups/</code>目录并按版本号命名</td><td>避免密钥丢失，保障扩展后续更新的合法性</td></tr></tbody></table>
<h4 data-id="heading-10">5. 密钥的生成与管理实操</h4>
<h5 data-id="heading-11">（1）首次生成密钥</h5>
<p>执行<code>npm run build:crx</code>后，控制台会输出类似日志：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">Generated <span class="hljs-keyword">private</span> <span class="hljs-keyword">key</span>: <span class="hljs-keyword">key</span>.pem
Packed dist/unpacked <span class="hljs-keyword">to</span> dist/crx/pure-native-crx-v1.<span class="hljs-number">2.0</span>.crx
密钥文件为<span class="hljs-keyword">key</span>.pem，请注意备份！
</code></pre>
<p>此时项目根目录会出现<code>key.pem</code>文件，这是该扩展的唯一私钥，需立即执行<code>npm run backup:key</code>备份到<code>backups/</code>目录。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0530c600748c4fa7977a7cffd4a11887~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081106&amp;x-signature=ttGHCe94kVIBfxJ01SHH5kgEQR4%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-12">（2）复用密钥打包</h5>
<p>后续再次执行<code>npm run build:crx</code>时，<code>crx3</code>会自动读取项目根目录的<code>key.pem</code>，用同一密钥签名新版本的<code>.crx</code>文件，保证 Chrome 识别为 “同一扩展的更新”。</p>
<h5 data-id="heading-13">（3）密钥丢失的影响</h5>
<p>若<code>key.pem</code>丢失，再次执行<code>build:crx</code>会生成新的<code>key.pem</code>，此时：</p>
<ul>
<li>旧版本扩展无法通过新<code>.crx</code>更新，用户需手动卸载旧版本再安装新版本；</li>
<li>若扩展已发布到 Chrome 应用店，将无法用新密钥提交更新，只能重新发布为新扩展。</li>
</ul>
<h4 data-id="heading-14">6. 纯原生脚本的核心价值</h4>
<ul>
<li><strong>跨平台兼容</strong>：使用<code>rimraf</code>替代<code>rm -rf</code>，<code>copyfiles</code>替代手动复制，解决 Windows 与 Mac/Linux 的命令行差异问题。</li>
<li><strong>零构建工具依赖</strong>：仅用轻量工具实现自动化，适合纯原生 CRX 的简单开发场景，避免引入 Webpack 带来的配置复杂度。</li>
<li><strong>版本自动关联</strong>：通过<code>$npm_package_version</code>将<code>package.json</code>中的版本号自动写入<code>.crx</code>文件名，替代直接用解压目录时的手动命名。</li>
<li><strong>密钥自动化管理</strong>：首次打包自动生成密钥，新增备份脚本，解决直接用解压目录的安全与更新问题。</li>
<li><strong>开发提效</strong>：<code>npm run dev</code>实现源码热更新，修改代码后 Chrome 会自动检测扩展变化并重新加载，无需手动点击 “刷新扩展”。</li>
</ul>
<h3 data-id="heading-15">结合 Webpack 的 NPM 脚本（复杂 CRX 场景）</h3>
<p><em>小小Maxkim对Webpack理解有限，这里只是一些理论上可行的方案</em></p>
<p>对于引入 Vue/React、包含大量第三方库的复杂 CRX，需结合 Webpack 实现代码编译、压缩优化，其 NPM 脚本在纯原生基础上增加构建环节，<strong>密钥的使用逻辑与纯原生一致</strong>（复用<code>key.pem</code>签名）：</p>
<h4 data-id="heading-16">1. 安装 Webpack 相关依赖</h4>
<pre><code class="hljs language-js" lang="js"># 安装<span class="hljs-title class_">Webpack</span>及优化插件
npm install webpack webpack-cli clean-webpack-plugin terser-webpack-plugin css-minimizer-webpack-plugin --save-dev
</code></pre>
<h4 data-id="heading-17">2. 混合开发的 NPM 脚本配置</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack-crx"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rimraf dist"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:compile"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack --config webpack.config.js"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Webpack编译/优化源码</span>
    <span class="hljs-attr">"copy:static"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copyfiles -u 1 src/manifest.json src/assets/**/* dist/unpacked"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 复制非编译资源</span>
    <span class="hljs-attr">"build:unpacked"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run clean &amp;&amp; npm run build:compile &amp;&amp; npm run copy:static"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:crx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/crx/webpack-crx-v$npm_package_version.crx -p key.pem &amp;&amp; echo '密钥文件为key.pem，请注意备份！'"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:zip"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/zip/webpack-crx-v$npm_package_version.zip --zip"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build:unpacked &amp;&amp; npm run build:crx &amp;&amp; npm run build:zip"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack --watch --config webpack.config.js &amp; copyfiles -u 1 src/**/* dist/unpacked --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"backup:key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copy key.pem backups/key-v$npm_package_version.pem &amp;&amp; echo '密钥已备份到backups/目录！'"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-18">基于输入输出的性能优化：从体积到性能</h3>
<p>直接使用解压目录时，源码中的冗余代码、未压缩的资源会导致 CRX 体积大、加载慢，而通过工程化流程，可在<strong>输入处理</strong>和<strong>输出构建</strong>阶段做针对性优化。</p>
<h4 data-id="heading-19">1. 输入阶段：源码层面的轻量化优化（纯原生 / 工程化通用）</h4>
<p>在标准化输入目录的基础上，从源码源头减少冗余：</p>
<ul>
<li><strong>按需拆分模块</strong>：将 content 脚本按功能拆分为多个子模块，仅在需要时注入（如<code>chrome.scripting.executeScript</code>动态注入），而非一次性加载所有代码。</li>
<li><strong>剔除冗余资源</strong>：输入目录中仅保留必要的静态资源（如只保留 16/48/128px 的图标），删除开发日志、测试文件等无关内容。</li>
<li><strong>使用原生 API 替代第三方库</strong>：纯原生 CRX 中，用原生<code>fetch</code>替代<code>axios</code>，用原生数组方法替代<code>lodash</code>，减少第三方库的体积引入。</li>
</ul>
<h4 data-id="heading-20">2. 输出阶段：纯原生 CRX 的轻量优化</h4>
<p>纯原生 CRX 无需编译，可通过简单手段优化输出产物，同时不影响密钥签名逻辑：</p>
<ul>
<li><strong>手动压缩静态资源</strong>：使用在线工具压缩图片（如 TinyPNG）、CSS/JS（如 Terser 在线版），将压缩后的文件放入<code>dist/unpacked/</code>，再执行<code>build:crx</code>签名，体积优化后不影响签名合法性。</li>
<li><strong>删除注释与空白</strong>：手动剔除 JS/CSS 中的注释、多余空白，减少文件体积（小型 CRX 效果显著）。</li>
<li><strong>资源内联</strong>：将小图标转为 Base64 编码，直接写入 CSS/HTML 中，减少 CRX 的文件数量，避免注入时的资源请求。</li>
</ul>
<h4 data-id="heading-21">3. 输出阶段：工程化 CRX 的深度优化（Webpack）</h4>
<p>通过 Webpack 配置实现自动化优化，解决纯原生手动优化的低效问题，且优化后的产物仍可通过<code>key.pem</code>正常签名：这里就不过多阐述啦，感兴趣的可以沿着以下三个方向去查阅相关资料。</p>
<h5 data-id="heading-22">（1）代码压缩与混淆</h5>
<h5 data-id="heading-23">（2）Tree Shaking 剔除无用代码</h5>
<h5 data-id="heading-24">（3）静态资源优化</h5>
<h3 data-id="heading-25">对比直接用解压目录：工程化流程的核心优势（含密钥安全维度）</h3>















































<table><thead><tr><th>维度</th><th>直接使用解压目录</th><th>纯原生 CRX 工程化（NPM 脚本 + 密钥）</th><th>工程化 CRX（Webpack+NPM + 密钥）</th></tr></thead><tbody><tr><td><strong>资源管理</strong></td><td>文件结构混乱，路径易出错</td><td>标准化输入输出，路径可控</td><td>模块化设计，解耦性强</td></tr><tr><td><strong>操作效率</strong></td><td>手动复制 / 修改 / 签名，效率极低</td><td>一键自动化，跨平台兼容</td><td>编译 + 打包 + 签名一键完成</td></tr><tr><td><strong>版本管理</strong></td><td>无版本标识，易混淆</td><td>版本号自动关联产物名</td><td>版本追溯清晰，可集成 CI/CD</td></tr><tr><td><strong>性能表现</strong></td><td>源码未优化，体积大、加载慢</td><td>轻量手动优化，体积小幅缩减</td><td>代码压缩 + Tree Shaking，性能优异</td></tr><tr><td><strong>安全与分发</strong></td><td>源码暴露，易被篡改，无更新保障</td><td>带签名的.crx，防篡改，密钥保障更新</td><td>代码混淆 + 签名，安全级别更高</td></tr><tr><td><strong>密钥管理</strong></td><td>无密钥概念，无法证明开发者身份</td><td>自动生成 + 备份脚本，管理规范</td><td>复用密钥，支持规模化发布</td></tr></tbody></table>
<h3 data-id="heading-26">总结</h3>
<p>直接使用解压目录仅能满足 CRX 的调试需求，而通过<strong>标准化输入输出</strong>规范资源结构，<strong>NPM 自定义脚本</strong>实现纯原生 / 工程化的自动化打包（含密钥的生成、复用与备份），再结合性能优化手段，才能让 CRX 成为可分发、高性能且安全的产品。</p>
<p>其中，<strong>密钥（<code>key.pem</code>）</strong> 是 CRX 从 “调试原型” 走向 “生产分发” 的安全核心，解决了直接用解压目录的篡改与更新问题；而<strong>NPM脚本</strong>则将密钥管理、资源复制、签名打包等流程<strong>自动化</strong>，大幅提升开发效率。对于简单的纯原生 CRX，轻量的 NPM 脚本 + 密钥管理即可满足需求；对于复杂 CRX，结合 Webpack 的工程化流程则能实现深度的性能优化，且全程复用密钥保障扩展的合法性。
总而言之，打包就是要明白<strong>输入</strong>是什么， <strong>输出</strong>有什么，<strong>输入到输出</strong>发生了什么！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Context 的 “上下文”]]></title>    <link>https://juejin.cn/post/7586684925107060779</link>    <guid>https://juejin.cn/post/7586684925107060779</guid>    <pubDate>2025-12-23T07:02:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586684925107060779" data-draft-id="7586684925106978859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Context 的 “上下文”"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T07:02:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarShip"/> <meta itemprop="url" content="https://juejin.cn/user/3790771820172391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Context 的 “上下文”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771820172391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarShip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:02:19.000Z" title="Tue Dec 23 2025 07:02:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题：</h2>
<p>请系统讲解 Android 中 <code>Context</code> 及其相关类的设计与应用，内容需涵盖以下方面：</p>
<ol>
<li>
<p><strong>类的体系结构与关系</strong></p>
<ol>
<li>说明 <code>Context</code> 抽象类的作用及核心接口</li>
<li>介绍 <code>ContextImpl</code>、<code>Application</code>、<code>Activity</code>、<code>Service</code>、<code>BroadcastReceiver</code> 等与 <code>Context</code> 关联的类，以及它们之间的继承与实现关系</li>
<li>对这些类的职责与使用场景进行对比说明</li>
</ol>
</li>
<li>
<p><strong>设计原理与机制</strong></p>
<ol>
<li>解释 <code>Context</code> 在 Android 框架中作为全局访问点的设计思想</li>
<li>描述其在资源访问、组件启动、系统服务获取中的作用</li>
<li>阐述为何设计成接口/抽象类，及背后的解耦和可扩展性考虑</li>
</ol>
</li>
<li>
<p><strong>主题与样式支持</strong></p>
<ol>
<li>分析 <code>Context</code> 如何支持 <code>Theme</code>、<code>Style</code> 的加载与应用</li>
<li>说明 <code>setTheme()</code>、<code>getTheme()</code> 的工作原理</li>
<li>举例 Activity 与 Application 中主题的继承与覆盖机制</li>
</ol>
</li>
<li>
<p><strong>使用建议与最佳实践</strong></p>
<ol>
<li>说明在不同场景中选择合适类型的 Context（如 Application Context vs Activity Context）</li>
<li>讨论避免内存泄漏的常见方法</li>
</ol>
</li>
<li>
<p><strong>结构化输出要求</strong></p>
<ol>
<li>使用分标题、层级列表或表格</li>
<li>必要时配合简单流程图或示意图</li>
<li>结合代码片段进行说明（Java/Kotlin 皆可）</li>
</ol>
</li>
</ol>
<p>目标：帮助理解 <code>Context</code> 的类关系脉络、设计理念以及在主题支持上的实现细节，既有理论深度，也有实用指导。</p>
<hr/>
<p>下面的内容按“结构 → 原理 → 主题 → 实战与最佳实践”的顺序展开，你可以当成一份系统的 <code>Context</code> 速查+原理笔记。</p>
<hr/>
<h2 data-id="heading-1"><strong>一、</strong> <strong><code>Context</code></strong> <strong>体系结构与类关系</strong></h2>
<h3 data-id="heading-2"><strong>1.1</strong> <strong><code>Context</code></strong> <strong>抽象类的角色与核心能力</strong></h3>
<p><strong><code>Context</code></strong> <strong>= 当前应用运行环境的“句柄”</strong> ，它把“我是谁、在哪个包、用什么资源与配置、能访问哪些系统能力”这类信息封装起来，并提供统一 API。</p>
<p>它是一个 <strong>抽象类</strong>，不直接被实例化，主要能力可以分几类：</p>
<ol>
<li>
<p><strong>资源与配置访问</strong></p>
<ol>
<li><code>getResources()</code>：访问 <code>res/</code> 里的所有资源</li>
<li><code>getAssets()</code>：访问打包进 APK 的资源文件</li>
<li><code>getPackageName()</code>、<code>getApplicationInfo()</code>、<code>getPackageManager()</code> 等</li>
</ol>
</li>
<li>
<p><strong>组件管理 / 应用<strong><strong>生命周期</strong></strong>相关</strong></p>
<ol>
<li><code>startActivity()</code>, <code>startService()</code>, <code>bindService()</code>, <code>sendBroadcast()</code> …</li>
<li><code>registerReceiver()</code>, <code>unregisterReceiver()</code></li>
</ol>
</li>
<li>
<p><strong>系统服务****获取</strong></p>
</li>
</ol>
<ul>
<li><code>getSystemService(String name)</code></li>
</ul>
<pre><code class="hljs language-ini" lang="ini">LayoutInflater <span class="hljs-attr">inflater</span> = (LayoutInflater)
        context.getSystemService(Context.LAYOUT_INFLATER_SERVICE)<span class="hljs-comment">;</span>
PowerManager <span class="hljs-attr">pm</span> = (PowerManager)
        context.getSystemService(Context.POWER_SERVICE)<span class="hljs-comment">;</span>
</code></pre>
<ol start="4">
<li>
<p><strong>存储与数据</strong></p>
<ol>
<li><code>openFileInput()</code>, <code>openFileOutput()</code>（内部文件）</li>
<li><code>getSharedPreferences()</code></li>
<li><code>getDatabasePath()</code>, <code>openOrCreateDatabase()</code></li>
</ol>
</li>
<li>
<p><strong>UI /</strong> <strong>主题****相关（由支持主题的子类实现）</strong></p>
<ol>
<li><code>setTheme(int resId)</code></li>
<li><code>getTheme()</code></li>
<li><code>getResources().getDrawable()</code> 等主题敏感资源</li>
</ol>
</li>
</ol>
<p><strong>设计要点：</strong> 对开发者来说，<strong>不关心到底是哪个具体子类</strong>（<code>Activity</code>、<code>Application</code> 等），只要拿到一个 <code>Context</code> 引用，就能在“一致的 API”下工作。</p>
<h3 data-id="heading-3"><strong>1.2 核心类的继承与关系示意图</strong></h3>
<p>简化版类图（忽略一些细枝末节）：</p>
<pre><code class="hljs language-lua" lang="lua">          (抽象)
        +<span class="hljs-comment">-----------+</span>
        |  Context  |
        +<span class="hljs-comment">-----------+</span>
             ^
             |
      +<span class="hljs-comment">-------------+</span>
      | ContextImpl |  ← 真正的实现类（framework 内部）
      +<span class="hljs-comment">-------------+</span>

             ^
             | (组合/委托：mBase)
      +<span class="hljs-comment">------------------+</span>
      |  ContextWrapper  |
      +<span class="hljs-comment">------------------+</span>
             ^
             |
   +<span class="hljs-comment">----------------------+</span>
   |  ContextThemeWrapper |  ← 支持 Theme 的包装
   +<span class="hljs-comment">----------------------+</span>
      ^              ^
      |              |
+<span class="hljs-comment">------------+   +--------+</span>
|  Activity  |   |  ...   |
+<span class="hljs-comment">------------+</span>

+<span class="hljs-comment">--------------+</span>
| Application  |  ← 继承 ContextWrapper（不带 UI Theme）
+<span class="hljs-comment">--------------+</span>

+<span class="hljs-comment">------------+</span>
|  Service   |  ← 继承 ContextWrapper（不带 UI Theme）
+<span class="hljs-comment">------------+</span>
</code></pre>
<p><strong><code>BroadcastReceiver</code></strong> <strong>没有继承</strong> <code>Context</code>，它只是：</p>
<p>void onReceive(Context context, Intent intent)</p>
<p>通过参数暂时拿到一个 <code>Context</code>。</p>
<h3 data-id="heading-4"><strong>1.3 关键类逐个看：</strong></h3>
<h4 data-id="heading-5"><strong>1）</strong> <strong><code>ContextImpl</code></strong> <strong>（内部实现）</strong></h4>
<ul>
<li>
<p>位于 framework 内部，是 <strong><code>Context</code></strong> <strong>的具体实现类</strong>。（不对外暴露）</p>
</li>
<li>
<p>持有：</p>
<ul>
<li><code>LoadedApk</code> / <code>Resources</code> / <code>AssetManager</code> / <code>PackageInfo</code></li>
<li><code>IBinder</code> 到 AMS 等系统服务的引用</li>
</ul>
</li>
<li>
<p><strong>应用进程****中真正干活的对象</strong>，其他对外暴露的 <code>Context</code> 大多是对 <code>ContextImpl</code> 的包装。</p>
</li>
</ul>
<h4 data-id="heading-6"><strong>2）</strong> <strong><code>ContextWrapper</code></strong></h4>
<ul>
<li>继承 <code>Context</code>，内部有一个：protected Context mBase;</li>
<li>所有方法基本都是：</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">Resources</span> <span class="hljs-title function_">getResources</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> mBase.<span class="hljs-title function_">getResources</span>();
}
</code></pre>
<ul>
<li>作用：<strong>利用委托模式包装一个</strong> <strong><code>Context</code></strong> <strong>实现（通常是</strong> <strong><code>ContextImpl</code></strong> <strong>），并允许子类按需重写部分行为。</strong></li>
</ul>
<h4 data-id="heading-7"><strong>3）</strong> <strong><code>ContextThemeWrapper</code></strong></h4>
<ul>
<li>
<p>继承 <code>ContextWrapper</code>，<strong>引入主题（</strong> <strong><code>Theme</code></strong> <strong>）的概念</strong>。</p>
</li>
<li>
<p>维护：</p>
<ul>
<li><code>Resources.Theme mTheme</code></li>
<li><code>int mThemeResource</code></li>
</ul>
</li>
<li>
<p>为 UI 组件（主要是 <code>Activity</code>、<code>Dialog</code> 等）提供：</p>
<ul>
<li><code>setTheme(int resId)</code></li>
<li><code>getTheme()</code></li>
</ul>
</li>
<li>
<p><strong>只有基于</strong> <strong><code>ContextThemeWrapper</code></strong> <strong>的 Context 才真正支持 UI 主题。</strong></p>
</li>
</ul>
<h4 data-id="heading-8"><strong>4）</strong> <strong><code>Application</code></strong></h4>
<ul>
<li>
<p>继承 <code>ContextWrapper</code>，<strong>全应用级别的 Context</strong>。</p>
</li>
<li>
<p>生命周期：<code>onCreate()</code> 在整个应用进程创建时调用一次。</p>
</li>
<li>
<p>主要职责：</p>
<ul>
<li>初始化应用级别的组件（例如：网络库、日志系统、依赖注入容器等）</li>
<li>提供 <strong>Application Context</strong>（<code>getApplicationContext()</code>）</li>
</ul>
</li>
<li>
<p>不直接参与 UI 绘制，对主题支持有限（不用于 View inflation 的 UI Theme）。</p>
</li>
</ul>
<h4 data-id="heading-9"><strong>5）</strong> <strong><code>Activity</code></strong></h4>
<ul>
<li>
<p>继承 <code>ContextThemeWrapper</code>，因此：</p>
<ul>
<li>既是一个 <code>Context</code>，</li>
<li>又是一个 <strong>支持主题的 UI 宿主组件</strong>。</li>
</ul>
</li>
<li>
<p>职责：</p>
<ul>
<li>
<p>管理界面（布局、交互）</p>
</li>
<li>
<p>管理生命周期（<code>onCreate</code>/<code>onStart</code>/<code>onResume</code>…）</p>
</li>
<li>
<p>承担一个“UI 级 Context”：用于</p>
<ul>
<li><code>LayoutInflater</code></li>
<li>Dialog、Popup、Menu 的创建</li>
<li>主题化资源加载（<code>?attr/colorPrimary</code> 等）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-10"><strong>6）</strong> <strong><code>Service</code></strong></h4>
<ul>
<li>
<p>继承 <code>ContextWrapper</code>，<strong>不支持 UI 主题</strong>。</p>
</li>
<li>
<p>职责：</p>
<ul>
<li>在后台执行长时间任务（播放音乐、网络下载等）</li>
<li>支持与其他组件绑定/通信（<code>bindService</code>）</li>
</ul>
</li>
<li>
<p>由于不处理 UI，<strong>不能直接显示窗口、Dialog</strong>（需要借助 <code>Activity</code> 或特殊系统权限）。</p>
</li>
</ul>
<h4 data-id="heading-11"><strong>7）</strong> <strong><code>BroadcastReceiver</code></strong></h4>
<ul>
<li>
<p>不是 <code>Context</code>，但 <code>onReceive()</code> 会给你一个临时的 <code>Context</code>。</p>
</li>
<li>
<p>这个 <code>Context</code> 通常是一个 <strong>短生命周期的</strong> <strong><code>ContextImpl</code></strong> <strong>包装</strong>，主要用于：</p>
<ul>
<li>简单操作：<code>startService()</code>、<code>goAsync()</code> 等</li>
<li>不推荐做耗时操作（<code>onReceive</code> 要尽快返回）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-12"><strong>1.4 类职责对比（简表）</strong></h3>



























































<table><thead><tr><th>类/角色</th><th>是否继承 Context</th><th>是否支持 Theme</th><th>典型使用场景</th></tr></thead><tbody><tr><td>Context（抽象）</td><td>是</td><td>取决于子类</td><td>框架统一接口，不直接使用</td></tr><tr><td>ContextImpl</td><td>是（内部）</td><td>视类型而定</td><td>真正实现所有 Context 功能</td></tr><tr><td>ContextWrapper</td><td>是</td><td>否</td><td>对 ContextImpl 的通用包装</td></tr><tr><td>ContextThemeWrapper</td><td>是</td><td>是</td><td>提供 UI 主题能力（Activity、Dialog 等）</td></tr><tr><td>Application</td><td>是</td><td>有方法，但不用于 UI</td><td>全局初始化、单例、Application Context</td></tr><tr><td>Activity</td><td>是</td><td>是</td><td>界面、View、用户交互</td></tr><tr><td>Service</td><td>是</td><td>否</td><td>后台任务、长期运行逻辑</td></tr><tr><td>BroadcastReceiver</td><td>否</td><td>否</td><td>被动响应广播，通过参数获取 Context</td></tr></tbody></table>
<h2 data-id="heading-13"><strong>二、设计原理与机制</strong></h2>
<h3 data-id="heading-14"><strong>2.1 Context 作为“全局访问点”的设计思想</strong></h3>
<p>Android 不鼓励你使用大量的 <code>static</code> 全局变量来到处传递状态，而是通过 <strong><code>Context</code></strong> <strong>作为</strong> <strong>“应用环境的访问门面（facade）</strong> <strong>”</strong> ，提供：</p>
<ul>
<li>
<p><strong>统一的访问入口</strong>：资源、系统服务、组件启动都从这里拿。</p>
</li>
<li>
<p><strong>隐藏实现细节</strong>：你不需要知道 <code>ActivityManager</code> 在哪一进程，只管 <code>startActivity()</code>。</p>
</li>
<li>
<p><strong>分级的“全局”</strong> ：</p>
<ul>
<li>Application 级：<code>Application</code> / <code>getApplicationContext()</code></li>
<li>Activity 级：带 UI 的 <code>Context</code></li>
<li>Service 级、Receiver 级：非 UI Context</li>
</ul>
</li>
</ul>
<p>这有点类似 <strong>Service Locator</strong> 或 <strong>Facade</strong> 模式：<strong>让上层代码依赖稳定接口，而不依赖具体实现</strong></p>
<h3 data-id="heading-15"><strong>2.2 资源访问机制（Resources / Assets）</strong></h3>
<p>当你调用：</p>
<pre><code class="hljs language-ini" lang="ini">Resources <span class="hljs-attr">res</span> = context.getResources()<span class="hljs-comment">;</span>
Drawable <span class="hljs-attr">d</span> = res.getDrawable(R.drawable.xxx, context.getTheme())<span class="hljs-comment">;</span>
</code></pre>
<p>内部大致流程：</p>
<ol>
<li>
<p><code>context</code>（可能是 Activity / Application）最终委托到 <code>ContextImpl</code>。</p>
</li>
<li>
<p><code>ContextImpl</code> 内部持有一个 <code>Resources</code> 实例，关联当前</p>
<ol>
<li>包名 / APK</li>
<li><code>Configuration</code>（语言、方向、dpi 等）</li>
<li><code>AssetManager</code></li>
</ol>
</li>
<li>
<p><code>Resources</code> 根据当前 <strong><code>Configuration + Theme</code></strong> 选择合适的资源版本（如 <code>values-en</code>、<code>values-night</code> 等）。</p>
</li>
</ol>
<p><strong>关键点：</strong></p>
<ul>
<li><code>ContextImpl</code> 决定“去哪儿找资源”</li>
<li><strong>Theme 会影响资源最终表现</strong>（例如：<code>?attr/colorPrimary</code>）</li>
</ul>
<h3 data-id="heading-16"><strong>2.3 组件启动机制（以</strong> <strong><code>startActivity</code></strong> <strong>为例）</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino">context.<span class="hljs-built_in">startActivity</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Intent</span>(context, DetailActivity.<span class="hljs-keyword">class</span>));
</code></pre>
<p>简化理解：</p>
<ol>
<li><code>Activity</code> / <code>Application</code> → <code>ContextImpl.startActivity()</code></li>
<li>内部通过 <code>Instrumentation</code> / <code>ActivityTaskManager</code> / <code>ActivityManagerService</code> 与系统进程通信（Binder）</li>
<li>系统进程根据 Intent / Manifest 信息，在合适的进程启动/复用 <code>Activity</code> 实例。</li>
<li>新 <code>Activity</code> 创建时，被注入一个 <strong><code>ContextImpl + ContextWrapper</code></strong> <strong>组合的 Context</strong>，并在 <code>attach()</code> 时绑定。</li>
</ol>
<p><strong>好处：</strong> 你的代码只需调用 <code>Context</code> 的 API，不需要直接依赖任何 system_server 内部类。</p>
<h3 data-id="heading-17"><strong>2.4 系统服务获取机制：</strong> <strong><code>getSystemService()</code></strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Object</span> <span class="hljs-title function_">getSystemService</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) {
    <span class="hljs-comment">// 1. 先查看当前 Context 的本地缓存（Map）</span>
    <span class="hljs-comment">// 2. 如果是“真·系统服务”：</span>
    <span class="hljs-comment">//    - 通过 ServiceManager 拿 Binder（一次）</span>
    <span class="hljs-comment">//    - 转成对应的 Manager 类（如 LocationManager）</span>
    <span class="hljs-comment">//    - 缓存起来</span>
    <span class="hljs-comment">// 3. 如果是本地工具类：</span>
    <span class="hljs-comment">//    - 直接 new（如 LayoutInflater）</span>
    <span class="hljs-comment">//    - 缓存起来</span>
}
</code></pre>
<p><strong>区别：</strong></p>
<ul>
<li>
<p><strong>例如</strong> <strong><code>LocationManager</code></strong> <strong>、</strong> <strong><code>PowerManager</code></strong>：</p>
<ul>
<li>内部持有 Binder 代理 → 调用时可能产生 IPC。</li>
</ul>
</li>
<li>
<p><strong>例如</strong> <strong><code>LayoutInflater</code></strong>：</p>
<ul>
<li>是当前进程内的纯 Java 对象 → 不产生 IPC。</li>
</ul>
</li>
</ul>
<p><strong>Context 的意义</strong>：你不用区分“这个服务是远程的还是本地的”，统一通过 <code>getSystemService()</code> 拿就行。</p>
<h3 data-id="heading-18"><strong>2.5 为什么设计成抽象类 + Wrapper，而不是一个单例？</strong></h3>
<p><strong>原因主要是几个维度的解耦与可扩展性：</strong></p>
<ol>
<li>
<p><strong>不同组件需要“不一样”的 Context 行为</strong></p>
<ol>
<li>Activity 需要 Theme、Window、<code>startActivityForResult</code> 等</li>
<li>Service 不需要 Theme，也不能直接弹 UI</li>
<li>Application 需要“全局但不依赖任何具体 UI”的 Context</li>
</ol>
</li>
</ol>
<p>用 <strong><code>ContextWrapper</code></strong> <strong>/</strong> <strong><code>ContextThemeWrapper</code></strong> 即可在保持统一接口的同时，添加/修改特定行为。</p>
<blockquote>
<p>装饰者设计模式</p>
</blockquote>
<ol start="2">
<li>
<p><strong>内部实现可以替换</strong></p>
<ol>
<li>对外只暴露 <code>Context</code> 抽象类和 <code>getSystemService()</code> 这类稳定接口</li>
<li>内部 <code>ContextImpl</code> 的实现可以随着版本演进自由修改</li>
</ol>
</li>
<li>
<p><strong>方便测试 / Mock</strong></p>
<ol>
<li>在单元测试中可以实现一个自定义 <code>Context</code> 或基于 <code>ContextWrapper</code> 的 mock，不需要运行真实的 Android 系统。</li>
</ol>
</li>
</ol>
<h2 data-id="heading-19"><strong>三、主题（Theme）与样式（Style）支持</strong></h2>
<h3 data-id="heading-20"><strong>3.1 Context 与 Theme 的关系</strong></h3>
<p><strong>只有基于</strong> <strong><code>ContextThemeWrapper</code></strong> <strong>的 Context 才真正具备“UI 主题上下文”的语义</strong>，核心数据结构：</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContextThemeWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ContextWrapper</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-type">Resources</span>.<span class="hljs-type">Theme</span> mTheme;
    <span class="hljs-keyword">private</span> int mThemeResource;
}
</code></pre>
<p><strong>Activity = ContextThemeWrapper + UI 能力</strong>，因此：</p>
<ul>
<li>
<p><code>Activity</code> 的 <code>Theme</code> 决定：</p>
<ul>
<li><code>setContentView()</code> 时 View 默认使用怎样的样式</li>
<li><code>?attr/colorPrimary</code>, <code>?attr/textColorPrimary</code> 等主题属性的解析结果</li>
</ul>
</li>
</ul>
<p>而 <strong>Application / Service 的 Context 即使有</strong> <strong><code>setTheme()</code></strong> <strong>方法，也通常不用于 View 的主题化</strong>（因为不会直接 inflate 界面）。</p>
<h3 data-id="heading-21"><strong>3.2</strong> <strong><code>setTheme()</code></strong> <strong>/</strong> <strong><code>getTheme()</code></strong> <strong>工作原理（简化）</strong></h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Override</span>
public void setTheme(int resid) {
    mThemeResource = resid;
    <span class="hljs-built_in">initializeTheme</span>();
}

private void <span class="hljs-built_in">initializeTheme</span>() {
    final boolean first = (mTheme == null);
    if (first) {
        <span class="hljs-comment">// 1. 创建一个新的 Theme</span>
        mTheme = <span class="hljs-built_in">getResources</span>()<span class="hljs-selector-class">.newTheme</span>();
    }

    <span class="hljs-comment">// 2. 先根据父 Context（或 Application）继承一份基础 Theme</span>
    final Theme parent = <span class="hljs-built_in">getBaseContext</span>()<span class="hljs-selector-class">.getTheme</span>();
    if (parent != null) {
        mTheme<span class="hljs-selector-class">.setTo</span>(parent);
    }

    <span class="hljs-comment">// 3. 再把当前资源 id 对应的 style 叠加上去</span>
    mTheme<span class="hljs-selector-class">.applyStyle</span>(mThemeResource, true);
}

<span class="hljs-keyword">@Override</span>
public Resources.Theme getTheme() {
    if (mTheme == null) {
        <span class="hljs-comment">// 如果还没 setTheme，就根据默认 theme 初始化</span>
        mThemeResource = <span class="hljs-built_in">getApplicationInfo</span>()<span class="hljs-selector-class">.theme</span>; <span class="hljs-comment">// Manifest 里配置的</span>
        <span class="hljs-built_in">initializeTheme</span>();
    }
    return mTheme;
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><code>Theme</code> 是对 <code>Resources</code> 中 <code>&lt;style&gt;</code> 的运行时组合/叠加结果。</li>
<li><code>applyStyle()</code> 可以多次调用，后面的 style 能覆盖前面的属性。</li>
<li><code>Activity</code> 的 Theme 在 <code>onCreate()</code> 前就已准备好，<code>setContentView()</code> 时就会用这个 Theme 去解析布局里的 <code>?attr/xxx</code>。</li>
</ul>
<h3 data-id="heading-22"><strong>3.3 Activity 与 Application 主题的继承与覆盖</strong></h3>
<p>Manifest 中常见配置：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;application
    android:<span class="hljs-attr">name</span>=<span class="hljs-string">".MyApp"</span>
    android:<span class="hljs-attr">theme</span>=<span class="hljs-string">"@style/AppTheme"</span>&gt;

    &lt;activity
        android:<span class="hljs-attr">name</span>=<span class="hljs-string">".MainActivity"</span>
        android:<span class="hljs-attr">theme</span>=<span class="hljs-string">"@style/AppTheme.Main"</span>/&gt;
&lt;/application&gt;
</code></pre>
<p><strong>继承链：</strong></p>
<ol>
<li>
<p>Application 设置 <code>android:theme="@style/AppTheme"</code>：</p>
<ol>
<li>作为 <strong>应用内 Activity 的默认主题</strong>（除非 Activity 自己覆盖）</li>
</ol>
</li>
<li>
<p>Activity 设置 <code>android:theme="@style/AppTheme.Main"</code>：</p>
<ol>
<li>其 <code>Theme</code> = 以 Application 的 Theme 为基础，再叠加 <code>AppTheme.Main</code> 的效果（具体取决于 style 的父子关系）。</li>
</ol>
</li>
<li>
<p>如果某个 Activity 未显式声明 <code>android:theme</code>：</p>
<ol>
<li>使用 Application 的 theme 作为其 Theme。</li>
</ol>
</li>
</ol>
<p><strong>运行时覆盖：</strong></p>
<p>在 Activity 中可以：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Override</span>
protected void onCreate(Bundle savedInstanceState) {
    <span class="hljs-built_in">setTheme</span>(R.style.AppTheme_Dark); <span class="hljs-comment">// 必须在 super.onCreate() 之前调用更稳妥</span>
    super<span class="hljs-selector-class">.onCreate</span>(savedInstanceState);
    <span class="hljs-built_in">setContentView</span>(R.layout.activity_main);
}
</code></pre>
<p>也可以为某个局部 UI 创建一个带特定 Theme 的 Context：</p>
<pre><code class="hljs language-ini" lang="ini">Context <span class="hljs-attr">themedContext</span> =
        new ContextThemeWrapper(this, R.style.MyDialogTheme)<span class="hljs-comment">;</span>
AlertDialog <span class="hljs-attr">dialog</span> = new AlertDialog.Builder(themedContext)
        .setTitle("Title")
        .setMessage("Hello")
        .create()<span class="hljs-comment">;</span>
dialog.show()<span class="hljs-comment">;</span>
</code></pre>
<p><strong>这个</strong> <strong><code>ContextThemeWrapper</code></strong> <strong>就是一个局部“主题化 Context”</strong> ，很常用于 Dialog、PopupMenu、RecyclerView item 的样式等。</p>
<h2 data-id="heading-23"><strong>四、使用建议与最佳实践</strong></h2>
<h3 data-id="heading-24"><strong>4.1 如何选择合适的 Context？</strong></h3>


















































<table><thead><tr><th>场景/需求</th><th>推荐 Context 类型</th><th>原因说明</th></tr></thead><tbody><tr><td>加载/绘制界面（setContentView、inflate View）</td><td>Activity Context (this)</td><td>需要使用 Activity 的 Theme、Window，支持 UI 属性解析</td></tr><tr><td>创建 Dialog、PopupWindow、Menu</td><td>Activity Context / 主题化 ContextThemeWrapper</td><td>需要依附 Window、Theme，Application Context 无法正常工作</td></tr><tr><td>启动新的 Activity</td><td>一般用 Activity Context</td><td>与当前 Activity 的任务栈、动画等直接相关</td></tr><tr><td>启动或绑定 Service</td><td>任意合法 Context（注：有时需要非 Activity）</td><td>通常用 Application 或 Activity，都可以，与 UI 无强绑定</td></tr><tr><td>注册全局单例、工具类初始化</td><td>Application Context</td><td>生命周期 = 应用进程，不易造成 Activity 泄漏</td></tr><tr><td>访问系统服务（不依赖 UI，例如 Vibrator、Connectivity）</td><td>Application Context</td><td>仅需系统服务，不需要 Theme/Window</td></tr><tr><td>BroadcastReceiver 中进行短时操作</td><td>onReceive 里的 Context 参数</td><td>系统给你的就是合适的 Context，短时间用完即可</td></tr><tr><td>长时间缓存 Context 引用</td><td>Application Context</td><td>Activity Context 可能被销毁，缓存会导致内存泄漏</td></tr></tbody></table>
<p><strong>经验总结：</strong></p>
<ul>
<li><strong>涉及 UI / Theme / View 的，一律优先用 Activity Context</strong></li>
<li><strong>要放进单例、静态变量、长生命周期对象，则用 Application Context</strong></li>
</ul>
<h3 data-id="heading-25"><strong>4.2 避免内存泄漏的常见方法</strong></h3>
<ol>
<li><strong>不要把 Activity Context 存入静态变量 / 单例</strong></li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ImageLoader</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ImageLoader sInstance;
    <span class="hljs-keyword">private</span> Context mContext;

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">ImageLoader</span>(<span class="hljs-params">Context context</span>)</span> {
        mContext = context; <span class="hljs-comment">// 若传入 Activity，则可能泄漏</span>
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ImageLoader <span class="hljs-title">getInstance</span>(<span class="hljs-params">Context context</span>)</span> {
        <span class="hljs-keyword">if</span> (sInstance == <span class="hljs-literal">null</span>) {
            sInstance = <span class="hljs-keyword">new</span> ImageLoader(context);
        }
        <span class="hljs-keyword">return</span> sInstance;
    }
}
</code></pre>
<p>正确做法：改用 Application Context</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">mContext</span> = context.getApplicationContext()<span class="hljs-comment">;</span>
</code></pre>
<ol start="2">
<li><strong>避免 Handler / Thread 等隐式持有 Activity</strong></li>
</ol>
<ul>
<li>非静态内部类会默认持有外部类（Activity）的引用。</li>
<li>可以使用 <strong>静态内部类 +</strong> <strong><code>WeakReference&lt;Activity&gt;</code></strong> ：</li>
</ul>
<pre><code class="hljs language-scala" lang="scala">static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Handler</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">WeakReference</span>&lt;<span class="hljs-type">Activity</span>&gt; activityRef;

    <span class="hljs-type">MyHandler</span>(<span class="hljs-type">Activity</span> activity) {
        activityRef = <span class="hljs-keyword">new</span> <span class="hljs-type">WeakReference</span>&lt;&gt;(activity);
    }

    <span class="hljs-meta">@Override</span>
    public void handleMessage(<span class="hljs-type">Message</span> msg) {
        <span class="hljs-type">Activity</span> activity = activityRef.get();
        <span class="hljs-keyword">if</span> (activity == <span class="hljs-literal">null</span> || activity.isFinishing()) <span class="hljs-keyword">return</span>;
        <span class="hljs-comment">// 安全使用 activity</span>
    }
}
</code></pre>
<ol start="3">
<li><strong>注意 View 持有 Context</strong></li>
</ol>
<ul>
<li>所有 <code>View</code> 的构造函数都会传入一个 Context，通常是 Activity。</li>
<li>如果你把一个 View（或包含它的对象）缓存到单例里，相当于间接缓存 Activity Context → 泄漏。</li>
<li><strong>规则：不要把 View 放到长生命周期的静态集合或单例中。</strong></li>
</ul>
<ol start="4">
<li><strong>使用生命周期感知组件（Lifecycle-Aware）</strong></li>
</ol>
<ul>
<li>使用 Jetpack 的 <code>ViewModel</code>、<code>LiveData</code>、<code>LifecycleOwner</code> 等，让框架帮助你在适当时机清理引用。</li>
<li><code>ViewModel</code> 中一般只用 Application Context（通过 <code>AndroidViewModel</code>），不要持有 Activity Context。</li>
</ul>
<h2 data-id="heading-26"><strong>五、整体小结</strong></h2>
<ul>
<li>
<p><strong><code>Context</code></strong> <strong>是 Android 应用环境的“门面”，统一对外提供资源访问、组件启动、系统服务获取等能力。</strong></p>
</li>
<li>
<p>通过 <strong><code>ContextImpl + ContextWrapper + ContextThemeWrapper</code></strong> <strong>的分层设计</strong>：</p>
<ul>
<li>把复杂、易变的内部实现封装在 <code>ContextImpl</code> 中；</li>
<li>通过不同包装类（Application、Activity、Service）组合出不同语义的 Context；</li>
<li>同时支持 UI 主题（Theme）、非 UI 背景服务、多进程等场景。</li>
</ul>
</li>
<li>
<p><strong>Theme/Style 与 Context 强绑定</strong>：只有基于 <code>ContextThemeWrapper</code> 的 Context 才具备完整的 UI 主题语义；Activity 通过 Manifest 与 <code>setTheme()</code> 决定自己的外观。</p>
</li>
<li>
<p>实战中最关键的两点：</p>
<ul>
<li><strong>搞清楚当前手上的 Context 属于哪一类（Activity / Application / Service 等），能做什么、不能做什么。</strong></li>
<li><strong>长生命周期用 Application Context，短生命周期/UI 相关用 Activity Context，避免“误用 Context”导致的内存泄漏和 UI 问题。</strong></li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2-6-1 快速掌握Kotlin-语言的接口定义]]></title>    <link>https://juejin.cn/post/7586688485728403462</link>    <guid>https://juejin.cn/post/7586688485728403462</guid>    <pubDate>2025-12-23T07:35:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586688485728403462" data-draft-id="7586680977856397375" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2-6-1 快速掌握Kotlin-语言的接口定义"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T07:35:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="成都大菠萝"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2-6-1 快速掌握Kotlin-语言的接口定义
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    成都大菠萝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:35:32.000Z" title="Tue Dec 23 2025 07:35:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kotlin 接口定义</h2>
<p>Kotlin 接口是一种强大的抽象机制，它允许定义方法、属性、默认实现，并且支持多继承。以下是 Kotlin 接口的完整指南：</p>
<h3 data-id="heading-1">1. <strong>基本接口定义</strong></h3>
<h4 data-id="heading-2">简单接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Drawable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">draw</span><span class="hljs-params">()</span></span>  <span class="hljs-comment">// 抽象方法</span>
}

<span class="hljs-comment">// 实现接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span> : <span class="hljs-type">Drawable</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">draw</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"绘制圆形"</span>)
    }
}
</code></pre>
<h4 data-id="heading-3">带属性的接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Shape</span> {
    <span class="hljs-keyword">val</span> name: String  <span class="hljs-comment">// 抽象属性</span>
    
    <span class="hljs-keyword">val</span> description: String
        <span class="hljs-keyword">get</span>() = <span class="hljs-string">"这是一个形状"</span>  <span class="hljs-comment">// 带 getter 的属性</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Square</span> : <span class="hljs-type">Shape</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> name: String = <span class="hljs-string">"正方形"</span>
    
    <span class="hljs-comment">// 可以重写 description 属性</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> description: String
        <span class="hljs-keyword">get</span>() = <span class="hljs-string">"这是一个四边相等的形状"</span>
}
</code></pre>
<h3 data-id="heading-4">2. <strong>接口中的方法</strong></h3>
<h4 data-id="heading-5">抽象方法和默认实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Vehicle</span> {
    <span class="hljs-comment">// 抽象方法（必须被实现）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">start</span><span class="hljs-params">()</span></span>
    
    <span class="hljs-comment">// 带默认实现的方法（可选重写）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"车辆停止"</span>)
    }
    
    <span class="hljs-comment">// 也可以有具体实现的方法体</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">honk</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"嘟嘟！"</span>)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span> : <span class="hljs-type">Vehicle</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">start</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"汽车启动"</span>)
    }
    
    <span class="hljs-comment">// 可以选择重写 stop()，也可以使用默认实现</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"汽车紧急制动"</span>)
    }
    
    <span class="hljs-comment">// 不重写 honk()，使用接口中的默认实现</span>
}
</code></pre>
<h4 data-id="heading-6">私有方法（Kotlin 1.7+）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">DatabaseAccess</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">save</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span> {
        validate(<span class="hljs-keyword">data</span>)
        println(<span class="hljs-string">"保存数据: <span class="hljs-variable">$data</span>"</span>)
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">validate</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span> {  <span class="hljs-comment">// 接口中的私有方法</span>
        require(<span class="hljs-keyword">data</span>.isNotBlank()) { <span class="hljs-string">"数据不能为空"</span> }
    }
}
</code></pre>
<h3 data-id="heading-7">3. <strong>接口中的属性</strong></h3>
<h4 data-id="heading-8">各种属性类型</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-comment">// 抽象属性（必须被实现）</span>
    <span class="hljs-keyword">val</span> username: String
    
    <span class="hljs-comment">// 带 getter 的属性</span>
    <span class="hljs-keyword">val</span> displayName: String
        <span class="hljs-keyword">get</span>() = username.uppercase()
    
    <span class="hljs-comment">// 可变属性</span>
    <span class="hljs-keyword">var</span> email: String
    
    <span class="hljs-comment">// 常量（使用伴生对象）</span>
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MIN_USERNAME_LENGTH = <span class="hljs-number">3</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RegularUser</span>(<span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> username: String) : User {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> email: String = <span class="hljs-string">""</span>
    
    <span class="hljs-comment">// 可以重写 displayName</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> displayName: String
        <span class="hljs-keyword">get</span>() = <span class="hljs-string">"用户: <span class="hljs-subst">${username.lowercase()}</span>"</span>
}
</code></pre>
<h3 data-id="heading-9">4. <strong>接口继承</strong></h3>
<h4 data-id="heading-10">接口继承接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Clickable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">click</span><span class="hljs-params">()</span></span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Focusable</span> : <span class="hljs-type">Clickable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">focus</span><span class="hljs-params">()</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showOff</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"我是可聚焦的!"</span>)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Button</span> : <span class="hljs-type">Focusable</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">click</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"按钮被点击"</span>)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">focus</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"按钮获得焦点"</span>)
    }
    
    <span class="hljs-comment">// 可以选择重写 showOff() 或不重写</span>
}
</code></pre>
<h4 data-id="heading-11">多接口继承</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">A</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"A.foo"</span>)
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">B</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"B.foo"</span>)
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bar</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"B.bar"</span>)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> : <span class="hljs-type">A</span>, <span class="hljs-type">B</span> {
    <span class="hljs-comment">// 必须重写 foo() 来解决冲突</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 调用特定父接口的实现</span>
        <span class="hljs-keyword">super</span>&lt;A&gt;.foo()
        <span class="hljs-keyword">super</span>&lt;B&gt;.foo()
        println(<span class="hljs-string">"C.foo"</span>)
    }
    
    <span class="hljs-comment">// 不需要重写 bar()，因为只有一个实现</span>
}
</code></pre>
<h3 data-id="heading-12">5. <strong>函数式接口（SAM接口）</strong></h3>
<h4 data-id="heading-13">单抽象方法接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 fun interface 声明（Kotlin 1.4+）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-keyword">interface</span> StringProcessor {</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">process</span><span class="hljs-params">(input: <span class="hljs-type">String</span>)</span></span>: String
}

<span class="hljs-comment">// 传统方式</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">OnClickListener</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">(view: <span class="hljs-type">View</span>)</span></span>
}

<span class="hljs-comment">// 使用 lambda 表达式实现</span>
<span class="hljs-keyword">val</span> processor = StringProcessor { it.uppercase() }
<span class="hljs-keyword">val</span> listener = OnClickListener { println(<span class="hljs-string">"点击了 <span class="hljs-variable">$it</span>"</span>) }

<span class="hljs-comment">// 在函数参数中使用</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setOnClickListener</span><span class="hljs-params">(listener: <span class="hljs-type">OnClickListener</span>)</span></span> {
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 调用时可以传递 lambda</span>
setOnClickListener { view -&gt; println(<span class="hljs-string">"点击"</span>) }
</code></pre>
<h4 data-id="heading-14">Java 函数式接口互操作</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Java 中的函数式接口</span>
<span class="hljs-comment">// @FunctionalInterface</span>
<span class="hljs-comment">// public interface Runnable { void run(); }</span>

<span class="hljs-keyword">val</span> runnable = Runnable { println(<span class="hljs-string">"在后台运行"</span>) }
Thread(runnable).start()

<span class="hljs-comment">// 或者直接使用</span>
Thread { println(<span class="hljs-string">"简洁写法"</span>) }.start()
</code></pre>
<h3 data-id="heading-15">6. <strong>接口与抽象类的比较</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">AnimalInterface</span> {
    <span class="hljs-keyword">val</span> name: String
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeSound</span><span class="hljs-params">()</span></span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span> {  <span class="hljs-comment">// 可以有默认实现</span>
        println(<span class="hljs-string">"<span class="hljs-variable">$name</span> 正在进食"</span>)
    }
}

<span class="hljs-comment">// 抽象类</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnimalAbstract</span> {
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> name: String
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeSound</span><span class="hljs-params">()</span></span>
    
    <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span> {  <span class="hljs-comment">// 需要 open 关键字</span>
        println(<span class="hljs-string">"<span class="hljs-variable">$name</span> 正在进食"</span>)
    }
    
    <span class="hljs-comment">// 抽象类可以有状态</span>
    <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 可以有构造函数</span>
    <span class="hljs-keyword">constructor</span>(name: String)
}

<span class="hljs-comment">// 实现差异</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DogInterface</span> : <span class="hljs-type">AnimalInterface</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> name: String = <span class="hljs-string">"狗狗"</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeSound</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"汪汪！"</span>)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DogAbstract</span> : <span class="hljs-type">AnimalAbstract</span>(<span class="hljs-string">"狗狗"</span>) {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> name: String = <span class="hljs-string">"狗狗"</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeSound</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"汪汪！"</span>)
}
</code></pre>
<h3 data-id="heading-16">7. <strong>接口委托</strong></h3>
<h4 data-id="heading-17">使用 <code>by</code> 关键字委托实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Repository</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">save</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: String?
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseRepository</span> : <span class="hljs-type">Repository</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">save</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span> {
        println(<span class="hljs-string">"保存到数据库: <span class="hljs-variable">$data</span>"</span>)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: String? {
        println(<span class="hljs-string">"从数据库加载: <span class="hljs-variable">$id</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">"数据"</span>
    }
}

<span class="hljs-comment">// 委托给 DatabaseRepository</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedRepository</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> repository: Repository) : Repository <span class="hljs-keyword">by</span> repository {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cache = mutableMapOf&lt;String, String&gt;()
    
    <span class="hljs-comment">// 只重写需要定制的方法</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: String? {
        <span class="hljs-keyword">return</span> cache[id] ?: repository.load(id)?.also {
            cache[id] = it
        }
    }
    
    <span class="hljs-comment">// 新增方法</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearCache</span><span class="hljs-params">()</span></span> {
        cache.clear()
    }
}
</code></pre>
<h4 data-id="heading-18">属性委托到接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Logger</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">log</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsoleLogger</span> : <span class="hljs-type">Logger</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">log</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
        println(<span class="hljs-string">"控制台日志: <span class="hljs-variable">$message</span>"</span>)
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Service</span>(logger: Logger) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> logger: Logger <span class="hljs-keyword">by</span> lazy { logger }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doWork</span><span class="hljs-params">()</span></span> {
        logger.log(<span class="hljs-string">"开始工作"</span>)
        <span class="hljs-comment">// 工作逻辑</span>
        logger.log(<span class="hljs-string">"工作完成"</span>)
    }
}
</code></pre>
<h3 data-id="heading-19">8. <strong>接口中的内联方法</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">JsonSerializable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toJson</span><span class="hljs-params">()</span></span>: String
    
    <span class="hljs-comment">// 内联方法</span>
    <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printJson</span><span class="hljs-params">()</span></span> {
        println(toJson())
    }
}

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>) : JsonSerializable {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toJson</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"""{"name": "<span class="hljs-variable">$name</span>", "age": <span class="hljs-variable">$age</span>}"""</span>
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> person = Person(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">30</span>)
person.printJson()  <span class="hljs-comment">// 内联展开</span>
</code></pre>
<h3 data-id="heading-20">9. <strong>接口中的扩展函数</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Sortable</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">compare</span><span class="hljs-params">(other: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Int</span>
}

<span class="hljs-comment">// 为接口定义扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Sortable&lt;T&gt;</span>&gt; List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">sorted</span><span class="hljs-params">()</span></span>: List&lt;T&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.sortedWith { a, b -&gt; a.compare(b) }
}

<span class="hljs-comment">// 为接口定义扩展属性</span>
<span class="hljs-keyword">val</span> Sortable&lt;*&gt;.hash: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() = hashCode()

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> price: <span class="hljs-built_in">Double</span>) : Sortable&lt;Product&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">compare</span><span class="hljs-params">(other: <span class="hljs-type">Product</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> price.compareTo(other.price)
    }
}

<span class="hljs-keyword">val</span> products = listOf(
    Product(<span class="hljs-string">"A"</span>, <span class="hljs-number">100.0</span>),
    Product(<span class="hljs-string">"B"</span>, <span class="hljs-number">50.0</span>),
    Product(<span class="hljs-string">"C"</span>, <span class="hljs-number">75.0</span>)
)

<span class="hljs-keyword">val</span> sorted = products.sorted()  <span class="hljs-comment">// 使用扩展函数</span>
</code></pre>
<h3 data-id="heading-21">10. <strong>接口的实用模式</strong></h3>
<h4 data-id="heading-22">标记接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 标记接口（没有任何方法）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Serializable</span>

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Document</span>(<span class="hljs-keyword">val</span> content: String) : Serializable

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveIfSerializable</span><span class="hljs-params">(obj: <span class="hljs-type">Any</span>)</span></span> {
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> Serializable) {
        println(<span class="hljs-string">"保存对象: <span class="hljs-variable">$obj</span>"</span>)
    }
}
</code></pre>
<h4 data-id="heading-23">构建器模式接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Builder</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>: T
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CarBuilder</span> : <span class="hljs-type">Builder</span>&lt;<span class="hljs-type">Car</span>&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> color = <span class="hljs-string">"红色"</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> wheels = <span class="hljs-number">4</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setColor</span><span class="hljs-params">(color: <span class="hljs-type">String</span>)</span></span> = apply { <span class="hljs-keyword">this</span>.color = color }
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setWheels</span><span class="hljs-params">(wheels: <span class="hljs-type">Int</span>)</span></span> = apply { <span class="hljs-keyword">this</span>.wheels = wheels }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>: Car {
        <span class="hljs-keyword">return</span> Car(color, wheels)
    }
}

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span>(<span class="hljs-keyword">val</span> color: String, <span class="hljs-keyword">val</span> wheels: <span class="hljs-built_in">Int</span>)

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> car = CarBuilder()
    .setColor(<span class="hljs-string">"蓝色"</span>)
    .setWheels(<span class="hljs-number">4</span>)
    .build()
</code></pre>
<h4 data-id="heading-24">策略模式接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentStrategy</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">pay</span><span class="hljs-params">(amount: <span class="hljs-type">Double</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CreditCardPayment</span> : <span class="hljs-type">PaymentStrategy</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">pay</span><span class="hljs-params">(amount: <span class="hljs-type">Double</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        println(<span class="hljs-string">"信用卡支付: $<span class="hljs-variable">$amount</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PayPalPayment</span> : <span class="hljs-type">PaymentStrategy</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">pay</span><span class="hljs-params">(amount: <span class="hljs-type">Double</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        println(<span class="hljs-string">"PayPal支付: $<span class="hljs-variable">$amount</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ShoppingCart</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> paymentStrategy: PaymentStrategy) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkout</span><span class="hljs-params">(amount: <span class="hljs-type">Double</span>)</span></span> {
        paymentStrategy.pay(amount)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">changeStrategy</span><span class="hljs-params">(strategy: <span class="hljs-type">PaymentStrategy</span>)</span></span> {
        paymentStrategy = strategy
    }
}
</code></pre>
<h3 data-id="heading-25">11. <strong>接口的协变和逆变</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 协变接口（out 关键字）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Producer</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span></span>: T
}

<span class="hljs-comment">// 逆变接口（in 关键字）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Consumer</span>&lt;<span class="hljs-type">in T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">consume</span><span class="hljs-params">(item: <span class="hljs-type">T</span>)</span></span>
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FruitProducer</span> : <span class="hljs-type">Producer</span>&lt;<span class="hljs-type">Fruit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span></span>: Fruit = Fruit()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppleProducer</span> : <span class="hljs-type">Producer</span>&lt;<span class="hljs-type">Apple</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span></span>: Apple = Apple()
}

<span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Fruit</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Apple</span> : <span class="hljs-type">Fruit</span>()

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">useProducer</span><span class="hljs-params">(producer: <span class="hljs-type">Producer</span>&lt;<span class="hljs-type">Fruit</span>&gt;)</span></span> {
    <span class="hljs-keyword">val</span> fruit: Fruit = producer.produce()
}

<span class="hljs-comment">// 协变允许 Producer&lt;Apple&gt; 赋值给 Producer&lt;Fruit&gt;</span>
<span class="hljs-keyword">val</span> fruitProducer: Producer&lt;Fruit&gt; = AppleProducer()
</code></pre>
<h3 data-id="heading-26">12. <strong>接口的最佳实践</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 单一职责原则</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Savable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">save</span><span class="hljs-params">()</span></span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Loadable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">()</span></span>
}

<span class="hljs-comment">// 2. 接口隔离原则（不要强迫客户端依赖它们不用的方法）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Printer</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">print</span><span class="hljs-params">()</span></span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Scanner</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">scan</span><span class="hljs-params">()</span></span>
}

<span class="hljs-comment">// 3. 使用默认实现减少样板代码</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Repository</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">save</span><span class="hljs-params">(item: <span class="hljs-type">T</span>)</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findById</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: T?
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findAll</span><span class="hljs-params">()</span></span>: List&lt;T&gt;
    
    <span class="hljs-comment">// 默认实现</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">existsById</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> findById(id) != <span class="hljs-literal">null</span>
    }
}

<span class="hljs-comment">// 4. 使用函数式接口简化回调</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-keyword">interface</span> OnSuccess<span class="hljs-type">&lt;T&gt;</span> {</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSuccess</span><span class="hljs-params">(result: <span class="hljs-type">T</span>)</span></span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">doAsync</span><span class="hljs-params">(
    operation: () -&gt; <span class="hljs-type">T</span>,
    onSuccess: <span class="hljs-type">OnSuccess</span>&lt;<span class="hljs-type">T</span>&gt;
)</span></span> {
    <span class="hljs-keyword">val</span> result = operation()
    onSuccess.onSuccess(result)
}

<span class="hljs-comment">// 使用</span>
doAsync(
    operation = { <span class="hljs-string">"结果"</span> },
    onSuccess = { println(<span class="hljs-string">"成功: <span class="hljs-variable">$it</span>"</span>) }
)
</code></pre>
<h3 data-id="heading-27">总结</h3>
<p>Kotlin 接口提供了比 Java 接口更强大的功能：</p>
<ul>
<li><strong>默认方法实现</strong>：减少实现类的样板代码</li>
<li><strong>属性支持</strong>：可以定义抽象属性和带 getter/setter 的属性</li>
<li><strong>多继承</strong>：一个类可以实现多个接口</li>
<li><strong>函数式接口</strong>：支持 SAM 转换，简化回调</li>
<li><strong>私有方法</strong>：Kotlin 1.7+ 支持接口中的私有方法</li>
<li><strong>委托模式</strong>：使用 <code>by</code> 关键字委托接口实现</li>
</ul>
<p>接口在 Kotlin 中是实现抽象、多态和解耦代码的重要工具。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始学LangChain（二）：LangChain的核心组件 - Agents]]></title>    <link>https://juejin.cn/post/7586610067568394240</link>    <guid>https://juejin.cn/post/7586610067568394240</guid>    <pubDate>2025-12-23T06:47:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586610067568394240" data-draft-id="7586587644824256546" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始学LangChain（二）：LangChain的核心组件 - Agents"/> <meta itemprop="keywords" content="人工智能,Python"/> <meta itemprop="datePublished" content="2025-12-23T06:47:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="锐学AI"/> <meta itemprop="url" content="https://juejin.cn/user/1165926981220583"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始学LangChain（二）：LangChain的核心组件 - Agents
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1165926981220583/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    锐学AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:47:37.000Z" title="Tue Dec 23 2025 06:47:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>欢迎加入我的【ima知识库】<a href="https://link.juejin.cn?target=https%3A%2F%2Fima.qq.com%2Fwiki%2F%3FshareId%3D4a37197cd81c4a33a2eac74f1e3c2931013b3a28f8ebba113ea59e454af9f803" target="_blank" title="https://ima.qq.com/wiki/?shareId=4a37197cd81c4a33a2eac74f1e3c2931013b3a28f8ebba113ea59e454af9f803" ref="nofollow noopener noreferrer">从零开始学LangChain</a>，第一时间收到更新！</p>
</blockquote>
<p>Agents将大模型与工具结合起来，创建能够进行任务推理、决定使用哪种工具并迭代解决方案的系统。</p>
<p><code>create_agent</code> 提供了一种适用于生产的Agent的实现方式。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsimonwillison.net%2F2025%2FSep%2F18%2Fagents%2F" target="_blank" title="https://simonwillison.net/2025/Sep/18/agents/" ref="nofollow noopener noreferrer">在模型发出最终输出或达到迭代限制前，Agent会一直运行。</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a10d82efdb54b9383e8ee1214f25644~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSQ5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077257&amp;x-signature=dlqlbaUh3SUby9pNLZCAZdmi6A0%3D" alt="1765537636588.png" loading="lazy"/></p>
<h2 data-id="heading-0">Core components（核心组件）</h2>
<h3 data-id="heading-1">Model（模型）</h3>
<p>模型是Agent的推理引擎。可以通过多种方式指定，支持静态和动态模型选择。</p>
<h4 data-id="heading-2">Static model（静态模型）</h4>
<p>静态模型在创建代理时配置一次，并在整个执行过程中保持不变。这是最常见和最直接的方法。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent

agent = create_agent(
    <span class="hljs-string">"gpt-5"</span>,
    tools=tools
)
</code></pre>
<blockquote>
<p>模型标识符字符串支持自动推理（例如，“gpt-5”将被推断为“openai:gpt-5”）。<a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain%2Fmodels%2F%23langchain.chat_models.init_chat_model(model)" target="_blank" title="https://reference.langchain.com/python/langchain/models/#langchain.chat_models.init_chat_model(model)" ref="nofollow noopener noreferrer">参考</a>查看模型标识符字符串映射的完整列表。</p>
</blockquote>
<p>要对模型配置进行更多的控制，请使用供应商提供的工具包进行初始化模型实例。本次以 <code>ChatDeepSeek</code> 为例进行演示。其他可用的聊天模型，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Fintegrations%2Fchat" target="_blank" title="https://docs.langchain.com/oss/python/integrations/chat" ref="nofollow noopener noreferrer">聊天模型</a>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

model = ChatDeepSeek(
    model=<span class="hljs-string">"deepseek-chat"</span>,
    api_base=<span class="hljs-string">"https://api.deepseek.com/v1"</span>,
    temperature=<span class="hljs-number">0.1</span>,
    max_tokens=<span class="hljs-number">1000</span>,
    timeout=<span class="hljs-number">30</span>
    <span class="hljs-comment"># ... (other params)</span>
)
agent = create_agent(model)
</code></pre>
<blockquote>
<p>在使用ChatDeepSeek时，需使用api_base参数（而非api_url）</p>
</blockquote>
<p>模型实例使你能够完全控制配置。当你需要设置特定的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fmodels%23parameters" target="_blank" title="https://docs.langchain.com/oss/python/langchain/models#parameters" ref="nofollow noopener noreferrer">参数</a>时，比如 <code>temperature</code>，<code>max_tokens</code>，<code>timeouts</code>，<code>base_url</code> 和其他特定于提供程序的设置。请<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Fintegrations%2Fproviders%2Fall_providers" target="_blank" title="https://docs.langchain.com/oss/python/integrations/providers/all_providers" ref="nofollow noopener noreferrer">参考</a>查看模型上可用的参数和方法。</p>
<h4 data-id="heading-3">Dynamic model（动态模型）</h4>
<p>动态模型是在运行时根据当前状态和上下文选择的。这样能够适配复杂的路由逻辑，还能优化成本。</p>
<p>要使用动态模型，请使用 <code>@wrap_model_call</code> 装饰器，在发起请求的过程中修改模型参数。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> wrap_model_call, ModelRequest, ModelResponse
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

basic_model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>)
advanced_model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-reasoner"</span>)

<span class="hljs-meta">@wrap_model_call</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">dynamic_model_selection</span>(<span class="hljs-params">request: ModelRequest, handler</span>) -&gt; ModelResponse:
    <span class="hljs-string">"""根据对话的复杂度选择模型"""</span>
    message_count = <span class="hljs-built_in">len</span>(request.state[<span class="hljs-string">"messages"</span>])

    <span class="hljs-keyword">if</span> message_count &gt; <span class="hljs-number">5</span>:
        <span class="hljs-comment"># 在长对话的时候使用高级模型</span>
        model = advanced_model
    <span class="hljs-keyword">else</span>:
        model = basic_model

    <span class="hljs-keyword">return</span> handler(request.override(model=model))

agent = create_agent(
    model=basic_model,  <span class="hljs-comment"># 默认使用基础模型</span>
    middleware=[dynamic_model_selection]
)
result1 = agent.invoke({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你叫什么名字？"</span>}]
})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅: <span class="hljs-subst">{result1[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
result2 = agent.invoke({
    <span class="hljs-string">"messages"</span>: [
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n1+1等于多少？"</span>},
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n1+2等于多少？"</span>},
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n1+3等于多少？"</span>},
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n1+4等于多少？"</span>},
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n1+5等于多少？"</span>},
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n1+6等于多少？"</span>}
    ]
})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅: <span class="hljs-subst">{result2[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
</code></pre>
<blockquote>
<p>⚠️ 使用结构化输出时不支持预绑定模型(通过<a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain_core%2Flanguage_models%2F%23langchain_core.language_models.chat_models.BaseChatModel.bind_tools" target="_blank" title="https://reference.langchain.com/python/langchain_core/language_models/#langchain_core.language_models.chat_models.BaseChatModel.bind_tools" ref="nofollow noopener noreferrer">bind_tools</a>进行绑定的模型)。如果您需要具有结构化输出的动态模型选择，请确保传递给中间件的模型没有预绑定。</p>
</blockquote>
<blockquote>
<p>💡 更多模型配置的详细信息，参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fmodels" target="_blank" title="https://docs.langchain.com/oss/python/langchain/models" ref="nofollow noopener noreferrer">Models</a>。关于动态模型选择，参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fmiddleware%2Foverview%23dynamic-model" target="_blank" title="https://docs.langchain.com/oss/python/langchain/middleware/overview#dynamic-model" ref="nofollow noopener noreferrer">Dynamic model in middleware</a>，。</p>
</blockquote>
<h3 data-id="heading-4">Tools（工具）</h3>
<p>工具赋予agents采取行动的能力。agents通过以下方式超越了简单的纯模型工具绑定：</p>
<ul>
<li>有次序地调用多个工具（通过prompt触发）</li>
<li>在适当的时候异步调用工具</li>
<li>基于之前的结果的进行动态工具选择</li>
<li>加入工具调用的重试逻辑和异常处理</li>
<li>在跨工具调用时保持Agent状态的持久性</li>
</ul>
<p>想要了解更多关于工具的信息，请查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Ftools" target="_blank" title="https://docs.langchain.com/oss/python/langchain/tools" ref="nofollow noopener noreferrer">工具</a></p>
<h4 data-id="heading-5">Defining Tools（定义工具）</h4>
<p>将工具列表传递给Agent。</p>
<blockquote>
<p>💡 工具可以被指定为普通的Python函数或协程。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Ftools%23create-tools" target="_blank" title="https://docs.langchain.com/oss/python/langchain/tools#create-tools" ref="nofollow noopener noreferrer">tool decorator</a>可用来自定义工具名称、描述、参数模型和其他属性。</p>
</blockquote>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>)

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""查询信息"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Results for: <span class="hljs-subst">{query}</span>"</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">location: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""根据地点查询天气"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{location}</span>天气: 晴, 25℃"</span>

agent = create_agent(model, tools=[search, get_weather])
result = agent.invoke({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"武汉的天气怎么样？"</span>}]
})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅: <span class="hljs-subst">{result[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
</code></pre>
<p>如果提供了一个空的工具列表，代理将由一个没有工具调用能力的LLM节点组成。</p>
<h4 data-id="heading-6">Tool error handling（工具的异常处理）</h4>
<p>如果要自定义工具的异常处理，请使用<a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain%2Fmiddleware%2F%23langchain.agents.middleware.wrap_tool_call" target="_blank" title="https://reference.langchain.com/python/langchain/middleware/#langchain.agents.middleware.wrap_tool_call" ref="nofollow noopener noreferrer">@wrap_tool_call</a>装饰器来创建中间件：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> wrap_tool_call
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> ToolMessage
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>, max_retries=<span class="hljs-number">0</span>)

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">query_airindex</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""计算空气指数"""</span>
    pm25 = <span class="hljs-number">1000</span>
    airindex = pm25 / <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> airindex

<span class="hljs-meta">@wrap_tool_call</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_tool_errors</span>(<span class="hljs-params">request, handler</span>):
    <span class="hljs-string">"""自定义工具执行过程中的异常消息"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">return</span> handler(request)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-keyword">return</span> ToolMessage(
            content=<span class="hljs-string">f"Tool error: 请检查输入并重试。 (<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>)"</span>,
            tool_call_id=request.tool_call[<span class="hljs-string">"id"</span>]
        )

agent = create_agent(
    model=model,
    tools = [query_airindex],
    middleware=[handle_tool_errors]
)
result = agent.invoke({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"查询一下武汉的空气指数"</span>}]
})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅: <span class="hljs-subst">{result[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">2</span>].content}</span>"</span>)
</code></pre>
<p>当工具执行失败时，Agent将返回带有自定义异常消息的<a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain%2Fmessages%2F%23langchain.messages.ToolMessage" target="_blank" title="https://reference.langchain.com/python/langchain/messages/#langchain.messages.ToolMessage" ref="nofollow noopener noreferrer">ToolMessage</a>：</p>
<pre><code class="hljs language-python" lang="python">[
    ...
    ToolMessage(
        content=<span class="hljs-string">"Tool error: 请检查输入并重试。 (division by zero)"</span>,
        tool_call_id=<span class="hljs-string">"..."</span>
    ),
    ...
]
</code></pre>
<h4 data-id="heading-7">Tool use in the ReAct loop</h4>
<p>Agent遵循ReAct（“ Reasoning（推理）+ Acting（执行）”）规则，在简短的推理步骤与目标工具调用之间交替进行，并将结果观察结果提供给后续决策，直到它们能够提供最终答案。</p>
<h5 data-id="heading-8">ReaAct loop示例：</h5>
<p><strong>Prompt：</strong> 找到当前最流行的无线耳机并验证可用性。</p>
<pre><code class="hljs language-ini" lang="ini">================================ Human <span class="hljs-attr">Message</span> =================================

找到现在最流行的无线耳机，看看是否有货
</code></pre>
<ul>
<li><strong>Reasoning（推理）：</strong>“流行度是时间敏感的，我需要使用已经提供的搜索工具。”</li>
<li><strong>Acting（执行）：</strong> 调用 <code>search_products("无线耳机")</code></li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">==================================</span> <span class="hljs-string">Ai</span> <span class="hljs-string">Message</span> <span class="hljs-string">==================================</span>
<span class="hljs-attr">Tool Calls:</span>
  <span class="hljs-string">search_products</span> <span class="hljs-string">(call_abc123)</span>
 <span class="hljs-attr">Call ID:</span> <span class="hljs-string">call_abc123</span>
  <span class="hljs-attr">Args:</span>
    <span class="hljs-attr">query:</span> <span class="hljs-string">wireless</span> <span class="hljs-string">headphones</span>
</code></pre>

<pre><code class="hljs language-ini" lang="ini">================================= Tool <span class="hljs-attr">Message</span> =================================

Found 5 products matching "wireless headphones". Top 5 results: WH-1000XM5, ...
</code></pre>
<p>后面还会继续重复上述Reasoning和Acting步骤，直到Agent得到最终答案（这里不继续演示）。</p>
<blockquote>
<p>💡 更多关于工具信息，请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Ftools" target="_blank" title="https://docs.langchain.com/oss/python/langchain/tools" ref="nofollow noopener noreferrer">Tools</a></p>
</blockquote>
<h3 data-id="heading-9">System prompt（系统提示词）</h3>
<p>你可以通过提供提示词来塑造Agent处理任务的方式。系统提示词通常是以字符串的形式提供：</p>
<pre><code class="hljs language-python" lang="python">agent = create_agent(
    model,
    tools,
    system_prompt=<span class="hljs-string">"你是一个有用的助手。回答要简洁准确。"</span>
)
</code></pre>
<p>如果没有提供系统提示词，Agent将直接从消息中推断其任务。</p>
<p>系统提示词参数可以是 <code>str</code> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain%2Fmessages%2F%23langchain.messages.SystemMessage" target="_blank" title="https://reference.langchain.com/python/langchain/messages/#langchain.messages.SystemMessage" ref="nofollow noopener noreferrer"><code>SystemMessage</code></a>。使用 <code>SystemMessage</code> 可以让你更好地控制提示词的结构，这对于特定大模型供应商的功能很有用，比如Anthropic的提示词缓存：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> SystemMessage, HumanMessage

literary_agent = create_agent(
    model=<span class="hljs-string">"anthropic:claude-sonnet-4-5"</span>,
    system_prompt=SystemMessage(
        content=[
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-string">"You are an AI assistant tasked with analyzing literary works."</span>,
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-string">"&lt;the entire contents of 'Pride and Prejudice'&gt;"</span>,
                <span class="hljs-string">"cache_control"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"ephemeral"</span>}
            }
        ]
    )
)

result = literary_agent.invoke(
    {<span class="hljs-string">"messages"</span>: [HumanMessage(<span class="hljs-string">"Analyze the major themes in 'Pride and Prejudice'."</span>)]}
)
</code></pre>
<p><code>cache_control</code> 字段的 <code>{"type": "ephemeral"}</code> 告诉Anthropic缓存内容块，减少重复使用相同系统提示词的请求的延迟和成本。</p>
<h4 data-id="heading-10">Dynamic system prompt（动态系统提示词）</h4>
<p>对于需要根据运行时上下文或Agent状态修改系统提示词这种更高级的用法，可以使用middleware（中间件）。</p>
<p>通过 <code>@dynamic_prompt</code> 装饰器创建中间件，实现根据模型请求生成系统提示词：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict

<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> dynamic_prompt, ModelRequest

<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    user_role: <span class="hljs-built_in">str</span>

<span class="hljs-meta">@dynamic_prompt</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">user_role_prompt</span>(<span class="hljs-params">request: ModelRequest</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""根据用户角色来生成系统提示词"""</span>
    user_role = request.runtime.context.get(<span class="hljs-string">"user_role"</span>, <span class="hljs-string">"user"</span>)
    base_prompt = <span class="hljs-string">"你是一个有用的助手。"</span>

    <span class="hljs-keyword">if</span> user_role == <span class="hljs-string">"专家"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{base_prompt}</span> 给出详细的专业解释。"</span>
    <span class="hljs-keyword">elif</span> user_role == <span class="hljs-string">"小白"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{base_prompt}</span> 简单地解释概念，避免术语。"</span>

    <span class="hljs-keyword">return</span> base_prompt

model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>)

agent = create_agent(
    model=model,
    middleware=[user_role_prompt],
    context_schema=Context
)

<span class="hljs-comment"># 系统提示词会根据上下文动态产生</span>
result1 = agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"解释一下机器学习"</span>}]},
    context={<span class="hljs-string">"user_role"</span>: <span class="hljs-string">"专家"</span>}
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 专家: <span class="hljs-subst">{result1[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
result2 = agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"解释一下机器学习"</span>}]},
    context={<span class="hljs-string">"user_role"</span>: <span class="hljs-string">"小白"</span>}
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 小白: <span class="hljs-subst">{result2[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
</code></pre>
<h2 data-id="heading-11">Invocation（调用）</h2>
<p>您可以通过更新Agent的 <code>State</code> 状态来调用它。所有agents在其状态中都包含一个 <code>sequence of messages</code> （消息序列），发送一条消息来调用Agent：</p>
<pre><code class="hljs language-python" lang="python">result = agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"武汉的天气怎么样？"</span>}]}
)
</code></pre>
<p>有关Agent的streaming steps或tokens，请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fagents%2Fstreaming" target="_blank" title="https://docs.langchain.com/oss/python/langchain/agents/streaming" ref="nofollow noopener noreferrer">streaming</a></p>
<p>另外，Agent遵循LangGraph <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flanggraph%2Fuse-graph-api" target="_blank" title="https://docs.langchain.com/oss/python/langgraph/use-graph-api" ref="nofollow noopener noreferrer">Graph API</a>，并支持所有相关的方法，如 <code>stream</code> 和 <code>invoke</code> 。</p>
<h2 data-id="heading-12">Advanced concepts（高级概念）</h2>
<h3 data-id="heading-13">Structured output（结构化输出）</h3>
<p>在某些情况下，你可能希望Agent以特定格式返回输出。LangChain通过 <code>response_format</code> （响应格式）提供了结构化输出的策略。</p>
<h4 data-id="heading-14">ToolStrategy（工具策略）</h4>
<p><code>ToolStrategy</code> 使用人为调用工具来生成结构化的输出。这适用于任何支持工具调用的模型：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.agents.structured_output <span class="hljs-keyword">import</span> ToolStrategy
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

<span class="hljs-comment"># 结构化输出模型（必须定义）：</span>
<span class="hljs-comment"># 方法1：Pydantic BaseModel - 官方推荐</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContactInfo</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-built_in">str</span>
    email: <span class="hljs-built_in">str</span>
    phone: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># 方法2：dataclass - 极致性能，简单场景</span>
<span class="hljs-comment"># from dataclasses import dataclass</span>
<span class="hljs-comment"># @dataclass</span>
<span class="hljs-comment"># class ContactInfo:</span>
<span class="hljs-comment">#     name: str</span>
<span class="hljs-comment">#     email: str</span>
<span class="hljs-comment">#     phone: str | None = None</span>

<span class="hljs-comment"># 方法3：TypedDict - 纯字典场景，无验证需求</span>
<span class="hljs-comment"># from typing import TypedDict, NotRequired</span>
<span class="hljs-comment"># class ContactInfo(TypedDict):</span>
<span class="hljs-comment">#     name: str</span>
<span class="hljs-comment">#     email: str</span>
<span class="hljs-comment">#     phone: NotRequired[str]</span>

model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>)

agent = create_agent(
    model=model,
    response_format=ToolStrategy(ContactInfo)
)

result = agent.invoke({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"提取联系人信息: John Doe, john@example.com, (555) 123-4567"</span>}]
})

<span class="hljs-built_in">print</span>(result[<span class="hljs-string">"structured_response"</span>])
<span class="hljs-comment"># ContactInfo(name='John Doe', email='john@example.com', phone='(555) 123-4567')</span>
</code></pre>
<h4 data-id="heading-15">ProviderStrategy（供应商策略）</h4>
<p><code>ProviderStrategy</code> 使用模型供应商提供的native（原生）结构化输出。这更可靠，但只适用于支持原生结构化输出的供应商（例如：OpenAI，<strong>DeepSeek等国内大模型暂时不支持ProviderStrategy</strong>）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.agents.structured_output <span class="hljs-keyword">import</span> ProviderStrategy
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

<span class="hljs-comment"># 结构化输出模型（必须定义）：</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContactInfo</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-built_in">str</span>
    email: <span class="hljs-built_in">str</span>
    phone: <span class="hljs-built_in">str</span>

model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>)

<span class="hljs-keyword">try</span>:
    agent = create_agent(
        model=model,
        response_format=ProviderStrategy(ContactInfo)
    )
    result = agent.invoke({
        <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"提取联系人信息: John Doe, john@example.com, (555) 123-4567"</span>}]
    })
    <span class="hljs-built_in">print</span>(result[<span class="hljs-string">"structured_response"</span>])
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   ❌ ProviderStrategy 失败: <span class="hljs-subst">{<span class="hljs-built_in">type</span>(e).__name__}</span>: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">100</span>]}</span>..."</span>)
<span class="hljs-comment"># ❌ ProviderStrategy 失败: BadRequestError: Error code: 400</span>
</code></pre>
<blockquote>
<p>🚨 从 <code>langchain 1.0</code> 开始，必须显式地使用 <code>ToolStrategy</code> 或 <code>ProviderStrategy</code> 。</p>
</blockquote>
<h3 data-id="heading-16">Memory</h3>
<p>Agents通过消息state（状态）自动维护会话历史。还可以对agent进行配置，使用自定义状态模型，以便在会话期间记住额外的信息。</p>
<p>存储在状态中的信息可以看作是agent的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fshort-term-memory" target="_blank" title="https://docs.langchain.com/oss/python/langchain/short-term-memory" ref="nofollow noopener noreferrer"><code>short-term memory</code></a> 短期记忆：</p>
<p>自定义state（状态）模型必须将 <a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain%2Fagents%2F%23langchain.agents.AgentState" target="_blank" title="https://reference.langchain.com/python/langchain/agents/#langchain.agents.AgentState" ref="nofollow noopener noreferrer"><code>AgentState</code></a> 扩展为 <code>TypedDict</code>。</p>
<p>自定义state（状态）的方式有两种：</p>
<ol>
<li>通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fmiddleware" target="_blank" title="https://docs.langchain.com/oss/python/langchain/middleware" ref="nofollow noopener noreferrer"><code>middleware</code></a> （首选）</li>
<li>通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain%2Fmiddleware%2F%23langchain.agents.middleware.AgentMiddleware.state_schema" target="_blank" title="https://reference.langchain.com/python/langchain/middleware/#langchain.agents.middleware.AgentMiddleware.state_schema" ref="nofollow noopener noreferrer"><code>state_schema</code></a> on <a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain%2Fagents%2F%23langchain.agents.create_agent" target="_blank" title="https://reference.langchain.com/python/langchain/agents/#langchain.agents.create_agent" ref="nofollow noopener noreferrer"><code>create_agent</code></a></li>
</ol>
<h4 data-id="heading-17">Defining state via middleware（通过中间件定义状态）</h4>
<p>当你的自定义state（状态）需要被特定的中间件hooks（钩子）和附加到该中间件上的tools（工具）访问时，使用中间件来定义自定义state（状态）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentState
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> AgentMiddleware
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>)

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定城市的天气信息"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{city}</span> 当前天气：晴天，25°C"</span>
  
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomState</span>(<span class="hljs-title class_ inherited__">AgentState</span>):
    <span class="hljs-string">"""支持用户偏好的自定义状态"""</span>
    user_preferences: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomMiddleware</span>(<span class="hljs-title class_ inherited__">AgentMiddleware</span>):
    <span class="hljs-string">"""根据用户偏好动态调整提示词和工具访问的自定义中间件"""</span>
    state_schema = CustomState

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">before_model</span>(<span class="hljs-params">self, state: CustomState, runtime</span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"============= before_model =================="</span>)
        <span class="hljs-built_in">print</span>(state.get(<span class="hljs-string">"user_preferences"</span>))
        
agent = create_agent(
    model=model,
    tools=[get_weather],
    middleware=[CustomMiddleware()]
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"======== 🤖 开始调用... =================="</span>)
result = agent.invoke({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"武汉的天气怎么样，有哪些地方值得游玩？"</span>}],
    <span class="hljs-string">"user_preferences"</span>: {<span class="hljs-string">"style"</span>: <span class="hljs-string">"technical"</span>, <span class="hljs-string">"verbosity"</span>: <span class="hljs-string">"detailed"</span>},
})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 回答: <span class="hljs-subst">{result[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
</code></pre>
<h4 data-id="heading-18">Defining state via <code>state_schema</code> （通过 <code>state_schema</code> 定义状态）</h4>
<p>使用 <code>state_schema</code> 这个参数作为定义状态的快捷键，这种方式<strong>只有</strong>在使用的tools（工具）的时候才能使用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentState
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定城市的天气信息"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{city}</span> 当前天气：晴天，25°C"</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomState</span>(<span class="hljs-title class_ inherited__">AgentState</span>):
    user_preferences: <span class="hljs-built_in">dict</span>

agent = create_agent(
    model=<span class="hljs-string">"deepseek-chat"</span>,
    tools=[get_weather],
    state_schema=CustomState
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"======== 🤖 开始调用... =================="</span>)
result = agent.invoke({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"武汉的天气怎么样，有哪些地方值得游玩？"</span>}],
    <span class="hljs-string">"user_preferences"</span>: {<span class="hljs-string">"style"</span>: <span class="hljs-string">"technical"</span>, <span class="hljs-string">"verbosity"</span>: <span class="hljs-string">"detailed"</span>},
})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 回答: <span class="hljs-subst">{result[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
</code></pre>
<blockquote>
<p>⚠️ 从 <code>langchain 1.0</code> 开始，自定义状态模式模型是 <code>TypedDict</code> 类型。不再支持Pydantic models和dataclasses。详情请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Fmigrate%2Flangchain-v1%23state-type-restrictions" target="_blank" title="https://docs.langchain.com/oss/python/migrate/langchain-v1#state-type-restrictions" ref="nofollow noopener noreferrer">v1 migration guide</a></p>
</blockquote>
<blockquote>
<p>⚠️ 定义自定义state（状态），使用 <code>middleware</code> 优于 <code>state_schema</code> ，这让你在概念上将状态扩展限定在相关中间件和工具的范围内。</p>
<p><code>state_schema</code> 在 <code>create_agent</code> 时仍然向后兼容。</p>
</blockquote>
<blockquote>
<p>💡 更多关于memory的信息，参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Fconcepts%2Fmemory" target="_blank" title="https://docs.langchain.com/oss/python/concepts/memory" ref="nofollow noopener noreferrer">Memory</a> 。关于实现跨会话long-term memory的信息，参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Flong-term-memory" target="_blank" title="https://docs.langchain.com/oss/python/langchain/long-term-memory" ref="nofollow noopener noreferrer">Long-term memory</a> 。</p>
</blockquote>
<h3 data-id="heading-19">Streaming（流）</h3>
<p>我们已经看到了如何使用 <code>invoke</code> 调用Agent得到最终响应。如果Agent执行多个步骤，这可能需要一段时间。为了显示中间进程，我们可以在消息生成时将其流化。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定城市的天气信息"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{city}</span> 当前天气：晴天，25°C"</span>

agent = create_agent(model=<span class="hljs-string">"deepseek-chat"</span>, tools=[get_weather])
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> agent.stream({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"武汉的天气怎么样，给我一个穿衣建议"</span>}]
}, stream_mode=<span class="hljs-string">"values"</span>):
    <span class="hljs-comment"># Each chunk contains the full state at that point</span>
    latest_message = chunk[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> latest_message.content:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Agent: <span class="hljs-subst">{latest_message.content}</span>"</span>)
    <span class="hljs-keyword">elif</span> latest_message.tool_calls:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Calling tools: <span class="hljs-subst">{[tc[<span class="hljs-string">'name'</span>] <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> latest_message.tool_calls]}</span>"</span>)
</code></pre>
<blockquote>
<p>💡 更多关于streaming的细节，参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fstreaming" target="_blank" title="https://docs.langchain.com/oss/python/langchain/streaming" ref="nofollow noopener noreferrer">Streaming</a>。</p>
</blockquote>
<h3 data-id="heading-20">Middleware（中间件）</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fmiddleware" target="_blank" title="https://docs.langchain.com/oss/python/langchain/middleware" ref="nofollow noopener noreferrer">Middleware</a> 中间件为在不同的执行阶段定制Agent的行为提供了强大的扩展能力。你可以这样使用中间件：</p>
<ul>
<li>调用模型之前的处理Agent的状态。（例如：message trimming,context injection）</li>
<li>修改或验证模型的响应（例如：guardrails，content filtering）</li>
<li>使用自定义逻辑处理工具执行产生的异常</li>
<li>实现基于状态或上下文的动态模型选择</li>
<li>添加自定义日志、监控或分析</li>
</ul>
<p>中间件无缝地集成到Agent的执行中，你可以在关键节点拦截和修改数据流，而无需更改核心Agent逻辑。</p>
<blockquote>
<p>💡 关于中间件的完整文档（包括 <code>@before_model</code> , <code>@after_model</code> , <code>@wrap_tool_call</code>），请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fmiddleware" target="_blank" title="https://docs.langchain.com/oss/python/langchain/middleware" ref="nofollow noopener noreferrer">Middleware</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重读经典：Karpathy 的《循环神经网络不可思议的有效性》与代码实战]]></title>    <link>https://juejin.cn/post/7586675587148578852</link>    <guid>https://juejin.cn/post/7586675587148578852</guid>    <pubDate>2025-12-23T07:09:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586675587148578852" data-draft-id="7586680977855987775" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重读经典：Karpathy 的《循环神经网络不可思议的有效性》与代码实战"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T07:09:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拖拖765"/> <meta itemprop="url" content="https://juejin.cn/user/3727811066212480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重读经典：Karpathy 的《循环神经网络不可思议的有效性》与代码实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3727811066212480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拖拖765
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:09:02.000Z" title="Tue Dec 23 2025 07:09:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 GPT-4 和各种大模型横行的今天，我们很容易忘记深度学习领域的“史前时代”。但在 2015 年，Andrej Karpathy（OpenAI 创始成员、前 Tesla AI 总监）发表了一篇极具影响力的博文——<a href="https://link.juejin.cn?target=https%3A%2F%2Fkarpathy.github.io%2F2015%2F05%2F21%2Frnn-effectiveness%2F" target="_blank" title="https://karpathy.github.io/2015/05/21/rnn-effectiveness/" ref="nofollow noopener noreferrer">《The Unreasonable Effectiveness of Recurrent Neural Networks》</a>。</p>
<p>这篇文章不仅是无数开发者的 RNN 启蒙读物，更第一次向大众展示了：<strong>一个简单的算法，只要有足够的数据，竟然能自学成才，写诗、写代码甚至写论文。</strong></p>
<p>今天，我们来重读这篇经典，梳理其核心技术，并用 PyTorch 复现一个最小版本的 Demo。</p>
<hr/>
<h2 data-id="heading-0">1. 核心内容：序列的魔法</h2>
<p>传统的神经网络（如全连接网络或 CNN）通常受到 API 的限制：它们接受固定大小的向量作为输入（例如一张图像），并产生固定大小的向量作为输出（例如不同类别的概率）。</p>
<p>Karpathy 在文中指出，RNN（循环神经网络）的魔力在于它打破了这种限制。它处理的是<strong>序列（Sequences）</strong> 。</p>
<ul>
<li>输入可以是序列（如一段文本）。</li>
<li>输出可以是序列（如生成的翻译）。</li>
<li>最重要的是，它拥有<strong>内部状态（Hidden State）</strong> 。这意味着在处理当前的输入时，它还“记得”刚才看到的内容。</li>
</ul>
<p>文章中最著名的实验是<strong>字符级语言模型（Character-Level Language Model）</strong> 。不同于通常基于“单词”的 NLP 模型，Karpathy 让 RNN 一个字符一个字符地阅读文本。</p>
<blockquote>
<p>输入：h -&gt; e -&gt; l -&gt; l</p>
<p>预测：e -&gt; l -&gt; l -&gt; o</p>
</blockquote>
<p>模型不需要预先知道什么是“单词”，什么是“语法”。它必须从零开始学会：<code>h</code> 后面跟着 <code>e</code> 的概率更高；左括号 <code>(</code> 出现后，未来某个时刻必须出现右括号 <code>)</code>。</p>
<hr/>
<h2 data-id="heading-1">2. 关键技术与创新点</h2>
<p>虽然 RNN 和 LSTM 的数学原理在文章发表前就已经存在，但 Karpathy 的这篇文章通过极具创意的实验，挖掘出了几个关键的技术洞见：</p>
<h3 data-id="heading-2">2.1 LSTM 的长距离记忆</h3>
<p>文章明确展示了 <strong>LSTM (Long Short-Term Memory)</strong> 相比普通 RNN 的优越性。普通 RNN 只有短时记忆，难以处理长文本。而 LSTM 通过精巧的门控机制（遗忘门、输入门、输出门），能够“记住”很久之前的信息。例如，在生成 C 语言代码时，LSTM 能够记得几百个字符前打开的大括号 <code>{</code>，并在合适的时机生成关闭的大括号 <code>}</code>。</p>
<h3 data-id="heading-3">2.2 可解释性：神经元可视化</h3>
<p>这是文章最精彩的部分。Karpathy 没有把网络当成黑盒，而是可视化了 LSTM 内部特定单元（Cell）的激活状态。他惊讶地发现了一些功能明确的“神经元”：</p>
<ul>
<li><strong>引号检测单元</strong>：当遇到开引号时激活，直到遇到闭引号才关闭。</li>
<li><strong>行长计数单元</strong>：随着一行字符的增加，激活值逐渐升高，仿佛在计算何时该换行。</li>
<li><strong>缩进层级单元</strong>：在生成代码时，有单元专门负责跟踪 <code>if/else</code> 的嵌套层级。</li>
</ul>
<h3 data-id="heading-4">2.3 Softmax 温度 (Temperature)</h3>
<p>文章介绍了一个至今仍在使用的技巧：在生成文本时引入“温度”参数。</p>
<ul>
<li><strong>高温度 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">T &gt; 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>)</strong> ：模型更疯狂，创造力更强，但也更容易出错。</li>
<li><strong>低温度 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>&lt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">T &lt; 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>)</strong> ：模型更保守，倾向于重复高概率的字符（有时会陷入死循环）。</li>
</ul>
<hr/>
<h2 data-id="heading-5">3. 实际应用场景</h2>
<p>虽然现在的 NLP 领域已经被 Transformer (GPT) 统治，但 Karpathy 文中提到的 RNN 应用模式，构成了后来无数 AI 产品的基础：</p>
<ol>
<li><strong>代码辅助 (Code Copilot 前身)</strong> ：文中展示了 RNN 学习 Linux 内核源码后，能生成以假乱真的 C 代码。这正是后来 GitHub Copilot 等工具的雏形——通过学习海量代码库来预测下一行代码。</li>
<li><strong>机器翻译 (Seq2Seq)</strong> ：利用 RNN 的“编码器-解码器”结构，将一种语言的序列映射为另一种语言的序列。</li>
<li><strong>图像描述 (Image Captioning)</strong> ：结合 CNN 提取图片特征，再用 RNN 生成描述文字（如“一只猫坐在草地上”）。这是 Karpathy 的成名研究方向。</li>
<li><strong>文本生成与风格迁移</strong>：从生成莎士比亚剧本到生成假 Wikipedia 条目，证明了模型可以捕捉并模仿特定的文风。</li>
</ol>
<hr/>
<h2 data-id="heading-6">4. 动手实战：最小可运行 Demo (PyTorch)</h2>
<p>Karpathy 当年用 NumPy 手写了一个 100 行的代码。为了方便现代开发者理解，我将其重构为 <strong>PyTorch</strong> 版本。</p>
<p>这段代码实现了一个核心逻辑：给它一段文本，它学会这段文本的风格，并能无限生成下去。</p>
<h3 data-id="heading-7">环境准备</h3>
<p>你需要安装 PyTorch：<code>pip install torch</code></p>
<h3 data-id="heading-8">完整代码 (<code>min_rnn.py</code>)</h3>
<p>Python</p>
<pre><code class="hljs language-ini" lang="ini">import torch
import torch.nn as nn
import torch.optim as optim
import sys

<span class="hljs-comment"># --- 1. 数据准备 ---</span>
<span class="hljs-comment"># 这里我们可以用一段简单的文本，或者你可以替换成任何你喜欢的 txt 文件内容</span>
<span class="hljs-attr">text</span> = <span class="hljs-string">"""
The quick brown fox jumps over the lazy dog.
Typically, RNNs process data sequentially.
Deep learning is amazing and recursive.
"""</span> * <span class="hljs-number">100</span> <span class="hljs-comment"># 重复多次以增加训练数据量</span>

<span class="hljs-comment"># 构建字符表</span>
<span class="hljs-attr">chars</span> = sorted(list(set(text)))
<span class="hljs-attr">char_to_int</span> = {c: i for i, c in enumerate(chars)}
<span class="hljs-attr">int_to_char</span> = {i: c for i, c in enumerate(chars)}

<span class="hljs-comment"># 超参数</span>
<span class="hljs-attr">input_size</span> = len(chars)
<span class="hljs-attr">hidden_size</span> = <span class="hljs-number">128</span>    <span class="hljs-comment"># 记忆容量</span>
<span class="hljs-attr">output_size</span> = len(chars)
<span class="hljs-attr">seq_length</span> = <span class="hljs-number">20</span>      <span class="hljs-comment"># 每次训练截取的序列长度</span>
<span class="hljs-attr">learning_rate</span> = <span class="hljs-number">0.005</span>

<span class="hljs-comment"># --- 2. 模型定义 (基于 LSTM) ---</span>
class CharLSTM(nn.Module):
    def __init__(self):
        super(CharLSTM, self).__init__()
        <span class="hljs-comment"># Embedding: 将字符索引转为向量</span>
        <span class="hljs-attr">self.embedding</span> = nn.Embedding(input_size, <span class="hljs-number">32</span>)
        <span class="hljs-comment"># LSTM: 核心循环层</span>
        <span class="hljs-attr">self.lstm</span> = nn.LSTM(<span class="hljs-number">32</span>, hidden_size, batch_first=<span class="hljs-literal">True</span>)
        <span class="hljs-comment"># Linear: 输出层，预测下一个字符的概率</span>
        <span class="hljs-attr">self.fc</span> = nn.Linear(hidden_size, output_size)
    
    def forward(self, x, hidden):
        <span class="hljs-attr">x</span> = self.embedding(x)
        out, <span class="hljs-attr">hidden</span> = self.lstm(x, hidden)
        <span class="hljs-comment"># 我们只关心序列最后一个时间步的输出</span>
        <span class="hljs-attr">out</span> = out[:, -<span class="hljs-number">1</span>, :]
        <span class="hljs-attr">out</span> = self.fc(out)
        return out, hidden

<span class="hljs-attr">model</span> = CharLSTM()
<span class="hljs-attr">criterion</span> = nn.CrossEntropyLoss()
<span class="hljs-attr">optimizer</span> = optim.Adam(model.parameters(), lr=learning_rate)

<span class="hljs-comment"># --- 3. 辅助函数：生成文本 ---</span>
def sample(model, <span class="hljs-attr">start_str</span>=<span class="hljs-string">"The"</span>, length=<span class="hljs-number">50</span>):
    model.eval()
    <span class="hljs-attr">hidden</span> = None
    <span class="hljs-attr">input_seq</span> = [char_to_int[c] for c in start_str]
    <span class="hljs-attr">input_tensor</span> = torch.tensor(input_seq, dtype=torch.long).unsqueeze(<span class="hljs-number">0</span>)
    
    <span class="hljs-attr">generated_text</span> = start_str
    
    with torch.no_grad():
        <span class="hljs-comment"># 先预热 hidden state</span>
        _, <span class="hljs-attr">hidden</span> = model.lstm(model.embedding(input_tensor[:, :-<span class="hljs-number">1</span>]), hidden)
        
        <span class="hljs-comment"># 开始逐字生成</span>
        <span class="hljs-attr">curr_input</span> = input_tensor[:, -<span class="hljs-number">1</span>:]
        for _ in range(length):
            out, <span class="hljs-attr">hidden</span> = model.lstm(model.embedding(curr_input), hidden)
            <span class="hljs-attr">out</span> = model.fc(out[:, -<span class="hljs-number">1</span>, :])
            
            <span class="hljs-comment"># 简单的贪婪采样 (取概率最大的)</span>
            _, <span class="hljs-attr">predicted_idx</span> = torch.max(out, <span class="hljs-number">1</span>)
            
            <span class="hljs-attr">next_char</span> = int_to_char[predicted_idx.item()]
            generated_text += next_char
            
            <span class="hljs-comment"># 更新输入</span>
            <span class="hljs-attr">curr_input</span> = torch.tensor([[predicted_idx.item()]], dtype=torch.long)
            
    return generated_text

<span class="hljs-comment"># --- 4. 训练循环 ---</span>
print(f"Training on {len(text)} characters. Vocabulary size: {len(chars)}")
<span class="hljs-attr">data_indices</span> = [char_to_int[c] for c in text]
<span class="hljs-attr">data_tensor</span> = torch.tensor(data_indices, dtype=torch.long)

for epoch in range(2001):
    <span class="hljs-comment"># 随机截取一段文本进行训练</span>
    <span class="hljs-attr">start_idx</span> = torch.randint(<span class="hljs-number">0</span>, len(text) - seq_length - <span class="hljs-number">1</span>, (<span class="hljs-number">1</span>,)).item()
    <span class="hljs-attr">end_idx</span> = start_idx + seq_length + <span class="hljs-number">1</span>
    
    <span class="hljs-comment"># 输入: hello, 目标: ello</span>
    <span class="hljs-attr">x_batch</span> = data_tensor[start_idx : end_idx-<span class="hljs-number">1</span>].unsqueeze(<span class="hljs-number">0</span>) <span class="hljs-comment"># [1, seq_len]</span>
    <span class="hljs-attr">y_batch</span> = data_tensor[start_idx+<span class="hljs-number">1</span> : end_idx]      <span class="hljs-comment"># [seq_len] (但在本简化demo中只预测最后一个字)</span>
    <span class="hljs-attr">y_target</span> = y_batch[-<span class="hljs-number">1</span>].unsqueeze(<span class="hljs-number">0</span>)               <span class="hljs-comment"># 只取最后一个字做目标，简化训练逻辑</span>
    
    optimizer.zero_grad()
    output, <span class="hljs-attr">_</span> = model(x_batch, None) <span class="hljs-comment"># Hidden 自动初始化</span>
    <span class="hljs-attr">loss</span> = criterion(output, y_target)
    loss.backward()
    optimizer.step()
    
    if epoch % <span class="hljs-attr">200</span> == <span class="hljs-number">0</span>:
        print(f"Epoch {epoch} | Loss: {loss.item():.4f}")
        print(f"Sample: {sample(model, <span class="hljs-attr">start_str</span>=<span class="hljs-string">'The'</span>, length=<span class="hljs-number">30</span>)}<span class="hljs-string">")
        print("</span>-<span class="hljs-string">" * 30)
</span></code></pre>
<h3 data-id="heading-9">运行结果预期</h3>
<p>刚开始模型会输出乱码。随着 Epoch 增加，你会看到 Loss 下降，生成的文本开始变得有意义（例如学会拼写 "deep", "learning" 等单词）。</p>
<h2 data-id="heading-10">结语</h2>
<p>虽然 LSTM 已经被 Transformer 取代，但 Karpathy 的这篇文章依然值得一读。它提醒我们：<strong>智能往往涌现于简单的结构与大规模数据的结合之中</strong>。这种“Unreasonable Effectiveness”（不可思议的有效性）正是深度学习最迷人的地方。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最大似然估计，香农熵，交叉熵与KL散度的详细解读与实现]]></title>    <link>https://juejin.cn/post/7586610067568689152</link>    <guid>https://juejin.cn/post/7586610067568689152</guid>    <pubDate>2025-12-23T07:45:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586610067568689152" data-draft-id="7586617459488243764" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最大似然估计，香农熵，交叉熵与KL散度的详细解读与实现"/> <meta itemprop="keywords" content="机器学习,人工智能"/> <meta itemprop="datePublished" content="2025-12-23T07:45:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Narrastory"/> <meta itemprop="url" content="https://juejin.cn/user/4355593566170010"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最大似然估计，香农熵，交叉熵与KL散度的详细解读与实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4355593566170010/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Narrastory
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:45:03.000Z" title="Tue Dec 23 2025 07:45:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">最大似然估计，香农熵，交叉熵与KL散度的详细解读与实现</h2>
<p><code>Ming | 2025.12</code></p>
<hr/>
<div align="center">
  <img align="center" src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25b5f8851b6b445ebfaf52c293d3de19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080702&amp;x-signature=yeBE9AXk%2F1vj3k8W9G6sxIheAYU%3D" alt="AI Generated Art" width="90%" loading="lazy"/>
</div>
<p>这篇文章将会依次讲解最大似然估计、香农熵、交叉熵与 KL 散度。它们之间逻辑紧密、层层递进，共同构成了现代机器学习与信息论中关于概率建模、信息度量与分布比较的核心基础。</p>
<h3 data-id="heading-1">1. 最大似然估计</h3>
<p>什么是最/极大似然估计？它是用来解决什么问题的？</p>
<p>我们暂时抛开严谨的数学定义，从一个简单的例子入手。</p>
<p>假设我们面对这样一个问题：
有一个神秘袋子，里面装有红、绿、蓝三种颜色的球，但我们不知道每种颜色的球所占的比例。我们仅知道颜色的概率分布具有以下结构（其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span> 是未知参数）：</p>

















<table><thead><tr><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：红</th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：绿</th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：蓝</th></tr></thead><tbody><tr><td>概率</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mfrac><mrow><mn>3</mn><mi>θ</mi></mrow><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">1- \frac{3\theta}{2} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>θ</mi><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{\theta}{2} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></td></tr></tbody></table>
<p>也就是说，抽到红球的概率是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span>，抽到蓝球的概率是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>θ</mi><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{\theta}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span>，抽到绿球的概率则是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mfrac><mrow><mn>3</mn><mi>θ</mi></mrow><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">1-\frac{3\theta}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span>。</p>
<p>现在我们唯一能做的，就是有放回地从袋中随机抽取若干次，观察颜色。除此之外，我们无法打开袋子查看内部情况。那么，如何根据有限的观测结果来估计参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span> 的值呢？</p>
<p>你可能会想到：只要抽取次数足够多，统计各颜色出现的频率，就能近似真实概率，从而推算出 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span>。这确实是不错的做法。但在实际问题中，我们往往只能获得有限的样本，甚至样本数很少；或者变量维度很高（比如有 1000 种颜色，未知数也不在是一个<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span>，而是非常多的未知变量），直接统计频率可能不稳定或不可行。这时，就需要借助<strong>最大似然估计</strong>这一强大的思想。</p>
<p>还是以上面的问题为例：</p>
<p>假设我们抽取了 6 次，得到颜色序列为：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>3</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{1},x_{2},x_{2},x_{3},x_{2},x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，记该观测事件为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span>。根据上述分布，事件 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 发生的概率（在给定 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span> 下）为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><mi>θ</mi><mo>⋅</mo><mo stretchy="false">(</mo><mfrac><mi>θ</mi><mn>2</mn></mfrac><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>⋅</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mfrac><mrow><mn>3</mn><mi>θ</mi></mrow><mn>2</mn></mfrac><msup><mo stretchy="false">)</mo><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">L(\theta ) = \theta \cdot (\frac{\theta}{2})^{2} \cdot (1-\frac{3\theta}{2} )^{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span></span></div>
<p>这里用到了独立事件的概率乘法公式：每次抽取相互独立，因此整个序列的概率等于各次抽取概率的乘积。</p>
<p>现在，关键的思想来了：<strong>这个观测结果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 是已经发生的既定事实。既然它发生了，我们就有理由认为，这个事件发生的概率应当是比较大的</strong>。既然如此，我们现在的任务就是找到一个<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span>，使得<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span>的值最大。这就是<strong>极大似然估计</strong>的核心直觉——寻找最能让观测数据“看起来合理”的参数。</p>
<p>在数学中，直接求<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L(\theta )</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span>的最小值可能不是很方便，因为它是多个概率的乘积，可能非常小，且容易导致数值下溢。为了便于计算与分析，我们通常对其取自然对数，得到<strong>对数似然函数</strong>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">ℓ</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>ln</mtext><mo stretchy="false">(</mo><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><mtext>ln</mtext><mi>θ</mi><mo>+</mo><mn>3</mn><mtext>ln</mtext><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mfrac><mrow><mn>3</mn><mi>θ</mi></mrow><mn>2</mn></mfrac><mo stretchy="false">)</mo><mo>+</mo><mn>2</mn><mtext>ln</mtext><mo stretchy="false">(</mo><mfrac><mi>θ</mi><mn>2</mn></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\ell(\theta) = \text{ln}(L(\theta)) = \text{ln}\theta + 3 \text{ln}(1-\frac{3\theta}{2}) + 2\text{ln}(\frac{\theta}{2})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">ℓ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">ln</span></span><span class="mopen">(</span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord text"><span class="mord">ln</span></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">3</span><span class="mord text"><span class="mord">ln</span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord">2</span><span class="mord text"><span class="mord">ln</span></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span></span></span></span></span></div>
<p>由于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ln</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\ln</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mop">ln</span></span></span></span></span> 是单调递增函数，最大化 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span> 等价于最大化 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">ℓ</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\ell(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">ℓ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span>。对数转换能将连乘转为求和，既简化求导运算，也提升数值稳定性。</p>
<p>现在我们把最大似然估计的概念放到机器学习语境中去，那么上面那个分布表，就是我们定义的模型，我们有放回的抽样获得的数据，就是训练集；<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L(\theta ) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span>就是损失函数，要求其极小值。用更加专业一点的说法就是：在机器学习中，我们经常将训练数据视为从某个真实分布中采样得到的观测。我们定义一个参数化模型 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_{\theta}(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>，希望用它来逼近真实分布。此时，似然函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span> 就度量了在该模型下观测到训练数据的“合理程度”。最大化似然函数等价于最小化负对数似然。而这正是许多监督学习模型（如逻辑回归、神经网络分类器）中使用的损失函数——交叉熵损失的理论来源。</p>
<h3 data-id="heading-2">2. 香农熵</h3>
<p>在探讨香农熵之前，我们首先需要理解什么是“信息量”。信息量直观来说，是一个事件发生时所携带的信息的多少。我们可以通过一个简单的例子来体会：小明是一名优等生，每次考试都能进入年级前几名。因此，下一次考试他再次进入年级前几名的概率非常高。假设他真的做到了，这个事件所包含的信息量其实很少，因为大家早已预料到这一结果——小明成绩优秀是常态。相反，如果小明下一次考试成绩大幅下滑，排名跌至年级下游，那么这个事件所包含的信息量就会非常大，会引发各种猜测与关注：小明是不是生病了？是不是最近遇到了什么困难？或是家庭出现了什么变故？这种“意外”所携带的信息，远远超过符合预期的结果。</p>
<p>从这一点我们可以总结：<strong>一个事件发生的概率越大，它所包含的信息量就越小</strong>；反之，概率越小，信息量就越大。换句话说，信息量与事件发生的概率成反比。</p>
<p>对于事件<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span>，其发生的概率为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>，则它的信息量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>p</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">I_{p}(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>计算方式如下</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>I</mi><mi>p</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mrow><mo stretchy="false">(</mo><mfrac><mn>1</mn><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac><mo stretchy="false">)</mo></mrow><mo>=</mo><mo>−</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">I_{p}(x) = \log_{2}{(\frac{1}{p(x)} )} = -\log_{2}{p(x)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.2574em;vertical-align:-0.936em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></span></div>
<p>为了更具体地理解这个公式，我们来看一个离散概率分布<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>的示例：</p>

















<table><thead><tr><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th></tr></thead><tbody><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></td><td>0.05</td><td>0.3</td><td>0.65</td></tr></tbody></table>
<p>根据公式计算每个事件的信息量就能得到</p>

















<table><thead><tr><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th></tr></thead><tbody><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>p</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">I_{p}(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></td><td>4.3219</td><td>1.7369</td><td>0.6214</td></tr></tbody></table>
<p>可以看出，概率极小的事件 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 信息量很大，而概率很大的事件 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 信息量则很小。这正是我们直觉的数学体现。</p>
<p>接下来，我们引入<strong>香农熵</strong>的概念。如果我们不仅关心单个事件的信息量，而是希望衡量整个概率分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span> 的“平均不确定性”或“平均信息量”，就需要计算信息量的期望值，即香农熵：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msub><mi>I</mi><mi>p</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H(P)= \sum_{i=1}^n P(x_{i})I_{p}(x_i) =-\sum_{i=1}^n P(x_{i})\log_2P(x_{i})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<p>香农熵描述的是：在概率分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span> 下，随机变量所携带的平均信息量。熵越大，表示分布的不确定性越高，平均信息量也越大；熵越小，则表示分布越集中，不确定性越低。</p>
<p>举个例子，如果某个分布中一个事件几乎必然发生（概率接近 1），那么熵会接近 0，因为几乎不需要额外信息来描述结果。相反，如果所有事件概率均等（如掷一枚均匀的骰子），熵就会达到最大值，因为每个结果都同样“意外”，描述结果所需的信息最多。</p>
<p>相信看了下面的代码你就会更加理解香农熵这个概念</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 三个不同的概率分布</span>
p_1 = np.array([<span class="hljs-number">0.01</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.98</span>,<span class="hljs-number">0.01</span>])
p_2 = np.array([<span class="hljs-number">0.25</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">0.25</span>,<span class="hljs-number">0.25</span>])
p_3 = np.array([<span class="hljs-number">0.3</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.1</span>,<span class="hljs-number">0.4</span>])

<span class="hljs-keyword">def</span> <span class="hljs-title function_">shannonEntropy</span>(<span class="hljs-params">p: np.ndarray</span>):	<span class="hljs-comment"># 计算香农熵的函数</span>
    <span class="hljs-keyword">return</span> -np.<span class="hljs-built_in">sum</span>(p * np.log2(p + <span class="hljs-number">1e-12</span>))    <span class="hljs-comment"># 加一个1e-12防止出现log(0)的情况</span>

<span class="hljs-built_in">print</span>(shannonEntropy(p_1))
<span class="hljs-built_in">print</span>(shannonEntropy(p_2))
<span class="hljs-built_in">print</span>(shannonEntropy(p_3))

<span class="hljs-comment"># 输出</span>
<span class="hljs-number">0.16144054253749263</span>
<span class="hljs-number">1.9999999999942293</span>
<span class="hljs-number">1.8464393446652445</span>
</code></pre>
<h3 data-id="heading-3">3. 交叉熵</h3>
<p>交叉熵在机器学习，尤其是分类任务中无处不在。简单来说，交叉熵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H(P,Q)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span></span></span></span></span>直接刻画了两个概率分布<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>之间的差异程度：<strong>两个分布越相似，交叉熵越小；两个分布差异越大，交叉熵越大</strong>。</p>
<p>交叉熵计算公式如下:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msub><mi>I</mi><mi>q</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H(P,Q)= \sum_{i=1}^n P(x_i)I_{q}(x_i) =-\sum_{i=1}^n P(x_i)\log_2Q(x_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<p>为了直观理解，来看两组例子。</p>
<p>假设在一个三分类任务中，某样本的真实标签分布和模型的预测分布如下：</p>























<table><thead><tr><th align="left">事件 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span></th><th align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (猫)</th><th align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (狗)</th><th align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (鸟)</th></tr></thead><tbody><tr><td align="left">真实分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_1(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></td><td align="left">0.00</td><td align="left">1.00</td><td align="left">0.00</td></tr><tr><td align="left">预测分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q_1(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></td><td align="left">0.05</td><td align="left">0.90</td><td align="left">0.05</td></tr></tbody></table>
<p>这里，真实分布表示样本是“狗”（概率为1）。模型的预测也高度集中在“狗”上，只是给其他类别分配了很小的概率。计算其交叉熵：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>H</mi><mo stretchy="false">(</mo><msub><mi>P</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>Q</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></munderover><msub><mi>P</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><mrow><mo fence="true">[</mo><msub><mi>P</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>+</mo><msub><mi>P</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>+</mo><msub><mi>P</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>3</mn></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>3</mn></msub><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><mrow><mo fence="true">[</mo><mn>0</mn><mo>×</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.05</mn><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn><mo>×</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.90</mn><mo stretchy="false">)</mo><mo>+</mo><mn>0</mn><mo>×</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.05</mn><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.90</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>≈</mo><mn>0.152</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
H(P_1, Q_1) &amp;= -\sum_{i=1}^{3} P_1(x_i) \log_2 Q_1(x_i) \\
&amp;= -\left[P_1(x_1) \log_2 Q_1(x_1) + P_1(x_2) \log_2 Q_1(x_2) + P_1(x_3) \log_2 Q_1(x_3)\right] \\
&amp;= -\left[0 \times \log_2(0.05) + 1 \times \log_2(0.90) + 0 \times \log_2(0.05)\right] \\
&amp;= -\log_2(0.90) \\
&amp;\approx 0.152
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:9.3788em;vertical-align:-4.4394em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.9394em;"><span style="top:-6.9394em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-4.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span><span style="top:-3.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span><span style="top:-1.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span><span style="top:-0.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.4394em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.9394em;"><span style="top:-6.9394em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8011em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-4.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span><span style="top:-3.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.05</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.90</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.05</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span><span style="top:-1.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.90</span><span class="mclose">)</span></span></span><span style="top:-0.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">0.152</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.4394em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>这个值非常小，说明两者高度相似。</p>
<p>现在考虑另一种情况，模型做出了完全错误的预测：</p>























<table><thead><tr><th align="left">事件 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span></th><th align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (猫)</th><th align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (狗)</th><th align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (鸟)</th></tr></thead><tbody><tr><td align="left">真实分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_2(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></td><td align="left">0.00</td><td align="left">1.00</td><td align="left">0.00</td></tr><tr><td align="left">预测分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q_2(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></td><td align="left">0.70</td><td align="left">0.15</td><td align="left">0.15</td></tr></tbody></table>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>H</mi><mo stretchy="false">(</mo><msub><mi>P</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>Q</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></munderover><msub><mi>P</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><mrow><mo fence="true">[</mo><msub><mi>P</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>+</mo><msub><mi>P</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>+</mo><msub><mi>P</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>3</mn></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>3</mn></msub><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><mrow><mo fence="true">[</mo><mn>0</mn><mo>×</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.70</mn><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn><mo>×</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.15</mn><mo stretchy="false">)</mo><mo>+</mo><mn>0</mn><mo>×</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.15</mn><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.15</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>≈</mo><mn>2.737</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
H(P_2, Q_2) &amp;= -\sum_{i=1}^{3} P_2(x_i) \log_2 Q_2(x_i) \\
&amp;= -\left[P_2(x_1) \log_2 Q_2(x_1) + P_2(x_2) \log_2 Q_2(x_2) + P_2(x_3) \log_2 Q_2(x_3)\right] \\
&amp;= -\left[0 \times \log_2(0.70) + 1 \times \log_2(0.15) + 0 \times \log_2(0.15)\right] \\
&amp;= -\log_2(0.15) \\
&amp;\approx 2.737
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:9.3788em;vertical-align:-4.4394em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.9394em;"><span style="top:-6.9394em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-4.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span><span style="top:-3.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span><span style="top:-1.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span><span style="top:-0.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.4394em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.9394em;"><span style="top:-6.9394em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8011em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-4.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span><span style="top:-3.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.70</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.15</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.15</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span><span style="top:-1.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.15</span><span class="mclose">)</span></span></span><span style="top:-0.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">2.737</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.4394em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>交叉熵值显著增大，清晰地反映了两个分布之间的巨大差异。</p>
<p>因此，交叉熵的本质是：<strong>以真实分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span> 为权重，对“用分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>  定义的信息量”求期望</strong>。它衡量的是，基于错误的估计 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span> ，描述真实事件 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>  所需要的平均比特数。</p>
<p>或者换个更直白的比喻：</p>
<blockquote>
<p>假设你要用英语（Q）向外国人（P）传达信息。</p>
<ul>
<li>如果你的英语很好（Q接近P），你不需要说很多话就能让对方理解</li>
<li>如果你的英语水平不高（Q远离P），你需要说很多废话、打很多手势才能沟通</li>
</ul>
<p>交叉熵衡量的是：用英语向外国人传达信息时，<strong>平均每句要多说多少废话</strong></p>
</blockquote>
<p>可以通过简单的代码来验证和感受交叉熵的计算：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-keyword">def</span> <span class="hljs-title function_">cross_entropy</span>(<span class="hljs-params">p: np.ndarray, q: np.ndarray</span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""
    计算离散概率分布 P 和 Q 之间的交叉熵 H(P, Q)。
    """</span>
    <span class="hljs-keyword">return</span> -np.<span class="hljs-built_in">sum</span>(p * np.log2(q + <span class="hljs-number">1e-12</span>))

<span class="hljs-comment"># 示例计算</span>
p = np.array([<span class="hljs-number">0.3</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.4</span>])
q = np.array([<span class="hljs-number">0.25</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">0.5</span>])
<span class="hljs-built_in">print</span>(cross_entropy(p, q))  <span class="hljs-comment"># 输出: 1.599...</span>
</code></pre>
<h3 data-id="heading-4">4. KL散度</h3>
<p>KL散度和交叉熵的功能相同，都是来衡量两个不同的概率分布之间的相似性的。同样的，<strong>两个分布越相似，KL散度值越小；两个分布差异越大，KL散度值越大</strong>。</p>
<p>你可能会问：既然交叉熵也可以衡量分布之间的差异，为什么还需要KL散度？要理解这一点，我们可以直接观察KL散度的计算公式：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>P</mi><mo>∥</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>=</mo><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>−</mo><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mfrac><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><mrow><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">D_{KL}(P \parallel Q)= H(P,Q)-H(P) =  \sum_{i=1}^{n}P(x_i)\log_{2}{\frac{P(x_i)}{Q(x_i)} }</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></span></div>
<p>你会惊奇的发现概率分布<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>的KL散度竟然只是其交叉熵减去<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>的香农熵这么简单！对，KL散度就是<strong>交叉熵与真实分布熵的差值</strong>。这意味着，KL散度在交叉熵的基础上，减去了真实分布自身的不确定性，从而更纯粹地反映了“近似分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span> 与真实分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span> 之间的差异”。换句话说，交叉熵同时包含了“真实分布的熵”与“两个分布之间的差异”，而KL散度则只提取了后者。</p>
<p>注意，从公式中还可以看出，KL散度具有以下重要数学性质：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>p</mi><mo>∥</mo><mi>q</mi><mo stretchy="false">)</mo><mo>≥</mo><mn>0</mn><mtext> 并且 </mtext><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>p</mi><mo>∥</mo><mi>q</mi><mo stretchy="false">)</mo><mo mathvariant="normal">≠</mo><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>q</mi><mo>∥</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{KL}(p \parallel q) \ge 0 \text{ 并且 }D_{KL}(p \parallel q) \ne D_{KL}(q \parallel p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0</span><span class="mord text"><span class="mord"> </span><span class="mord cjk_fallback">并且</span><span class="mord"> </span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"/></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span></span></div>
<p>任何两个概率分布的KL散度一定是大于等于0的，如果未来某一天你在计算KL散度的时候发现计算结果小于0，那你就要注意了，很可能意味着代码实现有误，或者概率值未正确归一化。另外，KL散度是不对称的，这一点仅从公式上就能看出来了，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>P</mi><mo>∥</mo><mi>Q</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{KL}(P \parallel Q)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span></span></span></span></span>表示目标分布是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>，它的值为预测分布<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>与目标<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>的差异，而<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>Q</mi><mo>∥</mo><mi>P</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{KL}(Q \parallel P)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span></span></span></span></span>则相反。</p>
<p>我们可以通过下面的这份代码来更加深入的理解交叉熵，KL散度之间的关系：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">kl_divergence</span>(<span class="hljs-params">p, q</span>):
    <span class="hljs-string">"""
    计算离散分布P和Q之间的KL散度 D_KL(P || Q)
    """</span>
    <span class="hljs-comment"># 添加一个小值避免log(0)</span>
    p = np.clip(p, <span class="hljs-number">1e-12</span>, <span class="hljs-number">1</span>)
    q = np.clip(q, <span class="hljs-number">1e-12</span>, <span class="hljs-number">1</span>)
    <span class="hljs-comment"># 归一化确保是概率分布</span>
    p = p / np.<span class="hljs-built_in">sum</span>(p)
    q = q / np.<span class="hljs-built_in">sum</span>(q)

    <span class="hljs-keyword">return</span> np.<span class="hljs-built_in">sum</span>(p * np.log(p / q))
</code></pre>
<pre><code class="hljs language-python" lang="python">p = np.array([<span class="hljs-number">0.02</span>, <span class="hljs-number">0.08</span>, <span class="hljs-number">0.9</span>])
q = np.array([<span class="hljs-number">0.1</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.8</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">"H(p) = "</span> + <span class="hljs-built_in">str</span>(shannonEntropy(p)))		<span class="hljs-comment">#计算p的香农熵</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"H(q) = "</span> + <span class="hljs-built_in">str</span>(shannonEntropy(q)))		<span class="hljs-comment">#计算q的香农熵</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"H(p,q) = "</span> + <span class="hljs-built_in">str</span>(cross_entropy(p, q)))	<span class="hljs-comment">#计算p与q之间的交叉熵</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"H(q,p) = "</span> + <span class="hljs-built_in">str</span>(cross_entropy(q, p)))	<span class="hljs-comment">#计算q与p之间的交叉熵</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"D_kl(p|q) = "</span> + <span class="hljs-built_in">str</span>(kl_divergence(p, q)))<span class="hljs-comment">#计算p与q之间的KL散度</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"D_kl(q|p) = "</span> + <span class="hljs-built_in">str</span>(kl_divergence(q, p)))<span class="hljs-comment">#计算q与p之间的KL散度</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 输出</span>
H(p) = <span class="hljs-number">0.5411884030736893</span>
H(q) = <span class="hljs-number">0.9219280948830342</span>
H(p,q) = <span class="hljs-number">0.6219280948842965</span>
H(q,p) = <span class="hljs-number">1.0503737127006858</span>
D_kl(p|q) = <span class="hljs-number">0.05596448973692631</span>
D_kl(q|p) = <span class="hljs-number">0.0890317178497243</span>
</code></pre>
<p>上面说到：交叉熵同时包含了“真实分布的熵”与“两个分布之间的差异”，而KL散度则只提取了后者。因此KL散度更能很好的体现出两个概率分布之间的差异性，KL散度要比交叉熵更加的“干净，纯粹”。</p>
<pre><code class="hljs language-python" lang="python">p = np.array([<span class="hljs-number">0.02</span>, <span class="hljs-number">0.08</span>, <span class="hljs-number">0.9</span>])
q = np.array([<span class="hljs-number">0.1</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.8</span>])
k = np.array([<span class="hljs-number">0.5</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.1</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">"H(p,q) = "</span> + <span class="hljs-built_in">str</span>(cross_entropy(p, q)))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"H(p,k) = "</span> + <span class="hljs-built_in">str</span>(cross_entropy(p, k)))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"D_kl(p|q) = "</span> + <span class="hljs-built_in">str</span>(kl_divergence(p, q)))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"D_kl(p|k) = "</span> + <span class="hljs-built_in">str</span>(kl_divergence(p, k)))
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 输出</span>
H(p,q) = <span class="hljs-number">0.6219280948842965</span>
H(p,k) = <span class="hljs-number">3.1154895329762846</span>
D_kl(p|q) = <span class="hljs-number">0.05596448973692631</span>
D_kl(p|k) = <span class="hljs-number">1.7843695701105056</span>	<span class="hljs-comment"># 可以看到KL散度明显比交叉熵要小很多，因为它只包含差异信息，不包含额外的目标概率分布的熵的信息</span>
</code></pre>
<p>既然这样，为什么在机器学习中经常使用交叉熵做损失函数，而很少听到KL散度呢？</p>
<p>其实在机器学习中，一直用的都是KL散度来做损失函数，只不过机器学习的训练数据的标签<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>是固定的，因此<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H(P)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span></span></span></span></span>是一个常数，根据公式</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>P</mi><mo>∥</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>=</mo><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>−</mo><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{KL}(P \parallel Q)= H(P,Q)-H(P)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span></span></span></span></span></div>
<p>要求<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>P</mi><mo>∥</mo><mi>Q</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{KL}(P \parallel Q)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span></span></span></span></span>的最小值，其实就是求<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H(P,Q)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span></span></span></span></span>的最小值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# Vue3 图片标注插件 AILabel]]></title>    <link>https://juejin.cn/post/7586615716907073536</link>    <guid>https://juejin.cn/post/7586615716907073536</guid>    <pubDate>2025-12-23T07:58:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586615716907073536" data-draft-id="7586610067568820224" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# Vue3 图片标注插件 AILabel"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:58:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叫我AddV"/> <meta itemprop="url" content="https://juejin.cn/user/4860749051150"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # Vue3 图片标注插件 AILabel
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4860749051150/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叫我AddV
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:58:40.000Z" title="Tue Dec 23 2025 07:58:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue3 图片标注插件 AILabel</h2>
<blockquote>
<p>近期在做一个图片标注的项目，就是展示一张图片，然后在图片上拖拖拽拽绘制一个一个的框框，然后把框框的位置数据保存起来。</p>
</blockquote>
<h3 data-id="heading-1">插件 AILabel</h3>
<p>NPM：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Failabel%3FactiveTab%3Dreadme" target="_blank" title="https://www.npmjs.com/package/ailabel?activeTab=readme" ref="nofollow noopener noreferrer">www.npmjs.com/package/ail…</a>
GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjlifeng%2Failabel" target="_blank" title="https://github.com/jlifeng/ailabel" ref="nofollow noopener noreferrer">github.com/jlifeng/ail…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ce4e65032a648a2b3f94f24018d3712~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081520&amp;x-signature=BptN%2FDjEmIcO5FggX0D6TSUbqCE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>但是有一个问题啊，就是这个 github 上面或者是 npm 上面的链接都是失效的了，文档都找不到，下面贴一个我弄到的文档，起码我发文的时候还是可以查看的，不知道后期还能不能保住！</p>
<p>文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fluchuanqi.github.io%2FAILabel%2Fdoc%2Fpreview%2F%231" target="_blank" title="https://luchuanqi.github.io/AILabel/doc/preview/#1" ref="nofollow noopener noreferrer">luchuanqi.github.io/AILabel/doc…</a></p>
<h3 data-id="heading-2">安装 AILabel 插件</h3>
<p>安装插件很简单哈，一行命令完事儿了。</p>
<pre><code class="hljs language-bash" lang="bash">npm i ailabel
</code></pre>
<p>静待安装完成就可以了。</p>
<h3 data-id="heading-3">使用（关键代码）</h3>
<p><code>AILabel</code> 使用类似于<code>openlayer</code>，也是那种一个一个的图层往上加，下面简单来个案例哈！</p>
<h4 data-id="heading-4">1. 获取图片，获取原始图片的宽高</h4>
<p>比如我有一张图片，我需要获取这个图片的<code>宽高</code>是多少，因为我必须于原始图片大小一样，不然的话我标注出来的位置就是不准的，因此需要先获取原始图片宽高。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> url = <span class="hljs-title function_">ref</span>(<span class="hljs-string">"http://192.168.78.17:5173/static/images/1.jpg"</span>)  <span class="hljs-comment">// 图片地址</span>

<span class="hljs-comment">// 加载图片 获取图片宽高</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadImage</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>()
  img.<span class="hljs-property">src</span> = url.<span class="hljs-property">value</span>
  img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
    imageWidth.<span class="hljs-property">value</span> = img.<span class="hljs-property">width</span>  <span class="hljs-comment">// 图片宽度</span>
    imageHeight.<span class="hljs-property">value</span> = img.<span class="hljs-property">height</span>   <span class="hljs-comment">// 图片高度</span>
  }
}
</code></pre>
<h4 data-id="heading-5">2. 初始化 AILabel</h4>
<p>初始化标注就是使用 AILabel，然后把图片作为图层中添加到 AILabel 中，同时需要在 AILabel 中添加一个标注图层。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 初始化标注</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">initAnno</span> = (<span class="hljs-params"/>) =&gt; {
  gMap.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-title class_">Map</span>(<span class="hljs-string">'ed-video-mask'</span>, {
    <span class="hljs-attr">center</span>: { <span class="hljs-attr">x</span>: imageWidth.<span class="hljs-property">value</span> / <span class="hljs-number">2</span>, <span class="hljs-attr">y</span>: imageHeight.<span class="hljs-property">value</span> / <span class="hljs-number">2</span> },  <span class="hljs-comment">// 设置一下中心点位置</span>
    <span class="hljs-attr">zoom</span>: imageWidth.<span class="hljs-property">value</span>,  <span class="hljs-comment">// zoom下面单独说，很重要</span>
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'PAN'</span>,   <span class="hljs-comment">// 设置类型为平移（可以设置绘制矩形、多边形、圆形等等，默认拖拽就行了）</span>
    <span class="hljs-attr">refreshDelayWhenZooming</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 这些在文档里面看就行</span>
    <span class="hljs-attr">zoomWhenDrawing</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">panWhenDrawing</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">withHotKeys</span>: <span class="hljs-literal">false</span>
  })

  <span class="hljs-comment">// 图片图层 （用于展示图片）</span>
  gImageLayer.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Layer</span>.<span class="hljs-title class_">Image</span>(<span class="hljs-string">'image-layer'</span>, {
    <span class="hljs-attr">src</span>: url.<span class="hljs-property">value</span>,  <span class="hljs-comment">// 图片地址url （比如：https://xxx.com/1.png）</span>
    <span class="hljs-attr">width</span>: imageWidth.<span class="hljs-property">value</span>,  <span class="hljs-comment">// 图片实际宽度</span>
    <span class="hljs-attr">height</span>: imageHeight.<span class="hljs-property">value</span>,   <span class="hljs-comment">// 图片实际高度</span>
    <span class="hljs-attr">crossOrigin</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">position</span>: { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> }  <span class="hljs-comment">// 初始位置</span>
  },
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'图片图层'</span> },
    { <span class="hljs-attr">zIndex</span>: <span class="hljs-number">1</span> })

  gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">addLayer</span>(gImageLayer.<span class="hljs-property">value</span>)  <span class="hljs-comment">// 图片图层添加到 AILabel</span>

  <span class="hljs-comment">// 标注图层 （绘制的框框在这个图层上）</span>
  gFeatureLayer.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Layer</span>.<span class="hljs-title class_">Feature</span>(
    <span class="hljs-string">'feature-layer'</span>,
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'标注图层'</span> },
    { <span class="hljs-attr">zIndex</span>: <span class="hljs-number">2</span> }
  )
  gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">addLayer</span>(gFeatureLayer.<span class="hljs-property">value</span>)   <span class="hljs-comment">// 标注图层添加到 AILabel</span>
}
</code></pre>
<p>这样就可以了。</p>
<p>那个 zoom 是啥意思哈，很重要，比如我的图片原始分辨率尺寸是 <code>3000 * 2000</code>，但是我们标注给的可是区域不一定这么大啊，也许只有1000* 500，那么我们直接标注的话可能就有问题，标注出来的框框位置可能和实际照片的位置不匹配，这个zoom就是来解决这个问题的。</p>
<p>这个 <code>zoom 就是图片宽度的实际大小</code>。</p>
<p>比如，我的标注可视区域可能只有1000px，但是图片实际宽度是3000px，图片为了在可视区域放得下，会自动把图片缩小，让图片可以在可视区域完整得放下。这时候其实图片是被缩小的，但是我们标注出来的位置和大小就和原尺寸的对应不上了，这时候我们设置 <code>zoom 为 3000</code>，那么就对应上了，所以，<code>zoom 设置为原始图片宽度就可以</code>！切记切记！不然标注出来的位置是错的！！！</p>
<h4 data-id="heading-6">3. 修改 AILabel 的模式</h4>
<p>上面默认设置了 <code>PAN</code>，就是平移，这个时候是可以拖拽图片位置，滚轮实现图片缩放的。</p>
<p>当需要鼠标拖拽绘制的时候，需要改为其他的模式，修改方式为：</p>
<pre><code class="hljs language-javascript" lang="javascript">gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">setMode</span>(mode)
</code></pre>
<p>其中 mode 的值可以是：<code>RECT</code>、<code>CIRCLE</code>、<code>POLYGON</code>、<code>POINT</code>、<code>LINE</code>。</p>

































<table><thead><tr><th>值</th><th>含义</th></tr></thead><tbody><tr><td>RECT</td><td>矩形</td></tr><tr><td>CIRCLE</td><td>圆形</td></tr><tr><td>POLYGON</td><td>多边形</td></tr><tr><td>POINT</td><td>点</td></tr><tr><td>LINE</td><td>线段</td></tr><tr><td>PAN</td><td>平移</td></tr></tbody></table>
<h4 data-id="heading-7">4. 设置拖拽样式</h4>
<p>在我们设置了 <code>gMap.value.setMode('RECT')</code>  绘制矩形的时候，我们按下鼠标左键拖拽的时候会有一个默认样式，当然这是可以设置的，设置起来很简单：</p>
<pre><code class="hljs language-javascript" lang="javascript">gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">setDrawingStyle</span>({
	<span class="hljs-attr">strokeStyle</span>: <span class="hljs-string">'#409EFF'</span>,  <span class="hljs-comment">// 设置边框颜色</span>
  <span class="hljs-attr">lineWidth</span>: <span class="hljs-number">2</span>,   <span class="hljs-comment">// 设置边框宽度</span>
  <span class="hljs-attr">fillStyle</span>: <span class="hljs-string">'#409EFF44'</span>,   <span class="hljs-comment">// 设置填充颜色</span>
  <span class="hljs-attr">fill</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 启用填充</span>
  <span class="hljs-attr">stroke</span>: <span class="hljs-literal">true</span>   <span class="hljs-comment">// 启用边框</span>
})
</code></pre>
<h4 data-id="heading-8">5. 事件</h4>
<p>事件是啥呢，比如，我绘制完会走哪个函数，选中会走那个函数，修改之后会走哪个函数等等。</p>
<p>我们可以写一个函数绑定这些事件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 绑定事件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">bindEvents</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 绘制完成回调监听</span>
  gMap.<span class="hljs-property">value</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'drawDone'</span>, <span class="hljs-function">(<span class="hljs-params">type, data</span>) =&gt;</span> {
    <span class="hljs-title function_">createAnnotation</span>(type, data)  <span class="hljs-comment">// 走了一个函数</span>
  })
  <span class="hljs-comment">// 要素选中回调监听(非PAN模式下双击选中)</span>
  gMap.<span class="hljs-property">value</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'featureSelected'</span>, <span class="hljs-function">(<span class="hljs-params">feature</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (feature) { gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">setActiveFeature</span>(feature) }
  })
  <span class="hljs-comment">// 要素取消选中回调监听(选中后点击其他位置取消选中)</span>
  gMap.<span class="hljs-property">value</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'featureUnselected'</span>, <span class="hljs-function">() =&gt;</span> {
    gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">setActiveFeature</span>(<span class="hljs-literal">null</span>)
  })
  <span class="hljs-comment">// 要素更新回调监听(选中后编辑完成回调)</span>
  gMap.<span class="hljs-property">value</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'featureUpdated'</span>, <span class="hljs-function">(<span class="hljs-params">feature, shape</span>) =&gt;</span> {
    feature.<span class="hljs-title function_">updateShape</span>(shape)
  })
}
</code></pre>
<p>我们开启绘制之后，绘制完一松手发现框框没了，因为我们没有绘制上去，所以我们在绘制完成之后的回调里面，获得了绘制的数据，然后把这个数据自己手写一个框框放到图层上面去：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加要素</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createAnnotation</span> = (<span class="hljs-params">type, shape</span>) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-string">`<span class="hljs-subst">${type}</span>_<span class="hljs-subst">${uuid4()}</span>`</span>  <span class="hljs-comment">// 随机ID</span>
  <span class="hljs-keyword">let</span> feature = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">let</span> style = {
    <span class="hljs-attr">strokeStyle</span>: <span class="hljs-string">'#409EFF'</span>,  <span class="hljs-comment">// 设置边框颜色</span>
 		<span class="hljs-attr">lineWidth</span>: <span class="hljs-number">2</span>,   <span class="hljs-comment">// 设置边框宽度</span>
    <span class="hljs-attr">fillStyle</span>: <span class="hljs-string">'#409EFF44'</span>,   <span class="hljs-comment">// 设置填充颜色</span>
    <span class="hljs-attr">fill</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 启用填充</span>
    <span class="hljs-attr">stroke</span>: <span class="hljs-literal">true</span>   <span class="hljs-comment">// 启用边框</span>
  }
  <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'RECT'</span>) {   <span class="hljs-comment">// 绘制矩形</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Rect</span>(id, shape, <span class="hljs-literal">null</span>, style)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'CIRCLE'</span>) {  <span class="hljs-comment">// 绘制圆形</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Circle</span>(id, shape, <span class="hljs-literal">null</span>, style)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'POLYGON'</span>) {  <span class="hljs-comment">// 绘制多边形</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Polygon</span>(id, { <span class="hljs-attr">points</span>: shape }, <span class="hljs-literal">null</span>, style)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'POINT'</span>) {  <span class="hljs-comment">// 绘制点</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Point</span>(id, shape, <span class="hljs-literal">null</span>, style)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'LINE'</span>) {   <span class="hljs-comment">// 绘制线</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Line</span>(id, shape, <span class="hljs-literal">null</span>, style)
  }
  gFeatureLayer.<span class="hljs-property">value</span>.<span class="hljs-title function_">addFeature</span>(feature)
  <span class="hljs-keyword">return</span> feature;
}
</code></pre>
<p>然后就可以了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acd4b27437f4493e8fb6f0711774ae71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081520&amp;x-signature=KWeIW3cwZWib8UY%2BfcG%2BwOdXgHA%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 编码技巧篇（内部分享）]]></title>    <link>https://juejin.cn/post/7586663700901019657</link>    <guid>https://juejin.cn/post/7586663700901019657</guid>    <pubDate>2025-12-23T07:56:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586663700901019657" data-draft-id="7586663700900773897" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 编码技巧篇（内部分享）"/> <meta itemprop="keywords" content="AI编程,前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-23T07:56:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="俊劫"/> <meta itemprop="url" content="https://juejin.cn/user/3386151545609837"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 编码技巧篇（内部分享）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3386151545609837/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    俊劫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:56:58.000Z" title="Tue Dec 23 2025 07:56:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>演讲 PPT 也是 AI 生成的</p>
<p>还有个manus在线版：<a href="https://link.juejin.cn?target=https%3A%2F%2Faicoding-ee5dej8g.manus.space" target="_blank" title="https://aicoding-ee5dej8g.manus.space" ref="nofollow noopener noreferrer">aicoding-ee5dej8g.manus.space</a></p>
<p>很久没发文章了，不知道还有没有人看</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba98db3f9025414c9521306aba33c49c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-K5Yqr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081418&amp;x-signature=XRtA4WVAj2XV0qmPtXqgnAoI9WQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0898c41397ac4596aa68a2faa4d40254~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-K5Yqr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081418&amp;x-signature=GDELGVwDbHb2sq48mZsVLuLPq6o%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">1. AI发展</h2>
<p>AI 人工智能（artificial intelligence）</p>
<h3 data-id="heading-1">1.1. Transformer 架构</h3>
<pre><code class="hljs language-text" lang="text">输入: "LLM是什么"
    ↓
[Tokenization] → 切分成词元: ["LLM", "是", "什么"]
    ↓
[Embedding] → 转换为数字向量
    ↓
[Self-Attention] → 理解词与词之间的关系（关键！）
    ↓
[前馈网络] → 多层处理
    ↓
[输出层] → 预测下一个词的概率分布
    ↓
输出: "LLM是大语言模型..."

</code></pre>
<h3 data-id="heading-2">1.2. 5 大阶段</h3>
<p>L1：聊天机器人，具有对话能力的AI，ChatGPT。</p>
<p>L2：推理者，像人类一样能够解决问题的AI，深度思考，DeepSeek。</p>
<p>L3：智能体，不仅能思考，还可以采取行动的AI系统，Agent。</p>
<p>L4：创新者，能够协助发明创造的AI。 AI医药发明</p>
<p>L5：组织者，可以完成组织工作的AI。钢铁侠贾维斯</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b19a6298c82a4e6bafb665dbf3e244e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-K5Yqr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081418&amp;x-signature=p1Ol1DPEC46q6XYPopP2H2L45Kg%3D" alt="" loading="lazy"/></p>
<p>对于我们开发者来说，目前主要接触的是 L1-L3 阶段。L1 就是日常问答，L2 是代码推理和debug，L3 就是 Cursor Agent、Warp Agent 这类能直接改代码跑命令的工具。</p>
<h2 data-id="heading-3">2. Prompt</h2>
<h3 data-id="heading-4">2.1. 需不需要学习？</h3>
<blockquote>
<p>AI 提示词需要学习吗？总是说AI prompt很重要，然后要教学怎么写，我用ai的话，我直接问你需要哪些信息不就行了，为什么要专门去学这些，而且效果还不一定好</p>
</blockquote>
<p><strong>直接问 vs 主动学习的区别</strong></p>
<blockquote>
<p>1、被动 vs 主动的效率差异</p>
</blockquote>
<blockquote>
<p>◦ 你每次都需要我来引导你补充信息，这增加了交互轮次</p>
</blockquote>
<blockquote>
<p>◦ 如果你懂基本原理，可以一次把关键信息都给我，减少往返</p>
</blockquote>
<blockquote>
<p>2、质量差异</p>
</blockquote>
<blockquote>
<p>◦ 一个好 prompt 能让我理解你的真实需求，而不是表面需求</p>
</blockquote>
<blockquote>
<p>◦ 比如你说"帮我优化代码"，我可能问半天——但如果你说"我的 API 响应时间 800ms，希望降到 200ms，瓶颈在数据库查询"，我直接能给出有针对性的方案</p>
</blockquote>
<blockquote>
<p>3、你能做 AI 做不了的</p>
</blockquote>
<blockquote>
<p>◦ AI 可以回答问题，但只有你知道你真正的约束条件（时间、成本、技术栈限制等）</p>
</blockquote>
<blockquote>
<p>◦ 如果你能清楚地表达这些，结果会好得多</p>
</blockquote>
<h3 data-id="heading-5">2.2. 套路实践</h3>
<ul>
<li>
<p>我是谁，什么身份</p>
</li>
<li>
<p>我要做什么，现状是什么</p>
</li>
<li>
<p>我问题的相关上下文有哪些</p>
</li>
<li>
<p>我希望能做到什么效果</p>
</li>
<li>
<p>需求确认</p>
</li>
</ul>
<p>eg：</p>
<p>我是一名前端开发，我现在要通过图片生成前端页面，现在只有一个模板页面。我的需求都写在当前目录的 prd.md中，我希望你能尽可能高的还原我的需求+图片设计。</p>
<p>评估下还有什么需要我补充的信息吗？如果没有，请直接开始</p>
<pre><code class="hljs language-line" lang="line">prd.md

结合现有系统的规范和当前目录下的图片，实现如下需求

通用要求：
- UI 不用按照图片的，参考departureTask/index.tsx的实现
- 规范参考当前子应用的apps/stationSystem/CLAUDE.md
- 接口先本地 mock，后续和后端进行接口联调
- 不需要写项目说明，直接实现即可

评估下还有什么需要我补充的信息吗？如果没有，请直接开始

[列表页]
- 使用系统组件：GeneralPage，导出、新建按钮等

[删除]
- 需要二次确认弹窗

</code></pre>
<h4 data-id="heading-6">2.2.1. 我是谁</h4>
<blockquote>
<p>我是一名前端开发，我是一名资深前端开发，我是一名前端架构师</p>
</blockquote>
<p><strong>举个例子</strong></p>
<pre><code class="hljs language-line" lang="line">任务：实现一个用户列表

•  "前端开发" → 我给你一个完整的组件 + 详细注释
•  "资深前端开发" → 我给你代码 + 简单说明，假设你知道怎么集成
•  "前端架构师" → 我会先问你：
	◦  这个列表未来会复用吗？
	◦  数据层怎么设计？
	◦  要不要做虚拟滚动？
	◦  然后给你一个分层清晰的方案


</code></pre>
<h4 data-id="heading-7">2.2.2. 我要做什么</h4>
<p>我现在要通过图片生成前端页面，现在只有一个模板页面。我的需求都写在当前目录的 prd.md中，我希望你能尽可能高的还原我的需求+图片设计。</p>
<p>优化后</p>
<blockquote>
<p>我现在要根据设计图（./design.png）和需求文档（./prd.md）生成前端页面，实现模板参考（./departureTask/index.tsx）。我希望你能尽可能高的还原需求</p>
</blockquote>
<h4 data-id="heading-8">2.2.3. 需求确认</h4>
<blockquote>
<p>评估下还有什么需要我补充的信息吗？如果没有，请直接开始</p>
</blockquote>
<p><strong>优化后</strong></p>
<blockquote>
<p>版本 1：平衡型（推荐）</p>
</blockquote>
<blockquote>
<blockquote>
<p>有缺少的关键信息吗？如果有请直接问，如果没有就开始吧。</p>
</blockquote>
</blockquote>
<blockquote>
<p>• 更简洁</p>
</blockquote>
<blockquote>
<p>• "关键"二字暗示：别问可有可无的细节</p>
</blockquote>
<blockquote>
<p>• 语气更直接</p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
<p>版本 2：强制检查型</p>
</blockquote>
<blockquote>
<blockquote>
<p>开始前确认：有什么信息缺失会影响实现？</p>
</blockquote>
</blockquote>
<blockquote>
<p>• 强迫 AI 思考"会影响实现"的信息，威胁 AI，说一些严重的后果</p>
</blockquote>
<blockquote>
<p>• 适合复杂任务</p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
<p>版本 3：极简型</p>
</blockquote>
<blockquote>
<blockquote>
<p>开始前确认：有什么信息缺失会影响实现？</p>
</blockquote>
</blockquote>
<blockquote>
<p>• 最干脆，适合你已经很清楚自己提供的信息够不够的时候</p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
<p>版本 4：去掉小尾巴</p>
</blockquote>
<blockquote>
<p>直接不加，让 AI 自己判断问还是做</p>
</blockquote>
<blockquote>
<p>• 如果你的 prompt 已经很完整，AI 会直接开始</p>
</blockquote>
<blockquote>
<p>• 如果真的缺信息，AI 自然会问</p>
</blockquote>
<blockquote>
<p>• 风险：可能多一轮对话</p>
</blockquote>
<h2 data-id="heading-9">3. Cost</h2>
<p>用AI写代码最肉疼的就是token消耗，尤其是用 Claude 这类贵的模型。分享几个省钱的套路：</p>
<h4 data-id="heading-10">3.1. 分层策略</h4>
<p>别什么问题都用最贵的模型。我的习惯是：</p>
<ul>
<li>
<p><strong>简单问答、格式转换、写注释</strong>：用便宜的模型，DeepSeek、GPT-4o-mini、Claude Haiku 都行，各种 IDE 都有 Auto 模式</p>
</li>
<li>
<p><strong>复杂逻辑、架构设计、疑难debug</strong>：Claude Sonnet 4.5、Gemini 3 Pro</p>
</li>
<li>
<p><strong>特别复杂的问题</strong>：Claude Opus 4.5、Gpt 5.2、Gemini 3 Pro （thinking）</p>
</li>
</ul>
<h4 data-id="heading-11">3.2. 减少上下文</h4>
<p>上下文越长，消耗越大。几个技巧：</p>
<ul>
<li>
<p>新开会话处理新问题，别在一个对话里聊八百件事</p>
</li>
<li>
<p>只贴相关代码，别把整个文件扔进去</p>
</li>
<li>
<p>用 <code>@</code> 符号精确引用文件（Cursor里），而不是手动复制粘贴</p>
</li>
<li>
<p>定期总结对话，让AI记住关键点后清理历史</p>
</li>
<li>
<p>多次提交代码，避免幻觉混乱返工</p>
</li>
</ul>
<h4 data-id="heading-12">3.3. 多种 IDE 结合</h4>
<ul>
<li>
<p>warp 目前用户较少，激活器模式无限 Token</p>
</li>
<li>
<p>国际：Cursor、Windsurf、Antigravity、Kiro</p>
</li>
<li>
<p>国内：Trae、Qoder</p>
</li>
</ul>
<h2 data-id="heading-13">4. 模型</h2>
<h3 data-id="heading-14">4.1. 代码场景推荐</h3>
<h4 data-id="heading-15">4.1.1. 国际模型</h4>



































<table><thead><tr><th>场景</th><th>推荐模型</th><th>原因</th></tr></thead><tbody><tr><td>高精度代码生成 / 疑难杂症</td><td>Opus 4.5</td><td>在 SWE-Bench 等代码基准上表现顶尖</td></tr><tr><td>分析大量设计文档 + 代码 + 图像原型</td><td>Gemini 3 Pro</td><td>超大上下文 + 多模态</td></tr><tr><td>持续 agent 工作流 / 长任务</td><td>Sonnet 4.5</td><td>连贯性、稳定推理</td></tr><tr><td>万能通用助手 / 成本敏感</td><td>GPT-5.x</td><td>性能与价格最优均衡</td></tr><tr><td>简单客服 / FAQ / 内容生成</td><td>较小模型足够</td><td>不需要用旗舰</td></tr></tbody></table>
<h4 data-id="heading-16">4.1.2. 国内模型</h4>
<ul>
<li>
<p><strong>DeepSeek</strong>：性价比之王，API价格是 OpenAI 的几十分之一，代码能力在线</p>
</li>
<li>
<p><strong>通义千问(Qwen)</strong>：阿里出的，开源模型质量高，可以本地跑</p>
</li>
<li>
<p><strong>Kimi</strong>：长上下文做得好，适合分析长文档</p>
</li>
<li>
<p><strong>豆包</strong>：便宜，日常够用</p>
</li>
</ul>
<h4 data-id="heading-17">4.1.3. 结论</h4>
<blockquote>
<p>D 档走天下，Auto 超省心</p>
</blockquote>
<ul>
<li>
<p>别迷信benchmark，实际用起来差别没那么大</p>
</li>
<li>
<p>不同模型有不同的"性格"，Claude 比较谨慎，GPT 比较敢写</p>
</li>
<li>
<p>复杂项目建议固定一个模型，它会更好地理解你的代码风格</p>
</li>
<li>
<p>遇到某个模型死活搞不定的问题，换一个模型试试 or 换一种 prompt，不要在幻觉中找方案</p>
</li>
</ul>
<h2 data-id="heading-18">5. 项目开发技巧</h2>
<h4 data-id="heading-19">5.1. 给AI建立项目上下文</h4>
<p>在项目根目录创建 <code>CLAUDE.md</code> 或 <code>README.md</code>或 <code>.cursorrules</code></p>
<pre><code class="hljs language-line" lang="line"># 项目规范

## 技术栈
- React 18 + TypeScript
- Ant Design 5.x

## 代码规范
- 组件用函数式，不用 class
- 样式用 CSS Modules
- 接口类型定义放 types/ 目录

## 项目结构
- src/components 通用组件
- src/pages 页面
- src/services API 调用


</code></pre>
<p>有了这个文件，AI 生成的代码会更符合项目规范，省得每次都要说一遍。</p>
<h4 data-id="heading-20">5.2. 增量开发而不是一次性生成</h4>
<p>别想着一句话让AI把整个功能写完。更好的方式：</p>
<ol>
<li>
<p>先让AI写个骨架/伪代码</p>
</li>
<li>
<p>review一下思路对不对</p>
</li>
<li>
<p>逐步填充具体实现</p>
</li>
<li>
<p>每一步都跑一下看看有没有问题</p>
</li>
</ol>
<p>这样出问题容易定位，也不容易跑偏。</p>
<h4 data-id="heading-21">5.3. 善用报错信息</h4>
<p>遇到报错，直接把完整的错误信息贴给AI，比你自己描述"它报错了"有用100倍。包括：</p>
<ul>
<li>完整的 error stack</li>
<li>相关的代码片段</li>
<li>你做了什么操作触发的</li>
</ul>
<h4 data-id="heading-22">5.4. Code Review 让AI来</h4>
<p>写完代码可以让AI帮忙 review：</p>
<pre><code class="hljs language-line" lang="line">帮我review一下这段代码，重点看：
1. 有没有潜在的bug
2. 性能有没有问题
3. 有没有更简洁的写法
4. 可维护性怎么样
5. 和其他模块通用部分抽离了没等等

</code></pre>
<h4 data-id="heading-23">5.5. 调试</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2a1f3952e064751b8a39d0a80b3fa87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-K5Yqr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081418&amp;x-signature=wE6BtP4RE1n3z%2BE%2BiFd7YKogjY0%3D" alt="" loading="lazy"/></p>
<p>与其问"为什么不工作"，不如：</p>
<ul>
<li>
<p>描述期望的行为</p>
</li>
<li>
<p>描述实际的行为</p>
</li>
<li>
<p>贴上相关代码和报错</p>
</li>
</ul>
<pre><code class="hljs language-line" lang="line">期望：点击按钮后弹窗关闭
实际：弹窗没有关闭，控制台没有报错
代码：[贴代码]
我已经确认 handleClose 函数被调用了（加了console.log）

</code></pre>
<h2 data-id="heading-24">6. 各种 好玩的AI</h2>
<ul>
<li>
<p>comfyUI - 图像生成工作流，比直接用 SD 灵活</p>
</li>
<li>
<p>nano banana pro - 基于 Gemini 3 Pro 的图像生成</p>
</li>
<li>
<p>AI 医药</p>
</li>
<li>
<p>AI 显卡</p>
</li>
<li>
<p>AI 储能</p>
<ul>
<li>核能</li>
<li>AI 数据中心送上天，太阳能</li>
</ul>
</li>
<li>
<p>AI 自动驾驶</p>
</li>
<li>
<p>Manus现状</p>
<ul>
<li>2025年3月，Manus一码难求；2025年7月，Manus在中国归于沉寂</li>
</ul>
</li>
<li>
<p>豆包手机</p>
<ul>
<li>首发搭载于努比亚M153工程样机,售价3499元</li>
<li>微信封杀</li>
<li>罗永浩力挺</li>
</ul>
</li>
<li>
<p>AotuGLM</p>
<ul>
<li>开源，可以自己部署一个全自动化手机</li>
</ul>
</li>
<li>
<p>AI 电影</p>
<ul>
<li>升级</li>
<li>黑客帝国（1～3）</li>
<li>我，机器人</li>
<li>攻壳机动队</li>
</ul>
</li>
<li>
<p>本地大模型 / 推理框架（离线、隐私、可控）</p>
<ul>
<li>Ollama - 一键拉取 + 本地运行模型</li>
<li>LM Studio - 本地模型 GUI + OpenAI 兼容接口</li>
<li>llama.cpp - 量化部署（CPU/GPU 都能跑）</li>
<li>vLLM - 高吞吐推理服务（适合自建 API）</li>
</ul>
</li>
<li>
<p>RAG / 知识库（让 AI “查资料再回答”）</p>
<ul>
<li>LangChain / LlamaIndex - 快速搭建检索增强应用</li>
<li>向量数据库：Milvus / Qdrant / Weaviate</li>
<li>Reranker：bge-reranker 等（提升检索排序质量）</li>
</ul>
</li>
<li>
<p>Agent / 自动化（让 AI 真的去做事）</p>
<ul>
<li>OpenHands / Aider - 让 AI 在仓库里改代码、跑命令、修 bug</li>
<li>Playwright + LLM - 自动化浏览器回归测试、抓取、脚本任务</li>
<li>Atlas 浏览器</li>
</ul>
</li>
<li>
<p>视频 / 音频（内容生产力工具链）</p>
<ul>
<li>视频生成：Runway / Pika / Luma / 可灵（Kling）</li>
<li>语音转文字：Whisper / FunASR</li>
<li>语音合成：TTS 工具（配合播客、旁白、客服）</li>
</ul>
</li>
<li>
<p>Claude SKILLS</p>
</li>
<li>
<p>Vibe Coding</p>
</li>
<li>
<p>Gemini Opal gems</p>
</li>
<li>
<p>Trae Solo Dev</p>
</li>
<li>
<p>Qoder Quest</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-25">7. 最后</h2>
<p>工具再好也只是工具。AI 能帮你提效，但不能替你思考架构、理解业务。最值得投入的还是自己的基本功：对语言特性的理解、对设计模式的掌握、对业务的熟悉程度。</p>
<p>AI 是放大器，你本身的能力决定了放大后的上限。</p>
<blockquote>
<p>有问题欢迎交流</p>
<p>爱你的俊劫</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux进程排查实战：strace和lsof救命指南]]></title>    <link>https://juejin.cn/post/7586615716906418176</link>    <guid>https://juejin.cn/post/7586615716906418176</guid>    <pubDate>2025-12-23T06:01:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586615716906418176" data-draft-id="7586615716906385408" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux进程排查实战：strace和lsof救命指南"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2025-12-23T06:01:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="嘻哈baby"/> <meta itemprop="url" content="https://juejin.cn/user/485305583405066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux进程排查实战：strace和lsof救命指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/485305583405066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    嘻哈baby
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:01:07.000Z" title="Tue Dec 23 2025 06:01:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>服务起不来，日志没报错。进程在跑，但就是不干活。</p>
<p>这种问题最恶心，看日志看不出问题，看监控也没异常。</p>
<p>这时候就需要strace和lsof这两个神器了。</p>
<h2 data-id="heading-0">strace：跟踪系统调用</h2>
<p>strace能看到进程在做什么系统调用，相当于给进程装了个监控摄像头。</p>
<h3 data-id="heading-1">基本用法</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 跟踪一个命令</span>
strace <span class="hljs-built_in">ls</span>

<span class="hljs-comment"># 跟踪正在运行的进程</span>
strace -p &lt;pid&gt;

<span class="hljs-comment"># 跟踪子进程</span>
strace -f -p &lt;pid&gt;
</code></pre>
<h3 data-id="heading-2">案例一：服务启动卡住</h3>
<p>现象：Java服务启动后卡住，不打印任何日志。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 找到进程号</span>
ps aux | grep java
<span class="hljs-comment"># 假设是12345</span>

<span class="hljs-comment"># strace跟踪</span>
strace -p 12345
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">futex</span>(<span class="hljs-number">0x7f8a8c000000</span>, FUTEX_WAIT_PRIVATE, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>
</code></pre>
<p>卡在futex，说明在等锁。</p>
<p>进一步看是什么锁：</p>
<pre><code class="hljs language-bash" lang="bash">strace -p 12345 -e trace=futex -T
</code></pre>
<p>结合jstack看线程栈：</p>
<pre><code class="hljs language-bash" lang="bash">jstack 12345 &gt; thread.dump
grep -A 20 <span class="hljs-string">"BLOCKED"</span> thread.dump
</code></pre>
<p>发现是启动时连接数据库，数据库连不上，超时时间设太长了。</p>
<h3 data-id="heading-3">案例二：文件读写问题</h3>
<p>现象：服务很慢，但CPU和内存都不高。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 只看文件相关的调用</span>
strace -p 12345 -e trace=file

<span class="hljs-comment"># 或者看所有IO</span>
strace -p 12345 -e trace=<span class="hljs-built_in">read</span>,write,open,close
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">open</span>("/data/logs/app.log", O_WRONLY|O_APPEND) = <span class="hljs-number">3</span>
<span class="hljs-built_in">write</span>(<span class="hljs-number">3</span>, "<span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">23</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> INFO...", <span class="hljs-number">1024</span>) = <span class="hljs-number">1024</span>
<span class="hljs-built_in">close</span>(<span class="hljs-number">3</span>) = <span class="hljs-number">0</span>
<span class="hljs-built_in">open</span>("/data/logs/app.log", O_WRONLY|O_APPEND) = <span class="hljs-number">3</span>
<span class="hljs-built_in">write</span>(<span class="hljs-number">3</span>, "<span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">23</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> INFO...", <span class="hljs-number">1024</span>) = <span class="hljs-number">1024</span>
<span class="hljs-built_in">close</span>(<span class="hljs-number">3</span>) = <span class="hljs-number">0</span>
...
</code></pre>
<p>每次写日志都open-write-close，频繁的文件操作导致性能差。</p>
<p>改成保持文件句柄打开，或者用异步日志。</p>
<h3 data-id="heading-4">案例三：网络问题</h3>
<p>现象：服务偶尔超时。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 只看网络相关</span>
strace -p 12345 -e trace=network -T
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">connect</span>(<span class="hljs-number">5</span>, {sa_family=AF_INET, sin_port=htons(<span class="hljs-number">3306</span>), sin_addr=<span class="hljs-built_in">inet_addr</span>("<span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span>")}, <span class="hljs-number">16</span>) = -<span class="hljs-number">1</span> ETIMEDOUT (Connection timed out) &lt;<span class="hljs-number">30.001234</span>&gt;
</code></pre>
<p>连接数据库超时30秒，问题找到了。</p>
<h3 data-id="heading-5">常用参数</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># -f：跟踪子进程</span>
strace -f -p 12345

<span class="hljs-comment"># -T：显示每个调用耗时</span>
strace -T -p 12345

<span class="hljs-comment"># -t：显示时间戳</span>
strace -t -p 12345

<span class="hljs-comment"># -c：统计系统调用次数和耗时</span>
strace -c -p 12345

<span class="hljs-comment"># -o：输出到文件</span>
strace -o trace.log -p 12345

<span class="hljs-comment"># 组合使用</span>
strace -f -T -t -o trace.log -p 12345
</code></pre>
<h3 data-id="heading-6">统计分析</h3>
<pre><code class="hljs language-bash" lang="bash">strace -c -p 12345
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-lua" lang="lua">% <span class="hljs-built_in">time</span>     seconds  usecs/call     calls    errors syscall
<span class="hljs-comment">------ ----------- ----------- --------- --------- ----------------</span>
 <span class="hljs-number">45.23</span>    <span class="hljs-number">2.345678</span>         <span class="hljs-number">234</span>     <span class="hljs-number">10000</span>           <span class="hljs-built_in">write</span>
 <span class="hljs-number">30.12</span>    <span class="hljs-number">1.234567</span>        <span class="hljs-number">1234</span>      <span class="hljs-number">1000</span>           <span class="hljs-built_in">read</span>
 <span class="hljs-number">20.11</span>    <span class="hljs-number">0.987654</span>          <span class="hljs-number">98</span>     <span class="hljs-number">10000</span>           futex
  <span class="hljs-number">4.54</span>    <span class="hljs-number">0.234567</span>          <span class="hljs-number">23</span>     <span class="hljs-number">10000</span>           clock_gettime
<span class="hljs-comment">------ ----------- ----------- --------- --------- ----------------</span>
<span class="hljs-number">100.00</span>    <span class="hljs-number">4.802466</span>                 <span class="hljs-number">31000</span>           total
</code></pre>
<p>一眼就能看出时间花在哪了。</p>
<h2 data-id="heading-7">lsof：列出打开的文件</h2>
<p>Linux里一切皆文件，lsof能看到进程打开了什么文件、网络连接、设备等。</p>
<h3 data-id="heading-8">基本用法</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看进程打开的所有文件</span>
lsof -p &lt;pid&gt;

<span class="hljs-comment"># 查看某个文件被谁打开</span>
lsof /var/log/app.log

<span class="hljs-comment"># 查看某个端口</span>
lsof -i :8080

<span class="hljs-comment"># 查看某个用户的所有打开文件</span>
lsof -u root
</code></pre>
<h3 data-id="heading-9">案例一：端口被占用</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 谁占用了8080端口</span>
lsof -i :8080
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-sql" lang="sql">COMMAND   PID <span class="hljs-keyword">USER</span>   FD   TYPE DEVICE SIZE<span class="hljs-operator">/</span>OFF NODE NAME
java    <span class="hljs-number">12345</span> root  <span class="hljs-number">123</span>u  IPv6 <span class="hljs-number">123456</span>      <span class="hljs-number">0</span>t0  TCP <span class="hljs-operator">*</span>:<span class="hljs-number">8080</span> (LISTEN)
</code></pre>
<p>进程12345占用了8080端口。</p>
<h3 data-id="heading-10">案例二：文件句柄泄漏</h3>
<p>现象：服务运行一段时间后报"Too many open files"。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看进程打开的文件数</span>
lsof -p 12345 | <span class="hljs-built_in">wc</span> -l

<span class="hljs-comment"># 按文件类型分组统计</span>
lsof -p 12345 | awk <span class="hljs-string">'{print $5}'</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -rn
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">5000 </span><span class="hljs-string">IPv4</span>
   <span class="hljs-number">3000 </span><span class="hljs-string">REG</span>
   <span class="hljs-number">1000 </span><span class="hljs-string">DIR</span>
</code></pre>
<p>5000个网络连接？明显有连接泄漏。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 看看都连了谁</span>
lsof -p 12345 -i | <span class="hljs-built_in">head</span> -20
</code></pre>
<pre><code class="hljs language-rust" lang="rust">COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
java    <span class="hljs-number">12345</span> root  <span class="hljs-number">123</span>u  IPv4 <span class="hljs-number">123456</span>      <span class="hljs-number">0</span>t0  TCP <span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">54321</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-number">10.0</span>.<span class="hljs-number">0.2</span>:<span class="hljs-number">3306</span> (ESTABLISHED)
java    <span class="hljs-number">12345</span> root  <span class="hljs-number">124</span>u  IPv4 <span class="hljs-number">123457</span>      <span class="hljs-number">0</span>t0  TCP <span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">54322</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-number">10.0</span>.<span class="hljs-number">0.2</span>:<span class="hljs-number">3306</span> (ESTABLISHED)
java    <span class="hljs-number">12345</span> root  <span class="hljs-number">125</span>u  IPv4 <span class="hljs-number">123458</span>      <span class="hljs-number">0</span>t0  TCP <span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">54323</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-number">10.0</span>.<span class="hljs-number">0.2</span>:<span class="hljs-number">3306</span> (ESTABLISHED)
...
</code></pre>
<p>全是连数据库的，连接池用完没归还。</p>
<h3 data-id="heading-11">案例三：删除的文件还在占用空间</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看已删除但仍被引用的文件</span>
lsof +L1
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-c" lang="c">COMMAND   PID USER   FD   TYPE DEVICE    SIZE/OFF NLINK  NODE NAME
java    <span class="hljs-number">12345</span> root   <span class="hljs-number">10</span>w   REG  <span class="hljs-number">253</span>,<span class="hljs-number">1</span> <span class="hljs-number">10737418240</span>     <span class="hljs-number">0</span> <span class="hljs-number">12345</span> /var/<span class="hljs-built_in">log</span>/app.<span class="hljs-built_in">log</span> (deleted)
</code></pre>
<p>日志文件被删了，但进程还引用着，10G空间释放不掉。</p>
<p>解决：重启服务，或者truncate文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 找到文件描述符路径</span>
<span class="hljs-built_in">ls</span> -l /proc/12345/fd/10
<span class="hljs-comment"># 清空内容但不关闭句柄</span>
: &gt; /proc/12345/fd/10
</code></pre>
<h3 data-id="heading-12">案例四：网络连接分析</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看所有网络连接</span>
lsof -i

<span class="hljs-comment"># 只看TCP</span>
lsof -i tcp

<span class="hljs-comment"># 只看某个状态</span>
lsof -i | grep ESTABLISHED

<span class="hljs-comment"># 统计连接数</span>
lsof -i | grep ESTABLISHED | <span class="hljs-built_in">wc</span> -l

<span class="hljs-comment"># 按目标地址分组</span>
lsof -i | grep ESTABLISHED | awk <span class="hljs-string">'{print $9}'</span> | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">'&gt;'</span> -f2 | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">':'</span> -f1 | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -rn
</code></pre>
<h2 data-id="heading-13">组合使用</h2>
<h3 data-id="heading-14">排查思路</h3>
<ol>
<li><strong>先用top/htop看整体</strong></li>
<li><strong>用ps看进程状态</strong></li>
<li><strong>用lsof看打开了什么</strong></li>
<li><strong>用strace看在做什么</strong></li>
</ol>
<h3 data-id="heading-15">实战：服务假死排查</h3>
<p>现象：服务进程在，但不响应请求。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 看进程状态</span>
ps aux | grep java
<span class="hljs-comment"># 状态是Sl，正常</span>

<span class="hljs-comment"># 2. 看打开的文件和连接</span>
lsof -p 12345 | <span class="hljs-built_in">wc</span> -l
<span class="hljs-comment"># 8000+，有点多</span>

<span class="hljs-comment"># 3. 看网络连接</span>
lsof -p 12345 -i | grep -c ESTABLISHED
<span class="hljs-comment"># 5000+，太多了</span>

<span class="hljs-comment"># 4. 看连接状态分布</span>
ss -tnp | grep 12345 | awk <span class="hljs-string">'{print $4}'</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c
<span class="hljs-comment"># 大量CLOSE_WAIT</span>

<span class="hljs-comment"># 5. strace看在做什么</span>
strace -p 12345 -e trace=network
<span class="hljs-comment"># 卡在accept上，但新连接进不来</span>
</code></pre>
<p>根因：连接池满了，CLOSE_WAIT状态的连接没有正确关闭。</p>
<h3 data-id="heading-16">实战：CPU 100%排查</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. top找到占用CPU的进程</span>
top -c
<span class="hljs-comment"># PID 12345 CPU 99%</span>

<span class="hljs-comment"># 2. 看线程CPU使用</span>
top -H -p 12345
<span class="hljs-comment"># TID 12346 CPU 99%</span>

<span class="hljs-comment"># 3. 把线程ID转成16进制</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">"%x\n"</span> 12346
<span class="hljs-comment"># 303a</span>

<span class="hljs-comment"># 4. jstack看线程栈（Java）</span>
jstack 12345 | grep -A 30 <span class="hljs-string">"0x303a"</span>

<span class="hljs-comment"># 5. 或者用strace看系统调用</span>
strace -p 12346 -c
</code></pre>
<h2 data-id="heading-17">远程排查</h2>
<p>有时候问题机器在远程，需要登录排查。</p>
<p>我们有几台服务器在不同机房，之前用跳板机一层层跳很麻烦。现在用星空组网把所有机器组到一起，直接SSH过去就能用strace、lsof排查，效率高多了。</p>
<h2 data-id="heading-18">常用命令速查</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># strace速查</span>
strace -p &lt;pid&gt;                    <span class="hljs-comment"># 跟踪进程</span>
strace -f -p &lt;pid&gt;                 <span class="hljs-comment"># 跟踪包括子进程</span>
strace -e trace=network -p &lt;pid&gt;   <span class="hljs-comment"># 只看网络</span>
strace -e trace=file -p &lt;pid&gt;      <span class="hljs-comment"># 只看文件</span>
strace -c -p &lt;pid&gt;                 <span class="hljs-comment"># 统计</span>
strace -T -p &lt;pid&gt;                 <span class="hljs-comment"># 显示耗时</span>

<span class="hljs-comment"># lsof速查</span>
lsof -p &lt;pid&gt;                      <span class="hljs-comment"># 进程打开的文件</span>
lsof -i :&lt;port&gt;                    <span class="hljs-comment"># 谁占用端口</span>
lsof -i tcp                        <span class="hljs-comment"># 所有TCP连接</span>
lsof +L1                           <span class="hljs-comment"># 已删除但仍占用的文件</span>
lsof -u &lt;user&gt;                     <span class="hljs-comment"># 用户打开的文件</span>
</code></pre>
<h2 data-id="heading-19">总结</h2>




















<table><thead><tr><th>工具</th><th>用途</th><th>典型场景</th></tr></thead><tbody><tr><td>strace</td><td>跟踪系统调用</td><td>卡死、慢、报错看不出原因</td></tr><tr><td>lsof</td><td>看打开的文件/连接</td><td>端口占用、文件泄漏、连接泄漏</td></tr></tbody></table>
<p>排查原则：</p>
<ol>
<li>从宏观到微观</li>
<li>从现象到根因</li>
<li>不确定就多看几遍</li>
</ol>
<p>这两个工具用熟了，大部分疑难杂症都能查出来。</p>
<hr/>
<p>有排查经验欢迎评论区分享~</p>
<pre><code class="hljs"/></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Dubbo跨机房调用实战：从原理到架构的完美解决方案]]></title>    <link>https://juejin.cn/post/7586617459487522868</link>    <guid>https://juejin.cn/post/7586617459487522868</guid>    <pubDate>2025-12-23T06:01:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586617459487522868" data-draft-id="7586622708998733864" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Dubbo跨机房调用实战：从原理到架构的完美解决方案"/> <meta itemprop="keywords" content="后端,Dubbo"/> <meta itemprop="datePublished" content="2025-12-23T06:01:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Dubbo跨机房调用实战：从原理到架构的完美解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:01:00.000Z" title="Tue Dec 23 2025 06:01:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、跨机房调用的核心挑战</h3>
<h4 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.1 [网络延迟]问题</h4>
<p>跨机房调用最直接的影响就是<strong>网络延迟</strong>。同一个机房内网络延迟通常在1ms以内，而跨机房延迟可能达到10-50ms，甚至更高！</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 模拟跨机房调用延迟对比</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NetworkLatencyDemo</span> {
    
    <span class="hljs-comment">// 同机房调用 - 延迟 &lt; 1ms</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sameIdcCall</span>()</span> {
        <span class="hljs-built_in">long</span> start = System.currentTimeMillis();
        <span class="hljs-comment">// 服务调用逻辑</span>
        doServiceCall();
        <span class="hljs-built_in">long</span> end = System.currentTimeMillis();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"同机房调用耗时: "</span> + (end - start) + <span class="hljs-string">"ms"</span>);
    }
    
    <span class="hljs-comment">// 跨机房调用 - 延迟 10-50ms</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">crossIdcCall</span>()</span> {
        <span class="hljs-built_in">long</span> start = System.currentTimeMillis();
        <span class="hljs-comment">// 跨机房网络传输</span>
        simulateNetworkLatency(<span class="hljs-number">20</span>);
        <span class="hljs-comment">// 服务调用逻辑</span>
        doServiceCall();
        <span class="hljs-built_in">long</span> end = System.currentTimeMillis();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"跨机房调用耗时: "</span> + (end - start) + <span class="hljs-string">"ms"</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">simulateNetworkLatency</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> ms</span>)</span> {
        <span class="hljs-keyword">try</span> {
            Thread.sleep(ms);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doServiceCall</span>()</span> {
        <span class="hljs-comment">// 模拟业务处理</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">5</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}

AI写代码java
运行
<span class="hljs-number">12345678910111213141516171819202122232425262728293031323334353637383940</span>
</code></pre>
<h4 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2 数据一致性问题</h4>
<p>在分布式系统中，保证跨机房的数据一致性是一个重大挑战。我们需要考虑<strong>CAP理论</strong>中的权衡：</p>

























<table><thead><tr><th>特性</th><th>描述</th><th>跨机房影响</th></tr></thead><tbody><tr><td><strong>一致性(Consistency)</strong></td><td>所有节点看到的数据相同</td><td>跨机房网络分区时难以保证</td></tr><tr><td><strong>可用性(Availability)</strong></td><td>每个请求都能获得响应</td><td>机房故障时可能受影响</td></tr><tr><td><strong>分区容错性(Partition Tolerance)</strong></td><td>系统在网络分区时继续工作</td><td>跨机房场景必须保证</td></tr></tbody></table>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.3 容错与故障转移</h4>
<p>单个机房故障不应该影响整个系统。Dubbo提供了多种容错机制：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/485541b3b8124301973ace5da4e7a60e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074460&amp;x-signature=k9Zp3oJaJyJchMs5j5zrjBJktRc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>二、Dubbo跨机房架构设计</h3>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.1 注册中心架构</h4>
<p>在跨机房场景下，注册中心的部署方式至关重要。推荐使用<strong>分区注册中心</strong>架构：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Dubbo注册中心配置示例</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegistryConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RegistryConfig</span> <span class="hljs-title function_">beijingRegistry</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">RegistryConfig</span> registry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegistryConfig</span>();
        registry.<span class="hljs-title function_">setId</span>(<span class="hljs-string">"beijing-registry"</span>);
        registry.<span class="hljs-title function_">setAddress</span>(<span class="hljs-string">"zookeeper://192.168.1.10:2181"</span>);
        registry.<span class="hljs-title function_">setParameters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt;() {{
            <span class="hljs-title function_">put</span>(<span class="hljs-string">"cluster"</span>, <span class="hljs-string">"beijing"</span>);
            <span class="hljs-title function_">put</span>(<span class="hljs-string">"zone"</span>, <span class="hljs-string">"north-china"</span>);
        }});
        <span class="hljs-keyword">return</span> registry;
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RegistryConfig</span> <span class="hljs-title function_">shanghaiRegistry</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">RegistryConfig</span> registry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegistryConfig</span>();
        registry.<span class="hljs-title function_">setId</span>(<span class="hljs-string">"shanghai-registry"</span>);
        registry.<span class="hljs-title function_">setAddress</span>(<span class="hljs-string">"zookeeper://192.168.2.10:2181"</span>);
        registry.<span class="hljs-title function_">setParameters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt;() {{
            <span class="hljs-title function_">put</span>(<span class="hljs-string">"cluster"</span>, <span class="hljs-string">"shanghai"</span>);
            <span class="hljs-title function_">put</span>(<span class="hljs-string">"zone"</span>, <span class="hljs-string">"east-china"</span>);
        }});
        <span class="hljs-keyword">return</span> registry;
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Service</span>(registry = {<span class="hljs-string">"beijing-registry"</span>, <span class="hljs-string">"shanghai-registry"</span>})
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">UserService</span> <span class="hljs-title function_">userService</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
    }
}

<span class="hljs-variable constant_">AI</span>写代码java
运行
<span class="hljs-number">12345678910111213141516171819202122232425262728293031323334</span>
</code></pre>
<h4 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.2 路由策略设计</h4>
<p>Dubbo提供了强大的路由能力，我们可以基于机房信息进行智能路由：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df0ae6ffe3904435b9fe118423018b89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074460&amp;x-signature=pcuaXnvpBcxfkV2aOZMIuxbtzPs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.3 服务治理策略</h4>
<p>跨机房环境下的服务治理需要特别关注：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 跨机房服务治理配置</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CrossIdcGovernance</span> </span>{
    
    <span class="hljs-comment">// 1. 负载均衡策略 - 优先本地机房</span>
    <span class="hljs-meta">@Reference</span>(loadbalance = <span class="hljs-string">"preferredIdcLoadBalance"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-type">OrderService</span> orderService;
    
    <span class="hljs-comment">// 2. 超时配置 - 跨机房调用需要更长的超时时间</span>
    <span class="hljs-meta">@Reference</span>(timeout = <span class="hljs-number">5000</span>, retries = <span class="hljs-number">2</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-type">PaymentService</span> paymentService;
    
    <span class="hljs-comment">// 3. 集群容错策略</span>
    <span class="hljs-meta">@Reference</span>(cluster = <span class="hljs-string">"failover"</span>, 
               parameters = {<span class="hljs-string">"crossIdc.failover"</span>, <span class="hljs-string">"true"</span>})
    <span class="hljs-keyword">private</span> <span class="hljs-type">InventoryService</span> inventoryService;
}

<span class="hljs-comment">// 自定义跨机房负载均衡器</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PreferredIdcLoadBalance</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractLoadBalance</span> </span>{
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> localIdc = <span class="hljs-type">System</span>.getProperty(<span class="hljs-string">"idc"</span>, <span class="hljs-string">"beijing"</span>);
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> &lt;<span class="hljs-type">T</span>&gt; <span class="hljs-type">Invoker</span>&lt;<span class="hljs-type">T</span>&gt; doSelect(<span class="hljs-type">List</span>&lt;<span class="hljs-type">Invoker</span>&lt;<span class="hljs-type">T</span>&gt;&gt; invokers, 
                                     <span class="hljs-type">URL</span> url, 
                                     <span class="hljs-type">Invocation</span> invocation) {
        <span class="hljs-comment">// 优先选择同机房服务</span>
        <span class="hljs-type">List</span>&lt;<span class="hljs-type">Invoker</span>&lt;<span class="hljs-type">T</span>&gt;&gt; localIdcInvokers = invokers.stream()
            .filter(invoker -&gt; localIdc.equals(invoker.getUrl().getParameter(<span class="hljs-string">"idc"</span>)))
            .collect(<span class="hljs-type">Collectors</span>.toList());
            
        <span class="hljs-keyword">if</span> (!localIdcInvokers.isEmpty()) {
            <span class="hljs-comment">// 同机房内使用随机负载均衡</span>
            <span class="hljs-keyword">return</span> randomSelect(localIdcInvokers);
        }
        
        <span class="hljs-comment">// 没有同机房服务，选择其他机房</span>
        <span class="hljs-keyword">return</span> randomSelect(invokers);
    }
}

<span class="hljs-type">AI</span>写代码java
运行
<span class="hljs-number">12345678910111213141516171819202122232425262728293031323334353637383940</span>
</code></pre>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>三、实战：Dubbo跨机房配置</h3>
<h4 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.1 环境准备与配置</h4>
<p>让我们通过一个完整的示例来配置Dubbo跨机房调用：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- dubbo-provider.xml 服务提供者配置 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hljs-attr">xmlns:dubbo</span>=<span class="hljs-string">"http://dubbo.apache.org/schema/dubbo"</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://dubbo.apache.org/schema/dubbo
       http://dubbo.apache.org/schema/dubbo/dubbo.xsd"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 北京机房应用配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:application</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"order-service"</span> <span class="hljs-attr">owner</span>=<span class="hljs-string">"team-bj"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:parameter</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"idc"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"beijing"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:parameter</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"region"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"north-china"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dubbo:application</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 多注册中心配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"beijing-registry"</span> 
                    <span class="hljs-attr">address</span>=<span class="hljs-string">"zookeeper://zk-bj1:2181?cluster=bj"</span>
                    <span class="hljs-attr">default</span>=<span class="hljs-string">"false"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"shanghai-registry"</span> 
                    <span class="hljs-attr">address</span>=<span class="hljs-string">"zookeeper://zk-sh1:2181?cluster=sh"</span>
                    <span class="hljs-attr">default</span>=<span class="hljs-string">"false"</span>/&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 协议配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:protocol</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dubbo"</span> <span class="hljs-attr">port</span>=<span class="hljs-string">"20880"</span> 
                    <span class="hljs-attr">server</span>=<span class="hljs-string">"netty"</span> <span class="hljs-attr">client</span>=<span class="hljs-string">"netty"</span>/&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 服务提供者配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:service</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">"com.example.OrderService"</span>
                   <span class="hljs-attr">ref</span>=<span class="hljs-string">"orderService"</span>
                   <span class="hljs-attr">registry</span>=<span class="hljs-string">"beijing-registry,shanghai-registry"</span>
                   <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0.0"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"createOrder"</span> <span class="hljs-attr">timeout</span>=<span class="hljs-string">"3000"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"queryOrder"</span> <span class="hljs-attr">timeout</span>=<span class="hljs-string">"1000"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dubbo:service</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"orderService"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.OrderServiceImpl"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>

AI写代码xml
1234567891011121314151617181920212223242526272829303132333435363738
</code></pre>
<h4 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.2 路由规则配置</h4>
<p>通过Dubbo的路由规则实现智能路由：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 动态路由规则配置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoutingRuleManager</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> void setupIdcRoutingRules() {
        <span class="hljs-comment">// 条件路由规则：优先调用同机房服务</span>
        <span class="hljs-type">String</span> conditionRule <span class="hljs-operator">=</span> 
            <span class="hljs-string">"{<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"  "</span>scope<span class="hljs-string">": "</span>application<span class="hljs-string">",<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"  "</span>key<span class="hljs-string">": "</span>order<span class="hljs-operator">-</span>service<span class="hljs-string">",<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"  "</span>conditions<span class="hljs-string">": [<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"    "</span><span class="hljs-operator">=&gt;</span> \n<span class="hljs-string">" +
            "</span>    $[idc] <span class="hljs-operator">=</span> $[consumer.idc] <span class="hljs-operator">?</span> <span class="hljs-operator">*</span> \n<span class="hljs-string">" +
            "</span>    : $[idc] <span class="hljs-operator">=</span> 'beijing' <span class="hljs-operator">&amp;&amp;</span> $[consumer.region] <span class="hljs-operator">=</span> 'north<span class="hljs-operator">-</span>china' <span class="hljs-operator">?</span> <span class="hljs-operator">*</span> \n<span class="hljs-string">" +
            "</span>    : $[idc] <span class="hljs-operator">=</span> 'shanghai' <span class="hljs-operator">&amp;&amp;</span> $[consumer.region] <span class="hljs-operator">=</span> 'east<span class="hljs-operator">-</span>china' <span class="hljs-operator">?</span> <span class="hljs-operator">*</span> \n<span class="hljs-string">" +
            "</span>    : null<span class="hljs-string">"<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"  ]<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"}"</span>;
        
        <span class="hljs-comment">// 标签路由规则：明确指定服务分组</span>
        <span class="hljs-type">String</span> tagRule <span class="hljs-operator">=</span> 
            <span class="hljs-string">"{<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"  "</span>force<span class="hljs-string">": false,<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"  "</span>rules<span class="hljs-string">": [<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"    {<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"      "</span>dubbo<span class="hljs-string">": "</span>com.example.<span class="hljs-type">OrderService</span><span class="hljs-string">",<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"      "</span>tags<span class="hljs-string">": [<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"        {<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"          "</span>name<span class="hljs-string">": "</span>beijing<span class="hljs-string">",<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"          "</span>addresses<span class="hljs-string">": ["</span><span class="hljs-number">192.168</span>.<span class="hljs-number">1</span><span class="hljs-operator">.*</span><span class="hljs-string">"]<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"        },<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"        {<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"          "</span>name<span class="hljs-string">": "</span>shanghai<span class="hljs-string">", <span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"          "</span>addresses<span class="hljs-string">": ["</span><span class="hljs-number">192.168</span>.<span class="hljs-number">2</span><span class="hljs-operator">.*</span><span class="hljs-string">"]<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"        }<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"      ]<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"    }<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"  ]<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"}"</span>;
        
        <span class="hljs-comment">// 将规则发布到注册中心</span>
        publishRoutingRules(conditionRule, tagRule);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> void publishRoutingRules(<span class="hljs-type">String</span> conditionRule, <span class="hljs-type">String</span> tagRule) {
        <span class="hljs-comment">// 实际项目中通过Dubbo Admin或直接调用注册中心API发布规则</span>
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"发布路由规则完成"</span>);
    }
}

<span class="hljs-type">AI写代码java</span>
运行
<span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748</span>
</code></pre>
<h4 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.3 监控与调优</h4>
<p>跨机房调用的监控至关重要，下面是一个监控配置示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 跨机房调用监控</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CrossIdcMonitor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MeterRegistry</span> <span class="hljs-variable">meterRegistry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMeterRegistry</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Counter</span> <span class="hljs-variable">crossIdcCounter</span> <span class="hljs-operator">=</span> Counter
        .builder(<span class="hljs-string">"dubbo.crossidc.calls"</span>)
        .description(<span class="hljs-string">"跨机房调用统计"</span>)
        .register(meterRegistry);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Timer</span> <span class="hljs-variable">crossIdcTimer</span> <span class="hljs-operator">=</span> Timer
        .builder(<span class="hljs-string">"dubbo.crossidc.latency"</span>)
        .description(<span class="hljs-string">"跨机房调用延迟"</span>)
        .register(meterRegistry);
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">invoke</span><span class="hljs-params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="hljs-keyword">throws</span> RpcException {
        <span class="hljs-type">String</span> <span class="hljs-variable">consumerIdc</span> <span class="hljs-operator">=</span> RpcContext.getContext().getAttachment(<span class="hljs-string">"idc"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">providerIdc</span> <span class="hljs-operator">=</span> invoker.getUrl().getParameter(<span class="hljs-string">"idc"</span>);
        
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isCrossIdc</span> <span class="hljs-operator">=</span> !Objects.equals(consumerIdc, providerIdc);
        
        <span class="hljs-keyword">if</span> (isCrossIdc) {
            crossIdcCounter.increment();
            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> invoker.invoke(invocation);
                <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;
                crossIdcTimer.record(duration, TimeUnit.MILLISECONDS);
                
                <span class="hljs-comment">// 记录监控日志</span>
                logCrossIdcCall(consumerIdc, providerIdc, duration, 
                               invocation.getMethodName(), <span class="hljs-literal">true</span>);
                <span class="hljs-keyword">return</span> result;
            } <span class="hljs-keyword">catch</span> (RpcException e) {
                logCrossIdcCall(consumerIdc, providerIdc, <span class="hljs-number">0L</span>, 
                               invocation.getMethodName(), <span class="hljs-literal">false</span>);
                <span class="hljs-keyword">throw</span> e;
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> invoker.invoke(invocation);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logCrossIdcCall</span><span class="hljs-params">(String fromIdc, String toIdc, <span class="hljs-type">long</span> latency, 
                                String method, <span class="hljs-type">boolean</span> success)</span> {
        System.out.printf(<span class="hljs-string">"跨机房调用: %s -&gt; %s, 方法: %s, 延迟: %dms, 状态: %s%n"</span>,
                         fromIdc, toIdc, method, latency, success ? <span class="hljs-string">"成功"</span> : <span class="hljs-string">"失败"</span>);
    }
}

AI写代码java
运行
<span class="hljs-number">1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950</span>
</code></pre>
<h3 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>四、高级特性与最佳实践</h3>
<h4 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.1 动态路由策略</h4>
<p>基于实时监控数据的动态路由策略：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 基于实时指标的路由决策</span>
@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicRoutingStrategy</span> {
    
    @Autowired
    <span class="hljs-keyword">private</span> MetricsCollector metricsCollector;
    
    <span class="hljs-comment">/**
     * 根据实时网络状况选择最优机房
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">selectOptimalIdc</span><span class="hljs-params">(<span class="hljs-type">String</span> serviceName, <span class="hljs-type">String</span> currentIdc)</span> </span>{
        Map&lt;<span class="hljs-type">String</span>, IdcMetrics&gt; idcMetrics = metricsCollector.<span class="hljs-built_in">getIdcMetrics</span>(serviceName);
        
        <span class="hljs-keyword">return</span> idcMetrics.<span class="hljs-built_in">entrySet</span>().<span class="hljs-built_in">stream</span>()
            .<span class="hljs-built_in">filter</span>(entry -&gt; <span class="hljs-built_in">isIdcHealthy</span>(entry.<span class="hljs-built_in">getValue</span>()))
            .<span class="hljs-built_in">min</span>(Comparator.<span class="hljs-built_in">comparing</span>(entry -&gt; <span class="hljs-built_in">calculateScore</span>(entry.<span class="hljs-built_in">getValue</span>(), currentIdc)))
            .<span class="hljs-built_in">map</span>(Map.Entry::getKey)
            .<span class="hljs-built_in">orElse</span>(currentIdc); <span class="hljs-comment">// 默认返回当前机房</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title">isIdcHealthy</span><span class="hljs-params">(IdcMetrics metrics)</span> </span>{
        <span class="hljs-comment">// 判断机房健康状况</span>
        <span class="hljs-keyword">return</span> metrics.<span class="hljs-built_in">getSuccessRate</span>() &gt; <span class="hljs-number">0.95</span> &amp;&amp; 
               metrics.<span class="hljs-built_in">getAvgLatency</span>() &lt; <span class="hljs-number">100</span> &amp;&amp;
               metrics.<span class="hljs-built_in">getErrorRate</span>() &lt; <span class="hljs-number">0.05</span>;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title">calculateScore</span><span class="hljs-params">(IdcMetrics metrics, <span class="hljs-type">String</span> currentIdc)</span> </span>{
        <span class="hljs-type">double</span> latencyScore = metrics.<span class="hljs-built_in">getAvgLatency</span>() / <span class="hljs-number">50.0</span>; <span class="hljs-comment">// 标准化延迟</span>
        <span class="hljs-type">double</span> successScore = (<span class="hljs-number">1</span> - metrics.<span class="hljs-built_in">getSuccessRate</span>()) * <span class="hljs-number">10</span>; <span class="hljs-comment">// 失败率惩罚</span>
        
        <span class="hljs-comment">// 同机房优先：当前机房得分降低</span>
        <span class="hljs-type">double</span> sameIdcBonus = metrics.<span class="hljs-built_in">getIdc</span>().<span class="hljs-built_in">equals</span>(currentIdc) ? <span class="hljs-number">-0.5</span> : <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">return</span> latencyScore + successScore + sameIdcBonus;
    }
}

<span class="hljs-comment">// 机房指标数据类</span>
@Data
<span class="hljs-keyword">class</span> <span class="hljs-title class_">IdcMetrics</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> idc;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> avgLatency;    <span class="hljs-comment">// 平均延迟(ms)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> successRate;   <span class="hljs-comment">// 成功率</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> errorRate;     <span class="hljs-comment">// 错误率</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> activeConnections; <span class="hljs-comment">// 活跃连接数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> lastUpdateTime;  <span class="hljs-comment">// 最后更新时间</span>
}

AI写代码java
运行
<span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748</span>
</code></pre>
<h4 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.2 熔断与降级</h4>
<p>跨机房调用必须要有完善的熔断降级机制：</p>
<pre><code class="hljs language-ini" lang="ini">// 跨机房熔断器实现
@Component
public class CrossIdcCircuitBreaker {
    
    private final Map&lt;String, CircuitBreakerStats&gt; <span class="hljs-attr">statsMap</span> = new ConcurrentHashMap&lt;&gt;()<span class="hljs-comment">;</span>
    private final int <span class="hljs-attr">failureThreshold</span> = <span class="hljs-number">5</span><span class="hljs-comment">;</span>
    private final long <span class="hljs-attr">timeout</span> = <span class="hljs-number">30000</span>L<span class="hljs-comment">; // 30秒熔断时间</span>
    
    public boolean allowRequest(String serviceId, String targetIdc) {
        String <span class="hljs-attr">key</span> = serviceId + <span class="hljs-string">":"</span> + targetIdc<span class="hljs-comment">;</span>
        CircuitBreakerStats <span class="hljs-attr">stats</span> = statsMap.computeIfAbsent(key, 
            k -&gt; new CircuitBreakerStats())<span class="hljs-comment">;</span>
            
        if (<span class="hljs-attr">stats.state</span> == State.OPEN) {
            if (System.currentTimeMillis() - stats.lastFailureTime &gt; timeout) {
                // 超时后进入半开状态
                <span class="hljs-attr">stats.state</span> = State.HALF_OPEN<span class="hljs-comment">;</span>
                <span class="hljs-attr">stats.consecutiveFailures</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
                return true<span class="hljs-comment">;</span>
            }
            return false<span class="hljs-comment">;</span>
        }
        return true<span class="hljs-comment">;</span>
    }
    
    public void onSuccess(String serviceId, String targetIdc) {
        String <span class="hljs-attr">key</span> = serviceId + <span class="hljs-string">":"</span> + targetIdc<span class="hljs-comment">;</span>
        CircuitBreakerStats <span class="hljs-attr">stats</span> = statsMap.get(key)<span class="hljs-comment">;</span>
        if (stats != null) {
            if (<span class="hljs-attr">stats.state</span> == State.HALF_OPEN) {
                <span class="hljs-attr">stats.state</span> = State.CLOSED<span class="hljs-comment">;</span>
            }
            <span class="hljs-attr">stats.consecutiveFailures</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        }
    }
    
    public void onFailure(String serviceId, String targetIdc) {
        String <span class="hljs-attr">key</span> = serviceId + <span class="hljs-string">":"</span> + targetIdc<span class="hljs-comment">;</span>
        CircuitBreakerStats <span class="hljs-attr">stats</span> = statsMap.computeIfAbsent(key, 
            k -&gt; new CircuitBreakerStats())<span class="hljs-comment">;</span>
            
        stats.consecutiveFailures++<span class="hljs-comment">;</span>
        <span class="hljs-attr">stats.lastFailureTime</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        
        if (stats.consecutiveFailures &gt;= failureThreshold) {
            <span class="hljs-attr">stats.state</span> = State.OPEN<span class="hljs-comment">;</span>
        } else if (<span class="hljs-attr">stats.state</span> == State.HALF_OPEN) {
            <span class="hljs-attr">stats.state</span> = State.OPEN<span class="hljs-comment">; // 半开状态下失败立即熔断</span>
        }
    }
    
    enum State { OPEN, HALF_OPEN, CLOSED }
    
    static class CircuitBreakerStats {
        State <span class="hljs-attr">state</span> = State.CLOSED<span class="hljs-comment">;</span>
        int <span class="hljs-attr">consecutiveFailures</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        long <span class="hljs-attr">lastFailureTime</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    }
}

AI写代码java
运行
1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859
</code></pre>
<h4 data-id="heading-15"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.3 性能优化技巧</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 跨机房调用性能优化实践</span>
public class PerformanceOptimization {
    
    <span class="hljs-comment">// 1. 连接池优化</span>
    <span class="hljs-keyword">@Bean</span>
    public ProtocolConfig protocolConfig() {
        ProtocolConfig protocol = new <span class="hljs-built_in">ProtocolConfig</span>();
        protocol<span class="hljs-selector-class">.setName</span>("dubbo");
        protocol<span class="hljs-selector-class">.setPort</span>(<span class="hljs-number">20880</span>);
        protocol<span class="hljs-selector-class">.setThreads</span>(<span class="hljs-number">200</span>);
        protocol<span class="hljs-selector-class">.setIothreads</span>(<span class="hljs-number">4</span>);
        protocol<span class="hljs-selector-class">.setQueues</span>(<span class="hljs-number">0</span>);
        protocol<span class="hljs-selector-class">.setAccepts</span>(<span class="hljs-number">1000</span>);
        protocol<span class="hljs-selector-class">.setIdleTimeout</span>(<span class="hljs-number">600000</span>); <span class="hljs-comment">// 10分钟空闲超时</span>
        return protocol;
    }
    
    <span class="hljs-comment">// 2. 序列化优化 - 使用Kryo或Protobuf</span>
    <span class="hljs-keyword">@Bean</span> 
    public SerializationOptimizer serializationOptimizer() {
        return new <span class="hljs-built_in">SerializationOptimizer</span>() {
            <span class="hljs-keyword">@Override</span>
            public Collection&lt;Class&lt;?&gt;&gt; getSerializableClasses() {
                List&lt;Class&lt;?&gt;&gt; classes = new ArrayList&lt;&gt;();
                classes<span class="hljs-selector-class">.add</span>(OrderDTO.class);
                classes<span class="hljs-selector-class">.add</span>(UserDTO.class);
                classes<span class="hljs-selector-class">.add</span>(ProductDTO.class);
                return classes;
            }
        };
    }
    
    <span class="hljs-comment">// 3. 异步调用优化</span>
    public void <span class="hljs-built_in">asyncCrossIdcCall</span>() {
        <span class="hljs-comment">// 异步调用，避免阻塞</span>
        CompletableFuture&lt;OrderResult&gt; future = orderService<span class="hljs-selector-class">.createOrderAsync</span>(order);
        
        <span class="hljs-comment">// 可以继续处理其他逻辑</span>
        <span class="hljs-built_in">doOtherWork</span>();
        
        <span class="hljs-comment">// 需要结果时再获取</span>
        OrderResult result = future<span class="hljs-selector-class">.get</span>(<span class="hljs-number">3000</span>, TimeUnit.MILLISECONDS);
    }
    
    <span class="hljs-comment">// 4. 批量调用优化</span>
    public void <span class="hljs-built_in">batchCrossIdcCall</span>(List&lt;Order&gt; orders) {
        <span class="hljs-comment">// 合并多个调用，减少网络往返</span>
        BatchResult batchResult = orderService<span class="hljs-selector-class">.batchCreateOrders</span>(orders);
        
        <span class="hljs-comment">// 处理批量结果</span>
        <span class="hljs-built_in">processBatchResult</span>(batchResult);
    }
}

AI写代码java
运行
<span class="hljs-number">1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253</span>
</code></pre>
<h3 data-id="heading-16"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>五、总结与展望</h3>
<p>通过本文的详细讲解，我们可以看到Dubbo在跨机房服务调用方面提供了完整的解决方案。从基础的路由配置到高级的动态路由策略，从简单的容错到复杂的熔断降级，Dubbo都给出了很好的实践方案。</p>
<h4 data-id="heading-17"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>🎯 关键要点回顾</h4>
<ol>
<li><strong>架构设计</strong>：合理的注册中心部署和路由策略是基础</li>
<li><strong>性能优化</strong>：连接池、序列化、异步调用等多方面优化</li>
<li><strong>容错保障</strong>：完善的熔断、降级、故障转移机制</li>
<li><strong>监控运维</strong>：全面的监控体系和动态调整能力</li>
</ol>
<h4 data-id="heading-18"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>🚀 未来展望</h4>
<p>随着云原生技术的发展，Dubbo在跨机房调用方面还会有更多创新：</p>
<ul>
<li><strong>服务网格集成</strong>：与Istio等服务网格技术深度融合</li>
<li><strong>智能路由</strong>：基于AI的预测性路由决策</li>
<li><strong>多活架构</strong>：真正意义上的多机房多活部署</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS单位全解析：从像素到视口的响应式设计]]></title>    <link>https://juejin.cn/post/7586675587147399204</link>    <guid>https://juejin.cn/post/7586675587147399204</guid>    <pubDate>2025-12-23T05:50:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586675587147399204" data-draft-id="7586684925105946667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS单位全解析：从像素到视口的响应式设计"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T05:50:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户2226459894341"/> <meta itemprop="url" content="https://juejin.cn/user/2128263774470791"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS单位全解析：从像素到视口的响应式设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2128263774470791/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户2226459894341
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T05:50:05.000Z" title="Tue Dec 23 2025 05:50:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，CSS单位的选择直接影响着网页的布局灵活性和响应式效果。随着现代Web开发对多设备适配要求的提高，理解各种CSS单位的特性和适用场景变得至关重要。</p>
<h2 data-id="heading-0">绝对单位：精确但缺乏弹性</h2>
<p>绝对单位如<code>px</code>（像素）是最常见的单位，1px对应屏幕上的一个物理像素点。在固定尺寸设计中，像素单位提供了精确控制：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">960px</span>; <span class="hljs-comment">/* 传统固定布局 */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}
</code></pre>
<p>然而，在Retina等高密度显示屏上，像素单位的实际物理尺寸会变小，且无法根据上下文环境自适应变化，这在响应式设计中成为明显限制。</p>
<h2 data-id="heading-1">相对单位：灵活适配的基石</h2>
<h3 data-id="heading-2">em：基于上下文字号</h3>
<p><code>em</code>单位相对于当前元素的字体大小或父元素字体大小：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
}

<span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.5em</span>; <span class="hljs-comment">/* 24px (16 × 1.5) */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">2em</span>;     <span class="hljs-comment">/* 48px (24 × 2) */</span>
}
</code></pre>
<h3 data-id="heading-3">rem：根元素相对单位</h3>
<p><code>rem</code>始终相对于根元素(<code>html</code>)的字体大小，避免了em的多层嵌套计算问题：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">html</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>; <span class="hljs-comment">/* 基准值 */</span>
}

<span class="hljs-selector-class">.component</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1rem</span>;    <span class="hljs-comment">/* 16px */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">2rem</span>;      <span class="hljs-comment">/* 32px */</span>
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0.5rem</span>;     <span class="hljs-comment">/* 8px */</span>
}
</code></pre>
<p>通过调整根元素字体大小，可以轻松实现整体缩放效果，非常适合构建可访问性友好的界面。</p>
<h2 data-id="heading-4">视口单位：现代响应式利器</h2>
<h3 data-id="heading-5">vw/vh：视口尺寸百分比</h3>
<p><code>vw</code>（视口宽度百分比）和<code>vh</code>（视口高度百分比）实现了真正基于视口尺寸的响应：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.hero-section</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;      <span class="hljs-comment">/* 充满整个视口高度 */</span>
  <span class="hljs-attribute">width</span>: <span class="hljs-number">80vw</span>;        <span class="hljs-comment">/* 视口宽度的80% */</span>
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">5vw</span>;     <span class="hljs-comment">/* 字号随视口宽度变化 */</span>
}
</code></pre>
<h3 data-id="heading-6">vmin/vmax：自适应选择</h3>
<p><code>vmin</code>取视口宽高中较小的百分比，<code>vmax</code>取较大的百分比：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 在移动端横竖屏切换时特别有用 */</span>
<span class="hljs-selector-class">.responsive-square</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">50vmin</span>;  <span class="hljs-comment">/* 总是基于较小尺寸 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">50vmin</span>; <span class="hljs-comment">/* 保持正方形 */</span>
}
</code></pre>
<h2 data-id="heading-7">现代布局单位：CSS Grid与Flexbox的完美搭档</h2>
<h3 data-id="heading-8">fr：Grid布局的弹性单位</h3>
<p><code>fr</code>单位在CSS Grid布局中按比例分配可用空间：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.grid-container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr <span class="hljs-number">2</span>fr <span class="hljs-number">1</span>fr; <span class="hljs-comment">/* 中间列是两侧的两倍宽 */</span>
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">1rem</span>;
}
</code></pre>
<h3 data-id="heading-9">%：基于父容器的百分比</h3>
<p>百分比单位相对于父元素的对应维度：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">800px</span>;
}

<span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">50%</span>; <span class="hljs-comment">/* 400px */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">25%</span>; <span class="hljs-comment">/* 相对于父元素高度 */</span>
}
</code></pre>
<h2 data-id="heading-10">实用技巧与最佳实践</h2>
<h3 data-id="heading-11">1. 响应式字体系统</h3>
<p>结合rem和vw创建流畅的字体缩放：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">html</span> {
  <span class="hljs-comment">/* 最小16px，最大20px，在320px-1200px视口间平滑变化 */</span>
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">16px</span>, <span class="hljs-number">4vw</span> - <span class="hljs-number">0.5rem</span>, <span class="hljs-number">20px</span>);
}
</code></pre>
<h3 data-id="heading-12">2. 间距系统的一致性</h3>
<p>建立基于rem的间距系统：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--space-unit</span>: <span class="hljs-number">0.5rem</span>;
  <span class="hljs-attr">--space-xs</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--space-unit) * <span class="hljs-number">0.5</span>);
  <span class="hljs-attr">--space-sm</span>: <span class="hljs-built_in">var</span>(--space-unit);
  <span class="hljs-attr">--space-md</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--space-unit) * <span class="hljs-number">2</span>);
  <span class="hljs-attr">--space-lg</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--space-unit) * <span class="hljs-number">3</span>);
}
</code></pre>
<h3 data-id="heading-13">3. 容器查询单位（实验性）</h3>
<p>CSS容器查询引入了<code>cqw</code>、<code>cqh</code>等单位，允许基于容器而非视口进行响应：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.card</span> {
  container-type: inline-size;
}

<span class="hljs-keyword">@container</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">400px</span>) {
  <span class="hljs-selector-class">.card-title</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">1rem</span>, <span class="hljs-number">2</span>cqw, <span class="hljs-number">1.5rem</span>);
  }
}
</code></pre>
<h2 data-id="heading-14">单位选择策略</h2>
<ol>
<li><strong>布局与间距</strong>：优先使用rem，确保可访问性缩放</li>
<li><strong>字体大小</strong>：rem为主，结合clamp()函数限制极值</li>
<li><strong>全屏元素</strong>：使用vh/vw实现视口相关尺寸</li>
<li><strong>栅格系统</strong>：Grid布局中使用fr，Flexbox中使用百分比或flex属性</li>
<li><strong>媒体查询</strong>：始终使用em单位，确保基于用户字体偏好</li>
</ol>
<h2 data-id="heading-15">结语</h2>
<p>随着CSS标准的不断演进，单位系统也变得越来越丰富和强大。理解每种单位的内在逻辑和适用场景，能够帮助我们在不同场景下做出最佳选择。在实际项目中，往往需要组合使用多种单位，发挥各自优势，才能构建出既美观又实用的响应式界面。</p>
<p>记住，没有“绝对最佳”的单位，只有在特定上下文中的“最合适”选择。通过实践和实验，您将逐渐形成自己的单位使用策略，创建出更具弹性和可维护性的前端代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析 React 项目架构：从文件结构到核心 API 的全面拆解]]></title>    <link>https://juejin.cn/post/7586622708998701096</link>    <guid>https://juejin.cn/post/7586622708998701096</guid>    <pubDate>2025-12-23T05:51:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586622708998701096" data-draft-id="7585866811717599259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析 React 项目架构：从文件结构到核心 API 的全面拆解"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-12-23T05:51:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA阿giao"/> <meta itemprop="url" content="https://juejin.cn/user/473218785740627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析 React 项目架构：从文件结构到核心 API 的全面拆解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/473218785740627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA阿giao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T05:51:11.000Z" title="Tue Dec 23 2025 05:51:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"> 引言</h2>
<p>欢迎来到 <strong>React 项目架构的深度解密之旅</strong>！本文将基于实际项目目录结构，结合六个源码文件内容，为你呈现一个<strong>完整、清晰、生动且极尽详细的现代 React 项目架构分析</strong>。我们将以图示为蓝本，逐层剖析每个文件的作用、技术选型背后的逻辑、API 的使用场景与设计哲学，并揭示整个项目的工程化思想。</p>
<hr/>
<h3 data-id="heading-1">图解项目结构：<code>react-demo</code> 目录全景</h3>
<p>首先，让我们从整体视角审视这个项目的物理结构：</p>
<pre><code class="hljs language-csharp" lang="csharp">react-demo/
├── node_modules/           <span class="hljs-meta"># 第三方依赖包（自动安装）</span>
├── <span class="hljs-keyword">public</span>/                 <span class="hljs-meta"># 静态资源根目录</span>
│   └── assets/             <span class="hljs-meta"># 公共静态资源</span>
│       └── react.svg       <span class="hljs-meta"># SVG 图标文件</span>
├── src/                    <span class="hljs-meta"># 源码主目录</span>
│   ├── assets/             <span class="hljs-meta"># 应用级静态资源（可选）</span>
│   │   └── react.svg       <span class="hljs-meta"># 可复用图标</span>
│   ├── pages/              <span class="hljs-meta"># 页面组件集合</span>
│   │   ├── About.jsx       <span class="hljs-meta"># 关于页面组件</span>
│   │   └── Home.jsx        <span class="hljs-meta"># 首页组件（含 API 调用）</span>
│   ├── router/             <span class="hljs-meta"># 路由配置模块</span>
│   │   └── index.jsx       <span class="hljs-meta"># 路由配置中心</span>
│   ├── App.css             <span class="hljs-meta"># 根组件样式</span>
│   ├── App.jsx             <span class="hljs-meta"># 根组件（导航 + 路由容器）</span>
│   ├── index.css           <span class="hljs-meta"># 全局样式（CSS）</span>
│   ├── index.stylus        <span class="hljs-meta"># 全局样式（Stylus 预处理器）</span>
│   ├── main.jsx            <span class="hljs-meta"># 应用入口文件</span>
│   └── vite.config.js      <span class="hljs-meta"># Vite 构建配置</span>
├── .gitignore              <span class="hljs-meta"># Git 忽略规则</span>
├── eslint.config.js        <span class="hljs-meta"># ESLint 代码规范配置</span>
├── index.html              <span class="hljs-meta"># HTML 入口模板</span>
├── package-<span class="hljs-keyword">lock</span>.json       <span class="hljs-meta"># 依赖锁定文件</span>
├── package.json            <span class="hljs-meta"># 项目配置与依赖声明</span>
├── README.md               <span class="hljs-meta"># 项目文档（含搭建流程）</span>
└── vite.config.js          <span class="hljs-meta"># Vite 构建工具配置</span>
</code></pre>
<blockquote>
<p>小贴士：<code>src/</code> 是开发的核心区域，其余如 <code>public/</code>、<code>package.json</code> 等是构建和部署支撑系统。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">架构概览：现代 React 项目的“五脏六腑”</h3>
<p>我们可以把整个项目比作一个人体：</p>








































<table><thead><tr><th>组件</th><th>类比</th><th>功能</th></tr></thead><tbody><tr><td><code>main.jsx</code></td><td>心脏</td><td>启动应用，连接 React 与 DOM</td></tr><tr><td><code>App.jsx</code></td><td>大脑</td><td>控制全局 UI 结构与路由调度</td></tr><tr><td><code>router/index.jsx</code></td><td>神经系统</td><td>实现页面跳转与路径匹配</td></tr><tr><td><code>pages/*</code></td><td>肢体</td><td>承载具体业务逻辑与视图</td></tr><tr><td><code>index.stylus/css</code></td><td>衣服</td><td>提供视觉风格与样式统一</td></tr><tr><td><code>vite.config.js</code></td><td>呼吸系统</td><td>支持开发时编译、热更新等</td></tr></tbody></table>
<p>接下来，我们逐一深入每一个器官！</p>
<hr/>
<h3 data-id="heading-3">1. 应用入口：<code>main.jsx</code> —— 生命的起点</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 严格模式会执行两次，一次是执行，一次是测试 review</span>
<span class="hljs-comment">// import { StrictMode } from 'react'</span>

<span class="hljs-comment">// 导入createRoot，用于创建根节点</span>
<span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>

<span class="hljs-comment">// vite帮我们将stylus编译成css</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./index.stylus'</span> <span class="hljs-comment">// 全局样式 stylus</span>
<span class="hljs-comment">// 或者</span>
<span class="hljs-comment">// import './index.css' // 全局样式 css</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.jsx'</span> <span class="hljs-comment">// 引入了组件</span>

<span class="hljs-comment">// 创建根节点，将 App 组件渲染到 root 元素中</span>
<span class="hljs-comment">// 将 App 组件挂载到root 的元素上，渲染render</span>
<span class="hljs-comment">// 类似于Vue中的createApp(App).mount('#root')</span>
<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>)).<span class="hljs-title function_">render</span>(
  <span class="hljs-comment">// 函数组件的名字 类HTML标签 自定义组件</span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>
  <span class="hljs-comment">// jsx</span>
)
</code></pre>
<h4 data-id="heading-4">详细解析：</h4>
<h5 data-id="heading-5">✅ <code>createRoot()</code>：React 18 的并发渲染引擎</h5>
<ul>
<li>
<p>替代旧版 <code>ReactDOM.render()</code>。</p>
</li>
<li>
<p>支持 <strong>并发模式</strong>（Concurrent Mode）：允许 React 在渲染过程中中断并优先处理高优先级任务（如用户输入）。</p>
</li>
<li>
<p>使用方式：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">root</span> = createRoot(document.getElementById(<span class="hljs-string">'root'</span>))<span class="hljs-comment">;</span>
root.render(&lt;App /&gt;)<span class="hljs-comment">;</span>
</code></pre>
<p>这种方式支持后续的 <code>root.unmount()</code> 和 <code>root.render(...)</code> 更新。</p>
</li>
</ul>
<h5 data-id="heading-6">✅ <code>import './index.stylus'</code></h5>
<ul>
<li>
<p>Stylus 是一种 CSS 预处理器，语法更简洁（类似 Sass）。</p>
</li>
<li>
<p>Vite 内置对 Stylus 的支持，无需额外插件即可编译为标准 CSS。</p>
</li>
<li>
<p>示例：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span>
  <span class="hljs-attribute">font-family</span> sans-serif
  <span class="hljs-attribute">background</span> <span class="hljs-selector-id">#f0f0f0</span>
</code></pre>
<p>编译后 → <code>&lt;style&gt;body{font-family:sans-serif;background:#f0f0f0}&lt;/style&gt;</code></p>
</li>
</ul>
<h5 data-id="heading-7">✅ 注释中的“彩蛋”：对比 Vue</h5>
<blockquote>
<p>“类似于 Vue 中的 <code>createApp(App).mount('#root')</code>”<br/>
这表明作者希望帮助跨框架开发者快速理解 React 的挂载机制，体现了良好的教学意识。</p>
</blockquote>
<h5 data-id="heading-8">❌ <code>StrictMode</code> 被注释</h5>
<ul>
<li>若启用，React 会在开发环境下<strong>故意双渲染组件</strong>，用于检测潜在问题（如不安全的副作用）。</li>
<li>生产环境不会触发，仅限开发调试。</li>
</ul>
<blockquote>
<p>💡 建议：在开发阶段开启 <code>StrictMode</code>，有助于提前发现隐患！</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">2. 根组件：<code>App.jsx</code> —— 整个 UI 的中枢</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">'./App.css'</span>
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">BrowserRouter</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Router</span>,
  <span class="hljs-title class_">Link</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AppRoutes</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./router/index.jsx'</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Router</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">AppRoutes</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Router</span>&gt;</span></span>
  )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>
</code></pre>
<h4 data-id="heading-10">详细解析：</h4>
<h4 data-id="heading-11">React 与 Vue 结构对照表总结</h4>





















<table><thead><tr><th>Vue SFC 部分</th><th>React (App.jsx) 对应部分</th></tr></thead><tbody><tr><td><code>&lt;template&gt;</code></td><td><code>return (...)</code> 中的 JSX</td></tr><tr><td><code>&lt;script&gt;</code></td><td>函数组件内部逻辑（Hooks、方法等）</td></tr><tr><td><code>&lt;style&gt;</code></td><td><code>import './App.css'</code> 或内联样式</td></tr></tbody></table>
<h5 data-id="heading-12">✅ <code>import { BrowserRouter as Router, Link } from 'react-router-dom'</code></h5>
<ul>
<li><strong>模块来源</strong>：第三方包 <code>react-router-dom</code>（已通过 <code>npm i react-router-dom</code> 安装）</li>
<li><strong>作用分解</strong>：</li>
</ul>





















<table><thead><tr><th>导入项</th><th>作用</th></tr></thead><tbody><tr><td><code>BrowserRouter</code></td><td>提供基于 HTML5 History API 的路由上下文。必须包裹整个应用才能使用 <code>Link</code> 和 <code>Route</code>。</td></tr><tr><td><code>as Router</code></td><td>使用别名简化 JSX 中的标签名（写 <code>&lt;Router&gt;</code> 而非 <code>&lt;BrowserRouter&gt;</code>）。</td></tr><tr><td><code>Link</code></td><td>客户端导航组件，点击时不刷新页面，实现 SPA 跳转。</td></tr></tbody></table>
<ul>
<li><strong>为何需要 <code>react-router-dom</code>？</strong><br/>
React 本身不包含路由功能。<code>react-router-dom</code> 是官方推荐的 Web 端路由库，提供完整的前端路由解决方案。</li>
</ul>
<blockquote>
<p>🛠️ 技术细节：<code>BrowserRouter</code> 内部使用 <code>window.history</code> API 管理 URL，需服务器支持（Vite 开发服务器已内置）。</p>
</blockquote>
<h5 data-id="heading-13">✅ <code>BrowserRouter as Router</code></h5>
<ul>
<li>使用 HTML5 History API 实现 URL 路径，例如：<code>http://localhost:5173/about</code></li>
<li>不再需要 <code>#</code> 哈希片段（<code>#/about</code>），URL 更美观、SEO 更友好。</li>
<li>需要服务器支持（Vite 开发服务器已内置支持）。</li>
</ul>
<blockquote>
<p>为什么不用 <code>HashRouter</code>？因为哈希路由丑陋且不利于 SEO，只适合简单演示或旧浏览器兼容。</p>
</blockquote>
<h5 data-id="heading-14">✅ <code>Link</code> 组件 vs <code>&lt;a&gt;</code></h5>






























<table><thead><tr><th>特性</th><th><code>&lt;a&gt;</code></th><th><code>&lt;Link&gt;</code></th></tr></thead><tbody><tr><td>是否刷新页面</td><td>✅ 是</td><td>❌ 否</td></tr><tr><td>是否触发 SPA 导航</td><td>❌ 否</td><td>✅ 是</td></tr><tr><td>是否支持路由参数</td><td>❌ 否</td><td>✅ 是</td></tr><tr><td>是否能传递状态</td><td>❌ 否</td><td>✅ 是（通过 <code>state</code> 属性）</td></tr></tbody></table>
<blockquote>
<p><code>Link</code> 是 React Router 的“官方导航”，它内部使用 <code>history.pushState()</code> 完成客户端跳转，避免整页重载。</p>
</blockquote>
<h5 data-id="heading-15">✅ <code>AppRoutes</code>：路由子组件</h5>
<ul>
<li>从 <code>./router/index.jsx</code> 导入，实现“职责分离”。</li>
<li>让 <code>App.jsx</code> 专注于布局和导航，而不关心具体路由逻辑。</li>
</ul>
<h5 data-id="heading-16">✅ <code>&lt;nav&gt;</code> 导航栏设计</h5>
<ul>
<li>使用语义化标签 <code>&lt;nav&gt;</code> 和 <code>&lt;ul&gt;/&lt;li&gt;</code> 构建无障碍友好的导航菜单。</li>
<li>每个 <code>&lt;Link&gt;</code> 都对应一个页面路径。</li>
</ul>
<blockquote>
<p>设计理念：<strong>UI 与逻辑分离，组件扁平化管理</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-17">3. 路由中枢：<code>router/index.jsx</code> —— 页面切换的指挥官</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Routes</span>, <span class="hljs-title class_">Route</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/Home.jsx'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/About.jsx'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AppRoutes</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/about"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">About</span> /&gt;</span>} /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-18">详细解析：</h4>
<h5 data-id="heading-19">✅ <code>Routes</code>：路由容器</h5>
<ul>
<li>包裹所有 <code>&lt;Route&gt;</code>，负责匹配当前 URL 并决定渲染哪个组件。</li>
<li>v6 中取代了旧版的 <code>Switch</code>，功能更强，支持嵌套路由。</li>
</ul>
<h5 data-id="heading-20">✅ <code>Route</code>：路由规则定义</h5>





















<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td><code>path</code></td><td>匹配的 URL 路径（支持通配符 <code>/user/:id</code>）</td></tr><tr><td><code>element</code></td><td>渲染的 JSX 元素（注意：必须是 JSX，不能是组件引用）</td></tr><tr><td><code>children</code></td><td>嵌套路由（v6 新增）</td></tr></tbody></table>
<blockquote>
<p>⚠️ 注意：<code>element={&lt;Home /&gt;}</code> 是 JSX 表达式，不是 <code>element={Home}</code>！后者会导致错误。</p>
</blockquote>
<h5 data-id="heading-21">✅ 路径匹配规则</h5>





















<table><thead><tr><th>路径</th><th>匹配情况</th></tr></thead><tbody><tr><td><code>/</code></td><td>匹配首页</td></tr><tr><td><code>/about</code></td><td>匹配关于页</td></tr><tr><td><code>/home</code></td><td>不匹配（没有定义）</td></tr></tbody></table>
<blockquote>
<p>🔄 如果多个 <code>&lt;Route&gt;</code> 匹配同一路径，React Router 会按顺序选择第一个匹配项。</p>
</blockquote>
<h5 data-id="heading-22">✅ <code>import Home from '../pages/Home.jsx'</code></h5>
<ul>
<li>
<p><strong>模块来源</strong>：本地页面组件（相对路径）</p>
</li>
<li>
<p><strong>作用</strong>：</p>
<ul>
<li>引入首页组件。</li>
<li>作为 <code>/</code> 路径的渲染内容。</li>
</ul>
</li>
<li>
<p><strong>路径说明</strong>：<code>../pages/</code> 表示从 <code>router/</code> 目录向上一级，再进入 <code>pages/</code>。</p>
</li>
</ul>
<blockquote>
<p>📁 目录规范：<code>pages/</code> 是约定俗成的页面组件存放位置，便于识别“页面级” vs “通用组件”。</p>
</blockquote>
<hr/>
<h5 data-id="heading-23">✅ <code>import About from '../pages/About.jsx'</code></h5>
<ul>
<li>
<p><strong>模块来源</strong>：同上</p>
</li>
<li>
<p><strong>作用</strong>：</p>
<ul>
<li>引入关于页组件。</li>
<li>作为 <code>/about</code> 路径的渲染内容。</li>
</ul>
</li>
<li>
<p><strong>设计一致性</strong>：所有页面组件统一放在 <code>pages/</code> 下，结构清晰。</p>
</li>
</ul>
<blockquote>
<p>✅ 工程建议：大型项目可进一步按功能划分 <code>pages/user/</code>, <code>pages/admin/</code> 等子目录。</p>
</blockquote>
<hr/>
<h3 data-id="heading-24">4. 首页组件：<code>Home.jsx</code> —— 数据驱动的实战典范</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> {
  useState,
  useEffect
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Home</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [repos, setRepos] = <span class="hljs-title function_">useState</span>([])
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件初始化'</span>)
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件挂载后'</span>)
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.github.com/users/octocat/repos'</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        <span class="hljs-title function_">setRepos</span>(data)
      })
  }, [])
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {
        repos.length ? (
          <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
            {
              repos.map(repo =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{repo.id}</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">{repo.html_url}</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"noreferrer"</span>&gt;</span>
                    {repo.name}
                  <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
              ))
            }
          <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
        ) : (
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>暂无仓库<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        )
      }
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Home</span>
</code></pre>
<h4 data-id="heading-25">详细解析：</h4>
<h5 data-id="heading-26">✅ <code>useState</code>：响应式状态管理</h5>
<ul>
<li><code>const [repos, setRepos] = useState([])</code> 创建一个可变的状态变量。</li>
<li>当调用 <code>setRepos(data)</code> 时，React 会重新渲染组件。</li>
<li><strong>状态是局部的</strong>，不会影响其他组件。</li>
</ul>
<blockquote>
<p>🧠 类比：就像 Vue 的 <code>data()</code> 方法，但更轻量、更灵活。</p>
</blockquote>
<h5 data-id="heading-27">✅ <code>useEffect</code>：副作用钩子</h5>
<ul>
<li>用于处理异步操作、订阅、定时器等“非渲染”行为。</li>
<li>参数：<code>(callback, deps)</code>，其中 <code>deps</code> 是依赖数组。</li>
<li>当 <code>deps</code> 为空数组 <code>[]</code> 时，表示<strong>仅在组件挂载后执行一次</strong>，相当于 <code>componentDidMount</code>。</li>
</ul>
<blockquote>
<p>🚫 错误写法：</p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-built_in">fetch</span>('/api/data')<span class="hljs-selector-class">.then</span>(data =&gt; setRepos(data))
}, <span class="hljs-selector-attr">[]</span>) <span class="hljs-comment">// ✅ 正确</span>
</code></pre>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-built_in">fetch</span>('/api/data')<span class="hljs-selector-class">.then</span>(data =&gt; setRepos(data))
}) <span class="hljs-comment">// ❌ 会无限循环！因为没有依赖控制</span>
</code></pre>
<h5 data-id="heading-28">✅ GitHub API 请求详解</h5>
<ul>
<li>地址：<code>https://api.github.com/users/octocat/repos</code></li>
<li>返回：JSON 数组，包含用户的所有公开仓库。</li>
<li>示例数据结构：</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {    <span class="hljs-string">"id"</span>: 12345,    <span class="hljs-string">"name"</span>: <span class="hljs-string">"hello-world"</span>,    <span class="hljs-string">"html_url"</span>: <span class="hljs-string">"https://github.com/octocat/hello-world"</span>  }]</span>
</code></pre>
<h5 data-id="heading-29">✅ 条件渲染与列表映射</h5>
<ul>
<li>使用三元运算符判断是否有数据。</li>
<li>使用 <code>.map()</code> 遍历数组，生成 <code>&lt;li&gt;</code> 列表。</li>
<li><strong>关键点</strong>：<code>key={repo.id}</code> 是必需的，防止 React 无法追踪列表项变化导致的性能问题。</li>
</ul>
<blockquote>
<p>🔥 最佳实践：永远给列表项设置唯一 <code>key</code>！</p>
</blockquote>
<h5 data-id="heading-30">✅ 安全链接：<code>rel="noreferrer"</code></h5>
<ul>
<li>防止点击链接时泄露当前页面的 Referrer 信息。</li>
<li>避免被恶意网站利用进行攻击。</li>
<li>是现代 Web 安全的重要一环。</li>
</ul>
<hr/>
<h3 data-id="heading-31">5. 关于页面：<code>About.jsx</code> —— 极简主义的胜利</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">About</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">About</span>
</code></pre>
<h4 data-id="heading-32">详细解析：</h4>
<ul>
<li>
<p>虽然只有几行代码，但它展示了 React 的本质：</p>
<ul>
<li><strong>函数即组件</strong></li>
<li><strong>返回 JSX 即 UI</strong></li>
<li><strong>无需类、无需生命周期</strong></li>
</ul>
</li>
</ul>
<blockquote>
<p>🎯 哲学：<strong>最小可用单元</strong>（Minimum Viable Component），先完成再优化。</p>
</blockquote>
<hr/>
<h3 data-id="heading-33">6. 项目说明书：<code>README.md</code> —— 工程化的指南针</h3>
<pre><code class="hljs language-rust" lang="rust"># React 项目架构
- npm init vite
  - 从GitHub 拉取一个项目模板
  - npm run dev 启动项目 dev即development
    vite 就是开发阶段的脚手架
    test 测试阶段
    production 上线阶段
    development 开发阶段
    dev <span class="hljs-punctuation">-&gt;</span> test <span class="hljs-punctuation">-&gt;</span> production <span class="hljs-punctuation">-&gt;</span>dev <span class="hljs-punctuation">-&gt;</span> test <span class="hljs-punctuation">-&gt;</span> production
    devDependencies 开发阶段依赖:vite,stylus 开发期间使用
    命令语句：npm i -D stylus
    dependencies 项目依赖  
  - react 基建也交给vite
    - esm 模块化，极致的冷启动
    - npm install -D stylus
      - 安装stylus插件，用于编译stylus文件  -D 表示在开发阶段依赖
      - 安装后在package.json中可以看到devDependencies中多了stylus

- 项目依赖
  vue <span class="hljs-number">3.5</span>.<span class="hljs-number">24</span>
  <span class="hljs-string">"react"</span>: <span class="hljs-string">"^19.2.0"</span>, 第一的现代前端开发框架 响应式、组件化、数据绑定...
  <span class="hljs-string">"react-dom"</span>: <span class="hljs-string">"^19.2.0"</span>
  vue = <span class="hljs-title function_ invoke__">react</span>(core) + react-<span class="hljs-title function_ invoke__">dom</span>(component render dom)
- 引入路由
  - 安装路由
    - npm i react-router-dom
      安装后在package.json中可以看到dependencies中多了react-router-dom
  - 路由的配置
    - 在src目录下创建一个router目录，用于存放路由相关的文件
    - 在router目录下创建一个index.js文件，用于配置路由
  - 引入路由组件，导航，页面级别组件
    - import { BrowserRouter <span class="hljs-keyword">as</span> Router, Routes, Route } from <span class="hljs-symbol">'react</span>-router-dom'
</code></pre>
<h4 data-id="heading-34">详细解析：</h4>
<h5 data-id="heading-35">✅ <code>npm init vite</code>：快速启动</h5>
<ul>
<li>Vite 是现代前端构建工具，基于 ES Modules，启动速度极快。</li>
<li>支持 HMR（Hot Module Replacement），修改代码即时生效。</li>
</ul>
<h5 data-id="heading-36">✅ <code>devDependencies</code> vs <code>dependencies</code></h5>




















<table><thead><tr><th>类型</th><th>用途</th><th>示例</th></tr></thead><tbody><tr><td><code>devDependencies</code></td><td>开发工具</td><td><code>vite</code>, <code>stylus</code>, <code>eslint</code></td></tr><tr><td><code>dependencies</code></td><td>生产依赖</td><td><code>react</code>, <code>react-router-dom</code></td></tr></tbody></table>
<blockquote>
<p>💡 规则：生产环境中不需要的包都放在 <code>devDependencies</code>，减少打包体积。</p>
</blockquote>
<h5 data-id="heading-37">✅ <code>npm i -D stylus</code>：预处理器安装</h5>
<ul>
<li><code>-D</code> 是 <code>--save-dev</code> 的缩写。</li>
<li>安装后会在 <code>package.json</code> 中自动添加：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"stylus"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.55.0"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-38">✅ 类比教学法：“vue = react + react-dom”</h5>
<ul>
<li>
<p>用 Vue 的概念解释 React 的分工：</p>
<ul>
<li><code>react</code>：核心库（响应式、虚拟 DOM）</li>
<li><code>react-dom</code>：DOM 渲染层（类似 Vue 的 <code>vue-runtime-dom</code>）</li>
</ul>
</li>
<li>
<p>有助于跨框架开发者快速理解 React 的分层架构。</p>
</li>
</ul>
<h5 data-id="heading-39">✅ 路由配置建议</h5>
<ul>
<li>创建 <code>src/router/</code> 目录，集中管理路由。</li>
<li>使用 <code>index.jsx</code> 作为路由入口，符合模块化命名规范。</li>
</ul>
<hr/>
<h3 data-id="heading-40">7. 其他重要文件详解</h3>
<h4 data-id="heading-41"><code>index.html</code>：HTML 模板</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"%PUBLIC_URL%/favicon.ico"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"theme-color"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"#000000"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"Web site created using create-react-app"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"apple-touch-icon"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"%PUBLIC_URL%/logo192.png"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"manifest"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"%PUBLIC_URL%/manifest.json"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>React App<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"root"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<ul>
<li><code>%PUBLIC_URL%</code> 是 Vite 的占位符，指向 <code>public/</code> 目录。</li>
<li><code>id="root"</code> 是 React 的挂载点，<code>main.jsx</code> 会将其替换为 <code>&lt;App /&gt;</code>。</li>
</ul>
<h4 data-id="heading-42"><code>vite.config.js</code>：构建配置</h4>
<pre><code class="hljs language-php" lang="php">export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">5173</span>
  },
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">outDir</span>: <span class="hljs-string">'dist'</span>
  }
})
</code></pre>
<ul>
<li><code>server.port</code>: 开发服务器端口（默认 5173）</li>
<li><code>build.outDir</code>: 构建输出目录（默认 <code>dist</code>）</li>
</ul>
<blockquote>
<p>✅ Vite 优势：无需 webpack，直接使用原生 ES Modules，编译更快。</p>
</blockquote>
<hr/>
<h3 data-id="heading-43">总结：现代 React 项目架构的五大支柱</h3>



































<table><thead><tr><th>支柱</th><th>技术实现</th><th>作用</th></tr></thead><tbody><tr><td><strong>1. 构建工具</strong></td><td>Vite</td><td>快速启动、HMR、ESM 原生支持</td></tr><tr><td><strong>2. 路由系统</strong></td><td>React Router v6</td><td>SPA 导航、路径匹配、组件切换</td></tr><tr><td><strong>3. 状态管理</strong></td><td><code>useState</code> + <code>useEffect</code></td><td>响应式数据、副作用控制</td></tr><tr><td><strong>4. 模块化结构</strong></td><td>ESM + 文件夹划分</td><td>代码清晰、易于维护</td></tr><tr><td><strong>5. 工程化配置</strong></td><td><code>package.json</code>, <code>vite.config.js</code></td><td>依赖管理、构建流程自动化</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-44">结语：不只是代码，更是思维的跃迁</h3>
<p>这个看似简单的 React 项目，实则蕴含着现代前端开发的全部精髓：</p>
<ul>
<li><strong>组件化</strong>：每个页面都是独立的组件。</li>
<li><strong>响应式</strong>：状态改变自动触发 UI 更新。</li>
<li><strong>工程化</strong>：Vite 提供了高效的开发体验。</li>
<li><strong>可扩展</strong>：结构清晰，未来可轻松接入 Redux、TypeScript、SSR 等。</li>
</ul>
<blockquote>
<p>“真正的架构之美，不在于复杂，而在于简洁中的秩序。” —— 一位资深前端工程师</p>
</blockquote>
<p>现在，你不仅读懂了每一行代码，更理解了它们之间的关系。下一步，你可以：</p>
<ul>
<li>添加更多页面</li>
<li>使用 TypeScript 增强类型安全</li>
<li>引入 Redux 管理全局状态</li>
<li>配置 SSR 服务端渲染</li>
<li>发布到 GitHub Pages 或 Vercel</li>
</ul>
<p>愿你在 React 的世界里，越走越远，越飞越高！🚀</p>
<p>完整项目链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FgiaoZou%2Flesson_zp%2Ftree%2Fmaster%2Freact%2Freact-demo" title="https://gitee.com/giaoZou/lesson_zp/tree/master/react/react-demo" target="_blank" ref="nofollow noopener noreferrer">lesson_zp: AI + 全栈学习仓库</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析 React 组件化开发：从 Props 通信到样式管理的进阶指南]]></title>    <link>https://juejin.cn/post/7586688485727043590</link>    <guid>https://juejin.cn/post/7586688485727043590</guid>    <pubDate>2025-12-23T05:57:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586688485727043590" data-draft-id="7586585688005541929" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析 React 组件化开发：从 Props 通信到样式管理的进阶指南"/> <meta itemprop="keywords" content="React.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-23T05:57:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="San30"/> <meta itemprop="url" content="https://juejin.cn/user/1766294768060816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析 React 组件化开发：从 Props 通信到样式管理的进阶指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1766294768060816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    San30
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T05:57:06.000Z" title="Tue Dec 23 2025 05:57:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在现代前端开发的版图中，React 无疑是最具影响力的 UI 库之一。它引入的“组件化”思想，彻底改变了我们构建网页的方式。React 开发就像“拼积木”一样，通过将页面拆解为一个个独立、可复用的单元，极大地提升了开发效率与协作体验。</p>
<p>本文将结合具体的代码实例（如 <code>Greeting</code>、<code>Model</code>、<code>Card</code> 组件），深入探讨 React 入门阶段的核心知识点，包括 JSX 语法特性、Props 传值机制、组件复用模式以及多样化的样式管理方案。</p>
<h2 data-id="heading-1">一、 理解组件（Components）：构建 UI 的最小单元</h2>
<p>在 React 的世界里，<strong>一切皆组件</strong>。</p>
<h3 data-id="heading-2">1.1 组件的本质</h3>
<p>组件是开发任务的最小单元。正如我们在 <code>App.jsx</code> 中看到的，<code>App</code> 组件作为“老板”（根组件），负责调度和组合其他的“员工”组件（子组件）。</p>
<ul>
<li><strong>复用性</strong>：写好一个 <code>Card</code> 组件，可以在首页用，也可以在个人中心用。</li>
<li><strong>协作性</strong>：不同开发者可以并行开发不同的组件，最后组合在一起。</li>
<li><strong>嵌套结构</strong>：组件之间存在父子关系，形成了一棵庞大的组件树。</li>
</ul>
<h3 data-id="heading-3">1.2 函数式组件与解构赋值</h3>
<p>在<code>App.jsx</code>根组件中传递数据：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span>(
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"张三"</span> <span class="hljs-attr">message</span>=<span class="hljs-string">"欢迎学习React"</span> <span class="hljs-attr">showIcon</span> /&gt;</span></span>
    )
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<p>子组件获取接收数据的最现代的 React 组件写法：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ name, message = <span class="hljs-string">"Welcome!"</span>, showIcon }</span>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {showIcon &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>👋<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {name}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{message}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Greeting</span>;
</code></pre>
<p>这里使用了 <strong>ES6 对象的解构赋值</strong>。与其接收一个巨大的 <code>props</code> 对象，不如直接在参数位提取出 <code>name</code>、<code>message</code> 和 <code>showIcon</code>。这种写法不仅简洁，还允许我们直接为 <code>message</code> 设置默认值（Default Parameters）。</p>
<h2 data-id="heading-4">二、 核心通信机制：Props（属性）</h2>
<p>如果说组件是积木，那么 <strong>Props</strong> 就是连接积木的榫卯。</p>
<h3 data-id="heading-5">2.1 什么是 Props？</h3>
<p>Props 是 "Properties" 的缩写。它是父组件向子组件传递数据的主要方式。有两点至关重要：</p>
<ol>
<li><strong>State vs Props</strong>：State 是组件自有的、可变的数据；而 Props 是外部传入的、<strong>只读</strong>的数据。</li>
<li><strong>单向数据流</strong>：数据永远是从父组件流向子组件，子组件无权修改 Props。</li>
</ol>
<h3 data-id="heading-6">2.2 Props 的多种形态</h3>
<p>Props 的灵活性：</p>
<ul>
<li><strong>传递字符串</strong>：<code>&lt;Greeting name="张三" /&gt;</code></li>
<li><strong>传递布尔值</strong>：<code>&lt;Greeting showIcon /&gt;</code>（简写形式，等同于 <code>showIcon={true}</code>）</li>
<li><strong>传递表达式/数字</strong>：<code>&lt;Greeting name={123} /&gt;</code>（需使用花括号 <code>{}</code>）</li>
</ul>
<p>像上面这样，写在根组件中的子组件内的属性会成为<code>props</code>参数对象的属性，在之前的<code>react</code>开发中，在子组件我们可以在子组件中这样接收<code>props</code>参数对象：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {props.showIcon &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>👋<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {props.name}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{props.message}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Greeting</span>;
</code></pre>
<h3 data-id="heading-7">2.3 Props 类型检查：PropTypes</h3>
<p>为了保证组件的健壮性，<code>Greeting.jsx</code> 使用了 <code>prop-types</code> 库：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title class_">Greeting</span>.<span class="hljs-property">propTypes</span> = {
    <span class="hljs-attr">name</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">string</span>.<span class="hljs-property">isRequired</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">string</span>,
    <span class="hljs-attr">showIcon</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">bool</span>,
}
</code></pre>
<p>这就像一份“合同”，规定了外部必须传入字符串类型的 <code>name</code>并且<code>name</code>要是必须传递的，因为加了<code>string</code>类型要求和<code>isRequired</code>必传属性，否则控制台会抛出相应的警告。这在大型团队协作中尤为重要。</p>
<h2 data-id="heading-8">三、 JSX 的魔法：JS in JSX 与 逻辑渲染</h2>
<p>JSX 允许我们在 JavaScript 中编写类似 HTML 的代码。但它本质上是 <code>React.createElement</code> 的语法糖。</p>
<h3 data-id="heading-9">3.1 变量插值与逻辑表达式</h3>
<ul>
<li><strong>内容插值</strong>：<code>{props.name}</code> 将 JS 变量渲染到 HTML 中。</li>
<li><strong>条件渲染</strong>：<code>{showIcon &amp;&amp; &lt;span&gt;👋&lt;/span&gt;}</code>。这是 JS “短路运算”的妙用，如果 <code>showIcon</code> 为真，则渲染图标。</li>
</ul>
<h3 data-id="heading-10">3.2 关键字避让</h3>
<p>由于 JSX 最终会编译成 JS，因此 HTML 属性名不能与 JS 关键字冲突。</p>
<ul>
<li><code>class</code> 必须写成 <code>className</code></li>
<li><code>for</code> 必须写成 <code>htmlFor</code>。</li>
</ul>
<h2 data-id="heading-11">四、 高级组件模式：Children 与插槽</h2>
<p>有时我们希望组件不仅能接收数据，还能接收“一段内容”。</p>
<h3 data-id="heading-12">4.1 props.children</h3>
<p>其中 <code>children</code> 的应用：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Card</span> = (<span class="hljs-params">{ className = <span class="hljs-string">''</span>, children }</span>) =&gt; {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">card</span> ${<span class="hljs-attr">className</span>}`}&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Card</span>;
</code></pre>
<p>当你在 <code>App.jsx</code> 中这样调用时：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">&lt;<span class="hljs-title class_">Card</span> className=<span class="hljs-string">"user-card"</span>&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>张三<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>高级前端工程师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Card</span>&gt;
</code></pre>
<p><code>&lt;h2&gt;</code> 和 <code>&lt;p&gt;</code> 标签会自动成为 <code>Card</code> 组件的<code>props</code>参数对象的 <code>children</code> 属性。这种模式极大增强了组件的<strong>通用性</strong>。</p>
<h3 data-id="heading-13">4.2 渲染属性（Render Props / Component Injection）</h3>
<p>更高阶的技巧：<strong>将组件作为 Props 传递</strong>。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Model</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-keyword">const</span> { <span class="hljs-title class_">HeaderComponent</span>, <span class="hljs-title class_">FooterComponent</span>, children } = props;
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.overlay}</span>&gt;</span>
            {HeaderComponent &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">HeaderComponent</span> /&gt;</span>}
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            {FooterComponent &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">FooterComponent</span> /&gt;</span>}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">const</span> styles = {
    <span class="hljs-attr">overlay</span>: {
        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'rgba(0, 0, 0, 0.5)'</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">'fixed'</span>,
        <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">right</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">bottom</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">display</span>: <span class="hljs-string">'flex'</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
    }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Model</span>;
</code></pre>
<p>在<code>App.jsx</code>中这样定义</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">MyHeader</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{margin:</span> <span class="hljs-attr">0</span>, <span class="hljs-attr">color:</span> '<span class="hljs-attr">lightblue</span>'}}&gt;</span> 自定义标题 <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>
  )
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">MyFooter</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{textAlign:</span> '<span class="hljs-attr">right</span>'}}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> alert('关闭弹窗')} style={{padding: '0.5rem 1rem'}}&gt;关闭弹窗<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
&lt;<span class="hljs-title class_">Model</span>
<span class="hljs-title class_">HeaderComponent</span>={<span class="hljs-title class_">MyHeader</span>}
<span class="hljs-title class_">FooterComponent</span>={<span class="hljs-title class_">MyFooter</span>}
&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个弹窗<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>你可以在这里显示任何JSX<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Model</span>&gt; 
</code></pre>
<p>这种设计模式允许调用者完全自定义弹窗的头部（<code>HeaderComponent</code>）和底部（<code>FooterComponent</code>），而 <code>Model</code> 组件只负责布局逻辑和弹窗遮罩的展示。</p>
<h2 data-id="heading-14">五、 样式管理：多样化的 CSS 方案</h2>
<p>下面将展示两种主流的样式处理方式。</p>
<h3 data-id="heading-15">5.1 传统 CSS 与 Class 组合（<code>Card.css</code>）</h3>
<p>这是最符合传统开发习惯的方式。通过<strong>外部 CSS 文件</strong>定义样式，并利用 <code>className</code> 进行关联。</p>
<ul>
<li><strong>动态类名</strong>：在 <code>Card.jsx</code> 中，使用了模板字符串 <code>${className}</code>。这允许外部在使用 <code>Card</code> 时注入额外的类名（如 <code>user-card</code>），从而实现样式的覆盖和扩展。</li>
<li><strong>交互效果</strong>：<code>Card.css</code> 中利用 <code>.card:hover</code> 实现了浮动阴影效果，展示了传统 CSS 在处理伪类时的便捷。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'./Card.css'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Card</span> = (<span class="hljs-params">{ className = <span class="hljs-string">''</span>, children }</span>) =&gt; {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">card</span> ${<span class="hljs-attr">className</span>}`}&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Card</span>;
</code></pre>
<h3 data-id="heading-16">5.2 CSS in JS（<code>Model.jsx</code>）</h3>
<p>在 <code>Model.jsx</code> 中，样式是直接定义在 JS 对象里的：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> styles = {
    <span class="hljs-attr">overlay</span>: {
        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'rgba(0, 0, 0, 0.5)'</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">'fixed'</span>,
        <span class="hljs-comment">// ... 其他样式</span>
    }
}
</code></pre>
<p>如何调用？
<code>&lt;div style={styles.overlay}&gt;</code></p>
<p><strong>优点：</strong></p>
<ol>
<li><strong>逻辑绑定</strong>：样式与组件逻辑紧密结合，不担心类名冲突（局部作用域）。</li>
<li><strong>动态计算</strong>：可以根据 Props 轻松计算样式（例如：<code>color: props.isError ? 'red' : 'blue'</code>）。</li>
<li><strong>自包含</strong>：组件搬到哪里，样式就跟到哪里，无需额外引入 CSS 文件。</li>
</ol>
<h2 data-id="heading-17">六、 实战分析：构建一个可定制的 Card 系统</h2>
<p>通过分析这几个文件，我们可以梳理出构建高质量 React 组件的链路：</p>
<ol>
<li><strong>定义结构</strong>：使用 JSX 编写 HTML 骨架。</li>
<li><strong>提炼属性</strong>：确定哪些数据是变化的（name, message），将其设计为 Props。</li>
<li><strong>增强弹性</strong>：利用 <code>children</code> 允许外部注入内容，利用 <code>Component Props</code> 允许外部注入组件。</li>
<li><strong>规范约束</strong>：引入 <code>PropTypes</code> 进行类型校验。</li>
<li><strong>外观封装</strong>：结合 CSS 或 CSS in JS，并提供 <code>className</code> 接口供外部微调。</li>
</ol>
<h2 data-id="heading-18">七、 总结</h2>
<p>React 的学习曲线初看略陡，但只要掌握了 <strong>组件化</strong> 和 <strong>Props</strong> 这两个核心概念，剩下的就是对 JavaScript 基础的运用。</p>
<ul>
<li><strong>JSX</strong> 让我们拥有了在 UI 中自由运用 JS 逻辑的能力。</li>
<li><strong>Props</strong> 建立了组件间的契约，让数据流动变得清晰、可预测。</li>
<li><strong>Children 机制</strong> 则赋予了组件无限的扩展可能。</li>
</ul>
<p>无论是 <code>Greeting</code> 的简单传参，还是 <code>Model</code> 的组件注入，亦或是 <code>Card</code> 的样式混入，本质上都在解决同一个问题：<strong>如何在保持组件独立性的同时，最大化其复用性。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【实景三维】还再为渲染发愁？手把手教你大场景如何实现“精细”与“流畅”平衡！]]></title>    <link>https://juejin.cn/post/7586617459487588404</link>    <guid>https://juejin.cn/post/7586617459487588404</guid>    <pubDate>2025-12-23T06:08:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586617459487588404" data-draft-id="7586587644824092706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【实景三维】还再为渲染发愁？手把手教你大场景如何实现“精细”与“流畅”平衡！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T06:08:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapmost"/> <meta itemprop="url" content="https://juejin.cn/user/1679709496936343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【实景三维】还再为渲染发愁？手把手教你大场景如何实现“精细”与“流畅”平衡！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709496936343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapmost
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:08:25.000Z" title="Tue Dec 23 2025 06:08:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你需要搭建一个600平方公里的倾斜场景，要求近距离查看建筑细节时，墙面纹理、门窗结构清晰可辨；切换到大范围飞行漫游时，画面流畅不卡顿。那么，可以试试<strong>Mapmost</strong>，轻松实现**“近看精细、远飞流畅”**的效果。</p>
<p>当然，为了能让大家更好地应用<strong>Mapmost</strong>，我们今天来讲讲倾斜服务(3DTiles)渲染“背后”的故事。</p>
<p>首先，我们一起来了解一下两个基础概念——<strong>几何误差(GE)<strong>和</strong>屏幕空间误差(SSE)</strong>。</p>
<h2 data-id="heading-0">一、基础概念：GE与SSE到底是什么？</h2>
<p><strong>1. 几何误差(GE，Geometric Error)</strong></p>
<ul>
<li><strong>定义：<strong>GeometricError是3DTiles数据自带的属性，即在倾斜数据预处理(几何体简化或分块)过程中产生的数值，用来描述简化后</strong>几何体与原始几何体之间的偏差</strong>，简单说就是模型简化程度的量化值。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bc6687d932e44bc86115b32beffeb0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074905&amp;x-signature=MWtogx0MZmTYShUOxKIeYl2Nypo%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>作用：<strong>GeometricError</strong>越大</strong>，与原始几何体差距越大，<strong>细节损失越多</strong>；GeometricError<strong>越小</strong>，模型越贴近原始形态，<strong>细节越丰富</strong>。</li>
</ul>
<h3 data-id="heading-1">2. 屏幕空间误差(SSE，Screen-Space Error)</h3>
<ul>
<li><strong>定义：<strong>SSE是原始几何体与简化几何体映射到屏幕上的</strong>像素级偏差</strong>。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e96bf8c78f4a959adabaae8c337f18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074905&amp;x-signature=iATJ2Euk87esOqqecM0B%2Fg0hWOU%3D" alt="" loading="lazy"/></p>
<p>对3DTiles数据，可直接基于GeometricError以及相机与瓦片的距离、屏幕分辨率、视场角等实时参数动态计算得出SSE。</p>
<p>二者的转换关系示意图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42c45c4aa5b34392b12e5ed345960510~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074905&amp;x-signature=bH1NDHX%2B0P%2BUSU1vpm7KCHAnc1Q%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>据此，可根据相似三角形以及三角函数的相关公式推知：</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6893709b02c04aa28c87f04ea233a530~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074905&amp;x-signature=hmcUg3ho5qBmkZYl4Zh2jMVfrTY%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>其中es为屏幕空间误差，eg为几何误差，H为以像素为单位的渲染窗口的高度，d为相机到瓦片中心之间的距离，θf为视场角的大小。</p>
</li>
<li>
<p><strong>作用：<strong>前端通常会预设</strong>最大屏幕空间误差阈值</strong>，当计算出的瓦片SSE大于该阈值时，系统会判定当前瓦片细节不足，自动加载GeometricError更小的精细瓦片。</p>
</li>
</ul>
<h2 data-id="heading-2">二、Mapmost核心配置</h2>
<p>Mapmost基于3DTiles标准，开放了控制全局精度的核心参数maximumScreenSpaceError，该参数控制了视野中所有瓦片的清晰程度。</p>
<ul>
<li>**参数名：**maximumScreenSpaceError</li>
<li><strong>作用：<strong>定义SSE的最大阈值(值＞0)，值越小，允许的屏幕像素误差越小，模型越精细，但性能消耗越大。该参数有一个</strong>默认值16</strong>，即当瓦片SSE超过16时，系统就会加载下一级更精细的瓦片。</li>
<li>**取值原则：**中高端设备可设得低一点，低端或者移动设备可设得高一点。</li>
<li><strong>不同设置性能对比实测：</strong></li>
</ul>
<p>maximumScreenSpaceError取值</p>
<p>视口内瓦片数量（个）</p>
<p>首屏加载时间（秒）</p>
<p>32</p>
<p>61</p>
<p>3.25</p>
<p>8</p>
<p>450</p>
<p>8.10</p>
<h2 data-id="heading-3">三、进阶优化：动态瓦片清晰度调整</h2>
<p>除了通过maximumScreenSpaceError控制全局精度，<strong>Mapmost</strong>还提供了另外三个参数对倾斜视角场景进行了针对性优化。</p>
<p><strong><em>1. enableDynamicTileAdjust</em></strong></p>
<ul>
<li>**取值范围：**true/false</li>
<li><strong>作用：<strong>开启后，相机倾斜时，会自动降低远处瓦片的SSE，从而</strong>降低瓦片清晰度</strong>以提升性能。</li>
</ul>
<p><strong><em>2. dynamicTileAdjustRange</em></strong></p>
<ul>
<li><strong>取值范围：</strong>[0,1]</li>
<li>**作用：**可控制瓦片模糊范围控制，值越大，表示从远及近瓦片模糊范围越大；值为0时全屏采用原精度的瓦片。仅当enableDynamicTileAdjust为true时生效。</li>
</ul>
<p><strong><em>3.dynamicTileAdjustFactor</em></strong></p>
<ul>
<li><strong>取值范围：</strong>[0,+∞)</li>
<li>**作用：**可调节模糊强度，值越大，瓦片模糊程度越高；值为0时等同于关闭该优化。仅当enableDynamicTileAdjust为true时生效。</li>
</ul>
<p><strong><em>4. 适用场景</em></strong></p>
<p>适合<strong>大范围倾斜浏览、移动巡检、飞行漫游</strong>等场景，这类场景中远处瓦片占比大但无需精细显示，优化后可大幅缩短视野内倾斜瓦片的更新时间，如当在地图上平移或缩放时，倾斜模型的画面刷新时间可<strong>缩减30%以上</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c97621d96a9d4291bcaf315454f17d3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074905&amp;x-signature=whkp12NDvvYuNEgGaSATG33%2FTvk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">四、结语</h2>
<p>几何误差(GE)作为3DTiles数据侧的<strong>简化基准</strong>，与屏幕空间误差(SSE)这一屏幕侧的视觉反馈，共同构成了<strong>可视化精度与性能平衡的核心逻辑</strong>。<strong>Mapmost</strong>精准把握二者关联，通过灵活的参数配置，让不同场景下的误差控制与性能优化更贴合实际需求，轻松实现**“清晰不卡顿、流畅不模糊”**的体验，是大规模三维地理空间数据可视化项目的可靠选择。</p>
<p>立即体验，开始三维开发之旅！<br/>
👉 点击访问官网免费试用：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mapmost.com%2F%23%2Flayout%2Fwebgl%2Fhome" target="_blank" title="https://www.mapmost.com/#/layout/webgl/home" ref="nofollow noopener noreferrer">Mapmost官网</a><br/>
👉 查看详细产品文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mapmost.com%2Fmapmost_docs%2Fwebgl%2Flatest%2Fdocs%2Fintro%2F" target="_blank" title="https://www.mapmost.com/mapmost_docs/webgl/latest/docs/intro/" ref="nofollow noopener noreferrer">产品概述 | Mapmost SDK for WebGL</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何用 Chrome DevTools 定位 Long Task：一份从零到实战的排查笔记]]></title>    <link>https://juejin.cn/post/7586684925106159659</link>    <guid>https://juejin.cn/post/7586684925106159659</guid>    <pubDate>2025-12-23T06:14:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586684925106159659" data-draft-id="7586688485727158278" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何用 Chrome DevTools 定位 Long Task：一份从零到实战的排查笔记"/> <meta itemprop="keywords" content="前端,性能优化"/> <meta itemprop="datePublished" content="2025-12-23T06:14:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sthenia"/> <meta itemprop="url" content="https://juejin.cn/user/4248168659951320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何用 Chrome DevTools 定位 Long Task：一份从零到实战的排查笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248168659951320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Sthenia
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:14:51.000Z" title="Tue Dec 23 2025 06:14:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">如何用 Chrome DevTools 定位 Long Task：一份从零到实战的排查笔记</h2>
<p>在上篇我们已经介绍过如何记录和分析页面性能指标，但是只是发现网页卡顿现象还不够，我们还需要进一步定位卡顿的具体原因，才能有针对性地进行优化。</p>
<p>首先我们得了解为什么网页会卡顿。</p>
<p>网页卡顿通常是由于主线程被长时间占用，导致浏览器无法及时响应用户的交互操作。这些长时间影响主线程的运行任务，会被 Chrome DevTools 提供了 Performance 面板捕捉到，来帮助我们识别这些长任务（Long Tasks），从而找出性能瓶颈。</p>
<h3 data-id="heading-1">什么是 Long Task？</h3>
<p>Long Task 是指在主线程上执行时间超过 50 毫秒的任务。当主线程被长时间占用时，浏览器无法及时响应用户的交互操作，导致页面卡顿。通过识别和优化这些 Long Task，可以显著提升页面的响应速度和用户体验。</p>
<h3 data-id="heading-2">环境准备</h3>
<p>windows 10 + Chrome 143.0.7499.147</p>
<h3 data-id="heading-3">1. 搭一个可复现的 Long Task Demo</h3>
<p>为方便讲解，我们先实现了一个典型的卡顿页面：</p>
<ol>
<li>页面有一个 canvas 小球左右匀速运动，并实时显示 FPS。</li>
<li>提供“制造卡顿”按钮，点击后在主线程执行同步的重计算：
<ol>
<li>大数组 sort（O(n log n)）</li>
<li>加上 while 忙等 + 数值迭代循环，确保单次执行 300–700ms。</li>
</ol>
</li>
<li>连续执行 5 次，动画明显掉帧，点击响应也变慢。</li>
</ol>
<p>这个 demo 有两个关键点：</p>
<ol>
<li>可视化：肉眼能看到动画卡顿，方便和性能曲线一一对应。</li>
<li>可定位：核心耗时集中在一个明确函数 blockMainThread 里，便于在 DevTools 中识别。</li>
</ol>
<p>下面是一个简化版的 Demo 代码示例（完整代码可以参考项目中的 <code>page-long-task.html</code>）：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"btn-stutter"</span>&gt;</span>制造卡顿（5 次）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"c"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"400"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"200"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"c"</span>);
  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);
  <span class="hljs-keyword">let</span> x = <span class="hljs-number">20</span>,
    dir = <span class="hljs-number">1</span>;

  <span class="hljs-comment">// 简单小球动画，用来观察掉帧</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"/>) {
    ctx.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);
    ctx.<span class="hljs-title function_">beginPath</span>();
    ctx.<span class="hljs-title function_">arc</span>(x, canvas.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>, <span class="hljs-number">18</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
    ctx.<span class="hljs-title function_">fill</span>();
    x += dir * <span class="hljs-number">3</span>;
    <span class="hljs-keyword">if</span> (x &gt; canvas.<span class="hljs-property">width</span> - <span class="hljs-number">20</span>) dir = -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">20</span>) dir = <span class="hljs-number">1</span>;
    <span class="hljs-title function_">requestAnimationFrame</span>(draw);
  }
  <span class="hljs-title function_">requestAnimationFrame</span>(draw);

  <span class="hljs-comment">// 核心：人为制造一个 300–600ms 的长任务</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">blockMainThread</span>(<span class="hljs-params">minMs = <span class="hljs-number">300</span>, maxMs = <span class="hljs-number">600</span></span>) {
    <span class="hljs-keyword">const</span> target = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * (maxMs - minMs + <span class="hljs-number">1</span>)) + minMs;
    <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">12000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>());
    arr.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a - b);
    <span class="hljs-keyword">while</span> (performance.<span class="hljs-title function_">now</span>() - start &lt; target) {
      <span class="hljs-keyword">let</span> v = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3000</span>; i++) {
        v += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(i) % <span class="hljs-number">1.2345</span>;
      }
    }
  }

  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"btn-stutter"</span>).<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
      <span class="hljs-title function_">blockMainThread</span>(<span class="hljs-number">350</span>, <span class="hljs-number">650</span>);
    }
  };
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">2. 用 Performance 面板捕获长任务</h3>
<p>在 Chrome 打开 Performance 面板进行一次完整录制的标准步骤：</p>
<ol>
<li>打开 Performance 面板，点击 Record 开始录制。</li>
<li>回到页面，点击“制造卡顿”按钮。</li>
<li>等到动画恢复流畅后点击 Stop 停止录制。</li>
<li>观察几个关键轨道：
<ul>
<li>Frames：是否有红线和 FPS 明显下降。</li>
<li>Main：是否出现宽度大于 50 ms 的长紫/黄块（Long Task）。</li>
<li>Interactions：是否能对齐上用户的点击等交互事件。</li>
</ul>
</li>
</ol>
<p>任意单个主线程任务耗时 超过 ~50 ms，都会被视为 Long Task，它会阻塞渲染和输入事件。</p>
<p>我们看下我们 performance 录制的结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7f26f29dda8435bbf3e07241da7d4e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=1194KcQERenRMxasTU75b8IBPAY%3D" alt="" loading="lazy"/></p>
<p>上面结果中，我们可以在 Bottom-up 面板中，时间主要是消耗在 blockMainThread，并且指向代码位置</p>
<h3 data-id="heading-5">3. 解读 Bottom-up 面板</h3>
<p><strong>3.1 Bottom‑up 是什么</strong></p>
<ul>
<li>Bottom‑up 顾名思义，从高到低按“谁最耗时”聚合排序，从热点函数开始向上汇总。
对比：
<ul>
<li>Call tree：从入口（事件、任务）往下看调用顺序。</li>
<li>Bottom‑up：从最耗时的叶子函数往上看“被谁调用”。</li>
</ul>
</li>
</ul>
<p>它非常适合用来回答：“这一段时间里，CPU 主要花在了哪些函数上？”</p>
<p><strong>3.2 Self time vs Total time</strong></p>
<ul>
<li>Self time：函数“自身”执行的独占时间（不含子调用）。</li>
<li>Total time：函数自身 + 所有子调用的累计时间</li>
</ul>
<p>例如上面的例子，我们可以看到 blockMainThread 函数 Self Time 和 Total Time 占用了这次长任务的绝大部分时间。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fd90d2c51d246f6920665f595c56020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=NKR3VYUjYbe5rDhV8a%2FvqDPC7Cw%3D" alt="" loading="lazy"/></p>
<ul>
<li>长任务耗时：2614.4ms</li>
<li>blockMainThread 耗时： 2605ms</li>
</ul>
<p>blockMainThread 几乎和长任务时间一致了，是导致卡顿产生的主要原因。</p>
<p>在新版的 chrome 中，甚至可以看到每段代码的具体耗时，点击 blockMainThread 右侧的源码就可以看到：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1027a98c87f244dbac1a4f4beb07a0eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=ut2O32FbHc5HTn73ufXRsiw4mRo%3D" alt="" loading="lazy"/></p>
<p>耗时主要是消耗在了这段代码</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">while</span> (performance.<span class="hljs-title function_">now</span>() - start &lt; target) {
  <span class="hljs-keyword">let</span> v = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3000</span>; i++) {
    v += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(i) % <span class="hljs-number">1.2345</span>;
  }
}
</code></pre>
<p>小结:</p>
<ol>
<li>Self 高、Total≈Self
→ 重活都在函数本体里（如大循环、忙等、同步解析）。我们的 blockMainThread 就是这种情况。</li>
<li>Self 低、Total 高
→ 它是“调度/包装层”，真正热点在子函数里（例如一个封装函数里面调了排序、布局、GC 等）。</li>
</ol>
<p>在 Bottom‑up 中：</p>
<ol>
<li>先按 Total 或 Self 排序，看前几名热点函数。</li>
<li>若 Self≈Total，优先怀疑这个函数本体的实现。</li>
<li>若 Self 低而 Total 高，展开看子节点或切到 Call tree 继续追踪。</li>
</ol>
<h3 data-id="heading-6">4. 解读 Call tree 面板</h3>
<p><strong>Call tree 是什么</strong></p>
<p>以树形结构查看函数的子调用和耗时，面板展示信息基本和 Bottom-up 一致。也可以发现页面耗时在哪里发生，例如上面的截图我们通过一步步展开，查看 self time 耗时高的事件是什么</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44b999c9268f40a0b589379105608059~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=52wHlI2Q%2FYIM7yJVifnJKwHrz%2Fo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">实战</h3>
<p>上面我们用 demo 演示了如何调试和发现导致网页卡顿的基本操作，实际上项目会比 demo 要复杂一些，接下来我会以实际项目更近一步演示如何发现卡顿以及解决。</p>
<p><strong>背景</strong></p>
<p>公司有一个 SaaS 项目经常被用户吐槽很卡，在我们经过了一系列的埋点后，发现页面确实卡顿率高达 40%</p>
<p><strong>目标</strong></p>
<p>找出页面为什么引起卡顿的 long tasks，并且优化。</p>
<p><strong>环境介绍</strong></p>
<ul>
<li>windows 10</li>
<li>Chrome 143.0.7499.147</li>
<li>项目 react 16.9 + element-react 1.4.34</li>
</ul>
<p>这个项目使用的 element-react 组件库已经非常旧了，并且已经很久都不更新了，初步怀疑是 element-react 组件导致的卡顿</p>
<h4 data-id="heading-8">1. 利用 performance 进行收集数据</h4>
<p>根据上面 long-task 调试方法：</p>
<ol>
<li>打开 performance 面板，开始录制</li>
<li>打开目标页面</li>
<li>页面准备好，数据加载后，停止录制。</li>
</ol>
<p>在我的项目中可以看到页面 main time-line 中确实有非常多的 long-task</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9d62d8b9d1841b1af2075cccd41329f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=WbmC7ZQoFoqgAN7H7%2B8ybBCT3s4%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">2. 根据 performance 分析卡顿</h4>
<p>在 Bottom-up 面板中，选择一个较大 long task，我们可以发现其中耗时较大的事件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29fa6a8b3d7148f18745350018282e41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=oaO%2FyH0SbKOeFMryA4fvxJAXra0%3D" alt="" loading="lazy"/></p>
<p>其中 mask，measure 时间耗时非常高，long task 1458.6ms, mask 自己耗时占 730ms，measure 自己耗时 315ms，但是这个事件无法展开，也无法定位到源码，那怎么产生这两个事件呢？</p>
<p>经过查阅 chrome<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fdevtools%2Fperformance%2Freference%3Fhl%3Dzh-cn" target="_blank" title="https://developer.chrome.com/docs/devtools/performance/reference?hl=zh-cn" ref="nofollow noopener noreferrer">文档</a>，才得知无法展开的事件属于浏览器内建（native）API，调用栈常被显示为“[unattributed]”或只到内建层，尤其在没有 SourceMap、被第三方库间接调用、或被 Ignore List/Blackbox 处理时，就看不到上层用户代码。</p>
<p>在 bottom-up 中，确实还有大量的其他内建 api 耗时，比如，Minor GC，appendChild。</p>
<p>上方截图中 mask，measure 是 performance api，怀疑是我们使用 performance 记录时，chrome 帮我们加的标记，所以先忽略继续看下一个耗时大的事件，而下一个 self time 耗时大的是 Recalculate style，并且是可以代码定位的，点击代码定位可以看到代码：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df97d4d9a7da4ceb9fd506186c21ef5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=nwNpCqIQredKrd%2BtHBdEzjuk31M%3D" alt="" loading="lazy"/></p>
<p>初步定位引起到卡顿的原因是 element-react -&gt; table 组件 -&gt; getScrollBarWidth 中计算 dom 宽度</p>
<h4 data-id="heading-10">真相大白</h4>
<p>虽然定位到 getScrollBarWidth 方法引起的，并且具体是计算 dom 宽度引起的卡顿，但是只是执行计算理应不会导致页面卡顿，是不是还是其他原因导致的卡顿？</p>
<p>继续分析，发现 getScrollBarWidth 方法是在 table 组件的 constructor 方法中调用的</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TableLayout</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span>&lt;
  <span class="hljs-title class_">TableLayoutProps</span>,
  <span class="hljs-title class_">TableLayoutState</span>
&gt; {
  <span class="hljs-keyword">static</span> childContextTypes = {
    <span class="hljs-attr">layout</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">any</span>,
  };

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props: TableLayoutProps</span>) {
    <span class="hljs-variable language_">super</span>(props);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = {
      <span class="hljs-attr">height</span>: props.<span class="hljs-property">height</span> || props.<span class="hljs-property">maxHeight</span> || <span class="hljs-literal">null</span>, <span class="hljs-comment">// Table's height or maxHeight prop</span>
      <span class="hljs-attr">gutterWidth</span>: <span class="hljs-title function_">getScrollBarWidth</span>(), <span class="hljs-comment">// ar</span>
      <span class="hljs-comment">// ...</span>
    };

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">resizeListener</span> = <span class="hljs-title function_">throttle</span>(<span class="hljs-number">50</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">scheduleLayout</span>();
    });
  }
}
</code></pre>
<p>按道理来说，constructor 方法是在组件初始化时调用的，应该是调用了一次 getScrollBarWidth 而已，不会导致卡顿，那为什么还会卡顿呢？</p>
<p>会不会是因为在组件更新时，getScrollBarWidth 被多次调用导致的卡顿？</p>
<p>抱着试试看的心态，我们在 element-table 组件中加了日志，</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'%c [ componentDidMount ]-41'</span>, <span class="hljs-string">'font-size:13px; background:pink; color:#bf2c9f;'</span>)
}
<span class="hljs-title function_">componentWillUnmount</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'%c [ componentWillUnmount ]-86'</span>, <span class="hljs-string">'font-size:13px; background:pink; color:#bf2c9f;'</span>)
}
</code></pre>
<p>发现确实是在组件更新时被多次调用了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac82424461a4437cb87b876f345fc76d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=yYdvKWfWzxwtySrfnSvdZ8tY8EY%3D" alt="" loading="lazy"/></p>
<p>被重载了200次...，相当于执行了200次 getScrollBarWidth中的计算节点宽度。</p>
<p>但是为什么会被重载200次呢？我继续分析 element-table 组件，既然是在constructor中调用到getScrollBarWidth方法，那应该是再往上追溯，应该是在调用elemenet-table组件时的业务逻辑导致重复渲染了多次，element-table 组件是无辜的，不要冤枉element。</p>
<p>然后我在业务代码中调用table组件时，代码是这样写的：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
 <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Table</span>
      // <span class="hljs-attr">....</span>
      <span class="hljs-attr">key</span>=<span class="hljs-string">{this.key++}</span>
      <span class="hljs-attr">colData</span>=<span class="hljs-string">{this.colData}</span>
      <span class="hljs-attr">datas</span>=<span class="hljs-string">{list}</span>
    /&gt;</span></span>
  );
}
</code></pre>
<p>问题很显然了，key 属性每次 render 时都会自增，导致 element-table 组件被重新渲染了 200 次，而 getScrollBarWidth 方法是在 constructor 中调用的。</p>
<p><strong>解决以及重新记录数据</strong></p>
<p>解决方法方法就很简单了，将 key 去掉。猜测以前加key应该是有些场景，table数据不更新导致table没有重新渲染，所以加了key来强制重新渲染，开发人员已经离职无从考证了，但是现在我们已经找到了问题的根源，就直接去掉 key 属性，重新运行项目。</p>
<p>重新执行 performance，发现已经没有Recalculate style了，long task 去掉mask 和 measure已经不算是long task了。</p>
<h3 data-id="heading-11">总结</h3>
<p>通过这次实战，我们成功定位并解决了页面卡顿的问题。主要步骤包括：</p>
<ol>
<li>使用 Chrome DevTools 的 Performance 面板捕获页面的长任务（Long Tasks）。</li>
<li>通过 Bottom-up 和 Call tree 面板分析长任务的具体原因，定位到耗时函数。</li>
<li>结合代码逻辑，找出导致函数多次调用的根本原因。</li>
<li>进行代码优化，重新测试确认问题解决。</li>
</ol>
<p>通过这种系统的方法，我们不仅解决了当前的性能问题，还为未来的性能优化提供了宝贵的经验。希望这篇文章能帮助大家更好地理解和应用 Chrome DevTools 来提升网页性能。</p>
<p>如果觉得有用的话麻烦“👍 赞”支持一下，谢谢！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react中useMemo和useCallback的使用场景]]></title>    <link>https://juejin.cn/post/7586584105742204978</link>    <guid>https://juejin.cn/post/7586584105742204978</guid>    <pubDate>2025-12-23T06:25:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586584105742204978" data-draft-id="7586663700900249609" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react中useMemo和useCallback的使用场景"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T06:25:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="user7142265964578"/> <meta itemprop="url" content="https://juejin.cn/user/2824011125884926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react中useMemo和useCallback的使用场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824011125884926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    user7142265964578
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:25:23.000Z" title="Tue Dec 23 2025 06:25:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">先说结论</h3>
<ol>
<li><strong>为了计算性能</strong>：遇到<strong>大数组遍历</strong>、<strong>复杂算法</strong> -&gt; 用 <code>useMemo</code>。</li>
<li><strong>为了引用稳定</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>要传给 <code>React.memo</code> 包裹的子组件的<strong>对象/数组</strong> -&gt; 用 <code>useMemo</code>。</li>
<li>要传给 <code>React.memo</code> 包裹的子组件的<strong>函数</strong> -&gt; 用 <code>useCallback</code>。</li>
<li>函数或对象要放进 <code>useEffect</code> <strong>的依赖数组</strong>里 -&gt; 用 <code>useMemo</code> <strong>/</strong> <code>useCallback</code>。</li>
</ul>
</li>
</ul>
<p>除此之外，直接写原生 JS 代码即可。</p>
<hr/>
<h3 data-id="heading-1">一、 什么时候使用 <code>useMemo</code>？</h3>
<p><code>useMemo</code> 的作用是<strong>缓存计算结果</strong>。</p>
<h4 data-id="heading-2">1. 进行昂贵的计算（Expensive Calculation）时</h4>
<p>如果你的组件内部有一个计算过程非常耗时（例如：遍历数万条数据、复杂的数学运算、图像处理），你不希望每次组件重新渲染（比如只是输入框打字）都重新计算一遍。</p>
<ul>
<li><strong>标准</strong>：如果计算耗时超过 1ms（肉眼不可见，但在低端设备累积会卡顿），或者处理数组长度很大。</li>
<li><strong>代码示例</strong>：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// ❌ 每次 render 都会运行，导致卡顿
const <span class="hljs-attr">filteredList</span> = hugeList.filter(item =&gt; item.includes(query))<span class="hljs-comment">;</span>

// ✅ 只有当 hugeList 或 query 变化时才重新计算
const <span class="hljs-attr">filteredList</span> = useMemo(() =&gt; {
  return hugeList.filter(<span class="hljs-attr">item</span> =&gt; item.includes(query))<span class="hljs-comment">;</span>
}, <span class="hljs-section">[hugeList, query]</span>)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-3">2. 防止子组件不必要的渲染（引用稳定性）</h4>
<p>这是最常见但也最容易被忽略的用法。<br/>
在 JavaScript 中，<code>{ a: 1 } !== { a: 1 }</code>（每次创建的对象引用地址不同）。<br/>
如果你的子组件使用了 <code>React.memo</code> 包裹，但你传给它的 props 是一个在父组件中动态生成的<strong>对象</strong>或<strong>数组</strong>，那么 <code>React.memo</code> 会失效，因为每次父组件渲染，生成的对象引用都变了。</p>
<ul>
<li><strong>代码示例</strong>：</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Parent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// ❌ 每次 Parent 渲染，config 都是一个新的对象引用</span>
  <span class="hljs-comment">// 导致 Child 认为 props 变了，从而强制重新渲染</span>
  <span class="hljs-keyword">const</span> config = { <span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span> }; 
  
  <span class="hljs-comment">// ✅ 缓存了对象引用，只有依赖变了引用才变</span>
  <span class="hljs-keyword">const</span> memoConfig = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span> }), []);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">config</span>=<span class="hljs-string">{memoConfig}</span> /&gt;</span></span>;
};

<span class="hljs-comment">// Child 被 memo 包裹</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Child</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ config }</span>) =&gt;</span> { ... });
</code></pre>
<hr/>
<h3 data-id="heading-4">二、 什么时候使用 <code>useCallback</code>？</h3>
<p><code>useCallback</code> 的作用是<strong>缓存函数引用</strong>。</p>
<p>它的核心用途<strong>只有一个</strong>：<strong>维持函数引用的稳定性，以配合</strong> <code>React.memo</code> <strong>或</strong> <code>useEffect</code> <strong>使用。</strong></p>
<h4 data-id="heading-5">1. 将函数传递给经过优化的子组件（React.memo）</h4>
<p>这是 <code>useCallback</code> 90% 的使用场景。<br/>
如果你把一个函数传给子组件，而子组件用了 <code>React.memo</code>，你不希望父组件渲染时，因为“函数是新创建的”而导致子组件也跟着渲染。</p>
<ul>
<li><strong>代码示例</strong>：</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Parent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// ❌ 每次 Parent 渲染，handleClick 都是一个全新的函数指针</span>
  <span class="hljs-comment">// 导致 BigList 组件的 props 发生变化，破坏了 React.memo 的效果</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Clicked'</span>);
  };

  <span class="hljs-comment">// ✅ 缓存函数引用，只要依赖不变，handleClick 永远是同一个引用</span>
  <span class="hljs-keyword">const</span> memoHandleClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Clicked'</span>);
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(c =&gt; c + 1)}&gt;加一<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      
      {/* 如果不传 memoHandleClick，这里的 memo 就白写了 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">BigList</span> <span class="hljs-attr">onItemClick</span>=<span class="hljs-string">{memoHandleClick}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
};

<span class="hljs-keyword">const</span> <span class="hljs-title class_">BigList</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ onItemClick }</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'BigList Rendered'</span>); <span class="hljs-comment">// 使用 useCallback 后，点击“加一”不会触发这里</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>List...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
});
</code></pre>
<h4 data-id="heading-6">2. 函数作为 <code>useEffect</code> 的依赖项时</h4>
<p>如果你的 <code>useEffect</code> 依赖于外部传入的一个函数，为了避免 <code>useEffect</code> 无限循环或者频繁触发，这个函数必须被 <code>useCallback</code> 包裹。</p>
<ul>
<li><strong>代码示例</strong>：</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">ChatRoom</span>({ roomId, createConnection }) {
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    const connection = <span class="hljs-built_in">createConnection</span>(roomId);
    connection<span class="hljs-selector-class">.connect</span>();
    return () =&gt; connection<span class="hljs-selector-class">.disconnect</span>();
  <span class="hljs-comment">// 如果 createConnection 没有被 useCallback 包裹，</span>
  <span class="hljs-comment">// 每次父组件渲染都会导致这里重跑，连接断开又重连</span>
  }, <span class="hljs-selector-attr">[roomId, createConnection]</span>); 
}
</code></pre>
<hr/>
<h3 data-id="heading-7">三、 什么时候不需要？（避坑指南）</h3>
<p>很多新手会把所有函数和变量都包上，<strong>这是错误的</strong>。</p>
<ol>
<li><strong>简单的计算</strong>：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">// ❌ 没必要，useMemo 本身也有开销（内存分配、依赖比较）
const <span class="hljs-attr">total</span> = useMemo(() =&gt; price * quantity, [price, quantity])<span class="hljs-comment">;</span>

// ✅ 直接算就好，JS 引擎算这种东西极快
const <span class="hljs-attr">total</span> = price * quantity<span class="hljs-comment">;</span>
</code></pre>
<ol start="2">
<li><strong>子组件没有使用</strong> <code>React.memo</code>：<br/>
如果子组件只是一个普通的 <code>div</code> 或者没有用 <code>memo</code> 包裹的组件，你给它传 <code>useCallback</code> 包裹的函数是<strong>完全浪费</strong>的。因为不管 props 变没变，子组件都会跟着父组件一起重新渲染。</li>
<li><strong>仅仅为了“看起来优化了”</strong> ：<br/>
<code>useMemo</code> 和 <code>useCallback</code> 会占用额外的内存，并且 React 需要在每次渲染时对比依赖数组。滥用会导致性能更差，代码可读性降低。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端水印实战：给你的页面穿上“隐形盔甲”]]></title>    <link>https://juejin.cn/post/7586680977855168575</link>    <guid>https://juejin.cn/post/7586680977855168575</guid>    <pubDate>2025-12-23T06:27:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586680977855168575" data-draft-id="7586680977855152191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 前端水印实战：给你的页面穿上“隐形盔甲”"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T06:27:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JS_Likers"/> <meta itemprop="url" content="https://juejin.cn/user/1377017277975032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             前端水印实战：给你的页面穿上“隐形盔甲”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1377017277975032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JS_Likers
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:27:50.000Z" title="Tue Dec 23 2025 06:27:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>欢迎使用我的小程序👇👇👇👇</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d25c4001b1b4e6e902dc1f8863bcef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSlNfTGlrZXJz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767076070&amp;x-signature=vg7%2BQlaT7ffX4smqMWMBnYtnyxk%3D" alt="small.png" loading="lazy"/></p>
<hr/>
<p>水印就像网页的“数字纹身”，既保护版权又不影响用户体验。今天我们来聊聊如何在前端优雅地添加水印，让敏感信息既可见又安全！</p>
<h2 data-id="heading-0">一、为什么需要水印？💭</h2>
<p>想象一下，你的内部数据分析页面被截图外泄了——如果有水印，就能立刻追踪到泄露源头！水印主要用途：</p>
<ul>
<li><strong>版权保护</strong>：防止图片、文档被滥用</li>
<li><strong>溯源追踪</strong>：内部系统截图可追溯责任人</li>
<li><strong>状态标识</strong>：区分测试/生产环境</li>
<li><strong>品牌展示</strong>：低调展示品牌信息</li>
</ul>
<h2 data-id="heading-1">二、水印实现方案对比 🆚</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[前端水印方案选择] --&gt; B{需求场景}
    
    B --&gt;|简单文字/logo| C[CSS背景水印]
    B --&gt;|动态内容/复杂效果| D[Canvas生成]
    B --&gt;|高清晰度/可缩放| E[SVG水印]
    
    C --&gt; C1[实现简单]
    C --&gt; C2[性能最优]
    
    D --&gt; D1[功能最强大]
    D --&gt; D2[可生成图片]
    
    E --&gt; E1[矢量不失真]
    E --&gt; E2[兼容性好]
</code></pre>
<h2 data-id="heading-2">三、实战：三种水印实现方式 ✨</h2>
<h3 data-id="heading-3">方案一：CSS背景水印（最简单！）</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.watermarked-page</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;
}

<span class="hljs-selector-class">.watermarked-page</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">pointer-events</span>: none; <span class="hljs-comment">/* 关键！让点击穿透 */</span>
  <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'data:image/svg+xml;utf8,&lt;svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"&gt;&lt;text x="20" y="40" transform="rotate(-45 100 100)" fill="rgba(0,0,0,0.1)" font-size="16"&gt;内部使用 严禁外传&lt;/text&gt;&lt;/svg&gt;'</span>);
  <span class="hljs-attribute">background-repeat</span>: repeat;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">9999</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"watermarked-page"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 你的页面内容 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><strong>优点</strong>：实现简单，性能好
<strong>缺点</strong>：水印内容固定，容易被移除</p>
<h3 data-id="heading-4">方案二：Canvas动态生成（最灵活！）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Watermark</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">text = <span class="hljs-string">'内部文档'</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = text
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>()
  }
  
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建画布生成水印图</span>
    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>)
    canvas.<span class="hljs-property">width</span> = <span class="hljs-number">200</span>
    canvas.<span class="hljs-property">height</span> = <span class="hljs-number">150</span>
    
    <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)
    ctx.<span class="hljs-title function_">rotate</span>(-<span class="hljs-number">20</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">180</span>)
    ctx.<span class="hljs-property">font</span> = <span class="hljs-string">'16px Microsoft Yahei'</span>
    ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'rgba(128, 128, 128, 0.1)'</span>
    ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span>, <span class="hljs-number">10</span>, <span class="hljs-number">80</span>)
    
    <span class="hljs-comment">// 将水印作为背景</span>
    <span class="hljs-keyword">const</span> watermarkDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)
    watermarkDiv.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background-image: url(<span class="hljs-subst">${canvas.toDataURL()}</span>);
      background-repeat: repeat;
      z-index: 9999;
    `</span>
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span> = watermarkDiv
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(watermarkDiv)
  }
  
  <span class="hljs-comment">// 添加用户信息</span>
  <span class="hljs-title function_">setUserInfo</span>(<span class="hljs-params">user</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = <span class="hljs-string">`<span class="hljs-subst">${user.name}</span> <span class="hljs-subst">${user.id}</span> <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleDateString()}</span>`</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">update</span>()
  }
  
  <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>.<span class="hljs-title function_">remove</span>()
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>()
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> watermark = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watermark</span>(<span class="hljs-string">'张三 - 2024-03-15'</span>)
</code></pre>
<h3 data-id="heading-5">方案三：SVG水印（最清晰！）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createSVGWatermark</span>(<span class="hljs-params">text, options = {}</span>) {
  <span class="hljs-keyword">const</span> { color = <span class="hljs-string">'rgba(0,0,0,0.1)'</span>, fontSize = <span class="hljs-number">16</span> } = options
  
  <span class="hljs-keyword">const</span> svg = <span class="hljs-string">`
    &lt;svg xmlns="http://www.w3.org/2000/svg" width="300" height="200"&gt;
      &lt;text 
        x="50%" 
        y="50%" 
        font-size="<span class="hljs-subst">${fontSize}</span>"
        fill="<span class="hljs-subst">${color}</span>"
        text-anchor="middle"
        transform="rotate(-45, 150, 100)"
        font-family="Arial"
      &gt;
        <span class="hljs-subst">${text}</span>
      &lt;/text&gt;
    &lt;/svg&gt;
  `</span>
  
  <span class="hljs-keyword">return</span> <span class="hljs-string">`url('data:image/svg+xml;utf8,<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(svg)}</span>')`</span>
}

<span class="hljs-comment">// 应用到页面</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">style</span>.<span class="hljs-property">backgroundImage</span> = <span class="hljs-title function_">createSVGWatermark</span>(
  <span class="hljs-string">`机密文件 • <span class="hljs-subst">${navigator.userAgent.slice(<span class="hljs-number">0</span>, <span class="hljs-number">30</span>)}</span>`</span>
)
</code></pre>
<h2 data-id="heading-6">四、高级技巧：防篡改水印 🛡️</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant U as 用户
    participant P as 页面
    participant O as 观察器
    participant W as 水印层
    
    U-&gt;&gt;P: 尝试删除水印元素
    O-&gt;&gt;O: MutationObserver检测到DOM变化
    O-&gt;&gt;W: 通知水印被修改
    W-&gt;&gt;W: 立即恢复水印
    W-&gt;&gt;P: 记录操作日志
    Note over P,W: 同时检查开发者工具&lt;br/&gt;定期验证水印完整性
</code></pre>
<h3 data-id="heading-7">实现防删除水印：</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProtectedWatermark</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span> = <span class="hljs-literal">null</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initProtection</span>()
  }
  
  <span class="hljs-title function_">initProtection</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 创建水印</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createWatermark</span>()
    
    <span class="hljs-comment">// 2. 监听DOM变化</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-function">(<span class="hljs-params">mutations</span>) =&gt;</span> {
      mutations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">mutation</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isWatermarkRemoved</span>(mutation)) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'检测到水印被修改，正在恢复...'</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">recoverWatermark</span>()
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">logViolation</span>()
        }
      })
    })
    
    <span class="hljs-comment">// 3. 开始监听</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>, {
      <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">attributes</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span>
    })
    
    <span class="hljs-comment">// 4. 定期检查水印完整性</span>
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkWatermark</span>(), <span class="hljs-number">1000</span>)
    
    <span class="hljs-comment">// 5. 防止控制台查看</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">preventConsole</span>()
  }
  
  <span class="hljs-title function_">createWatermark</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建水印元素...</span>
  }
  
  <span class="hljs-title function_">isWatermarkRemoved</span>(<span class="hljs-params">mutation</span>) {
    <span class="hljs-comment">// 检查水印是否被移除或修改</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// 简化示例</span>
  }
  
  <span class="hljs-title function_">preventConsole</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 禁用F12和右键检查</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'F12'</span> || 
          (e.<span class="hljs-property">ctrlKey</span> &amp;&amp; e.<span class="hljs-property">shiftKey</span> &amp;&amp; e.<span class="hljs-property">key</span> === <span class="hljs-string">'I'</span>) ||
          (e.<span class="hljs-property">ctrlKey</span> &amp;&amp; e.<span class="hljs-property">key</span> === <span class="hljs-string">'u'</span>)) {
        e.<span class="hljs-title function_">preventDefault</span>()
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'为了保护内容安全，此功能已被禁用'</span>)
      }
    })
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'contextmenu'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> e.<span class="hljs-title function_">preventDefault</span>())
  }
}
</code></pre>
<h2 data-id="heading-8">五、实用水印组件 🎁</h2>
<p>这里是一个开箱即用的水印组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// watermark.js - 完整组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Watermark</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = {
      <span class="hljs-attr">text</span>: <span class="hljs-string">'Watermark'</span>,
      <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>,
      <span class="hljs-attr">color</span>: <span class="hljs-string">'rgba(0,0,0,0.1)'</span>,
      <span class="hljs-attr">angle</span>: -<span class="hljs-number">20</span>,
      <span class="hljs-attr">density</span>: <span class="hljs-string">'normal'</span>, <span class="hljs-comment">// sparse, normal, dense</span>
      <span class="hljs-attr">monitor</span>: <span class="hljs-literal">true</span>,
      ...config
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>()
  }
  
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createCanvas</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyToPage</span>()
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">monitor</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startMonitoring</span>()
    }
    
    <span class="hljs-comment">// 适应窗口变化</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">update</span>())
  }
  
  <span class="hljs-title function_">createCanvas</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>)
    <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)
    
    <span class="hljs-comment">// 根据密度设置画布大小</span>
    <span class="hljs-keyword">const</span> size = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">density</span> === <span class="hljs-string">'sparse'</span> ? <span class="hljs-number">400</span> : 
                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">density</span> === <span class="hljs-string">'dense'</span> ? <span class="hljs-number">150</span> : <span class="hljs-number">250</span>
    
    canvas.<span class="hljs-property">width</span> = size
    canvas.<span class="hljs-property">height</span> = size
    
    <span class="hljs-comment">// 绘制水印</span>
    ctx.<span class="hljs-property">font</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.config.fontSize}</span>px Arial`</span>
    ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">color</span>
    ctx.<span class="hljs-property">textAlign</span> = <span class="hljs-string">'center'</span>
    ctx.<span class="hljs-property">textBaseline</span> = <span class="hljs-string">'middle'</span>
    
    ctx.<span class="hljs-title function_">translate</span>(canvas.<span class="hljs-property">width</span> / <span class="hljs-number">2</span>, canvas.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>)
    ctx.<span class="hljs-title function_">rotate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">angle</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">180</span>)
    
    <span class="hljs-comment">// 支持多行文本</span>
    <span class="hljs-keyword">const</span> lines = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">text</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>)
    lines.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">line, index</span>) =&gt;</span> {
      ctx.<span class="hljs-title function_">fillText</span>(
        line, 
        <span class="hljs-number">0</span>, 
        index * <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">fontSize</span> - (lines.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">fontSize</span> / <span class="hljs-number">2</span>
      )
    })
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span> = canvas
  }
  
  <span class="hljs-title function_">applyToPage</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 移除旧水印</span>
    <span class="hljs-keyword">const</span> oldWatermark = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'global-watermark'</span>)
    <span class="hljs-keyword">if</span> (oldWatermark) oldWatermark.<span class="hljs-title function_">remove</span>()
    
    <span class="hljs-comment">// 创建新水印层</span>
    <span class="hljs-keyword">const</span> watermark = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)
    watermark.<span class="hljs-property">id</span> = <span class="hljs-string">'global-watermark'</span>
    watermark.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      background-image: url(<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.canvas.toDataURL()}</span>);
      background-repeat: repeat;
      z-index: 2147483647; /* 最大z-index */
      opacity: 0.8;
    `</span>
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(watermark)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span> = watermark
  }
  
  <span class="hljs-title function_">update</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-keyword">if</span> (config) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>, ...config }
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createCanvas</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyToPage</span>()
  }
  
  <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>.<span class="hljs-title function_">remove</span>()
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>.<span class="hljs-title function_">disconnect</span>()
    }
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Watermark</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./watermark.js'</span>

<span class="hljs-comment">// 基础使用</span>
<span class="hljs-keyword">const</span> watermark = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watermark</span>({
  <span class="hljs-attr">text</span>: <span class="hljs-string">'内部使用\n严禁外传'</span>,
  <span class="hljs-attr">color</span>: <span class="hljs-string">'rgba(255, 0, 0, 0.08)'</span>,
  <span class="hljs-attr">density</span>: <span class="hljs-string">'dense'</span>
})

<span class="hljs-comment">// 动态更新</span>
watermark.<span class="hljs-title function_">update</span>({
  <span class="hljs-attr">text</span>: <span class="hljs-string">`用户：张三\n时间：<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleString()}</span>`</span>
})
</code></pre>
<h2 data-id="heading-9">六、最佳实践与注意事项 📝</h2>
<ol>
<li>
<p><strong>性能优化</strong>：</p>
<ul>
<li>使用CSS <code>will-change: transform</code> 提升渲染性能</li>
<li>对于动态内容，考虑使用<code>requestAnimationFrame</code>进行更新</li>
<li>移动端适当降低水印密度</li>
</ul>
</li>
<li>
<p><strong>安全须知</strong>：</p>
<ul>
<li>前端水印≠绝对安全，敏感数据还需后端保护</li>
<li>水印信息可以加密或编码</li>
<li>考虑使用不可见的数字水印</li>
</ul>
</li>
<li>
<p><strong>用户体验</strong>：</p>
<ul>
<li>水印透明度建议在0.05-0.15之间</li>
<li>避免遮挡重要操作区域</li>
<li>提供水印显隐切换（权限可控）</li>
</ul>
</li>
<li>
<p><strong>兼容性处理</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 优雅降级方案</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>).<span class="hljs-property">getContext</span>) {
  <span class="hljs-comment">// 使用纯CSS或SVG回退方案</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'使用基础水印方案'</span>)
}
</code></pre>
</li>
</ol>
<h2 data-id="heading-10">七、创意水印灵感 💡</h2>
<p>想让水印更有趣？试试这些创意：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 动态水印（随时间变化）</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  watermark.<span class="hljs-title function_">update</span>({
    <span class="hljs-attr">text</span>: <span class="hljs-string">`北京时间：<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleTimeString()}</span>`</span>
  })
}, <span class="hljs-number">60000</span>)

<span class="hljs-comment">// 2. 随机位置水印</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">randomWatermark</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> texts = [<span class="hljs-string">'保密'</span>, <span class="hljs-string">'内部'</span>, <span class="hljs-string">'机密'</span>, <span class="hljs-string">'严禁外传'</span>]
  <span class="hljs-keyword">const</span> randomText = texts[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * texts.<span class="hljs-property">length</span>)]
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watermark</span>({
    <span class="hljs-attr">text</span>: randomText,
    <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">60</span> - <span class="hljs-number">30</span>, <span class="hljs-comment">// -30° 到 30°</span>
    <span class="hljs-attr">color</span>: <span class="hljs-string">`rgba(<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">100</span>}</span>, <span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">100</span>}</span>, 255, 0.1)`</span>
  })
}

<span class="hljs-comment">// 3. 用户特定水印</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">userSpecificWatermark</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-comment">// 生成唯一用户识别图案</span>
  <span class="hljs-keyword">const</span> hash = <span class="hljs-title function_">md5</span>(userId) <span class="hljs-comment">// 使用哈希函数</span>
  <span class="hljs-keyword">const</span> pattern = hash.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>)
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watermark</span>({
    <span class="hljs-attr">text</span>: pattern,
    <span class="hljs-attr">fontSize</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">density</span>: <span class="hljs-string">'dense'</span>
  })
}
</code></pre>
<h2 data-id="heading-11">总结 🎯</h2>
<p>前端水印就像给页面穿上了一件“隐形盔甲”——平时不影响美观，关键时刻却能提供重要保护。选择哪种方案，取决于你的具体需求：</p>
<ul>
<li><strong>简单展示</strong> → CSS背景水印</li>
<li><strong>动态灵活</strong> → Canvas生成</li>
<li><strong>高清需求</strong> → SVG水印</li>
<li><strong>安全敏感</strong> → 防篡改方案</li>
</ul>
<p>记住，没有完美的方案，只有最适合的方案。希望这篇指南能帮你找到最适合的水印实现方式！</p>
<hr/>
<p><strong>小挑战</strong>：你能实现一个水印，当用户尝试截图时自动添加“截图警告”文字吗？试试看，这是很好的实践机会！</p>
<p>（注：本文示例代码可直接使用，但生产环境请根据实际情况调整安全策略）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型原理剖析——解耦RoPE(旋转位置编码)的基本原理]]></title>    <link>https://juejin.cn/post/7586615716906369024</link>    <guid>https://juejin.cn/post/7586615716906369024</guid>    <pubDate>2025-12-23T05:57:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586615716906369024" data-draft-id="7586610067568181248" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型原理剖析——解耦RoPE(旋转位置编码)的基本原理"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-23T05:57:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="艾醒"/> <meta itemprop="url" content="https://juejin.cn/user/708512558088669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型原理剖析——解耦RoPE(旋转位置编码)的基本原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/708512558088669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    艾醒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T05:57:35.000Z" title="Tue Dec 23 2025 05:57:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本篇文章详细解析解耦RoPE（Decoupled Rotary Position Embedding，DRoPE），包括它的核心原理、与传统RoPE的区别、实现方式以及核心优势。下面我会从基础到进阶，由浅入深地拆解这一技术。</p>
<h2 data-id="heading-1">前置知识：传统RoPE的核心逻辑</h2>
<p>要理解解耦RoPE，首先要掌握传统RoPE（旋转位置编码）的核心——它通过<strong>复平面旋转</strong>将位置信息编码到Query/Key向量中，让模型捕捉<strong>相对位置信息</strong>（注意力分数仅依赖于Q和K的相对位置，而非绝对位置）。</p>
<h3 data-id="heading-2">1. 传统RoPE的数学表达</h3>
<p>对于维度为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span>的向量（通常<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span>为偶数），将其拆分为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">d/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mord">/2</span></span></span></span></span>对二维向量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mn>2</mn><mi>m</mi></mrow></msub><mo separator="true">,</mo><msub><mi>x</mi><mrow><mn>2</mn><mi>m</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_{2m}, x_{2m+1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>为维度索引，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>≤</mo><mi>m</mi><mo>&lt;</mo><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">0 \leq m &lt; d/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"/><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mord">/2</span></span></span></span></span>），位置为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>的旋转操作如下：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mrow><mn>2</mn><mi>m</mi></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mrow><mn>2</mn><mi>m</mi><mo>+</mo><mn>1</mn></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>ϕ</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi>sin</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>ϕ</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>sin</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>ϕ</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>ϕ</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mrow><mn>2</mn><mi>m</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mrow><mn>2</mn><mi>m</mi><mo>+</mo><mn>1</mn></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix} x_{2m}' \\ x_{2m+1}' \end{bmatrix} = \begin{bmatrix} \cos(\phi_{m,k}) &amp; -\sin(\phi_{m,k}) \\ \sin(\phi_{m,k}) &amp; \cos(\phi_{m,k}) \end{bmatrix} \begin{bmatrix} x_{2m} \\ x_{2m+1} \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-2.4519em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">m</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2481em;"><span/></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-2.4519em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3064em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop">cos</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop">sin</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">sin</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop">cos</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<p>其中旋转角度<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ϕ</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo>=</mo><mi>k</mi><mo>⋅</mo><msub><mi>θ</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">\phi_{m,k} = k \cdot \theta_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，而<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>m</mi></msub><mo>=</mo><mn>1000</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>2</mn><mi>m</mi><mi mathvariant="normal">/</mi><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\theta_m = 10000^{-2m/d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.888em;"/><span class="mord">1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">m</span><span class="mord mtight">/</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span></span>（控制不同维度的旋转频率）。</p>
<h3 data-id="heading-3">2. 传统RoPE的核心问题</h3>
<p>传统RoPE的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ϕ</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\phi_{m,k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>是<strong>位置<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>和维度<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>直接耦合</strong>的，导致两个关键问题：</p>
<ul>
<li>长序列场景下：高频维度（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>大）的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">\theta_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>小，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ϕ</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\phi_{m,k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>随<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>增大快速饱和（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>cos</mi><mo>⁡</mo><mi mathvariant="normal">/</mi><mi>sin</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\cos/\sin</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop">cos</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">/</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">sin</span></span></span></span></span>值震荡到无区分度）；低频维度（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>小）的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">\theta_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>大，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ϕ</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\phi_{m,k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>随<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>增大变化过慢，位置编码失效；</li>
<li>序列长度扩展（extrapolation）：训练时用短序列（如512），推理时用长序列（如4096），性能大幅下降。</li>
</ul>
<h2 data-id="heading-4">解耦RoPE（DRoPE）的核心改进</h2>
<p>解耦RoPE的核心思想是：<strong>拆分位置<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>和维度<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>的耦合关系</strong>，引入独立的缩放因子，让不同维度的位置编码敏感度可独立调节，从而平衡高低频维度的表现。</p>
<h3 data-id="heading-5">1. 解耦RoPE的数学形式</h3>
<p>最通用的解耦公式如下（以全局解耦为例）：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>ϕ</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo>=</mo><mfrac><mi>k</mi><mi>γ</mi></mfrac><mo>⋅</mo><msub><mi>θ</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">\phi_{m,k} = \frac{k}{\gamma} \cdot \theta_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.2519em;vertical-align:-0.8804em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">\gamma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span></span></span>是<strong>全局解耦缩放因子</strong>（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\gamma&gt;1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>时，降低所有维度的位置敏感度，让长序列的旋转角度变化更平缓）。</p>
<p>更实用的<strong>分组解耦</strong>形式（平衡高低频）：
将维度分为低频组（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>小）和高频组（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>大），分别设置缩放因子<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>l</mi><mi>o</mi><mi>w</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\alpha_{low}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（&gt;1，降低低频敏感度）和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>h</mi><mi>i</mi><mi>g</mi><mi>h</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\alpha_{high}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">hi</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>（&lt;1，提高高频敏感度）：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>ϕ</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mfrac><mi>k</mi><msub><mi>α</mi><mrow><mi>l</mi><mi>o</mi><mi>w</mi></mrow></msub></mfrac><mo>⋅</mo><msub><mi>θ</mi><mi>m</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>低频维度</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mfrac><mi>k</mi><msub><mi>α</mi><mrow><mi>h</mi><mi>i</mi><mi>g</mi><mi>h</mi></mrow></msub></mfrac><mo>⋅</mo><msub><mi>θ</mi><mi>m</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>高频维度</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">\phi_{m,k} = 
\begin{cases} 
\frac{k}{\alpha_{low}} \cdot \theta_m &amp; \text{低频维度} \\
\frac{k}{\alpha_{high}} \cdot \theta_m &amp; \text{高频维度}
\end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.0149em;vertical-align:-1.2575em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7575em;"><span style="top:-3.7575em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0037em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4509em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.2986em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0037em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">hi</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2901em;"><span/></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5481em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2575em;"><span/></span></span></span></span><span class="arraycolsep" style="width:1em;"/><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7575em;"><span style="top:-3.7575em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord text"><span class="mord cjk_fallback">低频维度</span></span></span></span><span style="top:-2.2986em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord text"><span class="mord cjk_fallback">高频维度</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2575em;"><span/></span></span></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<h3 data-id="heading-6">2. 解耦RoPE的核心目标</h3>
<ul>
<li>让低频维度：旋转角度随位置增长更“快”（避免长序列下位置区分度不足）；</li>
<li>让高频维度：旋转角度随位置增长更“慢”（避免角度饱和）；</li>
<li>整体提升模型对长序列的适应性，解决extrapolation问题。</li>
</ul>
<h2 data-id="heading-7">解耦RoPE的代码实现（PyTorch）</h2>
<p>下面通过对比传统RoPE和分组解耦RoPE的实现，直观展示核心差异。</p>
<h3 data-id="heading-8">1. 传统RoPE实现</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch

<span class="hljs-keyword">def</span> <span class="hljs-title function_">apply_rotary_emb</span>(<span class="hljs-params">q, k, pos_ids, theta=<span class="hljs-number">10000.0</span></span>):
    <span class="hljs-string">"""
    传统RoPE实现
    参数：
    - q: [batch_size, num_heads, seq_len, head_dim]
    - k: [batch_size, num_heads, seq_len, head_dim]
    - pos_ids: 位置索引 [seq_len]
    """</span>
    <span class="hljs-keyword">assert</span> q.shape[-<span class="hljs-number">1</span>] % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>, <span class="hljs-string">"head_dim必须为偶数"</span>
    head_dim = q.shape[-<span class="hljs-number">1</span>]
    half_dim = head_dim // <span class="hljs-number">2</span>

    <span class="hljs-comment"># 计算传统的theta_m: 10000^(-2m/d)</span>
    inv_freq = <span class="hljs-number">1.0</span> / (theta ** (torch.arange(<span class="hljs-number">0</span>, half_dim).<span class="hljs-built_in">float</span>() / half_dim))
    <span class="hljs-comment"># 位置与维度耦合：pos_ids * inv_freq</span>
    freqs = torch.einsum(<span class="hljs-string">"i,j-&gt;ij"</span>, pos_ids, inv_freq)  <span class="hljs-comment"># [seq_len, half_dim]</span>

    <span class="hljs-comment"># 扩展为完整维度的cos/sin</span>
    cos_emb = torch.cat([freqs, freqs], dim=-<span class="hljs-number">1</span>).cos()  <span class="hljs-comment"># [seq_len, head_dim]</span>
    sin_emb = torch.cat([freqs, freqs], dim=-<span class="hljs-number">1</span>).sin()

    <span class="hljs-comment"># 旋转操作核心函数</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">rotate_half</span>(<span class="hljs-params">x</span>):
        x1, x2 = x[..., :half_dim], x[..., half_dim:]
        <span class="hljs-keyword">return</span> torch.cat([-x2, x1], dim=-<span class="hljs-number">1</span>)

    <span class="hljs-comment"># 应用旋转编码</span>
    q_rot = q * cos_emb.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>) + rotate_half(q) * sin_emb.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>)
    k_rot = k * cos_emb.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>) + rotate_half(k) * sin_emb.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> q_rot, k_rot
</code></pre>
<h3 data-id="heading-9">2. 分组解耦RoPE实现（工业界主流）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch

<span class="hljs-keyword">def</span> <span class="hljs-title function_">apply_decoupled_rotary_emb</span>(<span class="hljs-params">q, k, pos_ids, theta=<span class="hljs-number">10000.0</span>, alpha_low=<span class="hljs-number">2.0</span>, alpha_high=<span class="hljs-number">0.5</span></span>):
    <span class="hljs-string">"""
    分组解耦RoPE实现（高低频维度分别调节）
    参数：
    - alpha_low: 低频维度缩放因子（&gt;1，降低敏感度）
    - alpha_high: 高频维度缩放因子（&lt;1，提高敏感度）
    """</span>
    <span class="hljs-keyword">assert</span> q.shape[-<span class="hljs-number">1</span>] % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>, <span class="hljs-string">"head_dim必须为偶数"</span>
    head_dim = q.shape[-<span class="hljs-number">1</span>]
    half_dim = head_dim // <span class="hljs-number">2</span>

    <span class="hljs-comment"># 1. 生成维度索引和基础inv_freq</span>
    m = torch.arange(<span class="hljs-number">0</span>, half_dim).<span class="hljs-built_in">float</span>()
    inv_freq = <span class="hljs-number">1.0</span> / (theta ** (m / half_dim))  <span class="hljs-comment"># [half_dim]</span>

    <span class="hljs-comment"># 2. 分组解耦核心：为高低频分配不同缩放因子</span>
    <span class="hljs-comment"># 划分高低频维度（以half_dim//2为界）</span>
    low_freq_mask = m &lt; (half_dim // <span class="hljs-number">2</span>)
    high_freq_mask = ~low_freq_mask
    
    <span class="hljs-comment"># 初始化缩放因子</span>
    alpha = torch.ones_like(inv_freq)
    alpha[low_freq_mask] = alpha_low   <span class="hljs-comment"># 低频维度：pos_ids / alpha_low</span>
    alpha[high_freq_mask] = alpha_high <span class="hljs-comment"># 高频维度：pos_ids / alpha_high</span>

    <span class="hljs-comment"># 3. 解耦计算：pos_ids / alpha * inv_freq（核心修改）</span>
    freqs = torch.einsum(<span class="hljs-string">"i,j-&gt;ij"</span>, pos_ids, inv_freq / alpha)  <span class="hljs-comment"># [seq_len, half_dim]</span>

    <span class="hljs-comment"># 后续旋转逻辑与传统RoPE一致</span>
    cos_emb = torch.cat([freqs, freqs], dim=-<span class="hljs-number">1</span>).cos()
    sin_emb = torch.cat([freqs, freqs], dim=-<span class="hljs-number">1</span>).sin()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">rotate_half</span>(<span class="hljs-params">x</span>):
        x1, x2 = x[..., :half_dim], x[..., half_dim:]
        <span class="hljs-keyword">return</span> torch.cat([-x2, x1], dim=-<span class="hljs-number">1</span>)

    q_rot = q * cos_emb.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>) + rotate_half(q) * sin_emb.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>)
    k_rot = k * cos_emb.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>) + rotate_half(k) * sin_emb.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> q_rot, k_rot
</code></pre>
<h3 data-id="heading-10">3. 关键修改点说明</h3>

























<table><thead><tr><th>对比项</th><th>传统RoPE</th><th>解耦RoPE（分组）</th></tr></thead><tbody><tr><td>频率计算</td><td><code>freqs = pos_ids * inv_freq</code></td><td><code>freqs = pos_ids * (inv_freq / alpha)</code></td></tr><tr><td>核心差异</td><td>位置与维度强耦合</td><td>按维度分组调节位置敏感度</td></tr><tr><td>额外开销</td><td>无</td><td>仅增加缩放因子计算（可忽略）</td></tr></tbody></table>
<h2 data-id="heading-11">解耦RoPE的优势与应用场景</h2>
<h3 data-id="heading-12">1. 核心优势</h3>
<ul>
<li><strong>长序列适应性强</strong>：解决传统RoPE长序列下高频饱和、低频区分度不足的问题；</li>
<li><strong>无额外模型开销</strong>：仅修改位置编码的计算逻辑，不增加参数量或计算量；</li>
<li><strong>灵活可调</strong>：可通过调整<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>l</mi><mi>o</mi><mi>w</mi></mrow></msub><mi mathvariant="normal">/</mi><msub><mi>α</mi><mrow><mi>h</mi><mi>i</mi><mi>g</mi><mi>h</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\alpha_{low}/\alpha_{high}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">/</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">hi</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>适配不同长度的序列（如512→4096→8192）；</li>
<li><strong>兼容现有模型</strong>：可直接替换LLaMA、GPT、Qwen等模型的传统RoPE，无需重构模型结构。</li>
</ul>
<h3 data-id="heading-13">2. 典型应用场景</h3>
<ul>
<li>长文本建模（文档级QA、长文档摘要、法律/医疗长文本分析）；</li>
<li>大模型长上下文扩展（如将LLaMA-7B的上下文从2048扩展到8192）；</li>
<li>需要序列长度外推的场景（训练短序列，推理长序列）。</li>
</ul>
<h2 data-id="heading-14">总结</h2>
<ol>
<li>解耦RoPE的核心是<strong>拆分位置与维度的耦合关系</strong>，通过分组/全局缩放因子调节不同维度的位置编码敏感度；</li>
<li>分组解耦是工业界最常用的形式，通过<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>l</mi><mi>o</mi><mi>w</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\alpha_{low}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（&gt;1）和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>h</mi><mi>i</mi><mi>g</mi><mi>h</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\alpha_{high}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">hi</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>（&lt;1）平衡高低频维度的表现；</li>
<li>解耦RoPE几乎无额外开销，能显著提升模型对长序列的建模能力，是大模型长上下文扩展的核心优化手段。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 智能体工程现状]]></title>    <link>https://juejin.cn/post/7586585498745585718</link>    <guid>https://juejin.cn/post/7586585498745585718</guid>    <pubDate>2025-12-23T05:59:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586585498745585718" data-draft-id="7586582977708818474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 智能体工程现状"/> <meta itemprop="keywords" content="云原生,LLM"/> <meta itemprop="datePublished" content="2025-12-23T05:59:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 智能体工程现状
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T05:59:34.000Z" title="Tue Dec 23 2025 05:59:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：望宸</p>
<p>LangChain 近期发布了《State of Agent Engineering》报告，内容比较翔实，全面分析了 AI 智能体在企业中的采用现状、挑战与趋势。（或尚未应用的原因）</p>
<p>我们对报告进行了翻译，并做了些描述和内容排序上的的优化，让中文读者更易于理解。同时，我们将今年 9 月底发布的《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247577947%26idx%3D1%26sn%3D6ac4f70f3e84f894a59d8b50360e78a1%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247577947&amp;idx=1&amp;sn=6ac4f70f3e84f894a59d8b50360e78a1&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AI 原生应用架构白皮书</a>》中的部分调研数据，和《State of Agent Engineering》进行比对，以了解智能体工程现状在国内外的差异，以及对共性问题提供了些应对思路。</p>
<blockquote>
<p>报名与白皮书原文：</p>
<p>《State of Agent Engineering》</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.langchain.com%2Fstate-of-agent-engineering" target="_blank" title="https://www.langchain.com/state-of-agent-engineering" ref="nofollow noopener noreferrer">www.langchain.com/state-of-ag…</a></p>
<p>《AI 原生应用架构白皮书》</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.aliyun.com%2Febook%2F8479" target="_blank" title="https://developer.aliyun.com/ebook/8479" ref="nofollow noopener noreferrer">developer.aliyun.com/ebook/8479</a></p>
</blockquote>
<ul>
<li>《State of Agent Engineering》人群画像：1340 份有效回复，包括工程师、产品经理、业务负责人和企业高管。</li>
<li>《AI 原生应用架构白皮书》人群画像：来自参加杭州、上海、北京、深圳、广州举办的 6 场 AI 原生为主题的线下开发者沙龙，填写问卷的总人数是 1382 人，以架构师、后端、运维、技术负责人为主。</li>
</ul>
<h2 data-id="heading-0">什么是智能体工程？</h2>
<p>智能体工程是将大语言模型（LLM）转化为可靠系统的迭代过程。由于智能体具有不确定性，我们认为，工程师必须通过快速迭代来持续优化其输出质量。</p>
<h2 data-id="heading-1">核心发现</h2>
<p>企业的关注度不再问是否要构建智能体，而是关注如何可靠、高效且规模化地部署智能体，且这一趋势会一直蔓延到 2026 年，直到能有效的解决问题。核心发现：</p>
<ul>
<li><strong>生产落地势头强劲</strong>：57% 的受访者已将智能体投入生产环境，大型企业引领采纳潮流。</li>
<li><strong>质量是最大拦路虎</strong>：32% 的人将“质量”列为首要障碍；相比之下，成本担忧较去年有所下降。</li>
<li><strong>可观测性已成为标配</strong>：近 89% 的受访者为其智能体实施了可观测性方案，远超评估（evals）的采用率（52%）。</li>
<li><strong>多模型策略成常态</strong>：OpenAI 的 GPT 系列模型占据主导，但 Gemini、Claude 和开源模型也获得广泛应用；微调尚未普及。</li>
</ul>
<h2 data-id="heading-2">大型企业引领采纳浪潮</h2>
<p>超过半数（57.3%）的受访者表示其公司已在生产环境中运行智能体，另有 30.4% 正在积极开发并有明确的上线计划。</p>
<p>这标志着相较于去年（51% 的受访者称已有智能体上线），有了显著增长。企业正从概念验证阶段迈向生产部署。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/331094438aca414299b0c61201627d8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=oDk%2ByLXFOWJGQq0H%2Bbr0dKP0%2Bmc%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>《AI 原生应用架构白皮书》中关于实施进程的调研结果，国内外的智能体发展势头均比较强势，企业关注的不再是“是否”要推出智能体，而是“如何”以及“何时”。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c6d2b367c19471fbc938d2c37d759d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=gW30suS%2Bt167KmJeeY%2F9QeCWfqY%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-3">规模效应显现</h2>
<p>在员工规模超 10,000 人的大型组织中，67% 已部署智能体，24% 正在开发中；而在员工少于 100 人的小型组织中，这一比例分别为 50% 和 36%。这表明大型企业正更快地从试点走向可持续演进，可能得益于其在平台团队、安全性和可靠性基础设施上，有着更大的投入。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93dd08f417924e968b34d23bc4368893~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=flpFkh7%2F794zvXEkDULaqhSfw4o%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">主流智能体应用场景</h2>
<p>客户服务是最常见的智能体用例（26.5%），紧随其后的是研究与数据分析（24.4%）。这两类应用合计占所有主要部署场景的一半以上。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38aa88b2426f4de7b4cffe626b85fc77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=Mf2dPoG2Ghg0VfVHgaa6JZFabxY%3D" alt="图片" loading="lazy"/></p>
<p>这一结果表明：</p>
<ul>
<li>企业正越来越多地将智能体直接面向客户，而不仅限于内部使用。同时，智能体在提升内部效率方面也表现出显著的价值，18% 的受访者提到将其用于内部工作流自动化。</li>
<li>研究与数据分析场景的流行，进一步印证了智能体当前的优势所在，即整合海量信息、跨源推理，并加速知识密集型任务。</li>
<li>今年的受访者选择的应用场景更加分散（每人仅可选一项主要用例），说明智能体的应用正在从早期少数场景向更广泛的领域拓展。</li>
<li>大企业的偏好略有不同，在万人以上企业中，内部生产力提升成为首要用例（26.8%），客户服务（24.7%）和研究与数据分析（22.2%）紧随其后。这表明大型企业可能优先聚焦于提升内部团队效率，再逐步或同步向终端用户部署。</li>
</ul>
<blockquote>
<p>《AI 原生应用架构白皮书》提供了以下 4 类落地场景供多选，重塑客户互动 &gt; 重塑业务流程 &gt; 提升员工体验 &gt; 推动创新突破。结合两份数据，客户服务和企业内提效是智能体最确定的应用场景。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cbf638e45fd4e7ea24173a5dda2b220~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=pH0bXXziRN0d3siz0wZyiq%2FvIcQ%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">投产的最大障碍：质量、延迟与安全</h2>
<ul>
<li><strong>质量仍是头号难题，与去年一致。</strong> 今年有三分之一的受访者将其列为最大障碍。这里的“质量”涵盖准确性、相关性、一致性，以及智能体能否保持恰当语气并遵守品牌或政策规范。</li>
<li><strong>延迟成为第二大挑战（20%）。</strong> 随着智能体进入客户服务、代码生成等面向客户的场景，响应速度已成为用户体验的关键。这也反映了团队在质量与速度之间的权衡：能力更强、步骤更多的智能体虽能产出更高质量结果，但响应往往更慢。</li>
<li><strong>成本作为担忧因素的提及率低于往年。</strong> 模型价格下降和效率提升似乎已将组织的关注点从“花费多少”转向“如何让智能体又快又好”。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c650c2acc62d442ca5fc31199c890bf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=2hdgQNXiUTJysVlaCNsMr%2BjYxrQ%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>《AI 原生应用架构白皮书》侧重于技术层面的挑战进行调研：长回话状态管理 &gt; 算力资源调度 &gt; 数据梳理链路 &gt; 异步通信需求，和质量、延迟、成本有所呼应。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9331fea98ea42149a57009b2c7a6d91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=JBsX2acYu84V6ADNiDCIkozAKxM%3D" alt="图片" loading="lazy"/></p>
<p>规模带来的新挑战：</p>
<ul>
<li>在 2,000 人以上的大型企业中，安全跃升为第二大障碍（24.9%），超过了延迟。这反映出大型组织对数据合规、权限控制和审计追踪的更高要求。</li>
<li>在万人以上企业中，开放式回答指出，幻觉和输出一致性是确保智能体质量的最大挑战。许多人还提到，在大规模场景下进行上下文工程和管理上下文仍十分困难。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7981c62774634d17b27803eb37a8d09c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=r%2FE5rBDAl7X%2FwbAWyjt6aNBBEIw%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>《AI 原生应用架构白皮书》中提供了上下文工程和 AI 安全的一些初步探索。其中，上下文工程是技术难点，安全则依赖组织的体系化设计。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b999e55ac99481b823c059f2fa8f128~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=wul980wrVgcHZI%2BFs6hs4Zqct%2B8%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8eb52ae8165447d3a53363bbd02afd8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=mm08QKW4Mn0rEWUjcEIAFJ0xpbE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-6">智能体可观测性：已成为行业标配</h2>
<ul>
<li>对多步推理链和工具调用进行追踪的能力，如今已是智能体工程的“基本要求”。89% 的组织已为其智能体实施了某种形式的可观测性，其中 62% 具备详细追踪能力，可检查智能体的每一步操作和工具调用。</li>
<li>在已上线智能体的团队中，这一比例更高，94% 拥有某种可观测性，71.5% 具备完整追踪能力。这揭示了一个基本事实：若无法看清智能体如何推理和行动，团队就无法可靠地调试故障、优化性能，也无法赢得内外部利益相关者的信任。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa75841e942d450f8baf1abd4a2e73ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=pe%2FLC4TbxTrGr4VSXqPPW4UOAxY%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>《AI 原生应用架构白皮书》：调研了可观测的主流应用场景。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7027cd9a592a46c4b9157fbf537a1436~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=ePuD9ZgRm4hQGVqLJv66JvitHjw%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>同时，《AI 原生应用架构白皮书》提供了相关的理论和实践。解决以上痛点的关键能力是：端到端的全链路跟踪、全栈观测、自动化评估。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ab84fbbe9d6410299cb3f18dd7fdfdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=%2FrEvgrEqk6RESug6L0LpfkOrwqg%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-7">智能体评估与测试：仍在追赶</h2>
<ul>
<li>尽管可观测性已广泛普及，但智能体评估（evals）的采用仍在追赶中。略超一半的组织（52.4%）报告会在测试集上运行离线评估，表明许多团队已意识到在部署前捕捉回归和验证行为的重要性。</li>
<li>在线评估（online evals）的采用率较低（37.3%），但正在快速增长，因为团队开始监控智能体在真实世界中的表现。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90882a5ff9b943eeaf8cb3c87211b426~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=GQO9j%2BrXHhMdBXYOXoF7Ij8BBPI%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>对于已上线智能体的团队，评估实践明显更成熟：“不评估”的比例从 29.5% 降至 22.8%，而进行在线评估的比例升至 44.8%。这表明一旦智能体面对真实用户，团队就必须依赖生产数据实时发现问题。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/681da62d40ff4246af69e660fe929365~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=Yq6PV38Df2KDRoTZGM3BNltU9R8%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>大多数团队仍从离线评估入手（因其门槛较低、设置更清晰），但许多正在叠加多种方法。在开展评估的组织中，近四分之一同时使用离线和在线评估。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21158aa429704e41b93b9f447b3e89c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=iuj3cu2iNCRYsObLM6W2seWLlZY%3D" alt="图片" loading="lazy"/></p>
<p>这些团队通常结合人工评审与自动化方法：用 LLM-as-Judge 实现广度覆盖，用人工审核处理深度判断。</p>
<ul>
<li>总体而言，人工评审（59.8%）在高风险或需细腻判断的场景中仍不可或缺，而 LLM-as-Judge（53.3%）则被越来越多地用于规模化评估质量、事实准确性和合规性。</li>
<li>相比之下，传统的机器学习指标（如 ROUGE、BLEU）采用率很低，在开放式智能体交互中，往往存在多个有效答案，这些指标并不适用。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05edb4f4d4aa4f73a5f076d6c068af96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=kfC1Y2B%2B8JkxFv6RB4ERAgYpOVU%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>《AI 原生应用架构白皮书》也认为传统的机器学习指标（如 ROUGE、BLEU），存在较高的局限性。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bb85599b9ba4025a4fb13bbebcc28ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=I4ILS7%2BQIhrINCgY8WRQ7lCkzQo%3D" alt="图片" loading="lazy"/></p>
<p>更流行的是 LLM-as-Judge 范式，并提供了利用在线数据，实现自动化评估的实践框架。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59d13c3d85dc470bbdbd4e70a5934a51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=frDSu9m0Q9s%2FJmEZS7Izh%2B%2F1W9Q%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-8">模型与工具生态：开放、多元、务实</h2>
<ul>
<li>OpenAI 模型占据主导，但很少有团队押注单一供应商。超过三分之二的组织使用 OpenAI 的 GPT 系列模型，但超过四分之三（75%+）在生产或开发中使用多个模型。</li>
<li>团队越来越倾向于根据任务复杂度、成本和延迟等因素，将不同任务路由给不同模型，而非陷入平台锁定。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ca3405ac3994dc7b3856570e85284f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=VwF09AYjYRF4fKLuaNLePKwFMrM%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>《AI 原生应用架构白皮书》中提到多模型策略是常态，通过 AI 网关可以高效、安全、量化管理模型供应和 Token 的消耗。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24f51a795d2e4e81aeafe2efae9a15d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=fNyyBtCDQLIVvpzbpwDic4L7HTs%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>尽管商业 API 使用便捷，但自托管模型仍是重要策略。</strong> 约三分之一的组织投入资源建设自有基础设施以部署开源模型。这可能是出于高用量下的成本优化、数据驻留/主权要求，或特定行业的监管约束。</li>
<li><strong>同时，微调仍未普及。</strong> 57% 的组织未进行任何微调，而是依赖基础模型结合提示工程和检索增强生成。由于微调需要大量投入（数据收集、标注、训练基础设施和持续维护），目前主要用于高影响力或高度专业化的场景。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a188ec842f94a40920ee3bb26e0dfe9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074374&amp;x-signature=X%2FTKj7KWtSrcHItsWSxSZBr%2FYwc%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[看来 Oracle 还是听劝的！]]></title>    <link>https://juejin.cn/post/7586623059525763135</link>    <guid>https://juejin.cn/post/7586623059525763135</guid>    <pubDate>2025-12-23T06:00:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586623059525763135" data-draft-id="7586684925105995819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="看来 Oracle 还是听劝的！"/> <meta itemprop="keywords" content="HTTP"/> <meta itemprop="datePublished" content="2025-12-23T06:00:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lucifer三思而后行"/> <meta itemprop="url" content="https://juejin.cn/user/4169810296974189"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            看来 Oracle 还是听劝的！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4169810296974189/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lucifer三思而后行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:00:00.000Z" title="Tue Dec 23 2025 06:00:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>大家好，这里是公众号 <strong>DBA学习之路</strong>，分享一些学习数据库路上的知识和经验。</p>
</blockquote>
<p><img src="https://oss-emcsprod-public.modb.pro/image/editor/20251219-2001925766843015168_395407.png" alt="" loading="lazy"/></p>
<p>@<a href="https://link.juejin.cn?target=%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">TOC</a></p>
<h2 data-id="heading-0">前言</h2>
<p>自从 Oracle MOS 更新版本之后，备受吐槽，各种问题纷至沓来，我也写了两篇文章聊了聊这个事：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FYYXx9uOSv1Pb8di15VWLdA" target="_blank" title="https://mp.weixin.qq.com/s/YYXx9uOSv1Pb8di15VWLdA" ref="nofollow noopener noreferrer">Oracle MOS 重磅升级？嗯，什么东西！</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FcmIwZKVrC11dolEHGHSYUA" target="_blank" title="https://mp.weixin.qq.com/s/cmIwZKVrC11dolEHGHSYUA" ref="nofollow noopener noreferrer">听说 Oracle MOS 又放大招！</a></li>
</ul>
<p>今天登陆 MOS，发现 12.18 号更新了一篇文章：</p>
<p><img src="https://oss-emcsprod-public.modb.pro/image/editor/20251222-2002978644822679552_395407.png" alt="" loading="lazy"/></p>
<p><strong>文章的大概意思就是</strong>：关于用户之前吐槽 MOS 的大多数问题，我们都已经进行修复或者在修复中了。</p>
<p><img src="https://oss-emcsprod-public.modb.pro/image/editor/20251222-2002979108955971584_395407.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">已解决的问题</h3>
<ol>
<li><strong>文档搜索功能修复</strong>：之前用户无法通过旧版文档编号（如 472449.1）搜索知识文章，且部分文档不显示，现已提升搜索能力并修复链接重定向。</li>
<li><strong>旧版收藏夹恢复</strong>：用户可通过 <strong><code>Account → Preferences → Previous Favorites</code></strong> 查看，<strong>仅迁移以“.1”结尾的文章收藏</strong>，原文件夹内的收藏现以平铺列表展示，已删除文章将无法访问。</li>
<li><strong>文章打印功能修复</strong>：之前从门户直接打印时格式不理想，现已修复。浏览器打印功能得到增强，文章标题可完整显示而不被截断。</li>
<li><strong>文章内大型表格显示修复</strong>：之前包含多列表格的文章显示不正常，现已完成格式优化并实施了进一步改进。</li>
</ol>
<p>文档搜索功能：</p>
<p><img src="https://oss-emcsprod-public.modb.pro/image/editor/20251222-2002980047411027968_395407.png" alt="" loading="lazy"/></p>
<p>旧版收藏夹：</p>
<p><img src="https://oss-emcsprod-public.modb.pro/image/editor/20251222-2002980323928399872_395407.png" alt="" loading="lazy"/></p>
<p>文章打印功能（<strong>文章标题还是被截断的</strong>），还是没修复：</p>
<p><img src="https://oss-emcsprod-public.modb.pro/image/editor/20251222-2002984074425212928_395407.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">改进中</h3>
<ol>
<li><strong>外部链接重定向问题</strong>：从外部网站（如谷歌）或旧书签访问知识文章的链接可能无法正常跳转，相关链接处理功能仍在持续优化。</li>
<li><strong>大屏幕文章显示优化</strong>：目前文章以固定宽度显示，未充分利用大屏空间，正在更新以适应不同屏幕尺寸。</li>
</ol>
<h2 data-id="heading-3">总结</h2>
<p>目前看起来对我的帮助不大，但是这个态度还是值得点赞，希望优化的越来越好！</p>
<hr/>
<p><img src="https://oss-emcsprod-public.modb.pro/image/editor/20251219-2001925766843015168_395407.png" alt="" loading="lazy"/># 前言</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[day1]]></title>    <link>https://juejin.cn/post/7586617459487850548</link>    <guid>https://juejin.cn/post/7586617459487850548</guid>    <pubDate>2025-12-23T06:50:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586617459487850548" data-draft-id="7586617459487785012" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="day1"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T06:50:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="古蓬莱掌管玉米的神"/> <meta itemprop="url" content="https://juejin.cn/user/2654634748958267"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            day1
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2654634748958267/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    古蓬莱掌管玉米的神
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:50:16.000Z" title="Tue Dec 23 2025 06:50:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ul>
<li>LLM 智能理解：从非技术视角看，LLM 的智能基于 next TOKEN prediction，即根据上下文猜下一个文字，Transformer 逻辑类似完形填空只填最后一个字。当前 LLM 像刷题家，见过大量数据但未建立逻辑体系，而人类学习更具泛化能力。</li>
<li>写 Prompt 原则：写 Prompt 的本质是让 LLM 好猜答案，需构建合适环境，可拆解为 7 个子原则，包括说明任务环境、减少特殊黑话、确保规则独立、减少无意义和重复 context、按逻辑顺序排列、聚合相关内容等。</li>
<li>Context 工程内容：Context 工程主要做四件事，即帮模型减少冗余上下文、找到重要上下文、定义上下文结构、排序上下文，核心是让模型更好地完成完形填空。</li>
<li>判断是否上工程：不是模型做不好就立刻上工程，应先检查 Prompt 是否符合原则；关键场景追求成功率时应直接上工程；其他情况可商量，要习惯模型的概率性风险，实验是检验 LLM 的唯一真理
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d47cb8b150a4e2e98f1502561a76090~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k6JOs6I6x5o6M566h546J57Gz55qE56We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077416&amp;x-signature=eru5BQwXM7QLYbucZMXJQrKI9O4%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h2 data-id="heading-0">promote优化原则</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9144bffa9de44fb86403d9bc955f574~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k6JOs6I6x5o6M566h546J57Gz55qE56We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077416&amp;x-signature=7hGXjs%2BC%2BHE%2F0x9y8p%2Fjgem9mKU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/304550ffb42c466da603577a2bae550e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k6JOs6I6x5o6M566h546J57Gz55qE56We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077416&amp;x-signature=lMtKYNHIyXpU%2BCHpn775TtgZiE8%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[.NET 进阶 —— 深入理解线程（3）ThreadPool 与 Task 入门：从手动线程到池化任务的升级]]></title>    <link>https://juejin.cn/post/7586585688005607465</link>    <guid>https://juejin.cn/post/7586585688005607465</guid>    <pubDate>2025-12-23T05:12:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586585688005607465" data-draft-id="7585476892976103458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=".NET 进阶 —— 深入理解线程（3）ThreadPool 与 Task 入门：从手动线程到池化任务的升级"/> <meta itemprop="keywords" content=".NET,C#"/> <meta itemprop="datePublished" content="2025-12-23T05:12:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我要拿微软MVP"/> <meta itemprop="url" content="https://juejin.cn/user/1945461219656633"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            .NET 进阶 —— 深入理解线程（3）ThreadPool 与 Task 入门：从手动线程到池化任务的升级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1945461219656633/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我要拿微软MVP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T05:12:14.000Z" title="Tue Dec 23 2025 05:12:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、ThreadPool线程池</h2>
<p><code>ThreadPool</code>线程池是<code>.NET Framework 2.0</code>时代的产物，<code>.NET CORE</code>时代下用的很少，但是我们还是要理解<code>ThreadPool</code>线程池，因为有助于理解后续的<code>Task</code>任务。</p>
<h3 data-id="heading-1">1.1 为什么要用到<code>ThreadPool</code>线程池？</h3>
<p>如果我们在高并发场景下使用<code>Thread</code>创建线程，就会出现一个致命的问题，可以看下面的代码：</p>
<pre><code class="hljs language-cs" lang="cs">            <span class="hljs-comment">// 使用Thread手动创建线程</span>
            {
                Thread thread1 = <span class="hljs-keyword">new</span> Thread(() =&gt;
                {
                    Console.WriteLine(<span class="hljs-string">$"创建了一个线程，线程ID为：<span class="hljs-subst">{Thread.CurrentThread.ManagedThreadId}</span>"</span>);
                });
                thread1.Start();
                Thread thread2 = <span class="hljs-keyword">new</span> Thread(() =&gt;
                {
                    Console.WriteLine(<span class="hljs-string">$"创建了一个线程，线程ID为：<span class="hljs-subst">{Thread.CurrentThread.ManagedThreadId}</span>"</span>);
                });
                thread2.Start();
                <span class="hljs-comment">// 高并发场景下：</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)
                {
                    <span class="hljs-keyword">new</span> Thread(() =&gt;
                    {
                        Console.WriteLine(<span class="hljs-string">$"创建了一个线程，线程ID为：<span class="hljs-subst">{Thread.CurrentThread.ManagedThreadId}</span>"</span>);
                    }).Start();
                }
            }
</code></pre>
<p><strong>运行结果：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8f6f5445b3540fabcf9a68b35393507~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR6KaB5ou_5b6u6L2vTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767071534&amp;x-signature=WdLqcSuTNdvkChY%2FuQnooE%2BvNgo%3D" alt="image.png" loading="lazy"/></p>
<p>结果非常牛逼克拉斯啊，直接创建了一百多个线程，几乎是没有重复的。并且这里只是模拟100个并发，假如有一万个呢？要知道我们普通的电脑总共的线程才只有几千个。所以用<code>Thread</code>手动创建线程是非常不可取的。那咋办呢？</p>
<p>为了不让我们自己手动创建线程，<code>.NET</code>非常贴心的帮我们创建好了线程。<strong>它把这些创建好的线程放在一个池子里，如果我们需要用到其他线程，那就从池子里拿就行，不需要我们自己创建。</strong></p>
<p><strong><code>.NET</code>将这样装有很多线程的池子命名为线程池<code>ThreadPool</code></strong> ,我们来看看线程池的强大之处（现在不需要能理解下面的代码，只需要关注执行结果！！！）：</p>
<pre><code class="hljs language-cs" lang="cs">            <span class="hljs-comment">// 使用线程池的线程</span>
            {
                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)
                {
                    ThreadPool.QueueUserWorkItem(_ =&gt;
                    {
                        Console.WriteLine(<span class="hljs-string">$"创建了一个线程，线程ID为：<span class="hljs-subst">{Thread.CurrentThread.ManagedThreadId}</span>"</span>);
                    });
                }
                Thread.Sleep(<span class="hljs-number">2000</span>); <span class="hljs-comment">// 等任务完成</span>
            }

</code></pre>
<p><strong>运行结果：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f11a6b644f24c8abb430b7f40acc4df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR6KaB5ou_5b6u6L2vTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767071534&amp;x-signature=GlgeIyHF0PM55n9MsxGg2MlLtnE%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到，效果非常明显，原本要创建出100多个线程，现在，只需要线程池给我们创建好的那几个线程就行了，线程复用率大大提高！</p>
<h3 data-id="heading-2">1.2 <code>ThreadPool</code>线程池的工作原理</h3>
<p>看完 1.1 的对比，是不是好奇：为啥线程池能这么牛？100 个任务只复用几个线程就搞定？</p>
<p><strong>首先，用了线程池之后，我们就不需要自己去管理线程的生命周期了：</strong></p>
<p>用<code>Thread</code>时，你得手动<code>new Thread()</code>、<code>Start()</code>启动、甚至手动等线程完成；但线程池帮你包办了所有琐事：</p>
<ul>
<li>你只需要调用<code>ThreadPool.QueueUserWorkItem</code>把任务 “丢进池子”，剩下的启动、执行、复用、回收全由线程池自动处理；</li>
<li>就像你点外卖，只需要下单，不用管骑手是谁、怎么取餐、送完这单去哪 —— 骑手（线程）的调度全由平台（线程池）管。</li>
</ul>
<p><strong>其次，线程池就是一个 “预创建 + 可复用” 的线程仓库，妈妈再也不用担心我滥用线程了：</strong></p>
<p>线程池在程序启动后，会<strong>提前创建少量 “待命线程”</strong> （比如默认先创建 2-4 个），就像公司提前招好的 “待命员工”——</p>
<ul>
<li>当你用<code>ThreadPool.QueueUserWorkItem</code>丢任务时，线程池不会新建线程，而是直接把任务分给 “待命员工”（已有线程）；</li>
<li>这个线程执行完当前任务后，不会销毁，而是回到 “待命状态”，等着接下一个任务；</li>
<li>只有当待命线程全忙、任务还在排队时，线程池才会 “按需新建少量线程”（但不会无限制建），任务少了还会慢慢销毁多余线程。</li>
</ul>
<p><strong><code>Thread</code>和<code>ThreadPool</code>的对比：</strong></p>

























<table><thead><tr><th>操作场景</th><th>手动用 Thread</th><th>用 ThreadPool</th></tr></thead><tbody><tr><td>100 个任务来了</td><td>建 100 个新线程（100 个新骑手）</td><td>复用几个线程（几个骑手跑 100 单）</td></tr><tr><td>任务执行完</td><td>100 个线程全销毁（骑手全离职）</td><td>线程回到待命状态（骑手等下一单）</td></tr><tr><td>资源开销</td><td>内存 / CPU 直接飙高</td><td>资源消耗只有 Thread 的几十分之一</td></tr></tbody></table>
<h3 data-id="heading-3">1.3 <code>ThreadPool</code>的核心用法（如何把任务交给线程池）</h3>
<p>基于前面的原理，我们知道线程池的核心价值是 “复用线程、自动调度”—— <strong>我们不用关心线程的创建、销毁，并且我们无法创建线程池，线程池是由系统创建好的，我们只需要把要执行的 “任务” 交给线程池就行，</strong>。而把任务传给线程池的核心方法，就是 <code>ThreadPool.QueueUserWorkItem(...)</code>。</p>
<p>在讲具体用法前，先搞懂一个基础约定：<strong>线程池要求 “交给它的任务必须符合固定格式”</strong> ，这个格式由<code>WaitCallback</code>委托定义，是线程池和我们的 “沟通规则”。</p>
<p><strong>前置：线程池的任务格式 ——<code>WaitCallback</code></strong></p>
<p>线程池规定：要扔给它执行的任务，必须是 “无返回值、接收一个<code>object</code>类型参数” 的方法。这个规则被封装成了<code>WaitCallback</code>委托，源码核心定义如下（不用记，理解规则就行）：</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">// 线程池的“任务格式约定”：无返回值，参数为object（可传null）</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">delegate</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WaitCallback</span>(<span class="hljs-params"><span class="hljs-built_in">object</span>? state</span>)</span>;
</code></pre>
<p>我们后续调用<code>QueueUserWorkItem</code>时，传的任务本质都是符合这个格式的方法（包括匿名方法）。</p>
<hr/>
<h4 data-id="heading-4">1.3.1 基础用法：无参数的任务</h4>
<p>这个静态方法的签名：
<code>public static bool QueueUserWorkItem(WaitCallback callBack)</code>，接收<code>WaitCallback</code>参数，返回<code>bool</code>类型，返回的<code>Bool</code>类型如果用不到可以不接收。</p>
<p>这里的<code>WaitCallback</code>委托的签名我们再前面介绍过了，这里就直接创建这样的一个委托，然后把它传递到<code>QueueUserWorkItem</code>里就行：</p>
<pre><code class="hljs language-cs" lang="cs">            <span class="hljs-comment">// 只有一个WaitCallback的用法：</span>
            {
                WaitCallback waitCallback = obj =&gt;
                {
                    Console.WriteLine(<span class="hljs-string">$"我被分配给了线程池里的线程，这个线程的id是：<span class="hljs-subst">{Thread.CurrentThread.ManagedThreadId}</span>"</span>);
                };

                ThreadPool.QueueUserWorkItem(waitCallback); 

                <span class="hljs-comment">//Thread.Sleep(2000);</span>

            }
</code></pre>
<p><strong>重点注意：</strong>
可以看到我这里特地写了这样一行代码：<code>//Thread.Sleep(2000);</code>，我注释了这个等待代码，于是执行结果是这样的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49ddee562afc4e2db180bd90be13ce1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR6KaB5ou_5b6u6L2vTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767071534&amp;x-signature=ox%2BoVSunDFUg8mUQNHsGTCybNCc%3D" alt="image.png" loading="lazy"/></p>
<p><strong>什么都没有执行！</strong> 这可不是因为代码写错了，而是因为<strong>线程池里创建好的线程，默认都是后台线程</strong>。而进程不会等待后台线程，只会等待前台线程，所以这里<strong>主线程执行完了后，就直接杀死进程了，程序退出</strong>，线程池里的线程任务不会被执行，于是就什么也没有打印！！！！</p>
<p>当我们把<code>//Thread.Sleep(2000);</code>放开注释后，主线程会在这里卡2秒，2秒后，线程池里的线程大概率是做完了这个任务的，所以就可以正常打印了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4061125fa1d44f5953223889f4adad8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR6KaB5ou_5b6u6L2vTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767071534&amp;x-signature=4TJ5P%2B680BeX0eg528IPUSJb1zI%3D" alt="image.png" loading="lazy"/></p>
<p><strong>用<code>Lambda</code>作为<code>WaitCallback</code>任务传递给<code>ThreadPool.QueueUserWorkItem</code>方法：</strong></p>
<pre><code class="hljs language-cs" lang="cs">            {
                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)
                {
                    ThreadPool.QueueUserWorkItem(obj =&gt;
                    {
                        Console.WriteLine(<span class="hljs-string">$"我被分配给了线程池里的线程，这个线程的id是：<span class="hljs-subst">{Thread.CurrentThread.ManagedThreadId}</span>"</span>);
                    });
                }
                Thread.Sleep(<span class="hljs-number">5000</span>);
            }
</code></pre>
<p><strong>执行结果：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fa9a8c46357469098753b49aa456129~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR6KaB5ou_5b6u6L2vTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767071534&amp;x-signature=eJb7f%2FYIGvZmkfnNOCQJwSzq2bQ%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-5">1.3.2 进阶用法：带参数的任务</h4>
<p>这个静态方法的签名：
<code>  public static bool QueueUserWorkItem(WaitCallback callBack, object? state)</code>，接收一个<code>WaitCallback</code>参数和一个<code>object</code>类型的可空参数，返回<code>bool</code>类型，返回的<code>Bool</code>类型如果用不到可以不接收。</p>
<pre><code class="hljs language-cs" lang="cs">            {
                WaitCallback waitCallback = obj =&gt;
                {
                    Console.WriteLine(<span class="hljs-string">$"我是<span class="hljs-subst">{obj}</span>，我被线程<span class="hljs-subst">{Thread.CurrentThread.ManagedThreadId}</span>执行"</span>);
                };
                ThreadPool.QueueUserWorkItem(waitCallback, <span class="hljs-string">"小王"</span>);
                Thread.Sleep(<span class="hljs-number">2000</span>);
            }
</code></pre>
<p><strong>运行结果</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8363582928234206865e3d2d48f0854a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR6KaB5ou_5b6u6L2vTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767071534&amp;x-signature=9uW50J4owEXRMaMU3er883OlyqQ%3D" alt="image.png" loading="lazy"/></p>
<p>一个更贴近实战的例子：</p>
<pre><code class="hljs language-cs" lang="cs">            <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OrderInfo</span>
            {
               <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> OrderId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }    <span class="hljs-comment">// 订单编号</span>
               <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> UserName { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } <span class="hljs-comment">// 用户名</span>
               <span class="hljs-keyword">public</span> <span class="hljs-built_in">decimal</span> Amount { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }  <span class="hljs-comment">// 订单金额</span>
            }
           {
               List&lt;OrderInfo&gt; orders = <span class="hljs-keyword">new</span> List&lt;OrderInfo&gt;()
               {
                   <span class="hljs-keyword">new</span> OrderInfo() { OrderId = <span class="hljs-number">1</span>, UserName = <span class="hljs-string">"小王"</span>, Amount = <span class="hljs-number">11.5</span>m },
                   <span class="hljs-keyword">new</span> OrderInfo() { OrderId = <span class="hljs-number">2</span>, UserName = <span class="hljs-string">"小明"</span>, Amount = <span class="hljs-number">12.5</span>m },
                   <span class="hljs-keyword">new</span> OrderInfo() { OrderId = <span class="hljs-number">3</span>, UserName = <span class="hljs-string">"小张"</span>, Amount = <span class="hljs-number">13.5</span>m },
                   <span class="hljs-keyword">new</span> OrderInfo() { OrderId = <span class="hljs-number">4</span>, UserName = <span class="hljs-string">"小李"</span>, Amount = <span class="hljs-number">14.5</span>m }
               };
               ThreadPool.QueueUserWorkItem(obj =&gt;
               {

                   <span class="hljs-keyword">var</span> orders = obj <span class="hljs-keyword">as</span> List&lt;OrderInfo&gt;;
                   <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> orderInfo <span class="hljs-keyword">in</span> orders)
                   {
                       Console.WriteLine(<span class="hljs-string">$"id：<span class="hljs-subst">{orderInfo.OrderId}</span>,username = <span class="hljs-subst">{orderInfo.UserName}</span>，Amount = <span class="hljs-subst">{orderInfo.Amount}</span>"</span>);
                   }
               },orders);

               Thread.Sleep(<span class="hljs-number">2000</span>);
               Console.WriteLine(<span class="hljs-string">"所有订单处理完毕"</span>);
           }
</code></pre>
<p><strong>运行结果：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5900a326163543ef80897af5854c45dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR6KaB5ou_5b6u6L2vTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767071534&amp;x-signature=XDglGclCYVZfPYrtKWPdVazCloo%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">1.4 <code>ThreadPool</code>的致命缺点</h4>
<p>前面学了 ThreadPool 的用法，但它有个<strong>实际开发完全绕不开</strong>的致命缺点 ——<strong>我们在主线程并不知道子线程什么时候执行完成，只能无脑使用Thread.Sleep（）来猜子线程执行完了没</strong>。</p>
<p>举个例子：需求：计算 10+20 的和，在主线程中拿到结果并打印。</p>
<h4 data-id="heading-7">用 ThreadPool 实现：如果主线程等待的事件太短了，结果就拿不到！</h4>
<pre><code class="hljs language-cs" lang="cs">            {

                <span class="hljs-built_in">int</span> a = <span class="hljs-number">10</span>, b = <span class="hljs-number">20</span>;
                <span class="hljs-built_in">int</span> sum = <span class="hljs-number">0</span>; <span class="hljs-comment">// 想存计算结果</span>

                <span class="hljs-comment">// 用ThreadPool执行计算任务</span>
                ThreadPool.QueueUserWorkItem(obj =&gt;
                {
                    Thread.Sleep(<span class="hljs-number">1000</span>);
                    sum = a + b; <span class="hljs-comment">// 线程内计算完成，赋值给sum</span>
                    Console.WriteLine(<span class="hljs-string">$"线程池内计算：<span class="hljs-subst">{a}</span>+<span class="hljs-subst">{b}</span>=<span class="hljs-subst">{sum}</span>"</span>);
                });

                Thread.Sleep(<span class="hljs-number">500</span>);
                Console.WriteLine(<span class="hljs-string">$"主线程想拿结果：<span class="hljs-subst">{a}</span>+<span class="hljs-subst">{b}</span>=<span class="hljs-subst">{sum}</span>"</span>);

            }
</code></pre>
<p><strong>运行结果</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">主线程想拿结果：10+<span class="hljs-attr">20</span>=<span class="hljs-number">0</span>
</code></pre>
<h4 data-id="heading-8">问题 1：等待时间不匹配，主线程拿不到正确结果</h4>
<ul>
<li>线程池任务里加了<code>Thread.Sleep(1000)</code>：意味着任务要等 1 秒后，才会给<code>sum</code>赋值为 30；</li>
<li>主线程只加了<code>Thread.Sleep(500)</code>：只等 0.5 秒就去打印<code>sum</code>—— 此时线程池任务还在 “睡觉”，<code>sum</code>还是初始值 0，所以主线程打印<code>10+20=0</code>。</li>
</ul>
<h4 data-id="heading-9">问题 2：主线程退出导致线程池任务直接中断</h4>
<p>主线程打印完<code>sum=0</code>后，整个代码块执行完毕，<strong>进程直接退出</strong>（控制台显示 “已退出，代码为 0”）—— 而线程池任务还没等到 1 秒的睡眠结束，连<code>Console.WriteLine($"线程池内计算：{a}+{b}={sum}")</code>这行都没机会执行，直接被杀死了。</p>
<p>这就是<code>ThreadPool</code>最坑的地方：<strong>你永远没法精准控制 “任务是否执行完”，也没法让主线程 “等任务真的完成再退出”</strong> 。</p>
<hr/>
<h4 data-id="heading-10">对比 Task：一行代码解决所有问题（可靠又优雅）</h4>
<p>同样的需求，用<code>Task</code>改写后，不管是等待还是拿结果，都 100% 可靠，还不会让进程提前退出：</p>
<pre><code class="hljs language-cs" lang="cs">{
    <span class="hljs-built_in">int</span> a = <span class="hljs-number">10</span>, b = <span class="hljs-number">20</span>;

    <span class="hljs-comment">// Task声明：执行一个返回int的任务，哪怕任务要sleep1000ms</span>
    Task&lt;<span class="hljs-built_in">int</span>&gt; sumTask = Task.Run(() =&gt;
    {
        Thread.Sleep(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 模拟任务耗时</span>
        <span class="hljs-built_in">int</span> sum = a + b;
        Console.WriteLine(<span class="hljs-string">$"Task内计算：<span class="hljs-subst">{a}</span>+<span class="hljs-subst">{b}</span>=<span class="hljs-subst">{sum}</span>"</span>);
        <span class="hljs-keyword">return</span> sum; <span class="hljs-comment">// 直接返回结果，不用共享变量</span>
    });

    <span class="hljs-comment">// 核心：精准等待Task完成（不用猜Sleep时间，到底是睡1秒还是睡半秒），拿到结果</span>
    <span class="hljs-built_in">int</span> sum = sumTask.Result; 
    Console.WriteLine(<span class="hljs-string">$"主线程拿到结果：<span class="hljs-subst">{a}</span>+<span class="hljs-subst">{b}</span>=<span class="hljs-subst">{sum}</span>"</span>); <span class="hljs-comment">// 永远是30！</span>
}
</code></pre>
<h4 data-id="heading-11">运行结果（100% 可靠）：</h4>
<pre><code class="hljs language-ini" lang="ini">Task内计算：10+<span class="hljs-attr">20</span>=<span class="hljs-number">30</span>
主线程拿到结果：10+<span class="hljs-attr">20</span>=<span class="hljs-number">30</span>
</code></pre>
<h2 data-id="heading-12">二、Task 任务 —— ThreadPool 的全能升级版</h2>
<p>既然<code>ThreadPool</code>有 “拿不到可靠结果、等待靠瞎猜、进程提前退出” 这些致命缺点，那.NET Core 时代我们该用什么？答案就是<code>Task</code>—— 它完全继承了<code>ThreadPool</code>“线程复用、控数量” 的优点，又把所有痛点全解决了，是实际开发中多线程编程的<strong>首选方案</strong>。</p>
<h3 data-id="heading-13">2.1 Task 的核心定位：为啥能替代 ThreadPool？</h3>
<p>先一句话说清关系：<strong>Task 是 ThreadPool 的 “高级封装”</strong>  ——Task 底层还是用 ThreadPool 的线程执行任务，但给我们提供了更友好、更可靠的 API，完美解决 ThreadPool 的 4 大痛点：</p>






























<table><thead><tr><th>痛点（ThreadPool）</th><th>解决方案（Task）</th><th>新手直观感受</th></tr></thead><tbody><tr><td>任务无返回值</td><td>Task 直接返回强类型结果，不用共享变量</td><td>不用再靠全局变量传值，拿结果更靠谱</td></tr><tr><td>等待靠 Thread.Sleep</td><td>Result/Wait/await 精准等待任务完成</td><td>不用瞎猜 Sleep 多久，任务完了才继续</td></tr><tr><td>进程提前终止任务</td><td>主线程会等 Task 执行完，不会中途杀死任务</td><td>任务不会被莫名中断，逻辑能完整执行</td></tr><tr><td>异常 “悄悄吞掉”</td><td>可捕获 Task 的异常，主线程能感知任务失败</td><td>哪里错了能直接看到，不用猜原因</td></tr></tbody></table>
<h3 data-id="heading-14">2.2 Task 核心语法</h3>
<p>Task 的用法分两类：「手动创建（new Task ()+Start ()）」和「快捷创建（Task.Run ()）」，先学手动创建（理解更透），再学快捷方式（实际开发常用）。</p>
<h4 data-id="heading-15">2.2.1 基础款：new Task() + Start()(手动创建+延时启动)</h4>
<h5 data-id="heading-16">① 构造函数 1：无参、无返回值(最简单的任务)</h5>
<p><strong>适用场景</strong>：只干活不拿结果（比如打印、清理文件、写日志）。</p>
<pre><code class="hljs language-cs" lang="cs">            <span class="hljs-comment">// 用Task定义个任务</span>
            <span class="hljs-comment">// Task构造函数的参数是一个Action委托，我们直接用Lambda表达式传递</span>
            Task task = <span class="hljs-keyword">new</span> Task(() =&gt;
            {
                Console.WriteLine(<span class="hljs-string">"子线程开始执行任务"</span>);
                Console.WriteLine(<span class="hljs-string">$"线程Id：<span class="hljs-subst">{Thread.CurrentThread.ManagedThreadId}</span>"</span>);
                Console.WriteLine(<span class="hljs-string">"子线程结束执行任务"</span>);
            });

            Console.WriteLine(<span class="hljs-string">"主线程不等待，直接执行Start()"</span>);
            <span class="hljs-comment">// 启动任务</span>
            task.Start();
            Console.WriteLine(<span class="hljs-string">"遇到了Wait(),主线程开始等待子线程执行结束，并且不需要猜子线程什么时候结束完毕"</span>);
            task.Wait();
            Console.WriteLine(<span class="hljs-string">"Wait()结束，主线程结束等待子线程执行结束"</span>);
</code></pre>
<p><strong>执行结果：</strong></p>
<pre><code class="hljs language-scss" lang="scss">主线程不等待，直接执行<span class="hljs-built_in">Start</span>()
遇到了Wait(),主线程开始等待子线程执行结束，并且不需要猜子线程什么时候结束完毕
子线程开始执行任务
线程Id：<span class="hljs-number">6</span>
子线程结束执行任务
Wait()结束，主线程结束等待子线程执行结束
</code></pre>
<ul>
<li><code>new Task(...)</code> 只是 “定义任务”，不是 “执行任务”；</li>
<li><code>Start()</code> 是 “启动任务” 的唯一方式（漏写就白定义）；</li>
<li><code>Wait()</code> 是 “精准等待”，替代 ThreadPool 的 <code>Thread.Sleep</code> 瞎猜。</li>
</ul>
<h5 data-id="heading-17">② 构造函数 2：带参数（给任务传递数据）</h5>
<p><strong>适用场景</strong>：任务需要外部数据（比如给指定用户发消息、处理指定订单）。</p>
<pre><code class="hljs language-cs" lang="cs">                <span class="hljs-comment">// 此时的构造函数是：Task.Task(Action&lt;object?&gt; action, object? state)</span>
                <span class="hljs-comment">// 所以我们要传递一个带object类型的委托，还要传递一个object类型的参数</span>
                Task task = <span class="hljs-keyword">new</span> Task(obj =&gt;
                {
                    <span class="hljs-built_in">string</span> <span class="hljs-keyword">nameof</span> = obj <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
                    Console.WriteLine(<span class="hljs-string">$"欢迎<span class="hljs-subst">{obj}</span>"</span>);
                },<span class="hljs-string">"张三"</span>);

                <span class="hljs-comment">// 从线程池中找个线程执行这个task任务</span>
                task.Start();
                <span class="hljs-comment">// 主线程阻塞等待子线程</span>
                task.Wait();
</code></pre>
<p><strong>运行结果</strong>：</p>
<pre><code class="hljs language-cs" lang="cs">欢迎张三
</code></pre>
<p><strong>要点</strong>：</p>
<ul>
<li>参数是 <code>object</code> 类型，任务内要手动转换为目标类型（用 <code>is/as</code> 最安全）；</li>
<li>可传任意复杂参数（比如 <code>new OrderInfo { OrderId = 1001 }</code>），只需在任务内转换为 <code>OrderInfo</code>。</li>
</ul>
<h5 data-id="heading-18">③ 构造函数 3：可以取消</h5>
<p><strong>适用场景</strong>：任务可能需要中途终止（比如用户取消操作、超时、条件不满足）。</p>
<p>核心工具：<code>CancellationTokenSource</code>（简称 CTS，“叫停哨子”）+ <code>CancellationToken</code>（“令牌”，传给任务让它能听到叫停）。</p>
<pre><code class="hljs language-cs" lang="cs">                <span class="hljs-keyword">using</span> CancellationTokenSource cts = <span class="hljs-keyword">new</span> CancellationTokenSource();

                <span class="hljs-comment">// 此时构造函数是：Task(Action, CancellationToken)</span>
                <span class="hljs-comment">// 意味着我们要传递一个Action 和一个CancellationToken</span>
                Task task = <span class="hljs-keyword">new</span> Task(() =&gt;
                {
                    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)
                    {
                        <span class="hljs-keyword">if</span> (cts.Token.IsCancellationRequested)
                        {
                            Console.WriteLine(<span class="hljs-string">$"子线程<span class="hljs-subst">{Thread.CurrentThread.ManagedThreadId}</span> 任务被取消，不执行任务了......"</span>);
                            <span class="hljs-keyword">return</span>;
                        }
                        Console.WriteLine(<span class="hljs-string">$"子线程<span class="hljs-subst">{Thread.CurrentThread.ManagedThreadId}</span> 执行任务中......"</span>);
                        Thread.Sleep(<span class="hljs-number">500</span>);
                    }
                }, cts.Token);

                <span class="hljs-comment">// 找了个空闲的子线程执行任务</span>
                Console.WriteLine(<span class="hljs-string">"遇到了Start()，找了个空闲的子线程执行task任务"</span>);
                task.Start();

                Thread.Sleep(<span class="hljs-number">2000</span>);
                Console.WriteLine(<span class="hljs-string">"遇到了Cancel，子线程的任务被取消了"</span>);
                cts.Cancel();

                Console.WriteLine(<span class="hljs-string">"遇到了Wait()，如果子线程没执行完，主线程阻塞等待，如果执行完了直接走"</span>);
                task.Wait();
</code></pre>
<p><strong>运行结果</strong>：</p>
<pre><code class="hljs language-erlang" lang="erlang">遇到了Start()，找了个空闲的子线程执行task任务
子线程<span class="hljs-number">6</span> 执行任务中......
子线程<span class="hljs-number">6</span> 执行任务中......
子线程<span class="hljs-number">6</span> 执行任务中......
子线程<span class="hljs-number">6</span> 执行任务中......
遇到了Cancel，子线程的任务被取消了
遇到了Wait()，如果子线程没执行完，主线程阻塞等待，如果执行完了直接走
子线程<span class="hljs-number">6</span> 任务被取消，不执行任务了......
</code></pre>
<p><strong>要点</strong>：</p>
<ul>
<li>取消任务的核心是「任务内主动用<code>if</code>检测令牌」，只喊 <code>Cancel()</code> 不检测，任务会继续干；</li>
<li>CTS 用完要用using 自动释放，不然会占内存。</li>
</ul>
<h4 data-id="heading-19">3.1.4 构造函数 4：有返回值（Task，拿任务结果）</h4>
<p><strong>适用场景</strong>：任务干完要拿结果（比如计算求和、查询数据、调用接口返回值）—— 这是替代 ThreadPool 的核心优势！</p>
<pre><code class="hljs language-cs" lang="cs">                <span class="hljs-comment">// 使用有返回值的构造函数Task&lt;T&gt;(Func&lt;int&gt; function)</span>
                Task&lt;<span class="hljs-built_in">int</span>&gt; task = <span class="hljs-keyword">new</span> Task&lt;<span class="hljs-built_in">int</span>&gt;(() =&gt;
                {
                    Console.WriteLine(<span class="hljs-string">"任务开始，我负责计算20+10"</span>);
                    <span class="hljs-keyword">return</span> <span class="hljs-number">20</span>+<span class="hljs-number">10</span>;
                });

                Console.WriteLine(<span class="hljs-string">"遇到Start:找了个线程开始执行task任务"</span>);
                task.Start();

                Console.WriteLine(<span class="hljs-string">"遇到Result:主线程阻塞了，等待子线程执行完毕"</span>);
                <span class="hljs-built_in">int</span> sum = task.Result;

                Console.WriteLine(<span class="hljs-string">$"子任务执行完毕了，结果是<span class="hljs-subst">{sum}</span>"</span>);

</code></pre>
<p><strong>运行结果</strong>：</p>
<pre><code class="hljs language-cs" lang="cs">遇到Start:找了个线程开始执行task任务
遇到Result:主线程阻塞了，等待子线程执行完毕
任务开始，我负责计算<span class="hljs-number">20</span>+<span class="hljs-number">10</span>
子任务执行完毕了，结果是<span class="hljs-number">30</span>
</code></pre>
<p><strong>要点</strong>：</p>
<ul>
<li>有返回值的任务要用 <code>Task&lt;T&gt;</code>（T 是结果类型，比如 <code>Task&lt;string&gt;</code> 返回字符串，<code>Task&lt;OrderInfo&gt;</code> 返回自定义对象）；</li>
<li><code>Result</code> 是 “阻塞式获取结果”：主线程会等任务干完，再拿到结果（不用像 ThreadPool 那样靠共享变量传值）。</li>
</ul>
<h3 data-id="heading-20">3.2 快捷款：Task.Run ()（创建 + 立即启动，实际开发首选）</h3>
<p><code>Task.Run()</code> 是 <code>new Task()+Start()</code> 的快捷写法 —— 少写一行 <code>Start()</code>，直接创建并启动任务，90% 的业务场景用这个就够。</p>
<h4 data-id="heading-21">3.2.1 无返回值（替代 new Task (()=&gt;{...}).Start ()）</h4>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">// 一行搞定：创建+启动无返回值任务</span>
            Task task = Task.Run(() =&gt;
            {
                Console.WriteLine(<span class="hljs-string">"开始执行任务啦~~"</span>);
            });
            Console.WriteLine(<span class="hljs-string">"主线程开始等待"</span>);
            task.Wait();
            Console.WriteLine(<span class="hljs-string">"主线程等待结束"</span>);
</code></pre>
<p><strong>执行结果：</strong></p>
<pre><code class="hljs">主线程开始等待
开始执行任务啦~~
主线程等待结束    
</code></pre>
<h4 data-id="heading-22">3.2.2 有返回值（替代 new Task(()=&gt;{...}).Start()）</h4>
<pre><code class="hljs language-cs" lang="cs">            Task&lt;<span class="hljs-built_in">int</span>&gt; task = Task.Run(() =&gt;
            {
                <span class="hljs-keyword">return</span> DateTime.Now.Year;
            });

            <span class="hljs-built_in">int</span> sum = task.Result;
            Console.WriteLine(<span class="hljs-string">$"今年是<span class="hljs-subst">{sum}</span>年"</span>);
</code></pre>
<h4 data-id="heading-23">3.2.3 带参数（小技巧：用闭包传参，比构造函数更简洁）</h4>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-built_in">string</span> userName = <span class="hljs-string">"李四"</span>; <span class="hljs-comment">// 要传的参数</span>
Task paramTask = Task.Run(() =&gt;
{
    <span class="hljs-comment">// 直接用外部变量（闭包），不用转obj，更简洁</span>
    Console.WriteLine(<span class="hljs-string">$"✅ 欢迎 <span class="hljs-subst">{userName}</span>！"</span>);
});
paramTask.Wait();
</code></pre>
<h2 data-id="heading-24">四、Task 的等待方式（精准等待，不用瞎猜）</h2>
<p>除了单个任务的 <code>Wait()</code>，Task 还支持「批量等待」，满足复杂场景：</p>
<h3 data-id="heading-25">4.1 等待单个任务：Task.Wait ()</h3>
<pre><code class="hljs language-cs" lang="cs">Task task = Task.Run(() =&gt; Thread.Sleep(<span class="hljs-number">1000</span>));
task.Wait(); <span class="hljs-comment">// 等这个任务干完</span>
</code></pre>
<h3 data-id="heading-26">4.2 等待所有任务：Task.WaitAll ()</h3>
<p><strong>适用场景</strong>：批量任务都干完才继续（比如批量查询数据，汇总所有结果）。</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">// 创建3个任务</span>
Task t1 = Task.Run(() =&gt; { Thread.Sleep(<span class="hljs-number">500</span>); Console.WriteLine(<span class="hljs-string">" t1干完"</span>); });
Task t2 = Task.Run(() =&gt; { Thread.Sleep(<span class="hljs-number">1000</span>); Console.WriteLine(<span class="hljs-string">" t2干完"</span>); });
Task t3 = Task.Run(() =&gt; { Thread.Sleep(<span class="hljs-number">1500</span>); Console.WriteLine(<span class="hljs-string">" t3干完"</span>); });

<span class="hljs-comment">// 等所有任务干完（等最慢的t3，耗时1.5秒）</span>
Task.WaitAll(t1, t2, t3);
Console.WriteLine(<span class="hljs-string">" 所有任务都干完了，汇总结果"</span>);
</code></pre>
<h3 data-id="heading-27">4.3 等待任意一个任务：Task.WaitAny ()</h3>
<p><strong>适用场景</strong>：多个任务抢跑，拿到第一个结果就继续（比如多源查询，缓存比数据库快，拿缓存结果就返回）。</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">// 创建2个任务（缓存查询快，数据库查询慢）</span>
Task cacheTask = Task.Run(() =&gt; { Thread.Sleep(<span class="hljs-number">500</span>); Console.WriteLine(<span class="hljs-string">" 缓存查询完成"</span>); });
Task dbTask = Task.Run(() =&gt; { Thread.Sleep(<span class="hljs-number">2000</span>); Console.WriteLine(<span class="hljs-string">" 数据库查询完成"</span>); });

<span class="hljs-comment">// 等第一个任务干完（cacheTask先完成，耗时0.5秒）</span>
Task.WaitAny(cacheTask, dbTask);
Console.WriteLine(<span class="hljs-string">" 拿到第一个结果，直接返回"</span>);
</code></pre>
<h2 data-id="heading-28">五、Task 的异常处理（不吞异常，新手能定位问题）</h2>
<p>ThreadPool 的异常会 “悄悄消失”，Task 会把异常包装在 <code>AggregateException</code> 里，主线程能精准捕获。</p>
<h3 data-id="heading-29">5.1 单个任务的异常捕获</h3>
<pre><code class="hljs language-cs" lang="cs">Task errorTask = Task.Run(() =&gt;
{
    <span class="hljs-comment">// 模拟任务出错：除以0</span>
    <span class="hljs-built_in">int</span> num = <span class="hljs-number">0</span>;
    <span class="hljs-built_in">int</span> result = <span class="hljs-number">10</span> / num;
});

<span class="hljs-keyword">try</span>
{
    errorTask.Wait(); <span class="hljs-comment">// 调用Wait/Result时，异常会抛到主线程</span>
}
<span class="hljs-keyword">catch</span> (AggregateException ex)
{
    <span class="hljs-comment">// 遍历InnerExceptions，拿到真实异常</span>
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> innerEx <span class="hljs-keyword">in</span> ex.InnerExceptions)
    {
        Console.WriteLine(<span class="hljs-string">$"捕获异常：<span class="hljs-subst">{innerEx.GetType().Name}</span> - <span class="hljs-subst">{innerEx.Message}</span>"</span>);
    }
}
</code></pre>
<p><strong>运行结果</strong>：</p>
<pre><code class="hljs">捕获异常：DivideByZeroException - 尝试除以零。
</code></pre>
<h3 data-id="heading-30">5.2 批量任务的异常捕获</h3>
<pre><code class="hljs language-cs" lang="cs">Task t1 = Task.Run(() =&gt; { <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-string">"参数为空"</span>); });
Task t2 = Task.Run(() =&gt; { <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IndexOutOfRangeException(<span class="hljs-string">"索引越界"</span>); });

<span class="hljs-keyword">try</span>
{
    Task.WaitAll(t1, t2);
}
<span class="hljs-keyword">catch</span> (AggregateException ex)
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> innerEx <span class="hljs-keyword">in</span> ex.InnerExceptions)
    {
        Console.WriteLine(<span class="hljs-string">$"🚫 异常：<span class="hljs-subst">{innerEx.Message}</span>"</span>);
    }
}
</code></pre>
<h2 data-id="heading-31">六、Task 的进阶：async/await（语法糖，简化异步代码）</h2>
<p><code>async/await</code> 是 Task 的 “语法糖”—— 不用写 <code>Wait()</code>/<code>Result</code>，让异步代码看起来像同步代码，新手学完基础后必学。</p>
<h3 data-id="heading-32">6.1 基础用法（异步计算求和）</h3>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">// 步骤1：定义异步方法（标记async，返回Task/Task&lt;T&gt;）</span>
<span class="hljs-function"><span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">CalculateSumAsync</span>()</span>
{
    <span class="hljs-comment">// 步骤2：await 替代 Wait()/Result，非阻塞等待</span>
    <span class="hljs-built_in">int</span> sum = <span class="hljs-keyword">await</span> Task.Run(() =&gt;
    {
        Thread.Sleep(<span class="hljs-number">1000</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">10</span> + <span class="hljs-number">20</span>;
    });
    <span class="hljs-keyword">return</span> sum;
}

<span class="hljs-comment">// 步骤3：调用异步方法（控制台程序需Wait，WinForm/Web不用）</span>
<span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">Main</span>()</span>
{
    <span class="hljs-built_in">int</span> sum = <span class="hljs-keyword">await</span> CalculateSumAsync();
    Console.WriteLine(<span class="hljs-string">$"🏁 结果：<span class="hljs-subst">{sum}</span>"</span>); <span class="hljs-comment">// 输出30</span>
}

<span class="hljs-comment">// 执行入口</span>
Main().Wait();
</code></pre>
<p><strong>核心规则</strong>：</p>
<ul>
<li>方法必须标记 <code>async</code>；</li>
<li>返回值是 <code>Task</code>（无返回值）或 <code>Task&lt;T&gt;</code>（有返回值）；</li>
<li>用 <code>await</code> 等待 Task 完成，代码更简洁，不阻塞线程。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Chrome DevTools 详解系列之 Console 面板]]></title>    <link>https://juejin.cn/post/7586579021283737654</link>    <guid>https://juejin.cn/post/7586579021283737654</guid>    <pubDate>2025-12-23T02:38:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586579021283737654" data-draft-id="7586582977707704362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Chrome DevTools 详解系列之 Console 面板"/> <meta itemprop="keywords" content="JavaScript,Chrome"/> <meta itemprop="datePublished" content="2025-12-23T02:38:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="八哥程序员"/> <meta itemprop="url" content="https://juejin.cn/user/114004940297325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Chrome DevTools 详解系列之 Console 面板
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/114004940297325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    八哥程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:38:55.000Z" title="Tue Dec 23 2025 02:38:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">🚀 Chrome DevTools Console 面板高级用法完全指南</h2>
<blockquote>
<p>作为前端开发者，Console 面板是我们日常工作中最常用的工具之一。但大多数开发者可能只使用了其 20% 的功能，而忽略了那些能大幅提升开发效率的高级特性。本文将深入探索 Console 面板的高级用法，帮助你从"会用"提升到"精通"。</p>
</blockquote>
<h3 data-id="heading-1">📋 一、基础回顾：Console 面板的核心功能</h3>
<p>在深入高级用法之前，让我们快速回顾一下 Console 面板的核心功能：</p>
<ol>
<li><strong>日志输出</strong>：<code>console.log()</code>、<code>console.info()</code>、<code>console.warn()</code>、<code>console.error()</code></li>
<li><strong>断言功能</strong>：<code>console.assert()</code></li>
<li><strong>计数功能</strong>：<code>console.count()</code>、<code>console.countReset()</code></li>
<li><strong>计时功能</strong>：<code>console.time()</code>、<code>console.timeEnd()</code></li>
<li><strong>分组功能</strong>：<code>console.group()</code>、<code>console.groupEnd()</code>、<code>console.groupCollapsed()</code></li>
<li><strong>表格输出</strong>：<code>console.table()</code></li>
<li><strong>清除控制台</strong>：<code>console.clear()</code></li>
</ol>
<p align="center">图一</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8c22f605adc4ca996260e7dd544f465~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWr5ZOl56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767062335&amp;x-signature=wPpFDRhb63DW%2Bel0FkC639BZFVA%3D" alt="6751645b-3a12-4afb-955a-1b7bb724523d.png" loading="lazy"/></p>
<p align="center">图二</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac3879ced1aa46c8a5cf996b863afcd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWr5ZOl56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767062335&amp;x-signature=1ZReUJ1%2B1tv4qo%2BfMRwsbcHynJM%3D" alt="75e13492-c4fe-404f-909c-26e82331cc66.png" loading="lazy"/></p>
<p align="center">图三</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43224096d9ed4d2c868ad845d3dbc9db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWr5ZOl56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767062335&amp;x-signature=6l1pEHXNrfwOow20nH5HkMRsREc%3D" alt="93eaba3f-2c37-4d35-b860-3fd054dff333.png" loading="lazy"/></p>
<p align="center">图四</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a19cb289e4a0490c8912da07fa5f5733~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWr5ZOl56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767062335&amp;x-signature=YMBCl2FKJjLYfDOJN9BaNCTuH1s%3D" alt="65ae199b-52c6-4a55-8238-e4c577561bac.png" loading="lazy"/></p>
<p align="center">图五</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47644fea6dc04305a8537ed30cacbede~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWr5ZOl56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767062335&amp;x-signature=Z6WTudEKr%2BzDPKieuAqOJp9nnIQ%3D" alt="df8f1943-8b6f-4d3a-87ab-f979c5e7119c.png" loading="lazy"/></p>
<p align="center">图六</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/825346d9cf994e388f74975dcdc4dc40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWr5ZOl56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767062335&amp;x-signature=xEBH8zux342impp3EKpfTeYcQVc%3D" alt="7df43f42-2951-4b8b-9a88-8225c76bf506.png" loading="lazy"/></p>
<p>这些基础功能大家都很熟悉，但 Console 面板远不止这些。接下来，让我们探索其高级特性。</p>
<h3 data-id="heading-2">⚡ 二、高级命令与快捷操作</h3>
<h4 data-id="heading-3">🔍 1. 选择 DOM 元素</h4>
<p>在 Console 中，你可以使用以下快捷方式快速选择 DOM 元素：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 选择当前选中的元素（在 Elements 面板中）</span>
$0

<span class="hljs-comment">// 选择上一个选中的元素</span>
$1

<span class="hljs-comment">// 选择上上个选中的元素</span>
$2

<span class="hljs-comment">// 类似于 document.querySelector()</span>
$(<span class="hljs-string">'selector'</span>)

<span class="hljs-comment">// 类似于 document.querySelectorAll()</span>
$$(<span class="hljs-string">'selector'</span>)
</code></pre>
<p><strong>案例</strong>：快速获取并修改页面元素</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取第一个 div 元素</span>
<span class="hljs-keyword">const</span> firstDiv = $(<span class="hljs-string">'div'</span>);

<span class="hljs-comment">// 修改其样式</span>
firstDiv.<span class="hljs-property">style</span>.<span class="hljs-property">backgroundColor</span> = <span class="hljs-string">'red'</span>;

<span class="hljs-comment">// 获取所有按钮元素并添加点击事件</span>
$$(<span class="hljs-string">'button'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">btn</span> =&gt;</span> {
    btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Button clicked!'</span>));
});
</code></pre>
<h4 data-id="heading-4">🛠️ 2. 命令行 API 高级用法</h4>
<h5 data-id="heading-5">🎯 （1）监控 DOM 事件</h5>
<p>使用 <code>monitorEvents()</code> 可以监控指定元素的事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 监控按钮的所有事件</span>
<span class="hljs-keyword">const</span> button = $(<span class="hljs-string">'button'</span>);
<span class="hljs-title function_">monitorEvents</span>(button);

<span class="hljs-comment">// 监控按钮的特定事件</span>
<span class="hljs-title function_">monitorEvents</span>(button, [<span class="hljs-string">'click'</span>, <span class="hljs-string">'mouseover'</span>]);

<span class="hljs-comment">// 停止监控</span>
<span class="hljs-title function_">unmonitorEvents</span>(button);
</code></pre>
<p>当事件触发时，控制台会输出事件对象，便于调试事件流和状态变化</p>
<h5 data-id="heading-6">📊 （2）检查元素属性</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检查元素的所有属性</span>
<span class="hljs-title function_">dir</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>);

<span class="hljs-comment">// 检查元素的计算样式</span>
<span class="hljs-title function_">getComputedStyle</span>($(<span class="hljs-string">'div'</span>));

<span class="hljs-comment">// 获取元素的尺寸和位置</span>
<span class="hljs-title function_">getBoundingClientRect</span>($(<span class="hljs-string">'div'</span>));
</code></pre>
<h5 data-id="heading-7">⏱️ （3）性能相关命令</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 开始录制性能</span>
performance.<span class="hljs-title function_">mark</span>(<span class="hljs-string">'start'</span>);

<span class="hljs-comment">// 执行一些操作</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
    <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    div.<span class="hljs-property">textContent</span> = i;
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(div);
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(div);
}

<span class="hljs-comment">// 结束录制并查看结果</span>
performance.<span class="hljs-title function_">mark</span>(<span class="hljs-string">'end'</span>);
performance.<span class="hljs-title function_">measure</span>(<span class="hljs-string">'loop'</span>, <span class="hljs-string">'start'</span>, <span class="hljs-string">'end'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">table</span>(performance.<span class="hljs-title function_">getEntriesByName</span>(<span class="hljs-string">'loop'</span>));
</code></pre>
<h3 data-id="heading-8">🔧 三、高级调试技巧</h3>
<h4 data-id="heading-9">🎯 1. 条件断点</h4>
<p>虽然条件断点通常在 Sources 面板设置，但 Console 面板也能实现类似功能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 仅当 i 为 500 时输出日志</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
    <span class="hljs-keyword">if</span> (i === <span class="hljs-number">500</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Reached 500:'</span>, i);
    }
    <span class="hljs-comment">// 其他操作</span>
}
</code></pre>
<h4 data-id="heading-10">🔄 2. 调试 DOM 变化</h4>
<p>使用 <code>MutationObserver</code> 监控 DOM 变化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-function">(<span class="hljs-params">mutations</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'DOM 变化:'</span>, mutations);
});

observer.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>, {
    <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">attributes</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">characterData</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span>
});
</code></pre>
<h4 data-id="heading-11">🚦 3. 调试异步代码</h4>
<p>使用 <code>debugger</code> 语句和 <code>await</code> 调试异步代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/data'</span>);
        <span class="hljs-keyword">debugger</span>; <span class="hljs-comment">// 在这里设置断点</span>
        <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Data:'</span>, data);
        <span class="hljs-keyword">return</span> data;
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error:'</span>, error);
    }
}

<span class="hljs-title function_">fetchData</span>();
</code></pre>
<h3 data-id="heading-12">📝 四、Console API 进阶</h3>
<h4 data-id="heading-13">🌈 1. 格式化输出</h4>
<p>Console 支持多种格式化选项：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基本格式化</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hello %s, you are %d years old'</span>, <span class="hljs-string">'John'</span>, <span class="hljs-number">30</span>);

<span class="hljs-comment">// 样式化输出</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'%cThis is styled text'</span>, <span class="hljs-string">'color: red; font-size: 20px; font-weight: bold;'</span>);

<span class="hljs-comment">// 组合样式</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
    <span class="hljs-string">'%cWarning:%c This is a %cstyled%c message'</span>,
    <span class="hljs-string">'color: orange; font-weight: bold;'</span>,
    <span class="hljs-string">''</span>,
    <span class="hljs-string">'color: red; text-decoration: underline;'</span>,
    <span class="hljs-string">''</span>
);
</code></pre>
<p>Console 的格式化输出功能允许开发者以特定方式控制文本的显示效果，包括样式、布局和数据结构</p>
<h4 data-id="heading-14">2. 自定义日志级别</h4>
<p>你可以创建自己的日志函数，实现更灵活的日志管理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 自定义日志函数，支持不同级别和样式
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">level</span> - 日志级别 (debug, info, warn, error)
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">message</span> - 日志消息
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">data</span> - 附加数据
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">level, message, data = <span class="hljs-literal">null</span></span>) {
    <span class="hljs-keyword">const</span> styles = {
        <span class="hljs-attr">debug</span>: <span class="hljs-string">'color: blue;'</span>,
        <span class="hljs-attr">info</span>: <span class="hljs-string">'color: green;'</span>,
        <span class="hljs-attr">warn</span>: <span class="hljs-string">'color: orange;'</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">'color: red; font-weight: bold;'</span>
    };
    
    <span class="hljs-keyword">const</span> timestamp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
        <span class="hljs-string">`%c[<span class="hljs-subst">${timestamp}</span>] [<span class="hljs-subst">${level.toUpperCase()}</span>] <span class="hljs-subst">${message}</span>`</span>,
        styles[level],
        data || <span class="hljs-string">''</span>
    );
}

<span class="hljs-comment">// 使用自定义日志</span>
<span class="hljs-title function_">log</span>(<span class="hljs-string">'debug'</span>, <span class="hljs-string">'This is a debug message'</span>);
<span class="hljs-title function_">log</span>(<span class="hljs-string">'info'</span>, <span class="hljs-string">'User logged in'</span>, { <span class="hljs-attr">userId</span>: <span class="hljs-number">123</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">'john_doe'</span> });
<span class="hljs-title function_">log</span>(<span class="hljs-string">'warn'</span>, <span class="hljs-string">'Deprecated function used'</span>);
<span class="hljs-title function_">log</span>(<span class="hljs-string">'error'</span>, <span class="hljs-string">'API request failed'</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">404</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/data'</span> });
</code></pre>
<h4 data-id="heading-15">3. 堆快照与内存分析</h4>
<p>使用 Console 进行内存分析：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 手动触发垃圾回收（仅在开发者工具打开时可用）</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">gc</span>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">gc</span>();
}

<span class="hljs-comment">// 创建堆快照</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">takeHeapSnapshot</span>();

<span class="hljs-comment">// 比较堆快照</span>
<span class="hljs-keyword">const</span> snapshot1 = <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">takeHeapSnapshot</span>();
<span class="hljs-comment">// 执行一些操作</span>
<span class="hljs-keyword">const</span> snapshot2 = <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">takeHeapSnapshot</span>();
<span class="hljs-comment">// 比较两个快照的差异</span>
</code></pre>
<p>注意兼容性，有些浏览器不支持！当前我用的chrome 143.0.7499.148 不支持</p>
<h3 data-id="heading-16">五、实际应用案例</h3>
<h4 data-id="heading-17">1. 性能优化案例：监控函数执行时间</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 性能监控装饰器
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} <span class="hljs-variable">func</span> - 要监控的函数
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Function</span>} - 包装后的函数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">withPerformanceMonitoring</span>(<span class="hljs-params">func</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
        <span class="hljs-keyword">const</span> functionName = func.<span class="hljs-property">name</span> || <span class="hljs-string">'anonymous'</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(functionName);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> result = func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(functionName);
            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(functionName);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error in <span class="hljs-subst">${functionName}</span>:`</span>, error);
            <span class="hljs-keyword">throw</span> error;
        }
    };
}

<span class="hljs-comment">// 使用装饰器</span>
<span class="hljs-keyword">const</span> slowFunction = <span class="hljs-title function_">withPerformanceMonitoring</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">slowFunction</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
        <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(i);
    }
});

<span class="hljs-title function_">slowFunction</span>(); <span class="hljs-comment">// 输出: slowFunction: 12.345ms</span>
</code></pre>
<h4 data-id="heading-18">2. 调试案例：追踪函数调用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 函数调用追踪器
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">obj</span> - 包含要追踪方法的对象
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string[]</span>} <span class="hljs-variable">methods</span> - 要追踪的方法名数组
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">traceFunctionCalls</span>(<span class="hljs-params">obj, methods</span>) {
    methods.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">methodName</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> originalMethod = obj[methodName];
        
        obj[methodName] = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[TRACE] <span class="hljs-subst">${methodName}</span> called with args:`</span>, args);
            <span class="hljs-keyword">const</span> result = originalMethod.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[TRACE] <span class="hljs-subst">${methodName}</span> returned:`</span>, result);
            <span class="hljs-keyword">return</span> result;
        };
    });
}

<span class="hljs-comment">// 使用追踪器</span>
<span class="hljs-keyword">const</span> calculator = {
    <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a + b; },
    <span class="hljs-title function_">subtract</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a - b; }
};

<span class="hljs-title function_">traceFunctionCalls</span>(calculator, [<span class="hljs-string">'add'</span>, <span class="hljs-string">'subtract'</span>]);

calculator.<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>); <span class="hljs-comment">// 输出调用和返回信息</span>
</code></pre>
<h4 data-id="heading-19">3. 开发辅助：创建临时 UI 调试工具</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 创建一个临时调试面板
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">data</span> - 要显示的数据
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createDebugPanel</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> panel = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    panel.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px;
        border-radius: 5px;
        z-index: 9999;
        font-family: monospace;
        max-width: 300px;
        max-height: 400px;
        overflow-y: auto;
    `</span>;
    
    <span class="hljs-keyword">const</span> closeBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'button'</span>);
    closeBtn.<span class="hljs-property">textContent</span> = <span class="hljs-string">'×'</span>;
    closeBtn.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
        position: absolute;
        top: 5px;
        right: 5px;
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
    `</span>;
    
    closeBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(panel);
    });
    
    panel.<span class="hljs-title function_">appendChild</span>(closeBtn);
    
    <span class="hljs-keyword">const</span> content = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'pre'</span>);
    content.<span class="hljs-property">textContent</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>);
    panel.<span class="hljs-title function_">appendChild</span>(content);
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(panel);
}

<span class="hljs-comment">// 使用调试面板</span>
<span class="hljs-title function_">createDebugPanel</span>({
    <span class="hljs-attr">user</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">123</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span> },
    <span class="hljs-attr">appState</span>: { <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">theme</span>: <span class="hljs-string">'dark'</span> },
    <span class="hljs-attr">performance</span>: { <span class="hljs-attr">loadTime</span>: <span class="hljs-number">1234</span>, <span class="hljs-attr">apiCalls</span>: <span class="hljs-number">5</span> }
});
</code></pre>
<h3 data-id="heading-20">六、Console 面板的隐藏功能</h3>
<h4 data-id="heading-21">1. 实时表达式</h4>
<p>Console 面板顶部有一个"Create Live Expression"按钮（眼睛图标），可以创建实时更新的表达式。这对于监控变量变化、DOM 属性或性能指标非常有用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25d12334d9104298bbced00b88ef0ef3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWr5ZOl56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767062335&amp;x-signature=YOfNQX2Yu7CvoHJqdDUsNylU%2FM4%3D" alt="ae4c03fc-94d6-44ad-bf03-7120af8ed017.png" loading="lazy"/>
<strong>使用场景</strong>：</p>
<ul>
<li>监控页面滚动位置：<code>window.scrollY</code></li>
<li>监控元素尺寸：<code>$('div').offsetHeight</code></li>
<li>监控时间变化：<code>new Date().toLocaleTimeString()</code></li>
</ul>
<h4 data-id="heading-22">2. 网络请求模拟</h4>
<p>使用 <code>fetch</code> 或 <code>XMLHttpRequest</code> 在 Console 中模拟网络请求：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 fetch 模拟 POST 请求</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/data'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>,
        <span class="hljs-attr">email</span>: <span class="hljs-string">'john@example.com'</span>
    })
})
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Response:'</span>, data))
.<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error:'</span>, error));
</code></pre>
<h4 data-id="heading-23">3. 全局变量检查</h4>
<p>使用 <code>window</code> 对象检查全局变量：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 列出所有全局变量</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">window</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> !key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'_'</span>));

<span class="hljs-comment">// 检查是否存在某个全局变量</span>
<span class="hljs-string">'jQuery'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>; <span class="hljs-comment">// 检查 jQuery 是否加载</span>

<span class="hljs-comment">// 监控全局变量变化</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">window</span>, <span class="hljs-string">'myGlobalVar'</span>, {
    <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_myGlobalVar</span>; },
    <span class="hljs-title function_">set</span>(<span class="hljs-params">value</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'myGlobalVar changed from'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">_myGlobalVar</span>, <span class="hljs-string">'to'</span>, value);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_myGlobalVar</span> = value;
    }
});
</code></pre>
<h3 data-id="heading-24">七、最佳实践与注意事项</h3>
<ol>
<li><strong>避免在生产环境中留下控制台日志</strong>：使用构建工具移除或禁用生产环境的控制台输出</li>
<li><strong>使用适当的日志级别</strong>：根据消息的重要性选择合适的日志方法</li>
<li><strong>保持日志简洁</strong>：避免输出过多不必要的信息</li>
<li><strong>使用分组和表格</strong>：对于复杂数据，使用 <code>console.group()</code> 和 <code>console.table()</code> 提高可读性</li>
<li><strong>定期清理控制台</strong>：使用 <code>console.clear()</code> 保持控制台整洁</li>
<li><strong>利用条件日志</strong>：在开发环境中使用环境变量控制日志输出</li>
</ol>
<h3 data-id="heading-25">八、总结</h3>
<p>Chrome DevTools Console 面板是一个功能强大的工具，掌握其高级用法可以大幅提升开发效率。本文介绍了 Console 面板的高级命令、调试技巧、API 进阶用法和实际应用案例，希望能帮助你更好地利用这个工具。</p>
<p>记住，工具的价值在于使用，只有不断实践和探索，才能真正掌握这些高级特性。快去打开 Chrome DevTools，尝试本文介绍的技巧吧！</p>
<p>Happy coding! 🚀</p>
<hr/>
<p><strong>感谢阅读！如果您有任何问题或建议，欢迎在评论区留言讨论。</strong>  <strong>如果你觉得本文对你有帮助，欢迎点赞、收藏、分享，也欢迎关注我，获取更多前端技术干货！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于 react-hook-form 的 isValid 在有些场景下的值总是 false 问题]]></title>    <link>https://juejin.cn/post/7586614240530759706</link>    <guid>https://juejin.cn/post/7586614240530759706</guid>    <pubDate>2025-12-23T03:43:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586614240530759706" data-draft-id="7586614240530726938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于 react-hook-form 的 isValid 在有些场景下的值总是 false 问题"/> <meta itemprop="keywords" content="React.js,前端"/> <meta itemprop="datePublished" content="2025-12-23T03:43:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="昨晚我输给了一辆AE86"/> <meta itemprop="url" content="https://juejin.cn/user/3087084382068286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于 react-hook-form 的 isValid 在有些场景下的值总是 false 问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3087084382068286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    昨晚我输给了一辆AE86
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:43:43.000Z" title="Tue Dec 23 2025 03:43:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>为什么 react-hook-form 的 isValid 为什么有时在表单验证通过没有 errors 的情况下会出现 false？</p>
<p>在 React Hook Form 中，<code>formState.isValid</code> 为 <code>true</code> 表示表单当前<strong>完全有效</strong>（无任何验证错误），但即使 <code>errors</code> 对象为空（<code>{}</code>），<code>isValid</code> 有时仍会出现 <code>false</code> 的情况，这是库的正常行为或常见配置导致的。以下是主要原因及解释（基于官方文档和社区常见问题）：</p>
<h3 data-id="heading-0">1. <strong>初始状态默认 false</strong></h3>
<ul>
<li>表单 mount 时，<code>isValid</code> 初始值为 <code>false</code>。</li>
<li>库不会自动验证 <code>defaultValues</code>，这是为了可访问性（accessibility）考虑，避免初始加载时就显示错误。</li>
<li>即使所有字段初始值有效，且 <code>errors</code> 为空，<code>isValid</code> 仍需等待首次验证触发后才可能变为 <code>true</code>。</li>
<li><strong>解决</strong>：在组件 mount 后手动调用 <code>trigger()</code> 来验证初始值：
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { trigger, <span class="hljs-attr">formState</span>: { isValid, errors } } = <span class="hljs-title function_">useForm</span>({ <span class="hljs-attr">defaultValues</span>: {...} });

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">trigger</span>();  <span class="hljs-comment">// 触发初始验证</span>
}, [trigger]);
</code></pre>
</li>
</ul>
<h3 data-id="heading-1">2. <strong>Proxy 订阅机制问题（最常见渲染优化坑）</strong></h3>
<ul>
<li><code>formState</code> 被 Proxy 包裹，以优化性能，只订阅你实际读取的状态。</li>
<li>如果你这样写：
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { formState } = <span class="hljs-title function_">useForm</span>();
<span class="hljs-comment">// 渲染中条件性访问</span>
<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{!formState.isValid}</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
</code></pre>
由于 <code>isValid</code> 是条件访问，Proxy <strong>不会订阅</strong>它的变化，导致它永远停留在初始 <code>false</code>。</li>
<li><strong>解决</strong>：在渲染前解构读取所有需要的状态（强制订阅）：
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { <span class="hljs-attr">formState</span>: { isValid, isDirty, errors } } = <span class="hljs-title function_">useForm</span>();
<span class="hljs-comment">// 或至少读取 isValid</span>
<span class="hljs-keyword">const</span> { isValid } = formState;

<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{!isDirty</span> || !<span class="hljs-attr">isValid</span>}&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
</code></pre>
</li>
<li>如果在 <code>useEffect</code> 中监听，也要放整个 <code>formState</code>：
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(isValid); }, [formState]);  <span class="hljs-comment">// 正确</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-2">3. <strong>mode 配置影响验证时机</strong></h3>
<ul>
<li>默认 <code>mode: 'onSubmit'</code>：只有提交时才完整验证，<code>isValid</code> 在提交前通常为 <code>false</code>。</li>
<li>如果用 <code>mode: 'onChange'</code> 或 <code>'all'</code>，输入时实时验证，<code>isValid</code> 会及时更新。</li>
<li>但即使验证通过，如果字段未被“touch”（如异步填充值或未交互），<code>isValid</code> 可能滞后。</li>
<li><strong>建议</strong>：实时表单用 <code>mode: 'onChange'</code> 或 <code>'all'</code>：
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-title function_">useForm</span>({ <span class="hljs-attr">mode</span>: <span class="hljs-string">'onChange'</span> });
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">4. <strong>异步值填充或动态字段</strong></h3>
<ul>
<li>用 <code>setValue</code> 异步设置值（如 API 数据）时，如果不带 <code>{ shouldValidate: true }</code>，不会触发验证，<code>isValid</code> 不更新。
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-title function_">setValue</span>(<span class="hljs-string">'field'</span>, value, { <span class="hljs-attr">shouldValidate</span>: <span class="hljs-literal">true</span> });
</code></pre>
</li>
<li>动态添加字段（如 <code>useFieldArray</code> 或条件渲染）时，<code>isValid</code> 可能短暂为 <code>false</code>，需等待重新验证。</li>
</ul>
<h3 data-id="heading-4">5. <strong>其他边缘情况</strong></h3>
<ul>
<li>使用 <code>setError</code> 手动设置错误会强制 <code>isValid</code> 为 <code>false</code>。</li>
<li>Resolver（如 Yup/Zod）时，初始无效 <code>defaultValues</code> 会让 <code>isValid</code> 为 <code>false</code>，但 <code>errors</code> 可能为空（需 <code>trigger()</code> 显式显示错误）。</li>
<li>测试环境（如 Cypress/Jest）中，由于异步渲染，<code>isValid</code> 可能滞后，需要 <code>await waitFor</code>。</li>
</ul>
<h3 data-id="heading-5">调试建议</h3>
<ul>
<li>打印整个状态：<code>console.log({ isValid, errors, isValidating, dirtyFields })</code>。</li>
<li>检查是否订阅了 <code>isValid</code>（Proxy 问题）。</li>
<li>如果表单初始有效但按钮禁用，优先检查订阅和 <code>trigger()</code>。</li>
</ul>
<p>大多数情况下，结合 <code>mode: 'onChange'</code> + 正确解构 <code>isValid</code> + 必要时 <code>trigger()</code> 就能解决“有时 false”的问题。如果提供你的 <code>useForm</code> 配置和使用代码，能更精准定位！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端使用nuxt.js的seo优化]]></title>    <link>https://juejin.cn/post/7586585498744733750</link>    <guid>https://juejin.cn/post/7586585498744733750</guid>    <pubDate>2025-12-23T03:40:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586585498744733750" data-draft-id="7586585498744602678" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端使用nuxt.js的seo优化"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T03:40:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户63683660855"/> <meta itemprop="url" content="https://juejin.cn/user/2562299273943164"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端使用nuxt.js的seo优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2562299273943164/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户63683660855
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:40:15.000Z" title="Tue Dec 23 2025 03:40:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Nuxt.js 前端 SEO 优化全面指南</h2>
<p>Nuxt.js 是 Vue.js 的框架，提供了开箱即用的服务端渲染（SSR）和静态站点生成（SSG）功能，天生对 SEO 友好。以下是针对 Nuxt.js 的详细 SEO 优化方案。</p>
<h3 data-id="heading-1">一、Nuxt.js 的 SEO 优势</h3>
<ol>
<li><strong>服务端渲染（SSR）</strong> ：服务器返回完整的 HTML，爬虫可直接索引内容</li>
<li><strong>静态站点生成（SSG）</strong> ：预渲染为静态 HTML，速度极快</li>
<li><strong>自动优化</strong>：Nuxt 自动处理许多 SEO 基础工作</li>
</ol>
<h3 data-id="heading-2">二、基础配置优化</h3>
<h4 data-id="heading-3">1. Nuxt 配置中的 SEO 设置</h4>
<p>javascript</p>
<pre><code class="hljs language-css" lang="css">// nuxt<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>
export default {
  // 全局 SEO 配置
  app: {
    head: {
      htmlAttrs: {
        lang: <span class="hljs-string">'zh-CN'</span>
      },
      meta: [
        { charset: <span class="hljs-string">'utf-8'</span> },
        { name: <span class="hljs-string">'viewport'</span>, content: <span class="hljs-string">'width=device-width, initial-scale=1'</span> },
        { 
          name: <span class="hljs-string">'description'</span>, 
          content: <span class="hljs-string">'你的网站描述，这里应该详细描述你的网站内容'</span> 
        },
        // Open Graph 协议（社交媒体分享）
        { property: <span class="hljs-string">'og:type'</span>, content: <span class="hljs-string">'website'</span> },
        { property: <span class="hljs-string">'og:title'</span>, content: <span class="hljs-string">'你的网站标题'</span> },
        { property: <span class="hljs-string">'og:description'</span>, content: <span class="hljs-string">'分享时的描述'</span> },
        { property: <span class="hljs-string">'og:image'</span>, content: <span class="hljs-string">'/og-image.jpg'</span> },
        // Twitter Card
        { name: <span class="hljs-string">'twitter:card'</span>, content: <span class="hljs-string">'summary_large_image'</span> },
        // 其他 meta 标签
        { name: <span class="hljs-string">'robots'</span>, content: <span class="hljs-string">'index, follow'</span> },
        { name: <span class="hljs-string">'author'</span>, content: <span class="hljs-string">'你的品牌/公司名'</span> }
      ],
      link: [
        { rel: <span class="hljs-string">'icon'</span>, type: <span class="hljs-string">'image/x-icon'</span>, href: <span class="hljs-string">'/favicon.ico'</span> },
        // 预连接重要域名
        { rel: <span class="hljs-string">'preconnect'</span>, href: <span class="hljs-string">'https://fonts.googleapis.com'</span> },
        { rel: <span class="hljs-string">'dns-prefetch'</span>, href: <span class="hljs-string">'https://fonts.googleapis.com'</span> },
        // 规范链接
        { rel: <span class="hljs-string">'canonical'</span>, href: <span class="hljs-string">'https://your-domain.com'</span> }
      ],
      script: [
        // JSON-LD 结构化数据（也可放在组件中）
        {
          type: <span class="hljs-string">'application/ld+json'</span>,
          innerHTML: JSON.<span class="hljs-built_in">stringify</span>({
            '<span class="hljs-keyword">@context</span>': <span class="hljs-string">'https://schema.org'</span>,
            <span class="hljs-string">'@type'</span>: <span class="hljs-string">'WebSite'</span>,
            <span class="hljs-string">'name'</span>: <span class="hljs-string">'你的网站名称'</span>,
            <span class="hljs-string">'url'</span>: <span class="hljs-string">'https://your-domain.com'</span>
          })
        }
      ]
    }
  }
}
</code></pre>
<h4 data-id="heading-4">2. 路由和 URL 优化</h4>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// nuxt.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 使用友好的 URL</span>
  <span class="hljs-attr">routeRules</span>: {
    <span class="hljs-comment">// 为特定路由设置规则</span>
    <span class="hljs-string">'/products/:id'</span>: { <span class="hljs-attr">prerender</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">'/blog/**'</span>: { <span class="hljs-attr">swr</span>: <span class="hljs-number">3600</span> } <span class="hljs-comment">// 静态再生</span>
  },
  
  <span class="hljs-comment">// 配置路由过渡</span>
  <span class="hljs-attr">router</span>: {
    <span class="hljs-attr">trailingSlash</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 统一尾部斜杠</span>
    <span class="hljs-title function_">scrollBehavior</span>(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, savedPosition</span>) {
      <span class="hljs-comment">// 控制页面滚动行为，改善用户体验</span>
      <span class="hljs-keyword">if</span> (savedPosition) {
        <span class="hljs-keyword">return</span> savedPosition;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">top</span>: <span class="hljs-number">0</span> };
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-5">三、页面级 SEO 优化</h3>
<h4 data-id="heading-6">1. 使用 <code>useHead</code> 组合式 API（推荐）</h4>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pages/blog/[slug].vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">useRoute</span>();
<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: article } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">useFetch</span>(<span class="hljs-string">`/api/articles/<span class="hljs-subst">${route.params.slug}</span>`</span>);

<span class="hljs-comment">// 动态设置页面 SEO 信息</span>
<span class="hljs-title function_">useHead</span>({
  <span class="hljs-attr">title</span>: article.<span class="hljs-property">value</span>.<span class="hljs-property">title</span> + <span class="hljs-string">' | 网站名称'</span>,
  <span class="hljs-attr">meta</span>: [
    { 
      <span class="hljs-attr">name</span>: <span class="hljs-string">'description'</span>, 
      <span class="hljs-attr">content</span>: article.<span class="hljs-property">value</span>.<span class="hljs-property">excerpt</span> || article.<span class="hljs-property">value</span>.<span class="hljs-property">content</span>.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">160</span>) 
    },
    { 
      <span class="hljs-attr">name</span>: <span class="hljs-string">'keywords'</span>, 
      <span class="hljs-attr">content</span>: article.<span class="hljs-property">value</span>.<span class="hljs-property">tags</span>?.<span class="hljs-title function_">join</span>(<span class="hljs-string">', '</span>) || <span class="hljs-string">''</span> 
    },
    <span class="hljs-comment">// Open Graph</span>
    { <span class="hljs-attr">property</span>: <span class="hljs-string">'og:title'</span>, <span class="hljs-attr">content</span>: article.<span class="hljs-property">value</span>.<span class="hljs-property">title</span> },
    { <span class="hljs-attr">property</span>: <span class="hljs-string">'og:description'</span>, <span class="hljs-attr">content</span>: article.<span class="hljs-property">value</span>.<span class="hljs-property">excerpt</span> },
    { <span class="hljs-attr">property</span>: <span class="hljs-string">'og:image'</span>, <span class="hljs-attr">content</span>: article.<span class="hljs-property">value</span>.<span class="hljs-property">image</span> },
    <span class="hljs-comment">// 规范链接</span>
    { <span class="hljs-attr">rel</span>: <span class="hljs-string">'canonical'</span>, <span class="hljs-attr">href</span>: <span class="hljs-string">`https://your-domain.com/blog/<span class="hljs-subst">${article.value.slug}</span>`</span> }
  ],
  <span class="hljs-comment">// 结构化数据</span>
  <span class="hljs-attr">script</span>: [
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'application/ld+json'</span>,
      <span class="hljs-attr">innerHTML</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-string">'@context'</span>: <span class="hljs-string">'https://schema.org'</span>,
        <span class="hljs-string">'@type'</span>: <span class="hljs-string">'BlogPosting'</span>,
        <span class="hljs-string">'headline'</span>: article.<span class="hljs-property">value</span>.<span class="hljs-property">title</span>,
        <span class="hljs-string">'description'</span>: article.<span class="hljs-property">value</span>.<span class="hljs-property">excerpt</span>,
        <span class="hljs-string">'image'</span>: article.<span class="hljs-property">value</span>.<span class="hljs-property">image</span>,
        <span class="hljs-string">'author'</span>: {
          <span class="hljs-string">'@type'</span>: <span class="hljs-string">'Person'</span>,
          <span class="hljs-string">'name'</span>: article.<span class="hljs-property">value</span>.<span class="hljs-property">author</span>
        },
        <span class="hljs-string">'datePublished'</span>: article.<span class="hljs-property">value</span>.<span class="hljs-property">published_at</span>,
        <span class="hljs-string">'dateModified'</span>: article.<span class="hljs-property">value</span>.<span class="hljs-property">updated_at</span>
      })
    }
  ]
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">article</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 正确的标题结构 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{{ article.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{{ article.subtitle }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 面包屑导航 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"面包屑导航"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">NuxtLink</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">NuxtLink</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">NuxtLink</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/blog"</span>&gt;</span>博客<span class="hljs-tag">&lt;/<span class="hljs-name">NuxtLink</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>{{ article.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 内容 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-html</span>=<span class="hljs-string">"article.content"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 优化图片 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">NuxtImg</span>
      <span class="hljs-attr">:src</span>=<span class="hljs-string">"article.featured_image"</span>
      <span class="hljs-attr">:alt</span>=<span class="hljs-string">"article.image_alt || article.title"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">"800"</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">"600"</span>
      <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span>
      <span class="hljs-attr">format</span>=<span class="hljs-string">"webp"</span>
      <span class="hljs-attr">quality</span>=<span class="hljs-string">"80"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h4 data-id="heading-7">2. 使用 Nuxt SEO Kit（推荐插件）</h4>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">npm install @nuxt/seo
</code></pre>
<p>javascript</p>
<pre><code class="hljs language-css" lang="css">// nuxt<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>
export default {
  modules: [<span class="hljs-string">'@nuxt/seo'</span>],
  
  site: {
    url: <span class="hljs-string">'https://your-domain.com'</span>,
    name: <span class="hljs-string">'你的网站名称'</span>,
    description: <span class="hljs-string">'网站描述'</span>,
    defaultLocale: <span class="hljs-string">'zh-CN'</span>,
    trailingSlash: true,
  },
  
  sitemap: {
    sources: [<span class="hljs-string">'/api/__sitemap__/urls'</span>]
  },
  
  robots: {
    // 自动生成 robots<span class="hljs-selector-class">.txt</span>
    allow: [<span class="hljs-string">'*'</span>],
    disallow: [<span class="hljs-string">'/admin'</span>]
  }
}
</code></pre>
<h3 data-id="heading-8">四、性能优化</h3>
<h4 data-id="heading-9">1. 图片优化</h4>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 使用 NuxtImg 组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 自动优化图片 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">NuxtImg</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/images/hero.jpg"</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"描述文字"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">"1200"</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">"630"</span>
      <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span>
      <span class="hljs-attr">format</span>=<span class="hljs-string">"webp"</span>
      <span class="hljs-attr">:modifiers</span>=<span class="hljs-string">"{ quality: 80 }"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"sm:100vw md:50vw lg:400px"</span>
    /&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 使用 NuxtPicture 响应式图片 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">NuxtPicture</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/images/hero.jpg"</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"描述文字"</span>
      <span class="hljs-attr">:imgAttrs</span>=<span class="hljs-string">"{ class: 'responsive-image' }"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h4 data-id="heading-10">2. 资源加载优化</h4>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// nuxt.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 预加载关键资源</span>
  render: {
    resourceHints: <span class="hljs-literal">true</span>,
    asyncScripts: <span class="hljs-literal">true</span>
  },
  
  <span class="hljs-comment">// 字体优化</span>
  font: {
    <span class="hljs-comment">// 自动预加载关键字体</span>
    inject: <span class="hljs-literal">true</span>
  }
}
</code></pre>
<h4 data-id="heading-11">3. 代码分割和懒加载</h4>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 组件懒加载</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyComponent</span> = <span class="hljs-title function_">defineAsyncComponent</span>(<span class="hljs-function">() =&gt;</span>
  <span class="hljs-keyword">import</span>(<span class="hljs-string">'~/components/HeavyComponent.vue'</span>)
);

<span class="hljs-comment">// 数据懒加载（仅客户端）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadHeavyData</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">client</span>) {
    <span class="hljs-keyword">import</span>(<span class="hljs-string">'~/utils/heavy-data.js'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> {
      <span class="hljs-comment">// 使用模块</span>
    });
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 图片懒加载 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
    <span class="hljs-attr">v-lazy</span>=<span class="hljs-string">"'/images/product.jpg'"</span>
    <span class="hljs-attr">alt</span>=<span class="hljs-string">"产品图片"</span>
  /&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 组件懒加载 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"showComponent"</span> /&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 视频懒加载 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">preload</span>=<span class="hljs-string">"metadata"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/video/promo.mp4"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"video/mp4"</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h3 data-id="heading-12">五、高级 SEO 功能</h3>
<h4 data-id="heading-13">1. 生成 XML Sitemap</h4>
<p>javascript</p>
<pre><code class="hljs language-xml" lang="xml">// server/api/sitemap.xml.ts
export default defineEventHandler(async (event) =&gt; {
  const posts = await $fetch('/api/posts');
  
  const sitemap = `<span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">urlset</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.sitemaps.org/schemas/sitemap/0.9"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">loc</span>&gt;</span>https://your-domain.com<span class="hljs-tag">&lt;/<span class="hljs-name">loc</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">lastmod</span>&gt;</span>${new Date().toISOString()}<span class="hljs-tag">&lt;/<span class="hljs-name">lastmod</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">changefreq</span>&gt;</span>daily<span class="hljs-tag">&lt;/<span class="hljs-name">changefreq</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">priority</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">priority</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    ${posts.map(post =&gt; `
      <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">loc</span>&gt;</span>https://your-domain.com/blog/${post.slug}<span class="hljs-tag">&lt;/<span class="hljs-name">loc</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">lastmod</span>&gt;</span>${new Date(post.updated_at).toISOString()}<span class="hljs-tag">&lt;/<span class="hljs-name">lastmod</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">changefreq</span>&gt;</span>weekly<span class="hljs-tag">&lt;/<span class="hljs-name">changefreq</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">priority</span>&gt;</span>0.8<span class="hljs-tag">&lt;/<span class="hljs-name">priority</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    `).join('')}
  <span class="hljs-tag">&lt;/<span class="hljs-name">urlset</span>&gt;</span>`;
  
  event.res.setHeader('content-type', 'text/xml');
  return sitemap;
});
</code></pre>
<h4 data-id="heading-14">2. 自动生成规范链接</h4>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">useRoute</span>();
<span class="hljs-keyword">const</span> config = <span class="hljs-title function_">useRuntimeConfig</span>();

<span class="hljs-comment">// 自动生成规范链接</span>
<span class="hljs-keyword">const</span> canonicalUrl = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${config.public.siteUrl}</span><span class="hljs-subst">${route.path}</span>`</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-comment">//$/, '');</span>
});

<span class="hljs-title function_">useHead</span>({
  <span class="hljs-attr">link</span>: [
    { <span class="hljs-attr">rel</span>: <span class="hljs-string">'canonical'</span>, <span class="hljs-attr">href</span>: canonicalUrl }
  ]
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-15">3. 多语言 SEO 优化</h4>
<p>javascript</p>
<pre><code class="hljs language-css" lang="css">// nuxt<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>
export default {
  modules: [<span class="hljs-string">'@nuxtjs/i18n'</span>],
  
  i18n: {
    locales: [
      { <span class="hljs-selector-tag">code</span>: <span class="hljs-string">'zh'</span>, iso: <span class="hljs-string">'zh-CN'</span>, file: <span class="hljs-string">'zh-CN.js'</span> },
      { <span class="hljs-selector-tag">code</span>: <span class="hljs-string">'en'</span>, iso: <span class="hljs-string">'en-US'</span>, file: <span class="hljs-string">'en-US.js'</span> }
    ],
    defaultLocale: <span class="hljs-string">'zh'</span>,
    strategy: <span class="hljs-string">'prefix_except_default'</span>,
    // 为多语言添加 hreflang
    seo: true,
    
    vueI18n: <span class="hljs-string">'./i18n.config.ts'</span>
  },
  
  // 多语言 sitemap
  sitemap: {
    i18n: true
  }
}
</code></pre>
<h3 data-id="heading-16">六、部署优化</h3>
<h4 data-id="heading-17">1. 缓存策略配置</h4>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// nuxt.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 配置渲染缓存</span>
  nitro: {
    prerender: {
      crawlLinks: <span class="hljs-literal">true</span>,
      routes: [<span class="hljs-string">'/'</span>, <span class="hljs-string">'/about'</span>, <span class="hljs-string">'/blog'</span>]
    }
  },
  
  <span class="hljs-comment">// 设置 HTTP 头</span>
  routeRules: {
    <span class="hljs-string">'/_nuxt/**'</span>: { 
      headers: { 
        <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'public, max-age=31536000, immutable'</span> 
      } 
    },
    <span class="hljs-string">'/images/**'</span>: { 
      headers: { 
        <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'public, max-age=86400'</span> 
      } 
    },
    <span class="hljs-string">'/api/**'</span>: { 
      cors: <span class="hljs-literal">true</span>,
      headers: { 
        <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'*'</span> 
      } 
    }
  }
}
</code></pre>
<h4 data-id="heading-18">2. 使用 Nuxt Security 增强安全性</h4>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// nuxt.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  modules: [<span class="hljs-string">'nuxt-security'</span>],
  
  security: {
    headers: {
      <span class="hljs-comment">// 安全相关 HTTP 头</span>
      crossOriginResourcePolicy: <span class="hljs-string">'same-origin'</span>,
      crossOriginOpenerPolicy: <span class="hljs-string">'same-origin'</span>,
      crossOriginEmbedderPolicy: <span class="hljs-string">'require-corp'</span>,
      contentSecurityPolicy: {
        <span class="hljs-string">'default-src'</span>: [<span class="hljs-string">"'self'"</span>],
        <span class="hljs-string">'script-src'</span>: [<span class="hljs-string">"'self'"</span>, <span class="hljs-string">"'unsafe-inline'"</span>],
        <span class="hljs-string">'style-src'</span>: [<span class="hljs-string">"'self'"</span>, <span class="hljs-string">"'unsafe-inline'"</span>],
        <span class="hljs-string">'img-src'</span>: [<span class="hljs-string">"'self'"</span>, <span class="hljs-string">'data:'</span>, <span class="hljs-string">'https:'</span>]
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-19">七、监控和分析</h3>
<h4 data-id="heading-20">1. 集成 Google Analytics 4</h4>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// plugins/analytics.client.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtPlugin</span>(<span class="hljs-function">(<span class="hljs-params">nuxtApp</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
  
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">dataLayer</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">dataLayer</span> || [];
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">gtag</span>(<span class="hljs-params"/>) { dataLayer.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">arguments</span>); }
  <span class="hljs-title function_">gtag</span>(<span class="hljs-string">'js'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
  <span class="hljs-title function_">gtag</span>(<span class="hljs-string">'config'</span>, <span class="hljs-string">'G-XXXXXXXXXX'</span>);
  
  <span class="hljs-comment">// 跟踪页面视图</span>
  router.<span class="hljs-title function_">afterEach</span>(<span class="hljs-function">(<span class="hljs-params">to</span>) =&gt;</span> {
    <span class="hljs-title function_">gtag</span>(<span class="hljs-string">'event'</span>, <span class="hljs-string">'page_view'</span>, {
      <span class="hljs-attr">page_title</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span>,
      <span class="hljs-attr">page_location</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
      <span class="hljs-attr">page_path</span>: to.<span class="hljs-property">path</span>
    });
  });
});
</code></pre>
<h4 data-id="heading-21">2. 性能监控</h4>
<p>vue</p>
<pre><code class="hljs language-scss" lang="scss">&lt;script setup&gt;
<span class="hljs-comment">// 监控 Core Web Vitals</span>
if (process.client) {
  <span class="hljs-built_in">import</span>('web-vitals')<span class="hljs-selector-class">.then</span>(({ getCLS, getFID, getLCP }) =&gt; {
    <span class="hljs-built_in">getCLS</span>(console.log);
    <span class="hljs-built_in">getFID</span>(console.log);
    <span class="hljs-built_in">getLCP</span>(console.log);
    
    <span class="hljs-comment">// 发送到分析服务</span>
    const reportData = (metric) =&gt; {
      <span class="hljs-built_in">fetch</span>('/api/web-vitals', {
        method: 'POST',
        body: JSON.stringify(metric),
        headers: { '<span class="hljs-attribute">Content</span>-Type': <span class="hljs-string">'application/json'</span> }
      });
    };
    
    <span class="hljs-built_in">getCLS</span>(reportData);
    <span class="hljs-built_in">getFID</span>(reportData);
    <span class="hljs-built_in">getLCP</span>(reportData);
  });
}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-22">八、实用工具和命令</h3>
<h4 data-id="heading-23">1. SEO 检查脚本</h4>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// scripts/check-seo.js</span>
<span class="hljs-keyword">import</span> { generateSiteMap } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/sitemap.js'</span>;
<span class="hljs-keyword">import</span> { checkMetaTags } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/meta-checker.js'</span>;
<span class="hljs-keyword">import</span> { analyzePerformance } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/performance.js'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runSEOCheck</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始 SEO 检查...'</span>);
  
  <span class="hljs-comment">// 检查所有页面的 Meta 标签</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkMetaTags</span>();
  
  <span class="hljs-comment">// 生成并验证 sitemap</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateSiteMap</span>();
  
  <span class="hljs-comment">// 性能分析</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">analyzePerformance</span>();
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'SEO 检查完成！'</span>);
}

<span class="hljs-title function_">runSEOCheck</span>();
</code></pre>
<h4 data-id="heading-24">2. 构建优化</h4>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nuxt build --preset seo-optimized"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"generate"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nuxt generate"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"postbuild"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node scripts/analyze-bundle.js"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-25">九、常见问题解决</h3>
<h4 data-id="heading-26">1. 处理动态路由 SEO</h4>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// nuxt.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">nitro</span>: {
    <span class="hljs-attr">prerender</span>: {
      <span class="hljs-attr">routes</span>: <span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> $fetch(<span class="hljs-string">'/api/posts'</span>);
        <span class="hljs-keyword">return</span> posts.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span> <span class="hljs-string">`/blog/<span class="hljs-subst">${post.slug}</span>`</span>);
      }
    }
  }
};
</code></pre>
<h4 data-id="heading-27">2. 处理无限滚动内容</h4>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 为无限滚动内容添加规范链接和分页标记</span>
<span class="hljs-title function_">useHead</span>({
  <span class="hljs-attr">link</span>: [
    { <span class="hljs-attr">rel</span>: <span class="hljs-string">'canonical'</span>, <span class="hljs-attr">href</span>: <span class="hljs-string">`https://your-domain.com<span class="hljs-subst">${route.path}</span>`</span> },
    { <span class="hljs-attr">rel</span>: <span class="hljs-string">'next'</span>, <span class="hljs-attr">href</span>: <span class="hljs-string">`/page/<span class="hljs-subst">${currentPage + <span class="hljs-number">1</span>}</span>`</span> },
    { <span class="hljs-attr">rel</span>: <span class="hljs-string">'prev'</span>, <span class="hljs-attr">href</span>: <span class="hljs-string">`/page/<span class="hljs-subst">${currentPage - <span class="hljs-number">1</span>}</span>`</span> }
  ],
  <span class="hljs-attr">script</span>: [
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'application/ld+json'</span>,
      <span class="hljs-attr">innerHTML</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-string">'@context'</span>: <span class="hljs-string">'https://schema.org'</span>,
        <span class="hljs-string">'@type'</span>: <span class="hljs-string">'ItemList'</span>,
        <span class="hljs-string">'itemListElement'</span>: items.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> ({
          <span class="hljs-string">'@type'</span>: <span class="hljs-string">'ListItem'</span>,
          <span class="hljs-string">'position'</span>: index + <span class="hljs-number">1</span>,
          <span class="hljs-string">'url'</span>: <span class="hljs-string">`https://your-domain.com/item/<span class="hljs-subst">${item.id}</span>`</span>
        }))
      })
    }
  ]
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-28">总结：Nuxt.js SEO 检查清单</h3>
<ul>
<li>启用 SSR 或 SSG（根据需求选择）</li>
<li>正确配置 <code>nuxt.config.js</code> 中的 SEO 选项</li>
<li>每个页面都有唯一的 <code>title</code> 和 <code>meta description</code></li>
<li>使用正确的 HTML 语义化标签（H1-H6）</li>
<li>所有图片都有 <code>alt</code> 属性和合适尺寸</li>
<li>配置 XML Sitemap 和 robots.txt</li>
<li>添加结构化数据（JSON-LD）</li>
<li>实施 Core Web Vitals 优化</li>
<li>设置缓存策略和 HTTP 头</li>
<li>添加分析跟踪代码</li>
<li>多语言网站添加 <code>hreflang</code></li>
<li>定期检查死链和重定向</li>
<li>移动端友好测试通过</li>
<li>提交到 Google Search Console</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[滚动控制视频播放是如何实现的？GSAP ScrollTrigger + seek 实践 vivo官网案例]]></title>    <link>https://juejin.cn/post/7586587644823928866</link>    <guid>https://juejin.cn/post/7586587644823928866</guid>    <pubDate>2025-12-23T04:58:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586587644823928866" data-draft-id="7586157459971932212" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="滚动控制视频播放是如何实现的？GSAP ScrollTrigger + seek 实践 vivo官网案例"/> <meta itemprop="keywords" content="前端,产品"/> <meta itemprop="datePublished" content="2025-12-23T04:58:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="akira0912"/> <meta itemprop="url" content="https://juejin.cn/user/4306112028351885"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            滚动控制视频播放是如何实现的？GSAP ScrollTrigger + seek 实践 vivo官网案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4306112028351885/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    akira0912
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T04:58:05.000Z" title="Tue Dec 23 2025 04:58:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 vivo、Apple、Tesla 等官网中，经常能看到这样一种效果：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.vivo.com.cn%2Fvivo%2Fiqoo15%2F" target="_blank" title="https://www.vivo.com.cn/vivo/iqoo15/" ref="nofollow noopener noreferrer">www.vivo.com.cn/vivo/iqoo15…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a55fc25c809c4fbbba1f94200f7bb7b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWtpcmEwOTEy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767070685&amp;x-signature=SyncuPTYzzZDg7%2BBTRhPDxiyHWo%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>页面向下滚动，视频一点点向前播放<br/>
页面向上回滚，视频又一点点倒退<br/>
视频没播放完，页面无法继续向下滚动</p>
</blockquote>
<p>这种效果看起来像「视频跟着滚动播放」，但<strong>本质并不是播放，而是 seek</strong>。</p>
<p>本文将会复刻这个效果，完整拆解 <strong>滚动控制视频播放的实现方式</strong>，以及 <strong>GSAP 在其中到底发挥了什么作用</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、这类效果本质上是在做什么？</h2>
<p>先说结论：</p>
<blockquote>
<p><strong>滚动控制视频 ≠ 播放视频<br/>
滚动控制视频 = 用滚动不断 seek 视频</strong></p>
</blockquote>
<p>在 HTML5 中：<code>video.currentTime = 3.2;</code></p>
<p>这一次赋值操作，就叫 <strong>seek</strong> ——  也就是把视频播放头<strong>强制跳转</strong>到某个时间点。</p>
<p>而滚动驱动视频时，代码会不断执行：</p>
<p><code>scroll → currentTime → currentTime → currentTime</code></p>
<p>也就是说：<strong>滚动控制视频是一个“高频 seek”的极端使用场景</strong></p>
<hr/>
<h2 data-id="heading-1">二、一次 seek，浏览器内部发生了什么？</h2>
<p>当你设置：</p>
<pre><code class="hljs language-js" lang="js">video.<span class="hljs-property">currentTime</span> = <span class="hljs-number">4.5</span>;
</code></pre>
<p>浏览器并不是“立刻显示第 4.5 秒那一帧”，而是要经历：</p>
<ol>
<li>找到离 4.5 秒最近的关键帧（I-frame）</li>
<li>从关键帧开始解码</li>
<li>解码中间的 P / B 帧</li>
<li>渲染当前画面</li>
</ol>
<p>这也是为什么：</p>
<ul>
<li>关键帧越少，seek 越慢</li>
<li>滚动越频繁，视频越容易抖</li>
</ul>
<hr/>
<h2 data-id="heading-2">三、GSAP 的代码到底有没有用到 seek？</h2>
<p>答案是：<strong>有，而且用得非常多。</strong></p>
<p>来看一段最常见的 GSAP + ScrollTrigger 写法：</p>
<pre><code class="hljs language-js" lang="js">gsap.<span class="hljs-title function_">registerPlugin</span>(<span class="hljs-title class_">ScrollTrigger</span>);

<span class="hljs-keyword">const</span> video = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"video"</span>);
video.<span class="hljs-title function_">pause</span>();

video.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"loadedmetadata"</span>, <span class="hljs-function">() =&gt;</span> {
  gsap.<span class="hljs-title function_">to</span>(video, {
    <span class="hljs-attr">currentTime</span>: video.<span class="hljs-property">duration</span>,
    <span class="hljs-attr">ease</span>: <span class="hljs-string">"none"</span>,
    <span class="hljs-attr">scrollTrigger</span>: {
      <span class="hljs-attr">trigger</span>: <span class="hljs-string">".scroll-video"</span>,
      <span class="hljs-attr">start</span>: <span class="hljs-string">"top top"</span>,
      <span class="hljs-attr">end</span>: <span class="hljs-string">"bottom bottom"</span>,
      <span class="hljs-attr">scrub</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">pin</span>: <span class="hljs-literal">true</span>
    }
  });
});
</code></pre>
<p>这段代码<strong>并没有绕开 seek</strong>，它做的事情是：</p>
<pre><code class="hljs language-arduino" lang="arduino">ScrollTrigger 监听滚动
↓
计算滚动进度（<span class="hljs-number">0</span> ~ <span class="hljs-number">1</span>）
↓
GSAP 根据进度更新 currentTime
↓
video.currentTime 被不断赋值（seek）
</code></pre>
<p>所以可以明确地说：</p>
<blockquote>
<p><strong>GSAP 并没有避免 seek，而是系统性地管理了 seek</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-3">四、GSAP 真正解决的是什么问题？</h2>
<p>如果不用 GSAP，很多人会写成这样：</p>
<pre><code class="hljs language-ini" lang="ini">window.addEventListener("scroll", () =&gt; {
  <span class="hljs-attr">video.currentTime</span> = calcByScroll()<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p>这种写法的问题在于：</p>
<ul>
<li>scroll 触发频率不可控</li>
<li>同一帧内可能多次 seek</li>
<li>惯性滚动、回弹难处理</li>
<li>iOS / Mac 触控板体验差</li>
</ul>
<hr/>
<h3 data-id="heading-4">GSAP ScrollTrigger 的核心价值</h3>
<h4 data-id="heading-5">1️⃣ 把滚动抽象成“稳定的进度”</h4>
<p>GSAP 把滚动统一抽象成：</p>
<p><code>progress = 0 → 1</code></p>
<p>开发者不再关心 scrollTop、offset、临界点误差。</p>
<hr/>
<h4 data-id="heading-6">2️⃣ 用 requestAnimationFrame 控制更新频率</h4>
<p>GSAP 内部保证：</p>
<blockquote>
<p><strong>一帧最多更新一次 currentTime</strong></p>
</blockquote>
<p>避免了“seek 风暴”。</p>
<hr/>
<h4 data-id="heading-7">3️⃣ <code>scrub</code> 实现正反向严格同步</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">scrub:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>意味着：</p>
<ul>
<li>向下滚 → 视频前进</li>
<li>向上滚 → 视频回退</li>
<li>停止滚动 → 视频停在当前帧</li>
</ul>
<p>这是纯原生 scroll 非常难稳定实现的。</p>
<hr/>
<h4 data-id="heading-8">4️⃣ <code>pin</code> 实现滚动锁定</h4>
<p><code>pin: true</code></p>
<p>视频播放完之前，当前 section 会被固定：</p>
<blockquote>
<p>自然实现「视频没播完，页面不能继续滚」</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">五、为什么视频编码仍然是关键？</h2>
<p>GSAP 只能决定 <strong>什么时候 seek</strong>，<br/>
但 <strong>seek 快不快、准不准</strong>，取决于视频本身。</p>
<p>官网级方案通常会在制作阶段：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-g 1</span>
</code></pre>
<p>让视频 <strong>每一帧都是关键帧</strong>，以保证：</p>
<ul>
<li>高频 seek 不回退</li>
<li>滚动和画面严格同步</li>
</ul>
<p>这也是为什么滚动视频效果往往需要配合 ffmpeg 做素材处理。</p>
<hr/>
<h2 data-id="heading-10">六、一个总结模型</h2>
<p>可以用一句话总结整套方案：</p>
<blockquote>
<p><strong>滚动控制视频不是在播放视频，而是在用滚动驱动 seek。<br/>
GSAP 的作用不是消灭 seek，而是让 seek 变得可控、稳定，并与滚动严格同步。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-11">七、结语</h2>
<ul>
<li>✅ 滚动视频效果一定会用到 seek</li>
<li>✅ GSAP 解决的是“节奏”和“同步”问题</li>
<li>❌ GSAP 无法替代视频编码优化</li>
<li>🔥 官网级体验 = <strong>GSAP + 合理滚动距离 + 正确的视频编码</strong></li>
</ul>
<p>最后代码贴在这里，复刻了iQOO官网页面中的两个视频滚动，css就不贴了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//子组件</span>
<span class="hljs-string">'use client'</span>;

<span class="hljs-keyword">import</span> { useEffect, useRef, useId } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { gsap } <span class="hljs-keyword">from</span> <span class="hljs-string">'gsap'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ScrollTrigger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'gsap/ScrollTrigger'</span>;

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span>) {
  gsap.<span class="hljs-title function_">registerPlugin</span>(<span class="hljs-title class_">ScrollTrigger</span>);
}

interface <span class="hljs-title class_">ScrollVideoProps</span> {
  <span class="hljs-attr">videoSrc</span>: string;
  <span class="hljs-attr">duration</span>: number;
  className?: string;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ScrollVideo</span>(<span class="hljs-params">{ videoSrc, duration, className = <span class="hljs-string">''</span> }: ScrollVideoProps</span>) {
  <span class="hljs-keyword">const</span> sectionRef = useRef&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> videoRef = useRef&lt;<span class="hljs-title class_">HTMLVideoElement</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> triggerId = <span class="hljs-title function_">useId</span>();

  <span class="hljs-comment">// 8px per frame, 60fps</span>
  <span class="hljs-keyword">const</span> scrollHeight = duration * <span class="hljs-number">60</span> * <span class="hljs-number">8</span>;

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> video = videoRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">const</span> section = sectionRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (!video || !section) <span class="hljs-keyword">return</span>;

    video.<span class="hljs-title function_">pause</span>();
    video.<span class="hljs-property">currentTime</span> = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">let</span> <span class="hljs-attr">st</span>: <span class="hljs-title class_">ScrollTrigger</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLoadedMetadata</span> = (<span class="hljs-params"/>) =&gt; {
      st?.<span class="hljs-title function_">kill</span>();

      st = <span class="hljs-title class_">ScrollTrigger</span>.<span class="hljs-title function_">create</span>({
        <span class="hljs-attr">trigger</span>: section,
        <span class="hljs-attr">start</span>: <span class="hljs-string">'top top'</span>,
        <span class="hljs-attr">end</span>: <span class="hljs-string">'bottom bottom'</span>,
        <span class="hljs-attr">scrub</span>: <span class="hljs-number">0.2</span>,
        <span class="hljs-attr">id</span>: triggerId,
        <span class="hljs-attr">onUpdate</span>: <span class="hljs-function">(<span class="hljs-params">self</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (video.<span class="hljs-property">readyState</span> &gt;= <span class="hljs-number">1</span>) {
            video.<span class="hljs-property">currentTime</span> = self.<span class="hljs-property">progress</span> * video.<span class="hljs-property">duration</span>;
          }
        },
      });
    };

    <span class="hljs-keyword">if</span> (video.<span class="hljs-property">readyState</span> &gt;= <span class="hljs-number">1</span>) {
      <span class="hljs-title function_">handleLoadedMetadata</span>();
    } <span class="hljs-keyword">else</span> {
      video.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'loadedmetadata'</span>, handleLoadedMetadata);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      video.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'loadedmetadata'</span>, handleLoadedMetadata);
      st?.<span class="hljs-title function_">kill</span>();
    };
  }, [triggerId, duration]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{sectionRef}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">scroll-video</span> ${<span class="hljs-attr">className</span>}`}
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> `${<span class="hljs-attr">scrollHeight</span>}<span class="hljs-attr">px</span>` }}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"sticky top-0 h-screen w-full overflow-hidden"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">video</span>
          <span class="hljs-attr">ref</span>=<span class="hljs-string">{videoRef}</span>
          <span class="hljs-attr">muted</span>
          <span class="hljs-attr">playsInline</span>
          <span class="hljs-attr">preload</span>=<span class="hljs-string">"auto"</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-full object-cover pointer-events-none"</span>
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{videoSrc}</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"video/webm"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span>
  );
}


<span class="hljs-comment">//父组件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ScrollVideo</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ScrollVideo'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-black"</span>&gt;</span>
      {/* Hero Section */}
      <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-screen flex items-center justify-center"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center text-white"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-5xl md:text-7xl font-bold mb-6"</span>&gt;</span>
            企业官网
          <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-xl md:text-2xl text-gray-300 mb-8"</span>&gt;</span>
            向下滚动体验视频效果
          <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"animate-bounce"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> 
              <span class="hljs-attr">className</span>=<span class="hljs-string">"w-8 h-8 mx-auto text-white"</span> 
              <span class="hljs-attr">fill</span>=<span class="hljs-string">"none"</span> 
              <span class="hljs-attr">stroke</span>=<span class="hljs-string">"currentColor"</span> 
              <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 24 24"</span>
            &gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">path</span> 
                <span class="hljs-attr">strokeLinecap</span>=<span class="hljs-string">"round"</span> 
                <span class="hljs-attr">strokeLinejoin</span>=<span class="hljs-string">"round"</span> 
                <span class="hljs-attr">strokeWidth</span>=<span class="hljs-string">{2}</span> 
                <span class="hljs-attr">d</span>=<span class="hljs-string">"M19 14l-7 7m0 0l-7-7m7 7V3"</span> 
              /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>

      {/* Scroll Video 1 - 8秒 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">ScrollVideo</span> 
        <span class="hljs-attr">videoSrc</span>=<span class="hljs-string">"/video.webm"</span>
        <span class="hljs-attr">duration</span>=<span class="hljs-string">{8}</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-black"</span>
      /&gt;</span>

      {/* Scroll Video 2 - 4秒 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">ScrollVideo</span> 
        <span class="hljs-attr">videoSrc</span>=<span class="hljs-string">"/performance.webm"</span>
        <span class="hljs-attr">duration</span>=<span class="hljs-string">{4}</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-black"</span>
      /&gt;</span>

      {/* Content Section */}
      <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"min-h-screen flex items-center justify-center bg-gradient-to-b from-black to-gray-900"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center text-white max-w-4xl px-6"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-4xl md:text-5xl font-bold mb-8"</span>&gt;</span>
            创新科技
          <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-lg md:text-xl text-gray-300 leading-relaxed"</span>&gt;</span>
            我们致力于为用户提供最前沿的技术体验，
            通过不断创新，打造卓越的产品与服务。
          <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>

      {/* Footer */}
      <span class="hljs-tag">&lt;<span class="hljs-name">footer</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"py-12 bg-gray-900 text-center text-gray-400"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>© 2025 企业官网. All rights reserved.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span></span>
  );
}


</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elpis 第四阶段· Vue3 完成动态组件建设]]></title>    <link>https://juejin.cn/post/7586617459487113268</link>    <guid>https://juejin.cn/post/7586617459487113268</guid>    <pubDate>2025-12-23T04:01:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586617459487113268" data-draft-id="7586208617603317794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elpis 第四阶段· Vue3 完成动态组件建设"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-23T04:01:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一念之间lq"/> <meta itemprop="url" content="https://juejin.cn/user/2541726616524583"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elpis 第四阶段· Vue3 完成动态组件建设
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2541726616524583/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一念之间lq
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T04:01:00.000Z" title="Tue Dec 23 2025 04:01:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一.前言</h2>
<p>我们在第三阶段中学会了如何通过<code>Schema配置</code>与<code>Dashboard 模板引擎</code>实现了页面的自动渲染流程,但是缺乏对数据进行操作的功能,所以在本阶段重点就是<code>Schema配置与动态操作组件配合</code>来实现数据的增删改查操作</p>
<h2 data-id="heading-1">二.DSL中Schema  动态组件配置</h2>
<p>在基于第三章中的Schema配置中增加<code>componentConfig</code>配置,来描述不同的操作加载不同的动态组件</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-attr">componentConfig</span>: {
     <span class="hljs-comment">// create-from 表单相关配置</span>
      <span class="hljs-attr">createFrom</span>: {
         <span class="hljs-attr">title</span>: <span class="hljs-string">''</span>,<span class="hljs-comment">// 表单标题</span>
         <span class="hljs-attr">saveBtnText</span>: <span class="hljs-string">''</span>,<span class="hljs-comment">// 保存按钮文本</span>
       },
     <span class="hljs-comment">//edit-from 表单相关配置</span>
      <span class="hljs-attr">editFrom</span>: {
        <span class="hljs-attr">mainKey</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">//表单主键,用于唯一标识要修改的数据对象</span>
        <span class="hljs-attr">title</span>: <span class="hljs-string">''</span>,<span class="hljs-comment">// 表单标题</span>
        <span class="hljs-attr">saveBtnText</span>: <span class="hljs-string">''</span>,<span class="hljs-comment">// 保存按钮文本</span>
      },
     <span class="hljs-comment">// detailPanel 详情相关 </span>
       <span class="hljs-attr">detailPanel</span>: {
         <span class="hljs-attr">mainKey</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">//表单主键,用于唯一标识要修改的数据对象</span>
         <span class="hljs-attr">title</span>: <span class="hljs-string">''</span>,<span class="hljs-comment">// 标题</span>
     },
},
</code></pre>
<p>动态组件加载触发加载的条件:</p>
<ol>
<li><code>tableConfig</code>配置项中的表格头部操作和表格操作栏按钮增加 <code>eventKey</code>(触发事件)和<code>eventOption.comName</code>触发加载的组件名称</li>
<li>删除操作特殊处理<code>eventOption.params</code>中配置指定<code>key</code>字段进行删除操作</li>
</ol>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-attr">tableConfig</span>: {
    <span class="hljs-attr">headerButtons</span>: [{
      <span class="hljs-attr">label</span>: <span class="hljs-string">'新增商品'</span>,
      <span class="hljs-attr">eventKey</span>: <span class="hljs-string">'showComponent'</span>,
      <span class="hljs-attr">eventOption</span>: {
            <span class="hljs-attr">comName</span>: <span class="hljs-string">'createForm'</span>
      },
      <span class="hljs-attr">type</span>: <span class="hljs-string">'primary'</span>,
      <span class="hljs-attr">plain</span>: <span class="hljs-literal">true</span>
      }],
       <span class="hljs-attr">rowButtons</span>: [
       {
         <span class="hljs-attr">label</span>: <span class="hljs-string">"查看详情"</span>,
         <span class="hljs-attr">eventKey</span>: <span class="hljs-string">'showComponent'</span>,
         <span class="hljs-attr">type</span>: <span class="hljs-string">'primary'</span>,
         <span class="hljs-attr">eventOption</span>: {
          <span class="hljs-attr">comName</span>: <span class="hljs-string">'detailPanel'</span>
         },
      },
      {
          <span class="hljs-attr">label</span>: <span class="hljs-string">"修改"</span>,
          <span class="hljs-attr">eventKey</span>: <span class="hljs-string">'showComponent'</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
          <span class="hljs-attr">eventOption</span>: {
              <span class="hljs-attr">comName</span>: <span class="hljs-string">'editForm'</span>
          },
      },
      {
          <span class="hljs-attr">label</span>: <span class="hljs-string">"删除"</span>,
          <span class="hljs-attr">eventKey</span>: <span class="hljs-string">'remove'</span>,
          <span class="hljs-attr">eventOption</span>: {
              <span class="hljs-attr">params</span>: {
                  <span class="hljs-attr">product_id</span>: <span class="hljs-string">"schema::product_id"</span>
              }
          },
          <span class="hljs-attr">type</span>: <span class="hljs-string">'danger'</span>,
      }],
},
</code></pre>
<h2 data-id="heading-2">三. 动态组件的渲染机制</h2>
<h3 data-id="heading-3">1. schema-view 动态组件的引用</h3>
<p>在<code> schema-view</code>中通过对<code>component-config.js</code>中动态组件引入关系灵活组件管理</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// component-config.js</span>
<span class="hljs-keyword">import</span> createForm <span class="hljs-keyword">from</span> <span class="hljs-string">'./create-form/create-form.vue'</span>
<span class="hljs-keyword">import</span> editForm <span class="hljs-keyword">from</span> <span class="hljs-string">'./edit-form/edit-form.vue'</span>
<span class="hljs-keyword">import</span> detailPanel <span class="hljs-keyword">from</span> <span class="hljs-string">'./detail-panel/detail-panel.vue'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ComponentConfig</span> = {
    <span class="hljs-attr">createForm</span>: {
        <span class="hljs-attr">component</span>: createForm,
    },
    <span class="hljs-attr">editForm</span>: {
        <span class="hljs-attr">component</span>: editForm,
    },
    <span class="hljs-attr">detailPanel</span>: {
        <span class="hljs-attr">component</span>: detailPanel,
    },

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">ComponentConfig</span>
</code></pre>
<h3 data-id="heading-4">2.动态组件的表单控件</h3>
<p>针对于<code>createForm</code>和<code>editForm</code>动态组件进行的通用的<code>schema-form</code> widgets组件封装,对于<code>schema-form</code>表单实现结合shema中每个字段中配置的<code>comType</code>进行不同的表单控件渲染</p>
<p>同样通过<code>form-item-config.js</code>单独配置来管理表单控件的引入关系,便于后续的自定义表单控件的开发</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// form-item-config.js</span>
<span class="hljs-keyword">import</span> input <span class="hljs-keyword">from</span> <span class="hljs-string">'./complex-view/input/input.vue'</span>
<span class="hljs-keyword">import</span> inputNumber <span class="hljs-keyword">from</span> <span class="hljs-string">'./complex-view/input-number/input-number.vue'</span>
<span class="hljs-keyword">import</span> select <span class="hljs-keyword">from</span> <span class="hljs-string">'./complex-view/select/select.vue'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">FormItemConfig</span> = {
    <span class="hljs-attr">input</span>: {
        <span class="hljs-attr">component</span>: input,
    },
    <span class="hljs-attr">inputNumber</span>: {
        <span class="hljs-attr">component</span>: inputNumber,
    },
    <span class="hljs-attr">select</span>: {
        <span class="hljs-attr">component</span>: select,
    },
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">FormItemConfig</span>
</code></pre>
<p>进行表单组件封装时,我们要考虑如何<code>校验表单</code>与获取<code>表单内容</code>,在表单控件组件中我们都会导出<code>name</code>属性(控件名称),<code>validate</code>函数(校验函数),<code>getValue</code>函数(获取值)</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 以 input 控件为例子</span>
<span class="hljs-comment">// 校验函数 ,通过ajv校验当前的字段的shema中配置字段</span>
<span class="hljs-comment">// 例如input 中以字符串为主, 可能在schema中添加maxLength,minLength进行长度的要求</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">validate</span> = (<span class="hljs-params"/>) =&gt; {
    validTips.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">const</span> { type } = schema
    <span class="hljs-comment">//校验是否必填</span>
    <span class="hljs-keyword">if</span> (schema.<span class="hljs-property">option</span>?.<span class="hljs-property">required</span> &amp;&amp; !dtoValue.<span class="hljs-property">value</span>) {
        validTips.<span class="hljs-property">value</span> = <span class="hljs-string">'不能为空'</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    <span class="hljs-comment">//ajv 校验schema</span>
    <span class="hljs-keyword">if</span> (dtoValue.<span class="hljs-property">value</span>) {
        <span class="hljs-keyword">const</span> validate = ajv.<span class="hljs-title function_">compile</span>(schema)
        <span class="hljs-keyword">const</span> vaild = <span class="hljs-title function_">validate</span>(dtoValue.<span class="hljs-property">value</span>)
        <span class="hljs-keyword">if</span> (!vaild &amp;&amp; validate.<span class="hljs-property">errors</span> &amp;&amp; validate.<span class="hljs-property">errors</span>[<span class="hljs-number">0</span>]) {
            <span class="hljs-keyword">const</span> { keyword, params } = validate.<span class="hljs-property">errors</span>[<span class="hljs-number">0</span>]
            <span class="hljs-keyword">if</span> (keyword === <span class="hljs-string">'type'</span>) {
                validTips.<span class="hljs-property">value</span> = <span class="hljs-string">`类型必须为<span class="hljs-subst">${type}</span>`</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keyword === <span class="hljs-string">'maxLength'</span>) {
                validTips.<span class="hljs-property">value</span> = <span class="hljs-string">`最大长度应为:<span class="hljs-subst">${params.limit}</span>`</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keyword === <span class="hljs-string">'minLength'</span>) {
                validTips.<span class="hljs-property">value</span> = <span class="hljs-string">`最小长度应为:<span class="hljs-subst">${params.limit}</span>`</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keyword === <span class="hljs-string">'pattern'</span>) {
                validTips.<span class="hljs-property">value</span> = <span class="hljs-string">`格式不正确`</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(validate.<span class="hljs-property">errors</span>[<span class="hljs-number">0</span>]);
                validTips.<span class="hljs-property">value</span> = <span class="hljs-string">'不符合要求'</span>
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-comment">//schema 配置</span>
<span class="hljs-attr">product_name</span>: {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
  <span class="hljs-attr">label</span>: <span class="hljs-string">'商品名称'</span>,
  <span class="hljs-attr">maxLength</span>: <span class="hljs-number">10</span>, <span class="hljs-comment">//最大长度校验条件</span>
  <span class="hljs-attr">minLength</span>: <span class="hljs-number">3</span>, <span class="hljs-comment">//最小长度校验条件</span>
  <span class="hljs-attr">tableOption</span>: {
      <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>,
  },
  <span class="hljs-attr">searchOption</span>: {
      <span class="hljs-attr">comType</span>: <span class="hljs-string">'dynamicSelect'</span>,
      <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'请选择商品名称'</span>,
      <span class="hljs-attr">api</span>: <span class="hljs-string">'/api/proj/product_enum/list'</span>,
  },
  <span class="hljs-attr">createFormOption</span>: {
      <span class="hljs-attr">comType</span>: <span class="hljs-string">'input'</span>, <span class="hljs-comment">//在不同组件中该字段以什么样的表单控件进行展示</span>
  },
  <span class="hljs-attr">editFormOption</span>: {
      <span class="hljs-attr">comType</span>: <span class="hljs-string">'input'</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'测试一下'</span>
  },
  <span class="hljs-attr">detailPanelOption</span>: {},
},
</code></pre>
<h2 data-id="heading-5">四. schema 解析Hook</h2>
<p>通过<code>schema</code>配置转化为可视化界面中最重要的解析工具,从schema中将各个不同配置进行抽离出去形成新的<code>option</code>给组件进行页面渲染。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { ref, watch, onMounted, nextTick } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { useRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-keyword">import</span> { useMenuStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'$store/menu.js'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useSchema</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> route = <span class="hljs-title function_">useRoute</span>()
    <span class="hljs-keyword">const</span> menuStore = <span class="hljs-title function_">useMenuStore</span>()

    <span class="hljs-keyword">const</span> api = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
    <span class="hljs-keyword">const</span> tableSchema = <span class="hljs-title function_">ref</span>({})
    <span class="hljs-keyword">const</span> tableConfig = <span class="hljs-title function_">ref</span>()
    <span class="hljs-keyword">const</span> searchSchema = <span class="hljs-title function_">ref</span>({})
    <span class="hljs-keyword">const</span> searchConfig = <span class="hljs-title function_">ref</span>()
    <span class="hljs-keyword">const</span> components = <span class="hljs-title function_">ref</span>({})

    <span class="hljs-comment">//构造 schemaConfig 相关配置,,输送给 shemaView解释</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">buildData</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">const</span> { key, <span class="hljs-attr">sider_key</span>: siderKey } = route.<span class="hljs-property">query</span>

        <span class="hljs-keyword">const</span> mItem = menuStore.<span class="hljs-title function_">findMenuItem</span>({
            <span class="hljs-attr">key</span>: <span class="hljs-string">'key'</span>,
            <span class="hljs-attr">value</span>: siderKey ?? key
        })
        <span class="hljs-keyword">if</span> (mItem &amp;&amp; mItem.<span class="hljs-property">schemaConfig</span>) {
            <span class="hljs-keyword">const</span> { <span class="hljs-attr">schemaConfig</span>: sConfig } = mItem
            <span class="hljs-keyword">const</span> configSchema = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(sConfig.<span class="hljs-property">schema</span>))

            api.<span class="hljs-property">value</span> = sConfig.<span class="hljs-property">api</span> ?? <span class="hljs-string">''</span>
            tableSchema.<span class="hljs-property">value</span> = {}
            tableConfig.<span class="hljs-property">value</span> = <span class="hljs-literal">undefined</span>
            searchSchema.<span class="hljs-property">value</span> = {}
            searchConfig.<span class="hljs-property">value</span> = <span class="hljs-literal">undefined</span>
            components.<span class="hljs-property">value</span> = {}

            <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-comment">//构造 tableSchema 和 tableConfig</span>
                tableSchema.<span class="hljs-property">value</span> = <span class="hljs-title function_">buildDtoSchema</span>(configSchema, <span class="hljs-string">'table'</span>)
                tableConfig.<span class="hljs-property">value</span> = sConfig.<span class="hljs-property">tableConfig</span>
                <span class="hljs-comment">//构造 searchSchema 和 searchConfig</span>
                <span class="hljs-keyword">const</span> dtoSearchSchema = <span class="hljs-title function_">buildDtoSchema</span>(configSchema, <span class="hljs-string">'search'</span>)
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> dtoSearchSchema.<span class="hljs-property">properties</span>) {
                    <span class="hljs-keyword">if</span> (route.<span class="hljs-property">query</span>[key] !== <span class="hljs-literal">undefined</span>) {
                        dtoSearchSchema.<span class="hljs-property">properties</span>[key].<span class="hljs-property">option</span>.<span class="hljs-property">default</span> = route.<span class="hljs-property">query</span>[key]
                    }
                }
                searchSchema.<span class="hljs-property">value</span> = dtoSearchSchema
                searchConfig.<span class="hljs-property">value</span> = sConfig.<span class="hljs-property">tableConfig</span>

                <span class="hljs-comment">//构造 components = { comKey :{ schema:{} , config:{} } } </span>
                <span class="hljs-keyword">const</span> { componentConfig } = sConfig
                <span class="hljs-keyword">if</span> (componentConfig &amp;&amp; <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(componentConfig).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">const</span> dtoComponents = {}
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> comName <span class="hljs-keyword">in</span> componentConfig) {
                        dtoComponents[comName] = {
                            <span class="hljs-attr">schema</span>: <span class="hljs-title function_">buildDtoSchema</span>(configSchema, comName),
                            <span class="hljs-attr">config</span>: componentConfig[comName]
                        }
                    }
                    components.<span class="hljs-property">value</span> = dtoComponents
                }
            })
        }
    }

    <span class="hljs-comment">//通用构建 schema方法</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">buildDtoSchema</span> = (<span class="hljs-params">_schema, comName</span>) =&gt; {
        <span class="hljs-keyword">if</span> (!_schema?.<span class="hljs-property">properties</span>) { <span class="hljs-keyword">return</span> {} }
        <span class="hljs-keyword">const</span> dtoSchema = {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
            <span class="hljs-attr">properties</span>: {}
        }
        <span class="hljs-comment">// 提取有效 schema 字段量   </span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> _schema.<span class="hljs-property">properties</span>) {
            <span class="hljs-keyword">const</span> props = _schema.<span class="hljs-property">properties</span>[key]
            <span class="hljs-keyword">if</span> (props[<span class="hljs-string">`<span class="hljs-subst">${comName}</span>Option`</span>]) {
                <span class="hljs-keyword">let</span> dtoProps = {}
                <span class="hljs-comment">//提取 props 中非 option的部分,存放到 dtoProps中</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> pKey <span class="hljs-keyword">in</span> props) {
                    <span class="hljs-keyword">if</span> (pKey.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'Option'</span>) &lt; <span class="hljs-number">0</span>) {
                        dtoProps[pKey] = props[pKey]
                    }
                }
                <span class="hljs-comment">//处理 comName Option</span>
                dtoProps = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, dtoProps, { <span class="hljs-attr">option</span>: props[<span class="hljs-string">`<span class="hljs-subst">${comName}</span>Option`</span>] })
                <span class="hljs-comment">//处理 required 字段</span>
                <span class="hljs-keyword">const</span> { required } = _schema
                <span class="hljs-keyword">if</span> (required &amp;&amp; required.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">pk</span> =&gt;</span> pk === key)) {
                    dtoProps.<span class="hljs-property">option</span>.<span class="hljs-property">required</span> = <span class="hljs-literal">true</span>
                }
                dtoSchema.<span class="hljs-property">properties</span>[key] = dtoProps
            }
        }

        <span class="hljs-keyword">return</span> dtoSchema
    }
    <span class="hljs-title function_">watch</span>([
        <span class="hljs-function">() =&gt;</span> route.<span class="hljs-property">params</span>.<span class="hljs-property">key</span>,
        <span class="hljs-function">() =&gt;</span> route.<span class="hljs-property">params</span>.<span class="hljs-property">sider_key</span>,
        <span class="hljs-function">() =&gt;</span> menuStore.<span class="hljs-property">menuList</span>,
    ], <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">buildData</span>()
    }, { <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span> })

    <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">buildData</span>()
    })

    <span class="hljs-keyword">return</span> {
        api,
        tableSchema,
        tableConfig,
        searchSchema,
        searchConfig,
        components,
    }
}
</code></pre>
<h2 data-id="heading-6">五. 总结</h2>
<ol>
<li>
<p>在动态组件封装中,使用配置文件统一组件引入管理,保持封装的灵活和扩展性</p>
</li>
<li>
<p>完善<code>schema</code>配置,以<code>componentConfig</code>加载不同组件,增加不同组件的<code>xxxxxOption</code>配置完成该组件下不同的控件显示,最终形成我们所需要的交互动作</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2-2-2 快速掌握Kotlin-函数&Lambda]]></title>    <link>https://juejin.cn/post/7586623059525173311</link>    <guid>https://juejin.cn/post/7586623059525173311</guid>    <pubDate>2025-12-23T05:02:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586623059525173311" data-draft-id="7586623059524616255" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2-2-2 快速掌握Kotlin-函数&amp;Lambda"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T05:02:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="成都大菠萝"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2-2-2 快速掌握Kotlin-函数&amp;Lambda
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    成都大菠萝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T05:02:39.000Z" title="Tue Dec 23 2025 05:02:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kotlin 函数与 Lambda 表达式</h2>
<h3 data-id="heading-1">1. 函数（Functions）</h3>
<h4 data-id="heading-2">函数定义</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 基本函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">greet</span><span class="hljs-params">(name: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, <span class="hljs-variable">$name</span>!"</span>
}

<span class="hljs-comment">// 2. 表达式函数体（单表达式函数）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">add</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> = a + b

<span class="hljs-comment">// 3. 类型推断</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">multiply</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span> = a * b

<span class="hljs-comment">// 4. 无返回值（Unit 可省略）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printMessage</span><span class="hljs-params">(msg: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Unit</span> {
    println(msg)
}
<span class="hljs-comment">// 等价于</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printMessage</span><span class="hljs-params">(msg: <span class="hljs-type">String</span>)</span></span> {
    println(msg)
}
</code></pre>
<h4 data-id="heading-3">函数参数</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 默认参数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createUser</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, age: <span class="hljs-type">Int</span> = <span class="hljs-number">18</span>, city: <span class="hljs-type">String</span> = <span class="hljs-string">"Beijing"</span>)</span></span> {
    println(<span class="hljs-string">"Name: <span class="hljs-variable">$name</span>, Age: <span class="hljs-variable">$age</span>, City: <span class="hljs-variable">$city</span>"</span>)
}

<span class="hljs-comment">// 2. 命名参数</span>
createUser(name = <span class="hljs-string">"Alice"</span>, city = <span class="hljs-string">"Shanghai"</span>)  <span class="hljs-comment">// age 使用默认值 18</span>

<span class="hljs-comment">// 3. 可变参数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sum</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> numbers: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> numbers.sum()
}
sum(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)

<span class="hljs-comment">// 4. 函数参数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculate</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>, operation: (<span class="hljs-type">Int</span>, <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> operation(a, b)
}
</code></pre>
<h4 data-id="heading-4">特殊函数</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">addExclamation</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"<span class="hljs-variable">$this</span>!"</span>

<span class="hljs-keyword">val</span> message = <span class="hljs-string">"Hello"</span>.addExclamation()  <span class="hljs-comment">// "Hello!"</span>

<span class="hljs-comment">// 2. 中缀函数</span>
<span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-built_in">Int</span>.<span class="hljs-title">times</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span> = str.repeat(<span class="hljs-keyword">this</span>)
<span class="hljs-keyword">val</span> result = <span class="hljs-number">3</span> times <span class="hljs-string">"Hi"</span>  <span class="hljs-comment">// "HiHiHi"</span>

<span class="hljs-comment">// 3. 内联函数（用于高阶函数优化）</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">measureTime</span><span class="hljs-params">(block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> start = System.currentTimeMillis()
    block()
    <span class="hljs-keyword">val</span> end = System.currentTimeMillis()
    println(<span class="hljs-string">"Time: <span class="hljs-subst">${end - start}</span>ms"</span>)
}

<span class="hljs-comment">// 4. 尾递归函数</span>
<span class="hljs-keyword">tailrec</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">factorial</span><span class="hljs-params">(n: <span class="hljs-type">Int</span>, accumulator: <span class="hljs-type">Int</span> = <span class="hljs-number">1</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) accumulator <span class="hljs-keyword">else</span> factorial(n - <span class="hljs-number">1</span>, n * accumulator)
}

<span class="hljs-comment">// 5. 局部函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">outerFunction</span><span class="hljs-params">(x: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">innerFunction</span><span class="hljs-params">(y: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> x + y  <span class="hljs-comment">// 可以访问外部函数的参数</span>
    }
    println(innerFunction(<span class="hljs-number">5</span>))
}
</code></pre>
<h3 data-id="heading-5">2. Lambda 表达式</h3>
<h4 data-id="heading-6">基本语法</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 基本形式</span>
<span class="hljs-keyword">val</span> sum: (<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Int</span> = { a, b -&gt; a + b }

<span class="hljs-comment">// 2. 类型推断</span>
<span class="hljs-keyword">val</span> multiply = { a: <span class="hljs-built_in">Int</span>, b: <span class="hljs-built_in">Int</span> -&gt; a * b }

<span class="hljs-comment">// 3. 单参数 lambda（可用 it）</span>
<span class="hljs-keyword">val</span> double: (<span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Int</span> = { it * <span class="hljs-number">2</span> }
<span class="hljs-keyword">val</span> isEven: (<span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Boolean</span> = { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }

<span class="hljs-comment">// 4. 无参数 lambda</span>
<span class="hljs-keyword">val</span> sayHello: () -&gt; <span class="hljs-built_in">Unit</span> = { println(<span class="hljs-string">"Hello!"</span>) }

<span class="hljs-comment">// 5. 作为函数参数</span>
listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).forEach { println(it) }

<span class="hljs-comment">// 6. 带接收者的 lambda（常用于 DSL）</span>
<span class="hljs-keyword">val</span> stringBuilder = StringBuilder().apply {
    append(<span class="hljs-string">"Hello"</span>)
    append(<span class="hljs-string">" "</span>)
    append(<span class="hljs-string">"World"</span>)
}
</code></pre>
<h4 data-id="heading-7">Lambda 与集合操作</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>)

<span class="hljs-comment">// 1. filter - 过滤</span>
<span class="hljs-keyword">val</span> evens = numbers.filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }  <span class="hljs-comment">// [2, 4, 6, 8, 10]</span>

<span class="hljs-comment">// 2. map - 转换</span>
<span class="hljs-keyword">val</span> squares = numbers.map { it * it }  <span class="hljs-comment">// [1, 4, 9, 16, 25, ...]</span>

<span class="hljs-comment">// 3. reduce - 累积操作</span>
<span class="hljs-keyword">val</span> sum = numbers.reduce { acc, num -&gt; acc + num }  <span class="hljs-comment">// 55</span>

<span class="hljs-comment">// 4. fold - 带初始值的累积</span>
<span class="hljs-keyword">val</span> product = numbers.fold(<span class="hljs-number">1</span>) { acc, num -&gt; acc * num }

<span class="hljs-comment">// 5. takeWhile/dropWhile - 条件截取</span>
<span class="hljs-keyword">val</span> lessThan5 = numbers.takeWhile { it &lt; <span class="hljs-number">5</span> }  <span class="hljs-comment">// [1, 2, 3, 4]</span>
<span class="hljs-keyword">val</span> from5 = numbers.dropWhile { it &lt; <span class="hljs-number">5</span> }     <span class="hljs-comment">// [5, 6, 7, 8, 9, 10]</span>

<span class="hljs-comment">// 6. sortedBy - 排序</span>
<span class="hljs-keyword">val</span> strings = listOf(<span class="hljs-string">"apple"</span>, <span class="hljs-string">"banana"</span>, <span class="hljs-string">"cherry"</span>)
<span class="hljs-keyword">val</span> sortedByLength = strings.sortedBy { it.length }  <span class="hljs-comment">// ["apple", "cherry", "banana"]</span>

<span class="hljs-comment">// 7. groupBy - 分组</span>
<span class="hljs-keyword">val</span> groupedByParity = numbers.groupBy { 
    <span class="hljs-keyword">if</span> (it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) <span class="hljs-string">"even"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"odd"</span> 
}
<span class="hljs-comment">// 结果: {"odd"=[1,3,5,7,9], "even"=[2,4,6,8,10]}</span>

<span class="hljs-comment">// 8. flatMap - 扁平化映射</span>
<span class="hljs-keyword">val</span> nested = listOf(listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>), listOf(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>), listOf(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>))
<span class="hljs-keyword">val</span> flat = nested.flatMap { it }  <span class="hljs-comment">// [1, 2, 3, 4, 5, 6]</span>
</code></pre>
<h3 data-id="heading-8">3. 高阶函数（Higher-Order Functions）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 函数作为参数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processNumbers</span><span class="hljs-params">(
    numbers: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Int</span>&gt;,
    filter: (<span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Boolean</span>,
    transform: (<span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span>
)</span></span>: List&lt;<span class="hljs-built_in">Int</span>&gt; {
    <span class="hljs-keyword">return</span> numbers.filter(filter).map(transform)
}

<span class="hljs-keyword">val</span> result = processNumbers(
    numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>),
    filter = { it &gt; <span class="hljs-number">2</span> },
    transform = { it * <span class="hljs-number">10</span> }
)  <span class="hljs-comment">// [30, 40, 50]</span>

<span class="hljs-comment">// 2. 函数作为返回值</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getOperation</span><span class="hljs-params">(type: <span class="hljs-type">String</span>)</span></span>: (<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (type) {
        <span class="hljs-string">"add"</span> -&gt; { a, b -&gt; a + b }
        <span class="hljs-string">"multiply"</span> -&gt; { a, b -&gt; a * b }
        <span class="hljs-keyword">else</span> -&gt; { a, b -&gt; a - b }
    }
}

<span class="hljs-keyword">val</span> operation = getOperation(<span class="hljs-string">"add"</span>)
println(operation(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>))  <span class="hljs-comment">// 8</span>

<span class="hljs-comment">// 3. 组合函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">compose</span><span class="hljs-params">(f: (<span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span>, g: (<span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span>)</span></span>: (<span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> { x -&gt; f(g(x)) }
}

<span class="hljs-keyword">val</span> addTwo = { x: <span class="hljs-built_in">Int</span> -&gt; x + <span class="hljs-number">2</span> }
<span class="hljs-keyword">val</span> timesThree = { x: <span class="hljs-built_in">Int</span> -&gt; x * <span class="hljs-number">3</span> }
<span class="hljs-keyword">val</span> composed = compose(addTwo, timesThree)
println(composed(<span class="hljs-number">5</span>))  <span class="hljs-comment">// 17 = (5 * 3) + 2</span>

<span class="hljs-comment">// 4. 带接收者的函数类型</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">buildString</span><span class="hljs-params">(builderAction: <span class="hljs-type">StringBuilder</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> sb = StringBuilder()
    sb.builderAction()
    <span class="hljs-keyword">return</span> sb.toString()
}

<span class="hljs-keyword">val</span> s = buildString {
    append(<span class="hljs-string">"Hello, "</span>)
    append(<span class="hljs-string">"World!"</span>)
}  <span class="hljs-comment">// "Hello, World!"</span>
</code></pre>
<h3 data-id="heading-9">4. 作用域函数（Scope Functions）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">var</span> name: String, <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">var</span> city: String)

<span class="hljs-keyword">val</span> person = Person(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">25</span>, <span class="hljs-string">"New York"</span>)

<span class="hljs-comment">// 1. let - 用 it 引用对象，返回 lambda 结果</span>
<span class="hljs-keyword">val</span> nameLength = person.let {
    it.name = it.name.capitalize()
    it.name.length  <span class="hljs-comment">// 返回这个</span>
}

<span class="hljs-comment">// 2. run - 用 this 引用对象，返回 lambda 结果</span>
<span class="hljs-keyword">val</span> description = person.run {
    age += <span class="hljs-number">1</span>  <span class="hljs-comment">// 可以直接访问属性</span>
    <span class="hljs-string">"<span class="hljs-variable">$name</span> is <span class="hljs-variable">$age</span> years old from <span class="hljs-variable">$city</span>"</span>  <span class="hljs-comment">// 返回这个</span>
}

<span class="hljs-comment">// 3. with - 类似 run，但作为独立函数</span>
with(person) {
    println(<span class="hljs-string">"Processing <span class="hljs-variable">$name</span>"</span>)
    city = <span class="hljs-string">"London"</span>
}

<span class="hljs-comment">// 4. apply - 用 this 引用对象，返回对象本身</span>
<span class="hljs-keyword">val</span> modifiedPerson = person.apply {
    name = <span class="hljs-string">"Bob"</span>
    age = <span class="hljs-number">30</span>
}  <span class="hljs-comment">// 返回 person 对象本身</span>

<span class="hljs-comment">// 5. also - 用 it 引用对象，返回对象本身</span>
<span class="hljs-keyword">val</span> personCopy = person.also {
    println(<span class="hljs-string">"Before: <span class="hljs-variable">$it</span>"</span>)
    it.age = <span class="hljs-number">26</span>
}.also {
    println(<span class="hljs-string">"After: <span class="hljs-variable">$it</span>"</span>)
}
</code></pre>
<h3 data-id="heading-10">5. Lambda 的特殊语法</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 最后参数是 lambda 时可以放到括号外</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">executeWithDelay</span><span class="hljs-params">(delay: <span class="hljs-type">Long</span>, action: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    Thread.sleep(delay)
    action()
}

<span class="hljs-comment">// 传统调用</span>
executeWithDelay(<span class="hljs-number">1000</span>, { println(<span class="hljs-string">"Hello"</span>) })

<span class="hljs-comment">// 简化调用（推荐）</span>
executeWithDelay(<span class="hljs-number">1000</span>) {
    println(<span class="hljs-string">"Hello"</span>)
}

<span class="hljs-comment">// 2. 如果 lambda 是唯一参数，可以省略括号</span>
listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).forEach { println(it) }

<span class="hljs-comment">// 3. 带标签的 return</span>
listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>).forEach {
    <span class="hljs-keyword">if</span> (it == <span class="hljs-number">3</span>) <span class="hljs-keyword">return</span><span class="hljs-symbol">@forEach</span>  <span class="hljs-comment">// 只从这个 lambda 返回</span>
    println(it)
}
<span class="hljs-comment">// 输出: 1 2 4 5</span>

<span class="hljs-comment">// 4. 匿名函数（类似 lambda，但 return 行为不同）</span>
listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).forEach(<span class="hljs-function"><span class="hljs-title">fun</span><span class="hljs-params">(value)</span></span> {
    <span class="hljs-keyword">if</span> (value == <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 从匿名函数返回，继续循环</span>
    println(value)
})
<span class="hljs-comment">// 输出: 1 3</span>
</code></pre>
<h3 data-id="heading-11">6. 实用示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. DSL 构建器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HTML</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">body</span><span class="hljs-params">()</span></span> { println(<span class="hljs-string">"Creating body"</span>) }
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">div</span><span class="hljs-params">(block: <span class="hljs-type">Div</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span> { Div().apply(block) }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Div</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">p</span><span class="hljs-params">(text: <span class="hljs-type">String</span>)</span></span> { println(<span class="hljs-string">"Paragraph: <span class="hljs-variable">$text</span>"</span>) }
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">a</span><span class="hljs-params">(href: <span class="hljs-type">String</span>, text: <span class="hljs-type">String</span>)</span></span> { println(<span class="hljs-string">"Link: &lt;a href='<span class="hljs-variable">$href</span>'&gt;<span class="hljs-variable">$text</span>&lt;/a&gt;"</span>) }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">html</span><span class="hljs-params">(block: <span class="hljs-type">HTML</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: HTML {
    <span class="hljs-keyword">return</span> HTML().apply(block)
}

html {
    body()
    div {
        p(<span class="hljs-string">"Hello World"</span>)
        a(<span class="hljs-string">"https://kotlinlang.org"</span>, <span class="hljs-string">"Kotlin"</span>)
    }
}

<span class="hljs-comment">// 2. 缓存计算结果</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T, R&gt;</span> <span class="hljs-title">memoize</span><span class="hljs-params">(fn: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: (T) -&gt; R {
    <span class="hljs-keyword">val</span> cache = mutableMapOf&lt;T, R&gt;()
    <span class="hljs-keyword">return</span> { key -&gt;
        cache.getOrPut(key) { fn(key) }
    }
}

<span class="hljs-keyword">val</span> expensiveCalculation = memoize { n: <span class="hljs-built_in">Int</span> -&gt;
    println(<span class="hljs-string">"Calculating for <span class="hljs-variable">$n</span>"</span>)
    <span class="hljs-comment">// 模拟耗时计算</span>
    (<span class="hljs-number">1.</span>.n).sum()
}

println(expensiveCalculation(<span class="hljs-number">5</span>))  <span class="hljs-comment">// 计算并缓存</span>
println(expensiveCalculation(<span class="hljs-number">5</span>))  <span class="hljs-comment">// 直接使用缓存</span>
</code></pre>
<h3 data-id="heading-12">7. 函数引用</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 函数引用</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isEven</span><span class="hljs-params">(n: <span class="hljs-type">Int</span>)</span></span> = n % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>
<span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)

<span class="hljs-comment">// 使用函数引用</span>
<span class="hljs-keyword">val</span> evens = numbers.filter(::isEven)

<span class="hljs-comment">// 2. 属性引用</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>)
<span class="hljs-keyword">val</span> users = listOf(User(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">25</span>), User(<span class="hljs-string">"Bob"</span>, <span class="hljs-number">30</span>))

<span class="hljs-comment">// 按属性引用排序</span>
<span class="hljs-keyword">val</span> sortedByName = users.sortedBy(User::name)
<span class="hljs-keyword">val</span> ages = users.map(User::age)

<span class="hljs-comment">// 3. 构造函数引用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String)

<span class="hljs-keyword">val</span> createPerson = ::Person
<span class="hljs-keyword">val</span> person = createPerson(<span class="hljs-string">"Charlie"</span>)

<span class="hljs-comment">// 4. 绑定函数引用</span>
<span class="hljs-keyword">val</span> alice = User(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">25</span>)
<span class="hljs-keyword">val</span> isAliceAdult = alice::isAdult
println(isAliceAdult())  <span class="hljs-comment">// true</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> User.<span class="hljs-title">isAdult</span><span class="hljs-params">()</span></span> = age &gt;= <span class="hljs-number">18</span>
</code></pre>
<h3 data-id="heading-13">最佳实践</h3>
<ol>
<li><strong>优先使用表达式函数体</strong>：当函数体很简单时</li>
<li><strong>合理使用默认参数</strong>：减少重载函数数量</li>
<li><strong>善用作用域函数</strong>：让代码更简洁清晰</li>
<li><strong>链式调用时考虑性能</strong>：避免创建过多中间集合</li>
<li><strong>使用函数引用</strong>：提高代码可读性</li>
<li><strong>内联高阶函数</strong>：减少 lambda 开销</li>
<li><strong>注意 lambda 中的返回行为</strong>：使用标签或匿名函数控制</li>
</ol>
<p>Kotlin 的函数和 lambda 表达式是其函数式编程能力的核心，它们使代码更加简洁、表达力更强，并且支持多种编程范式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2-1-1 快速掌握Kotlin-kotlin中变量&语句&表达式]]></title>    <link>https://juejin.cn/post/7586585688004804649</link>    <guid>https://juejin.cn/post/7586585688004804649</guid>    <pubDate>2025-12-23T03:18:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586585688004804649" data-draft-id="7586555198116184070" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2-1-1 快速掌握Kotlin-kotlin中变量&amp;语句&amp;表达式"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T03:18:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="成都大菠萝"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2-1-1 快速掌握Kotlin-kotlin中变量&amp;语句&amp;表达式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    成都大菠萝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:18:27.000Z" title="Tue Dec 23 2025 03:18:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Kotlin 中，变量、语句和表达式是编程的基础概念。让我详细解释：</p>
<h2 data-id="heading-0">1. 变量（Variables）</h2>
<h3 data-id="heading-1">声明方式</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 只读变量（推荐使用，类似 Java 的 final）</span>
<span class="hljs-keyword">val</span> name = <span class="hljs-string">"Kotlin"</span>  <span class="hljs-comment">// 类型自动推断为 String</span>
<span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">25</span>     <span class="hljs-comment">// 显式声明类型</span>

<span class="hljs-comment">// 可变变量</span>
<span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>
<span class="hljs-keyword">var</span> price: <span class="hljs-built_in">Double</span> = <span class="hljs-number">99.9</span>
</code></pre>
<h3 data-id="heading-2">特点</h3>
<ul>
<li><code>val</code>（value）只读变量，赋值后不能修改</li>
<li><code>var</code>（variable）可变变量，可以重新赋值</li>
<li>类型可自动推断，也可显式声明</li>
<li>变量名使用驼峰命名法</li>
</ul>
<h3 data-id="heading-3">空安全</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">var</span> nullableString: String? = <span class="hljs-literal">null</span>  <span class="hljs-comment">// 可空类型</span>
<span class="hljs-keyword">var</span> nonNullString: String = <span class="hljs-string">"Hello"</span>  <span class="hljs-comment">// 非空类型（默认）</span>

<span class="hljs-keyword">val</span> length = nullableString?.length  <span class="hljs-comment">// 安全调用</span>
<span class="hljs-keyword">val</span> length2 = nullableString!!.length  <span class="hljs-comment">// 非空断言（可能抛异常）</span>
<span class="hljs-keyword">val</span> length3 = nullableString?.length ?: <span class="hljs-number">0</span>  <span class="hljs-comment">// Elvis 操作符</span>
</code></pre>
<h2 data-id="heading-4">2. 语句（Statements）</h2>
<p>语句是执行操作的代码单元，不返回值：</p>
<h3 data-id="heading-5">赋值语句</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> x = <span class="hljs-number">10</span>
<span class="hljs-keyword">var</span> y = <span class="hljs-number">20</span>
y = <span class="hljs-number">30</span>  <span class="hljs-comment">// 重新赋值</span>
</code></pre>
<h3 data-id="heading-6">控制流语句</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// if 语句</span>
<span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">5</span>) {
    println(<span class="hljs-string">"x is greater than 5"</span>)
} <span class="hljs-keyword">else</span> {
    println(<span class="hljs-string">"x is not greater than 5"</span>)
}

<span class="hljs-comment">// when 语句（类似 switch）</span>
<span class="hljs-keyword">when</span> (x) {
    <span class="hljs-number">1</span> -&gt; println(<span class="hljs-string">"One"</span>)
    <span class="hljs-number">2</span> -&gt; println(<span class="hljs-string">"Two"</span>)
    <span class="hljs-keyword">in</span> <span class="hljs-number">3.</span><span class="hljs-number">.10</span> -&gt; println(<span class="hljs-string">"3 to 10"</span>)
    <span class="hljs-keyword">else</span> -&gt; println(<span class="hljs-string">"Other"</span>)
}

<span class="hljs-comment">// for 循环</span>
<span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.5</span>) {
    println(i)
}

<span class="hljs-keyword">val</span> items = listOf(<span class="hljs-string">"apple"</span>, <span class="hljs-string">"banana"</span>, <span class="hljs-string">"orange"</span>)
<span class="hljs-keyword">for</span> (item <span class="hljs-keyword">in</span> items) {
    println(item)
}

<span class="hljs-comment">// while 循环</span>
<span class="hljs-keyword">while</span> (x &gt; <span class="hljs-number">0</span>) {
    println(x)
    x--
}
</code></pre>
<h2 data-id="heading-7">3. 表达式（Expressions）</h2>
<p>表达式有值，可以放在赋值符号右边：</p>
<h3 data-id="heading-8">赋值表达式</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> result = <span class="hljs-number">5</span> + <span class="hljs-number">3</span> * <span class="hljs-number">2</span>  <span class="hljs-comment">// 表达式值为 11</span>
</code></pre>
<h3 data-id="heading-9">if 表达式（在 Kotlin 中，if 是表达式）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> max = <span class="hljs-keyword">if</span> (a &gt; b) a <span class="hljs-keyword">else</span> b  <span class="hljs-comment">// if 返回一个值</span>

<span class="hljs-keyword">val</span> grade = <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">90</span>) {
    <span class="hljs-string">"A"</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">80</span>) {
    <span class="hljs-string">"B"</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-string">"C"</span>
}
</code></pre>
<h3 data-id="heading-10">when 表达式</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> description = <span class="hljs-keyword">when</span> (number) {
    <span class="hljs-number">1</span> -&gt; <span class="hljs-string">"One"</span>
    <span class="hljs-number">2</span> -&gt; <span class="hljs-string">"Two"</span>
    <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"Many"</span>
}

<span class="hljs-keyword">val</span> type = <span class="hljs-keyword">when</span> {
    x &gt; <span class="hljs-number">0</span> -&gt; <span class="hljs-string">"Positive"</span>
    x &lt; <span class="hljs-number">0</span> -&gt; <span class="hljs-string">"Negative"</span>
    <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"Zero"</span>
}
</code></pre>
<h3 data-id="heading-11">try-catch 表达式</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> number = <span class="hljs-keyword">try</span> {
    <span class="hljs-string">"123"</span>.toInt()
} <span class="hljs-keyword">catch</span> (e: NumberFormatException) {
    <span class="hljs-number">0</span>  <span class="hljs-comment">// 默认值</span>
}
</code></pre>
<h3 data-id="heading-12">Lambda 表达式</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> sum = { a: <span class="hljs-built_in">Int</span>, b: <span class="hljs-built_in">Int</span> -&gt; a + b }
println(sum(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>))  <span class="hljs-comment">// 输出 8</span>

<span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
<span class="hljs-keyword">val</span> doubled = numbers.map { it * <span class="hljs-number">2</span> }  <span class="hljs-comment">// [2, 4, 6, 8, 10]</span>
</code></pre>
<h2 data-id="heading-13">4. 关键区别和特性</h2>
<h3 data-id="heading-14">表达式 vs 语句</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 语句（不返回值）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printMessage</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
    println(message)
}

<span class="hljs-comment">// 表达式函数（单表达式函数）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">add</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span> = a + b

<span class="hljs-comment">// if 作为表达式（返回类型推断为 Int）</span>
<span class="hljs-keyword">val</span> result = <span class="hljs-keyword">if</span> (condition) <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">2</span>
</code></pre>
<h3 data-id="heading-15">作用域函数（特殊的表达式）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> person = Person().apply {
    name = <span class="hljs-string">"Alice"</span>
    age = <span class="hljs-number">25</span>
}

<span class="hljs-keyword">val</span> length = person.let {
    it.name.length
}

<span class="hljs-keyword">val</span> modified = person.run {
    name = <span class="hljs-string">"Bob"</span>
    <span class="hljs-keyword">this</span>  <span class="hljs-comment">// 返回对象本身</span>
}
</code></pre>
<h3 data-id="heading-16">范围表达式</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 范围表达式</span>
<span class="hljs-keyword">val</span> range1 = <span class="hljs-number">1.</span><span class="hljs-number">.10</span>  <span class="hljs-comment">// 包含 10</span>
<span class="hljs-keyword">val</span> range2 = <span class="hljs-number">1</span> until <span class="hljs-number">10</span>  <span class="hljs-comment">// 不包含 10</span>
<span class="hljs-keyword">val</span> range3 = <span class="hljs-number">10</span> downTo <span class="hljs-number">1</span>  <span class="hljs-comment">// 递减</span>
<span class="hljs-keyword">val</span> range4 = <span class="hljs-number">1.</span><span class="hljs-number">.10</span> step <span class="hljs-number">2</span>  <span class="hljs-comment">// 步长为 2</span>
</code></pre>
<h2 data-id="heading-17">5. 实用示例</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 变量声明和初始化</span>
<span class="hljs-keyword">val</span> name = <span class="hljs-string">"Kotlin"</span>
<span class="hljs-keyword">var</span> counter = <span class="hljs-number">0</span>

<span class="hljs-comment">// 表达式组合</span>
<span class="hljs-keyword">val</span> status = <span class="hljs-keyword">when</span> {
    counter &gt; <span class="hljs-number">10</span> -&gt; <span class="hljs-string">"High"</span>
    counter &gt; <span class="hljs-number">5</span> -&gt; <span class="hljs-string">"Medium"</span>
    counter &gt; <span class="hljs-number">0</span> -&gt; <span class="hljs-string">"Low"</span>
    <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"Zero"</span>
}

<span class="hljs-comment">// 使用 Elvis 操作符处理空值</span>
<span class="hljs-keyword">val</span> displayName = nullableName ?: <span class="hljs-string">"Guest"</span>

<span class="hljs-comment">// 集合操作（函数式表达式）</span>
<span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
<span class="hljs-keyword">val</span> evenSquares = numbers
    .filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }
    .map { it * it }
    .sum()
</code></pre>
<h2 data-id="heading-18">最佳实践</h2>
<ol>
<li><strong>优先使用 <code>val</code></strong>，除非确实需要可变性</li>
<li><strong>利用类型推断</strong>减少冗余代码</li>
<li><strong>使用表达式形式</strong>使代码更简洁</li>
<li><strong>善用空安全特性</strong>避免空指针异常</li>
<li><strong>使用范围表达式</strong>简化循环和条件判断</li>
</ol>
<p>Kotlin 的设计鼓励使用表达式而不是语句，这使代码更简洁、更函数式。很多在 Java 中是语句的结构，在 Kotlin 中都是表达式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[烧脑时刻：Dart 中异步生成器与流]]></title>    <link>https://juejin.cn/post/7586585688005181481</link>    <guid>https://juejin.cn/post/7586585688005181481</guid>    <pubDate>2025-12-23T03:44:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586585688005181481" data-draft-id="7586579021284229174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="烧脑时刻：Dart 中异步生成器与流"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-23T03:44:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OldBirds"/> <meta itemprop="url" content="https://juejin.cn/user/325111172054350"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            烧脑时刻：Dart 中异步生成器与流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/325111172054350/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OldBirds
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:44:16.000Z" title="Tue Dec 23 2025 03:44:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>有这么一段代码：</p>
<pre><code class="hljs language-dart" lang="dart">Stream&lt;<span class="hljs-built_in">int</span>&gt; countStream(<span class="hljs-built_in">int</span> max) <span class="hljs-keyword">async</span>* {
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; max; i++) {
        <span class="hljs-keyword">yield</span> i;
    }
}
</code></pre>
<p>这段代码定义了一个异步生成器函数，用来产生一个整数序列的流（<code>Stream</code>）。我会从基础到核心，帮你把这段代码拆解清楚。</p>
<h2 data-id="heading-0">代码整体功能</h2>
<p>这段代码定义了一个名为 <code>countStream</code> 的函数，它接收一个整数参数 <code>max</code>，返回一个 <code>Stream&lt;int&gt;</code>（整数类型的流）。这个流会异步地、逐个地生成从 <code>0</code> 到 <code>max-1</code> 的整数序列（比如传入 <code>max=3</code>，会依次产生 <code>0</code>、<code>1</code>、<code>2</code>）。</p>
<h2 data-id="heading-1">逐行拆解解释</h2>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 函数返回值是 Stream&lt;int&gt;：表示这是一个能产生整数的"数据流"</span>
Stream&lt;<span class="hljs-built_in">int</span>&gt; countStream(<span class="hljs-built_in">int</span> max) <span class="hljs-keyword">async</span>* {
    <span class="hljs-comment">// 普通的 for 循环，从 0 开始，到 max-1 结束</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; max; i++) {
        <span class="hljs-comment">// 核心关键字：yield，作用是"产出"一个值到流中</span>
        <span class="hljs-keyword">yield</span> i;
    }
}
</code></pre>
<h2 data-id="heading-2">核心概念解释</h2>
<h3 data-id="heading-3"><code>Stream&lt;int&gt;</code>：流</h3>
<p>你可以把 <code>Stream</code> 理解成一个<strong>异步的、可迭代的 "管道"</strong>：</p>
<ul>
<li>普通的 List 是一次性把所有数据（比如 [0,1,2]）放在一个容器里给你；</li>
<li>而 Stream 是把数据<strong>逐个、异步地</strong>通过管道传给你（先传 0，再传 1，再传 2），适合处理需要 "边产生边消费" 的场景（比如网络请求、文件读取、实时数据）。</li>
</ul>
<h3 data-id="heading-4"><code>async*</code>：异步生成器函数</h3>
<ul>
<li><code>async</code>：标记函数是异步的，但 <code>async*</code> 是 Dart 专门用于<code>生成 Stream</code>的异步生成器语法（区别于普通异步函数的 async）；</li>
<li><code>*</code>：表示这是一个 "生成器" 函数，作用是持续产生值，而不是只返回一个值。</li>
</ul>
<h3 data-id="heading-5">yield：产出值到流中</h3>
<p>yield 是生成器的核心关键字：</p>
<ul>
<li>当执行到<code>yield i</code>时，函数会把当前的<code>i</code>值 "发送" 到 Stream 中，供监听者接收；</li>
<li>发送后函数不会结束，而是暂停在这里，等下一次被请求时继续执行循环（直到循环结束，Stream 才会关闭）。</li>
</ul>
<h3 data-id="heading-6">实际使用示例</h3>
<p>为了让你更直观理解，我写一个完整的使用示例，你可以直接运行：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 调用函数，得到一个流（此时流还没开始产生数据）</span>
  Stream&lt;<span class="hljs-built_in">int</span>&gt; stream = countStream(<span class="hljs-number">3</span>);
  
  <span class="hljs-comment">// 监听流，接收每一个产出的值</span>
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> value <span class="hljs-keyword">in</span> stream) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'收到值：<span class="hljs-subst">$value</span>'</span>);
  }
  
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'流已结束'</span>);
}

<span class="hljs-comment">// 你提供的原函数</span>
Stream&lt;<span class="hljs-built_in">int</span>&gt; countStream(<span class="hljs-built_in">int</span> max) <span class="hljs-keyword">async</span>* {
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; max; i++) {
    <span class="hljs-keyword">yield</span> i;
  }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-dart" lang="dart">收到值：<span class="hljs-number">0</span>
收到值：<span class="hljs-number">1</span>
收到值：<span class="hljs-number">2</span>
流已结束
</code></pre>
<ul>
<li><code>countStream</code> 是一个<code>异步生成器函数</code>（<code>async*</code>），返回一个整数类型的流（<code>Stream&lt;int&gt;</code>）；</li>
<li><code>yield</code> 关键字负责把循环中的每个整数逐个 "发送" 到流中，而非一次性返回所有值；</li>
<li>流的特点是异步、逐个消费，需要通过 <code>await for</code> 或 <code>listen</code> 来监听和接收值。</li>
</ul>
<h2 data-id="heading-7">优点</h2>
<p>用<code>Dart</code> 异步生成器（<code>async* + yield</code>）返回 <code>Stream</code> 的方式来生成数据序列，相比直接返回列表（<code>List</code>）等其他方式，具体有哪些优势。我会结合实际场景，把这些好处讲得通俗易懂。</p>
<h3 data-id="heading-8">极致的内存效率：避免一次性加载所有数据</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 危险：max=1亿时会直接卡崩/内存溢出</span>
<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt; countList(<span class="hljs-built_in">int</span> max) {
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">List</span>.generate(max, (i) =&gt; i);
}

<span class="hljs-comment">// 安全：max=1亿也能正常运行（只要消费端能处理）</span>
Stream&lt;<span class="hljs-built_in">int</span>&gt; countStream(<span class="hljs-built_in">int</span> max) <span class="hljs-keyword">async</span>* {
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; max; i++) {
    <span class="hljs-keyword">yield</span> i;
  }
}
</code></pre>
<p>这是最核心的好处。</p>
<ul>
<li>如果用 <code>List&lt;int&gt; countList(int max)</code>，当 <code>max</code> 非常大（比如 100 万、1 亿）时，会<strong>一次性在内存中创建包含所有元素的列表</strong>，瞬间占用大量内存，甚至可能导致内存溢出（OOM）。</li>
<li>而 <code>Stream</code> + <code>yield</code> 的方式：每次只生成一个值并发送，内存中始终只保留当前的 <code>i</code>（单个整数），无论 <code>max</code> 多大，内存占用几乎可以忽略。</li>
</ul>
<h3 data-id="heading-9">异步非阻塞：不卡主线程，支持耗时操作</h3>
<p><code>Stream</code> 是异步的，生成数据的过程可以包含耗时操作（比如网络请求、文件读取），且不会阻塞主线程；而普通列表是同步生成，耗时操作会卡住整个程序。</p>
<h3 data-id="heading-10">实时响应：边生产边消费，提升交互体验</h3>
<p><code>Stream</code> 是「流式处理」，生成一个值就可以立即消费一个值，无需等待所有数据生成完毕。</p>
<ul>
<li>比如做一个「实时计数展示」的功能：用 <code>Stream</code> 可以每生成一个数就立刻更新 <code>UI</code>，用户能看到计数逐步增加；</li>
<li>用列表的话，必须等所有数生成完，才能一次性展示，用户会看到长时间的空白，体验极差。</li>
</ul>
<h2 data-id="heading-11">缺点</h2>
<h3 data-id="heading-12">手动管理成本极高，极易引发内存泄漏</h3>
<p>这是最致命的缺点，也是实际项目中最容易踩的坑。</p>
<ul>
<li>问题本质：<code>async*</code> 生成的 <code>Stream</code> 订阅后，必须手动调用 <code>subscription.cancel()</code> 取消订阅（比如在页面 <code>dispose</code> 生命周期中）；如果忘记取消，<code>async*</code> 函数会持续执行（比如倒计时循环、分页请求），导致内存泄漏（页面销毁后仍占用资源），甚至引发空指针异常（订阅回调中操作已销毁的 <code>Widget</code>）。</li>
<li>对比主流方案：<code>Bloc/Riverpod/Provider</code> 会自动绑定 <code>Widget</code> 生命周期，页面销毁时自动终止状态更新；<code>ValueNotifier</code> 也无需手动取消监听，<code>GC</code> 会自动处理。</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadStreamPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> BadStreamPage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;BadStreamPage&gt; createState() =&gt; _BadStreamPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_BadStreamPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">BadStreamPage</span>&gt; </span>{
  StreamSubscription&lt;<span class="hljs-built_in">int</span>&gt;? _subscription;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    <span class="hljs-comment">// 订阅倒计时流，但忘记在 dispose 中取消</span>
    _subscription = countStream(<span class="hljs-number">60</span>).listen((i) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'倒计时：<span class="hljs-subst">$i</span>'</span>); <span class="hljs-comment">// 页面销毁后仍会打印，内存泄漏</span>
    });
  }

  <span class="hljs-comment">// 忘记重写 dispose 取消订阅 → 内存泄漏！</span>
  <span class="hljs-comment">// @override</span>
  <span class="hljs-comment">// void dispose() {</span>
  <span class="hljs-comment">//   _subscription?.cancel(); // 必须手动取消</span>
  <span class="hljs-comment">//   super.dispose();</span>
  <span class="hljs-comment">// }</span>

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Center(child: Text(<span class="hljs-string">'倒计时页面'</span>));
  }
}
</code></pre>
<h3 data-id="heading-13">调试体验差，难以追踪数据流转</h3>
<p>原生 <code>Stream + async*</code> 缺乏配套的调试工具，排查问题成本极高。</p>
<ul>
<li>问题 1：无法直观看到 <code>yield</code> 的调用时机、数据值，只能靠 <code>print</code> 日志调试；</li>
<li>问题 2：无法追踪 <code>Stream</code> 的订阅 / 取消状态，排查内存泄漏时只能靠猜；</li>
<li>对比主流方案：<code>Bloc</code> 有 <code>BlocObserver</code> 可全局监控所有状态 <code>emit</code>操作，<code>Flutter DevTools</code> 能可视化 <code>Riverpod/Provider</code> 的状态变化，调试效率提升 10 倍。</li>
</ul>
<h3 data-id="heading-14">认知与协作成本高，团队易出分歧</h3>
<p><code>async*</code>、<code>yield</code>、<code>Stream</code> 属于 <code>Dart</code> 进阶语法，而非基础语法：</p>
<ul>
<li>新手理解成本高（比如分不清 <code>async</code> vs <code>async*</code>、<code>yield</code> vs <code>return</code>），容易写出逻辑错误的代码；</li>
<li>团队协作时，部分开发者用原生 <code>Stream</code>，部分用 <code>Bloc/Riverpod</code>，代码风格不统一，维护成本飙升；</li>
<li>对比主流方案：<code>setState</code>、<code>Future</code>、<code>Provider</code> 是 <code>Flutter</code> 入门必学内容，所有开发者都能快速上手。</li>
</ul>
<p>这些缺点决定了它只适合<code>「底层流式处理、大数据量、可中断序列」</code>等小众高需求场景。</p>
<h2 data-id="heading-15">典型场景</h2>
<h3 data-id="heading-16">实时、连续的「原生数据流」处理（不可替代）</h3>
<p>这是最核心的高需求场景 —— 当你需要处理<code>持续产生、无固定终点</code>的实时数据时，<code>async*</code> + <code>Stream</code> 是唯一简洁且高效的选择。</p>
<p>典型业务场景：</p>
<ul>
<li>蓝牙 / BLE / 串口通信（实时接收设备数据，比如手环心率、智能家居传感器）；</li>
<li>传感器数据（手机加速度计、陀螺仪、GPS 实时定位）；</li>
<li>WebSocket/SSE 推送（实时聊天、行情刷新、消息通知）；</li>
<li>实时日志监控（APP 运行日志、服务器日志实时展示）。</li>
</ul>
<p>这类场景的核心是「数据持续产生，需要逐次消费」，<code>Future</code> 只能处理单次异步操作，状态管理库（Bloc/Riverpod）是「状态封装层」，而底层的数据流生成必须依赖 <code>Stream</code>；<code>async*</code> + <code>yield</code> 则是生成这类流式数据最简洁的原生方式。</p>
<p>示例：蓝牙实时数据读取</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_blue_plus/flutter_blue_plus.dart'</span>;

<span class="hljs-comment">// 用 async* + yield 实时读取蓝牙设备的特征值数据</span>
Stream&lt;<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt;&gt; readBleDataStream(BluetoothCharacteristic characteristic) <span class="hljs-keyword">async</span>* {
  <span class="hljs-comment">// 持续监听蓝牙数据，有新数据就 yield 出去</span>
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> value <span class="hljs-keyword">in</span> characteristic.onValueReceived) {
    <span class="hljs-keyword">yield</span> value; <span class="hljs-comment">// 实时产出蓝牙设备发来的字节数据</span>
  }
}

<span class="hljs-comment">// 消费端使用</span>
<span class="hljs-keyword">void</span> listenBleData(BluetoothCharacteristic characteristic) {
  readBleDataStream(characteristic).listen((data) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'实时蓝牙数据：<span class="hljs-subst">$data</span>'</span>); <span class="hljs-comment">// 每收到一次数据就处理一次</span>
  });
}
</code></pre>
<p>其他方案的不足：</p>
<ul>
<li>用 <code>Future</code>：无法持续监听，只能单次读取，完全不适用；</li>
<li>用 <code>Bloc</code>：<code>Bloc</code> 的 <code>emit</code> 本质是封装了 <code>Stream</code>，但底层仍需用 <code>async*</code> 生成数据流，只是上层封装，而非替代。</li>
</ul>
<h3 data-id="heading-17">大数据量「流式处理」（内存敏感场景）</h3>
<p>当处理<code>超大文件 / 超大数据</code>集时，<code>async*</code> + <code>yield</code> 是避免 <code>OOM</code>（内存溢出）的最优解，属于「必须用」的高需求场景。</p>
<p>典型业务场景：</p>
<ul>
<li>读取 / 解析超大本地文件（比如 <code>100MB+</code> 的 <code>CSV/JSON</code> 日志文件、<code>Excel</code> 报表）；</li>
<li>大批量数据导出（比如导出 <code>10</code> 万条订单数据为 <code>CSV</code>，逐行生成避免内存爆炸）；</li>
<li>批量数据库查询（逐批读取数据，而非一次性加载所有结果）。</li>
</ul>
<p>这类场景的核心是「内存可控」—— 一次性加载所有数据会直接导致 <code>App</code> 崩溃，而 <code>yield</code> 能逐行/逐块产出数据，内存占用始终保持在极低水平。</p>
<p>实战示例：解析超大 <code>CSV</code> 文件</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'dart:io'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'dart:convert'</span>;

<span class="hljs-comment">// 用 async* + yield 逐行解析超大 CSV 文件，避免 OOM</span>
Stream&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt;&gt; parseLargeCsvStream(<span class="hljs-built_in">String</span> filePath) <span class="hljs-keyword">async</span>* {
  <span class="hljs-keyword">final</span> file = File(filePath);
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">await</span> file.exists()) <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">'文件不存在'</span>);

  <span class="hljs-keyword">final</span> lines = file.openRead()
      .transform(utf8.decoder)
      .transform(<span class="hljs-keyword">const</span> LineSplitter());

  <span class="hljs-comment">// 读取表头</span>
  <span class="hljs-keyword">final</span> headerLine = <span class="hljs-keyword">await</span> lines.first;
  <span class="hljs-keyword">final</span> headers = headerLine.split(<span class="hljs-string">','</span>);

  <span class="hljs-comment">// 逐行解析数据并 yield</span>
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> line <span class="hljs-keyword">in</span> lines) {
    <span class="hljs-keyword">if</span> (line.isEmpty) <span class="hljs-keyword">continue</span>;
    <span class="hljs-keyword">final</span> values = line.split(<span class="hljs-string">','</span>);
    <span class="hljs-keyword">final</span> row = &lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt;{};
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; headers.length; i++) {
      row[headers[i]] = values[i];
    }
    <span class="hljs-keyword">yield</span> row; <span class="hljs-comment">// 逐行产出解析后的行数据，内存只存当前行</span>
  }
}

<span class="hljs-comment">// 消费端：逐行处理，不卡内存</span>
<span class="hljs-keyword">void</span> processLargeCsv(<span class="hljs-built_in">String</span> filePath) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> row <span class="hljs-keyword">in</span> parseLargeCsvStream(filePath)) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'处理行数据：<span class="hljs-subst">$row</span>'</span>); <span class="hljs-comment">// 处理完当前行就释放内存</span>
  }
}
</code></pre>
<h3 data-id="heading-18">自定义「可中断的异步序列」生成</h3>
<p>当你需要生成有<code>固定序列、但可能中途取消</code>的异步数据时，<code>async*</code> + <code>Stream</code> 是最灵活的选择。</p>
<p>典型业务场景：</p>
<ul>
<li>分页加载（带「取消加载」功能，比如用户退出页面时终止后续请求）；</li>
<li>批量任务处理（比如批量上传 100 张图片，支持中途暂停 / 取消）；</li>
<li>精准控制的倒计时 / 定时器（支持中途停止，且不残留定时器）。</li>
</ul>
<p>这类场景的核心是「可中断」——<code>Stream</code> 的订阅取消能直接终止 <code>async*</code> 函数的执行，而其他方案（如 <code>Future</code> 循环 + 定时器）中断逻辑复杂，易残留资源。</p>
<p>实战示例：可中断的批量图片上传</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 用 async* + yield 生成批量上传进度流，支持中途取消</span>
Stream&lt;<span class="hljs-built_in">double</span>&gt; uploadImagesStream(<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; imagePaths) <span class="hljs-keyword">async</span>* {
  <span class="hljs-built_in">int</span> uploadedCount = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> path <span class="hljs-keyword">in</span> imagePaths) {
    <span class="hljs-comment">// 模拟单张图片上传（耗时操作）</span>
    <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>));
    uploadedCount++;
    <span class="hljs-comment">// 产出上传进度（0.0 ~ 1.0）</span>
    <span class="hljs-keyword">yield</span> uploadedCount / imagePaths.length;
  }
}

<span class="hljs-comment">// 消费端：支持中途取消上传</span>
<span class="hljs-keyword">void</span> startUpload(<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; imagePaths) {
  <span class="hljs-keyword">late</span> StreamSubscription&lt;<span class="hljs-built_in">double</span>&gt; subscription;
  
  subscription = uploadImagesStream(imagePaths).listen((progress) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'上传进度：<span class="hljs-subst">${(progress * <span class="hljs-number">100</span>).toStringAsFixed(<span class="hljs-number">1</span>)}</span>%'</span>);
    <span class="hljs-comment">// 模拟：进度到50%时取消上传</span>
    <span class="hljs-keyword">if</span> (progress &gt;= <span class="hljs-number">0.5</span>) {
      subscription.cancel(); <span class="hljs-comment">// 取消订阅，uploadImagesStream 会立即停止循环</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'上传已取消'</span>);
    }
  });
}
</code></pre>
<h3 data-id="heading-19">封装「底层流式工具 / SDK」</h3>
<p>当你需要开发通用工具类、SDK 或底层库时，<code>async*</code> + <code>Stream</code> 是对外暴露流式接口的标准方式</p>
<ul>
<li>自定义网络请求库（对外暴露下载进度流）；</li>
<li>日志工具（对外暴露实时日志流）；</li>
<li>数据同步工具（对外暴露同步进度流）。</li>
</ul>
<p>作为底层工具，需要提供「通用、灵活、低耦合」的接口，<code>Stream</code> 是 <code>Dart/Flutter</code> 生态的标准流式接口，而 <code>async*</code> 是生成这类接口的最简洁方式。</p>
<p>实战示例：自定义下载进度工具</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'dart:io'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:http/http.dart'</span> <span class="hljs-keyword">as</span> http;

<span class="hljs-comment">// 封装下载工具，用 async* + yield 暴露下载进度流</span>
Stream&lt;<span class="hljs-built_in">double</span>&gt; downloadFileStream(<span class="hljs-built_in">String</span> url, <span class="hljs-built_in">String</span> savePath) <span class="hljs-keyword">async</span>* {
  <span class="hljs-keyword">final</span> request = http.Request(<span class="hljs-string">'GET'</span>, <span class="hljs-built_in">Uri</span>.parse(url));
  <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> http.Client().send(request);
  
  <span class="hljs-keyword">final</span> totalLength = response.contentLength ?? <span class="hljs-number">-1</span>;
  <span class="hljs-built_in">int</span> downloadedLength = <span class="hljs-number">0</span>;
  
  <span class="hljs-keyword">final</span> file = File(savePath);
  <span class="hljs-keyword">final</span> sink = file.openWrite();
  
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> chunk <span class="hljs-keyword">in</span> response.stream) {
    downloadedLength += chunk.length;
    sink.add(chunk);
    <span class="hljs-comment">// 产出下载进度（-1 表示长度未知）</span>
    <span class="hljs-keyword">if</span> (totalLength &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">yield</span> downloadedLength / totalLength;
    }
  }
  
  <span class="hljs-keyword">await</span> sink.flush();
  <span class="hljs-keyword">await</span> sink.close();
  <span class="hljs-keyword">yield</span> <span class="hljs-number">1.0</span>; <span class="hljs-comment">// 最后产出 100% 进度</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VS Code使用 GitHub Copilot 高效重构代码：10 大实战技巧 + 自定义指令封装指南]]></title>    <link>https://juejin.cn/post/7586584105741697074</link>    <guid>https://juejin.cn/post/7586584105741697074</guid>    <pubDate>2025-12-23T04:33:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586584105741697074" data-draft-id="7585097023747588111" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VS Code使用 GitHub Copilot 高效重构代码：10 大实战技巧 + 自定义指令封装指南"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T04:33:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="golang学习记"/> <meta itemprop="url" content="https://juejin.cn/user/4371313964100990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VS Code使用 GitHub Copilot 高效重构代码：10 大实战技巧 + 自定义指令封装指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313964100990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    golang学习记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T04:33:02.000Z" title="Tue Dec 23 2025 04:33:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07cf582e89d14fe6971f48e366f5ea8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767069182&amp;x-signature=Zyx460v%2BKFG5YACNX7nmW%2BRV7O4%3D" alt="Copilot 重构界面：Inline Chat 中正在提取函数" loading="lazy"/><br/>
<em>▲ Copilot 支持一键“预览 → 应用”重构建议，安全高效</em></p>
<hr/>
<h2 data-id="heading-0">🔍 为什么重构比写新代码更重要？</h2>
<p>根据《重构：改善既有代码的设计》作者 Martin Fowler 的定义：</p>
<blockquote>
<p><strong>“重构是在不改变软件可观察行为的前提下，调整其内部结构，以提升可读性、可维护性与扩展性。”</strong></p>
</blockquote>
<p>但人工重构成本高、易出错——<br/>
✅ <strong>Copilot 的出现让重构从“高风险操作”变为“日常习惯”</strong>。<br/>
本文将教你：</p>
<ol>
<li>掌握 <strong>10 种高频重构场景</strong>的 Copilot 实战技巧；</li>
<li>将它们封装为 <strong>自定义 <code>/</code> 指令</strong>（如 <code>/extract</code>, <code>/inline</code>），像调用函数一样调用重构动作；</li>
<li>避开常见陷阱，确保<strong>重构零回归</strong>。</li>
</ol>
<hr/>
<h2 data-id="heading-1">🛠️ 一、Copilot 重构基础：三步走工作流</h2>
<p>所有重构操作，建议遵循以下标准化流程：</p>





























<table><thead><tr><th>步骤</th><th>操作</th><th>快捷键（VS Code）</th><th>目的</th></tr></thead><tbody><tr><td><strong>1. 理解</strong></td><td>选中代码 → <code>/explain</code></td><td><code>Ctrl+i</code> → <code>/explain</code></td><td>明确当前逻辑，避免误改</td></tr><tr><td><strong>2. 重构</strong></td><td>输入精准指令（如 <code>/extract</code>）</td><td><code>Ctrl+i</code> → <code>/extract</code></td><td>生成重构建议</td></tr><tr><td><strong>3. 验证</strong></td><td>单元测试 + 手动抽查</td><td>—</td><td>确保行为不变</td></tr></tbody></table>
<blockquote>
<p>⚠️ <strong>黄金法则</strong>：Copilot 是“建议者”，你才是“决策者”。永远执行 <strong>本地测试后再提交</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">📚 二、10 大 Copilot 重构技巧实战 + <code>/</code> 指令封装</h2>
<p>我们按重构复杂度排序，每项含：<strong>场景描述 → 原始代码 → <code>/</code> 指令 → 重构结果 → 注意事项</strong>。</p>
<hr/>
<h3 data-id="heading-3">1️⃣ <code>/explain</code>：理解即重构第一步 ✅</h3>
<p><strong>场景</strong>：接手遗留代码，不知其意。<br/>
<strong>操作</strong>：选中任意代码块 → <code>Ctrl+i</code> → 输入 <code>/explain</code><br/>
<strong>效果</strong>：Copilot 自动生成自然语言解释，支持 Markdown 表格/流程图式描述。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 选中以下函数 → /explain</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calc</span>(<span class="hljs-params">x, y</span>) {
  <span class="hljs-keyword">return</span> x &gt; <span class="hljs-number">0</span> ? (y || <span class="hljs-number">1</span>) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(x) : <span class="hljs-title class_">NaN</span>;
}
</code></pre>
<p>➡️ 返回：</p>
<blockquote>
<p><em>“若 <code>x &gt; 0</code>，则返回 <code>y</code>（若未定义则默认为 1）乘以 <code>√x</code>；否则返回 <code>NaN</code>。疑似实现‘带默认权重的平方根缩放’。”</em></p>
</blockquote>
<p>📌 <strong>提示</strong>：解释过长时点 <strong>View in Chat</strong> 可以展开阅读。</p>
<hr/>
<h3 data-id="heading-4">2️⃣ <code>/extract</code>：提取函数（消除重复/提升可读）🔥</h3>
<p><strong>场景</strong>：一段逻辑重复出现，或函数过长。<br/>
<strong>指令</strong>：<code>/extract function &lt;name&gt;</code> 或 <code>/extract</code>（让 Copilot 命名）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 原始：重复计算</span>
<span class="hljs-keyword">let</span> tax1 = price1 * <span class="hljs-number">0.08</span>;
<span class="hljs-keyword">let</span> tax2 = price2 * <span class="hljs-number">0.08</span>;
</code></pre>
<p>→ 选中 <code>price * 0.08</code> → <code>Ctrl+i</code> → <code>/extract calculateTax</code><br/>
➡️ 输出：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateTax</span>(<span class="hljs-params">price</span>) {
  <span class="hljs-keyword">return</span> price * <span class="hljs-number">0.08</span>;
}
<span class="hljs-keyword">let</span> tax1 = <span class="hljs-title function_">calculateTax</span>(price1);
<span class="hljs-keyword">let</span> tax2 = <span class="hljs-title function_">calculateTax</span>(price2);
</code></pre>
<p>✅ <strong>支持变体</strong>：</p>
<ul>
<li><code>/extract const</code> → 提取为常量</li>
<li><code>/extract interface</code> → 从对象字面量生成 TS interface</li>
</ul>
<hr/>
<h3 data-id="heading-5">3️⃣ <code>/inline</code>：内联变量/函数（简化过度抽象）</h3>
<p><strong>场景</strong>：单次使用的变量或 trivial 函数，增加阅读跳转。<br/>
<strong>指令</strong>：光标置于变量/函数 → <code>Ctrl+i</code> → <code>/inline</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> url = <span class="hljs-title function_">buildUrl</span>(host, path);
<span class="hljs-title function_">fetch</span>(url);
<span class="hljs-comment">// → /inline url</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-title function_">buildUrl</span>(host, path));
</code></pre>
<blockquote>
<p>💡 适用：临时变量、仅 return 的 getter、调试用中间变量。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">4️⃣ <code>/switch</code>：<code>if-else</code> → <code>switch</code>（提升分支可读性）</h3>
<p><strong>场景</strong>：多分支等值判断（尤其字符串/enum）。<br/>
<strong>指令</strong>：光标置于函数 → <code>/switch [language]</code>（如 <code>/switch java21</code>）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 原始</span>
<span class="hljs-keyword">if</span> (animal.equals(<span class="hljs-string">"Dog"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">"Bark"</span>;
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (animal.equals(<span class="hljs-string">"Cat"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">"Meow"</span>;
<span class="hljs-comment">// → /switch java21</span>
</code></pre>
<p>➡️ 输出（含 null 安全 + 模式匹配）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">return</span> <span class="hljs-keyword">switch</span> (animal) {
  <span class="hljs-keyword">case</span> <span class="hljs-literal">null</span> -&gt; <span class="hljs-string">"Unknown"</span>;
  <span class="hljs-keyword">case</span> String a when a.equalsIgnoreCase(<span class="hljs-string">"Dog"</span>) -&gt; <span class="hljs-string">"Bark"</span>;
  <span class="hljs-keyword">case</span> String a when a.equalsIgnoreCase(<span class="hljs-string">"Cat"</span>) -&gt; <span class="hljs-string">"Meow"</span>;
  <span class="hljs-keyword">default</span> -&gt; <span class="hljs-string">"Unknown"</span>;
};
</code></pre>
<p>📌 支持 TS/JS 的 <code>switch</code> + exhaustive check，Python 的 <code>match-case</code>。</p>
<hr/>
<h3 data-id="heading-7">5️⃣ <code>/optimize</code>：性能优化（算法/IO/循环）⚡</h3>
<p><strong>场景</strong>：低效循环、N+1 查询、重复计算。<br/>
<strong>指令</strong>：选中代码 → <code>/optimize</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 原始：调用 N 次 wc</span>
<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> $(find . -name <span class="hljs-string">"*.log"</span>); <span class="hljs-keyword">do</span>
  <span class="hljs-built_in">wc</span> -l <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span>
<span class="hljs-keyword">done</span>
→ /optimize
</code></pre>
<p>➡️ 输出：</p>
<pre><code class="hljs language-bash" lang="bash">find . -name <span class="hljs-string">"*.log"</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">wc</span> -l {} +
<span class="hljs-comment"># ✅ 批量传参，减少 fork 开销</span>
</code></pre>
<p>✅ 典型优化方向：</p>
<ul>
<li>循环 → 向量化 / 内置方法（<code>.map()</code> → <code>.reduce()</code>）</li>
<li>同步 → 异步批处理（如 <code>Promise.all</code>）</li>
<li>磁盘 IO → 缓存 / 流式处理</li>
</ul>
<hr/>
<h3 data-id="heading-8">6️⃣ <code>/concise</code>：精简冗余代码（变量/结构/注释）</h3>
<p><strong>场景</strong>：过度声明、中间变量、模板式代码。<br/>
<strong>指令</strong>：选中 → <code>/concise</code> 或 <code>/shorten</code></p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_area</span>(<span class="hljs-params">l, w</span>):
    area = l * w
    <span class="hljs-keyword">return</span> area  <span class="hljs-comment"># → /concise</span>
<span class="hljs-comment"># → 直接 return l * w</span>
</code></pre>
<p>📌 常见优化：</p>
<ul>
<li>删除无用 <code>let temp = ...; return temp;</code></li>
<li>合并连续 <code>.then()</code> → <code>async/await</code></li>
<li>内联简单 ternary 表达式</li>
</ul>
<hr/>
<h3 data-id="heading-9">7️⃣ <code>/split</code>：拆分巨型函数（单一职责原则）</h3>
<p><strong>场景</strong>：函数 &gt; 50 行，混合“数据清洗+计算+输出”。<br/>
<strong>指令</strong>：光标置于函数 → <code>/split into &lt;n&gt; functions</code></p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_order</span>(<span class="hljs-params">data</span>):
  <span class="hljs-comment"># 1. validate</span>
  <span class="hljs-comment"># 2. calc tax</span>
  <span class="hljs-comment"># 3. persist</span>
  <span class="hljs-comment"># 4. notify</span>
→ /split into <span class="hljs-number">4</span> functions
</code></pre>
<p>➡️ 输出：</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">validate_order</span>(<span class="hljs-params">data</span>): ...
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_tax</span>(<span class="hljs-params">order</span>): ...
<span class="hljs-keyword">def</span> <span class="hljs-title function_">persist_order</span>(<span class="hljs-params">order</span>): ...
<span class="hljs-keyword">def</span> <span class="hljs-title function_">notify_user</span>(<span class="hljs-params">order</span>): ...
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_order</span>(<span class="hljs-params">data</span>):
  order = validate_order(data)
  order = calculate_tax(order)
  persist_order(order)
  notify_user(order)
</code></pre>
<p>✅ 额外技巧：<code>/split with pipeline</code> 可生成函数式链式调用。</p>
<hr/>
<h3 data-id="heading-10">8️⃣ <code>/rename</code>：智能重命名（语义化符号）</h3>
<p><strong>平台支持</strong>：VS Code / Visual Studio（需语言服务支持）<br/>
<strong>操作</strong>：光标置于变量/函数 → <strong><code>F2</code></strong> → Copilot 下拉建议<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab102525a64e4e79b6eddcc09e76ce75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767069182&amp;x-signature=Seuq7PAvy0IfnbHF6LiUSSBLVPk%3D" alt="Rename symbol dropdown" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(); <span class="hljs-comment">// → F2 → 建议：`currentDate`, `timestamp`, `now`</span>
</code></pre>
<p>📌 命名原则：Copilot 会结合上下文（如 <code>d.getMonth()</code> → 倾向 <code>currentDate</code> 而非 <code>date</code>）</p>
<hr/>
<h3 data-id="heading-11">9️⃣ <code>/test</code>：为重构生成测试用例（安全兜底）🛡️</h3>
<p><strong>场景</strong>：重构前快速补齐测试覆盖。<br/>
<strong>指令</strong>：光标置于函数 → <code>/test [framework]</code>（如 <code>/test jest</code>）</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> { <span class="hljs-keyword">return</span> a + b; }
→ /test vitest
</code></pre>
<p>➡️ 输出：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { describe, it, expect } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitest'</span>;
<span class="hljs-keyword">import</span> { add } <span class="hljs-keyword">from</span> <span class="hljs-string">'./math'</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">'add'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'adds positive numbers'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">5</span>);
  });
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'handles negatives'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">add</span>(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">0</span>);
  });
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'handles zero'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">5</span>);
  });
});
</code></pre>
<p>✅ <strong>强烈建议</strong>：重构前执行 <code>/test</code> → 运行测试 → 重构 → 再运行 → 确认绿灯。</p>
<hr/>
<h3 data-id="heading-12">🔟 <code>/docs</code>：补充文档与类型（提升可维护性）</h3>
<p><strong>场景</strong>：无注释函数 / JS 项目需 TS 类型。<br/>
<strong>指令</strong>：光标置于函数 → <code>/docs</code> 或 <code>/types</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 原始</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">resize</span>(<span class="hljs-params">img, w, h</span>) { ... }
→ /docs jsdoc + types
</code></pre>
<p>➡️ 输出：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * Resizes an image to the specified dimensions
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLImageElement</span>} <span class="hljs-variable">img</span> - The source image element
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">w</span> - Target width (pixels)
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">h</span> - Target height (pixels)
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">HTMLCanvasElement</span>} Resized image as canvas
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">resize</span>(<span class="hljs-params">img: HTMLImageElement, w: <span class="hljs-built_in">number</span>, h: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">HTMLCanvasElement</span> {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>✅ 支持：JSDoc、TS 类型注解、Python docstring、Java <code>@param</code>。</p>
<hr/>
<h2 data-id="heading-13">🧰 三、高级技巧：打造你的 Copilot 重构快捷指令集</h2>
<p>重复输入长提示？不如<strong>封装为 <code>/</code> 指令</strong>！<br/>
虽 Copilot 目前不支持用户自定义 <code>/cmd</code>，但可通过 <strong>预设提示模板</strong> 实现等效效果。</p>
<h3 data-id="heading-14">✅ 推荐个人指令集</h3>


















































<table><thead><tr><th>指令别名</th><th>实际输入内容</th><th>用途</th></tr></thead><tbody><tr><td><code>/extract</code></td><td><code>extract selected code into a new function named:</code></td><td>快速提取函数</td></tr><tr><td><code>/inline</code></td><td><code>inline this variable/function safely</code></td><td>内联简化</td></tr><tr><td><code>/switch</code></td><td><code>convert if-else chain to switch/match, use modern syntax for [lang]</code></td><td>分支优化</td></tr><tr><td><code>/opt-loop</code></td><td><code>optimize this loop: avoid repeated work, use built-in methods</code></td><td>循环提速</td></tr><tr><td><code>/test-cover</code></td><td><code>generate unit tests for edge cases: null, empty, large input</code></td><td>测试兜底</td></tr><tr><td><code>/doc-ts</code></td><td><code>add JSDoc + TypeScript type annotations</code></td><td>类型增强</td></tr><tr><td><code>/rename-verb</code></td><td><code>suggest 3 verb-based names for this function</code></td><td>动词化命名</td></tr><tr><td><code>/split-pipe</code></td><td><code>split into pure functions and compose with pipeline</code></td><td>函数式重构</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>技巧</strong>：在 VS Code 中用 <strong>Snippets</strong>（<code>File &gt; Preferences &gt; Configure User Snippets</code>）创建快捷输入：</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"copilot-extract"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"prefix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cext"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/extract $1"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>输入 <code>cext</code> + Tab → 自动补全 <code>/extract </code>，光标定位到 <code>$1</code> 处填函数名。</p>
<hr/>
<h2 data-id="heading-15">⚠️ 四、避坑指南：Copilot 重构的 5 大禁忌</h2>



































<table><thead><tr><th>陷阱</th><th>风险</th><th>规避方案</th></tr></thead><tbody><tr><td><strong>1. 盲目接受</strong></td><td>逻辑变更（如边界条件丢失）</td><td>✅ 重构前后跑测试；✅ 用 <code>git diff</code> 逐行审查</td></tr><tr><td><strong>2. 忽略副作用</strong></td><td>提取函数时未传递依赖（如 <code>this</code>、闭包变量）</td><td>✅ 用 <code>/explain</code> 确认上下文；✅ 优先提取无副作用（pure）逻辑</td></tr><tr><td><strong>3. 过度重构</strong></td><td>为“简洁”牺牲可读性（如嵌套 ternary）</td><td>✅ 遵循团队规范；✅ 优先“清晰”而非“简短”</td></tr><tr><td><strong>4. 类型污染</strong></td><td>TS 中生成 <code>any</code> / 隐式 <code>any</code></td><td>✅ 开启 <code>strict: true</code>；✅ 用 <code>/types</code> 主动加注</td></tr><tr><td><strong>5. 忘记兼容性</strong></td><td>用新语法（如 <code>?.</code>、<code>??</code>）破坏旧环境</td><td>✅ 明确目标环境；✅ 用 <code>/compat es2020</code> 指定语法级别</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-16">🌟 五、结语：重构即日常，Copilot 是你的“结对程序员”</h2>
<blockquote>
<p>“<strong>优秀的程序员不是写更少的 bug，而是让 bug 更难藏身。</strong>”<br/>
—— 而重构，正是照亮代码角落的那束光。</p>
</blockquote>
<p>GitHub Copilot 将 Martin Fowler 的重构手册变成了 <strong>可执行的对话</strong>。<br/>
当你熟练使用 <code>/extract</code>、<code>/switch</code>、<code>/test</code> 这些“语言级指令”，<br/>
你便拥有了一个不知疲倦、精通 Clean Code 的结对程序员。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基础设施模板CLI工具：Boilerplates]]></title>    <link>https://juejin.cn/post/7586617459487391796</link>    <guid>https://juejin.cn/post/7586617459487391796</guid>    <pubDate>2025-12-23T05:32:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586617459487391796" data-draft-id="7586587644823994402" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基础设施模板CLI工具：Boilerplates"/> <meta itemprop="keywords" content="人工智能,AIGC"/> <meta itemprop="datePublished" content="2025-12-23T05:32:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="qife122"/> <meta itemprop="url" content="https://juejin.cn/user/1743174852185579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基础设施模板CLI工具：Boilerplates
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743174852185579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    qife122
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T05:32:45.000Z" title="Tue Dec 23 2025 05:32:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Boilerplates CLI</h2>
<p><strong>Boilerplates</strong> 是一个用于管理基础设施模板（boilerplates）的复杂集合，并配备了一个Python CLI工具。它支持Terraform、Docker、Ansible、Kubernetes等多种技术，帮助您快速生成、定制和部署配置模板。</p>
<h3 data-id="heading-1">功能特性</h3>
<ul>
<li><strong>多技术模板支持</strong>：提供Docker Compose、Terraform、Ansible、Kubernetes、Packer等基础设施模板。</li>
<li><strong>交互式变量收集</strong>：通过交互式CLI提示，引导用户为模板变量输入值。</li>
<li><strong>智能默认值管理</strong>：支持保存常用变量的默认值，并在多个项目中复用。</li>
<li><strong>Git仓库集成</strong>：模板库基于Git管理，支持添加、更新和移除自定义模板仓库。</li>
<li><strong>Jinja2模板渲染</strong>：使用Jinja2引擎渲染模板，支持条件语句和变量替换。</li>
<li><strong>模块化架构</strong>：通过模块系统（Module）组织不同技术的模板和命令。</li>
<li><strong>配置文件管理</strong>：提供配置管理功能，存储用户默认值和偏好设置。</li>
<li><strong>安全与验证</strong>：包含模板语法验证、变量类型检查和路径安全防护。</li>
</ul>
<h3 data-id="heading-2">安装指南</h3>
<h4 data-id="heading-3">使用安装脚本（推荐）</h4>
<p>通过自动化安装脚本安装Boilerplates CLI：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装最新版本</span>
curl -fsSL https://raw.githubusercontent.com/christianlempa/boilerplates/main/scripts/install.sh | bash

<span class="hljs-comment"># 安装特定版本</span>
curl -fsSL https://raw.githubusercontent.com/christianlempa/boilerplates/main/scripts/install.sh | bash -s -- --version v1.2.3
</code></pre>
<p>安装脚本使用<code>pipx</code>为CLI工具创建一个隔离环境。安装完成后，终端中即可使用<code>boilerplates</code>命令。</p>
<h4 data-id="heading-4">依赖要求</h4>
<ul>
<li>Python 3+</li>
<li>Git（用于模板库管理）</li>
<li>pipx（用于隔离安装，安装脚本会自动检查）</li>
</ul>
<h3 data-id="heading-5">使用说明</h3>
<h4 data-id="heading-6">基础命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看帮助信息</span>
boilerplates --<span class="hljs-built_in">help</span>

<span class="hljs-comment"># 查看版本</span>
boilerplates --version

<span class="hljs-comment"># 更新模板库</span>
boilerplates repo update

<span class="hljs-comment"># 列出所有已配置的库</span>
boilerplates repo list
</code></pre>
<h4 data-id="heading-7">模板操作</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出所有可用的Docker Compose模板</span>
boilerplates compose list

<span class="hljs-comment"># 查看特定模板的详细信息</span>
boilerplates compose show nginx

<span class="hljs-comment"># 生成模板（交互式模式）</span>
boilerplates compose generate authentik

<span class="hljs-comment"># 生成模板到自定义输出目录</span>
boilerplates compose generate nginx my-nginx-server

<span class="hljs-comment"># 非交互式模式，直接指定变量值</span>
boilerplates compose generate traefik my-proxy \
  --var service_name=traefik \
  --var traefik_enabled=<span class="hljs-literal">true</span> \
  --var traefik_host=proxy.example.com \
  --no-interactive
</code></pre>
<h4 data-id="heading-8">管理默认值</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置变量的默认值</span>
boilerplates compose defaults <span class="hljs-built_in">set</span> container_timezone <span class="hljs-string">"America/New_York"</span>
boilerplates compose defaults <span class="hljs-built_in">set</span> restart_policy <span class="hljs-string">"unless-stopped"</span>
</code></pre>
<h4 data-id="heading-9">模板库管理</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 添加自定义模板库</span>
boilerplates repo add my-templates https://github.com/user/templates \
  --directory library \
  --branch main

<span class="hljs-comment"># 移除模板库</span>
boilerplates repo remove my-templates
</code></pre>
<h3 data-id="heading-10">核心代码</h3>
<h4 data-id="heading-11">CLI主入口 (<code>cli/__main__.py</code>)</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-string">"""
Main entry point for the Boilerplates CLI application.
This file serves as the primary executable when running the CLI.
"""</span>
<span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> annotations

<span class="hljs-keyword">import</span> importlib
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> pkgutil
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>
<span class="hljs-keyword">from</span> typer <span class="hljs-keyword">import</span> Typer, Context, Option
<span class="hljs-keyword">from</span> rich.console <span class="hljs-keyword">import</span> Console
<span class="hljs-keyword">import</span> cli.modules
<span class="hljs-keyword">from</span> cli.core.registry <span class="hljs-keyword">import</span> registry
<span class="hljs-keyword">from</span> cli.core <span class="hljs-keyword">import</span> repo
<span class="hljs-comment"># Using standard Python exceptions instead of custom ones</span>

<span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> Placeholder version - will be overwritten by release script (.github/workflows/release.yaml)</span>
__version__ = <span class="hljs-string">"0.0.0"</span>

app = Typer(
  <span class="hljs-built_in">help</span>=<span class="hljs-string">"CLI tool for managing infrastructure boilerplates.\n\n[dim]Easily generate, customize, and deploy templates for Docker Compose, Terraform, Kubernetes, and more.\n\n [white]Made with 💜 by [bold]Christian Lempa[/bold]"</span>,
  add_completion=<span class="hljs-literal">True</span>,
  rich_markup_mode=<span class="hljs-string">"rich"</span>,
)
console = Console()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_logging</span>(<span class="hljs-params">log_level: <span class="hljs-built_in">str</span> = <span class="hljs-string">"WARNING"</span></span>) -&gt; <span class="hljs-literal">None</span>:
  <span class="hljs-string">"""Configure the logging system with the specified log level.
  
  Args:
      log_level: The logging level (DEBUG, INFO, WARNING, ERROR, CRITICAL)
  
  Raises:
      ValueError: If the log level is invalid
      RuntimeError: If logging configuration fails
  """</span>
  numeric_level = <span class="hljs-built_in">getattr</span>(logging, log_level.upper(), <span class="hljs-literal">None</span>)
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(numeric_level, <span class="hljs-built_in">int</span>):
    <span class="hljs-keyword">raise</span> ValueError(
      <span class="hljs-string">f"Invalid log level '<span class="hljs-subst">{log_level}</span>'. Valid levels: DEBUG, INFO, WARNING, ERROR, CRITICAL"</span>
    )
  
  <span class="hljs-keyword">try</span>:
    logging.basicConfig(
      level=numeric_level,
      <span class="hljs-built_in">format</span>=<span class="hljs-string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>,
      datefmt=<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>
    )

    logger = logging.getLogger(__name__)
    logger.setLevel(numeric_level)
  <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f"Failed to configure logging: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-meta">@app.callback(<span class="hljs-params">invoke_without_command=<span class="hljs-literal">True</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">
  version: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">bool</span>] = Option(<span class="hljs-params">
    <span class="hljs-literal">None</span>,
    <span class="hljs-string">"--version"</span>,
    <span class="hljs-string">"-v"</span>,
    <span class="hljs-built_in">help</span>=<span class="hljs-string">"Show the application version and exit"</span>,
  </span>),
  log_level: <span class="hljs-built_in">str</span> = Option(<span class="hljs-params">
    <span class="hljs-string">"WARNING"</span>,
    <span class="hljs-string">"--log-level"</span>,
    <span class="hljs-string">"-l"</span>,
    <span class="hljs-built_in">help</span>=<span class="hljs-string">"Set the logging level (DEBUG, INFO, WARNING, ERROR, CRITICAL)"</span>,
  </span>),
  ctx: Context = <span class="hljs-literal">None</span>,
</span>) -&gt; <span class="hljs-literal">None</span>:
  <span class="hljs-string">"""Main entry point for the boilerplates CLI.
  
  Args:
      version: Show version information
      log_level: Logging level for the application
      ctx: Typer context object
  """</span>
  <span class="hljs-keyword">if</span> version:
    console.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Boilerplates CLI [bold]v<span class="hljs-subst">{__version__}</span>[/bold]"</span>)
    <span class="hljs-keyword">raise</span> SystemExit(<span class="hljs-number">0</span>)
  
  <span class="hljs-keyword">try</span>:
    setup_logging(log_level)
  <span class="hljs-keyword">except</span> (ValueError, RuntimeError) <span class="hljs-keyword">as</span> e:
    console_err.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"[red]Failed to set up logging: <span class="hljs-subst">{e}</span>[/red]"</span>)
    sys.exit(<span class="hljs-number">1</span>)
  
  <span class="hljs-comment"># Discover and register modules</span>
  _discover_modules()
  
  <span class="hljs-comment"># Register repository management commands</span>
  app.add_typer(repo.app, name=<span class="hljs-string">"repo"</span>)
  
  <span class="hljs-keyword">if</span> ctx.invoked_subcommand <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
    console.<span class="hljs-built_in">print</span>(app.info.<span class="hljs-built_in">help</span>)
    <span class="hljs-keyword">raise</span> SystemExit(<span class="hljs-number">0</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">_discover_modules</span>() -&gt; <span class="hljs-literal">None</span>:
  <span class="hljs-string">"""Dynamically discover and register all modules in the modules package."""</span>
  <span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">for</span> _, name, _ <span class="hljs-keyword">in</span> pkgutil.iter_modules(cli.modules.__path__):
      module_path = <span class="hljs-string">f"cli.modules.<span class="hljs-subst">{name}</span>"</span>
      <span class="hljs-keyword">try</span>:
        importlib.import_module(module_path)
        logger.debug(<span class="hljs-string">f"Successfully imported module: <span class="hljs-subst">{name}</span>"</span>)
      <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.warning(<span class="hljs-string">f"Failed to import module '<span class="hljs-subst">{name}</span>': <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">continue</span>
    logger.info(<span class="hljs-string">f"Module discovery completed. Total modules: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(<span class="hljs-built_in">list</span>(registry.iter_module_classes()))}</span>"</span>)
  <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    logger.error(<span class="hljs-string">f"Module discovery failed: <span class="hljs-subst">{e}</span>"</span>)
    <span class="hljs-keyword">raise</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
  app()
</code></pre>
<h4 data-id="heading-12">变量集合管理 (<code>cli/core/collection.py</code>)</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> annotations

<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span>, <span class="hljs-type">Set</span>, <span class="hljs-type">Union</span>
<span class="hljs-keyword">import</span> logging

<span class="hljs-keyword">from</span> .variable <span class="hljs-keyword">import</span> Variable
<span class="hljs-keyword">from</span> .section <span class="hljs-keyword">import</span> VariableSection

logger = logging.getLogger(__name__)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">VariableCollection</span>:
  <span class="hljs-string">"""Manages variables grouped by sections and builds Jinja context."""</span>

  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, spec: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""Initialize VariableCollection from a specification dictionary.
    
    Args:
        spec: Dictionary containing the complete variable specification structure
              Expected format (as used in compose.py):
              {
                "section_key": {
                  "title": "Section Title",
                  "prompt": "Optional prompt text",
                  "toggle": "optional_toggle_var_name", 
                  "description": "Optional description",
                  "vars": {
                    "var_name": {
                      "description": "Variable description",
                      "type": "str",
                      "default": "default_value",
                      ...
                    }
                  }
                }
              }
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(spec, <span class="hljs-built_in">dict</span>):
      <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Spec must be a dictionary"</span>)
    
    self._sections: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, VariableSection] = {}
    <span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> The _variable_map provides a flat, O(1) lookup for any variable by its name,</span>
    <span class="hljs-comment"># avoiding the need to iterate through sections. It stores references to the same</span>
    <span class="hljs-comment"># Variable objects contained in the _set structure.</span>
    self._variable_map: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, Variable] = {}
    self._initialize_sections(spec)
    <span class="hljs-comment"># Validate dependencies after all sections are loaded</span>
    self._validate_dependencies()

  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_initialize_sections</span>(<span class="hljs-params">self, spec: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""Initialize sections from the spec."""</span>
    <span class="hljs-keyword">for</span> section_key, section_data <span class="hljs-keyword">in</span> spec.items():
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(section_data, <span class="hljs-built_in">dict</span>):
        <span class="hljs-keyword">continue</span>
      
      <span class="hljs-comment"># Create VariableSection</span>
      section_dict = {
        <span class="hljs-string">"key"</span>: section_key,
        <span class="hljs-string">"title"</span>: section_data.get(<span class="hljs-string">"title"</span>, section_key.title()),
        <span class="hljs-string">"description"</span>: section_data.get(<span class="hljs-string">"description"</span>),
        <span class="hljs-string">"toggle"</span>: section_data.get(<span class="hljs-string">"toggle"</span>),
        <span class="hljs-string">"required"</span>: section_data.get(<span class="hljs-string">"required"</span>, section_key == <span class="hljs-string">"general"</span>),
      }
      
      <span class="hljs-comment"># Handle dependencies</span>
      <span class="hljs-keyword">if</span> needs := section_data.get(<span class="hljs-string">"needs"</span>):
        section_dict[<span class="hljs-string">"needs"</span>] = needs
      
      section = VariableSection(section_dict)
      
      <span class="hljs-comment"># Add variables to section</span>
      <span class="hljs-keyword">if</span> <span class="hljs-string">"vars"</span> <span class="hljs-keyword">in</span> section_data <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(section_data[<span class="hljs-string">"vars"</span>], <span class="hljs-built_in">dict</span>):
        <span class="hljs-keyword">for</span> var_name, var_data <span class="hljs-keyword">in</span> section_data[<span class="hljs-string">"vars"</span>].items():
          <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(var_data, <span class="hljs-built_in">dict</span>):
            <span class="hljs-keyword">continue</span>
          
          <span class="hljs-comment"># Create Variable</span>
          var_dict = var_data.copy()
          var_dict[<span class="hljs-string">"name"</span>] = var_name
          var_dict[<span class="hljs-string">"origin"</span>] = <span class="hljs-string">"template"</span>
          
          variable = Variable(var_dict)
          
          <span class="hljs-comment"># Store in section and flat map</span>
          section.variables[var_name] = variable
          self._variable_map[var_name] = variable
      
      self._sections[section_key] = section
  
  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_validate_dependencies</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""Validate that all section dependencies exist."""</span>
    <span class="hljs-keyword">for</span> section_key, section <span class="hljs-keyword">in</span> self._sections.items():
      <span class="hljs-keyword">for</span> dep <span class="hljs-keyword">in</span> section.needs:
        <span class="hljs-keyword">if</span> dep <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self._sections:
          logger.warning(
            <span class="hljs-string">f"Section '<span class="hljs-subst">{section_key}</span>' depends on non-existent section '<span class="hljs-subst">{dep}</span>'"</span>
          )

  <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_section</span>(<span class="hljs-params">self, section_key: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Optional</span>[VariableSection]:
    <span class="hljs-string">"""Get a section by its key."""</span>
    <span class="hljs-keyword">return</span> self._sections.get(section_key)

  <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_sections</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, VariableSection]:
    <span class="hljs-string">"""Get all sections."""</span>
    <span class="hljs-keyword">return</span> self._sections.copy()

  <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_section_satisfied</span>(<span class="hljs-params">self, section_key: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-string">"""Check if a section's dependencies are satisfied."""</span>
    section = self._sections.get(section_key)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> section:
      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    
    <span class="hljs-comment"># General section is always satisfied</span>
    <span class="hljs-keyword">if</span> section_key == <span class="hljs-string">"general"</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    
    <span class="hljs-comment"># Check all dependencies</span>
    <span class="hljs-keyword">for</span> dep <span class="hljs-keyword">in</span> section.needs:
      dep_section = self._sections.get(dep)
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> dep_section <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> dep_section.is_enabled():
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

  <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_jinja_context</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
    <span class="hljs-string">"""Build Jinja2 template context from all variables.
    
    Returns:
        Dictionary mapping variable names to their values for
</span></code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[安装 docker.io（不走外网 Docker 域名）]]></title>    <link>https://juejin.cn/post/7586610067567706112</link>    <guid>https://juejin.cn/post/7586610067567706112</guid>    <pubDate>2025-12-23T03:46:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586610067567706112" data-draft-id="7585039706611449871" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="安装 docker.io（不走外网 Docker 域名）"/> <meta itemprop="keywords" content="后端,Docker"/> <meta itemprop="datePublished" content="2025-12-23T03:46:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿杰AJie"/> <meta itemprop="url" content="https://juejin.cn/user/3871838955636704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            安装 docker.io（不走外网 Docker 域名）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3871838955636704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿杰AJie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:46:46.000Z" title="Tue Dec 23 2025 03:46:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1️⃣ 安装 docker.io（不走外网 Docker 域名）</h3>
<pre><code class="hljs language-lua" lang="lua">sudo apt update
sudo apt install -y docker.<span class="hljs-built_in">io</span>
</code></pre>
<blockquote>
<p>这一步用的是 Ubuntu 官方仓库<br/>
<strong>不会访问 download.docker.com</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-1">2️⃣ 启动并设置开机自启</h3>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl start docker
sudo systemctl <span class="hljs-built_in">enable</span> docker
</code></pre>
<hr/>
<h3 data-id="heading-2">3️⃣ 验证 Docker 是否安装成功</h3>
<pre><code class="hljs language-css" lang="css">docker <span class="hljs-attr">--version</span>
</code></pre>
<p>只要能看到版本号，说明 <strong>Docker 已经 OK</strong>。</p>
<p>👉 <strong>把 Docker 的数据目录迁移到你指定的位置</strong></p>
<h2 data-id="heading-3">一、确认你要用的磁盘目录（假设用 <code>/data</code>）</h2>
<p>如果你已经有 <code>/data</code>，先看一下：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">df</span> -h
<span class="hljs-built_in">ls</span> /data
</code></pre>
<p>如果没有：</p>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">mkdir</span> -p /data
</code></pre>
<hr/>
<h2 data-id="heading-4">二、迁移 Docker 数据目录到 <code>/data/docker</code>（重点）</h2>
<blockquote>
<p>⚠️ 这一步一定要在 <strong>还没跑任何容器</strong> 前做<br/>
你现在正好是最佳时机</p>
</blockquote>
<h3 data-id="heading-5">1️⃣ 同时停止 docker.service 和 docker.socket</h3>
<pre><code class="hljs language-arduino" lang="arduino">sudo systemctl stop docker
sudo systemctl stop docker.socket
</code></pre>
<hr/>
<h3 data-id="heading-6">2️⃣ 确认 Docker 已完全停止（可选验证）</h3>
<pre><code class="hljs language-perl" lang="perl">ps -ef | <span class="hljs-keyword">grep</span> dockerd | <span class="hljs-keyword">grep</span> -v <span class="hljs-keyword">grep</span>
</code></pre>
<p>如果<strong>没有任何输出</strong>，说明 Docker 已彻底停干净 ✅</p>
<h3 data-id="heading-7">2️⃣ 创建新目录</h3>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">mkdir</span> -p /data/docker
</code></pre>
<hr/>
<h3 data-id="heading-8">3️⃣ 配置 Docker 使用新目录</h3>
<pre><code class="hljs language-bash" lang="bash">sudo nano /etc/docker/daemon.json
</code></pre>
<p>写入以下内容（<strong>完整覆盖</strong>）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"data-root"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/data/docker"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>保存退出。</p>
<hr/>
<h3 data-id="heading-9">4️⃣ 启动 Docker</h3>
<pre><code class="hljs language-sql" lang="sql">sudo systemctl <span class="hljs-keyword">start</span> docker
</code></pre>
<hr/>
<h3 data-id="heading-10">5️⃣ 验证是否生效（非常重要）</h3>
<pre><code class="hljs language-perl" lang="perl">docker info | <span class="hljs-keyword">grep</span> <span class="hljs-string">"Docker Root Dir"</span>
</code></pre>
<p>你应该看到：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Docker</span> <span class="hljs-title class_">Root</span> <span class="hljs-title class_">Dir</span>: <span class="hljs-regexp">/data/</span>docker
</code></pre>
<p>看到这行，说明<strong>安装位置调整成功</strong> ✅</p>
<hr/>
<h3 data-id="heading-11">1️⃣ 把当前用户加入 docker 组</h3>
<pre><code class="hljs language-bash" lang="bash">sudo usermod -aG docker <span class="hljs-variable">$USER</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">2️⃣ <strong>退出 SSH 会话，然后重新登录</strong></h3>
<p>或者直接执行：</p>
<pre><code class="hljs">newgrp docker
</code></pre>
<blockquote>
<p>让当前终端 session 立即生效</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">3️⃣ 再次验证 Docker Root Dir</h3>
<pre><code class="hljs language-perl" lang="perl">docker info | <span class="hljs-keyword">grep</span> <span class="hljs-string">"Docker Root Dir"</span>
</code></pre>
<p>正确输出示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Docker</span> <span class="hljs-title class_">Root</span> <span class="hljs-title class_">Dir</span>: <span class="hljs-regexp">/data/</span>docker
</code></pre>
<hr/>
<h3 data-id="heading-14">4️⃣ 后续操作就可以不用 sudo</h3>
<ul>
<li>拉镜像</li>
<li>启动 MySQL 容器</li>
<li>管理容器</li>
</ul>
<p>都可以直接用 <code>docker</code> 命令，不用加 sudo。</p>
<hr/>
<h2 data-id="heading-15">一、查看 Docker 服务状态（systemd 管理）</h2>
<pre><code class="hljs language-lua" lang="lua">sudo systemctl <span class="hljs-built_in">status</span> docker
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">●</span> <span class="hljs-string">docker.service</span> <span class="hljs-bullet">-</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Application</span> <span class="hljs-string">Container</span> <span class="hljs-string">Engine</span>
     <span class="hljs-attr">Loaded:</span> <span class="hljs-string">loaded</span> <span class="hljs-string">(/lib/systemd/system/docker.service;</span> <span class="hljs-string">enabled;</span> <span class="hljs-attr">vendor preset:</span> <span class="hljs-string">enabled)</span>
     <span class="hljs-attr">Active:</span> <span class="hljs-string">active</span> <span class="hljs-string">(running)</span> <span class="hljs-string">since</span> <span class="hljs-string">Fri</span> <span class="hljs-number">2025-12-19 10:45:00 </span><span class="hljs-string">CST;</span> <span class="hljs-string">5min</span> <span class="hljs-string">ago</span>
</code></pre>
<ul>
<li><code>Active: active (running)</code> → Docker 正在运行 ✅</li>
<li><code>Active: inactive (dead)</code> → Docker 没有运行 ❌</li>
</ul>
<hr/>
<h3 data-id="heading-16">相关命令</h3>
<ul>
<li>启动 Docker：</li>
</ul>
<pre><code class="hljs language-sql" lang="sql">sudo systemctl <span class="hljs-keyword">start</span> docker
</code></pre>
<ul>
<li>停止 Docker：</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">sudo systemctl stop docker
</code></pre>
<ul>
<li>重启 Docker：</li>
</ul>
<pre><code class="hljs">sudo systemctl restart docker
</code></pre>
<ul>
<li>设置开机自启：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl <span class="hljs-built_in">enable</span> docker
</code></pre>
<hr/>
<h2 data-id="heading-17">二、查看 Docker 容器运行状态</h2>
<h3 data-id="heading-18">1️⃣ 查看所有运行中的容器</h3>
<pre><code class="hljs">docker ps
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-bash" lang="bash">CONTAINER ID   IMAGE       COMMAND                  STATUS          PORTS                    NAMES
a1b2c3d4e5f6   mysql:8.0  <span class="hljs-string">"docker-entrypoint.s…"</span>   Up 2 minutes    0.0.0.0:3306-&gt;3306/tcp   mysql8
</code></pre>
<ul>
<li><code>STATUS</code> → 容器运行状态（Up / Exited）</li>
<li><code>PORTS</code> → 映射端口</li>
<li><code>NAMES</code> → 容器名字</li>
</ul>
<hr/>
<h3 data-id="heading-19">2️⃣ 查看所有容器（包括停止的）</h3>
<pre><code class="hljs language-css" lang="css">docker ps -<span class="hljs-selector-tag">a</span>
</code></pre>
<ul>
<li>可以看到已退出或报错的容器</li>
<li>如果 MySQL 容器 <code>STATUS</code> 显示 <code>Exited</code>，说明启动失败，需要检查日志</li>
</ul>
<hr/>
<h3 data-id="heading-20">3️⃣ 查看容器日志</h3>
<pre><code class="hljs">docker logs mysql8
</code></pre>
<ul>
<li>查看 MySQL 容器的启动输出</li>
<li>可以快速定位密码错误、数据目录权限问题等</li>
</ul>
<hr/>
<h3 data-id="heading-21">4️⃣ 进入容器内部（MySQL 测试 / 操作）</h3>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it mysql8 bash
</code></pre>
<p>然后可以直接使用 MySQL：</p>
<pre><code class="hljs language-css" lang="css">mysql -uroot -<span class="hljs-selector-tag">p</span>
</code></pre>
<hr/>
<h2 data-id="heading-22">三、查看 Docker 使用的资源</h2>
<pre><code class="hljs">docker info
</code></pre>
<p>重点看：</p>
<ul>
<li><code>Docker Root Dir</code> → 数据目录</li>
<li><code>Containers</code> → 当前容器数量</li>
<li><code>Images</code> → 镜像数量</li>
<li><code>Server Version</code> → Docker 版本</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手机号脱敏处理（Python/Scala 双版本实现）]]></title>    <link>https://juejin.cn/post/7586615716905680896</link>    <guid>https://juejin.cn/post/7586615716905680896</guid>    <pubDate>2025-12-23T03:19:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586615716905680896" data-draft-id="7586570254861369384" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手机号脱敏处理（Python/Scala 双版本实现）"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-23T03:19:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="徐老总"/> <meta itemprop="url" content="https://juejin.cn/user/3344078309963692"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手机号脱敏处理（Python/Scala 双版本实现）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3344078309963692/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    徐老总
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:19:26.000Z" title="Tue Dec 23 2025 03:19:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">import</span> re

# <span class="hljs-number">1.</span> 读取原文件
<span class="hljs-keyword">with</span> open(<span class="hljs-string">"address.txt"</span>, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) as f:
    content = f.read()

# <span class="hljs-number">2.</span> 识别并替换手机号
# 正则匹配<span class="hljs-number">11</span>位手机号，替换中间<span class="hljs-number">4</span>位为####
processed_content = re.sub(
    <span class="hljs-string">r"(\d{3})\d{4}(\d{4})"</span>,  # 匹配规则：前<span class="hljs-number">3</span>位+中间<span class="hljs-number">4</span>位+后<span class="hljs-number">4</span>位
    <span class="hljs-string">r"\1####\2"</span>,            # 替换为：前<span class="hljs-number">3</span>位+####+后<span class="hljs-number">4</span>位
    content
)

# <span class="hljs-number">3.</span> 保存到新文件
<span class="hljs-keyword">with</span> open(<span class="hljs-string">"processed_address.txt"</span>, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) as f:
    f.write(processed_content)
</code></pre>
<ul>
<li>原内容（<code>address.txt</code>）：<code>小花，xxx盛世城3楼303号，13617234567。</code></li>
<li>处理后（<code>processed_address.txt</code>）：<code>小花，xxx盛世城3楼303号，136####4567。</code></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9591b2e0dca44a4db49a90388944653b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q6ICB5oC7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767064765&amp;x-signature=OqNkLmHD8bd1OKT3E2mtmLyY9dA%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">reg04</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 1. 读入文件。根目录下的address.txt</span>
    <span class="hljs-keyword">val</span> source = scala.io.<span class="hljs-type">Source</span>.fromFile(<span class="hljs-string">"address.txt"</span>).mkString
    <span class="hljs-comment">// println(source)</span>

    <span class="hljs-comment">// 2. 识别手机号</span>
    <span class="hljs-comment">//val reg = "1[3456789]\d{9}".r</span>
    <span class="hljs-keyword">val</span> reg = <span class="hljs-string">"(1[3456789])(\d{4})(\d{4})"</span>.r

    <span class="hljs-comment">// 3. 替换</span>
    <span class="hljs-comment">// group 分组</span>
    <span class="hljs-comment">// group(0) 匹配到的整个字符串</span>
    <span class="hljs-comment">// group(1) 匹配到的第1个括号</span>
    <span class="hljs-comment">// group(2) 匹配到的第2个括号</span>
    <span class="hljs-comment">// group(3) 匹配到的第3个括号</span>
    <span class="hljs-keyword">val</span> newSource = reg.replaceAllIn(source, m =&gt; {
      println(m.group(<span class="hljs-number">0</span>))
      println(m.group(<span class="hljs-number">1</span>))
      println(m.group(<span class="hljs-number">2</span>))
      println(m.group(<span class="hljs-number">3</span>))
      m.group(<span class="hljs-number">1</span>) + <span class="hljs-string">"*****"</span> + m.group(<span class="hljs-number">3</span>)
      <span class="hljs-comment">// println(m.toString)</span>
      <span class="hljs-comment">// m.toString</span>
    })

    <span class="hljs-comment">// 4. 输出文件</span>
    <span class="hljs-keyword">val</span> writer = <span class="hljs-keyword">new</span> java.io.<span class="hljs-type">PrintWriter</span>(<span class="hljs-string">"address_new.txt"</span>)
    writer.write(newSource)
    writer.close()
  }
}
</code></pre>
<p>scala</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">object</span> reg04 {
</code></pre>
<ul>
<li>定义一个 Scala 单例对象（<code>object</code>），名为<code>reg04</code>，Scala 程序的入口逻辑通常写在单例对象中。</li>
</ul>
<p>scala</p>
<pre><code class="hljs language-arduino" lang="arduino">  <span class="hljs-function">def <span class="hljs-title">main</span><span class="hljs-params">(args: Array[<span class="hljs-type">String</span>])</span>: Unit =</span> {
</code></pre>
<ul>
<li>
<p>定义程序的主入口方法<code>main</code>：</p>
<ul>
<li><code>args: Array[String]</code>：接收命令行参数（本代码未使用）；</li>
<li><code>Unit</code>：表示方法无返回值（类似 Java 的<code>void</code>）。</li>
</ul>
</li>
</ul>
<p>scala</p>
<pre><code class="hljs language-ini" lang="ini">    // 1. 读入文件。根目录下的address.txt
    val <span class="hljs-attr">source</span> = scala.io.Source.fromFile(<span class="hljs-string">"address.txt"</span>).mkString
</code></pre>
<ul>
<li>
<p><strong>读取文件内容</strong>：</p>
<ul>
<li><code>scala.io.Source.fromFile("address.txt")</code>：打开项目根目录下的<code>address.txt</code>文件，创建文件读取源；</li>
<li><code>.mkString</code>：将文件中的所有字符读取为一个完整的字符串，赋值给不可变变量<code>source</code>。</li>
</ul>
</li>
</ul>
<p>scala</p>
<pre><code class="hljs language-arduino" lang="arduino">    <span class="hljs-comment">// println(source)</span>
</code></pre>
<ul>
<li>注释掉的调试代码：打印原始文件内容，用于验证是否正确读取文件。</li>
</ul>
<p>scala</p>
<pre><code class="hljs language-ini" lang="ini">    // 2. 识别手机号
    //val <span class="hljs-attr">reg</span> = <span class="hljs-string">"1[3456789]\d{9}"</span>.r
    val <span class="hljs-attr">reg</span> = <span class="hljs-string">"(1[3456789])(\d{4})(\d{4})"</span>.r
</code></pre>
<ul>
<li>
<p><strong>定义手机号匹配的正则表达式</strong>：</p>
<ul>
<li>
<p>注释的<code>reg = "1[3456789]\d{9}".r</code>：匹配完整的 11 位手机号（<code>1</code>开头 + 3/4/5/6/7/8/9 + 9 位任意数字），但未分组；</p>
</li>
<li>
<p>生效的<code>reg = "(1[3456789])(\d{4})(\d{4})".r</code>：</p>
<ul>
<li>
<p>用括号<code>()</code>将手机号拆分为 3 个分组，方便后续替换：</p>
<ul>
<li>第 1 组<code>(1[3456789])</code>：手机号前 3 位（运营商号段）；</li>
<li>第 2 组<code>(\d{4})</code>：手机号中间 4 位（要打码的部分）；</li>
<li>第 3 组<code>(\d{4})</code>：手机号后 4 位；</li>
</ul>
</li>
<li>
<p><code>.r</code>：将字符串转换为 Scala 的正则表达式对象。</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>scala</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">// 3. 替换</span>
    <span class="hljs-comment">// group 分组</span>
    <span class="hljs-comment">// group(0) 匹配到的整个字符串</span>
    <span class="hljs-comment">// group(1) 匹配到的第1个括号</span>
    <span class="hljs-comment">// group(2) 匹配到的第2个括号</span>
    <span class="hljs-comment">// group(3) 匹配到的第3个括号</span>
    <span class="hljs-type">val</span> <span class="hljs-variable">newSource</span> <span class="hljs-operator">=</span> reg.replaceAllIn(source, m =&gt; {
</code></pre>
<ul>
<li>
<p><strong>批量替换匹配到的手机号</strong>：</p>
<ul>
<li><code>reg.replaceAllIn(source, 替换规则)</code>：在<code>source</code>字符串中，找到所有匹配<code>reg</code>的手机号，按规则替换；</li>
<li><code>m =&gt; {...}</code>：匿名函数（替换逻辑），<code>m</code>是每个匹配到的手机号的 “匹配对象”，包含分组信息。</li>
</ul>
</li>
</ul>
<p>scala</p>
<pre><code class="hljs language-scss" lang="scss">      <span class="hljs-built_in">println</span>(m.group(<span class="hljs-number">0</span>))
      <span class="hljs-built_in">println</span>(m.group(<span class="hljs-number">1</span>))
      <span class="hljs-built_in">println</span>(m.group(<span class="hljs-number">2</span>))
      <span class="hljs-built_in">println</span>(m.group(<span class="hljs-number">3</span>))
</code></pre>
<ul>
<li>
<p>调试打印：输出每个匹配到的手机号的完整内容和分组内容，例如：</p>
<ul>
<li>
<p>若匹配到<code>13617234567</code>，则：</p>
<ul>
<li><code>m.group(0)</code> → <code>13617234567</code>（完整手机号）；</li>
<li><code>m.group(1)</code> → <code>136</code>（前 3 位）；</li>
<li><code>m.group(2)</code> → <code>1723</code>（中间 4 位）；</li>
<li><code>m.group(3)</code> → <code>4567</code>（后 4 位）。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>scala</p>
<pre><code class="hljs language-csharp" lang="csharp">      m.<span class="hljs-keyword">group</span>(<span class="hljs-number">1</span>) + <span class="hljs-string">"*****"</span> + m.<span class="hljs-keyword">group</span>(<span class="hljs-number">3</span>)
</code></pre>
<ul>
<li>
<p><strong>核心替换逻辑</strong>：</p>
<ul>
<li>拼接 “前 3 位 + <code>*****</code> + 后 4 位”，替换原手机号；</li>
<li>例如：<code>136</code> + <code>*****</code> + <code>4567</code> → <code>136*****4567</code>。</li>
</ul>
</li>
</ul>
<p>scala</p>
<pre><code class="hljs language-arduino" lang="arduino">      <span class="hljs-comment">// println(m.toString)</span>
      <span class="hljs-comment">// m.toString</span>
    })
</code></pre>
<ul>
<li>注释的调试代码：<code>m.toString</code>等价于<code>m.group(0)</code>，即打印完整匹配的手机号。</li>
</ul>
<p>scala</p>
<pre><code class="hljs language-go" lang="go">    <span class="hljs-comment">// 4. 输出文件</span>
    val writer = <span class="hljs-built_in">new</span> java.io.PrintWriter(<span class="hljs-string">"address_new.txt"</span>)
    writer.write(newSource)
    writer.<span class="hljs-built_in">close</span>()
</code></pre>
<ul>
<li>
<p><strong>保存处理后的内容</strong>：</p>
<ul>
<li><code>new java.io.PrintWriter("address_new.txt")</code>：创建打印写入器，指向新文件<code>address_new.txt</code>；</li>
<li><code>writer.write(newSource)</code>：将替换后的字符串写入新文件；</li>
<li><code>writer.close()</code>：关闭写入器，释放文件资源（必须执行，否则内容可能无法写入）。</li>
</ul>
</li>
</ul>
<p>scala</p>
<pre><code class="hljs">  }
}
</code></pre>
<ul>
<li>闭合<code>main</code>方法和单例对象。</li>
</ul>
<h3 data-id="heading-0">关键注意点</h3>
<ol>
<li><strong>正则匹配范围</strong>：原代码的正则是 “非整行匹配”，能识别嵌入在文本中的手机号（如 “小花 13617234567 地址”），而非仅独立一行的手机号；</li>
<li><strong>打码符号</strong>：代码中是<code>*****</code>，若需改为<code>####</code>，只需把<code>m.group(1) + "*****" + m.group(3)</code>中的<code>*****</code>替换为<code>####</code>；</li>
<li><strong>编码问题</strong>：原代码未指定文件编码，若文件包含中文，可能出现乱码，建议补充编码（如<code>fromFile("address.txt", "UTF-8")</code>）；</li>
<li><strong>资源释放</strong>：<code>PrintWriter</code>需手动<code>close()</code>，否则文件可能无法正常保存。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 工程学习路线图：8 个方向，从基础到前沿]]></title>    <link>https://juejin.cn/post/7586573133349912622</link>    <guid>https://juejin.cn/post/7586573133349912622</guid>    <pubDate>2025-12-23T05:43:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586573133349912622" data-draft-id="7586584105741942834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 工程学习路线图：8 个方向，从基础到前沿"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-23T05:43:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 工程学习路线图：8 个方向，从基础到前沿
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T05:43:02.000Z" title="Tue Dec 23 2025 05:43:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>想进入AI工程领域？这张路线图覆盖了从Python基础到多智能体系统的核心方向，还推荐了优质学习资源～</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e806453840d4ec99bfb66802ed4222b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767073381&amp;x-signature=WC%2BzE0BYgZMvWxxqIWDxSscySgM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. Python：AI工程的“基建语言”</h2>
<p>推荐资源：哈佛大学CS50p、Andrew Ng在Coursera的《AI Python》。</p>
<p>作用：AI工程的几乎所有工具（框架、库）都基于Python，扎实的Python基础是入门第一步。</p>
<h2 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 机器学习数学：算法的“底层逻辑”</h2>
<p>核心内容：概率、统计、线性代数。</p>
<p>推荐资源：Khan Academy（可汗学院）的YouTube播放列表。</p>
<p>作用：理解机器学习算法（如神经网络、大模型）的数学原理，才能不“盲目调包”。</p>
<h2 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3. 大语言模型（LLM）基础：AI的“核心组件”</h2>
<p>推荐资源：3Blue1Brown的“神经网络”系列视频。</p>
<p>作用：LLM是当前AI最核心的技术之一，先搞懂“神经网络如何工作”，再深入LLM更轻松。</p>
<h2 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4. LLM研究：前沿技术的“探索”</h2>
<p>推荐资源：Andrej Karpathy的Makemore系列（讲解从0构建大模型的思路）。</p>
<p>作用：从“用LLM”到“理解LLM如何被打造”，适合想深入研究大模型的同学。</p>
<h2 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5. AI智能体（Agents）：AI的“自主应用”</h2>
<p>推荐资源：Anthropic的《Building Effective Agents》。</p>
<p>作用：智能体是AI落地的热门方向（能自主完成任务），学习如何构建高效智能体是核心技能。</p>
<h2 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>6. 应用AI：多智能体系统实战</h2>
<p>推荐资源：用CrewAI构建多智能体系统。</p>
<p>作用：从“单智能体”到“多智能体协作”，是AI工程落地的进阶场景（比如智能体团队分工完成复杂任务）。</p>
<h2 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>7. AI协议：系统间的“交互规则”</h2>
<p>核心方向：MCP（多客户端协议）、A2A（智能体间通信）、AG-UI（智能体与界面交互）。</p>
<p>作用：AI系统不是孤立的，协议是智能体、系统之间“高效对话”的规则。</p>
<h2 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>8. 书籍：系统化的知识沉淀</h2>
<p>推荐书目：《AI Engineering》《AI Agents Guidebook》《MCP Guidebook》。</p>
<p>作用：书籍能提供更体系化的知识，帮你把零散的学习点串成“知识网”。</p>
<p>AI工程的学习逻辑是“从基础工具（Python）→ 核心技术（LLM、智能体）→ 系统协作（协议、多智能体）”，跟着这个路线逐步深入，能更高效地搭建知识体系～</p>
<h3 data-id="heading-8">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spec模式赋能百度网盘场景提效]]></title>    <link>https://juejin.cn/post/7586615716906303488</link>    <guid>https://juejin.cn/post/7586615716906303488</guid>    <pubDate>2025-12-23T05:46:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586615716906303488" data-draft-id="7586559672129699892" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spec模式赋能百度网盘场景提效"/> <meta itemprop="keywords" content="前端,程序员,前端框架"/> <meta itemprop="datePublished" content="2025-12-23T05:46:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文心快码BaiduComate"/> <meta itemprop="url" content="https://juejin.cn/user/992209294070809"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spec模式赋能百度网盘场景提效
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/992209294070809/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文心快码BaiduComate
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T05:46:31.000Z" title="Tue Dec 23 2025 05:46:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文将通过2个实践案例，带大家感受SPEC模式的魅力～看Spec如何在百度网盘场景下赋能研发提效！</p>
<h2 data-id="heading-0">Case 1 ：通过Spec模式生成代码库Rules数据看板</h2>
<p>百度网盘的技术老师最近在做通用Rules开发，过程中的监控指标是团队代码库Rules占比，但缺少一个能看到各团队占比的页面，现在的任务就是从0到1去解决这件事。当然，不是要生成一个临时项目，而是生成一个可持久维护的、符合当前团队技术栈的项目。</p>
<p>观看【通过Spec模式，从0到1生成各团队代码库Rules占比页面】视频👉<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fz2Qmp7Blq7tAdV9bovBcSQ" target="_blank" title="https://mp.weixin.qq.com/s/z2Qmp7Blq7tAdV9bovBcSQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/z2Qmp7Blq…</a></p>
<p>实际工作中经常会遇到一个痛点：在内部开发过程中，设计资源往往非常紧张，尤其像数据统计这类页面，经常没有现成的设计稿，因此也无法直接使用F2C（Figma to Code）这类功能。如果走传统开发模式，从零开始构建一个功能，需要到处寻找合适的组件、梳理交互逻辑，整个过程既耗时又容易出错。现在有了<strong>SPEC模式</strong>，情况就完全不同了。它能够带领我们从<strong>需求设计</strong>出发，一步步推进到<strong>架构设计</strong>，最后进入<strong>执行阶段</strong>，帮助我们高效、系统地实现一个完整功能，大大提升了整体效率。</p>
<p><strong>在介绍SPEC模式流程前，先设问：</strong> “面临‘无图开发’这个困境，一个理想的辅助工具，应该从哪几个环节帮助我们？<strong>理解需求、搭好架子、生成代码</strong>，这其实就是SPEC模式的核心脉络。”</p>
<p>一起看下SPEC生成效果，可以看到，Zulu已经成功完成了：</p>
<p><strong>1 完整的工程化能力：</strong> 完整的工程化能力是项目完成的一大步，后续也都可以基于本次构建团队的TPL模板以进行复用</p>
<ul>
<li>工作空间配置</li>
<li>符合规范文件结构：monorepo拆分为业务包frontend、以及shared便于后续多个业务包复用相同逻辑</li>
</ul>
<p><strong>2 可维护性强的代码：</strong></p>
<ul>
<li>生成人类可读’的代码，类型定义和使用</li>
</ul>
<p><strong>3 合理的业务分层：</strong></p>
<ul>
<li>组件、页面、状态管理、Service服务、工具函数等符合常规分层逻辑</li>
</ul>
<p><strong>4 符合预期的功能：</strong></p>
<ul>
<li>各个团队本身的Rules占比一目了然；</li>
<li>如果需要的话，只需给它说一下美化样式或者增加图表展示即可；</li>
<li>甚至还额外做了一些他觉得需要，我们没有想起来的功能，如数据下载；</li>
<li>本次的Prompt有点类似『闲聊版』，并没有很结构化，它具备一定的信息提取整理能力，说明使用AI编程的门槛并不高。结构化之后，可以实现更复杂的任务。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e78e6aec29db49da93cc3b7d18f4125c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767073590&amp;x-signature=D11rHdrDqKiC%2FXCMwtAU82Ia9I8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>Spec模式本质上是一种 <strong>“先计划，后执行”</strong> 的人机协作范式。它要求AI在动笔写代码之前，必须先把它的理解、方案和任务拆解写成详细的文档，并提交给人来确认。<strong>真正约束了AI生成代码的行为，让其更加规范，生成更准确的代码。</strong></p>
<p>这就像建筑施工前需要审核设计蓝图一样，把质量管控的关口大幅前移，避免在建设过程中有问题出现返工的情况。</p>
<p>本案例中看到的是SPEC模式处理“从0到1”场景的能力。但它更大的想象空间在于，<strong>它可能成为团队内部统一需求表述、快速产出技术方案原型的‘协作桥梁’：</strong> 产品、后端和前端，或许可以用同一种“语言”来沟通功能的雏形。</p>
<h2 data-id="heading-1">Case 2 ：用Zulu进行AI代码审查</h2>
<p>在刚才生成数据看板的场景，SPEC模式能大幅减少因方向错误、理解偏差导致的无效工作和返工，提升了代码生成质量。但如果之前的项目没有使用SPEC模式，现在想要进行代码审查，优化一下代码，有什么好的方法呢？传统上一般是靠人工逐字逐句审查代码的问题，费时费力，现在<strong>可以借助Zulu的能力在多个场景（如编码阶段、流水线构建阶段等）帮助做代码审查。</strong></p>
<p>在用Zulu进行代码审查前，要先准备符合本团队项目最佳实践（本团队的函数命名、Store使用、性能质量、组件使用等）的和本技术栈通用型（包含运行时崩溃风险、严重的逻辑和状态错误、内存泄露问题、原型污染、安全红线等）常见问题的Rules。</p>
<p>下面针对百度网盘GenFlow超能搭子项目做代码的审查演示，GenFlow超能搭子能帮你做文件智能整理、能生成视频、生成PPT。（GenFlow功能在百度网盘APP首页底部最显眼的TAB，WEB端、桌面端也有相应入口）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2f6e3c55102467c8f3ba81a59a1b83b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767073590&amp;x-signature=Zg%2BtXaCs2cQbVGWqN%2F2uUUdDELo%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>本地添加了一部分问题代码，便于演示。</p>
<p>观看【在编码阶段进行团队项目规范的代码审查】视频👉<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fz2Qmp7Blq7tAdV9bovBcSQ" target="_blank" title="https://mp.weixin.qq.com/s/z2Qmp7Blq7tAdV9bovBcSQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/z2Qmp7Blq…</a></p>
<p>观看【在编码阶段进行技术栈严重问题的代码审查】视频👉<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fz2Qmp7Blq7tAdV9bovBcSQ" target="_blank" title="https://mp.weixin.qq.com/s/z2Qmp7Blq7tAdV9bovBcSQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/z2Qmp7Blq…</a></p>
<p>如果没有在本地使用代码审查，或者某同学需要对同学A\B\C等的代码进行评审，众多代码的审查费时费力，如果把Zulu的代码审查能力接入开发工作流中，是不是会极大提高代码审查的效率呢?</p>
<p>观看【在构建阶段进行技术栈严重问题的代码审查】视频👉<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fz2Qmp7Blq7tAdV9bovBcSQ" target="_blank" title="https://mp.weixin.qq.com/s/z2Qmp7Blq7tAdV9bovBcSQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/z2Qmp7Blq…</a></p>
<p>针对团队的所有代码审查，可以在内部平台管理和监控，对AI代码审查的拦截效果做评估和改进，形成代码审查的正向循环飞轮。经过代码审查，Comate找到了以上代码修改的所有漏洞。</p>
<p>上文演示的AI代码审查功能清晰、高效。<strong>它通过系统化的步骤——从智能分析变更文件、依据规范逐项检查，到自动评分并生成详细报告和建议——真正实现了在代码提交评审之前，就能主动发现和修复问题。</strong> 这样一来，不仅大大提升了代码质量，也节省了团队反复沟通和修改的时间。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent开发路线图2025：从入门到精通，一文读懂智能体技术]]></title>    <link>https://juejin.cn/post/7586588823906779145</link>    <guid>https://juejin.cn/post/7586588823906779145</guid>    <pubDate>2025-12-23T05:49:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586588823906779145" data-draft-id="7586588823906729993" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent开发路线图2025：从入门到精通，一文读懂智能体技术"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-23T05:49:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent开发路线图2025：从入门到精通，一文读懂智能体技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T05:49:21.000Z" title="Tue Dec 23 2025 05:49:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<blockquote>
<p>AI Agent开发技术及工具链整理，分享给需要的你。</p>
</blockquote>
<p>今天，我们将通过一份2025年AI Agent开发路线图，全面解析Agent开发领域的核心技术栈和发展路径。</p>
<h2 data-id="heading-0"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>什么是AI Agent？</h2>
<p>不只是聊天机器人。AI Agent与传统聊天机器人的根本区别在于<strong>自主性</strong>。一个真正的AI Agent能够理解复杂目标，制定计划，使用工具执行任务，并根据结果调整策略——这一切只需要你给出一个高级指令。</p>
<p>想象一下，你告诉Agent：“帮我分析一下新能源汽车市场的最新趋势，并在周五前准备一份10页的报告”。一个真正的AI Agent会自主完成：搜索最新行业数据、分析竞争对手信息、制作图表并生成完整报告。</p>
<h2 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>核心开发层次全解析</h2>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>编程与提示工程</h3>
<p>任何AI Agent开发都从这里开始。<strong>Python</strong>仍然是首选语言，但JavaScript/TypeScript的使用也在增长。除了基础编程能力，提示工程是关键技能。</p>

















<table><thead><tr><th>层次名称</th><th>必须做</th><th>可选</th><th>工具/技术</th></tr></thead><tbody><tr><td><strong>编程与提示</strong></td><td>编程语言（如基础语法）；脚本与自动化（如API请求、文件处理）；提示概念（如提示工程、思维链提示）</td><td>异步编程；网络抓取；多 Agent提示；目标导向提示；自我批判与重试循环；反思循环</td><td>Python（首选）；JavaScript；TypeScript；Shell/Bash；HTTP/JSON库（如requests in Python）；文件处理库（如os, pathlib）；异步库（如asyncio）；网络抓取库（如BeautifulSoup, Scrapy）</td></tr></tbody></table>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>AI Agent基础架构</h3>
<p>理解AI Agent的基本构成要素是核心：LLM作为 Agent的大脑，负责决策和推理；工具作为Agent的手脚，允许它与外界交互；记忆系统存储Agent的经验；规划器负责制定和执行计划。</p>

















<table><thead><tr><th>层次名称</th><th>必须做</th><th>可选</th><th>工具/技术</th></tr></thead><tbody><tr><td><strong>AI Agent基础</strong></td><td>AI Agent定义；自治 vs. 半自治 Agent； Agent组件（如LLM、工具、记忆、规划器）</td><td>Agent架构设计</td><td>LangChain（ Agent框架）；LlamaIndex（数据索引与 Agent）；Haystack（搜索 Agent）；Semantic Kernel（微软 Agent框架）；AutoGen（多 Agent）；CrewAI（团队 Agent）</td></tr></tbody></table>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>LLM调用与工具集成</h3>
<p>LLM调用是Agent工作的基础，而工具调用则是Agent技术的杀手级功能。通过工具，Agent可以执行代码计算、进行网络搜索、查询数据库、操作浏览器和调用任何API接口。</p>























<table><thead><tr><th>层次名称</th><th>必须做</th><th>可选</th><th>工具/技术</th></tr></thead><tbody><tr><td><strong>LLM调用</strong></td><td>LLM API调用；提示模板（如动态提示、条件提示）</td><td>高级调用（如流式传输、批量/并行调用、回调/钩子）；提示链</td><td>OpenAI API；Anthropic API；Google AI；Cohere；Grok；本地LLM（如Ollama, LM Studio）；LangChain的LLM集成模块</td></tr><tr><td><strong>工具调用</strong></td><td>工具集成（如自定义工具、预构建工具）；工具类型（如搜索、计算、代码执行）</td><td>浏览器自动化；数据库查询；外部API集成</td><td>LangChain Tools；LlamaIndex Tools；Hugging Face Agents；Selenium（浏览器）；SQLAlchemy（数据库）；各种API SDK</td></tr></tbody></table>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>RAG与高级推理</h3>
<p>检索增强生成（RAG）技术让Agent能够访问特定领域知识，而不需要重新训练模型。规划与推理能力则决定了Agent处理复杂任务的智能水平。</p>























<table><thead><tr><th>层次名称</th><th>必须做</th><th>可选</th><th>工具/技术</th></tr></thead><tbody><tr><td><strong>检索增强生成（RAG）</strong></td><td>嵌入模型；向量存储；简单RAG</td><td>高级RAG（如查询重写、重新排名）； AgentRAG</td><td>OpenAI Embeddings；Sentence Transformers；Cohere Embeddings；FAISS（本地向量库）；Pinecone/Weaviate/Chroma/Milvus（托管向量DB）</td></tr><tr><td><strong>规划与推理</strong></td><td>规划技术（如ReAct, Plan-and-Solve）；推理引擎（如LLM作为推理器）</td><td>Tree of Thoughts；Graph-based Planning；自问自答；辩论式推理</td><td>LangChain的ReAct链；自定义LLM推理模块</td></tr></tbody></table>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>多Agent系统与状态管理</h3>
<p>单个Agent能力有限，但多Agent系统可以完成惊人复杂的任务。记忆与状态管理确保了Agent能够保持连续性和学习能力。</p>























<table><thead><tr><th>层次名称</th><th>必须做</th><th>可选</th><th>工具/技术</th></tr></thead><tbody><tr><td><strong>多 Agent系统</strong></td><td>Agent协作（如分层 Agent、辩论 Agent）</td><td>合作 Agent</td><td>AutoGen；CrewAI；Multi-Agent LangChain</td></tr><tr><td><strong>记忆与状态管理</strong></td><td>记忆类型（如短期/长期记忆、共享记忆）；状态管理（如会话状态）</td><td>持久化状态</td><td>Redis（缓存记忆）；SQL Databases（如SQLite/PostgreSQL）；Vector Stores for Memory（如Pinecone用于长期记忆）</td></tr></tbody></table>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>用户界面与部署</h3>
<p>优秀的用户界面让Agent能力更容易被使用者接受，而稳健的部署方案是生产环境应用的基础。</p>























<table><thead><tr><th>层次名称</th><th>必须做</th><th>可选</th><th>工具/技术</th></tr></thead><tbody><tr><td><strong>用户界面</strong></td><td>UI框架；交互（如聊天界面）</td><td>多模态输入；实时反馈</td><td>Streamlit/Gradio/Chainlit（快速原型）；Flask/Django（后端UI）；React/Vue（前端UI）</td></tr><tr><td><strong>部署</strong></td><td>API部署；Agent托管服务</td><td>无服务器函数；向量DB托管</td><td>FastAPI/Streamlit/Gradio（API/UI）；Docker；Kubernetes；Replit/Modal（托管）；Pinecone等向量DB服务</td></tr></tbody></table>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>监控评估与安全治理</h3>
<p>随着Agent能力增强，监控评估和安全治理变得至关重要。这不仅关系到系统稳定性，也涉及到伦理和法律合规问题。</p>























<table><thead><tr><th>层次名称</th><th>必须做</th><th>可选</th><th>工具/技术</th></tr></thead><tbody><tr><td><strong>监控与评估</strong></td><td>Agent评估指标；人机环路反馈</td><td>日志/追踪；自动评估循环；自定义仪表板</td><td>LangSmith（LangChain监控）；OpenTelemetry（追踪）；Prometheus/Grafana（指标监控）</td></tr><tr><td><strong>安全与治理</strong></td><td>提示注入保护；API密钥管理；用户认证</td><td>基于角色的访问控制（RBAC）；输出过滤；红队测试；数据隐私与合规</td><td>自定义防护提示；密钥管理工具（如Vault）；Auth0/OAuth（认证）；RBAC库（如Casbin）；合规模块（如GDPR工具）</td></tr></tbody></table>
<h2 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2025年趋势展望</h2>
<ul>
<li>本地化部署（Ollama等工具让本地运行大模型成为可能）</li>
<li>多模态融合（Agent不仅能处理文本，还能理解图像、音频）</li>
<li>专业化发展（领域特定Agent将超过通用Agent）</li>
<li>安全优先（随着应用深入，安全性将成为核心考量）</li>
</ul>
<h2 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>如何开始你的AI Agent开发之旅？</h2>
<p>如果你是初学者，建议按照以下路径学习：</p>
<ol>
<li>掌握Python基础和API调用；</li>
<li>学习提示工程基础；</li>
<li>尝试LangChain等框架构建简单Agent；</li>
<li>集成工具扩展Agent能力；</li>
<li>添加RAG提供专业知识；</li>
<li>探索多Agent协作场景。</li>
</ol>
<p>对于有经验的开发者，可以重点关注：</p>
<ul>
<li>高级规划与推理技术</li>
<li>多Agent系统架构</li>
<li>生产环境部署与监控</li>
<li>安全与合规框架。</li>
</ul>
<h2 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>结语</h2>
<p>AI Agent技术正在快速发展，2025年将是关键的一年。随着技术的成熟和工具的完善，我们将看到越来越多强大的AI Agent应用于各行各业。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4b176255d314fa9ae88dc471240c0cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767073761&amp;x-signature=0Lcr91TSdQf3qbkIApBFFOiUv6g%3D" alt="" loading="lazy"/><br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/197af662905346f4b646cc02cf9d162f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767073761&amp;x-signature=P2ErydDJAdVl7S5RJjq2CT7OGcY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>